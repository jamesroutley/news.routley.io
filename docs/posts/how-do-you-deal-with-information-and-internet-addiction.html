<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://news.ycombinator.com/item?id=34710830">Original</a>
    <h1>Ask HN: How do you deal with information and internet addiction?</h1>
    
    <div id="readability-page-1" class="page"><div><p>This post is about the steps I took to automate <a href="https://github.com/apollographql/apollo-client"><code>@apollo/client</code></a>&#39;s release process with a tool called <a href="https://github.com/changesets/changesets">Changesets</a>. Hopefully it will save someone else implementing a similar workflow a few minutes in the future :)</p>
<h2 id="changesets"><a href="#changesets"><span></span></a>Changesets</h2>
<p>After comparing several options, <a href="https://github.com/changesets/changesets">Changesets</a> stood out as the library that would allow our team to adapt our existing manual workflow seamlessly.</p>
<p>Some of its features include:</p>
<ol>
<li>changelog entries written in Markdown at the time code is committed so both changelog and release notes can contain formatted code blocks, links, and other rich contextual information related to the change</li>
<li>an API for handling prereleases in long-running integration branches</li>
<li>a simple mechanism for batching changes into releases (changesets <code>.md</code> files themselves)</li>
<li>many other nice to haves, including <a href="https://github.com/changesets/changesets/blob/main/docs/snapshot-releases.md">snapshot releases</a></li>
</ol>
<p>IMO, the prerelease workflow is more interesting to discuss since its API <a href="https://github.com/changesets/changesets/issues/665">may undergo significant changes in v3</a> and it took a bit of experimentation before landing on the current approach, so let&#39;s take a look at the more straightforward release workflow first.</p>
<h2 id="releases"><a href="#releases"><span></span></a>Releases</h2>
<p>The basic premise of Changesets is that each change to your library (or librariesâ€”it was designed with monorepos in mind) is represented by a markdown file generated via <code>npx changeset</code>.</p>
<p>The CLI prompts you with two questions: whether your change represents a new patch/minor/major version, and for a description of the change. Once this info is entered, the CLI uses it to generate a new file inside of <code>.changeset</code>.</p>
<p>Here&#39;s an example of a recent Apollo Client changeset, <code>.changeset/gorgeous-buses-laugh.md</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="md" data-theme="default"><code data-language="md" data-theme="default"><span><span>---</span></span>
<span><span>&#39;</span><span>@apollo/client</span><span>&#39;</span><span>:</span><span> </span><span>patch</span></span>
<span><span>---</span></span>
<span></span>
<span><span>Adds </span><span>`TVariables`</span><span> generic to </span><span>`GraphQLRequest`</span><span> and </span><span>`MockedResponse`</span><span> interfaces.</span></span></code></pre></div>
<p>In a monorepo, more than one package can be specified in the frontmatter block at the top. Once the PR containing the relevant change + changeset is merged to <code>main</code> the release workflow kicks off.</p>
<p>Here&#39;s an abridged + commented version of Apollo Client&#39;s <a href="https://github.com/apollographql/apollo-client/blob/main/.github/workflows/release.yml">release workflow</a>:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="yaml" data-theme="default"><code data-language="yaml" data-theme="default"><span><span>name</span><span>:</span><span> </span><span>Release</span></span>
<span></span>
<span><span>on</span><span>:</span></span>
<span><span>  </span><span>push</span><span>:</span></span>
<span><span>    </span><span>branches</span><span>:</span></span>
<span><span>      </span><span>-</span><span> </span><span>main</span></span>
<span></span>
<span><span>jobs</span><span>:</span></span>
<span><span>  </span><span>release</span><span>:</span></span>
<span><span>    </span><span># Prevents action from creating a PR on forks</span></span>
<span><span>    </span><span>if</span><span>:</span><span> </span><span>github.repository == &#39;apollographql/apollo-client&#39;</span></span>
<span></span>
<span><span>    </span><span>runs-on</span><span>:</span><span> </span><span>ubuntu-latest</span></span>
<span><span>    </span><span>steps</span><span>:</span></span>
<span><span>      </span><span>-</span><span> </span><span>name</span><span>:</span><span> </span><span>Checkout repo</span></span>
<span><span>        </span><span>uses</span><span>:</span><span> </span><span>actions/checkout@v3</span></span>
<span><span>        </span><span>with</span><span>:</span></span>
<span><span>          </span><span># Fetch entire git history so  Changesets can generate</span></span>
<span><span>          </span><span># changelogs with the correct commits</span></span>
<span><span>          </span><span>fetch-depth</span><span>:</span><span> </span><span>0</span></span>
<span></span>
<span><span>      </span><span># You can pass NPM_TOKEN directly to the</span></span>
<span><span>      </span><span># changesets action, but if you have an existing .npmrc</span></span>
<span><span>      </span><span># checked in, you&#39;ll need to append the token since .npmrc wins</span></span>
<span><span>      </span><span>-</span><span> </span><span>name</span><span>:</span><span> </span><span>Append NPM token to .npmrc</span></span>
<span><span>      </span><span># ...</span></span>
<span></span>
<span><span>      </span><span>-</span><span> </span><span>name</span><span>:</span><span> </span><span>Create release PR or publish to npm + GitHub</span></span>
<span><span>        </span><span>id</span><span>:</span><span> </span><span>changesets</span></span>
<span><span>        </span><span>uses</span><span>:</span><span> </span><span>changesets/action@v1</span></span>
<span><span>        </span><span>with</span><span>:</span></span>
<span><span>          </span><span># changesets increments the version in package.json according</span></span>
<span><span>          </span><span># to changesets files it detects and `npm i` updates lockfile</span></span>
<span><span>          </span><span>version</span><span>:</span><span> </span><span>npx changeset-version &amp;&amp; npm i</span></span>
<span><span>          </span><span># publish command should build library and call changeset publish</span></span>
<span><span>          </span><span># it also accepts several flags including `--tag` to specify npm tag</span></span>
<span><span>          </span><span>publish</span><span>:</span><span> </span><span>npm run build &amp;&amp; npx changeset publish -- --tag next</span></span>
<span><span>        </span><span>env</span><span>:</span></span>
<span><span>          </span><span>GITHUB_TOKEN</span><span>:</span><span> </span><span>${{ secrets.GITHUB_TOKEN }}</span></span>
<span><span>          </span><span>NPM_TOKEN</span><span>:</span><span> </span><span>${{ secrets.NPM_TOKEN }}</span></span>
<span></span>
<span><span>      </span><span># optional: announce the release somewhere</span></span>
<span><span>      </span><span>-</span><span> </span><span>name</span><span>:</span><span> </span><span>Send a Slack notification on publish</span></span>
<span><span>        </span><span>if</span><span>:</span><span> </span><span>steps.changesets.outcome == &#39;success&#39; &amp;&amp; steps.changesets.outputs.published == &#39;true&#39;</span></span>
<span><span>        </span><span># send Slack/Discord/etc. message with</span></span>
<span><span>        </span><span># ${{ fromJson(steps.changesets.outputs.publishedPackages)[0].version }}</span></span></code></pre></div>
<p>The first time this is run after merging a PR, changesets detects the new changeset file and opens a &#34;Versions Packages&#34; PR.</p>
<p><img alt="A screenshot of a Version Packages PR automatically created by the Changesets Action" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fversion.1186eee8.jpg&amp;w=1080&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fversion.1186eee8.jpg&amp;w=1920&amp;q=75 2x" src="https://aless.co/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fversion.1186eee8.jpg&amp;w=1920&amp;q=75" width="933" height="699" decoding="async" data-nimg="1" loading="lazy"/></p><p>Every time the release workflow runs on push events to the <code>main</code> branch, any unreleased changeset files are incorportated into the &#34;Version Packages&#34; PR and Changesets is smart enough to increment the package(s) version number(s) to the correct version.</p>
<p>By that I mean: if you have two unreleased changesets, one a <code>minor</code> change and one a <code>patch</code>, that results in a new minor version ðŸŽ‰ The automated &#34;Version Packages&#34; PR will update <code>CHANGELOG.md</code> listing minor/patch changes in separate sections, increment the version in <code>package.json</code> and lockfile, as well as removing the changeset markdown files for changes in the new release.</p>
<p>Merging this &#34;Version Packages&#34; PR is what will trigger the <code>changesets/action</code> to generate a new release ðŸ¥³</p>
<h2 id="prereleases"><a href="#prereleases"><span></span></a>Prereleases</h2>
<p>Prereleases work fairly similarly, but took some experimentation since entering &#34;prerelease mode&#34; generates a <code>pre.json</code> file that Changesets uses to track alpha releases.</p>
<p>Here&#39;s an example <code>pre.json</code> from Apollo Client&#39;s current <a href="https://github.com/apollographql/apollo-client/pull/10340"><code>release-3.8</code></a> branch:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="json" data-theme="default"><code data-language="json" data-theme="default"><span><span>{</span></span>
<span><span>  </span><span>&#34;</span><span>mode</span><span>&#34;</span><span>:</span><span> </span><span>&#34;</span><span>pre</span><span>&#34;</span><span>,</span></span>
<span><span>  </span><span>&#34;</span><span>tag</span><span>&#34;</span><span>:</span><span> </span><span>&#34;</span><span>alpha</span><span>&#34;</span><span>,</span></span>
<span><span>  </span><span>&#34;</span><span>initialVersions</span><span>&#34;</span><span>:</span><span> </span><span>{</span></span>
<span><span>    </span><span>&#34;</span><span>@apollo/client</span><span>&#34;</span><span>:</span><span> </span><span>&#34;</span><span>3.7.2</span><span>&#34;</span></span>
<span><span>  </span><span>},</span></span>
<span><span>  </span><span>&#34;</span><span>changesets</span><span>&#34;</span><span>:</span><span> </span><span>[</span></span>
<span><span>    </span><span>&#34;</span><span>early-pens-retire</span><span>&#34;</span><span>,</span></span>
<span><span>    </span><span>&#34;</span><span>polite-birds-rescue</span><span>&#34;</span><span>,</span></span>
<span><span>    </span><span>&#34;</span><span>rude-mayflies-scream</span><span>&#34;</span><span>,</span></span>
<span><span>    </span><span>&#34;</span><span>short-bikes-mate</span><span>&#34;</span><span>,</span></span>
<span><span>    </span><span>&#34;</span><span>sixty-trains-sniff</span><span>&#34;</span><span>,</span></span>
<span><span>    </span><span>&#34;</span><span>small-timers-shake</span><span>&#34;</span><span>,</span></span>
<span><span>    </span><span>&#34;</span><span>wild-mice-nail</span><span>&#34;</span></span>
<span><span>  </span><span>]</span></span>
<span><span>}</span></span></code></pre></div>
<p>In other simpler prerelease workflows I&#39;ve seen in the wild, <code>pre.json</code> is repeatedly added and removed from the default branch, but that seemed like a nonstarter for Apollo Client with its many forks. I wanted to avoid ever committing <code>pre.json</code> to <code>main</code>.</p>
<p>Instead, Apollo Client:</p>
<ol>
<li>enters pre mode on all <code>release-x</code> branches by default</li>
<li>each new commit with a changeset opens a &#34;Version Packages (alpha)&#34; PR that functions the same as regular releases,</li>
<li><em>but</em> the version is monotonically increased, ie <code>3.8.0-alpha.0</code>, <code>3.8.0-alpha.1</code>, and so on</li>
<li>and only npm releases are generated (not GitHub releases)</li>
</ol>
<p>Apollo Client&#39;s <a href="https://github.com/apollographql/apollo-client/blob/main/.github/workflows/prerelease.yml"><code>prerelease.yml</code></a> looks like this:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="yaml" data-theme="default"><code data-language="yaml" data-theme="default"><span><span># Are we already in pre mode?</span></span>
<span><span>-</span><span> </span><span>name</span><span>:</span><span> </span><span>Check for pre.json file existence</span></span>
<span><span>  </span><span>id</span><span>:</span><span> </span><span>check_files</span></span>
<span><span>  </span><span>uses</span><span>:</span><span> </span><span>andstor/file-existence-action@v2.0.0</span></span>
<span><span>  </span><span>with</span><span>:</span></span>
<span><span>    </span><span>files</span><span>:</span><span> </span><span>&#39;</span><span>.changeset/pre.json</span><span>&#39;</span></span>
<span></span>
<span><span># If .changeset/pre.json does not exist and we did not recently exit</span></span>
<span><span># prerelease mode, enter prerelease mode with tag alpha</span></span>
<span><span>-</span><span> </span><span>name</span><span>:</span><span> </span><span>Enter alpha prerelease mode</span></span>
<span><span>  </span><span>if</span><span>:</span><span> </span><span>steps.check_files.outputs.files_exists == &#39;false&#39; &amp;&amp; !contains(github.event.head_commit.message, &#39;Exit prerelease&#39;)</span></span>
<span><span>  </span><span>run</span><span>:</span><span> </span><span>npx changeset pre enter alpha</span></span>
<span></span>
<span><span>-</span><span> </span><span>name</span><span>:</span><span> </span><span>Create alpha release PR</span></span>
<span><span>  </span><span>uses</span><span>:</span><span> </span><span>changesets/action@v1</span></span>
<span><span>  </span><span>with</span><span>:</span></span>
<span><span>    </span><span>version</span><span>:</span><span> </span><span>npm run changeset-version</span></span>
<span><span>  </span><span>env</span><span>:</span></span>
<span><span>    </span><span>GITHUB_TOKEN</span><span>:</span><span> </span><span>${{ secrets.GITHUB_TOKEN }}</span></span>
<span></span>
<span><span># Read package version from package.json</span></span>
<span><span># in case we just published a new version</span></span>
<span><span># and want to pass it to a Discord, etc. bot to announce</span></span>
<span><span># since `steps.changesets.outputs.publishedPackages` is undefined</span></span>
<span><span># for prereleases (though we can read the version there</span></span>
<span><span># for non-pre releases)</span></span>
<span><span>-</span><span> </span><span>name</span><span>:</span><span> </span><span>get-npm-version</span></span>
<span><span>  </span><span>id</span><span>:</span><span> </span><span>package-version</span></span>
<span><span>  </span><span>uses</span><span>:</span><span> </span><span>martinbeentjes/npm-get-version-action@main</span></span>
<span></span>
<span><span>-</span><span> </span><span>name</span><span>:</span><span> </span><span>Run publish</span></span>
<span><span>  </span><span>id</span><span>:</span><span> </span><span>changesets</span></span>
<span><span>  </span><span># Only run publish if we&#39;re still in pre mode and the last commit was</span></span>
<span><span>  </span><span># via an automatically created Version Packages PR</span></span>
<span><span>  </span><span>if</span><span>:</span><span> </span><span>steps.check_files.outputs.files_exists == &#39;true&#39; &amp;&amp; startsWith(github.event.head_commit.message, &#39;Version Packages&#39;)</span></span>
<span><span>  </span><span>run</span><span>:</span><span> </span><span>npm run changeset-publish</span></span></code></pre></div>
<p>Exiting pre mode has <a href="https://github.com/apollographql/apollo-client/blob/main/.github/workflows/exit-prerelease.yml#L1:L1">its own workflow</a> that does two things: removes <code>pre.json</code> and reverts the package number in <code>package.json</code> to the last released version in <code>main</code>, and a separate workflow <a href="https://github.com/apollographql/apollo-client/blob/main/.github/workflows/check-prerelease.yml#L1:L1"><code>check-prerelease.yml</code></a> makes sure <code>pre.json</code> will never be accidentally merged to main.</p>
<h2 id="conclusion"><a href="#conclusion"><span></span></a>Conclusion</h2>
<p>Working with Changesets has been a breath of fresh air! It&#39;s taken a lot of tedious and repetitive tasks out of the release process, and allowed us to focus on the fixes and features on our roadmap. Many thanks to the team that builds and maintains it ðŸ™Œ</p></div></div>
  </body>
</html>
