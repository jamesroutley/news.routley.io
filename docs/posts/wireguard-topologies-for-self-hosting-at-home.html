<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://garrido.io/notes/wireguard-topologies-for-self-hosting-at-home/">Original</a>
    <h1>WireGuard topologies for self-hosting at home</h1>
    
    <div id="readability-page-1" class="page"><article><header><time datetime="2025-09-23 14:12:45 -0600 CST">September 23, 2025</time></header><p>Contents</p><nav id="TableOfContents"><ul><li><a href="#constraints">Constraints</a><ul><li><a href="#first-order-constraints">First-order constraints</a></li><li><a href="#second-order-constraints">Second-order constraints</a></li><li><a href="#non-constraints">Non-constraints</a></li></ul></li><li><a href="#resources">Resources</a></li><li><a href="#topologies">Topologies</a><ul><li><a href="#connecting-all-devices-in-the-same-physical-network-using-point-to-point-networking">Connecting all devices in the same physical network using point-to-point networking</a></li><li><a href="#fixing-an-issue-with-moving-targets">Fixing an issue with moving targets</a></li><li><a href="#connecting-from-the-outside">Connecting from the outside</a></li><li><a href="#adding-a-remote-peer">Adding a remote peer</a></li><li><a href="#routing-packets-through-the-remote-peer">Routing packets through the remote peer</a></li><li><a href="#introducing-hub-and-spoke">Introducing hub-and-spoke</a></li><li><a href="#rethinking-the-home-network-topology">Rethinking the home network topology</a></li><li><a href="#two-hubs-and-one-compromise">Two hubs and one compromise</a></li><li><a href="#reconsidering-the-hub-at-home">Reconsidering the hub at home</a></li><li><a href="#our-final-design">Our final design</a></li></ul></li><li><a href="#parting-thoughts">Parting thoughts</a></li><li><a href="#further-reading">Further reading</a></li></ul></nav><p>I recently migrated my self-hosted services from a VPS (virtual private server) at a remote data center to a physical server at home. This change was motivated by wanting to be in control of the hardware and network where said services run, while trying to keep things as simple as possible. What follows is a walk-through of how I reasoned through different <a href="https://www.wireguard.com/" rel="external noreferrer noopener">WireGuard</a> toplogies for the VPN (virtual private network) in which my devices and services reside.</p><p>Before starting, it’s worth emphasizing that using WireGuard (or a VPN altogether) is ont strictly required for self-hosting. WireGuard implies one more moving part in your system, the cost of which is justified only by what it affords you to do. The constraints that I outline below should provide clarity as to why using WireGuard is appropriate for my needs.</p><p>It goes without saying that not everyone has the same needs, resources, and threat model, all of which a design should account for. That said, there isn’t anything particularly special about what I’m doing. There is likely enough overlap here for this to be useful to individuals or small to medium-sized organizations looking to host their services.</p><p>I hope that this review helps others build a better mental model of WireGuard, and the sorts of networks that you can build up to per practical considerations. Going through this exercise proved to be an excellent learning experience, and that is worthwhile on its own.</p><p>This post assumes some familiarity with networking. This is a subject in which acronyms are frequently employed, so I’ve made sure to spell these out wherever introduced.</p><h2 id="constraints">Constraints</h2><p>The constraints behind the design of my network can be categorized into first-order and second-order constraints. Deploying WireGuard responds to the first-order constraints, whereas the specifics of <em>how</em> WireGuard is deployed responds to the second-order constraints.</p><h3 id="first-order-constraints">First-order constraints</h3><ol><li><p><strong>There should be no dependencies to services or hardware outside of the physical network.</strong> I should be able to connect to my self-hosted services <strong>while I’m at home</strong> as long as there’s electricity in the house and the hardware involved is operating without problems.</p></li><li><p><strong>Borrow elements of the <a href="https://www.nist.gov/publications/zero-trust-architecture" rel="external noreferrer noopener">Zero Trust Architecture</a> where appropriate.</strong> Right now that means treating all of my services and devices as resources, securing <strong>all</strong> communications (i.e not trusting the underlying network), and enforcing least-privileged access.</p></li><li><p><strong>Provisions made to connect to a device from outside the home network should be secondary and optional.</strong> While I do wish to use to my services while I’m away, satisfying this should not compromise the fundamental design of my setup. For example, I shouldn’t rely on tunneling services provided by third-parties.</p></li></ol><p>Choosing to deploy WireGuard is motivated by constraints two and three. Constraint one is not sufficient on its own to necessitate using WireGuard because everything can run on the local area network (LAN).</p><p>Once deployed, I should be able to connect all of my devices using hardware, software, and keys that I control within the boundaries of my home office. These devices all exist in the same physical network, but may reside in separate virtual LANs (VLANs) or subnets. Regardless, WireGuard is used to establish secure communications within and across these boundaries, while working in tandem with network and device firewalls for access control.</p><p>I cannot connect to my home network directly from the wide area network (WAN, e.g the Internet) because it is behind <a href="https://en.wikipedia.org/wiki/Carrier-grade_NAT" rel="external noreferrer noopener">Carrier-Grade Network Address Translation (CGNAT)</a>. A remote host is added to the WireGuard network to establish connections from outside. This host runs on hardware that I do not control, which goes against the spirit of the first constraint. However, an allowance is made considering that the role of this peer is not load-bearing in the overarching design, and can be removed from the network as needed.</p><h3 id="second-order-constraints">Second-order constraints</h3><p>Assuming WireGuard is now inherent in this design, its use should adhere to the following constraints:</p><ol><li><p><strong>Use WireGuard natively as opposed to software that builds on top of WireGuard.</strong> I choose to favor simplicity and ease of understanding rather than convenience or added features, <em>ergo</em>, complexity.</p></li><li><p><strong>Use of a control plane should not be required.</strong> All endpoints are first-class citizens and managed individually, regardless of using a network topology that confers routing responsibilities to a given peer.</p></li></ol><p>Satisfying these constraints preclude the use of solutions such as Tailscale, Headscale, or Netbird. Using WireGuard natively has the added benefit that I can rely on a vetted and stable version as packaged by my Linux distribution of choice, <a href="http://debian.org/" rel="external noreferrer noopener">Debian</a>.</p><h3 id="non-constraints">Non-constraints</h3><p>Lastly, it is worth stating requirements or features that are often found in designs such as these, but that are not currently relevant to me.</p><ol><li><p><strong>Mesh networking and direct peer-to-peer connections.</strong> It’s ok to have peers act as gateways if connections need to be established across different physical or logical networks. The size, throughput, and bandwidth of the network is small enough that prioritizing performance is not strictly necessary.</p></li><li><p><strong>Automatic discovery or key distribution</strong>. It’s ok for nodes in the network to be added or reconfigured manually.</p></li></ol><h2 id="resources">Resources</h2><p>Let’s look at the resources in the network, and how these connect with each other.</p><p>Consider the following matrix. Each row denotes whether the resource in the first column connects <strong>to</strong> the resources in the remaining columns, either to consume a service or perform a task. For example, we can tell that the server does not connect to any device, but all devices connect to the server.</p><table><thead><tr><th></th><th><strong>Server</strong></th><th><strong>Desktop</strong></th><th><strong>Laptop</strong></th><th><strong>Phone</strong></th><th><strong>Tablet</strong></th></tr></thead><tbody><tr><td><strong>Server</strong></td><td></td><td>No</td><td>No</td><td>No</td><td>No</td></tr><tr><td><strong>Desktop</strong></td><td>Yes</td><td></td><td>Yes</td><td>Yes</td><td>No</td></tr><tr><td><strong>Laptop</strong></td><td>Yes</td><td>Yes</td><td></td><td>No</td><td>No</td></tr><tr><td><strong>Phone</strong></td><td>Yes</td><td>Yes</td><td>No</td><td></td><td>No</td></tr><tr><td><strong>Tablet</strong></td><td>Yes</td><td>No</td><td>No</td><td>No</td><td></td></tr></tbody></table><p>Said specifically:</p><ol><li>The desktop computer connects to the server to access a calendar, git repositories, etc</li><li>The tablet connects to the server to download RSS feeds</li><li>The laptop and desktop connect with each other to sync files</li></ol><p>The purpose of this matrix is to determine which connections between devices ought to be supported, <strong>regardless of the network topology</strong>. This informs how WireGuard peers are configured, and what sort of firewall rules need to be established.</p><p>Before proceeding, let’s define the networks and device IP addresses that will be used.</p><table><thead><tr><th>Network</th><th>Protocol</th><th>Address</th><th>Netmask</th><th>Gateway</th></tr></thead><tbody><tr><td>LAN</td><td>IPv4</td><td>192.168.1.0</td><td>255.255.255.0</td><td>192.168.1.1</td></tr><tr><td>WireGuard</td><td>IPv4</td><td>10.55.2.0</td><td>255.255.255.0</td><td>-</td></tr></tbody></table><table><thead><tr><th>Device</th><th>LAN IP address</th><th>WireGuard IP address</th></tr></thead><tbody><tr><td>Desktop computer</td><td>192.168.1.6</td><td>10.55.2.11</td></tr><tr><td>Laptop</td><td>192.168.1.7</td><td>10.55.2.12</td></tr><tr><td>Phone</td><td>192.168.1.8</td><td>10.55.2.13</td></tr><tr><td>Tablet</td><td>192.168.1.9</td><td>10.55.2.14</td></tr><tr><td>Server</td><td>192.168.1.10</td><td>10.55.2.20</td></tr></tbody></table><p>The name of the WireGuard network interface will be <code>wg-home</code>, where applicable<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup>. For purposes of this explanation, port <code>48192</code> will be used in all of the devices when a port needs to be defined.</p><h2 id="topologies">Topologies</h2><p>I’ll explore different topologies as I build to up to the design that I currently employ. By starting with the simplest topology, we can appreciate the benefits and trade-offs involved in each step, while strengthening our conceptual model of WireGuard.</p><p>Each topology below is accompanied by a simple diagram of the network. In it, the orange arrow denotes a device <strong>connecting to</strong> another device. Where two devices connect to each other, a bidirectional arrow is employed. Later on, green arrows denote a device forwarding packets to and from other resources.</p><h3 id="connecting-all-devices-in-the-same-physical-network-using-point-to-point-networking">Connecting all devices in the same physical network using point-to-point networking</h3><figure><picture><source srcset="/notes/wireguard-topologies-for-self-hosting-at-home/images/lan-p2p_hu_58f6e134ea62b637.webp" type="image/webp"/><a href="https://garrido.io/notes/wireguard-topologies-for-self-hosting-at-home/images/lan-p2p.jpg"><img loading="lazy" height="375" alt="Diagram showing point-to-point topology. An arrow connects each device that connects directly with another device, per the connections matrix. All devices are inside a surrounding box that denotes the LAN network." src="https://garrido.io/notes/wireguard-topologies-for-self-hosting-at-home/images/lan-p2p_hu_a92b72a5aee8dc6a.jpg"/></a></picture></figure><p>The basic scenario, and perhaps the most familiar to someone looking to start using WireGuard to self-host at home, is hosting in the network that is established by the router provided by an Internet service provider (ISP). Let’s assume its configuration has not been modified other than changing the Wi-Fi and admin passwords.</p><p>A topology that can be used here is <strong>point-to-point</strong>, where each device lists every other device it connects to as its peer. In WireGuard terminology, “peers” are endpoints configured to connect with each other to establish an encrypted “tunnel” through which packets are sent and received.</p><p>According to the connections matrix, the desktop computer and the server are peers, but the desktop computer and tablet aren’t.</p><p>The WireGuard configuration for the desktop computer looks as follows:</p><div><pre tabindex="0"><code data-lang="ini"><span><span><span>[Interface]</span>
</span></span><span><span><span>Address</span> <span>=</span> <span>10.55.2.11/32</span>
</span></span><span><span><span>ListenPort</span> <span>=</span> <span>48192</span>
</span></span><span><span><span>PrivateKey</span> <span>=</span> <span>kJdAdg2G5sh+BcusDTPYv/nZOscXW5kuh5wILkOC63Q=</span>
</span></span><span><span>
</span></span><span><span><span># Server</span>
</span></span><span><span><span>[Peer]</span>
</span></span><span><span><span>PublicKey</span> <span>=</span> <span>5vj58uZIALlPwhelXQilQgCY0jSN6iOpBZOcZj2shEU=</span>
</span></span><span><span><span>AllowedIPs</span> <span>=</span> <span>10.55.2.20/32</span>
</span></span><span><span><span>Endpoint</span> <span>=</span> <span>192.168.1.10:48192</span>
</span></span><span><span>
</span></span><span><span><span># Laptop</span>
</span></span><span><span><span>[Peer]</span>
</span></span><span><span><span>PublicKey</span> <span>=</span> <span>Aa+dFAg5CWQ3U/ZLJbxfhYiJcW9lJP+tuWZ0ElHuY14=</span>
</span></span><span><span><span>AllowedIPs</span> <span>=</span> <span>10.55.2.12/32</span>
</span></span><span><span><span>Endpoint</span> <span>=</span> <span>192.168.1.7:48192</span>
</span></span><span><span>
</span></span><span><span><span># Phone</span>
</span></span><span><span><span>[Peer]</span>
</span></span><span><span><span>PublicKey</span> <span>=</span> <span>Ri10a7gcZ+sbFc44HvZVOvpTqWydi6OYQWZMMzAo3Eo=</span>
</span></span><span><span><span>AllowedIPs</span> <span>=</span> <span>10.55.2.13/32</span>
</span></span><span><span><span>Endpoint</span> <span>=</span> <span>192.168.1.8:48192</span>
</span></span></code></pre></div><p>Note that the LAN IP address of each peer is specified under <code>Endpoint</code>. This is used to find the peer’s device and establish the WireGuard tunnel. <code>AllowedIPs</code> specifies the IP addresses used <strong>within</strong> the WireGuard network. In other words, the phone is the desktop’s peer, it can be found at <code>192.168.1.8:48192</code> to establish the tunnel.</p><p>Let’s assume each of these devices have firewalls that allow UDP traffic through port <code>48192</code> and all subsequent traffic through the WireGuard <code>wg-home</code> interface. Once the WireGuard configurations of the server, laptop, and phone include the corresponding peers, secure communication is established through the WireGuard network interface.</p><p>Let’s try sending a packet from the desktop computer to the phone.</p><div><pre tabindex="0"><code data-lang="sh"><span><span>$ traceroute 10.55.2.13 
</span></span><span><span>traceroute to 10.55.2.13 <span>(</span>10.55.2.13<span>)</span>, <span>30</span> hops max, <span>60</span> byte packets
</span></span><span><span> <span>1</span>  10.55.2.13 <span>(</span>10.55.2.13<span>)</span>  950.434 ms  950.550 ms  950.493 ms
</span></span></code></pre></div><p>The packet was routed directly to the phone and echoed back.</p><p>At this point access control is enforced in each device’s firewall. Allowing everything that comes through the <code>wg-home</code> interface is convenient, but it should be limited to the relevant ports and protocols for least-privileged access.</p><h3 id="fixing-an-issue-with-moving-targets">Fixing an issue with moving targets</h3><p>An obvious problem with this scenario is that the Dynamic Host Configuration Protocol (DHCP) server in the router likely allocates IP addresses dynamically when devices connect to the LAN network. The IP address for a device may thus change over time, and WireGuard will be unable to find a peer to establish a connection to it.</p><p>For example, I’m at home and my phone dies. The LAN IP address <code>192.168.1.8</code> is freed and assigned to another device that comes online. WireGuard will attempt to connect to <code>192.168.1.8</code> (per <code>Endpoint</code>) and fail for any of the following reasons:</p><ol><li>Said device is not running WireGuard</li><li>Said device is using a different <code>Address</code> or <code>ListenPort</code>, in which case the peer’s <code>AllowedIPs</code> or port in <code>Endpoint</code> does not match</li><li>Said device is using a different <code>PrivateKey</code>, in which case the peer’s <code>PublicKey</code> does not match</li></ol><p>Fortunately, most routers support configuring static IP addresses for a given device in the network. Doing so for all devices in our WireGuard network fixes this problem as the IP address used in <code>Endpoint</code> will be reserved accordingly.</p><h3 id="connecting-from-the-outside">Connecting from the outside</h3><figure><picture><source srcset="/notes/wireguard-topologies-for-self-hosting-at-home/images/lan-p2p-remote_hu_4ffa3a1530ea532d.webp" type="image/webp"/><a href="https://garrido.io/notes/wireguard-topologies-for-self-hosting-at-home/images/lan-p2p-remote.jpg"><img loading="lazy" height="375" alt="Diagram showing point-to-point topology with a device added outside of the LAN network to provide connectivity from the outside." src="https://garrido.io/notes/wireguard-topologies-for-self-hosting-at-home/images/lan-p2p-remote_hu_e32949e4d7b15f59.jpg"/></a></picture></figure><p>Suppose I want to work at a coffee shop, but still need access to something that’s hosted on my home server. As mentioned in the constraints, my home network is behind CGNAT. This means that I cannot connect directly to it using whatever WAN IP address my router is using at the moment.</p><p>What I can do instead is use a device that has a publicly routable IP address and make that a WireGuard peer of our server. In this case that’ll be a VPS in some data center.</p><p>How is the packet ultimately relayed to and from the server at home? Both the server and laptop established direct encrypted tunnels with the VPS. WireGuard on the VPS will receive the encrypted packets from the laptop, decrypt them, and notice that they’re meant for the server. It will then encrypt these packets with the server’s key and send them through the server’s tunnel. It’ll do same thing with the server’s response, except towards the laptop using the laptop’s tunnel.</p><p>A device that forwards packets between peers needs to be configured for IPv4 packet forwarding. I will not cover the specifics of this configuration because it depends on what operating system and firewall are used<sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup>.</p><h3 id="adding-a-remote-peer">Adding a remote peer</h3><p>The VPS has a public IP address of <code>162.231.77.9</code>, and its WireGuard IP address will be <code>10.55.2.2</code>. The laptop and server are listed as peers in its WireGuard configuration:</p><div><pre tabindex="0"><code data-lang="ini"><span><span><span>[Interface]</span>
</span></span><span><span><span>Address</span> <span>=</span> <span>10.55.2.2/32</span>
</span></span><span><span><span>ListenPort</span> <span>=</span> <span>48192</span>
</span></span><span><span><span>PrivateKey</span> <span>=</span> <span>wMKvhMa7BSJvRe9+t7fiymFMqcHlxeI64uhjoLEKPWo=</span>
</span></span><span><span>
</span></span><span><span><span># Server</span>
</span></span><span><span><span>[Peer]</span>
</span></span><span><span><span>PublicKey</span> <span>=</span> <span>5vj58uZIALlPwhelXQilQgCY0jSN6iOpBZOcZj2shEU=</span>
</span></span><span><span><span>AllowedIPs</span> <span>=</span> <span>10.55.2.20/32</span>
</span></span><span><span>
</span></span><span><span><span># Laptop</span>
</span></span><span><span><span>[Peer]</span>
</span></span><span><span><span>PublicKey</span> <span>=</span> <span>Aa+dFAg5CWQ3U/ZLJbxfhYiJcW9lJP+tuWZ0ElHuY14=</span>
</span></span><span><span><span>AllowedIPs</span> <span>=</span> <span>10.55.2.12/32</span>
</span></span></code></pre></div><p>Note that <code>Endpoint</code> is omitted for each peer. The publicly routable IP addresses of the laptop and the home router are not known to us. Even if they were, they cannot be reached by the VPS. However, they will be known to the VPS when these connect to it.</p><p>Now, the server at home adds the VPS as its peer, using the VPS public IP address as its <code>Endpoint</code>:</p><div><pre tabindex="0"><code data-lang="ini"><span><span><span># VPS</span>
</span></span><span><span><span>[Peer]</span>
</span></span><span><span><span>PublicKey</span> <span>=</span> <span>7vXZGWpHp1PimrlbvwQ3sEOFUPx+1kq8Fdq4dv950m0=</span>
</span></span><span><span><span>AllowedIPs</span> <span>=</span> <span>10.55.2.2/32</span>
</span></span><span><span><span>Endpoint</span> <span>=</span> <span>162.231.77.9:48192</span>
</span></span><span><span><span>PersistentKeepalive</span> <span>=</span> <span>25</span>
</span></span></code></pre></div><p>We also make use of <code>PersistentKeepalive</code> to send an empty packet every 25 seconds. This is done to establish the tunnel ahead of time, and to keep it open. This is necessary because otherwise the tunnel may not exist when I’m at the coffee shop trying to access the server at home. Remember, the VPS doesn’t know how to reach the server unless the server is connected to it.</p><h3 id="routing-packets-through-the-remote-peer">Routing packets through the remote peer</h3><p>Let’s take a careful look at the laptop’s configuration, and what we’re looking to achieve. When the laptop is at home, it connects to the server using an endpoint address that is routable within the home LAN network. This endpoint address is not routable when I’m outside, in which case I want the connection to go through the VPS.</p><p>To achieve this, the laptop maintains two mutually-exclusive WireGuard interfaces: <code>wg-home</code> and <code>wg-remote</code>. The former is active only while I’m in the home network, and the latter while I’m on the go.</p><p>Unlike the server, the VPS does not need to be added as a peer to the laptop’s <code>wg-home</code> interface because it doesn’t need connect to it while at home. Instead, the VPS is added to the <code>wg-remote</code> configuration:</p><div><pre tabindex="0"><code data-lang="ini"><span><span><span>[Interface]</span>
</span></span><span><span><span>Address</span> <span>=</span> <span>10.55.2.12/32</span>
</span></span><span><span><span>PrivateKey</span> <span>=</span> <span>EAuj44uBRPWyV6d9I4NKT8WmRQP+a73X/ce+58ZrPVs=</span>
</span></span><span><span>
</span></span><span><span><span># VPS</span>
</span></span><span><span><span>[Peer]</span>
</span></span><span><span><span>PublicKey</span> <span>=</span> <span>7vXZGWpHp1PimrlbvwQ3sEOFUPx+1kq8Fdq4dv950m0=</span>
</span></span><span><span><span>AllowedIPs</span> <span>=</span> <span>10.55.2.2/32, 10.55.2.20/32</span>
</span></span><span><span><span>Endpoint</span> <span>=</span> <span>162.231.77.9:48192</span>
</span></span></code></pre></div><p>The <code>[Interface]</code> section for both <code>wg-home</code> and <code>wg-remote</code> is mostly the same. The laptop should have the same adress and key, regardless of where it is. Only <code>ListenPort</code> is omitted in <code>wg-remote</code> because no other device will look to connect to it, in which case we can have WireGuard set a port dynamically.</p><p>What differs is the peer configuration. In <code>wg-remote</code> the VPS is set as the only peer. However, the home server’s IP address <code>10.55.2.20</code> is added to the VPS’ list of <code>AllowedIPs</code>. WireGuard uses this information to route any packets for the VPS <em>or</em> the server through the VPS.</p><p>Unlike the server’s peer configuration for the VPS, <code>PersistentKeepalive</code> is not needed because the laptop is always the one initiating the tunnel when it reaches out to the server.</p><p>We can verify that packets are being routed appropriately to the server through the VPS:</p><div><pre tabindex="0"><code data-lang="sh"><span><span>$ traceroute 10.55.2.20 
</span></span><span><span>traceroute to 10.55.2.20 <span>(</span>10.55.2.20<span>)</span>, <span>30</span> hops max, <span>60</span> byte packets
</span></span><span><span> <span>1</span>  10.55.2.2 <span>(</span>10.55.2.2<span>)</span>  314.556 ms  314.482 ms  314.469 ms
</span></span><span><span> <span>2</span>  10.55.2.20 <span>(</span>10.55.2.20<span>)</span>  320.954 ms  320.821 ms 320.870 ms
</span></span></code></pre></div><h3 id="introducing-hub-and-spoke">Introducing hub-and-spoke</h3><p>We solved for outside connectivity using a network topology called hub-and-spoke. The laptop and home server are not connecting point-to-point.</p><p>The VPS acts as a hub or gateway through which connections among members of the network (i.e the spokes) are routed. If we scope down our network to just the laptop and the home server, we see how this hub is not only a peer of every spoke, but also just its only peer.</p><p>Yet, how exactly is the packet routed back to the laptop? Mind you, at home the laptop is a peer of the server. When the server responds to the laptop, it will attempt to route the response directly to the laptop’s peer endpoint. This fails because the laptop is not actually reachable via that direct connection when I’m on the go. This makes the laptop a “roaming client”; it connects to the network from different locations, and its <code>Endpoint</code> may change.</p><p>This all works because the hub has been configured to do Network Address Translation (NAT); it is replacing the source address of each packet for its own as it is being forwarded. The spokes at end of each hub accept the packets because they appear to originate from its peer. In other words, when the laptop is reaching out to the home server, the server sees traffic coming from the VPS and returns it there.</p><p>The hub is forwarding packets among the spokes without regards to access control. Thus, its firewall should be configured for least-privilege access. For example, if the laptop is only accessing git repositories in the home server over SSH, then the hub firewall should only allow forwarding from the laptop’s peer connection to the home server’s IP address and SSH port.</p><p>Let’s reiterate. If I now wish to sync my laptop with my desktop computer from outside the network, I would be adding yet another spoke to this hub. The desktop computer and the VPS configure each other as peers, while the desktop’s IP address is included in the VPS’ <code>AllowedIPs</code> list of the laptop’s <code>wg-remote</code> configuration.</p><div><pre tabindex="0"><code data-lang="diff"><span><span><span>+ AllowedIPs = 10.55.2.2/32, 10.55.2.20/32, 10.55.2.11/32
</span></span></span><span><span><span></span><span>- AllowedIPs = 10.55.2.2/32, 10.55.2.20/32
</span></span></span></code></pre></div><h3 id="rethinking-the-home-network-topology">Rethinking the home network topology</h3><p>Our topology <em>within</em> the home network is still point-to-point. As soon as I return home, my laptop will connect directly to the server when I toggle <code>wg-remote</code> off and <code>wg-home</code> on. But now that we know about <strong>hub-and-spoke</strong>, it might make sense to consider using it at home as well.</p><figure><picture><source srcset="/notes/wireguard-topologies-for-self-hosting-at-home/images/lan-hs_hu_e49e5313ce05b435.webp" type="image/webp"/><a href="https://garrido.io/notes/wireguard-topologies-for-self-hosting-at-home/images/lan-hs.jpg"><img loading="lazy" height="375" alt="Diagram showing hub-and-spoke topology in the home network. All devices have an arrow that connect them to the server box." src="https://garrido.io/notes/wireguard-topologies-for-self-hosting-at-home/images/lan-hs_hu_d2de0590db210cbb.jpg"/></a></picture></figure><p>According to the connection matrix, the server can assume the role of a hub because all other devices already connect to it. Likewise, the server runs 24/7, so it will always be online to route packets.</p><p>This topology simplifies the WireGuard configurations for all of the spokes. The desktop computer, phone, laptop, and tablet can now list the server as its only peer in <code>wg-home</code>.</p><p>This is convenient because now only one static address in the LAN network needs to be allocated by the DHCP server – the server’s.</p><p>Consider the changes to the WireGuard configuration of the desktop computer.</p><div><pre tabindex="0"><code data-lang="diff"><span><span>[Interface]
</span></span><span><span>Address = 10.55.2.11/32
</span></span><span><span>ListenPort = 48192
</span></span><span><span>PrivateKey = kJdAdg2G5sh+BcusDTPYv/nZOscXW5kuh5wILkOC63Q=
</span></span><span><span>
</span></span><span><span># Server
</span></span><span><span>[Peer]
</span></span><span><span>PublicKey = 5vj58uZIALlPwhelXQilQgCY0jSN6iOpBZOcZj2shEU=
</span></span><span><span><span>- AllowedIPs = 10.55.2.20/32
</span></span></span><span><span><span></span><span>+ AllowedIPs = 10.55.2.20/32, 10.55.2.12/32, 10.55.2.13/231
</span></span></span><span><span><span></span>Endpoint = 192.168.1.10:48192
</span></span><span><span><span>-
</span></span></span><span><span><span>- # Laptop
</span></span></span><span><span><span>- [Peer]
</span></span></span><span><span><span>- PublicKey = Aa+dFAg5CWQ3U/ZLJbxfhYiJcW9lJP+tuWZ0ElHuY14=
</span></span></span><span><span><span>- AllowedIPs = 10.55.2.12/32
</span></span></span><span><span><span>- Endpoint = 192.168.1.7:48192
</span></span></span><span><span><span>-
</span></span></span><span><span><span>- # Phone
</span></span></span><span><span><span>- [Peer]
</span></span></span><span><span><span>- PublicKey = Ri10a7gcZ+sbFc44HvZVOvpTqWydi6OYQWZMMzAo3Eo=
</span></span></span><span><span><span>- AllowedIPs = 10.55.2.13/32
</span></span></span><span><span><span>- Endpoint = 192.168.1.8:48192
</span></span></span><span><span><span>-
</span></span></span><span><span><span>-# VPS
</span></span></span><span><span><span>-[Peer]
</span></span></span><span><span><span>-PublicKey = 7vXZGWpHp1PimrlbvwQ3sEOFUPx+1kq8Fdq4dv950m0=
</span></span></span><span><span><span>-AllowedIPs = 10.55.2.2/32
</span></span></span><span><span><span>-Endpoint = 162.231.77.9:48192
</span></span></span></code></pre></div><p>All peers are removed except the server, and the IPs of the phone and laptop are added to the server’s of <code>AllowedIPs</code>. WireGuard will route packets for these other hosts through the server. We could also use Classless Inter-Domain Routing (CIDR) notation to state that packets for <em>all</em> hosts in the WireGuard network go through the server peer:</p><div><pre tabindex="0"><code data-lang="diff"><span><span><span>+ AllowedIPs = 10.55.2.0/24
</span></span></span><span><span><span></span><span>- AllowedIPs = 10.55.2.20/32, 10.55.2.12/32, 10.55.2.13/231
</span></span></span></code></pre></div><p>The server, in turn, keeps listing every device at home as its peer but no longer needs an <code>Endpoint</code> for each. The peers will initiate the connection to the server.</p><div><pre tabindex="0"><code data-lang="diff"><span><span>[Interface]
</span></span><span><span>Address = 10.55.2.20/32
</span></span><span><span>ListenPort = 48192
</span></span><span><span>PrivateKey = qFu8xkaA69wnX8aWURUUNAf9Ll1yU8RvjXczCiXbMGM=
</span></span><span><span>
</span></span><span><span># Desktop
</span></span><span><span>[Peer]
</span></span><span><span>PublicKey = doTWOdYC8hwpKVrc6tK4UHEXspO4CuajPORLHOeri2c=
</span></span><span><span>AllowedIPs = 10.55.2.11/32
</span></span><span><span><span>- Endpoint = 192.168.1.6:48192
</span></span></span><span><span><span></span>
</span></span><span><span># Laptop
</span></span><span><span>[Peer]
</span></span><span><span>PublicKey = Aa+dFAg5CWQ3U/ZLJbxfhYiJcW9lJP+tuWZ0ElHuY14=
</span></span><span><span>AllowedIPs = 10.55.2.12/32
</span></span><span><span><span>- Endpoint = 192.168.1.7:48192
</span></span></span><span><span><span></span>
</span></span><span><span># Phone
</span></span><span><span>[Peer]
</span></span><span><span>PublicKey = Ri10a7gcZ+sbFc44HvZVOvpTqWydi6OYQWZMMzAo3Eo=
</span></span><span><span>AllowedIPs = 10.55.2.13/32
</span></span><span><span><span>- Endpoint = 192.168.1.8:48192
</span></span></span><span><span><span></span>
</span></span><span><span># Tablet
</span></span><span><span>[Peer]
</span></span><span><span>PublicKey = dcRjeKjoDujcH/Ziy4stHIzCXSr+tlaeeyP6IEcc+EY=
</span></span><span><span>AllowedIPs = 10.55.2.14/32
</span></span><span><span><span>- Endpoint = 192.168.1.9:48192
</span></span></span><span><span><span></span>
</span></span><span><span># VPS
</span></span><span><span>[Peer]
</span></span><span><span>PublicKey = 7vXZGWpHp1PimrlbvwQ3sEOFUPx+1kq8Fdq4dv950m0=
</span></span><span><span>AllowedIPs = 10.55.2.2/32, 10.55.2.20/32
</span></span><span><span>Endpoint = 162.231.77.9:48192
</span></span></code></pre></div><p>Once again, let’s test sending a packet from the desktop computer to the phone.</p><div><pre tabindex="0"><code data-lang="sh"><span><span>$ traceroute 10.55.2.13 
</span></span><span><span>traceroute to 10.55.2.13 <span>(</span>10.55.2.13<span>)</span>, <span>30</span> hops max, <span>60</span> byte packets
</span></span><span><span> <span>1</span>  10.55.2.20 <span>(</span>10.55.2.20<span>)</span>  1.190 ms  1.328 ms  1.528 ms
</span></span><span><span> <span>2</span>  10.55.2.13 <span>(</span>10.55.2.13<span>)</span>  49.954 ms  50.142 ms  50.104 ms
</span></span></code></pre></div><p>The packet was hops once through the server (<code>10.55.2.20</code>), is received by the phone, and is echoed back.</p><p>The downside to this topology is that the server is now a single point of failure. If the server dies then the spokes won’t be able to connect with each other through WireGuard. There’s also an added cost to having every packet flow through the hub.</p><p>As for access control, much like we saw in the VPS, the hub now concentrates firewalling responsibilities. It knows which peer is looking to connect to which peer, thus it should establish rules for which packets can be forwarded. This is not mutually exclusive with input firewall rules on each device; those should exist as well.</p><h3 id="two-hubs-and-one-compromise">Two hubs and one compromise</h3><p>We’ve seen that home hub will route packets between the spokes. Furthermore, because it is peer of the VPS, the server can be used to route connections coming from outside the LAN network. Effectively, these are two hubs that connect to each other so that packets can flow across separate physical networks.</p><p>If the laptop wants to sync with the desktop while it is outside the LAN network, then the packets make two hops: once through the VPS, and another through the server. If the laptop is within the LAN network, the packets hop only once through the server.</p><p>Yet, there’s a subtle caveat to this design. The laptop can initiate a sync with the desktop from outside the LAN network and receive the response that it expects. However, the desktop can only initiate a sync with the laptop while the latter is within the LAN network. Why?</p><p>Similar to our previous example of the laptop communicating with the server, the laptop is configured as a peer of the home hub. When the desktop initiates a sync, the server will attempt to route the packet to the laptop. Per our last change, the laptop doesn’t have a fixed <code>Endpoint</code> and there is no established tunnel because the laptop is outside the network. Additionally, the home hub is not configured to route packets destined for the laptop through the VPS peer. The packet is thus dropped by the hub.</p><p>One could look into making the routing dynamic such that the packets are delivered through other means, perhaps through mesh networking. But herein lies a compromise that I’ve made. In this design, a spoke in the home hub cannot initiate connections to a roaming client. It can only receive connections from them, because the roaming client uses NAT through the remote hub.</p><p>I’m perfectly fine with this compromise as I don’t actually need this bidirectionality, and I don’t want the additional complexity from solving this issue. The remote hub facilitates tunneling <em>into</em> the home hub, not <em>out</em> of. My needs call for allowing my mobile devices (e.g laptop, phone, tablet) to communicate with the non-mobile devices at home (e.g server, desktop), and this has been solved.</p><h3 id="reconsidering-the-hub-at-home">Reconsidering the hub at home</h3><p>At this point we’re done insofar the overarching topology of our WireGuard network, but there is an improvement that can be made to make our home hub less brittle.</p><figure><picture><source srcset="/notes/wireguard-topologies-for-self-hosting-at-home/images/lan-hs-r_hu_49b38cc63599695a.webp" type="image/webp"/><a href="https://garrido.io/notes/wireguard-topologies-for-self-hosting-at-home/images/lan-hs-r.jpg"><img loading="lazy" height="375" alt="Diagram showing hub-and-spoke topology in the home network. All devices have an arrow that connect them to the router box." src="https://garrido.io/notes/wireguard-topologies-for-self-hosting-at-home/images/lan-hs-r_hu_76c60983f8f479f4.jpg"/></a></picture></figure><p>Consider the case where I’m using a router that can run WireGuard. Making the router the hub of our home network poses some benefits over the previous setup.</p><p>First, the router is already a single point of failure by way of being responsible for the underlying LAN network. Making the router the hub isn’t as costly as it is with some other device in the network.</p><p>Second, all devices in the network are already connected to the router. This simplifies the overall configuration because it is no longer necessary to configure static IP addresses in the DHCP server. Instead, each spoke can use the network gateway address to reach the hub.</p><p>Let’s the assume that the gateway for the LAN network is <code>192.168.1.1</code>, and the WireGuard IP address for the router is <code>10.55.2.1</code>.</p><p>Each spoke replaces the server peer with the router’s, and uses the gateway address for its <code>Endpoint</code>. For example, in the desktop computer:</p><div><pre tabindex="0"><code data-lang="diff"><span><span>[Interface]
</span></span><span><span>Address = 10.55.2.11/32
</span></span><span><span>ListenPort = 48192
</span></span><span><span>PrivateKey = kJdAdg2G5sh+BcusDTPYv/nZOscXW5kuh5wILkOC63Q=
</span></span><span><span>
</span></span><span><span><span>+ # Router
</span></span></span><span><span><span>+ [Peer]
</span></span></span><span><span><span>+ PublicKey = bGDvNVfFvSsZtku3vXZx2xzgLIC8mtfQLCfcVy/gajs=
</span></span></span><span><span><span>+ AllowedIPs = 10.55.2.0/24
</span></span></span><span><span><span>+ Endpoint = 192.168.1.1:48192
</span></span></span><span><span><span></span><span>- # Server
</span></span></span><span><span><span>- [Peer]
</span></span></span><span><span><span>- PublicKey = 5vj58uZIALlPwhelXQilQgCY0jSN6iOpBZOcZj2shEU=
</span></span></span><span><span><span>- AllowedIPs = 10.55.2.0/24
</span></span></span><span><span><span>- Endpoint = 192.168.1.10:48192
</span></span></span></code></pre></div><p>The server is demoted to a spoke and is configured like all other spokes. In turn, the router lists all peers like the server previously did:</p><div><pre tabindex="0"><code data-lang="ini"><span><span><span>[Interface]</span>
</span></span><span><span><span>Address</span> <span>=</span> <span>10.55.2.1/32</span>
</span></span><span><span><span>ListenPort</span> <span>=</span> <span>48192</span>
</span></span><span><span><span>PrivateKey</span> <span>=</span> <span>UN8CdQKylNzjP7LpB+nSmMoeBxvmPtvtDKG2RylZZ10=</span>
</span></span><span><span>
</span></span><span><span><span># Server</span>
</span></span><span><span><span>[Peer]</span>
</span></span><span><span><span>PublicKey</span> <span>=</span> <span>5vj58uZIALlPwhelXQilQgCY0jSN6iOpBZOcZj2shEU=</span>
</span></span><span><span><span>AllowedIPs</span> <span>=</span> <span>10.55.2.20/32</span>
</span></span><span><span>
</span></span><span><span><span># Desktop</span>
</span></span><span><span><span>[Peer]</span>
</span></span><span><span><span>PublicKey</span> <span>=</span> <span>doTWOdYC8hwpKVrc6tK4UHEXspO4CuajPORLHOeri2c=</span>
</span></span><span><span><span>AllowedIPs</span> <span>=</span> <span>10.55.2.11/32</span>
</span></span><span><span>
</span></span><span><span><span># Laptop</span>
</span></span><span><span><span>[Peer]</span>
</span></span><span><span><span>PublicKey</span> <span>=</span> <span>Aa+dFAg5CWQ3U/ZLJbxfhYiJcW9lJP+tuWZ0ElHuY14=</span>
</span></span><span><span><span>AllowedIPs</span> <span>=</span> <span>10.55.2.12/32</span>
</span></span><span><span>
</span></span><span><span><span># Phone</span>
</span></span><span><span><span>[Peer]</span>
</span></span><span><span><span>PublicKey</span> <span>=</span> <span>Ri10a7gcZ+sbFc44HvZVOvpTqWydi6OYQWZMMzAo3Eo=</span>
</span></span><span><span><span>AllowedIPs</span> <span>=</span> <span>10.55.2.13/32</span>
</span></span><span><span>
</span></span><span><span><span># Tablet</span>
</span></span><span><span><span>[Peer]</span>
</span></span><span><span><span>PublicKey</span> <span>=</span> <span>dcRjeKjoDujcH/Ziy4stHIzCXSr+tlaeeyP6IEcc+EY=</span>
</span></span><span><span><span>AllowedIPs</span> <span>=</span> <span>10.55.2.14/32</span>
</span></span><span><span>
</span></span><span><span><span># VPS</span>
</span></span><span><span><span>[Peer]</span>
</span></span><span><span><span>PublicKey</span> <span>=</span> <span>7vXZGWpHp1PimrlbvwQ3sEOFUPx+1kq8Fdq4dv950m0=</span>
</span></span><span><span><span>AllowedIPs</span> <span>=</span> <span>10.55.2.2/32, 10.55.2.20/32</span>
</span></span><span><span><span>Endpoint</span> <span>=</span> <span>162.231.77.9:48192</span>
</span></span></code></pre></div><p>Again, the firewall in the router is now responsible for enforcing access control between spokes.</p><h3 id="our-final-design">Our final design</h3><p>For the sake of illustrating how much further the underlying networks can evolve without interfering with the WireGuard network, consider the final design.</p><figure><picture><source srcset="/notes/wireguard-topologies-for-self-hosting-at-home/images/lan-hs-multiple_hu_2f20144342ece540.webp" type="image/webp"/><a href="https://garrido.io/notes/wireguard-topologies-for-self-hosting-at-home/images/lan-hs-multiple.jpg"><img loading="lazy" height="375" alt="Diagram showing hub-and-spoke topology in the home network, as well as outside of the network. All devices have an arrow that connect it to the corresponding hub." src="https://garrido.io/notes/wireguard-topologies-for-self-hosting-at-home/images/lan-hs-multiple_hu_4c62e1d473c6f160.jpg"/></a></picture></figure><p>I’ve broken apart the LAN network into separate VLANs to isolate network traffic. The server resides in its own VLAN, and client devices in another. The router keeps on forwarding packets in WireGuard network regardless of where these devices are.</p><p>The only change that is necessary to keep things working is to update <code>Endpoint</code> address for the router peer in each spoke. The spoke now uses the corresponding VLAN gateway address, rather than that of the LAN network:</p><div><pre tabindex="0"><code data-lang="diff"><span><span>[Interface]
</span></span><span><span>Address = 10.55.2.11/32
</span></span><span><span>ListenPort = 48192
</span></span><span><span>PrivateKey = kJdAdg2G5sh+BcusDTPYv/nZOscXW5kuh5wILkOC63Q=
</span></span><span><span>
</span></span><span><span># Router
</span></span><span><span>[Peer]
</span></span><span><span>PublicKey = bGDvNVfFvSsZtku3vXZx2xzgLIC8mtfQLCfcVy/gajs=
</span></span><span><span>AllowedIPs = 10.55.2.1/32, 10.55.2.0/24
</span></span><span><span><span>+ Endpoint = 10.2.0.1:48192
</span></span></span><span><span><span></span><span>- Endpoint = 192.168.1.1:48192
</span></span></span></code></pre></div><h2 id="parting-thoughts">Parting thoughts</h2><p>I’ve been using this setup for some months now and it’s been working without issues. A couple of thoughts come to mind having gone through this exercise and written about it.</p><p>Running WireGuard on the router simplifies things considerably. If the home network were not behind CGNAT then I could do away with the VPS hub altogether. I would still need separate WireGuard interfaces for when I’m on the go, but that’s not a big deal. Nonetheless, <em>within</em> the LAN network, configuration is simpler by using a hub-and-spoke topology with the router as hub. Centralizing access control on the router’s firewall is also appreciated.</p><p>WireGuard is simple to deploy and it <em>just</em> works. Nonetheless, some knowledge of networking is required to think through how to deploy WireGuard appropriately for a given context. Being comfortable with configuring interfaces and firewalls is also necessary to troubleshoot the inevitable connectivity issues.</p><p>One can appreciate why solutions that abstract over WireGuard exist. I used Tailscale extensively before this and did not have think through things as much as I did here. This was all solved for me. I just had to install the agent on each device, authorize it, and suddenly packets moved securely and efficiently across networks.</p><p>And yet, WireGuard was there all along and I knew that I could unearth the abstraction. Now I appreciate its simplicity even more, and take relish in having a stronger understanding of what I previously took for granted.</p><p>Lastly, I purposefully omitted other aspects of my WireGuard setup for self-hosting, particularly around DNS. This will be the subject of another article, which is rather similar to the one I wrote on using <a href="https://garrido.io/notes/tailscale-nextdns-custom-domains/">Tailscale with custom domains</a>. Furthermore, a closer look at access control in this topology might be of interest to others considering that there are multiple firewalls that come into play.</p><h2 id="further-reading">Further reading</h2><ul><li><a href="https://www.wireguard.com/papers/wireguard.pdf" rel="external noreferrer noopener">WireGuard: Next Generation Kernel Network Tunnel</a></li><li><a href="https://mwl.link/networking-for-system-administrators.html" rel="external noreferrer noopener">Networking for System Administrators</a></li><li><a href="https://www.procustodibus.com/blog/2020/10/wireguard-topologies/" rel="external noreferrer noopener">Primary WireGuard Topologies</a></li><li><a href="https://tailscale.com/blog/how-tailscale-works" rel="external noreferrer noopener">How Tailscale works</a></li></ul></article></div>
  </body>
</html>
