<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ianthehenry.com/posts/zsh-autoquoter/">Original</a>
    <h1>Zsh-autoquoter makes shell quoting slightly less annoying</h1>
    
    <div id="readability-page-1" class="page"><article>

<div><p>Earlier this year I wrote <a href="https://github.com/ianthehenry/zsh-autoquoter">zsh-autoquoter</a>, a little zsh extension that automatically quotes arguments to commands of my choice.</p>

<p>I’ve been using it for a few months now, and I’ve gotta say: it’s pretty nice! I wish I’d written this a long time ago. Here are a few use cases I’ve found for it so far:</p>

<p><code>git</code> has a neat feature where you can specify a commit message directly on the command line, with the <code>-m</code> flag:</p>
<div><pre tabindex="0"><code data-lang="bash">$ git commit -m <span>&#39;fix typo&#39;</span>
</code></pre></div><p>It’s really useful for repositories like this blog, where almost every commit is a short little memo like that. But sometimes I want to write something a little more complicated:</p>
<div><pre tabindex="0"><code data-lang="bash">$ git commit -m <span>&#34;\&#34;fire\&#34; wasn&#39;t clear; rename to \&#34;fire_the_missiles\&#34;&#34;</span>
</code></pre></div><p>Now, I like to commit “early and often,” using a patch queue workflow, and then rebase entire branches in order to get them ready for “publication” to the outside world. So I do this a lot. And it’s not <em>that</em> annoying to open up a vim buffer to write this, but it’s <em>slightly</em> more friction than just typing it directly.</p>

<p>Sometimes I want to run complicated shell commands on remote servers, with globs and pipelines and quoted arguments and all sorts of things, without actually starting up an interactive session on that server.</p>
<p><code>ssh</code> makes this… possible. But I find it really difficult to wrangle all the nested quoting that this entails.</p>
<p>Here’s a simple example of what I mean:</p>
<div><pre tabindex="0"><code data-lang="bash">$ ssh user@host <span>&#34;awk &#39;{print </span><span>$1</span><span>}&#39; file.txt&#34;</span>
</code></pre></div><p>See the problem? <code>$1</code> is going to be expanded as a shell variable, and fortunately syntax highlighting makes the mistake obvious. (You do have <a href="https://github.com/zsh-users/zsh-syntax-highlighting">syntax highlighting</a> in your shell, right?)</p>
<p>To pass a literal <code>$1</code> to <code>awk</code>, you <em>actually</em> have to write:</p>
<div><pre tabindex="0"><code data-lang="bash">ssh user@host <span>&#39;awk &#34;{print $1}&#34; file.txt&#39;</span>
</code></pre></div><p>Except, of course, that’s still wrong. You’ve just moved the problem to the remote server. You <em>actually actually</em> have to write something like:</p>
<div><pre tabindex="0"><code data-lang="bash">$ ssh user@host <span>&#34;awk &#39;{print \$1}&#39; file.txt&#34;</span>
</code></pre></div><p>(Or is it <code>\\$1</code>?)</p>
<p>But with zsh-autoquoter, you don’t have to do any of that. You just type the obvious thing; the same thing you would type if you were running a local command:</p>
<pre><code>$ ssh user@host awk &#39;{print $1}&#39; file.txt
</code></pre>
<p>And it will do the thing you want.</p>

<p>Once upon a time I wrote a little command-line todo list app to help keep track of my stack at work.</p>
<pre><code>todo &#39;write a blog post about zsh-autoquoter&#39;
</code></pre>
<p>I liked the app; I liked the interface; I liked how simple it was. But it suffered from a simple ergonomic problem: English strings are really annoying to type on the command line.</p>
<pre><code>todo &#39;rework dackery&#39;\&#39;&#39;s speech about the &#34;hex machine&#34;&#39;
</code></pre>
<p>But now I can add a zsh-autoquoter rule for it, and give it another try.</p>

<p>A neat feature of <a href="https://ianthehenry.com/posts/a-cozy-nest-for-your-scripts/"><code>sd</code></a> is the ability to quickly stash useful oneliners:</p>
<pre><code>sd video poster --new &#39;ffmpeg -i &#34;$1&#34; -vframes 1 &#34;${basename $1}-poster.png&#34; -y&#39;
</code></pre>
<p>That <em>particular</em> example happened to fit into single quotes. But I would really like to be able to stash arbitrary commands without worrying about how to escape them. Like this one, for example:</p>
<pre><code>nix-env -qaA &#34;nixpkgs.$1&#34; --json | jq -r &#39;.[] | .name + &#34; &#34; + .meta.description, &#34;&#34;, (.meta.longDescription | rtrimstr(&#34;\n&#34;))&#39;
</code></pre>
<p>How am I supposed to quote <em>that</em> monstrosity? Well, with zsh-autoquoter, of course.</p>

<p>For many years I have been taking notes in a simple text file, using a Mac GUI application called <a href="https://www.alfredapp.com">Alfred</a>. I press a shortcut, Alfred pops up, and I type my note:</p>
<a href="https://ianthehenry.com/posts/zsh-autoquoter/alfred_hu9109df11ae5e20ae44a255e1d26d4b3e_52685_1246x1246_fit_box_3.png"><picture><source type="image/webp" srcset="/posts/zsh-autoquoter/alfred_hu9109df11ae5e20ae44a255e1d26d4b3e_52685_623x623_fit_q75_h1_box_3.webp 623w,
/posts/zsh-autoquoter/alfred_hu9109df11ae5e20ae44a255e1d26d4b3e_52685_1246x1246_fit_q75_h1_box_3.webp 1246w,
/posts/zsh-autoquoter/alfred_hu9109df11ae5e20ae44a255e1d26d4b3e_52685_375x375_fit_q75_h1_box_3.webp 375w,
/posts/zsh-autoquoter/alfred_hu9109df11ae5e20ae44a255e1d26d4b3e_52685_750x750_fit_q75_h1_box_3.webp 750w" sizes="(max-width: 400px) 375px, 623px"/><img srcset="/posts/zsh-autoquoter/alfred_hu9109df11ae5e20ae44a255e1d26d4b3e_52685_623x623_fit_box_3.png 623w,
/posts/zsh-autoquoter/alfred_hu9109df11ae5e20ae44a255e1d26d4b3e_52685_1246x1246_fit_box_3.png 1246w,
/posts/zsh-autoquoter/alfred_hu9109df11ae5e20ae44a255e1d26d4b3e_52685_375x375_fit_box_3.png 375w,
/posts/zsh-autoquoter/alfred_hu9109df11ae5e20ae44a255e1d26d4b3e_52685_750x750_fit_box_3.png 750w" alt="" title="" sizes="(max-width: 400px) 375px, 623px" width="623" height="187"/></picture></a>
<p>Using Alfred for this is a little silly, and I would <em>like</em> to replace this “workflow” with this tiny shell script:</p>
<pre><code>$ cat ~/bin/note
</code></pre>
<div><pre tabindex="0"><code data-lang="bash"><span>#!/usr/bin/env bash
</span><span></span>
<span>set</span> -euo pipefail

<span>printf</span> <span>&#39;%s %s\n&#39;</span> <span>$(</span>date <span>&#39;+%Y-%m-%d&#39;</span><span>)</span> <span>&#34;</span><span>$1</span><span>&#34;</span> &gt;&gt; ~/Dropbox/notes.txt
</code></pre></div><p>But these notes can be long, free-from things. It would have been a nightmare to write something like this, for example:</p>
<pre tabindex="0"><code>2022-01-08 TIL about SSH &#34;key types&#34; and &#34;signature types&#34; being different. if 
i want to use this key i have to configure sshd to accept ssh-rsa-sha2-256, not 
just ssh-rsa. the error message says that ssh-rsa isn&#39;t supported, but it
actually means this particular signature type
</code></pre><p>But not anymore!</p>

<p>Tempted? <a href="https://github.com/ianthehenry/zsh-autoquoter">Give it a spin!</a> The extension should work with any zsh plugin manager, and the readme explains how to configure it and enable the (optional) <a href="https://github.com/zsh-users/zsh-syntax-highlighting">zsh-syntax-highlighting</a> integration.</p>
<p>Apparently you’re supposed to end posts like this with a prominent call to action, so <a href="https://en.wikipedia.org/wiki/Luna_moth">go check out this crazy moth I found on Wikipedia</a>.</p></div>
</article></div>
  </body>
</html>
