<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://annahope.me/blog/when-is-rust-as-okay/">Original</a>
    <h1>When is it okay to cast types with `as`?</h1>
    
    <div id="readability-page-1" class="page"><div>
    <article>
      

      <span> 6 min read <span></span> July 11, 2024 <span></span>updated: July 14, 2024 <span></span> #<a href="https://annahope.me/tags/rust/">rust</a>  #<a href="https://annahope.me/tags/programming/">programming</a> </span>

    


<p><small><strong>Update:</strong> Added a section about using <code>as</code> to cast to wider types.</small></p>
<p><small><a rel="noopener" target="_blank" href="https://travellingcryptographer.com/"><code>swan</code></a> asked me this after reading an earlier version of 
<a href="https://annahope.me/blog/rust-as/">&#34;Surprises with Rust&#39;s <code>as</code>&#34;</a>. I thought that post had already gotten long,
so I decided to break this part out. I recommend reading that post first if you want the full context.</small></p>
<p>This is a complicated question. I don&#39;t think there are absolute answers
in software engineering — and we should probably beware people who
<a rel="noopener" target="_blank" href="https://www.linkedin.com/feed/update/urn:li:activity:7209966198703161344/">try to give them.</a>
Almost every engineering decision requires trade-offs, and this is 100% the case with
using <a rel="noopener" target="_blank" href="https://doc.rust-lang.org/std/convert/trait.TryFrom.html#examples"><code>TryFrom</code></a> 
instead of <code>as</code>. <code>TryFrom</code> gives us more certainty that this
particular part of our codebase won&#39;t cause us surprises, but we trade away simplicity and convenience.</p>
<p>For me, that trade-off is worth it. When my code — or any code I have to work with — encounters something
unexpected that it can&#39;t handle correctly, I prefer it to fail as fast as possible
and give me as much relevant context as possible, instead of chugging on and
doing strange things (and making me go on a wild chase to find the cause). So, I am clearly biased against <code>as</code>.</p>
<p>With that said, casting types with <code>as</code> is <em>probably</em> okay if:</p>
<ul>
<li>You are building a toy project or a prototype just to learn or figure something out</li>
<li>And you just need to get it working and don&#39;t care about handling errors</li>
<li>And you&#39;re 100% sure that this will always be a toy project or a prototype
where you won&#39;t care about handling errors (I&#39;ve made the wrong assumption with this before)</li>
<li>And if you&#39;re not 100% sure, you leave notes/issues/tickets/<code>// TODO</code> comments to replace <code>as</code> with <code>TryFrom</code>
for when you start to care about handling errors, <em>and pinky promise to actually do that</em></li>
<li>Or you&#39;re an experienced Rust programmer doing some low-level type juggling, and
you have considered all the possible ranges and types of values your code would ever deal with,
and determined that <code>as</code> is the best option, in which case you probably don&#39;t need my advice on this
(but I would welcome your feedback!)</li>
</ul>
<p>So, in short, something like this:</p>
<pre data-lang="rust"><code data-lang="rust"><span></span><span></span><span><span>let</span> byte <span>=</span> some_char <span>as</span> <span>u8</span><span>;</span>
</span></code></pre>
<p>Otherwise, if in doubt, I don&#39;t think it would be a bad idea to use <code>TryFrom</code> instead.</p>
<p><small>I appreciate <code>swan</code>&#39;s feedback that led to this addendum, and hope that it helps!</small></p>
<h2 id="using-as-to-widen-types"><a href="#using-as-to-widen-types" aria-label="Anchor link for: using-as-to-widen-types">§</a>Using <code>as</code> to widen types</h2>
<p>As <a rel="noopener" target="_blank" href="https://ryanisaacg.com/">Ryan Goldstein</a> helpfully pointed out in response to an earlier version of this post,
casting from a smaller type to a larger one (for example, <code>u8</code> to <code>u16</code>, or <code>f32</code> to <code>f64</code>) will always produce 
expected results:</p>
<pre data-lang="rust"><code data-lang="rust"><span><span><span><span>fn</span> </span><span>get_number</span></span><span><span><span>(</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>u8</span></span> </span><span><span><span>{</span>
</span></span></span><span><span><span>    </span></span></span><span><span><span>    <span>32</span>
</span></span></span><span><span><span></span><span><span>}</span></span></span>
</span><span>
</span><span><span><span><span>fn</span> </span><span>get_half_floor</span></span><span><span><span>(</span><span>number</span><span>:</span> <span>u16</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>u16</span></span> </span><span><span><span>{</span>
</span></span></span><span><span><span>    number <span>/</span> <span>2</span>
</span></span></span><span><span><span></span><span><span>}</span></span></span>
</span><span>
</span><span><span><span><span>fn</span> </span><span>main</span></span><span><span><span>(</span></span><span><span><span>)</span></span></span></span><span> </span><span><span><span>{</span>
</span></span></span><span><span><span>    <span>let</span> number <span>=</span> <span>get_number</span><span><span>(</span></span><span><span>)</span></span><span>;</span>
</span></span></span><span><span><span>    <span>let</span> result <span>=</span> <span>get_half_floor</span><span><span>(</span>number <span>as</span> <span>u16</span></span><span><span>)</span></span><span>;</span>
</span></span></span><span><span><span>    <span>dbg!</span><span><span>(</span>result</span><span><span>)</span></span><span>;</span>
</span></span></span><span><span><span></span><span><span>}</span></span></span>
</span></code></pre>
<pre><code><span>[src/main.rs:13:5] result = 16
</span></code></pre>
<p>However, I would still avoid using <code>as</code> here.</p>
<ul>
<li>If the type of <code>number</code> were to change to, for example, <code>u32</code>, and its value was no longer guaranteed to fit into 
<code>u16</code> (like, if we got <code>number</code> from some struct or function that someone updated without us realizing), 
we would once again risk getting results we might not expect </li>
<li>For type conversions that guarantee to be lossless and preserve the original value, we can use 
<a rel="noopener" target="_blank" href="https://doc.rust-lang.org/std/convert/trait.From.html"><code>From</code>/<code>Into</code></a></li>
</ul>
<p>Compared to the above example, the latter would both give us arguably better ergonomics (we can let Rust infer the type 
we want to convert to, instead of having to specify it manually):</p>
<pre data-lang="rust"><code data-lang="rust"><span></span><span>
</span><span><span><span><span>fn</span> </span><span>main</span></span><span><span><span>(</span></span><span><span><span>)</span></span></span></span><span> </span><span><span><span>{</span>
</span></span></span><span><span><span>    <span>let</span> number <span>=</span> <span>get_number</span><span><span>(</span></span><span><span>)</span></span><span>;</span>
</span></span></span><span><span><span>    <span>let</span> result <span>=</span> <span>get_half_floor</span><span><span>(</span>number<span>.</span><span>into</span><span><span>(</span></span><span><span>)</span></span></span><span><span>)</span></span><span>;</span>
</span></span></span><span><span><span>    <span>dbg!</span><span><span>(</span>result</span><span><span>)</span></span><span>;</span>
</span></span></span><span><span><span></span><span><span>}</span></span></span>
</span><span>
</span></code></pre>
<p>and, importantly, if the type of <code>number</code> were to change from under us, we would get a compiler error :</p>
<pre data-lang="rust"><code data-lang="rust"><span><span><span><span>fn</span> </span><span>get_number</span></span><span><span><span>(</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>u32</span></span> </span><span><span><span>{</span> 
</span></span></span><span><span><span>    </span></span></span><span><span><span></span><span><span>}</span></span></span>
</span><span>
</span><span></span><span>
</span><span><span><span><span>fn</span> </span><span>main</span></span><span><span><span>(</span></span><span><span><span>)</span></span></span></span><span> </span><span><span><span>{</span>
</span></span></span><span><span><span>    <span>let</span> number <span>=</span> <span>get_number</span><span><span>(</span></span><span><span>)</span></span><span>;</span>
</span></span></span><span><span><span>    <span>let</span> result <span>=</span> <span>get_half_floor</span><span><span>(</span>number<span>.</span><span>into</span><span><span>(</span></span><span><span>)</span></span></span><span><span>)</span></span><span>;</span>
</span></span></span><span><span><span>    <span>dbg!</span><span><span>(</span>result</span><span><span>)</span></span><span>;</span>
</span></span></span><span><span><span></span><span><span>}</span></span></span>
</span></code></pre>
<pre><code><span>error[E0277]: the trait bound `u16: From&lt;u32&gt;` is not satisfied
</span><span>--&gt; src/main.rs:12:40
</span><span>|
</span><span>12 |     let result = get_half_floor(number.into());
</span><span>|                                        ^^^^ the trait `From&lt;u32&gt;` is not implemented for `u16`, which is required by `u32: Into&lt;_&gt;`
</span><span>|
</span><span>= help: the following other types implement trait `From&lt;T&gt;`:
</span><span>&lt;u16 as From&lt;Char&gt;&gt;
</span><span>&lt;u16 as From&lt;bool&gt;&gt;
</span><span>&lt;u16 as From&lt;u8&gt;&gt;
</span><span>= note: required for `u32` to implement `Into&lt;u16&gt;`
</span><span>
</span><span>For more information about this error, try `rustc --explain E0277`.
</span></code></pre>
<p>I don&#39;t think that error is very helpful in itself, but it would force us to investigate what is going on
and update our code, instead of running into potentially surprising and unwanted behavior at runtime, 
which we might get if we stuck with <code>as</code>.</p>
<hr/>





    <p><small><i>If you have feedback, I would love to hear from you! Please use one of the links below to get in touch.</i></small>
    </p>
      <nav>
        
        
      </nav>
    </article>
  </div></div>
  </body>
</html>
