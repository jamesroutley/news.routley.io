<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.torproject.org/introducing-oniux-tor-isolation-using-linux-namespaces/">Original</a>
    <h1>Oniux: Kernel-level Tor isolation for any Linux app</h1>
    
    <div id="readability-page-1" class="page"><div><p>When launching privacy-critical apps and services, developers want to make sure that every packet really only goes through Tor. One mistyped proxy settingâ€“or a single system-call outside the SOCKS wrapperâ€“and your data is suddenly on the line.</p>
<p>That&#39;s why today, we are excited to introduce <em>oniux</em>: a small command-line utility providing Tor network isolation for third-party applications using Linux namespaces. Built on Arti, and onionmasq, oniux drop-ships any Linux program into its own network namespace to route it through Tor and strips away the potential for data leaks. If your work, activism, or research demands rock-solid traffic isolation, oniux delivers it.</p>

<p>Namespaces are an isolation feature found in the Linux kernel that were introduced around the year 2000. They provide a secure way of isolating a certain part of an application from the rest of the system. Namespaces come in various forms and shapes. Some examples include network namespaces, mount namespaces, process namespaces, and a few more; each of them isolating a certain amount of system resources from an application.</p>
<p>What do we mean by <strong>system resources</strong>? In Linux, system resources are available globally by all applications on the system. The most notable example of this is probably your operating system clock, but there are many other areas as well, such as the list of all processes, the file system, and the list of users.</p>
<p>Namespaces <em>containerize</em> a certain part of an application from the rest of the operating system; this is exactly what Docker uses in order to provide its isolation primitives.</p>

<p>As outlined above, namespaces are a powerful feature that gives us the ability to isolate Tor network access of an arbitrary application. We put each application in a network namespace that doesn&#39;t provide access to system-wide network interfaces (such as eth0), and instead provides a custom network interface onion0.</p>
<p>This allows us to isolate an arbitrary application over Tor in the most secure way possible software-wise, namely by relying on a security primitive offered by the operating system kernel. Unlike SOCKS, the application cannot accidentally leak data by failing to make some connection via the configured SOCKS, which may happen due to a mistake by the developer.</p>

<p>You may have also heard of a tool with a similar goal, known as
<a href="https://gitlab.torproject.org/tpo/core/torsocks"><code>torsocks</code></a>, which works by
overwriting all network-related libc functions in a way to route traffic over a
SOCKS proxy offered by Tor.  While this approach is a bit more cross-platform,
it has the notable downside that applications making system calls <em>not</em> through
a dynamically linked libc, either with malicious intent or not, will leak data.
Most notably, this excludes support for purely static binaries and applications
from the Zig ecosystem.</p>
<p>The following provides a basic comparison on <em>oniux</em> vs <em>torsocks</em>:</p>
<table>
<thead><tr>
<th><em>oniux</em></th>
<th><em>torsocks</em></th>
</tr>
</thead>
<tbody>
<tr>
<td>Standalone application</td>
<td>Requires running Tor daemon</td>
</tr>
<tr>
<td>Uses Linux namespaces</td>
<td>Uses an ld.so preload hack</td>
</tr>
<tr>
<td>Works on all applications</td>
<td>Only works on applications making system calls through libc</td>
</tr>
<tr>
<td>Malicious application cannot leak</td>
<td>Malicious application can leak by making a system call through raw assembly</td>
</tr>
<tr>
<td>Linux only</td>
<td>Cross-platform</td>
</tr>
<tr>
<td>New and experimental</td>
<td>Battle-proven for over 15 years</td>
</tr>
<tr>
<td>Uses Arti as its engine</td>
<td>Uses CTor as its engine</td>
</tr>
<tr>
<td>Written in Rust</td>
<td>Written in C</td>
</tr>
</tbody>
</table>

<p>First, you need a Linux system with a Rust toolchain installed.
Afterwards, you can install <em>oniux</em> with the following command:</p>
<div><pre><span></span>$ cargo install --git https://gitlab.torproject.org/tpo/core/oniux oniux@0.4.0
</pre></div>
<p>Once that is done, you are ready to go for using <em>oniux</em>!  ðŸ™‚</p>
<p>Using <em>oniux</em> is straightforward:</p>
<div><pre><span></span><span># Perform a simple HTTPS query using oniux!</span>
$ oniux curl https://icanhazip.com
&lt;A TOR EXIT NODE IP ADDRESS&gt;

<span># oniux also supports IPv6 of course!</span>
$ oniux curl -6 https://ipv6.icanhazip.com
&lt;A TOR EXIT NODE IPv6 ADDRESS&gt;

<span># Tor without onion services is like a car without an engine ...</span>
$ oniux curl http://2gzyxa5ihm7nsggfxnu52rck2vv4rvmdlkiu3zzui5du4xyclen53wid.onion/index.html

<span># You can also enable logging if you are a nerd. ðŸ¤“</span>
$ <span>RUST_LOG</span><span>=</span>debug oniux curl https://icanhazip.com

<span># If you want, you can &#34;torify&#34; your entire shell, isolating all processes within!</span>
$ oniux bash

<span># If you are in a desktop environment, you can isolate graphical applications too!</span>
$ oniux hexchat
</pre></div>

<p><em>oniux</em> works by immediately spawning a child process using the <code>clone(2)</code>
system call, which is isolated in its own network, mount, PID, and user
namespace.  This process then mounts its own copy of <code>/proc</code> followed by UID
and GID mappings to the respective UID and GID of the parent process.</p>
<p>Afterwards, it creates a temporary file with nameserver entries which will then
be bind mounted onto <code>/etc/resolv.conf</code>, so that applications running within
will use a custom name resolver that supports resolving through Tor.</p>
<p>Next, the child process utilizes
<a href="https://gitlab.torproject.org/tpo/core/onionmasq">onionmasq</a> to create a TUN
interface named <code>onion0</code> followed by some <code>rtnetlink(7)</code> operations required to
set up the interface, such as assigning IP addresses.</p>
<p>Then, the child process sends the file descriptor of the TUN interface over
a Unix Domain socket to the parent process, who has been waiting for this
message ever since executing the initial <code>clone(2)</code>.</p>
<p>Once that is done, the child process drops all of its capabilities which
were acquired as part of being the root process in the user namespace.</p>
<p>Finally, the command supplied by the user is executed using facilities
provided by the Rust standard library.</p>

<p>Although this section should not discourage you from using <em>oniux</em>, you should
keep in mind that this is a relatively new feature which uses new Tor software,
such as <em>Arti</em> and <em>onionmasq</em>.</p>
<p>While things are already working as expected at the moment, tools such as
<em>torsocks</em> have been around for over 15 years, giving them more experience on
the battlefield.</p>
<p>But we do want to reach a similar state with oniux, so please go ahead and
check it out!</p>

<p>Many thanks to the developers of
<a href="https://github.com/smoltcp-rs/smoltcp"><code>smoltcp</code></a>, which is a Rust crate that
implements a full IP stack in Rust -- something, we make heavy use of.</p>
<p>Also many thanks go to <code>7ppKb5bW</code>, who taught us on how this can implemented
without the use of <code>capabilities(7)</code> by using <code>user_namespaces(7)</code> properly.</p>
<p>Last but not least, many thanks to all people and organizations who support Tor financially. The Tor Project, Inc. is a 501(c)(3) nonprofit advancing human rights and defending privacy online through free software and open networks. The oniux release is powered by a community of supporters. Please consider donating today to continue advancing our work that makes privacy possible.</p>
<p><a href="https://torproject.org/donate/donate-bp2-sc2025"><img src="https://blog.torproject.org/introducing-oniux-tor-isolation-using-linux-namespaces/button-large-black.png" alt="Donate Button"/></a></p>

    </div></div>
  </body>
</html>
