<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.joinformal.com/blog/using-proxies-to-hide-secrets-from-claude-code/">Original</a>
    <h1>Using proxies to hide secrets from Claude Code</h1>
    
    <div id="readability-page-1" class="page"><article><div><div><h2 id="proxies-1">Sandboxing agentic coding tools is a networking problem<!-- notionvc: 6046987d-4826-4e75-b476-edc20065d802 --></h2>
<p><a tabindex="0" href="https://www.joinformal.com/blog/allowlisting-some-bash-commands-is-often-the-same-as-allowlisting-all-with-claude-code/" rel="noopener noreferrer" data-token-index="0"><span>Allowlisting commands on a trusted host for an agentic coding tool can be somewhat fraught</span></a>. Taking inspiration from <a tabindex="0" href="https://simonwillison.net/2025/Oct/22/living-dangerously-with-claude/#living-dangerously-with-claude.014.jpeg" rel="noopener noreferrer" data-token-index="2"><span>Simon Willison</span></a>:</p>
<p><img loading="lazy" decoding="async" src="https://formal1.wpenginepowered.com/wp-content/uploads/2026/01/image-300x169.png" alt="" width="744" height="419" srcset="https://www.joinformal.com/wp-content/uploads/2026/01/image-300x169.png 300w, https://www.joinformal.com/wp-content/uploads/2026/01/image-1024x576.png 1024w, https://www.joinformal.com/wp-content/uploads/2026/01/image-768x432.png 768w, https://www.joinformal.com/wp-content/uploads/2026/01/image-1536x864.png 1536w, https://www.joinformal.com/wp-content/uploads/2026/01/image.png 1920w" sizes="auto, (max-width: 744px) 100vw, 744px"/></p>
<p>Sandboxes help us reason about their relation to the lethal trifecta:</p>
<p><img loading="lazy" decoding="async" src="https://formal1.wpenginepowered.com/wp-content/uploads/2026/01/image-1-300x150.png" alt="" width="744" height="372" srcset="https://www.joinformal.com/wp-content/uploads/2026/01/image-1-300x150.png 300w, https://www.joinformal.com/wp-content/uploads/2026/01/image-1-1024x512.png 1024w, https://www.joinformal.com/wp-content/uploads/2026/01/image-1-768x384.png 768w, https://www.joinformal.com/wp-content/uploads/2026/01/image-1-1536x768.png 1536w, https://www.joinformal.com/wp-content/uploads/2026/01/image-1-2048x1024.png 2048w" sizes="auto, (max-width: 744px) 100vw, 744px"/></p>
<ul>
<li>What untrusted content is the sandbox exposed to?</li>
<li>How can they externally communicate?</li>
<li>What sensitive data are we providing to the sandbox?</li>
</ul>

<p>Anthropic provides several sandboxing tools specific to Claude Code:</p>
<ul>
<li><a href="https://docs.claude.com/en/docs/claude-code/settings#permission-settings">Claude Code’s Sandbox Bash tool</a>, which uses <span>sandbox-exec</span> under the hood for OS X users. This is the <a href="https://www.chromium.org/developers/design-documents/sandbox/osx-sandboxing-design/">same technique Chromium uses</a></li>
<li>Claude Code’s <a href="https://github.com/anthropic-experimental/sandbox-runtime">experimental sandbox runtime</a>, which also uses sandbox-exec for OS X users</li>
<li>Anthropic provides a <a href="https://docs.claude.com/en/docs/claude-code/devcontainer">devcontainers</a> template for working with Claude Code that will apply a firewall to</li>
</ul>

<p>Cursor also has a similar sandboxing feature for Mac users that uses sandbox-exec under the hood for the Cursor IDE. <a href="https://developers.openai.com/codex/cli/reference/">OpenAI’s Codex CLI</a> also supports a sandbox argument that uses <span>sandbox-exec</span>. We’re super excited to see all the new tools to limit what access these agentic coding tools have to our host!</p>
<p>You could also write your own sandbox using gVisor or Firecracker VMs! The themes around network isolation and proxies should transfer.</p>


</div><div><h2 id="proxies-2">What is the worst a sandbox can do?</h2>
<p>Although the <a href="https://platform.claude.com/docs/en/agent-sdk/secure-deployment#isolation-technologies">specifics of the sandbox technology affect the level of isolation</a>, a sufficiently sandboxed Claude Code can make a sandboxed Claude Code look like a separate host.</p>
<ul>
<li>What network access am I allowing Claude Code to have?</li>
<li>What actions can Claude Code perform with this network access and the data it has?</li>
</ul>
<p>For example, almost all Claude Code instances have access to Anthropic API keys to be able to interact with the Anthropic API.</p>
<p>Claude Code has access to all environment variables present in your terminal session (which are propagated to the Claude Code sandbox), and Claude Code has access to read the files from the directory where you run <span>claude</span>.</p>
<p>Unfortunately, a lot of software requires secrets. For example, development on <a href="https://www.oauth.com/oauth2-servers/client-registration/client-id-secret/">third-party integrations requires using secrets</a>.</p>
<p>This makes having separate development, staging, and production integration credentials especially valuable, but even development integration credentials are not designed to be publicly accessible: otherwise, they wouldn’t be credentials!</p>
<ul>
<li>What data am I providing to Claude Code?</li>
<li>What secrets or environment variables will Claude Code have access to?</li>
<li>Are the files (including the source code) I’m providing to Claude Code open-source or public?<!-- notionvc: 99a1ae2b-6918-4158-b2f0-12ec695e6972 --></li>
</ul>

<p>Consider the precedence of <a href="https://github.com/motdotla/dotenv">dotenv files</a> to manage secrets on your local repo. Making sure that these <span>.env</span> files are properly <span>.gitignore</span>d and <span>.dockerignore</span>d is no longer sufficient: leaving these <span>.env</span> files in a folder where you are running <span>claude</span> gives Claude Code access to these secrets.</p>
<p>You could also write your own sandbox using gVisor or Firecracker VMs! The themes around network isolation and proxies should transfer.<!-- notionvc: 71c63f4f-c52a-4623-a9de-0e2bab1ce700 --></p>

</div><div><h2 id="proxies-3">Unpacking the devcontainer firewall</h2>
<p>The provided devcontainer template has an <span>init-firewall.sh</span> script that applies a firewall to the devcontainer running Claude Code. This firewall <a href="https://github.com/anthropics/claude-code/blob/main/.devcontainer/init-firewall.sh">permits network connections to the following hosts by default</a>:</p>
<ul>
<li><a href="https://registry.npmjs.org">registry.npmjs.org</a>: allow installing npm packages</li>
<li><a href="https://api.anthropic.com">api.anthropic.com</a>: interact with Anthropic’s API</li>
<li><a href="https://sentry.io">sentry.io</a>: a logging and error observability product that Anthropic is using</li>
<li><a href="https://statsig.anthropic.com">statsig.anthropic.com</a>/<a href="https://statsig.com">statsig.com</a>: a feature flagging product that Anthropic is using</li>
<li><a href="https://marketplace.visualstudio.com">marketplace.visualstudio.com</a>: enable installing VSCode extensions</li>
<li><a href="https://vscode.blob.core.windows.net">vscode.blob.core.windows.net</a>/<a href="https://update.code.visualstudio.com">update.code.visualstudio.com</a>: a blob store used by VSCode</li>
<li>GitHub’s web, API, and git servers</li>
</ul>

<p>This firewall is enforced at the IP layer: the init script performs a <span>dig</span> to resolve these hosts’ IP addresses and uses <span>iptables</span> to allow connections to these IPs. This does mean that the particular connection to these hosts is not necessarily enforced at the TLS/HTTP layers; for example, an AWS ALB on an allowlisted IP that routes traffic based on SNI or Host headers could still receive requests that specify different hosts.</p>
<p>In addition, the firewall supports inbound and outbound traffic to any IP address on port <span>22</span> for SSH connections.</p>
<p>If we:</p>
<ul>
<li>Use this firewall</li>
<li>Provide environment variables we would not want to be publicly accessible</li>
<li>Run the devcontainer with <span>claude –dangerouslyUnsafePermissions<br/>
</span></li>
</ul>

<p>The devcontainer could exfiltrate sensitive data, including credentials, via a</p>
<ul>
<li>Connect to a random IP over port 22</li>
<li>Create an npm package with the secret in the tarball</li>
<li data-stringify-indent="0" data-stringify-border="1">Create a github gist with the credentials</li>
</ul>

<p>Even if we only HTTP traffic to a select set of hosts, this problem remains challenging because of <a href="https://en.wikipedia.org/wiki/Domain_fronting"><em>Domain Fronting</em></a>: there are often a huge diversity of actions you can perform on a single domain. Applying restricted privileges to these kinds of domains at the IP, domain, or even host level is often not fine-grained enough to allow the actions you want to allow and block the actions you want to block. In fact, <a href="https://simonwillison.net/2025/Aug/9/bay-area-ai/#the-lethal-trifecta.011.jpeg">prompt injection attacks in particular</a> have taken advantage of overly broad domain allowlists to exfiltrate sensitive information!</p>
<p>The specifics of what kind of network traffic you want to permit and not permit often requires looking at the <em>application layer</em>.</p>

</div><div><h2 id="proxies-4">Using network proxies to prevent secrets exfiltration: hiding the ANTHROPIC_API_KEY from Claude Code</h2>
<p>Thankfully, Claude Code supports using proxies to route traffic! There are two ways to configure Claude Code to use proxies:</p>
<ul>
<li>A <a href="https://docs.claude.com/en/docs/claude-code/network-config">HTTP_PROXY environment variable that applies to all Claude Code HTTP traffic</a>. This proxy environment variable intercepts HTTP traffic that the parent Claude Code process makes.</li>
<li><a href="https://docs.claude.com/en/docs/claude-code/sandboxing#custom-proxy-configuration">A sandbox httpProxyPort</a>. This intercepts HTTP proxy traffic for bash commands executed from within the sandbox.</li>
</ul>

<p>Note that these proxy configurations are independent of each other: the <span>HTTP_PROXY</span> environment variable will not intercept HTTP traffic from bash commands in the sandbox, and the sandbox <span>httpProxyPort</span> will not intercept HTTP traffic from the Claude Code CLI tool that is outside of the sandbox.</p>
<p>You can configure <a href="https://docs.claude.com/en/docs/claude-code/sandboxing#custom-proxy-configuration">Claude Code to use an HTTP proxy</a> using the following configuration in <span>settings.json</span>:</p>
<p><img loading="lazy" decoding="async" src="https://formal1.wpenginepowered.com/wp-content/uploads/2026/01/carbon-2-300x140.png" alt="" width="744" height="347" srcset="https://www.joinformal.com/wp-content/uploads/2026/01/carbon-2-300x140.png 300w, https://www.joinformal.com/wp-content/uploads/2026/01/carbon-2-1024x477.png 1024w, https://www.joinformal.com/wp-content/uploads/2026/01/carbon-2-768x358.png 768w, https://www.joinformal.com/wp-content/uploads/2026/01/carbon-2.png 1134w" sizes="auto, (max-width: 744px) 100vw, 744px"/></p>
<p><a href="https://www.mitmproxy.org/"><span>mitmproxy</span></a> is a great tool to run these HTTP proxies. Note: provide the mitmproxy-generated TLS certificate to intercept TLS traffic to Claude for node processes via <span>export NODE_EXTRA_CA_CERTS=~/mitmproxy/mitmproxy-ca-cert.pem</span>.</p>
<p>The <span>mitmproxy</span> tool also <a href="https://docs.mitmproxy.org/stable/addons/overview/">supports addons</a> where you can transform HTTP requests between Claude Code and third-party web servers. For example, you could write an add-on that intercepts <a href="https://api.anthropic.com">https://api.anthropic.com</a> and updates the <span>X-API-Key</span> header with an actual Anthropic API Key.</p>
<p>You could then pass an invalid Anthropic API Key to Claude Code so that neither the Claude Code process nor the sandbox has access to our Anthropic API Key!</p>
<p><img loading="lazy" decoding="async" src="https://formal1.wpenginepowered.com/wp-content/uploads/2026/01/carbon-3-300x205.png" alt="" width="744" height="508" srcset="https://www.joinformal.com/wp-content/uploads/2026/01/carbon-3-300x205.png 300w, https://www.joinformal.com/wp-content/uploads/2026/01/carbon-3-1024x699.png 1024w, https://www.joinformal.com/wp-content/uploads/2026/01/carbon-3-768x524.png 768w, https://www.joinformal.com/wp-content/uploads/2026/01/carbon-3.png 1134w" sizes="auto, (max-width: 744px) 100vw, 744px"/></p>
<p>You could then run <span>mitmweb</span> with the right API key:</p>
<p><img loading="lazy" decoding="async" src="https://formal1.wpenginepowered.com/wp-content/uploads/2026/01/carbon-4-300x105.png" alt="" width="744" height="260" srcset="https://www.joinformal.com/wp-content/uploads/2026/01/carbon-4-300x105.png 300w, https://www.joinformal.com/wp-content/uploads/2026/01/carbon-4-1024x358.png 1024w, https://www.joinformal.com/wp-content/uploads/2026/01/carbon-4-768x268.png 768w, https://www.joinformal.com/wp-content/uploads/2026/01/carbon-4.png 1134w" sizes="auto, (max-width: 744px) 100vw, 744px"/></p>
<p>Afterwards, run <span>claude</span> with the <span>ANTHROPIC_API_KEY</span> environment variable set to an invalid API key:</p>
<p><img loading="lazy" decoding="async" src="https://formal1.wpenginepowered.com/wp-content/uploads/2026/01/carbon-5-300x105.png" alt="" width="744" height="260" srcset="https://www.joinformal.com/wp-content/uploads/2026/01/carbon-5-300x105.png 300w, https://www.joinformal.com/wp-content/uploads/2026/01/carbon-5-1024x358.png 1024w, https://www.joinformal.com/wp-content/uploads/2026/01/carbon-5-768x268.png 768w, https://www.joinformal.com/wp-content/uploads/2026/01/carbon-5.png 1134w" sizes="auto, (max-width: 744px) 100vw, 744px"/></p>
<p>From the perspective of Claude Code, all API responses from <a href="https://api.anthropic.com">api.anthropic.com</a> will appear to Claude Code as if the API key of <span>sk-ant-dummy</span> is a valid API key!</p>
<p>Unfortunately, Claude Code still requires signing in via OAuth before checking if the <span>ANTHROPIC_API_KEY</span> is set, so you may have to sign in via OAuth first, grab the API key, close the session, and then start a new <span>claude</span> process with an invalid <span>ANTHROPIC_API_KEY</span> environment variable.</p>
<p>This kind of technique is not unique to hiding your Anthropic API Keys: you could insert dummy API keys and secrets and use <span>mitmproxy</span> addons to intercept these HTTP requests and inject actual API keys once the request has left the Claude Code process and sandbox.<!-- notionvc: 54c59125-c706-437d-90b0-ece881e330c8 --></p>

</div><div><h2 id="proxies-5">Tying a developer’s permissions to their Claude Code permissions: proxying Claude Code to the Formal Connector</h2>
<p>Our customers use Formal to <a href="https://docs.joinformal.com/docs/guides/core-concepts/identities#overview">apply least privilege to both human and machine identities.</a> You can also leverage Formal to decouple human &amp; machine identities from <a href="https://docs.joinformal.com/docs/guides/core-concepts/resources/native_users#native-users">Native Users</a> and apply fine-grained least privilege <a href="https://docs.joinformal.com/docs/guides/core-concepts/resources/introduction">at the application layer</a>. A lot of the techniques to apply organizational least privilege are relevant for applying least privilege to Claude Code sandboxes: if your organizational permissions are sufficiently constrained, the blast radius of a rogue Claude Code with a developer’s credentials should be small as well.</p>
<p>To date, Admin Anthropic API Keys inherit the full permissions of the user who created them, and there is no ability to make API keys more fine-grained. API keys generated from the Claude API for Claude Code, however, seem to have restrictions on what API endpoints they are allowed to use, but we have not found documentation on the exact permissions that are allowed versus disabled.</p>
<p>Developers may want to use Claude Code to write and run code that uses an Admin Anthropic API Key. If they pass the API Key via an environment variable, the sandbox will have access to this Admin Anthropic API Key. An organization, however, may want to prevent certain API actions from being taken with an Anthropic API Key and have logging on who is performing which API actions. Developers may not notice the distinction as well!</p>
<p>The best way to prevent Claude Code from leaking an API Key is to make sure that it never has <a href="https://platform.claude.com/docs/en/agent-sdk/secure-deployment#the-proxy-pattern">direct access to the credentials</a> in the first place! One can use <a href="https://docs.joinformal.com/docs/guides/core-concepts/connectors/introduction">Formal Connectors</a>, <a href="https://docs.joinformal.com/docs/guides/core-concepts/resources/http">Formal Resources</a>, and <a href="https://docs.joinformal.com/docs/guides/core-concepts/resources/http#native-users">Native Users</a> to make sure that Claude Code cannot leak the API Key. That way, Claude Code can make requests to the Connector with <a href="https://docs.joinformal.com/docs/guides/core-concepts/identities#machine-users">Formal-specific credentials</a> and the Connector can inject actual secrets when communicating with the upstream API.</p>

</div><div><h2 id="proxies-6">When hostnames and headers are hard to edit: mitmproy add-ons</h2>
<p>For hostnames and headers that are hard to tweak, use mitmproxy add-ons to route the HTTP requests for these domains to the corresponding listener.</p>
<p><img loading="lazy" decoding="async" src="https://formal1.wpenginepowered.com/wp-content/uploads/2026/01/carbon-6-300x295.png" alt="" width="744" height="731" srcset="https://www.joinformal.com/wp-content/uploads/2026/01/carbon-6-300x295.png 300w, https://www.joinformal.com/wp-content/uploads/2026/01/carbon-6-1024x1006.png 1024w, https://www.joinformal.com/wp-content/uploads/2026/01/carbon-6-768x754.png 768w, https://www.joinformal.com/wp-content/uploads/2026/01/carbon-6.png 1134w" sizes="auto, (max-width: 744px) 100vw, 744px"/></p>

<p>You can then pass this add-on via <span>mitmproxy -s reroute_hosts.py</span>.</p>
<p>One advantage of this approach is that you do not have to configure hostnames and ports for Claude Code: the default hostnames and ports for these APIs will look identical from the perspective of Claude Code.</p>

</div><div><h2 id="proxies-7">Applying fine-grained least privilege policies</h2>
<p>We could then create a policy in a similar way to the policy we created for the <a href="https://www.joinformal.com/blog/the-permission-pitfall-securing-mcp-servers-without-limiting-value/">local Github MCP server use case</a>.<!-- notionvc: 43f938f0-01a6-4a73-9381-bc4702015c07 --></p>
<p><img loading="lazy" decoding="async" src="https://formal1.wpenginepowered.com/wp-content/uploads/2026/01/carbon-7-300x161.png" alt="" width="744" height="399" srcset="https://www.joinformal.com/wp-content/uploads/2026/01/carbon-7-300x161.png 300w, https://www.joinformal.com/wp-content/uploads/2026/01/carbon-7-1024x549.png 1024w, https://www.joinformal.com/wp-content/uploads/2026/01/carbon-7-768x412.png 768w, https://www.joinformal.com/wp-content/uploads/2026/01/carbon-7.png 1134w" sizes="auto, (max-width: 744px) 100vw, 744px"/></p>
<p>If we change the path param to “/v1/messages,” we can confirm that this policy is able block requests to the Anthropic API even outside of the Claude Code sandbox:<!-- notionvc: d719ee85-5256-4d0c-8343-158c99dcf9ef --></p>
<p><img loading="lazy" decoding="async" src="https://formal1.wpenginepowered.com/wp-content/uploads/2026/01/carbon-8-300x112.png" alt="" width="744" height="277" srcset="https://www.joinformal.com/wp-content/uploads/2026/01/carbon-8-300x112.png 300w, https://www.joinformal.com/wp-content/uploads/2026/01/carbon-8-1024x381.png 1024w, https://www.joinformal.com/wp-content/uploads/2026/01/carbon-8-768x286.png 768w, https://www.joinformal.com/wp-content/uploads/2026/01/carbon-8.png 1134w" sizes="auto, (max-width: 744px) 100vw, 744px"/></p>
<p>We also get visibility into every request being made to the Anthropic API across our organization!</p>
<p><img loading="lazy" decoding="async" src="https://formal1.wpenginepowered.com/wp-content/uploads/2026/01/image-2-300x135.png" alt="" width="744" height="334" srcset="https://www.joinformal.com/wp-content/uploads/2026/01/image-2-300x135.png 300w, https://www.joinformal.com/wp-content/uploads/2026/01/image-2-1024x460.png 1024w, https://www.joinformal.com/wp-content/uploads/2026/01/image-2-768x345.png 768w, https://www.joinformal.com/wp-content/uploads/2026/01/image-2-1536x690.png 1536w, https://www.joinformal.com/wp-content/uploads/2026/01/image-2-2048x920.png 2048w" sizes="auto, (max-width: 744px) 100vw, 744px"/></p>
</div><div><p>Of course, this technique was not specific to safeguarding Anthropic API Keys: one can use HTTP proxies and Claude Code sandboxes to enforce least privilege for your API Keys even if you want to enable Claude Code to use some of these APIs!</p>
<p>Proxies as a result can help in two dimensions of the lethal trifecta:</p>
<p><img loading="lazy" decoding="async" src="https://formal1.wpenginepowered.com/wp-content/uploads/2026/01/image-1-300x150.png" alt="" width="744" height="372" srcset="https://www.joinformal.com/wp-content/uploads/2026/01/image-1-300x150.png 300w, https://www.joinformal.com/wp-content/uploads/2026/01/image-1-1024x512.png 1024w, https://www.joinformal.com/wp-content/uploads/2026/01/image-1-768x384.png 768w, https://www.joinformal.com/wp-content/uploads/2026/01/image-1-1536x768.png 1536w, https://www.joinformal.com/wp-content/uploads/2026/01/image-1-2048x1024.png 2048w" sizes="auto, (max-width: 744px) 100vw, 744px"/></p>
</div><div><ul>
<li>Proxies can limit the ability to externally communicate by allowing or blocking traffic.</li>
<li>Proxies <strong>can also</strong> limit an agent’s access to private data if they don’t need to read that data for inference. Credentials can be injected for actions the agent wants to take with those credentials without allowing the credential to be available to a language model’s context window.</li>
</ul>
</div></div></article></div>
  </body>
</html>
