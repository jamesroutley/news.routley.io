<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://retrocomputing.stackexchange.com/questions/1514/how-exactly-does-sonic-knuckles-lock-on-technology-work">Original</a>
    <h1>How does Sonic and Knuckles&#39; “Lock-On Technology” work? (2016)</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="text">
<blockquote>
<p>How does the Sonic &amp; Knuckles cart detect another cartridge?</p>
</blockquote>
<p>It checks the serial numbers of games; they can be found in the ROM&#39;s header. It probably detects all preceding Sonic the Hedgehog games since they all result in specific effects when locked-on.</p>
<blockquote>
<p>Are the game ROMs merged in some way when connected?</p>
</blockquote>
<p>It seems both games are simply mapped onto memory. This way, the executing game code gets access to the contents of both games.</p>
<p>To better understand what this means, imagine a Sonic &amp; Knuckles ROM with the complete contents of the Sonic the Hedgehog 3 ROM concatenated onto it.</p>
<p><img src="https://docs.google.com/drawings/d/1bYEZHBCZCIMGC-uvZuWg4jOaeyv7ZETZQe9PU88uJno/pub?w=1137&amp;h=573" alt="Sonic &amp; Knuckles and Sonic the Hedgehog 3"/></p>
<p>The address space represents memory the game code can access. The contents of the <a href="https://en.wikipedia.org/wiki/Read-only_memory" rel="nofollow noreferrer">read-only memory</a> chips get <em>mapped</em> onto the Mega Drive&#39;s 68k processor&#39;s 24-bit address space. The Mega Drive just sees two games, one after another. Incidentally, that&#39;s what a good dump of Sonic 3 &amp; Knuckles looks like. This explains why the game works even in emulators that don&#39;t support any of the custom hardware inside the Sonic &amp; Knuckles cartridge.</p>
<p>Any game locked onto Sonic &amp; Knuckles will probably have its ROM mapped onto the game&#39;s address space the same way. This means game&#39;s data is <em>made available</em> for use by the Sonic &amp; Knuckles game code; it does <em>not</em> necessarily mean the data will be <em>used</em>. Since Sonic &amp; Knuckles was programmed to work with Sonic the Hedgehog 3, it makes extensive use of the data in the locked-on cartridge. Its handling of other games is far less sophisticated; apparently, it just uses the metadata found in the ROM&#39;s header to generate a unique Blue Spheres stage. If it detects that it&#39;s the first Sonic the Hedgehog game, it simply unlocks the full version of the bonus game.</p>
<p>The connection to Sonic the Hedgehog 2 works similarly:</p>
<p><img src="https://docs.google.com/drawings/d/e/2PACX-1vQeNKgjPpKN-m24msxznacQ-BTYkJQB62DQD0yopX6N0D0fO7CpZQstL5maNbfuASLW5TG8wtDWhMoy/pub?w=1137&amp;h=573" alt="Sonic &amp; Knuckles and Sonic the Hedgehog 3"/></p>
<p>There are two ROM chips in the Sonic &amp; Knuckles cartridge: one has the main game and the other has a patch for Sonic the Hedgehog 2. The patch ROM contains the complete Knuckles the Echidna in Sonic the Hedgehog 2 game code; this is the full code for the original game but modified with the necessary game mechanics for Knuckles: lower speed, lower jump height, flight, wall climbing, etc. The ROM also contains new graphics data for Knuckles as well as new map data with places and items for Knuckles to reach with his abilities.</p>
<p>When Sonic &amp; Knuckles detects that Sonic the Hedgehog 2 is locked on, it passes control of the processor to the code inside the patch ROM, thereby launching Knuckles the Echidna in Sonic the Hedgehog 2. The new game can reuse much of the data from the original game: level graphics, enemy data, bosses, etc. The only code from the locked-on cartridge that executes is the sound driver.</p>
<blockquote>
<p>My question is, <strong>how</strong> exactly does the Lock-On Technology work?</p>
</blockquote>
<p>Let&#39;s delve into the details.</p>
<p>According to <a href="http://www.emulationzone.org/projects/s&amp;k/references.htm" rel="nofollow noreferrer">Lock-on Technology Hacking Guide</a>, there are some chips on the Sonic &amp; Knuckles cartridge:</p>
<ul>
<li><a href="http://i2c2p.twibright.com/datasheet/74HC_HCT74_3.pdf" rel="nofollow noreferrer">74HC74 Dual D-type Flip-Flop</a></li>
<li><a href="http://www.solarbotics.net/library/datasheets/74AC139.pdf" rel="nofollow noreferrer">74AC139 1-of-4 decoder/demultiplexer</a></li>
<li><a href="https://www.fairchildsemi.com/datasheets/74/74AC08.pdf" rel="nofollow noreferrer">74AC08 Quad 2-input AND Gate</a></li>
</ul>
<p>Along with the two ROM chips and the cartridge slot, they implement the Lock-On functionality.</p>
<p>Rizzo&#39;s photographs show what the cartridge&#39;s printed circuit board looks like:</p>
<p><a href="https://i.stack.imgur.com/fFdzL.jpg" rel="nofollow noreferrer"><img src="https://i.stack.imgur.com/fFdzL.jpg" alt="Sonic &amp; Knuckles cartridge printed circuit board, front"/></a>
<a href="https://i.stack.imgur.com/Z7wso.jpg" rel="nofollow noreferrer"><img src="https://i.stack.imgur.com/Z7wso.jpg" alt="Sonic &amp; Knuckles cartridge printed circuit board, front"/></a></p>
<p>The Mega Drive&#39;s cartridge I/O is meant for only one cartridge. However, a cartridge locked onto Sonic &amp; Knuckles forms a system that contains three ROM chips:</p>
<ul>
<li>Sonic &amp; Knuckles cartridge
<ul>
<li>Sonic &amp; Knuckles ROM <sub>2 MB</sub></li>
<li>Sonic the Hedgehog 2 patch ROM <sub>512 kB</sub>
<ul>
<li>Responsible for <a href="http://info.sonicretro.org/Knuckles_the_Echidna_in_Sonic_the_Hedgehog_2" rel="nofollow noreferrer">Knuckles the Echidna in Sonic the Hedgehog 2</a></li>
</ul>
</li>
</ul>
</li>
<li>Locked-on cartridge
<ul>
<li>Game ROM</li>
</ul>
</li>
</ul>
<p>Apparently, the key functionality behind Lock-On Technology is choosing one of those ROM chips and connecting it to the appropriate addressing lines of the Mega Drive which is none the wiser.</p>
<p>This memory bank switching is apparently achieved via the chip enable lines. They are active when logically <code>0</code> and if inactive will cause all memory addressing operations to be ignored and nothing to be returned on the data bus, effectively &#34;disabling&#34; the chip. If one of the ROMs is disabled, the other will be mapped in its place. The Mega Drive just sees a big cartridge with a big address space.</p>
<p>Rizzo also made a schematic of the electronics:</p>
<p><a href="https://i.stack.imgur.com/ESaiS.gif" rel="nofollow noreferrer"><img src="https://i.stack.imgur.com/ESaiS.gif" alt="Sonic &amp; Knuckles Lock-On schematics, full"/></a></p>
<p>Even though I&#39;m not an electronics expert, I was able to figure some things out by studying the schematics and reading the notes on the website. Here&#39;s what I learned.</p>

<p>The purpose of this chip is to hold a single bit of information: is Sonic the Hedgehog 2 locked on? Much of the circuit&#39;s operation depends on this single bit. It is denoted by the red node on the schematic, corresponding to the 74HC74&#39;s <code>Q</code> output.</p>
<p>When Sonic &amp; Knuckles boots, it checks its cartridge slot. If there is a game locked on, it tests if its serial number matches that of earlier Sonic games. If it detects Sonic the Hedgehog 2, a signal is generated on the ROM&#39;s <code>D0</code> line, setting the <code>Q</code> bit of the 74HC74.</p>
<p>On Hacker News, <a href="https://news.ycombinator.com/user?id=Dylan16807" rel="nofollow noreferrer">Dylan16807</a> provides <a href="https://news.ycombinator.com/item?id=36743029" rel="nofollow noreferrer">additional information</a> about the workings of this bit:</p>
<blockquote>
<p>This is missing some important information.
One input to the flip flop is <code>D0</code> on the ROM, yes, but it only sets when there is a clock signal.
Otherwise there would be some very <em>interesting</em> coding constraints.</p>
<p>The clock of the flip flop is connected to cartridge pin <code>B31</code>.
Here&#39;s the best explanation I can find of that pin:</p>
<blockquote>
<p><code>/TIME</code> is the schematic label given to pin <code>B31</code> on the cartridge slot.
It is essentially a chip enable for the I/O port range <code>$A130Fx</code>, and is used for programming on-cart memory mappers.
The only games I know of that use it are Beyond Oasis, Phantasy Star 4 (both for switching between ROM and SRAM at <code>$200000-3FFFFF</code>) and Super Street Fighter 2 (for a full-blown ROM banking chip).
I don&#39;t know why it&#39;s called <code>/TIME</code>; perhaps they expected to connect an RTC chip to it.</p>
</blockquote>
<p>So if you write to certain addresses, the genesis will flicker that pin, which is great for controlling an extra chip like this.
(I mean, it&#39;s meant to control an extra chip, but it seems like the plan is a significantly smarter one than a flip flop.)</p>
</blockquote>

<p>There are two independent decoders <code>M</code> and <code>N</code>, each with three inputs <code>E̅</code>, <code>SA</code> and <code>SB</code> as well as four outputs <code>Y0</code>, <code>Y1</code>, <code>Y2</code> and <code>Y3</code>. If <code>E̅</code> is <code>1</code>, all outputs are also forced to <code>1</code>.</p>
<p>The <code>Y</code> outputs obey the following truth table:</p>
<pre><code>E̅ SA SB Y0 Y1 Y2 Y3
1 -- --  1  1  1  1
0  0  0  0  1  1  1
0  1  0  1  0  1  1
0  0  1  1  1  0  1
0  1  1  1  1  1  0
</code></pre>
<h3>The I/O arrangement of each decoder</h3>
<p><code>M</code> is connected to to address line 20 and the output of the 74HC74 through <code>SA</code> and <code>SB</code> respectively; <code>E̅</code> is connected to the <code>Y3</code> output of <code>N</code>. The chip enable line of the Sonic the Hedgehog 2 patch ROM is connected to <code>Y3</code>, while <code>Y0</code>, <code>Y1</code> and <code>Y2</code> are all inputs to the 74AC08.</p>
<p><code>N</code> is connected to address line 21 through both <code>SA</code> and <code>SB</code>. The chip enable signal from Mega Drive is connected to <code>E̅</code>. The chip enable line of the Sonic &amp; Knuckles ROM is connected to <code>Y0</code> but <code>Y1</code> and <code>Y2</code> are not connected to anything at all. <code>Y3</code> is connected to <code>M</code>&#39;s <code>E̅</code> input.</p>
<h3>Putting it all together</h3>
<p>Decoder <code>M</code> controls the activation of both the Sonic the Hedgehog 2 patch ROM and the locked-on cartridge&#39;s ROM. Decoder <code>N</code> controls the activation of the Sonic &amp; Knuckles ROM.</p>
<p>The A21 line addresses memory that is beyond the bounds of the game&#39;s 2 megabytes ROM. If this memory is accessed, the result is that the Sonic &amp; Knuckles ROM is disabled. Otherwise, it is enabled and <code>M</code>&#39;s <code>E̅</code> is set.</p>
<p>The A20 line addresses memory that is within bounds; if that memory is accessed and the 74HC74 is also set, the Sonic the Hedgehog 2 patch ROM is enabled and the outputs to the 74AC08 are all <code>1</code>. If <code>M</code>&#39;s <code>E̅</code> is set, the 74AC08 also receives all <code>1</code>s, but the patch ROM is not enabled.</p>

<p>The 74AC08 has three inputs <code>Y0</code>, <code>Y1</code> and <code>Y2</code> as well as a single output that equals <code>Y0 ∧ Y1 ∧ Y2</code> and is connected to the locked-on cartridge&#39;s chip enable line. Therefore, the second cartridge&#39;s ROM will only be mapped when all its inputs are <code>1</code>:</p>
<ul>
<li>Locked-on cartridge is Sonic the Hedgehog 2</li>
<li>Sonic &amp; Knuckles ROM is enabled
<ul>
<li><code>M</code>&#39;s <code>E̅</code> is set</li>
</ul>
</li>
</ul>
    </div></div>
  </body>
</html>
