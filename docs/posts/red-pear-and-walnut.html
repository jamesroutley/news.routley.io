<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://charles.inclouds.space/blog/redpear/">Original</a>
    <h1>red pear and walnut</h1>
    
    <div id="readability-page-1" class="page"><svg viewBox="0 0 200 200">
<path d="" fill="#63b4ff"></path>
</svg>






<nav>
<a href="https://charles.inclouds.space/">home</a>
<a href="https://charles.inclouds.space/art/">art</a>
<a href="https://charles.inclouds.space/projects/">projects</a>
<a href="https://notes.inclouds.space">lab notes</a>
<a href="https://charles.inclouds.space/blog/">blog</a>
</nav>
<h2><a href="https://charles.inclouds.space/">red pear and walnut</a></h2>
<h4>2023-05-24</h4>
<p>I have some new projects to share with you! The quick summary is:</p>
<ul>
<li>I made a new cloud programming environment called red pear! (<a href="https://redpear.dev">redpear.dev</a>) Its goal is to help you build small web apps very quickly. In particular, it helps you build 2012-era, backend-first web apps with the use of ruby and <a href="https://sinatrarb.com/">sinatra</a>.
<ul>
<li>Much like <a href="https://birch.ink">birch</a>, red pear has instant deploys: the code you write is hosted on a dev instance immediately and on a prod instance with the push of a button.</li>
<li>red pear is open source! (<a href="https://github.com/charlesetc/redpear">github</a>) I&#39;d love for people to make it their own. If you want to self-host comment <a href="https://github.com/charlesetc/redpear/issues/1">here</a>, it shouldn&#39;t be too hard.</li>
</ul>
</li>
<li>I made a new interface to persistent data for use in red pear: <a href="https://github.com/charlesetc/walnut">walnut</a>. Its goal is to be easier than something like sql or graphql, especially in the context of smaller apps.</li>
<li>You can watch me build a demo app in red pear <a href="#demo">here.</a></li>
</ul>
<h2 id="why-build-this">why build this?</h2>
<p>Unclear! <a href="https://charles.inclouds.space/blog/humans-are-monkeys/">I&#39;m a human being</a> after all, complete with a diverse set of motivations. I want to live a pleasant life, take part in our grand social conversation, find interesting people to talk to, fiddle with fun toys, follow my curiosities, make lots of money, gain respect from peers, etc, etc.</p>
<p>More singular, perhaps, is my motivation for publishing red pear now: I want to share as many interesting or useful ideas I&#39;ve had during this process with as wide an audience as possible. And I&#39;m hoping that real, instantiated software can help facilitate this discussion. So red pear!</p>
<h2 id="red-pear">red pear</h2>
<h3 id="description">description</h3>
<p><a href="https://redpear.dev/">red pear</a> is an online editor and platform for building ruby/sinatra apps. The target audience is either experienced developers who have a couple of hours on a weekend to build an app and don&#39;t want to spend that time setting up dev &amp; prod environments, or brand new developers for whom this setup process is a serious obstacle to actually coding.</p>
<p>red pear is simple:</p>
<ul>
<li>A red pear project consists of ruby functions and html/<a href="https://mustache.github.io/mustache.5.html">mustache</a> templates.</li>
<li>Functions can be assigned a route, like <code>GET /about</code> or <code>POST /users/:id/edit</code>.</li>
<li>Functions can return templates by name, possibly passing in some data to be rendered by mustache.</li>
<li>Functions can read and write data using a custom ruby library called walnut, more on that below.</li>
</ul>
<p>Each app gets compiled into a sinatra webserver hosted and running under redpear.dev: one subdomain for the dev instance and one for the prod instance.</p>
<p>People have been surprised by how fast this deploy is. Most function-as-a-service companies use VMs to sandbox users&#39; code. VMs take a while to spin up, even <a href="https://firecracker-microvm.github.io/">the fast ones</a>. Instead I&#39;m using a user-space sand-boxing tool called <a href="https://manpages.debian.org/testing/bubblewrap/bwrap.1.en.html">bubblewrap</a>, which only adds a few milliseconds. I highly recommend it.</p>
<p>Aside from that, there isn&#39;t too much to say feature-wise â€” give it a <a href="https://redpear.dev">try</a>!</p>
<h3 id="current-status">current status</h3>
<p>I&#39;m proud and happy that red pear exists, both at redpear.dev and in whatever very niche zeitgeist it happens to contribute to. But I don&#39;t think it&#39;s something that I can or want to make money extending and improving. Aside from bug fixes and server maintenance, I won&#39;t be focusing on it in the future. It&#39;s <a href="https://github.com/charlesetc/redpear">open source</a> if people want to run with that!</p>
<h3 id="ideas-for-future-work">ideas for future work</h3>
<ul>
<li>There is surprisingly little ruby-specific code in red pear. It would be pretty easy to swap in javascript or python and use red pear as a general editor for different micro-frameworks and languages ðŸ¤”</li>
<li>At the moment, red pear is a multi-page app: to edit a function you navigate away from the index and into a separate editor tab. It&#39;d be nice to have the editor pop up on the same page as the index, keeping more of the context around and visible.</li>
<li>There&#39;s an opportunity to support &#34;server-side UI primitives&#34; in a red pear-like environment. Imagine creating a kafka-like <code>stream</code> as a server-side ruby value that you can embed directly into a template: </li>
</ul>
<p>... and many more ideas! Talk to me if you are thinking of building something similar.</p>
<h2 id="walnut">walnut</h2>
<h3 id="description-1">description</h3>
<p>walnut (<a href="https://github.com/charlesetc/walnut">github</a>) is a ruby DSL made for storing data in red pear. The goal is to make interacting with persistent, relational data much easier. It works like so:</p>
<p>We can create a walnut object by &#34;calling&#34; a ruby symbol:</p>
<pre data-lang="ruby"><code data-lang="ruby"><span>def </span><span>a_function_in_red_pear</span><span>()
</span><span>	</span><span># ...
</span><span>	alice </span><span>= :</span><span>person</span><span>.(</span><span>name</span><span>: &#34;</span><span>Alice</span><span>&#34;)
</span><span>	</span><span># ...
</span><span>end
</span></code></pre>
<p>We don&#39;t have to define a schema for <code>:person</code> ahead of time; we could have used any other tag, <code>:dog</code>, <code>:plant</code>, etc, and it would have worked just fine. In addition to being stored as a variable <code>alice</code>, this <code>:person</code> is immediately written to disk. </p>
<p>We can query all the people:</p>
<pre data-lang="ruby"><code data-lang="ruby"><span>irb</span><span>&gt; :</span><span>person</span><span>.</span><span>all
</span><span>=&gt; [:</span><span>person</span><span>.(</span><span>name</span><span>: &#34;</span><span>Alice</span><span>&#34;),
</span><span>    </span><span>:</span><span>person</span><span>.(</span><span>name</span><span>: &#34;</span><span>Bob</span><span>&#34;)]
</span></code></pre>
<p>We can get a reference to a person by indexing into this array:</p>
<pre data-lang="ruby"><code data-lang="ruby"><span>irb</span><span>&gt;</span><span> alice </span><span>= :</span><span>person</span><span>.</span><span>all</span><span>[</span><span>0</span><span>]
</span><span>=&gt; :</span><span>person</span><span>.(</span><span>name</span><span>: &#34;</span><span>Alice</span><span>&#34;)
</span></code></pre>
<p>or by filtering first:</p>
<pre data-lang="ruby"><code data-lang="ruby"><span>irb</span><span>&gt;</span><span> bob </span><span>= :</span><span>person</span><span>.</span><span>findmany</span><span>(</span><span>name</span><span>: &#34;</span><span>Bob</span><span>&#34;)[</span><span>1</span><span>]
</span><span>=&gt; :</span><span>person</span><span>.(</span><span>name</span><span>: &#34;</span><span>Bob</span><span>&#34;)
</span></code></pre>
<p>We can update a person as you would a normal ruby object:</p>
<pre data-lang="ruby"><code data-lang="ruby"><span>irb</span><span>&gt;</span><span> alice</span><span>.</span><span>friends </span><span>= [</span><span> bob </span><span>]
</span></code></pre>
<p>...and this is instantly reflected on disk, no &#34;save&#34; step needed. We can then re-query all the people and see an updated result:</p>
<pre data-lang="ruby"><code data-lang="ruby"><span>irb</span><span>&gt;</span><span> person</span><span>.</span><span>all
</span><span>=&gt; [:</span><span>person</span><span>.(</span><span>name</span><span>: &#34;</span><span>Alice</span><span>&#34;, </span><span>friends</span><span>: [:</span><span>person</span><span>.(</span><span>name</span><span>: &#34;</span><span>Bob</span><span>&#34;)]),
</span><span>    </span><span>:</span><span>person</span><span>.(</span><span>name</span><span>: &#34;</span><span>Bob</span><span>&#34;),
</span></code></pre>
<p>Bob is stored in Alice&#39;s friends <em>as a reference,</em> so if we change Bob&#39;s name, it&#39;ll change everywhere:</p>
<pre data-lang="ruby"><code data-lang="ruby"><span>irb</span><span>&gt;</span><span> bob</span><span>.</span><span>name </span><span>+= &#39;</span><span> Ross</span><span>&#39;
</span><span>=&gt; &#34;</span><span>Bob Ross</span><span>&#34;
</span><span>
</span><span>irb</span><span>&gt; :</span><span>person</span><span>.</span><span>all
</span><span>=&gt; [:</span><span>person</span><span>.(</span><span>name</span><span>: &#34;</span><span>Alice</span><span>&#34;, </span><span>friends</span><span>: [:</span><span>person</span><span>.(</span><span>name</span><span>: &#34;</span><span>Bob Ross</span><span>&#34;)]),
</span><span>    </span><span>:</span><span>person</span><span>.(</span><span>name</span><span>: &#34;</span><span>Bob Ross</span><span>&#34;),
</span></code></pre>
<p>That&#39;s pretty much everything. Fun fact: I use walnut as the storage API for red pear itself. It&#39;s been really easy to work with! Though it should be said, red pear has <em>just</em> grown large enough that I am feeling the need for a standardized schema, instead of the ad-hoc dynamic data walnut gives you.</p>
<p>This dynamism was a motivation for creating walnut in the first place; it&#39;s much nicer not to have to write a schema upfront if you&#39;re only writing a small app.</p>
<p>Okay but traditional nosql databases like mongo don&#39;t require schemas, right? And what about key-value stores? Well, joins in mongo are super verbose. (Sql too for that matter.) And joining across prefixes in a key-value store is a dreadfully manual process.</p>
<p>This is what walnut does best: it makes joins <strong>very easy</strong>. You can quickly traverse relationships to get your friend&#39;s friend&#39;s dog&#39;s name, and you can do that without having to learn another language or syntax. It&#39;s all just mapping, indexing, and filtering in ruby.</p>
<h3 id="ideas-for-future-work-1">ideas for future work</h3>
<ul>
<li>walnut is currently backed by json files on disk, but it would be very cool to extend it as a frontend to sqlite or postgres! There are some tricky parts there I&#39;m sure but nothing insurmountable.</li>
<li>One could infer a database schema through static analysis of all the walnut writes and reads peppered throughout the code. Perhaps this schema could be tracked in version control, so a programmer would have to approve any changes. Could be a neat way to automate the writing of schemas.</li>
<li>walnut doesn&#39;t have any notion of indices at the moment: every select involves walking the whole table. One option to improve scalability would be to allow people to create indices explicitly, perhaps within the graphical interface of red pear. Another route would be to create good indices automatically, even asynchronously, through query pattern analysis. So much left to be explored!</li>
</ul>
<h2 id="demo">demo</h2>
<p><iframe src="https://player.vimeo.com/video/829900863?h=d46fa9519c&amp;badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen="" title="red-pear"></iframe></p>
<h2 id="the-end">the end</h2>
<p>Thanks for reading! Try out red pear if you like; I&#39;ll be sure to address any questions or errors you might have. </p>
<p>And I&#39;ve got some more fun projects in the works! Subscribe if you&#39;d like to keep up to date:</p>

<p>See you next time!</p>
<p><a href="https://charles.inclouds.space/blog/">â†µ</a></p>



</div>
  </body>
</html>
