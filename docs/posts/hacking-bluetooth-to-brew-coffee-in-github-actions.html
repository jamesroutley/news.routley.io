<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://grack.com/blog/2022/12/01/hacking-bluetooth-to-brew-coffee-on-github-actions-part-1/">Original</a>
    <h1>Show HN: Hacking Bluetooth to brew coffee in GitHub actions</h1>
    
    <div id="readability-page-1" class="page"><div>


<div>




<section>

<article>
<header>
<h2>Hacking Bluetooth to Brew Coffee from GitHub Actions: Part 1 - Bluetooth Investigation</h2><a href="https://grack.com/blog/2022/12/01/hacking-bluetooth-to-brew-coffee-on-github-actions-part-1">permalink</a>
</header>
<section>
<p>This is going to be a long journey in three parts that covers the odyssey of getting a new coffeemaker, learning BTLE and how it works, reverse-engineering the Bluetooth interface and Android applications for the coffeemaker, writing a <a href="https://github.com/mmastrac/longshot">Rust-based CLI interface</a>, and finally, hooking it all up to a GitHub actions bot that lets you <a href="https://github.com/mmastrac/brew-a-coffee-demo/">brew a coffee just by filing an issue</a>!</p>
<ul>
<li><a href="https://grack.com/blog/2022/12/01/hacking-bluetooth-to-brew-coffee-on-github-actions-part-1">Part 1: Bluetooth Investigation</a>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#btle-background-and-traffic-sniffing">BTLE Background and Traffic Sniffing</a></li>
<li><a href="#communicating-in-rust">Communicating in Rust</a></li>
<li><a href="#further-reading-for-this-post">Further Reading</a></li>
</ul>
</li>
<li><a href="https://grack.com/blog/2022/12/02/hacking-bluetooth-to-brew-coffee-on-github-actions-part-2">Part 2: Reverse Engineering</a></li>
<li><a href="https://grack.com/blog/2022/12/04/hacking-bluetooth-to-brew-coffee-on-github-actions-part-3">Part 3: GitHub Actions</a></li>
</ul>
<h2 id="introduction">Introduction</h2>
<p>I’ve always been pretty content with using whatever coffeemaker I had nearby. For the last two or three years I’ve been using an old 2-in-1 Breville YouBrew coffeemaker, with a grinder built-in. It was a workhorse and worked perfectly until this September. A few months ago the machine asked me to run the regular descaling process to deal with our hard water, and this is where our adventure starts.</p>
<p><a href="https://grack.com/assets/2022/12/part-1-breville-youbrew.jpeg"><img src="https://grack.com/_thumbs/04d2d0502ca652e67d2ddff6722bd37e-600-600"/></a></p>
<p>For those of you without <a href="https://en.wikipedia.org/wiki/Hard_water">hard water</a>, our water in Canada like that of Italy, tends to be hard due to the type of rocks that water passes through on the way into our water supply. Over time, the hard water minerals precipitate out and stick to the metallic pipes and heaters within the machine, causing the temperature of the brewing water to drop, and other quality problems. <a href="https://www.kitchenaid.com/pinch-of-help/countertop-appliances/how-to-clean-and-descale-a-coffee-maker.html">Regular descaling</a> is recommended, and some modern machines feature special descaling modes and chemicals that make this easier to do.</p>
<p><a href="https://grack.com/assets/2022/12/part-1-Map-of-water-hardness-of-Italian-tap-water-Classification-is-presented-in-the-legend.png"><img src="https://grack.com/_thumbs/c0aef4579e0ae0a88b3dacccb182dd61-600-600"/></a></p>
<p>Figure: <a href="https://www.researchgate.net/publication/231520556_Major_and_Trace_Elements_in_Tap_Water_from_Italy">Major and Trace Elements in Tap Water from Italy</a> January 2012 <em>Journal of Geochemical Exploration 112:54-75</em> DOI:10.1016/j.gexplo.2011.07.009</p>
<p>To descale a machine, you generally use a weak acid like vinegar, or a more complex <a href="https://en.wikipedia.org/wiki/Descaling_agent">descaling agent</a> to dissolve the precipitate as salts so they can be flushed out. Unfortunately, the last time I ran the descaling process on this coffeemaker the acid I was using seems to have degraded one of the internal seals and the machine began to leak significantly.</p>
<p><a href="https://grack.com/assets/2022/12/part-1-leak.jpeg"><img src="https://grack.com/_thumbs/b4a51f655be2153965b008e20a0068bf-600-600"/></a></p>
<p>Faced with the prospect of opening it up and actually figuring out what part was leaking, I was finally convinced that given the amount of coffee we drink, it was time for us to invest in a more modern and little more upscale coffeemaker.</p>
<p>Fortunately a few months earlier over the same Spring, my partner had been TA’ing a course at a building in a nearby hospital over the summer and came home raving about a machine they had, that let her brew coffee from an application: the Delonghi Dinamica Plus. We talked about how cool it was to brew from an app and how it could make so many different drinks, but we both forgot about it for a few months until our the old machine failed.</p>
<p><a href="https://grack.com/assets/2022/12/part-1-dinamica-plus.jpeg"><img src="https://grack.com/_thumbs/b520c81f57a2c16343ad0fb6dedae554-600-600"/></a></p>
<p>Our coffee situation was pretty dire and we decided to pull the trigger on a Delonghi Dinamica Plus, despite the eye-watering price. We waited anxiously for a week, keeping the old coffeemaker in service by putting it inside a tray to catch the leaks.</p>
<p>When the new coffeemaker arrived we set it up and – to avoid a major digression – the coffee it made was excellent. Tasty espresso, perfect americano, creamy cappuccino. There was one major problem: the application you’re supposed to use for the coffeemaker doesn’t reliably connect and stay connected to the machine.</p>
<p>The <a href="https://www.delonghi.com/en-ca/dinamica-plus-smart-coffee-and-espresso-machine-with-coffee-link-connectivity-app-plus-automatic-milk-frother-titanium-ecam37095ti/p/ECAM37095TI">Dinamica Plus</a> is about $100 more than the <a href="https://www.delonghi.com/en-ca/dinamica-with-lattecrema-automatic-coffee-and-espresso-machine-with-iced-coffee-plus-automatic-milk-frother-silver-ecam35075si/p/ECAM35075SI">Dinamica</a>, and this cost is effectively for the privilege of brewing coffee from your phone (along with some other goodies, like defining your favourite or custom drinks from the couch). The application is difficult to use and a bit buggy, however. It will often fail to find the coffeemaker. Once you’ve connected, there’s no guarantee that it’ll allow you to connect again without wiping all the saved data from the application. It’s also integrated with some sort of online service that returns a 404.</p>
<p><a href="https://grack.com/assets/2022/12/part-1-coffee-lounge-404.png"><img src="https://grack.com/_thumbs/264c3ee556c10dbb41229978cade1e7a-600-600"/></a></p>
<p>I found myself at a crossroads here: Do I accept that the extra features that I paid for will go to waste, or do I dig in and see if there’s some way I can get this feature to work in a way that I can actually use it. There’s a lot you can learn by being forced to dig into something new, and it looked like this might be an opportunity to understand a bit more about Bluetooth. So, as you can probably guess from the remaining length on this topic, I took the latter path.</p>
<h2 id="btle-background-and-traffic-sniffing">BTLE Background and Traffic Sniffing</h2>
<p>The first question we need to answer is how we’re going to talk to this thing. We know it’s Bluetooth from the application’s insistence that Bluetooth be turned on. But it’s not showing up on my MacBook’s Bluetooth devices list, which means it’s somehow different than the common Bluetooth “Classic” audio and phone devices that show up there.</p>
<p>There may be other reasons why the coffeemaker doesn’t show up in a list of Bluetooth devices on a laptop, but the most likely candidate for something that isn’t Bluetooth Classic like those devices is <a href="https://learn.adafruit.com/introduction-to-bluetooth-low-energy">Bluetooth Low-Energy</a>, or more commonly known as BTLE.</p>
<p>One of BTLE’s major fame was its use in <a href="https://en.wikipedia.org/wiki/IBeacon">iBeacon</a> for the Apple ecosystem: a way of transmitting that a physical location was “interesting” in some way to some set of applications. This is done by <a href="https://os.mbed.com/blog/entry/BLE-Beacons-URIBeacon-AltBeacons-iBeacon/">“advertising”</a> Apple’s Bluetooth SIG identifier, along with an ID that specifies you’re talking iBeacon language, and some metadata allowing you to identify two 16-bit numbers of data along with that.</p>
<p>BTLE devices are often hidden from general device users, and you access them through specific programs and applications. For example, if you’re looking to rent a scooter, the app might communicate directly with the scooter over BTLE to unlock it for use directly from the phone – no cellular radio required!</p>
<p>We can scan for BTLE devices using an app like <a href="https://play.google.com/store/apps/details?id=no.nordicsemi.android.mcp">nRF Connect</a> that will show us all the nearby devices to our mobile phone. In the screenshot below you’ll see everything that speaks BTLE that my phone can see:</p>
<p><a href="https://grack.com/assets/2022/12/part-1-nRF-screenshot.png"><img src="https://grack.com/_thumbs/16a8fb83efb3c3fb814fcd3ab618fd67-600-600"/></a></p>
<p>There’s no obvious coffeemaker here but we can start to make some educated guesses by using signal strength. We’ll walk from the couch to the coffeemaker and see that one of our BTLE devices shows an increasing signal level.</p>
<p>We can confirm that this is the right device by forcing a connection to it and seeing the same Bluetooth icon appear on the screen that also appears when the application connects.</p>
<p><a href="https://grack.com/assets/2022/12/part-1-connect.png"><img src="https://grack.com/_thumbs/b89f81a72a1128a2b442ace57bf9a1aa-600-600"/></a></p>
<p>Aha! So now we’ve proved this coffeemaker is communicating over BTLE. But let’s digress and dig into what BTLE actually is, so we can figure out how to talk to it.</p>
<p>At a high level, BTLE works around the concept of a <em>Service</em> and a <em>Characteristic</em>, both identified by UUIDs. A <em>Service</em> is a container for <em>Characteristic</em>s and, at a high level, two services on two different devices sharing the same UUID will generally implement the same “protocol”. BTLE stacks on devices will generally allow you to scan for announcements of devices advertising a <em>Service</em> UUID you are interested in, allowing you to take inventory of supported devices relatively easily.</p>
<p>The <em>Characteristic</em> is an endpoint on the <em>Service</em> and has some directionality information embedded within it. A <em>Characteristic</em> at a high level provides <code>READ</code> and/or <code>WRITE</code> operations to communicate with the device, but also which of the devices in the connection can be the origin of this data (ie: does the device broadcast packets? will it send them unannounced? does the device only communicate if you send it something first?). <a href="https://devzone.nordicsemi.com/guides/short-range-guides/b/bluetooth-low-energy/posts/ble-characteristics-a-beginners-tutorial">Table 2 in this tutorial</a> lists the options if you’re interested in more detail.</p>
<p>We’ve learned some important information along the way. From our scan earlier, we know the two bits we need to communicate with the device, ie: the <em>Service</em> UUID is <code>00035b03-58e6-07dd-021a-08123a000300</code> and the <em>Characteristic</em> UUID is <code>00035b03-58e6-07dd-021a-08123a000301</code>.</p>
<p>What we need now is something to send to it. I’m not brave enough to brute force packets for an expensive coffeemaker, so let’s try to capture some real communication between the application and the device.</p>
<p>Android has something called the Bluetooth HCI snoop log that, as you can imagine, allows you to snoop on Bluetooth communication. HCI stands for “host-controller interface”, and we’ll use the snooper to log interaction between the phone and the coffeemaker. The process of enabling and retrieving HCI logs <a href="https://stackoverflow.com/questions/28445552/bluetooth-hci-snoop-log-not-generated">varies</a> <a href="https://medium.com/@charlie.d.anderson/how-to-get-the-bluetooth-host-controller-interface-logs-from-a-modern-android-phone-d23bde00b9fa">wildly</a> between device models, so your mileage may vary.</p>
<p>We can tap the button in the app to brew a cappuccino and, from the logs, see what the application sends to the machine. We don’t have any context as to what these packets are, but we know that sending this will brew a cappuccino with the default parameters (which according to the application is 65ml of coffee, 19 seconds of milk, and “medium” aroma):</p>
<pre><code>Brew a cappuccino:
0d 14 83 f0 07 01 01 00 41 09 00 be 02 03 0c 00 1c 02 06 dc

Device sends back:
d0 07 83 f0 01 00 64 d9

Cancel brewing:
0d 08 83 f0 07 02 06 2f 41

Device sends back:
d0 07 83 f0 01 00 64 d9
</code></pre>
<h2 id="communicating-in-rust">Communicating in Rust</h2>
<p>Now we’re going to need to talk to the coffeemaker ourselves. Each platform has its own libraries for talking to Bluetooth devices (CoreBluetooth on OSX, bluez-over-DBUS for Linux, etc.) Because of the complexity of dealing with cross-platform Bluetooth, most platforms like node.js, Rust, and Python, provide libraries that abstract this away.</p>
<p>My first attempts to talk to the coffeemaker were using node.js. I tried <a href="https://github.com/noble/noble">noble</a>, and <a href="https://github.com/noble/bleno">bleno</a>, but neither appeared to work for me on my Mac. I’ve been wanting to get my Rust skills back into shape, so I decided to explore the <a href="https://github.com/deviceplug/btleplug">btleplug</a> library which is being actively maintained on all modern platforms.</p>
<p>To connect to the device we’re interested in, first we need to start a scan to find devices that are advertising the <em>Service</em> and <em>Characteristic</em> we are interested in. The following code fragment will ask <code>btleplug</code> to scan for peripherals on every adapter connected to the system.</p>
<pre><code>async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
    let manager = Manager::new().await?;
    let filter = ScanFilter {
        services: vec![SERVICE_UUID],
    };

    eprintln!(&#34;Looking for coffeemakers...&#34;);
    for adapter in manager.adapters().await? {
        adapter.start_scan(filter.clone()).await?;
        tokio::time::sleep(Duration::from_secs(10)).await;
        for peripheral in adapter.peripherals().await? {
            eprintln!(&#34;Found peripheral&#34;);
            peripheral.connect().await?;
            peripheral.discover_services().await?;
            for service in peripheral.services() {
                for characteristic in service.characteristics {
                    if service.uuid == SERVICE_UUID &amp;&amp; characteristic.uuid == CHARACTERISTIC_UUID {
                        run_with_peripheral(peripheral.clone(), characteristic).await?;
                    }
                }
            }
        }
    }

    Ok(())
}

async fn run_with_peripheral(
    peripheral: Peripheral,
    characteristic: Characteristic,
) -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
    eprintln!(&#34;{:?}&#34;, characteristic);
    Ok(())
}
</code></pre>
<p>If we run this code it, prints:</p>
<pre><code>Looking for coffeemakers...
Found peripheral
Characteristic { uuid: 00035b03-58e6-07dd-021a-08123a000301, service_uuid: 00035b03-58e6-07dd-021a-08123a000300, properties: READ | WRITE | INDICATE }
</code></pre>
<p>Looks good! We found the coffeemaker. And now we can try to send a raw packet to it that we had captured earlier that we believed was sent to brew cappuccino. Let’s change <code>run_with_peripheral</code> to this:</p>
<pre><code>async fn run_with_peripheral(peripheral: Peripheral, characteristic: Characteristic) -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
    let data = &amp;[0x0d,0x14,0x83,0xf0,0x07,0x01,0x01,0x00,
        0x41,0x09,0x00,0xbe,0x02,0x03,0x0c,0x00,0x1c,0x02,0x06,0xdc]; 
    peripheral.write(&amp;characteristic, data, btleplug::api::WriteType::WithoutResponse);
    Ok(())
}
</code></pre>
<p>And hey, that started brewing a cappuccino!</p>
<p><a href="https://grack.com/assets/2022/12/part-1-cappuccino.jpeg"><img src="https://grack.com/_thumbs/2648c801f7556860ebd9ead82bef9cdd-600-600"/></a></p>
<p>Let’s take stock of where we are:</p>
<ul>
<li>We know how to communicate with the device</li>
<li>We know the UUIDs of the endpoint that we’re going to communicate with</li>
<li>We can write a packet to the device and see that it performs an action</li>
</ul>
<p>This might be enough to stop here. We could trace all the packets to brew all the coffee recipes we want, but that doesn’t seem like a complete solution.</p>
<p><a href="https://grack.com/blog/2022/12/02/hacking-bluetooth-to-brew-coffee-on-github-actions-part-2"><em>Continue reading…</em></a> In <a href="https://grack.com/blog/2022/12/02/hacking-bluetooth-to-brew-coffee-on-github-actions-part-2">part two</a> of the series we’ll reverse engineer the protocol itself!</p>
<h2 id="further-reading-for-this-post">Further reading for this post</h2>
<ul>
<li><a href="https://learn.adafruit.com/introduction-to-bluetooth-low-energy">Adafruit: Introduction to Bluetooth Low-Energy</a></li>
<li><a href="https://os.mbed.com/blog/entry/BLE-Beacons-URIBeacon-AltBeacons-iBeacon/">Understanding the different types of BLE Beacons</a></li>
<li><a href="https://devzone.nordicsemi.com/guides/short-range-guides/b/bluetooth-low-energy/posts/ble-characteristics-a-beginners-tutorial">BTLE Characteristics, a beginner’s tutorial</a></li>
<li><a href="https://medium.com/@charlie.d.anderson/how-to-get-the-bluetooth-host-controller-interface-logs-from-a-modern-android-phone-d23bde00b9fa">How to get BT Host Controller Interface logs from a modern Android phone</a></li>
</ul>
<p><strong><em><a href="https://hachyderm.io/@mmastrac">Follow me on Mastadon</a> for more updates on this adventure!</em></strong></p>
<a href="https://grack.com/blog/2022/12/01/hacking-bluetooth-to-brew-coffee-on-github-actions-part-1">Read full post</a>
</section>

</article>

</section>
</div>




</div></div>
  </body>
</html>
