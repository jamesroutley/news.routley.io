<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://humanprogramming.substack.com/p/a-maybe-kinda-secure-way-to-evaluate">Original</a>
    <h1>A Maybe Kinda Secure Way to Evaluate Untrusted Javascript in a Web Browser*</h1>
    
    <div id="readability-page-1" class="page"><div><div><article><div class=""><div><div dir="auto"><p><strong>I’m not a security expert and I don’t guarantee that the approach laid out in this article is secure</strong><span>. In fact, part of why I’m writing this article is because I’d </span><em>love</em><span> for someone to point out the flaws with my approach, which </span><strong>very likely</strong><span> exist.</span></p><p>That said, I’m also writing this article because I couldn’t find great online resources about sandboxing Javascript, and felt that I should publish my learnings.</p><p><span>I and a collaborator are developing a successor to </span><a href="https://a.methodable.com/" rel="nofollow ugc noopener">Methodable</a><span>. The new tool will allow people to produce beautiful interactive guides.</span></p><p><span>One key feature of our tool is the ability to create guides that run computations in the background and incrementally render custom content for each user. We want to build a tool where any author can create magical interactivity </span><em>without</em><span> writing code, but we also want to allow authors to write executable snippets of Javascript in case they want additional customizability.</span></p><p><span>Suppose someone wants to make an interactive guide to the board game </span><a href="https://en.wikipedia.org/wiki/Catan" rel="nofollow ugc noopener">Catan</a><span>.</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Ffebaa32a-a4a2-41e2-9d0e-f40b4fccd991_1024x1024.jpeg" rel="nofollow ugc noopener"><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Ffebaa32a-a4a2-41e2-9d0e-f40b4fccd991_1024x1024.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Ffebaa32a-a4a2-41e2-9d0e-f40b4fccd991_1024x1024.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Ffebaa32a-a4a2-41e2-9d0e-f40b4fccd991_1024x1024.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Ffebaa32a-a4a2-41e2-9d0e-f40b4fccd991_1024x1024.jpeg 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Ffebaa32a-a4a2-41e2-9d0e-f40b4fccd991_1024x1024.jpeg" width="182" height="182" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/febaa32a-a4a2-41e2-9d0e-f40b4fccd991_1024x1024.jpeg&#34;,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:1024,&#34;width&#34;:1024,&#34;resizeWidth&#34;:182,&#34;bytes&#34;:null,&#34;alt&#34;:&#34;Catan | Asmodee&#34;,&#34;title&#34;:null,&#34;type&#34;:null,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;internalRedirect&#34;:null}" alt="Catan | Asmodee" title="Catan | Asmodee" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Ffebaa32a-a4a2-41e2-9d0e-f40b4fccd991_1024x1024.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Ffebaa32a-a4a2-41e2-9d0e-f40b4fccd991_1024x1024.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Ffebaa32a-a4a2-41e2-9d0e-f40b4fccd991_1024x1024.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Ffebaa32a-a4a2-41e2-9d0e-f40b4fccd991_1024x1024.jpeg 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>The board game Catan</figcaption></figure></div><p><span>First the author wants to ask how many people are playing, with six numbered buttons to click, and to assign the value of the clicked button to a variable called </span><code>players</code><span>. Here’s how that would look in the authoring UI:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf095b31-fed5-4e0a-a954-d16f2f814b39_1304x444.png" rel="nofollow ugc noopener"><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf095b31-fed5-4e0a-a954-d16f2f814b39_1304x444.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf095b31-fed5-4e0a-a954-d16f2f814b39_1304x444.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf095b31-fed5-4e0a-a954-d16f2f814b39_1304x444.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf095b31-fed5-4e0a-a954-d16f2f814b39_1304x444.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf095b31-fed5-4e0a-a954-d16f2f814b39_1304x444.png" width="1304" height="444" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/df095b31-fed5-4e0a-a954-d16f2f814b39_1304x444.png&#34;,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:444,&#34;width&#34;:1304,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:178518,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf095b31-fed5-4e0a-a954-d16f2f814b39_1304x444.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf095b31-fed5-4e0a-a954-d16f2f814b39_1304x444.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf095b31-fed5-4e0a-a954-d16f2f814b39_1304x444.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf095b31-fed5-4e0a-a954-d16f2f814b39_1304x444.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption><span>A view of the authoring experience. The author wrote a question, then created a button for each answer to the question, and indicated that the value of the clicked button should be assigned to a variable called </span><em>players.</em></figcaption></figure></div><p>The author also wants the guide to automatically evaluate whether the players need an expansion pack, so they add a code block:</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F0e4ba62f-c239-4b92-973c-cab0e99a16f2_1460x296.png" rel="nofollow ugc noopener"><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F0e4ba62f-c239-4b92-973c-cab0e99a16f2_1460x296.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F0e4ba62f-c239-4b92-973c-cab0e99a16f2_1460x296.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F0e4ba62f-c239-4b92-973c-cab0e99a16f2_1460x296.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F0e4ba62f-c239-4b92-973c-cab0e99a16f2_1460x296.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F0e4ba62f-c239-4b92-973c-cab0e99a16f2_1460x296.png" width="1456" height="295" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/0e4ba62f-c239-4b92-973c-cab0e99a16f2_1460x296.png&#34;,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:295,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:150423,&#34;alt&#34;:&#34;&#34;,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;internalRedirect&#34;:null}" alt="" title="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F0e4ba62f-c239-4b92-973c-cab0e99a16f2_1460x296.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F0e4ba62f-c239-4b92-973c-cab0e99a16f2_1460x296.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F0e4ba62f-c239-4b92-973c-cab0e99a16f2_1460x296.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F0e4ba62f-c239-4b92-973c-cab0e99a16f2_1460x296.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption><span>A view of a code block in the authoring experience. The variable </span><em>needsExpansion</em><span> is declared and assigned to be true in cases where there are more than four players.</span></figcaption></figure></div><p>Finally the author adds a conditional branch so that if the players need an expansion pack, a special section of the guide appears:</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F473fb480-2c0f-48f6-9060-9ff4fc12f824_1946x1322.png" rel="nofollow ugc noopener"><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F473fb480-2c0f-48f6-9060-9ff4fc12f824_1946x1322.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F473fb480-2c0f-48f6-9060-9ff4fc12f824_1946x1322.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F473fb480-2c0f-48f6-9060-9ff4fc12f824_1946x1322.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F473fb480-2c0f-48f6-9060-9ff4fc12f824_1946x1322.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F473fb480-2c0f-48f6-9060-9ff4fc12f824_1946x1322.png" width="1456" height="989" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/473fb480-2c0f-48f6-9060-9ff4fc12f824_1946x1322.png&#34;,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:989,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:163147,&#34;alt&#34;:&#34;&#34;,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;internalRedirect&#34;:null}" alt="" title="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F473fb480-2c0f-48f6-9060-9ff4fc12f824_1946x1322.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F473fb480-2c0f-48f6-9060-9ff4fc12f824_1946x1322.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F473fb480-2c0f-48f6-9060-9ff4fc12f824_1946x1322.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F473fb480-2c0f-48f6-9060-9ff4fc12f824_1946x1322.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>The author has created a branch in their document that is only visible to players who need the expansion pack.</figcaption></figure></div><p>How would the published guide look? If a group of five Catan players were to click the button “5” then they would see the following:</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F4a0d0953-709f-4524-981c-42951b54975e_2334x1514.png" rel="nofollow ugc noopener"><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F4a0d0953-709f-4524-981c-42951b54975e_2334x1514.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F4a0d0953-709f-4524-981c-42951b54975e_2334x1514.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F4a0d0953-709f-4524-981c-42951b54975e_2334x1514.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F4a0d0953-709f-4524-981c-42951b54975e_2334x1514.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F4a0d0953-709f-4524-981c-42951b54975e_2334x1514.png" width="1456" height="944" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/4a0d0953-709f-4524-981c-42951b54975e_2334x1514.png&#34;,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:944,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:235803,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F4a0d0953-709f-4524-981c-42951b54975e_2334x1514.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F4a0d0953-709f-4524-981c-42951b54975e_2334x1514.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F4a0d0953-709f-4524-981c-42951b54975e_2334x1514.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F4a0d0953-709f-4524-981c-42951b54975e_2334x1514.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>The Catan players’ view of the interactive guide. The guide has reacted to the players’ choice of “5” by rendering a new guide section that asks about the expansion pack.</figcaption></figure></div><p>Hopefully this simple example demonstrates the utility of allowing authors to write code that runs in the background while a guide renders.</p><p>So how do we actually go about evaluating Javascript within our web app? First off, some technical goals:</p><p>In general, we want authors who write code to feel like they have global execution context that they can tap into at any point in a document/guide’s lifecycle. To put that in more concrete terms, we have the following three goals for the API of our code execution environment:</p><p>We want to allow users to add variables to the context using normal Javascript declarations, like so:</p><blockquote><pre><code><span> </span><code>let myText = “hello world”</code></code></pre></blockquote><p>and like:</p><blockquote><pre><code><code>const {h,w} = {h: “hello”, w: “world”}</code></code></pre></blockquote><p>We want to allow the user to reference variables from that context in later code snippets, like so:</p><blockquote><pre><code><code>let helloWorld = h + “ “ + w</code></code></pre></blockquote><p> We want to evaluate expressions and access the resulting values from the outer context (from the browser window):</p><blockquote><pre><code><code>helloWorld.length &gt; 5</code></code></pre></blockquote><p>I intend for user-submitted Javascript code to be unable to read from anything other than its fenced-off execution context and unable to write to anything other than its fenced off execution context.</p><p><span>I am tentatively okay with allowing the user-submitted code to have </span><a href="https://en.wikipedia.org/wiki/Side_effect_(computer_science)" rel="nofollow ugc noopener">side effects</a><span> and make requests as long as it’s sandboxed off from any end-user data or browser storage. I am not 100% convinced that this is safe; again, please let me know if you have criticisms of my approach.</span></p><p><span>You can see all of the code at </span><a href="https://gist.github.com/dnsosebee/52e03181bf8c9629a27bc627e11f6412" rel="nofollow ugc noopener">this link</a><span> (Note that sometimes we use the word “flogram” as shorthand for “user-submitted code”).</span></p><p>Read on for a breakdown of the approach, which uses Web Workers, static analysis, and the Function constructor.</p><p>The advice about evaluating arbitrary Javascript that I came across most often was “don’t do it”. The second piece of advice I came across was to either “evaluate your code in a Web Worker” or “evaluate the code in a secure execution environment on your server.” We wanted an approach that works with our so-far client-rendered app, so we went with Web Workers.</p><p><span>According to the </span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers" rel="nofollow ugc noopener">mdn web docs</a><span>:</span></p><blockquote><p>Web Workers are a simple means for web content to run scripts in background threads.</p></blockquote><blockquote><p><span>Web workers run in another global context that is different from the current </span><code>window</code><span>. Thus, using the </span><code>window</code><span> shortcut to get the current global scope (instead of </span><code>self</code><span>) within a </span><code>Worker</code><span> will return an error.</span></p></blockquote><p><span> So, code evaluated within a worker cannot access the client’s </span><code>Window</code><span>. This removes the vulnerability for some </span><a href="https://owasp.org/www-community/attacks/xss/" rel="nofollow ugc noopener">XSS attacks</a><span> such as </span><a href="https://owasp.org/www-community/attacks/Session_hijacking_attack" rel="nofollow ugc noopener">session highjacking</a><span>. Still, be aware that Web Workers were not </span><em>designed </em><span>for sandboxed code execution, that’s only an incidental ability.</span></p><p><strong>Note: </strong><span>our approach uses a </span><em>Web Worker</em><span> and not a </span><em>Service Worker</em><span>. Service workers have more permissions and </span><a href="https://success.cse.tamu.edu/wp-content/uploads/sites/197/2020/07/SW-XSS_ACSAC20.pdf" rel="nofollow ugc noopener">may pose more of a security risk</a><span>.</span></p><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval#never_use_eval!" rel="nofollow ugc noopener">MDN recommends</a><span> we use the Function constructor instead of </span><code>eval</code><span> to create a blank canvas for execution. Here’s how we apply the Function constructor when we’re trying to evaluate code to return a value:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F1f2626ad-1351-4b20-bfcf-59998601e2cc_1198x580.png" rel="nofollow ugc noopener"><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F1f2626ad-1351-4b20-bfcf-59998601e2cc_1198x580.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F1f2626ad-1351-4b20-bfcf-59998601e2cc_1198x580.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F1f2626ad-1351-4b20-bfcf-59998601e2cc_1198x580.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F1f2626ad-1351-4b20-bfcf-59998601e2cc_1198x580.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F1f2626ad-1351-4b20-bfcf-59998601e2cc_1198x580.png" width="1198" height="580" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/1f2626ad-1351-4b20-bfcf-59998601e2cc_1198x580.png&#34;,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:580,&#34;width&#34;:1198,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:127845,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F1f2626ad-1351-4b20-bfcf-59998601e2cc_1198x580.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F1f2626ad-1351-4b20-bfcf-59998601e2cc_1198x580.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F1f2626ad-1351-4b20-bfcf-59998601e2cc_1198x580.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F1f2626ad-1351-4b20-bfcf-59998601e2cc_1198x580.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>Using the Function constructor to evaluate an expression against a key-value store context.</figcaption></figure></div><p><span>In this code snippet, we take in a string of user-submitted code (</span><code>toEval</code><span>) to evaluate and a context to evaluate it against, then create a code string that declares all of the context variables and finishes with a return statement that returns the evaluated user-submitted code. That code string is passed to the Function constructor, where it’s executed in a scoped function, and the result is returned.</span></p><p>How do we generate all of the context declarations/assignments for the code string? like so:</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb747671c-4d03-440a-9ae6-b71d3dbde64c_1052x724.png" rel="nofollow ugc noopener"><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb747671c-4d03-440a-9ae6-b71d3dbde64c_1052x724.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb747671c-4d03-440a-9ae6-b71d3dbde64c_1052x724.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb747671c-4d03-440a-9ae6-b71d3dbde64c_1052x724.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb747671c-4d03-440a-9ae6-b71d3dbde64c_1052x724.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb747671c-4d03-440a-9ae6-b71d3dbde64c_1052x724.png" width="1052" height="724" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/b747671c-4d03-440a-9ae6-b71d3dbde64c_1052x724.png&#34;,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:724,&#34;width&#34;:1052,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:122533,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb747671c-4d03-440a-9ae6-b71d3dbde64c_1052x724.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb747671c-4d03-440a-9ae6-b71d3dbde64c_1052x724.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb747671c-4d03-440a-9ae6-b71d3dbde64c_1052x724.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb747671c-4d03-440a-9ae6-b71d3dbde64c_1052x724.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>This function creates code that will pull all objects from the key/value context and declare them as function-level variables for our Function constructor</figcaption></figure></div><p>In order to allow the user to declare new variables, we need to know what new variables the user declares to save those new variables back into the context. It turns out that this is very difficult and Javascript basically doesn’t allow you to do that, at least not inside of functions:</p><p><span>In Javascript, </span><strong>you can’t access the function scope as an object </strong><span>(not since the </span><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/with" rel="nofollow ugc noopener">with statement</a><span> was deprecated). You can access things </span><em>within </em><span>the function scope but you cannot iterate over the keys and values in the scope, meaning you cannot tell what new variables have been declared in a function scope.</span></p><p>Here are three possible solutions to this conundrum:</p><p><span>Unlike function scopes, Javascript does actually allow you to iterate over the contents of the global scope, so we could evaluate user code in the global scope and then scrape the variables back out, but this gets very messy because the Web Worker global scope is full of all kinds of variables already. For example, if a user were to create a variable called </span><code>name</code><span> that would collide with the </span><code>self.name</code><span> variable that already exists in the Web Worker.</span></p><p><code>name</code><span> is a very popular variable name, so this is not a good solution.</span></p><p><span>We didn’t do this. Maybe it’s still a good idea. But for the time being, we’re dead set on the code experience </span><em>feeling</em><span> like just coding in a global context and declaring variables.</span></p><p><span>We decided to use the </span><a href="https://esprima.org/index.html" rel="nofollow ugc noopener">esprima</a><span> library to parse the user-submitted JS and identify newly declared variables, using the function </span><code>getDeclaredIdentifiers</code><span> below:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe4289e87-c596-44a9-b774-efdcf8ef3d45_1280x1840.png" rel="nofollow ugc noopener"><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe4289e87-c596-44a9-b774-efdcf8ef3d45_1280x1840.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe4289e87-c596-44a9-b774-efdcf8ef3d45_1280x1840.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe4289e87-c596-44a9-b774-efdcf8ef3d45_1280x1840.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe4289e87-c596-44a9-b774-efdcf8ef3d45_1280x1840.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe4289e87-c596-44a9-b774-efdcf8ef3d45_1280x1840.png" width="1280" height="1840" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/e4289e87-c596-44a9-b774-efdcf8ef3d45_1280x1840.png&#34;,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:1840,&#34;width&#34;:1280,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:365708,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe4289e87-c596-44a9-b774-efdcf8ef3d45_1280x1840.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe4289e87-c596-44a9-b774-efdcf8ef3d45_1280x1840.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe4289e87-c596-44a9-b774-efdcf8ef3d45_1280x1840.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe4289e87-c596-44a9-b774-efdcf8ef3d45_1280x1840.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>Using the esprima library to parse code and find declarators</figcaption></figure></div><blockquote><p><strong>Note:</strong><span> in the code above we catch “normal” declarations like </span><code>let a = 3</code><span>, and declarations that destructure from an object (using the recursive sub-function </span><code>getIdentifiersRecursive</code><span>), but not array-based destructuring and possibly not whatever unbeknownst-to-me variable declaration patterns are out there. For now, users will make do with the limited selection.</span></p></blockquote><p>Now that we know what new variables are declared in the user’s code, we can generate code to place at the end of our code string in cases where we are declaring new variables:</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F068e4a66-af06-45a7-a4bb-c78759b8b235_1300x652.png" rel="nofollow ugc noopener"><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F068e4a66-af06-45a7-a4bb-c78759b8b235_1300x652.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F068e4a66-af06-45a7-a4bb-c78759b8b235_1300x652.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F068e4a66-af06-45a7-a4bb-c78759b8b235_1300x652.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F068e4a66-af06-45a7-a4bb-c78759b8b235_1300x652.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F068e4a66-af06-45a7-a4bb-c78759b8b235_1300x652.png" width="1300" height="652" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/068e4a66-af06-45a7-a4bb-c78759b8b235_1300x652.png&#34;,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:652,&#34;width&#34;:1300,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:129478,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F068e4a66-af06-45a7-a4bb-c78759b8b235_1300x652.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F068e4a66-af06-45a7-a4bb-c78759b8b235_1300x652.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F068e4a66-af06-45a7-a4bb-c78759b8b235_1300x652.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F068e4a66-af06-45a7-a4bb-c78759b8b235_1300x652.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>A function that generates code that returns an object containing the entire existing context plus newly declared values.</figcaption></figure></div><p>So, putting that all together we can now take a context and some user-submitted code, evaluate the code against the context, and return the new context, including newly declared variables:</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F42621b90-afc5-47e8-b9b0-54db28776295_1300x832.png" rel="nofollow ugc noopener"><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F42621b90-afc5-47e8-b9b0-54db28776295_1300x832.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F42621b90-afc5-47e8-b9b0-54db28776295_1300x832.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F42621b90-afc5-47e8-b9b0-54db28776295_1300x832.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F42621b90-afc5-47e8-b9b0-54db28776295_1300x832.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F42621b90-afc5-47e8-b9b0-54db28776295_1300x832.png" width="1300" height="832" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/42621b90-afc5-47e8-b9b0-54db28776295_1300x832.png&#34;,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:832,&#34;width&#34;:1300,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:164756,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F42621b90-afc5-47e8-b9b0-54db28776295_1300x832.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F42621b90-afc5-47e8-b9b0-54db28776295_1300x832.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F42621b90-afc5-47e8-b9b0-54db28776295_1300x832.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F42621b90-afc5-47e8-b9b0-54db28776295_1300x832.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption><span>A function within the Web Worker that evaluates code and assigns declarations back into the context that was originally passed in. The parameter </span><em>declaredIdentifiers</em><span> comes from our parser functions.</span></figcaption></figure></div><p>Web Workers are messy and I try to abstract the handling of the workers away from the rest of my code as much as possible. In the end, I ended up with this interface:</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fa79a25b3-71a9-405c-b750-ba9a6ff96bc8_1280x1336.png" rel="nofollow ugc noopener"><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fa79a25b3-71a9-405c-b750-ba9a6ff96bc8_1280x1336.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fa79a25b3-71a9-405c-b750-ba9a6ff96bc8_1280x1336.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fa79a25b3-71a9-405c-b750-ba9a6ff96bc8_1280x1336.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fa79a25b3-71a9-405c-b750-ba9a6ff96bc8_1280x1336.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fa79a25b3-71a9-405c-b750-ba9a6ff96bc8_1280x1336.png" width="1280" height="1336" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/a79a25b3-71a9-405c-b750-ba9a6ff96bc8_1280x1336.png&#34;,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:1336,&#34;width&#34;:1280,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:289593,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fa79a25b3-71a9-405c-b750-ba9a6ff96bc8_1280x1336.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fa79a25b3-71a9-405c-b750-ba9a6ff96bc8_1280x1336.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fa79a25b3-71a9-405c-b750-ba9a6ff96bc8_1280x1336.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fa79a25b3-71a9-405c-b750-ba9a6ff96bc8_1280x1336.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>The two functions that allow us to evaluate user-submitted JS</figcaption></figure></div><p>These two simple function interfaces allow a guide experience to gradually build up a context by executing user-submitted code, and to evaluate user-submitted boolean conditions against that context as well. All user-submitted code execution is done in Web Workers in a separate file.</p><p><span>The screenshots in this article are not the complete code, once again </span><a href="https://gist.github.com/dnsosebee/52e03181bf8c9629a27bc627e11f6412" rel="nofollow ugc noopener">here’s all of the code</a><span>.</span></p><p><span>Even if user-submitted code cannot be used maliciously </span><em>within</em><span> our Web-Worker sandbox, we still have to be very careful with how we handle the resulting values outside of our sandbox. For example, if we allow users to display variable values in the guide, that means that at the very least the </span><code>toString</code><span> function is being called on values that were generated by untrusted code, which would be a vulnerability. This calls for strict validation before doing anything based on the results of user-submitted code.</span></p><p>Even then, I am not sure if it’s safe to store untrusted-code-generated context in the main thread, even if it’s just being stored and passed back to the Web Worker: perhaps there’s some way that the stored context could contain code that asynchronously gains access the main browser thread. Again, data validation could prevent this, and it may be necessary to limit the kinds of values that are allowed to live in the persistent context (more research needed!).</p><p><span>Many sandboxes like </span><a href="https://replit.com/" rel="nofollow ugc noopener">Replit</a><span> evaluate code server-side.</span></p><p><span>Another approach is to follow the lead of </span><a href="https://observablehq.com/" rel="nofollow ugc noopener">Observable</a><span> which has an entirely custom quasi-Javascript language and parser. But Observable still doesn’t recommend users to fork untrusted notebooks (and I assume Replit would not recommend people fork untrusted REPLs). There’s always inherent unpredictability when allowing people to run each other’s code.</span></p><p>I’ve presented a hacky but functional approach to giving users an in-browser code-execution sandbox. Let me know if you see any glaring security issues with my setup. And get psyched to start playing around with our magical document authoring experience soon :))</p><p>til next time,</p><p>Daniel</p></div></div></div></article></div></div></div>
  </body>
</html>
