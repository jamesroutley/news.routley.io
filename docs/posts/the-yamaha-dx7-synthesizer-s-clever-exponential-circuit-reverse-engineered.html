<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.righto.com/2021/11/reverse-engineering-yamaha-dx7_28.html">Original</a>
    <h1>The Yamaha DX7 synthesizer&#39;s clever exponential circuit, reverse-engineered</h1>
    
    <div id="readability-page-1" class="page"><div id="post-body-1047696568687268260" itemprop="description articleBody">


<p>The Yamaha DX7 digital synthesizer was released in 1983 and became extremely popular, defining the sound of 1980s pop music.
Because microprocessors weren&#39;t fast enough in the early 1980s, the DX7
used two custom digital chips: the EGS &#34;envelope&#34; chip generated frequency and envelope data,
which it fed to the OPS &#34;operator&#34; chip that generated the sound waveforms.
A key part of the OPS chip is an exponential circuit, which is used for frequency calculation and envelope application.
In this blog post, I examine this circuit—implemented by a ROM, shifter, and other circuitry—in detail and
extract the ROM&#39;s data.</p>
<p>I created the high-resolution die photo below by compositing over a hundred microscope photos.
Around the edges, you can see the 64 bond wires attached to pads; these connect the silicon die to the chip&#39;s 64 pins.
The chip has one layer of metal, visible as the whitish lines on top. (Power and ground are the thick metal lines.)
Underneath the metal, the polysilicon wiring layer appears reddish or greenish.
Finally, the underlying silicon is grayish.
I discussed the chip as a whole in my previous <a href="https://www.righto.com/2021/11/reverse-engineering-yamaha-dx7.html">DX7 article</a>; now I will focus on
the exponential circuit.</p>
<p><a href="https://static.righto.com/images/dx7-exp/die.jpg"><img alt="Die photo of the DX7&#39;s YM21280 Operator chip.  Click this photo (or any other) for a magnified version." height="523" src="https://static.righto.com/images/dx7-exp/die-w600.jpg" title="Die photo of the DX7&#39;s YM21280 Operator chip.  Click this photo (or any other) for a magnified version." width="600"/></a></p><p>Die photo of the DX7&#39;s YM21280 Operator chip.  Click this photo (or any other) for a magnified version.</p>
<p>The DX7 was the first commercially successful digital synthesizer.
Instead of the analog oscillators and filters of an analog synthesizer, the DX7 generates sounds digitally, using a technique called FM synthesis.
The idea is that you start with a sine wave (the carrier signal) and perturb it with another signal (the modulating signal). The modulating signal changes the phase (and thus the frequency) of the carrier, creating complex harmonic structures.
These signals are represented as digital values throughout the system; a digital-to-analog converter (DAC) turns the digital representation into
an analog voltage for the synthesizer&#39;s output.</p>
<p>The digital implementation of frequency modulation uses a lookup table that holds a digitized sine wave.
By stepping an index through the table at a specific rate, you can produce a sine wave of a fixed frequency. 
By perturbing this index with another signal, you can produce a modulated sine wave.
The DX7 implements this with a sine-wave table in ROM,
an increment value that controls the frequency, and an adder that adds the increment to the table index (i.e. the phase angle) each time step.
The DX7 has 96 oscillators, so it keeps track of 96 separate phase angles; these are stored in the phase accumulators.
The frequency modulation is implemented by <em>operator</em> circuitry, which allows oscillators to perturb other oscillators.
(This is a very brief overview of FM synthesis; see my previous <a href="https://www.righto.com/2021/11/reverse-engineering-yamaha-dx7.html">DX7 reverse-engineering article</a> for more details.)</p>
<h2>Logarithms and exponentials</h2>
<p>In hardware, multiplication is much slower than addition, especially with 1980s-era technology.
The solution in the DX7 is to represent values as base-2 logarithms because adding logarithms is equivalent to multiplying the values.
By applying 2<sup>x</sup> to the sum, the logarithmic value can be converted back to a linear value.</p>
<p>The first role for logarithms is in the frequency input to the chip: the phase increment value supplied to the chip is logarithmic.
The motivation is that note frequencies are related exponentially: for instance, going up one octave doubles the frequency.
By using logarithms, note computations can be done with addition.</p>
<p>Second, each oscillator has an associated envelope, which changes the output level according to a time-varying curve.<span id="fnref:envelope"><a href="#fn:envelope">1</a></span>
To multiply the signal by the envelope level,
the sine wave signal and the envelope are both represented logarithmically.
Thus, the multiplication is replaced by addition.
(The logarithm of the sine-wave signal is conveniently obtained by storing log<sub>2</sub>(sin(x)) in the waveform ROM instead of sin(x), so the logarithm is obtained &#34;for free&#34;.)</p>
<p>The block diagram below shows the structure of the exponential circuit that converts the logarithmic value
to a linear value by computing 2<sup>x</sup>.
The exponential circuitry is somewhat complex to fit a fast, high-accuracy exponential calculation into a small space on the die.
The circuit takes a 14-bit input value that consists of a 4-bit integer part and 10 fractional bits, so it computes 2<sup>x</sup> for 0≤x&lt;16.<span id="fnref:exact"><a href="#fn:exact">2</a></span>
The circuit uses a ROM lookup and a shift to rapidly compute the value.</p>
<p><a href="https://static.righto.com/images/dx7-exp/block-diagram.jpg"><img alt="Block diagram of the exponentiation circuit. Input bits are indicated in green." height="203" src="https://static.righto.com/images/dx7-exp/block-diagram-w700.jpg" title="Block diagram of the exponentiation circuit. Input bits are indicated in green." width="700"/></a></p><p>Block diagram of the exponentiation circuit. Input bits are indicated in green.</p>
<p>The ROM takes a 10-bit input address (0 through 1023) representing <em>x</em> values 0 through 1023/1024.
A technique called delta encoding is used to reduce the size of the ROM.
The idea of delta encoding is that if values change slowly, the difference between two values is considerably smaller than the value itself.<span id="fnref:ymf262"><a href="#fn:ymf262">3</a></span>
Specifically, only every fourth value is explicitly stored in the ROM; this value is called an &#34;absolute&#34; value.<span id="fnref:absolute"><a href="#fn:absolute">7</a></span>
The next three values are stored as the deltas, difference between the value and the previous absolute value.
The deltas fit into 4 bits<span id="fnref:deltamax"><a href="#fn:deltamax">4</a></span>, a considerable saving over the 11-bit absolute values.
An adder circuit adds the absolute value to the difference value, yielding the desired exponential value.</p>
<p>The final step in the exponential circuity is to perform a binary shift on the value from the ROM.
Shifting by the number of bits in the integer part of the input results in the final exponential value.<span id="fnref:shift"><a href="#fn:shift">6</a></span>
Prior to shifting, a leading 1 is added to the ROM&#39;s value so this bit doesn&#39;t take up space in the ROM.<span id="fnref:leadingone"><a href="#fn:leadingone">5</a></span>
The chip has two exponentiation circuits: one for computing the frequency and one for computing the signal (the sine and envelope path).
Most of the circuitry is identical between the two, but
the frequency exponent produces 22 bits of output, while the signal exponent has just 14 bits of output.</p>
<h2>A closer look at the die</h2>
<p>The diagram below labels the pins and the main functional blocks of the chip.
In this article, I focus on the two exponential circuits, highlighted in red, but I&#39;ll summarize the
other blocks.
The 96 phase accumulators, implemented with shift registers, are the largest block of the chip.
ROMs hold the sine wave function and the exponential function.
(There are two identical exponential ROMs, with associated adder and shifter circuitry.)
Other major blocks apply the envelope, hold configuration data, compute the operators that combine oscillators, define different operator algorithms, and buffer the output values.</p>
<p><a href="https://static.righto.com/images/dx7-exp/die-labeled.jpg"><img alt="Die with the major functional blocks labeled. This photo shows the metal layer of the chip. (Click for a larger version.)" height="523" src="https://static.righto.com/images/dx7-exp/die-labeled-w600.jpg" title="Die with the major functional blocks labeled. This photo shows the metal layer of the chip. (Click for a larger version.)" width="600"/></a></p><p>Die with the major functional blocks labeled. This photo shows the metal layer of the chip. (Click for a larger version.)</p>
<h3>Transistors</h3>
<p>To explain the die photos, I&#39;ll first show how a transistor (below) is constructed in an NMOS integrated circuit.
Regions of the silicon are doped with impurities to create diffusion regions with desired properties.
The transistor can be viewed as a switch, allowing current to flow between two diffusion regions called the source and drain.
The transistor is controlled by the gate, made of a special type of silicon called polysilicon.
A high voltage on the gate lets current flow between the source and drain, while a low voltage blocks current flow.
These tiny transistors are combined to form logic gates and other circuits.</p>
<p><a href="https://static.righto.com/images/dx7-exp/mosfet.jpg"><img alt="Structure of an NMOS transistor (MOSFET) as implemented in an integrated circuit." height="259" src="https://static.righto.com/images/dx7-exp/mosfet-w500.jpg" title="Structure of an NMOS transistor (MOSFET) as implemented in an integrated circuit." width="500"/></a></p><p>Structure of an NMOS transistor (MOSFET) as implemented in an integrated circuit.</p>
<p>To make the transistors more visible, I removed the metal layer from the chip, resulting in the high-resolution die photo below.
(The colors are due to variations in the thickness of the oxide layer due to my etching process.)</p>
<p><a href="https://static.righto.com/images/dx7-exp/stripped2.jpg"><img alt="Die photo of the DX7&#39;s YM21280 Operator chip with the metal layer removed.  Click this photo (or any other) for a magnified version." height="523" src="https://static.righto.com/images/dx7-exp/stripped2-w600.jpg" title="Die photo of the DX7&#39;s YM21280 Operator chip with the metal layer removed.  Click this photo (or any other) for a magnified version." width="600"/></a></p><p>Die photo of the DX7&#39;s YM21280 Operator chip with the metal layer removed.  Click this photo (or any other) for a magnified version.</p>
<h3>The ROM</h3>
<p>The diagram below shows one of the exponential ROMs.
The ROM is constructed from a grid of transistors: 128 rows by 32 columns.<span id="fnref:orientation"><a href="#fn:orientation">8</a></span>
At each grid point, a transistor can be present, representing a 1 bit; or a transistor can be absent, representing a 0 bit.<span id="fnref:polarity"><a href="#fn:polarity">9</a></span></p>
<p>At the top, decoders activate one of the 32 vertical select lines in the ROM, based on five bits of the address.
The ROM is arranged into groups of 8 rows (or fewer, depending on compression).
A multiplexer selects one bit of each group, based on three bits of the address.
This produces a 20-bit output.
Finally, the output logic produces the desired delta value, based on the address.
The result is the 11-bit absolute value and a 4-bit delta value.</p>
<p><a href="https://static.righto.com/images/dx7-exp/rom-labeled.jpg"><img alt="The ROM with the main components labeled." height="624" src="https://static.righto.com/images/dx7-exp/rom-labeled-w350.jpg" title="The ROM with the main components labeled." width="350"/></a></p><p>The ROM with the main components labeled.</p>
<p>Zooming in on the ROM shows the individual transistors. The large pale regions are the doped silicon, forming transistor sources and drains.
The polysilicon select lines are vertical.
A transistor is formed when a polysilicon line crosses a doped silicon region.
The indicated silicon regions are connected to ground, pulling one side of each transistor low.
The circles are connections called vias between the silicon and the metal lines above.
(The metal lines have been removed but the wavy horizontal lines show where the metal was.)</p>
<p><a href="https://static.righto.com/images/dx7-exp/rom-closeup.jpg"><img alt="Closeup of a 4×4 section of the ROM, showing its construction." height="319" src="https://static.righto.com/images/dx7-exp/rom-closeup-w350.jpg" title="Closeup of a 4×4 section of the ROM, showing its construction." width="350"/></a></p><p>Closeup of a 4×4 section of the ROM, showing its construction.</p>
<p>Each bit is stored in the ROM by the presence or absence of a transistor at a grid position.
(During manufacturing, the silicon doping pattern controls whether or not a transistor exists.)
When one of the 32 select lines is activated, all the transistors in that column will turn on, pulling the corresponding output lines low.
But if a transistor is missing, the corresponding output line will remain high.
Thus, a value is read from the ROM by activating a select line, reading that ROM value onto the output lines.
By looking at the silicon pattern in the ROM, I determined the sequence of 1&#39;s and 0&#39;s stored in the ROM, 4 kilobits in total.</p>
<h3>The multiplexer</h3>
<p>The ROM has 256 entries of 20 bits, before the delta processing is applied.
To make the layout more efficient, the ROM stores bits in groups of 8, (conceptually) organized as 8 rows of 32 entries (columns) for each output bit.
Each output bit has a multiplexer that selects one of the 8 bits in the group, based on 3 more address lines that control the 8 multiplexer select lines.</p>
<p><a href="https://static.righto.com/images/dx7-exp/multiplexer.jpg"><img alt="A multiplexer in the ROM." height="281" src="https://static.righto.com/images/dx7-exp/multiplexer-w500.jpg" title="A multiplexer in the ROM." width="500"/></a></p><p>A multiplexer in the ROM.</p>
<p>Each multiplexer (above) is implemented by 8 pass transistors. One transistor is activated, letting that row&#39;s bit through, while the unselected rows
are blocked.
The output of the multiplexer goes to the logic circuitry on the left.</p>
<p>Looking at the die photo closely shows that some of the multiplexers
don&#39;t have all eight rows.
This is a key optimization to reduce the ROM size.
If all the bits in a row are 0, the row can be eliminated from the ROM entirely.<span id="fnref:row-elimination"><a href="#fn:row-elimination">10</a></span></p>
<h3>The delta logic and the adder</h3>
<p>The ROM produces 20 output bits, 11 bits for the &#34;absolute&#34; value and 9 bits for the three delta values.
Some logic circuitry expands the ROM&#39;s 9 bits into three deltas of four bits, taking
advantage of some structure in the deltas.<span id="fnref:deltas"><a href="#fn:deltas">11</a></span></p>
<p>To obtain the <em>2<sup>x</sup>-1</em> value, the 11-bit absolute value and the 4-bit delta must be added.
This is accomplished by an adder circuit to the left of the ROM.
One interesting feature of the adder is it is pipelined to minimize the delay from carry propagation.
I discussed the adder in my <a href="https://www.righto.com/2021/11/reverse-engineering-yamaha-dx7.html">previous article</a> so I won&#39;t go into details here.</p>
<h3>The bit shifter</h3>
<p>The final building block that I&#39;ll discuss is the bit shifter, which implements the integer part of the
exponential calculation.
It shifts the value to the left by 0 to 15 bits,
which is equivalent to multiplying by a power of 2.
The shifter is built in two layers: the bottom layer shifts by 0, 1, 2, or 3 positions.
The upper layer shifts by 0, 4, 8, or 12 positions. The combination of the two layers permits any shift between 0 and 15 bit positions.
Wiring between the two layers distributes the outputs from the first layer to the second layer. Each output goes to four inputs, each spaced 4 bits apart
to provide the larger shift.</p>
<p><a href="https://static.righto.com/images/dx7-exp/shifter.jpg"><img alt="The shifter circuit." height="194" src="https://static.righto.com/images/dx7-exp/shifter-w600.jpg" title="The shifter circuit." width="600"/></a></p><p>The shifter circuit.</p>
<p>The diagram below shows part of the shifter that shifts by 0, 1, 2, or 3 positions, controlled by the horizontal lines.
The shifter is built from multiplexers, similar to those in the ROM, that select one of four inputs.
I&#39;ve highlighted one of the bits in green. If the &#34;shift 0&#34; line is activated, the rightmost green transistor (circled) will turn on and the green input bit
will exit from the rightmost output.
Likewise, if the &#34;shift 1&#34; line is activated, the second green transistor will turn on and the green bit will exit shifted one position to the left.
The &#34;shift 2&#34; and &#34;shift 3&#34; lines will cause the green bit to be shifted two or three positions to the left.
The remaining transistors (circled in black) act in the same manner to shift the other bits.
The result is that all the bits will be shifted by shifted 0, 1, 2, or 3 positions.
The second shifter is similar, except the input lines go to multiplexers that are four positions apart.</p>
<p><a href="https://static.righto.com/images/dx7-exp/shifter-detail2.jpg"><img alt="Detail of the shifter circuit." height="208" src="https://static.righto.com/images/dx7-exp/shifter-detail2-w600.jpg" title="Detail of the shifter circuit." width="600"/></a></p><p>Detail of the shifter circuit.</p>
<h2>Conclusion</h2>
<p>Computing exponents is a key part of the DX7&#39;s sound synthesis.
The chip needs to compute exponents very quickly, faster than an algorithm such as CORDIC could operate, but a straightforward ROM would have been much too large.
The chip solves this dilemma by using delta encoding, ROM compression, and a shifter circuit.
These techniques reduced the ROM size by almost 64%.<span id="fnref:efficiency"><a href="#fn:efficiency">12</a></span>
By examining the circuitry closely, I have reverse-engineered the exact values that are generated.
DX7 emulators may be able to achieve more accuracy by using these values.</p>
<p><a href="https://static.righto.com/images/dx7-exp/package.jpg"><img alt="The DX7&#39;s OPS chip comes in a 64-pin ceramic package with staggered pins. This is known as a Quad Inline Package (QIP)." height="222" src="https://static.righto.com/images/dx7-exp/package-w400.jpg" title="The DX7&#39;s OPS chip comes in a 64-pin ceramic package with staggered pins. This is known as a Quad Inline Package (QIP)." width="400"/></a></p><p>The DX7&#39;s OPS chip comes in a 64-pin ceramic package with staggered pins. This is known as a Quad Inline Package (QIP).</p>
<p>The next step is to reverse-engineer the chip&#39;s sine wave ROM, which implements the log-sin function.
That ROM uses many of the same techniques as the exponential ROM, but stores the deltas differently, for instance.
I announce my latest blog posts on Twitter, so follow me <a href="https://twitter.com/kenshirriff">@kenshirriff</a> for updates. I also have an <a href="https://www.righto.com/feeds/posts/default">RSS feed</a>.
If you&#39;re interested in ROM data, I also wrote about extracting constants from the <a href="https://www.righto.com/2020/05/extracting-rom-constants-from-8087-math.html">8087 floating point chip</a>.</p>
<p>Thanks to Jacques Mattheij and Anthony Richardson for providing the chip and discussion.<span id="fnref:refs"><a href="#fn:refs">14</a></span></p>
<h2>Notes and references</h2>
<div>
<ol>
<li id="fn:envelope">
<p>For an output signal, the envelope gives the note a more realistic sound; a typical sound has a sharp attack when it is first played, and then the
volume decays. The level is sustained until the key is released, and then dies off quickly.
However, the DX7 also applies envelopes to the modulating signals, allowing the timbre of the note to change over time. <a href="#fnref:envelope" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn:exact">
<p>The exact values of the exponentiation circuit are given as follows.
Suppose the 14-bit input value is <em>int.frac</em>, where <em>int</em> is the 4-bit integer part and <em>frac</em> is the 10-bit fractional
part.
The 12-bit output value from the ROM, after the delta adder and appending a leading 1 bit, is exactly given by <em>round(2<sup>frac</sup>×2048)</em>.
The shifter applies a left shift of 0 to 15 bits and then the result is truncated to 22 or 14 bits, for the frequency and signal exponentiation respectively.
The final results are
</p>
<p>In both cases, the fixed 1 is in the leftmost position of the output when the input has maximum integer portion (i.e. 15).
(This is necessary since otherwise the value would either get truncated, or the leftmost bit would be unused.)
However, with input integer portion of 0, the frequency circuit still has 7 bits of output,
while the envelope circuit produces a value of 0 (since all the bits are lost in shifting). <a href="#fnref:exact" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
<li id="fn:ymf262">
<p>A different chip, the Yamaha YMF262 (1988) was used in computer sound cards such as the Sound Blaster 16.
(This chip is also known as <a href="https://en.wikipedia.org/wiki/Yamaha_OPL#OPL3">OPL3</a> for FM Operator Type-L.)
It uses FM synthesis, but is stripped down compared to the DX-7.
The chip was <a href="https://docs.google.com/document/d/18IGx18NQY_Q1PJVZ-bHywao9bhsDoAqoIn1rIm42nwo/edit">reverse-engineered</a> by 
Matthew Gambrell and Olli Niemitalo who decapsulated the chip and read out the ROM contents.</p>
<p>The OPL3 exponential ROM is similar to the DX7&#39;s in some ways, but is also very different.
The OPL3 chip is 256 samples long, rather than 1024, and holds 10-bit values, rather than
12-bit values.
Both chips use delta encoding, but the OPL3 has one delta-encoded value for each absolute
value, while the DX7 has three delta-encoded values. <a href="#fnref:ymf262" title="Jump back to footnote 3 in the text">↩</a></p>
</li>
<li id="fn:deltamax">
<p>The graph below shows the exponential function 2<sup>x</sup> over the fractional range.
The difference between successive elements is fairly small, so a 4-bit delta value is sufficient.
Storing a 4-bit difference instead of an 11-bit absolute value achieves a large space saving.</p>
<p><a href="https://static.righto.com/images/dx7-exp/graph.jpg"><img alt="Graph of 2x over the fractional range." height="295" src="https://static.righto.com/images/dx7-exp/graph-w500.jpg" title="Graph of 2x over the fractional range." width="500"/></a></p><p>Graph of 2<sup>x</sup> over the fractional range.</p>
<p>Since the exponential function is convex, the largest delta in the exponential table is at the right,
specifically (2<sup>1023/1024</sup>-2<sup>1020/1024</sup>)×2048 ≈ 8.3.
The delta almost fits into three bits, but four bits are required. <a href="#fnref:deltamax" title="Jump back to footnote 4 in the text">↩</a></p>
</li>
<li id="fn:leadingone">
<p>The ROM stores 2<sup>x</sup>-1 rather than 2<sup>x</sup>, since all the values have a leading one.
Specifically, for 0≤x&lt;1, 1≤2<sup>x</sup>&lt;2. Adding 1 to the ROM&#39;s output instead of explicitly storing it in
the ROM
reduces the ROM&#39;s size. <a href="#fnref:leadingone" title="Jump back to footnote 5 in the text">↩</a></p>
</li>
<li id="fn:shift">
<p>Mathematically, if the input value is split into integer and fractional parts: <em>int+frac</em>, then 2<sup>int+frac</sup> = 2<sup>int</sup>×2<sup>frac</sup>.
Multiplying by 2<sup>int</sup> is the same as performing a binary shift <em>int</em> bits to the left. <a href="#fnref:shift" title="Jump back to footnote 6 in the text">↩</a></p>
</li>
<li id="fn:absolute">
<p>The absolute value in delta encoding is the full, explicit value. It&#39;s unrelated to the absolute value function |x|. <a href="#fnref:absolute" title="Jump back to footnote 7 in the text">↩</a></p>
</li>
<li id="fn:orientation">
<p>The two exponential ROMs on the chip are identical, except one is horizontal and one is vertical.
This makes referring to rows and columns a bit ambiguous; hopefully it all makes sense. <a href="#fnref:orientation" title="Jump back to footnote 8 in the text">↩</a></p>
</li>
<li id="fn:polarity">
<p>Whether a transistor in the ROM represents a 1 or a 0 is somewhat arbitrary, since the signal gets inverted several times before use.
A transistor will cause that line of the ROM to be pulled low, so at the fundamental level a transistor represents a 0.
However, in the exponential ROM, this value is immediately inverted, so a transistor represents a 1 bit in the final result. <a href="#fnref:polarity" title="Jump back to footnote 9 in the text">↩</a></p>
</li>
<li id="fn:row-elimination">
<p>The ROM operates in two phases, controlled by the clock. In the first phase, the rows and the multiplexers are all pulled high.
In the second phase, the desired ROM column is activated. If there are transistors, they will pull the rows low.
Through the selected multiplexer transistor, this will pull the multiplexer low.
The multiplexer output is then inverted, so a position with a transistor represents
a logical 1 and the absence of a transistor represents a logical 0.
With this circuit, if a row and multiplexer transistor are omitted entirely, the multiplexer will retain its high precharge value, which
represents a logical 0.
Thus, any rows in the ROM that are all 0 can be eliminated, saving space. <a href="#fnref:row-elimination" title="Jump back to footnote 10 in the text">↩</a></p>
</li>
<li id="fn:deltas">
<p>The schematic below shows the implementation of the logic to produce the absolute data and the deltas.
The 11 absolute data bits simply take the corresponding multiplexer
output and invert it. Each multiplexer also has a transistor to precharge it to +5 on the clock phase 1.
(The delta multiplexers also have precharge transistors, but I omitted them from the schematic to avoid clutter.)</p>
<p><a href="https://static.righto.com/images/dx7-exp/logic.jpg"><img alt="Diagram of the logic circuitry." height="742" src="https://static.righto.com/images/dx7-exp/logic-w320.jpg" title="Diagram of the logic circuitry." width="320"/></a></p><p>Diagram of the logic circuitry.</p>
<p>The delta bit logic implements four different cases. Entry 0 provides a delta value of 0 for the absolute value.
It is followed by three entries for the values stored as deltas.
(In all four cases, the value is computed by adding the absolute value and the delta.)
The two low-order address bits select the entry.
If the 9 bits from the ROM are labeled A-I, the successive 4-bit delta entries are 0000 (no delta for the &#34;absolute&#34; value), 00AB, 0CDE, FGHI.
Three entries use the top bit of the address (bit 9) to force a delta bit to 1 over half the range.
This is another optimization so those regions don&#39;t need to be stored in the ROM. <a href="#fnref:deltas" title="Jump back to footnote 11 in the text">↩</a></p>
</li>
<li id="fn:efficiency">
<p>The exponential circuit takes a 14-bit input and produces a 22-bit output.
Holding all these values in a ROM would take over 360 kilobits, impractical in the 1980s.
The use of a shifter dramatically reduced the storage requirement to 
1024 11-bit values (11 Kb).
The ROM compression techniques reduced this to just 4 kilobits, almost 64% less.
In this section I break down how the ROM compression is implemented.</p>
<p>The majority of the savings comes from the delta encoding, which uses 256 11-bit &#34;absolute&#34; values and 768 4-bit delta values.
This reduces the storage to about 5.9 Kb, saving about 48%.
The remainder of the savings comes from eliminating rows in the ROM through various techniques.
The ROM is structured as rows of 32 bits.
Uncompressed, the ROM would require 184 rows. 
However, if the values in a row are all 0, the row can be omitted entirely, due to the multiplexer&#39;s construction.<span id="fnref:1rows"><a href="#fn:1rows">13</a></span>
Since the exponential curve grows slowly, the top bits of the absolute value are 0 for large stretches, so many rows can be eliminated.
Specifically, the topmost bit is zero for 4 of 8 rows, the next bit zero for 3 of 8 rows, and the next bit zero for 1 row.
Thus, 8 rows can be eliminated for the absolute value storage.</p>
<p>The delta bits are also zero much of the time. The top two bits of the first delta are always 0, as is the top bit of the second delta.
This is handled by the logic circuitry, eliminating 24 rows of the ROM.
12 more zero rows are eliminated from delta bits that are zero some of the time.
Finally, the logic circuitry forces 3 delta bits to 1 over half-intervals where they are always 1, making 12 more rows unnecessary.</p>
<p>To summarize, zero-row-elimination saves 8 rows from absolute value data, and 36 rows from delta data.
Another 12 rows are saved by forcing bits to 1.
This reduces the ROM from potentially 188 rows to the 128 rows it has, shrinking it almost 32%. <a href="#fnref:efficiency" title="Jump back to footnote 12 in the text">↩</a></p>
</li>
<li id="fn:1rows">
<p>Conceptually, rows in the ROM can be considered NOR gates with pull-up resistors.
However, the implementation is slightly different: rows are precharged to +5 during one clock phase and then discharged (or not) to ground through
transistors. This reduces the power consumption compared to regular NMOS pull-ups. (Modern circuits use CMOS instead of NMOS to avoid the static
power consumption of pull-ups.)</p>
<p><a href="https://static.righto.com/images/dx7-exp/precharge.jpg"><img alt="The ROM with its precharge circuit. This is a bit tricky to interpret. The row lines are metal as is the ground line on the right.
The other ground lines and the precharge line are in silicon. The clock and the column select lines (unlabeled) are in polysilicon." height="218" src="https://static.righto.com/images/dx7-exp/precharge-w450.jpg" title="The ROM with its precharge circuit. This is a bit tricky to interpret. The row lines are metal as is the ground line on the right.
The other ground lines and the precharge line are in silicon. The clock and the column select lines (unlabeled) are in polysilicon." width="450"/></a></p><p>The ROM with its precharge circuit. This is a bit tricky to interpret. The row lines are metal as is the ground line on the right.
The other ground lines and the precharge line are in silicon. The clock and the column select lines (unlabeled) are in polysilicon.</p>
<p>Another optimization is that rows in the ROM that are all 1&#39;s have the transistors omitted and the output line connected directly to ground.
This reduces power consumption slightly, since that row line won&#39;t be charged and discharged. However, it doesn&#39;t save any space, since
the row is still physically present. (In contrast rows that are all 0&#39;s are omitted entirely.) <a href="#fnref:1rows" title="Jump back to footnote 13 in the text">↩</a></p>
</li>
<li id="fn:refs">
<p>For more information on the DX7 internals, see
<a href="https://ajxs.me/blog/Yamaha_DX7_Technical_Analysis.html">DX7 Technical Analysis</a>,
<a href="https://github.com/google/music-synthesizer-for-android/blob/master/wiki/Dx7Hardware.wiki">DX7 Hardware</a>,
<a href="https://docs.google.com/a/google.com/Doc?id=dd8kqn9f_13cqjkf4gp">OPLx decapsulated</a>,
and my previous DX7 article <a href="https://www.righto.com/2021/11/reverse-engineering-yamaha-dx7.html">Reverse-engineering the Yamaha DX7 synthesizer&#39;s sound chip from die photos</a>. <a href="#fnref:refs" title="Jump back to footnote 14 in the text">↩</a></p>
</li>
</ol>
</div>

</div></div>
  </body>
</html>
