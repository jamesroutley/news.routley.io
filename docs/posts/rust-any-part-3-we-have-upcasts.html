<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lucumr.pocoo.org/2025/3/27/any-upcast/">Original</a>
    <h1>Rust Any part 3: we have upcasts</h1>
    
    <div id="readability-page-1" class="page"><div>
        
  

  
  <p data-date="2025-03-27T00:00:00">written on Thursday, March 27, 2025</p>
  

  <p>Three years ago I shared the <a href="https://lucumr.pocoo.org/2022/1/7/as-any-hack/">As-Any Hack</a> on
this blog.  That hack is a way to get upcasting to supertraits working on
stable Rust.  To refresh your memory, the goal was to make something like
this work:</p>
<div><pre><span></span><span>#[derive(Debug)]</span><span></span>
<span>struct</span> <span>AnyBox</span><span>(</span><span>Box</span><span>&lt;</span><span>dyn</span><span> </span><span>DebugAny</span><span>&gt;</span><span>);</span><span></span>

<span>trait</span><span> </span><span>DebugAny</span>: <span>Any</span><span> </span><span>+</span><span> </span><span>Debug</span><span> </span><span>{}</span><span></span>

<span>impl</span><span>&lt;</span><span>T</span>: <span>Any</span><span> </span><span>+</span><span> </span><span>Debug</span><span> </span><span>+</span><span> </span><span>&#39;</span><span>static</span><span>&gt;</span><span> </span><span>DebugAny</span><span> </span><span>for</span><span> </span><span>T</span><span> </span><span>{}</span><span></span>
</pre></div>
<p>The problem? Even though <cite>DebugAny</cite> inherits from <cite>Any</cite>, Rust wouldn&#39;t let you
use methods from <cite>Any</cite> on a <cite>dyn DebugAny</cite>.  So while you could call
<cite>DebugAny</cite> methods just fine, trying to use <cite>downcast_ref</cite> from <cite>Any</cite> (the
reason to use Any in the first place) would fail:</p>
<div><pre><span></span><span>fn</span> <span>main</span><span>()</span><span> </span><span>{</span><span></span>
<span>    </span><span>let</span><span> </span><span>any_box</span><span> </span><span>=</span><span> </span><span>AnyBox</span><span>(</span><span>Box</span>::<span>new</span><span>(</span><span>42</span><span>i32</span><span>));</span><span></span>
<span>    </span><span>dbg!</span><span>(</span><span>any_box</span><span>.</span><span>0.</span><span>downcast_ref</span>::<span>&lt;</span><span>i32</span><span>&gt;</span><span>());</span><span>  </span><span>// Compile error</span>
<span>}</span><span></span>
</pre></div>
<p>The same would happen if we tried to cast it into an <cite>&amp;dyn Any</cite>?  A
compile error again:</p>
<div><pre><span></span><span>fn</span> <span>main</span><span>()</span><span> </span><span>{</span><span></span>
<span>    </span><span>let</span><span> </span><span>any_box</span><span> </span><span>=</span><span> </span><span>AnyBox</span><span>(</span><span>Box</span>::<span>new</span><span>(</span><span>42</span><span>i32</span><span>));</span><span></span>
<span>    </span><span>let</span><span> </span><span>any</span><span> </span><span>=</span><span> </span><span>&amp;*</span><span>any_box</span><span>.</span><span>0</span><span> </span><span>as</span><span> </span><span>&amp;</span><span>dyn</span><span> </span><span>Any</span><span>;</span><span></span>
<span>    </span><span>dbg!</span><span>(</span><span>any</span><span>.</span><span>downcast_ref</span>::<span>&lt;</span><span>i32</span><span>&gt;</span><span>());</span><span></span>
<span>}</span><span></span>
</pre></div>
<p>But there is good news!  As of Rust 1.86, this is finally fixed. The cast
now works:</p>
<pre>[src/main.rs:14:5] any.downcast_ref::&lt;i32&gt;() = Some(
    42,
)
</pre>
<p>At the time of writing, this fix is in the beta channel, but stable
release is just around the corner.  That means a lot of old hacks can
finally be retired.  At least once your MSRV moves up.</p>
<p>Thank you so much to everyone who <a href="https://github.com/rust-lang/rust/issues/65991">worked on this</a> to make it work!</p>


  
  <p>This entry was tagged
    
      <a href="https://lucumr.pocoo.org/tags/rust/">rust</a>
  

      </p></div></div>
  </body>
</html>
