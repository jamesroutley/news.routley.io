<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ntietz.com/blog/til-enabling-features-on-transitive-dependencies-rust/">Original</a>
    <h1>TIL: enabling features on transitive dependencies (Rust)</h1>
    
    <div id="readability-page-1" class="page"><div>
  

  <p><strong>Saturday, January  6, 2024</strong></p>

  <div><p>While pairing on a small Rust program with <a href="https://erikarow.land/">a friend</a>, I ran into a problem: to compile to WASM, one of my dependencies needed one of <em>its</em> dependencies to turn on a feature.
A variation of this that I&#39;ve run into in other projects is where a transitive dependency has a bug/CVE and I want to upgrade it.
So what do you do if a transitive dependency is giving you grief?</p>

<p>I ended up finding that if you add the package as a direct dependency, you can specify the features and then this will be used transitively as well.
So I added the transitive dependency with its feature enabled, and compilation worked.</p>
<pre><code>[dependencies.getrandom]
version = &#34;*&#34;
features = [&#34;js&#34;]
</code></pre>
<p>I initially added it with <em>no</em> version specifier so that it would never conflict with the transitive version, and just pick that one.
This behavior is deprecated, but we can do it with just specifying <code>*</code> as the version, so all is good.</p>
<p>What I don&#39;t love here is that now I have another dependency to keep track of.
If my transitive dependency (twice removed) ever removes <code>getrandom</code>, then I&#39;m still stuck with it unless I notice that it&#39;s not depended on anymore!
It would be a lot nicer to have something where we can specify the features, but fortunately we can lint for unused dependencies using <a href="https://github.com/est31/cargo-udeps">cargo-udeps</a>.</p>

<p>Here are a few other things I tried that didn&#39;t work.</p>
<p><strong>Patching the dependency.</strong>
I tried using the <a href="https://doc.rust-lang.org/cargo/reference/overriding-dependencies.html#the-patch-section">patch</a> section of my <code>Cargo.toml</code> to specify the version and features that would work for WASM.
Unfortunately, I got this error:</p>
<pre><code>`cargo metadata` exited with an error: warning: patch for `getrandom` uses the features mechanism. default-features and features will not take effect because the patch dependency does not support this mechanism
[...]

Caused by:
  patch for `getrandom` in `https://github.com/rust-lang/crates.io-index` points to the same source, but patches must point to different sources
</code></pre>
<p>So two issues with using patch for this, one is that it just plain doesn&#39;t support this mechanism, so it won&#39;t work for features.
And for version upgrades, no dice either, because you can&#39;t patch to a different version in the same registry.
I don&#39;t get why this is the case, and if I&#39;m missing something, I&#39;d love to update this post to reflect a way to do it here.</p>
<p><strong>Enabling the feature on the direct dependency.</strong>
The crate I depend on did not actually expect to be compiled to WASM, but <em>does</em> work if this one feature is enabled.
So this doesn&#39;t work, because it wasn&#39;t expected!</p>
<hr/>

</div>

  


  <hr/>
  <p>
    If this post was enjoyable or useful for you, <strong>please share it!</strong>
    If you have comments, questions, or feedback, you can email <a href="mailto:me@ntietz.com">my personal email</a>.
    To get new posts, subscribe to the <a href="https://ntietz.com/newsletter">newsletter</a> or use the <a href="https://ntietz.com/atom.xml">RSS feed</a>.
  </p>
  <p>
  <i></i> Want to become a better programmer?
  <a href="https://www.recurse.com/scout/click?t=c9a1a9e2e7a2ffefd4af20020b4af1e6">Join the Recurse Center!</a>
</p>


</div></div>
  </body>
</html>
