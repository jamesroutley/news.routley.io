<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.davidreis.me/2024/what-happens-when-you-make-a-move-in-lichess">Original</a>
    <h1>What happens when you make a move in lichess.org?</h1>
    
    <div id="readability-page-1" class="page"><article><p><span><span><span><a href="https://twitter.com/dreis_sw" target="_blank">@dreis_sw</a></span><span>|</span></span><span>September 23, 2024<!-- --> <span>(<!-- -->1m<!-- --> ago)</span></span></span><span><!--$--><!--/$--></span></p>
<p>Have you ever wondered what goes on behind the scenes every time you make a move in your favorite online chess platform?</p>
<p>Lichess.org is a popular, free, and open-source chess platform that attracts millions of players worldwide. Its seamless, real-time gameplay experience must be powered by a robust backend infrastructure. In this post, we&#39;ll peek behind the curtain and explore the technical processes involved when you play a move.</p>

<p>To understand the flow of data when making a move, we&#39;ll start by utilizing Chrome DevTools, particularly the <strong>Network</strong> tab, which allows us to monitor communication between the client (your browser) and the server.</p>
<h2>WebSocket Connections</h2>
<p>The first notable network activity is a WebSocket connection to a URL similar to:</p>
<div><pre><code><code>wss://socket2.lichess.org/play/H5uHz0egyvIA/v6?sri=bt6QzcyOiZg5&amp;v=0
</code></code></pre></div>
<p>The protocol, <strong><code>wss</code></strong>, indicates an encrypted websockets connection using TLS.</p>
<p>No surprises here, WebSockets are the obvious choice for real-time browser apps like online chess because they allow for full-duplex communication, enabling instant updates between the client and server without the overhead of repeated HTTP requests.</p>
<p>A few notable parameters in the URL:</p>
<ul>
<li><strong><code>H5uHz0egyvIA</code></strong>: The unique game ID. This ID is used to identify the game that we&#39;re connecting to.</li>
<li><strong><code>v</code></strong>: An incrementing counter representing the game&#39;s version from the client&#39;s perspective. More on this later.</li>
<li><strong><code>sri</code></strong>: A randomly generated string on each page load, possibly for session tracking or security purposes.</li>
</ul>
<p>Let&#39;s observe the network activity when we make a move.</p>
<h2>Local Player&#39;s Turn</h2>
<p>When we make a move, several packets of data are exchanged. Here&#39;s the first packet, sent by us:</p>
<div><pre><code><code>
<span>{</span> 
  <span>&#34;t&#34;</span><span>:</span> <span>&#34;move&#34;</span><span>,</span>
  <span>&#34;d&#34;</span><span>:</span> <span>{</span>
    <span>&#34;u&#34;</span><span>:</span> <span>&#34;d2d4&#34;</span><span>,</span>
    <span>&#34;l&#34;</span><span>:</span> <span>32</span><span>,</span>
    <span>&#34;a&#34;</span><span>:</span> <span>1</span>
  <span>}</span>
<span>}</span>
</code></code></pre></div>
<p>Clear enough, right? Let&#39;s break it down:</p>
<ul>
<li><strong><code>t</code>: &#34;move&#34;</strong>: Indicates the type of message.</li>
<li><strong><code>d</code></strong>: Data payload containing:<!-- -->
<ul>
<li><strong><code>u</code></strong>: The move in UCI<a href="#f1" id="s1">[<!-- -->1<!-- -->]</a> format.</li>
<li><strong><code>l</code></strong>: Probably some length?</li>
<li><strong><code>a</code></strong>: Acknowledgment counter to track message acknowledgments.</li>
</ul>
</li>
</ul>
<p>We then receive the following message:</p>

<p>This message from the server acknowledges that it has received our move. Notice that the <code>d</code> field contains the same acknowledgment counter we sent in our move message, in this case, <code>1</code>.</p>
<p>Right after, we receive the following message:</p>
<div><pre><code><code>
<span>{</span>
  <span>&#34;t&#34;</span><span>:</span> <span>&#34;move&#34;</span><span>,</span>
  <span>&#34;v&#34;</span><span>:</span> <span>1</span><span>,</span>
  <span>&#34;d&#34;</span><span>:</span> <span>{</span>
    <span>&#34;uci&#34;</span><span>:</span> <span>&#34;d2d4&#34;</span><span>,</span>
    <span>&#34;san&#34;</span><span>:</span> <span>&#34;d4&#34;</span><span>,</span>
    <span>&#34;fen&#34;</span><span>:</span> <span>&#34;rnbqkbnr/pppppppp/8/8/3P4/8/PPP1PPPP/RNBQKBNR&#34;</span><span>,</span>
    <span>&#34;ply&#34;</span><span>:</span> <span>1</span><span>,</span>
    <span>&#34;clock&#34;</span><span>:</span> <span>{</span>
      <span>&#34;white&#34;</span><span>:</span> <span>300</span><span>,</span>
      <span>&#34;black&#34;</span><span>:</span> <span>300</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></code></pre></div>
<p>This message provides details about the move we just made and the updated game state.</p>
<ul>
<li><strong><code>uci</code></strong>: Move in UCI<a href="#f1" id="s1">[<!-- -->1<!-- -->]</a> format.</li>
<li><strong><code>san</code></strong>: Move in SAN<a href="#f2" id="s2">[<!-- -->2<!-- -->]</a> format.</li>
<li><strong><code>fen</code></strong>: FEN<a href="#f3" id="s3">[<!-- -->3<!-- -->]</a> string representing the current state of the game.</li>
<li><strong><code>ply</code></strong>: Number of half-moves made in the game.</li>
<li><strong><code>clock</code></strong>: Remaining time for each player. Since the game just started, both players have 300 seconds.</li>
</ul>
<p>In summary, when a move is made, the client sends a move message, receives an acknowledgment, and then receives a detailed update about the move and the game&#39;s new state.</p>
<h2>Opponent&#39;s Turn</h2>
<p>When the opponent makes a move, we receive a similar packet from the server.</p>
<div><pre><code><code>
<span>{</span>
  <span>&#34;t&#34;</span><span>:</span> <span>&#34;move&#34;</span><span>,</span>
  <span>&#34;v&#34;</span><span>:</span> <span>2</span><span>,</span>
  <span>&#34;d&#34;</span><span>:</span> <span>{</span>
    <span>&#34;uci&#34;</span><span>:</span> <span>&#34;d7d5&#34;</span><span>,</span>
    <span>&#34;san&#34;</span><span>:</span> <span>&#34;d5&#34;</span><span>,</span>
    <span>&#34;fen&#34;</span><span>:</span> <span>&#34;rnbqkbnr/ppp1pppp/8/3p4/3P4/8/PPP1PPPP/RNBQKBNR&#34;</span><span>,</span>
    <span>&#34;ply&#34;</span><span>:</span> <span>2</span><span>,</span>
    <span>&#34;dests&#34;</span><span>:</span> <span>{</span>
      <span>&#34;c2&#34;</span><span>:</span> <span>&#34;c3c4&#34;</span><span>,</span>
      <span>&#34;g2&#34;</span><span>:</span> <span>&#34;g3g4&#34;</span>
      
    <span>}</span><span>,</span>
    <span>&#34;clock&#34;</span><span>:</span> <span>{</span>
      <span>&#34;white&#34;</span><span>:</span> <span>300</span><span>,</span>
      <span>&#34;black&#34;</span><span>:</span> <span>300</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></code></pre></div>
<p>One key difference is the <code>dests</code> parameter, which lists all possible moves available from the current position. This parameter is used to highlight the possible moves on the chessboard that we can make after our opponent&#39;s move.</p>
<p>While these moves could be calculated client-side, providing them server-side ensures consistency - especially for complex or esoteric chess variants - and optimizes performance on clients with limited processing capabilities or energy restrictions.</p>
<p>Now that we&#39;ve analysed the network activity, let&#39;s look into the backend architecture that powers these real-time interactions.</p>

<p>Lichess&#39;s real-time playing system is primarily composed of two main services (both written in Scala):</p>
<ol>
<li><strong><code>lila</code></strong>: Core service that manages game logic, state, user interactions, and other fundamental functionalities. Without it, the lichess.org website would be unable to function.</li>
<li><strong><code>lila-ws</code></strong>: Specialized service responsible for handling WebSocket connections, acting as a bridge between the client and <code>lila</code>. This service knows as little as possible about chess.</li>
</ol>
<h2>Architecture Overview</h2>
<p>From the <code>lila-ws</code> readme:</p>
<div><pre><code><code>lila &lt;-&gt; redis &lt;-&gt; lila-ws &lt;-&gt; websocket &lt;-&gt; client
</code></code></pre></div>
<p>As this implies, <code>lila</code> communicates with <code>lila-ws</code> through Redis, which in turn manages WebSocket connections with clients.</p>
<p>If <code>lila</code> is momentarily down, <code>lila-ws</code> can still handle WebSocket connections and maintain real-time communication with clients (perhaps features like chat would still work!). Conversely, if <code>lila-ws</code> is down, the lichess.org website will still be online, but you won&#39;t be able to play games.</p>
<p>This separation also allows for independent scaling of the two components.</p>
<h2>Communication using Redis Pub/Sub</h2>
<p>The move event is published to a <a target="_blank" href="https://redis.io/docs/latest/develop/interact/pubsub/">Redis Pub/Sub</a> channel, to which <code>lila</code> is subscribed and processes the move.</p>
<p>Redis Pub/Sub offers <em><strong>at-most-once</strong></em> delivery. This means that each message is delivered no more than once to each subscriber, if at all. If a subscriber fails while processing a message, that message is lost and not re-delivered. This has the benefit that once a message is delivered, it can be removed from Redis, reducing memory usage. However, it also means that message loss is possible.</p>
<p><a target="_blank" href="https://redis.io/docs/latest/develop/data-types/streams/">Redis Streams</a> could be used to provide <em><strong>at-least-once</strong></em> delivery, ensuring that messages are not lost even if a subscriber fails. However, this would increase memory usage and complexity.</p>
<h2>Eventual Data Persistence with MongoDB</h2>
<p>While <code>lila</code> primarily stores game states in MongoDB, it optimizes database load by <strong>not saving every single move immediately</strong>. Instead, it buffers progress by accumulating moves and periodically saving them unless a significant event occurs, such as a game conclusion. This strategy lightens the load on the database while maintaining data integrity.</p>
<div><pre><code><code><span><span>def</span> <span>save</span></span>(progress: <span>Progress</span>): <span>Funit</span> =
  
  set(progress.game)
  
  
  dirtyProgress = dirtyProgress.fold(progress.dropEvents)(_.withGame(progress.game)).some
  
  
  <span>if</span> shouldFlushProgress(progress) <span>then</span> flushProgress() 
  
  
  <span>else</span> fuccess(scheduleFlushProgress())
</code></code></pre></div>
<h2>Joining a Game In Progress</h2>
<p>As mentioned earlier, when a player connects, they provide the <code>v</code> parameter, which tells the system the latest version of the game they know about. Since the game state in MongoDB syncs up eventually (and your opponent might move just as you join), a player might initially get a state that&#39;s a bit behind the latest action.</p>
<p>To handle this, <code>lila-ws</code> uses a trusty <code>java.util.concurrent.ConcurrentHashMap</code>:</p>
<ul>
<li><strong>Key</strong>: Game ID.</li>
<li><strong>Value</strong>: List of ordered and versioned events for that game.</li>
</ul>
<p>This setup keeps track of all events for any ongoing game and clears them once the game wraps up. It helps players reconnect to an active game by giving them all the events they need from point <code>v</code> onwards, without missing any or doubling up. Understandably, it has to be a concurrency-safe data structure, since multiple threads can be serving multiple players at the same time.</p>

<p>We are now ready to sum up the process of making a move in Lichess:</p>
<ol>
<li>
<span><strong>Client Connection</strong></span>
<p>The client establishes a WebSocket connection to <code>lila-ws</code> at a URL like <code>wss://socket2.lichess.org/play/...</code>.</p>
</li>
<li>
<span><strong>Sending a Move</strong></span>
<p>When a player makes a move, the client sends a move event to <code>lila-ws</code> with details like the move&#39;s UCI string and acknowledgment counter.</p>
</li>
<li>
<span><strong>Acknowledgment</strong></span>
<p><code>lila-ws</code> responds with an acknowledgment (<code>ack</code>) to confirm that the move has been received.</p>
</li>
<li>
<span><strong>Publishing to Redis</strong></span>
<p>The move event is published to a Redis Pub/Sub channel, to which <code>lila</code> is listening and processes the move.</p>
</li>
<li>
<span><strong>Updating Game State</strong></span>
<p><code>lila</code> receives the move, updates the game state accordingly, and (eventually) stores it in a MongoDB database. An updated game state is then sent back through <code>lila-ws</code> to the client.</p>
</li>
<li>
<span><strong>Client Receives Update</strong></span>
<p>The client receives the updated game state, reflecting the new move and any changes in the game&#39;s status.</p>
</li>
</ol>

<p><em>Thank you for reading! If you have any questions or further insights, feel free to reach out.</em></p>
<div><p>1<!-- -->.<!-- --> <a href="#s1" id="f1">^</a> <strong>UCI (Universal Chess Interface)</strong>: A standard format for encoding chess moves, useful for computer processing. <a target="_blank" href="https://en.wikipedia.org/wiki/Universal_Chess_Interface">Learn more</a>.</p><p>2<!-- -->.<!-- --> <a href="#s2" id="f2">^</a> <strong>SAN (Standard Algebraic Notation)</strong>: A human-readable format for chess moves. Compared to UCI, this move requires chess knowledge, since it doesn&#39;t specify the piece moved. <a target="_blank" href="https://en.wikipedia.org/wiki/Algebraic_notation_(chess)">Learn more</a>.</p><p>3<!-- -->.<!-- --> <a href="#s3" id="f3">^</a> <strong>FEN (Forsyth-Edwards Notation)</strong>: Encodes the entire game state, including piece positions, turn order, castling rights, and more. <a target="_blank" href="https://en.wikipedia.org/wiki/Forsyth%E2%80%93Edwards_Notation">Learn more</a>.</p></div></article></div>
  </body>
</html>
