<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://fedify.dev/tutorial/microblog">Original</a>
    <h1>Creating your own federated microblog</h1>
    
    <div id="readability-page-1" class="page"><div data-v-e6f2a212=""><div data-v-e6f2a212=""><!--[--><!--]--><main data-v-e6f2a212=""><div data-v-e6f2a212=""><div><div><p>TIP</p><p>This tutorial is also available in the following languages: <a href="https://hackmd.io/@hongminhee/fedify-tutorial-ko" target="_blank" rel="noreferrer">한국어</a> (Korean) and <a href="https://zenn.dev/hongminhee/books/4a38b6358a027b" target="_blank" rel="noreferrer">日本語</a> (Japanese).</p></div><p>In this tutorial, we will build a small <a href="https://en.wikipedia.org/wiki/Microblogging" target="_blank" rel="noreferrer">microblog</a> that implements the ActivityPub protocol, similar to <a href="https://joinmastodon.org/" target="_blank" rel="noreferrer">Mastodon</a> or <a href="https://misskey-hub.net/" target="_blank" rel="noreferrer">Misskey</a>, using <a href="https://fedify.dev/" target="_blank" rel="noreferrer">Fedify</a>, an ActivityPub server framework. This tutorial will focus more on how to use Fedify rather than understanding its underlying operating principles.</p><p>If you have any questions, suggestions, or feedback, please feel free to join our <a href="https://matrix.to/#/#fedify:matrix.org" target="_blank" rel="noreferrer">Matrix chat space</a> or <a href="https://discord.gg/bhtwpzURwd" target="_blank" rel="noreferrer">Discord server</a> or <a href="https://github.com/fedify-dev/fedify/discussions" target="_blank" rel="noreferrer">GitHub Discussions</a>.</p><h2 id="target-audience" tabindex="-1">Target audience <a href="#target-audience" aria-label="Permalink to &#34;Target audience&#34;">​</a></h2><p>This tutorial is aimed at those who want to learn Fedify and create ActivityPub server software.</p><p>We assume that you have experience in creating web applications using HTML and HTTP, and that you understand command-line interfaces, SQL, JSON, and basic JavaScript. However, you don&#39;t need to know TypeScript, <abbr title="JavaScript XML">JSX</abbr>, ActivityPub, or Fedify—we&#39;ll teach you what you need to know about these as we go along.</p><p>You don&#39;t need experience in creating ActivityPub software, but we do assume that you&#39;ve used at least one ActivityPub software like Mastodon or Misskey. This is so you have an idea of what we&#39;re trying to build.</p><h2 id="goals" tabindex="-1">Goals <a href="#goals" aria-label="Permalink to &#34;Goals&#34;">​</a></h2><p>In this tutorial, we&#39;ll use Fedify to create a single-user microblog that can communicate with other federated software and services via ActivityPub. This software will include the following features:</p><ul><li>Only one account can be created.</li><li>Other accounts in the fediverse can follow the user.</li><li>Followers can unfollow the user.</li><li>The user can view their list of followers.</li><li>The user can create posts.</li><li>The user&#39;s posts are visible to followers in the fediverse.</li><li>The user can follow other accounts in the fediverse.</li><li>The user can view a list of accounts they are following.</li><li>The user can view a chronological list of posts from accounts they follow.</li></ul><p>To simplify the tutorial, we&#39;ll impose the following feature constraints:</p><ul><li>Account profiles (bio, photos, etc.) cannot be set.</li><li>Once created, an account cannot be deleted.</li><li>Once posted, a post cannot be edited or deleted.</li><li>Once followed, another account cannot be unfollowed.</li><li>There are no likes, shares, or comments.</li><li>There is no search functionality.</li><li>There are no security features such as authentication or permission checks.</li></ul><p>Of course, after completing the tutorial, you&#39;re welcome to add these features—it would be good practice!</p><p>The complete source code is available in the <a href="https://github.com/fedify-dev/microblog" target="_blank" rel="noreferrer">GitHub repository</a>, with commits separated according to each implementation step for your reference.</p><h2 id="setting-up-the-development-environment" tabindex="-1">Setting up the development environment <a href="#setting-up-the-development-environment" aria-label="Permalink to &#34;Setting up the development environment&#34;">​</a></h2><h3 id="installing-node-js" tabindex="-1">Installing Node.js <a href="#installing-node-js" aria-label="Permalink to &#34;Installing Node.js&#34;">​</a></h3><p>Fedify supports three JavaScript runtimes: <a href="https://deno.com/" target="_blank" rel="noreferrer">Deno</a>, <a href="https://bun.sh/" target="_blank" rel="noreferrer">Bun</a>, and <a href="https://nodejs.org/" target="_blank" rel="noreferrer">Node.js</a>. Among these, Node.js is the most widely used, so we&#39;ll use Node.js as the basis for this tutorial.</p><div><p>TIP</p><p>A JavaScript runtime is a platform that executes JavaScript code. Web browsers are one type of JavaScript runtime, and for command-line or server use, Node.js is widely used. Recently, cloud edge functions like <a href="https://workers.cloudflare.com/" target="_blank" rel="noreferrer">Cloudflare Workers</a> have also gained popularity as JavaScript runtimes.</p></div><p>To use Fedify, you need Node.js version 20.0.0 or higher. There are <a href="https://nodejs.org/en/download/package-manager" target="_blank" rel="noreferrer">various installation methods</a>—choose the one that suits you best.</p><p>Once Node.js is installed, you&#39;ll have access to the <code>node</code> and <code>npm</code> commands:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>node</span><span> --version</span></span>
<span><span>npm</span><span> --version</span></span></code></pre></div><h3 id="installing-the-fedify-command" tabindex="-1">Installing the <code>fedify</code> command <a href="#installing-the-fedify-command" aria-label="Permalink to &#34;Installing the `fedify` command&#34;">​</a></h3><p>To set up a Fedify project, you need to install the <a href="https://ntietz.com/blog/cli"><code>fedify</code></a> command on your system. There are <a href="https://ntietz.com/blog/cli#installation">several installation methods</a>, but using the <code>npm</code> command is the simplest:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>npm</span><span> install</span><span> -g</span><span> @fedify/cli</span></span></code></pre></div><p>After installation, check if you can use the <code>fedify</code> command. You can check the version of the <code>fedify</code> command with this command:</p><p>Make sure the version number is 1.0.0 or higher. If it&#39;s an older version, you won&#39;t be able to properly follow this tutorial.</p><h3 id="fedify-init-to-initialize-the-project" tabindex="-1"><code>fedify init</code> to initialize the project <a href="#fedify-init-to-initialize-the-project" aria-label="Permalink to &#34;`fedify init` to initialize the project&#34;">​</a></h3><p>To start a new Fedify project, let&#39;s decide on a directory path to work in. In this tutorial, we&#39;ll name it <em>microblog</em>. Run the <a href="https://ntietz.com/blog/cli#fedify-init-initializing-a-fedify-project"><code>fedify init</code></a> command followed by the directory path (it&#39;s okay if the directory doesn&#39;t exist yet):</p><p>When you run the <code>fedify init</code> command, you&#39;ll see a series of prompts. Select <em>Node.js</em>, <em>npm</em>, <em>Hono</em>, <em>In-memory</em>, and <em>In-process</em> in order:</p><div><p><span>console</span></p><pre tabindex="0"><code><span><span>             ___      _____        _ _  __</span></span>
<span><span>            /&#39;_&#39;)    |  ___|__  __| (_)/ _|_   _</span></span>
<span><span>     .-^^^-/  /      | |_ / _ \/ _` | | |_| | | |</span></span>
<span><span>   __/       /       |  _|  __/ (_| | |  _| |_| |</span></span>
<span><span>  &lt;__.|_|-|_|        |_|  \___|\__,_|_|_|  \__, |</span></span>
<span><span>                                           |___/</span></span>
<span></span>
<span><span>? Choose the JavaScript runtime to use</span></span>
<span><span>  Deno</span></span>
<span><span>  Bun</span></span>
<span><span>❯ Node.js</span></span>
<span></span>
<span><span>? Choose the package manager to use</span></span>
<span><span>❯ npm</span></span>
<span><span>  Yarn</span></span>
<span><span>  pnpm</span></span>
<span></span>
<span><span>? Choose the web framework to integrate Fedify with</span></span>
<span><span>  Bare-bones</span></span>
<span><span>  Fresh</span></span>
<span><span>❯ Hono</span></span>
<span><span>  Express</span></span>
<span><span>  Nitro</span></span>
<span></span>
<span><span>? Choose the key-value store to use for caching</span></span>
<span><span>❯ In-memory</span></span>
<span><span>  Redis</span></span>
<span><span>  PostgreSQL</span></span>
<span><span>  Deno KV</span></span>
<span></span>
<span><span>? Choose the message queue to use for background jobs</span></span>
<span><span>❯ In-process</span></span>
<span><span>  Redis</span></span>
<span><span>  PostgreSQL</span></span>
<span><span>  AMQP (e.g., RabbitMQ)</span></span>
<span><span>  Deno KV</span></span></code></pre></div><div><p>NOTE</p><p>Fedify is not a full-stack framework, but rather a framework specialized for implementing ActivityPub servers. Therefore, it&#39;s designed to be used alongside other web frameworks. In this tutorial, we&#39;ll adopt <a href="https://hono.dev/" target="_blank" rel="noreferrer">Hono</a> as our web framework to use with Fedify.</p></div><p>After a moment, you&#39;ll see files created in your working directory with the following structure:</p><ul><li><em>.vscode/</em> — Visual Studio Code related settings <ul><li><em>extensions.json</em> — Recommended extensions for Visual Studio Code</li><li><em>settings.json</em> — Visual Studio Code settings</li></ul></li><li><em>node_modules/</em> — Directory where dependent packages are installed (contents omitted)</li><li><em>src/</em> — Source code <ul><li><em>app.tsx</em> — Server unrelated to ActivityPub</li><li><em>federation.ts</em> — ActivityPub server</li><li><em>index.ts</em> — Entry point</li><li><em>logging.ts</em> — Logging configuration</li></ul></li><li><em>biome.json</em> — Formatter and linter settings</li><li><em>package.json</em> — Package metadata</li><li><em>tsconfig.json</em> — TypeScript settings</li></ul><p>As you might guess, we&#39;re using TypeScript instead of JavaScript, which is why we have <em>.ts</em> and <em>.tsx</em> files instead of <em>.js</em> files.</p><p>The generated source code is a working demo. Let&#39;s first check if it runs properly:</p><p>This command will keep the server running until you press <kbd>Ctrl</kbd>+<kbd>C</kbd>:</p><div><p><span>console</span></p><pre tabindex="0"><code><span><span>Server started at http://0.0.0.0:8000</span></span></code></pre></div><p>With the server running, open a new terminal tab and run the following command:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>fedify</span><span> lookup</span><span> http://localhost:8000/users/john</span></span></code></pre></div><p>This command queries an actor (actor) on the ActivityPub server we&#39;ve set up locally. In ActivityPub, an actor can be thought of as an account that&#39;s accessible across various ActivityPub servers.</p><p>If you see output like this, it&#39;s working correctly:</p><div><p><span>console</span></p><pre tabindex="0"><code><span><span>✔ Looking up the object...</span></span>
<span><span>Person {</span></span>
<span><span>  id: URL &#34;http://localhost:8000/users/john&#34;,</span></span>
<span><span>  name: &#34;john&#34;,</span></span>
<span><span>  preferredUsername: &#34;john&#34;</span></span>
<span><span>}</span></span></code></pre></div><p>This result tells us that there&#39;s an actor object located at the <em>/users/john</em> path, it&#39;s of type <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Person"><code>Person</code></a>, its ID is <em><a href="http://localhost:8000/users/john" target="_blank" rel="noreferrer">http://localhost:8000/users/john</a></em>, its name is <em>john</em>, and its username is also <em>john</em>.</p><div><p>TIP</p><p><a href="https://ntietz.com/blog/cli#fedify-lookup-looking-up-an-activitypub-object"><code>fedify lookup</code></a> is a command to query ActivityPub objects. This is equivalent to searching with the corresponding URI on Mastodon. (Of course, since your server is only accessible locally at the moment, searching on Mastodon won&#39;t yield any results yet.)</p><p>If you prefer <code>curl</code> over the <code>fedify lookup</code> command, you can also query the actor with this command (note that we&#39;re sending the <code>Accept</code> header with the <code>-H</code> option):</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>curl</span><span> -H</span><span>&#34;Accept: application/activity+json&#34;</span><span> http://localhost:8000/users/john</span></span></code></pre></div><p>However, if you query like this, the result will be in JSON format, which is difficult to read with the naked eye. If you also have the <code>jq</code> command installed on your system, you can use <code>curl</code> and <code>jq</code> together:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>curl</span><span> -H</span><span>&#34;Accept: application/activity+json&#34;</span><span> http://localhost:8000/users/john</span><span> |</span><span> jq</span><span> .</span></span></code></pre></div></div><h3 id="visual-studio-code" tabindex="-1">Visual Studio Code <a href="#visual-studio-code" aria-label="Permalink to &#34;Visual Studio Code&#34;">​</a></h3><p><a href="https://code.visualstudio.com/" target="_blank" rel="noreferrer">Visual Studio Code</a> might not be your favorite editor. However, we recommend using Visual Studio Code while following this tutorial. This is because we need to use TypeScript, and Visual Studio Code is currently the most convenient and excellent TypeScript IDE. Also, the generated project setup already includes Visual Studio Code settings, so you don&#39;t have to wrestle with formatters or linters.</p><div><p>WARNING</p><p>Don&#39;t confuse this with Visual Studio. Visual Studio Code and Visual Studio only share a brand name; they are completely different software.</p></div><p>After <a href="https://code.visualstudio.com/docs/setup/setup-overview" target="_blank" rel="noreferrer">installing Visual Studio Code</a>, open the working directory by selecting <em>File</em> → <em>Open Folder…</em> from the menu.</p><p>If you see a popup in the bottom right asking <q>Do you want to install the recommended &#39;Biome&#39; extension from biomejs for this repository?</q>, click the <em>Install</em> button to install the extension. Installing this extension will automatically format your TypeScript code, so you don&#39;t have to wrestle with code styles like indentation or spacing when writing TypeScript code.</p><div><p>TIP</p><p>If you&#39;re a loyal Emacs or Vim user, we won&#39;t discourage you from using your favorite editor. However, we recommend setting up TypeScript <abbr title="Language Server Protocol">LSP</abbr>. The difference in productivity depending on whether TypeScript <abbr title="Language Server Protocol">LSP</abbr> is set up or not is significant.</p></div><h2 id="prerequisites" tabindex="-1">Prerequisites <a href="#prerequisites" aria-label="Permalink to &#34;Prerequisites&#34;">​</a></h2><h3 id="typescript" tabindex="-1">TypeScript <a href="#typescript" aria-label="Permalink to &#34;TypeScript&#34;">​</a></h3><p>Before we start modifying code, let&#39;s briefly go over TypeScript. If you&#39;re already familiar with TypeScript, you can skip this section.</p><p>TypeScript adds static type checking to JavaScript. The TypeScript syntax is almost the same as JavaScript, but the main difference is that you can specify types for variables and functions. Types are specified by adding a colon (<code>:</code>) after the variable or parameter.</p><p>For example, the following code indicates that the <code>foo</code> variable is a <code>string</code>:</p><p>If you try to assign a value of a different type to a variable declared like this, Visual Studio Code will show a red underline <em>before you even run it</em> and display a type error:</p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span><span>foo</span></span><span> </span><span>=</span><span> 123</span><span>;</span></span><p>Type &#39;number&#39; is not assignable to type &#39;string&#39;.</p></code></pre></div><p>When coding, don&#39;t ignore red underlines. If you ignore them and run the program, it&#39;s likely that an error will actually occur at that part.</p><p>The most common type of error you&#39;ll encounter when coding in TypeScript is the <code>null</code> possibility error. For example, in the following code, the <code>bar</code> variable can be either a <code>string</code> or <code>null</code> (<code>string | null</code>):</p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>const</span><span> </span><span></span><span>:</span><span> string</span><span> |</span><span> null</span><span> =</span><span> </span><span></span><span>();</span></span></code></pre></div><p>What happens if you try to get the first character of this variable&#39;s content like this?</p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>const</span><span> </span><span></span><span> =</span><span> </span><span><span>bar</span></span><span>.</span><span></span><span>(</span><span>0</span><span>);</span></span><p>&#39;bar&#39; is possibly &#39;null&#39;.</p></code></pre></div><p>You&#39;ll get a type error like above. It&#39;s saying that <code>bar</code> might sometimes be <code>null</code>, and in that case, calling <code>null.charAt(0)</code> would cause an error, so you need to fix the code. In such cases, you need to add handling for the <code>null</code> case like this:</p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>const</span><span> </span><span></span><span> =</span><span> </span><span></span><span> </span><span>===</span><span> null</span><span> ?</span><span> &#34;&#34;</span><span> :</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>0</span><span>);</span></span></code></pre></div><p>In this way, TypeScript helps prevent bugs by making you think of cases you might not have considered when coding.</p><p>Another incidental advantage of TypeScript is that it enables auto-completion. For example, if you type <code>foo.</code>, a list of methods available for string objects will appear, allowing you to choose from them. This allows for faster coding without having to check documentation each time.</p><p>We hope you&#39;ll feel the charm of TypeScript as you follow this tutorial. Above all, Fedify provides the best experience when used with TypeScript.</p><div><p>TIP</p><p>If you want to learn TypeScript properly and thoroughly, we recommend reading <em><a href="https://www.typescriptlang.org/docs/handbook/intro.html" target="_blank" rel="noreferrer">The TypeScript Handbook</a></em>. It takes about 30 minutes to read it all.</p></div><h3 id="jsx" tabindex="-1"><abbr title="JavaScript XML">JSX</abbr> <a href="#jsx" aria-label="Permalink to &#34;JSX&#34;">​</a></h3><p><abbr title="JavaScript XML">JSX</abbr> is a syntax extension of JavaScript that allows you to insert XML or HTML into JavaScript code. It can also be used in TypeScript, in which case it&#39;s sometimes called TSX. In this tutorial, we&#39;ll write all HTML within JavaScript code using <abbr title="JavaScript XML">JSX</abbr> syntax. Those who are already familiar with <abbr title="JavaScript XML">JSX</abbr> can skip this section.</p><p>For example, the following code assigns an HTML tree with a <code>&lt;div&gt;</code> element at the top to the <code>html</code> variable:</p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span>const</span><span> </span><span></span><span> =</span><span> &lt;</span><span></span><span>&gt;</span></span>
<span><span>  &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;greet&#34;</span><span>&gt;Hello, &lt;</span><span></span><span>&gt;JSX&lt;/</span><span></span><span>&gt;!&lt;/</span><span></span><span>&gt;</span></span>
<span><span>&lt;/</span><span></span><span>&gt;;</span></span></code></pre></div><p>You can also insert JavaScript expressions using curly braces (the following code assumes, of course, that there&#39;s a <code>getName()</code> function):</p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span>const</span><span> </span><span></span><span> =</span><span> &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span>&#34;Hello, &#34;</span><span> +</span><span> </span><span></span><span>() </span><span>+</span><span> &#34;!&#34;</span><span>}&gt;</span></span>
<span><span>  &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;greet&#34;</span><span>&gt;Hello, &lt;</span><span></span><span>&gt;{</span><span></span><span>()}&lt;/</span><span></span><span>&gt;!&lt;/</span><span></span><span>&gt;</span></span>
<span><span>&lt;/</span><span></span><span>&gt;;</span></span></code></pre></div><p>One of the features of <abbr title="JavaScript XML">JSX</abbr> is that you can define your own tags called components. Components can be defined as ordinary JavaScript functions. For example, the following code defines and uses a <code>&lt;Container&gt;</code> component (component names typically follow PascalCase style):</p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span>import</span><span> type</span><span> { </span><span></span><span>, </span><span></span><span> } </span><span>from</span><span> &#34;hono/jsx&#34;</span><span>;</span></span>
<span></span>
<span><span>function</span><span> </span><span></span><span>() {</span></span>
<span><span>  return</span><span> &#34;JSX&#34;</span><span>;</span></span>
<span><span>}</span></span>
<span></span>
<span><span>interface</span><span> </span><span>ContainerProps</span><span> {</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> </span><span></span><span>;</span></span>
<span><span>}</span></span>
<span></span>
<span><span>const</span><span> </span><span></span><span>:</span><span> </span><span></span><span>&lt;</span><span>ContainerProps</span><span>&gt; </span><span>=</span><span> (</span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  return</span><span> &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span>&#34;Hello, &#34;</span><span> +</span><span> </span><span></span><span>.</span><span></span><span> </span><span>+</span><span> &#34;!&#34;</span><span>}&gt;{</span><span></span><span>.</span><span></span><span>}&lt;/</span><span></span><span>&gt;;</span></span>
<span><span>};</span></span>
<span></span>
<span><span>const</span><span> </span><span></span><span> =</span><span> &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>()}&gt;</span></span>
<span><span>  &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;greet&#34;</span><span>&gt;Hello, &lt;</span><span></span><span>&gt;{</span><span></span><span>()}&lt;/</span><span></span><span>&gt;!&lt;/</span><span></span><span>&gt;</span></span>
<span><span>&lt;/</span><span></span><span>&gt;;</span></span></code></pre></div><p>In the above code, <code>FC</code> is provided by <a href="https://hono.dev/" target="_blank" rel="noreferrer">Hono</a>, the web framework we&#39;ll use, and it helps define the type of the component. <code>FC</code> is a generic type, and the types that go inside the angle brackets after <code>FC</code> are type arguments. Here, we specify the props type as the type argument. Props refer to the parameters passed to the component. In the above code, we declared and used the <code>ContainerProps</code> interface as the props type for the <code>&lt;Container&gt;</code> component.</p><div><p>TIP</p><p>Type arguments for generic types can be multiple, separated by commas. For example, <code>Foo&lt;A, B&gt;</code> applies type arguments <code>A</code> and <code>B</code> to the generic type <code>Foo</code>.</p><p>There are also generic functions, which are written as <code>someFunction&lt;A, B&gt;(foo, bar)</code>.</p><p>When there&#39;s only one type argument, the angle brackets enclosing the type argument may look like XML/HTML tags, but they have nothing to do with <abbr title="JavaScript XML">JSX</abbr> functionality.</p><dl><dt><code>FC&lt;ContainerProps&gt;</code></dt><dd>Applies the type argument <code>ContainerProps</code> to the generic type <code>FC</code>.</dd><dt><code>&lt;Container&gt;</code></dt><dd>Opens a component tag named <code>&lt;Container&gt;</code>. Must be closed with <code>&lt;/Container&gt;</code>.</dd></dl></div><p>Among the things passed as props, <code>children</code> is worth noting specifically. This is because the child elements of the component are passed as the <code>children</code> prop. As a result, in the above code, the <code>html</code> variable is assigned the HTML tree <code>&lt;div title=&#34;Hello, JSX!&#34;&gt;&lt;p id=&#34;greet&#34;&gt;Hello, &lt;strong&gt;JSX&lt;/strong&gt;!&lt;/p&gt;&lt;/div&gt;</code>.</p><h2 id="account-creation-page" tabindex="-1">Account creation page <a href="#account-creation-page" aria-label="Permalink to &#34;Account creation page&#34;">​</a></h2><p>The first thing we&#39;ll create is the account creation page. We need to create an account before we can post or follow other accounts. Let&#39;s start by building the visible part.</p><p>First, let&#39;s create a file named <em>src/views.tsx</em>. Inside this file, we&#39;ll define a <code>&lt;Layout&gt;</code> component using <abbr title="JavaScript XML">JSX</abbr>:</p><div><p><span data-title="src/views.tsx">src/views.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span>import</span><span> type</span><span> { </span><span></span><span> } </span><span>from</span><span> &#34;hono/jsx&#34;</span><span>;</span></span>
<span></span>
<span><span>export</span><span> const</span><span> </span><span></span><span>:</span><span> </span><span></span><span> =</span><span> (</span><span></span><span>) </span><span>=&gt;</span><span> (</span></span>
<span><span>  &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;en&#34;</span><span>&gt;</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;utf-8&#34;</span><span> /&gt;</span></span>
<span><span>      &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;viewport&#34;</span><span> </span><span></span><span>=</span><span>&#34;width=device-width, initial-scale=1&#34;</span><span> /&gt;</span></span>
<span><span>      &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;color-scheme&#34;</span><span> </span><span></span><span>=</span><span>&#34;light dark&#34;</span><span> /&gt;</span></span>
<span><span>      &lt;</span><span></span><span>&gt;Microblog&lt;/</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span></span>
<span><span>        </span><span></span><span>=</span><span>&#34;stylesheet&#34;</span></span>
<span><span>        </span><span></span><span>=</span><span>&#34;https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css&#34;</span></span>
<span><span>      /&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;container&#34;</span><span>&gt;{</span><span></span><span>.</span><span>children</span><span>}&lt;/</span><span></span><span>&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;</span></span>
<span><span>  &lt;/</span><span></span><span>&gt;</span></span>
<span><span>);</span></span></code></pre></div></div><p>To avoid spending too much time on design, we&#39;ll use a CSS framework called <a href="https://picocss.com/" target="_blank" rel="noreferrer">Pico CSS</a>.</p><div><p>TIP</p><p>When the type of a variable or parameter can be inferred by TypeScript&#39;s type checker, like <code>props</code> above, it&#39;s fine to omit the type annotation. Even when the type annotation is omitted in such cases, you can check the type of a variable by hovering your mouse cursor over the variable name in Visual Studio Code.</p></div><p>Next, in the same file, let&#39;s define a <code>&lt;SetupForm&gt;</code> component that will go inside the layout:</p><div><p><span data-title="src/views.tsx">src/views.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span>export</span><span> const</span><span> </span><span></span><span>:</span><span> </span><span></span><span> =</span><span> () </span><span>=&gt;</span><span> (</span></span>
<span><span>  &lt;&gt;</span></span>
<span><span>    &lt;</span><span></span><span>&gt;Set up your microblog&lt;/</span><span></span><span>&gt;</span></span>
<span><span>    &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;post&#34;</span><span> </span><span></span><span>=</span><span>&#34;/setup&#34;</span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span>&gt;</span></span>
<span><span>        &lt;</span><span></span><span>&gt;</span></span>
<span><span>          Username{</span><span>&#34; &#34;</span><span>}</span></span>
<span><span>          &lt;</span><span></span></span>
<span><span>            </span><span></span><span>=</span><span>&#34;text&#34;</span></span>
<span><span>            </span><span></span><span>=</span><span>&#34;username&#34;</span></span>
<span><span>            </span><span></span></span>
<span><span>            </span><span></span><span>=</span><span>{</span><span>50</span><span>}</span></span>
<span><span>            </span><span></span><span>=</span><span>&#34;^[a-z0-9_\-]+$&#34;</span></span>
<span><span>          /&gt;</span></span>
<span><span>        &lt;/</span><span></span><span>&gt;</span></span>
<span><span>      &lt;/</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;submit&#34;</span><span> </span><span></span><span>=</span><span>&#34;Setup&#34;</span><span> /&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;</span></span>
<span><span>  &lt;/&gt;</span></span>
<span><span>);</span></span></code></pre></div></div><p>In <abbr title="JavaScript XML">JSX</abbr>, you can only have one top-level element, but the <code>&lt;SetupForm&gt;</code> component has two top-level elements: <code>&lt;h1&gt;</code> and <code>&lt;form&gt;</code>. That&#39;s why we&#39;ve wrapped them with <code>&lt;&gt;</code> and <code>&lt;/&gt;</code>. This is called a fragment.</p><p>Now it&#39;s time to use the components we&#39;ve defined. Open the <em>src/app.tsx</em> file and <code>import</code> the two components we just defined:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span>import</span><span> { </span><span></span><span>, </span><span></span><span> } </span><span>from</span><span> &#34;./views.tsx&#34;</span><span>;</span></span></code></pre></div></div><p>Then, display the account creation form we just made on the <em>/setup</em> page:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/setup&#34;</span><span>, (</span><span></span><span>) </span><span>=&gt;</span></span>
<span><span>  </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span> /&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;,</span></span>
<span><span>  ),</span></span>
<span><span>);</span></span></code></pre></div></div><p>Now, let&#39;s open the <a href="http://localhost:8000/setup" target="_blank" rel="noreferrer">http://localhost:8000/setup</a> page in a web browser. If you see a screen like this, it&#39;s working correctly:</p><p><img src="https://ntietz.com/assets/account-creation-page.Zbk-Rx66.png" alt="Account creation page"/></p><div><p>NOTE</p><p>To use <abbr title="JavaScript XML">JSX</abbr>, the source file extension must be <em>.jsx</em> or <em>.tsx</em>. Note that both files we edited in this section have the <em>.tsx</em> extension.</p></div><h3 id="database-setup" tabindex="-1">Database setup <a href="#database-setup" aria-label="Permalink to &#34;Database setup&#34;">​</a></h3><p>Now that we&#39;ve implemented the visible part, it&#39;s time to implement the functionality. We need a place to store account information, so let&#39;s use <a href="https://www.sqlite.org/" target="_blank" rel="noreferrer">SQLite</a>. SQLite is a relational database suitable for small-scale applications.</p><p>First, let&#39;s declare a table to hold account information. From now on, we&#39;ll write all table declarations in the <em>src/schema.sql</em> file. We&#39;ll store account information in the <code>users</code> table:</p><div><p><span data-title="src/schema.sql">src/schema.sql</span></p><div><p><span>sql</span></p><pre tabindex="0"><code><span><span>CREATE</span><span> TABLE</span><span> IF</span><span> NOT</span><span> EXISTS</span><span> users (</span></span>
<span><span>  id       </span><span>INTEGER</span><span> NOT NULL</span><span> PRIMARY KEY</span><span> CHECK</span><span> (id </span><span>=</span><span> 1</span><span>),</span></span>
<span><span>  username </span><span>TEXT</span><span>    NOT NULL</span><span> UNIQUE</span><span>      CHECK</span><span> (</span><span>trim</span><span>(</span><span>lower</span><span>(username)) </span><span>=</span><span> username</span></span>
<span><span>                                               AND</span><span> username </span><span>&lt;&gt;</span><span> &#39;&#39;</span></span>
<span><span>                                               AND</span><span> length</span><span>(username) </span><span>&lt;=</span><span> 50</span><span>)</span></span>
<span><span>);</span></span></code></pre></div></div><p>Since the microblog we&#39;re creating can only have one account, we&#39;ve put a constraint on the <code>id</code> column, which is the primary key, to not allow values other than <code>1</code>. This ensures that the <code>users</code> table can&#39;t contain more than one record. We&#39;ve also put constraints on the <code>username</code> column to not allow empty strings or strings that are too long.</p><p>Now we need to run the <em>src/schema.sql</em> file to create the users table. For this, we need the <code>sqlite3</code> command, which you can <a href="https://www.sqlite.org/download.html" target="_blank" rel="noreferrer">get from the SQLite website</a> or install from your platform&#39;s package manager. For macOS, you don&#39;t need to get it separately as it is built into the system. If you get it directly, you can get the <em>sqlite-tools-*.zip</em> file for your OS and unzip it. If you use a package manager, you can also install it with the following command:</p><div><p><label data-title="Debian &amp; Ubuntu" for="tab-37jO9Kg">Debian &amp; Ubuntu</label><label data-title="Fedora &amp; RHEL" for="tab-oZscTaX">Fedora &amp; RHEL</label><label data-title="Chocolatey" for="tab-H7wRwjX">Chocolatey</label><label data-title="Scoop" for="tab-F0Y0eP4">Scoop</label><label data-title="Windows Package Manager" for="tab-4pu01JZ">Windows Package Manager</label></p><div><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>sudo</span><span> apt</span><span> install</span><span> sqlite3</span></span></code></pre></div><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>sudo</span><span> dnf</span><span> install</span><span> sqlite</span></span></code></pre></div><div><p><span>powershell</span></p><pre tabindex="0"><code><span><span>choco install sqlite</span></span></code></pre></div><div><p><span>powershell</span></p><pre tabindex="0"><code><span><span>scoop install sqlite</span></span></code></pre></div><div><p><span>powershell</span></p><pre tabindex="0"><code><span><span>winget install SQLite.SQLite</span></span></code></pre></div></div></div><p>Okay, now that we have the <code>sqlite3</code> command, let&#39;s use it to create a database file:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>sqlite3</span><span> microblog.sqlite3</span><span> &lt;</span><span> src/schema.sql</span></span></code></pre></div><p>The above command will create a <em>microblog.sqlite3</em> file, which will store your SQLite data.</p><h3 id="connecting-to-the-database-in-the-app" tabindex="-1">Connecting to the database in the app <a href="#connecting-to-the-database-in-the-app" aria-label="Permalink to &#34;Connecting to the database in the app&#34;">​</a></h3><p>Now we need to use the SQLite database in our app. To use SQLite database in Node.js, we need a SQLite driver library, and we&#39;ll use the <em><a href="https://github.com/WiseLibs/better-sqlite3" target="_blank" rel="noreferrer">better-sqlite3</a></em> package. You can easily install the package with the <code>npm</code> command:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>npm</span><span> add</span><span> better-sqlite3</span></span>
<span><span>npm</span><span> add</span><span> --save-dev</span><span> @types/better-sqlite3</span></span></code></pre></div><div><p>TIP</p><p>The <em><a href="https://www.npmjs.com/package/@types/better-sqlite3" target="_blank" rel="noreferrer">@types/better-sqlite3</a></em> package contains type information about the <em>better-sqlite3</em> package&#39;s API for TypeScript. You need to install this package to enable auto-completion and type checking when editing in Visual Studio Code.</p><p>Packages like this in the <em>@types/</em> scope are called <a href="https://github.com/DefinitelyTyped/DefinitelyTyped" target="_blank" rel="noreferrer">Definitely Typed</a> packages. When a library is not written in TypeScript, the community adds type information and makes it into a package.</p></div><p>Now that we&#39;ve installed the package, let&#39;s write code to connect to the database using this package. Create a new file named <em>src/db.ts</em> and code it as follows:</p><div><p><span data-title="src/db.ts">src/db.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> </span><span></span><span> </span><span>from</span><span> &#34;better-sqlite3&#34;</span><span>;</span></span>
<span></span>
<span><span>const</span><span> </span><span></span><span> =</span><span> new</span><span> </span><span></span><span>(</span><span>&#34;microblog.sqlite3&#34;</span><span>);</span></span>
<span><span></span><span>.</span><span></span><span>(</span><span>&#34;journal_mode = WAL&#34;</span><span>);</span></span>
<span><span></span><span>.</span><span></span><span>(</span><span>&#34;foreign_keys = ON&#34;</span><span>);</span></span>
<span></span>
<span><span>export</span><span> default</span><span> </span><span></span><span>;</span></span></code></pre></div></div><div><p>TIP</p><p>The settings made through the <code>db.pragma()</code> function have the following effects:</p><dl><dt><a href="https://www.sqlite.org/wal.html" target="_blank" rel="noreferrer"><code>journal_mode = WAL</code></a></dt><dd>Adopts <a href="https://en.wikipedia.org/wiki/Write-ahead_logging" target="_blank" rel="noreferrer">Write-Ahead Logging</a> mode as a way to implement atomic commits and rollbacks in SQLite. This mode is generally more performant than the default <a href="https://www.sqlite.org/lockingv3.html#rollback" target="_blank" rel="noreferrer">rollback journal</a> mode.</dd><dt><a href="https://www.sqlite.org/foreignkeys.html#fk_enable" target="_blank" rel="noreferrer"><code>foreign_keys = ON</code></a></dt><dd>By default, SQLite does not check foreign key constraints. Turning on this setting makes it check foreign key constraints, which helps maintain data integrity.</dd></dl></div><p>Now let&#39;s declare a type in JavaScript to represent the record stored in the <code>users</code> table. Create a <em>src/schema.ts</em> file and define the <code>User</code> type as follows:</p><div><p><span data-title="src/schema.ts">src/schema.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>export</span><span> interface</span><span> </span><span>User</span><span> {</span></span>
<span><span>  </span><span></span><span>:</span><span> number</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span>;</span></span>
<span><span>}</span></span></code></pre></div></div><h3 id="record-insertion" tabindex="-1">Record insertion <a href="#record-insertion" aria-label="Permalink to &#34;Record insertion&#34;">​</a></h3><p>Now that we&#39;ve connected to the database, it&#39;s time to write code to insert records.</p><p>Open the <em>src/app.tsx</em> file and <code>import</code> the <code>db</code> object and <code>User</code> type that will be used for record insertion:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> </span><span></span><span> </span><span>from</span><span> &#34;./db.ts&#34;</span><span>;</span></span>
<span><span>import</span><span> type</span><span> { </span><span>User</span><span> } </span><span>from</span><span> &#34;./schema.ts&#34;</span><span>;</span></span></code></pre></div></div><p>Implement the <code>POST /setup</code> handler:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/setup&#34;</span><span>, </span><span>async</span><span> (</span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  // Check if an account already exists</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>User</span><span>&gt;(</span><span>&#34;SELECT * FROM users LIMIT 1&#34;</span><span>).</span><span></span><span>();</span></span>
<span><span>  if</span><span> (</span><span></span><span> </span><span>!=</span><span> null</span><span>) </span><span>return</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;/&#34;</span><span>);</span></span>
<span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> await</span><span> </span><span></span><span>.</span><span></span><span>.</span><span></span><span>();</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;username&#34;</span><span>);</span></span>
<span><span>  if</span><span> (</span><span>typeof</span><span> </span><span></span><span> </span><span>!==</span><span> &#34;string&#34;</span><span> ||</span><span> !</span><span></span><span>.</span><span></span><span>(</span><span>/</span><span>^</span><span>[a-z0-9_-]</span><span>{1,50}$</span><span>/</span><span>)) {</span></span>
<span><span>    return</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;/setup&#34;</span><span>);</span></span>
<span><span>  }</span></span>
<span><span>  </span><span></span><span>.</span><span></span><span>(</span><span>&#34;INSERT INTO users (username) VALUES (?)&#34;</span><span>).</span><span></span><span>(</span><span></span><span>);</span></span>
<span><span>  return</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;/&#34;</span><span>);</span></span>
<span><span>});</span></span></code></pre></div></div><p>Add code to check if an account already exists to the <code>GET /setup</code> handler we created earlier:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/setup&#34;</span><span>, (</span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  // Check if an account already exists</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>User</span><span>&gt;(</span><span>&#34;SELECT * FROM users LIMIT 1&#34;</span><span>).</span><span></span><span>();</span></span>
<span><span>  if</span><span> (</span><span></span><span> </span><span>!=</span><span> null</span><span>) </span><span>return</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;/&#34;</span><span>);</span></span>
<span></span>
<span><span>  return</span><span> </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span> /&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;,</span></span>
<span><span>  );</span></span>
<span><span>});</span></span></code></pre></div></div><h3 id="testing" tabindex="-1">Testing <a href="#testing" aria-label="Permalink to &#34;Testing&#34;">​</a></h3><p>Now that we&#39;ve roughly implemented the account creation feature, let&#39;s try it out. Open the <a href="http://localhost:8000/setup" target="_blank" rel="noreferrer">http://localhost:8000/setup</a> page in a web browser and create an account. In this tutorial, we&#39;ll assume that we used <em>johndoe</em> as the username. If it&#39;s created, let&#39;s also check if the record was properly inserted into the SQLite database:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>echo</span><span> &#34;SELECT * FROM users;&#34;</span><span> |</span><span> sqlite3</span><span> -table</span><span> microblog.sqlite3</span></span></code></pre></div><p>If the record was properly inserted, you should see output like this (of course, <code>johndoe</code> will be whatever username you entered):</p><table tabindex="0"><thead><tr><th><code>id</code></th><th><code>username</code></th></tr></thead><tbody><tr><td><code>1</code></td><td><code>johndoe</code></td></tr></tbody></table><h2 id="profile-page" tabindex="-1">Profile page <a href="#profile-page" aria-label="Permalink to &#34;Profile page&#34;">​</a></h2><p>Now that we&#39;ve created an account, let&#39;s implement a profile page to display the account information. Although we don&#39;t have much information to show yet.</p><p>Let&#39;s start with the visible part again. Open the <em>src/views.tsx</em> file and define a <code>&lt;Profile&gt;</code> component:</p><div><p><span data-title="src/views.tsx">src/views.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span>export</span><span> interface</span><span> </span><span>ProfileProps</span><span> {</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span>;</span></span>
<span><span>}</span></span>
<span></span>
<span><span>export</span><span> const</span><span> </span><span></span><span>:</span><span> </span><span></span><span>&lt;</span><span>ProfileProps</span><span>&gt; </span><span>=</span><span> ({ </span><span></span><span>, </span><span></span><span> }) </span><span>=&gt;</span><span> (</span></span>
<span><span>  &lt;&gt;</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span>&gt;{</span><span></span><span>}&lt;/</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;user-select: all;&#34;</span><span>&gt;{</span><span></span><span>}&lt;/</span><span></span><span>&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;</span></span>
<span><span>  &lt;/&gt;</span></span>
<span><span>);</span></span></code></pre></div></div><p>Then, open the <em>src/app.tsx</em> file and <code>import</code> the component we just defined:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span>import</span><span> { </span><span></span><span>, </span><span></span><span>, </span><span></span><span> } </span><span>from</span><span> &#34;./views.tsx&#34;</span><span>;</span></span></code></pre></div></div><p>And add a <code>GET /users/{username}</code> request handler that displays the <code>&lt;Profile&gt;</code> component:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/users/:username&#34;</span><span>, </span><span>async</span><span> (</span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>    .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>User</span><span>&gt;(</span><span>&#34;SELECT * FROM users WHERE username = ?&#34;</span><span>)</span></span>
<span><span>    .</span><span></span><span>(</span><span></span><span>.</span><span></span><span>.</span><span></span><span>(</span><span>&#34;username&#34;</span><span>));</span></span>
<span><span>  if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span> </span><span></span><span>.</span><span></span><span>();</span></span>
<span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> new</span><span> </span><span></span><span>(</span><span></span><span>.</span><span></span><span>.</span><span></span><span>);</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> `@${</span><span></span><span>.</span><span></span><span>}@${</span><span></span><span>.</span><span></span><span>}`</span><span>;</span></span>
<span><span>  return</span><span> </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span>} </span><span></span><span>=</span><span>{</span><span></span><span>} /&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;,</span></span>
<span><span>  );</span></span>
<span><span>});</span></span></code></pre></div></div><p>Now let&#39;s test if it displays correctly. Open the <a href="http://localhost:8000/users/johndoe" target="_blank" rel="noreferrer">http://localhost:8000/users/johndoe</a> page in your web browser (if you created an account with a username other than <code>johndoe</code>, change the URL accordingly). You should see a screen like this:</p><p><img src="https://ntietz.com/assets/profile-page.BQHXdBsx.png" alt="Profile page"/></p><div><p>TIP</p><p>A fediverse handle, or simply handle, is a unique address that identifies an account in the fediverse. For example, it looks like <code>@hongminhee@fosstodon.org</code>. It&#39;s similar to an email address, and its structure is also similar to an email address. It starts with <code>@</code>, followed by a name, then another <code>@</code>, and finally the domain name of the server the account belongs to. Sometimes the initial <code>@</code> is omitted.</p><p>Technically, handles are implemented using two standards: <a href="https://datatracker.ietf.org/doc/html/rfc7033" target="_blank" rel="noreferrer">WebFinger</a> and the <a href="https://datatracker.ietf.org/doc/html/rfc7565" target="_blank" rel="noreferrer"><code>acct:</code> URI scheme</a>. Thanks to Fedify implementing these, you don&#39;t need to know the implementation details while following this tutorial.</p></div><h2 id="implementing-the-actor" tabindex="-1">Implementing the actor <a href="#implementing-the-actor" aria-label="Permalink to &#34;Implementing the actor&#34;">​</a></h2><p>As the name suggests, ActivityPub is a protocol for exchanging activities. Writing a post, editing a post, deleting a post, liking a post, commenting, editing a profile… All actions that happen in social media are expressed as activities.</p><p>And all activities are transmitted from actor to actor. For example, when John Doe writes a post, a <q>writing</q> (<code>Create(Note)</code>) activity is sent from Joh Doe to John Doe&#39;s followers. If Jane Doe likes that post, a <q>liking</q> (<a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Like"><code>Like</code></a>) activity is sent from Jane Doe to John Doe.</p><p>Therefore, the first step in implementing ActivityPub is to implement the actor.</p><p>The demo app generated by the <code>fedify init</code> command already has a very simple actor implemented, but to communicate with actual software like Mastodon or Misskey, we need to implement the actor more properly.</p><p>First, let&#39;s take a look at the current implementation. Open the <em>src/federation.ts</em> file:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> { </span><span></span><span>, </span><span></span><span> } </span><span>from</span><span> &#34;@fedify/fedify&#34;</span><span>;</span></span>
<span><span>import</span><span> { </span><span></span><span>, </span><span></span><span> } </span><span>from</span><span> &#34;@fedify/fedify&#34;</span><span>;</span></span>
<span><span>import</span><span> { </span><span></span><span> } </span><span>from</span><span> &#34;@logtape/logtape&#34;</span><span>;</span></span>
<span></span>
<span><span>const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>(</span><span>&#34;microblog&#34;</span><span>);</span></span>
<span></span>
<span><span>const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>({</span></span>
<span><span>  </span><span></span><span>: </span><span>new</span><span> </span><span></span><span>(),</span></span>
<span><span>  </span><span></span><span>: </span><span>new</span><span> </span><span></span><span>(),</span></span>
<span><span>});</span></span>
<span></span>
<span><span></span><span>.</span><span></span><span>(</span><span>&#34;/users/{identifier}&#34;</span><span>, </span><span>async</span><span> (</span><span></span><span>, </span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  return</span><span> new</span><span> </span><span></span><span>({</span></span>
<span><span>    </span><span></span><span>: </span><span></span><span>.</span><span></span><span>(</span><span></span><span>),</span></span>
<span><span>    </span><span></span><span>: </span><span></span><span>,</span></span>
<span><span>    </span><span></span><span>: </span><span></span><span>,</span></span>
<span><span>  });</span></span>
<span><span>});</span></span>
<span></span>
<span><span>export</span><span> default</span><span> </span><span></span><span>;</span></span></code></pre></div></div><p>The part we should focus on is the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Federation.setActorDispatcher"><code>setActorDispatcher()</code></a> method. This method defines the URL and behavior that other ActivityPub software will use when querying an actor on our server. For example, if we query <em>/users/johndoe</em> as we did earlier, the <code>identifier</code> parameter of the callback function will receive the string value <code>&#34;johndoe&#34;</code>. And the callback function returns an instance of the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Person"><code>Person</code></a> class to convey the information of the queried actor.</p><p>The <code>ctx</code> parameter receives a <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/federation/~/Context"><code>Context</code></a> object, which contains various functions related to the ActivityPub protocol. For example, the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Context.getActorUri"><code>getActorUri()</code></a> method used in the above code returns the unique URI of the actor with the <code>identifier</code> passed as a parameter. This URI is being used as the unique identifier of the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Person"><code>Person</code></a> object.</p><p>As you can see from the implementation code, currently it&#39;s <em>making up</em> actor information and returning it for any identifier that comes after the <em>/users/</em> path. But what we want is to only allow queries for accounts that are actually registered. Let&#39;s modify this part to only return for accounts in the database.</p><h3 id="table-creation" tabindex="-1">Table creation <a href="#table-creation" aria-label="Permalink to &#34;Table creation&#34;">​</a></h3><p>We need to create an <code>actors</code> table. Unlike the <code>users</code> table which only contains accounts on the current instance server, this table will also include remote actors belonging to federated servers. The table looks like this. Add the following SQL to the <em>src/schema.sql</em> file:</p><div><p><span data-title="src/schema.sql">src/schema.sql</span></p><div><p><span>sql</span></p><pre tabindex="0"><code><span><span>CREATE</span><span> TABLE</span><span> IF</span><span> NOT</span><span> EXISTS</span><span> actors (</span></span>
<span><span>  id               </span><span>INTEGER</span><span> NOT NULL</span><span> PRIMARY KEY</span><span>,</span></span>
<span><span>  user_id          </span><span>INTEGER</span><span>          REFERENCES</span><span> users (id),</span></span>
<span><span>  uri              </span><span>TEXT</span><span>    NOT NULL</span><span> UNIQUE</span><span> CHECK</span><span> (uri </span><span>&lt;&gt;</span><span> &#39;&#39;</span><span>),</span></span>
<span><span>  handle           </span><span>TEXT</span><span>    NOT NULL</span><span> UNIQUE</span><span> CHECK</span><span> (handle </span><span>&lt;&gt;</span><span> &#39;&#39;</span><span>),</span></span>
<span><span>  name</span><span>             TEXT</span><span>,</span></span>
<span><span>  inbox_url        </span><span>TEXT</span><span>    NOT NULL</span><span> UNIQUE</span><span> CHECK</span><span> (inbox_url </span><span>LIKE</span><span> &#39;https://%&#39;</span></span>
<span><span>                                                  OR</span><span> inbox_url </span><span>LIKE</span><span> &#39;http://%&#39;</span><span>),</span></span>
<span><span>  shared_inbox_url </span><span>TEXT</span><span>                    CHECK</span><span> (shared_inbox_url</span></span>
<span><span>                                                  LIKE</span><span> &#39;https://%&#39;</span></span>
<span><span>                                                  OR</span><span> shared_inbox_url</span></span>
<span><span>                                                  LIKE</span><span> &#39;http://%&#39;</span><span>),</span></span>
<span><span>  url</span><span>              TEXT</span><span>                    CHECK</span><span> (</span><span>url</span><span> LIKE</span><span> &#39;https://%&#39;</span></span>
<span><span>                                                  OR</span><span> url</span><span> LIKE</span><span> &#39;http://%&#39;</span><span>),</span></span>
<span><span>  created          </span><span>TEXT</span><span>    NOT NULL</span><span> DEFAULT</span><span> (CURRENT_TIMESTAMP)</span></span>
<span><span>                                           CHECK</span><span> (created </span><span>&lt;&gt;</span><span> &#39;&#39;</span><span>)</span></span>
<span><span>);</span></span></code></pre></div></div><ul><li><p>The <code>user_id</code> column is a foreign key to connect with the <code>users</code> column. If the record represents a remote actor, it will be <code>NULL</code>, but if it&#39;s an account on the current instance server, it will contain the <code>users.id</code> value of that account.</p></li><li><p>The <code>uri</code> column contains the unique URI of the actor, also called the actor ID. All ActivityPub objects, including actors, have a unique ID in URI form. Therefore, it cannot be empty and cannot be duplicated.</p></li><li><p>The <code>handle</code> column contains the fediverse handle in the form of <code>@johndoe@example.com</code>. Likewise, it cannot be empty and cannot be duplicated.</p></li><li><p>The <code>name</code> column contains the name displayed in the UI. It usually contains a full name or nickname. However, according to the ActivityPub specification, this column can be empty.</p></li><li><p>The <code>inbox_url</code> column contains the URL of the actor&#39;s inbox. We&#39;ll explain in detail what an inbox is below, but for now, just know that it must exist for the actor. This column also cannot be empty or duplicated.</p></li><li><p>The <code>shared_inbox_url</code> column contains the URL of the actor&#39;s shared inbox, which we&#39;ll also explain below. It&#39;s not mandatory, so it can be empty, and as the column name suggests, it can share the same shared inbox URL with other actors.</p></li><li><p>The <code>url</code> column contains the profile URL of the actor. A profile URL means the URL of the profile page that can be opened in a web browser. Sometimes the actor&#39;s ID and profile URL are the same, but they can be different depending on the service, so in that case, the profile URL is stored in this column. It can be empty.</p></li><li><p>The <code>created</code> column records when the record was created. It cannot be empty, and by default, the insertion time is recorded.</p></li></ul><p>Now, let&#39;s apply the <em>src/schema.sql</em> file to the <em>microblog.sqlite3</em> database file:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>sqlite3</span><span> microblog.sqlite3</span><span> &lt;</span><span> src/schema.sql</span></span></code></pre></div><p>And let&#39;s define a type in <em>src/schema.ts</em> to represent records stored in the <code>actors</code> table in JavaScript:</p><div><p><span data-title="src/schema.ts">src/schema.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>export</span><span> interface</span><span> </span><span>Actor</span><span> {</span></span>
<span><span>  </span><span></span><span>:</span><span> number</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> number</span><span> |</span><span> null</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span> |</span><span> null</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span> |</span><span> null</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span> |</span><span> null</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span>;</span></span>
<span><span>}</span></span></code></pre></div></div><h3 id="actor-record" tabindex="-1">Actor record <a href="#actor-record" aria-label="Permalink to &#34;Actor record&#34;">​</a></h3><p>Although we currently have one record in the <code>users</code> table, there&#39;s no corresponding record in the <code>actors</code> table. This is because we didn&#39;t add a record to the <code>actors</code> table when creating the account. We need to modify the account creation code to add records to both <code>users</code> and <code>actors</code>.</p><p>First, let&#39;s modify the <code>SetupForm</code> in <em>src/views.tsx</em> to also input a name that will go into the <code>actors.name</code> column along with the username:</p><div><p><span data-title="src/views.tsx">src/views.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span>export</span><span> const</span><span> </span><span></span><span>:</span><span> </span><span></span><span> =</span><span> () </span><span>=&gt;</span><span> (</span></span>
<span><span>  &lt;&gt;</span></span>
<span><span>    &lt;</span><span></span><span>&gt;Set up your microblog&lt;/</span><span></span><span>&gt;</span></span>
<span><span>    &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;post&#34;</span><span> </span><span></span><span>=</span><span>&#34;/setup&#34;</span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span>&gt;</span></span>
<span><span>        &lt;</span><span></span><span>&gt;</span></span>
<span><span>          Username{</span><span>&#34; &#34;</span><span>}</span></span>
<span><span>          &lt;</span><span></span></span>
<span><span>            </span><span></span><span>=</span><span>&#34;text&#34;</span></span>
<span><span>            </span><span></span><span>=</span><span>&#34;username&#34;</span></span>
<span><span>            </span><span></span></span>
<span><span>            </span><span></span><span>=</span><span>{</span><span>50</span><span>}</span></span>
<span><span>            </span><span></span><span>=</span><span>&#34;^[a-z0-9_\-]+$&#34;</span></span>
<span><span>          /&gt;</span></span>
<span><span>        &lt;/</span><span></span><span>&gt;</span></span>
<span><span>        &lt;</span><span></span><span>&gt;</span></span>
<span><span>          Name &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;text&#34;</span><span> </span><span></span><span>=</span><span>&#34;name&#34;</span><span> </span><span></span><span> /&gt;</span></span>
<span><span>        &lt;/</span><span></span><span>&gt;</span></span>
<span><span>      &lt;/</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;submit&#34;</span><span> </span><span></span><span>=</span><span>&#34;Setup&#34;</span><span> /&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;</span></span>
<span><span>  &lt;/&gt;</span></span>
<span><span>);</span></span></code></pre></div></div><p>Now <code>import</code> the <code>Actor</code> type we defined earlier in <em>src/app.tsx</em>:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> type</span><span> { Actor, User } </span><span>from</span><span> &#34;./schema.ts&#34;</span><span>;</span></span></code></pre></div></div><p>Now let&#39;s add code to the <code>POST /setup</code> handler to create a record in the <code>actors</code> table with the input name and other necessary information:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/setup&#34;</span><span>, </span><span>async</span><span> (</span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  // Check if an account already exists</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>    .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>User</span><span>&gt;(</span></span>
<span><span>      `</span></span>
<span><span>      SELECT * FROM users</span></span>
<span><span>      JOIN actors ON (users.id = actors.user_id)</span></span>
<span><span>      LIMIT 1</span></span>
<span><span>      `</span><span>,</span></span>
<span><span>    )</span></span>
<span><span>    .</span><span></span><span>();</span></span>
<span><span>  if</span><span> (</span><span></span><span> </span><span>!=</span><span> null</span><span>) </span><span>return</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;/&#34;</span><span>);</span></span>
<span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> await</span><span> </span><span></span><span>.</span><span></span><span>.</span><span></span><span>();</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;username&#34;</span><span>);</span></span>
<span><span>  if</span><span> (</span><span>typeof</span><span> </span><span></span><span> </span><span>!==</span><span> &#34;string&#34;</span><span> ||</span><span> !</span><span></span><span>.</span><span></span><span>(</span><span>/</span><span>^</span><span>[a-z0-9_-]</span><span>{1,50}$</span><span>/</span><span>)) {</span></span>
<span><span>    return</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;/setup&#34;</span><span>);</span></span>
<span><span>  }</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;name&#34;</span><span>);</span></span>
<span><span>  if</span><span> (</span><span>typeof</span><span> </span><span></span><span> </span><span>!==</span><span> &#34;string&#34;</span><span> ||</span><span> </span><span></span><span>.</span><span></span><span>() </span><span>===</span><span> &#34;&#34;</span><span>) {</span></span>
<span><span>    return</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;/setup&#34;</span><span>);</span></span>
<span><span>  }</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> new</span><span> </span><span></span><span>(</span><span></span><span>.</span><span></span><span>.</span><span></span><span>);</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> `@${</span><span></span><span>}@${</span><span></span><span>.</span><span></span><span>}`</span><span>;</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>(</span><span></span><span>.</span><span></span><span>.</span><span></span><span>, </span><span></span><span>);</span></span>
<span><span>  </span><span></span><span>.</span><span></span><span>(() </span><span>=&gt;</span><span> {</span></span>
<span><span>    </span><span></span><span>.</span><span></span><span>(</span><span>&#34;INSERT OR REPLACE INTO users (id, username) VALUES (1, ?)&#34;</span><span>).</span><span></span><span>(</span></span>
<span><span>      </span><span></span><span>,</span></span>
<span><span>    );</span></span>
<span><span>    </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>      `</span></span>
<span><span>      INSERT OR REPLACE INTO actors</span></span>
<span><span>        (user_id, uri, handle, name, inbox_url, shared_inbox_url, url)</span></span>
<span><span>      VALUES (1, ?, ?, ?, ?, ?, ?)</span></span>
<span><span>    `</span><span>,</span></span>
<span><span>    ).</span><span></span><span>(</span></span>
<span><span>      </span><span></span><span>.</span><span></span><span>(</span><span></span><span>).</span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>.</span><span></span><span>(</span><span></span><span>).</span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>.</span><span></span><span>().</span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>.</span><span></span><span>(</span><span></span><span>).</span><span></span><span>,</span></span>
<span><span>    );</span></span>
<span><span>  })();</span></span>
<span><span>  return</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;/&#34;</span><span>);</span></span>
<span><span>});</span></span></code></pre></div></div><p>When checking if an account already exists, we modified it to determine that there&#39;s no account yet not only when there&#39;s no record in the <code>users</code> table, but also when there&#39;s no matching record in the <code>actors</code> table. Apply the same condition to the <code>GET /setup</code> handler and the <code>GET /users/{username}</code> handler:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/setup&#34;</span><span>, (</span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  // Check if the user already exists</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>    .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>User</span><span>&gt;(</span></span>
<span><span>      `</span></span>
<span><span>      SELECT * FROM users</span></span>
<span><span>      JOIN actors ON (users.id = actors.user_id)</span></span>
<span><span>      LIMIT 1</span></span>
<span><span>      `</span><span>,</span></span>
<span><span>    )</span></span>
<span><span>    .</span><span></span><span>();</span></span>
<span><span>  if</span><span> (</span><span></span><span> </span><span>!=</span><span> null</span><span>) </span><span>return</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;/&#34;</span><span>);</span></span>
<span></span>
<span><span>  return</span><span> </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span> /&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;,</span></span>
<span><span>  );</span></span>
<span><span>});</span></span></code></pre></div></div><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/users/:username&#34;</span><span>, </span><span>async</span><span> (</span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>    .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>User</span><span> &amp;</span><span> </span><span>Actor</span><span>&gt;(</span></span>
<span><span>      `</span></span>
<span><span>      SELECT * FROM users</span></span>
<span><span>      JOIN actors ON (users.id = actors.user_id)</span></span>
<span><span>      WHERE username = ?</span></span>
<span><span>      `</span><span>,</span></span>
<span><span>    )</span></span>
<span><span>    .</span><span></span><span>(</span><span></span><span>.</span><span></span><span>.</span><span></span><span>(</span><span>&#34;username&#34;</span><span>));</span></span>
<span><span>  if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span> </span><span></span><span>.</span><span></span><span>();</span></span>
<span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> new</span><span> </span><span></span><span>(</span><span></span><span>.</span><span></span><span>.</span><span></span><span>);</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> `@${</span><span></span><span>.</span><span></span><span>}@${</span><span></span><span>.</span><span></span><span>}`</span><span>;</span></span>
<span><span>  return</span><span> </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span> </span><span>??</span><span> </span><span></span><span>.</span><span></span><span>} </span><span></span><span>=</span><span>{</span><span></span><span>} /&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;,</span></span>
<span><span>  );</span></span>
<span><span>});</span></span></code></pre></div></div><div><p>TIP</p><p>In TypeScript, <code>A &amp; B</code> means an object that is both type <code>A</code> and type <code>B</code>. For example, given the type <code>{ a: number } &amp; { b: string }</code>, <code>{ a: 123 }</code> or <code>{ b: &#34;foo&#34; }</code> do not satisfy this type, but <code>{ a: 123, b: &#34;foo&#34; }</code> does satisfy this type.</p></div><p>Finally, open the <em>src/federation.ts</em> file and add the following code below the actor dispatcher:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/users/{identifier}/inbox&#34;</span><span>, </span><span>&#34;/inbox&#34;</span><span>);</span></span></code></pre></div></div><p>Don&#39;t worry about the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Federation.setInboxListeners"><code>setInboxListeners()</code></a> method for now. We&#39;ll cover this when we explain about the inbox. Just note that the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Context.getInboxUri"><code>getInboxUri()</code></a> method used in the account creation code needs the above code to work properly.</p><p>If you&#39;ve modified all the code, open the <a href="http://localhost:8000/setup" target="_blank" rel="noreferrer">http://localhost:8000/setup</a> page in your browser and create an account again:</p><p><img src="https://ntietz.com/assets/account-creation-page-2.BAKG9NMu.png" alt="Account creation page"/></p><h3 id="actor-dispatcher" tabindex="-1">Actor dispatcher <a href="#actor-dispatcher" aria-label="Permalink to &#34;Actor dispatcher&#34;">​</a></h3><p>Now that we&#39;ve created the <code>actors</code> table and filled in a record, let&#39;s modify <em>src/federation.ts</em> again. First, <code>import</code> the <code>db</code> object, and <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Endpoints"><code>Endpoints</code></a> and <code>Actor</code> types:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> { </span><span></span><span>, </span><span></span><span>, </span><span></span><span> } </span><span>from</span><span> &#34;@fedify/fedify&#34;</span><span>;</span></span>
<span><span>import</span><span> </span><span></span><span> </span><span>from</span><span> &#34;./db.ts&#34;</span><span>;</span></span>
<span><span>import</span><span> type</span><span> { </span><span></span><span>, </span><span></span><span> } </span><span>from</span><span> &#34;./schema.ts&#34;</span><span>;</span></span></code></pre></div></div><p>Now that we&#39;ve <code>import</code>ed what we need, let&#39;s modify the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Federation.setActorDispatcher"><code>setActorDispatcher()</code></a> method:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/users/{identifier}&#34;</span><span>, </span><span>async</span><span> (</span><span></span><span>, </span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>    .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>User</span><span> &amp;</span><span> </span><span>Actor</span><span>&gt;(</span></span>
<span><span>      `</span></span>
<span><span>      SELECT * FROM users</span></span>
<span><span>      JOIN actors ON (users.id = actors.user_id)</span></span>
<span><span>      WHERE users.username = ?</span></span>
<span><span>      `</span><span>,</span></span>
<span><span>    )</span></span>
<span><span>    .</span><span></span><span>(</span><span></span><span>);</span></span>
<span><span>  if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span> null</span><span>;</span></span>
<span></span>
<span><span>  return</span><span> new</span><span> </span><span></span><span>({</span></span>
<span><span>    </span><span></span><span>: </span><span></span><span>.</span><span></span><span>(</span><span></span><span>),</span></span>
<span><span>    </span><span></span><span>: </span><span></span><span>,</span></span>
<span><span>    </span><span></span><span>: </span><span></span><span>.</span><span></span><span>,</span></span>
<span><span>    </span><span></span><span>: </span><span></span><span>.</span><span></span><span>(</span><span></span><span>),</span></span>
<span><span>    </span><span></span><span>: </span><span>new</span><span> </span><span></span><span>({</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>.</span><span></span><span>(),</span></span>
<span><span>    }),</span></span>
<span><span>    </span><span></span><span>: </span><span></span><span>.</span><span></span><span>(</span><span></span><span>),</span></span>
<span><span>  });</span></span>
<span><span>});</span></span></code></pre></div></div><p>In the changed code, we now query the <code>users</code> table in the database and return <code>null</code> if it&#39;s not an account on the current server. In other words, it will respond with a proper <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Person"><code>Person</code></a> object with <code>200 OK</code> for a <code>GET /users/johndoe</code> request (assuming the account was created with the username <code>johndoe</code>), and respond with <code>404 Not Found</code> for other requests.</p><p>Let&#39;s look at how the part creating the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Person"><code>Person</code></a> object has changed. First, a <code>name</code> property has been added. This property uses the value from the <code>actors.name</code> column. We&#39;ll cover the <code>inbox</code> and <code>endpoints</code> properties when we explain about the inbox. The <code>url</code> property contains the profile URL of this account, and in this tutorial, we&#39;ll make the actor ID and the actor&#39;s profile URL match.</p><div><p>TIP</p><p>Sharp-eyed readers may have noticed that we&#39;re defining overlapping handlers for <code>GET /users/{identifier}</code> on both Hono and Fedify sides. So what happens when an actual request is sent to this path? The answer is that it depends on the <code>Accept</code> header of the request. If a request is sent with the <code>Accept: text/html</code> header, the request handler on the Hono side responds. If a request is sent with the <code>Accept: application/activity+json</code> header, the request handler on the Fedify side responds.</p><p>This way of giving different responses according to the <code>Accept</code> header of the request is called HTTP <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Content_negotiation" target="_blank" rel="noreferrer">content negotiation</a>, and Fedify itself implements content negotiation. More specifically, all requests go through Fedify once, and if it&#39;s not an ActivityPub-related request, it&#39;s passed on to the integrated framework, which in this tutorial is Hono.</p></div><div><p>TIP</p><p>In Fedify, all URIs and URLs are represented as <a href="https://developer.mozilla.org/" target="_blank" rel="noreferrer"><code>URL</code></a> instances.</p></div><h3 id="testing-1" tabindex="-1">Testing <a href="#testing-1" aria-label="Permalink to &#34;Testing&#34;">​</a></h3><p>Now, let&#39;s test if the actor dispatcher is working well.</p><p>With the server running, open a new terminal tab and enter the following command:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>fedify</span><span> lookup</span><span> http://localhost:8000/users/alice</span></span></code></pre></div><p>Since there&#39;s no account named <code>alice</code>, you&#39;ll get an error like this, unlike before:</p><div><p><span>console</span></p><pre tabindex="0"><code><span><span>✔ Looking up the object...</span></span>
<span><span>Failed to fetch the object.</span></span>
<span><span>It may be a private object.  Try with -a/--authorized-fetch.</span></span></code></pre></div><p>Now let&#39;s look up the <code>johndoe</code> account:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>fedify</span><span> lookup</span><span> http://localhost:8000/users/johndoe</span></span></code></pre></div><p>Now you get a good result:</p><div><p><span>console</span></p><pre tabindex="0"><code><span><span>✔ Looking up the object...</span></span>
<span><span>Person {</span></span>
<span><span>  id: URL &#34;http://localhost:8000/users/johndoe&#34;,</span></span>
<span><span>  name: &#34;John Doe&#34;,</span></span>
<span><span>  url: URL &#34;http://localhost:8000/users/johndoe&#34;,</span></span>
<span><span>  preferredUsername: &#34;johndoe&#34;,</span></span>
<span><span>  inbox: URL &#34;http://localhost:8000/users/johndoe/inbox&#34;,</span></span>
<span><span>  endpoints: Endpoints { sharedInbox: URL &#34;http://localhost:8000/inbox&#34; }</span></span>
<span><span>}</span></span></code></pre></div><h2 id="cryptographic-key-pairs" tabindex="-1">Cryptographic key pairs <a href="#cryptographic-key-pairs" aria-label="Permalink to &#34;Cryptographic key pairs&#34;">​</a></h2><p>The next thing we&#39;ll implement is the actor&#39;s cryptographic keys for signing. In ActivityPub, when an actor creates and sends an activity, it uses a <a href="https://en.wikipedia.org/wiki/Digital_signature" target="_blank" rel="noreferrer">digital signature</a> to prove that the activity was really created by that actor. For this, each actor creates and holds their own matching private key (secret key) and public key pair, and makes the public key visible to other actors. When actors receive an activity, they compare the sender&#39;s public key with the activity&#39;s signature to verify that the activity was indeed created by the sender. Fedify handles the signing and signature verification automatically, but you need to implement the generation and preservation of the key pairs yourself.</p><div><p>WARNING</p><p>As the name suggests, the private key (secret key) should not be accessible to anyone other than the signing subject. On the other hand, the public key&#39;s purpose is to be public, so it&#39;s fine for anyone to access it.</p></div><h3 id="table-creation-1" tabindex="-1">Table creation <a href="#table-creation-1" aria-label="Permalink to &#34;Table creation&#34;">​</a></h3><p>Let&#39;s define a <code>keys</code> table in <em>src/schema.sql</em> to store the private and public key pairs:</p><div><p><span data-title="src/schema.sql">src/schema.sql</span></p><div><p><span>sql</span></p><pre tabindex="0"><code><span><span>CREATE</span><span> TABLE</span><span> IF</span><span> NOT</span><span> EXISTS</span><span> keys (</span></span>
<span><span>  user_id     </span><span>INTEGER</span><span> NOT NULL</span><span> REFERENCES</span><span> users (id),</span></span>
<span><span>  type</span><span>        TEXT</span><span>    NOT NULL</span><span> CHECK</span><span> (</span><span>type</span><span> IN</span><span> (</span><span>&#39;RSASSA-PKCS1-v1_5&#39;</span><span>, </span><span>&#39;Ed25519&#39;</span><span>)),</span></span>
<span><span>  private_key </span><span>TEXT</span><span>    NOT NULL</span><span> CHECK</span><span> (private_key </span><span>&lt;&gt;</span><span> &#39;&#39;</span><span>),</span></span>
<span><span>  public_key  </span><span>TEXT</span><span>    NOT NULL</span><span> CHECK</span><span> (public_key </span><span>&lt;&gt;</span><span> &#39;&#39;</span><span>),</span></span>
<span><span>  created     </span><span>TEXT</span><span>    NOT NULL</span><span> DEFAULT</span><span> (CURRENT_TIMESTAMP) </span><span>CHECK</span><span> (created </span><span>&lt;&gt;</span><span> &#39;&#39;</span><span>),</span></span>
<span><span>  PRIMARY KEY</span><span> (user_id, </span><span>type</span><span>)</span></span>
<span><span>);</span></span></code></pre></div></div><p>If you look closely at the table, you can see that the <code>type</code> column only allows two types of values. One is the <a href="https://www.rfc-editor.org/rfc/rfc2313" target="_blank" rel="noreferrer">RSA-PKCS#1-v1.5</a> type and the other is the <a href="https://ed25519.cr.yp.to/" target="_blank" rel="noreferrer">Ed25519</a> type. (What each of these means is not important for this tutorial.) Since the primary key is on <code>(user_id, type)</code>, there can be a maximum of two key pairs for one user.</p><div><p>TIP</p><p>We can&#39;t go into detail in this tutorial, but as of November 2024, the ActivityPub network is in the process of transitioning from the RSA-PKCS#1-v1.5 type to the Ed25519 type. Some software only accepts the RSA-PKCS#1-v1.5 type, while some software accepts the Ed25519 type. Therefore, to communicate with both sides, both pairs of keys are needed.</p></div><p>The <code>private_key</code> and <code>public_key</code> columns can receive strings, and we&#39;ll put JSON data in them. We&#39;ll cover how to encode private and public keys as JSON later.</p><p>Now let&#39;s create the <code>keys</code> table:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>sqlite3</span><span> microblog.sqlite3</span><span> &lt;</span><span> src/schema.sql</span></span></code></pre></div><p>Let&#39;s also define a <code>Key</code> type in the <em>src/schema.ts</em> file to represent records stored in the <code>keys</code> table in JavaScript:</p><div><p><span data-title="src/schema.ts">src/schema.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>export</span><span> interface</span><span> </span><span>Key</span><span> {</span></span>
<span><span>  </span><span></span><span>:</span><span> number</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> &#34;RSASSA-PKCS1-v1_5&#34;</span><span> |</span><span> &#34;Ed25519&#34;</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span>;</span></span>
<span><span>}</span></span></code></pre></div></div><h3 id="key-pairs-dispatcher" tabindex="-1">Key pairs dispatcher <a href="#key-pairs-dispatcher" aria-label="Permalink to &#34;Key pairs dispatcher&#34;">​</a></h3><p>Now we need to write code to generate and load key pairs.</p><p>Open the <em>src/federation.ts</em> file and <code>import</code> the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/exportJwk"><code>exportJwk()</code></a>, <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/generateCryptoKeyPair"><code>generateCryptoKeyPair()</code></a>, <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/importJwk"><code>importJwk()</code></a> functions provided by Fedify and the <code>Key</code> type we defined earlier:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> {</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>} </span><span>from</span><span> &#34;@fedify/fedify&#34;</span><span>;</span></span>
<span><span>import</span><span> type</span><span> { </span><span></span><span>, </span><span></span><span>, </span><span></span><span> } </span><span>from</span><span> &#34;./schema.ts&#34;</span><span>;</span></span></code></pre></div></div><p>Now let&#39;s modify the actor dispatcher part as follows:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span></span></span>
<span><span>  .</span><span></span><span>(</span><span>&#34;/users/{identifier}&#34;</span><span>, </span><span>async</span><span> (</span><span></span><span>, </span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>      .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>User</span><span> &amp;</span><span> </span><span>Actor</span><span>&gt;(</span></span>
<span><span>        `</span></span>
<span><span>        SELECT * FROM users</span></span>
<span><span>        JOIN actors ON (users.id = actors.user_id)</span></span>
<span><span>        WHERE users.username = ?</span></span>
<span><span>        `</span><span>,</span></span>
<span><span>      )</span></span>
<span><span>      .</span><span></span><span>(</span><span></span><span>);</span></span>
<span><span>    if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span> null</span><span>;</span></span>
<span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> await</span><span> </span><span></span><span>.</span><span></span><span>(</span><span></span><span>);</span></span>
<span><span>    return</span><span> new</span><span> </span><span></span><span>({</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>.</span><span></span><span>(</span><span></span><span>),</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>.</span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>.</span><span></span><span>(</span><span></span><span>),</span></span>
<span><span>      </span><span></span><span>: </span><span>new</span><span> </span><span></span><span>({</span></span>
<span><span>        </span><span></span><span>: </span><span></span><span>.</span><span></span><span>(),</span></span>
<span><span>      }),</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>.</span><span></span><span>(</span><span></span><span>),</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>[</span><span>0</span><span>].</span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>.</span><span></span><span>((</span><span></span><span>) </span><span>=&gt;</span><span> </span><span></span><span>.</span><span></span><span>),</span></span>
<span><span>    });</span></span>
<span><span>  })</span></span>
<span><span>  .</span><span></span><span>(</span><span>async</span><span> (</span><span></span><span>, </span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>      .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>User</span><span>&gt;(</span><span>&#34;SELECT * FROM users WHERE username = ?&#34;</span><span>)</span></span>
<span><span>      .</span><span></span><span>(</span><span></span><span>);</span></span>
<span><span>    if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span> [];</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>      .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>Key</span><span>&gt;(</span><span>&#34;SELECT * FROM keys WHERE keys.user_id = ?&#34;</span><span>)</span></span>
<span><span>      .</span><span></span><span>(</span><span></span><span>.</span><span></span><span>);</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>      </span><span></span><span>.</span><span></span><span>((</span><span></span><span>) </span><span>=&gt;</span><span> [</span><span></span><span>.</span><span></span><span>, </span><span></span><span>]),</span></span>
<span><span>    ) </span><span>as</span><span> </span><span></span><span>&lt;</span><span>Key</span><span>[</span><span>&#34;type&#34;</span><span>], </span><span>Key</span><span>&gt;;</span></span>
<span><span>    const</span><span> </span><span></span><span>:</span><span> </span><span>CryptoKeyPair</span><span>[] </span><span>=</span><span> [];</span></span>
<span><span>    // For each of the two key formats (RSASSA-PKCS1-v1_5 and Ed25519) that</span></span>
<span><span>    // the actor supports, check if they have a key pair, and if not,</span></span>
<span><span>    // generate one and store it in the database:</span></span>
<span><span>    for</span><span> (</span><span>const</span><span> </span><span></span><span> of</span><span> [</span><span>&#34;RSASSA-PKCS1-v1_5&#34;</span><span>, </span><span>&#34;Ed25519&#34;</span><span>] </span><span>as</span><span> </span><span></span><span>) {</span></span>
<span><span>      if</span><span> (</span><span></span><span>[</span><span></span><span>] </span><span>==</span><span> null</span><span>) {</span></span>
<span><span>        </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>          &#34;The user {identifier} does not have an {keyType} key; creating one...&#34;</span><span>,</span></span>
<span><span>          { </span><span></span><span>, </span><span></span><span> },</span></span>
<span><span>        );</span></span>
<span><span>        const</span><span> { </span><span></span><span>, </span><span></span><span> } </span><span>=</span><span> await</span><span> </span><span></span><span>(</span><span></span><span>);</span></span>
<span><span>        </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>          `</span></span>
<span><span>          INSERT INTO keys (user_id, type, private_key, public_key)</span></span>
<span><span>          VALUES (?, ?, ?, ?)</span></span>
<span><span>          `</span><span>,</span></span>
<span><span>        ).</span><span></span><span>(</span></span>
<span><span>          </span><span></span><span>.</span><span></span><span>,</span></span>
<span><span>          </span><span></span><span>,</span></span>
<span><span>          </span><span></span><span>.</span><span></span><span>(</span><span>await</span><span> </span><span></span><span>(</span><span></span><span>)),</span></span>
<span><span>          </span><span></span><span>.</span><span></span><span>(</span><span>await</span><span> </span><span></span><span>(</span><span></span><span>)),</span></span>
<span><span>        );</span></span>
<span><span>        </span><span></span><span>.</span><span></span><span>({ </span><span></span><span>, </span><span></span><span> });</span></span>
<span><span>      } </span><span>else</span><span> {</span></span>
<span><span>        </span><span></span><span>.</span><span></span><span>({</span></span>
<span><span>          </span><span></span><span>: </span><span>await</span><span> </span><span></span><span>(</span></span>
<span><span>            </span><span></span><span>.</span><span></span><span>(</span><span></span><span>[</span><span></span><span>].</span><span></span><span>),</span></span>
<span><span>            &#34;private&#34;</span><span>,</span></span>
<span><span>          ),</span></span>
<span><span>          </span><span></span><span>: </span><span>await</span><span> </span><span></span><span>(</span></span>
<span><span>            </span><span></span><span>.</span><span></span><span>(</span><span></span><span>[</span><span></span><span>].</span><span></span><span>),</span></span>
<span><span>            &#34;public&#34;</span><span>,</span></span>
<span><span>          ),</span></span>
<span><span>        });</span></span>
<span><span>      }</span></span>
<span><span>    }</span></span>
<span><span>    return</span><span> </span><span></span><span>;</span></span>
<span><span>  });</span></span></code></pre></div></div><p>First of all, we should pay attention to the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/ActorCallbackSetters.setKeyPairsDispatcher"><code>setKeyPairsDispatcher()</code></a> method called in succession after the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Federation.setActorDispatcher"><code>setActorDispatcher()</code></a> method. This method connects the key pairs returned by the callback function to the account. By connecting the key pairs in this way, Fedify automatically adds digital signatures with the registered private keys when sending activities.</p><p>The <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/generateCryptoKeyPair"><code>generateCryptoKeyPair()</code></a> function generates a new private key and public key pair and returns it as a <a href="https://developer.mozilla.org/en-US/docs/Web/API/CryptoKeyPair" target="_blank" rel="noreferrer"><code>CryptoKeyPair</code></a> object. For your reference, the <a href="https://developer.mozilla.org/en-US/docs/Web/API/CryptoKeyPair" target="_blank" rel="noreferrer"><code>CryptoKeyPair</code></a> type has the type <code>{ privateKey: CryptoKey; publicKey: CryptoKey; }</code>.</p><p>The <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/exportJwk"><code>exportJwk()</code></a> function returns an object representing the <a href="https://developer.mozilla.org/en-US/docs/Web/API/CryptoKey" target="_blank" rel="noreferrer"><code>CryptoKey</code></a> object in JWK format. You don&#39;t need to know what the JWK format is. Just understand that it&#39;s a standard format for representing cryptographic keys in JSON. <a href="https://developer.mozilla.org/en-US/docs/Web/API/CryptoKey" target="_blank" rel="noreferrer"><code>CryptoKey</code></a> is a web standard type for representing cryptographic keys as JavaScript objects.</p><p>The <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/importJwk"><code>importJwk()</code></a> function converts a key represented in JWK format to a <a href="https://developer.mozilla.org/en-US/docs/Web/API/CryptoKey" target="_blank" rel="noreferrer"><code>CryptoKey</code></a> object. You can understand it as the opposite of the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/exportJwk"><code>exportJwk()</code></a> function.</p><p>Now, let&#39;s turn our attention back to the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Federation.setActorDispatcher"><code>setActorDispatcher()</code></a> method. We&#39;re using a method called <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Context.getActorKeyPairs"><code>getActorKeyPairs()</code></a>, which, as the name suggests, returns the key pairs of the actor. The actor&#39;s key pairs are those very key pairs we just loaded with the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/ActorCallbackSetters.setKeyPairsDispatcher"><code>setKeyPairsDispatcher()</code></a> method. We loaded two pairs of keys in RSA-PKCS#1-v1.5 and Ed25519 formats, so the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Context.getActorKeyPairs"><code>getActorKeyPairs()</code></a> method returns an array of two key pairs. Each element of the array is an object representing the key pair in various formats, which looks like this:</p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>interface</span><span> </span><span>ActorKeyPair</span><span> {</span></span>
<span><span>  </span><span></span><span>:</span><span> </span><span>CryptoKey</span><span>;              </span><span>// Private key</span></span>
<span><span>  </span><span></span><span>:</span><span> </span><span>CryptoKey</span><span>;               </span><span>// Public key</span></span>
<span><span>  </span><span></span><span>:</span><span> </span><span>URL</span><span>;                         </span><span>// Unique identification URI of the key</span></span>
<span><span>  </span><span></span><span>:</span><span> </span><span></span><span>; </span><span>// Another format of the public key</span></span>
<span><span>  </span><span></span><span>:</span><span> </span><span></span><span>;                 </span><span>// Yet another format of the public key</span></span>
<span><span>}</span></span></code></pre></div><p>It&#39;s complex to explain here how <a href="https://developer.mozilla.org/en-US/docs/Web/API/CryptoKey" target="_blank" rel="noreferrer"><code>CryptoKey</code></a>, <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/CryptographicKey"><code>CryptographicKey</code></a>, and <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Multikey"><code>Multikey</code></a> differ, and why there need to be so many formats. For now, let&#39;s just note that when initializing the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Person"><code>Person</code></a> object, the <code>publicKey</code> property accepts the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/CryptographicKey"><code>CryptographicKey</code></a> type and the <code>assertionMethods</code> property accepts the <code>MultiKey[]</code> (TypeScript notation for an array of <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Multikey"><code>Multikey</code></a>) type.</p><p>By the way, why are there two properties in the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Person"><code>Person</code></a> object that hold public keys, <code>publicKey</code> and <code>assertionMethods</code>? Originally in ActivityPub, there was only the <code>publicKey</code> property, but later the <code>assertionMethods</code> property was added to allow registration of multiple keys. Similar to how we generated both RSA-PKCS#1-v1.5 and Ed25519 keys earlier, we&#39;re setting both properties for compatibility with various software. If you look closely, you can see that we&#39;re only registering the RSA-PKCS#1-v1.5 key to the legacy <code>publicKey</code> property (the first item in the array is the RSA-PKCS#1-v1.5 key pair, and the second item is the Ed25519 key pair).</p><div><p>TIP</p><p>Actually, the <code>publicKey</code> property can contain multiple keys too. However, many software are already implemented under the assumption that the <code>publicKey</code> property will only contain one key, so they often malfunction. The <code>assertionMethods</code> property was proposed to avoid this.</p><p>For those interested in this, refer to the <a href="https://w3id.org/fep/521a" target="_blank" rel="noreferrer">FEP-521a</a> document.</p></div><h3 id="testing-2" tabindex="-1">Testing <a href="#testing-2" aria-label="Permalink to &#34;Testing&#34;">​</a></h3><p>Now that we&#39;ve registered the cryptographic keys to the actor object, let&#39;s check if it&#39;s working well. Query the actor with the following command:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>fedify</span><span> lookup</span><span> http://localhost:8000/users/johndoe</span></span></code></pre></div><p>If it&#39;s working correctly, you should see output like this:</p><div><p><span>console</span></p><pre tabindex="0"><code><span><span>✔ Looking up the object...</span></span>
<span><span>Person {</span></span>
<span><span>  id: URL &#34;http://localhost:8000/users/johndoe&#34;,</span></span>
<span><span>  name: &#34;John Doe&#34;,</span></span>
<span><span>  url: URL &#34;http://localhost:8000/users/johndoe&#34;,</span></span>
<span><span>  preferredUsername: &#34;johndoe&#34;,</span></span>
<span><span>  publicKey: CryptographicKey {</span></span>
<span><span>    id: URL &#34;http://localhost:8000/users/johndoe#main-key&#34;,</span></span>
<span><span>    owner: URL &#34;http://localhost:8000/users/johndoe&#34;,</span></span>
<span><span>    publicKey: CryptoKey {</span></span>
<span><span>      type: &#34;public&#34;,</span></span>
<span><span>      extractable: true,</span></span>
<span><span>      algorithm: {</span></span>
<span><span>        name: &#34;RSASSA-PKCS1-v1_5&#34;,</span></span>
<span><span>        modulusLength: 4096,</span></span>
<span><span>        publicExponent: Uint8Array(3) [ 1, 0, 1 ],</span></span>
<span><span>        hash: { name: &#34;SHA-256&#34; }</span></span>
<span><span>      },</span></span>
<span><span>      usages: [ &#34;verify&#34; ]</span></span>
<span><span>    }</span></span>
<span><span>  },</span></span>
<span><span>  assertionMethods: [</span></span>
<span><span>    Multikey {</span></span>
<span><span>      id: URL &#34;http://localhost:8000/users/johndoe#main-key&#34;,</span></span>
<span><span>      controller: URL &#34;http://localhost:8000/users/johndoe&#34;,</span></span>
<span><span>      publicKey: CryptoKey {</span></span>
<span><span>        type: &#34;public&#34;,</span></span>
<span><span>        extractable: true,</span></span>
<span><span>        algorithm: {</span></span>
<span><span>          name: &#34;RSASSA-PKCS1-v1_5&#34;,</span></span>
<span><span>          modulusLength: 4096,</span></span>
<span><span>          publicExponent: Uint8Array(3) [ 1, 0, 1 ],</span></span>
<span><span>          hash: { name: &#34;SHA-256&#34; }</span></span>
<span><span>        },</span></span>
<span><span>        usages: [ &#34;verify&#34; ]</span></span>
<span><span>      }</span></span>
<span><span>    },</span></span>
<span><span>    Multikey {</span></span>
<span><span>      id: URL &#34;http://localhost:8000/users/johndoe#key-2&#34;,</span></span>
<span><span>      controller: URL &#34;http://localhost:8000/users/johndoe&#34;,</span></span>
<span><span>      publicKey: CryptoKey {</span></span>
<span><span>        type: &#34;public&#34;,</span></span>
<span><span>        extractable: true,</span></span>
<span><span>        algorithm: { name: &#34;Ed25519&#34; },</span></span>
<span><span>        usages: [ &#34;verify&#34; ]</span></span>
<span><span>      }</span></span>
<span><span>    }</span></span>
<span><span>  ],</span></span>
<span><span>  inbox: URL &#34;http://localhost:8000/users/johndoe/inbox&#34;,</span></span>
<span><span>  endpoints: Endpoints { sharedInbox: URL &#34;http://localhost:8000/inbox&#34; }</span></span>
<span><span>}</span></span></code></pre></div><p>You can see that the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Person"><code>Person</code></a> object&#39;s <code>publicKey</code> property contains one <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/CryptographicKey"><code>CryptographicKey</code></a> object in RSA-PKCS#1-v1.5 type, and the <code>assertionMethods</code> property contains two <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Multikey"><code>Multikey</code></a> objects in RSA-PKCS#1-v1.5 and Ed25519 formats.</p><h2 id="interoperating-with-mastodon" tabindex="-1">Interoperating with Mastodon <a href="#interoperating-with-mastodon" aria-label="Permalink to &#34;Interoperating with Mastodon&#34;">​</a></h2><p>Now let&#39;s check if we can actually view the actor we&#39;ve created in Mastodon.</p><h3 id="exposing-to-the-public-internet" tabindex="-1">Exposing to the public internet <a href="#exposing-to-the-public-internet" aria-label="Permalink to &#34;Exposing to the public internet&#34;">​</a></h3><p>Unfortunately, the current server is only accessible locally. However, it would be inconvenient to deploy somewhere every time we modify the code for testing. Wouldn&#39;t it be great if we could expose our local server to the internet without deployment for immediate testing?</p><p>Here&#39;s where the <a href="https://ntietz.com/blog/cli#fedify-tunnel-exposing-a-local-http-server-to-the-public-internet"><code>fedify tunnel</code></a> command comes in handy. In a terminal, open a new tab and enter this command followed by the port number of your local server:</p><p>This creates a disposable domain name and relays to your local server. It will output a URL that&#39;s accessible from the outside:</p><div><p><span>console</span></p><pre tabindex="0"><code><span><span>✔ Your local server at 8000 is now publicly accessible:</span></span>
<span></span>
<span><span>https://temp-address.serveo.net/</span></span>
<span></span>
<span><span>Press ^C to close the tunnel.</span></span></code></pre></div><p>Of course, you&#39;ll see your own unique URL different from the one above. You can check if it&#39;s connecting well by opening <a href="https://temp-address.serveo.net/users/johndoe" target="_blank" rel="noreferrer">https://temp-address.serveo.net/users/johndoe</a> in your web browser (replace with your unique temporary domain):</p><p><img src="https://ntietz.com/assets/profile-page-2.ixKV_Uc_.png" alt="Profile page exposed to the public internet"/></p><p>Copy your fediverse handle shown on the above web page, then go into Mastodon and paste it into the search box in the upper left corner:</p><p><img src="https://ntietz.com/assets/search-results.BvVtwbw0.png" alt="Search results for the fediverse handle in Mastodon"/></p><p>If the actor we created appears in the search results as shown above, it&#39;s working correctly. You can also click on the actor&#39;s name in the search results to go to their profile page:</p><p><img src="https://ntietz.com/assets/remote-profile.C4GEH3OF.png" alt="Actor&#39;s profile viewed in Mastodon"/></p><p>But this is as far as we can go. Don&#39;t try to follow yet! For our actor to be followable from other servers, we need to implement an inbox.</p><div><p>NOTE</p><p>The <code>fedify tunnel</code> command automatically disconnects after a while if not used. When this happens, you need to press <kbd>Ctrl</kbd>+<kbd>C</kbd> to stop it, then run the <code>fedify tunnel 8000</code> command again to establish a new connection.</p></div><h2 id="inbox" tabindex="-1">Inbox <a href="#inbox" aria-label="Permalink to &#34;Inbox&#34;">​</a></h2><p>In ActivityPub, an inbox is an endpoint where an actor receives incoming activities from other actors. All actors have their own inbox, which is a URL that can receive activities via HTTP <code>POST</code> requests. When another actor sends a follow request, writes a post, comments, or performs any other interaction, the corresponding activity is delivered to the recipient&#39;s inbox. The server processes the activities that come into the inbox and responds appropriately, allowing it to communicate and function as part of the federated network.</p><p>For now, we&#39;ll start by implementing the reception of follow requests.</p><h3 id="table-creation-2" tabindex="-1">Table creation <a href="#table-creation-2" aria-label="Permalink to &#34;Table creation&#34;">​</a></h3><p>We need to create a <code>follows</code> table to hold the actors who follow you (followers) and the actors you follow (following). Add the following SQL to the <em>src/schema.sql</em> file:</p><div><p><span data-title="src/schema.sql">src/schema.sql</span></p><div><p><span>sql</span></p><pre tabindex="0"><code><span><span>CREATE</span><span> TABLE</span><span> IF</span><span> NOT</span><span> EXISTS</span><span> follows (</span></span>
<span><span>  following_id </span><span>INTEGER</span><span>          REFERENCES</span><span> actors (id),</span></span>
<span><span>  follower_id  </span><span>INTEGER</span><span>          REFERENCES</span><span> actors (id),</span></span>
<span><span>  created      </span><span>TEXT</span><span>    NOT NULL</span><span> DEFAULT</span><span> (CURRENT_TIMESTAMP)</span></span>
<span><span>                                CHECK</span><span> (created </span><span>&lt;&gt;</span><span> &#39;&#39;</span><span>),</span></span>
<span><span>  PRIMARY KEY</span><span> (following_id, follower_id)</span></span>
<span><span>);</span></span></code></pre></div></div><p>Let&#39;s create the <code>follows</code> table by executing <em>src/schema.sql</em> once again:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>sqlite3</span><span> microblog.sqlite3</span><span> &lt;</span><span> src/schema.sql</span></span></code></pre></div><p>Open the <em>src/schema.ts</em> file and define a type to represent records stored in the <code>follows</code> table in JavaScript:</p><div><p><span data-title="src/schema.ts">src/schema.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>export</span><span> interface</span><span> </span><span>Follow</span><span> {</span></span>
<span><span>  </span><span></span><span>:</span><span> number</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> number</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span>;</span></span>
<span><span>}</span></span></code></pre></div></div><h3 id="receiving-follow-activity" tabindex="-1">Receiving <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Follow"><code>Follow</code></a> activity <a href="#receiving-follow-activity" aria-label="Permalink to &#34;Receiving `Follow` activity&#34;">​</a></h3><p>Now it&#39;s time to implement the inbox. Actually, we&#39;ve already written the following code in the <em>src/federation.ts</em> file earlier:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/users/{identifier}/inbox&#34;</span><span>, </span><span>&#34;/inbox&#34;</span><span>);</span></span></code></pre></div></div><p>Before modifying this code, let&#39;s <code>import</code> the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Accept"><code>Accept</code></a> and <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Follow"><code>Follow</code></a> classes and the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/getActorHandle"><code>getActorHandle()</code></a> function provided by Fedify:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> {</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>} </span><span>from</span><span> &#34;@fedify/fedify&#34;</span><span>;</span></span></code></pre></div></div><p>Now let&#39;s modify the code calling the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Federation.setInboxListeners"><code>setInboxListeners()</code></a> method as follows:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span></span></span>
<span><span>  .</span><span></span><span>(</span><span>&#34;/users/{identifier}/inbox&#34;</span><span>, </span><span>&#34;/inbox&#34;</span><span>)</span></span>
<span><span>  .</span><span></span><span>(</span><span></span><span>, </span><span>async</span><span> (</span><span></span><span>, </span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    if</span><span> (</span><span></span><span>.</span><span></span><span> </span><span>==</span><span> null</span><span>) {</span></span>
<span><span>      </span><span></span><span>.</span><span></span><span>(</span><span>&#34;The Follow object does not have an object: {follow}&#34;</span><span>, {</span></span>
<span><span>        </span><span></span><span>,</span></span>
<span><span>      });</span></span>
<span><span>      return</span><span>;</span></span>
<span><span>    }</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>(</span><span></span><span>.</span><span></span><span>);</span></span>
<span><span>    if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span> ||</span><span> </span><span></span><span>.</span><span></span><span> </span><span>!==</span><span> &#34;actor&#34;</span><span>) {</span></span>
<span><span>      </span><span></span><span>.</span><span></span><span>(</span><span>&#34;The Follow object&#39;s object is not an actor: {follow}&#34;</span><span>, {</span></span>
<span><span>        </span><span></span><span>,</span></span>
<span><span>      });</span></span>
<span><span>      return</span><span>;</span></span>
<span><span>    }</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> await</span><span> </span><span></span><span>.</span><span></span><span>();</span></span>
<span><span>    if</span><span> (</span><span></span><span>?.</span><span></span><span> </span><span>==</span><span> null</span><span> ||</span><span> </span><span></span><span>.</span><span></span><span> </span><span>==</span><span> null</span><span>) {</span></span>
<span><span>      </span><span></span><span>.</span><span></span><span>(</span><span>&#34;The Follow object does not have an actor: {follow}&#34;</span><span>, {</span></span>
<span><span>        </span><span></span><span>,</span></span>
<span><span>      });</span></span>
<span><span>      return</span><span>;</span></span>
<span><span>    }</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>      .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>Actor</span><span>&gt;(</span></span>
<span><span>        `</span></span>
<span><span>        SELECT * FROM actors</span></span>
<span><span>        JOIN users ON users.id = actors.user_id</span></span>
<span><span>        WHERE users.username = ?</span></span>
<span><span>        `</span><span>,</span></span>
<span><span>      )</span></span>
<span><span>      .</span><span></span><span>(</span><span></span><span>.</span><span></span><span>)?.</span><span></span><span>;</span></span>
<span><span>    if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) {</span></span>
<span><span>      </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>        &#34;Failed to find the actor to follow in the database: {object}&#34;</span><span>,</span></span>
<span><span>        { </span><span></span><span> },</span></span>
<span><span>      );</span></span>
<span><span>    }</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>      .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>Actor</span><span>&gt;(</span></span>
<span><span>        `</span></span>
<span><span>        -- Add a new follower actor record or update if it already exists</span></span>
<span><span>        INSERT INTO actors (uri, handle, name, inbox_url, shared_inbox_url, url)</span></span>
<span><span>        VALUES (?, ?, ?, ?, ?, ?)</span></span>
<span><span>        ON CONFLICT (uri) DO UPDATE SET</span></span>
<span><span>          handle = excluded.handle,</span></span>
<span><span>          name = excluded.name,</span></span>
<span><span>          inbox_url = excluded.inbox_url,</span></span>
<span><span>          shared_inbox_url = excluded.shared_inbox_url,</span></span>
<span><span>          url = excluded.url</span></span>
<span><span>        WHERE</span></span>
<span><span>          actors.uri = excluded.uri</span></span>
<span><span>        RETURNING *</span></span>
<span><span>        `</span><span>,</span></span>
<span><span>      )</span></span>
<span><span>      .</span><span></span><span>(</span></span>
<span><span>        </span><span></span><span>.</span><span></span><span>.</span><span></span><span>,</span></span>
<span><span>        await</span><span> </span><span></span><span>(</span><span></span><span>),</span></span>
<span><span>        </span><span></span><span>.</span><span></span><span>?.</span><span></span><span>(),</span></span>
<span><span>        </span><span></span><span>.</span><span></span><span>.</span><span></span><span>,</span></span>
<span><span>        </span><span></span><span>.</span><span></span><span>?.</span><span></span><span>?.</span><span></span><span>,</span></span>
<span><span>        </span><span></span><span>.</span><span></span><span>?.</span><span></span><span>,</span></span>
<span><span>      )?.</span><span></span><span>;</span></span>
<span><span>    </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>      &#34;INSERT INTO follows (following_id, follower_id) VALUES (?, ?)&#34;</span><span>,</span></span>
<span><span>    ).</span><span></span><span>(</span><span></span><span>, </span><span></span><span>);</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> new</span><span> </span><span></span><span>({</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>.</span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>.</span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>,</span></span>
<span><span>    });</span></span>
<span><span>    await</span><span> </span><span></span><span>.</span><span></span><span>(</span><span></span><span>, </span><span></span><span>, </span><span></span><span>);</span></span>
<span><span>  });</span></span></code></pre></div></div><p>Let&#39;s examine the code carefully. The <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/InboxListenerSetters.on"><code>on()</code></a> method defines the action to take when a specific type of activity is received. Here, we&#39;ve written code to record the follower information in the database when a <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Follow"><code>Follow</code></a> activity is received, and then send an <code>Accept(Follow)</code> activity back to the actor who sent the follow request.</p><p>The <code>follow.objectId</code> should contain the URI of the actor being followed. We use the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Context.parseUri"><code>parseUri()</code></a> method to check if the URI inside it points to the actor we created.</p><p>The <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/getActorHandle"><code>getActorHandle()</code></a> function returns the fediverse handle as a string from the given actor object.</p><p>If there&#39;s no information about the actor who sent the follow request in the <code>actors</code> table yet, we first add a record. If a record already exists, we update it with the latest data. Then, we add the follower to the <code>follows</code> table.</p><p>Once the record is completed in the database, we use the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Context.sendActivity"><code>sendActivity()</code></a> method to send an <code>Accept(Follow)</code> activity as a reply to the actor who sent the activity. It takes the sender as the first parameter, the recipient as the second parameter, and the activity object to send as the third parameter.</p><h3 id="activitypub-academy" tabindex="-1">ActivityPub.Academy <a href="#activitypub-academy" aria-label="Permalink to &#34;ActivityPub.Academy&#34;">​</a></h3><p>Now it&#39;s time to check if follow requests are being received properly.</p><p>While it would be fine to test from a regular Mastodon server, let&#39;s use the <a href="https://activitypub.academy/" target="_blank" rel="noreferrer">ActivityPub.Academy</a> server, which allows us to see exactly how activities are exchanged. ActivityPub.Academy is a special Mastodon server for education and debugging purposes, where you can easily create temporary accounts with just one click.</p><p><img src="https://ntietz.com/assets/academy.BEfymNOt.jpg" alt="ActivityPub.Academy homepage"/></p><p>After agreeing to the privacy policy, click the <em>Sign Up</em> button to create a new account. The created account will have a randomly generated name and handle, and will disappear on its own after a day. Instead, you can create new accounts as many times as you want.</p><p>Once you&#39;re logged in, paste the handle of the actor we created into the search box in the top left corner of the screen:</p><p><img src="https://ntietz.com/assets/academy-search-results.BRfKsJiB.png" alt="Search results for our actor&#39;s handle on ActivityPub.Academy"/></p><p>If our actor appears in the search results, click the follow button on the right to send a follow request. Then click on <em>Activity Log</em> in the right menu:</p><p><img src="https://ntietz.com/assets/activity-log.Dm59VnxS.png" alt="ActivityPub.Academy&#39;s Activity Log"/></p><p>You&#39;ll see an indication that a <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Follow"><code>Follow</code></a> activity was sent from the ActivityPub.Academy server to the inbox of the actor we created by clicking the follow button just now. You can see the contents of the activity by clicking <em>show source</em> in the bottom right:</p><p><img src="https://ntietz.com/assets/activity-log-2.Bsel8qEA.png" alt="Activity Log screen after clicking show source"/></p><h3 id="testing-3" tabindex="-1">Testing <a href="#testing-3" aria-label="Permalink to &#34;Testing&#34;">​</a></h3><p>Now that we&#39;ve confirmed that the activity was sent well, it&#39;s time to check if our inbox code is working properly. First, let&#39;s see if a record was created properly in the <code>follows</code> table:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>echo</span><span> &#34;SELECT * FROM follows;&#34;</span><span> |</span><span> sqlite3</span><span> -table</span><span> microblog.sqlite3</span></span></code></pre></div><p>If the follow request was processed successfully, you should see a result like this (of course, the time will be different):</p><table tabindex="0"><thead><tr><th><code>following_id</code></th><th><code>follower_id</code></th><th><code>created</code></th></tr></thead><tbody><tr><td><code>1</code></td><td><code>2</code></td><td><code>2024-09-01 10:19:41</code></td></tr></tbody></table><p>Let&#39;s also check if a new record was created in the <code>actors</code> table:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>echo</span><span> &#34;SELECT * FROM actors WHERE id &gt; 1;&#34;</span><span> |</span><span> sqlite3</span><span> -table</span><span> microblog.sqlite3</span></span></code></pre></div><table tabindex="0"><thead><tr><th><code>id</code></th><th><code>user_id</code></th><th><code>uri</code></th><th><code>handle</code></th><th><code>name</code></th><th><code>inbox_url</code></th><th><code>shared_inbox_url</code></th><th><code>url</code></th><th><code>created</code></th></tr></thead><tbody><tr><td><code>2</code></td><td></td><td><code>https://activitypub.academy/users/dobussia_dovornath</code></td><td><code>@dobussia_dovornath@activitypub.academy</code></td><td><code>Dobussia Dovornath</code></td><td><code>https://activitypub.academy/users/dobussia_dovornath/inbox</code></td><td><code>https://activitypub.academy/inbox</code></td><td><code>https://activitypub.academy/@dobussia_dovornath</code></td><td><code>2024-09-01 10:19:41</code></td></tr></tbody></table><p>Now, let&#39;s look at ActivityPub.Academy&#39;s <em>Activity Log</em> again. If the <code>Accept(Follow)</code> activity sent by our actor arrived well, it should be displayed as follows:</p><p><img src="https://ntietz.com/assets/activity-log-3.CK83vz3Y.png" alt="Accept(Follow) activity displayed in Activity Log"/></p><p>This way, you&#39;ve implemented your first interaction via ActivityPub!</p><h2 id="unfollow" tabindex="-1">Unfollow <a href="#unfollow" aria-label="Permalink to &#34;Unfollow&#34;">​</a></h2><p>What happens if an actor from another server unfollows our actor after following it? Let&#39;s test this in <a href="https://activitypub.academy/" target="_blank" rel="noreferrer">ActivityPub.Academy</a>. As before, enter our actor&#39;s fediverse handle in the ActivityPub.Academy search box:</p><p><img src="https://ntietz.com/assets/academy-search-results-2.UVqR0fdO.png" alt="Search results in ActivityPub.Academy"/></p><p>If you look closely, you&#39;ll see an unfollow button in place of the follow button to the right of the actor name. Click this button to unfollow, then go to the <em>Activity Log</em> to see what activity is sent:</p><p><img src="https://ntietz.com/assets/activity-log-4.C2MQmf8S.png" alt="Activity Log showing the sent Undo(Follow) activity"/></p><p>As you can see, an <code>Undo(Follow)</code> activity has been sent. If you click <em>show source</em> in the bottom right, you can see the detailed contents of the activity:</p><div><p><span>json</span></p><pre tabindex="0"><code><span><span>{</span></span>
<span><span>  &#34;@context&#34;</span><span>: </span><span>&#34;https://www.w3.org/ns/activitystreams&#34;</span><span>,</span></span>
<span><span>  &#34;id&#34;</span><span>: </span><span>&#34;https://activitypub.academy/users/dobussia_dovornath#follows/3283/undo&#34;</span><span>,</span></span>
<span><span>  &#34;type&#34;</span><span>: </span><span>&#34;Undo&#34;</span><span>,</span></span>
<span><span>  &#34;actor&#34;</span><span>: </span><span>&#34;https://activitypub.academy/users/dobussia_dovornath&#34;</span><span>,</span></span>
<span><span>  &#34;object&#34;</span><span>: {</span></span>
<span><span>    &#34;id&#34;</span><span>: </span><span>&#34;https://activitypub.academy/98b131b8-89ea-49ba-b2bd-3ee0f5a87694&#34;</span><span>,</span></span>
<span><span>    &#34;type&#34;</span><span>: </span><span>&#34;Follow&#34;</span><span>,</span></span>
<span><span>    &#34;actor&#34;</span><span>: </span><span>&#34;https://activitypub.academy/users/dobussia_dovornath&#34;</span><span>,</span></span>
<span><span>    &#34;object&#34;</span><span>: </span><span>&#34;https://temp-address.serveo.net/users/johndoe&#34;</span></span>
<span><span>  }</span></span>
<span><span>}</span></span></code></pre></div><p>Looking at this JSON object, you can see that the <code>Undo(Follow)</code> activity includes the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Follow"><code>Follow</code></a> activity that was received by our inbox earlier. However, since we haven&#39;t defined any behavior for when the inbox receives an <code>Undo(Follow)</code> activity, nothing has happened.</p><h3 id="receiving-undo-follow-activity" tabindex="-1">Receiving <code>Undo(Follow)</code> Activity <a href="#receiving-undo-follow-activity" aria-label="Permalink to &#34;Receiving `Undo(Follow)` Activity&#34;">​</a></h3><p>To implement unfollow, open the <em>src/federation.ts</em> file and <code>import</code> the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Undo"><code>Undo</code></a> class provided by Fedify:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> {</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,  </span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>} </span><span>from</span><span> &#34;@fedify/fedify&#34;</span><span>;</span></span></code></pre></div></div><p>Then add <code>on(Undo, ...)</code> in succession after <code>on(Follow, ...)</code>:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span></span></span>
<span><span>  .</span><span></span><span>(</span><span>&#34;/users/{identifier}/inbox&#34;</span><span>, </span><span>&#34;/inbox&#34;</span><span>)</span></span>
<span><span>  .</span><span></span><span>(</span><span></span><span>, </span><span>async</span><span> (</span><span></span><span>, </span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    // ... omitted ...</span></span>
<span><span>  })</span></span>
<span><span>  .</span><span></span><span>(</span><span></span><span>, </span><span>async</span><span> (</span><span></span><span>, </span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> await</span><span> </span><span></span><span>.</span><span></span><span>();</span></span>
<span><span>    if</span><span> (</span><span>!</span><span>(</span><span></span><span> </span><span>instanceof</span><span> </span><span></span><span>)) </span><span>return</span><span>;</span></span>
<span><span>    if</span><span> (</span><span></span><span>.</span><span></span><span> </span><span>==</span><span> null</span><span> ||</span><span> </span><span></span><span>.</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span>;</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>(</span><span></span><span>.</span><span></span><span>);</span></span>
<span><span>    if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span> ||</span><span> </span><span></span><span>.</span><span></span><span> </span><span>!==</span><span> &#34;actor&#34;</span><span>) </span><span>return</span><span>;</span></span>
<span><span>    </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>      `</span></span>
<span><span>      DELETE FROM follows</span></span>
<span><span>      WHERE following_id = (</span></span>
<span><span>        SELECT actors.id</span></span>
<span><span>        FROM actors</span></span>
<span><span>        JOIN users ON actors.user_id = users.id</span></span>
<span><span>        WHERE users.username = ?</span></span>
<span><span>      ) AND follower_id = (SELECT id FROM actors WHERE uri = ?)</span></span>
<span><span>      `</span><span>,</span></span>
<span><span>    ).</span><span></span><span>(</span><span></span><span>.</span><span></span><span>, </span><span></span><span>.</span><span></span><span>.</span><span></span><span>);</span></span>
<span><span>  });</span></span></code></pre></div></div><p>This time, the code is shorter than when processing follow requests. It checks if the thing inside the <code>Undo(Follow)</code> activity is a <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Follow"><code>Follow</code></a> activity, uses the <code>parseUri()</code> method to check if the follow target of the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Follow"><code>Follow</code></a> activity to be canceled is our actor, and then deletes the corresponding record from the <code>follows</code> table.</p><h3 id="testing-4" tabindex="-1">Testing <a href="#testing-4" aria-label="Permalink to &#34;Testing&#34;">​</a></h3><p>We can&#39;t unfollow once more since we already clicked the unfollow button in <a href="https://activitypub.academy/" target="_blank" rel="noreferrer">ActivityPub.Academy</a> earlier. We&#39;ll have to follow again and then unfollow to test. But before that, we need to empty the <code>follows</code> table. Otherwise, there will be an error when the follow request comes in because the record already exists.</p><p>Let&#39;s empty the <code>follows</code> table using the <code>sqlite3</code> command:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>echo</span><span> &#34;DELETE FROM follows;&#34;</span><span> |</span><span> sqlite3</span><span> microblog.sqlite3</span></span></code></pre></div><p>Now press the follow button again, then check the database:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>echo</span><span> &#34;SELECT * FROM follows;&#34;</span><span> |</span><span> sqlite3</span><span> -table</span><span> microblog.sqlite3</span></span></code></pre></div><p>If the follow request was processed successfully, you should see a result like this:</p><table tabindex="0"><thead><tr><th><code>following_id</code></th><th><code>follower_id</code></th><th><code>created</code></th></tr></thead><tbody><tr><td><code>1</code></td><td><code>2</code></td><td><code>2024-09-02 01:05:17</code></td></tr></tbody></table><p>Now press the unfollow button again, then check the database one more time:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>echo</span><span> &#34;SELECT count(*) FROM follows;&#34;</span><span> |</span><span> sqlite3</span><span> -table</span><span> microblog.sqlite3</span></span></code></pre></div><p>If the unfollow request was processed successfully, the record should have disappeared, so you should see a result like this:</p><table tabindex="0"><thead><tr><th><code>count(*)</code></th></tr></thead><tbody><tr><td><code>0</code></td></tr></tbody></table><h2 id="followers-list" tabindex="-1">Followers list <a href="#followers-list" aria-label="Permalink to &#34;Followers list&#34;">​</a></h2><p>It&#39;s cumbersome to view the followers list using the <code>sqlite3</code> command every time, so let&#39;s make it possible to view the followers list on the web.</p><p>Let&#39;s start by adding a new component to the <em>src/views.tsx</em> file. First, <code>import</code> the <code>Actor</code> type:</p><div><p><span data-title="src/views.tsx">src/views.tsx</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> type</span><span> { </span><span></span><span> } </span><span>from</span><span> &#34;./schema.ts&#34;</span><span>;</span></span></code></pre></div></div><p>Then define the <code>&lt;FollowerList&gt;</code> component and the <code>&lt;ActorLink&gt;</code> component:</p><div><p><span data-title="src/views.tsx">src/views.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span>export</span><span> interface</span><span> </span><span>FollowerListProps</span><span> {</span></span>
<span><span>  </span><span></span><span>:</span><span> </span><span>Actor</span><span>[];</span></span>
<span><span>}</span></span>
<span></span>
<span><span>export</span><span> const</span><span> </span><span></span><span>:</span><span> </span><span></span><span>&lt;</span><span>FollowerListProps</span><span>&gt; </span><span>=</span><span> ({ </span><span></span><span> }) </span><span>=&gt;</span><span> (</span></span>
<span><span>  &lt;&gt;</span></span>
<span><span>    &lt;</span><span></span><span>&gt;Followers&lt;/</span><span></span><span>&gt;</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      {</span><span></span><span>.</span><span></span><span>((</span><span></span><span>) </span><span>=&gt;</span><span> (</span></span>
<span><span>        &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span>}&gt;</span></span>
<span><span>          &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>} /&gt;</span></span>
<span><span>        &lt;/</span><span></span><span>&gt;</span></span>
<span><span>      ))}</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;</span></span>
<span><span>  &lt;/&gt;</span></span>
<span><span>);</span></span>
<span></span>
<span><span>export</span><span> interface</span><span> </span><span>ActorLinkProps</span><span> {</span></span>
<span><span>  </span><span></span><span>:</span><span> </span><span>Actor</span><span>;</span></span>
<span><span>}</span></span>
<span></span>
<span><span>export</span><span> const</span><span> </span><span></span><span>:</span><span> </span><span></span><span>&lt;</span><span>ActorLinkProps</span><span>&gt; </span><span>=</span><span> ({ </span><span></span><span> }) </span><span>=&gt;</span><span> {</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span> </span><span>??</span><span> </span><span></span><span>.</span><span></span><span>;</span></span>
<span><span>  return</span><span> </span><span></span><span>.</span><span></span><span> </span><span>==</span><span> null</span><span> ?</span><span> (</span></span>
<span><span>    &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>} </span><span></span><span>=</span><span>&#34;secondary&#34;</span><span>&gt;</span></span>
<span><span>      {</span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;</span></span>
<span><span>  ) </span><span>:</span><span> (</span></span>
<span><span>    &lt;&gt;</span></span>
<span><span>      &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>}&gt;{</span><span></span><span>.</span><span></span><span>}&lt;/</span><span></span><span>&gt;{</span><span>&#34; &#34;</span><span>}</span></span>
<span><span>      &lt;</span><span></span><span>&gt;</span></span>
<span><span>        (</span></span>
<span><span>        &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>} </span><span></span><span>=</span><span>&#34;secondary&#34;</span><span>&gt;</span></span>
<span><span>          {</span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>        &lt;/</span><span></span><span>&gt;</span></span>
<span><span>        )</span></span>
<span><span>      &lt;/</span><span></span><span>&gt;</span></span>
<span><span>    &lt;/&gt;</span></span>
<span><span>  );</span></span>
<span><span>};</span></span></code></pre></div></div><p>The <code>&lt;ActorLink&gt;</code> component is used to represent a single actor, and the <code>&lt;FollowerList&gt;</code> component uses the <code>&lt;ActorLink&gt;</code> component to represent the list of followers. As you can see, since <abbr title="JavaScript XML">JSX</abbr> doesn&#39;t have conditional statements or loops, we&#39;re using the ternary operator and the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map" target="_blank" rel="noreferrer"><code>Array.map()</code></a> method.</p><p>Now let&#39;s create an endpoint to display the followers list. Open the <em>src/app.tsx</em> file and <code>import</code> the <code>&lt;FollowerList&gt;</code> component:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> { </span><span></span><span>, </span><span></span><span>, </span><span></span><span>, </span><span></span><span> } </span><span>from</span><span> &#34;./views.tsx&#34;</span><span>;</span></span></code></pre></div></div><p>Then add a request handler for <code>GET /users/{username}/followers</code>:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/users/:username/followers&#34;</span><span>, </span><span>async</span><span> (</span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>    .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>Actor</span><span>&gt;(</span></span>
<span><span>      `</span></span>
<span><span>      SELECT followers.*</span></span>
<span><span>      FROM follows</span></span>
<span><span>      JOIN actors AS followers ON follows.follower_id = followers.id</span></span>
<span><span>      JOIN actors AS following ON follows.following_id = following.id</span></span>
<span><span>      JOIN users ON users.id = following.user_id</span></span>
<span><span>      WHERE users.username = ?</span></span>
<span><span>      ORDER BY follows.created DESC</span></span>
<span><span>      `</span><span>,</span></span>
<span><span>    )</span></span>
<span><span>    .</span><span></span><span>(</span><span></span><span>.</span><span></span><span>.</span><span></span><span>(</span><span>&#34;username&#34;</span><span>));</span></span>
<span><span>  return</span><span> </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>} /&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;,</span></span>
<span><span>  );</span></span>
<span><span>});</span></span></code></pre></div></div><p>Now, shall we check if it&#39;s displaying correctly? There should be followers, so with <code>fedify tunnel</code> running, follow our actor from another Mastodon server or <a href="https://activitypub.academy/" target="_blank" rel="noreferrer">ActivityPub.Academy</a>. After the follow request is accepted, open the <a href="http://localhost:8000/users/johndoe/followers" target="_blank" rel="noreferrer">http://localhost:8000/users/johndoe/followers</a> page in your web browser, and you should see something like this:</p><p><img src="https://ntietz.com/assets/followers-list.CFBaVYQj.png" alt="Followers list page"/></p><p>Now that we&#39;ve created the followers list, it would be nice to display the number of followers on the profile page as well. Open the <em>src/views.tsx</em> file again and modify the <code>&lt;Profile&gt;</code> component as follows:</p><div><p><span data-title="src/views.tsx">src/views.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span>export</span><span> interface</span><span> </span><span>ProfileProps</span><span> {</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span>;   </span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> number</span><span>;  </span></span>
<span><span>}</span></span>
<span></span>
<span><span>export</span><span> const</span><span> </span><span></span><span>:</span><span> </span><span></span><span>&lt;</span><span>ProfileProps</span><span>&gt; </span><span>=</span><span> ({</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,   </span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,  </span></span>
<span><span>}) </span><span>=&gt;</span><span> (</span></span>
<span><span>  &lt;&gt;</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span>&gt;</span></span>
<span><span>        &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span>`/users/${</span><span></span><span>}`</span><span>}&gt;{</span><span></span><span>}&lt;/</span><span></span><span>&gt;</span></span>
<span><span>      &lt;/</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span>&gt;</span></span>
<span><span>        &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;user-select: all;&#34;</span><span>&gt;{</span><span></span><span>}&lt;/</span><span></span><span>&gt; </span><span>&amp;middot;</span><span>{</span><span>&#34; &#34;</span><span>}</span></span>
<span><span>        &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span>`/users/${</span><span></span><span>}/followers`</span><span>}&gt;</span></span>
<span><span>          {</span><span></span><span> </span><span>===</span><span> 1</span><span> ?</span><span> &#34;1 follower&#34;</span><span> :</span><span> `${</span><span></span><span>} followers`</span><span>}</span></span>
<span><span>        &lt;/</span><span></span><span>&gt;</span></span>
<span><span>      &lt;/</span><span></span><span>&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;</span></span>
<span><span>  &lt;/&gt;</span></span>
<span><span>);</span></span></code></pre></div></div><p>Two props have been added to <code>ProfileProps</code>. <code>followers</code> is a prop that holds the number of followers, as the name suggests. <code>username</code> receives the username that will go into the URL to link to the followers list.</p><p>Now go back to the <em>src/app.tsx</em> file and modify the <code>GET /users/{username}</code> request handler as follows:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/users/:username&#34;</span><span>, </span><span>async</span><span> (</span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  // ... omitted ...</span></span>
<span><span>  if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span> </span><span></span><span>.</span><span></span><span>();</span></span>
<span></span>
<span><span>  // biome-ignore lint/style/noNonNullAssertion: Always returns a single record</span></span>
<span><span>  const</span><span> { </span><span></span><span> } </span><span>=</span><span> </span><span></span></span>
<span><span>    .</span><span></span><span>&lt;</span><span>unknown</span><span>[], { </span><span></span><span>:</span><span> number</span><span> }&gt;(</span></span>
<span><span>      `</span></span>
<span><span>      SELECT count(*) AS followers</span></span>
<span><span>      FROM follows</span></span>
<span><span>      JOIN actors ON follows.following_id = actors.id</span></span>
<span><span>      WHERE actors.user_id = ?</span></span>
<span><span>      `</span><span>,</span></span>
<span><span>    )</span></span>
<span><span>    .</span><span></span><span>(</span><span></span><span>.</span><span></span><span>)</span><span>!</span><span>;</span></span>
<span><span>  // ... omitted ...</span></span>
<span><span>  return</span><span> </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span></span>
<span><span>        </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span> </span><span>??</span><span> </span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>        </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>        </span><span></span><span>=</span><span>{</span><span></span><span>}</span></span>
<span><span>        </span><span></span><span>=</span><span>{</span><span></span><span>}</span></span>
<span><span>      /&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;,</span></span>
<span><span>  );</span></span>
<span><span>});</span></span></code></pre></div></div><p>SQL that counts the number of records in the <code>follows</code> table in the database has been added. Now, let&#39;s check the changed profile page. When you open the <a href="http://localhost:8000/users/johndoe" target="_blank" rel="noreferrer">http://localhost:8000/users/johndoe</a> page in your web browser, you should see something like this:</p><p><img src="https://ntietz.com/assets/profile-page-3.Bz3NK0AA.png" alt="Changed profile page"/></p><h2 id="followers-collection" tabindex="-1">Followers collection <a href="#followers-collection" aria-label="Permalink to &#34;Followers collection&#34;">​</a></h2><p>However, there&#39;s one problem. Let&#39;s look up our actor from a Mastodon server that is <em>not</em> ActivityPub.Academy. (You know how to look it up, right? With the server exposed to the public internet, enter the actor&#39;s handle in the Mastodon search box.) When you view our actor&#39;s profile in Mastodon, you might notice something strange:</p><p><img src="https://ntietz.com/assets/remote-profile-2.havFcOBx.png" alt="Our actor&#39;s profile viewed in Mastodon"/></p><p>The number of followers is shown as 0. This is because our actor is not exposing the followers list via ActivityPub. To expose the followers list in ActivityPub, we need to define a followers collection.</p><p>Open the <em>src/federation.ts</em> file and <code>import</code> the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Recipient"><code>Recipient</code></a> type provided by Fedify:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> {</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  type</span><span> </span><span>Recipient</span><span>,  </span></span>
<span><span>} </span><span>from</span><span> &#34;@fedify/fedify&#34;</span><span>;</span></span></code></pre></div></div><p>Then add a followers collection dispatcher at the bottom:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span></span></span>
<span><span>  .</span><span></span><span>(</span></span>
<span><span>    &#34;/users/{identifier}/followers&#34;</span><span>,</span></span>
<span><span>    (</span><span></span><span>, </span><span></span><span>, </span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>      const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>        .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>Actor</span><span>&gt;(</span></span>
<span><span>          `</span></span>
<span><span>          SELECT followers.*</span></span>
<span><span>          FROM follows</span></span>
<span><span>          JOIN actors AS followers ON follows.follower_id = followers.id</span></span>
<span><span>          JOIN actors AS following ON follows.following_id = following.id</span></span>
<span><span>          JOIN users ON users.id = following.user_id</span></span>
<span><span>          WHERE users.username = ?</span></span>
<span><span>          ORDER BY follows.created DESC</span></span>
<span><span>          `</span><span>,</span></span>
<span><span>        )</span></span>
<span><span>        .</span><span></span><span>(</span><span></span><span>);</span></span>
<span><span>      const</span><span> </span><span></span><span>:</span><span> </span><span>Recipient</span><span>[] </span><span>=</span><span> </span><span></span><span>.</span><span></span><span>((</span><span></span><span>) </span><span>=&gt;</span><span> ({</span></span>
<span><span>        </span><span></span><span>: </span><span>new</span><span> </span><span></span><span>(</span><span></span><span>.</span><span></span><span>),</span></span>
<span><span>        </span><span></span><span>: </span><span>new</span><span> </span><span></span><span>(</span><span></span><span>.</span><span></span><span>),</span></span>
<span><span>        </span><span></span><span>:</span></span>
<span><span>          </span><span></span><span>.</span><span></span><span> </span><span>==</span><span> null</span></span>
<span><span>            ?</span><span> null</span></span>
<span><span>            :</span><span> { </span><span></span><span>: </span><span>new</span><span> </span><span></span><span>(</span><span></span><span>.</span><span></span><span>) },</span></span>
<span><span>      }));</span></span>
<span><span>      return</span><span> { </span><span></span><span> };</span></span>
<span><span>    },</span></span>
<span><span>  )</span></span>
<span><span>  .</span><span></span><span>((</span><span></span><span>, </span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>      .</span><span></span><span>&lt;</span><span>unknown</span><span>[], { </span><span></span><span>:</span><span> number</span><span> }&gt;(</span></span>
<span><span>        `</span></span>
<span><span>        SELECT count(*) AS cnt</span></span>
<span><span>        FROM follows</span></span>
<span><span>        JOIN actors ON actors.id = follows.following_id</span></span>
<span><span>        JOIN users ON users.id = actors.user_id</span></span>
<span><span>        WHERE users.username = ?</span></span>
<span><span>        `</span><span>,</span></span>
<span><span>      )</span></span>
<span><span>      .</span><span></span><span>(</span><span></span><span>);</span></span>
<span><span>    return</span><span> </span><span></span><span> </span><span>==</span><span> null</span><span> ?</span><span> 0</span><span> :</span><span> </span><span></span><span>.</span><span></span><span>;</span></span>
<span><span>  });</span></span></code></pre></div></div><p>The <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Federation.setFollowersDispatcher"><code>setFollowersDispatcher()</code></a> method creates a followers collection object to respond to when a <code>GET /users/{identifier}/followers</code> request comes in. Although the SQL is a bit long, it essentially gets the list of actors following the actor with the <code>identifier</code> parameter. The <code>items</code> contains <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Recipient"><code>Recipient</code></a> objects, and the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Recipient"><code>Recipient</code></a> type looks like this:</p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>export</span><span> interface</span><span> </span><span>Recipient</span><span> {</span></span>
<span><span>  readonly</span><span> </span><span></span><span>:</span><span> </span><span>URL</span><span> |</span><span> null</span><span>;</span></span>
<span><span>  readonly</span><span> </span><span></span><span>:</span><span> </span><span>URL</span><span> |</span><span> null</span><span>;</span></span>
<span><span>  readonly</span><span> </span><span></span><span>?:</span><span> {</span></span>
<span><span>    </span><span></span><span>:</span><span> </span><span>URL</span><span> |</span><span> null</span><span>;</span></span>
<span><span>  } </span><span>|</span><span> null</span><span>;</span></span>
<span><span>}</span></span></code></pre></div><p>The <code>id</code> property contains the actor&#39;s unique IRI, and <code>inboxId</code> contains the URL of the actor&#39;s personal inbox. <code>endpoints.sharedInbox</code> contains the URL of the actor&#39;s shared inbox. Since we have all that information in our <code>actors</code> table, we can fill the <code>items</code> array with that information.</p><p>The <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/CollectionCallbackSetters.setCounter"><code>setCounter()</code></a> method gets the total number of the followers collection. Here too, the SQL is a bit complex, but in summary, it&#39;s counting the number of actors following the actor with the <code>identifier</code> parameter.</p><p>Now, let&#39;s check if the followers collection is working properly by using the <code>fedify lookup</code> command:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>fedify</span><span> lookup</span><span> http://localhost:8000/users/johndoe/followers</span></span></code></pre></div><p>If implemented correctly, you should see a result like this:</p><div><p><span>console</span></p><pre tabindex="0"><code><span><span>✔ Looking up the object...</span></span>
<span><span>OrderedCollection {</span></span>
<span><span>  totalItems: 1,</span></span>
<span><span>  items: [ URL &#34;https://activitypub.academy/users/dobussia_dovornath&#34; ]</span></span>
<span><span>}</span></span></code></pre></div><p>However, just creating a followers collection like this doesn&#39;t let other servers know where the followers collection is. So we need to link to the followers collection in the actor dispatcher:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span></span></span>
<span><span>  .</span><span></span><span>(</span><span>&#34;/users/{identifier}&#34;</span><span>, </span><span>async</span><span> (</span><span></span><span>, </span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    // ... omitted ...</span></span>
<span><span>    return</span><span> new</span><span> </span><span></span><span>({</span></span>
<span><span>      // ... omitted ...</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>.</span><span></span><span>(</span><span></span><span>),  </span></span>
<span><span>    });</span></span>
<span><span>  })</span></span></code></pre></div></div><p>Let&#39;s look up the actor with <code>fedify lookup</code> again:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>fedify</span><span> lookup</span><span> http://localhost:8000/users/johndoe</span></span></code></pre></div><p>If you see a <code>&#34;followers&#34;</code> property included in the result as shown below, it&#39;s correct:</p><div><p><span>console</span></p><pre tabindex="0"><code><span><span>✔ Looking up the object...</span></span>
<span><span>Person {</span></span>
<span><span>  ... omitted ...</span></span>
<span><span>  inbox: URL &#34;http://localhost:8000/users/johndoe/inbox&#34;,</span></span>
<span><span>  followers: URL &#34;http://localhost:8000/users/johndoe/followers&#34;,</span></span>
<span><span>  endpoints: Endpoints { sharedInbox: URL &#34;http://localhost:8000/inbox&#34; }</span></span>
<span><span>}</span></span></code></pre></div><p>Now, let&#39;s look up our actor in Mastodon again. But the result might be a bit disappointing:</p><p><img src="https://ntietz.com/assets/remote-profile-2.havFcOBx.png" alt="Our actor&#39;s profile viewed again in Mastodon"/></p><p>The number of followers is still shown as 0. This is because Mastodon caches information about actors from other servers. There are ways to update this, but they&#39;re not as easy as pressing the <kbd>F5</kbd> key:</p><ul><li><p>One way is to wait for a week. Mastodon clears the cache that holds information about actors from other servers 7 days after the last update.</p></li><li><p>Another way is to send an <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Update"><code>Update</code></a> activity, but this requires tedious coding.</p></li><li><p>Or you could try looking it up from another Mastodon server where the cache hasn&#39;t been created yet.</p></li><li><p>The last method is to turn off and on <code>fedify tunnel</code> to get a new temporary domain assigned.</p></li></ul><p>If you want to see the correct number of followers displayed on another Mastodon server, try one of the methods I&#39;ve listed.</p><h2 id="posts" tabindex="-1">Posts <a href="#posts" aria-label="Permalink to &#34;Posts&#34;">​</a></h2><p>Now, it&#39;s finally time to implement posts. Unlike a typical blog, the microblog we&#39;re creating should be able to store posts created on other servers as well. Let&#39;s design with this in mind.</p><h3 id="table-creation-3" tabindex="-1">Table creation <a href="#table-creation-3" aria-label="Permalink to &#34;Table creation&#34;">​</a></h3><p>Let&#39;s start by creating a <code>posts</code> table. Open the <em>src/schema.sql</em> file and add the following SQL:</p><div><p><span data-title="src/schema.sql">src/schema.sql</span></p><div><p><span>sql</span></p><pre tabindex="0"><code><span><span>CREATE</span><span> TABLE</span><span> IF</span><span> NOT</span><span> EXISTS</span><span> posts (</span></span>
<span><span>  id       </span><span>INTEGER</span><span> NOT NULL</span><span> PRIMARY KEY</span><span>,</span></span>
<span><span>  uri      </span><span>TEXT</span><span>    NOT NULL</span><span> UNIQUE</span><span> CHECK</span><span> (uri </span><span>&lt;&gt;</span><span> &#39;&#39;</span><span>),</span></span>
<span><span>  actor_id </span><span>INTEGER</span><span> NOT NULL</span><span> REFERENCES</span><span> actors (id),</span></span>
<span><span>  content  </span><span>TEXT</span><span>    NOT NULL</span><span>,</span></span>
<span><span>  url</span><span>      TEXT</span><span>             CHECK</span><span> (</span><span>url</span><span> LIKE</span><span> &#39;https://%&#39;</span><span> OR</span><span> url</span><span> LIKE</span><span> &#39;http://%&#39;</span><span>),</span></span>
<span><span>  created  </span><span>TEXT</span><span>    NOT NULL</span><span> DEFAULT</span><span> (CURRENT_TIMESTAMP) </span><span>CHECK</span><span> (created </span><span>&lt;&gt;</span><span> &#39;&#39;</span><span>)</span></span>
<span><span>);</span></span></code></pre></div></div><ul><li><p>The <code>id</code> column is the primary key of the table.</p></li><li><p>The <code>uri</code> column holds the unique URI of the post. As mentioned earlier, all ActivityPub objects must have a unique URI.</p></li><li><p>The <code>actor_id</code> column points to the actor who wrote the post.</p></li><li><p>The <code>content</code> column contains the content of the post.</p></li><li><p>The <code>url</code> column contains the URL where the post is displayed in a web browser. There are cases where the URI of an ActivityPub object and the URL of the page displayed in a web browser match, but there are also cases where they don&#39;t, so a separate column is necessary. However, it can be empty.</p></li><li><p>The <code>created</code> column contains the time the post was created.</p></li></ul><p>Let&#39;s execute the SQL to create the <code>posts</code> table:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>sqlite3</span><span> microblog.sqlite3</span><span> &lt;</span><span> src/schema.sql</span></span></code></pre></div><p>Also define a <code>Post</code> type in the <em>src/schema.ts</em> file to represent records that will be stored in the <code>posts</code> table in JavaScript:</p><div><p><span data-title="src/schema.ts">src/schema.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>export</span><span> interface</span><span> </span><span>Post</span><span> {</span></span>
<span><span>  </span><span></span><span>:</span><span> number</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> number</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span> |</span><span> null</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span>;</span></span>
<span><span>}</span></span></code></pre></div></div><h3 id="home-page" tabindex="-1">Home page <a href="#home-page" aria-label="Permalink to &#34;Home page&#34;">​</a></h3><p>To write a post, there needs to be a form somewhere, right? Come to think of it, we haven&#39;t properly created the home page yet. Let&#39;s add a post creation form to the home page.</p><p>First, open the <em>src/views.tsx</em> file and <code>import</code> the <code>User</code> type:</p><div><p><span data-title="src/views.tsx">src/views.tsx</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> type</span><span> { </span><span></span><span>, </span><span></span><span> } </span><span>from</span><span> &#34;./schema.ts&#34;</span><span>;</span></span></code></pre></div></div><p>Then define the <code>&lt;Home&gt;</code> component:</p><div><p><span data-title="src/views.tsx">src/views.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span>export</span><span> interface</span><span> </span><span>HomeProps</span><span> {</span></span>
<span><span>  </span><span></span><span>:</span><span> </span><span>User</span><span> &amp;</span><span> </span><span>Actor</span><span>;</span></span>
<span><span>}</span></span>
<span></span>
<span><span>export</span><span> const</span><span> </span><span></span><span>:</span><span> </span><span></span><span>&lt;</span><span>HomeProps</span><span>&gt; </span><span>=</span><span> ({ </span><span></span><span> }) </span><span>=&gt;</span><span> (</span></span>
<span><span>  &lt;&gt;</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span>&gt;{</span><span></span><span>.</span><span></span><span>}&#39;s microblog&lt;/</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span>&gt;</span></span>
<span><span>        &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span>`/users/${</span><span></span><span>.</span><span></span><span>}`</span><span>}&gt;{</span><span></span><span>.</span><span></span><span>}&#39;s profile&lt;/</span><span></span><span>&gt;</span></span>
<span><span>      &lt;/</span><span></span><span>&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;</span></span>
<span><span>    &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;post&#34;</span><span> </span><span></span><span>=</span><span>{</span><span>`/users/${</span><span></span><span>.</span><span></span><span>}/posts`</span><span>}&gt;</span></span>
<span><span>      &lt;</span><span></span><span>&gt;</span></span>
<span><span>        &lt;</span><span></span><span>&gt;</span></span>
<span><span>          &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;content&#34;</span><span> </span><span></span><span>=</span><span>{</span><span>true</span><span>} </span><span></span><span>=</span><span>&#34;What&#39;s up?&#34;</span><span> /&gt;</span></span>
<span><span>        &lt;/</span><span></span><span>&gt;</span></span>
<span><span>      &lt;/</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;submit&#34;</span><span> </span><span></span><span>=</span><span>&#34;Post&#34;</span><span> /&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;</span></span>
<span><span>  &lt;/&gt;</span></span>
<span><span>);</span></span></code></pre></div></div><p>Then open the <em>src/app.tsx</em> file and <code>import</code> the <code>&lt;Home&gt;</code> component we just defined:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> { </span><span></span><span>, </span><span></span><span>, </span><span></span><span>, </span><span></span><span>, </span><span></span><span> } </span><span>from</span><span> &#34;./views.tsx&#34;</span><span>;</span></span></code></pre></div></div><p>And modify the existing <code>GET /</code> request handler:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/&#34;</span><span>, (</span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>    .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>User</span><span> &amp;</span><span> </span><span>Actor</span><span>&gt;(</span></span>
<span><span>      `</span></span>
<span><span>      SELECT users.*, actors.*</span></span>
<span><span>      FROM users</span></span>
<span><span>      JOIN actors ON users.id = actors.user_id</span></span>
<span><span>      LIMIT 1</span></span>
<span><span>      `</span><span>,</span></span>
<span><span>    )</span></span>
<span><span>    .</span><span></span><span>();</span></span>
<span><span>  if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;/setup&#34;</span><span>);</span></span>
<span></span>
<span><span>  return</span><span> </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>} /&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;,</span></span>
<span><span>  );</span></span>
<span><span>});</span></span></code></pre></div></div><p>If you&#39;ve done this much, let&#39;s check if the home page comes out well. When you open the <a href="http://localhost:8000/" target="_blank" rel="noreferrer">http://localhost:8000/</a> page in your web browser, you should see something like this:</p><p><img src="https://hackmd.io/_uploads/HJF35y7nR.png" alt="Home page"/></p><h3 id="record-insertion-1" tabindex="-1">Record insertion <a href="#record-insertion-1" aria-label="Permalink to &#34;Record insertion&#34;">​</a></h3><p>Now that we&#39;ve created the post creation form, we need code to actually save the post content to the <code>posts</code> table.</p><p>First, open the <em>src/federation.ts</em> file and <code>import</code> the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Note"><code>Note</code></a> class provided by Fedify:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> {</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,  </span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  type</span><span> </span><span>Recipient</span><span>,</span></span>
<span><span>} </span><span>from</span><span> &#34;@fedify/fedify&#34;</span><span>;</span></span></code></pre></div></div><p>Add the following code:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  &#34;/users/{identifier}/posts/{id}&#34;</span><span>,</span></span>
<span><span>  (</span><span></span><span>, </span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    return</span><span> null</span><span>;</span></span>
<span><span>  },</span></span>
<span><span>);</span></span></code></pre></div></div><p>This code doesn&#39;t do much yet, but it&#39;s needed to determine the permalink format of the posts. We&#39;ll implement it properly later.</p><p>In ActivityPub, the content of posts is exchanged in HTML format. Therefore, we need to convert the content received in plain text format to HTML format. At this time, we need the <em><a href="https://github.com/wooorm/stringify-entities" target="_blank" rel="noreferrer">stringify-entities</a></em> package to convert characters like <code>&lt;</code> and <code>&gt;</code> to HTML entities like <code>&amp;lt;</code> and <code>&amp;gt;</code>:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>npm</span><span> add</span><span> stringify-entities</span></span></code></pre></div><p>Then open the <em>src/app.tsx</em> file and <code>import</code> the installed package:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> { </span><span></span><span> } </span><span>from</span><span> &#34;stringify-entities&#34;</span><span>;</span></span></code></pre></div></div><p>Also <code>import</code> the <code>Post</code> type and the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Note"><code>Note</code></a> class provided by Fedify:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> type</span><span> { </span><span></span><span>, </span><span></span><span>, </span><span></span><span> } </span><span>from</span><span> &#34;./schema.ts&#34;</span><span>;</span></span>
<span><span>import</span><span> { </span><span></span><span> } </span><span>from</span><span> &#34;@fedify/fedify&#34;</span><span>;</span></span></code></pre></div></div><p>And implement the <code>POST /users/{username}/posts</code> request handler:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/users/:username/posts&#34;</span><span>, </span><span>async</span><span> (</span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>.</span><span></span><span>(</span><span>&#34;username&#34;</span><span>);</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>    .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>Actor</span><span>&gt;(</span></span>
<span><span>      `</span></span>
<span><span>      SELECT actors.*</span></span>
<span><span>      FROM actors</span></span>
<span><span>      JOIN users ON users.id = actors.user_id</span></span>
<span><span>      WHERE users.username = ?</span></span>
<span><span>      `</span><span>,</span></span>
<span><span>    )</span></span>
<span><span>    .</span><span></span><span>(</span><span></span><span>);</span></span>
<span><span>  if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;/setup&#34;</span><span>);</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> await</span><span> </span><span></span><span>.</span><span></span><span>.</span><span></span><span>();</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;content&#34;</span><span>)?.</span><span></span><span>();</span></span>
<span><span>  if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span> ||</span><span> </span><span></span><span>.</span><span></span><span>() </span><span>===</span><span> &#34;&#34;</span><span>) {</span></span>
<span><span>    return</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;Content is required&#34;</span><span>, </span><span>400</span><span>);</span></span>
<span><span>  }</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>(</span><span></span><span>.</span><span></span><span>.</span><span></span><span>, </span><span></span><span>);</span></span>
<span><span>  const</span><span> </span><span></span><span>:</span><span> string</span><span> |</span><span> null</span><span> =</span><span> </span><span></span><span>.</span><span></span><span>(() </span><span>=&gt;</span><span> {</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>      .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>Post</span><span>&gt;(</span></span>
<span><span>        `</span></span>
<span><span>        INSERT INTO posts (uri, actor_id, content)</span></span>
<span><span>        VALUES (&#39;https://localhost/&#39;, ?, ?)</span></span>
<span><span>        RETURNING *</span></span>
<span><span>        `</span><span>,</span></span>
<span><span>      )</span></span>
<span><span>      .</span><span></span><span>(</span><span></span><span>.</span><span></span><span>, </span><span></span><span>(</span><span></span><span>, { </span><span></span><span>: </span><span>true</span><span> }));</span></span>
<span><span>    if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span> null</span><span>;</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>(</span><span></span><span>, {</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>.</span><span></span><span>.</span><span></span><span>(),</span></span>
<span><span>    }).</span><span></span><span>;</span></span>
<span><span>    </span><span></span><span>.</span><span></span><span>(</span><span>&#34;UPDATE posts SET uri = ?, url = ? WHERE id = ?&#34;</span><span>).</span><span></span><span>(</span></span>
<span><span>      </span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>.</span><span></span><span>,</span></span>
<span><span>    );</span></span>
<span><span>    return</span><span> </span><span></span><span>;</span></span>
<span><span>  })();</span></span>
<span><span>  if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;Failed to create post&#34;</span><span>, </span><span>500</span><span>);</span></span>
<span><span>  return</span><span> </span><span></span><span>.</span><span></span><span>(</span><span></span><span>);</span></span>
<span><span>});</span></span></code></pre></div></div><p>Although it&#39;s a normal code that adds a record to the <code>posts</code> table, there&#39;s one peculiar part. To get the URI of the ActivityPub object representing the post, <code>posts.id</code> needs to be determined first, so we first insert a temporary URI <code>https://localhost/</code> into the <code>posts.uri</code> column to add the record, then use the determined <code>posts.id</code> to get the actual URI using the <code>getObjectUri()</code> method and update the record.</p><p>Now, let&#39;s open the <a href="http://localhost:8000/" target="_blank" rel="noreferrer">http://localhost:8000/</a> page in your web browser and create a post:</p><p><img src="https://ntietz.com/assets/home-2.BRuu-QR7.png" alt="Creating a post"/></p><p>When you press the <em>Post</em> button to create a post, unfortunately you&#39;ll get a <code>404 Not Found</code> error:</p><p><img src="https://ntietz.com/assets/404.DUD_N_SX.png" alt="404 Not Found"/></p><p>This is because we implemented it to redirect to the post&#39;s permalink, but we haven&#39;t implemented the post page yet. However, a record should have been created in the <code>posts</code> table. Let&#39;s check:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>echo</span><span> &#34;SELECT * FROM posts;&#34;</span><span> |</span><span> sqlite3</span><span> -table</span><span> microblog.sqlite3</span></span></code></pre></div><p>You should see a result like this:</p><table tabindex="0"><thead><tr><th><code>id</code></th><th><code>uri</code></th><th><code>actor_id</code></th><th><code>content</code></th><th><code>url</code></th><th><code>created</code></th></tr></thead><tbody><tr><td><code>1</code></td><td><code>http://localhost:8000/users/johndoe/posts/1</code></td><td><code>1</code></td><td><code>It&#39;s my first post!</code></td><td><code>http://localhost:8000/users/johndoe/posts/1</code></td><td><code>2024-09-02 08:10:55</code></td></tr></tbody></table><h3 id="post-page" tabindex="-1">Post page <a href="#post-page" aria-label="Permalink to &#34;Post page&#34;">​</a></h3><p>To prevent the <code>404 Not Found</code> error after creating a post, let&#39;s implement the post page.</p><p>Open the <em>src/views.tsx</em> file and <code>import</code> the <code>Post</code> type:</p><div><p><span data-title="src/views.tsx">src/views.tsx</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> type</span><span> { </span><span></span><span>, </span><span></span><span>, </span><span></span><span> } </span><span>from</span><span> &#34;./schema.ts&#34;</span><span>;</span></span></code></pre></div></div><p>Then define the <code>&lt;PostPage&gt;</code> component and the <code>&lt;PostView&gt;</code> component:</p><div><p><span data-title="src/views.tsx">src/views.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span>export</span><span> interface</span><span> </span><span>PostPageProps</span><span> extends</span><span> </span><span>ProfileProps</span><span>, </span><span>PostViewProps</span><span> {}</span></span>
<span></span>
<span><span>export</span><span> const</span><span> </span><span></span><span>:</span><span> </span><span></span><span>&lt;</span><span>PostPageProps</span><span>&gt; </span><span>=</span><span> (</span><span></span><span>) </span><span>=&gt;</span><span> (</span></span>
<span><span>  &lt;&gt;</span></span>
<span><span>    &lt;</span><span></span></span>
<span><span>      </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>      </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>      </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>      </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>    /&gt;</span></span>
<span><span>    &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span>} /&gt;</span></span>
<span><span>  &lt;/&gt;</span></span>
<span><span>);</span></span>
<span></span>
<span><span>export</span><span> interface</span><span> </span><span>PostViewProps</span><span> {</span></span>
<span><span>  </span><span></span><span>:</span><span> </span><span>Post</span><span> &amp;</span><span> </span><span>Actor</span><span>;</span></span>
<span><span>}</span></span>
<span></span>
<span><span>export</span><span> const</span><span> </span><span></span><span>:</span><span> </span><span></span><span>&lt;</span><span>PostViewProps</span><span>&gt; </span><span>=</span><span> ({ </span><span></span><span> }) </span><span>=&gt;</span><span> (</span></span>
<span><span>  &lt;</span><span></span><span>&gt;</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>} /&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;</span></span>
<span><span>    {</span><span>/* biome-ignore lint/security/noDangerouslySetInnerHtml: */</span><span>}</span></span>
<span><span>    &lt;</span><span></span><span> </span><span></span><span>=</span><span>{{ </span><span></span><span>: </span><span></span><span>.</span><span></span><span> }} /&gt;</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span> </span><span>??</span><span> </span><span></span><span>.</span><span></span><span>}&gt;</span></span>
<span><span>        &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span>new</span><span> </span><span></span><span>(</span><span></span><span>.</span><span></span><span>).</span><span></span><span>()}&gt;</span></span>
<span><span>          {</span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>        &lt;/</span><span></span><span>&gt;</span></span>
<span><span>      &lt;/</span><span></span><span>&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;</span></span>
<span><span>  &lt;/</span><span></span><span>&gt;</span></span>
<span><span>);</span></span></code></pre></div></div><p>Now let&#39;s load the post data from the database and render it with the <code>&lt;PostPage&gt;</code> component. Open the <em>src/app.tsx</em> file and <code>import</code> the <code>&lt;PostPage&gt;</code> component we just defined:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> {</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,  </span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>} </span><span>from</span><span> &#34;./views.tsx&#34;</span><span>;</span></span></code></pre></div></div><p>And implement the <code>GET /users/{username}/posts/{id}</code> request handler:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/users/:username/posts/:id&#34;</span><span>, (</span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>    .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>Post</span><span> &amp;</span><span> </span><span>Actor</span><span> &amp;</span><span> </span><span>User</span><span>&gt;(</span></span>
<span><span>      `</span></span>
<span><span>      SELECT users.*, actors.*, posts.*</span></span>
<span><span>      FROM posts</span></span>
<span><span>      JOIN actors ON actors.id = posts.actor_id</span></span>
<span><span>      JOIN users ON users.id = actors.user_id</span></span>
<span><span>      WHERE users.username = ? AND posts.id = ?</span></span>
<span><span>      `</span><span>,</span></span>
<span><span>    )</span></span>
<span><span>    .</span><span></span><span>(</span><span></span><span>.</span><span></span><span>.</span><span></span><span>(</span><span>&#34;username&#34;</span><span>), </span><span></span><span>.</span><span></span><span>.</span><span></span><span>(</span><span>&#34;id&#34;</span><span>));</span></span>
<span><span>  if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span> </span><span></span><span>.</span><span></span><span>();</span></span>
<span></span>
<span><span>  // biome-ignore lint/style/noNonNullAssertion: Always returns a single record</span></span>
<span><span>  const</span><span> { </span><span></span><span> } </span><span>=</span><span> </span><span></span></span>
<span><span>    .</span><span></span><span>&lt;</span><span>unknown</span><span>[], { </span><span></span><span>:</span><span> number</span><span> }&gt;(</span></span>
<span><span>      `</span></span>
<span><span>      SELECT count(*) AS followers</span></span>
<span><span>      FROM follows</span></span>
<span><span>      WHERE follows.following_id = ?</span></span>
<span><span>      `</span><span>,</span></span>
<span><span>    )</span></span>
<span><span>    .</span><span></span><span>(</span><span></span><span>.</span><span></span><span>)</span><span>!</span><span>;</span></span>
<span><span>  return</span><span> </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span></span>
<span><span>        </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span> </span><span>??</span><span> </span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>        </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>        </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>        </span><span></span><span>=</span><span>{</span><span></span><span>}</span></span>
<span><span>        </span><span></span><span>=</span><span>{</span><span></span><span>}</span></span>
<span><span>      /&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;,</span></span>
<span><span>  );</span></span>
<span><span>});</span></span></code></pre></div></div><p>Now let&#39;s open the <a href="http://localhost:8000/users/johndoe/posts/1" target="_blank" rel="noreferrer">http://localhost:8000/users/johndoe/posts/1</a> page that gave a <code>404 Not Found</code> error earlier in your web browser:</p><p><img src="https://ntietz.com/assets/post-page.B2yFZAN1.png" alt="Post page"/></p><h3 id="note-object-dispatcher" tabindex="-1"><a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Note"><code>Note</code></a> object dispatcher <a href="#note-object-dispatcher" aria-label="Permalink to &#34;`Note` object dispatcher&#34;">​</a></h3><p>Now, can we check if the post can be viewed from other Mastodon servers? First, use <code>fedify tunnel</code> to expose the local server to the public internet.</p><p>In that state, try entering the post&#39;s permalink <a href="https://temp-address.serveo.net/users/johndoe/posts/1" target="_blank" rel="noreferrer">https://temp-address.serveo.net/users/johndoe/posts/1</a> (replace with your temporary domain name) in the Mastodon search box:</p><p><img src="https://ntietz.com/assets/search-results-2.TfIygmaz.png" alt="Empty search results"/></p><p>Unfortunately, the search results are empty. This is because we haven&#39;t exposed the post as an ActivityPub object. Let&#39;s expose the post as an ActivityPub object.</p><p>Before implementation, we need to install a necessary library. Because the <a href="https://tc39.es/proposal-temporal/docs/" target="_blank" rel="noreferrer">Temporal API</a> used by Fedify to represent time is not yet built into Node.js, we need the <em><a href="https://github.com/js-temporal/temporal-polyfill" target="_blank" rel="noreferrer">@js-temporal/polyfill</a></em> package to polyfill it:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>npm</span><span> add</span><span> @js-temporal/polyfill</span></span></code></pre></div><p>Open the <em>src/federation.ts</em> file and <code>import</code> the installed package:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> { </span><span>Temporal</span><span> } </span><span>from</span><span> &#34;@js-temporal/polyfill&#34;</span><span>;</span></span></code></pre></div></div><p>Also <code>import</code> the <code>Post</code> type and the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/PUBLIC_COLLECTION"><code>PUBLIC_COLLECTION</code></a> constant provided by Fedify:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> {</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,  </span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  type</span><span> </span><span>Recipient</span><span>,</span></span>
<span><span>} </span><span>from</span><span> &#34;@fedify/fedify&#34;</span><span>;</span></span>
<span><span>import</span><span> type</span><span> {</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,  </span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>} </span><span>from</span><span> &#34;./schema.ts&#34;</span><span>;</span></span></code></pre></div></div><p>Short posts like microblog posts are usually represented as <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Note"><code>Note</code></a> in ActivityPub. We&#39;ve already created an empty implementation of the object dispatcher for the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Note"><code>Note</code></a> class:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  &#34;/users/{identifier}/posts/{id}&#34;</span><span>,</span></span>
<span><span>  (</span><span></span><span>, </span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    return</span><span> null</span><span>;</span></span>
<span><span>  },</span></span>
<span><span>);</span></span></code></pre></div></div><p>Let&#39;s modify this as follows:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  &#34;/users/{identifier}/posts/{id}&#34;</span><span>,</span></span>
<span><span>  (</span><span></span><span>, </span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>      .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>Post</span><span>&gt;(</span></span>
<span><span>        `</span></span>
<span><span>        SELECT posts.*</span></span>
<span><span>        FROM posts</span></span>
<span><span>        JOIN actors ON actors.id = posts.actor_id</span></span>
<span><span>        JOIN users ON users.id = actors.user_id</span></span>
<span><span>        WHERE users.username = ? AND posts.id = ?</span></span>
<span><span>        `</span><span>,</span></span>
<span><span>      )</span></span>
<span><span>      .</span><span></span><span>(</span><span></span><span>.</span><span></span><span>, </span><span></span><span>.</span><span></span><span>);</span></span>
<span><span>    if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span> null</span><span>;</span></span>
<span><span>    return</span><span> new</span><span> </span><span></span><span>({</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>.</span><span></span><span>(</span><span></span><span>, </span><span></span><span>),</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>.</span><span></span><span>(</span><span></span><span>.</span><span></span><span>),</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>.</span><span></span><span>(</span><span></span><span>.</span><span></span><span>),</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>.</span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>: </span><span>&#34;text/html&#34;</span><span>,</span></span>
<span><span>      </span><span></span><span>: </span><span>Temporal</span><span>.</span><span></span><span>.</span><span></span><span>(</span><span>`${</span><span></span><span>.</span><span></span><span>.</span><span></span><span>(</span><span>&#34; &#34;</span><span>, </span><span>&#34;T&#34;</span><span>)</span><span>}Z`</span><span>),</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>.</span><span></span><span>(</span><span></span><span>, </span><span></span><span>),</span></span>
<span><span>    });</span></span>
<span><span>  },</span></span>
<span><span>);</span></span></code></pre></div></div><p>The property values filled when creating the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Note"><code>Note</code></a> object have the following roles:</p><ul><li><p>Putting <code>ctx.getActorUri(values.identifier)</code> in the <code>attribution</code> property indicates that the author of this post is the actor we created.</p></li><li><p>Putting <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/PUBLIC_COLLECTION"><code>PUBLIC_COLLECTION</code></a> in the <code>to</code> property indicates that this post is a public post.</p></li><li><p>Putting <code>ctx.getFollowersUri(values.identifier)</code> in the <code>cc</code> property indicates that this post is delivered to followers, but this itself doesn&#39;t have much meaning.</p></li></ul><p>Now, let&#39;s try entering the post&#39;s permalink <a href="https://temp-address.serveo.net/users/johndoe/posts/1" target="_blank" rel="noreferrer">https://temp-address.serveo.net/users/johndoe/posts/1</a> (replace with your temporary domain name) in the Mastodon search box again:</p><p><img src="https://ntietz.com/assets/search-results-3.7hzVgwrP.png" alt="Mastodon search results showing our created post"/></p><p>This time, our created post appears properly in the search results!</p><h3 id="sending-create-note-activity" tabindex="-1">Sending <code>Create(Note)</code> activity <a href="#sending-create-note-activity" aria-label="Permalink to &#34;Sending `Create(Note)` activity&#34;">​</a></h3><p>However, even if you follow our created actor from Mastodon, newly created posts won&#39;t appear in the Mastodon timeline. This is because Mastodon doesn&#39;t automatically fetch new posts; instead, the side that created the new post needs to send a <code>Create(Note)</code> activity to notify that a new post has been created.</p><p>Let&#39;s modify the code to send a <code>Create(Note)</code> activity when creating a post. Open the <em>src/app.tsx</em> file and <code>import</code> the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Create"><code>Create</code></a> class provided by Fedify:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> { </span><span></span><span>, </span><span></span><span> } </span><span>from</span><span> &#34;@fedify/fedify&#34;</span><span>;</span></span></code></pre></div></div><p>Then modify the <code>POST /users/{username}/posts</code> request handler as follows:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/users/:username/posts&#34;</span><span>, </span><span>async</span><span> (</span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  // ... omitted ...</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>(</span><span></span><span>.</span><span></span><span>.</span><span></span><span>, </span><span></span><span>);</span></span>
<span><span>  const</span><span> </span><span></span><span>:</span><span> </span><span>Post</span><span> |</span><span> null</span><span> =</span><span> </span><span></span><span>.</span><span></span><span>(() </span><span>=&gt;</span><span> {</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>      .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>Post</span><span>&gt;(</span></span>
<span><span>        `</span></span>
<span><span>        INSERT INTO posts (uri, actor_id, content)</span></span>
<span><span>        VALUES (&#39;https://localhost/&#39;, ?, ?)</span></span>
<span><span>        RETURNING *</span></span>
<span><span>        `</span><span>,</span></span>
<span><span>      )</span></span>
<span><span>      .</span><span></span><span>(</span><span></span><span>.</span><span></span><span>, </span><span></span><span>(</span><span></span><span>, { </span><span></span><span>: </span><span>true</span><span> }));</span></span>
<span><span>    if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span> null</span><span>;</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>(</span><span></span><span>, {</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>.</span><span></span><span>.</span><span></span><span>(),</span></span>
<span><span>    }).</span><span></span><span>;</span></span>
<span><span>    </span><span></span><span>.</span><span></span><span>(</span><span>&#34;UPDATE posts SET uri = ?, url = ? WHERE id = ?&#34;</span><span>).</span><span></span><span>(</span></span>
<span><span>      </span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>.</span><span></span><span>,</span></span>
<span><span>    );</span></span>
<span><span>    return</span><span> </span><span></span><span>;</span></span>
<span><span>  })();</span></span>
<span><span>  if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;Failed to create post&#34;</span><span>, </span><span>500</span><span>);</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> { </span><span></span><span>: </span><span></span><span>, </span><span></span><span>: </span><span></span><span>.</span><span></span><span>.</span><span></span><span>() };</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> await</span><span> </span><span></span><span>.</span><span></span><span>(</span><span></span><span>, </span><span></span><span>);</span></span>
<span><span>  await</span><span> </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>    { </span><span></span><span>: </span><span></span><span> },</span></span>
<span><span>    &#34;followers&#34;</span><span>,</span></span>
<span><span>    new</span><span> </span><span></span><span>({</span></span>
<span><span>      </span><span></span><span>: </span><span>new</span><span> </span><span></span><span>(</span><span>&#34;#activity&#34;</span><span>, </span><span></span><span>?.</span><span></span><span> </span><span>??</span><span> </span><span></span><span>),</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>?.</span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>?.</span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>?.</span><span></span><span>,</span></span>
<span><span>    }),</span></span>
<span><span>  );</span></span>
<span><span>  return</span><span> </span><span></span><span>.</span><span></span><span>(</span><span></span><span>.</span><span></span><span>(</span><span></span><span>, </span><span></span><span>).</span><span></span><span>);</span></span>
<span><span>});</span></span></code></pre></div></div><p>The <code>getObject()</code> method returns the ActivityPub object created by the object dispatcher. Here, it will return a <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Note"><code>Note</code></a> object. We put that <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Note"><code>Note</code></a> object in the <code>object</code> property when creating the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Create"><code>Create</code></a> object. We set the <code>tos</code> (plural of <code>to</code>) and <code>ccs</code> (plural of <code>cc</code>) properties of the activity the same as the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Note"><code>Note</code></a> object. We set an arbitrary unique URI for the <code>id</code> of the activity.</p><div><p>TIP</p><p>The <code>id</code> property of the activity object doesn&#39;t necessarily need to be an accessible URI. It just needs to be unique.</p></div><p>The second parameter of the <code>sendActivity()</code> method is where the recipients go, and here we&#39;ve specified the special option <code>&#34;followers&#34;</code>. When this option is specified, it uses the followers collection dispatcher we implemented earlier to send the activity to all followers.</p><p>Now that we&#39;ve finished the implementation, let&#39;s check if the <code>Create(Note)</code> activity is sent properly.</p><p>With the <code>fedify tunnel</code> command exposing the local server to the public internet, go to <a href="https://activitypub.academy/" target="_blank" rel="noreferrer">ActivityPub.Academy</a> and follow <em>@johndoe@temp-address.serveo.net</em> (replace the domain name with the temporary domain name assigned to you). After making sure that the follow request has been accepted in the followers list, go to <a href="https://temp-address.serveo.net/" target="_blank" rel="noreferrer">https://temp-address.serveo.net/</a> (again, replace the domain name) in your web browser and create a new post.</p><div><p>WARNING</p><p>When testing activity transmission, you must access via a domain name accessible from the public internet, not <em>localhost</em>. This is because when determining the ID of ActivityPub objects, the URI is constructed based on the domain name of the incoming request.</p></div><p>To check if the <code>Create(Note)</code> activity was sent well, let&#39;s look at ActivityPub.Academy&#39;s <em>Activity Log</em>:</p><p><img src="https://ntietz.com/assets/activity-log-5.BGmaQ3LG.png" alt="Activity Log showing received Create(Note) activity"/></p><p>It came in well. Now let&#39;s look at the timeline in ActivityPub.Academy:</p><p><img src="https://ntietz.com/assets/academy-timeline.DcazK0VL.png" alt="The created post is visible in ActivityPub.Academy&#39;s timeline"/></p><p>We did it!</p><h2 id="post-list-on-profile-page" tabindex="-1">Post list on profile page <a href="#post-list-on-profile-page" aria-label="Permalink to &#34;Post list on profile page&#34;">​</a></h2><p>Currently, the profile page only shows the name, fediverse handle, and number of followers, but not the actual posts. Let&#39;s display the created posts on the profile page.</p><p>First, open the <em>src/views.tsx</em> file and add a <code>&lt;PostList&gt;</code> component:</p><div><p><span data-title="src/views.tsx">src/views.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span>export</span><span> interface</span><span> </span><span>PostListProps</span><span> {</span></span>
<span><span>  </span><span></span><span>:</span><span> (</span><span>Post</span><span> &amp;</span><span> </span><span>Actor</span><span>)[];</span></span>
<span><span>}</span></span>
<span></span>
<span><span>export</span><span> const</span><span> </span><span></span><span>:</span><span> </span><span></span><span>&lt;</span><span>PostListProps</span><span>&gt; </span><span>=</span><span> ({ </span><span></span><span> }) </span><span>=&gt;</span><span> (</span></span>
<span><span>  &lt;&gt;</span></span>
<span><span>    {</span><span></span><span>.</span><span></span><span>((</span><span></span><span>) </span><span>=&gt;</span><span> (</span></span>
<span><span>      &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span>}&gt;</span></span>
<span><span>        &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>} /&gt;</span></span>
<span><span>      &lt;/</span><span></span><span>&gt;</span></span>
<span><span>    ))}</span></span>
<span><span>  &lt;/&gt;</span></span>
<span><span>);</span></span></code></pre></div></div><p>Then, open the <em>src/app.tsx</em> file and <code>import</code> the <code>&lt;PostList&gt;</code> component we just defined:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> {</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,  </span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>} </span><span>from</span><span> &#34;./views.tsx&#34;</span><span>;</span></span></code></pre></div></div><p>Modify the existing <code>GET /users/{username}</code> request handler as follows:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/users/:username&#34;</span><span>, </span><span>async</span><span> (</span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  // ... omitted ...</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>    .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>Post</span><span> &amp;</span><span> </span><span>Actor</span><span>&gt;(</span></span>
<span><span>      `</span></span>
<span><span>      SELECT actors.*, posts.*</span></span>
<span><span>      FROM posts</span></span>
<span><span>      JOIN actors ON posts.actor_id = actors.id</span></span>
<span><span>      WHERE actors.user_id = ?</span></span>
<span><span>      ORDER BY posts.created DESC</span></span>
<span><span>      `</span><span>,</span></span>
<span><span>    )</span></span>
<span><span>    .</span><span></span><span>(</span><span></span><span>.</span><span></span><span>);</span></span>
<span><span>  // ... omitted ...</span></span>
<span><span>  return</span><span> </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      // ... omitted ...</span></span>
<span><span>      &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>} /&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;,</span></span>
<span><span>  );</span></span>
<span><span>});</span></span></code></pre></div></div><p>Now, let&#39;s open the <a href="http://localhost:8000/users/johndoe" target="_blank" rel="noreferrer">http://localhost:8000/users/johndoe</a> page in your web browser:</p><p><img src="https://ntietz.com/assets/profile-page-4.DDjJeIrV.png" alt="Modified profile page"/></p><p>You can see that the created posts are displayed well.</p><h2 id="follow" tabindex="-1">Follow <a href="#follow" aria-label="Permalink to &#34;Follow&#34;">​</a></h2><p>Currently, our actor can receive follow requests from actors on other servers, but it can&#39;t send follow requests to actors on other servers. Since we can&#39;t follow, we also can&#39;t see posts created by other actors. So, let&#39;s add the functionality to send follow requests to actors on other servers.</p><p>Let&#39;s start with the UI. Open the <em>src/views.tsx</em> file and modify the existing <code>&lt;Home&gt;</code> component as follows:</p><div><p><span data-title="src/views.tsx">src/views.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span>export</span><span> const</span><span> </span><span></span><span>:</span><span> </span><span></span><span>&lt;</span><span>HomeProps</span><span>&gt; </span><span>=</span><span> ({ </span><span></span><span> }) </span><span>=&gt;</span><span> (</span></span>
<span><span>  &lt;&gt;</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      {</span><span>/* ... omitted ... */</span><span>}</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;</span></span>
<span><span>    &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;post&#34;</span><span> </span><span></span><span>=</span><span>{</span><span>`/users/${</span><span></span><span>.</span><span></span><span>}/following`</span><span>}&gt;</span></span>
<span><span>      {</span><span>/* biome-ignore lint/a11y/noRedundantRoles: PicoCSS requires role=group */</span><span>}</span></span>
<span><span>      &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;group&#34;</span><span>&gt;</span></span>
<span><span>        &lt;</span><span></span></span>
<span><span>          </span><span></span><span>=</span><span>&#34;text&#34;</span></span>
<span><span>          </span><span></span><span>=</span><span>&#34;actor&#34;</span></span>
<span><span>          </span><span></span><span>=</span><span>{</span><span>true</span><span>}</span></span>
<span><span>          </span><span></span><span>=</span><span>&#34;Enter an actor handle (e.g., @johndoe@mastodon.com) or URI (e.g., https://mastodon.com/@johndoe)&#34;</span></span>
<span><span>        /&gt;</span></span>
<span><span>        &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;submit&#34;</span><span> </span><span></span><span>=</span><span>&#34;Follow&#34;</span><span> /&gt;</span></span>
<span><span>      &lt;/</span><span></span><span>&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;</span></span>
<span><span>    &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;post&#34;</span><span> </span><span></span><span>=</span><span>{</span><span>`/users/${</span><span></span><span>.</span><span></span><span>}/posts`</span><span>}&gt;</span></span>
<span><span>      {</span><span>/* ... omitted ... */</span><span>}</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;</span></span>
<span><span>  &lt;/&gt;</span></span>
<span><span>);</span></span></code></pre></div></div><p>To check if the home page has been modified correctly, open the <a href="http://localhost:8000/" target="_blank" rel="noreferrer">http://localhost:8000/</a> page in your web browser:</p><p><img src="https://ntietz.com/assets/home-3.Bg8eDKPT.png" alt="Home page with follow request UI added"/></p><h3 id="sending-follow-activity" tabindex="-1">Sending <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Follow"><code>Follow</code></a> activity <a href="#sending-follow-activity" aria-label="Permalink to &#34;Sending `Follow` activity&#34;">​</a></h3><p>Now that we have the follow request UI, let&#39;s write the code to actually send the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Follow"><code>Follow</code></a> activity.</p><p>Open the <em>src/app.tsx</em> file and <code>import</code> the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Follow"><code>Follow</code></a> class and the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/isActor"><code>isActor()</code></a> function provided by Fedify:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> {</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,        </span></span>
<span><span>  </span><span></span><span>,       </span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>} </span><span>from</span><span> &#34;@fedify/fedify&#34;</span><span>;</span></span></code></pre></div></div><p>Then add a <code>POST /users/{username}/following</code> request handler:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/users/:username/following&#34;</span><span>, </span><span>async</span><span> (</span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>.</span><span></span><span>(</span><span>&#34;username&#34;</span><span>);</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> await</span><span> </span><span></span><span>.</span><span></span><span>.</span><span></span><span>();</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;actor&#34;</span><span>);</span></span>
<span><span>  if</span><span> (</span><span>typeof</span><span> </span><span></span><span> </span><span>!==</span><span> &#34;string&#34;</span><span>) {</span></span>
<span><span>    return</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;Invalid actor handle or URL&#34;</span><span>, </span><span>400</span><span>);</span></span>
<span><span>  }</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>(</span><span></span><span>.</span><span></span><span>.</span><span></span><span>, </span><span></span><span>);</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> await</span><span> </span><span></span><span>.</span><span></span><span>(</span><span></span><span>.</span><span></span><span>());</span></span>
<span><span>  if</span><span> (</span><span>!</span><span></span><span>(</span><span></span><span>)) {</span></span>
<span><span>    return</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;Invalid actor handle or URL&#34;</span><span>, </span><span>400</span><span>);</span></span>
<span><span>  }</span></span>
<span><span>  await</span><span> </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>    { </span><span></span><span>: </span><span></span><span> },</span></span>
<span><span>    </span><span></span><span>,</span></span>
<span><span>    new</span><span> </span><span></span><span>({</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>.</span><span></span><span>(</span><span></span><span>),</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>.</span><span></span><span>,</span></span>
<span><span>      </span><span></span><span>: </span><span></span><span>.</span><span></span><span>,</span></span>
<span><span>    }),</span></span>
<span><span>  );</span></span>
<span><span>  return</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;Successfully sent a follow request&#34;</span><span>);</span></span>
<span><span>});</span></span></code></pre></div></div><p><a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Context.lookupObject"><code>Context.lookupObject()</code></a> method looks up ActivityPub objects, including actors. It takes the unique URI of an ActivityPub object or a fediverse handle as input and returns the looked-up ActivityPub object.</p><p>The <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/isActor"><code>isActor()</code></a> function checks if the given ActivityPub object is an actor.</p><p>In this code, we&#39;re using the <code>sendActivity()</code> method to send a <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Follow"><code>Follow</code></a> activity to the looked-up actor. However, we&#39;re not adding any records to the <code>follows</code> table yet. This is because we should add the record after receiving an <code>Accept(Follow)</code> activity from the other party.</p><h3 id="testing-5" tabindex="-1">Testing <a href="#testing-5" aria-label="Permalink to &#34;Testing&#34;">​</a></h3><p>We need to check if the implemented follow request functionality is working properly. This time too, we need to send an activity, so use the <code>fedify tunnel</code> command to expose the local server to the public internet, then enter the <a href="https://temp-address.serveo.net/" target="_blank" rel="noreferrer">https://temp-address.serveo.net/</a> page (replace the domain name) in your web browser:</p><p><img src="https://ntietz.com/assets/home-3.Bg8eDKPT.png" alt="Home page with follow request UI"/></p><p>You need to enter the fediverse handle of the actor you want to follow in the follow request input field. Here, for easy debugging, let&#39;s enter an actor from <a href="https://activitypub.academy/" target="_blank" rel="noreferrer">ActivityPub.Academy</a>. By the way, you can see the handle of the temporary account logged in to ActivityPub.Academy by clicking on the temporary account name to go to the profile page and looking just below the name:</p><p><img src="https://ntietz.com/assets/academy-profile.BWyi1vIy.png" alt="Fediverse handle visible on the account profile page in ActivityPub.Academy"/></p><p>Enter the ActivityPub.Academy actor&#39;s handle as follows, then press the <em>Follow</em> button to send a follow request:</p><p><img src="https://ntietz.com/assets/home-5.nO4VlUKm.png" alt="Sending a follow request to the ActivityPub.Academy actor"/></p><p>And check ActivityPub.Academy&#39;s <em>Activity Log</em>:</p><p><img src="https://ntietz.com/assets/activity-log-6.BMlsSF-r.png" alt="ActivityPub.Academy&#39;s Activity Log"/></p><p>The <em>Activity Log</em> shows the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Follow"><code>Follow</code></a> activity we sent and the <code>Accept(Follow)</code> activity sent in response from ActivityPub.Academy.</p><p>If you go to the notifications page in ActivityPub.Academy, you can see that the follow request has actually arrived:</p><p><img src="https://ntietz.com/assets/academy-notifications.BU98-1EO.png" alt="Arrived follow request shown on ActivityPub.Academy&#39;s notifications page"/></p><h3 id="receiving-accept-follow-activity" tabindex="-1">Receiving <code>Accept(Follow)</code> activity <a href="#receiving-accept-follow-activity" aria-label="Permalink to &#34;Receiving `Accept(Follow)` activity&#34;">​</a></h3><p>However, we&#39;re not taking any action on the received <code>Accept(Follow)</code> activity yet, so we need to implement this part.</p><p>Open the <em>src/federation.ts</em> file and <code>import</code> the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/isActor"><code>isActor()</code></a> function and <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Actor"><code>Actor</code></a> type provided by Fedify:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> {</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,                </span></span>
<span><span>  type</span><span> </span><span></span><span> </span><span>as</span><span> </span><span></span><span>,  </span></span>
<span><span>  type</span><span> </span><span>Recipient</span><span>,</span></span>
<span><span>} </span><span>from</span><span> &#34;@fedify/fedify&#34;</span><span>;</span></span></code></pre></div></div><p>We&#39;ve given the alias <code>APActor</code> to the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Actor"><code>Actor</code></a> type because the <code>Actor</code> type name is already used in this source file.</p><p>Before implementation, let&#39;s refactor the code that adds actor information to the <code>actors</code> table when first encountered to make it reusable. Add the following function:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>async</span><span> function</span><span> </span><span></span><span>(</span><span></span><span>:</span><span> </span><span></span><span>)</span><span>:</span><span> </span><span></span><span>&lt;</span><span>Actor</span><span> |</span><span> null</span><span>&gt; {</span></span>
<span><span>  if</span><span> (</span><span></span><span>.</span><span></span><span> </span><span>==</span><span> null</span><span> ||</span><span> </span><span></span><span>.</span><span></span><span> </span><span>==</span><span> null</span><span>) {</span></span>
<span><span>    </span><span></span><span>.</span><span></span><span>(</span><span>&#34;Actor is missing required fields: {actor}&#34;</span><span>, { </span><span></span><span> });</span></span>
<span><span>    return</span><span> null</span><span>;</span></span>
<span><span>  }</span></span>
<span><span>  return</span><span> (</span></span>
<span><span>    </span><span></span></span>
<span><span>      .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>Actor</span><span>&gt;(</span></span>
<span><span>        `</span></span>
<span><span>        -- Add a new actor record or update if it already exists</span></span>
<span><span>        INSERT INTO actors (uri, handle, name, inbox_url, shared_inbox_url, url)</span></span>
<span><span>        VALUES (?, ?, ?, ?, ?, ?)</span></span>
<span><span>        ON CONFLICT (uri) DO UPDATE SET</span></span>
<span><span>          handle = excluded.handle,</span></span>
<span><span>          name = excluded.name,</span></span>
<span><span>          inbox_url = excluded.inbox_url,</span></span>
<span><span>          shared_inbox_url = excluded.shared_inbox_url,</span></span>
<span><span>          url = excluded.url</span></span>
<span><span>        WHERE</span></span>
<span><span>          actors.uri = excluded.uri</span></span>
<span><span>        RETURNING *</span></span>
<span><span>        `</span><span>,</span></span>
<span><span>      )</span></span>
<span><span>      .</span><span></span><span>(</span></span>
<span><span>        </span><span></span><span>.</span><span></span><span>.</span><span></span><span>,</span></span>
<span><span>        await</span><span> </span><span></span><span>(</span><span></span><span>),</span></span>
<span><span>        </span><span></span><span>.</span><span></span><span>?.</span><span></span><span>(),</span></span>
<span><span>        </span><span></span><span>.</span><span></span><span>.</span><span></span><span>,</span></span>
<span><span>        </span><span></span><span>.</span><span></span><span>?.</span><span></span><span>?.</span><span></span><span>,</span></span>
<span><span>        </span><span></span><span>.</span><span></span><span>?.</span><span></span><span>,</span></span>
<span><span>      ) </span><span>??</span><span> null</span></span>
<span><span>  );</span></span>
<span><span>}</span></span></code></pre></div></div><p>The defined <code>persistActor()</code> function adds a record corresponding to the actor object passed as an argument to the <code>actors</code> table. If there&#39;s already a corresponding record in the table, it updates the record.</p><p>Change the code doing the same role in the <code>on(Follow, ...)</code> part of the inbox to use the <code>persistActor()</code> function:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span></span></span>
<span><span>  .</span><span></span><span>(</span><span>&#34;/users/{identifier}/inbox&#34;</span><span>, </span><span>&#34;/inbox&#34;</span><span>)</span></span>
<span><span>  .</span><span></span><span>(</span><span></span><span>, </span><span>async</span><span> (</span><span></span><span>, </span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    // ... omitted ...</span></span>
<span><span>    if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) {</span></span>
<span><span>      </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>        &#34;Failed to find the actor to follow in the database: {object}&#34;</span><span>,</span></span>
<span><span>        { </span><span></span><span> },</span></span>
<span><span>      );</span></span>
<span><span>    }</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> (</span><span>await</span><span> </span><span></span><span>(</span><span></span><span>))?.</span><span></span><span>;  </span></span>
<span><span>    </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>      &#34;INSERT INTO follows (following_id, follower_id) VALUES (?, ?)&#34;</span><span>,</span></span>
<span><span>    ).</span><span></span><span>(</span><span></span><span>, </span><span></span><span>);</span></span>
<span><span>    // ... omitted ...</span></span>
<span><span>  })</span></span></code></pre></div></div><p>Now that we&#39;ve finished refactoring, let&#39;s implement the behavior when receiving an <code>Accept(Follow)</code> activity in the inbox:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>  .</span><span></span><span>(</span><span></span><span>, </span><span>async</span><span> (</span><span></span><span>, </span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> await</span><span> </span><span></span><span>.</span><span></span><span>();</span></span>
<span><span>    if</span><span> (</span><span>!</span><span>(</span><span></span><span> </span><span>instanceof</span><span> </span><span></span><span>)) </span><span>return</span><span>;</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> await</span><span> </span><span></span><span>.</span><span></span><span>();</span></span>
<span><span>    if</span><span> (</span><span>!</span><span></span><span>(</span><span></span><span>)) </span><span>return</span><span>;</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>;</span></span>
<span><span>    if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span>;</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>(</span><span></span><span>);</span></span>
<span><span>    if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span> ||</span><span> </span><span></span><span>.</span><span></span><span> </span><span>!==</span><span> &#34;actor&#34;</span><span>) </span><span>return</span><span>;</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> (</span><span>await</span><span> </span><span></span><span>(</span><span></span><span>))?.</span><span></span><span>;</span></span>
<span><span>    if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span>;</span></span>
<span><span>    </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>      `</span></span>
<span><span>      INSERT INTO follows (following_id, follower_id)</span></span>
<span><span>      VALUES (</span></span>
<span><span>        ?,</span></span>
<span><span>        (</span></span>
<span><span>          SELECT actors.id</span></span>
<span><span>          FROM actors</span></span>
<span><span>          JOIN users ON actors.user_id = users.id</span></span>
<span><span>          WHERE users.username = ?</span></span>
<span><span>        )</span></span>
<span><span>      )</span></span>
<span><span>      `</span><span>,</span></span>
<span><span>    ).</span><span></span><span>(</span><span></span><span>, </span><span></span><span>.</span><span></span><span>);</span></span>
<span><span>  });</span></span></code></pre></div></div><p>Although there&#39;s a lot of validity checking code, in summary, it gets the actor who sent the follow request (<code>follower</code>) and the actor who received the follow request (<code>following</code>) from the contents of the <code>Accept(Follow)</code> activity and adds a record to the <code>follows</code> table.</p><h3 id="testing-6" tabindex="-1">Testing <a href="#testing-6" aria-label="Permalink to &#34;Testing&#34;">​</a></h3><p>Now we need to check if it&#39;s working well, but there&#39;s a problem. When we sent a follow request earlier, <a href="https://activitypub.academy/" target="_blank" rel="noreferrer">ActivityPub.Academy</a> already accepted the follow request and sent an <code>Accept(Follow)</code> activity, so even if we send another follow request, it will be ignored. Therefore, we need to log out of ActivityPub.Academy and create a new temporary account to test.</p><p>If you&#39;ve created a new temporary account in ActivityPub.Academy, with the local server exposed to the public internet using the <code>fedify tunnel</code> command, go to the <a href="https://temp-address.serveo.net/" target="_blank" rel="noreferrer">https://temp-address.serveo.net/</a> page (replace the domain name) in your web browser and send a follow request to the new temporary account on ActivityPub.Academy.</p><p>If the follow request was sent successfully, you should see the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Follow"><code>Follow</code></a> activity arriving and the <code>Accept(Follow)</code> activity being sent in response in the <em>Activity Log</em>, just like before:</p><p><img src="https://ntietz.com/assets/activity-log-7.C0CTOcUr.png" alt="Activity Log showing received Follow activity and sent Accept(Follow) activity"/></p><p>We haven&#39;t implemented the following list yet, so let&#39;s directly check if a record has been properly added to the <code>follows</code> table:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>echo</span><span> &#34;SELECT * FROM follows WHERE follower_id = 1;&#34;</span><span> |</span><span> sqlite3</span><span> -table</span><span> microblog.sqlite3</span></span></code></pre></div><p>If successful, you should see a result like this (the value in the <code>following_id</code> column might be slightly different):</p><table tabindex="0"><thead><tr><th><code>following_id</code></th><th><code>follower_id</code></th><th><code>created</code></th></tr></thead><tbody><tr><td><code>3</code></td><td><code>1</code></td><td><code>2024-09-02 14:11:17</code></td></tr></tbody></table><h2 id="following-list" tabindex="-1">Following list <a href="#following-list" aria-label="Permalink to &#34;Following list&#34;">​</a></h2><p>Let&#39;s create a page that displays the list of actors our actor is following.</p><p>First, open the <em>src/views.tsx</em> file and add a <code>&lt;FollowingList&gt;</code> component:</p><div><p><span data-title="src/views.tsx">src/views.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span>export</span><span> interface</span><span> </span><span>FollowingListProps</span><span> {</span></span>
<span><span>  </span><span></span><span>:</span><span> </span><span>Actor</span><span>[];</span></span>
<span><span>}</span></span>
<span></span>
<span><span>export</span><span> const</span><span> </span><span></span><span>:</span><span> </span><span></span><span>&lt;</span><span>FollowingListProps</span><span>&gt; </span><span>=</span><span> ({ </span><span></span><span> }) </span><span>=&gt;</span><span> (</span></span>
<span><span>  &lt;&gt;</span></span>
<span><span>    &lt;</span><span></span><span>&gt;Following&lt;/</span><span></span><span>&gt;</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      {</span><span></span><span>.</span><span></span><span>((</span><span></span><span>) </span><span>=&gt;</span><span> (</span></span>
<span><span>        &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span>}&gt;</span></span>
<span><span>          &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>} /&gt;</span></span>
<span><span>        &lt;/</span><span></span><span>&gt;</span></span>
<span><span>      ))}</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;</span></span>
<span><span>  &lt;/&gt;</span></span>
<span><span>);</span></span></code></pre></div></div><p>Then, open the <em>src/app.tsx</em> file and <code>import</code> the <code>&lt;FollowingList&gt;</code> component we just defined:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> {</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,  </span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>} </span><span>from</span><span> &#34;./views.tsx&#34;</span><span>;</span></span></code></pre></div></div><p>And add a handler for the <code>GET /users/{username}/following</code> request:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/users/:username/following&#34;</span><span>, </span><span>async</span><span> (</span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>    .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>Actor</span><span>&gt;(</span></span>
<span><span>      `</span></span>
<span><span>      SELECT following.*</span></span>
<span><span>      FROM follows</span></span>
<span><span>      JOIN actors AS followers ON follows.follower_id = followers.id</span></span>
<span><span>      JOIN actors AS following ON follows.following_id = following.id</span></span>
<span><span>      JOIN users ON users.id = followers.user_id</span></span>
<span><span>      WHERE users.username = ?</span></span>
<span><span>      ORDER BY follows.created DESC</span></span>
<span><span>      `</span><span>,</span></span>
<span><span>    )</span></span>
<span><span>    .</span><span></span><span>(</span><span></span><span>.</span><span></span><span>.</span><span></span><span>(</span><span>&#34;username&#34;</span><span>));</span></span>
<span><span>  return</span><span> </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>} /&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;,</span></span>
<span><span>  );</span></span>
<span><span>});</span></span></code></pre></div></div><p>To check if it&#39;s been implemented correctly, open the <a href="http://localhost:8000/users/johndoe/following" target="_blank" rel="noreferrer">http://localhost:8000/users/johndoe/following</a> page in your web browser:</p><p><img src="https://ntietz.com/assets/following-list.Du0M00k7.png" alt="Following list"/></p><h2 id="following-count" tabindex="-1">Following count <a href="#following-count" aria-label="Permalink to &#34;Following count&#34;">​</a></h2><p>Just as we&#39;re showing the number of followers, we should also display the number of accounts the user is following.</p><p>Open the <em>src/views.tsx</em> file and modify the <code>&lt;Profile&gt;</code> component as follows:</p><div><p><span data-title="src/views.tsx">src/views.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span>export</span><span> interface</span><span> </span><span>ProfileProps</span><span> {</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> string</span><span>;</span></span>
<span><span>  </span><span></span><span>:</span><span> number</span><span>;  </span></span>
<span><span>  </span><span></span><span>:</span><span> number</span><span>;</span></span>
<span><span>}</span></span>
<span></span>
<span><span>export</span><span> const</span><span> </span><span></span><span>:</span><span> </span><span></span><span>&lt;</span><span>ProfileProps</span><span>&gt; </span><span>=</span><span> ({</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,  </span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>}) </span><span>=&gt;</span><span> (</span></span>
<span><span>  &lt;&gt;</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span>&gt;</span></span>
<span><span>        &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span>`/users/${</span><span></span><span>}`</span><span>}&gt;{</span><span></span><span>}&lt;/</span><span></span><span>&gt;</span></span>
<span><span>      &lt;/</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span>&gt;</span></span>
<span><span>        &lt;</span><span></span><span> </span><span></span><span>=</span><span>&#34;user-select: all;&#34;</span><span>&gt;{</span><span></span><span>}&lt;/</span><span></span><span>&gt; </span><span>&amp;middot;</span><span>{</span><span>&#34; &#34;</span><span>}</span></span>
<span><span>        &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span>`/users/${</span><span></span><span>}/following`</span><span>}&gt;{</span><span></span><span>} following&lt;/</span><span></span><span>&gt;{</span><span>&#34; &#34;</span><span>}</span></span>
<span><span>        &amp;middot;</span><span>{</span><span>&#34; &#34;</span><span>}</span></span>
<span><span>        &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span>`/users/${</span><span></span><span>}/followers`</span><span>}&gt;</span></span>
<span><span>          {</span><span></span><span> </span><span>===</span><span> 1</span><span> ?</span><span> &#34;1 follower&#34;</span><span> :</span><span> `${</span><span></span><span>} followers`</span><span>}</span></span>
<span><span>        &lt;/</span><span></span><span>&gt;</span></span>
<span><span>      &lt;/</span><span></span><span>&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;</span></span>
<span><span>  &lt;/&gt;</span></span>
<span><span>);</span></span></code></pre></div></div><p>Also modify the <code>&lt;PostPage&gt;</code> component as follows:</p><div><p><span data-title="src/views.tsx">src/views.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span>export</span><span> interface</span><span> </span><span>PostPageProps</span><span> extends</span><span> </span><span>ProfileProps</span><span>, </span><span>PostViewProps</span><span> {}</span></span>
<span></span>
<span><span>export</span><span> const</span><span> </span><span></span><span>:</span><span> </span><span></span><span>&lt;</span><span>PostPageProps</span><span>&gt; </span><span>=</span><span> (</span><span></span><span>) </span><span>=&gt;</span><span> (</span></span>
<span><span>  &lt;&gt;</span></span>
<span><span>    &lt;</span><span></span></span>
<span><span>      </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>      </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>      </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>      </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>      </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>    /&gt;</span></span>
<span><span>    &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span>} /&gt;</span></span>
<span><span>  &lt;/&gt;</span></span>
<span><span>);</span></span></code></pre></div></div><p>Now we need to write code to actually query the database and get the number of following accounts.</p><p>Open the <em>src/app.tsx</em> file and modify the <code>GET /users/{username}</code> request handler as follows:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/users/:username&#34;</span><span>, </span><span>async</span><span> (</span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  // ... omitted ...</span></span>
<span><span>  if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span> </span><span></span><span>.</span><span></span><span>();</span></span>
<span></span>
<span><span>  // biome-ignore lint/style/noNonNullAssertion: Always returns a single record</span></span>
<span><span>  const</span><span> { </span><span></span><span> } </span><span>=</span><span> </span><span></span></span>
<span><span>    .</span><span></span><span>&lt;</span><span>unknown</span><span>[], { </span><span></span><span>:</span><span> number</span><span> }&gt;(</span></span>
<span><span>      `</span></span>
<span><span>      SELECT count(*) AS following</span></span>
<span><span>      FROM follows</span></span>
<span><span>      JOIN actors ON follows.follower_id = actors.id</span></span>
<span><span>      WHERE actors.user_id = ?</span></span>
<span><span>      `</span><span>,</span></span>
<span><span>    )</span></span>
<span><span>    .</span><span></span><span>(</span><span></span><span>.</span><span></span><span>)</span><span>!</span><span>;</span></span>
<span><span>  // ... omitted ...</span></span>
<span><span>  return</span><span> </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span></span>
<span><span>        </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span> </span><span>??</span><span> </span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>        </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>        </span><span></span><span>=</span><span>{</span><span></span><span>}</span></span>
<span><span>        </span><span></span><span>=</span><span>{</span><span></span><span>}</span></span>
<span><span>        </span><span></span><span>=</span><span>{</span><span></span><span>}</span></span>
<span><span>      /&gt;</span></span>
<span><span>      &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>} /&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;,</span></span>
<span><span>  );</span></span>
<span><span>});</span></span></code></pre></div></div><p>Also modify the <code>GET /users/{username}/posts/{id}</code> request handler:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/users/:username/posts/:id&#34;</span><span>, (</span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  // ... omitted ...</span></span>
<span><span>  if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span> </span><span></span><span>.</span><span></span><span>();</span></span>
<span></span>
<span><span>  // biome-ignore lint/style/noNonNullAssertion: Always returns a single record</span></span>
<span><span>  const</span><span> { </span><span></span><span>, </span><span></span><span> } </span><span>=</span><span> </span><span></span></span>
<span><span>    .</span><span></span><span>&lt;</span><span>unknown</span><span>[], { </span><span></span><span>:</span><span> number</span><span>; </span><span></span><span>:</span><span> number</span><span> }&gt;(</span></span>
<span><span>      `</span></span>
<span><span>      SELECT sum(follows.follower_id = ?) AS following,</span></span>
<span><span>             sum(follows.following_id = ?) AS followers</span></span>
<span><span>      FROM follows</span></span>
<span><span>      `</span><span>,</span></span>
<span><span>    )</span></span>
<span><span>    .</span><span></span><span>(</span><span></span><span>.</span><span></span><span>, </span><span></span><span>.</span><span></span><span>)</span><span>!</span><span>;</span></span>
<span><span>  return</span><span> </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span></span>
<span><span>        </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span> </span><span>??</span><span> </span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>        </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>        </span><span></span><span>=</span><span>{</span><span></span><span>.</span><span></span><span>}</span></span>
<span><span>        </span><span></span><span>=</span><span>{</span><span></span><span>}</span></span>
<span><span>        </span><span></span><span>=</span><span>{</span><span></span><span>}</span></span>
<span><span>        </span><span></span><span>=</span><span>{</span><span></span><span>}</span></span>
<span><span>      /&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;,</span></span>
<span><span>  );</span></span>
<span><span>});</span></span></code></pre></div></div><p>If you&#39;ve made all these modifications, open the <a href="http://localhost:8000/users/johndoe" target="_blank" rel="noreferrer">http://localhost:8000/users/johndoe</a> page in your web browser:</p><p><img src="https://ntietz.com/assets/profile-page-5.Bs7wI18J.png" alt="Profile page"/></p><h2 id="timeline" tabindex="-1">Timeline <a href="#timeline" aria-label="Permalink to &#34;Timeline&#34;">​</a></h2><p>We&#39;ve implemented many things, but posts written on other Mastodon servers are still not visible. As you might have guessed from the process so far, just as we sent a <code>Create(Note)</code> activity when we wrote a post, we need to receive a <code>Create(Note)</code> activity from other servers to see posts written on other Mastodon servers.</p><p>To see exactly what happens when a post is written on another Mastodon server, let&#39;s create a new post on <a href="https://activitypub.academy/" target="_blank" rel="noreferrer">ActivityPub.Academy</a>:</p><p><img src="https://ntietz.com/assets/academy-compose.DJU3L4C1.png" alt="Creating a new post on ActivityPub.Academy"/></p><p>After pressing the <em>Publish!</em> button to save the post, go to the <em>Activity Log</em> page and check if the <code>Create(Note)</code> activity was indeed sent:</p><p><img src="https://ntietz.com/assets/activity-log-8.8tG98GVz.png" alt="Activity Log showing sent Create(Note) activity"/></p><p>Now we need to write code to receive this sent <code>Create(Note)</code> activity.</p><h3 id="receiving-create-note-activity" tabindex="-1">Receiving <code>Create(Note)</code> activity <a href="#receiving-create-note-activity" aria-label="Permalink to &#34;Receiving `Create(Note)` activity&#34;">​</a></h3><p>Open the <em>src/federation.ts</em> file and <code>import</code> the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Create"><code>Create</code></a> class provided by Fedify:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>import</span><span> {</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,  </span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  </span><span></span><span>,</span></span>
<span><span>  type</span><span> </span><span></span><span> </span><span>as</span><span> </span><span></span><span>,</span></span>
<span><span>  type</span><span> </span><span>Recipient</span><span>,</span></span>
<span><span>} </span><span>from</span><span> &#34;@fedify/fedify&#34;</span><span>;</span></span></code></pre></div></div><p>And add <code>on(Create, ...)</code> to the inbox code:</p><div><p><span data-title="src/federation.ts">src/federation.ts</span></p><div><p><span>typescript</span></p><pre tabindex="0"><code><span><span>  .</span><span></span><span>(</span><span></span><span>, </span><span>async</span><span> (</span><span></span><span>, </span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> await</span><span> </span><span></span><span>.</span><span></span><span>();</span></span>
<span><span>    if</span><span> (</span><span>!</span><span>(</span><span></span><span> </span><span>instanceof</span><span> </span><span></span><span>)) </span><span>return</span><span>;</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>;</span></span>
<span><span>    if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span>;</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> await</span><span> </span><span></span><span>.</span><span></span><span>();</span></span>
<span><span>    if</span><span> (</span><span>!</span><span></span><span>(</span><span></span><span>) </span><span>||</span><span> </span><span></span><span>.</span><span></span><span>?.</span><span></span><span> </span><span>!==</span><span> </span><span></span><span>.</span><span></span><span>) </span><span>return</span><span>;</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> (</span><span>await</span><span> </span><span></span><span>(</span><span></span><span>))?.</span><span></span><span>;</span></span>
<span><span>    if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span>;</span></span>
<span><span>    if</span><span> (</span><span></span><span>.</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span>;</span></span>
<span><span>    const</span><span> </span><span></span><span> =</span><span> </span><span></span><span>.</span><span></span><span>?.</span><span></span><span>();</span></span>
<span><span>    </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>      &#34;INSERT INTO posts (uri, actor_id, content, url) VALUES (?, ?, ?, ?)&#34;</span><span>,</span></span>
<span><span>    ).</span><span></span><span>(</span><span></span><span>.</span><span></span><span>.</span><span></span><span>, </span><span></span><span>, </span><span></span><span>, </span><span></span><span>.</span><span></span><span>?.</span><span></span><span>);</span></span>
<span><span>  });</span></span></code></pre></div></div><p>We use the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Object.prototype.getAttribution"><code>getAttribution()</code></a> method to get the author, then add the actor to the <code>actors</code> table if it&#39;s not already there using the <code>persistActor()</code> function. Then we add a new record to the <code>posts</code> table.</p><p>To check if the code is working well, let&#39;s go back to <a href="https://activitypub.academy/" target="_blank" rel="noreferrer">ActivityPub.Academy</a> and create a post. Open the <em>Activity Log</em> to check if the <code>Create(Note)</code> activity was sent, then use the following command to check if a record was indeed added to the <code>posts</code> table:</p><div><p><span>sh</span></p><pre tabindex="0"><code><span><span>echo</span><span> &#34;SELECT * FROM posts WHERE actor_id != 1&#34;</span><span> |</span><span> sqlite3</span><span> -table</span><span> microblog.sqlite3</span></span></code></pre></div><p>If a record was indeed added, you should see a result like this:</p><table tabindex="0"><thead><tr><th><code>id</code></th><th><code>uri</code></th><th><code>actor_id</code></th><th><code>content</code></th><th><code>url</code></th><th><code>created</code></th></tr></thead><tbody><tr><td><code>3</code></td><td><code>https://activitypub.academy/users/algusia_draneoll/statuses/113068684551948316</code></td><td><code>3</code></td><td><code>&lt;p&gt;Would it send a Create(Note) activity?&lt;/p&gt;</code></td><td><code>https://activitypub.academy/@algusia_draneoll/113068684551948316</code></td><td><code>2024-09-02 15:33:32</code></td></tr></tbody></table><h3 id="displaying-remote-posts" tabindex="-1">Displaying remote posts <a href="#displaying-remote-posts" aria-label="Permalink to &#34;Displaying remote posts&#34;">​</a></h3><p>Now that we&#39;ve added remote posts as records in the <code>posts</code> table, all that&#39;s left is to display these records well. This is often called a <q>timeline</q> feature.</p><p>First, open the <em>src/views.tsx</em> file and modify the <code>&lt;Home&gt;</code> component:</p><div><p><span data-title="src/views.tsx">src/views.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span>export</span><span> interface</span><span> </span><span>HomeProps</span><span> extends</span><span> </span><span>PostListProps</span><span> {</span></span>
<span><span>  </span><span></span><span>:</span><span> </span><span>User</span><span> &amp;</span><span> </span><span>Actor</span><span>;</span></span>
<span><span>}</span></span>
<span></span>
<span><span>export</span><span> const</span><span> </span><span></span><span>:</span><span> </span><span></span><span>&lt;</span><span>HomeProps</span><span>&gt; </span><span>=</span><span> ({ </span><span></span><span>, </span><span></span><span> }) </span><span>=&gt;</span><span> (</span></span>
<span><span>  &lt;&gt;</span></span>
<span><span>    {</span><span>/* ... omitted ... */</span><span>}</span></span>
<span><span>    &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>} /&gt;</span></span>
<span><span>  &lt;/&gt;</span></span>
<span><span>);</span></span></code></pre></div></div><p>Then, open the <em>src/app.tsx</em> file and modify the <code>GET /</code> request handler:</p><div><p><span data-title="src/app.tsx">src/app.tsx</span></p><div><p><span>tsx</span></p><pre tabindex="0"><code><span><span></span><span>.</span><span></span><span>(</span><span>&#34;/&#34;</span><span>, (</span><span></span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  // ... omitted ...</span></span>
<span><span>  if</span><span> (</span><span></span><span> </span><span>==</span><span> null</span><span>) </span><span>return</span><span> </span><span></span><span>.</span><span></span><span>(</span><span>&#34;/setup&#34;</span><span>);</span></span>
<span></span>
<span><span>  const</span><span> </span><span></span><span> =</span><span> </span><span></span></span>
<span><span>    .</span><span></span><span>&lt;</span><span>unknown</span><span>[], </span><span>Post</span><span> &amp;</span><span> </span><span>Actor</span><span>&gt;(</span></span>
<span><span>      `</span></span>
<span><span>      SELECT actors.*, posts.*</span></span>
<span><span>      FROM posts</span></span>
<span><span>      JOIN actors ON posts.actor_id = actors.id</span></span>
<span><span>      WHERE posts.actor_id = ? OR posts.actor_id IN (</span></span>
<span><span>        SELECT following_id</span></span>
<span><span>        FROM follows</span></span>
<span><span>        WHERE follower_id = ?</span></span>
<span><span>      )</span></span>
<span><span>      ORDER BY posts.created DESC</span></span>
<span><span>      `</span><span>,</span></span>
<span><span>    )</span></span>
<span><span>    .</span><span></span><span>(</span><span></span><span>.</span><span></span><span>, </span><span></span><span>.</span><span></span><span>);</span></span>
<span><span>  return</span><span> </span><span></span><span>.</span><span></span><span>(</span></span>
<span><span>    &lt;</span><span></span><span>&gt;</span></span>
<span><span>      &lt;</span><span></span><span> </span><span></span><span>=</span><span>{</span><span></span><span>} </span><span></span><span>=</span><span>{</span><span></span><span>} /&gt;</span></span>
<span><span>    &lt;/</span><span></span><span>&gt;,</span></span>
<span><span>  );</span></span>
<span><span>});</span></span></code></pre></div></div><p>Now that we&#39;ve implemented everything, let&#39;s open the <a href="http://localhost:8000/" target="_blank" rel="noreferrer">http://localhost:8000/</a> page in your web browser to admire the timeline:</p><p><img src="https://ntietz.com/assets/home-6.Chj_T8HC.png" alt="Timeline visible on the home page"/></p><p>As you can see above, posts created remotely and posts created locally are displayed in chronological order. How do you like it?</p><p>This is all we&#39;re going to implement in this tutorial. Based on this, you should be able to complete your own microblog.</p><h2 id="areas-for-improvement" tabindex="-1">Areas for improvement <a href="#areas-for-improvement" aria-label="Permalink to &#34;Areas for improvement&#34;">​</a></h2><p>Unfortunately, the microblog you&#39;ve completed through this tutorial is not yet suitable for real use. In particular, there are many vulnerabilities in terms of security, so it could be dangerous to actually use it.</p><p>For those who want to further develop the microblog you&#39;ve created, you might want to try solving the following challenges:</p><ul><li><p>Currently, there&#39;s no authentication, so anyone can post if they know the URL. How about adding a login process to prevent this?</p></li><li><p>The current implementation directly outputs the HTML contained in the <a href="https://jsr.io/@fedify/fedify@1.6.0-dev.757+7fa54fbc/doc/~/Note"><code>Note</code></a> object received via ActivityPub. Therefore, a malicious ActivityPub server could send a <code>Create(Note)</code> activity containing HTML like <code>&lt;script&gt;while (true) alert(&#39;Gotcha!&#39;);&lt;/script&gt;</code>. This is called an <a href="https://en.wikipedia.org/wiki/Cross-site_scripting" target="_blank" rel="noreferrer">XSS</a> vulnerability. How can we prevent such vulnerabilities?</p></li><li><p>Let&#39;s try changing the name of the actor we created by executing the following SQL in the SQLite database:</p><div><p><span>sql</span></p><pre tabindex="0"><code><span><span>UPDATE</span><span> actors </span><span>SET</span><span> name</span><span> =</span><span> &#39;Renamed&#39;</span><span> WHERE</span><span> id </span><span>=</span><span> 1</span><span>;</span></span></code></pre></div><p>When we change the actor&#39;s name like this, will the changed name be applied on other Mastodon servers? If not, what kind of activity should we send to apply the change?</p></li><li><p>Let&#39;s try adding a profile picture to the actor. If you&#39;re wondering how to add a profile picture, try using the <code>fedify lookup</code> command to look up an actor that already has a profile picture.</p></li><li><p>Try creating a post with an image attached on another Mastodon server. In the timeline we created, the image attached to the post isn&#39;t visible. How can we display the attached image?</p></li><li><p>Let&#39;s make it possible to mention other actors within a post. What should we do to send a notification to the mentioned party? Use the <em>Activity Log</em> of <a href="https://activitypub.academy/" target="_blank" rel="noreferrer">ActivityPub.Academy</a> to find a way.</p></li></ul></div></div></main><!--[--><!--]--></div></div></div>
  </body>
</html>
