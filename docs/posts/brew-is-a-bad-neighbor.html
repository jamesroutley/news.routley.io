<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://gist.github.com/pudquick/29bc95b6c49703992981864e48f8e341">Original</a>
    <h1>Brew Is a Bad Neighbor</h1>
    
    <div id="readability-page-1" class="page"><div>
  <div id="file-brew-md">
      
      <div id="file-brew-md-readme">
    <article itemprop="text">
<p dir="auto">This isn&#39;t a guide about locking down homebrew so that it can&#39;t touch the rest of your system security-wise.</p>
<p dir="auto">This guide doesn&#39;t fix the inherent security issues of a package management system that will literally yell at you if you try to do something about &#34;huh, maybe it&#39;s not great my executables are writeable by my account without requiring authorization first&#34;.</p>
<p dir="auto">But it absolutely <em>is</em> a guide about shoving it into its own little corner so that you can take it or leave it as you see fit, instead of just letting the project do what it likes like completely taking over permissions and ownership of a directory that might be in use by other software on your Mac and stomping all over their contents.</p>
<p dir="auto">By following this guide you will:</p>
<ul dir="auto">
<li>Never have to run <code>sudo</code> to forcefully change permissions of some directory to be owned by your account</li>
<li>Pick and choose exactly what binaries from homebrew you want to have exposed to your environment</li>
<li>Make it possible to effectively &#34;unhook&#34; the installed homebrew environment on-demand</li>
<li>You could even have multiple separate installs side-by-side, if you wanted</li>
</ul>

<p dir="auto">I create a lot of my own tools - and other times I&#39;ll have tools built by others that I just like to keep somewhere non-standard to avoid some app or something I install that relies on an opensource component that decides to ship those components in &#34;their standard location&#34; and ends up clobbering <code>/usr/local</code> or other paths.</p>
<p dir="auto">So to that end, I created a <code>.local</code> folder in my home directory. The structure you&#39;d find inside it is the same as you&#39;d see in <code>/usr</code> or <code>/usr/local</code>, with a <code>bin</code>, <code>lib</code>, <code>share</code>, etc. I have this path prepended onto the front of my <code>$PATH</code> for my shell:</p>
<div dir="auto"><pre><span>export</span> PATH=<span><span>&#34;</span>~/.local/bin:<span>$PATH</span><span>&#34;</span></span></pre></div>
<p dir="auto">The <code>.</code> at the beginning of <code>.local</code> ensures that if I&#39;m looking in my home folder in the Finder, it won&#39;t clutter the view unless I reveal hidden files. You could choose any name you like if you want to do this. And because it&#39;s at the front of my <code>$PATH</code>, anything I link into <code>.local/bin</code> takes precedence - I know I&#39;ll be running a specific instance of a binary named <code>foo</code> if I put or link something named <code>foo</code> into it.</p>
<p dir="auto">If you want a little extra security here, feel free to adjust the path permissions so that you can&#39;t write or add new things to this path without elevating. (But it won&#39;t be much, mind - homebrew will still be doing its thing as our unauthenticated user account in the end, as you&#39;ll see)</p>

<p dir="auto">homebrew (grudgingly?) supports being installed in a non-standard folder. They just don&#39;t suggest it to you up front. It&#39;s tucked away in the detailed installation page under &#34;Alternative Installs&#34;:</p>
<p dir="auto"><a href="https://docs.brew.sh/Installation#untar-anywhere" rel="nofollow">https://docs.brew.sh/Installation#untar-anywhere</a></p>
<p dir="auto">What&#39;s the downside of doing this?</p>
<ul dir="auto">
<li>A lot of precompiled packages will now require compiling, because it&#39;s not the standard path so the linked library paths in the prebuilt binaries won&#39;t work. As a concrete example: Installing the <code>ghc</code> package after freshly setting up homebrew as listed above required compilation - total time was 8 minutes and 7 seconds including all the dependencies.</li>
<li>Some (poorly built) packages potentially won&#39;t work because they make assumptions about path. In practice, I haven&#39;t run into this yet.</li>
</ul>
<p dir="auto">What&#39;s the <strong>upside</strong> of doing this?</p>
<ul dir="auto">
<li>It&#39;s not camped out in <code>/usr/local</code> or <code>/opt</code></li>
<li>You&#39;re not blindly directly executing a script you just curl&#39;d down</li>
<li>If you&#39;ve got a managed IT environment that thinks massively distributing or managing a default path homebrew install across engineering laptops is a good idea, by doing this you won&#39;t be fighting with their install or having to run <code>brew doctor</code> to repair permissions flips</li>
<li>You never have to enter your password or use <code>sudo</code> to set it up</li>
<li>(And more we&#39;ll get into shortly here)</li>
</ul>
<p dir="auto">So I <code>cd</code> into my <code>~/.local</code> and then follow the main instruction they have there:</p>
<div dir="auto"><pre>mkdir homebrew <span>&amp;&amp;</span> curl -L https://github.com/Homebrew/brew/tarball/master <span>|</span> tar xz --strip 1 -C homebrew</pre></div>
<p dir="auto">That&#39;s it really. You&#39;ve got homebrew installed now. Since it was installed in your home directory - no need to change any permissions. No <code>sudo</code> required.</p>
<p dir="auto">But you still have to patch in <code>brew</code> itself to your shell session, since you&#39;ve got it tucked away right now in <code>~/.local/homebrew/bin/brew</code>, which so far you haven&#39;t added to your <code>$PATH</code>.</p>

<p dir="auto">homebrew, as part of some of the other things it does that I don&#39;t like, if you symlink it into a <code>bin</code>-like path that you&#39;ve included in your <code>$PATH</code>, when you execute it it will &#34;helpfully&#34; analyze the path it was called from and use that as a target destination for installing symlinks to all the binaries anything you install generates.</p>
<p dir="auto">But we don&#39;t want that. We put baby in the corner and it needs to stay there.</p>
<p dir="auto">So the trick is adding this to your shell environment: <code>alias brew=~/.local/homebrew/bin/brew</code></p>
<p dir="auto">This makes it so that <code>brew</code> is available to your shell environment as a callable command, but what it&#39;s calling is the fully qualified path that <code>brew</code> already lives in, as a subdirectory under <code>~/.local/homebrew</code></p>
<p dir="auto">The net effect of this is: <strong>everything you install or update with brew stays in this folder</strong></p>
<p dir="auto">All of the binaries only get linked into <code>~/.local/homebrew/bin</code></p>
<p dir="auto">Want to completely nuke this homebrew install? <strong>Remove the directory - done!</strong></p>
<p dir="auto">Done installing something with <code>brew</code>?</p>
<p dir="auto">You can now use <code>ln</code> to symlink <em>exactly</em> what you please into <code>~/.local/bin</code>. So if the act of installing a single package in homebrew results in 5+ additional packages being installed, all with their own binaries, when it&#39;s finished installing everything and the kitchen sink you can make sure that <strong>only the exact single thing that you wanted in the first place</strong> is allowed to be seen outside of that directory (instead of finding out later that something had a side effect of installing a <code>brew</code> copy of python you never wanted, etc).</p>
<p dir="auto">This is why I said not to adjust your <code>$PATH</code> to include <code>homebrew/bin</code> itself to make <code>brew</code> work. It would work - but it would also make <em>every</em> single thing you installed exposed as callable in your shell environment. We don&#39;t want that.</p>
<p dir="auto">Worried about other projects that use headers or libraries installed by <code>brew</code>?</p>
<p dir="auto"><strong>Most</strong> of the ones I&#39;ve seen are smart and use <code>$(brew --prefix)</code> to automatically figure out the correct platform independent path your libraries are at. Easily 95% or more of what I see out there is doing this. There are <em>some</em> things you&#39;ll run into out there though where that might not be the case, but you can fix that almost always by using something like:</p>
<div dir="auto"><pre>CFLAGS=<span><span>&#34;</span>-I<span><span>$(</span>brew --prefix<span>)</span></span>/include<span>&#34;</span></span> LDFLAGS=<span><span>&#34;</span>-L<span><span>$(</span>brew --prefix<span>)</span></span>/lib<span>&#34;</span></span></pre></div>

<p dir="auto">It&#39;s easy. Just get rid of the alias. <code>alias brew=</code></p>
<p dir="auto">Now its existence isn&#39;t discoverable. All of your built packages are off in their <code>~/.local/homebrew</code> jail, but because it&#39;s on a non-standard path nothing is able to discover and link to the results - and because <code>brew</code> itself can&#39;t be found, it can&#39;t be queried for library/linker paths.</p>
<p dir="auto">There&#39;s the danger here still of them finding or tripping across the binaries you&#39;ve linked into <code>~/.local/bin</code>, sure. But if you think you might want to take advantage of the ability to hide <code>brew</code> products during a build, you could always keep that in a separate <code>brewbin</code> path that you add or remove from your <code>$PATH</code>.</p>
<p dir="auto">Now that you understand the basics of how this works, there&#39;s lots of options and flexibility. Maybe try to fix some of the core security issues in homebrew and move its path and managing it to a dedicated service account. Do what you like - go wild!</p>
<p dir="auto">But most importantly: don&#39;t let <code>brew</code> win</p>
</article>
  </div>

  </div>
</div></div>
  </body>
</html>
