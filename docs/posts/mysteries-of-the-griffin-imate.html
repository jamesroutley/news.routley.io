<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.projectgus.com/2023/04/griffin-imate/">Original</a>
    <h1>Mysteries of the Griffin iMate</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="description articleBody">
<p><em>A vintage keyboard, a mysterious battery, and some questionable 1990s engineering choices...</em></p>
<h2>Keyboard</h2>
<p>For five years this classic keyboard has sat in my cupboard:</p>
<p><a href="https://www.projectgus.com/images/2023-04/keyboard.webp"><img alt="Apple Extended Keyboard II" src="https://www.projectgus.com/images/2023-04/derivatives/article/1x/keyboard.webp" srcset="https://www.projectgus.com/images/2023-04/derivatives/article/1x/keyboard.webp 1x, https://www.projectgus.com/images/2023-04/derivatives/article/2x/keyboard.webp 2x, https://www.projectgus.com/images/2023-04/derivatives/article/4x/keyboard.webp 4x"/></a></p>
<p>This is an Apple Extended Keyboard II, released 1990. This model is <a href="https://macclack.com/reviewed-apple-extended-keyboard-ii/">praised</a> by keyboard nerds for its &#34;clicky&#34; mechanical ALPS switches and sturdy design.</p>
<p>This particular keyboard has a hand-written asset sticker from the <a href="https://en.wikipedia.org/wiki/Department_of_Administrative_Services_(1987%E2%80%931993)">Federal Department of Administrative Affairs</a> (1987-1993):</p>
<p><a href="https://www.projectgus.com/images/2023-04/asset_sticker.webp"><img alt="Asset Sticker on back of keyboard" src="https://www.projectgus.com/images/2023-04/derivatives/medium/1x/asset_sticker.webp" srcset="https://www.projectgus.com/images/2023-04/derivatives/medium/1x/asset_sticker.webp 1x, https://www.projectgus.com/images/2023-04/derivatives/medium/2x/asset_sticker.webp 2x, https://www.projectgus.com/images/2023-04/derivatives/medium/4x/asset_sticker.webp 4x"/></a></p>
<p>I think either my Dad or I bought this at an ex-government auction in the late 1990s, together with a Macintosh IIsi that was briefly our dial-up modem router at home. Later, the Macintosh and its keyboard spent around twenty years in my Dad&#39;s shed.</p>
<p>When my parents downsized five years ago, the Mac and its magnificent <a href="https://www.cultofmac.com/469981/today-in-apple-history-remember-the-macintosh-portrait-display/">Portrait Display</a> were sold. I kept the keyboard.</p>
<p>Recently I saw it sitting in the cupboard, once again forgotten. Time to actually use this thing!</p>
<h2>Birthday</h2>
<p>The keyboard was a bit sad and unsanitary, with a thick layer of 1990s grime. So I gave it a birthday!<sup id="fnref:birthday"><a href="#fn:birthday">1</a></sup></p>
<p>Specifically I stripped it down, washed all the plastic parts, and put it back together.</p>
<p><a href="https://www.projectgus.com/images/2023-04/keyboard_disassembled.webp"><img alt="Partly dismantled keyboard" src="https://www.projectgus.com/images/2023-04/derivatives/medium/1x/keyboard_disassembled.webp" srcset="https://www.projectgus.com/images/2023-04/derivatives/medium/1x/keyboard_disassembled.webp 1x, https://www.projectgus.com/images/2023-04/derivatives/medium/2x/keyboard_disassembled.webp 2x, https://www.projectgus.com/images/2023-04/derivatives/medium/4x/keyboard_disassembled.webp 4x"/></a></p>
<p><a href="https://www.projectgus.com/images/2023-04/keys_drying.webp"><img alt="Key caps drying on dining table" src="https://www.projectgus.com/images/2023-04/derivatives/medium/1x/keys_drying.webp" srcset="https://www.projectgus.com/images/2023-04/derivatives/medium/1x/keys_drying.webp 1x, https://www.projectgus.com/images/2023-04/derivatives/medium/2x/keys_drying.webp 2x, https://www.projectgus.com/images/2023-04/derivatives/medium/4x/keys_drying.webp 4x"/></a></p>
<p><a href="https://www.ifixit.com/Teardown/Apple+Extended+Keyboard+II+Teardown/42138">iFixit&#39;s teardown</a> is very helpful. The vintage plastics on this particular keyboard seem to be in good condition, despite my clumsiness nothing snapped off.</p>
<p><a href="https://www.projectgus.com/images/2023-04/clean_keyboard.webp"><img alt="Clean Keyboard" src="https://www.projectgus.com/images/2023-04/derivatives/article/1x/clean_keyboard.webp" srcset="https://www.projectgus.com/images/2023-04/derivatives/article/1x/clean_keyboard.webp 1x, https://www.projectgus.com/images/2023-04/derivatives/article/2x/clean_keyboard.webp 2x, https://www.projectgus.com/images/2023-04/derivatives/article/4x/clean_keyboard.webp 4x"/></a></p>
<p>It&#39;s never going to be pristine, but it&#39;s now a lot nicer to look at and use.</p>
<h2>No Yak Shaving</h2>
<p>Being from 1990, this keyboard connects using <a href="https://en.wikipedia.org/wiki/Apple_Desktop_Bus">Apple Desktop Bus</a> (ADB):</p>
<p><a href="https://www.projectgus.com/images/2023-04/adb_port.webp"><img alt="ADB port on keyboard" src="https://www.projectgus.com/images/2023-04/derivatives/medium/1x/adb_port.webp" srcset="https://www.projectgus.com/images/2023-04/derivatives/medium/1x/adb_port.webp 1x, https://www.projectgus.com/images/2023-04/derivatives/medium/2x/adb_port.webp 2x, https://www.projectgus.com/images/2023-04/derivatives/medium/4x/adb_port.webp 4x"/></a></p>
<p>A converter is required to connect it over USB.</p>
<p>For an embedded developer prone to distraction, this creates a risky situation... the task is simple enough, and countless DIY versions already exist, so it&#39;s tempting to &#34;just knock something together&#34;. One could build on the <a href="https://github.com/tmk/tmk_keyboard/wiki/Apple-Desktop-Bus">classic TMK firmware</a>, leverage the <a href="https://github.com/micropython/micropython-lib/pull/558">USB device support I&#39;ve been implementing for MicroPython</a>, or pick a real challenge like bit-banging low speed USB in <a href="https://noxim.xyz/blog/rust-ch32v003/">Rust on a dirt cheap RISC-V micro</a>.</p>
<p><strong>NO! BAD GUS! TOO MANY PROJECTS!</strong></p>
<p>I reminded myself that I have too many projects already, including a <a href="https://www.projectgus.com/tag/ev-conversion-project.html">whole electric car conversion to do</a>. Best not to chase more squirrels or shave more yaks.</p>
<p>In hindsight, I should have ordered a <a href="https://geekhack.org/index.php?topic=72052.0">pre-built TMK ADB-USB adapter</a> at this point. However, overseas shipping is slow. Someone on eBay Australia had listed a &#34;Griffin Technology iMate Universal ADB to USB Adapter&#34;. Confirmed working, reasonable price, and even in the original packaging:</p>
<p><a href="https://www.projectgus.com/images/2023-04/griffin_imate.webp"><img alt="Griffin iMate in original packaging" src="https://www.projectgus.com/images/2023-04/derivatives/medium/1x/griffin_imate.webp" srcset="https://www.projectgus.com/images/2023-04/derivatives/medium/1x/griffin_imate.webp 1x, https://www.projectgus.com/images/2023-04/derivatives/medium/2x/griffin_imate.webp 2x, https://www.projectgus.com/images/2023-04/derivatives/medium/4x/griffin_imate.webp 4x"/></a></p>
<h2>Griffin Technology</h2>
<p>These days Griffin Technology seem to mostly sell phone cases, but in the 1990s they specialised in Macintosh accessories. When the iMac was released in 1998, Apple switched from ADB to USB. So in 1999 Griffin released the iMate to adapt ADB devices to &#34;<a href="https://web.archive.org/web/19990430062021/http://www.griffintechnology.com:80/imac/index.html">iMacs, Macs with USB, and PCs with USB</a>&#34;. Pretty cutting edge stuff!</p>
<p>Griffin seem to have sold the iMate from late 1998 through to <a href="https://web.archive.org/web/20081220102759/http://www.griffintechnology.com/category/desktop">late 2008</a>. Not a bad run!</p>
<h2>iMate No Good</h2>
<p>Sadly, my laptop didn&#39;t work with the iMate and the Apple Extended Keyboard II. The iMate briefly enumerates over USB but goes immediately into a permanent USB reset loop before giving up. The Linux kernel log tells the sad tale:</p>
<div><pre><span></span><code>17:34:38 usb 3-4: new low-speed USB device number 6 using xhci_hcd
17:34:38 usb 3-4: New USB device found, idVendor=077d, idProduct=0405, bcdDevice= 3.70
17:34:38 usb 3-4: New USB device strings: Mfr=1, Product=2, SerialNumber=0
17:34:38 usb 3-4: Product: iMate, USB To ADB Adaptor
17:34:38 usb 3-4: Manufacturer: Griffin Technology, Inc.
17:34:38 input: Griffin Technology, Inc. iMate, USB To ADB Adaptor as /devices/pci0000:00/0000:00:14.0/usb3/3-4/3-4:1.0/0003:077D:04&gt;
17:34:38 hid-generic 0003:077D:0405.000C: input,hidraw6: USB HID v1.00 Keyboard [Griffin Technology, Inc. iMate, USB To ADB Adaptor]&gt;
17:34:38 input: Griffin Technology, Inc. iMate, USB To ADB Adaptor as /devices/pci0000:00/0000:00:14.0/usb3/3-4/3-4:1.1/0003:077D:04&gt;
17:34:38 hid-generic 0003:077D:0405.000D: input,hidraw7: USB HID v1.00 Mouse [Griffin Technology, Inc. iMate, USB To ADB Adaptor] on&gt;
17:34:40 usb 3-4: reset low-speed USB device number 6 using xhci_hcd
17:34:42 usb 3-4: reset low-speed USB device number 6 using xhci_hcd
17:34:43 usb 3-4: reset low-speed USB device number 6 using xhci_hcd
17:34:45 usb 3-4: reset low-speed USB device number 6 using xhci_hcd
17:34:45 usb 3-4: reset low-speed USB device number 6 using xhci_hcd
17:34:47 usb 3-4: reset low-speed USB device number 6 using xhci_hcd
17:34:48 usb 3-4: reset low-speed USB device number 6 using xhci_hcd
17:34:50 usb 3-4: reset low-speed USB device number 6 using xhci_hcd
17:34:50 usb 3-4: reset low-speed USB device number 6 using xhci_hcd
17:34:52 usb 3-4: reset low-speed USB device number 6 using xhci_hcd
17:34:54 usb 3-4: reset low-speed USB device number 6 using xhci_hcd
17:34:55 usb 3-4: reset low-speed USB device number 6 using xhci_hcd
17:34:56 usb 3-4: reset low-speed USB device number 6 using xhci_hcd
17:34:57 usb 3-4: reset low-speed USB device number 6 using xhci_hcd
17:34:57 usb 3-4: USB disconnect, device number 6
</code></pre></div>
<p>It worked once or twice for a moment, but never consistently. It felt a lot like an electrical noise issue...</p>
<p>I messaged the eBay seller, who confirmed the iMate had been working fine plugged into a newer &#34;AppleDesign&#34; ADB keyboard. I figured maybe it was the keyboard. After all, this one had been left in a country shed for twenty years...</p>
<h2>Capacitors</h2>
<p><em>&#34;Oh, I know! Vintage computer people are always excited about replacing old capacitors!&#34;</em></p>
<p>The keyboard had three identical 1uF electrolytic capacitors visible on the board.</p>
<p><a href="https://www.projectgus.com/images/2023-04/capacitor.webp"><img alt="One of the capacitors" src="https://www.projectgus.com/images/2023-04/derivatives/medium/1x/capacitor.webp" srcset="https://www.projectgus.com/images/2023-04/derivatives/medium/1x/capacitor.webp 1x, https://www.projectgus.com/images/2023-04/derivatives/medium/2x/capacitor.webp 2x, https://www.projectgus.com/images/2023-04/derivatives/medium/4x/capacitor.webp 4x"/></a></p>
<p>I keenly desoldered one. Out of circuit it measured 1.1uF, 110% of the rated capacitance! Solid effort for a 30+ year old capacitor.</p>
<p><em>Uh, maybe it&#39;s not the capacitors</em>. I soldered that one back on.</p>
<h2>Mystery Battery</h2>
<p>Until now I hadn&#39;t done any reading about the iMate. Reading <a href="https://deskthority.net/wiki/Griffin_iMate">its page on Deskthority</a>, I got a surprise:</p>
<blockquote>
<p>The iMate contains an <strong>undocumented button cell battery</strong>, of type CR1225. The purpose of this battery is not confirmed, as Griffin have never formally acknowledged its existence. The consensus is that it provides the power required to switch on certain Macintosh models via the keyboard, from keyboards with a power button.</p>
<p>The battery is not required (the iMate will operate without it, but without the power-on feature), but <strong>when the battery becomes depleted, the iMate may fail to function</strong></p>
</blockquote>
<p>(Emphasis mine.)</p>
<p><strong>WTAF</strong>! Why does a permanently connected USB device have a secret battery in it?</p>
<p>Taking the iMate apart,<sup id="fnref:brittle"><a href="#fn:brittle">3</a></sup> sure enough there&#39;s a coin cell battery in there:</p>
<p><a href="https://www.projectgus.com/images/2023-04/pcb_back.webp"><img alt="Back of PCB, showing coin cell" src="https://www.projectgus.com/images/2023-04/derivatives/medium/1x/pcb_back.webp" srcset="https://www.projectgus.com/images/2023-04/derivatives/medium/1x/pcb_back.webp 1x, https://www.projectgus.com/images/2023-04/derivatives/medium/2x/pcb_back.webp 2x, https://www.projectgus.com/images/2023-04/derivatives/medium/4x/pcb_back.webp 4x"/></a></p>
<p>It was totally flat. However, even with the battery removed the USB issue stayed exactly the same.</p>
<h2>Replacement battery</h2>
<p>My local $2 shop didn&#39;t have a CR1225 cell, but they did have a CR1220 cell which is the same thickness and voltage. $4 later and... the iMate worked flawlessly!<sup id="fnref:awe"><a href="#fn:awe">2</a></sup></p>
<p><a href="https://www.projectgus.com/images/2023-04/new_battery.webp"><img alt="iMate connected with new battery" src="https://www.projectgus.com/images/2023-04/derivatives/medium/1x/new_battery.webp" srcset="https://www.projectgus.com/images/2023-04/derivatives/medium/1x/new_battery.webp 1x, https://www.projectgus.com/images/2023-04/derivatives/medium/2x/new_battery.webp 2x, https://www.projectgus.com/images/2023-04/derivatives/medium/4x/new_battery.webp 4x"/></a></p>
<p>Very weird. Now I am totally Nerd Sniped: What does this mystery battery do? Why is it needed for this keyboard, but maybe not for other keyboards?</p>
<p>When I raised the issue on Mastodon I received two theories: &#34;<a href="https://aus.social/@Unixbigot/110256444797095715">totally an NSA keylogger</a>&#34;, and &#34;<a href="https://aus.social/@M0les/110264206405526721">purely for planned obsolescence</a>&#34;. I guess both are possible...</p>
<h2>Research</h2>
<p>The 2000s were a long time ago in Internet Years. The <a href="https://archive.org/donate">blessed Internet Archive</a> has captured a lot from this era, but the sources linked from Deskthority seem to be lost. There&#39;s some good info on the <a href="https://github.com/tmk/tmk_keyboard/wiki/Apple-Desktop-Bus#griffin-imate">TMK wiki</a>, including Wayback Machine links for Griffin&#39;s original iMate Support pages. Indeed, Griffin never mentioned it has a battery.</p>
<p>Time to look closely at the PCB:</p>
<p><a href="https://www.projectgus.com/images/2023-04/pcb_front.webp"><img alt="Front of iMate PCB" src="https://www.projectgus.com/images/2023-04/derivatives/article/1x/pcb_front.webp" srcset="https://www.projectgus.com/images/2023-04/derivatives/article/1x/pcb_front.webp 1x, https://www.projectgus.com/images/2023-04/derivatives/article/2x/pcb_front.webp 2x, https://www.projectgus.com/images/2023-04/derivatives/article/4x/pcb_front.webp 4x"/></a></p>
<p>The largest component is a Cypress CY7C63413-PVC. This is long discontinued, but it still has a <a href="https://www.digikey.com.au/en/products/detail/infineon-technologies/CY7C63413-PVC/464803">product page on Digikey</a> complete with <a href="https://media.digikey.com/pdf/Data%20Sheets/Cypress%20PDFs/CY7C63411,12,13%20CY7C63511,12,13.pdf">datasheet PDF</a> (published 1997, revised 1998).</p>
<p>The chip is a One Time Programmable &#34;8-bit RISC&#34; microcontroller with an integrated USB Low Speed interface. Operating voltage is 4.0V to 5.5V and there&#39;s no low power features, so it seems unlikely that the 3V battery is used directly with this micro.</p>
<p>There&#39;s also a lot of discrete parts on the PCB, and a worrying number of very high impedance 2.2 Megaohm resistors. When it comes to noise susceptibility, very high impedance terminations are a red flag.</p>
<p>In the end, I traced the whole circuit:</p>
<p><a href="https://www.projectgus.com/images/2023-04/schematic.png"><img alt="Traced Schematic" src="https://www.projectgus.com/images/2023-04/derivatives/article/1x/schematic.png" srcset="https://www.projectgus.com/images/2023-04/derivatives/article/1x/schematic.png 1x, https://www.projectgus.com/images/2023-04/derivatives/article/2x/schematic.png 2x, https://www.projectgus.com/images/2023-04/derivatives/article/4x/schematic.png 4x"/></a></p>
<p>You can <a href="https://github.com/projectgus/griffin-imate-schematic">get the KiCad files on GitHub</a>.</p>
<p>Identifying the diodes and transistors from their marking was tricky, for example Q1 on my board is marked &#34;KF&#34; and I&#39;m not sure what that is. However, between <a href="https://deskthority.net/wiki/Griffin_iMate">Deskthority</a> and <a href="https://www.flickr.com/photos/perdedor/366033415/">flickr user ninjabong (lol)</a>, there are images of two other iMate PCBs with the same layout but slightly different parts. Perhaps different production runs?</p>
<p>To understand the schematic, I first had to learn about two features of vintage Apple computers...</p>
<h2>ADB PSW Signal</h2>
<p>ADB is a single wire low speed serial bus, so the four pins on the Mini-DIN connector are 5V Power, Ground, the ADB data signal, and Power Switch (PSW).</p>
<p>In the Apple Extended Keyboard, the power switch is connected to the &#34;power&#34; key in the corner and switches the PSW signal to ground through a diode:</p>
<p><a href="https://www.projectgus.com/images/2023-04/apple_keyboard_psw.png"><img alt="Apple Extended Keyboard PSW Circuit" src="https://www.projectgus.com/images/2023-04/derivatives/article/1x/apple_keyboard_psw.png" srcset="https://www.projectgus.com/images/2023-04/derivatives/article/1x/apple_keyboard_psw.png 1x, https://www.projectgus.com/images/2023-04/derivatives/article/2x/apple_keyboard_psw.png 2x, https://www.projectgus.com/images/2023-04/derivatives/article/4x/apple_keyboard_psw.png 4x"/></a></p>
<p>In a Macintosh, the other end of this signal pin has a zener diode for protection and a 100K pullup. The signal then feeds into the &#34;MCU&#34; which can switch on the rest of the Mac:</p>
<p><a href="https://www.projectgus.com/images/2023-04/mac_iisi_schematic_extract.png"><img alt="Highlighted section of Macintosh IIsi schematic" src="https://www.projectgus.com/images/2023-04/derivatives/article/1x/mac_iisi_schematic_extract.png" srcset="https://www.projectgus.com/images/2023-04/derivatives/article/1x/mac_iisi_schematic_extract.png 1x, https://www.projectgus.com/images/2023-04/derivatives/article/2x/mac_iisi_schematic_extract.png 2x, https://www.projectgus.com/images/2023-04/derivatives/article/4x/mac_iisi_schematic_extract.png 4x"/></a></p>
<p>(<em>Part of a glorious Macintosh IIsi schematic, as created by a company called Bomarc Services and <a href="https://archive.org/details/Macintosh68kSchematics">preserved by the Internet Archive</a>. Highlighting mine.</em>)</p>
<p>Note that when the Mac is powered off no power flows to the 5V power pin on the ADB connector, the only powered pin is PSW which is pulled up to &#34;always on&#34; power inside the Macintosh.</p>
<h2>Normal USB Wakeup</h2>
<p>Modern USB devices do not have a dedicated &#34;power switch&#34; pin on their plugs.</p>
<p>Ever since USB 1.0 in 1996, there is a &#34;remote wake-up&#34; option where a USB device can stay powered in a suspended state until it wakes the host. This is what happens on most USB keyboards where pressing any key wakes the computer from sleep, or (depending on the hardware) powers on the computer.</p>
<p>Unlike the ADB power switch signal, the USB device has to stay powered for &#34;remote wake-up&#34; to work.</p>
<h2>Cursed Apple USB Power Button</h2>
<p>It seems Apple made an &#34;interesting&#34; choice in 1998 when they switched from ADB to USB. I can&#39;t find a decent technical source for this, only tidbits like this uncited quote from <a href="https://en.wikipedia.org/wiki/Apple_keyboards#Layout_and_features">Wikipedia</a>:</p>
<blockquote>
<p>The power key was replaced with a more conventional power button on early USB keyboards, thanks to a proprietary pin wired to the Macintosh&#39;s power supply in Apple&#39;s early USB implementations, subsequently eliminated on the Pro Keyboard along with the special power supply pin.</p>
</blockquote>
<p><a href="https://www.instructables.com/Intro-31/">This Instructable</a>, linked from the <a href="https://github.com/tmk/tmk_keyboard/wiki/Apple-Desktop-Bus">TMK wiki</a>, describes building a custom &#34;<em>Power Macintosh G3 power button</em>&#34; by connecting a USB cable&#39;s USB D- signal and Ground pin through a momentary pushbutton.</p>
<p>Seems like rather than implementing USB &#34;remote auto-wakeup&#34; to power on, Apple kept the spirit of the ADB PSW pin. They wired the keyboard&#39;s power button to the USB D- signal. Pressing the button shorts this signal to ground. This way the rest of the keyboard can stay unpowered, apart from the D- pin.</p>
<p><a href="https://www.projectgus.com/images/2023-04/apple_usb_power.png"><img alt="Hypothesised Apple Early USB Power Circuit" src="https://www.projectgus.com/images/2023-04/derivatives/article/1x/apple_usb_power.png" srcset="https://www.projectgus.com/images/2023-04/derivatives/article/1x/apple_usb_power.png 1x, https://www.projectgus.com/images/2023-04/derivatives/article/2x/apple_usb_power.png 2x, https://www.projectgus.com/images/2023-04/derivatives/article/4x/apple_usb_power.png 4x"/></a></p>
<p>For about $50AU I could get a &#34;model M2452&#34; Apple keyboard and confirm this sketch is accurate, but I&#39;ve already gone way too deep on this...</p>
<h2>All the FETs</h2>
<p>Looking at the iMate again, I think the extra circuitry exists to translate ADB&#39;s Power Switch signal into the &#34;Cursed Apple USB Power Button&#34; signal. Here&#39;s the relevant part of the schematic:</p>
<p><a href="https://www.projectgus.com/images/2023-04/schematic_power.png"><img alt="Traced Schematic section close up" src="https://www.projectgus.com/images/2023-04/derivatives/article/1x/schematic_power.png" srcset="https://www.projectgus.com/images/2023-04/derivatives/article/1x/schematic_power.png 1x, https://www.projectgus.com/images/2023-04/derivatives/article/2x/schematic_power.png 2x, https://www.projectgus.com/images/2023-04/derivatives/article/4x/schematic_power.png 4x"/></a></p>
<p>I think it works like this:</p>
<ol>
<li>PSW is normally pulled up to the battery voltage by pull-up resistor R3, so Q1 (P-channel FET) is normally turned off.</li>
<li>When the power key is pressed, PSW drives low and turns on Q1.</li>
<li>Q2 is another P-channel FET, whose purpose is to stop the power key from messing up USB signalling if USB is powered. If Q1 turns on then Q2&#39;s Source pin sees 3V from the battery.<ul>
<li>If USB is powered then Q2&#39;s Gate pin sees 5V, meaning Vgs remains positive and Q2 stays turned off.</li>
<li>If USB is not powered then the voltage at Q2&#39;s Gate pin is 0V, Vgs is negative, and Q2 will turn on.</li>
</ul>
</li>
<li>If Q2 turns on then the voltage from the 3V battery next appears at the Gate pin of Q3 (an N-channel FET).</li>
<li>This turns on Q3, which pulls down the USB D- pin.</li>
<li>If the iMate is connected to an old USB Mac, this signal will turn the Mac on!</li>
</ol>
<p>This pretty much works as designed as long as the battery holds charge. Yay!</p>
<p>There are some things about the schematic that I still don&#39;t understand, such as why Q1 and Q2 are different P-channel FETs with similar specifications and in compatible packages. I assume there&#39;s a key difference between them, but I don&#39;t know what.</p>
<h2>Confirming the fault</h2>
<p>If the fault is in this part of the circuit then we should be able to see it by capturing the USB data signals with a logic analyzer.</p>
<p>Here is a working iMate with a fresh battery, talking 1.5Mbps Low Speed USB:</p>
<p><a href="https://www.projectgus.com/images/2023-04/usb_working.png"><img alt="PulseView logic analyzer trace of working iMate USB" src="https://www.projectgus.com/images/2023-04/derivatives/article/1x/usb_working.png" srcset="https://www.projectgus.com/images/2023-04/derivatives/article/1x/usb_working.png 1x, https://www.projectgus.com/images/2023-04/derivatives/article/2x/usb_working.png 2x, https://www.projectgus.com/images/2023-04/derivatives/article/4x/usb_working.png 4x"/></a></p>
<p>Here are the USB signals from a faulty iMate with no battery, stuck in a USB reset loop:</p>
<p><a href="https://www.projectgus.com/images/2023-04/usb_not_working.png"><img alt="PulseView logic analyzer trace of faulty iMate USB" src="https://www.projectgus.com/images/2023-04/derivatives/article/1x/usb_not_working.png" srcset="https://www.projectgus.com/images/2023-04/derivatives/article/1x/usb_not_working.png 1x, https://www.projectgus.com/images/2023-04/derivatives/article/2x/usb_not_working.png 2x, https://www.projectgus.com/images/2023-04/derivatives/article/4x/usb_not_working.png 4x"/></a></p>
<p>The traces are similar, but on the faulty iMate the USB D- line randomly glitches to a low level (near the right of the image). The <a href="https://sigrok.org/">Sigrok</a> USB decoder has interpreted these as &#34;bus reset&#34; signals, but a compliant USB Bus Reset needs to last 10ms or longer to be valid. These pulses are much shorter, they are nothing but noise!</p>
<p>Nevertheless, the USB host is correctly interpreting them as an error and triggers a proper Bus Reset a short time later. Communication restarts until the next time the USB D- signal glitches low...</p>
<h2>So much noise</h2>
<p>The issue appears either when the battery is removed, or if the battery has completely discharged meaning its internal resistance is very high.<sup id="fnref:equivalent"><a href="#fn:equivalent">4</a></sup> At this point the entire part of the circuit connected to &#34;BATT+&#34; is effectively floating, as is the PSW pin:</p>
<p><a href="https://www.projectgus.com/images/2023-04/schematic_power_floating.png"><img alt="Schematic section with floating part highlighted" src="https://www.projectgus.com/images/2023-04/derivatives/article/1x/schematic_power_floating.png" srcset="https://www.projectgus.com/images/2023-04/derivatives/article/1x/schematic_power_floating.png 1x, https://www.projectgus.com/images/2023-04/derivatives/article/2x/schematic_power_floating.png 2x, https://www.projectgus.com/images/2023-04/derivatives/article/4x/schematic_power_floating.png 4x"/></a></p>
<p>Looking at the PSW pin on an oscilloscope, it&#39;s incredibly noisy:</p>
<p><a href="https://www.projectgus.com/images/2023-04/scope_psw_noise.png"><img alt="PSW Pin on oscilloscope" src="https://www.projectgus.com/images/2023-04/derivatives/article/1x/scope_psw_noise.png" srcset="https://www.projectgus.com/images/2023-04/derivatives/article/1x/scope_psw_noise.png 1x, https://www.projectgus.com/images/2023-04/derivatives/article/2x/scope_psw_noise.png 2x, https://www.projectgus.com/images/2023-04/derivatives/article/4x/scope_psw_noise.png 4x"/></a></p>
<p>The ADB data signal is clearly visible, coupled into the floating PSW signal:</p>
<p><a href="https://www.projectgus.com/images/2023-04/scope_psw_adb.png"><img alt="PSW and ADB Pins on oscilloscope" src="https://www.projectgus.com/images/2023-04/derivatives/article/1x/scope_psw_adb.png" srcset="https://www.projectgus.com/images/2023-04/derivatives/article/1x/scope_psw_adb.png 1x, https://www.projectgus.com/images/2023-04/derivatives/article/2x/scope_psw_adb.png 2x, https://www.projectgus.com/images/2023-04/derivatives/article/4x/scope_psw_adb.png 4x"/></a></p>
<p>(Ch1 is PSW pin and Ch2 is ADB pin.)</p>
<p>Without any low impedance path to decouple or discharge, the noise is left bouncing around the circuit!</p>
<p>I think that the noise-induced voltage at Q2&#39;s Source pin sometimes exceeds 5V. When it reaches a high enough voltage, Q2&#39;s Vgs becomes negative enough that Q2 turns on despite USB being powered and active:</p>
<p><a href="https://www.projectgus.com/images/2023-04/schematic_power_7v.png"><img alt="Schematic section with overvoltage part" src="https://www.projectgus.com/images/2023-04/derivatives/article/1x/schematic_power_7v.png" srcset="https://www.projectgus.com/images/2023-04/derivatives/article/1x/schematic_power_7v.png 1x, https://www.projectgus.com/images/2023-04/derivatives/article/2x/schematic_power_7v.png 2x, https://www.projectgus.com/images/2023-04/derivatives/article/4x/schematic_power_7v.png 4x"/></a></p>
<p>(Recall that Q2 was intended to prevent the power switch from triggering while USB was active...)</p>
<p>Q2 only has to very slightly turn on in order to pass enough current to turn on Q3 and short out the USB D- signal. This is because Q3&#39;s Gate pull-down resistor R5 is a massive 2.2Mohm, and the typical Gate cut-off voltage for Q3 is 1.2V. Even 550nA of current passing through Q2 may be enough to turn on Q3.<sup id="fnref:gate"><a href="#fn:gate">5</a></sup></p>
<p>I wasn&#39;t able to see this on the oscilloscope, the highest PSW voltage I saw was around 5V. However, probing the circuit changes its behaviour! My cheap 10X scope probe adds approximately 17pF of capacitance, and this resolves the issue: while the oscilloscope probe was attached the iMate worked perfectly!</p>
<h2>Quick Fix</h2>
<p>To validate this theory I soldered a 100nF capacitor between the BATT+ voltage and Ground. This should act as a decoupling path for the electrical noise.</p>
<p>A pretty good place to solder a surface mount capacitor is between pin 3 of D3 and one of the battery holder pins:</p>
<p><a href="https://www.projectgus.com/images/2023-04/new_capacitor_soldered.webp"><img alt="New capacitor soldered in place" src="https://www.projectgus.com/images/2023-04/derivatives/article/1x/new_capacitor_soldered.webp" srcset="https://www.projectgus.com/images/2023-04/derivatives/article/1x/new_capacitor_soldered.webp 1x, https://www.projectgus.com/images/2023-04/derivatives/article/2x/new_capacitor_soldered.webp 2x, https://www.projectgus.com/images/2023-04/derivatives/article/4x/new_capacitor_soldered.webp 4x"/></a></p>
<p>I used an 0603 sized capacitor, but an 0805 would fit better. Not the greatest soldering, but the electrons won&#39;t notice.</p>
<p>Sure enough, the iMate works fine now. The PSW signal looks much the same on the oscilloscope, but Q1 no longer turns on. I believe that any time a voltage develops between Q1 and Q2, it now discharges through Q1&#39;s body diode into the capacitor.</p>
<p>Adding more decoupling capacitors to the actual PSW line (rather than BATT+), or decreasing the value of some of the Gate resistors, would likely reduce the noise further. For now it seems to fine, though. My only doubt is how much RF noise is radiating from the ADB cable&#39;s PSW wire, but I guess I&#39;ll find out about that!<sup id="fnref:fcc"><a href="#fn:fcc">6</a></sup></p>
<p>I haven&#39;t reinstalled a battery, as I don&#39;t need the Apple Cursed USB Power Button functionality. However if someone installs a battery later on then it should all keep working fine, as well.</p>
<h2>Why this keyboard?</h2>
<p>Why did other ADB keyboards apparently work OK with a flat-battery iMate, while this one was faulty?</p>
<p>My best guess is that different ADB keyboards have different PSW circuits in them. For example, other keyboard models might have a decoupling capacitor, a pullup resistor, or better common mode noise filtering on the PSK signal. This is just a theory.</p>
<h2>Does it really need a battery?</h2>
<p>I&#39;ve been trying to think of a way Griffin could have implemented &#34;Apple Cursed USB Power Button&#34; functionality without a battery. I haven&#39;t thought of a way, yet.</p>
<p>If you were designing the iMate in 2023 then you could probably use a supercapacitor instead of a coin cell battery, and have it charged when USB was powered. Unfortunately consumer grade supercapacitors were probably quite hard to source in 1998...</p>
<p>Connecting the PSW pin directly to D- would be tempting, as the two circuits are so similar. However, then the USB D- signal would be connected into the ADB cable&#39;s PSW wire whenever USB was active, and would become an even worse antenna!<sup id="fnref2:fcc"><a href="#fn:fcc">6</a></sup> Once you start thinking of ways to block the signal when USB is enabled, and unblock it when the keyboard is unpowered, then it&#39;s hard not to wish you had access to an independent voltage source like a battery...</p>
<p>Griffin&#39;s engineers(s) seemingly ignored what happens in the circuit when the battery goes away. Some would suggest this wasn&#39;t an accident (i.e. planned obsolescence), but I think it probably was an accident. That said, not mentioning the battery at all in their support material is harder to explain.</p>
<h2>Conclusion</h2>
<p>So, uh, &#34;don&#39;t start a new project&#34; resulted in a lot more yak shaving than I&#39;d counted on...</p>
<p>Worse, I&#39;m already kind of dissatisfied with the iMate - it doesn&#39;t distinguish left and right for Alt/Shift/etc. Also, because I&#39;m not a Mac user it&#39;d be nice to have a firmware that could swap Command and Alt keys instead of needing to configure that in software. So, if I keep this keyboard then I might end up buying a different adapter for it anyway. Sigh.</p>
<p>Oh well, at least I probably learned something.</p>
<p><a href="https://www.projectgus.com/images/2023-04/on_desk.webp"><img alt="Apple Extended Keyboard II in place on my desk" src="https://www.projectgus.com/images/2023-04/derivatives/article/1x/on_desk.webp" srcset="https://www.projectgus.com/images/2023-04/derivatives/article/1x/on_desk.webp 1x, https://www.projectgus.com/images/2023-04/derivatives/article/2x/on_desk.webp 2x, https://www.projectgus.com/images/2023-04/derivatives/article/4x/on_desk.webp 4x"/></a></p>

</div></div>
  </body>
</html>
