<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://joisig.com/2023-holiday-side-project-turtles">Original</a>
    <h1>Turtles, a Shelly/Zigbee home automation tool in Elixir</h1>
    
    <div id="readability-page-1" class="page"><div aria-label="Content">
      <div>
        

<article itemscope="" itemtype="http://schema.org/BlogPosting">

  

  <div itemprop="articleBody">
    <p>
  <img cmsbear-processed="true" src="https://joisig.com/bimg/532A8FEC-0732-4AAB-BA43-DB30AD8D96EF/image.png"/>
</p>
<p>
TL;DR: If you have lights controlled by Shelly dimmers and/or via a Philips Hue bridge, <a href="https://github.com/joisig/turtles">Turtles</a> might possibly be a useful project for you. It’s reasonably simple to set up and the code is small and straight-forward so it would be easy to hack at if you like that sort of thing, but it is very limited in functionality compared to something like <a href="https://www.home-assistant.io/">Home Assistant</a>.</p>
<h2>
The itch</h2>
<p>
My wife and I recently completed a renovation project of a big part of our house. Almost all of the new lights were controlled by <a href="https://www.shelly.com/en/products/switching-and-triggering?gclid=CjwKCAiA4smsBhAEEiwAO6DEja0yUYQI_H2y2qOv6cIEB2AW1ZFw13h0JZ3KzX3fSfvNkGc9kUL9URoCrH0QAvD_BwE">Shelly dimmers</a>, which are Wi-Fi attached and have some simple APIs for programmability. A couple of lights needed more power than the Shelly dimmers could handle, and the electricians used some no-name Zigbee dimmers for this.</p>
<p>
Of course this caused an immediate itch to want to be able to control all the lights at once from my smartphone, create scenes and so on.</p>
<p>
I poked a bit at the <a href="https://shelly-api-docs.shelly.cloud/gen1/">Shelly APIs</a>, they’re very simple to use as long as you’re on the same Wi-Fi, and I ordered an off-brand Wi-Fi/Zigbee bridge via Aliexpress, figuring it might arrive before the holiday break and this could be a nice project during the holiday break.</p>
<p>
I also took a look at Home Assistant and some other existing home automation platforms. Rationally, I might have been better off going with Home Assistant, which has ready-made integrations with Shelly, Zigbee dimmers, and probably thousands of other device types, but I wanted complete control and hackability, and I preferred to spend time building my own system rather than learning and customizing Home Assistant and maybe never getting it to work like I want it to.</p>
<h2>
Scratching it</h2>
<p>
The AliExpress shipment arrived just before the holidays! Sadly, the order did not contain a Zigbee bridge but rather a Bluetooth Low Energy (BLE) bridge. The AliExpress folks brushed me off when I sent them a photo showing the packaging of the wrong device… oh well, that’s something like $20 down the drain ($8 for the thing itself with shipping, and the rest to Icelandic customs and postal authorities… don’t get me started).</p>
<p>
Lucky for me, my wife had bought a Philips Hue starter set for our son as a Christmas present, and it comes with a bridge which very quickly and easily discovered the other Zigbee lights! The Hue is very hackable, too, with <a href="https://developers.meethue.com/develop/get-started-2/">simple APIs</a> and a bunch of <a href="https://www.burgestrand.se/hue-api/">unofficial documentation</a> around the Internet. The only tricky bit was that it seems that the Hue bridge will change its MAC address from time to time, so assigning it a static IP in our home router did not work - a couple of days later it presented as a new MAC address and therefore got a different IP. In the end it was simple to implement <a href="https://www.burgestrand.se/hue-api/api/discovery/">SSDP discovery</a>.</p>
<p>
My programming language of choice these days is Elixir (along with Erlang and JavaScript) and that’s what I implemented Turtles in. The de facto standard web framework for Elixir is called Phoenix. It’s really good, but the default generator for a new project does create a veritable ton of all kinds of files and configuration, much of which I don’t need in a simple project like this… but which I haven’t gotten around to removing.</p>
<p>
To use Turtles, go get the <a href="https://github.com/joisig/turtles">source code</a>, install <a href="https://asdf-vm.com/">asdf</a>, create a file named <code>tconfig.secret.exs</code> in the <code>config</code> directory, set static IPs for all your Shelly lights in your home router, and document all the lights you want to control in the <code>tconfig.secret.exs</code> file similar to the below:</p>
<pre><code>config :turtles,
  zones: [
    &#34;Foyer&#34;,
    &#34;Kitchen&#34;
  ],
  dimmers: [
    {&#34;foyerrecessed&#34;,
      %{name: &#34;Forstofa inngangur&#34;, type: :shelly, zone: &#34;Foyer&#34;, ip: &#34;192.168.1.90&#34;}},
    {&#34;foyerindirectled&#34;,
      # Hue device unique IDs can be found at
      # http://{ip address of bridge}/api/{Hue bridge username}/lights
      %{name: &#34;Foyer indirect LEDs&#34;, type: :hue, zone: &#34;Foyer&#34;, bridge: :hue1, unique_id: &#34;04:11:84:ff:13:43:75:a3-01&#34;}},

    {&#34;kitchenbenches&#34;,
      %{name: &#34;Kitchen worktops&#34;, type: :shelly, zone: &#34;Kitchen&#34;, ip: &#34;192.168.1.96&#34;}},
    {&#34;kitchenisland&#34;,
      %{name: &#34;Kitchen island&#34;, type: :hue, zone: &#34;Kitchen&#34;, bridge: :hue1, unique_id: &#34;03:11:84:ff:13:12:75:a1-03&#34;}},
  ],
  bridges: %{
    # For details on getting the username, see
    # https://www.burgestrand.se/hue-api/api/auth/registration/
    #
    # The unique_id can be found at http://{ip address of bridge}/description.xml
    # under the &lt;serialNumber&gt; key.
    hue1: %{type: :hue, unique_id: &#34;abcdef01234&#34;, username: &#34;HUEBRIDGEUSERNAME&#34;}
  }</code></pre>
<p>
You can get fancy with how you run Elixir, building an Erlang release and/or putting everything into a Docker container, but from my perspective for a local-WiFi system like this you can simply run it in development mode as follows:</p>
<pre><code>cd ~/turtles   # assuming that&#39;s where you retrieved the code to
iex -S mix phx.server</code></pre>
<p>
Maybe run it in a <code>screen</code> session that you can detach from and reattach to later, on an always-on old Linux laptop in a closet, connected to the same Wi-Fi as the lights and bridge, of course.</p>
<h2>
Obligatory screenshots</h2>
<p>
I’ll end with some obligatory screenshots showing the UI.</p>
<p>
Let me know if you try it! It was just to scratch my own itch, but still would be fun if it’s useful for someone.</p>
<figure aria-describedby="623c4709-bc9a-4130-8fb1-bf41a678a2bc">
    <img alt="Main screen - control lights, choose scenes" cmsbear-processed="true" src="https://joisig.com/bimg/3677D008-3462-4C65-9B9B-2FEBA6DD8F1A/image%204.png" title="Main screen - control lights, choose scenes"/>
    <figcaption id="623c4709-bc9a-4130-8fb1-bf41a678a2bc">
      <p>
Main screen - control lights, choose scenes      </p>
    </figcaption>
  </figure>

<figure aria-describedby="958d810b-53e2-4fbe-8595-63b6bc340647">
    <img alt="Create a scene; give it a name and choose which lights it will affect, and it will later apply the same state to lights as they currently have" cmsbear-processed="true" src="https://joisig.com/bimg/C9A9054A-4943-490F-8D5C-3CD2EA8D59E7/image%202.png" title="Create a scene; give it a name and choose which lights it will affect, and it will later apply the same state to lights as they currently have"/>
    <figcaption id="958d810b-53e2-4fbe-8595-63b6bc340647">
      <p>
Create a scene; give it a name and choose which lights it will affect, and it will later apply the same state to lights as they currently have      </p>
    </figcaption>
  </figure>

<figure aria-describedby="44f87078-f57d-441a-83ef-868d41f886ac">
    <img alt="Manage scenes; so far all you can do is delete but I want to add reordering and renaming." cmsbear-processed="true" src="https://joisig.com/bimg/8AFCE339-7258-4154-BFB1-B4EA884B6824/image%203.png" title="Manage scenes; so far all you can do is delete but I want to add reordering and renaming."/>
    <figcaption id="44f87078-f57d-441a-83ef-868d41f886ac">
      <p>
Manage scenes; so far all you can do is delete but I want to add reordering and renaming.      </p>
    </figcaption>
  </figure>


  </div>





</article>

      </div>
    </div></div>
  </body>
</html>
