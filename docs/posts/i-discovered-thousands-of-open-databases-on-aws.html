<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://infosecwriteups.com/how-i-discovered-thousands-of-open-databases-on-aws-764729aa7f32?gi=af55b7c4e39f">Original</a>
    <h1>I discovered thousands of open databases on AWS</h1>
    
    <div id="readability-page-1" class="page"><div><div><article><div><div><section><div><div><p id="bc96">My journey on finding and reporting databases with sensitive data about Fortune-500 companies, Hospitals, Crypto platforms, Startups during due diligence, and more.</p><p id="441b"><strong><em>Table Of Contents</em></strong></p><ul><li id="e6bf"><a href="#e9d4" rel="noopener ugc nofollow"><em>Overview</em></a></li><li id="ec4a"><a href="#e257" rel="noopener ugc nofollow"><em>Background</em></a></li><li id="7235"><a href="#ac13" rel="noopener ugc nofollow"><em>My Hypothesis</em></a></li><li id="c22b"><a href="#9ccc" rel="noopener ugc nofollow"><em>Scanning</em></a></li><li id="d8f6"><a href="#bfa8" rel="noopener ugc nofollow"><em>BI &amp; Automation: From thousands to hundreds</em></a></li><li id="8bf0"><a href="#836b" rel="noopener ugc nofollow"><em>Examples of data I found</em></a></li><li id="fe72"><a href="#776f" rel="noopener ugc nofollow"><em>Conclusion</em></a></li></ul><p id="1312">It is easy to find misconfigured assets on cloud services, by scanning the <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing" rel="noopener ugc nofollow" target="_blank">CIDR</a> blocks (IP ranges) of managed services, since they are known and published by them.</p><figure><div role="button" tabindex="0"><p><img alt="" src="https://miro.medium.com/max/1400/1*IAnU4gla_lOiy4u_ZfunWQ.png" width="700" height="500" role="presentation"/></p></div><figcaption>An email from one of the companies I reported.</figcaption></figure><p id="8999">In just 1 day, I found thousands of <a href="https://www.elastic.co/" rel="noopener ugc nofollow" target="_blank">ElasticSearch</a> databases and K<a href="https://www.elastic.co/" rel="noopener ugc nofollow" target="_blank">ibana</a> dashboards that exposed sensitive information, most probably by mistake:</p><ul><li id="2712">Sensitive information about <strong>customers</strong>: <strong>emails, addresses, current occupation, salaries, private wallets addresses, locations, bank accounts</strong>, and other sensitive information.</li><li id="0d86"><strong>Production</strong> <strong>Logs </strong>that are written by Kubernetes cluster — From the applications logs to the kernels and system logs.</li><li id="4288">Some of the databases were already malformed by ransomware.</li></ul><figure><div role="button" tabindex="0"><p><img alt="" src="https://miro.medium.com/max/1400/1*vbs3OC7yoKyr6e8TH8kD_Q.png" width="700" height="65" role="presentation"/></p></div><figcaption>A company that I found compromised, is giving services to these companies. The image is taken from their website.</figcaption></figure><p id="da5d">There must be plenty of assets out there, listening outside their scope, waiting to be discovered. </p><p id="d7e9">DevOps, Developers, and IT practitioners often misconfigure some of the following:</p><ul><li id="b45c">Binding the socket on the wrong network interfaces.</li><li id="5588">Misconfigured security group for the cluster (allow all TCP and all UDP from broad <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing" rel="noopener ugc nofollow" target="_blank">CIDR blocks</a>).</li><li id="5260">Sometimes, the security group is changed by others that are not aware of the consequences.</li><li id="6def">The default network or subnet is used, subnet settings are derived, and a public IPv4 address is assigned silently.</li></ul><p id="77eb">I hypothesized that <strong>I can easily find misconfigured assets,</strong> mostly due to human errors <strong>if I will scan specific </strong><a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing" rel="noopener ugc nofollow" target="_blank"><strong>CIDR</strong></a><strong> blocks from within the cloud operator (An Instance / VPS).</strong></p><p id="4619"><strong>The key is to scan smartly</strong>, leveraging the pre-known network infrastructure (known <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing" rel="noopener ugc nofollow" target="_blank">CIDR</a>-blocks for the software we like to scan) to find live servers, that are within my reach.</p><p id="5136">If you search a bit, you can find the relevant <a href="https://docs.aws.amazon.com/general/latest/gr/aws-ip-ranges.html" rel="noopener ugc nofollow" target="_blank">CIDR blocks of every cloud provider.</a></p><p id="df15">All Cloud providers publish a list of their services along with their <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing" rel="noopener ugc nofollow" target="_blank">CIDR</a> blocks (IP addresses ranges) for each service.</p><figure><div></div><figcaption>Get the CIDR blocks of ElasticSearch Service (ES) from AWS</figcaption></figure><p id="b230">Some <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing" rel="noopener ugc nofollow" target="_blank">CIDR</a> blocks were<a href="https://en.wikipedia.org/wiki/Private_network" rel="noopener ugc nofollow" target="_blank"><strong> accessible only from within the cloud provider</strong></a>. All you have to do is to start a VPS / instance with internet connectivity inside the cloud provider you want to scan.</p><h2 id="6792">What does one need to find them?</h2><ul><li id="5c5d">A basic understanding of networks, the IP stack and routing, and cloud infrastructure.</li><li id="92d9">A lightweight tool for Port Scanning (like <a href="https://github.com/robertdavidgraham/masscan" rel="noopener ugc nofollow" target="_blank"><strong>MasScan</strong></a>, or <a href="https://nmap.org/" rel="noopener ugc nofollow" target="_blank">NMap</a>)</li><li id="e35c">A list of <a href="https://docs.aws.amazon.com/general/latest/gr/aws-ip-ranges.html" rel="noopener ugc nofollow" target="_blank">CIDR blocks</a> to scan(managed services — like <a href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank">Kubernetes</a> or <a href="https://www.elastic.co/" rel="noopener ugc nofollow" target="_blank">ElasticSearch</a>) along with the ports that are most likely to be open on the instances within these IP ranges.</li><li id="d2b7">A tool to visualize all the data we collect (like <a href="https://www.elastic.co/" rel="noopener ugc nofollow" target="_blank">ElasticSearch</a>+<a href="https://www.elastic.co/what-is/kibana" rel="noopener ugc nofollow" target="_blank">Kibana</a>)</li></ul><p id="2b68">I have used <a href="https://github.com/robertdavidgraham/masscan" rel="noopener ugc nofollow" target="_blank"><strong>MasScan</strong></a> to scan for the open ports on the CIDR blocks I selected.</p><p id="a685">The input is the CIDR blocks (e.g <em>50.60.0.0/16 or 118.23.1.0/24) </em>and the ports we would like to scan (9200, 5600, 80, 443, etc.).</p><p id="2931">I started an <strong>ELK</strong> stack on my instance using Docker images.</p><p id="8c86">I let it run for a while, and I had 337K<strong>+ IP and Ports combinations</strong> scanned in my hands, in no time. </p><figure><div role="button" tabindex="0"><p><img alt="" src="https://miro.medium.com/max/1400/1*c_wmJwIe7P-c7fN0fFG7JA.png" width="700" height="257" role="presentation"/></p></div><figcaption>337K open ports in AWS’s ElasticSearch service CIDR blocks (customers clusters), in a few hours.</figcaption></figure><blockquote><p id="13a0">The photos are censored.</p><p id="ca3f">Most of the parties addressed the issue within a day or two.</p></blockquote><p id="0a76">Thanks to the pipeline I created — I had real-time logs and I could start looking at the services immediately, as it scans for more.</p><ul><li id="bff6">I exported the assets that were up from <strong>Kibana</strong> to a <strong>CSV</strong> file using Kibana’s export button. Then I loaded it using pandas (python).</li></ul><figure><p><img alt="" src="https://miro.medium.com/max/552/1*JmgBJHRtCA6aLXObyQ4rNA.png" width="276" height="25" role="presentation"/></p></figure><ul><li id="7b57">For each IP, I fired an HTTP HEAD request and got an HTTP response with the fingerprint of the asset.</li></ul><figure><p><img alt="" src="https://miro.medium.com/max/778/1*cw9OUliReATo2rJC8eNr-w.png" width="389" height="44" role="presentation"/></p></figure><figure><p><img alt="" src="https://miro.medium.com/max/874/1*F_1Whdkh0USVh2u7P54FIg.png" width="437" height="44" role="presentation"/></p></figure><ul><li id="3456">I eliminated the responses that required authentication.</li></ul><figure><p><img alt="" src="https://miro.medium.com/max/704/1*fTdby2gUlfDOHC7vFTO9Cw.png" width="352" height="229" role="presentation"/></p></figure><ul><li id="0c85">Then I printed their web page’s titles from the HTTP response.</li></ul><figure><p><img alt="" src="https://miro.medium.com/max/588/1*spRQfef0vxfyWkf297TA6w.png" width="294" height="166" role="presentation"/></p><figcaption>We can do the same for ElasticSearch port, or any service. The IPs were already scanned by MasScan so I assumed they were up.</figcaption></figure><figure><div role="button" tabindex="0"><p><img alt="" src="https://miro.medium.com/max/1400/1*oDBq3BmgJzWyJpEYkVayVg.png" width="700" height="118" role="presentation"/></p></div><figcaption>Printing the title of the HTML documents that came in response from the endpoint I found. Can be also done using nmap’s HTTP script.</figcaption></figure><figure><div role="button" tabindex="0"><p><img alt="" src="https://miro.medium.com/max/1400/1*NxOo3DS3ZzyWxGvxSwIqyw.png" width="700" height="845" role="presentation"/></p></div><figcaption>Getting the title of the servers that I found relevant</figcaption></figure></div><div><p id="8780">so, now I have a list of all the assets, along with their web page name.</p><p id="6d73">Then, I explored the assets carefully, one at a time.</p><ul><li id="0be3"><strong><em>/_aliases</em></strong></li><li id="fb06"><strong><em>/&lt;index&gt;/_search</em></strong></li></ul><p id="001b">This <a href="https://www.elastic.co/" rel="noopener ugc nofollow" target="_blank">ElasticSearch</a> REST API is very convenient. It is easy to get the fields metadata, documents count, and everything you wanted to know about the ES cluster.</p><figure><div role="button" tabindex="0"><p><img alt="" src="https://miro.medium.com/max/1400/1*ogTOoUE4GwuJyehg6kixag.png" width="700" height="684" role="presentation"/></p></div><figcaption>ElasticSearch Index summary via /_aliases REST call</figcaption></figure><ul><li id="febc"><strong>Kubernetes logs for the entire production clusters </strong>(gathered through log collectors)</li></ul><figure><div role="button" tabindex="0"><p><img alt="" src="https://miro.medium.com/max/1400/1*QhPT-j3KK3a5ilY4lhCFlw.png" width="700" height="369" role="presentation"/></p></div><figcaption>K8 cluster logs, streamed via fluentd, with live URLs and logs to the kernel.</figcaption></figure><figure><div role="button" tabindex="0"><p><img alt="" src="https://miro.medium.com/max/1400/1*KlSONQQ2YZVVsHTE_8ZbGQ.png" width="700" height="30" role="presentation"/></p></div><figcaption>Successful SSH login using the private key</figcaption></figure><figure><div role="button" tabindex="0"><p><img alt="" src="https://miro.medium.com/max/1400/1*sk1DG-cxTd49HPoQZAdspA.png" width="700" height="397" role="presentation"/></p></div><figcaption>SSH Daemon Logs — Cluster’s machines. Realtime logs.</figcaption></figure><figure><div role="button" tabindex="0"><p><img alt="" src="https://miro.medium.com/max/1400/1*aIWhmk3KWkXRQN3cuKZriQ.png" width="700" height="657" role="presentation"/></p></div><figcaption>Full cloud visibility — instance type, AMI, account ID, visible to the world, thanks to misconfigured clusters of K8 and ElasticSearch</figcaption></figure><ul><li id="aeb2"><strong>Private Dashboards</strong></li></ul><p id="5d23">some companies have streamed Jira tasks and issued them into their ElasticSearch dashboards) — including customer data, code examples, accounts names, etc. This Kibana dashboard contained everything about the R&amp;D of the company.</p><ul><li id="e2ef"><strong>Hospitals / Medical supply — Vaccination information of individuals.</strong></li></ul><figure><div role="button" tabindex="0"><p><img alt="" src="https://miro.medium.com/max/1400/1*UFc5Xt8ntcztYs71lnpKSQ.png" width="700" height="898" role="presentation"/></p></div></figure><figure><div role="button" tabindex="0"><p><img alt="" src="https://miro.medium.com/max/1400/1*Dmw_RcLYZ2k6YbFtp7EMZQ.png" width="700" height="109" role="presentation"/></p></div><figcaption>A vaccination date along with an email address</figcaption></figure><ul><li id="9896"><strong>Crypto Trading Platform</strong></li></ul><figure><div role="button" tabindex="0"><p><img alt="" src="https://miro.medium.com/max/1400/1*S1gUPWADQQgZqmKngxJezQ.png" width="700" height="96" role="presentation"/></p></div><figcaption>Crypto Token swaps</figcaption></figure><ul><li id="6688"><strong>Banking<br/></strong>Bank transfer along with full name and bank account details.</li></ul><figure><div role="button" tabindex="0"><p><img alt="" src="https://miro.medium.com/max/1400/1*ODVl6BljY4EGUYu3MrmTHA.png" width="700" height="346" role="presentation"/></p></div><figcaption>Bank transfer along with full name and bank account details.</figcaption></figure><ul><li id="2258"><strong>Live car fleet metrics (about each car):<br/></strong>- IMEI (unique cellular identifier)</li></ul><figure><div role="button" tabindex="0"><p><img alt="" src="https://miro.medium.com/max/1400/1*bZ7plJYsNtWceGV7ZOdBhg.png" width="700" height="656" role="presentation"/></p></div></figure><p id="3ab2">sometimes I had trouble understanding whether the database is real or a <a href="https://en.wikipedia.org/wiki/Honeypot_(computing)" rel="noopener ugc nofollow" target="_blank">honeypot</a>.</p><p id="0841"><em>The document in ElasticSearch:</em></p><figure><div role="button" tabindex="0"><p><img alt="" src="https://miro.medium.com/max/1400/1*Vmm5MgfqLJ-i4c-y7GzOEA.png" width="700" height="63" role="presentation"/></p></div></figure><p id="903d"><em>The document in the production website, online:</em></p><figure><div role="button" tabindex="0"><p><img alt="" src="https://miro.medium.com/max/1400/1*7VkVII4x8b6bN7JgowbOog.png" width="700" height="210" role="presentation"/></p></div></figure></div><div><h2 id="2a44">Already-Hacked Servers by RansomWare</h2><p id="e889">If your cluster is open to the world, there is no need for a 0-day to run the ransomware. One can access everything if you have no authentication on top of that.</p><p id="60bf">As you can see, some of the assets I’ve discovered were already “hacked” (not hacked, more but malformed, by RansomWare.</p><figure><div role="button" tabindex="0"><p><img alt="" src="https://miro.medium.com/max/1400/1*uvsJCtexXhnERzOBBjWjpA.png" width="700" height="40" role="presentation"/></p></div></figure></div><div><p id="ce12">As you can imagine, many of the organizations I found were GDPR Compliant. This means they are sensitive about data breaches, they have a DPO (Data Protection Officer) who actively searches and handles this kind of incident.</p><figure><div role="button" tabindex="0"><p><img alt="" src="https://miro.medium.com/max/1400/1*jWRcbF4FQXK5Hz4YUlby1Q.png" width="700" height="108" role="presentation"/></p></div><figcaption>An example of a privacy policy I read (to find the DPO)</figcaption></figure><figure><div role="button" tabindex="0"><p><img alt="" src="https://miro.medium.com/max/1400/1*dEdvrN4OG0QsqgMdHXtAIw.png" width="700" height="67" role="presentation"/></p></div><figcaption>“Contact us if you wish to know how your data is stored”.</figcaption></figure><p id="9c24">Some DPOs did not reply, and some of the DPO’s mailboxes’ have rejected my emails with permissions errors (they are not allowed to receive emails outside the organization).</p><p id="5eb5">For some companies, the <strong>DMARC</strong> and <strong>SPF</strong> records did not allow emails to be received in their mail servers from outside the company.</p><p id="f6d9">I also sent emails to the twin companies and other subsidiaries.</p><p id="88ff">As for the ignoring companies — their assets and data are exposed to this day, and they don’t care.</p><p id="7694">Publishing CIDR blocks per service is a logical issue when it comes to port scanning. We need it for many reasons — but it poses such a huge risk for cloud providers at the same time, making their customers scannable with ease.</p><p id="756d">Misconfiguration happens all the time, and it is here to stay, causing many holes in the company&#39;s security unknowingly.</p><p id="048d"><strong>I have reported the companies that I found</strong>, until a certain limit (there were too many), and<strong> I could not reach them all on my own</strong>.</p><p id="4c20"><a href="https://aws.amazon.com/compliance/shared-responsibility-model/" rel="noopener ugc nofollow" target="_blank">Click here to learn more information about AWS’s shared responsibility model</a>.</p><p id="5c4b">At the moment all we can do is assume that misconfiguration is always possible, no matter the company’s size — and that somebody is always seeing you from the network. If you open a service to the world, at least <strong>use decent authorization and authentication</strong>.</p></div><div><p id="54fe">By the way, I am doing this in my spare time.</p><p id="cf97">Thank you for reading this far.</p><p id="8f80">If you like my works, or if you offer a bug-bounty program, let me know.</p><p id="60e2">Check out my previous releases:</p></div><div><p id="21b4">🔈 🔈<strong>Infosec Writeups is organizing its first-ever virtual conference and networking event. If you’re into Infosec, this is the coolest place to be, with 16 incredible speakers and 10+ hours of power-packed discussion sessions. </strong><a href="https://iwcon.live/" rel="noopener ugc nofollow" target="_blank"><strong>Check more details and register here.</strong></a></p></div></div></section></div></div></article></div></div></div>
  </body>
</html>
