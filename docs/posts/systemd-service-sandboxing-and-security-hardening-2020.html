<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.ctrl.blog/entry/systemd-service-hardening.html">Original</a>
    <h1>systemd service sandboxing and security hardening (2020)</h1>
    
    <div id="readability-page-1" class="page"><div property="schema:articleBody">
        <p><code translate="no">systemd</code> enable services to run with a whole suite of hardening and sandboxing features from the Linux kernel. Here’s how to get a quick security review of the services running on your system and how to go about hardening their security.</p>
        
        <p>The Linux kernel can filter and limit access to file systems, networks, devices, kernel capabilities and system calls (syscalls), and more. In this article, I’ll focus on sandboxing access to the file system as a simple introduction to <code translate="no">systemd</code> service security hardening.</p>
        <p>The <code translate="no">systemd</code> service security review tool was added in version 240 (released in <time datetime="2018-12-21">December 2018</time>.) You’ll need to be running that or a later version to follow along with this article.</p>
        <h3>Security overview of <code translate="no">systemd</code> services</h3>
        <p>Run the <code translate="no">systemd-analyze security</code> command to get a security audit of all your <code translate="no">systemd</code> services. It will list each service unit and give them a security exposure score rating from 0–10. Lower scores are more secure.</p>
        <figure>
          <pre><samp translate="no">UNIT             EXPOSURE PREDICATE
atd.service           9.6 UNSAFE
crond.service         9.6 UNSAFE
httpd.service         9.2 UNSAFE
mariadb.service       8.8 EXPOSED
sshd.service          9.6 UNSAFE</samp></pre>
        </figure>
        <p>The exposure score is entirely based on a service’s utilization of security features provided by <code translate="no">systemd</code>. It doesn’t consider security features built-in to the program or enforced by access control policies like Security-Enhanced Linux (SELinux) or AppArmor. Nor does the score in any way evaluate the risk factors of a program or its configuration.</p>
        <p>In the above example, you’ll notice that task scheduling daemons like <code translate="no">atd</code> and <code translate="no">crond</code> and the remote terminal access daemon for <code translate="no">sshd</code> are considered to be unsafe. That’s an accurate assessment as these services are designed to allow unrestricted execution of arbitrary commands. You may want to disable these services entirely unless you need them.</p>
        <p>You can also see that the <code translate="no">httpd</code> (Apache HTTP Server) service has a slightly lower score. This is because Fedora Linux, which is the distribution I use, ships its <code translate="no">httpd</code> service unit with a few <code translate="no">systemd</code> security directives enabled by default. Let’s look at how to review a service’s security directives next.</p>
        <h3>Analyze a service’s security directives</h3>
        <p>You should start by analyzing any service that is exposed to the public internet or deal with untrusted/user-provided data. These services will benefit system security the most from being sandboxed. We looked at the Apache web server earlier, so let us stick with that example.</p>
        <p>Run the <code translate="no">systemd-analyze security httpd.service</code> command to generate a report of the security directives applied to the <code translate="no">httpd.service</code>.</p>
        <p>As of version 233, there are 77 tests in the security review. Below, I’ve included a small selection of test results that focus on file system access.</p>
        <figure>
          <pre><samp translate="no">  NAME                   DESCRIPTION                                          EXPOSURE
<span>✗</span> PrivateDevices         Service potentially has access to hardware devices        0.2
✓ PrivateTmp             Service has no access to other software&#39;s temporary files
<span>✗</span> ProtectControlGroups   Service may modify to the control group file system       0.2
<span>✗</span> ProtectHome            Service has full access to home directories               0.2
<span>✗</span> ProtectKernelTunables  Service may alter kernel tunables                         0.2
<span>✗</span> ProtectSystem          Service has full access to the OS file hierarchy          0.2
<span>✗</span> RestrictSUIDSGID       Service may create SUID/SGID files                        0.2
<span>✗</span> RootDirectory          Service runs within the host&#39;s root directory             0.1
…
→ Overall exposure level for httpd.service: 9.2 UNSAFE</samp></pre>
        </figure>
        <p>We can see that Apache HTTP Server is restricted to its own sandboxed temp directory and that it doesn’t have access to the system <code translate="no">/tmp</code> directory. This is a default policy for <code translate="no">httpd</code> on Fedora Linux. You may get different results in your Linux distribution of choice.</p>
        <p>The test results show us that our web server could definitively be configured to be more secure. There’s a lot of room for improvement, depending on your Apache HTTP Server configuration. Your web server probably doesn’t need write-access to most locations in your file hierarchy. It probably doesn’t even need read-access.</p>
        <p>Let’s move on to tightening the security of the <code translate="no">httpd.service</code>.</p>
        <h3>Service unit security hardening</h3>
        <p>Run the <code translate="no">systemctl edit httpd.service</code> command to make changes to the <code translate="no">httpd</code> service unit. This will open a text editor where any change you make will override the service’s default directives. (It will use your default text editor as specified in the <code translate="no">EDITOR</code> environmental variable.)</p>
        <p>The following is an example service unit override that addresses some of the points identified in the above security review. Please refer to the <a href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html" rel="external" title="“systemd.exec”"><code translate="no">systemd.exec</code> man page</a> for extensive documentation on each directive.</p>
        <figure resource="#article-source-code-example1" typeof="cc:Work schema:SoftwareSourceCode">
          
          <meta content="ini" property="programmingLanguage"/>
          <pre><code translate="no"><span>[Service]</span>
<span>PrivateDevices</span><span>=</span><span>true</span>
<span>ProtectControlGroups</span><span>=</span><span>true</span>
<span>ProtectHome</span><span>=</span><span>true</span>
<span>ProtectKernelTunables</span><span>=</span><span>true</span>
<span>ProtectSystem</span><span>=</span><span>full</span>
<span>RestrictSUIDSGID</span><span>=</span><span>true</span></code></pre>
        </figure>
        <p>Save this to the override file, run the <code translate="no">systemctl daemon-reload</code> command to make <code translate="no">systemd</code> aware of the changes, and finally <code translate="no">systemctl restart httpd.service</code> to make the changes take effect. You should see about 2 points improvement if you re-run the service security directive testing.</p>
        <p>You now need to do extensive testing to ensure that everything still works as expected. You’ve put in place restrictions that the program was never designed to run under. It or programs you run on top of it may misbehave under these conditions. You may need to grant it access to specific files or directories. Let’s look at how you do that.</p>
        <p>If something breaks with the above configuration, it might suggest that you’ve tasked your web server to do something potentially risky.</p>
        <h3>Further locking down access</h3>
        <p>The <code translate="no">ProtectSystem=full</code> directive makes the <code translate="no">/boot</code>, <code translate="no">/etc</code>, and <code translate="no">/usr</code> directories read-only. This will prevent a compromised program from interfering with system configurations. However, a compromised program can still read and copy sensitive data such as your Let’s Encrypt certificates from the <code translate="no">/etc/letsencrypt</code> directory.</p>
        
        <p>You can block access to specific directories by adding them to the <code translate="no">InaccessiblePaths=-/etc/letsencrypt</code> directive. You can specify multiple paths separated by space characters. Any file or directory under that path in the file hierarchy will be made inaccessible. The minus in front of the path tells <code translate="no">systemd</code> not to raise an error if the path doesn’t exist at runtime.</p>
        <p>The <code translate="no">InaccessiblePaths</code> directive combined with the ones from the above example can be used to effectively prevent different processes from getting at each other’s data. You may not want to maintain a white-list per service. However, you should at least set up a block-list of sensitive locations and make them inaccessible to every other service.</p>
        <p>You can take it one step further and manually specify <code translate="no">ReadWritePaths</code>, <code translate="no">ReadOnlyPaths</code>, and <code translate="no">InaccessiblePaths</code>. A utility like <code translate="no"><a href="https://strace.io/" rel="external" title="strace project home page">strace</a> -e trace=%file <mark>program</mark></code> can help you identify what paths a program requires. Requirements will change over time so a setup like this requires ongoing monitoring.</p>
        <p>You can go even further and change the root directory with the <code translate="no">RootDirectory</code> directive. This works like the traditional <code translate="no">chroot</code> command and lets you set up a mock file system and launch the service inside it.</p>
        <h3>Conclusions</h3>
        <p><code translate="no">systemd</code> can offer extra protections for your custom services as well as services shipped by your Linux distributed. Your Linux distributions may ship services with little or no protections. Security needs differ from installation to installation so it’s up to the system administrator to enable security protections.</p>
        <p>You can quickly strengthen your system security by deploying some of the standard sandboxing directives. It may just be the thing that saves your organization from having a compromised service turn into a security nightmare.</p>
        <p>Read on to part two for a <a href="https://www.ctrl.blog/entry/systemd-opensmtpd-hardening.html" title="“Limit the impact of a security intrusion with systemd directives”">tutorial on more advanced <code translate="no">systemd</code> security directives</a>.</p>
        
      </div></div>
  </body>
</html>
