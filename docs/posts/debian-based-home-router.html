<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/tonusoo/koduinternet-cpe">Original</a>
    <h1>Show HN: Debian-based home router</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<h2 id="user-content-table-of-contents" tabindex="-1" dir="auto"><a id="user-content--book-table-of-contents" aria-hidden="true" href="#-book-table-of-contents"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="book" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d6.png">üìñ</g-emoji> Table of Contents</h2>
<details open="open">
  <summary>Table of Contents</summary>
  <ol dir="auto">
    <li><a href="#about-the-project"> ‚û§ About The Project</a></li>
    <li><a href="#hardware"> ‚û§ Hardware</a></li>
    <li><a href="#configuring-nic-nvram"> ‚û§ Configuring NIC NVRAM</a></li>
    <li><a href="#modifying-the-nic-driver"> ‚û§ Modifying the NIC driver</a></li>
    <li><a href="#rooting-the-sfp-ont"> ‚û§ Rooting the SFP ONT</a></li>
    <li><a href="#modifying-the-sfp-ont-serial"> ‚û§ Modifying the SFP ONT serial</a></li>
    <li>
      <a href="#debian-10-config"> ‚û§ Debian 10 config</a>
      <ul dir="auto">
        <li><a href="#udev-usb_modeswitch-config">udev and usb_modeswitch config</a></li>
        <li><a href="#network-config">network config</a></li>
        <li><a href="#iptables">iptables</a></li>
        <li><a href="#dnsmasq">dnsmasq</a></li>
        <li><a href="#radvd">radvd</a></li>
        <li><a href="#igmpproxy">igmpproxy</a></li>
        <li><a href="#ntp-config">NTP config</a></li>
        <li><a href="#hostapd">hostapd</a></li>
        <li><a href="#linux-pam-config">Linux PAM config</a></li>
      </ul>
    </li>
    <li><a href="#bandwidth-tests"> ‚û§ Bandwidth tests</a></li>
    <li>
      <a href="#hardware-mods"> ‚û§ Hardware mods</a>
      <ul dir="auto">
        <li><a href="#nic-fan-replacement">Replacing the Dell N20KJ stock fan with Noctua NF-A4x10 fan</a></li>
      </ul>
    </li>
    <li><a href="#acknowledgements"> ‚û§ Acknowledgements</a></li>
    <li><a href="#license"> ‚û§ License</a></li>
  </ol>
</details>
<h2 id="user-content-about-the-project" tabindex="-1" dir="auto"><a id="user-content--pencil-about-the-project" aria-hidden="true" href="#-pencil-about-the-project"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="memo" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png">üìù</g-emoji> About The Project</h2>
<p dir="auto">
Debian based router on conventional PC hardware and SFP GPON ONT replacing the <a href="https://pood.telia.ee/ruuterid-ja-digiboksid/ruuter-Telia-X2-Technicolor-DGA4330/DGA4330-TELIA" rel="nofollow">Technicolor</a> or <a href="https://pood.telia.ee/ruuterid-ja-digiboksid/ruuter-Genexis-Pure-ED500/ED500A-TELIA" rel="nofollow">Genexis</a> router and stand-alone <a href="https://pood.telia.ee/vorguseadmed-ja-lisad/v%C3%B5rguseade-Huawei-HG8010H/HG8010H-TELIA" rel="nofollow">Huawei ONT</a> provided by ISP.
</p>
<p dir="auto"><a href="#configuring-nic-nvram">&#34;Configuring NIC NVRAM&#34;</a> and <a href="#modifying-the-nic-driver">&#34;Modifying the NIC driver&#34;</a> steps are needed if <code>2500BASE-X</code> link between the NIC and SFP ONT is desired instead of <code>1000BASE-T</code> link. <a href="#rooting-the-sfp-ont">&#34;Rooting the SFP ONT&#34;</a> and <a href="#modifying-the-sfp-ont-serial">&#34;Modifying the SFP ONT serial&#34;</a> steps are mandatory because Telia authenticates ONT by its serial number.</p>
<h2 id="user-content-hardware" tabindex="-1" dir="auto"><a id="user-content--clipboard-hardware" aria-hidden="true" href="#-clipboard-hardware"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="clipboard" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cb.png">üìã</g-emoji> Hardware</h2>
<div data-snippet-clipboard-copy-content="CPU: Intel Core i7-4790K @ 4.00GHz (Cooler Master Hyper 212 EVO cooler)
MB: ASRock H97 Anniversary
RAM: Crucial 8 GiB CT102464BA160B.C16FER
SSD: Corsair Force LS 2.5&#34; 60 GB SATA3
NIC: Dell N20KJ; Broadcom BCM57810 (wan0 and lan0; driver bnx2x; firmware /usr/lib/firmware/bnx2x/bnx2x-e2-7.13.1.0.fw; NF-A4x10 fan)
NIC: integrated; Realtek RTL8111/8168/8411 (lan1; driver r8169; firmware /usr/lib/firmware/rtl_nic/rtl8168g-2.fw)
NIC: TP-LINK TG-3468; Realtek RTL8111/8168/8411 (lan2; driver r8169; firmware /usr/lib/firmware/rtl_nic/rtl8168e-2.fw)
NIC: TP-LINK TG-3468; Realtek RTL8111/8168/8411 (lan3; driver r8169; firmware /usr/lib/firmware/rtl_nic/rtl8168e-2.fw)
WNIC: Asus PCE-AC88; Broadcom BCM4366(v4) (wlan0; driver brcmfmac; firmware /usr/lib/firmware/brcm/brcmfmac4366c-pcie.bin)
LTE modem: Huawei E3372s-153 (hw ver: CL1E3372SM Ver.A; firmware ver: 22.286.03.02.07)
SFP ONT: Huawei MA5671A
PSU: Chieftec CTG-500-80P
case: Chieftec 1E0-500A-CT04"><pre><code>CPU: Intel Core i7-4790K @ 4.00GHz (Cooler Master Hyper 212 EVO cooler)
MB: ASRock H97 Anniversary
RAM: Crucial 8 GiB CT102464BA160B.C16FER
SSD: Corsair Force LS 2.5&#34; 60 GB SATA3
NIC: Dell N20KJ; Broadcom BCM57810 (wan0 and lan0; driver bnx2x; firmware /usr/lib/firmware/bnx2x/bnx2x-e2-7.13.1.0.fw; NF-A4x10 fan)
NIC: integrated; Realtek RTL8111/8168/8411 (lan1; driver r8169; firmware /usr/lib/firmware/rtl_nic/rtl8168g-2.fw)
NIC: TP-LINK TG-3468; Realtek RTL8111/8168/8411 (lan2; driver r8169; firmware /usr/lib/firmware/rtl_nic/rtl8168e-2.fw)
NIC: TP-LINK TG-3468; Realtek RTL8111/8168/8411 (lan3; driver r8169; firmware /usr/lib/firmware/rtl_nic/rtl8168e-2.fw)
WNIC: Asus PCE-AC88; Broadcom BCM4366(v4) (wlan0; driver brcmfmac; firmware /usr/lib/firmware/brcm/brcmfmac4366c-pcie.bin)
LTE modem: Huawei E3372s-153 (hw ver: CL1E3372SM Ver.A; firmware ver: 22.286.03.02.07)
SFP ONT: Huawei MA5671A
PSU: Chieftec CTG-500-80P
case: Chieftec 1E0-500A-CT04
</code></pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/router_with_side_panel_removed.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/router_with_side_panel_removed.jpg" alt="router with side panel removed"/></a></p>
<h2 id="user-content-configuring-nic-nvram" tabindex="-1" dir="auto"><a id="user-content--small_blue_diamond-configuring-nic-nvram" aria-hidden="true" href="#-small_blue_diamond-configuring-nic-nvram"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="small_blue_diamond" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f539.png">üîπ</g-emoji> Configuring NIC NVRAM</h2>
<p dir="auto">Both the <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/docs/hw_415752.pdf">Huawei MA5671A SFP ONT</a> and <code>Dell N20KJ</code> NIC using the <code>Broadcom BCM57810</code> chipset support the 2500BASE-X mode. According to <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/docs/netxtreme_ii.pdf">Broadcom NetXtreme II Network Adapter User Guide</a>, the 2500BASE-X is a term used by Broadcom to describe 2.5 Gbit/s operation, where electricals are leveraged from IEEE 802.3ae-2002 (XAUI).</p>
<p dir="auto">By default, the <code>Dell N20KJ</code> branded NIC supports 1GigE and 10GigE modes. One needs to configure the NIC&#39;s NVRAM with <a href="https://github.com/tonusoo/koduinternet-cpe/raw/main/uefi_ediag.tgz">QLogic BCM577xx/BCM578xx diagnostics utility named eDiag</a> in order to enable the 2500BASE-X mode. For example, the NIC can be passed through to a VM where <code>ediag_x64.efi</code> UEFI binary in engineering mode(<code>-b10eng</code>) is executed:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/UEFI_shell_in_qemu_VM.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/UEFI_shell_in_qemu_VM.jpg" alt="UEFI shell in qemu VM"/></a></p>
<p dir="auto">Command for creating the VM in the upper <code>tmux</code> pane was:</p>
<div data-snippet-clipboard-copy-content="# PCIe passthrough requires IOMMU support.
# &#34;OVMF.fd&#34; UEFI is from the &#34;ovmf&#34; package.
qemu-system-x86_64 \
    -name eDiag-VM \
    --enable-kvm \
    -m 1G \
    -bios /usr/share/ovmf/OVMF.fd \
    -serial telnet:127.0.0.1:5016,server,nowait \
    -nographic \
    -drive file=fat:rw:UEFI/uefi_ediag/x64/,format=raw \
    -device vfio-pci,host=01:00.0,rombar=0 \
    -device vfio-pci,host=01:00.1,rombar=0"><pre><code># PCIe passthrough requires IOMMU support.
# &#34;OVMF.fd&#34; UEFI is from the &#34;ovmf&#34; package.
qemu-system-x86_64 \
    -name eDiag-VM \
    --enable-kvm \
    -m 1G \
    -bios /usr/share/ovmf/OVMF.fd \
    -serial telnet:127.0.0.1:5016,server,nowait \
    -nographic \
    -drive file=fat:rw:UEFI/uefi_ediag/x64/,format=raw \
    -device vfio-pci,host=01:00.0,rombar=0 \
    -device vfio-pci,host=01:00.1,rombar=0
</code></pre></div>
<p dir="auto">As seen on the lower <code>tmux</code> pane, the first ports is set to <code>2.5G</code> mode:
<a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/UEFI_eDiag_in_qemu_VM.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/UEFI_eDiag_in_qemu_VM.jpg" alt="UEFI eDiag in qemu VM"/></a></p>
<p dir="auto"><code>2500BASE-X</code> mode was enabled and set as a default for the first port with <code>eDiag</code> CLI commands below:</p>
<div data-snippet-clipboard-copy-content="device 1
nvm cfg
7
35=70
36=70
56=6
59=6
save
exit"><pre><code>device 1
nvm cfg
7
35=70
36=70
56=6
59=6
save
exit
</code></pre></div>
<p dir="auto">Correct link settings for the first port can be seen below:
<a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/UEFI_eDiag_in_qemu_VM_2_5G_settings.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/UEFI_eDiag_in_qemu_VM_2_5G_settings.jpg" alt="UEFI eDiag in qemu VM 2.5G settings"/></a></p>
<h2 id="user-content-modifying-the-nic-driver" tabindex="-1" dir="auto"><a id="user-content--small_blue_diamond-modifying-the-nic-driver" aria-hidden="true" href="#-small_blue_diamond-modifying-the-nic-driver"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="small_blue_diamond" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f539.png">üîπ</g-emoji> Modifying the NIC driver</h2>
<p dir="auto"><code>bnx2x</code> driver was <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/patches/bnx2x_link.patch">patched</a> in order to support the 2500BASE-X mode and ignore the Tx fault:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/bnx2x_link_diff.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/bnx2x_link_diff.jpg" alt="bnx2x_link.c diff"/></a></p>
<p dir="auto">Without ignoring the Tx fault, the Ethernet link would drop down if the fiber to <code>MA5671A SFP ONT</code> is not connected and ONT is not successfully registered by the OLT.</p>
<p dir="auto">Example of taking the patched driver into use:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/patching_the_bnx2x_driver.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/patching_the_bnx2x_driver.jpg" alt="patching the bnx2x driver"/></a></p>
<p dir="auto">For troubleshooting purposes, the driver can be loaded in debug mode with <code>modprobe -v bnx2x debug=0x4102034</code>.</p>
<p dir="auto"><code>2500BASE-X</code> link between the <code>MA5671A SFP ONT</code> and <code>Dell N20KJ</code> NIC observed from the Linux router:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/MA5671A_and_2500BASE-X_link_from_r1.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/MA5671A_and_2500BASE-X_link_from_r1.jpg" alt="MA5671A and 2500BASE-X link from r1"/></a></p>
<p dir="auto">The same link mode seen from the non-rooted <code>MA5671A SFP ONT</code> <code>minishell</code> with the <code>lanpsg</code>(LAN port status get) command where <code>link_status</code> value <code>5</code> means <code>2500BASE-X</code>:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/MA5671A_and_2500BASE-X_link_from_non-rooted_MA5671A.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/MA5671A_and_2500BASE-X_link_from_non-rooted_MA5671A.jpg" alt="MA5671A and 2500BASE-X link from non-rooted MA5671A"/></a></p>
<p dir="auto">Link mode checked from the rooted <code>MA5671A SFP ONT</code>:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/MA5671A_and_2500BASE-X_link_from_rooted_MA5671A.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/MA5671A_and_2500BASE-X_link_from_rooted_MA5671A.jpg" alt="MA5671A and 2500BASE-X link from rooted MA5671A"/></a></p>
<p dir="auto">In case the <code>2500BASE-X</code> mode is not desired, then <code>Huawei MA5671A SFP ONT</code> links also in <code>1000BASE-T</code> mode:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/MA5671A_and_1000BASE-T_link_from_r1_and_rooted_MA5671A.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/MA5671A_and_1000BASE-T_link_from_r1_and_rooted_MA5671A.jpg" alt="MA5671A and 1000BASE-T link from r1 and rooted MA5671A.jpg"/></a></p>
<p dir="auto">Once the link is established, the SFP is accessible at 192.168.1.10 via SSH. User is <code>root</code> and password is <code>admin123</code>.</p>
<h2 id="user-content-rooting-the-sfp-ont" tabindex="-1" dir="auto"><a id="user-content--small_blue_diamond-rooting-the-sfp-ont" aria-hidden="true" href="#-small_blue_diamond-rooting-the-sfp-ont"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="small_blue_diamond" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f539.png">üîπ</g-emoji> Rooting the SFP ONT</h2>
<p dir="auto">One option to root the <code>Huawei MA5671A SFP ONT</code> is to short the <code>GND</code>(pin <code>4</code>) and <code>Serial Data Input</code>(pin <code>5</code>) of the <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/docs/Infineon-S25FL129P_128-Mbit_3.0_V_Flash_Memory-DataSheet-v11_00-EN.pdf">flash memory</a> and power on the SFP. The SFP will boot into bootrom CLI and one can transfer a modified boot loader(<a href="https://github.com/tonusoo/koduinternet-cpe/raw/main/1224ABORT.bin">1224ABORT.bin</a>) to flash chip with XMODEM file transfer protocol.</p>
<p dir="auto"><code>Huawei MA5671A SFP ONT</code> with wires soldered to <code>GND</code> and <code>SI</code> pins:
<a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/MA5671A_with_soldered_wires_to_flash.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/MA5671A_with_soldered_wires_to_flash.jpg" alt="MA5671A with soldered wires to flash"/></a></p>
<p dir="auto"><code>Huawei MA5671A SFP ONT</code> connected to <a href="https://www.reveltronics.com/en/products/sfp-qsfp-xfp" rel="nofollow">Reveltronics adapter board</a>:
<a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/MA5671A_connected_to_reveltronics_board.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/MA5671A_connected_to_reveltronics_board.jpg" alt="MA5671A connected to reveltronics board"/></a></p>
<p dir="auto">As seen above, the <code>RXD</code>, <code>TXD</code> and <code>GND</code> of the USB to TTL (3.3V) adapter are connected to transceivers adapter board.</p>
<p dir="auto">Minicom(<code>115200 8N1</code>) screenshot of the <code>Huawei MA5671A SFP ONT</code> bootup where <code>GND</code> and <code>SI</code> pins of the flash were shorted:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/falcon_cli_after_modified_u-boot_upload.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/falcon_cli_after_modified_u-boot_upload.jpg" alt="FALCON CLI after modified U-Boot upload"/></a></p>
<p dir="auto">Typing the <code>7</code> in the <code>ROM:</code> prompt started the XMODEM file transfer mode and <code>Ctrl + c</code> aborted the autoboot. Setting the variables below will keep the bootloader open after the SFP module restart:</p>
<div data-snippet-clipboard-copy-content="FALCON =&gt; setenv bootdelay 5
FALCON =&gt; setenv asc 0
FALCON =&gt; setenv preboot &#34;gpio input 105;gpio input 106;gpio input 107;gpio input 108;gpio set 3;gpio set 109;gpio set 110;gpio clear 423;gpio clear 422;gpio clear 325;gpio clear 402;gpio clear 424&#34;
FALCON =&gt; saveenv"><pre><code>FALCON =&gt; setenv bootdelay 5
FALCON =&gt; setenv asc 0
FALCON =&gt; setenv preboot &#34;gpio input 105;gpio input 106;gpio input 107;gpio input 108;gpio set 3;gpio set 109;gpio set 110;gpio clear 423;gpio clear 422;gpio clear 325;gpio clear 402;gpio clear 424&#34;
FALCON =&gt; saveenv
</code></pre></div>
<p dir="auto">After rebooting the module, the <code>minishell</code> was replaced with <code>ash</code> shell with <code>sed -i  &#34;s|/opt/lantiq/bin/minishell|/bin/ash|g&#34; /etc/passwd</code>.</p>
<p dir="auto"><a href="https://github.com/tonusoo/koduinternet-cpe/raw/main/1224ABORT.bin">1224ABORT.bin</a>(MD5 <code>10e94a4b4acdc82dec20c7904b69e5c0</code>) is a slightly modified U-Boot version 1.22.4 binary image for <code>MA5671A</code>. Hex dumps diff between the <code>1224ABORT.bin</code> and <a href="https://github.com/minhng99/alcatel_lucent-lantiq_falcon/blob/master/mtd/mtd0">unmodified U-boot for this module</a>(<code>Huawei MA5671A</code> is based on <code>Alcatel-Lucent G-010S-P</code>) can be seen below:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/1224ABORT_hex_dump_compared_to_vanilla_U-boot.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/1224ABORT_hex_dump_compared_to_vanilla_U-boot.jpg" alt="1224ABORT.bin hex dump compared to vanilla U-boot"/></a></p>
<p dir="auto">Boot messages over serial of the rooted <code>MA5671A SFP ONT</code> can be seen <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/docs/rooted_MA5671A_boot_messages.txt">here</a>.</p>
<h2 id="user-content-modifying-the-sfp-ont-serial" tabindex="-1" dir="auto"><a id="user-content--small_blue_diamond-modifying-the-sfp-ont-serial" aria-hidden="true" href="#-small_blue_diamond-modifying-the-sfp-ont-serial"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="small_blue_diamond" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f539.png">üîπ</g-emoji> Modifying the SFP ONT serial</h2>
<p dir="auto">GPON OLT does not register the new SFP ONT if its serial number differs from the serial number of the <code>Huawei HG8010H ONT</code> installed by Telia. In other words, the serial number of the ONT is used for authentication. Here is a screenshot of the OLT CLI from <a href="https://forum.huawei.com/enterprise/en/sfp-mini-ont-ma5671a-ploam-password/thread/686439-100181" rel="nofollow">Huawei forum</a> showing the status of the ONT:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/Huawei_GPON_OLT_CLI.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/Huawei_GPON_OLT_CLI.jpg" alt="Huawei GPON OLT CLI"/></a></p>
<p dir="auto">The serial of the <code>Huawei HG8010H</code> provided by Telia can be seen from the web interface:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/HG8010H_status.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/HG8010H_status.jpg" alt="HG8010H status"/></a></p>
<p dir="auto">Default username is <code>root</code> and password is <code>admin</code>. One could also log in as a privileged user named <code>telecomadmin</code> with password <code>admintelecom</code>. For example, this allows one to enable telnet access to <code>Huawei HG8010H ONT</code> by downloading its configuration file from the web interface, modifying the <code>TELNETLanEnable</code> parameter and uploading the configuration. The same serial from <code>Huawei HG8010H</code> CLI:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/HG8010H_telnet_cli.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/HG8010H_telnet_cli.jpg" alt="HG8010H telnet CLI"/></a></p>
<p dir="auto">The hex representation of the serial is also printed on the label under the <code>Huawei HG8010H</code> chassis and additionally on its cardboard box.</p>
<p dir="auto"><code>MA5671A SFP ONT</code> stores the base64 encoded serial number in U-Boot environment(<code>/dev/mtd1</code> flash partition named <code>uboot_env</code>) variable called &#34;sfp_a2_info&#34;. The &#34;sfp_a2_info&#34; variable contains multiple base64 encoded fields/lines which are separated with <code>@</code> character. For example, the MAC address is on the ninth field and GPON ONT password is on the fifth field. However, only the serial needs to be changed and this is on the sixth, 45 bytes long base64 encoded field:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/MA5671A_serial_in_sfp_a2_info.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/MA5671A_serial_in_sfp_a2_info.jpg" alt="MA5671A serial in sfp_a2_info"/></a></p>
<p dir="auto">As seen above, the output of the <code>fw_printenv sfp_a2_info</code> was transferred to <code>r1</code> Debian machine where the sixth base64 field was decoded to binary and dumped to hex. In order to change the serial number for example from <code>HWTCa1b1c1d1</code> to <code>HWTCa2b2c2d2</code>, it&#39;s necessary to prepare a new value of &#34;sfp_a2_info&#34; variable:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/MA5671A_new_sfp_a2_info_prepared.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/MA5671A_new_sfp_a2_info_prepared.jpg" alt="MA5671A new sfp_a2_info prepared"/></a></p>
<p dir="auto">As a final step, the modified &#34;sfp_a2_info&#34; variable needs to be written to <code>/dev/mtd1</code> with <code>fw_setenv</code> and SFP ONT has to be rebooted so U-Boot reads the updated variable:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/MA5671A_new_sfp_a2_info_written.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/MA5671A_new_sfp_a2_info_written.jpg" alt="MA5671A new_sfp_a2_info written"/></a></p>
<p dir="auto">As mentioned before, the default password for <code>root</code> user is <code>admin123</code>. It&#39;s recommended to back up the <code>/dev/mtd1</code> and output of <code>fw_printenv</code> before the changes.</p>
<p dir="auto"><code>MA5671A SFP ONT</code> registration status can be checked with the <code>onu ploamsg</code> command. Value of the <code>curr_state</code> has to be <code>5</code> which means <code>O5</code> or <code>operation-state</code>:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/MA5671A_in_operation_state.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/MA5671A_in_operation_state.jpg" alt="MA5671A in operation state"/></a></p>
<p dir="auto">The same <code>O5</code> value was seen on the screenshot of the <code>Huawei HG8010H ONT</code> <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/HG8010H_status.jpg">web interface</a>. On lower <code>tmux</code> pane the optical Tx and Rx power reported by the <code>MA5671A SFP ONT</code>(plugged into <code>wan0</code> port) can be seen.</p>
<h2 id="user-content-debian-10-config" tabindex="-1" dir="auto"><a id="user-content--small_blue_diamond-debian-10-config" aria-hidden="true" href="#-small_blue_diamond-debian-10-config"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="small_blue_diamond" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f539.png">üîπ</g-emoji> Debian 10 config</h2>
<p dir="auto">Configuration leans towards traditional or legacy way of doing things, e.g <code>iptables</code> over <code>nftables</code>, <code>udev</code> rules in <code>/etc/udev/rules.d/</code> for renaming network interfaces instead of <code>/etc/systemd/network/*.link</code> files, etc. This is an intentional design choice.</p>
<p dir="auto">List of packages installed using <code>apt</code>:</p>
<div data-snippet-clipboard-copy-content="firmware-bnx2x
firmware-realtek
firmware-brcm80211
usb-modeswitch
bridge-utils
radvd
hostapd
libpam-yubico
libpam-google-authenticator"><pre><code>firmware-bnx2x
firmware-realtek
firmware-brcm80211
usb-modeswitch
bridge-utils
radvd
hostapd
libpam-yubico
libpam-google-authenticator
</code></pre></div>
<h3 id="user-content-udev-usb_modeswitch-config" tabindex="-1" dir="auto"><a id="user-content--black_small_square-udev-and-usb_modeswitch-config" aria-hidden="true" href="#-black_small_square-udev-and-usb_modeswitch-config"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="black_small_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/25aa.png">‚ñ™Ô∏è</g-emoji> udev and usb_modeswitch config</h3>
<p dir="auto"><code>Huawei E3372s-153</code> USB LTE modem has to be mode switched from <code>157d</code>(CD/DVD drive) to <a href="https://wiki.dd-wrt.com/wiki/index.php/3G_/_3.5G#Huawei" rel="nofollow">modem mode</a> which is <code>14dc</code> for this particular device.</p>
<p dir="auto">This is taken care of by following <code>udev</code> rule in <code>/usr/lib/udev/rules.d/40-usb_modeswitch.rules</code> file installed by <code>usb-modeswitch-data</code> package:</p>
<div data-snippet-clipboard-copy-content="ATTRS{idVendor}==&#34;12d1&#34;, ATTRS{manufacturer}!=&#34;Android&#34;, ATTR{bInterfaceNumber}==&#34;00&#34;, ATTR{bInterfaceClass}==&#34;08&#34;, RUN+=&#34;usb_modeswitch &#39;/%k&#39;&#34;"><pre><code>ATTRS{idVendor}==&#34;12d1&#34;, ATTRS{manufacturer}!=&#34;Android&#34;, ATTR{bInterfaceNumber}==&#34;00&#34;, ATTR{bInterfaceClass}==&#34;08&#34;, RUN+=&#34;usb_modeswitch &#39;/%k&#39;&#34;
</code></pre></div>
<p dir="auto">The rule above executes the <code>/usr/lib/udev/usb_modeswitch</code> script with a &#34;kernel name&#34; for the device as an argument, e.g <code>/usr/lib/udev/usb_modeswitch 3-2:1.0</code>. The script starts an instance of the <code>/lib/systemd/system/usb_modeswitch@.service</code>, which in turn executes the <code>usb_modeswitch_dispatcher</code> binary with a <code>--switch-mode</code> option for a specified device. <code>usb_modeswitch_dispatcher</code> reads the configuration from the <code>/usr/share/usb_modeswitch/configPack.tar.gz</code> tarball:</p>
<div data-snippet-clipboard-copy-content="root@r1:~# tar -xOzf /usr/share/usb_modeswitch/configPack.tar.gz 12d1:157d
# Huawei E3331, E3372
TargetVendor=0x12d1
TargetProductList=&#34;14db,14dc&#34;
HuaweiNewMode=1
root@r1:~#"><pre><code>root@r1:~# tar -xOzf /usr/share/usb_modeswitch/configPack.tar.gz 12d1:157d
# Huawei E3331, E3372
TargetVendor=0x12d1
TargetProductList=&#34;14db,14dc&#34;
HuaweiNewMode=1
root@r1:~#
</code></pre></div>
<p dir="auto">.. and calls the <code>usb_modeswitch</code> with the content of the appropriate configuration file as a value of the <code>--long-config</code> argument. However, the default configuration does not work if the <code>cdc_mbim</code> driver is loaded. As a workaround, <code>/etc/usb_modeswitch.d/12d1:157d</code> file is created with <code>NoMBIMCheck=1</code> configuration option added:</p>
<div data-snippet-clipboard-copy-content="root@r1:~# cat /etc/usb_modeswitch.d/12d1:157d
# Huawei E3331, E3372
TargetVendor=0x12d1
TargetProductList=&#34;14db,14dc&#34;
HuaweiNewMode=1
NoMBIMCheck=1
root@r1:~#"><pre><code>root@r1:~# cat /etc/usb_modeswitch.d/12d1:157d
# Huawei E3331, E3372
TargetVendor=0x12d1
TargetProductList=&#34;14db,14dc&#34;
HuaweiNewMode=1
NoMBIMCheck=1
root@r1:~#
</code></pre></div>
<p dir="auto">With the configuration above the <code>usb_modeswitch</code> called by <code>usb_modeswitch_dispatcher</code> makes the switch from <code>157d</code> to <code>14dc</code>:</p>
<div data-snippet-clipboard-copy-content="root@r1:~# lsusb -d 12d1:
Bus 003 Device 042: ID 12d1:14dc Huawei Technologies Co., Ltd. E33372 LTE/UMTS/GSM HiLink Modem/Networkcard
root@r1:~#"><pre><code>root@r1:~# lsusb -d 12d1:
Bus 003 Device 042: ID 12d1:14dc Huawei Technologies Co., Ltd. E33372 LTE/UMTS/GSM HiLink Modem/Networkcard
root@r1:~#
</code></pre></div>
<p dir="auto"><code>udev</code> rule named <code>70-persistent-net.rules</code> ensures the <code>wan*</code>, <code>wwan*</code>, <code>lan*</code> and <code>wlan*</code> interfaces naming convention:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/ip_link_brief.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/ip_link_brief.jpg" alt="ip_link_brief"/></a></p>
<p dir="auto">Configuration files: <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/usb_modeswitch.d/12d1%3A157d">/etc/usb_modeswitch.d/12d1:157d</a>, <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/udev/rules.d/70-persistent-net.rules">/etc/udev/rules.d/70-persistent-net.rules</a></p>
<h3 id="user-content-network-config" tabindex="-1" dir="auto"><a id="user-content--black_small_square-network-config" aria-hidden="true" href="#-black_small_square-network-config"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="black_small_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/25aa.png">‚ñ™Ô∏è</g-emoji> network config</h3>
<p dir="auto">Telia&#39;s service works in a way that the Internet traffic is untagged and IPTV traffic is in the VLAN(IEEE 802.1q) 4. Router has a <code>wan0</code> interface for untagged Internet traffic and a VLAN interface named <code>wan0.4</code> for IPTV. Both interfaces receive the IPv4 address and netmask via DHCP. <code>wan0</code> will get a publicly routable IPv4 address and IPTV interface will get a private IPv4 address. In addition, several v4 routes are installed by DHCP. Few /24 publicly routable networks and the 10/8 are routed via the IPTV interface. Default route is via the Internet interface <code>wan0</code>. IPv6 part works in a way that Telia delegates a /56 prefix for LAN hosts from their /32 allocation using a DHCPv6. Internet facing interface will not get an IPv6 address and routing works using the IPv6 link local addresses:</p>
<div data-snippet-clipboard-copy-content="root@r1:~# # v6 default route via VRRP virtual router
root@r1:~# ip -6 r sh default
default via fe80::200:5eff:fe00:1 dev wan0 proto ra metric 1024 expires 3286sec hoplimit 64 pref medium
root@r1:~#"><pre><code>root@r1:~# # v6 default route via VRRP virtual router
root@r1:~# ip -6 r sh default
default via fe80::200:5eff:fe00:1 dev wan0 proto ra metric 1024 expires 3286sec hoplimit 64 pref medium
root@r1:~#
</code></pre></div>
<p dir="auto">Additionally, the <code>wan0</code> interface has a manually configured address of <code>192.168.1.200/24</code> for accessing the <code>Huawei MA5671A SFP ONT</code>. <code>dhclient</code> enter hook script named <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/dhcp/dhclient-enter-hooks.d/get-static-ipv4-addrs">get-static-ipv4-addrs</a> and exit hook script named <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/dhcp/dhclient-exit-hooks.d/restore-static-ipv4-addrs">restore-static-ipv4-addrs</a> ensure that this address does not get flushed by <code>dhclient</code>.</p>
<p dir="auto"><code>lan*</code> and <code>wlan*</code> interfaces are part of the Linux bridge named <code>br0</code>:</p>
<div data-snippet-clipboard-copy-content="root@r1:~# bridge link
2: lan2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master br0 state forwarding priority 32 cost 4
3: lan3: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 master br0 state disabled priority 32 cost 4
4: lan1: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 master br0 state disabled priority 32 cost 100
6: lan0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 master br0 state disabled priority 32 cost 100
47: wlan0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master br0 state forwarding priority 32 cost 100
root@r1:~#"><pre><code>root@r1:~# bridge link
2: lan2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master br0 state forwarding priority 32 cost 4
3: lan3: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 master br0 state disabled priority 32 cost 4
4: lan1: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 master br0 state disabled priority 32 cost 100
6: lan0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 master br0 state disabled priority 32 cost 100
47: wlan0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master br0 state forwarding priority 32 cost 100
root@r1:~#
</code></pre></div>
<p dir="auto">The <code>br0</code> interface has a manually configured IPv4 address <code>192.168.0.1/24</code>. IPv6 address on <code>br0</code> is managed by <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/dhcp/dhclient-exit-hooks.d/ipv6-pd-br0">dhclient exit hook script</a>.</p>
<p dir="auto">In addition, there is a <code>wwan0</code>(USB CDC Ethernet device) interface facing the Telia&#39;s mobile broadband network with static address of <code>192.168.8.200/24</code> and corresponding floating default route:</p>
<div data-snippet-clipboard-copy-content="root@r1:~# ip r sh default dev wwan0
default via 192.168.8.1 metric 100
root@r1:~#"><pre><code>root@r1:~# ip r sh default dev wwan0
default via 192.168.8.1 metric 100
root@r1:~#
</code></pre></div>
<p dir="auto">Switching the IPv4 connectivity to mobile network and back to fiber by adjusting the default routes metric is managed by <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/systemd/system/isp-switch.service">isp-switch</a> <code>systemd</code> service which calls the <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/usr/local/sbin/isp-switch">isp-switch</a> script. IPv6 is not supported by Telia for the mobile broadband service.</p>
<p dir="auto">LAN hosts get the IPv4 address of the DNS server(<code>dnsmasq</code> running in the router) from DHCPv4 server(also <code>dnsmasq</code>). By default, the domain name server sent to DHCPv4 clients is set to the address of the interface running <code>dnsmasq</code> which is 192.168.0.1:</p>
<div data-snippet-clipboard-copy-content="root@r1:~# ip -4 --brief a sh dev br0
br0              UP             192.168.0.1/24
root@r1:~#"><pre><code>root@r1:~# ip -4 --brief a sh dev br0
br0              UP             192.168.0.1/24
root@r1:~#
</code></pre></div>
<p dir="auto">IPv6 address of the DNS server(<code>dnsmasq</code> running in the router) is propagated by NDP &#34;Router Advertisement&#34; messages sent by <code>radvd</code>. RDNSS(Recursive DNS Server) statement in <code>radvd</code> configuration file <code>/etc/radvd.conf</code> is set automatically by the <code>dhclient</code> exit hook script <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/dhcp/dhclient-exit-hooks.d/ipv6-pd-br0">ipv6-pd-br0</a>. This script will use the IPv6 <a href="https://datatracker.ietf.org/doc/html/rfc8106#section-5.1" rel="nofollow">link-local address</a>(found by <code>ip -6 a</code> or <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/usr/local/bin/mac_to_ip6_ll_addr">mac_to_ip6_ll_addr</a> script) of the <code>br0</code> interface as a value for the <code>RDNSS</code> statement for <code>radvd</code>:</p>
<div data-snippet-clipboard-copy-content="root@r1:~# ip --brief -6 addr show dev br0 scope link
br0              UP             fe80::a7:29ff:fea6:ec61/64
root@r1:~#
root@r1:~# grep RDNSS /etc/radvd.conf
    RDNSS fe80::a7:29ff:fea6:ec61 { };
root@r1:~#"><pre><code>root@r1:~# ip --brief -6 addr show dev br0 scope link
br0              UP             fe80::a7:29ff:fea6:ec61/64
root@r1:~#
root@r1:~# grep RDNSS /etc/radvd.conf
    RDNSS fe80::a7:29ff:fea6:ec61 { };
root@r1:~#
</code></pre></div>
<p dir="auto"><a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/dhcp/dhclient-enter-hooks.d/nodnsupdate">nodnsupdate</a> <code>dhclient</code> enter hook ensures that local <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/resolv.conf">/etc/resolv.conf</a> is not overwritten by DHCP client. As a safety net, modifications of the <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/resolv.conf">/etc/resolv.conf</a> were disabled with <code>chattr +i /etc/resolv.conf</code>:</p>
<div data-snippet-clipboard-copy-content="root@r1:~# lsattr /etc/resolv.conf
----i---------e---- /etc/resolv.conf
root@r1:~#"><pre><code>root@r1:~# lsattr /etc/resolv.conf
----i---------e---- /etc/resolv.conf
root@r1:~#
</code></pre></div>
<p dir="auto">Configuration files and scripts: <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/network/interfaces">/etc/network/interfaces</a>, <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/systemd/system/networking.service.d/override.conf">/etc/systemd/system/networking.service.d/override.conf</a>, <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/dhcp/dhclient.conf">/etc/dhcp/dhclient.conf</a>, <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/dhcp/dhclient-exit-hooks.d/ipv6-pd-br0">/etc/dhcp/dhclient-exit-hooks.d/ipv6-pd-br0</a>, <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/usr/local/bin/mac_to_ip6_ll_addr">/usr/local/bin/mac_to_ip6_ll_addr</a>, <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/dhcp/dhclient-enter-hooks.d/get-static-ipv4-addrs">/etc/dhcp/dhclient-enter-hooks.d/get-static-ipv4-addrs</a>, <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/dhcp/dhclient-exit-hooks.d/restore-static-ipv4-addrs">/etc/dhcp/dhclient-exit-hooks.d/restore-static-ipv4-addrs</a>, <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/dhcp/dhclient-enter-hooks.d/nodnsupdate">/etc/dhcp/dhclient-enter-hooks.d/nodnsupdate</a>, <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/dhcp/dhclient-enter-hooks.d/unset-dhcp-options">/etc/dhcp/dhclient-enter-hooks.d/unset-dhcp-options</a>, <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/resolv.conf">/etc/resolv.conf</a>, <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/modprobe.d/bnx2x.conf">/etc/modprobe.d/bnx2x.conf</a>, <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/sysctl.conf">/etc/sysctl.conf</a>, <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/systemd/system/isp-switch.service">/etc/systemd/system/isp-switch.service</a>, <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/usr/local/sbin/isp-switch">/usr/local/sbin/isp-switch</a></p>
<h3 id="user-content-iptables" tabindex="-1" dir="auto"><a id="user-content--black_small_square-iptables" aria-hidden="true" href="#-black_small_square-iptables"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="black_small_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/25aa.png">‚ñ™Ô∏è</g-emoji> iptables</h3>
<p dir="auto">Notes on <code>iptables</code> and <code>ip6tables</code> rules:</p>
<ul dir="auto">
<li><code>dhclient</code> in DHCPv4 mode uses raw sockets(fallback UDP socket for sending unicast packets is also opened) and thus no firewall rule is needed</li>
<li>important ICMP messages like &#34;frag needed&#34; or &#34;TTL exceeded&#34; are accepted thanks to conntrack &#34;RELATED&#34; state match</li>
<li>certain ICMP messages sent by the router including &#34;Echo Reply&#34; or &#34;Destination Unreachable&#34; are rate limited by adjusting the kernel parameters in <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/sysctl.conf">/etc/sysctl.conf</a></li>
<li><code>recent</code>(used in SSH chain) module internals are seen in the /proc/net/xt_recent/SSH file</li>
<li>while <code>igmpproxy</code> is using raw sockets on the downstream interface, then in regard to upstream interface the <code>igmpproxy</code> simply acts as a normal multicast client(calls <code>setsockopt()</code> with IP_ADD_MEMBERSHIP) and thus there is a need to accept IGMP membership query messages sent by ISP. This also means that the IPTV UDP datagrams are sent towards the router application layer and dropped in the filter table INPUT chain.</li>
<li>IGMP messages can not be tracked by the conntrack module. At least without an helper module. IGMP messages are sent to IPv4 multicast address and thus the <code>conntrack</code> module expects a reply sourced from a multicast address in order to move from UNREPLIED state to ESTABLISHED state. However, multicast address is never used as a src IP.</li>
<li><code>igmpproxy</code> subscribes to 224.0.0.2(IGMP &#34;Leave group&#34; messages) on a downstream interface and packets sent to this address are subject to INPUT chain rules. That&#39;s the reason for <code>-A INPUT -d 224.0.0.2/32 -i br0 -p igmp -j ACCEPT</code> rule. Details can be seen in <a href="https://marc.info/?l=netfilter&amp;m=168393431101974&amp;w=2" rel="nofollow">netfilter user mailinglist message</a>.</li>
<li>dhclient in DHCPv6 mode is able to use ordinary UDP sockets thanks to link-local addresses and does not need to use raw sockets. This means that a firewall rule for DHCPv6 traffic is needed.</li>
<li>ICMP6 &#34;echo request&#34; messages are rate limited by the <code>limit</code> module. Newer kernel versions have the <code>net.ipv6.icmp.ratemask</code> which would allow to rate limit the replies to &#34;echo request&#34; messages by adjusting the <code>net.ipv6.icmp.ratelimit</code>. ICMP6 &#34;destination unreachable&#34; messages are rate limited according to <code>net.ipv6.icmp.ratelimit</code>.</li>
<li>important ICMP6 messages like &#34;packet too big&#34; or &#34;time exceeded&#34; or &#34;destination unreachable&#34; are accepted thanks to <code>conntrack</code> &#34;RELATED&#34; state match</li>
<li>RA messages sent by radvd to <code>ff02::1</code> multicast addr via LAN-facing interface are looped back by the IP layer for local delivery. This is a default behavior and can be controlled by IPV6_MULTICAST_LOOP(<code>man 7 ipv6</code>). Those messages are dropped.</li>
</ul>
<p dir="auto">Rules are loaded by <code>iptables-restore</code> and <code>ip6tables-restore</code> utilities before bringing the <code>br0</code> bridge interface up and after taking the <code>br0</code> interface down. This is configred in <code>/etc/network/interfaces</code> file.</p>
<p dir="auto">Configuration files: <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/usr/local/etc/IPv4_fw_rules">/usr/local/etc/IPv4_fw_rules</a>, <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/usr/local/etc/IPv4_default_fw_rules">/usr/local/etc/IPv4_default_fw_rules</a>, <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/usr/local/etc/IPv6_fw_rules">/usr/local/etc/IPv6_fw_rules</a>, <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/usr/local/etc/IPv6_default_fw_rules">/usr/local/etc/IPv6_default_fw_rules</a></p>
<h3 id="user-content-dnsmasq" tabindex="-1" dir="auto"><a id="user-content--black_small_square-dnsmasq" aria-hidden="true" href="#-black_small_square-dnsmasq"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="black_small_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/25aa.png">‚ñ™Ô∏è</g-emoji> dnsmasq</h3>
<p dir="auto">As <code>dnsmasq</code> is configured with <code>interface=br0</code> and <code>bind-interfaces</code>, then <code>setsockopt()</code> with <code>SO_BINDTODEVICE</code> option is called by <code>dnsmasq</code> when started and socket is bound to a <code>br0</code> interface. <a href="https://github.com/torvalds/linux/blob/ba0ad6ed89fd5dada3b7b65ef2b08e95d449d4ab/net/core/sock.c#L667">Under the hood</a>, the socket is bound to an ifindex of <code>br0</code> interface. As restarting the <code>networking.service</code> deletes and recreates the network bridge <code>br0</code> and the new <code>br0</code> has an <a href="https://github.com/torvalds/linux/blob/80e62bc8487b049696e67ad133c503bf7f6806f7/net/core/dev.c#L9553">incremented ifindex</a>, then <code>dnsmasq.service</code> has to be restarted if the <code>networking.service</code> is restarted:</p>
<div data-snippet-clipboard-copy-content="root@r1:~# systemctl show dnsmasq | grep PartOf=
PartOf=networking.service
root@r1:~#
root@r1:~# systemctl show networking | grep ConsistsOf=
ConsistsOf=hostapd.service igmpproxy.service dnsmasq.service
root@r1:~#"><pre><code>root@r1:~# systemctl show dnsmasq | grep PartOf=
PartOf=networking.service
root@r1:~#
root@r1:~# systemctl show networking | grep ConsistsOf=
ConsistsOf=hostapd.service igmpproxy.service dnsmasq.service
root@r1:~#
</code></pre></div>
<p dir="auto"><code>dnsmasq</code> is configured not to read <code>/etc/resolv.conf</code> and use the upstream DNS servers specified in its configuration file:</p>
<div data-snippet-clipboard-copy-content="root@r1:~# grep ^server /etc/dnsmasq.conf
server=2620:fe::fe
server=2620:fe::9
server=9.9.9.9
server=149.112.112.112
root@r1:~#"><pre><code>root@r1:~# grep ^server /etc/dnsmasq.conf
server=2620:fe::fe
server=2620:fe::9
server=9.9.9.9
server=149.112.112.112
root@r1:~#
</code></pre></div>
<p dir="auto">Configuration files: <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/dnsmasq.conf">/etc/dnsmasq.conf</a>, <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/systemd/system/dnsmasq.service.d/override.conf">/etc/systemd/system/dnsmasq.service.d/override.conf</a></p>
<h3 id="user-content-radvd" tabindex="-1" dir="auto"><a id="user-content--black_small_square-radvd" aria-hidden="true" href="#-black_small_square-radvd"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="black_small_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/25aa.png">‚ñ™Ô∏è</g-emoji> radvd</h3>
<p dir="auto"><code>radvd</code> configuration and necessary reloads for activating the configuration is automatically handled by <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/dhcp/dhclient-exit-hooks.d/ipv6-pd-br0">dhclient exit hook script</a> and <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/usr/local/sbin/rm-expired-prefixes">expired prefixes removal script</a> executed by <code>cron</code> at every minute.</p>
<p dir="auto">The general idea is that it&#39;s needed to keep advertising the prefixes with no valid or preferred lifetime left towards LAN at least as long as the last non-zero valid lifetime of the prefix in order to ensure that all the hosts in LAN pick up the prefix deprecation. Such setup ensures that the prefix deprecation is seen even by devices which were for example in suspended to RAM state at the time of the delegated prefix change.</p>
<p dir="auto">For each &#34;prefix&#34; statement in radvd.conf file the script finds a timestamp in the future when this prefix could be removed from the radvd.conf file in order to avoid stale entries.</p>
<p dir="auto">Example of <code>/etc/radvd.conf</code>:
<a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/radvd_conf.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/radvd_conf.jpg" alt="radvd_conf"/></a></p>
<p dir="auto">Scripts: <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/dhcp/dhclient-exit-hooks.d/ipv6-pd-br0">/etc/dhcp/dhclient-exit-hooks.d/ipv6-pd-br0</a>, <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/usr/local/sbin/rm-expired-prefixes">/usr/local/sbin/rm-expired-prefixes</a></p>
<h3 id="user-content-igmpproxy" tabindex="-1" dir="auto"><a id="user-content--black_small_square-igmpproxy" aria-hidden="true" href="#-black_small_square-igmpproxy"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="black_small_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/25aa.png">‚ñ™Ô∏è</g-emoji> igmpproxy</h3>
<p dir="auto"><a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/patches/igmpproxy.patch">Patched</a>(issue <a href="https://github.com/pali/igmpproxy/issues/95" data-hovercard-type="issue" data-hovercard-url="/pali/igmpproxy/issues/95/hovercard">#95</a>) version of <code>igmpproxy</code> is installed. <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/igmpproxy_0.2.1-1%2Brelaxed-timeout1_amd64.deb">igmpproxy_0.2.1-1+relaxed-timeout1_amd64.deb</a> package was built with commands below:</p>
<ol dir="auto">
<li><code>apt source igmpproxy</code></li>
<li><code>cd igmpproxy-0.2.1/</code></li>
<li><code>patch --verbose src/igmpproxy.c ~/koduinternet-cpe/patches/igmpproxy.patch</code></li>
<li><code>dch --local +relaxed-timeout</code> with &#34;relaxed pselect() timeout in main loop&#34; note for the changelog</li>
<li><code>cd . &amp;&amp; dpkg-buildpackage -b</code></li>
</ol>
<p dir="auto">Package can be installed with <code>dpkg -i igmpproxy_0.2.1-1+relaxed-timeout1_amd64.deb</code> and <code>apt-mark hold igmpproxy</code> prevents the package from being automatically upgraded.</p>
<p dir="auto">Restarting the <code>networking.service</code> will call the <code>/lib/bridge-utils/ifupdown.sh</code> script which deletes(<code>brctl delbr ..</code>) and recreates(<code>brctl addbr ..</code>) the network bridge <code>br0</code>. However, the new <code>br0</code> interface will have an incremented ifindex(<code>cat /sys/class/net/br0/ifindex</code> or <code>ip l sh dev br0</code>) and thus the <code>setsockopt()</code> calls by <code>igmpproxy</code> will fail. Example where interface with ifindex 17(21 in octal) no longer existst:</p>
<div data-snippet-clipboard-copy-content="setsockopt(3, SOL_IP, IP_MULTICAST_IF, &#34;\217U\0\0\300\250\0\1\21\0\0\0&#34;, 12) = -1 EADDRNOTAVAIL (Cannot assign requested address)"><pre><code>setsockopt(3, SOL_IP, IP_MULTICAST_IF, &#34;\217U\0\0\300\250\0\1\21\0\0\0&#34;, 12) = -1 EADDRNOTAVAIL (Cannot assign requested address)
</code></pre></div>
<p dir="auto">That&#39;s the reason why <code>igmpproxy.service</code> is configured to be restarted if <code>networking.service</code> is restarted:</p>
<div data-snippet-clipboard-copy-content="root@r1:~# systemctl show igmpproxy | grep PartOf=
PartOf=networking.service
root@r1:~#
root@r1:~# systemctl show networking | grep ConsistsOf=
ConsistsOf=hostapd.service igmpproxy.service dnsmasq.service
root@r1:~#"><pre><code>root@r1:~# systemctl show igmpproxy | grep PartOf=
PartOf=networking.service
root@r1:~#
root@r1:~# systemctl show networking | grep ConsistsOf=
ConsistsOf=hostapd.service igmpproxy.service dnsmasq.service
root@r1:~#
</code></pre></div>
<p dir="auto">As an example, here is the multicast routing table(populated by <code>igmpproxy</code>) and switch multicast group membership table(populated by IGMP snooping) at the time when host connected to <code>lan0</code> is running <code>mplayer -vf yadif -volume 80 -fs -ao pulse udp://@239.3.1.106:1234</code>:</p>
<div data-snippet-clipboard-copy-content="root@r1:~# ip mroute
(10.0.2.28,239.3.1.106)          Iif: wan0.4     Oifs: br0  State: resolved
root@r1:~#
root@r1:~# bridge -s mdb
33: br0  lan0  239.3.1.106  temp   251.57
root@r1:~#"><pre><code>root@r1:~# ip mroute
(10.0.2.28,239.3.1.106)          Iif: wan0.4     Oifs: br0  State: resolved
root@r1:~#
root@r1:~# bridge -s mdb
33: br0  lan0  239.3.1.106  temp   251.57
root@r1:~#
</code></pre></div>
<p dir="auto">IGMP snooping is enabled by default:</p>
<div data-snippet-clipboard-copy-content="root@r1:~# cat /sys/devices/virtual/net/br0/bridge/multicast_snooping
1
root@r1:~#"><pre><code>root@r1:~# cat /sys/devices/virtual/net/br0/bridge/multicast_snooping
1
root@r1:~#
</code></pre></div>
<p dir="auto"><code>force_igmp_version</code> for <code>wan0.4</code> is not touched, i.e it&#39;s in IGMPv3 mode and falls back to IGMPv1/v2 mode if needed.</p>
<p dir="auto">Configuration files: <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/igmpproxy.conf">/etc/igmpproxy.conf</a>, <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/systemd/system/igmpproxy.service.d/override.conf">/etc/systemd/system/igmpproxy.service.d/override.conf</a></p>
<h3 id="user-content-ntp-config" tabindex="-1" dir="auto"><a id="user-content--black_small_square-ntp-config" aria-hidden="true" href="#-black_small_square-ntp-config"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="black_small_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/25aa.png">‚ñ™Ô∏è</g-emoji> NTP config</h3>
<p dir="auto">By default, the <code>dhclient</code> <code>/etc/dhcp/dhclient-exit-hooks.d/timesyncd</code> script builds the <code>/run/systemd/timesyncd.conf.d/01-dhclient.conf</code> configuration file for <code>systemd-timesyncd</code> SNTP client and instructs it to use the NTP servers provided by Telia&#39;s DHCP server. Instead, the default Debian NTP pool compiled to <code>systemd-timesyncd</code> is used by creating a <code>/etc/systemd/timesyncd.conf.d/01-dhclient.conf</code> symlink pointing to <code>/dev/null</code>. Output of <code>timedatectl</code>:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/timedatectl_output.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/timedatectl_output.jpg" alt="timedatectl output"/></a></p>
<h3 id="user-content-hostapd" tabindex="-1" dir="auto"><a id="user-content--black_small_square-hostapd" aria-hidden="true" href="#-black_small_square-hostapd"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="black_small_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/25aa.png">‚ñ™Ô∏è</g-emoji> hostapd</h3>
<p dir="auto"><code>Asus PCE-AC88</code>(<code>Broadcom BCM4366/4</code> SoC) WNIC is configured to work as <code>IEEE 802.11a/n/ac</code> AP. For the <code>IEEE 802.11ac</code> mode, the channel width is up to 80 MHz(5170 - 5250 MHz). <code>hostapd</code> adds the WNIC named <code>wlan0</code> to bridge <code>br0</code>. Connectivity between the Wi-Fi clients is allowed. Output of <a href="https://manpages.debian.org/testing/hostapd/hostapd_cli.1.en.html" rel="nofollow">hostapd_cli</a> <code>status</code> and <code>get_config</code> commands can be seen below:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/hostapd_cli_output.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/hostapd_cli_output.jpg" alt="hostapd_cli_output"/></a></p>
<p dir="auto">Firmware blob loaded by <code>brcmfmac</code> driver is <code>brcmfmac4366c-pcie.bin</code>:</p>
<div data-snippet-clipboard-copy-content="root@r1:~# md5sum /lib/firmware/brcm/brcmfmac4366c-pcie.bin
e3bb4457082aa54769253e9168db2269  /lib/firmware/brcm/brcmfmac4366c-pcie.bin
root@r1:~#
root@r1:~# strings /lib/firmware/brcm/brcmfmac4366c-pcie.bin | tail -1
4366c0-roml/pcie-ag-splitrx-fdap-mbss-mfp-wnm-osen-wl11k-wl11u-txbf-pktctx-amsdutx-ampduretry-chkd2hdma-proptxstatus-11nprop-obss-dbwsw-ringer-dmaindex16-bgdfs-murx-wwdfs Version: 10.28.2 (r769115) CRC: 6924533a Date: Mon 2018-11-05 03:22:36 PST Ucode Ver: 1128.17924 FWID: 01-d2cbb8fd
root@r1:~#"><pre><code>root@r1:~# md5sum /lib/firmware/brcm/brcmfmac4366c-pcie.bin
e3bb4457082aa54769253e9168db2269  /lib/firmware/brcm/brcmfmac4366c-pcie.bin
root@r1:~#
root@r1:~# strings /lib/firmware/brcm/brcmfmac4366c-pcie.bin | tail -1
4366c0-roml/pcie-ag-splitrx-fdap-mbss-mfp-wnm-osen-wl11k-wl11u-txbf-pktctx-amsdutx-ampduretry-chkd2hdma-proptxstatus-11nprop-obss-dbwsw-ringer-dmaindex16-bgdfs-murx-wwdfs Version: 10.28.2 (r769115) CRC: 6924533a Date: Mon 2018-11-05 03:22:36 PST Ucode Ver: 1128.17924 FWID: 01-d2cbb8fd
root@r1:~#
</code></pre></div>
<p dir="auto">This is provided by <code>firmware-brcm80211</code> package, but the same firmware version can also be downloaded from <a href="https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git/tree/brcm/brcmfmac4366c-pcie.bin" rel="nofollow">Linux kernel git repo</a>:</p>
<div data-snippet-clipboard-copy-content="root@r1:~# curl -s https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git/plain/brcm/brcmfmac4366c-pcie.bin | md5sum
e3bb4457082aa54769253e9168db2269  -
root@r1:~#"><pre><code>root@r1:~# curl -s https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git/plain/brcm/brcmfmac4366c-pcie.bin | md5sum
e3bb4457082aa54769253e9168db2269  -
root@r1:~#
</code></pre></div>
<p dir="auto">For firmware related troubleshooting purposes, the <code>brcmfmac</code> driver can be loaded with <code>modprobe -v brcmfmac debug=0x1416</code> when built with debugging support:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/brcmfmac_with_debug_functions.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/brcmfmac_with_debug_functions.jpg" alt="brcmfmac_with_debug_functions"/></a></p>
<p dir="auto">Configuration files: <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/hostapd/hostapd.conf">/etc/hostapd/hostapd.conf</a>, <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/systemd/system/hostapd.service.d/override.conf">/etc/systemd/system/hostapd.service.d/override.conf</a></p>
<h3 id="user-content-linux-pam-config" tabindex="-1" dir="auto"><a id="user-content--black_small_square-linux-pam-config" aria-hidden="true" href="#-black_small_square-linux-pam-config"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="black_small_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/25aa.png">‚ñ™Ô∏è</g-emoji> Linux PAM config</h3>
<p dir="auto">Diff with <code>Debian 10</code> default Linux PAM <code>common-auth</code> enabling 2FA(user password and OTP):</p>
<div data-snippet-clipboard-copy-content="root@r1:~# diff -u /etc/pam.d/common-auth{~,}
--- /etc/pam.d/common-auth~     2023-06-01 21:22:43.894184345 +0300
+++ /etc/pam.d/common-auth      2023-06-01 21:48:15.777645409 +0300
@@ -13,8 +13,16 @@
 # pam-auth-update to manage selection of other modules.  See
 # pam-auth-update(8) for details.

+# If pam_yubico.so returns PAM_SUCCESS, then pam_google_authenticator.so is skipped.
+# All other return codes are ignored and pam_google_authenticator.so is used.
+# pam_yubico.so has &#34;forward_pass&#34;(pam_set_item(pamh, PAM_AUTHTOK, onlypasswd)) enabled by default.
+auth   [success=1 default=ignore]      pam_yubico.so id=12345 authfile=/etc/authorized_yubikeys urllist=https://api.yubico.com/wsapi/2.0/verify
+
+# pam_google_authenticator.so is able to detect if user password is entered before TOTP.
+auth   required        pam_google_authenticator.so forward_pass
+
 # here are the per-package modules (the &#34;Primary&#34; block)
-auth   [success=1 default=ignore]      pam_unix.so nullok_secure
+auth   [success=1 default=ignore]      pam_unix.so nullok_secure try_first_pass
 # here&#39;s the fallback if no module succeeds
 auth   requisite                       pam_deny.so
 # prime the stack with a positive return value if there isn&#39;t one already;
root@r1:~#"><pre><code>root@r1:~# diff -u /etc/pam.d/common-auth{~,}
--- /etc/pam.d/common-auth~     2023-06-01 21:22:43.894184345 +0300
+++ /etc/pam.d/common-auth      2023-06-01 21:48:15.777645409 +0300
@@ -13,8 +13,16 @@
 # pam-auth-update to manage selection of other modules.  See
 # pam-auth-update(8) for details.

+# If pam_yubico.so returns PAM_SUCCESS, then pam_google_authenticator.so is skipped.
+# All other return codes are ignored and pam_google_authenticator.so is used.
+# pam_yubico.so has &#34;forward_pass&#34;(pam_set_item(pamh, PAM_AUTHTOK, onlypasswd)) enabled by default.
+auth   [success=1 default=ignore]      pam_yubico.so id=12345 authfile=/etc/authorized_yubikeys urllist=https://api.yubico.com/wsapi/2.0/verify
+
+# pam_google_authenticator.so is able to detect if user password is entered before TOTP.
+auth   required        pam_google_authenticator.so forward_pass
+
 # here are the per-package modules (the &#34;Primary&#34; block)
-auth   [success=1 default=ignore]      pam_unix.so nullok_secure
+auth   [success=1 default=ignore]      pam_unix.so nullok_secure try_first_pass
 # here&#39;s the fallback if no module succeeds
 auth   requisite                       pam_deny.so
 # prime the stack with a positive return value if there isn&#39;t one already;
root@r1:~#
</code></pre></div>
<p dir="auto">YubiKeys token IDs are mapped to username in <code>/etc/authorized_yubikeys</code> file. <code>$HOME/.google_authenticator</code> is created by <code>google-authenticator</code> utility and it includes the secret key, emergency scratch codes, rate-limit configuration, etc. SSH keyboard interactive authentication is enabled in <code>/etc/ssh/sshd_config</code> by changing the value of <code>ChallengeResponseAuthentication</code> to <code>yes</code>.</p>
<p dir="auto">Configuration files: <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/conf/etc/pam.d/common-auth">/etc/pam.d/common-auth</a></p>
<h2 id="user-content-bandwidth-tests" tabindex="-1" dir="auto"><a id="user-content--small_blue_diamond-bandwidth-tests" aria-hidden="true" href="#-small_blue_diamond-bandwidth-tests"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="small_blue_diamond" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f539.png">üîπ</g-emoji> Bandwidth tests</h2>
<p dir="auto">Statistics of <code>wan0</code> when host connected to <code>lan2</code> was running a TCP bidirectional test against <code>iperf3</code> server in another ISP network:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/iptraf-ng_wan0_stats.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/iptraf-ng_wan0_stats.jpg" alt="iptraf-ng wan0 stats"/></a></p>
<p dir="auto">Statistics of all the interfaces when hosts connected to <code>lan2</code> and <code>lan3</code> were running a TCP bidirectional test against <code>iperf3</code> server in another ISP network and smartphone connected to Wi-Fi was running Ookla&#39;s Speedtest:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/iptraf-ng_general_stats.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/iptraf-ng_general_stats.jpg" alt="iptraf-ng general stats"/></a></p>
<p dir="auto"><a href="https://www.speedtest.net/" rel="nofollow">Speedtest.net</a> results when executed from a host connected to <code>lan2</code>:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/speedtest_from_host_in_lan.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/speedtest_from_host_in_lan.jpg" alt="speedtest from host in lan"/></a></p>
<p dir="auto"><a href="https://www.speedtest.net/" rel="nofollow">Speedtest.net</a> results when executed from a smartphone connected to <code>r1</code> Wi-Fi network:
<a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/speedtest_from_wifi_client_in_lan.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/speedtest_from_wifi_client_in_lan.jpg" alt="speedtest from wifi client in lan"/></a></p>
<h2 id="user-content-hardware-mods" tabindex="-1" dir="auto"><a id="user-content--small_blue_diamond-hardware-mods" aria-hidden="true" href="#-small_blue_diamond-hardware-mods"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="small_blue_diamond" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f539.png">üîπ</g-emoji> Hardware mods</h2>
<h3 id="user-content-nic-fan-replacement" tabindex="-1" dir="auto"><a id="user-content--black_small_square-replacing-the-dell-n20kj-stock-fan-with-noctua-nf-a4x10-fan" aria-hidden="true" href="#-black_small_square-replacing-the-dell-n20kj-stock-fan-with-noctua-nf-a4x10-fan"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="black_small_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/25aa.png">‚ñ™Ô∏è</g-emoji> Replacing the Dell N20KJ stock fan with Noctua NF-A4x10 fan</h3>
<p dir="auto">Stock <code>ADDA AD0412HB-K96</code> fan was replaced with silent, <code>Noctua NF-A4x10</code> fan:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/Dell_N20KJ_with_NF-A4x10_fan.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/Dell_N20KJ_with_NF-A4x10_fan.jpg" alt="Dell N20KJ with NF-A4x10 fan"/></a></p>
<p dir="auto"><code>Noctua NF-A4x10</code> is connected to motherboard chassis fan connector where it is picked up by <code>lm-sensors</code>:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tonusoo/koduinternet-cpe/blob/main/imgs/NIC_fan_RPM_by_lm-sensors.jpg"><img src="https://github.com/tonusoo/koduinternet-cpe/raw/main/imgs/NIC_fan_RPM_by_lm-sensors.jpg" alt="NIC fan RPM by lm-sensors"/></a></p>
<p dir="auto"><code>Dell N20KJ</code> fan fault detection was disabled in <code>eDiag</code> engineering mode(<code>ediag_x64.efi -b10eng</code>) with commands below:</p>
<div data-snippet-clipboard-copy-content="nvm cfg
option 4 (board i/o)
83=1 (disabled)
save
exit"><pre><code>nvm cfg
option 4 (board i/o)
83=1 (disabled)
save
exit
</code></pre></div>
<h2 id="user-content-acknowledgements" tabindex="-1" dir="auto"><a id="user-content--small_blue_diamond-acknowledgements" aria-hidden="true" href="#-small_blue_diamond-acknowledgements"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="small_blue_diamond" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f539.png">üîπ</g-emoji> Acknowledgements</h2>
<p dir="auto">Users <a href="https://www.dslreports.com/profile/1426739" rel="nofollow">upnatom</a> and <a href="https://www.dslreports.com/profile/1901978" rel="nofollow">JAMESMTL</a> in <a href="https://www.dslreports.com/forums/all" rel="nofollow">DSLReports forum</a> <a href="https://www.dslreports.com/forum/r32230041-Internet-Bypassing-the-HH3K-up-to-2-5Gbps-using-a-BCM57810S-NIC" rel="nofollow">&#34;Bypassing the HH3K up to 2.5Gbps using a BCM57810S NIC&#34;</a> thread.
User <strong>anon23891239</strong> and others in <a href="https://forum.openwrt.org/" rel="nofollow">OpenWRT forum</a> <a href="https://forum.openwrt.org/t/support-ma5671a-sfp-gpon/48042/" rel="nofollow">&#34;Support MA5671A SFP GPON&#34;</a> thread. <a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/README.md">README</a> is inspired by <a href="https://github.com/ma-shamshiri/Human-Activity-Recognition">&#34;Human-Activity-Recognition&#34;</a> repo.</p>
<h2 id="user-content-license" tabindex="-1" dir="auto"><a id="user-content--small_blue_diamond-license" aria-hidden="true" href="#-small_blue_diamond-license"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a> <g-emoji alias="small_blue_diamond" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f539.png">üîπ</g-emoji> License</h2>
<p dir="auto"><a href="https://github.com/tonusoo/koduinternet-cpe/blob/main/LICENSE">MIT License</a></p>
</article>
          </div></div>
  </body>
</html>
