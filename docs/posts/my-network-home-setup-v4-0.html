<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://giuliomagnifico.blog/networking/2023/01/05/home-network_v4.html">Original</a>
    <h1>My network home setup – v4.0</h1>
    
    <div id="readability-page-1" class="page"><div aria-label="Content">
      <div>
        <div>
  <section>

     <div>
  <section>









<article itemscope="" itemtype="http://schema.org/BlogPosting">

    <div itemprop="articleBody">

      <p>A new update of my network home setup, to both hardware and software.</p>

<ul>
  <li><a href="#introduction">Introduction</a></li>
  <li>
<a href="#hardware">Hardware</a>
    <ul>
      <li><a href="#breeze-for-the-hardware">Breeze for the hardware</a></li>
      <li><a href="#netgear-ax6-ap">Netgear AX/6 AP</a></li>
      <li><a href="#netgear-gs308t-switch">Netgear GS308T switch</a></li>
      <li><a href="#wiring">Wiring</a></li>
    </ul>
  </li>
  <li>
<a href="#software">Software</a>
    <ul>
      <li><a href="#vlans-and-homekit">VLANs and HomeKit</a></li>
      <li><a href="#access-point">Access Point</a></li>
      <li><a href="#router">Router</a></li>
      <li><a href="#switch">Switch</a></li>
      <li><a href="#grafana">Grafana</a></li>
    </ul>
  </li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="introduction">Introduction</h2>
<p>In this new “update/release” I have added two 120mm fans inside the server cabinet, I switched to Wi-Fi AX/6, I configured my network with separated VLANSs (IoT, Guest and Main), I connected both the computer and the television with an ethernet cable and I made some little modifications to the Grafana and Prometheus setup.</p>

<p>Before the beginning, I have to remember the “previous versions”, just in case you’re interested in all the steps that led me here:</p>

<ul>
  <li>Jan 14, 2022 - <a href="https://giuliomagnifico.blog/networking/2022/01/14/my-home-setup.html">My hardware and software setup for a new house</a>
</li>
  <li>Jun 02, 2022 - <a href="https://giuliomagnifico.blog/networking/2022/06/02/my-network-home-setup.html">My network home setup - v2.0</a>
</li>
  <li>Aug 14, 2022 - <a href="https://giuliomagnifico.blog/networking/2022/08/14/home-network_v3.html">My network home setup - v3.0</a>
</li>
  <li>Dec 12, 2022 - <a href="https://giuliomagnifico.blog/networking/2022/12/12/Grafana-Pushover.html">Some custom push notifications that improved my life</a>
</li>
  <li>Dec 19, 2022 - <a href="https://giuliomagnifico.blog/networking/2022/12/19/grafana-reporting.html">Retrieve a scheduled report of your Grafana dashboards via mail</a>
</li>
  <li>Now - My network home setup - v4.0</li>
</ul>

<p>As always, before the details, the final result:</p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/final/IMG_8640.jpg" alt="IMG_8640"/></p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/final/IMG_8635.jpg" alt="IMG_8635"/></p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/final/IMG_8637.jpg" alt="IMG_8637"/></p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/final/IMG_8642.jpg" alt="IMG_8642"/></p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/final/IMG_8641.jpg" alt="IMG_8641"/></p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/Rete%20casa.png" alt="Rete casa"/>
<a href="https://giuliomagnifico.blog/_images/2023/home-network_v4/Rete%20casa.png">full size</a></p>

<h2 id="hardware">Hardware</h2>
<p>Starting with the hardware, the first new thing is a DIY modification to my server cabinet.</p>

<h3 id="breeze-for-the-hardware">Breeze for the hardware</h3>

<p>My server cabinet…is not a server cabinet, but is a wooden furniture from Maisons du Monde: <a href="https://www.maisonsdumonde.com/FR/fr/p/buffet-vintage-en-manguier-bleu-janeiro-155740.htm">Janeiro</a>), it works fine as a cabinet because I bought it for this purpose, and it is also nicer and well integrated inside a home, than a metal cabinet/rack.</p>

<p>The only downside are the (high) temperatures during the summer, when the door is closed.
So I had to lower the temperatures, for this reason I decided to install two 120mm fans inside the cabinet that extract the hot air from the inside. Also they are connected to a smart plug so I can use a simple automation to start them only when the temperature inside the cabinet is above x ºC (I think 28/30°) and they shut down automatically when the temperature is below x °C (I think 24°), I will tune the temperature the next summer.</p>

<p>I know that 120mm could sound like big fans, and they are big, but since I want to have a low noise , I bought them with 3 speeds and I’ll use them at the lowest speed. This because the bigger are the fans, the more air they can move by spinning at a low rpm/rotation.</p>

<p>I choose a set of two USB fans for 17€ on Amazon, with 3 speeds, long cables and front grill (to avoid that a cable can enter inside): <a href="https://amzn.eu/d/fqg1uxB">link</a>.</p>

<p>I also decided that they have to extract hot air, and not blow fresh air inside, because above the cabinet I have an air conditioner, so I can leave the cabinet door with a little slot and the fans can create an airflow with cold air blow inside from the front, that is  extracted from the rear of the cabinet.</p>

<p>Last, I bought the correct tool to make a 120mm circle hole: (<a href="https://www.amazon.it/gp/aw/d/B09JP3CPLK?psc=1&amp;ref=ppx_pop_mob_b_asin_image">link</a>).</p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/cabinet/IMG_8426.jpg" alt="IMG_8426"/></p>

<p>I simply removed some inside hardware and I drilled the holes, very easy (the after work cleanup was not easy).</p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/cabinet/IMG_8428.jpg" alt="IMG_8428"/></p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/cabinet/IMG_8445.jpg" alt="IMG_8445"/></p>

<p>Then I stuck four pieces of soft material (bi-adhesive pad) to the fans, to have less vibration noise, four long self-tapping screws and the fans are attached inside.</p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/cabinet/IMG_8448.jpg" alt="IMG_8448"/></p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/cabinet/IMG_8451.jpg" alt="IMG_8451"/></p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/cabinet/IMG_8452.jpg" alt="IMG_8452"/></p>

<p>At the beginning I installed the upper fan without the grill, but after I realized that is better to use the grill before reinstall the stuff inside :)</p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/cabinet/IMG_8464.jpg" alt="IMG_8464"/></p>

<p>Then I cleaned up from the dust everything, using the vacuum and a brush
<img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/cabinet/IMG_8455.jpg" alt="IMG_8455"/></p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/cabinet/IMG_8447.jpg" alt="IMG_8447"/></p>

<p>Last step was tidy up all the cables to optimize the mess/airflow</p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/cabinet/IMG_8482.jpg" alt="IMG_8482"/></p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/cabinet/IMG_8496.jpg" alt="IMG_8496"/></p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/cabinet/IMG_8497.jpg" alt="IMG_8497"/></p>

<p>The fans work pretty well, maybe also “too much” because when I turn both on (at the lowest speed) the temperature of the inside hardware drops very fast, maybe I will not need to turn on both the fans but only the one above.</p>

<p>When I turn on the fans:</p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/fantemps.jpeg" alt="SCR-20230209-dyl"/></p>

<p>Anyway the fans will turn on/off automatically using HomeKit, something like “on above 30°, off below 25°”. During the summer inside the cabinet the temperatures rise very fast.</p>

<h3 id="netgear-ax6-ap">Netgear AX/6 AP</h3>
<p>Previously (summer 2022) I bought a Netgear WAX202 that was -officially- supported by OpenWrt, but when I tested it I had been disappointed because the performance of the wifi 6, just behind a wall, was lower than wifi 5 of the R7800. So I returned it to Amazon and I decided to keep the R7800.</p>

<p>No, after some months, I decided to test again the progress with Wi-Fi AX, so I bought a Netgear WAX206 (<a href="http://en.techinfodepot.shoutwiki.com/wiki/Netgear_WAX206">specs</a>) that should be a little more powerful than the WAX202. But with my surprise, I found that it’s more than “a bit” faster than the WAX202. It’s way better.</p>

<p>To be honest I bought also a Netgear EAX80, that is/should be the most powerful device of the trio, but since it has a Broadcom antennas, it will never be supported by OpenWrt.
Anyway I bought these two APs to test if the EAX80 is faster and better than the WAX206 I would have kept it, also without OpenWrt because is nicer also. But instead I found that it has the same speed with my devices, for example the iPhone 14 Pro has only a 2x2 80MHz antenna, and can reach a theoretical speed of 866Mbps, and is the same for my other devices. So with these devices I can already fill the bandwidth without being able to take advantage of the other bandwidth from the EAX80:</p>

<p>With the EAX80 the speed was the same (or maybe little lower) but with the downside that I wasn’t unable to install OpenWrt and to build the Grafana wireless dashboards, and the web interface/management of the EAX80 is worse than the WAX206 Netgear default interface, indeed I was really surprised of how bad and without  any settings the WebUI was. There are no ways to have more than 2 SSID, no way to have a different name on 2 different SSID, even no way to see how many clients are connected to an antenna. Instead the WAX206 “can be flashed” with OpenWrt and it also has a 2.5Gb WAN port that can be used inside the LAN when it’s working as AP only.</p>

<p>End of the short story: I decided to keep the WAX206 and send back the EAX80, although I love the EAX80 sleek design and nice grill/LEDs.</p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/ScaledImage_2000x1501-2.jpg" alt="EAX80+WAX206"/></p>

<p>Then I had to create my own image of OpenWrt for the WAX206. I had to do this because the WAX206 is still -officially- unsupported (also in the Master/Snapshot branch), but there’s the kernel support using <a href="https://github.com/boretom/openwrt-fork/tree/wax206/flashable-1Gbit">this</a> repository. But this story goes on in the <a href="#software">software</a> section of this post.</p>

<h3 id="netgear-gs308t-switch">Netgear GS308T switch</h3>
<p>I also bought a switch that is supported by OpenWrt, just because using OpenWrt I can export also the metrics from it and so, build a full Grafana Dashboard with all the info from my network devices. But I’ll talk more about this in the “<a href="#grafana">software-Grafana</a>” section, just a sneak peek of the switch and graphs:</p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/IMG_8611.jpg" alt="Christmas_switch"/></p>

<p>(<a href="https://giuliomagnifico.blog/_images/2023/home-network_v4/Screenshot%25202023-02-07%2520at%252011.03.51.jpg">full size</a>)
<img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/Screenshot%202023-02-07%20at%2011.03.51.jpg" alt="switch_Grafana"/></p>

<h3 id="wiring">Wiring</h3>

<p>I don’t have much to write about the wiring stuff,  it’s a pretty common and easy procedure. 
I have simply bought a probe used by electricals, 30 meters of Ethernet 6a FTP cable, and with a good deal of patience I found the path inside the walls and then I put in the cables.</p>

<p>This is the patience that I had…spot the probe in this mess:</p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/IMG_8494.jpg.jpeg" alt="cable_mess"/></p>

<p>I had also a bad surprise with my 2021 LG OLED 55C1 television because I discovered that it has only the 100mbps Ethernet port. I noticed this because the 1000mbps LED of the switch was inactive. So I searched and I discovered that almost all the /current/ TV are still using 100mbps port (yes in 2021). 
Well, 100mbps are more than sufficient for a 4k streaming video nowadays, and I need the wired connection only to use the TV with HomeKit without lag or Wake On LAN issues, but this 100mbps port is definitely too old and it’s absurd that manufacturers still use it, but eventually, they will have to find an argument for us to buy a new model?</p>

<p>Anyway, using a cable connected to the TV, now when I rise/lower the volume from Home app, it acts without any lag. Also the Wake On Lan works flawless.</p>

<p>Tip: you can also have some more bandwidth using a USB 3 to Ethernet adapter (for 10-12€),  using it the TV can reach about 300mbps.</p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/IMG_8521.jpeg" alt="USB-adapter"/></p>

<h2 id="software">Software</h2>
<p>Talking about the software improvement, I made some important changes for security and performance: I configured the network using VLANs instead of subnets and I compiled some custom OpenWrt images for my hardware (nanoPi R4S, Netgear WAX206 and GS308T).</p>

<h3 id="vlans-and-homekit">VLANs and HomeKit</h3>
<p>Also if this setup can be obtained with only subnets (because they are all assigned to wireless interfaces) I decided to switch all the networks from 3 separated subnets to 3 separated vlans. First I want to show my network config now:</p>

<p>(<a href="https://giuliomagnifico.blog/_images/2023/home-network_v4/Rete%20casa.png">full size</a>)
<img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/Rete%20casa.png" alt="Rete casa"/></p>

<p>The bigger (and only?) issue was with Apple Home/HomeKit configuration, because as soon as I put the Homekit devices in a IoT separated VLAN from your iPhone, Mac, etc.. the devices stopped to respond. This happens because Apple is using its mDNS advertiser (Bonjour), and the queries made by the HomeKit server (in my case the Homebridge server on 192.168.1.x lan) in another vlan, can’t be discovered by the devices in another VLAN.</p>

<p>To fix this I had to install “something” on the router that can reflect the queries from a lan, to another (v)lan. And this “something” is called <a href="https://www.avahi.org">Avahi</a>:</p>
<blockquote>
  <p>an mDNS/DNS-SD daemon implements Apple’s Zeroconf architecture (also known as “Rendezvous” or “Bonjour”)</p>
</blockquote>

<p>That has the option to reflect the queries from the Homebridge lan to another lan, this option is called indeed <em>reflector</em>. So I installed Avahi on my router and then I modified just two parameters in <code>/etc/avahi/avahi-daemon.conf</code></p>

<p>Under the <em>[server]</em> section I added my IoT VLAN only (by default it reflects on all the interfaces, that is less safe)</p>

<p><code>allow-interfaces=br-lan.50</code></p>

<p>And under the <em>[reflector]</em>, I changed from <em>no</em> to <em>yes</em></p>

<p><code>enable-reflector=yes</code></p>

<p>then I just reloaded it  with <code>service avahi-daemon restart</code> (and be sure to also reload the Homebridge service with <code>sudo hb-service restart</code>).</p>

<p>Solved this, in order to have the DHCP, mDNS and DNS addresses sent from the router to the IoT vlan, I also added some rules to the firewall:</p>

<div><div><pre><code>config forwarding
	option src &#39;lan&#39;
	option dest &#39;iot&#39;

config forwarding
	option src &#39;iot&#39;
	option dest &#39;WAN&#39;

config rule
	option name &#39;IoT DHCP&#39;
	list proto &#39;udp&#39;
	option src &#39;iot&#39;
	option dest_port &#39;67-68&#39;
	option target &#39;ACCEPT&#39;

config rule
	option name &#39;IoT DNS&#39;
	option src &#39;iot&#39;
	option dest_port &#39;53&#39;
	option target &#39;ACCEPT&#39;

config rule
	option name &#39;IoT 443&#39;
	option src &#39;iot&#39;
	option dest_port &#39;443&#39;
	option target &#39;ACCEPT&#39;

config rule
	option name &#39;IoT mDNS&#39;
	list proto &#39;udp&#39;
	option src &#39;iot&#39;
	list dest_IP &#39;224.0.0.251&#39;
	option dest_port &#39;5353&#39;
	option target &#39;ACCEPT&#39;
	
config rule
	option src &#39;iot&#39;
	list dest_ip &#39;192.168.2.0/24&#39;
	option target &#39;DROP&#39;
	option name &#39;IoT Modem&#39;
	list proto &#39;all&#39;
	option dest &#39;wan&#39;	
</code></pre></div></div>

<p>Now the devices inside the IoT vlan are isolated from the other devices in othe (v)lans and they don’t have access to the router, modem or other devices. This is an improvement for security and privacy.</p>

<p>The same can be configured for the guest vlan, except for the Avahi mDNS reflector that is not needed obviously, you just have to allow the guests devices to browse the web, have access to DNS and DHCP.</p>

<h3 id="access-point">Access Point</h3>
<p>Since the WAX206 is not officialy supported by OpenWrt (also in the master branch),  I had to compile my OpenWrt image. And I did this using an <a href="https://cloud.oracle.com">Oracle Cloud</a> istance, because I was surprised how on a “forever free plan” you can have access to a quite powerful ARM virtual machine. This hardware results in a full build in about 35/40 minutes without use your local machine or electricity. 
This Oracle free tier is now my new OpenWrt build machine, and I made also my custom builds for the nanoPi R4S router and Netgear GS308T switch.</p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/Screenshot%202023-01-18%20at%2016.40.28.jpeg" alt="Oracle OpenWrt"/>
<img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/Screenshot%202023-02-07%20at%2009.49.53.jpeg" alt="Oracle free tier"/></p>

<p>And with my surprise, in the latest image, the power LED is now green (instead of orange), and this is a bit nicer than the ugly orange one before. Kudos to the dev who changed it.</p>

<p>Talking about the configuration on it, now it is operating as Access Point only, without firewall, DNS, DHCP or other stuff, all is demanded to the nanoPi R4S.</p>

<p>On the WAX206 I had only to create 3 VLAN, two tagged and without any IP or DHCP or firewall, and one, the VLAN that I use to connect to the access point,  untagged and with only a static IP (192.168.1.3).</p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/Screenshot%202023-02-07%20at%2015.07.59.jpeg" alt="AP interfaces"/></p>

<div><div><pre><code>config bridge-vlan
	option device &#39;br-lan&#39;
	option vlan &#39;1&#39;
	list ports &#39;lan4&#39;

config bridge-vlan
	option device &#39;br-lan&#39;
	option vlan &#39;10&#39;
	list ports &#39;lan4:t&#39;

config bridge-vlan
	option device &#39;br-lan&#39;
	option vlan &#39;20&#39;
	list ports &#39;lan4:t&#39;

config bridge-vlan
	option device &#39;br-lan&#39;
	option vlan &#39;50&#39;
	list ports &#39;lan4:t&#39;

config interface &#39;lan&#39;
	option proto &#39;static&#39;
	option device &#39;br-lan.1&#39;
	option ipaddr &#39;192.168.1.3&#39;
	option netmask &#39;255.255.255.0&#39;
	option gateway &#39;192.168.1.2&#39;
	list dns &#39;192.168.1.4&#39;

config interface &#39;iot&#39;
	option device &#39;br-lan.50&#39;
	option proto &#39;none&#39;

config interface &#39;guest&#39;
	option device &#39;br-lan.20&#39;
	option proto &#39;none&#39;

config device
	option name &#39;br-lan.1&#39;
	option type &#39;8021q&#39;
	option ifname &#39;br-lan&#39;
	option vid &#39;1&#39;
	option ipv6 &#39;0&#39;

config device
	option name &#39;br-lan.10&#39;
	option type &#39;8021q&#39;
	option ifname &#39;br-lan&#39;
	option vid &#39;10&#39;
	option ipv6 &#39;0&#39;

config device
	option name &#39;br-lan.20&#39;
	option type &#39;8021q&#39;
	option ifname &#39;br-lan&#39;
	option vid &#39;20&#39;
	option ipv6 &#39;0&#39;

config device
	option name &#39;br-lan.50&#39;
	option type &#39;8021q&#39;
	option ifname &#39;br-lan&#39;
	option vid &#39;50&#39;
	option ipv6 &#39;0&#39;
</code></pre></div></div>
<p>This to be able to access to the AP from the main lan (br-lan.1) but to avoid that a device in the IoT or Guest network sets its own IP as the IP of the AP and indeed, doing this it would be able to bypass the firewall an be inside my main lan.</p>

<p>Then I assigned the correct wireless interfaces to the respective network interfaces/VLANs and that’s all.</p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/Screenshot%202023-02-07%20at%2015.09.50.jpeg" alt="Wireless interfaces"/></p>

<p>I also noticed that this setup is a bit faster because the WAX206/AP is totally transparent and is doing nothing (except their wireless things), and all is demanded to the R4S that is way more powerful and all is routed straight inside it and by it. The gain is marginal, from 0,6/0,7ms to 0,4/0,5ms.</p>

<h3 id="router">Router</h3>
<p>On the nanoPi R4S I’ve made the same VLANs obviously, then I created the same network interfaces and I assigned to every new network its own firewall zone and every network interface has also the DHCP and DNS assigned.</p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/Screenshot%202023-02-07%20at%2015.04.40.jpeg" alt="Router interfaces"/></p>

<div><div><pre><code>config interface &#39;lan&#39;
	option device &#39;br-lan.1&#39;
	option proto &#39;static&#39;
	option ipaddr &#39;192.168.1.2&#39;
	option netmask &#39;255.255.255.0&#39;
	list dns &#39;192.168.1.4&#39;
	
config bridge-vlan
	option device &#39;br-lan&#39;
	option vlan &#39;1&#39;
	list ports &#39;eth1&#39;

config bridge-vlan
	option device &#39;br-lan&#39;
	option vlan &#39;10&#39;
	list ports &#39;eth1:t&#39;

config bridge-vlan
	option device &#39;br-lan&#39;
	option vlan &#39;20&#39;
	list ports &#39;eth1:t&#39;

config bridge-vlan
	option device &#39;br-lan&#39;
	option vlan &#39;50&#39;
	list ports &#39;eth1:t&#39;

config interface &#39;guest&#39;
	option proto &#39;static&#39;
	option device &#39;br-lan.20&#39;
	option ipaddr &#39;192.168.20.1&#39;
	option netmask &#39;255.255.255.0&#39;
	list DNS &#39;192.168.1.4&#39;
	option gateway &#39;192.168.1.2&#39;

config interface &#39;iot&#39;
	option proto &#39;static&#39;
	option device &#39;br-lan.50&#39;
	option ipaddr &#39;192.168.50.1&#39;
	option netmask &#39;255.255.255.0&#39;
	list dns &#39;192.168.1.4&#39;

config device
	option name &#39;br-lan.10&#39;
	option type &#39;8021q&#39;

config device
	option name &#39;br-lan.20&#39;
	option type &#39;8021q&#39;
	option ifname &#39;br-lan&#39;
	option vid &#39;20&#39;
	option ipv6 &#39;0&#39;
	option acceptlocal &#39;1&#39;

config device
	option name &#39;br-lan.1&#39;
	option type &#39;8021q&#39;
	option ifname &#39;br-lan&#39;
	option vid &#39;1&#39;
	option ipv6 &#39;0&#39;
	option acceptlocal &#39;1&#39;

config device
	option name &#39;br-lan.50&#39;
	option type &#39;8021q&#39;
	option ifname &#39;br-lan&#39;
	option vid &#39;50&#39;
	option acceptlocal &#39;1&#39;
	option ipv6 &#39;0&#39;
</code></pre></div></div>

<h3 id="switch">Switch</h3>
<p>The last thing is to tell the switch which physical port is must be assigned to which VLAN and if it must be tagged or untagged.</p>

<p>In my case, all the 8 ports of the switch are assigned to the br-lan.1 (the main lan) untagged, and the ports 3 and 4 are tagged and assigned to the IoT and Guest VLANs. Because to the port 4 of the switch is connected the AP with the same VLANs.</p>

<div><div><pre><code>config bridge-vlan &#39;lan_vlan&#39;
	option device &#39;switch&#39;
	option vlan &#39;1&#39;
	list ports &#39;lan1&#39;
	list ports &#39;lan2&#39;
	list ports &#39;lan3&#39;
	list ports &#39;lan4&#39;
	list ports &#39;lan5&#39;
	list ports &#39;lan6&#39;
	list ports &#39;lan7&#39;
	list ports &#39;lan8&#39;

config device
	option name &#39;switch.1&#39;
	option macaddr &#39;&#39;

config interface &#39;lan&#39;
	option device &#39;switch.1&#39;
	option proto &#39;static&#39;
	option netmask &#39;255.255.255.0&#39;
	option ip6assign &#39;0&#39;
	list dns &#39;192.168.1.4&#39;
	option gateway &#39;192.168.1.2&#39;
	option ipaddr &#39;192.168.1.240&#39;

config bridge-vlan
	option device &#39;switch&#39;
	option vlan &#39;10&#39;
	list ports &#39;lan3:t&#39;
	list ports &#39;lan4:t&#39;

config bridge-vlan
	option device &#39;switch&#39;
	list ports &#39;lan3:t&#39;
	list ports &#39;lan4:t&#39;
	option vlan &#39;20&#39;

config bridge-vlan
	option device &#39;switch&#39;
	option vlan &#39;50&#39;
	list ports &#39;lan3:t&#39;
	list ports &#39;lan4:t&#39;

config device
	option name &#39;switch.10&#39;
	option type &#39;8021q&#39;
	option ifname &#39;switch&#39;
	option vid &#39;10&#39;

config device
	option name &#39;switch.20&#39;
	option type &#39;8021q&#39;
	option ifname &#39;switch&#39;
	option vid &#39;20&#39;

config device
	option name &#39;switch.50&#39;
	option type &#39;8021q&#39;
	option ifname &#39;switch&#39;
	option vid &#39;50&#39;
</code></pre></div></div>

<h3 id="grafana">Grafana</h3>
<p>For the Grafana setup, since now I have all the 3 hardware devices that can create their metrics, so I changed the layout of some panels in order to have all the devices displayed inside one panel. This is very useful because when I get the daily reports I can see the hardware status of all the devices in one.</p>

<p><a href="https://giuliomagnifico.blog/_images/2023/home-network_v4/SCR-20230209-dyl.jpg">full size</a>
<img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/SCR-20230209-dyl.jpg" alt="Grafana-full"/></p>

<p>But with the new setup that uses VLANs instead of subnet, the Prometheus exporters weren’t working, I tried to change the interface to br-lan.x but the only way I figured out to have the setup working, was to use an asterisk for the interfaces, that means “all the available interfaces”, that is also what I want:</p>

<p><code>/etc/config/prometheus-node-exporter-lua</code></p>

<div><div><pre><code>config prometheus-node-exporter-lua &#39;main&#39;
        option listen_interface &#39;*&#39;
        option listen_port &#39;9100&#39;
        option listen_ipv6 &#39;0&#39;
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>
<p>I spent lots of time, about 2 months, in this, but I think I reached a good setup for the summer and future updates of the network. Now the current speed of the wireless devices is the maxium they can reach with their antenna setup.</p>

<p><img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/IMG_40F6B4B87C3F-1.jpeg" alt="iPerf3"/></p>

<p>And about the consumpution, the whole setup uses about 45-50W, as you can see from the Grafana “home dashboard” of the last 7 days:</p>

<p><a href="https://giuliomagnifico.blog/_images/2023/home-network_v4/power.jpeg">full size</a>
<img src="https://giuliomagnifico.blog/_images/2023/home-network_v4/power.jpeg" alt="power_comsuption"/></p>

<p>Feel free to ask or warn me, if you need more information, using the comments or sending me an email.</p>


    </div>

</article>
<!--  --></section>
</div>


  </section>
  
</div>

      </div>
    </div></div>
  </body>
</html>
