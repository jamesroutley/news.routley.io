<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tty.neveragain.de/2023/09/21/aws-cannot-escape-ipv4.html">Original</a>
    <h1>AWS Customers Cannot Escape IPv4</h1>
    
    <div id="readability-page-1" class="page"><div>
		<hr/>

<p>This is the first part of a blog series. Other pieces will be linked here when published.</p>

<hr/>

<h2 id="introduction">Introduction</h2>

<p>AWS has announced that they
<a href="https://aws.amazon.com/blogs/aws/new-aws-public-ipv4-address-charge-public-ip-insights/">will charge for public IPv4 addresses</a>
soon. Surprisingly, most reactions to this announcement were welcoming, as it’s believed to bring
a big push for IPv6 adoption.</p>

<p>The AWS blog had this to say:</p>

<blockquote>
  <p>This change … is also intended to encourage you to be a bit more frugal with your use of public IPv4 addresses and to think about accelerating your adoption of IPv6 as a modernization and conservation measure.</p>
</blockquote>

<p>I will explain why this charge will not affect IPv6 adoption in any meaningful way.</p>

<p>I will also show that it is pretty bold for AWS to use IPv6 in trying to soften the blow of this charge: AWS IPv6 support has
<em>huge</em> gaps. AWS makes it impossible for customers to move on from IPv4.</p>

<p>But first, a quick summary, and some costly anti-patterns to watch out for.</p>

<h2 id="whats-going-to-change">What’s Going to Change</h2>

<p>Every <em>dedicated</em> public AWS IPv4 address<sup id="fnref:byoip" role="doc-noteref"><a href="#fn:byoip" rel="footnote">1</a></sup> will be charged with $0.005 per hour (almost $4 per month /
more than $40 per year), starting February 2024.</p>

<p>Some examples of affected services:</p>
<ul>
  <li>Elastic Load Balancers (one address per availability zone, <em>at least</em> two – and IPv4 cannot be turned off)</li>
  <li>EC2 instances &amp; Elastic IPs</li>
  <li>ECS Fargate<sup id="fnref:awsvpc" role="doc-noteref"><a href="#fn:awsvpc" rel="footnote">2</a></sup> tasks configured with public IPs</li>
  <li>Global Accelerator IPs</li>
  <li>Site-to-site VPN IPs</li>
  <li>RDS (nine in ten customers have public IP on RDS by accident)</li>
  <li>Managed NAT Gateways</li>
</ul>

<p>So for a public Elastic Load Balancer configured in three availability zones (as recommended),
this is a base price increase of over 50%.</p>

<p>For Managed NAT Gateway, this is a base price increase of ~10%. I didn’t think those could become more expensive,
but here we are. By the way, this is a good time to remember that a NAT Gateway does <em>not</em> provide zonal redundancy –
a NAT Gateway in every availability zone is required when outbound connections are critical.</p>

<p>All <em>shared</em> IPv4 addresses, like those used for Cloudfront distributions or API Gateway endpoints, are <em>not</em> affected. Public IPv4
addresses used by non-VPC Lambda functions aren’t affected either.</p>

<h2 id="wasteful-patterns">Wasteful Patterns</h2>

<p>I have observed two patterns that waste quite a lot of addresses and are heavily impacted by the upcoming charges.</p>

<p>The first pattern is having multiple Load Balancers (per VPC); this is often the result of using several
readily available Cloudformation templates / Terraform modules, or somehow using Kubernetes ingress controllers that create
a Load Balancer <em>for every service</em>. This is fixed by not doing that! A single Load Balancer can handle many URLs
and services.</p>

<p>The second pattern is intentionally configuring public IPv4 on EC2 instances and Fargate tasks just to avoid Managed NAT Gateway
(commendable until now!). Ironically, this will still be cheaper until hitting around ten public IPv4 addresses per availability zone.</p>

<h2 id="how-to-check">How to Check</h2>

<p>The usage data for public IPv4 addresses is already being accounted, so it’s easy to check.
Usage is currently listed with $0 but will start to cost $0.005 per hour starting in February 2024.</p>

<ul>
  <li>In <em>Billing Dashboard</em> &gt; <em>Bills</em>, usage is displayed as <code>PublicIPv4:InUseAddress</code>
in the <em>Virtual Private Cloud</em> section</li>
  <li>In <em>Cost Explorer</em>, it’s easy to see usage hours by filtering to only include <code>PublicIPv4:InUseAddress</code>;
this is nice because Cost Explorer shows usage per day/hour and it’s easy to group e.g. by member account</li>
  <li><em>VPC</em> &gt; <em>VPC IP Address Manager</em> (at the very bottom) &gt; <em>Public IP insights</em> is a nice way to get an overview of
public IPv4 address usage; this part of IPAM is free, but it shows data only per account and region, and it’s
incomplete data – it doesn’t capture transient address usage.</li>
</ul>

<h2 id="accelerating-your-ipv6-adoption">Accelerating Your IPv6 Adoption</h2>

<p>So it does sound pretty obvious: IPv4 addresses will soon cost a few bucks, while IPv6 addresses are free of charge. Even better:
There is no concept of private addresses in IPv6, which means farewell to the Managed NAT Gateway and its magnificent pricing.
It seems like the perfect time to finally adopt IPv6.</p>

<p>There are two approaches to adopting IPv6. Either by going dual-stack, which means configuring IPv4 <em>and</em> IPv6 addresses on all systems.
Or by going IPv6-only internally, with IPv4 connectivity only where facing the general public – for example at the very edge, on the CDN,
which takes care of serving IPv4 clients.</p>

<p>Running IPv6-only is the optimal solution for a future-proof network. Even the U.S. Government, of all places,
recognizes this. A <a href="https://www.whitehouse.gov/wp-content/uploads/2020/11/M-21-07.pdf">memorandum from the Executive Office of the President</a> states:</p>

<blockquote>
  <p>In recent years it has become clear that [running dual-stack] is overly complex to maintain and unnecessary. As a result, standards bodies and leading technology companies began migrating toward IPv6-only deployments, thereby eliminating complexity, operational cost, and threat vectors associated with operating two network protocols.</p>
</blockquote>

<p>That memorandum was issued three years ago.</p>

<p>The underlying IPv6 support on AWS is excellent. It’s possible to configure IPv6-only EC2 instances in IPv6-only subnets
and everything works fine, including local DNS, time service, host configuration, security
and all the stuff to be expected in an IPv6-enabled network. Components like VPN, Transit Gateway,
Direct Connect and Network Firewall also support IPv6.</p>

<h2 id="cannot-escape-ipv4">Cannot Escape IPv4<sup id="fnref:title" role="doc-noteref"><a href="#fn:title" rel="footnote">3</a></sup></h2>

<p>The problem is actually using all the (other) Amazon Web Services.</p>

<p>It’s practically impossible to run IPv6-only on AWS. Trying to configure core services like API Gateway, Lambda,
ECS or App Runner into IPv6-only subnets makes them either sternly refuse those subnets or throw comically sad error messages like
<code>Not enough IP space available</code> (Elastic Load Balancer).</p>

<p>And it gets worse: Not even running dual-stack internally helps. Most AWS services, when configured into a dual-stack
subnet, happily ignore that the subnet has IPv6 configured; they can connect to IPv4 targets only. This
<a href="https://twitter.com/tim_nolet/status/1696206569090789416">actually hurts customers</a>.</p>

<p>Almost no AWS API can be used from a VPC without public IPv4 addresses<sup id="fnref:privatelink" role="doc-noteref"><a href="#fn:privatelink" rel="footnote">4</a></sup>.
Running an innocent <code>aws s3 ls</code> from an EC2 instance will fail. Using Systems Manager – the recommended way to
connect to and manage an instance – does not work. Accessing SQS from an ECS Task is impossible. And so on.
This is because <a href="https://awsipv6.neveragain.de">more than 90% of all AWS service API endpoints do not support IPv6</a>.
Other endpoints like SES SMTP or ECR repository endpoints<sup id="fnref:dockerhub" role="doc-noteref"><a href="#fn:dockerhub" rel="footnote">5</a></sup> don’t work either. Cloudfront cannot connect
to IPv6 origins.</p>

<p>And then AWS frames this new charge as an “encouragement” to adopt IPv6. <em>This</em> is what ticked me off:
There is no escape, no way to avoid these charges – because AWS has significantly neglected IPv6 for years.</p>

<h2 id="charges-without-changes">Charges Without Changes</h2>

<p>For most customers, nothing will change. Which is exactly my point.</p>

<p>For AWS customers of any relevant size, this IPv4 charge is a drop in the bucket; they won’t even notice it on their bill.
In my experience so far, this will usually be very well below 1%. Nobody will invest significant engineering effort for that alone.</p>

<p>For many SMBs, hobbyists and startups though, this charge can easily amount to 10-30% of the bill. These customers certainly
would adopt IPv6 to avoid such a price increase.</p>

<p>So that’s where we are: The larger customers do not care about this charge; and those that will feel the impact have
no way to avoid it.</p>

<h2 id="conclusion-so-far">Conclusion So Far</h2>

<p>I think the IPv4 charge by itself is fine – maybe even necessary, given the IPv4 acquisition costs lately.</p>

<p>I would like AWS to be a role model in IPv6 adoption, like they are in many other areas.
If the AWS service landscape had mature IPv6 support, many customers could indeed migrate to IPv6-only environments.
Larger customers still would not care – but it would create a lot of
first movers within the AWS community, setting examples to follow.</p>

<p>But IPv6 is clearly not a first-class citizen on AWS today.</p>

<p>Given those circumstances, this charge will do nothing to drive IPv6 adoption. It will stiffle innovation and make it
<a href="https://www.lastweekinaws.com/blog/aws-has-a-moral-responsibility-to-fix-the-free-tier/">even less</a> attractive to have a
personal AWS account – for example, for learning AWS, to study for certifications (to invest in AWS as a career path) or to
support open-source work. AWS talks big about democratizing cloud; this isn’t it.</p>

<h2 id="upcoming-posts">Upcoming Posts</h2>

<p>This is the first part of a blog series. Upcoming posts will take in-depth looks at options for ingress and intra-VPC traffic
(IPv6 support in Cloudfront, API Gateway, App Runner etc.), egress traffic (avoiding public IPv4 addresses and NAT Gateways),
application programming issues (accessing AWS service endpoints and peculiarities of the AWS CLI and SDKs in dealing with
IPv6), other obscure details and a list of helpful resources.</p>

<hr/>

<p><a href="https://twitter.com/apparentorder/status/1704628704876388472">Discuss and/or follow on Twitter!</a></p>

<hr/>

<h2 id="links">Links</h2>

<ul>
  <li><a href="https://d1.awsstatic.com/architecture-diagrams/ArchitectureDiagrams/IPv6-reference-architectures-for-AWS-and-hybrid-networks-ra.pdf">Dual Stack and IPv6-only Amazon VPC Reference Architectures</a> (PDF)</li>
  <li>AWS Workshop: <a href="https://catalog.workshops.aws/ipv6-on-aws/en-US">Get hands-on with IPv6</a></li>
  <li>AWS blog
    <ul>
      <li><a href="https://aws.amazon.com/blogs/aws/new-aws-public-ipv4-address-charge-public-ip-insights/">AWS Public IPv4 Address Charge + Public IP Insights</a></li>
      <li><a href="https://aws.amazon.com/blogs/networking-and-content-delivery/identify-and-optimize-public-ipv4-address-usage-on-aws/">Identify and optimize public IPv4 address usage on AWS</a></li>
      <li>Dual-stack IPv6 architectures for AWS and hybrid networks
<a href="https://aws.amazon.com/blogs/networking-and-content-delivery/dual-stack-ipv6-architectures-for-aws-and-hybrid-networks/">Part 1</a>
and <a href="https://aws.amazon.com/blogs/networking-and-content-delivery/dual-stack-architectures-for-aws-and-hybrid-networks-part-2/">Part 2</a></li>
    </ul>
  </li>
  <li>AWS whitepaper
    <ul>
      <li><a href="https://docs.aws.amazon.com/whitepapers/latest/ipv6-on-aws/designing-an-ipv6-aws-cloud-network.html">Designing an IPv6 AWS Cloud network</a></li>
      <li><a href="https://docs.aws.amazon.com/whitepapers/latest/ipv6-on-aws/IPv6-on-AWS.html">IPv6 on AWS</a></li>
    </ul>
  </li>
  <li>AWS VPC documentation
    <ul>
      <li><a href="https://docs.aws.amazon.com/vpc/latest/userguide/aws-ipv6-support.html">AWS services that support IPv6</a>
(includes a list of ~30 services that have at least some IPv6 support; not listed at all are the ~200 other services)</li>
      <li><a href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-migrate-ipv6.html">Migrate your VPC from IPv4 to IPv6</a></li>
      <li><a href="https://docs.aws.amazon.com/vpc/latest/userguide/nat-gateway-nat64-dns64.html">DNS64 and NAT64</a></li>
    </ul>
  </li>
</ul>

<hr/>

<p><em>Update 2023-09-21</em> – added “Links” section</p>

<p><em>Update 2023-09-21</em> – affected services: added RDS; made it clear that those are examples
(list is not exhaustive)</p>

<hr/>



	</div></div>
  </body>
</html>
