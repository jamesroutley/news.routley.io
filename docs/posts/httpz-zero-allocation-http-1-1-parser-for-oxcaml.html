<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/avsm/httpz">Original</a>
    <h1>Httpz – Zero-Allocation HTTP/1.1 Parser for OxCaml</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">A high-performance HTTP/1.1 parser and serializer that aims for zero heap
allocations using OxCaml&#39;s unboxed types and local allocations.</p>
<p dir="auto">Will soon have io_uring on Linux.</p>

<ul dir="auto">
<li><strong>Zero heap allocations</strong>: Parser results are stack-allocated using OxCaml unboxed records and local lists</li>
<li><strong>Direct bigstring I/O</strong>: Read and write directly to/from bigarray buffers</li>
<li><strong>HTTP/1.1 support</strong>: Methods, headers, chunked transfer encoding, keep-alive</li>
<li><strong>Async file server included</strong>: Production-ready static file server. Soon to be parallel.</li>
</ul>

<p dir="auto">httpz achieves zero-allocation parsing through:</p>
<ol dir="auto">
<li><strong>Unboxed records</strong> (<code>#{...}</code>): Request and span types are stack-allocated</li>
<li><strong>Local lists</strong> (<code>@ local</code>): Header list grows on the stack, not heap</li>
<li><strong>Span-based parsing</strong>: Strings are referenced by offset+length into the input buffer</li>
<li><strong>Pre-allocated buffers</strong>: 32KB read buffer reused across requests</li>
</ol>

<p dir="auto">Benchmarks comparing httpz (OxCaml) vs httpe (Eio-based parser):</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Request Size</th>
<th>httpz (ns/op)</th>
<th>httpe (ns/op)</th>
<th>Speedup</th>
<th>Allocation Reduction</th>
</tr>
</thead>
<tbody>
<tr>
<td>Small (35B)</td>
<td>69</td>
<td>218</td>
<td><strong>3.14x</strong></td>
<td>94x fewer words</td>
</tr>
<tr>
<td>Medium (439B)</td>
<td>792</td>
<td>1,690</td>
<td><strong>2.13x</strong></td>
<td>399x fewer words</td>
</tr>
<tr>
<td>Large (1155B)</td>
<td>1,771</td>
<td>4,017</td>
<td><strong>2.27x</strong></td>
<td>829x fewer words</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto"><strong>Throughput</strong>: 14.6M requests/sec (vs 4.6M for httpe)</p>

<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Operation</th>
<th>Time</th>
<th>Heap Allocations</th>
</tr>
</thead>
<tbody>
<tr>
<td>Parse minimal request</td>
<td>209ns</td>
<td>3 words</td>
</tr>
<tr>
<td>Parse browser request (10 headers)</td>
<td>2.8μs</td>
<td>3 words</td>
</tr>
<tr>
<td>Parse 50 headers</td>
<td>7.7μs</td>
<td>3 words</td>
</tr>
<tr>
<td>Write status line</td>
<td>21ns</td>
<td>3 words</td>
</tr>
<tr>
<td>Write full response headers</td>
<td>62ns</td>
<td>3 words</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>

<p dir="auto">Requires OxCaml compiler from <a href="https://oxcaml.org/" rel="nofollow">https://oxcaml.org/</a></p>

<p dir="auto">An Async-based static file server is included:</p>
<div dir="auto" data-snippet-clipboard-copy-content="# Serve current directory on port 8080
dune exec bin/httpz_server.exe

# Serve specific directory on custom port
dune exec bin/httpz_server.exe -- -d /var/www -p 3000

# Get help
dune exec bin/httpz_server.exe -- -help"><pre><span><span>#</span> Serve current directory on port 8080</span>
dune <span>exec</span> bin/httpz_server.exe

<span><span>#</span> Serve specific directory on custom port</span>
dune <span>exec</span> bin/httpz_server.exe -- -d /var/www -p 3000

<span><span>#</span> Get help</span>
dune <span>exec</span> bin/httpz_server.exe -- -help</pre></div>
<p dir="auto">Features:</p>
<ul dir="auto">
<li>Async concurrent connection handling (up to 10,000 connections)</li>
<li>Zero-copy bigstring I/O</li>
<li>MIME type detection</li>
<li>Directory traversal protection</li>
<li>Automatic <code>index.html</code> for directories</li>
</ul>

<div dir="auto" data-snippet-clipboard-copy-content="# Comparative benchmark (httpz vs httpe)
dune exec bench/bench_compare.exe

# Detailed httpz benchmarks with core_bench
dune exec bench/bench_httpz.exe -- -quota 2"><pre><span><span>#</span> Comparative benchmark (httpz vs httpe)</span>
dune <span>exec</span> bench/bench_compare.exe

<span><span>#</span> Detailed httpz benchmarks with core_bench</span>
dune <span>exec</span> bench/bench_httpz.exe -- -quota 2</pre></div>

<p dir="auto">ISC</p>
</article></div></div>
  </body>
</html>
