<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://andschwa.com/posts/emacs-on-an-ipad/">Original</a>
    <h1>Emacs on an iPad</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>With my iPad having replaced my MacBook, the last thing I was missing was
<a href="https://github.com/andschwa/.emacs.d">Emacs</a>, which I not only enjoy hacking on, but is also how update my blog and
resume! Let’s just say that it’s an integral tool in my life which I wanted
access to, and I managed to make it happen.</p>
<p>So first off, you cannot run Emacs directly on an iPad as an app, but can
certainly access something <em>else</em> which is running it. In this case a Virtual
Private Server (VPS) over SSH, such as one might setup on DigitalOcean. Cloud
hosts have plenty of information on how to deploy a VPS, so I won’t repeat it
here. These instructions are for an Ubuntu 20.04 machine.</p>
<p>I think the app <a href="https://blink.sh">Blink</a> is more than adequate as a terminal
emulator (with 24 bit color support, which is important!) with SSH access and a
number of useful supporting tools (like <a href="https://blink.sh/docs/advanced/advanced-ssh#ssh-agent-and-forwarding"><code>ssh-agent</code></a>).</p>
<p>I used the app’s settings (either type <code>config</code> or hit <code>CMD-,</code>) to generate a
new SSH key pair and add my VPS as a host named <code>vps</code> with its IPv6 address for
the host name. Before connecting I first open a tab and start <code>ssh-agent</code>, then
I open a <em>second</em> tab and run <code>ssh-add id_rsa</code> (no, not the path to the key,
just the key’s default name, which the app’s port of the tools just
understands), and finally connect with the forwarded agent via <code>ssh -A vps</code>.</p>
<p>In the app’s keyboard settings I set “Option” to send “Esc” (which is “Alt” for
terminals and “Meta” for Emacs, as in the <code>M</code> in <code>M-x</code>). In my system settings I
have my hardware keyboard’s “Caps Lock” key set to act as “Control,” but Blink
can do this in software as well.</p>
<h2 id="install-the-basics">Install the Basics</h2>
<p>From here I first installed some helpful tools:</p>
<ul>
<li><code>git</code> and <code>stow</code> to setup my <a href="https://github.com/andschwa/dotfiles">dotfiles</a></li>
<li><a href="https://github.com/BurntSushi/ripgrep"><code>ripgrep</code></a> search tool</li>
<li><code>aspell</code> for spell checking in Emacs with Flyspell</li>
<li><code>htop</code> because it’s pretty and helpful to see what’s going on</li>
</ul>
<div><pre><code data-lang="bash">sudo apt install git stow ripgrep aspell htop
</code></pre></div><h2 id="secure-it-with-sshguard">Secure it with SSHGuard</h2>
<p>Installing <a href="https://www.sshguard.net">SSHGuard</a> is still very useful to mitigate
connection attempts to an open VPS:</p>
<div><pre><code data-lang="bash">sudo apt install sshguard
sudo journalctl -u sshguard
</code></pre></div><p>Once I saw how many connection attempts were being made (but all failing because
I only have key access setup, no passwords), I added a firewall rule on
DigitalOcean to deny all incoming traffic except port 22 (SSH) on IPv6. This
allows me to access it because I know its IPv6 address, but since that address
space is so huge it really can’t be found by bots scanning it.</p>
<h2 id="add-a-swap-file">Add a Swap File</h2>
<p>Now before attempting to compile anything from source on a VPS with limited
memory, I like to setup a swap file to prevent silly out of memory errors. I
think I followed this guide on
<a href="https://linuxize.com/post/create-a-linux-swap-file/">Linuxize</a>. In short:</p>
<div><pre><code data-lang="bash">sudo swapon --show
sudo fallocate -l 1G /swapfile
sudo chmod <span>600</span> /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
sudo swapon --show
sudo cp /etc/fstab /etc/fstab.bak
<span>echo</span> <span>&#39;/swapfile none swap sw 0 0&#39;</span> <span>|</span> sudo tee -a /etc/fstab
</code></pre></div><h2 id="build-emacs-from-source">Build Emacs from Source</h2>
<p>Ok, now the fun part: building Emacs 27 from source, for the terminal, with
everything we need. First we clone the <code>emacs-27</code> branch from the GitHub mirror:</p>
<div><pre><code data-lang="bash">git clone -b emacs-27 https://github.com/emacs-mirror/emacs.git
<span>cd</span> emacs
</code></pre></div><p>Now we install the myriad of necessary packages (I think this was everything I
could find in my <code>bash_history</code> after I got things working). This includes the
normal build tools, TeX for the documentation, ncurses since this is a
<em>terminal</em> build, GNU TLS for secure connections when installing packages,
Jansson JSON library for <a href="https://microsoft.github.io/language-server-protocol/">LSP</a>, XML library, zlib library, and finally the
<a href="https://systemd.io">systemd</a> library because we’ll use the unit file to daemonize Emacs.</p>
<div><pre><code data-lang="bash">sudo apt install build-essential autoconf pkg-config texinfo <span>\
</span><span></span>     libncurses-dev libgnutls28-dev libjansson-dev <span>\
</span><span></span>     libxml2-dev libz-dev libsystemd-dev
</code></pre></div><p>Now hopefully you can configure the build. The first step uses <code>autoconf</code>
(installed above) to generate the <code>configure</code> file, which is then used to
generate the <code>Makefile</code>. The configuration options explicitly disable X since,
again, this is a terminal build, enable the features outlined above, and set the
image support to be enabled opportunistically instead of required.</p>
<div><pre><code data-lang="bash">./autogen.sh
./configure --with-x-toolkit<span>=</span>no --with-gnutls --with-json --with-xml2 --with-libsystemd  <span>\
</span><span></span>            --with-jpeg<span>=</span>ifavailable --with-png<span>=</span>ifavailable --with-gif<span>=</span>ifavailable <span>\
</span><span></span>            --with-tiff<span>=</span>ifavailable --with-xpm<span>=</span>ifavailable
</code></pre></div><p>Finally we can launch a parallel build. I like to connect in another Blink tab
and launch <code>htop</code> to watch the pretty colors as the core usage is reported. When
it’s done, install it!</p>
<div><pre><code data-lang="bash">make -j <span>$(</span>nproc<span>)</span> all info doc
sudo make -j <span>$(</span>nproc<span>)</span> install
</code></pre></div><h3 id="daemonize-emacs">Daemonize Emacs</h3>
<p>This is why we installed and configured the <code>systemd</code> library support. I always
use Emacs in <a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Emacs-Server.html">server</a> mode so that I can simply edit files with <code>emacsclient</code>
(which I alias to simply <code>e</code>) as fast as <code>vi</code> users. Enable and start the
user-scoped unit file that Emacs installed, and check the log to see if it
worked. It should start Emacs with <code>--fg-daemon</code>, and hopefully your own
<code>init.el</code> is setup such that this works.</p>
<div><pre><code data-lang="bash">systemctl --user <span>enable</span> --now emacs
journalctl --user-unit emacs
</code></pre></div><h3 id="fix-the-ssh-agent">Fix the SSH Agent</h3>
<p>So one problem shows up when using Emacs as a daemon under <code>systemd</code>: your SSH
environment isn’t used which means the forwarded SSH agent cannot be found. I
fixed this by adding the following code to my <code>~/.bashrc</code> to opportunistically
find the socket file and set <code>SSH_AUTH_SOCK</code> appropriately.</p>
<p>Note that I don’t actually have this in <code>~/.bashrc</code> but in an environment setup
file which I ensure is always sourced by Bash, that way my interactive shell
setup is kept separate. But that’s for another blog post.</p>
<div><pre><code data-lang="bash"><span># Find SSH agent socket file</span>
<span>ssh_sock_file</span><span>=</span><span>$(</span><span>compgen</span> -G <span>&#34;/tmp/ssh-*/agent.*&#34;</span> <span>|</span> head -n 1<span>)</span>
<span>if</span> <span>[[</span> -z <span>$SSH_AUTH_SOCK</span> <span>&amp;&amp;</span> -S <span>$ssh_sock_file</span> <span>]]</span><span>;</span> <span>then</span>
    <span>export</span> <span>SSH_AUTH_SOCK</span><span>=</span><span>$ssh_sock_file</span>
<span>fi</span>
</code></pre></div><p>Then I used the ever helpful <a href="https://github.com/purcell/exec-path-from-shell">exec-path-from-shell</a> Emacs package to set this
environment variable within Emacs when it starts.</p>
<div><pre><code data-lang="emacs-lisp"><span>(</span><span>use-package</span> <span>exec-path-from-shell</span>
  <span>:if</span> <span>(</span><span>daemonp</span><span>)</span>
  <span>:config</span>
  <span>(</span><span>add-to-list</span> <span>&#39;exec-path-from-shell-variables</span> <span>&#34;SSH_AUTH_SOCK&#34;</span><span>)</span>
  <span>(</span><span>exec-path-from-shell-initialize</span><span>))</span>
</code></pre></div><h3 id="add-24-bit-support-to-terminal">Add 24-bit Support to Terminal</h3>
<p>Okay so now we need to setup 24-bit colors because otherwise my favorite Emacs
theme, <a href="https://github.com/bbatsov/solarized-emacs/issues/18">Solarized</a>, has a bright blue background! It’s an ancient “bug” and
frankly will never be fixed, but 24-bit terminal support is a viable workaround.
Besides, it’s prettier that way.</p>
<p>The official Emacs FAQ has an entry, <a href="https://www.gnu.org/software/emacs/manual/html_node/efaq/Colors-on-a-TTY.html">Colors on a TTY</a>, with detailed
instructions to enable “direct color mode” in the terminal. Unfortunately, the
instructions as currently posted do not work with Blink, or at least not how
I’ve set it up. Interestingly, a <a href="https://github.com/emacs-mirror/emacs/commit/e463e5762bbe628be3d15da066a90f079a8468b3">prior</a> version of the instructions (where
the semicolons were replaced with colons), <em>does</em> work, so that’s what I adapted
and used. All this “terminfo” stuff is rather archaic, and I haven’t found a
satisfactory answer as to why it’s broken and why what I did worked, so if you
have any insight, I’d love to hear it <a href="https://github.com/bbatsov/solarized-emacs/issues/18#issuecomment-751009572">here</a>.</p>
<p>Like in the instructions, create a file named <code>terminfo-custom.src</code> with the
following content (where I’ve removed the line breaks and replaced escaped
colons <code>\:</code> with semicolons <code>;</code>, and deleted the repeated colon after “2”):</p>
<div><pre><code data-lang="terminfo"><span># See Emacs FAQ &#34;Colors on a TTY&#34; but sub ; for :</span><span>
</span><span></span><span>xterm-emacs</span><span>|</span><span>xterm with 24-bit direct color mode for Emacs</span><span>,</span>
  <span>use</span><span>=</span><span>xterm-256color</span><span>,</span>
  <span>setb24</span><span>=</span><span>\E[48;2;%p1%{65536}%/%d;%p1%{256}%/%{255}%&amp;%d;%p1%{255}%&amp;%dm</span><span>,</span>
  <span>setf24</span><span>=</span><span>\E[38;2;%p1%{65536}%/%d;%p1%{256}%/%{255}%&amp;%d;%p1%{255}%&amp;%dm</span><span>,</span>
</code></pre></div><p>This is a file with “terminfo” (terminal info) which we then compile to the user
terminfo database with <code>tic</code>:</p>
<div><pre><code data-lang="bash">tic -x -o ~/.terminfo terminfo-custom.src
</code></pre></div><p>Now we can set <code>TERM=xterm-emacs</code> and launch Emacs with full 24-bit color
support, which means the Solarized theme works!</p>
<h3 id="some-keys-that-wont-work">Some keys that won’t work</h3>
<p>There are a number of Emacs bindings that simply cannot be typed in a terminal
because it’s restricted to the ASCII character set. They all seem to be control
prefixes, perhaps it’s something to do with <em>control</em> characters used by
terminals. Frankly I don’t know, the implementation of TTYs is arcane to me.</p>
<p>Some of these quite annoying, if you have a fix, <em>please</em> let me know!</p>
<h4 id="c-spc"><code>C-SPC</code></h4>
<p>In the “Custom Presses” section at the bottom of Blink’s keyboard settings I
added “^_” (“Control-Space”) to send exactly that, “Control-Space,” used often
in Emacs for marking. This is a bit of a workaround because iPadOS otherwise
intercepts that keyboard combination and uselessly opens the Emoji keyboard (or
usefully opens your other language’s keyboards), and another workaround is to
remove all other keyboards. Unfortunately, even with these workarounds it
doesn’t seem to “persist” through key chords so I have to let go of control
between keys in a chord. That is, <code>C-SPC C-p</code> with control held prints “p” but
<code>C-SPC</code>, release control, <code>C-p</code> works as expected.</p>
<p>Interestingly, <code>C-2</code> comes through as <code><a href="https://andschwa.com/cdn-cgi/l/email-protection" data-cfemail="3c7f117c">[email protected]</a></code>, one of the alternative default
bindings for <code>set-mark-command</code>, which I previously never understood as it was
difficult to type. It’s a viable replacement for <code>C-SPC</code> since the shift key
does not actually have to be pressed, and it makes me wonder if this was the
case with old-school TTYs as well, ergo its existence.</p>
<h4 id="c-x-c-"><code>C-x C-;</code></h4>
<p>The key combination <code>C-;</code> is not a valid character in a terminal, so it is
baffling that it is used as a default binding. When using Emacs in a terminal
typing <code>C-x C-;</code> mis-translates to <code>C-x ;</code> which calls <code>comment-set-column</code>, a
confusing situation indeed! Instead of finding a new mapping, I just select the
line and use <code>M-;</code>.</p>
<h4 id="c-123-any-number"><code>C-&lt;1,2,3,...&gt;</code> (any number)</h4>
<p>This one sure is awful. Again a prevalent default (used as one option for
numeric prefixes), it also drops control and just inserts the digit.
Fortunately, <code>M-&lt;1,2,3...&gt;</code> all work as expected.</p>
<h4 id="c-"><code>C-=</code></h4>
<p>I have this bound to the ever helpful <a href="https://github.com/magnars/expand-region.el">expand-region</a> command, but it doesn’t
work either, the control is dropped.</p>
<h2 id="outro">Outro</h2>
<p>I’m happily blogging away in Emacs on my iPad now. In fact, two last notes about
Blink: it supports SSH tunnels and copying files!</p>
<p>For Hugo, I connect with <code>ssh -A -L 1313:localhost:1313 vps</code> (tunneling my
iPad’s port 1313 to the VPS’s port 1313), and then launch <code>hugo server</code> which
listens on that port by default. I can then see my blog in Safari at:
http://localhost:1313</p>
<p>I’m also successfully hacking on Python with fast LSP support, and even edited
my LaTeX resume. You can run <code>link-files</code> in a separate Blink tab which opens a
dialog to link an iPad or iCloud folder to the app (like your Desktop). Copying
a file using Blink is a bit arduous. The SCP port is actually <code>curl</code> underneath,
and using IPv6 with that is tricky. This seemed hacky but worked:</p>
<div><pre><code data-lang="bash">link-files
curl --insecure -v -u &lt;VPS username&gt; <span>&#34;scp://[VPS IPv6 address]/~/path/to/file.pdf&#34;</span> -o Desktop/file.pdf
</code></pre></div><p>Let me know how your experience goes!</p>
</div></div>
  </body>
</html>
