<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/DesktopECHO/T95-H616-Malware">Original</a>
    <h1>T95 Allwinner T616 Malware Analysis</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/33142753/211725608-d9b4b2bd-58ec-4cd2-976d-1f161823822e.png"><img src="https://user-images.githubusercontent.com/33142753/211725608-d9b4b2bd-58ec-4cd2-976d-1f161823822e.png" alt="image"/></a></p>
<p dir="auto">Does your T95 Android TV Box contain a folder named:</p>
<p dir="auto"><code>/data/system/Corejava</code></p>
<p dir="auto">...and a file named</p>
<p dir="auto"><code>/data/system/shared_prefs/open_preference.xml</code>?</p>
<p dir="auto">Your T95 is infected with malware pre-installed, ready to do whatever the C2 servers decide.  Yes, malware from Amazon straight to your door!  If they insist on selling these devices they really should add an &#34;Includes Malware&#34; category in the Android TV section.</p>
<p dir="auto">A few months ago I purchased a <a href="https://m.media-amazon.com/images/I/716SS0ze8pL.jpg" rel="nofollow">T95 Android TV</a> box; it came with Android 10 (with working Play store) and an Allwinner H616 processor.   It&#39;s a small-ish black box with a blue swirly graphic on top and a digital clock on the front.  There&#39;s got to be thousands (or more!) of these boxes already in use globally.</p>
<p dir="auto">There are <a href="https://www.amazon.com/s?k=t95+h616&amp;crid=2MYAV99P2V0S3&amp;sprefix=t95+h616%2Caps%2C121&amp;ref=nb_sb_noss_2" rel="nofollow">tons of them available for purchase on Amazon</a> and AliExpress.</p>
<p dir="auto">This device&#39;s ROM turned out to be very very sketchy -- Android 10 is signed with test keys, and named &#34;Walleye&#34; after the Google Pixel 2.  I noticed there was not much crapware to be found, on the surface anyway.  If test keys weren&#39;t enough of a bad omen, I found ADB wide open over Ethernet and WiFi - right out-of-the-box.</p>
<p dir="auto">I purchased the device to run <a href="https://github.com/DesktopECHO/Pi-hole-for-Android">Pi-hole</a> among other things, and that&#39;s how I discovered just how nastily this box is festooned with malware.  After running the Pi-hole install I set the box&#39;s DNS1 and DNS2 to <a href="https://127.0.0.1" rel="nofollow">127.0.0.1</a> and got a <a href="https://forum.xda-developers.com/attachments/1668625298269-png.5763127/" rel="nofollow">hell of a surprise</a>.   The box was reaching out to many known, <strong>active</strong> malware addresses.</p>
<p dir="auto">After searching unsuccessfully for a clean ROM, I set out to remove the malware in a last-ditch effort to make the T95 useful.  I found layers on top of layers of malware using <code>tcpflow</code> and <code>nethogs</code> to monitor traffic and traced it back to the offending process/APK which I then removed from the ROM.</p>
<p dir="auto">The final bit of malware I could not track down injects the <code>system_server</code> process and looks to be deeply-baked into the ROM.  It&#39;s pretty sophisticated malware, resembling <a href="https://www.checkpoint.com/downloads/resources/copycat-research-report.pdf" rel="nofollow">CopyCat </a>in the way it operates.  It&#39;s not found by any of the AV products I tried -- If anyone can offer guidance on how to find these hooks into <code>system_server</code> let me know.</p>
<p dir="auto">The closest I could come to neutralizing the malaware was to use Pi-hole to change the DNS of the command and control server, <strong>YCXRL.COM</strong> to <em>127.0.0.2</em>.   You can then monitor activity with netstat:</p>
<div data-snippet-clipboard-copy-content="netstat -nputwc | grep 127.0.0.2

tcp6   1    0 127.0.0.1:34282  127.0.0.2:80     CLOSE_WAIT  2262/system_server  
tcp    0    0 127.0.0.2:80     127.0.0.1:34280  TIME_WAIT   -                   
tcp    0    0 127.0.0.2:80     127.0.0.1:34282  FIN_WAIT2   -                   
tcp6   1    0 127.0.0.1:34282  127.0.0.2:80     CLOSE_WAIT  2262/system_server  
tcp    0    0 127.0.0.2:80     127.0.0.1:34280  TIME_WAIT   -                   
tcp    0    0 127.0.0.2:80     127.0.0.1:34282  FIN_WAIT2   -                   
tcp6   1    0 127.0.0.1:34282  127.0.0.2:80     CLOSE_WAIT  2262/system_server  
tcp    0    0 127.0.0.2:80     127.0.0.1:34280  TIME_WAIT   -                   
tcp    0    0 127.0.0.2:80     127.0.0.1:34282  FIN_WAIT2   -                   
tcp6   1    0 127.0.0.1:34282  127.0.0.2:80     CLOSE_WAIT  2262/system_server  "><pre><code>netstat -nputwc | grep 127.0.0.2

tcp6   1    0 127.0.0.1:34282  127.0.0.2:80     CLOSE_WAIT  2262/system_server  
tcp    0    0 127.0.0.2:80     127.0.0.1:34280  TIME_WAIT   -                   
tcp    0    0 127.0.0.2:80     127.0.0.1:34282  FIN_WAIT2   -                   
tcp6   1    0 127.0.0.1:34282  127.0.0.2:80     CLOSE_WAIT  2262/system_server  
tcp    0    0 127.0.0.2:80     127.0.0.1:34280  TIME_WAIT   -                   
tcp    0    0 127.0.0.2:80     127.0.0.1:34282  FIN_WAIT2   -                   
tcp6   1    0 127.0.0.1:34282  127.0.0.2:80     CLOSE_WAIT  2262/system_server  
tcp    0    0 127.0.0.2:80     127.0.0.1:34280  TIME_WAIT   -                   
tcp    0    0 127.0.0.2:80     127.0.0.1:34282  FIN_WAIT2   -                   
tcp6   1    0 127.0.0.1:34282  127.0.0.2:80     CLOSE_WAIT  2262/system_server  
</code></pre></div>
<p dir="auto">I also had to create an iptables rule to redirect all DNS to the Pi-hole as the malware/virus/whatever will use external DNS if it can&#39;t resolve, and then tries with a nonstandard port.</p>
<div data-snippet-clipboard-copy-content="adb shell iptables -t nat -A OUTPUT -p udp --dport 53 -j DNAT --to 127.0.0.1:53
adb shell iptables -t nat -A OUTPUT -p tcp --dport 53 -j DNAT --to 127.0.0.1:53
adb shell iptables -t nat -A OUTPUT -p tcp --dport 5353 -j DNAT --to 127.0.0.1:53
adb shell iptables -t nat -A OUTPUT -p udp --dport 5353 -j DNAT --to 127.0.0.1:53"><pre><code>adb shell iptables -t nat -A OUTPUT -p udp --dport 53 -j DNAT --to 127.0.0.1:53
adb shell iptables -t nat -A OUTPUT -p tcp --dport 53 -j DNAT --to 127.0.0.1:53
adb shell iptables -t nat -A OUTPUT -p tcp --dport 5353 -j DNAT --to 127.0.0.1:53
adb shell iptables -t nat -A OUTPUT -p udp --dport 5353 -j DNAT --to 127.0.0.1:53
</code></pre></div>
<p dir="auto">By doing this, the C&amp;C server ends up hitting the Pi-hole webserver</p>
<div data-snippet-clipboard-copy-content="1672673217|ycxrl.com|POST /terminal/client/eventinfo HTTP/1.1|404|0
1672673247|ycxrl.com|POST /terminal/client/eventinfo HTTP/1.1|404|0
1672673277|ycxrl.com|POST /terminal/client/eventinfo HTTP/1.1|404|0
1672673307|ycxrl.com|POST /terminal/client/eventinfo HTTP/1.1|404|0
1672673907|ycxrl.com|POST /terminal/client/eventinfo HTTP/1.1|404|0
1672673937|ycxrl.com|POST /terminal/client/eventinfo HTTP/1.1|404|0
1672673967|ycxrl.com|POST /terminal/client/eventinfo HTTP/1.1|404|0
1672673997|ycxrl.com|POST /terminal/client/eventinfo HTTP/1.1|404|0"><pre><code>1672673217|ycxrl.com|POST /terminal/client/eventinfo HTTP/1.1|404|0
1672673247|ycxrl.com|POST /terminal/client/eventinfo HTTP/1.1|404|0
1672673277|ycxrl.com|POST /terminal/client/eventinfo HTTP/1.1|404|0
1672673307|ycxrl.com|POST /terminal/client/eventinfo HTTP/1.1|404|0
1672673907|ycxrl.com|POST /terminal/client/eventinfo HTTP/1.1|404|0
1672673937|ycxrl.com|POST /terminal/client/eventinfo HTTP/1.1|404|0
1672673967|ycxrl.com|POST /terminal/client/eventinfo HTTP/1.1|404|0
1672673997|ycxrl.com|POST /terminal/client/eventinfo HTTP/1.1|404|0
</code></pre></div>
<p dir="auto">&#34;Stage 0&#34; hooks <code>system_server</code> and attempts to pull-down a payload from <code>ycxrl.com</code>, <code>cbphe.com</code>, or <code>cbpheback.com</code></p>
<p dir="auto">The DNS addresses above (as of this writing) are hosted by Linode/Akami.</p>
<h2 dir="auto"><a id="user-content-cleanup-instructions" aria-hidden="true" href="#cleanup-instructions"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Cleanup Instructions</h2>
<ul dir="auto">
<li>Reboot into recovery to reset the device or use the Reset option in the &#39;about&#39; menu to &#34;Factory Reset&#34; the T95</li>
<li>When device comes back online, connect to <code>adb</code> via USB A-to-A cable or WiFi/Ethernet</li>
<li><a href="https://github.com/DesktopECHO/T95-H616-Malware/blob/main/T95-H616-Cleanup.sh">Run the script</a> (WiP!)</li>
</ul>
<h2 dir="auto"><a id="user-content-check-if-the-script-was-successful" aria-hidden="true" href="#check-if-the-script-was-successful"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Check if the script was successful</h2>
<p dir="auto"><code>adb logcat | grep Corejava</code></p>
<p dir="auto">The script prevents a successful download from the C2 servers, as the malware can&#39;t write to /Corejava, preventing the payload from doing naughty things on your device:</p>
<p dir="auto"><code>101-10 23:34:39.759  2153  2153 W FileUtils: Failed to chmod(/data/system/Corejava): android.system.ErrnoException: chmod failed: EPERM (Operation not permitted)</code></p>
<p dir="auto"><code>01-10 23:34:39.760  2153  2153 W FileUtils: Failed to chmod(/data/system/Corejava/node): android.system.ErrnoException: chmod failed: ENOTDIR (Not a directory)</code></p>
<h2 dir="auto"><a id="user-content-ongoing-investigation" aria-hidden="true" href="#ongoing-investigation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Ongoing Investigation</h2>
<p dir="auto">In this repo you will find Classes.dex, the &#39;Stage 1&#39; payload I managed to capture.  The malware takes many measures to prevent from being discovered.  You can install Pi-hole and <code>tcpflow</code> to monitor activity.  Hopefully a method can be found to to completely disable the malware, for the time being this is as close as it gets.</p>
</article>
          </div></div>
  </body>
</html>
