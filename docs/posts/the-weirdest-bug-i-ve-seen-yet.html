<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://engineering.gusto.com/the-weirdest-bug-ive-seen-yet/">Original</a>
    <h1>The weirdest bug I&#39;ve seen yet</h1>
    
    <div id="readability-page-1" class="page"><div>
            <article>
                <div>
                    <section>
                        
                    </section>

                    <section>
                        <div>
                            <p>29 November 2023</p>
                            <p>7 min read</p>
                        </div>

                        

                        

                        <div><h3 id="how-digging-into-an-on-call-issue-led-to-an-unlikely-culprit">How digging into an on-call issue led to an unlikely culprit</h3><figure><img src="https://images.unsplash.com/photo-1565635897404-6c9a6515cc91?crop=entropy&amp;cs=tinysrgb&amp;fit=max&amp;fm=jpg&amp;ixid=M3wxMTc3M3wwfDF8c2VhcmNofDJ8fExlYWZob3BwZXJ8ZW58MHx8fHwxNzAwNjg3MjM4fDA&amp;ixlib=rb-4.0.3&amp;q=80&amp;w=2000" alt="red and yellow insect" loading="lazy" width="4496" height="2997" srcset="https://images.unsplash.com/photo-1565635897404-6c9a6515cc91?crop=entropy&amp;cs=tinysrgb&amp;fit=max&amp;fm=jpg&amp;ixid=M3wxMTc3M3wwfDF8c2VhcmNofDJ8fExlYWZob3BwZXJ8ZW58MHx8fHwxNzAwNjg3MjM4fDA&amp;ixlib=rb-4.0.3&amp;q=80&amp;w=600 600w, https://images.unsplash.com/photo-1565635897404-6c9a6515cc91?crop=entropy&amp;cs=tinysrgb&amp;fit=max&amp;fm=jpg&amp;ixid=M3wxMTc3M3wwfDF8c2VhcmNofDJ8fExlYWZob3BwZXJ8ZW58MHx8fHwxNzAwNjg3MjM4fDA&amp;ixlib=rb-4.0.3&amp;q=80&amp;w=1000 1000w, https://images.unsplash.com/photo-1565635897404-6c9a6515cc91?crop=entropy&amp;cs=tinysrgb&amp;fit=max&amp;fm=jpg&amp;ixid=M3wxMTc3M3wwfDF8c2VhcmNofDJ8fExlYWZob3BwZXJ8ZW58MHx8fHwxNzAwNjg3MjM4fDA&amp;ixlib=rb-4.0.3&amp;q=80&amp;w=1600 1600w, https://images.unsplash.com/photo-1565635897404-6c9a6515cc91?crop=entropy&amp;cs=tinysrgb&amp;fit=max&amp;fm=jpg&amp;ixid=M3wxMTc3M3wwfDF8c2VhcmNofDJ8fExlYWZob3BwZXJ8ZW58MHx8fHwxNzAwNjg3MjM4fDA&amp;ixlib=rb-4.0.3&amp;q=80&amp;w=2400 2400w" sizes="(min-width: 720px) 720px"/><figcaption><span>Photo by </span><a href="https://unsplash.com/@mariuszdabrowski?ref=engineering.gusto.com"><span>Mariusz Dabrowski</span></a><span> / </span><a href="https://unsplash.com/?utm_source=ghost&amp;utm_medium=referral&amp;utm_campaign=api-credit"><span>Unsplash</span></a></figcaption></figure><h2 id="what-in-tarnation">What in tarnation?</h2><p>During one of my on-call rotations for our internal tools team, we got a report that Chrome was crashing for users of Gusto’s internal software. This was causing all sorts of interruptions to our normal customer service. Gusto employees in the middle of answering customer emails or phone calls might suddenly find themselves without visibility into customers’ accounts necessary to do their jobs.</p><figure><img src="https://lh7-us.googleusercontent.com/ExG_6KfMf8cUHrm9LmHDU2kBRAE_OMuKRAT7SO41Lp-kmih7BJ-kR9MNKHZwbo9qIqNgSRZ_52bRXbTKMlmeLv-TrMMUPMsOn2g-6YFjjdzA9MCcx9JtgZxt0eKFhc_133dVzHFJP36SIpGkQwTrIw" alt="Chrome browser showing crash error" loading="lazy" width="619" height="297"/><figcaption><span>Chrome tab crash</span></figcaption></figure><p>This was fairly far outside the usual scope of our on-call issues. Our team is generally well-insulated by other teams from issues like browser compatibility, so I didn’t know the first thing about browser debugging. Where would I even begin? I leaned on a more experienced teammate, our product infrastructure team, and our IT team. </p><h2 id="the-first-clues">The first clues </h2><p>We started by trying to find out what the affected users had in common.</p><p>We learned rather quickly that:</p><ul><li>Not all Gusto employee users were affected.</li><li>Our customer-facing software did not appear to be affected.</li><li>Other internal software webpages appeared to be fine.</li><li>Crashing did not occur consistently. Users who experienced it could reload the same page multiple times, and sometimes it would crash and sometimes it would not.</li><li>Not all of our internal pages crashed, but more than one of them did, including our most heavily-trafficked pages.</li><li>The issue was not occurring with Safari or Firefox.</li></ul><h3 id="hunch-1-a-bad-chrome-version">Hunch #1: A bad Chrome version</h3><p>Our first hunch was that maybe it was the Chrome version. We had one affected user update their Chrome version, and early signs looked promising that the issue was resolved. However, we soon learned that although installing the new Chrome version decreased the frequency of crashing, it didn’t eliminate the issue.</p><p>We added the following new clues to our list:</p><ul><li>The specific Chrome version had already been released for a while.</li><li>We had affected users on different versions of Chrome.</li><li>We had affected users and unaffected users on the same version of Chrome.</li><li>Upgrading/downgrading the Chrome version for affected users did not fix the issue.</li></ul><h3 id="hunch-2-a-bad-chrome-extension">Hunch #2: A bad Chrome extension</h3><p>Okay, maybe it was a Chrome extension? We thought the crashing stopped when one of our users disabled three core extensions. When we tried to reproduce the fix with a guest profile (without extensions present), we still saw crashing. Back to the drawing board, then.</p><h2 id="trouble-reproducing-the-bug">Trouble reproducing the bug</h2><p>Our Infrastructure team put out a call to all of engineering to ask if anyone could reproduce the issue. Frustratingly, although many of our customer service representatives were affected, none of our engineering teams reported any crashes at all except for two engineers in Turkey. With precious little overlap in available pairing time due to time zone differences, we slowly learned the following over several weeks:</p><ul><li> For security reasons, we do not have Chrome crash reporting enabled.</li><li>Checking out code from several weeks prior did not fix the issue, which indicated that the cause was not a recent change.</li><li>Loading a static html version of a crashing page did not cause crashing.</li><li>Using open-source Chromium instead of Chrome did not cause crashes, so we couldn’t see what Chrome code was failing either.</li><li>Several different internal applications were causing Chrome to crash, not just one.</li><li>Removing all of the page-specific content from the page did not fix the issue.</li><li>Disabling our in-house font did not fix the issue.</li></ul><p>As urgency waned because our users were using other browsers as a workaround, progress on this bug slowed to make way for other priorities. We didn’t have much left to go on without being able to reproduce the bug. However, we wanted to resolve it since users had bookmarks/settings/preferences in Chrome. We believed that we shouldn’t have to ask our users to avoid the world’s most popular browser, and we were also still getting periodic pings from various users asking whether we had made any progress on this bug.</p><h2 id="a-stroke-of-good-luck">A stroke of good luck</h2><p>One day out of the blue, one of our Denver engineers reported being newly affected. The only change she had made was downloading the Grammarly desktop app.</p><p>Wait, really? We had to see if we could reproduce the bug.</p><ul><li>I downloaded the Grammarly desktop app too. Instant reproduction of the issue (at last!).</li><li>I deleted Grammarly. The issue didn’t go away. I restarted my computer and the issue went away again.</li><li>I reinstalled Grammarly. Chrome started crashing again.</li></ul><p>We also confirmed with many of our affected users that they had Grammarly installed on their computers. Now we were cooking with fire!</p><h2 id="making-headway">Making headway</h2><p>With our ability to debug now greatly improved, we started making tedious headway: make a change, reload the page ten times or until it crashes.</p><p>Our main internal application is built on ActiveAdmin, but newer parts of it use React without the same ActiveAdmin framework as the rest of the application. The pages that are built in React did not crash. Hmm, so maybe our ActiveAdmin code was causing the crashes?</p><p>We learned earlier that removing all page-specific content did not fix the issue, so we started looking at parts of the code that were common to multiple pages, like the main navigation header and sidebar. Notably, our React pages do not use the same navigation header.</p><p>The code for our main navigation bar has a fair amount of metaprogramming, and chasing down threads here was often more confusing than not. We eventually figured out how to comment out pieces of the navigation bar, until we pinpointed one line that stopped crashing Chrome when it was commented out:</p><pre><code>dropdown &#39;My History&#39;, [], turbo: true, src: &#39;/navigation/my_history&#39;
</code></pre><p>This section is called “My History” and it differs from the rest of the main navigation in that instead of being more-or-less the same for all users, it is customized for each user, displaying the handful of pages that each user has visited most recently. We discovered that even when the page loaded successfully, hovering over the “My History” section could cause Chrome to immediately crash.</p><h3 id="hunch-3-turbo">Hunch #3: Turbo</h3><p>Then we looked at <code>turbo: true</code>. Could that be causing the issue? <a href="https://github.com/hotwired/turbo-rails?ref=engineering.gusto.com"><u>Turbo</u></a> is a gem we added to speed up our Rails application, but it turned out to be a red herring: it was only introduced after the bug had already been reported, and we learned that the engineer who introduced it had actually been experiencing these Chrome crashes for months prior to Turbo being introduced, and months prior to the bug being escalated to us.</p><p>Okay, so where was the dropdown being defined? We use a framework called <a href="https://activeadmin.github.io/arbre/?ref=engineering.gusto.com"><u>Arbre</u></a> to metaprogram html from this type of method. To navigate the internal plumbing, I turned to one of our engineers with deep Rails knowledge. In this case, the relevant code (once we finally found it) looked like this:</p><figure><pre><code>ul(class: &#39;dropdown-menu&#39;) do
  li(style: &#39;text-align: center;&#39;) { frontend_image_pack &#39;loaders/loader-spinner.gif&#39; } if has_spinner
  menu_items.each do |item|
    li(id: &#34;#{attributes[:id]}_#{item.id}&#34;) do
       text_node link_to item.name, item.url
     end
   end
 end</code></pre><figcaption><p><span>Rails code for drop down menu</span></p></figcaption></figure><p>This code generates html that looked something like this:</p><figure><pre><code>&lt;ul class=&#34;dropdown-menu&#34;&gt;
  &lt;li style=&#34;text-align: center;&#34;&gt;
    &lt;img src=&#34;/vite-dev/images/loaders/loader-spinner.gif&#34; /&gt;
  &lt;/li&gt;
  &lt;li id=&#34;recent_companies_123&#34;&gt;
    &lt;a href=&#34;/companies/123&#34;&gt;Totally Awesome Company A&lt;/a&gt;
  &lt;/li&gt;
  &lt;li id=&#34;recent_companies_124&#34;&gt;
    &lt;a href=&#34;/companies/124&#34;&gt;Even More Awesome Company B&lt;/a&gt;
  &lt;/li&gt;
&lt;/ul&gt;</code></pre><figcaption><p><span>HTML for drop down menu</span></p></figcaption></figure><p>We replaced the call to dropdown with the generated html, removing pieces of the new html until we zeroed in on the culprit.</p><p>When I removed <code>loader-spinner.gif</code>, the placeholder we display while the menu options load, the page stopped crashing. Eureka! It’s the gif! We swapped in a different gif and the page did not crash.</p><p>We downloaded the image file and dragged the file into the browser window. With Shakespearean melodrama, the page immediately crashed. My pair and I both audibly gasped.</p><p>We also found out that:</p><ul><li>Opening the file in Safari did not cause a crash.</li><li>After uninstalling Grammarly and restarting the computer, the gif loaded in Chrome without crashing.</li></ul><p>At this point, we notified our Design Systems team of the very peculiar fact that this gif was causing Chrome to crash, and they promptly replaced it with a new one. </p><figure><img src="https://engineering.gusto.com/content/images/2023/11/Screen-Shot-2022-08-04-at-9.42.49-AM--1-.png" alt="Pull request change for swapping the problem GIF" loading="lazy" width="2000" height="779" srcset="https://engineering.gusto.com/content/images/size/w600/2023/11/Screen-Shot-2022-08-04-at-9.42.49-AM--1-.png 600w, https://engineering.gusto.com/content/images/size/w1000/2023/11/Screen-Shot-2022-08-04-at-9.42.49-AM--1-.png 1000w, https://engineering.gusto.com/content/images/size/w1600/2023/11/Screen-Shot-2022-08-04-at-9.42.49-AM--1-.png 1600w, https://engineering.gusto.com/content/images/size/w2400/2023/11/Screen-Shot-2022-08-04-at-9.42.49-AM--1-.png 2400w" sizes="(min-width: 720px) 720px"/><figcaption><span>Pull request for swapping the problematic GIF</span></figcaption></figure><p>Why did this particular gif crash Chrome when Grammarly was installed? Unfortunately, with access to neither the Chrome source code nor the Grammarly source code, we can only guess. In the time since we replaced the gif, either Grammarly or Chrome or both have fixed this issue, because the original gif no longer causes Chrome to crash.</p><p>I would never, ever have guessed that the treasure at the end of the debugging rainbow was an animated gif. </p><p>Even though the priority of this bug changed over time as we found workarounds, relentless curiosity won out in the end. No single one of us had all of the necessary knowledge to solve this bug on their own, but with persistence and collaboration, we were able to figure it out together.</p><p>If you also enjoy collaborating with relentlessly curious people, <a href="http://www.gusto.com/careers?ref=engineering.gusto.com" rel="noreferrer">we are hiring</a>!</p><hr/><p>Hats off to the many people who collaborated to investigate and fix this issue: Iain McGinniss, Lucy Fox, Gregor MacDougall, Oguzhan Ince, Can Gençler, Daniel Flynn, Eric Nagy, Lijie Zhou, Harry Seeber, Nathaniel Strauss, and Steve Konves.</p></div>

                                                
                    </section>
                </div>
            </article>
        </div></div>
  </body>
</html>
