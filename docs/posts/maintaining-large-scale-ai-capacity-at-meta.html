<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://engineering.fb.com/2024/06/12/production-engineering/maintaining-large-scale-ai-capacity-meta/">Original</a>
    <h1>Maintaining large-scale AI capacity at Meta</h1>
    
    <div id="readability-page-1" class="page"><div>

		<p><span>Meta is currently operating many data centers with GPU training clusters across the world. Our data centers are the backbone of our operations, meticulously designed to support the scaling demands of compute and storage. A year ago, however, as the industry reached a critical inflection point due to the rise of artificial intelligence (AI), we recognized that to lead in the generative AI space we’d need to transform our fleet. </span></p>
<p><span>Our increased focus on AI was driven both by its rise in driving business outcomes and the huge growth in these types of workloads’ computational needs. In addition to wider use of traditional AI for things like ad targeting, we have also seen increasing numbers of large generative AI models that mimic almost-human intelligence in everything from human verbal interaction to the creation of pictures and other media. And these types of models are huge, with trillions of training parameters, and to train them we need vast resources. </span></p>
<p><span>In this process, we’ve built one of the </span><a href="https://engineering.fb.com/2024/03/12/data-center-engineering/building-metas-genai-infrastructure/"><span>world’s largest AI training infrastructures</span></a><span>, and it has been growing exponentially over the last years. Meta’s training infrastructure comprises dozens of AI clusters of varying sizes, with a plan to scale to 600,000 GPUs in the next year. It runs thousands of training jobs every day from hundreds of different Meta teams. Training jobs characteristics vary greatly too. They can be as small as a single GPU running for a couple minutes, while generative AI jobs can have trillions of parameters and often span thousands of hosts that need to work together and are very sensitive to interruptions. In addition to that, training jobs are tied much closer to the hardware, and that hardware varies greatly. Meta runs different types of backend networks, topologies, and training jobs that have tight dependencies between software and hardware components. </span></p>
<p><span>This transition has not been without its challenges. We had to reconfigure the fleet without disrupting our hypergrowth, a task akin to rebuilding an airplane mid-flight. This pushed us to innovate and collaborate with vendors and utility companies to create a supportive ecosystem. In this blog we will discuss only one of these transformations. We will describe how Meta is maintaining these training clusters and what sets us apart from the average AI environment. And what do we mean by maintaining? Basically, any kind of operation that updates or verifies software and firmware components in the clusters, including the networking path. </span></p>
<h2><span>The main characteristics of GPU training</span></h2>
<p><span>GPU training has some demanding characteristics:</span></p>
<ul>
<li aria-level="1"><b>Capacity guarantees</b><span>: While some training jobs can be paused, a lot of Meta jobs are time-critical</span> <span>and recurring or online. This means we cannot take large amounts of capacity on a default basis.</span></li>
<li aria-level="1"><b>Bad hosts are very bad</b><span>: Since many jobs require all hosts to be synchronized, bad hosts that are a bit slower, have some non-fatal hardware, or have networking issues are extremely damaging.</span></li>
<li aria-level="1"><b>Low interruption rate</b><span>: Since many hosts work with each other on a shared problem, AI training jobs are sensitive to interruptions. </span></li>
<li aria-level="1"><b>Rollout safety</b><span>: The AI software stack is deep, and problems are often hard to pinpoint, so we need to be careful when rolling out new components.</span></li>
<li aria-level="1"><b>Host consistency</b><span>: AI training jobs are in general cross-host, and while outside of the CUDA version there are rarely hard incompatibilities, we have learned that cluster consistency is highly important for debugging and SEV avoidance. </span></li>
</ul>
<h2><span>What’s special about Meta’s GPU training?</span></h2>
<p><span>Meta uses bespoke training hardware with the newest chips possible and high-performance backend networks that are highly speed optimized. We also try to stay as current and flexible as possible with the software stack; in the event of firmware upgrades, this allows us to utilize new features or reduce failure rates. </span></p>
<p><span>Together this means we have more than:</span></p>
<ul>
<li aria-level="1"><span>30 maintenance operations</span></li>
<li aria-level="1"><span>50 different components that are updated </span></li>
<li aria-level="1"><span>Three different host-verification tasks to ensure optimal performance and stability</span></li>
<li aria-level="1"><span>Thousands of disruptive AI host tasks every day </span></li>
</ul>
<p><span>And we need to do them safely, while guaranteeing capacity. After all, our training clusters are also used flexibly to run a wide variety of workloads, from single-host to some of the biggest training jobs in the world, and from offline tasks to jobs that need to be up and running 24/7.</span></p>
<figure id="attachment_21311" aria-describedby="caption-attachment-21311"><img decoding="async" src="https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-1.png?w=1024" alt="" width="1024" height="462" srcset="https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-1.png 1600w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-1.png?resize=916,413 916w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-1.png?resize=768,347 768w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-1.png?resize=1024,462 1024w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-1.png?resize=1536,693 1536w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-1.png?resize=96,43 96w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-1.png?resize=192,87 192w" sizes="(max-width: 992px) 100vw, 62vw"/><figcaption id="caption-attachment-21311">An overview of different maintenance rollouts happening on Meta capacity over time with overlapping durations.</figcaption></figure>
<p><span>Given the variety of upgrades, we have a large amount of overlapping inflight changes at any given time, including some that are consistently being applied, such as verification tasks. Accepting this gives Meta the flexibility we need in using cutting-edge hardware, scaling our infrastructure, and using both in flexible ways. In smaller environments it is often possible to keep clusters in a consistent state and upgrade the whole cluster and all of its firmware and software components in the same maintenance window. Doing this in a large, diverse environment like Meta, however, would introduce big risks and be operationally infeasible. Instead, we ensure components are compatible with each other and roll component upgrades up in a sliding fashion. This approach also allows us to guarantee capacity availability. </span></p>
<h2><span>Maintenance trains</span></h2>
<figure id="attachment_21312" aria-describedby="caption-attachment-21312"><img decoding="async" src="https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-2.jpg?w=1024" alt="" width="1024" height="295" srcset="https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-2.jpg 1999w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-2.jpg?resize=916,264 916w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-2.jpg?resize=768,221 768w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-2.jpg?resize=1024,295 1024w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-2.jpg?resize=1536,443 1536w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-2.jpg?resize=96,28 96w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-2.jpg?resize=192,55 192w" sizes="(max-width: 992px) 100vw, 62vw"/><figcaption id="caption-attachment-21312">Meta maintains capacity by using maintenance trains, which involves shutting down small amounts of capacity in a cyclic fashion.</figcaption></figure>
<p><span>Outside of special cases, Meta maintains its fleet of clusters using a technique called maintenance trains. This is used for all capacity, including compute and storage capacity. A small number of servers are taken out of production and maintained with all applicable upgrades. Trains provide the guarantee that all capacity minus one maintenance domain is up and running 24/7, thus providing capacity predictability. This is mandatory for all capacity that is used for online and recurring training.</span></p>
<p><span>Maintenance trains pick up any new upgrade and guarantee a full-visit cycle in a guaranteed timeframe. Longer-running upgrades can have lower rollout guarantees and may be scheduled to be applied in multiple cycles. So you can have many overlapping upgrades, and, if beneficial, upgrades can be aligned. </span></p>
<p><span>For AI capacity, we have optimized domains that allow for different kinds of AI capacity, very strict SLOs, and a contract with services that allows them to avoid maintenance-train interruptions, if possible. </span></p>
<h2><span>Gradual rollouts</span></h2>
<figure id="attachment_21313" aria-describedby="caption-attachment-21313"><img loading="lazy" decoding="async" src="https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-3.jpg?w=571" alt="" width="195" height="350" srcset="https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-3.jpg 992w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-3.jpg?resize=511,916 511w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-3.jpg?resize=768,1377 768w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-3.jpg?resize=571,1024 571w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-3.jpg?resize=857,1536 857w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-3.jpg?resize=96,172 96w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-3.jpg?resize=192,344 192w" sizes="(max-width: 992px) 100vw, 62vw"/><figcaption id="caption-attachment-21313">An illustration of the distinction between higher-level components of the AI stack—such as the CUDA drivers, and the lower-level components involved in the training job,.</figcaption></figure>
<p><span>Because of the scale of our infrastructure, we had to ensure that all disruptive rollouts outside of special cases happen in a gradual fashion. This means different servers in a cluster can run a different host stack for a short period of time. This is quite normal in traditional capacity but challenging in AI training, since AI jobs are very closely tied to the hardware. </span></p>
<p><span>At Meta, we’ve ensured that jobs have a consistent stack but upgrade lower-level components in a gradual fashion. In contrast to this, the AI job itself, which includes the CUDA library, is always consistent. </span><span>This distinction is necessary because lower-level components often require hours to install and configure or require rebooting the host, while higher-level components in the job container itself can be restarted fluidly. </span></p>
<p><span>This sounds simple, but because of the tight integration of AI with hardware, we have needed to do a lot of development, including careful testing on all lower levels, special monitoring, and tight work with vendors. </span></p>
<p><span>By and large, this has been very successful. The AI stack in general has matured a lot over the past three years. We also added tooling for rare compatibility-breaking upgrades. </span></p>

<h2><span>Selecting the correct maintenance domains </span></h2>
<figure id="attachment_21314" aria-describedby="caption-attachment-21314"><img loading="lazy" decoding="async" src="https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-4.jpg?w=916" alt="" width="916" height="623" srcset="https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-4.jpg 1950w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-4.jpg?resize=916,623 916w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-4.jpg?resize=768,522 768w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-4.jpg?resize=1024,696 1024w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-4.jpg?resize=1536,1044 1536w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-4.jpg?resize=96,65 96w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-4.jpg?resize=192,131 192w" sizes="(max-width: 992px) 100vw, 62vw"/><figcaption id="caption-attachment-21314">Maintenance domains are selected based on the amount of buffer-reserved capacity (the smaller the better) and the amount of interruptions we cause to training jobs (the bigger the better).</figcaption></figure>
<p><span>One way to ensure optimal AI performance was to work with AI teams to design the optimal size of maintenance domains. A maintenance domain is the percentage of capacity we take down in one go, and selecting the optimal size is a function of both the cost of interruptions and the capacity that is lost during the maintenance duration. Since interruption costs are high for AI jobs, optimizing this relationship allowed us to significantly reduce the maintenance overhead for AI capacity.</span></p>
<h2><span>OpsPlanner: Meta disruptive-work orchestrator</span></h2>
<p><span>Critical to AI capacity are the consistency requirements. For example, if you want to move to a new CUDA version, you may need all of the capacity on a new driver version. This becomes really difficult in an environment with thousands of hosts and lots of planned and unplanned operations that may overlap with each other. To do this safely and guarantee hosts have the correct upgrades applied before entering production, Meta has unified them in the OpsPlanner work orchestrator. Not only can it work on overlapping scopes of operations and correctly serialize them, it also takes them safely out and into production. In addition, it has a built-in handover flow that ensures correct escalation behavior and avoids overlaps and deadlocks. OpsPlanner can also ensure upgrades are applied to hosts before they are returned to production. And OpsPlanner owns planned maintenance and failure buffers and safeguards them. Furthermore, it’s highly effective and efficient: OpsPlanner currently handles a million operations per day. </span></p>
<figure id="attachment_21315" aria-describedby="caption-attachment-21315"><img loading="lazy" decoding="async" src="https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-5.jpg?w=1024" alt="" width="1024" height="495" srcset="https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-5.jpg 1768w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-5.jpg?resize=916,442 916w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-5.jpg?resize=768,371 768w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-5.jpg?resize=1024,495 1024w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-5.jpg?resize=1536,742 1536w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-5.jpg?resize=96,46 96w, https://engineering.fb.com/wp-content/uploads/2024/06/Systems@scale_AI-Maintence_image-5.jpg?resize=192,93 192w" sizes="(max-width: 992px) 100vw, 62vw"/><figcaption id="caption-attachment-21315">Example scenarios illustrating the disruptive work scheduler the OpsPlanner needs to handle to ensure host consistency.</figcaption></figure>
<h2><span>Safety and failure scenarios </span></h2>
<p><span>Meta has a deep stack of safety features that includes:</span><span><br/>
</span></p>
<ul>
<li aria-level="1"><span>Autostop of maintenance trains if maintenance or failure buffers are exhausted;</span></li>
<li aria-level="1"><span>Automatic offboarding of failing upgrades; and</span></li>
<li aria-level="1"><span>Rollout phases for upgrades, so that only well-tested changes reach global systems.</span></li>
</ul>
<p><span>If something does go wrong, however, we can react quickly, depending on the needed fix, with emergency trains, large-scale maintenance for breaking upgrades, and more.</span></p>
<h2><span>Rapidly moving to the future of generative AI</span></h2>
<p><span>At Meta, we believe in moving fast and learning by doing. Rapid innovation is in our ethos. This is what fundamentally shaped our journey as we continually innovated towards building the foundational infrastructure that makes us leaders in generative AI. We will remain dedicated to creating technologies that not only benefit Meta but also have a positive impact on society as a whole. </span></p>
<p><span>As we move forward, we invite you to join us on this journey. Together, we can shape a future where AI is not just a tool but a force for good, transforming industries, empowering individuals, and creating a more sustainable world.</span></p>
<p><span>The best is yet to come, and we are excited to pioneer tomorrow’s possibilities in generative AI.</span></p>

		
	</div></div>
  </body>
</html>
