<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://sqlite.org/wasm/doc/tip/about.md">Original</a>
    <h1>SQLite in the browser with WASM/JS</h1>
    
    <div id="readability-page-1" class="page"><div>

<p><a href="https://webassembly.org">WebAssembly</a>, a.k.a. WASM, is a standard defining a low-level
programming language suitable (A) as a target for cross-compilation
from many other languages and (B) for running via a virtual machine in
a browser. Designed with scriptability via JavaScript in mind, it
provides a way to compile C code (among others) to WASM and script it
via JavaScript with relatively little friction despite the vast
differences between JavaScript and C.</p>

<p>Folks have been building <a href="https://sqlite.org">sqlite3</a> for WASM since at least
as far back at 2019, but this subproject is the first effort
&#34;officially&#34; associated with the SQLite project, created with the goal
of making WASM builds of the library first-class members of the family
of supported SQLite deliverables.</p>

<h2>Specific Goals of this Project</h2>
<p>The concrete goals of this project include...</p>

<ul>
<li><p>Except where noted in the non-goals, provide a more-or-less
feature-complete wrapper to the sqlite3 C API, insofar as WASM
feature parity with C allows for. In fact, provide <a href="https://sqlite.org/wasm/doc/tip/api-index.md">at least
the following APIs</a>...</p>

<ol>
<li>Bind a <strong><a href="https://sqlite.org/wasm/doc/tip/api-c-style.md">low-level sqlite3 API</a></strong> which is as
close to the native one as feasible in terms of usage.</li>
<li>A <strong><a href="https://sqlite.org/wasm/doc/tip/api-oo1.md">higher-level OO API</a></strong>, more akin to sql.js
and node.js-style implementations. This one speaks directly to
the low-level API. This API must be used from the same thread as
the low-level API.</li>
<li>A <strong><a href="https://sqlite.org/wasm/doc/tip/api-worker1.md">Worker-based API</a></strong> which speaks to the
previous APIs via Worker messages. This one is intended for use
in the main thread, with the lower-level APIs installed in a
Worker thread, and talking to them via Worker messages. Because
Workers are asynchronous and have only a single message channel,
some acrobatics are needed here to feed async work results back
to the client (as we cannot simply pass around callbacks between
the main and Worker threads).</li>
<li>A <strong><a href="https://sqlite.org/wasm/doc/tip/api-worker1.md">Promise-based variant of the Worker API</a></strong>
(#3, above) which entirely hides the cross-thread communication
aspects from the user.</li>
</ol></li>
<li><p>Insofar as possible, support <strong>persistent client-side storage</strong>
using available JS APIs. As of this writing, that includes the
<a href="https://sqlite.org/wasm/doc/tip/persistence.md#opfs">Origin-Private FileSystem (OPFS)</a> and (very limited) storage via
the <code>window.localStorage</code> and <code>window.sessionStorage</code> backends.</p></li>
</ul>

<h2>Specific Non-goals</h2>
<p>Things we specifically do <em>not</em> aim to achieve:</p>

<ul>
<li><p>As WASM is a web-centric technology and UTF-8 is the King of
Encodings in that realm, there are <strong>no current plans to support the
UTF16-related sqlite3 APIs</strong>. They would add a complication to the
bindings for no appreciable benefit.</p></li>
<li><p>Though support for out-of-browser WASM runtimes is widespread, this
project is currently (late 2022) <strong>focused only on browser
targets</strong>. Though web-related implementation details take priority,
and the JavaScript components of the API specifically focus on
browser clients, the lower-level WASM module &#34;should&#34; work in
non-web WASM environments.</p></li>
<li><p>Supporting old or niche-market platforms. WASM is <strong>built for a
modern web and requires modern platforms</strong>. Similarly, sqlite3 library
options which have been deprecated will be removed
entirely from the WASM interface.</p></li>
</ul>


<p>Several projects have helped us considerably along the way. We are
greatly indebted to (in the order we investigated them)...</p>

<h2>Emscripten</h2>
<p><a href="https://emscripten.org">https://emscripten.org</a></p>

<p>The Emscripten WASM toolchain is, as of this writing, the only
full-featured WASM toolchain available. Though other toolchains exist,
Emscripten offers several &#34;killer features&#34; which others do not, most
notably transparent emulation of POSIX file I/O APIs, which allows
sqlite3 to function as-is in a WASM build, with no changes or tweaking
necessary.</p>

<p>Additionally, Emscripten developers directly offered invaluable
support during the development of <a href="https://sqlite.org/wasm/doc/tip/persistence.md#opfs">the OPFS-based features</a>.</p>

<h2>sql.js</h2>
<p><a href="https://github.com/sql-js/sql.js">https://github.com/sql-js/sql.js</a></p>

<p>sql.js was an essential stepping stone in this code&#39;s development as
it demonstrates how to handle some of the WASM-related voodoo (like
handling pointers-to-pointers and adding JS implementations of
C-bound callback functions). These APIs have a considerably
different shape than sql.js&#39;s, however.</p>

<h2>absurd-sql</h2>
<p><a href="https://github.com/jlongster/absurd-sql">https://github.com/jlongster/absurd-sql</a></p>

<p>The aptly-named absurd-sql demonstrates persistent browser-side
sqlite3 by storing the databases in IndexedDB storage. We experimented
with that approach but it&#39;s... well, <em>absurd</em> ðŸ˜‰. It&#39;s too slow for
anything beyond trivial databases and it&#39;s easy to get a database in
an inconsistent state by visiting the page from two tabs.</p>

<p>Even so, it was an interesting experiment.</p>

<h2>wa-sqlite</h2>
<p><a href="https://github.com/rhashimoto/wa-sqlite">https://github.com/rhashimoto/wa-sqlite</a></p>

<p>It is likely that wa-sqlite was the first project to provide an OPFS
storage option for sqlite3. It also provides a full demonstration of
how to use the otherwise largely undocumented <a href="https://sqlite.org/wasm/doc/tip/persistence.md#opfs">OPFS</a> APIs.</p>

</div></div>
  </body>
</html>
