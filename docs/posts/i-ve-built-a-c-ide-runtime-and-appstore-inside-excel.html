<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://querystorm.com/csharp-in-excel/">Original</a>
    <h1>Show HN: I&#39;ve built a C# IDE, Runtime, and AppStore inside Excel</h1>
    
    <div id="readability-page-1" class="page"><div>
      <div>
        <div>
          
<h2>Replacing VBA with C#?</h2>



<p>I spend a fair amount of time writing code in C#, which I enjoy. I occasionally wish I could use C# inside other applications.</p>



<p>One application where I think C# would fit right in is Excel, as a replacement for VBA. VBA is a bit (a lot) behind the times and Microsoft isn’t planning on upgrading it. Instead, they’re offering a sandboxed JavaScript environment called Office Scripts. </p>



<p>I see the appeal of JavaScript for the web version of Excel, but a good replacement for VBA, it is not.</p>



<p>Since Microsoft won’t be doing it, I figured I might have a crack at it. After all, with Microsoft committed to JavaScript, it’s unlikely they will muscle me out of the lucrative C# in Excel market.</p>



<p>So here’s what I came up with:</p>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://www.querystorm.com/docs2/images/cs_querying.gif" data-img-id="0" data-nonce="acb568d494"><img src="https://www.querystorm.com/docs2/images/cs_querying.gif" alt="QueryStorm IDE running a LINQ query over an Excel table"/><figcaption>QueryStorm IDE running a LINQ query over an Excel table</figcaption></figure>



<p>“Is that a C# IDE running LINQ queries over Excel tables?” Yep, that’s exactly what it is.</p>



<p>I call it QueryStorm. I started <a href="https://querystorm.com/i-wandered-off-and-built-an-ide/">working on it way back in 2014</a>. It originally had just <a href="https://querystorm.com/how-to-use-sql-in-excel/">SQL support</a>, and I’ve continued working on it ever since, gradually adding support for C# scripting, custom C#/Excel functions, NuGet support, a debugger, and even an app store!</p>



<p>Let me give you a tour.</p>



<h2>The QueryStorm IDE</h2>



<p>QueryStorm uses AvalonEdit as its code editor. AvalonEdit is a fancy textbox that can show text with rich formatting, but it doesn’t know anything about the C# language and its syntax. It needs to be told where symbols and errors are located in the text (so it can highlight them), which autocomplete options to offer, etc.</p>



<p>To understand the user’s C# code, QueryStorm uses Microsoft’s C# compiler, aka Roslyn. </p>



<p>Roslyn is a .NET library rather than a separate program. Aside from being able to compile C# code into a dll, Roslyn can tell you all about any C# code you give it. </p>



<p>For example, if you give it some C# code, it can tell you where any errors might be, where each symbol is defined and referenced, what each symbol means, and what auto-complete options to offer at a particular location in code.</p>



<p>Most of the functionality that Roslyn offers is surfaced in the QueryStorm IDE, which enables features such as:</p>



<ul><li>Syntax and error highlighting</li><li>Code completion</li><li>Code fixes and formatting</li><li><a href="https://www.querystorm.com/docs2/ide/code_editor/">…and many others</a></li></ul>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://www.querystorm.com/docs2/images/ide_code_completion.gif" data-img-id="0" data-nonce="acb568d494"><img src="https://www.querystorm.com/docs2/images/ide_code_completion.gif" alt="Writing C# code in QueryStorm"/><figcaption>Writing C# code in QueryStorm</figcaption></figure>



<p>These features make for a productive and enjoyable code editing experience. It might not be exactly on par with Visual Studio or Rider but it certainly beats the pants off of the VBA IDE.</p>



<h2>C# scripting in Excel</h2>



<p>The simplest way to explore C# in Excel is to start a C# script which you can do by clicking the “C#” button in the ribbon.</p>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/image.png" data-img-id="1876" data-nonce="bf35087372"><img loading="lazy" width="944" height="287" src="https://querystorm.com/wp-content/uploads/2023/01/image.png" alt="Starting a new C# script in Excel" srcset="https://querystorm.com/wp-content/uploads/2023/01/image.png 944w, https://querystorm.com/wp-content/uploads/2023/01/image-300x91.png 300w, https://querystorm.com/wp-content/uploads/2023/01/image-768x233.png 768w" sizes="(max-width: 944px) 100vw, 944px"/><figcaption>Creating a new C# script</figcaption></figure>



<p>The scripting flavor of C# allows executing snippets of code and evaluating expressions without all the ceremony of defining namespaces, classes, and a <em><code>static void Main()</code></em> method.</p>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/image-3-1024x337.png" data-img-id="1879" data-nonce="05ef946a22"><img loading="lazy" width="1024" height="337" src="https://querystorm.com/wp-content/uploads/2023/01/image-3-1024x337.png" alt="Example C# expression and its result" srcset="https://querystorm.com/wp-content/uploads/2023/01/image-3-1024x337.png 1024w, https://querystorm.com/wp-content/uploads/2023/01/image-3-300x99.png 300w, https://querystorm.com/wp-content/uploads/2023/01/image-3-768x253.png 768w, https://querystorm.com/wp-content/uploads/2023/01/image-3.png 1268w" sizes="(max-width: 1024px) 100vw, 1024px"/><figcaption>Example C# expression and its result</figcaption></figure>



<p>You can run the script by pressing F5 on the keyboard or clicking the “Run” button in the ribbon.</p>



<p>If the script returns a value explicitly (uses the <code>return</code> keyword), or implicitly (ends with an expression that isn’t terminated by a semi-colon), the result will be displayed in the results grid upon execution.</p>



<p>You can use this scripting functionality as a C# scratchpad (like LinqPad), but the added value is the interaction with the workbook and Excel. This way, we get the benefits of C# and .NET on top of Excel’s native functionality.</p>



<p>Scripts can get a reference to the Excel <code>Application</code> object or the <code>Workbook</code> object using the <code>Resolve&lt;&gt;</code> method. </p>



<p>For example, we can write a script to create a new Excel table with a list of files contained in a particular folder:</p>



<pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">using System.IO;
using Microsoft.Office.Interop.Excel;

// get some data
var appDataFolder = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData);
var files = Directory
	.GetFiles(appDataFolder, &#34;*&#34;, SearchOption.AllDirectories)
	.Take(1000)
	.Select(f =&gt; 
		new {
			File= Path.GetFileName(f),
			Size= new FileInfo(f).Length
		});

// write to Excel as a new table
Resolve&lt;IExcelAccessor&gt;().Run(excel =&gt; 
{
	(excel.Selection as Range).WriteTable(files, &#34;myNewTable&#34;);
});</pre>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/CS_Script_WriteNewTable.gif" data-img-id="1880" data-nonce="48883c70ee"><img loading="lazy" width="1415" height="779" src="https://querystorm.com/wp-content/uploads/2023/01/CS_Script_WriteNewTable.gif" alt="Writing a List&lt;T&gt; instance as new Excel table"/><figcaption>Writing a List&lt;T&gt; instance as new Excel table</figcaption></figure>



<p>The Excel API available to the user is the same as in VBA, so anything you can do with VBA, you can do with C#.</p>



<p>In addition, a set of handy extension methods is also available, like the <code>WriteTable()</code> method shown in the example above.</p>



<h2>Linq to Excel tables</h2>



<p>Rather than focusing on Excel concepts like cells and sheets, though, a more interesting thing to focus on is the data. In QueryStorm’s C# scripts, <strong>each Excel table shows up as a strongly typed collection</strong> we can query and update.</p>



<p>For example, suppose we have a table containing a list of cities. For each city, we have its name, population, and the country it belongs to. To find the 3 most populous cities in each country, we could run the following LINQ query:</p>



<pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">cities.GroupBy(x =&gt; x.country)
	.SelectMany(g =&gt; g.OrderByDescending(x =&gt; x.population).Take(3))
	.OrderBy(x =&gt; x.country).ThenBy(x =&gt; x.population)
	.Select(x =&gt; new { x.city, x.country, x.population })</pre>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/image-17.png" data-img-id="1895" data-nonce="869349450b"><img loading="lazy" width="2217" height="1325" src="https://querystorm.com/wp-content/uploads/2023/01/image-17.png" alt="Example LINQ query over Excel table" srcset="https://querystorm.com/wp-content/uploads/2023/01/image-17.png 2217w, https://querystorm.com/wp-content/uploads/2023/01/image-17-300x179.png 300w, https://querystorm.com/wp-content/uploads/2023/01/image-17-1024x612.png 1024w, https://querystorm.com/wp-content/uploads/2023/01/image-17-768x459.png 768w, https://querystorm.com/wp-content/uploads/2023/01/image-17-1536x918.png 1536w, https://querystorm.com/wp-content/uploads/2023/01/image-17-2048x1224.png 2048w" sizes="(max-width: 2217px) 100vw, 2217px"/><figcaption>Example LINQ query over Excel table</figcaption></figure>



<h3>ORM for Excel Tables</h3>



<p>Notice that column names show up in auto-complete, meaning that somewhere there is a strongly typed class that represents the rows of the table.</p>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/image-15.png" data-img-id="1893" data-nonce="9c8daca236"><img loading="lazy" width="1725" height="745" src="https://querystorm.com/wp-content/uploads/2023/01/image-15.png" alt="Rows have strongly typed properties that correspond to table columns" srcset="https://querystorm.com/wp-content/uploads/2023/01/image-15.png 1725w, https://querystorm.com/wp-content/uploads/2023/01/image-15-300x130.png 300w, https://querystorm.com/wp-content/uploads/2023/01/image-15-1024x442.png 1024w, https://querystorm.com/wp-content/uploads/2023/01/image-15-768x332.png 768w, https://querystorm.com/wp-content/uploads/2023/01/image-15-1536x663.png 1536w" sizes="(max-width: 1725px) 100vw, 1725px"/><figcaption>Rows have strongly typed properties that correspond to table columns</figcaption></figure>



<p>Where does this class come from? The answer is – it’s generated automatically by QueryStorm (using <code>Reflection.Emit</code>). </p>



<p>The generated class lives inside a dll which the script automatically references. Each time the user changes a table, QueryStorm will examine the change and, if needed, update the generated types.</p>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/image-16.png" data-img-id="1894" data-nonce="bf1edfa3f9"><img loading="lazy" width="715" height="637" src="https://querystorm.com/wp-content/uploads/2023/01/image-16.png" alt="Dynamically generated dll with types for accessing data in Excel tables" srcset="https://querystorm.com/wp-content/uploads/2023/01/image-16.png 715w, https://querystorm.com/wp-content/uploads/2023/01/image-16-300x267.png 300w" sizes="(max-width: 715px) 100vw, 715px"/><figcaption>Dynamically generated dll with types for accessing data in Excel tables</figcaption></figure>



<p>This functions as an ORM layer on top of Excel tables. For a proper ORM, though, we’d need to be able to specify column data types and table relationships.</p>



<p>By default, QueryStorm will guess the data type for each table column based on the data it contains, and it will not assume any relationships between tables.</p>



<p>However, <a href="https://querystorm.com/docs2/data_contexts/workbook_data_context/">defining a custom data context</a> allows us to specify column types and table relationships. Adding relationships between tables will cause extra navigation properties to be added to the generated types.</p>



<p>For example, let’s assume we have a “cities” table and a “countries” table. We could modify the column types and add table relationships using the following data context class:</p>



<pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">public class WorkbookDataContext1 : WorkbookDataContext 
{
	public WorkbookDataContext1(IWorkbookAccessor workbookAccessor, ISyncRunner syncRunner)
		: base(workbookAccessor, syncRunner, false)
	{
	}

	// Set up column data types
	protected override void Configure(ITablesConfiguration config)
	{
		config.ConfigureTable(&#34;countries&#34;, tableView =&gt; {
			tableView
				.ConfigureColumn&lt;System.String&gt;(&#34;Name&#34;)
				.ConfigureColumn&lt;System.Int32&gt;(&#34;Population (2020)&#34;);
		});

		config.ConfigureTable(&#34;cities&#34;, tableView =&gt; {
			tableView
				.ConfigureColumn&lt;System.String&gt;(&#34;city&#34;)
				.ConfigureColumn&lt;System.Int32?&gt;(&#34;population&#34;);
		});
	}

	// Set up relationships
	protected override IEnumerable&lt;RelationInfo&gt; CreateRelationships()
	{
		// city.Country relationship (each city to 1 country)
		yield return new RelationInfo(&#34;cities&#34;, &#34;countryName&#34;, To.One, &#34;countries&#34;, &#34;Name&#34;, &#34;Country&#34;);
	
		// country.Cities relationship (each country to N cities)
		yield return new RelationInfo(&#34;countries&#34;, &#34;Name&#34;, To.Many, &#34;cities&#34;, &#34;countryName&#34;, &#34;Cities&#34;);
	}
}
</pre>



<p>Once the data context is updated, we can see the new navigation properties in our C# scripts. </p>



<p>For example, let’s try to find how much of a country’s population each city accounts for. Since rows in the “cities” table now have a navigation property that allows us to fetch the corresponding country, this is an easy task:</p>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/image-19.png" data-img-id="1897" data-nonce="4bb24d3206"><img loading="lazy" width="2217" height="1325" src="https://querystorm.com/wp-content/uploads/2023/01/image-19.png" alt="The custom data context changes the strongly typed classes that represent table rows" srcset="https://querystorm.com/wp-content/uploads/2023/01/image-19.png 2217w, https://querystorm.com/wp-content/uploads/2023/01/image-19-300x179.png 300w, https://querystorm.com/wp-content/uploads/2023/01/image-19-1024x612.png 1024w, https://querystorm.com/wp-content/uploads/2023/01/image-19-768x459.png 768w, https://querystorm.com/wp-content/uploads/2023/01/image-19-1536x918.png 1536w, https://querystorm.com/wp-content/uploads/2023/01/image-19-2048x1224.png 2048w" sizes="(max-width: 2217px) 100vw, 2217px"/><figcaption>The custom data context changes the strongly typed classes that represent table rows</figcaption></figure>



<p>As we specified in the data context definition, the population properties are now of type “int?” and <em>cities</em> now have a navigation property “<em>Country</em>” that makes it easy to navigate to the corresponding row in the <em>countries</em> table.</p>



<h3>Updating Excel tables</h3>



<p>We aren’t limited to just querying the data in Excel tables. We can also perform updates on Excel tables.</p>



<p>For example, let’s add a new column in the <em>cities</em> table for the share of the country’s population that the city accounts for. First, we must add the column manually in Excel, and then update it through the C# script.</p>



<pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">cities.ForEach(c =&gt;
{
	int? cityPopulation = c.population;
	int? countryPopulation = c.Country?.Population__2020_;

	var shareOfCountrysPopulation = 
		1.0 * cityPopulation/ countryPopulation;
	
	c.share_of_country_s_popupation = 
        	$&#34;{100.0 * shareOfCountrysPopulation:0.00}%&#34;;
})</pre>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/image-20-1024x612.png" data-img-id="1898" data-nonce="051a4360fb"><img loading="lazy" width="1024" height="612" src="https://querystorm.com/wp-content/uploads/2023/01/image-20-1024x612.png" alt="Updating the contents of an Excel table&#39;s column using C# LINQ" srcset="https://querystorm.com/wp-content/uploads/2023/01/image-20-1024x612.png 1024w, https://querystorm.com/wp-content/uploads/2023/01/image-20-300x179.png 300w, https://querystorm.com/wp-content/uploads/2023/01/image-20-768x459.png 768w, https://querystorm.com/wp-content/uploads/2023/01/image-20-1536x918.png 1536w, https://querystorm.com/wp-content/uploads/2023/01/image-20-2048x1224.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/><figcaption>Updating the contents of an Excel table’s column using C# LINQ</figcaption></figure>



<h3>Formatting table rows</h3>



<p>Lastly, we can update row formatting using the Format() extension method available on IEnumerable objects.</p>



<p>For example, let’s highlight all cities that account for more than 20% of the population of their country.</p>



<pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">cities.Where(c =&gt; c.share_of_country_s_popupation &gt; 0.2)
	.Format(r =&gt; r.Interior.ColorIndex = 35);</pre>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/image-21.png" data-img-id="1899" data-nonce="a38f607290"><img loading="lazy" width="2217" height="1325" src="https://querystorm.com/wp-content/uploads/2023/01/image-21.png" alt="Set Excel table row formatting using C#" srcset="https://querystorm.com/wp-content/uploads/2023/01/image-21.png 2217w, https://querystorm.com/wp-content/uploads/2023/01/image-21-300x179.png 300w, https://querystorm.com/wp-content/uploads/2023/01/image-21-1024x612.png 1024w, https://querystorm.com/wp-content/uploads/2023/01/image-21-768x459.png 768w, https://querystorm.com/wp-content/uploads/2023/01/image-21-1536x918.png 1536w, https://querystorm.com/wp-content/uploads/2023/01/image-21-2048x1224.png 2048w" sizes="(max-width: 2217px) 100vw, 2217px"/><figcaption>Updating Excel table row formatting using C#</figcaption></figure>



<h3>Performance</h3>



<p>The data from Excel tables is internally cached, so reading performance is about the same as working with lists of objects in memory, i.e., very fast.</p>



<p>Reading data from large tables, even ones with hundreds of thousands of rows takes just a few milliseconds (except for the first read that populates the cache and can take a few seconds for huge tables).</p>



<p>Formatting, though slower than reading, is also highly optimized and has a processing rate of about 1k rows per second.</p>



<h2>Extending Excel functionality with C#</h2>



<p>Scripts are mainly used for running one-off queries against data in tables. But we can also use C# to add permanent functionality to Excel itself! We can even publish our extensions to allow other people to use them.</p>



<p>We can extend Excel with the following kinds of elements:</p>



<ul><li>Custom Excel functions</li><li>New context menus</li><li>New ribbon tabs and controls</li><li>Keyboard shortcuts</li></ul>



<h3>Custom Excel functions with C#</h3>



<p>In VBA, we can easily define custom functions for use in Excel formulas. In QueryStorm, it’s just as easy (but more powerful).</p>



<p>To define one or more custom Excel functions, we need to create a project in QueryStorm, write the C# function, decorate it with the [ExcelFunction] attribute, and build the project. At that point, the function will be available for use in Excel.</p>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/image-12-1024x542.png" data-img-id="1890" data-nonce="8c06f4d42c"><img loading="lazy" width="1024" height="542" src="https://querystorm.com/wp-content/uploads/2023/01/image-12-1024x542.png" alt="Creating and using a C# function in Excel formulas" srcset="https://querystorm.com/wp-content/uploads/2023/01/image-12-1024x542.png 1024w, https://querystorm.com/wp-content/uploads/2023/01/image-12-300x159.png 300w, https://querystorm.com/wp-content/uploads/2023/01/image-12-768x406.png 768w, https://querystorm.com/wp-content/uploads/2023/01/image-12-1536x813.png 1536w, https://querystorm.com/wp-content/uploads/2023/01/image-12.png 1599w" sizes="(max-width: 1024px) 100vw, 1024px"/><figcaption>Creating and using a C# function in Excel formulas</figcaption></figure>



<p>For example, let’s create a function called “<em>IsMatch</em>” which will tell us if an input string matches a regular expression pattern:</p>



<pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">using System;
using System.ComponentModel;
using System.Text.RegularExpressions;
using QueryStorm.Apps;
 
namespace DemoProject;

public class ExcelFunctions1
{
	[ExcelFunction(Description=&#34;check if input matches rx pattern&#34;)]
	public static bool IsMatch(string inputText, string regexPattern)
		=&gt; Regex.IsMatch(inputText, regexPattern);
}</pre>



<p>Here’s what the new function looks like in Excel:</p>



<figure><img loading="lazy" width="486" height="514" src="https://querystorm.com/wp-content/uploads/2023/01/image-10.png" alt="Validating IP addresses using the new IsMatch method created using Regex" srcset="https://querystorm.com/wp-content/uploads/2023/01/image-10.png 486w, https://querystorm.com/wp-content/uploads/2023/01/image-10-284x300.png 284w" sizes="(max-width: 486px) 100vw, 486px"/><figcaption>Validating IP addresses using the new <em>IsMatch</em> method created using Regex</figcaption></figure>



<p>The .NET base class library contains all sorts of functionality which might be useful in Excel (like regular expressions), and this is an easy way to make it available in Excel.</p>



<p>And, as we’ll see later on, we can also use NuGet packages in our extensions.</p>



<p>C# functions exposed as Excel functions can:</p>



<ul><li>be synchronous or <a href="https://querystorm.com/docs2/apps_dotnet/defining_functions/#async-functions">asynchronous</a></li><li>return one value or an <a href="https://querystorm.com/docs2/apps_dotnet/defining_functions/#table-valued-results">array of values</a> that spills across a range of cells</li><li>return a single value or a <a href="https://querystorm.com/docs2/apps_dotnet/defining_functions/#streaming-functions">stream of values</a> that change over time (e.g. stock prices)</li></ul>



<p>See the documentation for more details on <a href="https://querystorm.com/docs2/apps_dotnet/defining_functions/">defining Excel functions</a> with C#.</p>



<h3>Adding custom commands to Excel</h3>



<p>Aside from custom functions, we can also extend Excel with custom ribbon commands, context menus, and keyboard shortcuts.</p>



<p>For example, suppose we want to add a custom context menu command for converting the texts in selected cells to upper case.</p>



<p>Here’s what the code for that command would look like:</p>



<pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">using Microsoft.Office.Interop.Excel;
using System;
using QueryStorm.Apps;
using QueryStorm.Apps.Contract;
using QueryStorm.Tools.Excel;
using QueryStorm.Tools;

namespace Project;

public class ContextCommand1 : ContextMenuCommand
{
    private readonly IWorkbookAccessor workbookAccessor;

    public ContextCommand1(IWorkbookAccessor workbookAccessor)
        : base(
            caption: &#34;To UPPPER case&#34;,
            faceId: 100,
            allowedLocations: new[] { KnownContextMenuLocations.Cell, KnownContextMenuLocations.Table })
    {
        this.workbookAccessor = workbookAccessor;
    }

    public override void Execute()
    {
        workbookAccessor.Run(wb =&gt; 
        {
        	var range = wb.Application.Selection as Range;
        	object [,] data = range.GetData();
        	for (int i = data.GetLowerBound(0); i &lt;= data.GetUpperBound(0); i++)
        	{
        		for (int j = data.GetLowerBound(1); j &lt;= data.GetUpperBound(1); j++)
        		{
        			var val = data[i,j];
        			if(val is string s)
        				data[i, j] = s.ToUpper();
        		}
        	}
        	range.Value = data;
        });
    }
}</pre>



<p>And here’s what the new context menu command looks like in Excel:</p>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/to_uppercase_command.gif" data-img-id="1900" data-nonce="e95db202f5"><img loading="lazy" width="1654" height="1214" src="https://querystorm.com/wp-content/uploads/2023/01/to_uppercase_command.gif" alt="Custom command for converting text to uppercase"/><figcaption>Custom command for converting text to uppercase</figcaption></figure>



<p>If you look at the context menu command’s constructor, you might notice that it uses dependency injection to access the current workbook. In fact, QueryStorm apps use dependency injection extensively. More on that in <a href="https://querystorm.com/docs2/apps_dotnet/dependency_injection/">this section</a> of the documentation.</p>



<h3>Publishing Extension packages</h3>



<p>Once you’ve built the customizations you want, you might want to share them with colleagues or clients. You can do so by publishing your extension package to a repository.</p>



<p>Once you publish an extension to a repository, users who have the QueryStorm Runtime and the URL of your repository can download and use it. More on this in the “Runtime” section of this post.</p>



<h2>Automating workbooks</h2>



<p>Another thing you can do in Excel with VBA is react to events in the workbook. We can easily do this with C# and QueryStorm too.</p>



<p>To add behavior (in the form of C# code) to a workbook, create a project inside the workbook and add a component class:</p>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/create_workbookapp_component.gif" data-img-id="1901" data-nonce="c76758352a"><img loading="lazy" width="2205" height="1305" src="https://querystorm.com/wp-content/uploads/2023/01/create_workbookapp_component.gif" alt="Create a project and a component inside the workbook"/><figcaption>Create a project and a component inside the workbook</figcaption></figure>



<p>For example, the following component pops up the name of the oldest person in an Excel table whenever the user clicks a specific button in the workbook.</p>



<pre data-enlighter-language="csharp" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">using System;
using System.Collections.Generic;
using System.Linq;
using QueryStorm.Apps;
using QueryStorm.Apps.Contract;
using QueryStorm.Data;
using static QueryStorm.Tools.DebugHelpers;

namespace Project;

public class Component1 : ComponentBase
{
	private double _number;
		
	// data-bind to &#34;People&#34; table
	[BindTable]
	public PeopleTable People { get; set; }
		
	// handle click of button &#34;Sheet1!CommandButton1&#34;
	[EventHandler(&#34;Sheet1!CommandButton1&#34;)]
	public void Test()
	{
		var oldestPersonsName = People
			.OrderByDescending(x =&gt; x.Age)
			.First()
			.Name;
			
		System.Windows.Forms.MessageBox.Show(
			$&#34;Oldest person is {oldestPersonsName}&#34;);
	}
}
</pre>



<p>The component uses data binding to access data in an Excel table and defines a method for handling the click event of a button.</p>



<p>Upon building the project, the compiled workbook app is embedded inside the workbook as one or more dll files. The QueryStorm Runtime then detects the workbook app and starts it.</p>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/workbookapp_demo.gif" data-img-id="1902" data-nonce="a25e19c322"><img loading="lazy" width="2205" height="1305" src="https://querystorm.com/wp-content/uploads/2023/01/workbookapp_demo.gif" alt="Simple Workbook app via C# (demo)"/><figcaption>Simple Workbook App demo</figcaption></figure>



<p>It’s worth noting that workbook apps can also include their own custom Excel functions. The functions defined inside of a workbook are only available in that particular workbook. The same goes for any context menus, ribbon customizations, and keyboard shortcuts that the workbook app defines.</p>



<h2>The project system</h2>



<p>QueryStorm has its own project system similar to the one in Visual Studio.</p>



<p>Projects that contain Excel extensions are defined at the machine level, while a project that automates a workbook is stored inside the workbook itself.</p>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/image-29-1024x517.png" data-img-id="1913" data-nonce="eeb272396b"><img loading="lazy" width="1024" height="517" src="https://querystorm.com/wp-content/uploads/2023/01/image-29-1024x517.png" alt="QueryStorm project system" srcset="https://querystorm.com/wp-content/uploads/2023/01/image-29-1024x517.png 1024w, https://querystorm.com/wp-content/uploads/2023/01/image-29-300x151.png 300w, https://querystorm.com/wp-content/uploads/2023/01/image-29-768x388.png 768w, https://querystorm.com/wp-content/uploads/2023/01/image-29.png 1189w" sizes="(max-width: 1024px) 100vw, 1024px"/><figcaption>QueryStorm project system</figcaption></figure>



<p>The context menu contains commands for generating various kinds of files with some basic code scaffolding included.</p>



<h3>VB.NET support</h3>



<p>One thing worth mentioning is that C# is not the only language that’s supported – <a href="http://VB.NET">VB.NET</a> is as well. When creating a project you can choose which language to use.</p>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/image-22.png" data-img-id="1903" data-nonce="63dc3c0372"><img loading="lazy" width="722" height="377" src="https://querystorm.com/wp-content/uploads/2023/01/image-22.png" alt="Choosing between C# and VB.NET languages when creating a project" srcset="https://querystorm.com/wp-content/uploads/2023/01/image-22.png 722w, https://querystorm.com/wp-content/uploads/2023/01/image-22-300x157.png 300w" sizes="(max-width: 722px) 100vw, 722px"/><figcaption>Choosing between C# and VB.NET languages when creating a project</figcaption></figure>



<p>This choice is stored inside the <em>project.config</em> file.</p>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/image-23-1024x429.png" data-img-id="1904" data-nonce="337af2f663"><img loading="lazy" width="1024" height="429" src="https://querystorm.com/wp-content/uploads/2023/01/image-23-1024x429.png" alt="The language of the project is stored inside the project.config file" srcset="https://querystorm.com/wp-content/uploads/2023/01/image-23-1024x429.png 1024w, https://querystorm.com/wp-content/uploads/2023/01/image-23-300x126.png 300w, https://querystorm.com/wp-content/uploads/2023/01/image-23-768x322.png 768w, https://querystorm.com/wp-content/uploads/2023/01/image-23.png 1411w" sizes="(max-width: 1024px) 100vw, 1024px"/><figcaption>The language of the project is stored inside the <em>project.config</em> file</figcaption></figure>



<p>Support for VB.NET might appeal to users with a background in VBA. Since Roslyn includes support for VB.NET, surfacing it in QueryStorm made sense.</p>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/image-24.png" data-img-id="1905" data-nonce="0186060bbf"><img loading="lazy" width="2217" height="1325" src="https://querystorm.com/wp-content/uploads/2023/01/image-24.png" alt="VB.NET code in QueryStorm" srcset="https://querystorm.com/wp-content/uploads/2023/01/image-24.png 2217w, https://querystorm.com/wp-content/uploads/2023/01/image-24-300x179.png 300w, https://querystorm.com/wp-content/uploads/2023/01/image-24-1024x612.png 1024w, https://querystorm.com/wp-content/uploads/2023/01/image-24-768x459.png 768w, https://querystorm.com/wp-content/uploads/2023/01/image-24-1536x918.png 1536w, https://querystorm.com/wp-content/uploads/2023/01/image-24-2048x1224.png 2048w" sizes="(max-width: 2217px) 100vw, 2217px"/><figcaption>VB.NET code in QueryStorm</figcaption></figure>



<p>Note that we can use VB.NET to build extension apps and workbook apps, but there is no scripting flavor of <a href="http://VB.NET">VB.NET</a> in Roslyn, so there are no VB.NET scripts, only C# scripts.</p>



<h2>NuGet packages</h2>



<p>One of the main advantages of C# and .NET is the ability to use existing libraries and packages from the .NET ecosystem, so supporting NuGet was a must for QueryStorm.</p>



<p>Here’s what adding a package to a project looks like:</p>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/add_nuget_package.gif" data-img-id="1906" data-nonce="d710064114"><img loading="lazy" width="2205" height="1314" src="https://querystorm.com/wp-content/uploads/2023/01/add_nuget_package.gif" alt="Adding and using a NuGet package to a project"/><figcaption>Adding and using a NuGet package to a project</figcaption></figure>



<h2>The QueryStorm Runtime</h2>



<p>Ok, so how does someone use a workbook or Excel extension that you’ve built using QueryStorm?</p>



<p>The main thing they need is the QueryStorm runtime. The runtime allows running workbooks with compiled C# code as well as downloading and running Excel extensions created by QueryStorm.</p>



<p>The runtime is a free 4MB add-in that end users install into Excel. Users can <a href="https://querystorm.com/downloads/">download it</a> from the QueryStorm website.  </p>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/image-25-1024x612.png" data-img-id="1907" data-nonce="1e5e4dae64"><img loading="lazy" width="1024" height="612" src="https://querystorm.com/wp-content/uploads/2023/01/image-25-1024x612.png" alt="Downloading the runtime installer" srcset="https://querystorm.com/wp-content/uploads/2023/01/image-25-1024x612.png 1024w, https://querystorm.com/wp-content/uploads/2023/01/image-25-300x179.png 300w, https://querystorm.com/wp-content/uploads/2023/01/image-25-768x459.png 768w, https://querystorm.com/wp-content/uploads/2023/01/image-25-1536x918.png 1536w, https://querystorm.com/wp-content/uploads/2023/01/image-25.png 1633w" sizes="(max-width: 1024px) 100vw, 1024px"/><figcaption>Downloading the runtime installer</figcaption></figure>



<p>The installer performs a per-user installation that does not require admin privileges. </p>



<p>Workbook apps and extension apps are very similar but differ in how they are distributed.</p>



<h3>Running and distributing workbook apps</h3>



<p>For workbook apps, distribution is simple. The compiled code is embedded inside the workbook itself. The workbook can be distributed via email, network share, cloud storage, etc… </p>



<p>Note that sharing the workbook as an email attachment might not always work, since the workbook contains an embedded dll which some email filters will detect and block for security reasons. Sharing through OneDrive, Dropbox, or Google Drive will work just fine, though.</p>



<p>When an end user opens a workbook that has compiled code inside it, the QueryStorm runtime will prompt the user to allow the code in the workbook to run.</p>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/image-26.png" data-img-id="1908" data-nonce="aa9985f525"><img loading="lazy" width="872" height="243" src="https://querystorm.com/wp-content/uploads/2023/01/image-26.png" alt="Security prompt before allowing a workbook app to run" srcset="https://querystorm.com/wp-content/uploads/2023/01/image-26.png 872w, https://querystorm.com/wp-content/uploads/2023/01/image-26-300x84.png 300w, https://querystorm.com/wp-content/uploads/2023/01/image-26-768x214.png 768w" sizes="(max-width: 872px) 100vw, 872px"/><figcaption>Security prompt before allowing a workbook app to run</figcaption></figure>



<p>If the user allows the workbook to run, they will not be asked again for that particular workbook, unless the compiled code is changed in any way.</p>



<p>Check out the docs for more information on <a href="https://querystorm.com/docs2/runtime/trusted_workbooks/">workbook app security</a>.</p>



<h3>Running and distributing extension apps</h3>



<p>Excel extensions, on the other hand, are distributed through the QueryStorm app store. The author publishes their extension package to a (NuGet) server. </p>



<p>End users can pull the extension from there, but they must first register the URL of the repository using the “Extensions” dialog in the “QueryStorm Runtime” tab in the ribbon:</p>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/image-27-1024x614.png" data-img-id="1909" data-nonce="0195502b8c"><img loading="lazy" width="1024" height="614" src="https://querystorm.com/wp-content/uploads/2023/01/image-27-1024x614.png" alt="Registering an extensions repository" srcset="https://querystorm.com/wp-content/uploads/2023/01/image-27-1024x614.png 1024w, https://querystorm.com/wp-content/uploads/2023/01/image-27-300x180.png 300w, https://querystorm.com/wp-content/uploads/2023/01/image-27-768x460.png 768w, https://querystorm.com/wp-content/uploads/2023/01/image-27-1536x920.png 1536w, https://querystorm.com/wp-content/uploads/2023/01/image-27-2048x1227.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/><figcaption>Registering an extensions repository</figcaption></figure>



<p>Once they do, they will be able to browse and install all extensions on that repository.</p>



<p>The QueryStorm runtime comes with one predefined repository where we (mostly I) publish general-purpose extensions.</p>



<p>For example, I’ve built and published an extension that adds several functions for working with <a href="https://querystorm.com/phone-numbers-in-excel/">phone numbers</a>. </p>



<p>Here’s how to install and use it:</p>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/install_phonenumbers_extension_demo.gif" data-img-id="1912" data-nonce="122ab02363"><img loading="lazy" width="2205" height="1314" src="https://querystorm.com/wp-content/uploads/2023/01/install_phonenumbers_extension_demo.gif" alt="Installing and using the Windy.Phone package that adds functions for working with phone numbers"/><figcaption>Installing and using the Windy.Phone package with functions for working with phone numbers</figcaption></figure>



<p>Currently, authors can’t publish their extensions to this built-in repository (contact me if you would like to). However, you can easily create your own repository and use it to share your extensions with colleagues and clients.</p>



<p>If you would like to share extensions with other users on the same network, a simple shared folder will work nicely. Simply registering the path of the network share is sufficient both for package authors and end users.</p>



<p>If you would like to share your extensions with other people outside of your network, then using a cloud repository like Azure Artifacts would be best. Azure Artifacts has a free tier that offers 2GB of storage which is enough for hundreds of extensions. Setting up an Azure Artifacts repository takes just a few minutes, see <a href="https://www.youtube.com/watch?v=jc5l4OV0PZM&amp;t=4s&amp;ab_channel=AntonioNaki%C4%87-Alfirevi%C4%87">this video</a> for instructions.</p>



<p>For more information on setting up repositories, check out <a href="https://querystorm.com/docs2/projects/publishing/">this section</a> of the documentation.</p>



<h2>Debugging C# code in Excel</h2>



<p>If you’re writing more than a trivial amount of C#, you’ll need to be able to debug. There are several ways to debug C# code in QueryStorm, the easiest one being the built-in .NET debugger.</p>



<p>To start debugging a project, press F5.</p>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/debugging_demo.gif" data-img-id="1911" data-nonce="abc108ac0e"><img loading="lazy" width="2205" height="1314" src="https://querystorm.com/wp-content/uploads/2023/01/debugging_demo.gif" alt="Debugging C# code in Excel demo"/><figcaption>Debugging C# code demo</figcaption></figure>



<p>All of the debugger commands are available in the ribbon, but you can also use keyboard shortcuts which you can configure in the settings dialog:</p>



<figure data-open="modal-ajax" data-action="get_modal_image" data-img-src="https://querystorm.com/wp-content/uploads/2023/01/image-28-1024x835.png" data-img-id="1910" data-nonce="8fd2b83594"><img loading="lazy" width="1024" height="835" src="https://querystorm.com/wp-content/uploads/2023/01/image-28-1024x835.png" alt="Viewing and adjusting keyboard shortcuts" srcset="https://querystorm.com/wp-content/uploads/2023/01/image-28-1024x835.png 1024w, https://querystorm.com/wp-content/uploads/2023/01/image-28-300x245.png 300w, https://querystorm.com/wp-content/uploads/2023/01/image-28-768x627.png 768w, https://querystorm.com/wp-content/uploads/2023/01/image-28.png 1320w" sizes="(max-width: 1024px) 100vw, 1024px"/><figcaption>Viewing and adjusting keyboard shortcuts</figcaption></figure>



<p>One limitation of the debugger is that you can only use it to debug <em>regular</em> C# code. Debugging C# scripts is not (yet) supported. </p>



<p>To debug C# scripts, you can either fall back on log statements (using the <code>Log()</code> method) or attach Visual Studio to the Excel process and use the <code>Debug()</code> method to act as a breakpoint.</p>



<h2>Final thoughts</h2>



<p>Excel has a lot of functionality. With the ability to process data and add logic using C#, however, it can become an extremely powerful tool in the hands of a skilled user.</p>



<p>This post only scratched the surface of the possible ways to use C# inside Excel.</p>



<p>If you’re a C# developer, VBA developer, data analyst, or data scientist, I hope that QueryStorm finds its place in your toolbox as your favorite tool.</p>



<p>If you have any thoughts or comments, please leave them below. I’d very much welcome your feedback.</p>


        </div>
      </div>
    </div></div>
  </body>
</html>
