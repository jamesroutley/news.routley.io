<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://en.wikipedia.org/wiki/Ichiki_Shir%C5%8D">Original</a>
    <h1>Ichiki Shirō</h1>
    
    <div id="readability-page-1" class="page"><div>
      



<section id="post">

  <nav>
    &gt; <a href="https://sawyer.dev/">home</a>
    &gt; <a href="https://sawyer.dev/posts">blog posts</a>
  </nav>

  <container>
    <h2 id="post-title"> Tracking Function Calls in Python with Deride </h2>

    <article>
      <p>When I was writing my <a href="https://sawyer.dev/posts/dropbox-cli-python">Dropbox command-line client</a> earlier this year, I found one aspect particularly frustrating: testing my interactions with the Dropbox client itself. This was frustrating because, after all, the Dropbox client is at the core of everything the CLI does. I ended up hand-crafting fake responses and exceptions and it worked well enough despite being a pain to assemble. However, I know that if and when the API changes I&#39;ll need to re-explore the API and update whatever&#39;s gone stale.</p>
<p>Around the same time, I started trying out OCaml for some personal projects. Unsurprisingly, I ended up reading some blog posts from Jane Street about their work with and on OCaml. When I read about <a href="https://blog.janestreet.com/testing-with-expectations/">their concept of &#34;expect tests&#34;</a>, I immediately thought of my frustration with crafting fake data for the Dropbox client. Specifically, it were these two sentences early in the post that spoke to me:</p>
<blockquote>
<p>Expect tests allow you to write test scenarios without having to manually write out the output generated by the code you’re testing. Instead, that output is captured and recorded automatically for you, in a way that makes it easy to integrate into the source of the test.</p>
</blockquote>
<p>Despite all the differences between the context of that post and the context of my cli, I was inspired by the idea that interactive exploration could help make testing easier.</p>
<h2>deride</h2>
<p>I put together a small Python module, <a href="https://gitlab.com/soryrawyer/deride"><code>deride</code></a>, that might get me closer to automatically generating data for testing. The module currently exposes one class, <code>Deride</code>, that wraps a class or module and will record all the functions called, along with the arguments to and responses from those function calls. In practice, it&#39;s kind of similar to existing Python testing utilities like <a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.Mock"><code>Mock</code></a> in that you can still call any function you&#39;d expect to find on the underlying object. It does this via a custom implementation of <code>__getattr__</code>, which is one part of how Python finds functions and attributes on objects. The class also squirrels away a few attributes, like the wrapped object and a list of function calls. The attribute lookup will return yet another wrapper, one that will add information about the function back to the original <code>Deride</code> instance. Once you&#39;ve called some functions, it&#39;s time to use the other notable part of the module: <code>get_calls</code>. This returns a list of objects containing information about each function call.</p>
<p>The way I intend to use <code>deride</code> is in an interactive session where I wrap a module like <code>requests</code> or a class like the Dropbox client. After calling all the functions I might need to call in my real code, I can take the output of <code>get_calls</code> and turn that into a suitable facsimile of the third-party service I&#39;m building on.</p>
<p>There are some rough edges to work on, like tracking exceptions thrown and attributes looked up, but hopefully this saves me a bit of time down the road in creating realistic test scenarios and easing the maintenance burden of code written against third-party services.</p>

    </article>

  </container>


</section>

    </div></div>
  </body>
</html>
