<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://alinpanaitiu.com/blog/over-500nits-failed/">Original</a>
    <h1>Trying to get past the 500 nits limit of the MacBook Pro (and failing)</h1>
    
    <div id="readability-page-1" class="page"><div>

<main role="main">
  <section>
    <article>
      
      <section>
        <p>Exactly 3 months and a day after placing an order through a Romanian Apple reseller, I finally got my 14-inch M1 Max.</p>
<p><em>Well, actually.. I first got the wrong configuration (base model instead of CTO), had to return it to them after wasting a day on migrating my data to it, they sent my money back by mistake, had to pay them again, and after many calls and emails later the correct laptop arrived.</em></p>










<picture>
  
    
    
    
      <source sizes="(min-width: 60em) 90%, 90vw" srcset="/images/m1max/1920_m1max.webp 1920w,/images/m1max/1280_m1max.webp 1280w,/images/m1max/1024_m1max.webp 1024w,/images/m1max/768_m1max.webp 768w,/images/m1max/640_m1max.webp 640w,/images/m1max/320_m1max.webp 320w" type="image/webp"/>
    
    <source sizes="(min-width: 60em) 90%, 90vw" srcset="/images/m1max/1920_m1max.png 1920w,/images/m1max/1280_m1max.png 1280w,/images/m1max/1024_m1max.png 1024w,/images/m1max/768_m1max.png 768w,/images/m1max/640_m1max.png 640w,/images/m1max/320_m1max.png 320w"/>
  
  <img src="https://jesseevers.com/images/m1max/m1max.png" alt="M1 Max MacBook Pro box"/>
</picture>

<p>As soon as these devices were in the hands of users, requests started coming in for <strong><a href="https://lunar.fyi">Lunar</a></strong> to provide an option to <a href="https://github.com/alin23/Lunar/issues/417">get past the 500 nits limit for everyday usage</a></p>
<p>Over the last week I tried my best to figure out how to do this, but it’s either impossible to raise the nits limit from userspace, or I just don’t have the necessary expertise.</p>
<p>I’ll share some details that I found while reverse engineering my way through the macOS part that handles brightness.</p>
<h2 id="testing-the-system"><a href="#testing-the-system">#</a> Testing the system</h2>
<h3 id="playing-a-hdr-video"><a href="#playing-a-hdr-video">#</a> Playing a HDR video</h3>
<p>I first started by playing this HDR test video <em>(open it in latest Chrome or Safari for best results)</em>: <a href="https://files.alinpanaitiu.com/hdr-test-pattern.webm">hdr-test-pattern.webm</a></p>
<p>Which resulted in a blinding white at 1600 nits:










<picture>
  
    
    
    
      <source sizes="(min-width: 60em) 90%, 90vw" srcset="/images/hdr-result/1920_hdr-result.webp 1920w,/images/hdr-result/1280_hdr-result.webp 1280w,/images/hdr-result/1024_hdr-result.webp 1024w,/images/hdr-result/768_hdr-result.webp 768w,/images/hdr-result/640_hdr-result.webp 640w,/images/hdr-result/320_hdr-result.webp 320w" type="image/webp"/>
    
    <source sizes="(min-width: 60em) 90%, 90vw" srcset="/images/hdr-result/1920_hdr-result.png 1920w,/images/hdr-result/1280_hdr-result.png 1280w,/images/hdr-result/1024_hdr-result.png 1024w,/images/hdr-result/768_hdr-result.png 768w,/images/hdr-result/640_hdr-result.png 640w,/images/hdr-result/320_hdr-result.png 320w"/>
  
  <img src="https://jesseevers.com/images/hdr-result/hdr-result.png" alt="HDR white being whiter than the webpage white"/>
</picture>
</p>
<p>This generated the following logs in Console.app:</p>
<div><div>
<table><tbody><tr><td>
<pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span></code></pre></td>
<td>
<pre tabindex="0"><code data-lang="swift"><span>WindowServer</span>    <span>Display</span> <span>1</span> <span>setting</span> <span>nits</span> <span>to</span> <span>888.889</span>
<span>corebrightnessd</span> <span>SDR</span> <span>-</span> <span>perceptual</span> <span>ramp</span> <span>clocked</span><span>:</span> <span>227.095169</span> <span>-&gt;</span> <span>252.268112</span> <span>-</span> <span>49.169426</span><span>%</span> <span>(</span><span>239.142059</span> <span>Nits</span><span>)</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>211.603</span><span>,</span> <span>headroom</span><span>:</span> <span>4.20075</span><span>,</span> <span>ambient</span><span>:</span> <span>4.3396</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>13.6333</span><span>,</span> <span>limit</span><span>:</span> <span>1600</span>
</code></pre></td></tr></tbody></table>
</div>
</div><hr/>
<h3 id="sdr-cap-in-normal-lighting"><a href="#sdr-cap-in-normal-lighting">#</a> SDR cap in normal lighting</h3>
<p>After setting the display brightness to max, I could see in the logs that <strong>SDR</strong> (Standard Dynamic Range) was being capped at <strong>400 nits</strong>:</p>
<div><div>
<table><tbody><tr><td>
<pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span></code></pre></td>
<td>
<pre tabindex="0"><code data-lang="swift"><span>WindowServer</span>    <span>Display</span> <span>1</span> <span>setting</span> <span>nits</span> <span>to</span> <span>1600</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>setting</span> <span>display</span> <span>headroom</span> <span>hint</span> <span>to</span> <span>7.56866</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>216.548</span><span>,</span> <span>headroom</span><span>:</span> <span>7.38865</span><span>,</span> <span>ambient</span><span>:</span> <span>4.24854</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>13.3472</span><span>,</span> <span>limit</span><span>:</span> <span>1600</span>
<span>corebrightnessd</span> <span>PCC</span><span>:</span> <span>Set</span> <span>PCC</span><span>:</span> <span>Factor</span><span>:=</span><span>1.0496</span> <span>CabalFactor</span><span>:=</span><span>0.0033</span> <span>time</span><span>=</span><span>2.000000</span> <span>Lux</span><span>:=</span><span>13.6080</span> <span>Nits</span><span>:=</span><span>229.1757</span> <span>result</span><span>=</span><span>1</span> <span>error</span><span>=(</span><span>null</span><span>)</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>301.188</span><span>,</span> <span>headroom</span><span>:</span> <span>5.3123</span><span>,</span> <span>ambient</span><span>:</span> <span>4.24854</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>13.3472</span><span>,</span> <span>limit</span><span>:</span> <span>1600</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>setting</span> <span>nits</span> <span>to</span> <span>1602.03</span>
<span>corebrightnessd</span> <span>levelPercentage</span> <span>0.334298</span><span>,</span> <span>level</span> <span>=</span> <span>4.967383</span> <span>(</span><span>nits</span><span>/</span><span>pwm</span><span>),</span> <span>lux</span> <span>=</span> <span>15.000000</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>301.571</span><span>,</span> <span>headroom</span><span>:</span> <span>-</span><span>1</span><span>,</span> <span>ambient</span><span>:</span> <span>4.79275</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>15.0569</span><span>,</span> <span>limit</span><span>:</span> <span>-</span><span>1</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>setting</span> <span>display</span> <span>headroom</span> <span>hint</span> <span>to</span> <span>5.27556</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>321.478</span><span>,</span> <span>headroom</span><span>:</span> <span>4.97701</span><span>,</span> <span>ambient</span><span>:</span> <span>4.79275</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>15.0569</span><span>,</span> <span>limit</span><span>:</span> <span>1600</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>340.675</span><span>,</span> <span>headroom</span><span>:</span> <span>4.69655</span><span>,</span> <span>ambient</span><span>:</span> <span>4.79275</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>15.0569</span><span>,</span> <span>limit</span><span>:</span> <span>1600</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>377.322</span><span>,</span> <span>headroom</span><span>:</span> <span>4.24041</span><span>,</span> <span>ambient</span><span>:</span> <span>4.79275</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>15.0569</span><span>,</span> <span>limit</span><span>:</span> <span>1600</span>
<span>corebrightnessd</span> <span>PCC</span><span>:</span> <span>Set</span> <span>PCC</span><span>:</span> <span>Factor</span><span>:=</span><span>1.0340</span> <span>CabalFactor</span><span>:=</span><span>0.0023</span> <span>time</span><span>=</span><span>2.000000</span> <span>Lux</span><span>:=</span><span>15.0569</span> <span>Nits</span><span>:=</span><span>377.3223</span> <span>result</span><span>=</span><span>1</span> <span>error</span><span>=(</span><span>null</span><span>)</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>setting</span> <span>nits</span> <span>to</span> <span>1600</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>setting</span> <span>display</span> <span>headroom</span> <span>hint</span> <span>to</span> <span>4</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>400</span><span>,</span> <span>headroom</span><span>:</span> <span>-</span><span>1</span><span>,</span> <span>ambient</span><span>:</span> <span>4.96577</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>15.6004</span><span>,</span> <span>limit</span><span>:</span> <span>-</span><span>1</span>

</code></pre></td></tr></tbody></table>
</div>
</div>









<picture>
  
    
    
    
      <source sizes="(min-width: 60em) 90%, 90vw" srcset="/images/hdr-console/1920_hdr-console.webp 1920w,/images/hdr-console/1280_hdr-console.webp 1280w,/images/hdr-console/1024_hdr-console.webp 1024w,/images/hdr-console/768_hdr-console.webp 768w,/images/hdr-console/640_hdr-console.webp 640w,/images/hdr-console/320_hdr-console.webp 320w" type="image/webp"/>
    
    <source sizes="(min-width: 60em) 90%, 90vw" srcset="/images/hdr-console/1920_hdr-console.png 1920w,/images/hdr-console/1280_hdr-console.png 1280w,/images/hdr-console/1024_hdr-console.png 1024w,/images/hdr-console/768_hdr-console.png 768w,/images/hdr-console/640_hdr-console.png 640w,/images/hdr-console/320_hdr-console.png 320w"/>
  
  <img src="https://jesseevers.com/images/hdr-console/hdr-console.png" alt="HDR white and console logs side by side"/>
</picture>

<hr/>
<h3 id="sdr-cap-in-direct-sunlight"><a href="#sdr-cap-in-direct-sunlight">#</a> SDR cap in direct sunlight</h3>
<p>Shining a flashlight directly into the Ambient Light Sensor allowed <strong>SDR</strong> to jump up to <strong>500 nits</strong>:</p>
<div><div>
<table><tbody><tr><td>
<pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span><span>22
</span><span>23
</span><span>24
</span><span>25
</span><span>26
</span><span>27
</span><span>28
</span><span>29
</span><span>30
</span><span>31
</span><span>32
</span></code></pre></td>
<td>
<pre tabindex="0"><code data-lang="swift"><span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>400</span><span>,</span> <span>headroom</span><span>:</span> <span>-</span><span>1</span><span>,</span> <span>ambient</span><span>:</span> <span>322.204</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>1012.24</span><span>,</span> <span>limit</span><span>:</span> <span>-</span><span>1</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>400.484</span><span>,</span> <span>headroom</span><span>:</span> <span>1</span><span>,</span> <span>ambient</span><span>:</span> <span>322.204</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>1012.24</span><span>,</span> <span>limit</span><span>:</span> <span>400.484</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>setting</span> <span>nits</span> <span>to</span> <span>400.484</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>401.15</span><span>,</span> <span>headroom</span><span>:</span> <span>1</span><span>,</span> <span>ambient</span><span>:</span> <span>322.204</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>1012.24</span><span>,</span> <span>limit</span><span>:</span> <span>401.15</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>setting</span> <span>nits</span> <span>to</span> <span>401.15</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>401.223</span><span>,</span> <span>headroom</span><span>:</span> <span>1</span><span>,</span> <span>ambient</span><span>:</span> <span>322.204</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>1012.24</span><span>,</span> <span>limit</span><span>:</span> <span>401.224</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>setting</span> <span>nits</span> <span>to</span> <span>401.223</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>401.223</span><span>,</span> <span>headroom</span><span>:</span> <span>-</span><span>1</span><span>,</span> <span>ambient</span><span>:</span> <span>370.814</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>1164.95</span><span>,</span> <span>limit</span><span>:</span> <span>-</span><span>1</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>401.552</span><span>,</span> <span>headroom</span><span>:</span> <span>1</span><span>,</span> <span>ambient</span><span>:</span> <span>370.814</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>1164.95</span><span>,</span> <span>limit</span><span>:</span> <span>401.552</span>
<span>corebrightnessd</span> <span>PCC</span><span>:</span> <span>Set</span> <span>PCC</span><span>:</span> <span>Factor</span><span>:=</span><span>1.7464</span> <span>CabalFactor</span><span>:=</span><span>0.0498</span> <span>time</span><span>=</span><span>2.000000</span> <span>Lux</span><span>:=</span><span>1164.9467</span> <span>Nits</span><span>:=</span><span>401.5517</span> <span>result</span><span>=</span><span>1</span> <span>error</span><span>=(</span><span>null</span><span>)</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>setting</span> <span>nits</span> <span>to</span> <span>401.552</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>402.219</span><span>,</span> <span>headroom</span><span>:</span> <span>1</span><span>,</span> <span>ambient</span><span>:</span> <span>370.814</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>1164.95</span><span>,</span> <span>limit</span><span>:</span> <span>402.219</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>setting</span> <span>nits</span> <span>to</span> <span>402.219</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>402.885</span><span>,</span> <span>headroom</span><span>:</span> <span>1</span><span>,</span> <span>ambient</span><span>:</span> <span>370.814</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>1164.95</span><span>,</span> <span>limit</span><span>:</span> <span>402.885</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>setting</span> <span>nits</span> <span>to</span> <span>402.885</span>
<span>...</span> <span>lots</span> <span>of</span> <span>similar</span> <span>logs</span> <span>...</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>setting</span> <span>nits</span> <span>to</span> <span>495.458</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>496.125</span><span>,</span> <span>headroom</span><span>:</span> <span>1</span><span>,</span> <span>ambient</span><span>:</span> <span>810.176</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>2545.24</span><span>,</span> <span>limit</span><span>:</span> <span>496.125</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>setting</span> <span>nits</span> <span>to</span> <span>496.125</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>496.791</span><span>,</span> <span>headroom</span><span>:</span> <span>1</span><span>,</span> <span>ambient</span><span>:</span> <span>810.176</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>2545.24</span><span>,</span> <span>limit</span><span>:</span> <span>496.792</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>setting</span> <span>nits</span> <span>to</span> <span>496.791</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>497.458</span><span>,</span> <span>headroom</span><span>:</span> <span>1</span><span>,</span> <span>ambient</span><span>:</span> <span>810.176</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>2545.24</span><span>,</span> <span>limit</span><span>:</span> <span>497.458</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>setting</span> <span>nits</span> <span>to</span> <span>497.458</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>498.125</span><span>,</span> <span>headroom</span><span>:</span> <span>1</span><span>,</span> <span>ambient</span><span>:</span> <span>810.176</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>2545.24</span><span>,</span> <span>limit</span><span>:</span> <span>498.125</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>setting</span> <span>nits</span> <span>to</span> <span>498.125</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>498.791</span><span>,</span> <span>headroom</span><span>:</span> <span>1</span><span>,</span> <span>ambient</span><span>:</span> <span>810.176</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>2545.24</span><span>,</span> <span>limit</span><span>:</span> <span>498.792</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>setting</span> <span>nits</span> <span>to</span> <span>498.791</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>499.458</span><span>,</span> <span>headroom</span><span>:</span> <span>1</span><span>,</span> <span>ambient</span><span>:</span> <span>810.176</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>2545.24</span><span>,</span> <span>limit</span><span>:</span> <span>499.458</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>setting</span> <span>nits</span> <span>to</span> <span>499.458</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>500</span><span>,</span> <span>headroom</span><span>:</span> <span>1</span><span>,</span> <span>ambient</span><span>:</span> <span>810.176</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>2545.24</span><span>,</span> <span>limit</span><span>:</span> <span>500</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>setting</span> <span>nits</span> <span>to</span> <span>500</span>
<span>WindowServer</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>500</span><span>,</span> <span>headroom</span><span>:</span> <span>-</span><span>1</span><span>,</span> <span>ambient</span><span>:</span> <span>987.858</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>3103.45</span><span>,</span> <span>limit</span><span>:</span> <span>-</span><span>1</span>
</code></pre></td></tr></tbody></table>
</div>
</div><h2 id="dissecting-the-system"><a href="#dissecting-the-system">#</a> Dissecting the system</h2>
<p>Since Big Sur, macOS transitioned from having the frameworks on the disk as separate binaries, to having a single file containing all the system libraries, called a <code>dyld_shared_cache</code>.</p>
<blockquote>
<ul>
<li>New in macOS Big Sur 11.0.1, the system ships with a built-in dynamic linker cache of all system-provided libraries. As part of this change, copies of dynamic libraries are no longer present on the filesystem. Code that attempts to check for dynamic library presence by looking for a file at a path or enumerating a directory will fail. Instead, check for library presence by attempting to dlopen() the path, which will correctly check for the library in the cache. (62986286)</li>
</ul>
</blockquote>
<p>Searching for keywords from the above logs surfaced only the dyld cache as expected.</p>










<picture>
  
    
    
    
      <source sizes="(min-width: 60em) 90%, 90vw" srcset="/images/dyld-cache-rg-result/1920_dyld-cache-rg-result.webp 1920w,/images/dyld-cache-rg-result/1280_dyld-cache-rg-result.webp 1280w,/images/dyld-cache-rg-result/1024_dyld-cache-rg-result.webp 1024w,/images/dyld-cache-rg-result/768_dyld-cache-rg-result.webp 768w,/images/dyld-cache-rg-result/640_dyld-cache-rg-result.webp 640w,/images/dyld-cache-rg-result/320_dyld-cache-rg-result.webp 320w" type="image/webp"/>
    
    <source sizes="(min-width: 60em) 90%, 90vw" srcset="/images/dyld-cache-rg-result/1920_dyld-cache-rg-result.png 1920w,/images/dyld-cache-rg-result/1280_dyld-cache-rg-result.png 1280w,/images/dyld-cache-rg-result/1024_dyld-cache-rg-result.png 1024w,/images/dyld-cache-rg-result/768_dyld-cache-rg-result.png 768w,/images/dyld-cache-rg-result/640_dyld-cache-rg-result.png 640w,/images/dyld-cache-rg-result/320_dyld-cache-rg-result.png 320w"/>
  
  <img src="https://jesseevers.com/images/dyld-cache-rg-result/dyld-cache-rg-result.png" alt="searching for nits in system"/>
</picture>

<p>I used <a href="https://github.com/keith/dyld-shared-cache-extractor">dyld-shared-cache-extractor</a> to drop the separate binaries on disk, then did another search there.</p>
<p>This surfaced up <code>QuartzCore</code> as the single place where that string could be found.</p>










<picture>
  
    
    
    
      <source sizes="(min-width: 60em) 90%, 90vw" srcset="/images/dyld-cache-extracted-rg-result/1920_dyld-cache-extracted-rg-result.webp 1920w,/images/dyld-cache-extracted-rg-result/1280_dyld-cache-extracted-rg-result.webp 1280w,/images/dyld-cache-extracted-rg-result/1024_dyld-cache-extracted-rg-result.webp 1024w,/images/dyld-cache-extracted-rg-result/768_dyld-cache-extracted-rg-result.webp 768w,/images/dyld-cache-extracted-rg-result/640_dyld-cache-extracted-rg-result.webp 640w,/images/dyld-cache-extracted-rg-result/320_dyld-cache-extracted-rg-result.webp 320w" type="image/webp"/>
    
    <source sizes="(min-width: 60em) 90%, 90vw" srcset="/images/dyld-cache-extracted-rg-result/1920_dyld-cache-extracted-rg-result.png 1920w,/images/dyld-cache-extracted-rg-result/1280_dyld-cache-extracted-rg-result.png 1280w,/images/dyld-cache-extracted-rg-result/1024_dyld-cache-extracted-rg-result.png 1024w,/images/dyld-cache-extracted-rg-result/768_dyld-cache-extracted-rg-result.png 768w,/images/dyld-cache-extracted-rg-result/640_dyld-cache-extracted-rg-result.png 640w,/images/dyld-cache-extracted-rg-result/320_dyld-cache-extracted-rg-result.png 320w"/>
  
  <img src="https://jesseevers.com/images/dyld-cache-extracted-rg-result/dyld-cache-extracted-rg-result.png" alt="searching for nits in extracted dyld cache"/>
</picture>

<hr/>
<h3 id="trying-to-abuse-quartzcore"><a href="#trying-to-abuse-quartzcore">#</a> Trying to abuse QuartzCore</h3>
<p>After looking through the QuartzCore binary with Ghidra and finding some iOS headers for it on <a href="https://developer.limneos.net/index.php?ios=15.2.1&amp;framework=QuartzCore.framework&amp;header=CAWindowServer.h">limneos.net</a>, I created a sample Swift project to try to use some of the exported functions from it: <a href="https://github.com/alin23/monitorpanel/blob/nits-limit/Sources/monitorpanel/main.swift">monitorpanel - main.swift</a></p>
<p>Based on some open-sourced iOS jailbreak tweaks, I noticed that developers used the <code>CAWindowServer</code> class to interface with the display and HID components directly. The class was available here so I tried to do the same on macOS.</p>
<p>Unfortunately, <code>CAWindowServer.serverIfRunning</code> always returns <code>nil</code> and while <code>CAWindowServer.server(withOptions: nil)</code> returns a seemingly valid server, all external displays are forcefully disconnected when that server is created.</p>
<p>Using the below code, I succeeded in producing the <code>commitBrightness</code> log line in Console, but nothing really changed.</p>
<p><strong>code from <a href="https://github.com/alin23/monitorpanel/blob/nits-limit/Sources/monitorpanel/main.swift">main.swift</a></strong></p>
<div><div>
<table><tbody><tr><td>
<pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span></code></pre></td>
<td>
<pre tabindex="0"><code data-lang="swift"><span>func</span> <span>setToMax</span><span>(</span><span>_</span> <span>d</span><span>:</span> <span>CAWindowServerDisplay</span><span>)</span> <span>{</span>
    <span>d</span><span>.</span><span>setBrightnessLimit</span><span>(</span><span>1600</span><span>)</span>
    <span>d</span><span>.</span><span>setHeadroom</span><span>(</span><span>1</span><span>)</span>
    <span>d</span><span>.</span><span>maximumBrightness</span> <span>=</span> <span>1000.0</span>
    <span>d</span><span>.</span><span>setSDRBrightness</span><span>(</span><span>600</span><span>)</span>
    <span>d</span><span>.</span><span>maximumHDRLuminance</span> <span>=</span> <span>1600</span>
    <span>d</span><span>.</span><span>maximumReferenceLuminance</span> <span>=</span> <span>1600</span>
    <span>d</span><span>.</span><span>maximumSDRLuminance</span> <span>=</span> <span>1000</span>
    <span>d</span><span>.</span><span>contrast</span> <span>=</span> <span>1.1</span>
    <span>d</span><span>.</span><span>commitBrightness</span><span>(</span><span>1</span><span>)</span>
    <span>// d.update() // segfault</span>
<span>}</span>

<span>let</span> <span>ws</span><span>:</span> <span>CAWindowServer</span><span>?</span> <span>=</span> <span>(</span><span>CAWindowServer</span><span>.</span><span>server</span><span>(</span><span>withOptions</span><span>:</span> <span>nil</span><span>)</span> <span>as</span><span>?</span> <span>CAWindowServer</span><span>)</span> <span>// disconnects external displays</span>
<span>if</span> <span>let</span> <span>ws</span> <span>=</span> <span>ws</span><span>,</span>
   <span>let</span> <span>displays</span> <span>=</span> <span>ws</span><span>.</span><span>displays</span> <span>as</span><span>?</span> <span>[</span><span>CAWindowServerDisplay</span><span>],</span>
   <span>let</span> <span>d</span> <span>=</span> <span>displays</span><span>.</span><span>first</span><span>(</span><span>where</span><span>:</span> <span>{</span> <span>$0</span><span>.</span><span>deviceName</span> <span>==</span> <span>&#34;primary&#34;</span> <span>})</span>
<span>{</span>
    <span>setToMax</span><span>(</span><span>d</span><span>)</span>
<span>}</span>
</code></pre></td></tr></tbody></table>
</div>
</div><p><strong><code>commitBrightness</code> log line</strong></p>
<div><div>
<table><tbody><tr><td>
<pre tabindex="0"><code><span>1
</span></code></pre></td>
<td>
<pre tabindex="0"><code data-lang="swift"><span>monitorpanel</span>    <span>Display</span> <span>1</span> <span>commitBrightness</span> <span>sdr</span><span>:</span> <span>600</span><span>,</span> <span>headroom</span><span>:</span> <span>1</span><span>,</span> <span>ambient</span><span>:</span> <span>-</span><span>1</span><span>,</span> <span>filtered</span> <span>ambient</span><span>:</span> <span>-</span><span>1</span><span>,</span> <span>limit</span><span>:</span> <span>1600</span>
</code></pre></td></tr></tbody></table>
</div>
</div><h3 id="corebrightness"><a href="#corebrightness">#</a> CoreBrightness</h3>
<p>While looking through Ghidra, I noticed that <code>QuartzCore</code> finally calls into <code>CoreBrightness</code> functions to increase the nits limit, so I took a look at the exported symbols on that binary.</p>
<p>Unfortunately, all the possibly useful symbols are not exported and trying to link against them would result in the <code>undefined symbols</code> error.</p>
<p>Adding the private symbols in the <a href="https://github.com/alin23/monitorpanel/blob/nits-limit/Sources/CoreBrightness.framework/CoreBrightness.tbd">CoreBrightness.tbd</a> file doesn’t help in this case.</p>
<div><div>
<table><tbody><tr><td>
<pre tabindex="0"><code><span>  1
</span><span>  2
</span><span>  3
</span><span>  4
</span><span>  5
</span><span>  6
</span><span>  7
</span><span>  8
</span><span>  9
</span><span> 10
</span><span> 11
</span><span> 12
</span><span> 13
</span><span> 14
</span><span> 15
</span><span> 16
</span><span> 17
</span><span> 18
</span><span> 19
</span><span> 20
</span><span> 21
</span><span> 22
</span><span> 23
</span><span> 24
</span><span> 25
</span><span> 26
</span><span> 27
</span><span> 28
</span><span> 29
</span><span> 30
</span><span> 31
</span><span> 32
</span><span> 33
</span><span> 34
</span><span> 35
</span><span> 36
</span><span> 37
</span><span> 38
</span><span> 39
</span><span> 40
</span><span> 41
</span><span> 42
</span><span> 43
</span><span> 44
</span><span> 45
</span><span> 46
</span><span> 47
</span><span> 48
</span><span> 49
</span><span> 50
</span><span> 51
</span><span> 52
</span><span> 53
</span><span> 54
</span><span> 55
</span><span> 56
</span><span> 57
</span><span> 58
</span><span> 59
</span><span> 60
</span><span> 61
</span><span> 62
</span><span> 63
</span><span> 64
</span><span> 65
</span><span> 66
</span><span> 67
</span><span> 68
</span><span> 69
</span><span> 70
</span><span> 71
</span><span> 72
</span><span> 73
</span><span> 74
</span><span> 75
</span><span> 76
</span><span> 77
</span><span> 78
</span><span> 79
</span><span> 80
</span><span> 81
</span><span> 82
</span><span> 83
</span><span> 84
</span><span> 85
</span><span> 86
</span><span> 87
</span><span> 88
</span><span> 89
</span><span> 90
</span><span> 91
</span><span> 92
</span><span> 93
</span><span> 94
</span><span> 95
</span><span> 96
</span><span> 97
</span><span> 98
</span><span> 99
</span><span>100
</span><span>101
</span><span>102
</span><span>103
</span><span>104
</span><span>105
</span><span>106
</span><span>107
</span><span>108
</span><span>109
</span><span>110
</span><span>111
</span></code></pre></td>
<td>
<pre tabindex="0"><code data-lang="objc"><span>// Uninteresting Exported Symbols
</span><span></span>
<span>_OBJC_CLASS_</span><span>$</span><span>_BrightnessSystem</span>
<span>_OBJC_CLASS_</span><span>$</span><span>_BrightnessSystemClient</span>
<span>_OBJC_CLASS_</span><span>$</span><span>_BrightnessSystemClientInternal</span>
<span>_OBJC_CLASS_</span><span>$</span><span>_CBAdaptationClient</span>
<span>_OBJC_CLASS_</span><span>$</span><span>_CBBlueLightClient</span>
<span>_OBJC_CLASS_</span><span>$</span><span>_CBClient</span>
<span>_OBJC_CLASS_</span><span>$</span><span>_CBKeyboardPreferencesManager</span>
<span>_OBJC_CLASS_</span><span>$</span><span>_CBTrueToneClient</span>
<span>_OBJC_CLASS_</span><span>$</span><span>_DisplayServicesClient</span>
<span>_OBJC_CLASS_</span><span>$</span><span>_KeyboardBrightnessClient</span>


<span>// Interesting Not Exported Symbols
</span><span></span>
<span>-</span><span>[</span><span>CBBrightnessProxySKL</span> <span>brightnessNotificationRequestEDR</span><span>]</span>
<span>-</span><span>[</span><span>CBBrightnessProxySKL</span> <span>brightnessRequestEDRHeadroom</span><span>]</span>
<span>-</span><span>[</span><span>CBBrightnessProxySKL</span> <span>brightnessRequestRampDuration</span><span>]</span>
<span>-</span><span>[</span><span>CBBrightnessProxySKL</span> <span>commitBrightness</span><span>:]</span>
<span>-</span><span>[</span><span>CBBrightnessProxySKL</span> <span>initWithSLSBrightnessControl</span><span>:]</span>
<span>-</span><span>[</span><span>CBBrightnessProxySKL</span> <span>setAmbient</span><span>:]</span>
<span>-</span><span>[</span><span>CBBrightnessProxySKL</span> <span>setBrightnessLimit</span><span>:]</span>
<span>-</span><span>[</span><span>CBBrightnessProxySKL</span> <span>setHeadroom</span><span>:]</span>
<span>-</span><span>[</span><span>CBBrightnessProxySKL</span> <span>setNotificationQueue</span><span>:]</span>
<span>-</span><span>[</span><span>CBBrightnessProxySKL</span> <span>setPotentialHeadroom</span><span>:]</span>
<span>-</span><span>[</span><span>CBBrightnessProxySKL</span> <span>setSDRBrightness</span><span>:]</span>
<span>-</span><span>[</span><span>CBBrightnessProxySKL</span> <span>setWhitePoint</span><span>:</span><span>rampDuration</span><span>:</span><span>error</span><span>:]</span>
<span>-</span><span>[</span><span>CBBrightnessProxySKL</span> <span>unregisterNotificationBlocks</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>configureEDRSecPerStop</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>configurePCCDefaults</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>getBrightnessLimit</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>getDynamicSliderAdjustedNits</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>getDynamicSliderAdjustedSDRNits</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>getLinearBrightnessForNits</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>getLinearBrightness</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>getMaxNitsAdjusted</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>getMaxNitsEDR</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>getMaxPanelNits</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>getNitsForLinearBrightness</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>getNitsForUserBrightness</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>getPerceptualBrightness</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>getSDRBrightnessCurrent</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>getSDRBrightnessTarget</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>getSDRNitsCapped</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>getUserBrightnessForNits</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>getUserBrightnessSloperExtended</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>getUserBrightness</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>handleBrightnessCapOverride</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>initialiseEDR</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>initialiseSDR</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>luminanceToPerceptual</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>panelMaxNitsOverride</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>perceptualToLuminance</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>rampDynamicSlider</span><span>:</span><span>withLength</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>rampEDRHedroom</span><span>:</span><span>withLength</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>rampFactor</span><span>:</span><span>withLength</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>rampManagerUpdateHandling</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>rampNitsCap</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>rampSDRBrightness</span><span>:</span><span>withLength</span><span>:</span><span>properties</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>requestEDRHeadroomImmediate</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>requestEDRHeadroomTransition</span><span>:</span><span>withLength</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>requestEDRHeadroomTransitionStop</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>requestFactorImmediate</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>requestFactorTransition</span><span>:</span><span>withLength</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>requestFactorTransitionStop</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>requestSDRBrightnessTransition</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>requestSDRBrightnessTransition</span><span>:</span><span>withLength</span><span>:</span><span>properties</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>requestSDRBrightnessTransitionStop</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>supportsDynamicSlider</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>supportsEDR</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>supportsSDRBrightness</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>updateAmbient</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>updateAutoBrightnessState</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>updateBrightnessState</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>updateContrastEnhancerState</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>updateDynamicSliderAmbient</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>updateDynamicSliderAutoBrightness</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>updateDynamicSliderChargerState</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>updateDynamicSliderScaler</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>updateEDRAmbient</span><span>]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>updateSDRBrightness</span><span>:]</span>
<span>-</span><span>[</span><span>CBDisplayModuleSKL</span> <span>updateSDRNits</span><span>:]</span>
<span>-</span><span>[</span><span>CBEDR</span> <span>appliedCompensation</span><span>]</span>
<span>-</span><span>[</span><span>CBEDR</span> <span>availableHeadroom</span><span>]</span>
<span>-</span><span>[</span><span>CBEDR</span> <span>brightnessCap</span><span>]</span>
<span>-</span><span>[</span><span>CBEDR</span> <span>cappedHeadroomFromUncapped</span><span>:]</span>
<span>-</span><span>[</span><span>CBEDR</span> <span>copyStatusInfo</span><span>]</span>
<span>-</span><span>[</span><span>CBEDR</span> <span>description</span><span>]</span>
<span>-</span><span>[</span><span>CBEDR</span> <span>initWithRampPolicy</span><span>:</span><span>potentialHeadroom</span><span>:</span><span>andReferenceHeadroom</span><span>:]</span>
<span>-</span><span>[</span><span>CBEDR</span> <span>maxHeadroom</span><span>]</span>
<span>-</span><span>[</span><span>CBEDR</span> <span>panelMax</span><span>]</span>
<span>-</span><span>[</span><span>CBEDR</span> <span>referenceHeadroom</span><span>]</span>
<span>-</span><span>[</span><span>CBEDR</span> <span>sanityCheck</span><span>]</span>
<span>-</span><span>[</span><span>CBEDR</span> <span>sdrBrightness</span><span>]</span>
<span>-</span><span>[</span><span>CBEDR</span> <span>secondsPerStop</span><span>]</span>
<span>-</span><span>[</span><span>CBEDR</span> <span>setAppliedCompensation</span><span>:]</span>
<span>-</span><span>[</span><span>CBEDR</span> <span>setBrightnessCap</span><span>:]</span>
<span>-</span><span>[</span><span>CBEDR</span> <span>setPanelMax</span><span>:]</span>
<span>-</span><span>[</span><span>CBEDR</span> <span>setSdrBrightness</span><span>:]</span>
<span>-</span><span>[</span><span>CBEDR</span> <span>setSecondsPerStop</span><span>:]</span>
<span>-</span><span>[</span><span>CBEDR</span> <span>shouldUpdateEDRForRequestedHeadroom</span><span>:</span><span>targetHeadroom</span><span>:</span><span>rampTime</span><span>:]</span>
<span>-</span><span>[</span><span>CBEDR</span> <span>stopsFromHeadroomRatio</span><span>:]</span>
<span>-</span><span>[</span><span>CBNVRAM</span> <span>backlightNitsDefault</span><span>]</span>
<span>-</span><span>[</span><span>CBNVRAM</span> <span>backlightNitsMax</span><span>]</span>
<span>-</span><span>[</span><span>CBNVRAM</span> <span>backlightNitsMin</span><span>]</span>
<span>-</span><span>[</span><span>CBNVRAM</span> <span>dealloc</span><span>]</span>
<span>-</span><span>[</span><span>CBNVRAM</span> <span>init</span><span>]</span>
<span>-</span><span>[</span><span>CBNVRAM</span> <span>readBacklightNits</span><span>]</span>
<span>-</span><span>[</span><span>CBNVRAM</span> <span>setBacklightNitsMax</span><span>:]</span>
<span>-</span><span>[</span><span>CBNVRAM</span> <span>writeBacklightNits</span><span>:]</span>
</code></pre></td></tr></tbody></table>
</div>
</div><h3 id="skylight"><a href="#skylight">#</a> SkyLight</h3>
<p>I knew from previous work on window management that the <code>SkyLight</code> framework is closely related to the WindowServer so I took a look at that too.</p>
<p>SkyLight exports a lot of symbols, and fortunately I had a good example on how to use them inside <a href="https://github.com/koekeishiya/yabai/blob/master/src/misc/extern.h">yabai</a>, a macOS window manager similar to i3 and bspwm.</p>
<p>But again, nothing useful is exported.</p>










<picture>
  
    
    
    
      <source sizes="(min-width: 60em) 90%, 90vw" srcset="/images/skylight-symbols/1920_skylight-symbols.webp 1920w,/images/skylight-symbols/1280_skylight-symbols.webp 1280w,/images/skylight-symbols/1024_skylight-symbols.webp 1024w,/images/skylight-symbols/768_skylight-symbols.webp 768w,/images/skylight-symbols/640_skylight-symbols.webp 640w,/images/skylight-symbols/320_skylight-symbols.webp 320w" type="image/webp"/>
    
    <source sizes="(min-width: 60em) 90%, 90vw" srcset="/images/skylight-symbols/1920_skylight-symbols.png 1920w,/images/skylight-symbols/1280_skylight-symbols.png 1280w,/images/skylight-symbols/1024_skylight-symbols.png 1024w,/images/skylight-symbols/768_skylight-symbols.png 768w,/images/skylight-symbols/640_skylight-symbols.png 640w,/images/skylight-symbols/320_skylight-symbols.png 320w"/>
  
  <img src="https://jesseevers.com/images/skylight-symbols/skylight-symbols.png" alt="Searching for nits in SkyLight"/>
</picture>

<p>The function <code>kSLSBrightnessRequestEDRHeadroom</code> seemed promising but I always got a <code>SIGBUS</code> when trying to call it. I can’t find its implementation so I don’t know what parameters I should pass. I just guessed the first one could be a display ID.</p>
<div><div>
<table><tbody><tr><td>
<pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span></code></pre></td>
<td>
<pre tabindex="0"><code data-lang="objc"><span>@</span><span>import</span> <span>Darwin</span><span>;</span>
<span>@</span><span>import</span> <span>Foundation</span><span>;</span>

<span>// clang -fmodules -F/System/Library/PrivateFrameworks -framework SkyLight -o headroom headroom.m &amp;&amp; ./headroom
</span><span></span>
<span>extern</span> <span>int</span> <span>SLSMainConnectionID</span><span>(</span><span>void</span><span>);</span>
<span>extern</span> <span>CFTypeRef</span> <span>SLSDisplayGetCurrentHeadroom</span><span>(</span><span>int</span> <span>did</span><span>);</span>
<span>extern</span> <span>void</span> <span>kSLSBrightnessRequestEDRHeadroom</span><span>(</span><span>int</span> <span>did</span><span>,</span> <span>CFTypeRef</span> <span>headroom</span><span>);</span>

<span>const</span> <span>int</span> <span>MAIN_DISPLAY_ID</span> <span>=</span> <span>1</span><span>;</span>

<span>int</span> <span>main</span><span>(</span><span>int</span> <span>argc</span><span>,</span> <span>char</span><span>**</span> <span>argv</span><span>)</span>
<span>{</span>
    <span>int</span> <span>cid</span> <span>=</span> <span>SLSMainConnectionID</span><span>();</span>
    <span>NSLog</span><span>(</span><span>@&#34;SLSMainConnectionID: %d&#34;</span><span>,</span> <span>cid</span><span>);</span>

    <span>CFTypeRef</span> <span>headroom</span> <span>=</span> <span>SLSDisplayGetCurrentHeadroom</span><span>(</span><span>MAIN_DISPLAY_ID</span><span>);</span>
    <span>kSLSBrightnessRequestEDRHeadroom</span><span>(</span><span>MAIN_DISPLAY_ID</span><span>,</span> <span>headroom</span><span>);</span>

    <span>return</span> <span>0</span><span>;</span>
<span>}</span>
</code></pre></td></tr></tbody></table>
</div>
</div><h2 id="other-ideas"><a href="#other-ideas">#</a> Other ideas</h2>
<h3 id="streaming-to-a-dummy"><a href="#streaming-to-a-dummy">#</a> Streaming to a dummy</h3>
<p>While discussing this matter with István Tóth, the developer of <a href="https://github.com/waydabber/BetterDummy/">BetterDummy</a>, he came up with an interesting idea.</p>
<ol>
<li>Create a <code>CGVirtualDisplay</code> with the same size as the built-in display</li>
<li>Tone map the SDR contents of the built-in display to 1000nits HDR video</li>
<li><code>CGDisplayStream</code> that video to the virtual display</li>
<li>Move the virtual display to the built-in display coordinates and use that as the main display</li>
</ol>
<p>The streaming part already works in the <a href="https://github.com/waydabber/BetterDummy/releases/tag/v1.1.0-beta1">latest Beta of BetterDummy</a> and seems pretty fast as well. But adding tone mapping might cause this to be too resource intensive to be used.</p>
<h3 id="using-private-symbols"><a href="#using-private-symbols">#</a> Using private symbols</h3>
<p>I think linking can be done against private symbols using memory offsets, I remember doing something like that 8 years ago at BitDefender, while trying to use the unexported <code>_decrypt</code> and <code>_generate_domain</code> methods of some DGA malware.</p>
<p>But the <code>dyld_shared_cache</code> model of macOS is something new to me and I don’t have enough knowledge to be able to do that right now.</p>
<p>If someone has any idea how this can be achieved, I’d be glad if you could send me a hint through the <a href="https://jesseevers.com/contact">Contact page</a>.</p>

        
        <details closed="">
  <dl>
    <dt>Posted on:</dt>
    <dd>February 4, 2022</dd>
  </dl>
  <dl>
    <dt>Length:</dt>
    <dd>10 minute read, 2018 words</dd>
  </dl>
  
  <dl>
    <dt>Categories:</dt>
    <dd> <a href="https://alinpanaitiu.com/categories/macos-reverse-engineering">macOS reverse engineering</a> </dd>
  </dl>
  
  
  
  <dl>
    <dt>Tags:</dt>
    <dd> <a href="https://alinpanaitiu.com/tags/macbook">macbook</a>  <a href="https://alinpanaitiu.com/tags/macbook-pro">macbook pro</a>  <a href="https://alinpanaitiu.com/tags/nits">nits</a>  <a href="https://alinpanaitiu.com/tags/nits-limit">nits limit</a>  <a href="https://alinpanaitiu.com/tags/hdr">hdr</a>  <a href="https://alinpanaitiu.com/tags/maximum-brightness">maximum brightness</a>  <a href="https://alinpanaitiu.com/tags/lunar">lunar</a> </dd>
  </dl>
  
  <dl>
    <dt>See Also:</dt>
    
    <dd><a href="https://jesseevers.com/blog/apps-outside-app-store/">Why aren&#39;t the most useful Mac apps on the App Store?</a></dd>
    
    <dd><a href="https://jesseevers.com/blog/journey-to-ddc-on-m1-macs/">The journey to controlling external monitors on M1 Macs</a></dd>
    
  </dl>
</details>

      </section>
      
    </article>
    
  </section>
</main>

      </div></div>
  </body>
</html>
