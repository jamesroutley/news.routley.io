<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://bdash.net.nz/posts/tcc-and-the-platform-sandbox-policy/">Original</a>
    <h1>TCC and the macOS Platform Sandbox Policy</h1>
    
    <div id="readability-page-1" class="page"><article>
    

<section>
  
    
  <article>
<h2 id="what-is-tcc">What is TCC?</h2>
<p>TCC is a subsystem on macOS that is responsible for managing which applications
a user has permitted to access certain resources. Its full name is
&#34;Transparency, Consent and Control&#34;. If you&#39;ve ever seen an <em>&#34;Application&#34; would
like to access the camera</em>  prompt… that&#39;s TCC.</p>
<p>TCC is used to gate access to resources that Apple considers to be sensitive. Protected
resources include:</p>
<ul>
<li>Hardware devices such as the camera and microphone</li>
<li>Location services</li>
<li>A user&#39;s photos, contacts, calendar, or reminders</li>
<li>Files in a user&#39;s desktop, downloads or documents folders</li>
<li>Data managed by other third-party applications</li>
</ul>
<p>TCC permissions are mediated by the <code>tccd</code> process that runs as part of macOS.
System frameworks that access sensitive resources use private APIs, such as
<code>TCCAccessRequest</code> to determine whether they have permission to access the
resource. The API performs an interprocess call to <code>tccd</code>, which will trigger a
prompt if it is the first time the application has attempted to access that
class of resource. Otherwise, it will return the stored permission decision.</p>
<h2 id="what-is-the-platform-sandbox-policy">What is the Platform Sandbox Policy?</h2>
<p>For background about what sandboxing is on macOS and how it works, see
<a href="https://bdash.net.nz/posts/sandboxing-on-macos/">Sandboxing on macOS</a>.</p>
<p>The Platform Sandbox Policy is a sandbox policy that is applied to all processes
running on macOS. It is applied transparently to all processes on the system,
irrespective of whether they are explicitly sandboxed.</p>
<p>The Platform Sandbox Policy implements one part of System Integrity Protection
on macOS. It defines and enforces the restrictions on access to the file system,
Mach bootstrap names, IOKit devices, and other resources. Amongst other
things, the platform sandbox policy uses process attributes (such as signing
identity, bundle identifier, and entitlements) to allow specific applications to
bypass restrictions that System Integrity Protection would typically apply to
them. This allows applications that are part of macOS to provide system
functionality, such as app installation and software updates, that would
otherwise be prohibited by System Integrity Protection.</p>

<p>One aspect of TCC that most existing analyses of it miss is that the Platform
Sandbox Policy also backstops TCC.  The sandbox kernel extension supports
triggering TCC prompts when a program accesses specific resources, rather than
being limited to merely allowing or denying the access, and the platform sandbox
policy makes use of this facility</p>
<p>Specifically, <code>allow</code> actions in the platform sandbox policy can have a <code>(with user-approval &#34;&lt;type&gt;&#34;)</code> modifier attached to them. This triggers an up-call
from the Sandbox kernel extension to the <code>sandboxd</code> user-space helper asking for
TCC approval of the specified type.  <code>sandboxd</code> translates this into a call to
<code>tccd</code>, much like a system framework using <code>TCCAccessRequest</code> to verify
that the calling application is permitted to access a given resource.</p>
<h2 id="a-simple-example">A &#34;simple&#34; example</h2>
<p>Access to the computer&#39;s camera is gated behind the <code>kTCCServiceCamera</code> TCC
policy.  Frameworks that provide access to the camera, such as AVFoundation,
explicitly call <code>TCCAccessRequest(kTCCServiceCamera, …)</code> to ensure that the
application is permitted to access the camera. But as the camera is a hardware
device, a sufficiently motivated application could access it directly via the
IOKit framework. To safeguard against this, the Platform Sandbox Profile has a
policy in place for <code>iokit-open-user-client</code> operations that will trigger a TCC
prompt if a camera device is accessed directly via IOKit:</p>
<pre data-lang="scm"><code data-lang="scm"><span><span><span>(</span>allow iokit<span>-</span><span>open</span><span>-</span>user<span>-</span>client
</span></span><span><span>  <span><span>(</span><span>with</span> user<span>-</span>approval <span><span>&#34;</span>kTCCServiceCamera<span>&#34;</span></span><span>)</span></span>
</span></span><span><span>  <span><span>(</span><span>require</span><span>-</span>all
</span></span></span><span><span><span>    <span><span>(</span>process<span>-</span>attribute is<span>-</span>sandcastle<span>-</span>constrained<span>)</span></span>
</span></span></span><span><span><span>    <span><span>(</span><span>require</span><span>-</span>any
</span></span></span></span><span><span><span><span>      <span><span>(</span><span>require</span><span>-</span>all
</span></span></span></span></span><span><span><span><span><span>        <span><span>(</span>iokit<span>-</span>registry<span>-</span>entry<span>-</span>class <span><span>&#34;</span>IOFireWireAVCUserClient<span>&#34;</span></span><span>)</span></span>
</span></span></span></span></span><span><span><span><span><span>        <span><span>(</span><span>require</span><span>-</span>any
</span></span></span></span></span></span><span><span><span><span><span><span>          <span><span>(</span><span>require</span><span>-</span><span>not</span>
</span></span></span></span></span></span></span><span><span><span><span><span><span><span>            <span><span>(</span>signing<span>-</span>identifier <span><span>&#34;</span>com.apple.AVCAssistant<span>&#34;</span></span><span>)</span></span><span>)</span></span>
</span></span></span></span></span></span><span><span><span><span><span><span>          <span><span>(</span><span>require</span><span>-</span><span>not</span>
</span></span></span></span></span></span></span><span><span><span><span><span><span><span>            <span><span>(</span>process<span>-</span>attribute is<span>-</span>platform<span>-</span>binary<span>)</span></span><span>)</span></span><span>)</span></span><span>)</span></span>
</span></span></span></span><span><span><span><span>      <span><span>(</span><span>require</span><span>-</span>all
</span></span></span></span></span><span><span><span><span><span>        <span><span>(</span>iokit<span>-</span>registry<span>-</span>entry<span>-</span>class <span><span>&#34;</span>IOUSBInterfaceUserClientV2<span>&#34;</span></span><span>)</span></span>
</span></span></span></span></span><span><span><span><span><span>        <span><span>(</span>iokit<span>-</span>usb<span>-</span>interface<span>-</span>class kUSBVideoInterfaceClass<span>)</span></span>
</span></span></span></span></span><span><span><span><span><span>        <span><span>(</span><span>require</span><span>-</span>any
</span></span></span></span></span></span><span><span><span><span><span><span>          <span><span>(</span><span>require</span><span>-</span><span>not</span>
</span></span></span></span></span></span></span><span><span><span><span><span><span><span>            <span><span>(</span>process<span>-</span>attribute is<span>-</span>platform<span>-</span>binary<span>)</span></span><span>)</span></span>
</span></span></span></span></span></span><span><span><span><span><span><span>          <span><span>(</span><span>require</span><span>-</span><span>not</span>
</span></span></span></span></span></span></span><span><span><span><span><span><span><span>            <span><span>(</span>signing<span>-</span>identifier <span><span>&#34;</span>com.apple.VDCAssistant<span>&#34;</span></span><span>)</span></span><span>)</span></span><span>)</span></span><span>)</span></span>
</span></span></span></span><span><span><span><span>      <span><span>(</span><span>require</span><span>-</span>all
</span></span></span></span></span><span><span><span><span><span>        <span><span>(</span><span>require</span><span>-</span><span>not</span>
</span></span></span></span></span></span><span><span><span><span><span><span>          <span><span>(</span>%entitlement<span>-</span>is<span>-</span>bool<span>-</span>true <span><span>&#34;</span>com.apple.camera.iokit-user-access<span>&#34;</span></span><span>)</span></span><span>)</span></span>
</span></span></span></span></span><span><span><span><span><span>        <span><span>(</span>iokit<span>-</span>registry<span>-</span>entry<span>-</span>class <span><span>&#34;</span>AppleCamInUserClient<span>&#34;</span></span><span>)</span></span><span>)</span></span><span>)</span></span><span>)</span></span><span>)</span></span>
</span></code></pre>
<p>This triggers a <code>kTCCServiceCamera</code> prompt for any access to
<code>IOFireWireAVCUserClient</code>, <code>IOUSBInterfaceUserClientV2</code> with class
<code>kUSBVideoInterfaceClass</code>, and <code>AppleCamInUserClient</code>. Platform binaries and
binaries with certain entitlements or identifiers are excluded from the
prompting.</p>
<h2 id="storage-classes">Storage classes</h2>
<p>One of the key attributes used within the Platform Sandbox Policy is the concept
of the <strong>storage class</strong> of a file system object. This is a way of classifying a
given file system object as containing some type of data that may need special
attention.</p>
<p>File system objects are tracked in the sandbox kernel extension as kernel
<code>vnode</code> objects. A given <code>vnode</code> is assigned to exactly one storage class at a
time, though the storage class it is assigned to can change. The sandbox kernel
extension caches the mapping from <code>vnode</code> objects to storage class to avoid
recomputing them. The cache is invalidated in response to certain events
that could cause the mapping to change.</p>
<p>Storage classes are assigned by the Platform Sandbox Policy. The special
<code>storage-class-map</code> sandbox operation is used along with the <code>(with assign-storage-class &#34;&lt;class&gt;&#34;)</code> action modifier to determine which storage
class should be assigned to a given file system object. Within this portion of
the policy, the same filter operations that are applicable to file system
operations are available, along with predicates involving process or system
attributes.</p>
<p>There are around 130 storage classes defined by the Platform Sandbox Policy as
of macOS 15.1. Most of the storage classes describe data as belonging to a
specific application or framework (<code>CloudKit</code>, <code>FaceTime</code>, <code>Safari</code>, and many
others), while a handful correspond directly to TCC policies (for instance,
<code>kTCCServiceAddressBook</code>, <code>kTCCServiceSystemPolicyAppBundles</code>,
<code>kTCCServiceSsytemPolicySysAdminFiles</code>). You can see the <a href="https://gist.github.com/bdash/9a73475ed0676b3a3fed88d21628e6ab#file-storage-classes-scm">complete list of storage classes
here</a>.</p>
<h3 id="tcc-prompting-based-on-storage-classes">TCC prompting based on storage classes</h3>
<p>Much like the <code>iokit-open-user-client</code> / <code>kTCCServiceCamera</code> case presented above, file system
operations consider a combination of path, storage class, and process attributes to determine
whether an operation should result in a TCC prompt.</p>
<h3 id="a-sampling-of-storage-classes">A sampling of storage classes</h3>
<h4 id="ktccservicesystempolicynetworkvolumes"><code>kTCCServiceSystemPolicyNetworkVolumes</code></h4>
<pre data-lang="scm"><code data-lang="scm"><span><span><span>(</span>file<span>-</span>attribute local<span>-</span>filesystem<span>)</span></span>
</span></code></pre>
<h4 id="ktccservicesystempolicyappbundles"><code>kTCCServiceSystemPolicyAppBundles</code></h4>
<pre data-lang="scm"><code data-lang="scm"><span><span><span>(</span>file<span>-</span>attribute app<span>-</span>bundle<span>)</span></span>
</span></code></pre>
<h4 id="ktccservicesystempolicydownloadsfolder"><code>kTCCServiceSystemPolicyDownloadsFolder</code></h4>
<pre data-lang="scm"><code data-lang="scm"><span><span><span>(</span>path <span><span>(</span>subpath <span><span>&#34;</span>${any_user_home}/downloads<span>&#34;</span></span><span>)</span></span><span>)</span></span>
</span></code></pre>
<h4 id="ktccservicesystempolicysysadminfiles"><code>kTCCServiceSystemPolicySysAdminFiles</code></h4>
<pre data-lang="scm"><code data-lang="scm"><span><span><span>(</span>path
</span></span><span><span>  <span><span>&#34;</span>/library/application support/apple/remote desktop/remotemanagement.launchd<span>&#34;</span></span>
</span></span><span><span>  <span><span>&#34;</span>/library/preferences/com.apple.security.smartcard.plist<span>&#34;</span></span>
</span></span><span><span>  <span><span>&#34;</span>/library/preferences/directoryservice/directoryservice.plist<span>&#34;</span></span>
</span></span><span><span>  <span><span>&#34;</span>/library/preferences/systemconfiguration/com.apple.smb.server.plist<span>&#34;</span></span>
</span></span><span><span>  <span><span>&#34;</span>/private/etc/auto_home<span>&#34;</span></span>
</span></span><span><span>  <span><span>&#34;</span>/private/etc/auto_master<span>&#34;</span></span>
</span></span><span><span>  <span><span>&#34;</span>/private/etc/autofs.conf<span>&#34;</span></span>
</span></span><span><span>  <span><span>&#34;</span>/private/etc/crontab<span>&#34;</span></span>
</span></span><span><span>  <span><span>&#34;</span>/private/etc/exports<span>&#34;</span></span>
</span></span><span><span>  <span><span>&#34;</span>/private/etc/master.passwd<span>&#34;</span></span>
</span></span><span><span>  <span><span>&#34;</span>/private/etc/passwd<span>&#34;</span></span>
</span></span><span><span>  <span><span>&#34;</span>/private/etc/sudo.conf<span>&#34;</span></span>
</span></span><span><span>  <span><span>&#34;</span>/usr/lib/cron<span>&#34;</span></span>
</span></span><span><span>  <span><span>(</span>prefix <span><span>&#34;</span>/private/etc/rc.<span>&#34;</span></span><span>)</span></span>
</span></span><span><span>  <span><span>(</span>subpath <span><span>&#34;</span>/library/directoryservices/plugins<span>&#34;</span></span><span>)</span></span>
</span></span><span><span>  <span><span>(</span>subpath <span><span>&#34;</span>/library/perl<span>&#34;</span></span><span>)</span></span>
</span></span><span><span>  <span><span>(</span>subpath <span><span>&#34;</span>/library/preferences/logging<span>&#34;</span></span><span>)</span></span>
</span></span><span><span>  <span><span>(</span>subpath <span><span>&#34;</span>/private/etc/pam.d<span>&#34;</span></span><span>)</span></span>
</span></span><span><span>  <span><span>(</span>subpath <span><span>&#34;</span>/private/etc/postfix<span>&#34;</span></span><span>)</span></span>
</span></span><span><span>  <span><span>(</span>subpath <span><span>&#34;</span>/private/var/at<span>&#34;</span></span><span>)</span></span>
</span></span><span><span>  <span><span>(</span>subpath <span><span>&#34;</span>/private/var/db/com.apple.xpc.launchd<span>&#34;</span></span><span>)</span></span><span>)</span></span>
</span></code></pre>
<h4 id="safari"><code>Safari</code></h4>
<pre data-lang="scm"><code data-lang="scm"><span><span><span>(</span>path
</span></span><span><span>  <span><span>(</span>subpath <span><span>&#34;</span>${any_user_home}/library/caches/com.apple.safari<span>&#34;</span></span><span>)</span></span>
</span></span><span><span>  <span><span>(</span>subpath <span><span>&#34;</span>${any_user_home}/library/caches/com.apple.safari.safebrowsing<span>&#34;</span></span><span>)</span></span>
</span></span><span><span>  <span><span>(</span>subpath <span><span>&#34;</span>${any_user_home}/library/caches/com.apple.safaridavclient<span>&#34;</span></span><span>)</span></span>
</span></span><span><span>  <span><span>(</span>subpath <span><span>&#34;</span>${any_user_home}/library/caches/com.apple.safaritechnologypreview<span>&#34;</span></span><span>)</span></span>
</span></span><span><span>  <span><span>(</span>subpath <span><span>&#34;</span>${any_user_home}/library/containers/com.apple.safari<span>&#34;</span></span><span>)</span></span>
</span></span><span><span>  <span><span>(</span>subpath <span><span>&#34;</span>${any_user_home}/library/containers/com.apple.safari.webapp<span>&#34;</span></span><span>)</span></span>
</span></span><span><span>  <span><span>(</span>subpath
</span></span></span><span><span><span>    <span><span>&#34;</span>${any_user_home}/library/containers/com.apple.safaritechnologypreview<span>&#34;</span></span><span>)</span></span>
</span></span><span><span>  <span><span>(</span>subpath <span><span>&#34;</span>${any_user_home}/library/safari<span>&#34;</span></span><span>)</span></span>
</span></span><span><span>  <span><span>(</span>subpath <span><span>&#34;</span>${any_user_home}/library/safaritechnologypreview<span>&#34;</span></span><span>)</span></span><span>)</span></span>
</span></code></pre>
</article>

  
    
  
  
    
</section>
</article></div>
  </body>
</html>
