<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.winstoncooke.com/blog/rotation-based-compression">Original</a>
    <h1>Rotation-Based Compression</h1>
    
    <div id="readability-page-1" class="page"><article><div><p><time datetime="2024-09-23">2024-09-23</time></p><h2 data-svelte-h="svelte-1c47mae">Background</h2> <p data-svelte-h="svelte-sp1ruv">In the late 19th to mid 20th century, the United States Department of Agriculture hired dozens of artists to paint watercolors of every fruit that grows in the United States.
The <a href="https://search.nal.usda.gov/discovery/collectionDiscovery?vid=01NAL_INST:MAIN&amp;collectionId=81279629860007426" rel="nofollow">collection</a> contains 7,497 watercolor paintings, 87 line drawings, and 79 wax models created by approximately 21 artists.
I thought this would make a great set of images to choose a random photo every day to use as my desktop wallpaper.
The entire collection is 59.06 GB in size because the images are stored in archival quality.</p> <p data-svelte-h="svelte-1qigk8l">Right off the bat, I noticed that there are a few images that have to be rotated because their orientation is incorrect.</p> <p><a href="https://imagedelivery.net/ga2MLDZ3d0ln9C7Qw_eDwg/3473cbc1-338b-4484-8bef-6e2aa0ba5000/gallery"><img loading="lazy" src="https://imagedelivery.net/ga2MLDZ3d0ln9C7Qw_eDwg/3473cbc1-338b-4484-8bef-6e2aa0ba5000/public" alt="A watercolor of strawberries." title="Fragaria: Strawberries"/></a></p> <p data-svelte-h="svelte-gvorr4">One such image that required rotation is <a href="https://search.nal.usda.gov/permalink/01NAL_INST/178fopj/alma9916344285407426" rel="nofollow">strawberries</a>, so I went ahead and rotated it.</p> <p><a href="https://imagedelivery.net/ga2MLDZ3d0ln9C7Qw_eDwg/ce996fa6-af3a-4355-58e7-73bdec629000/gallery"><img loading="lazy" src="https://imagedelivery.net/ga2MLDZ3d0ln9C7Qw_eDwg/ce996fa6-af3a-4355-58e7-73bdec629000/public" alt="The strawberries image rotated to the correct orientation." title="Strawberries - Rotated"/></a></p> <p data-svelte-h="svelte-u2ukf8">After rotating the image, I noticed something interesting.
The original image’s file size was 12.67 MB, but the rotated image’s size was only 5.41 MB.
That’s a huge size saving!
And even better, I can’t visually tell the difference.</p> <h2 data-svelte-h="svelte-i7xlay">Image quality</h2> <p data-svelte-h="svelte-197kdv9">I used ImageMagick to compare the qualities:</p> <pre><!-- HTML_TAG_START --><code>identify <span>-format</span> <span>&#34;%Q&#34;</span> POM00000042.jpg
<span>98</span>%</code><!-- HTML_TAG_END --></pre> <pre><!-- HTML_TAG_START --><code>identify <span>-format</span> <span>&#34;%Q&#34;</span> POM00000042-rotated.jpg
<span>93</span>%</code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-xqq43k">Clearly there’s a difference that I don’t notice visually.
This got me wondering what’s going on when Preview rotates an image.
I looked up how Preview rotates images and came across a MacOS tool called <code>sips</code>.</p>  <p data-svelte-h="svelte-1q9ley4">I next ran the direct sips compression command to reduce the original image quality to 93%:</p> <pre><!-- HTML_TAG_START --><code>sips <span>-s</span> formatOptions <span>75</span> POM00000042.jpg</code><!-- HTML_TAG_END --></pre> <p><a href="https://imagedelivery.net/ga2MLDZ3d0ln9C7Qw_eDwg/6cf763b9-b99e-4163-b9ca-c0c7cc794b00/gallery"><img loading="lazy" src="https://imagedelivery.net/ga2MLDZ3d0ln9C7Qw_eDwg/6cf763b9-b99e-4163-b9ca-c0c7cc794b00/public" alt="The strawberries image compressed via sips." title="Strawberries - sips compression"/></a></p> <p data-svelte-h="svelte-1chw9e5">The quality of this image was also 93%, but the size was 6.57 MB, which is larger than the rotated image!</p> <h2 data-svelte-h="svelte-zt8lk3">ImageMagick compression</h2> <p data-svelte-h="svelte-1j4xdws">Next, I wondered what would happen if I used a more mainline tool to compress the image to 93%.
Surely ImageMagick will be the most efficient right?</p> <pre><!-- HTML_TAG_START --><code>magick POM00000042.jpg <span>-quality</span> <span>93</span> POM00000042.jpg</code><!-- HTML_TAG_END --></pre> <p><a href="https://imagedelivery.net/ga2MLDZ3d0ln9C7Qw_eDwg/9c162c6a-8b3f-44f8-9771-4e3f9ddf0300/gallery"><img loading="lazy" src="https://imagedelivery.net/ga2MLDZ3d0ln9C7Qw_eDwg/9c162c6a-8b3f-44f8-9771-4e3f9ddf0300/public" alt="The strawberries image compressed via sips." title="Strawberries - sips compression"/></a></p> <p data-svelte-h="svelte-q6j1fg">The size of this image was 7.01 MB, which is even bigger than <code>sips</code>.
Something must be going on when the image is rotated.
What would happen if we rotated the image 360 degrees to keep it in the same orientation?
Well it turns out using sips to rotate 360 degrees doesn’t do anything, but if you first rotate the file 90 degrees and then rotate it another 270 degrees to return it to its original orientation, the image compresses.</p> <h2 data-svelte-h="svelte-ithv3p">strawberry compression</h2> <p data-svelte-h="svelte-hgy9pg">I wrote a script called <a href="https://github.com/winstonrc/strawberry" rel="nofollow">strawberry</a> that handles this rotation.</p> <p><a href="https://imagedelivery.net/ga2MLDZ3d0ln9C7Qw_eDwg/8d89c711-1789-4a78-a880-1f4adf267b00/gallery"><img loading="lazy" src="https://imagedelivery.net/ga2MLDZ3d0ln9C7Qw_eDwg/8d89c711-1789-4a78-a880-1f4adf267b00/public" alt="The strawberries image compressed via sips." title="Strawberries - sips compression"/></a></p> <p data-svelte-h="svelte-1c9m8l">After rotating the original image in place, the output size was 4.10 MB, which is the smallest file size yet.
That’s a 68% reduction in size, and I still can’t notice the difference!</p> <h2 data-svelte-h="svelte-12ovj34">GIMP comparison</h2> <p data-svelte-h="svelte-iwi0kh">The next step I took was to compare the compressed image with the original image in GIMP to check for differences.
Assuming I correctly made the comparison, GIMP showed that there was no visual difference.
Well that’s pretty great for me.</p> <h2 data-svelte-h="svelte-ecgi9f">Rotating too many times</h2> <p data-svelte-h="svelte-idtkuq">Next I decided to rotate the image 12,500 times for fun.</p> <p><a href="https://imagedelivery.net/ga2MLDZ3d0ln9C7Qw_eDwg/6373de11-f47b-4ea5-9907-95f3d41e8e00/gallery"><img loading="lazy" src="https://imagedelivery.net/ga2MLDZ3d0ln9C7Qw_eDwg/6373de11-f47b-4ea5-9907-95f3d41e8e00/public" alt="The strawberries image compressed via sips." title="Strawberries - sips compression"/></a></p> <p data-svelte-h="svelte-15hl0wv">I think this might provide a hint at what’s going on.
When I compare the difference between this image and the original in GIMP, it now shows a lot of differences.</p> <h2 data-svelte-h="svelte-166pcnc">Thoughts</h2> <p data-svelte-h="svelte-1q55q23">So what’s going on here?
I’m not entirely sure, and this is where my ignorance of JPEG works.
My understanding is that JPEGs don’t have lossless rotation by default, and that is true for <code>sips</code> as well.
There’s a great <a href="https://parametric.press/issue-01/unraveling-the-jpeg/?imageSrc=https://na-st01.ext.exlibrisgroup.com/01NAL_INST/storage/alma/EF/36/0D/3F/A1/B5/08/B1/08/07/9C/02/F0/BD/BC/68/OBJ.jpeg?Expires=1727103492&amp;Signature=CJc9HNhbRZ7dRGZKlF9rbxUaeR4YGgofkeU4sWLqD8OSDkTAbhH0wJPOsWYB-NyeOvabkGwxT89o6mnYUiLX-du1Gq7AHBS-90ebH9X7fwoFIHvUT522oS5fP5xLerD0xQ5Wu~7K5NEXV5Nvji8niCbAzA8QMAuSzYA-m-UO4Jxr9bwd8h3lQsepUBscvS6Vmk-9rTZmguW9IvCTi5n7hq8ex4i6sOgQV7iU704U1a6PTJU3zJIasxpTJjBeEihbD6zfxKUDksiK3Al9QbQZB53ngq0SytB6eq0addSamhjDuv4Kq7u5Ur1w8B1Q52oGQjbDz-7yuYCVy7v0S622Yg__&amp;Key-Pair-Id=APKAJ72OZCZ36VGVASIA" rel="nofollow">article on JPEG</a>, which allowed me to plug in strawberries as an example image.
I believe there’s either some minor compression happening related to the Discrete Cosine Transform or a lossless saving from the Huffman Encoding, but I’m not 100% confident on either option.
Regardless, it seems doing a single rotation compresses the image to a smaller size than direct compression, and I can’t visually perceive the difference.
That’s an absolute win for me.
The final thing I noticed is that this method seems particularly effective on the set of images that are stored in a significantly higher quality than most other JPEGs, so that’s worth considering as well.</p> <p data-svelte-h="svelte-12qpnk4">The original size of the image collection was 59.06 GB.
After compressing them, it dropped down to about 17 GB.
That’s a roughly 70% size reduction!
I wish I could find an answer for what’s going on, but I’m pretty happy with the results.</p></div></article></div>
  </body>
</html>
