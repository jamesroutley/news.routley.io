<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.ryujinx.org/progress-report-november-2022/">Original</a>
    <h1>Ryujinx (Switch Emulator) Update</h1>
    
    <div id="readability-page-1" class="page"><section>
        <p>Wow. What a month. November is not typically this eventful, but sometimes a little spice is exactly what the Doctor ordered.</p><p>LDN being introduced to the number 3, macOS meeting a graphically demanding program, and Ryujinx facing its final adversary… the cardinal direction, North!</p><p>Before that rant goes any further, please check out our remaining and final set of patreon goals. Once more, all the goals are planned to be actioned <em>eventually</em>, although if a sufficient monetary amount is sustained then focus would be shifted to deliver the respective feature in a reasonable timeframe. </p><p><strong>Patreon Goals:</strong></p><p><strong>$2000/month - Texture Packs / Replacement Capabilities</strong> - getting closer!</p><p><strong>$2500/month - One full-time developer</strong> - Not yet met.</p><p><strong>$5000/month - Additional full-time developer</strong> - Not yet met.</p><p>Done reading? Alright, let’s whirl. </p><p><strong>GPU:</strong></p><p>How could this section start with anything other than Pokémon? Our streak of playable day 1 titles continues although not without hitches. Some issues were immediately apparent, both in the graphical and performance department. Firstly, resolution scaling on Vulkan was a tad broken as showcased below:</p><figure><img src="https://i.postimg.cc/vHDWZY3M/01.png" alt="" loading="lazy"/></figure><p>This was isolated to Vulkan and was caused by the <a href="https://github.com/Ryujinx/Ryujinx/pull/3863">SPIR-V scale helpers being unable to find Array textures. </a>With this issue addressed, beaches and lake beds were no longer covered in perpetual grass.</p><figure><img src="https://i.postimg.cc/rFb5dBP4/02.png" alt="" loading="lazy"/></figure><p>The Mesa Radeon Vulkan driver, RADV, was also displaying some rather interesting albeit random behavior where occasionally, on boot the whole screen would be covered in a bright white filter. The Switch will always sample the initial dummy texture as 0 but Ryujinx was not forcing this. By <a href="https://github.com/Ryujinx/Ryujinx/pull/3867">clearing the texture to (0,0,0,0)</a> when on creation, the variability is removed and so is the holy light of purgatory.</p><!--kg-card-begin: html--><figure>
    
    <figcaption></figcaption>
</figure><!--kg-card-end: html--><p>While users with newer graphics cards and Linux users were having all of the fun, owners of Nvidia’s GTX 700 (and even some mobile 900 series) cards were getting no graphical output at all. As with most bugs of this type, we can usually trace them back to an unsupported feature or extension. This time it was the VK_EXT_shader_viewport_index_layer, and its OpenGL equivalent, that needed workarounds. <a href="https://github.com/Ryujinx/Ryujinx/pull/3866">By moving the gl_Layer from vertex to geometry if the GPU doesn’t support the extension</a>, these older cards no longer have any issues rendering as nicely as their younger siblings.</p><p>The final Scarlet/Violet graphical bug fix that was squeezed into November resolved an issue with the Pokémon stats graph, where parts would be completely cut off and fail to render. It turns out that GameFreak, to no one&#39;s surprise, is using extremely dated rendering methods. Polygon topology is used to draw the hexagon but most Vulkan drivers, and a fair few OpenGL drivers, do not support the extensions required anymore. Nvidia does still support GL_POLYGON in compatibility mode but no such equivalent exists in Vulkan. Luckily for us, <a href="https://github.com/Ryujinx/Ryujinx/pull/3932">convex polygons can be identically rendered via a triangle fan</a> (imagine a fan of triangles around a single point) which, as has been stated in previous reports, is a breeze for modern computer graphics renderers.</p><!--kg-card-begin: html--><figure>
    
    <figcaption></figcaption>
</figure><!--kg-card-end: html--><p>To close out our Scarlet &amp; Violet monologue, a<a href="https://github.com/Ryujinx/Ryujinx/pull/3865"> random crash</a> was resolved; but, we still have those pesky performance issues mentioned earlier to talk about. Thankfully, such issues affect more than just these games so we can take a breather from all this Pokémon talk.</p><p>First stop: Pokémon Sword &amp; Shield. What? We managed a quick breath there. Didn’t you?</p><p>Jokes aside, they’re but a couple of games that have seen some rather startling performance improvements this month due to an avalanche of activity in the GPU emulation department. Given how varied and numerous the changes here are, it would be ill-advised to give them individual spotlight for the sake of all our time, but here’s a quick rundown. See the graph a bit further down for a TL;DR.</p><ul><li>A <a href="https://github.com/Ryujinx/Ryujinx/pull/3748">HLE macro for DrawElementsIndirect</a> was implemented. This helps performance in a few titles such as: Monster Hunter Rise, NieR Automata &amp; Pokémon Scarlet/Violet.</li><li><a href="https://github.com/Ryujinx/Ryujinx/pull/3828">Redundant buffer updates no longer trigger updates</a>. Improves performance in Xenoblade titles when using Vulkan by around 25%.</li><li><a href="https://github.com/Ryujinx/Ryujinx/pull/3830">_volatile flag is once again allowed to be set from MultiRegionHandle</a>. Fixes a regression to the performance of Pokémon Sword &amp; Shield when using Vulkan. Once again places Vulkan and OpenGL on-par in performance in these titles.</li><li><a href="https://github.com/Ryujinx/Ryujinx/pull/3847">CB0 accesses have been eliminated when storage buffer accesses are resolved.</a> Improves performance in Xenoblade titles and The Legend of Zelda Link’s Awakening by up to 30%.</li><li><a href="https://github.com/Ryujinx/Ryujinx/pull/3864">Preload command buffers are no longer created outside the render pass on Vulkan</a>. Improves performance by around 15% in Pokémon Scarlet/Violet.</li><li><a href="https://github.com/Ryujinx/Ryujinx/pull/3881">All buffer assignments are now sent simultaneously instead of one at a time.</a> Improves performance in GPU bottlenecked games such as Super Mario Odyssey by around 7%.</li><li><a href="https://github.com/Ryujinx/Ryujinx/pull/3882">Non-prefetch command buffers are now accessed directly.</a> Can improve performance in Super Mario Odyssey and Pokémon Sword &amp; Shield up to 3%.</li><li><a href="https://github.com/Ryujinx/Ryujinx/pull/3883">Locking on the buffer cache has been heavily relaxed.</a> Further improvement to GPU-bound titles such as Super Mario Odyssey by up to 5%.</li></ul><p>That’s a lot of bullet points containing Super Mario Odyssey and Pokémon. Don’t be disappointed though, these are just our developers’ go-to titles to test any GPU thread improvements at the moment due to their relative ease on the CPU-side. Tying all of those together; here is a quick graph of some popular titles’ performance at the start of November vs the start of December:</p><figure><img src="https://i.postimg.cc/vm57w0XV/07.png" alt="" loading="lazy"/></figure><p>The big winners here are the two Pokémon entries with Scarlet/Violet receiving a staggering 81% performance uplift in under two weeks from its release. Even titles with hideous bottlenecks elsewhere, such as The Legend of Zelda: Breath of the Wild, still saw a healthy improvement of around 10%. It’s worth noting that both Xenoblade Chronicles and Sword/Shield were already hitting similar framerates on OpenGL. November has eliminated that gap and allowed both backends to reach new performance heights for any users who may still need to switch between OpenGL and Vulkan. </p><p>Moving away from all those figures and stats onto something a little more visual again, a change was mentioned a couple of months ago that allowed Fate Extella: The Umbral Star to render on OpenGL. We claimed a similar fix for Vulkan was on the way and <a href="https://github.com/Ryujinx/Ryujinx/pull/3723">November indeed provided.</a></p><!--kg-card-begin: html--><figure>
    
    <figcaption></figcaption>
</figure><!--kg-card-end: html--><p>Due to Vulkan needing a little extra work in the form of implementing support for depth-stencil resolve and some changes to texture compatibility rules, Sonic Colours Ultimate also now renders on Intel GPUs using Vulkan. This game already worked for NVIDIA but it seems Intel’s driver is a little more picky.</p><figure><img src="https://i.postimg.cc/bNGtj6ww/10.png" alt="" loading="lazy"/></figure><p>Nights of Azure 2: Bride of the New Moon highlighted a flaw in the way Ryujinx handles instanced draws this month. Originally, we attempted to defer the draw until we could confirm the total instance count which seemed like the safest way to ensure an accurate render. Unfortunately there are rare circumstances, such as in Nights of Azure 2, where a compute dispatch is performed while the draw is still ‘pending’. Thus by the time the draw finally triggered, the state was completely wrong and was causing hard crashes for all GPU vendors. <a href="https://github.com/Ryujinx/Ryujinx/pull/3822">By ensuring all pending draws are forced to complete before any compute dispatches occur</a>, our process holds true even in these niche scenarios.</p><figure><img src="https://i.postimg.cc/wMrRmN0z/11.png" alt="" loading="lazy"/></figure><p>Alongside some minor <a href="https://github.com/Ryujinx/Ryujinx/pull/3829">improvements to the Vulkan pipeline management systems</a>, a long-standing transform feedback bug that was affecting AMD and Intel was finally stamped out. If any users with those GPUs tried to play Xenoblade Chronicles Definitive Edition, the issue would have been immediately apparent:</p><figure><img src="https://i.postimg.cc/rwxRDKW6/12.png" alt="" loading="lazy"/></figure><p>Maybe the grass in the field was a metaphor about GPU drivers all along… Either way it shouldn’t look like that. <a href="https://github.com/Ryujinx/Ryujinx/pull/3832">Making use of the vector outputs</a> in cases like Xenoblade can get around the root of the problem, which is: missing data or data being written to the wrong offset in Intel’s case. Anyway, grass!</p><figure><img src="https://i.postimg.cc/k5C6KqF2/13.png" alt="" loading="lazy"/></figure><p>Do I see some Mystery Dungeon fans out there? Just me…? Well if you’re a Mystery Dungeon fan with an Intel GPU then this month you’re eating well. To render Pokémon Mystery Dungeon: Rescue Team DX in Vulkan, we were making use of OpenGL conventions such as gl_VertexID and gl_InstanceID. While Nvidia and even AMD have sufficient conformance for this to not be an issue, Intel wasn’t so lucky. Vulkan does have equivalents of sorts but they aren’t a direct 1:1 mapping; they add a little more information. <a href="https://github.com/Ryujinx/Ryujinx/pull/3833">By correcting for this divergence</a> and literally subtracting some values, the visual gore is finally a relic of the past.</p><!--kg-card-begin: html--><figure>
    
    <figcaption></figcaption>
</figure><!--kg-card-end: html--><p>Finishing up the improvements to our GPU emulation this month: not <a href="https://github.com/Ryujinx/Ryujinx/pull/3942">one</a> but <a href="https://github.com/Ryujinx/Ryujinx/pull/3943">two</a> crashes were resolved with the second deserving some extra air time, as it removes some extension requirements for MoltenVK and macOS. Regressions in <a href="https://github.com/Ryujinx/Ryujinx/pull/3876">A Hat in Time</a>, <a href="https://github.com/Ryujinx/Ryujinx/pull/3897">Xenoblade Chronicles 3</a> and <a href="https://github.com/Ryujinx/Ryujinx/pull/3872">Super Smash Bros: Ultimate</a> were quickly cleaned up and an interesting <a href="https://github.com/Ryujinx/Ryujinx/pull/3862">little bug in which Super Mario Odyssey could collect 10s of thousands of entries in the buffer cache</a> was resolved!</p><p><strong>Kernel/Services:</strong></p><p>Onwards, toward the black hole that is the Switch kernel and Horizon OS.</p><p>Service HLE maestros of various usernames graced us with a couple of service implementations and cleanups in November, including a rather curious bug in the deserialization process of a sfdnsres (catchy!) service. The old implementation was unable to deserialize AddrInfoSerialized when the addresses were empty, causing a crash. <a href="https://github.com/Ryujinx/Ryujinx/pull/3924">With that scenario covered</a>, a very cool bit of homebrew finally boots!</p><figure><img src="https://i.postimg.cc/bNK2YQZH/16.png" alt="" loading="lazy"/></figure><p>More services of equally memorable names like <a href="https://github.com/Ryujinx/Ryujinx/pull/3841">‘IFriendService: 1 (Cancel)’</a> and <a href="https://github.com/Ryujinx/Ryujinx/pull/3857">‘GetSaveDataSizeMax’</a> were both stubbed, the first of which allows SnowRunner to advance a little further into gameplay before hitting another friend service crash. One step at a time.</p><p>Two of the larger service implementations of <a href="https://github.com/Ryujinx/Ryujinx/pull/3908">audio</a> and <a href="https://github.com/Ryujinx/Ryujinx/pull/3878">filesystem</a> were updated to their firmware 15.0.0 variants with a variety of bug fixes attached. </p><p><a href="https://github.com/Thealexbarney/LibHac">LibHac</a>, the library used for our Switch file system emulation, was also bumped to its newest release which added support for firmware 15.0.0 decryption keys and implemented some new save data services that were introduced in firmware 14.0.0. ‘General system stability improvements to enhance the user&#39;s experience’ are also listed if that floats your boat.</p><p>The spring autumn cleaning continued with fixes to <a href="https://github.com/Ryujinx/Ryujinx/pull/3909">IPsmSession</a>, <a href="https://github.com/Ryujinx/Ryujinx/pull/3647">eventfd logic</a> in the bsd services and even reaching as far as the software keyboard. Seemingly no one had ever noticed that when presented with exotic characters, it simply didn’t know what to do.</p><figure><img src="https://i.postimg.cc/Gm5gmgkg/17.png" alt="" loading="lazy"/></figure><p>Hmmmmmmm, yes. This character is made out of… LEGO? Fear not, this turned out to be a very silly bug where the text displayed was not filtering out unicode control characters before displaying. A unicode control character is basically a character that instructs your computer to do something that, as a user, you don’t need to see, such as enter a word end or new-line. <a href="https://github.com/Ryujinx/Ryujinx/pull/3845">By adding a method to strip the raw unicode output</a> into something we’d expect to see, text like this becomes much more legible.</p><figure><img src="https://i.postimg.cc/6Q4j2VcW/18.png" alt="" loading="lazy"/></figure><p><strong>UI/UX:</strong></p><p>November has seen Avalonia edge closer to the spotlight with <em>a lot</em> of clean-up work and Linux bug fixes. We invested so much faith in it that we exclusively shipped Avalonia for the macOS releases, and other operating systems are mere inches away from following suit. </p><p>The main roadblock thus far has been a couple of Linux-exclusive rendering bugs on the GUI such as dialog boxes and pop-up windows failing to draw. Even worse was that the render window was solid black when using Vulkan, not something we could realistically push out the door when we’re sure most users, even on Linux, would prefer to use Vulkan for that butter-smooth shader compilation.</p><figure><img src="https://i.postimg.cc/262ZCMWV/19.png" alt="" loading="lazy"/></figure><p>Thankfully, the issue was tracked down to the way we <a href="https://github.com/Ryujinx/Ryujinx/pull/3901">initialized the X11 window</a> and, with some back and forth and <a href="https://github.com/Ryujinx/Ryujinx/pull/3902">breaking OpenGL for a bit</a> along the way, everything now works correctly. Although the dialogs were still broken, clearly this wasn’t the same issue.</p><p>The real cause was tracked down to the Avalonia style we’re using called “FluentAvalonia” which is, effectively, Fluent WinUI design and controls ported into Avalonia. We had to open a pull request <a href="https://github.com/amwx/FluentAvalonia/pull/248">to their repo directly</a> to get this issue resolved, but the maintainers over there were gracious enough to get the change merged extremely promptly. All we then had to do was <a href="https://github.com/Ryujinx/Ryujinx/pull/3938">update to the new FluentAvalonia version.</a></p><p>A final boon to any Linux users; Ryujinx can also now <a href="https://github.com/Ryujinx/Ryujinx/pull/3516">boot in Wayland</a> directly, if setting two-hundred environment variables wasn’t to your liking!</p><p>On to more general changes not targeted toward a specific OS: historically we needed a RenderTimer to keep the GUI and game in-sync before the switch back to an embedded window (covered a couple of progress reports ago!). That was still kicking around and was still forcing the GUI to refresh at 60hz no matter your monitor refresh rate. <a href="https://github.com/Ryujinx/Ryujinx/pull/3935">Removing the timer and some other legacy bits-and-bobs</a> now allows the GUI to animate at full refresh rate.</p><p>We took this month to address some quirks with the general user-experience and streamline a few basics of organizing your libraries. The <a href="https://github.com/Ryujinx/Ryujinx/pull/3896">DLC manager has been completely reworked</a> for Avalonia and now features the ability to enable or disable <em>all </em>files that have been added. As anyone who has all of the DLC for Super Smash Bros: Ultimate can tell you, this is a godsend.</p><figure><img src="https://i.postimg.cc/MHqdFCSH/20.png" alt="" loading="lazy"/></figure><p>Just the DLC window? Of course not, it would be fairly stupid to go through all that effort and not give the <a href="https://github.com/Ryujinx/Ryujinx/pull/3898">same treatment to the game update window</a>...although, we can’t let you enable all the update versions at once; we’re told that it would cause some kind of tear in the fabric of the space-time continuum…</p><figure><img src="https://i.postimg.cc/MTksyc3y/21.png" alt="" loading="lazy"/></figure><p>For those that didn’t know, Ryujinx can also be launched completely GUI-lessly from a terminal or command window. This is very useful for frontend launchers or those people with a very particular workflow! Until this month it was impossible to set the preferred graphics backend, OpenGL or Vulkan, when launching a game from the terminal, which was a major annoyance to many who wanted game-specific setups. This was the main focus of a <a href="https://github.com/Ryujinx/Ryujinx/pull/3707">bit of refactoring of the command-line launch process</a> which also reduced some duplicated code to boot. There’s never been a better time to be a keyboard warrior.</p><p>Finally, like exasperated parents, we’ve had to <a href="https://github.com/Ryujinx/Ryujinx/pull/3870">rename the “Expand DRAM size to 6GB”</a> option to not include the words “Expand”, “DRAM” or “6GB”, as faaaaaaarrrr too many of you were enabling it. We place it under ‘HACKS (may cause instability)’, and what do you think 90% of the support requests we got when Scarlet &amp; Violet launched were? Right-o.</p><p>The entire team now has “disable the DRAM expansion” tattooed into the backs of their eyeballs. </p><p><strong>MISC:</strong></p><p>We’re looking at a fairly trivial miscellaneous section this time but with a single, very large, elephant.</p><figure><img src="https://i.postimg.cc/5tmHmTnn/22.png" alt="" loading="lazy"/></figure><p>.NET 7, the latest release of the .NET runtime, was let loose upon the world on November 8th and we, being the cutting edge software project that we are, <a href="https://github.com/Ryujinx/Ryujinx/pull/3795">jumped on it</a> almost instantly. One of the <em>many </em>advantages to developing software in languages that are in active development is that we regularly see new features and performance gains that other people have written for us! In the case of major runtime updates this can be fairly significant. <em>Just </em>the update to the runtime gave us another 6% performance jump in Super Mario Odyssey (part of the jump in the graph above!) and when enabling a new .NET feature called Tiered PGO (TPGO) we saw a very healthy 13% gain over .NET 6.</p><p>TPGO, Tiered Profile Guided Optimization, was the feature that was most interesting to the development team going into .NET 7, as it effectively allows the runtime to optimize common code paths in real-time. This is a bit of an open goal as it required zero changes on Ryujinx’s end and simply provided more performance. What’s not to like?</p><p>Loads of other work in this section revolves around the new tricks we can take advantage of, or old bits we can remove, thanks to both .NET 7 and C#11. <a href="https://github.com/Ryujinx/Ryujinx/pull/3851">New LINQ methods</a>, <a href="https://github.com/Ryujinx/Ryujinx/pull/3852">Random.Shared</a>, <a href="https://github.com/Ryujinx/Ryujinx/pull/3853">ReadOnlySpan</a> and <a href="https://github.com/Ryujinx/Ryujinx/pull/3854">string literals</a> being the main quick additions. </p><p>A significant portion of this report has involved Linux, and we’re finishing the exact same way. Some fresh Fedora installs weren’t symlinking required dependencies so we now<a href="https://github.com/Ryujinx/Ryujinx/pull/3815"> attempt to import those libraries as a fallback.</a> Not content with stopping there, FFmpeg 5.1.x decided to break our video decoding and instead present a green screen.</p><p>Turns out the FFmpeg maintainers reverted some AVCodec changes they made in 5.0.x releases and we didn’t get the memo. <a href="https://github.com/Ryujinx/Ryujinx/pull/3816">Adjusting our decoder back to the older format</a> fixes these bugs.</p><!--kg-card-begin: html--><figure>
    
    <figcaption></figcaption>
</figure><!--kg-card-end: html--><p><strong>Closing words:</strong></p><p>If that’s what she wrote, then that is all! This report alone really cannot do the month of November justice. Check out our separate blog posts for both the release of <a href="https://blog.ryujinx.org/introducing-ldn3/">LDN3</a> and our <a href="https://blog.ryujinx.org/the-impossible-port-macos/">world-first macOS port</a>! It’s a phrase that’s been said a lot recently, but there truly never has been a better time to emulate the Switch. </p><p>Once again, it’s the recruitment section of the report! If you know some C#, .NET, 3D-graphics or low-level engineering, you too can help the remainder of 2022 be as smooth and bug-free as possible. If that&#39;s all alchemy &amp; wizardry to you then donating to our <a href="https://www.patreon.com/ryujinx/posts">patreon</a>, or being active in testing and bug-reporting really does help out a bunch.</p><p>Until December, and the New Year!</p><p><em>Image credits: Key (Header image), MutantAura &amp; Ryujinx contributors on Github (Misc images).</em><br/></p>
    </section></div>
  </body>
</html>
