<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://borretti.me/article/nixos-for-the-impatient">Original</a>
    <h1>NixOS for the Impatient</h1>
    
    <div id="readability-page-1" class="page"><article>
    <p><a href="https://nixos.org/">NixOS</a> is a Linux distribution configured using <a href="https://en.wikipedia.org/wiki/Nix_(package_manager)">Nix</a>. It is
declarative, meaning that the entire system state can be defined in a single
<code>.nix</code> file; and reproducible, meaning you can have multiple computers set up
identically.</p>

<p>If this sounds like a bullshit timesink like Arch or Gentoo: it’s not. There was
a time when the idea of spending an afternoon typing cryptsetup incantations
into a terminal would have been appealing. That time is past. I don’t use
distros that lack a graphical installer (running <code>fdisk</code> is frankly beneath my
dignity) or that require extensive maintenance. I’m not building my own kernel
with some bespoke set of paranoid <code>CFLAGS</code>. I just want something that works.</p>

<p>NixOS works. It actually works great.</p>

<p>This post is about how I set up NixOS. I don’t know Nix best practices and
haven’t the time to learn, what I know is my setup works and is easy to
understand, and that’s good enough at present.</p>



<ol>
  <li><a href="#started">Getting Started</a>
    <ol>
      <li><a href="#install">Installation</a></li>
      <li><a href="#postinstall">Post-Install</a></li>
      <li><a href="#packages">Installing Packages</a></li>
      <li><a href="#dotfiles">Dotfiles</a></li>
      <li><a href="#upgrading">Upgrading</a></li>
    </ol>
  </li>
  <li><a href="#single">A Single-Device Setup</a></li>
  <li><a href="#current">My Current Setup</a></li>
  <li><a href="#comparison">Comparison</a></li>
</ol>



<p>Head over to <a href="https://nixos.org/download.html#nixos-iso">downloads</a> and pick a graphical ISO image.</p>

<h2 id="install">Installation</h2>

<p><img src="http://harihareswara.net/assets/content/nixos-for-the-impatient/nix1.jpg"/></p>

<p>The installer is based on <a href="https://calamares.io/">Calamares</a> and is very user friendly. I want to
highlight two features in particular.</p>

<p>Firstly, a minor thing, timezones are separated from locales. I use
<code>en_US.UTF-8</code> everywhere, but a lot of installers give you some obscure locale
if your timezone is outside the US. Here they are correctly
separated<sup id="fnref:locale" role="doc-noteref"><a href="#fn:locale" rel="footnote">1</a></sup>:</p>

<p><img src="http://harihareswara.net/assets/content/nixos-for-the-impatient/nix2.jpg"/></p>

<p>Secondly, something more important: <a href="https://en.wikipedia.org/wiki/Disk_encryption">full disk encryption</a> is completely
supported out of the box. This is crucial: full disk encryption should be the
default. Some distros like Ubuntu and Debian also support it in the installer,
while others treat this as some exotic edge case, and there might be some
incomplete wiki page that lists the dozens of commands you have to run to set up
<a href="https://en.wikipedia.org/wiki/Linux_Unified_Key_Setup">LUKS</a> manually.</p>

<p><img src="http://harihareswara.net/assets/content/nixos-for-the-impatient/nix3.jpg"/></p>

<p>For my setup I chose to wipe the whole disk (I dual-boot, but have each OS in a
separate disk, which really is the only tractable way to do it), and chose swap
plus hibernation so I can suspend the computer. Another plus here is the full
disk encryption setup, by default, gives you infinite retries if you misspell
the password. I have a long disk encryption password so this is a lifesaver:
with Ubuntu and Debian it was locked at three retries, and I’d regularly fail
that many times and have to hold down the power button to try again, which feels
like smothering the poor laptop.</p>

<p>Other minor things: I chose “allow unfree software” and the <a href="https://elementary.io/">Pantheon
desktop</a> since it’s like a nicer version of old GNOME 2.</p>

<p><strong>Troubleshooting Note:</strong> when you get to the “Partitions” page, make sure the
label on the upper-right hand corner reads “GPT” and not “MBR”. Installing on an
MBR system gives you a severely degraded setup. Fixing this is just a matter of
opening up <a href="https://gparted.org/">GParted</a> (which comes with the installer) and changing the
partition table for the disk, assuming the disk is empty.</p>

<h2 id="postinstall">Post-Install</h2>

<p>A journey of a thousand lightyears begins with a simple step. Let’s take a small
step: changing the hostname.</p>

<p>By default, NixOS’s configuration lives in <code>/etc/nixos</code>. Eventually we will move
this to a more convenient place. There are two files here: <code>configuration.nix</code>
is the main thing we’ll use, and <code>hardware-configuration.nix</code> is generated for
you by the installer.</p>

<p>First, open up the main configuration file:</p>

<div><div><pre><code><span>$ </span><span>sudo </span>nano /etc/nixos/configuration.nix
</code></pre></div></div>

<p>Navigate to <code>networking.hostName</code>. The default value is <code>&#34;nixos&#34;</code>. Change it to
something you like:</p>

<div><div><pre><code><span>networking</span><span>.</span><span>hostName</span> <span>=</span> <span>&#34;sextant&#34;</span>
</code></pre></div></div>

<p>Apply the configuration with:</p>

<div><div><pre><code><span>$ </span><span>sudo </span>nixos-rebuild switch
</code></pre></div></div>

<p>Now, trying to start a new terminal window after changing hostnames might error,
so you have to log out and log back in to observe your new hostname. For most
changes, however, they take effect immediately. How much you have to do depends
on how much you’ve changed: if you’ve updated your <code>.bashrc</code> you’ll have to open
a new terminal, if you’ve updated your window manager config you’ll have to
reboot the window manager, etc.</p>

<p>This is the basic pattern to configuring Nix: you make a change to your config
file, run one command, and the system is updated.</p>

<h2 id="packages">Installing Packages</h2>

<p>There’s two ways to install packages: system-wide and user specific. Open the
<code>configuration.nix</code> file again. System-wide packages go in <code>environmentSystemPackages</code>:</p>

<div><div><pre><code><span>environment</span><span>.</span><span>systemPackages</span> <span>=</span> <span>with</span> <span>pkgs</span><span>;</span> <span>[</span>
    <span>firefox</span>
<span>];</span>
</code></pre></div></div>

<p>User-specific packages go in <code>users.users.$USER.packages</code>:</p>

<div><div><pre><code><span>users</span><span>.</span><span>users</span><span>.</span><span>eudoxia</span><span>.</span><span>packages</span> <span>=</span> <span>with</span> <span>pkgs</span><span>;</span> <span>[</span>
    <span>emacs</span>
<span>];</span>
</code></pre></div></div>

<h2 id="dotfiles">Dotfiles</h2>

<p>To manage our dotfiles we need a Nix plugin called <a href="https://github.com/nix-community/home-manager">Home Manager</a>. Go to
<code>/etc/nixos</code>, create a file <code>home.nix</code>, and write this in:</p>

<div><div><pre><code><span>{</span> <span>config</span><span>,</span> <span>pkgs</span><span>,</span> <span>...</span> <span>}:</span>
<span>let</span>
    <span>home-manager</span> <span>=</span> <span>builtins</span><span>.</span><span>fetchTarball</span> <span>{</span>
        <span>url</span> <span>=</span> <span>&#34;https://github.com/nix-community/home-manager/archive/release-22.11.tar.gz&#34;</span><span>;</span>
        <span>sha256</span> <span>=</span> <span>&#34;1cp2rpprcfl4mjsrsrpfg6278nf05a0mpl3m0snksvdalfmc5si5&#34;</span><span>;</span>
    <span>};</span>
<span>in</span>
<span>{</span>
    <span>imports</span> <span>=</span> <span>[</span>
        <span>(</span><span>import</span> <span>&#34;</span><span>${</span><span>home-manager</span><span>}</span><span>/nixos&#34;</span><span>)</span>
    <span>];</span>

    <span>home-manager</span><span>.</span><span>users</span><span>.</span><span>eudoxia</span> <span>=</span> <span>{</span>
        <span># This should be the same value as `system.stateVersion` in</span>
        <span># your `configuration.nix` file.</span>
        <span>home</span><span>.</span><span>stateVersion</span> <span>=</span> <span>&#34;22.11&#34;</span><span>;</span>
    <span>};</span>
<span>}</span>
</code></pre></div></div>

<p>Now open <code>configuration.nix</code> and add <code>home.nix</code> to the imports:</p>

<div><div><pre><code><span>imports</span> <span>=</span> <span>[</span>
    <span>./hardware-configuration.nix</span>
    <span>./home.nix</span>
<span>];</span>
</code></pre></div></div>

<p>This configuration does nothing but make Home Manager available. Now, the
simplest possible next step: create a <code>.foorc</code> dotfile in the home directory,
with some contents. Open <code>home.nix</code> and under <code>stateVersion</code> add this:</p>

<div><div><pre><code><span>home-manager</span><span>.</span><span>users</span><span>.</span><span>eudoxia</span> <span>=</span> <span>{</span>
    <span># This should be the same value as `system.stateVersion` in</span>
    <span># your `configuration.nix` file.</span>
    <span>home</span><span>.</span><span>stateVersion</span> <span>=</span> <span>&#34;22.11&#34;</span><span>;</span>

    <span>home</span><span>.</span><span>file</span> <span>=</span> <span>{</span>
        <span>&#34;.foorc&#34;</span> <span>=</span> <span>{</span>
            <span>text</span> <span>=</span> <span>&#39;&#39;</span><span>
</span><span>                Hello, world!</span><span>
</span><span>            &#39;&#39;</span><span>;</span>
        <span>};</span>
    <span>};</span>
<span>};</span>
</code></pre></div></div>

<p>Running <code>sudo nixos-rebuild switch</code> you will find a write-protected <code>.foorc</code>
file in your home directory.</p>

<h2 id="upgrading">Upgrading</h2>

<p><em>Added on 2023-06-03</em>.</p>

<p>Recently, <a href="https://nixos.org/blog/announcements.html#nixos-23.05">23.05</a> was released. To upgrade, I first updated my version of Home Manager:</p>

<div><div><pre><code> let
   home-manager = builtins.fetchTarball {
<span>-    url = &#34;https://github.com/nix-community/home-manager/archive/release-22.11.tar.gz&#34;;
-    sha256 = &#34;1cp2rpprcfl4mjsrsrpfg6278nf05a0mpl3m0snksvdalfmc5si5&#34;;
</span><span>+    url = &#34;https://github.com/nix-community/home-manager/archive/release-23.05.tar.gz&#34;;
+    sha256 = &#34;1ixy1bi21nq0dlfzpn72k1gjdm8aq7h84wvl1ysff7lmqc4gi1jf&#34;;
</span>   };
</code></pre></div></div>

<p>Then I ran:</p>

<div><div><pre><code><span>$ </span><span>sudo </span>nix-channel <span>--add</span> https://nixos.org/channels/nixos-23.05 nixos
<span>$ </span><span>sudo </span>nixos-rebuild boot <span>-I</span> nixos-config<span>=</span>path-to-my-config.nix <span>--upgrade</span>
</code></pre></div></div>

<p>I had to remove a few files that were bothering Home Manager, but the error
messages pointed out exactly what to do.</p>



<p>The above instructions are enough to get going. This section describes how to
make the setup a bit more tractable. Specifically, we’re gonna move the
configuration to a git repo and move the dotfiles to files outside the <code>.nix</code>
configuration so they’re not embedded strings.</p>

<p>The first step is to make a folder for the dotfiles:</p>

<div><div><pre><code><span>$ </span><span>mkdir </span>dotfiles
<span>$ </span><span>cd </span>dotfiles
<span>$ </span>git init
</code></pre></div></div>

<p>Then, copy your existing configuration:</p>

<div><div><pre><code><span>$ </span><span>cp</span> /etc/nixos/configuration.nix configuration.nix
<span>$ </span><span>cp</span> /etc/nixos/home.nix home.nix
<span>$ </span><span>cp</span> /etc/nixos/hardware-configuration.nix hardware-configuration.nix
<span>$ </span>git add <span>.</span>
</code></pre></div></div>

<p>For simplicity, add a script that lets you quickly reapply the configuration
without having to remember any Nix-specific commands. I call mine <code>recrank.sh</code>:</p>

<div><div><pre><code><span>#!/usr/bin/env bash</span>

<span>sudo </span>nixos-rebuild switch <span>-I</span> nixos-config<span>=</span>configuration.nix
</code></pre></div></div>

<p>The <code>-I</code> flag tells <code>nixos-rebuild</code> to use the local configuration rather than
the one in <code>/etc/nixos</code>.</p>

<p>Then make a folder for your home directory’s dotfiles:</p>



<p>And copy anything you might need: <code>.bashrc</code>, <code>git</code> configuration, X11 resources,
etc.</p>

<p>Then modify your <code>home.nix</code> to load the dotfiles from the <code>sources/</code>
directory. For example:</p>

<div><div><pre><code><span>home</span><span>.</span><span>file</span> <span>=</span> <span>{</span>
    <span>&#34;.bashrc&#34;</span><span>.</span><span>source</span>            <span>=</span> <span>./sources/bashrc.sh</span><span>&#34;;</span><span>
</span><span>    &#34;</span><span>.emacs.d/init.el</span><span>&#34;.source   = ./sources/init.el;</span><span>
</span><span>    &#34;</span><span>.config/git/config</span><span>&#34;.source = ./sources/gitconfig.txt;</span><span>
</span><span>    &#34;</span><span>.</span><span>Xresources</span><span>&#34;.source        = ./sources/xresources.txt;</span><span>
</span><span>};</span><span>
</span></code></pre></div></div>

<p>Then run the recrank script, and you’ll find your dotfiles in their target
locations. If you want to copy a whole directory of files at once, you can do
something like this:</p>

<div><div><pre><code><span>&#34;.local/bin&#34;</span> <span>=</span> <span>{</span>
    <span>source</span> <span>=</span> <span>./sources/scripts</span><span>;</span>
    <span>recursive</span> <span>=</span> <span>true</span><span>;</span>
<span>};</span>
</code></pre></div></div>

<p>This will create a <code>~/.local/bin</code> directory and copy the contents of
<code>sources/scripts/</code> there.</p>



<p>For an example setup, see my <a href="https://github.com/eudoxia0/dotfiles">dotfiles</a> repo. This setup is shared across my
desktop and laptop, using identical configuration except each one has a
different hostname and hardware configuration. I use <a href="https://syncthing.net/">Syncthing</a>
which automatically syncs my personal files when both computers are on at the
same time.</p>



<p>My <a href="https://github.com/eudoxia0/dotfiles">dotfiles</a> repo is ten years old. Over the years I’ve tried different
schemes for managing them. What I settled on for the longest chunk of time was a
bash script to install software and then copy some source dotfiles to their
destinations. This works well enough, but for two drawbacks:</p>

<ol>
  <li>Sometimes I’d install something by hand and forget to add it to the bootstrap
script.</li>
  <li>Analogously, I’d make a change to a dotfile in its target location, out of
expedience, and forget to apply the change to the corresponding file in the
dotfiles repo.</li>
</ol>

<p>And so the live configuration and my dotfiles would slowly drift over time. When
I ran the bootstrap script, I had no idea whether it would overwrite some key
part of my config I’d forgotten to copy over to the repo.</p>

<p>I tried <a href="https://www.gnu.org/software/stow/">GNU Stow</a>, a “symlink farm” manager, to symlink rather than copy
my dotfiles. So changes made to the live dotfiles automatically update the
repo. But symlinks are brittle: moving the dotfiles directory broke everything.</p>

<p>Nix solves both problems:</p>

<ol>
  <li>I <em>can’t</em> install packages by hand, I can only add them to the Nix
configuration.</li>
  <li>The dotfiles that <code>home-manager</code> creates are write-protected, so I can’t
change them directly, rather, I have to change them in the dotfiles repo and
run the script to apply the changes.</li>
</ol>

<p>In the past, there’d always been something I wasn’t entirely happy about with my
setup. For the first time, I’m entirely satisfied with my system
configuration. Using NixOS has been thoroughly enjoyable.</p>





  </article></div>
  </body>
</html>
