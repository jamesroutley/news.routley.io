<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://rsadowski.de/posts/2025/openbsd-immutable-system-logs/">Original</a>
    <h1>When root meets immutable: OpenBSD chflags vs. log tampering</h1>
    
    <div id="readability-page-1" class="page"><div>
          
<h2>Why ISO 27001 Demands Immutable Logs (Without Actually Saying So) 
    
    
    <span>
        <a href="#why-iso-27001-demands-immutable-logs-without-actually-saying-so" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>ISO 27001 is like that careful lawyer who never says exactly what they mean –
it tells you what needs to be achieved, not how to do it. When it comes to
logging, this is particularly telling: Control A.12.4.2 simply states that
“logging information and logging facilities shall be protected against
tampering and unauthorized access.” Period. How? That’s your problem to solve.</p>
<p>But anyone who’s ever had to investigate a security incident knows the harsh
reality: logs are only as trustworthy as their protection against post-incident
tampering. An attacker who gains root access isn’t going to politely leave
their tracks in the log files – unless they physically can’t alter them
anymore.</p>
<p>Anyone who follows this blog knows I’ve been diving into VFS/FFS code lately,
and during that exploration, I stumbled across SF_APPEND and SF_IMMUTABLE flags
in the kernel source. “IMMUTABLE?” I thought. “What the hack, OpenBSD can do that? Must
be dead code ;)”. Turns out these flags are very much alive and can be
beautifully set using <code>chflags</code>. I started playing around with them in /tmp,
and for days afterward, I’d get a bunch of error messages on every boot
because OpenBSD, as you know, cleans /tmp on startup. I left it like that for a
while – just another quirky reminder of my filesystem experiments.</p>
<p>Then a client I administrate several OpenBSD servers for asked me about ISO
27001 compliance. Suddenly, those “dead” immutable flags didn’t seem so useless
anymore. In fact, they turned out to be exactly what the standard was asking
for, even if it doesn’t explicitly say so.</p>
<p>This is where immutability becomes not just a nice-to-have, but a forensic
necessity. While ISO 27001 never mentions the word “immutable”, it’s
essentially describing exactly that: logs that cannot be modified after they’re
written. This isn’t security theater – it’s about maintaining the integrity of
your audit trail when it matters most.</p>
<p>But there’s a deeper motivation here beyond just checking the compliance box.
If an attacker gains root privileges on your system without you knowing, you
have a massive problem. Your logs might be the only evidence of what happened,
when it happened, and how extensive the breach was. If those logs can be
silently modified or deleted, you’re essentially flying blind during the most
critical moment of your security response.</p>
<p>The following blog post shows one approach to having <strong>secure</strong>,
<strong>root-tamper-proof logs</strong> and archiving them <strong>IMMUTABLE</strong> without any
external system.</p>

<h2>OpenBSD’s Default Logging: Simple but Effective 
    
    
    <span>
        <a href="#openbsds-default-logging-simple-but-effective" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>OpenBSD ships with a straightforward logging configuration that handles most
system events out of the box. The default <code>/etc/syslog.conf</code> follows a clean
separation of concerns:</p>
<pre tabindex="0"><code>*.notice;auth,authpriv,cron,ftp,kern,lpr,mail,user.none	/var/log/messages
kern.debug;syslog,user.info				/var/log/messages
auth.info						/var/log/authlog
authpriv.debug						/var/log/secure
cron.info						/var/cron/log
daemon.info						/var/log/daemon
ftp.info						/var/log/xferlog
lpr.debug						/var/log/lpd-errs
mail.info						/var/log/maillog

# ....
#!doas
#*.*							/var/log/doas
</code></pre><p>This configuration creates a logical hierarchy: general system messages land in
<code>/var/log/messages</code>, while specific services get their own dedicated log files.
Authentication attempts go to <code>/var/log/authlog</code>, privileged operations to
<code>/var/log/secure</code>, and so on.</p>
<p>The beauty of this setup is its predictability. When you need to investigate a
login issue, you know exactly where to look. Mail problems? Check
<code>/var/log/maillog</code>. System crashes? <code>/var/log/messages</code> has your answers.</p>
<p>But here’s where it gets interesting from a security perspective: newsyslog
runs as a root cron job every hour, rotating these logs automatically. A quick
look at <code>/etc/newsyslog.conf</code> shows the rotation schedule:</p>
<pre tabindex="0"><code>/var/cron/log		root:wheel	600  3     10   *     Z
/var/log/authlog	root:wheel	640  7     *    168   Z
/var/log/daemon				640  5     300  *     Z
/var/log/lpd-errs			640  7     10   *     Z
/var/log/maillog			640  7     *    24    Z
/var/log/messages			644  5     300  *     Z
/var/log/secure				600  7     *    168   Z
/var/log/wtmp				644  7     *    $M1D4 B &#34;&#34;
/var/log/xferlog			640  7     250  *     Z
/var/log/pflog				600  3     250  *     ZB &#34;pkill -HUP -u root -U root -t - -x pflogd&#34;
/var/www/logs/access.log		644  4     *    $W0   Z &#34;pkill -USR1 -u root -U root -x httpd&#34;
/var/www/logs/error.log			644  7     250  *     Z &#34;pkill -USR1 -u root -U root -x httpd&#34;
</code></pre><p>While this prevents logs from consuming all available disk space, it also means
that log files are regularly recreated, moved, and compressed. From an
attacker’s perspective, this creates windows of opportunity – not just to
modify logs, but to potentially interfere with the rotation process itself.</p>
<p>Even more concerning: any attacker with root access can simply open the log
files directly and delete specific lines, modify timestamps, or insert false
entries. There’s nothing stopping <code>rm /var/log/authlog</code> or a quick <code>sed -i &#39;/failed login/d&#39; /var/log/secure</code> to clean up those failed authentication
attempts.</p>
<p>This is exactly where the default setup meets its limitations for ISO 27001
compliance. Those hourly rotations and the fact that everything runs as root
means our logs are only as secure as our root access control. And if root is
compromised, well… that’s precisely when we need our logs to be most
trustworthy.</p>

<h2>Understanding chflags: System-Level Immutability 
    
    
    <span>
        <a href="#understanding-chflags-system-level-immutability" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>OpenBSD’s <code>chflags</code> command provides fine-grained control over file attributes at
the filesystem level. According to the manpage, several flags are available,
but for our log protection purposes, we’re particularly interested in:</p>
<ul>
<li><strong>sappnd</strong> - set the system append-only flag (superuser only)</li>
<li><strong>schg</strong> - set the system immutable flag (superuser only)</li>
</ul>
<p>Our strategy is simple: use <strong>sappnd</strong> for active log files that need to grow,
and <strong>schg</strong> for archived logs that should never change.</p>
<p>Let’s see this in action. First, let’s check the current flags on a log file:</p>
<pre tabindex="0"><code>$ ls -lo /var/log/secure
-rw-------  1 root  wheel  - 748935 Jul 16 19:11 /var/log/secure
                          ^^^
</code></pre><p>The <code>-o</code> flag shows us file flags, and we see none are set (the dash after
wheel). Now let’s set the append-only flag:</p>
<pre tabindex="0"><code># chflags sappnd /var/log/secure
# ls -lo /var/log/secure  
-rw-------  1 root  wheel  uappnd 748935 Jul 16 19:11 /var/log/secure
</code></pre><p>Notice something interesting? We set sappnd but see uappnd. That’s because
we’re running as root (the owner), so the system flag becomes a user flag from
our perspective. We could have used uappnd directly with the same result.
The behaviour makes the removal of flags somewhat error-prone.</p>
<p>Now comes the fascinating part. Let’s try to remove this flag as root:</p>
<pre tabindex="0"><code># chflags nosappnd /var/log/secure
chflags: /var/log/secure: Operation not permitted
</code></pre><p>Even root can’t remove it! This is where OpenBSD’s security model shines.
According to the manpage:</p>
<blockquote>
<p>The superuser-settable sappnd and schg flags can be set at any time, but may
only be cleared when the system is running at security level 0 or -1 (insecure
or permanently insecure mode, respectively).  For more information on setting
the system security level, see securelevel(7).</p></blockquote>
<p>This brings <code>securelevel(7)</code> into play – I think the only practical <strong>user-defined
use case</strong> for OpenBSD’s <code>securelevel(7)</code> (All other use cases are not really
useful for the end user). We can only modify these flags in <strong>0 Insecure mode</strong>
where “system file flags may be cleared with chflags(2)”.</p>
<p>Of course, we don’t want to manually boot into single-user mode every time we
need to manage log rotation or we have to remove/modify chflags. Fortunately,
OpenBSD provides <code>/etc/rc.securelevel</code> – commands that run before the security
level changes. This is exactly what we need to automate flag management during
the boot process.</p>

<h2>Complete Setup: Immutable Logging Implementation 
    
    
    <span>
        <a href="#complete-setup-immutable-logging-implementation" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Now let’s put it all together into a complete, production-ready setup.</p>

<h3>Step 1: Disable the hourly newsyslog cron job 
    
    
    <span>
        <a href="#step-1-disable-the-hourly-newsyslog-cron-job" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Since we can’t rotate files with <strong>sappnd</strong> flags through the normal
<code>newsyslog(1)</code> process (append-only means the file can’t be moved or renamed),
we need to disable the automatic rotation:</p>
<div><pre tabindex="0"><code data-lang="sh"><span><span><span># Comment out or remove newsyslog from root&#39;s crontab</span>
</span></span><span><span><span># crontab -e</span>
</span></span></code></pre></div>
<h3>Step 2: Create the log archive directory 
    
    
    <span>
        <a href="#step-2-create-the-log-archive-directory" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>We need a dedicated space for our immutable archived logs: <code>mkdir /var/log/archive</code>.</p>
<p>If you have existing rotated logs, move them to the archive and make them
permanently immutable:</p>
<div><pre tabindex="0"><code data-lang="sh"><span><span><span># mv /var/log/secure.0.* /var/log/archive/</span>
</span></span><span><span><span># chflags -R schg /var/log/archive/</span>
</span></span></code></pre></div><p>If <code>schg</code> is set on these archived files, they become completely immutable -
perfect for long-term forensic preservation.</p>

<h3>Step 3: Set append-only flag on active logs 
    
    
    <span>
        <a href="#step-3-set-append-only-flag-on-active-logs" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Now protect the active log files:</p>
<div><pre tabindex="0"><code data-lang="sh"><span><span><span># chflags sappnd /var/log/secure</span>
</span></span><span><span><span># chflags sappnd /var/log/authlog</span>
</span></span><span><span><span># chflags sappnd /var/log/messages</span>
</span></span><span><span><span># ....</span>
</span></span></code></pre></div>
<h3>Step 4: Create the securelevel script 
    
    
    <span>
        <a href="#step-4-create-the-securelevel-script" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>This is where the magic happens. Create <strong>/etc/rc.securelevel</strong>:</p>
<div><pre tabindex="0"><code data-lang="sh"><span><span><span># touch /etc/rc.securelevel &amp;&amp; chmod 700 /etc/rc.securelevel</span>
</span></span></code></pre></div><p>Write your management script. Here is an example for <code>/var/log/archive</code>.</p>
<div><pre tabindex="0"><code data-lang="sh"><span><span><span>#!/bin/sh
</span></span></span><span><span><span></span><span># Remove append-only and immutable flags</span>
</span></span><span><span>chflags nosappnd /var/log/secure /var/log/authlog /var/log/messages
</span></span><span><span>chflags -R noschg /var/log/archive
</span></span><span><span>
</span></span><span><span><span># Run newsyslog and force log rotation regardless of size/age</span>
</span></span><span><span>newsyslog -F -a /var/log/archive
</span></span><span><span>
</span></span><span><span><span># Restore append-only and immutable flags</span>
</span></span><span><span>chflags sappnd /var/log/secure /var/log/authlog /var/log/messages
</span></span><span><span>chflags -R schg /var/log/archive
</span></span></code></pre></div><p>This script runs during boot before the security level increases, giving us a
brief window to manage our immutable files. It rotates logs into the archive
directory and immediately makes them immutable again.</p>
<p>The beauty of this setup? Once the system reaches normal security level, even
root cannot tamper with these logs without rebooting into single-user mode –
exactly the kind of forensic integrity ISO 27001 demands.</p>

<h2>return 0; 
    
    
    <span>
        <a href="#return-0" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>I hope this post was helpful for anyone facing similar challenges. These flags
aren’t unique to OpenBSD – you’ll find these and additional options in NetBSD
and FreeBSD as well. FreeBSD probably has even cooler solutions for this
problem using ZFS features, and if not, maybe this could serve as inspiration
for someone.</p>
<p>On that note, I’d like to thank the <a href="https://www.bsdnow.tv/" target="_blank">BSDNow podcast</a>
(which I discovered during workouts at the gym) for reading my last blog post
on their show. Thank you!</p>
<p>This implementation provides filesystem-level log protection that satisfies ISO
27001 requirements while leveraging OpenBSD’s built-in security features. No
additional software, no network dependencies – just the kernel enforcing
immutability where it matters most.</p>

          
          
          
        </div></div>
  </body>
</html>
