<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://futhark-lang.org/blog/2022-12-22-literate-audio.html">Original</a>
    <h1>Generating audio with literate futhark</h1>
    
    <div id="readability-page-1" class="page"><div id="content">
      

<p>
    Posted on December 22, 2022
    
        by Philip Munksgaard
    
</p>

<p>Hello, it’s me, <a href="https://munksgaard.me">Philip Munksgaard</a>
<a href="https://futhark-lang.org/blog/2022-11-03-short-circuiting.html">again</a>! Today, I’m here to talk about a
new feature in literate Futhark: <a href="https://github.com/diku-dk/futhark/pull/1810">Audio
support</a>. In short, we have
added a new <code>:audio</code> directive, which let’s you turn an array of signed 8-bit
integers into audio. For details, check out the documentation
<a href="https://futhark.readthedocs.io/en/latest/man/futhark-literate.html#directives">here</a>.
This post is a demonstration of how you can use this functionality to compose
songs in Futhark. By the way, everything you’re reading here is itself a
literate Futhark script, so you can check <a href="https://futhark-lang.org/blog/2022-12-22-literate-audio.fut">the
source</a> if you want to see how it works behind
the scenes. Let’s get started!</p>
<p>Sound is vibrations in the air that are picked up by our ears<a href="#fn1" id="fnref1" role="doc-noteref"><sup>1</sup></a>. Vibrations
can be described using sine-curves. Computers are ultimately discrete in
nature, so in order to produce sound we have to approximate sine-curves using
sampling. Let’s see how that works in practice.</p>
<p>We start by defining some global variables that we’re going to use. First,
the volume which we wish to output at. This should be a value between 0.0
and 1.0.</p>

<p>Then, the output frequency, meaning the number of samples we need to generate
per second.</p>

<p>And the <em>standard pitch</em>. This is an agreed-upon frequency that forms the
base of a particular school of music. For instance, most western music is
based on a 12-tone chromatic scale, centered around the A₄-note, which is
defined to have the frequency 440 Hz. This means that the A₄ can be described
as a sine-curve with 440 periods every second.</p>
<div id="cb3"><pre><code><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span>def</span> standard_pitch = <span>440.0</span>f32</span></code></pre></div>
<p>All other notes in the 12-tone chromatic scale can be defined in terms of the
A₄ note. Notes are divided into octaves, which is why the standard pitch has
that four in it: It is the A-note of the fourth octave. Each octave has 12
tones or notes in it, named A, A#, B, C, C#, D, D#, E, F, F#, G, G#, and each
note in an octave is exactly double or half that of the corresponding note in
the previous or next octave, so the A₅-note has the frequency 880 Hz. The
12-notes in each octave are distributed in such a way that this invariant is
always true.</p>
<p>This function helps us to compute the frequency of different notes based on
the standard pitch. So, for instance, the pitch of the next note up from A₄,
the A#₄-note, is computed by calling <code>pitch 1</code>.</p>
<div id="cb4"><pre><code><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span>def</span> pitch (i: i64): f32 =</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  standard_pitch * <span>2</span> ** (f32.i64 i/<span>12</span>)</span></code></pre></div>
<p>To produce notes we need two things: a pitch and a duration.
If the duration is given in seconds, for instance 0.5 seconds, we need to
turn that into the number of samples resulting in a sound of that length,
given the output frequency.</p>
<div id="cb5"><pre><code><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span>def</span> num_samples (duration: f32): i64 =</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  i64.f32 (f32.i64 output_hz * duration)</span></code></pre></div>
<p>Next, we define the <code>sample</code> function, which takes a pitch and a sample index
in order to generate the frequency of the pitch at that particular point in
time. The result is a number between -1.0 and 1.0 corresponding to the value
of the sine function corresponding to the given pitch at that particular
point in time.</p>
<div id="cb6"><pre><code><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span>def</span> sample (p: f32) (i: i64): f32 =</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  volume * f32.sin (<span>2</span> * f32.pi * f32.i64 i * p / f32.i64 output_hz)</span></code></pre></div>
<p>Now we can define the <code>note</code> function, which samples the frequency for a
particular note for the given duration. This function ties together the pitch
and duration by taking samples of the sine function corresponding to a
particular pitch.</p>
<div id="cb7"><pre><code><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span>def</span> note (i: i64) (duration: f32): []f32 =</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span>let</span> p = pitch i</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span>let</span> n = num_samples duration</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span>in</span> tabulate n (sample p)</span></code></pre></div>
<p>Let’s also make it possible to insert breaks in our compositions.</p>
<div id="cb8"><pre><code><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span>def</span> break (duration: f32): []f32 =</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  replicate (num_samples duration) <span>0.0</span></span></code></pre></div>
<p>Finally, we need a function to turn the samples into signed 8-bit integers,
such that <code>futhark literate</code> can turn that into music.</p>
<div id="cb9"><pre><code><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span>def</span> play [n] (samples: [n]f32): [n]i8 =</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  samples</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  |&gt; map ((*) (f32.i8 i8.highest))</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  |&gt; map i8.f32</span></code></pre></div>
<p>In the spirit of season, let’s use what we have defined so far to compose a
song, inserting breaks and adjusting the length of notes as necessary. Let’s
see if you can recognize it.</p>
<div id="cb10"><pre><code><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span>def</span> seasonal_song =</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span>let</span> c = note <span>3</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span>let</span> d = note <span>5</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span>let</span> e = note <span>7</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span>let</span> g = note <span>10</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span>in</span> e <span>0.3</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>       ++ break <span>0.1</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>       ++ e <span>0.3</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>       ++ break <span>0.1</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>       ++ e <span>0.6</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>       ++ break <span>0.2</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>       ++ e <span>0.3</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>       ++ break <span>0.1</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>       ++ e <span>0.3</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>       ++ break <span>0.1</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>       ++ e <span>0.6</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>       ++ break <span>0.2</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>       ++ e <span>0.3</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>       ++ break <span>0.1</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>       ++ g <span>0.3</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>       ++ break <span>0.1</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>       ++ c <span>0.5</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>       ++ break <span>0.05</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>       ++ d <span>0.15</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>       ++ break <span>0.1</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>       ++ e <span>0.6</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>       |&gt; play</span></code></pre></div>
<pre><code>&gt; :audio seasonal_song</code></pre>
<p><audio src="2022-12-22-literate-audio-img/fd1d071397a89bfa6860eb8286014944-audio.wav" controls=""><a href="https://futhark-lang.org/blog/2022-12-22-literate-audio-img/fd1d071397a89bfa6860eb8286014944-audio.wav">Audio</a></audio></p>
<p>There are plenty of things to improve in our song in particular and the music
framework in general. For instance, it would be nice to get rid of the
popping sound between notes, and at some point we’d like to be able to write
chords (multiple notes played at the same time) and so on, but I think this
is a nice start. There are also plenty of things we can do to improve the
<code>:audio</code> directive in literate Futhark, like specifying a different
frequency, a different output format (currently we generate wave-files) and
support for 32-bit sound. I should also note that I have no real knowledge
about music except for the bits and pieces I’ve read on Wikipedia, so if
anyone more knowledge about music comes along, please let me know about my
mistakes.</p>
<p>Nevertheless, I hope you’ve enjoyed this blog post; I look forward to seeing
what kind of things people come up with using the new audio support. Happy
holidays to everyone!</p>



    </div></div>
  </body>
</html>
