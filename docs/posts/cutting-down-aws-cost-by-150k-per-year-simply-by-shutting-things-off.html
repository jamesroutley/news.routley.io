<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tuananh.net/2024/01/21/cloud-cost-optimization-at-scale-part-1/">Original</a>
    <h1>Cutting down AWS cost by $150k per year simply by shutting things off</h1>
    
    <div id="readability-page-1" class="page"><article>

<h5>
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
<rect x="4" y="5" width="16" height="16" rx="2"></rect>
<line x1="16" y1="3" x2="16" y2="7"></line>
<line x1="8" y1="3" x2="8" y2="7"></line>
<line x1="4" y1="11" x2="20" y2="11"></line>
<rect x="8" y="15" width="2" height="2"></rect>
</svg>
Posted on
January 21, 2024
 • 
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
<circle cx="12" cy="12" r="9"></circle>
<polyline points="12 7 12 12 15 15"></polyline>
</svg>
4 minutes
 •
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
<path d="M3 19a9 9 0 0 1 9 0a9 9 0 0 1 9 0"></path>
<path d="M3 6a9 9 0 0 1 9 0a9 9 0 0 1 9 0"></path>
<line x1="3" y1="6" x2="3" y2="19"></line>
<line x1="12" y1="6" x2="12" y2="19"></line>
<line x1="21" y1="6" x2="21" y2="19"></line>
</svg>
788 words
</h5>
<h2 id="the-best-optimization-is-simply-shutting-things-off">The best optimization is simply shutting things off</h2>
<p>You work from 8am to 8pm. That’s 12 hours. What happened to the rest of the day? You go home. So you shut things down. That’s 50% cost saving right there.</p>
<p>Simple enough right?</p>
<p>Now add the following constraints:</p>
<ul>
<li>Imagine if you have an AWS organization with hundreds of workload accounts. I’ve seen org with over 700 accounts.</li>
<li>Imagine if you want to support resources other than EC2.</li>
<li>Now add Kubernetes to the mix. Now your EC2 VM is being controlled by autoscaling group/cluster autoscaler or karpenter. You can’t simply shut those off. They will be spin up right back.</li>
<li>Your team is small. You cant have them support all the teams within organization. You need a solution that can be dynamic (to support multiple resources, different requirements from different teams,etc..) but also easy enough for other team to operate it themselves.</li>
</ul>
<h2 id="cloud-automation-platform">Cloud Automation Platform</h2>
<p>I was thinking a bigger picture. I want a simple way to automate the whole cloud platform:</p>
<ul>
<li>Automate shutting down resources during off-work hours.</li>
<li>Discover certain event, correcting things</li>
<li>Etc…</li>
</ul>
<p>I like Lambda, Step Functions and EventBridge. Let’s build something out of those.</p>
<p>Here’s what I had in mind initially</p>
<p><img src="https://tuananh.net/img/cloud-automation.png" alt=""/></p>
<p>We changed the design a little bit by instead of assuming role, we just publish an event to the spoke account eventbus. We didn’t want the automation executor to have abilties to assume role everywhere in the org.</p>
<p>With this system in placed, we can do lots of stuff like</p>
<ul>
<li>Whenever an EKS cluster is created within our org, we want to inject some security baseline policies in.</li>
<li>Whenever a Cloudwatch logs group created, we check for certain tag and if one presented, we ship it to a centralized account.</li>
<li>Or we can do stuff like auto-shutdown resources like we want initially at the beginning of the post.</li>
</ul>
<h2 id="the-deployment">The deployment</h2>
<p>Now for this to work, we need to have:</p>
<ul>
<li>(1) a consistent way of deploying stuff into spoke accounts.</li>
<li>(2) We also need a way to protect those resources (this one is actually easy, we can use tag.)</li>
</ul>
<p>As for (1), we are currently using <a href="https://docs.aws.amazon.com/controltower/latest/userguide/aft-overview.html" target="_blank" rel="noopener">AWS AFT</a>
. They have a mechanism for us to define baseline.</p>
<p>Baseline is whatever resources you want to deploy to every accounts within an Organization Unit. Sounds exactly like what we need right.</p>
<p>This kind of “baseline” is kinda like our agents, embeded in every spoke account.</p>
<p>The rest of this is just</p>
<ul>
<li>(1) agent discover stuff, send event to controlplane.</li>
<li>(2) controlplane send command back to spoke account to act accordingly.</li>
</ul>
<p>We built all these with Lambda, Step Functions and EventBridge.</p>
<p>We love EventBridge pattern matching so much we created a small, <a href="https://github.com/tuananh/py-event-ruler" target="_blank" rel="noopener">tiny Python module to be able to test pattern matching locally</a>
.</p>
<h2 id="back-to-the-cloud-cost-optimization-problem">Back to the cloud cost optimization problem</h2>
<p>Now that we have a generic mechanism to automate stuff in our org. Let’s do some $$ saving.</p>
<p>For this specific case, we don’t need our embedded agent to send us anything. We can simply send the “shutdown” command from controlplane.</p>
<p>We have a little database for config customization if needed. This is a small Git repo where owners/operators of those spoke accounts can customize their schedule according to their need.</p>
<p>What they can config is a pattern (EventBridge pattern style) along with what kind resouces to apply and the action accordingly. We also populate some more properties into the pattern payload like</p>
<ul>
<li><code>is_holiday</code>: bool. This one is pre-evaluated with our national public holiday. Users can then use this in their pattern matching. Eg. if holiday, do not turn them on at 8am.</li>
<li><code>day_of_week</code>: Mon, Tue, etc… Users can then use this field to add a rule to turn things on at 8am from Mon to Fri.</li>
<li>and more …</li>
</ul>
<p>Once the agent receives the payload, they will act accordingly. For examples, EC2 will be send to a Lambda function that handle EC2 and RDS will be sent to another Lambda function that handle RDS.
It’s quite easy to add another resouce to the supported list by simply adding more Lambda function handler.</p>
<p>We make this feature an opt-out feature on our non-production OU (Organization Unit). If they want to turn this off for certain resources, they will have to tag those resources accordingly.</p>
<h2 id="the-result">The result</h2>
<p>Our compute (EC2, RDS, etc…) non-production costs reduce by over 70% during off-work hours. We projected to save approx ~150k USD during 1 year (assume that our cost will not grow). It’s a small piece of our cost but we are going to</p>
<p>There are certain workload that are a bit more complicated like Kubernetes I mentioned earlier. Those will be solved next in part 2 of this series. Stay tuned!</p>
</article></div>
  </body>
</html>
