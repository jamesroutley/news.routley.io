<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://shapr.github.io/posts/2023-07-25-android-app-in-haskell.html">Original</a>
    <h1>Android app in Haskell, six months, no previous Android experience</h1>
    
    <div id="readability-page-1" class="page"><div id="content">
            

            <p>
    Posted on July 25, 2023
    
</p>

<p><img src="http://shapr.github.io/images/gapaldur.png"/></p>

<p>We built an <span target="whetstone.private.storage/privatestorage/privatestoragemobile/"><em>open source</em></span> Android app for <a href="https://private.storage">Private Storage</a>, with Haskell, in six months.</p>
<p><img src="http://shapr.github.io/images/psm-front.png"/> <img src="http://shapr.github.io/images/psm-file-list.png"/></p>

<p>When I joined in October 2022, Private Storage had an existing <a href="https://en.wikipedia.org/wiki/Bureau_of_Democracy,_Human_Rights,_and_Labor">grant deadline</a> to ship an Android app by the end of July 2023.
This seemed like the most important thing to do, so we did. We also improved the underlying layers of the tech stack in the process.</p>

<p>I work for <a href="https://private.storage/">Private Storage</a>, a secure file sharing system on top of <a href="https://tahoe-lafs.readthedocs.io/en/latest/about-tahoe.html#what-is-tahoe-lafs">Tahoe-LAFS</a>.</p>

<p>YES! As of &lt;2023-07-25&gt; the app is submitted but not yet through the Google Play Store review process.</p>

<ul>
<li>Shae Erisson, me</li>
<li><a href="https://github.com/exarkun">Jean-Paul Calderone</a> who knows much nix, Python, and now Haskell!</li>
<li><a href="https://flosse.works/">Florian Sesser</a> did css wizardry, I learned much about material.</li>
<li><a href="https://meejah.ca/">Meejah</a> worked on magic wormhole pieces and picked up Haskell as we went.</li>
</ul>

<ul>
<li>We almost always paired, so we all knew the state of the codebase and where we were heading.</li>
<li>When we didn’t understand a thing, we would write a small standalone prototype for that one feature or library to teach ourselves how that worked.</li>
<li>We paid <a href="https://obsidian.systems/">Obsidian Systems</a> for one hour a week to help where we got stuck.</li>
<li>We used <a href="https://nixos.org/">nix</a> for cross compilation and build automation.</li>
<li>We spent several hours a week explicitly teaching each other what we knew.
I really want to put this first in the list, as the culture of being open and teaching was a massive benefit.
We had one hour a week where the Jean-Paul taught nix, one hour a week where I taught beginning Haskell, another hour where I taught advanced Haskell (things I was learning that might help).
We also had two hours a week of explicit scheduled pairing where we all got together and worked on the stickiest problem along the path to shipping.</li>
</ul>
<p>Most software dev jobs I’ve had want me to “do the thing” while spending zero time teaching or training others. I wanted to take the opposite approach and this paid off far more than my already wild hopes.</p>

<p>We used <a href="https://reflex-frp.org/">reflex-frp</a>, meaning the app was a webview component that worked on Android and also on localhost.</p>
<p>First we learned about <a href="http://conal.net/">functional reactive programming</a>, then specifically reflex-frp, then we got a one hour a week contract with Obsidian Systems ( creators of reflex-frp ) where we could ask questions when stuck.</p>

<p>Private Storage is a thin layer on top of <a href="https://github.com/gridsync/gridsync/">gridsync</a>, which is a layer on top of <a href="https://tahoe-lafs.readthedocs.io/en/latest/about-tahoe.html#what-is-tahoe-lafs">Tahoe-LAFS</a>, and it’s almost entirely written in Python.</p>
<p>One of these ingredients, <a href="https://github.com/tahoe-lafs/zfec/">zfec</a>, is a <a href="https://en.wikipedia.org/wiki/Error_correction_code">forward error correction layer</a> that splits your saved file into five pieces, allowing you to recover the data from any three of those pieces.
Tahoe’s ZFEC is a <a href="https://github.com/tahoe-lafs/zfec/blob/master/zfec/fec.c">17 year old C file</a> that compiles to a shared object that dynamically loads into our application.
Jean-Paul figured out the magic to cross compile this shared object to Android. :tada:</p>
<p>I spent eight weeks failing to load the shared object into a Python on Android.</p>
<p>When we hit the point where we could not pay <a href="https://chaquo.com/chaquopy/contact/">anyone</a> to do it for us, I tried Haskell.</p>
<p>I was able to load the shared object into ghci on termux in two days. So we tried building an Android app in Haskell.</p>
<p>Here’s demo code for using Haskell’s foreign function interface from inside GHCi:</p>
<div id="cb1"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span>-- this works great in ghci:</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>foreign <span>import</span> ccall &#34;math.h sin&#34; c_sin :: <span>Double</span> -&gt; <span>Double</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>c_sin <span>1.0</span></span></code></pre></div>
<div id="cb2"><pre><code><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span>{-# LANGUAGE ForeignFunctionInterface #-}</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>Foreign.C.String</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>Foreign.Ptr</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span>data</span> <span>C_Token</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>foreign <span>import</span> ccall &#34;lib.h token_random&#34; tokenRandom :: <span>IO</span> (<span>Ptr</span> <span>C_Token</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>foreign <span>import</span> ccall &#34;lib.h token_encode_base64&#34; tokenEncodeBase64 :: (<span>Ptr</span> <span>C_Token</span>) -&gt; <span>IO</span> <span>CString</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span>do</span> tr <span>&lt;-</span> tokenRandom</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>   btr <span>&lt;-</span> tokenEncodeBase64 tr</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>   res <span>&lt;-</span> peekCAString btr</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>   <span>print</span> res</span></code></pre></div>
<p>This was more work than it seems, I had to install the latest version of termux from the F-Droid store due to changes in Android permissions.</p>
<p>I don’t remember where I got a version of GHC built for termux, but if you want to know, I can check my notes.</p>

<p>Jean-Paul and I had previous Java experience, but didn’t really want to write it in Java if possible.</p>

<p>My previous job was Haskell, Jean-Paul wanted to use Haskell in anger.</p>
<p>In my experience, Haskell is more fun to write than Java or Kotlin.</p>

<p>Using <a href="https://github.com/Genymobile/scrcpy">scrcpy</a> to interact with my phone from my desktop was good for pairing, team demos, and the screenshots in this blog post.</p>

        </div></div>
  </body>
</html>
