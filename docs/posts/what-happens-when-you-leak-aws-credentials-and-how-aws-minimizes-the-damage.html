<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://xebia.com/blog/what-happens-when-you-leak-aws-credentials-and-how-aws-minimizes-the-damage/">Original</a>
    <h1>What happens when you leak AWS credentials and how AWS minimizes the damage</h1>
    
    <div id="readability-page-1" class="page"><div><p>I heard multiple times that AWS scans public GitHub repositories for AWS credentials and informs its users of the leaked credentials.</p><p>So I am curious to see this for myself, so I decided to intentionally leak AWS credentials to a Public GitHub repository. And show you the steps I took and how I got informed about the leaked credentials.</p><p>I created a IAM user in my AWS account named <code>test-user</code> and generated an access key and secret for this user and attached a very limited policy to this user.</p><pre><code>{
    &#34;Version&#34;: &#34;2012-10-17&#34;,
    &#34;Statement&#34;: [
        {
            &#34;Sid&#34;: &#34;ListBucket&#34;,
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Action&#34;: &#34;s3:ListBucket&#34;,
            &#34;Resource&#34;: &#34;arn:aws:s3:::aws-leaked-credentials&#34;
        }
    ]
}
</code></pre><p>I then pushed the AWS access key and secret to GitHub see the commit here: <a href="https://github.com/tiborhercz/aws-leaked-credentials/commit/33b4d387e94e16b1c8b9277056299bdb02de3a4b">Commit: 33b4d387e94e16b1c8b9277056299bdb02de3a4b</a>.</p><p>Very quickly after pushing the credentials to GitHub various things happened which I will show below.</p><h2>Timestamps and events after leaking the credentials to GitHub</h2><p>Here you will find all the events that happened after pushing to GitHub.</p><p><strong>12:33:12</strong> – Pushed the credentials to GitHub</p><p><strong>12:34:19</strong> – The <code>AWSCompromisedKeyQuarantineV2</code> policy is attached to the IAM user <code>test-user</code> by AWS</p><p><strong>12:34:32</strong> – Various List and Describe calls are made using the leaked credentials</p><p><strong>12:35:08</strong> – Received an email from AWS with the subject ‘ACTION REQUIRED: Your AWS Access Key is Exposed for AWS Account 12345678’</p><p>As you can see 1 minute and 7 seconds after leaking the credentials AWS added the <code>AWSCompromisedKeyQuarantineV2</code> policy. Because AWS IAM is eventually consistent the malicious actor was able to perform various API calls even after the <code>AWSCompromisedKeyQuarantineV2</code> policy has been added. Luckily this was short-lived because IAM has little delay for changes to take effect. 2 minutes after leaking the credentials I received an email from AWS informing me of the event and providing instructions on how to secure the account.</p><p>Below you will find detailed information about every event.</p><h2>Policy attached by AWS</h2><p>The <code>AWSCompromisedKeyQuarantineV2</code> is attached to the IAM user <code>test-user</code>. This policy denies the most important actions. But if the leaked credentials have a lot of permissions the malicious actor could still do damage to systems running in the AWS account.</p><p>See the policy below:</p><pre><code>{
  &#34;Version&#34;: &#34;2012-10-17&#34;,
  &#34;Statement&#34;: [
    {
      &#34;Effect&#34;: &#34;Deny&#34;,
      &#34;Action&#34;: [
        &#34;cloudtrail:LookupEvents&#34;,
        &#34;ec2:RequestSpotInstances&#34;,
        &#34;ec2:RunInstances&#34;,
        &#34;ec2:StartInstances&#34;,
        &#34;iam:AddUserToGroup&#34;,
        &#34;iam:AttachGroupPolicy&#34;,
        &#34;iam:AttachRolePolicy&#34;,
        &#34;iam:AttachUserPolicy&#34;,
        &#34;iam:ChangePassword&#34;,
        &#34;iam:CreateAccessKey&#34;,
        &#34;iam:CreateInstanceProfile&#34;,
        &#34;iam:CreateLoginProfile&#34;,
        &#34;iam:CreatePolicyVersion&#34;,
        &#34;iam:CreateRole&#34;,
        &#34;iam:CreateUser&#34;,
        &#34;iam:DetachUserPolicy&#34;,
        &#34;iam:PassRole&#34;,
        &#34;iam:PutGroupPolicy&#34;,
        &#34;iam:PutRolePolicy&#34;,
        &#34;iam:PutUserPermissionsBoundary&#34;,
        &#34;iam:PutUserPolicy&#34;,
        &#34;iam:SetDefaultPolicyVersion&#34;,
        &#34;iam:UpdateAccessKey&#34;,
        &#34;iam:UpdateAccountPasswordPolicy&#34;,
        &#34;iam:UpdateAssumeRolePolicy&#34;,
        &#34;iam:UpdateLoginProfile&#34;,
        &#34;iam:UpdateUser&#34;,
        &#34;lambda:AddLayerVersionPermission&#34;,
        &#34;lambda:AddPermission&#34;,
        &#34;lambda:CreateFunction&#34;,
        &#34;lambda:GetPolicy&#34;,
        &#34;lambda:ListTags&#34;,
        &#34;lambda:PutProvisionedConcurrencyConfig&#34;,
        &#34;lambda:TagResource&#34;,
        &#34;lambda:UntagResource&#34;,
        &#34;lambda:UpdateFunctionCode&#34;,
        &#34;lightsail:Create*&#34;,
        &#34;lightsail:Delete*&#34;,
        &#34;lightsail:DownloadDefaultKeyPair&#34;,
        &#34;lightsail:GetInstanceAccessDetails&#34;,
        &#34;lightsail:Start*&#34;,
        &#34;lightsail:Update*&#34;,
        &#34;organizations:CreateAccount&#34;,
        &#34;organizations:CreateOrganization&#34;,
        &#34;organizations:InviteAccountToOrganization&#34;,
        &#34;s3:DeleteBucket&#34;,
        &#34;s3:DeleteObject&#34;,
        &#34;s3:DeleteObjectVersion&#34;,
        &#34;s3:PutLifecycleConfiguration&#34;,
        &#34;s3:PutBucketAcl&#34;,
        &#34;s3:PutBucketOwnershipControls&#34;,
        &#34;s3:DeleteBucketPolicy&#34;,
        &#34;s3:ObjectOwnerOverrideToBucketOwner&#34;,
        &#34;s3:PutAccountPublicAccessBlock&#34;,
        &#34;s3:PutBucketPolicy&#34;,
        &#34;s3:ListAllMyBuckets&#34;,
        &#34;ec2:PurchaseReservedInstancesOffering&#34;,
        &#34;ec2:AcceptReservedInstancesExchangeQuote&#34;,
        &#34;ec2:CreateReservedInstancesListing&#34;,
        &#34;savingsplans:CreateSavingsPlan&#34;
      ],
      &#34;Resource&#34;: [
        &#34;*&#34;
      ]
    }
  ]
}
</code></pre><h3>CloudTrail event</h3><p>In the us-east-1 CloudTrail logs you can see that a <code>AttachUserPolicy</code> API call is made to attach the <code>AWSCompromisedKeyQuarantineV2</code> policy. In the event record it clearly states that this has been invoked by AWS <code>&#34;invokedBy&#34;: &#34;AWS Internal&#34;</code>.</p><p>CloudTrail event:</p><pre><code>{
    &#34;eventVersion&#34;: &#34;1.08&#34;,
    &#34;userIdentity&#34;: {
        &#34;type&#34;: &#34;IAMUser&#34;,
        &#34;principalId&#34;: &#34;AIDAxxxxxxxxx&#34;,
        &#34;arn&#34;: &#34;arn:aws:iam::xxxxxxxxx:user/test-user&#34;,
        &#34;accountId&#34;: &#34;xxxxxxxxx&#34;,
        &#34;accessKeyId&#34;: &#34;ASIAxxxxxxxxx&#34;,
        &#34;userName&#34;: &#34;test-user&#34;,
        &#34;sessionContext&#34;: {
            &#34;sessionIssuer&#34;: {},
            &#34;webIdFederationData&#34;: {},
            &#34;attributes&#34;: {
                &#34;creationDate&#34;: &#34;2023-03-21T11:34:19Z&#34;,
                &#34;mfaAuthenticated&#34;: &#34;false&#34;
            }
        },
        &#34;invokedBy&#34;: &#34;AWS Internal&#34;
    },
    &#34;eventTime&#34;: &#34;2023-03-21T11:34:19Z&#34;,
    &#34;eventSource&#34;: &#34;iam.amazonaws.com&#34;,
    &#34;eventName&#34;: &#34;AttachUserPolicy&#34;,
    &#34;awsRegion&#34;: &#34;us-east-1&#34;,
    &#34;sourceIPAddress&#34;: &#34;AWS Internal&#34;,
    &#34;userAgent&#34;: &#34;AWS Internal&#34;,
    &#34;requestParameters&#34;: {
        &#34;userName&#34;: &#34;test-user&#34;,
        &#34;policyArn&#34;: &#34;arn:aws:iam::aws:policy/AWSCompromisedKeyQuarantineV2&#34;
    },
    &#34;responseElements&#34;: null,
    &#34;requestID&#34;: &#34;7b163d6c-xxxxxxxxx&#34;,
    &#34;eventID&#34;: &#34;c3eda312-xxxxxxxxx&#34;,
    &#34;readOnly&#34;: false,
    &#34;eventType&#34;: &#34;AwsApiCall&#34;,
    &#34;managementEvent&#34;: true,
    &#34;recipientAccountId&#34;: &#34;xxxxxxxxx&#34;,
    &#34;eventCategory&#34;: &#34;Management&#34;
}
</code></pre><h2>Malicious actor?</h2><p>I found it surprising how quickly the malicious actor made some automated API calls with the leaked credentials. Meaning that they scan GitHub public repositories constantly for leaked credentials.</p><p>The user agent used was <code>aws-sdk-go-v2/1.17.1</code> so they probably have an automated tool that detects leaked credentials and start scanning the AWS account for resources. In the image below you see the various API calls they made, luckily without any luck because they didn’t have the permissions for these API calls.</p><p><img decoding="async" alt="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABzQAAAJEAQAAAABYhS8tAAAAAnRSTlMAAHaTzTgAAACZSURBVHja7cExAQAAAMKg9U9tDQ+gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHgyDb4AAdb44FIAAAAASUVORK5CYII=" data-src="https://xebia.com/wp-content/uploads/2023/04/what-happens-when-you-leak-aws-credentials-and-how-aws-minimizes-the-damage-cloudtrail-logs.png" data-src-webp="https://xebia.com/wp-content/uploads/2023/04/what-happens-when-you-leak-aws-credentials-and-how-aws-minimizes-the-damage-cloudtrail-logs.png.webp"/></p><p>Below you will find the CloudTrail log of the <code>ListCertificates</code> API call:</p><pre><code>{
    &#34;eventVersion&#34;: &#34;1.08&#34;,
    &#34;userIdentity&#34;: {
        &#34;type&#34;: &#34;IAMUser&#34;,
        &#34;principalId&#34;: &#34;AIDAxxxxxxxxx&#34;,
        &#34;arn&#34;: &#34;arn:aws:iam::xxxxxxxxx:user/test-user&#34;,
        &#34;accountId&#34;: &#34;xxxxxxxxx&#34;,
        &#34;accessKeyId&#34;: &#34;AKIAYUBS5O3BYC7WBJWO&#34;,
        &#34;userName&#34;: &#34;test-user&#34;
    },
    &#34;eventTime&#34;: &#34;2023-03-21T11:34:36Z&#34;,
    &#34;eventSource&#34;: &#34;acm.amazonaws.com&#34;,
    &#34;eventName&#34;: &#34;ListCertificates&#34;,
    &#34;awsRegion&#34;: &#34;eu-west-1&#34;,
    &#34;sourceIPAddress&#34;: &#34;3.xxx.xx.xxx&#34;,
    &#34;userAgent&#34;: &#34;aws-sdk-go-v2/1.17.1 os/linux lang/go/1.18.10 md/GOOS/linux md/GOARCH/amd64 api/acm/1.15.2&#34;,
    &#34;errorCode&#34;: &#34;AccessDenied&#34;,
    &#34;errorMessage&#34;: &#34;User: arn:aws:iam::xxxxxxxxx:user/test-user is not authorized to perform: acm:ListCertificates because no identity-based policy allows the acm:ListCertificates action&#34;,
    &#34;requestParameters&#34;: null,
    &#34;responseElements&#34;: null,
    &#34;requestID&#34;: &#34;b83e5733-xxxxxxxxx&#34;,
    &#34;eventID&#34;: &#34;37d59144-xxxxxxxxx&#34;,
    &#34;readOnly&#34;: true,
    &#34;eventType&#34;: &#34;AwsApiCall&#34;,
    &#34;managementEvent&#34;: true,
    &#34;recipientAccountId&#34;: &#34;xxxxxxxxx&#34;,
    &#34;eventCategory&#34;: &#34;Management&#34;,
    &#34;tlsDetails&#34;: {
        &#34;tlsVersion&#34;: &#34;TLSv1.3&#34;,
        &#34;cipherSuite&#34;: &#34;TLS_AES_128_GCM_SHA256&#34;,
        &#34;clientProvidedHostHeader&#34;: &#34;acm.eu-west-1.amazonaws.com&#34;
    }
}
</code></pre><h2>Email from AWS</h2><p>Within two minutes of leaking the credentials I received an email from AWS informing me that the credentials have been leaked. See the first part of the email below:</p><blockquote><p>Hello,</p><p>We have become aware that the AWS Access Key AKIAYUBS5O3BYC7WBJWO , belonging to IAM User test-user , along with the corresponding Secret Key is publicly available online at https://github.com/tiborhercz/aws-leaked-credentials/blob/33b4d387e94e16b1c8b9277056299bdb02de3a4b/credentials.txt.</p><p>Your security is important to us and this exposure of your account’s IAM credentials poses a security risk to your AWS account, could lead to excessive charges from unauthorized activity, and violates the AWS Customer Agreement or other agreement with us governing your use of our Services.</p><p>To protect your account from excessive charges and unauthorized activity, we have applied the “AWSCompromisedKeyQuarantineV2” AWS Managed Policy (“Quarantine Policy”) to the IAM User listed above. The Quarantine Policy applied to the User protects your account by denying access to high risk actions like iam:CreateAccessKey and ec2:RunInstances. You can view all the actions denied by the policy by going here: https://console.aws.amazon.com/iam/home#policies/arn:aws:iam::aws:policy/AWSCompromisedKeyQuarantineV2$jsonEditor?section=permissions.</p></blockquote><p>In the email they also give guidance on how to secure the account. They do this in four steps: 1. Rotate and delete the exposed AWS Access Key AKIAYUBS5O3BYC7WBJWO 2. Check your CloudTrail log for unsanctioned activity 3. Review your AWS account for any unauthorized AWS usage 4. You must respond to the existing Support Case or create a new one to confirm completion of the steps above in order to restore access to your account, prevent suspension, and apply for a billing adjustment, if applicable.</p><p>How does AWS respond this fast when credentials are leaked is something I am not 100% sure about, because I do not have confirmation from AWS itself.</p><p>How they could achieve this is by using <a href="https://docs.github.com/en/code-security/secret-scanning/about-secret-scanning">GitHub ‘Secrets Scanning’</a> service and using the ‘Secret scanning alerts for partners’. GitHub will then report leaked secrets to these partners, when receiving this report AWS has some automated system that adds the <code>AWSCompromisedKeyQuarantineV2</code> policy, sends the email and opens a support ticket.</p><p>When leaking AWS credentials to GitHub, AWS has safeguards in place to protect you. AWS and the malicious actors act impressively fast on the leaked credentials both taking action immediately. AWS informs the root user and adds a Deny policy to the IAM user. The malicious actor starts to scan the account for resources they can exploit.</p><p>It is very nice that AWS protects its users in this way, but we could better prevent the leaking of the credentials. There are various ways of preventing leaking the credentials.</p><ul><li>You could run a pre commit locally scanning for secrets before pushing to GitHub</li><li>Add a secret scanner in your CI/CD pipeline</li><li>The GitHub Secrets Scanning for users <a href="https://docs.github.com/en/code-security/secret-scanning/configuring-secret-scanning-for-your-repositories">Configuring secret scanning for your repositories</a></li></ul></div></div>
  </body>
</html>
