<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.zellic.io/blog/proton-dart-flutter-csprng-prng/">Original</a>
    <h1>Three mistakes from Dart/Flutter&#39;s weak PRNG</h1>
    
    <div id="readability-page-1" class="page"><div id="__blog-post-container" itemprop="articleBody"><p>What happens when developers accidentally pick a predictable source of randomness, and that source happens to be significantly weaker than reasonable developers would expect? These are the stories of how some popular projects all got burned by the same underlying weakness in the Dart/Flutter ecosystem and how the projects were affected. The mistake is prevalent in many open-source projects, but we will highlight just a few of them here.</p>
<p>These are the vulnerabilities we’ll be taking a look into.</p>
<ul>
<li>The <strong>Dart SDK one-click exploit</strong>, an arbitrary file read and write affecting most Dart/Flutter developers</li>
<li>The <strong>Proton Wallet encryption vulnerability</strong>, including attacks against their wallet and backup mnemonic security</li>
<li>An issue with <strong>predictable passwords in SelfPrivacy</strong></li>
</ul>
<h2 id="1--the-dart-sdk-one-click-exploit">1 — The Dart SDK One-Click Exploit<a aria-label="Direct link to 1 — The Dart SDK One-Click Exploit" title="Direct link to 1 — The Dart SDK One-Click Exploit" href="https://www.zellic.io/blog/proton-dart-flutter-csprng-prng#1--the-dart-sdk-one-click-exploit">​</a></h2>
<h3 id="flutter-is-not-so-random">Flutter Is Not So Random<a aria-label="Direct link to Flutter Is Not So Random" title="Direct link to Flutter Is Not So Random" href="https://www.zellic.io/blog/proton-dart-flutter-csprng-prng#flutter-is-not-so-random">​</a></h3>
<p>When you want to create an interactive application that runs on mobile, web, and desktop alike, and all in the same codebase, <a href="https://flutter.dev/" target="_blank" rel="noopener">Flutter<span>↗</span></a> is a popular choice. It allows users to write performant applications that give similar user experiences on every supported platform. Flutter is powered by <a href="https://dart.dev/" target="_blank" rel="noopener">Dart<span>↗</span></a>, which can compile the code to ARM machine code for both iOS and Android, JavaScript/WebAssembly for browsers, and x64/ARM for desktop devices. It also features some nifty functionality like “stateful hot reload”, which allows users to change the code and instantly see the results of the change without restarting their entire application.</p>
<p>In order to run similarly on many platforms, Dart code runs in a virtual machine called the Dart VM. The VM comes with multiple built-in libraries that handle OS-specific operations like interacting with files and resources, rendering graphics, doing math operations, and also generating randomness. The platform-specific implementation of these libraries may have differences in exactly how they accomplish their tasks. For instance, platforms that have built-in randomness sources might use those for their CSPRNG and ask the Dart isolate (the main process) for an initial random seed for the insecure PRNG. And then there’s Wasm, that straight up <a href="https://github.com/dart-lang/sdk/commit/5e3fbe1c1ebea885ca89b08378b1107d7d2ab525" target="_blank" rel="noopener">hardcoded the initial seed<span>↗</span></a> until September 2024.</p>
<div><div><pre tabindex="0"><code><span><span>diff --git a/sdk/lib/_internal/wasm/lib/math_patch.dart b/sdk/lib/_internal/wasm/lib/math_patch.dart</span><br/></span><span><span>index 07c6f21dca2b..8df63bd71e47 100644</span><br/></span><span><span></span><span>--- a/sdk/lib/_internal/wasm/lib/math_patch.dart</span><span></span><br/></span><span><span></span><span>+++ b/sdk/lib/_internal/wasm/lib/math_patch.dart</span><span></span><br/></span><span><span>@@ -226,8 +226,11 @@ class _Random implements Random {</span><br/></span><span><span></span><span> </span><span></span><br/></span><span><span></span><span> </span><span>  static int _setupSeed(int seed) =&gt; mix64(seed);</span><br/></span><span><span></span><span> </span><span></span><br/></span><span><span></span><span>-</span><span>  // TODO: Make this actually random</span><br/></span><span><span></span><span>-</span><span>  static int _initialSeed() =&gt; 0xCAFEBABEDEADBEEF;</span><br/></span><span><span></span><span>+</span><span>  static int _initialSeed() {</span><br/></span><span><span></span><span>+</span><span>    final low = (_jsMath.random() * 4294967295.0).toInt();</span><br/></span><span><span></span><span>+</span><span>    final high = (_jsMath.random() * 4294967295.0).toInt();</span><br/></span><span><span></span><span>+</span><span>    return ((high &lt;&lt; 32) | low);</span><br/></span><span><span></span><span>+</span><span>  }</span><br/></span></code></pre></div></div>
<p>In an <a href="https://www.zellic.io/blog/csprngs-how-to-properly-generate-random-numbers" target="_blank" rel="noopener">earlier blog post<span>↗</span></a>, we talked about various generators for randomness and how subtle mistakes could easily lead to loss of funds or private-key material down the road. The accidental usage of weak PRNGs can be hard to detect for a human, unless it is so weak that it generates duplicate keys often enough to notice. And even in that case, you have bugs like CVE-2008-0166 (Debian OpenSSL Predictable PRNG) that went undetected for nearly two years, despite having only <strong>15 bits</strong> of entropy for all generated SSH keys.</p>
<p>One such accidental weakness is to initialize Dart’s <code>Random()</code> class directly and not call the special constructor <code>Random.secure()</code>, which actually generates cryptographically secure numbers. But how bad is the standard PRNG actually? We dived into the code to figure that out. First off, Dart’s standard PRNG is a <a href="https://en.wikipedia.org/wiki/Multiply-with-carry_pseudorandom_number_generator" target="_blank" rel="noopener">multiply-with-carry (MWC) pseudorandom number generator<span>↗</span></a> using the native integer type for its state, which is technically 64 bits. The random module is slightly complicated by having platform-specific patches and overrides here and there, but we will quickly go through the main gist of its internals.</p>
<h3 id="dart-prng-internals">Dart PRNG Internals<a aria-label="Direct link to Dart PRNG Internals" title="Direct link to Dart PRNG Internals" href="https://www.zellic.io/blog/proton-dart-flutter-csprng-prng#dart-prng-internals">​</a></h3>
<p>Let’s assume a user wants to generate 100 random bytes in Flutter. The <strong>insecure</strong> code for doing this is something like this:</p>
<div><div><pre tabindex="0"><code><span><span>import</span><span> </span><span>&#39;dart:math&#39;</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>int len </span><span>=</span><span> </span><span>100</span><span>;</span><span></span><br/></span><span><span></span><span>Random</span><span> random </span><span>=</span><span> </span><span>Random</span><span>(</span><span>)</span><span>;</span><span>  </span><br/></span><span><span></span><span>final</span><span> </span><span>List</span><span>&lt;</span><span>int</span><span>&gt;</span><span> bytes </span><span>=</span><span> </span><span>List</span><span>&lt;</span><span>int</span><span>&gt;</span><span>.</span><span>generate</span><span>(</span><span>len</span><span>,</span><span> </span><span>(</span><span>_</span><span>)</span><span> </span><span>=</span><span>&gt;</span><span> random</span><span>.</span><span>nextInt</span><span>(</span><span>256</span><span>)</span><span>)</span><span>;</span><br/></span></code></pre></div></div>
<p>In the VM, the <code>Random()</code> constructor in the math module is patched in to be</p>
<div><div><pre tabindex="0"><code><span><span>@patch</span><br/></span><span><span></span><span>class</span><span> </span><span>Random</span><span> </span><span>{</span><span></span><br/></span><span><span>  </span><span>static</span><span> </span><span>final</span><span> Random _secureRandom </span><span>=</span><span> </span><span>_SecureRandom</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>  @patch</span><br/></span><span><span>  factory </span><span>Random</span><span>(</span><span>[</span><span>int</span><span>?</span><span> seed</span><span>]</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>    var state </span><span>=</span><span> _Random</span><span>.</span><span>_setupSeed</span><span>(</span><span>(</span><span>seed </span><span>==</span><span> null</span><span>)</span><span> </span><span>?</span><span> _Random</span><span>.</span><span>_nextSeed</span><span>(</span><span>)</span><span> </span><span>:</span><span> seed</span><span>)</span><span>;</span><span></span><br/></span><span><span>    </span><span></span><br/></span><span><span>    </span><span>return</span><span> </span><span>new</span><span> _Random</span><span>.</span><span>_withState</span><span>(</span><span>state</span><span>)</span><span></span><br/></span><span><span>      </span><span>.</span><span>.</span><span>_nextState</span><span>(</span><span>)</span><span></span><br/></span><span><span>      </span><span>.</span><span>.</span><span>_nextState</span><span>(</span><span>)</span><span></span><br/></span><span><span>      </span><span>.</span><span>.</span><span>_nextState</span><span>(</span><span>)</span><span></span><br/></span><span><span>      </span><span>.</span><span>.</span><span>_nextState</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span>  </span><span>}</span><span></span><br/></span><span><span></span><br/></span><span><span>  @patch</span><br/></span><span><span>  factory Random</span><span>.</span><span>secure</span><span>(</span><span>)</span><span> </span><span>=</span><span>&gt;</span><span> _secureRandom</span><span>;</span><span></span><br/></span><span><span></span><span>}</span><br/></span></code></pre></div></div>
<p>It takes in an optional seed parameter, if the caller wants reproducible outputs; otherwise, it will call <code>_setupSeed(_Random._nextSeed())</code>. But where is this seed coming from, if it’s the first time the random is being initialized?</p>
<div><div><pre tabindex="0"><code><span><span>  </span><span></span><br/></span><span><span>  </span><span>static</span><span> </span><span>final</span><span> _prng </span><span>=</span><span> </span><span>new</span><span> _Random</span><span>.</span><span>_withState</span><span>(</span><span>_initialSeed</span><span>(</span><span>)</span><span>)</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>  </span><span></span><br/></span><span><span></span><br/></span><span><span>  </span><span></span><br/></span><span><span>  @</span><span>pragma</span><span>(</span><span>&#34;vm:external-name&#34;</span><span>,</span><span> </span><span>&#34;Random_initialSeed&#34;</span><span>)</span><span></span><br/></span><span><span>  external </span><span>static</span><span> </span><span>int</span><span> </span><span>_initialSeed</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>  </span><span>static</span><span> </span><span>int</span><span> </span><span>_nextSeed</span><span>(</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>    </span><span></span><br/></span><span><span>    _prng</span><span>.</span><span>_nextState</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span>    </span><span>return</span><span> _prng</span><span>.</span><span>_state </span><span>&amp;</span><span> </span><span>0xFFFFFFFF</span><span>;</span><span></span><br/></span><span><span>  </span><span>}</span><span></span><br/></span><span><span></span><br/></span></code></pre></div></div>
<p>And here we have a big surprise waiting for us. Dart will always generate an internal singleton <code>Random</code> object, which is seeded with 64 bits of secure randomness directly from the VM’s entropy source. Upon constructing a new <code>Random()</code> class, it will fetch a 64-bit state from this singleton and then <strong>truncate it</strong> by masking with <code>0xFFFFFFFF</code>. This makes all possible PRNGs only have 32 bits of entropy when initialized like in the insecure example above. To summarize, anything generated from a freshly initialized <code>Random()</code> class is one out of 4,294,967,296 possible streams of outputs. This is absolutely trivial to brute force with modern desktop computers.</p>
<p>Reasonable developers might assume that since the PRNG state is 64 bits and seeded with 64 bits, then the security would also be 64 bits, but due to the 32 bit truncation this isn’t true. It’s at most 32 bits. In short, that means that using <code>Random()</code> over <code>Random.secure()</code> should only be done for the most trivial of applications, but this was accidentally overlooked by the Dart SDK team.</p>
<h3 id="the-attack-scenario">The Attack Scenario<a aria-label="Direct link to The Attack Scenario" title="Direct link to The Attack Scenario" href="https://www.zellic.io/blog/proton-dart-flutter-csprng-prng#the-attack-scenario">​</a></h3>
<p>Many new adopters and testers of Flutter might start their journey by following the tutorial on the Flutter website. It will ask a user to install the required Dart SDK and create a new project in an IDE like Android Studio or Visual Studio Code. Once they have created their first project and are staring at their blank template, they might be tempted to look up the documentation online not knowing they are one click away from malicious users stealing files from their computer, or potentially executing code.</p>
<p>Flutter IDEs like Visual Studio Code and Android Studio rely on a persistent, long-running background process. That’s the <a href="https://pub.dev/packages/dtd" target="_blank" rel="noopener">Dart Tooling Daemon<span>↗</span></a>, or DTD for short. Once a Flutter workspace is opened, DTD will automatically start running in the background. This happens automatically when the IDE starts, and it is not triggered by building or running the project. From the package documentation itself,</p>
<blockquote>
<p>The Dart Tooling Daemon is a long running process meant to facilitate communication between Dart tools and minimal file system access for a Dart development workspace.</p>
<p>When writing or running a Dart or Flutter application, in an IDE, the Dart Tooling Daemon is started by the IDE. It persists over the life of the IDE’s workspace.</p>
</blockquote>
<p>Essentially, DTD is a websocket that listens on a random port. By connecting to it, users gain access to reading and writing files in the workspace directory, listing file directory contents, registering and listening to services, and listening to and posting events to streams. <strong>This websocket can be accessed from a browser</strong>, but it is somewhat secured by binding to a random port and a generated, random secret that has to be provided in the websocket path when connecting. From their own examples, the URI might look like this,</p>
<p><code>ws://127.0.0.1:62925/cKB5QFiAUNMzSzlb</code></p>
<p>where the random port is <code>62925</code> and the URI auth code is <code>cKB5QFiAUNMzSzlb</code>. In addition to this secret, there’s a second secret that is required for the special the API call <code>setIDEWorkspaceRoots(secret, roots)</code>, which unlocks the capability for the clients to access any file on the computer — not just the ones in the workspace.</p>
<p>But how are these secrets generated? This all happens in dart_tooling_daemon.dart, where we extract only the relevant snippets:</p>
<div><div><pre tabindex="0"><code><span><span>static</span><span> </span><span>String</span><span> </span><span>_generateSecret</span><span>(</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>  </span><span>String</span><span> upper </span><span>=</span><span> </span><span>&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span><span>;</span><span></span><br/></span><span><span>  </span><span>String</span><span> lower </span><span>=</span><span> </span><span>&#39;abcdefghijklmnopqrstuvwxyz&#39;</span><span>;</span><span></span><br/></span><span><span>  </span><span>String</span><span> numbers </span><span>=</span><span> </span><span>&#39;1234567890&#39;</span><span>;</span><span></span><br/></span><span><span>  int secretLength </span><span>=</span><span> </span><span>16</span><span>;</span><span></span><br/></span><span><span>  </span><span>String</span><span> seed </span><span>=</span><span> upper </span><span>+</span><span> lower </span><span>+</span><span> numbers</span><span>;</span><span></span><br/></span><span><span>  </span><span>String</span><span> password </span><span>=</span><span> </span><span>&#39;&#39;</span><span>;</span><span></span><br/></span><span><span>  </span><span>List</span><span>&lt;</span><span>String</span><span>&gt;</span><span> list </span><span>=</span><span> seed</span><span>.</span><span>split</span><span>(</span><span>&#39;&#39;</span><span>)</span><span>.</span><span>toList</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span>  </span><span>Random</span><span> rand </span><span>=</span><span> </span><span>Random</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span>  </span><span>for</span><span> </span><span>(</span><span>int i </span><span>=</span><span> </span><span>0</span><span>;</span><span> i </span><span>&lt;</span><span> secretLength</span><span>;</span><span> i</span><span>++</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>    int index </span><span>=</span><span> rand</span><span>.</span><span>nextInt</span><span>(</span><span>list</span><span>.</span><span>length</span><span>)</span><span>;</span><span></span><br/></span><span><span>    password </span><span>+=</span><span> list</span><span>[</span><span>index</span><span>]</span><span>;</span><span></span><br/></span><span><span>  </span><span>}</span><span></span><br/></span><span><span>  </span><span>return</span><span> password</span><span>;</span><span></span><br/></span><span><span></span><span>}</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span>final</span><span> </span><span>String</span><span>?</span><span> _uriAuthCode </span><span>=</span><span> disableServiceAuthCodes </span><span>?</span><span> </span><span>null</span><span> </span><span>:</span><span> </span><span>_generateSecret</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span></span><span>final</span><span> secret </span><span>=</span><span> </span><span>_generateSecret</span><span>(</span><span>)</span><span>;</span><br/></span></code></pre></div></div>
<p>Turns out, these secrets are merely 32 bits. Let’s confirm by brute forcing the seed of the example URI.</p>
<div><div><pre tabindex="0"><code><span><span>$ time ./findseed.py cKB5QFiAUNMzSzlb</span><br/></span><span><span>Recovered seed: 0xAA70CB0D</span><br/></span><span><span></span><br/></span><span><span>real    0m10.428s</span><br/></span><span><span>user    0m10.242s</span><br/></span><span><span>sys     0m0.006s</span><br/></span></code></pre></div></div>
<p>This isn’t great. A silver lining is that the two secrets are generated independently, so an attacker needs twice the brute force (33 bits) in order to recover both. But a huge downside is that the websocket can be accessed by JavaScript on any malicious website, completely without user interaction. The website can automatically brute force the port, followed by testing all four billion possible secrets. At this point, the website can list directory contents, extract and exfiltrate secret files from the workspace, or overwrite build scripts and GIT hooks to indirectly run arbitrary code. After recovering the second secret and changing the workspace roots, the same can be applied to all files that the current user has access to, for example in a typical stealer malware fashion. The same attack scenario applies to local processes that run under less privileged users, allowing privilege escalation.</p>
<p>In our report, we included a JavaScript implementation of the attack that runs when a developer visits a website. It brute forces the port, then starts a throttled scan to guess the authentication code. Such an attack takes some time to run, because browsers have a limit to how many concurrent websockets they allow. So in a real-life scenario, the attacker would need to put the malicious code on a website where the victim is likely to linger (e.g., a Flutter tutorial website, websites that stream video, have messaging services or similar). It is possible to make the attack persist through page clicks by using cookies or <code>localStorage</code> to store progress.</p>
<h3 id="timeline-and-conclusion">Timeline and Conclusion<a aria-label="Direct link to Timeline and Conclusion" title="Direct link to Timeline and Conclusion" href="https://www.zellic.io/blog/proton-dart-flutter-csprng-prng#timeline-and-conclusion">​</a></h3>
<ul>
<li>August 23, 2024 — The bug was reported to the Google Open Source Software Vulnerability Reward Program.</li>
<li>September 5, 2024 — The Google Bug Hunters team made a response that an internal bug report has been filed with the product team.</li>
<li>September 25, 2024 — The bug was <a href="https://github.com/dart-lang/sdk/commit/ef5295d0501798838ba5ec4eabf8cc80616f9d4a" target="_blank" rel="noopener">fixed<span>↗</span></a> about one month after the initial report.</li>
<li>November 1, 2024 — The Google Bug Hunters team decided to not reward nor announce this security fix, because it only affects developers.</li>
<li>December 11, 2024 — As of the time of writing, Dart SDK 3.6.0 has not been marked “stable” and has thus not made its way into the stable Flutter SDK.</li>
</ul>
<h2 id="2--proton-wallet-encryption-vulnerability">2 — Proton Wallet Encryption Vulnerability<a aria-label="Direct link to 2 — Proton Wallet Encryption Vulnerability" title="Direct link to 2 — Proton Wallet Encryption Vulnerability" href="https://www.zellic.io/blog/proton-dart-flutter-csprng-prng#2--proton-wallet-encryption-vulnerability">​</a></h2>
<p>The preview version of Proton Wallet launched the summer of 2024, with parts of its application code <a href="https://github.com/ProtonWallet/" target="_blank" rel="noopener">open sourced<span>↗</span></a>. The mobile app is written in Flutter and featured the same kind of mistake that the Dart SDK team made. The vulnerability was only present for a single day, but to understand the impact of this vulnerability, let’s take a look at the security of Proton.</p>
<h3 id="protons-protection-mechanisms">Proton’s Protection Mechanisms<a aria-label="Direct link to Proton’s Protection Mechanisms" title="Direct link to Proton’s Protection Mechanisms" href="https://www.zellic.io/blog/proton-dart-flutter-csprng-prng#protons-protection-mechanisms">​</a></h3>
<p>Proton’s threat model includes some protections against subpoenas, database hacks, and internal threats. To accomplish this, they try to store the bare minimum of what is necessary to authenticate a user, with a layered approach for the various applications in their ecosystem. Most data is encrypted using AES-256-GCM, where the encrypted key is stored together with the data. To decrypt the data, knowledge about the user password is required at some point. This does come with a few significant downsides, however.</p>
<p>Firstly, they do not know a user’s password, nor the direct hash of their password. The password is not actually sent at all during authentication. But this means that if a user loses their password and have not set up the proper recovery mechanisms, their data is irrecoverably lost — at least until they are able to remember it. The account itself can be recovered, but old data will not be decrypted.</p>
<p>Secondly, while Proton cannot scan a user’s email contents, it also means the user cannot search the contents of their emails without decrypting and caching all the emails locally. Proton’s web client supports doing this in the background, but for large mailboxes, this could take a long time. The sender, recipients, and subject of every email are not encrypted, so make sure to not leave sensitive information in those.</p>
<p>It is worth noting that Proton does not protect against compromised devices or shoulder surfing and that it assumes that the normal certificate-pinning mechanisms will protect against serving malicious websites on the official domains. Users can still fall prey to phishing scams, but there are protections like 2FA that can mitigate some of these. Naturally, Proton itself could serve a user a fake website, but they do release regular versions of their clients that the most vigilant users can vet and then run locally.</p>
<h3 id="secure-remote-password-protocol">Secure Remote Password Protocol<a aria-label="Direct link to Secure Remote Password Protocol" title="Direct link to Secure Remote Password Protocol" href="https://www.zellic.io/blog/proton-dart-flutter-csprng-prng#secure-remote-password-protocol">​</a></h3>
<p>To accomplish the first feat of not knowing a user’s password, Proton implements the Secure Remote Password protocol, revision 6a (SRP-6a). SRP is what we call an augmented password-authenticated key exchange (PAKE), where “augmented” means that the server does not store password-equivalent data. Instead, the client will prove to the server that it has the password, without revealing any information about the password to a passive eavesdropper or an active man in the middle. The server is also authenticated in the same transaction, as it has to store a verifier of the password in order to start the protocol.</p>
<p>The protocol itself is reminiscent of the <a href="https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange" target="_blank" rel="noopener">Diffie–Hellman key exchange<span>↗</span></a>, where two parties can agree on a shared, secret key over a public channel. The general flow is like this:</p>
<p><img decoding="async" loading="lazy" alt="Steps in the SRP protocol" src="https://blog-cdn.zellic.io/blog/assets/images/Steps-in-the-SRP-protocol-8825a95b88f320f56a94626da87e5bd2.png" width="980" height="822"/></p>
<p>First, the client will send a username to the server, and the server will need to retrieve its verifier and a corresponding, user-specific salt. In Proton’s case, they pick a random modulus from a large pool of moduli whenever the verifier is generated. This reduces the value of solving the general discrete log for any specific modulus, which is something that is likely only within nation-state capabilities as it’s 2,048 bits. The modulus is also signed by Proton, so an attacker cannot use malicious moduli where discrete log is easier. But as an extra precaution, the modulus actually goes into the password itself, so if the modulus somehow <em>is</em> malicious, the attacker only learns about the incorrect hash. The usage of multiple moduli, signing the moduli, or embedding the modulus into the password are not required by the TLS-SRP RFC 5054. The additions are used to harden the protocol against various attacks that Proton wants to protect its users against.</p>
<p>Next, the client will create a hash of its own password using the salt provided by the remote. This hash function is simply SHA-1 in RFC 5054, but this makes dictionary attacks against the verifier faster, so Proton decided to use bcrypt — a memory hard-hashing function — instead here. This does introduce a 72-character password limit, but the hardness of bcrypt makes up for that. Specifically, the <code>salt</code> from the server is used in the bcrypt salt, combined with a work factor of 10.</p>
<div><div><pre tabindex="0"><code><span><span>def</span><span> </span><span>hash_password_3</span><span>(</span><span>hash_class</span><span>,</span><span> password</span><span>,</span><span> salt</span><span>,</span><span> modulus</span><span>)</span><span>:</span><span></span><br/></span><span><span>    salt </span><span>=</span><span> </span><span>(</span><span>salt </span><span>+</span><span> </span><span>b&#34;proton&#34;</span><span>)</span><span>[</span><span>:</span><span>16</span><span>]</span><span></span><br/></span><span><span>    salt </span><span>=</span><span> bcrypt_b64_encode</span><span>(</span><span>salt</span><span>)</span><span>[</span><span>:</span><span>22</span><span>]</span><span></span><br/></span><span><span>    hashed </span><span>=</span><span> bcrypt</span><span>.</span><span>hashpw</span><span>(</span><span>password</span><span>,</span><span> </span><span>b&#34;$2y$10$&#34;</span><span> </span><span>+</span><span> salt</span><span>)</span><span></span><br/></span><span><span>    </span><span>return</span><span> hash_class</span><span>(</span><span>hashed </span><span>+</span><span> modulus</span><span>)</span><span>.</span><span>digest</span><span>(</span><span>)</span><br/></span></code></pre></div></div>
<p>The mysterious <code>hash_class</code> here is a custom hash function called <code>PMHash</code>, which extends <code>SHA-512</code> to 2,048 bits by hashing the data four times and combining:</p>
<div><div><pre tabindex="0"><code><span><span>def</span><span> </span><span>digest</span><span>(</span><span>b</span><span>)</span><span>:</span><span></span><br/></span><span><span>    </span><span>return</span><span> hashlib</span><span>.</span><span>sha512</span><span>(</span><span>b </span><span>+</span><span> </span><span>b&#39;\0&#39;</span><span>)</span><span>.</span><span>digest</span><span>(</span><span>)</span><span> </span><span>+</span><span> </span><br/></span><span><span>           hashlib</span><span>.</span><span>sha512</span><span>(</span><span>b </span><span>+</span><span> </span><span>b&#39;\1&#39;</span><span>)</span><span>.</span><span>digest</span><span>(</span><span>)</span><span> </span><span>+</span><span> </span><br/></span><span><span>           hashlib</span><span>.</span><span>sha512</span><span>(</span><span>b </span><span>+</span><span> </span><span>b&#39;\2&#39;</span><span>)</span><span>.</span><span>digest</span><span>(</span><span>)</span><span> </span><span>+</span><span> </span><br/></span><span><span>           hashlib</span><span>.</span><span>sha512</span><span>(</span><span>b </span><span>+</span><span> </span><span>b&#39;\3&#39;</span><span>)</span><span>.</span><span>digest</span><span>(</span><span>)</span><br/></span></code></pre></div></div>
<p>The resulting hash is the de facto secret that is used to decrypt everything in a user’s account, so it is absolutely vital to never reveal anything about this <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>x</span></span></span></span> value. What we call the verifier is actually <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mo>=</mo><msup><mi>g</mi><mi>x</mi></msup><mtext> </mtext><mo lspace="0.22em" rspace="0.22em"><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow></mo><mtext> </mtext><mi>m</mi><mi>o</mi><mi>d</mi><mi>u</mi><mi>l</mi><mi>u</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">v = g^x \bmod modulus</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>v</span><span></span><span>=</span><span></span></span><span><span></span><span><span>g</span><span><span><span><span><span><span></span><span><span>x</span></span></span></span></span></span></span></span><span></span><span></span><span><span><span>mod</span></span></span><span></span><span></span></span><span><span></span><span>m</span><span>o</span><span>d</span><span>u</span><span>l</span><span>u</span><span>s</span></span></span></span>, and the server has knowledge about this stored away somewhere.</p>
<p>To prove that it does possess the password hash, the client creates a secret, random <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>a</span></span></span></span> and calculates <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>=</mo><msup><mi>g</mi><mi>a</mi></msup><mtext> </mtext><mo lspace="0.22em" rspace="0.22em"><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow></mo><mtext> </mtext><mi>m</mi><mi>o</mi><mi>d</mi><mi>u</mi><mi>l</mi><mi>u</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">A = g^a \bmod modulus</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>A</span><span></span><span>=</span><span></span></span><span><span></span><span><span>g</span><span><span><span><span><span><span></span><span><span>a</span></span></span></span></span></span></span></span><span></span><span></span><span><span><span>mod</span></span></span><span></span><span></span></span><span><span></span><span>m</span><span>o</span><span>d</span><span>u</span><span>l</span><span>u</span><span>s</span></span></span></span> then sends that to the server. The server creates a secret, random <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>b</span></span></span></span> and sends <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>=</mo><mi>k</mi><mi>v</mi><mo>+</mo><msup><mi>g</mi><mi>b</mi></msup></mrow><annotation encoding="application/x-tex">B = kv + g^b</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>B</span><span></span><span>=</span><span></span></span><span><span></span><span>k</span><span>v</span><span></span><span>+</span><span></span></span><span><span></span><span><span>g</span><span><span><span><span><span><span></span><span><span>b</span></span></span></span></span></span></span></span></span></span></span> and some random <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>u</span></span></span></span> to the client. In Proton’s case, the server simply sends these values together with the modulus and salt at the very start, in order to remove a round trip. These two values constitute the server challenge. The <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>k</span></span></span></span> value is special to the 6a revision of SRP and is deterministically derived from the modulus and the generator <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi></mrow><annotation encoding="application/x-tex">g</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>g</span></span></span></span>.</p>
<p>Now the client will use its knowledge about <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>x</span></span></span></span> to calculate</p>
<p><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right" columnspacing=""><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>S</mi><mo>=</mo><mo stretchy="false">(</mo><mi>B</mi><mo>−</mo><mi>k</mi><mo>⋅</mo><msup><mi>g</mi><mi>x</mi></msup><msup><mo stretchy="false">)</mo><mrow><mo stretchy="false">(</mo><mi>a</mi><mo>+</mo><mi>u</mi><mi>x</mi><mo stretchy="false">)</mo></mrow></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>S</mi><mo>=</mo><mo stretchy="false">(</mo><mi>k</mi><mi>v</mi><mo>+</mo><msup><mi>g</mi><mi>b</mi></msup><mo>−</mo><mi>k</mi><mo>⋅</mo><msup><mi>g</mi><mi>x</mi></msup><msup><mo stretchy="false">)</mo><mrow><mo stretchy="false">(</mo><mi>a</mi><mo>+</mo><mi>u</mi><mi>x</mi><mo stretchy="false">)</mo></mrow></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>S</mi><mo>=</mo><mo stretchy="false">(</mo><mi>k</mi><mo>⋅</mo><msup><mi>g</mi><mi>x</mi></msup><mo>−</mo><mi>k</mi><mo>⋅</mo><msup><mi>g</mi><mi>x</mi></msup><mo>+</mo><msup><mi>g</mi><mi>b</mi></msup><msup><mo stretchy="false">)</mo><mrow><mo stretchy="false">(</mo><mi>a</mi><mo>+</mo><mi>u</mi><mi>x</mi><mo stretchy="false">)</mo></mrow></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>S</mi><mo>=</mo><mo stretchy="false">(</mo><msup><mi>g</mi><mi>b</mi></msup><msup><mo stretchy="false">)</mo><mrow><mo stretchy="false">(</mo><mi>a</mi><mo>+</mo><mi>u</mi><mi>x</mi><mo stretchy="false">)</mo></mrow></msup></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned} S = (B - k \cdot g^x)^{(a + ux)}\\ S = (kv + g^b - k \cdot g^x)^{(a + ux)}\\ S = (k \cdot g^x - k \cdot g^x + g^b)^{(a + ux)}\\ S = (g^b)^{(a + ux)} \end{aligned}</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span><span><span><span><span><span><span></span><span><span>S</span><span></span><span>=</span><span></span><span>(</span><span>B</span><span></span><span>−</span><span></span><span>k</span><span></span><span>⋅</span><span></span><span><span>g</span><span><span><span><span><span><span></span><span><span>x</span></span></span></span></span></span></span></span><span><span>)</span><span><span><span><span><span><span></span><span><span><span>(</span><span>a</span><span>+</span><span>ux</span><span>)</span></span></span></span></span></span></span></span></span></span></span><span><span></span><span><span>S</span><span></span><span>=</span><span></span><span>(</span><span>k</span><span>v</span><span></span><span>+</span><span></span><span><span>g</span><span><span><span><span><span><span></span><span><span>b</span></span></span></span></span></span></span></span><span></span><span>−</span><span></span><span>k</span><span></span><span>⋅</span><span></span><span><span>g</span><span><span><span><span><span><span></span><span><span>x</span></span></span></span></span></span></span></span><span><span>)</span><span><span><span><span><span><span></span><span><span><span>(</span><span>a</span><span>+</span><span>ux</span><span>)</span></span></span></span></span></span></span></span></span></span></span><span><span></span><span><span>S</span><span></span><span>=</span><span></span><span>(</span><span>k</span><span></span><span>⋅</span><span></span><span><span>g</span><span><span><span><span><span><span></span><span><span>x</span></span></span></span></span></span></span></span><span></span><span>−</span><span></span><span>k</span><span></span><span>⋅</span><span></span><span><span>g</span><span><span><span><span><span><span></span><span><span>x</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span>g</span><span><span><span><span><span><span></span><span><span>b</span></span></span></span></span></span></span></span><span><span>)</span><span><span><span><span><span><span></span><span><span><span>(</span><span>a</span><span>+</span><span>ux</span><span>)</span></span></span></span></span></span></span></span></span></span></span><span><span></span><span><span>S</span><span></span><span>=</span><span></span><span>(</span><span><span>g</span><span><span><span><span><span><span></span><span><span>b</span></span></span></span></span></span></span></span><span><span>)</span><span><span><span><span><span><span></span><span><span><span>(</span><span>a</span><span>+</span><span>ux</span><span>)</span></span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></p><p>The server, knowing the verifier <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mo>=</mo><msup><mi>g</mi><mi>x</mi></msup></mrow><annotation encoding="application/x-tex">v=g^x</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>v</span><span></span><span>=</span><span></span></span><span><span></span><span><span>g</span><span><span><span><span><span><span></span><span><span>x</span></span></span></span></span></span></span></span></span></span></span>, can calculate</p>
<p><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right" columnspacing=""><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>S</mi><mo>=</mo><mo stretchy="false">(</mo><mi>A</mi><mo>⋅</mo><msup><mi>v</mi><mi>u</mi></msup><msup><mo stretchy="false">)</mo><mi>b</mi></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>S</mi><mo>=</mo><mo stretchy="false">(</mo><msup><mi>g</mi><mi>a</mi></msup><mo>⋅</mo><msup><mi>g</mi><mrow><mi>u</mi><mi>x</mi></mrow></msup><msup><mo stretchy="false">)</mo><mi>b</mi></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>S</mi><mo>=</mo><mo stretchy="false">(</mo><msup><mi>g</mi><mrow><mo stretchy="false">(</mo><mi>a</mi><mo>+</mo><mi>u</mi><mi>x</mi><mo stretchy="false">)</mo></mrow></msup><msup><mo stretchy="false">)</mo><mi>b</mi></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>S</mi><mo>=</mo><mo stretchy="false">(</mo><msup><mi>g</mi><mi>b</mi></msup><msup><mo stretchy="false">)</mo><mrow><mo stretchy="false">(</mo><mi>a</mi><mo>+</mo><mi>u</mi><mi>x</mi><mo stretchy="false">)</mo></mrow></msup></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned} S = (A \cdot v^u)^b\\ S = (g^a \cdot g^{ux})^b\\ S = (g^{(a + ux)})^b\\ S = (g^b)^{(a + ux)}
\end{aligned}</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span><span><span><span><span><span><span></span><span><span>S</span><span></span><span>=</span><span></span><span>(</span><span>A</span><span></span><span>⋅</span><span></span><span><span>v</span><span><span><span><span><span><span></span><span><span>u</span></span></span></span></span></span></span></span><span><span>)</span><span><span><span><span><span><span></span><span><span>b</span></span></span></span></span></span></span></span></span></span><span><span></span><span><span>S</span><span></span><span>=</span><span></span><span>(</span><span><span>g</span><span><span><span><span><span><span></span><span><span>a</span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span><span><span>g</span><span><span><span><span><span><span></span><span><span><span>ux</span></span></span></span></span></span></span></span></span><span><span>)</span><span><span><span><span><span><span></span><span><span>b</span></span></span></span></span></span></span></span></span></span><span><span></span><span><span>S</span><span></span><span>=</span><span></span><span>(</span><span><span>g</span><span><span><span><span><span><span></span><span><span><span>(</span><span>a</span><span>+</span><span>ux</span><span>)</span></span></span></span></span></span></span></span></span><span><span>)</span><span><span><span><span><span><span></span><span><span>b</span></span></span></span></span></span></span></span></span></span><span><span></span><span><span>S</span><span></span><span>=</span><span></span><span>(</span><span><span>g</span><span><span><span><span><span><span></span><span><span>b</span></span></span></span></span></span></span></span><span><span>)</span><span><span><span><span><span><span></span><span><span><span>(</span><span>a</span><span>+</span><span>ux</span><span>)</span></span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></p><p>which should be the same value <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>S</span></span></span></span> as the client, and it becomes a shared secret. The client goes first and reveals a hash based on the public parameters and the shared secret <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>c</mi><mi>l</mi><mi>i</mi><mi>e</mi><mi>n</mi><mi>t</mi></mrow></msub><mo>=</mo><mi>P</mi><mi>M</mi><mi>h</mi><mi>a</mi><mi>s</mi><mi>h</mi><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>B</mi><mo separator="true">,</mo><mi>S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_{client} = PMhash(A, B, S)</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span>P</span><span><span><span><span><span><span></span><span><span><span>c</span><span>l</span><span>i</span><span>e</span><span>n</span><span>t</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>PM</span><span>ha</span><span>s</span><span>h</span><span>(</span><span>A</span><span>,</span><span></span><span>B</span><span>,</span><span></span><span>S</span><span>)</span></span></span></span>. The server is able to calculate the expected value of <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>c</mi><mi>l</mi><mi>i</mi><mi>e</mi><mi>n</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{client}</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span>P</span><span><span><span><span><span><span></span><span><span><span>c</span><span>l</span><span>i</span><span>e</span><span>n</span><span>t</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span> for verification. If a mismatch is detected, it means that someone tampered with the public values, or that the client has the wrong password/secret, and the server must then immediately terminate the protocol. Sending any data encrypted with the shared secret is a common pitfall when implementing SRP, and enables the client to brute-force the password offline. If everything looks good, the server will also send a commitment <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>s</mi><mi>e</mi><mi>r</mi><mi>v</mi><mi>e</mi><mi>r</mi></mrow></msub><mo>=</mo><mi>P</mi><mi>M</mi><mi>h</mi><mi>a</mi><mi>s</mi><mi>h</mi><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><msub><mi>P</mi><mrow><mi>c</mi><mi>l</mi><mi>i</mi><mi>e</mi><mi>n</mi><mi>t</mi></mrow></msub><mo separator="true">,</mo><mi>S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_{server} = PMhash(A, P_{client}, S)</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span>P</span><span><span><span><span><span><span></span><span><span><span>ser</span><span>v</span><span>er</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>PM</span><span>ha</span><span>s</span><span>h</span><span>(</span><span>A</span><span>,</span><span></span><span><span>P</span><span><span><span><span><span><span></span><span><span><span>c</span><span>l</span><span>i</span><span>e</span><span>n</span><span>t</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>S</span><span>)</span></span></span></span> that shows agreement with the client parameters, the client commitment, and the shared secret <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>S</span></span></span></span>.</p>
<p>At this point, the client is authenticated and Proton will serve it encrypted data that the server itself cannot decrypt. The client has proved knowledge about the secret key that is required to decrypt the data, after all.</p>
<h3 id="insecure-recovery-phrase">Insecure Recovery Phrase<a aria-label="Direct link to Insecure Recovery Phrase" title="Direct link to Insecure Recovery Phrase" href="https://www.zellic.io/blog/proton-dart-flutter-csprng-prng#insecure-recovery-phrase">​</a></h3>
<p>From the description of the SRP-6a protocol, it is possible to realize a potential venue of attack that comes to play if someone gets access to the database containing the verifiers. Since the verifier is deterministically generated, it is possible to run an offline dictionary attack using the user salt and modulus. Each step involves running bcrypt once, SHA-512 four times, and then calculating <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>g</mi><mi>x</mi></msup><mtext> </mtext><mo lspace="0.22em" rspace="0.22em"><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow></mo><mtext> </mtext><mi>m</mi><mi>o</mi><mi>d</mi><mi>u</mi><mi>l</mi><mi>u</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">g^x \bmod modulus</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span>g</span><span><span><span><span><span><span></span><span><span>x</span></span></span></span></span></span></span></span><span></span><span></span><span><span><span>mod</span></span></span><span></span><span></span></span><span><span></span><span>m</span><span>o</span><span>d</span><span>u</span><span>l</span><span>u</span><span>s</span></span></span></span> to check if it matches the server verifier. The combination of these steps makes testing a single password quite slow. As each password is also combined with the modulus and a random salt, there are no benefits to scaling up the brute-force operations and attacking multiple hashes at once. Combined with the requirement of database access, this makes it very hard to get to the user password itself with Proton’s hardening.</p>
<p>One of multiple recovery mechanisms for Proton accounts is to use a recovery phrase, which is essentially a BIP39 mnemonic phrase. This phrase can decrypt a backup key that the server stores for a user and can recover all user data in case a password is forgotten. A user will often be reminded by Proton to set up recovery options, and the recovery phrase is one of the easier ones to set up. It just requires the user to generate then safekeep a string of words that are ultimately even <strong>more valuable than the password itself</strong>. That’s because a recovery phrase will also <strong>disable 2FA when used</strong>.</p>
<p>In the Proton Wallet application, users are again reminded to set this up to not lose access to their funds. This code snippet, a part of the <code>on&lt;EnableRecovery&gt;</code> event handler, is responsible for generating this backup phrase when no phrase already exists:</p>
<div><div><pre tabindex="0"><code><span><span></span><br/></span><span><span></span><span>final</span><span> serverProofs </span><span>=</span><span> </span><span>await</span><span> protonUsersApi</span><span>.</span><span>unlockPasswordChange</span><span>(</span><span></span><br/></span><span><span>  proofs</span><span>:</span><span> proofs</span><span>,</span><span></span><br/></span><span><span></span><span>)</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span></span><br/></span><span><span></span><span>final</span><span> check </span><span>=</span><span> clientProofs</span><span>.</span><span>expectedServerProof </span><span>==</span><span> serverProofs</span><span>;</span><span></span><br/></span><span><span>logger</span><span>.</span><span>i</span><span>(</span><span>&#34;EnableRecovery password server proofs: </span><span>$</span><span>check</span><span>&#34;</span><span>)</span><span>;</span><span></span><br/></span><span><span></span><span>if</span><span> </span><span>(</span><span>!</span><span>check</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>  </span><span>return</span><span> </span><span>Future</span><span>.</span><span>error</span><span>(</span><span>&#39;Invalid server proofs&#39;</span><span>)</span><span>;</span><span></span><br/></span><span><span></span><span>}</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span></span><br/></span><span><span></span><span>final</span><span> salt </span><span>=</span><span> </span><span>WalletKeyHelper</span><span>.</span><span>getRandomValues</span><span>(</span><span>16</span><span>)</span><span>;</span><span></span><br/></span><span><span></span><span>final</span><span> randomEntropy </span><span>=</span><span> </span><span>WalletKeyHelper</span><span>.</span><span>getRandomValues</span><span>(</span><span>16</span><span>)</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span>final</span><span> </span><span>FrbMnemonic</span><span> mnemonic </span><span>=</span><span> </span><span>FrbMnemonic</span><span>.</span><span>newWith</span><span>(</span><span>entropy</span><span>:</span><span> randomEntropy</span><span>)</span><span>;</span><span></span><br/></span><span><span></span><span>final</span><span> mnemonicWords </span><span>=</span><span> mnemonic</span><span>.</span><span>asWords</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span></span><span>final</span><span> recoveryPassword </span><span>=</span><span> randomEntropy</span><span>.</span><span>base64encode</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span>final</span><span> hashedPassword </span><span>=</span><span> </span><span>await</span><span> </span><span>SrpClient</span><span>.</span><span>computeKeyPassword</span><span>(</span><span></span><br/></span><span><span>  password</span><span>:</span><span> recoveryPassword</span><span>,</span><span></span><br/></span><span><span>  salt</span><span>:</span><span> salt</span><span>,</span><span></span><br/></span><span><span></span><span>)</span><span>;</span><span></span><br/></span><span><span></span><br/></span></code></pre></div></div>
<p>And this is how the start of <code>WalletKeyHelper</code> used to look like,</p>
<div><div><pre tabindex="0"><code><span><span>class</span><span> </span><span>WalletKeyHelper</span><span> </span><span>{</span><span></span><br/></span><span><span>  </span><span>static</span><span> </span><span>SecretKey</span><span> </span><span>generateSecretKey</span><span>(</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>    </span><span>final</span><span> </span><span>SecretKey</span><span> secretKey </span><span>=</span><span> </span><span>SecretKey</span><span>(</span><span>getRandomValues</span><span>(</span><span>32</span><span>)</span><span>)</span><span>;</span><span></span><br/></span><span><span>    </span><span>return</span><span> secretKey</span><span>;</span><span></span><br/></span><span><span>  </span><span>}</span><span></span><br/></span><span><span></span><br/></span><span><span>  </span><span>static</span><span> </span><span>Uint8List</span><span> </span><span>getRandomValues</span><span>(</span><span>int length</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>    </span><span>final</span><span> </span><span>Random</span><span> random </span><span>=</span><span> </span><span>Random</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span>    </span><span>final</span><span> </span><span>List</span><span>&lt;</span><span>int</span><span>&gt;</span><span> bytes </span><span>=</span><span> </span><span>List</span><span>&lt;</span><span>int</span><span>&gt;</span><span>.</span><span>generate</span><span>(</span><span>length</span><span>,</span><span> </span><span>(</span><span>_</span><span>)</span><span> </span><span>=</span><span>&gt;</span><span> random</span><span>.</span><span>nextInt</span><span>(</span><span>256</span><span>)</span><span>)</span><span>;</span><span></span><br/></span><span><span>    </span><span>return</span><span> </span><span>Uint8List</span><span>.</span><span>fromList</span><span>(</span><span>bytes</span><span>)</span><span>;</span><span></span><br/></span><span><span>  </span><span>}</span><span></span><br/></span><span><span>  </span><span></span><br/></span><span><span></span><span>}</span><br/></span></code></pre></div></div>
<p>which uses the insecure <code>Random()</code> construct we discussed in the <a href="https://www.zellic.io/blog/proton-dart-flutter-csprng-prng#flutter-is-not-so-random">Dart SDK vulnerability</a>. This means that there were only <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>32</mn></msup></mrow><annotation encoding="application/x-tex">2^{32}</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>32</span></span></span></span></span></span></span></span></span></span></span></span> unique recovery phrases available, and if a user manages to guess the correct one, they would get immediate access to the account while also bypassing 2FA. Proton employs captchas when a user guesses the incorrect phrase too many times, and it was not (to our knowledge) possible for remote users to detect if an account has an insecurely generated phrase or not. But the opportunity existed, and it opened up for internal attacks from users with database access or cracking data stemming from hacks or subpoenas. Brute forcing four billion recovery phrases — despite captcha requirements — is well within the budget and capabilities of many nation states and threat actors. Their issue would be to detect if an account was vulnerable or not. Proton does store metadata about which client created the phrase and when, but this is not externally visible unless logged in.</p>
<p>Proton managed to detect all these vulnerable phrases and invalidated them on their server. Users logging in will be met with this message, prompting them to update the recovery phrase.</p>
<p><img decoding="async" loading="lazy" alt="Outdated recovery phrase" src="https://blog-cdn.zellic.io/blog/assets/images/outdated-969ca9f79cb1421fbaf240b3a05efd0d.png" width="672" height="230"/></p>
<p>The vulnerable Flutter application version was also blocked from logging in entirely, making it impossible to accidentally generate a new, vulnerable recovery phrase. Do note that this only bug only affected people that used the preview version of the Proton Wallet application, had early access to the Wallet application, and created their recovery phrase through that application. <strong>The issue was present for only 1 day, and Proton has invalidated all vulnerable recovery phrases.</strong></p>
<h3 id="the-brute-force-attack">The Brute-Force Attack<a aria-label="Direct link to The Brute-Force Attack" title="Direct link to The Brute-Force Attack" href="https://www.zellic.io/blog/proton-dart-flutter-csprng-prng#the-brute-force-attack">​</a></h3>
<p>The various applications in the Proton ecosystem (e.g., the Proton Wallet), will sometimes generate random passwords that protect certain pieces of data. These passwords can be encrypted using the private or public key of the current user account. The piece of data can then be stored together with this encrypted password, and knowledge about the account password is required to decrypt the password and then decrypt the data itself.</p>
<p>Here is how the Proton Wallet Flutter application used to do this when encrypting the wallet mnemonic and wallet name:</p>
<div><div><pre tabindex="0"><code><span><span>  </span><span>Future</span><span>&lt;</span><span>ApiWalletData</span><span>&gt;</span><span> </span><span>createWallet</span><span>(</span><span></span><br/></span><span><span>    </span><span>String</span><span> walletName</span><span>,</span><span></span><br/></span><span><span>    </span><span>String</span><span> mnemonicStr</span><span>,</span><span></span><br/></span><span><span>    </span><span>Network</span><span> network</span><span>,</span><span></span><br/></span><span><span>    int walletType</span><span>,</span><span></span><br/></span><span><span>    </span><span>String</span><span> walletPassphrase</span><span>,</span><span></span><br/></span><span><span>  </span><span>)</span><span> </span><span>async</span><span> </span><span>{</span><span></span><br/></span><span><span>    </span><span></span><br/></span><span><span>    </span><span>final</span><span> </span><span>SecretKey</span><span> secretKey </span><span>=</span><span> </span><span>WalletKeyHelper</span><span>.</span><span>generateSecretKey</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span>    </span><span>final</span><span> </span><span>Uint8List</span><span> entropy </span><span>=</span><span> </span><span>Uint8List</span><span>.</span><span>fromList</span><span>(</span><span>await</span><span> secretKey</span><span>.</span><span>extractBytes</span><span>(</span><span>)</span><span>)</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span></span><br/></span><span><span>    </span><span>final</span><span> primaryUserKey </span><span>=</span><span> </span><span>await</span><span> userManager</span><span>.</span><span>getPrimaryKey</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span>    </span><span>final</span><span> </span><span>String</span><span> userPrivateKey </span><span>=</span><span> primaryUserKey</span><span>.</span><span>privateKey</span><span>;</span><span></span><br/></span><span><span>    </span><span>final</span><span> </span><span>String</span><span> userKeyID </span><span>=</span><span> primaryUserKey</span><span>.</span><span>keyID</span><span>;</span><span></span><br/></span><span><span>    </span><span>final</span><span> </span><span>String</span><span> passphrase </span><span>=</span><span> primaryUserKey</span><span>.</span><span>passphrase</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span></span><br/></span><span><span>    </span><span>final</span><span> </span><span>String</span><span> encryptedMnemonic </span><span>=</span><span> </span><span>await</span><span> </span><span>WalletKeyHelper</span><span>.</span><span>encrypt</span><span>(</span><span></span><br/></span><span><span>      secretKey</span><span>,</span><span></span><br/></span><span><span>      mnemonicStr</span><span>,</span><span></span><br/></span><span><span>    </span><span>)</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span></span><br/></span><span><span>    </span><span>final</span><span> </span><span>String</span><span> clearWalletName </span><span>=</span><span> walletName</span><span>.</span><span>isNotEmpty </span><span>?</span><span> walletName </span><span>:</span><span> </span><span>&#34;My Wallet&#34;</span><span>;</span><span></span><br/></span><span><span>    </span><span>final</span><span> </span><span>String</span><span> encryptedWalletName </span><span>=</span><span> </span><span>await</span><span> </span><span>WalletKeyHelper</span><span>.</span><span>encrypt</span><span>(</span><span></span><br/></span><span><span>      secretKey</span><span>,</span><span></span><br/></span><span><span>      clearWalletName</span><span>,</span><span></span><br/></span><span><span>    </span><span>)</span><span>;</span><span></span><br/></span><span><span>    </span><span></span><br/></span><span><span>  </span><span>}</span><br/></span></code></pre></div></div>
<p>The class <code>WalletKeyHelper</code> is the same as before, this time calling <code>generateSecretKey()</code> instead of <code>getRandomValues()</code>:</p>
<div><div><pre tabindex="0"><code><span><span>class</span><span> </span><span>WalletKeyHelper</span><span> </span><span>{</span><span></span><br/></span><span><span>  </span><span>static</span><span> </span><span>SecretKey</span><span> </span><span>generateSecretKey</span><span>(</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>    </span><span>final</span><span> </span><span>SecretKey</span><span> secretKey </span><span>=</span><span> </span><span>SecretKey</span><span>(</span><span>getRandomValues</span><span>(</span><span>32</span><span>)</span><span>)</span><span>;</span><span></span><br/></span><span><span>    </span><span>return</span><span> secretKey</span><span>;</span><span></span><br/></span><span><span>  </span><span>}</span><span></span><br/></span><span><span></span><br/></span><span><span>  </span><span>static</span><span> </span><span>Uint8List</span><span> </span><span>getRandomValues</span><span>(</span><span>int length</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>    </span><span>final</span><span> </span><span>Random</span><span> random </span><span>=</span><span> </span><span>Random</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span>    </span><span>final</span><span> </span><span>List</span><span>&lt;</span><span>int</span><span>&gt;</span><span> bytes </span><span>=</span><span> </span><span>List</span><span>&lt;</span><span>int</span><span>&gt;</span><span>.</span><span>generate</span><span>(</span><span>length</span><span>,</span><span> </span><span>(</span><span>_</span><span>)</span><span> </span><span>=</span><span>&gt;</span><span> random</span><span>.</span><span>nextInt</span><span>(</span><span>256</span><span>)</span><span>)</span><span>;</span><span></span><br/></span><span><span>    </span><span>return</span><span> </span><span>Uint8List</span><span>.</span><span>fromList</span><span>(</span><span>bytes</span><span>)</span><span>;</span><span></span><br/></span><span><span>  </span><span>}</span><span></span><br/></span><span><span>  </span><span></span><br/></span><span><span></span><span>}</span><br/></span></code></pre></div></div>
<p>However, the former is just a wrapper for the latter, and the same bug is introduced here. To our knowledge, the wallet mnemonic itself is securely generated. But when the mnemonic and wallet name were encrypted for storage, the key used to store them on Proton’s servers was only 32 bits. This allowed anyone with server access to attempt brute forcing the key and get access both to the funds and any historic transactions of the user with it.</p>
<p>Decrypting one’s own mnemonic is also an event that requires reauthentication in order to unlock the master password used to unwrap wallet keys, but when the wallet is weak, we can just fetch the encrypted data and brute force it. We implemented a naive, threaded brute forcer to test the security of this. Thanks to Proton using AES-GCM, which includes a MAC/tag, we can quickly verify if the decryption was successful without any additional heuristics.</p>
<p>To test this, we used the old, vulnerable application to create a wallet. After authenticating once at some point, the user is allowed to call <code>GET https://wallet.proton.me/api/wallet/v1/wallets</code>, which fetches the encrypted wallet data in a concatenated format like <code>IV | ciphertext | MAC</code>. At this step, the user is supposed to authenticate again to get the secret value that unwraps the key to decrypt the wallet data, but we will sidestep this for demonstration purposes.</p>
<p>By inspecting the browser traffic, we get that the encrypted mnemonic is</p>
<p><code>pGxRIh/QNeAKidoUaTjg9xEuz55O5EeOnNrZnN2Zs66+e1R3qRqeM0H+HTOssHOPseQ+YRK3jNyCcNp7wsG6gypBv/xVDwwZH7jC+puX05/eJwWwBMOaEAWmmRgkuA6bR1kbFricwU7pAA5W3Q==</code></p>
<p>and the wallet name is this:</p>
<p><code>i3sVzkkK0YN9X4J9LqCX09ecvDmJjlqqx93rwyTJvZY64oPdittZ+zkjTg==</code></p>
<p>Parsing this and running a brute force that does not stop when the key is found, we can figure out the time it takes to exhaust all the possible passwords. Then, we can decrypt the data using a script like this:</p>
<div><div><pre tabindex="0"><code><span><span>from</span><span> Crypto</span><span>.</span><span>Cipher </span><span>import</span><span> AES</span><br/></span><span><span></span><span>from</span><span> base64 </span><span>import</span><span> b64decode</span><br/></span><span><span></span><span>import</span><span> sys</span><br/></span><span><span></span><br/></span><span><span>data </span><span>=</span><span> sys</span><span>.</span><span>argv</span><span>[</span><span>1</span><span>]</span><span></span><br/></span><span><span>key </span><span>=</span><span> </span><span>bytes</span><span>.</span><span>fromhex</span><span>(</span><span>sys</span><span>.</span><span>argv</span><span>[</span><span>2</span><span>]</span><span>)</span><span></span><br/></span><span><span></span><br/></span><span><span>data </span><span>=</span><span> b64decode</span><span>(</span><span>data</span><span>)</span><span></span><br/></span><span><span>iv </span><span>=</span><span> data</span><span>[</span><span>:</span><span>12</span><span>]</span><span></span><br/></span><span><span>tag </span><span>=</span><span> data</span><span>[</span><span>-</span><span>16</span><span>:</span><span>]</span><span></span><br/></span><span><span>ct </span><span>=</span><span> data</span><span>[</span><span>12</span><span>:</span><span>-</span><span>16</span><span>]</span><span></span><br/></span><span><span></span><br/></span><span><span>dec </span><span>=</span><span> AES</span><span>.</span><span>new</span><span>(</span><span>key</span><span>,</span><span> AES</span><span>.</span><span>MODE_GCM</span><span>,</span><span> nonce</span><span>=</span><span>iv</span><span>)</span><span>.</span><span>decrypt_and_verify</span><span>(</span><span>ct</span><span>,</span><span> tag</span><span>)</span><span></span><br/></span><span><span></span><span>print</span><span>(</span><span>dec</span><span>)</span><br/></span></code></pre></div></div>
<p>Using eight hyper-threaded cores on a normal desktop computer, we time the brute force:</p>
<div><div><pre tabindex="0"><code><span><span>$ time ./brute_aes</span><br/></span><span><span>All threads created, waiting for all to finish</span><br/></span><span><span>PTHREAD 0 ended</span><br/></span><span><span>PTHREAD 1 ended</span><br/></span><span><span>PTHREAD 2 ended</span><br/></span><span><span>PTHREAD 3 ended</span><br/></span><span><span>PTHREAD 4 ended</span><br/></span><span><span>PTHREAD 5 ended</span><br/></span><span><span>PTHREAD 6 ended</span><br/></span><span><span>Found the key:</span><br/></span><span><span>c8c3be3b2b4a54253f208749ff9bb6a152391b117dc3fe28f4df33afeca40281</span><br/></span><span><span>PTHREAD 7 ended</span><br/></span><span><span>PTHREAD 8 ended</span><br/></span><span><span>PTHREAD 9 ended</span><br/></span><span><span>PTHREAD 10 ended</span><br/></span><span><span>PTHREAD 11 ended</span><br/></span><span><span>PTHREAD 12 ended</span><br/></span><span><span>PTHREAD 13 ended</span><br/></span><span><span>PTHREAD 14 ended</span><br/></span><span><span>PTHREAD 15 ended</span><br/></span><span><span></span><br/></span><span><span>real    16m31.705s</span><br/></span><span><span>user    187m43.243s</span><br/></span><span><span>sys     0m1.210s</span><br/></span></code></pre></div></div>
<p>And it takes about 16 minutes to fully exhaust the entire <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>32</mn></msup></mrow><annotation encoding="application/x-tex">2^{32}</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>32</span></span></span></span></span></span></span></span></span></span></span></span> key space. Considering the relative cheap cost of online CPU cores, this is indeed trivial to recover if the information is obtained. Feeding the key into the initial Python script reveals both the mnemonic and the wallet name.</p>
<div><div><pre tabindex="0"><code><span><span>$ python3 decrypt.py pGxRIh/QNeAKi... c8c3be3b2b4...</span><br/></span><span><span>b&#39;miracle toy pudding isolate glide hour canvas circle violin olympic camera museum&#39;</span><br/></span><span><span></span><br/></span><span><span>$ python3 decrypt.py i3sVzkkK0YN9... c8c3be3b2b4...</span><br/></span><span><span>b&#39;Primary Account&#39;</span><br/></span></code></pre></div></div>
<p>Having weakly encrypted keys does not impose any immediate threats for the users, but for Proton it breaks some of the fundamentals in their threat model. It would be feasible for an insider, or an attacker with database access, to easily decrypt wallets. That includes data from subpoenas or other legal avenues that Proton usually has some protection against. Fetching the encrypted wallet data still comes with the requirement that the user has logged in at some point, but it lets an attacker skip a step. For instance, a stolen computer where a user is already logged into Proton Mail should not give access to the mnemonic without authenticating again.</p>
<p>Proton fixed this bug by encrypting all affected wallets with the public key of each user and simultaneously updating the Flutter application to support this new encryption scheme. By introducing a <code>migrationRequired</code> flag to the wallet schema, the Flutter application will now automatically decrypt and then migrate any wallets that are flagged server-side. The migration transparently decrypts then reencrypts the wallet with a secure key, and the key is then encrypted using the user key — as before. The fix can be found <a href="https://github.com/ProtonWallet/flutter-app/commit/633e16220c63c855fd4df7f0c87f039d602662fd" target="_blank" rel="noopener">here<span>↗</span></a>, which is a mirror of their internal repository.</p>
<h3 id="timeline-and-conclusion-1">Timeline and Conclusion<a aria-label="Direct link to Timeline and Conclusion" title="Direct link to Timeline and Conclusion" href="https://www.zellic.io/blog/proton-dart-flutter-csprng-prng#timeline-and-conclusion-1">​</a></h3>
<ul>
<li>July 25, 2024 — The weak randomness bug was reported. Proton acknowledged it, stating that they are looking into it. The bug was fixed internally the same day, but the code mirror was not updated. In the initial report, we believed the PRNG to be seeded with a 64-bit random because the desktop version used that.</li>
<li>July 26, 2024 — The code mirror was updated, and we noticed that it contained a fix. We sent them an update noting that the fix was proper but that some migration of existing wallets will be required.</li>
<li>July 27, 2024 — Proton acknowledged the fix and noted that bounty adjudication would be completed the following week.</li>
<li>August 1, 2024 — Proton responded, clearing up some technical confusion from the initial report and stating that the weak key is only ephemeral and then encrypted with a user key after.</li>
<li>August 15, 2024 — After getting a bounty and also the green light to discuss the bug with others, we discovered that the PRNG was only 32 bit on mobile platforms. That made some brute-force attacks feasible.</li>
<li>August 16, 2024 — The team responded, stating that they are looking into the new information. The upcoming days, we sent additional emails explaining various threats that were enabled by the weak PRNG.</li>
<li>August 21, 2024 — A thank you and acknowledgement were given from Proton — and a request for a 120-day embargo to make sure they could forcefully migrate old wallets.</li>
</ul>
<h2 id="3--predictable-passwords-in-selfprivacy">3 — Predictable Passwords in SelfPrivacy<a aria-label="Direct link to 3 — Predictable Passwords in SelfPrivacy" title="Direct link to 3 — Predictable Passwords in SelfPrivacy" href="https://www.zellic.io/blog/proton-dart-flutter-csprng-prng#3--predictable-passwords-in-selfprivacy">​</a></h2>
<p>Finally, we’ll take a look at <a href="https://selfprivacy.org/" target="_blank" rel="noopener">SelfPrivacy<span>↗</span></a>, which offers bootstrapping of various self-hosted services like Gitea, Nextcloud, Bitwarden, and more. Their automatic setup will create passwords, API tokens, and the like using the password_generator.dart utility library. It has this general structure:</p>
<div><div><pre tabindex="0"><code><span><span>import</span><span> </span><span>&#39;dart:math&#39;</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span>Random</span><span> _rnd </span><span>=</span><span> </span><span>Random</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span>typedef</span><span> </span><span>StringGeneratorFunction</span><span> </span><span>=</span><span> </span><span>String</span><span> </span><span>Function</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span>class</span><span> </span><span>StringGenerators</span><span> </span><span>{</span><span></span><br/></span><span><span>  </span><span>static</span><span> </span><span>const</span><span> </span><span>String</span><span> letters </span><span>=</span><span> </span><span>&#39;abcdefghijklmnopqrstuvwxyz&#39;</span><span>;</span><span></span><br/></span><span><span>  </span><span>static</span><span> </span><span>const</span><span> </span><span>String</span><span> numbers </span><span>=</span><span> </span><span>&#39;1234567890&#39;</span><span>;</span><span></span><br/></span><span><span>  </span><span>static</span><span> </span><span>const</span><span> </span><span>String</span><span> symbols </span><span>=</span><span> </span><span>&#39;_&#39;</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>  </span><span>static</span><span> </span><span>String</span><span> </span><span>getRandomString</span><span>(</span><span></span><br/></span><span><span>    </span><span>final</span><span> int length</span><span>,</span><span> </span><span>{</span><span></span><br/></span><span><span>    </span><span>final</span><span> hasLowercaseLetters </span><span>=</span><span> </span><span>false</span><span>,</span><span></span><br/></span><span><span>    </span><span>final</span><span> hasUppercaseLetters </span><span>=</span><span> </span><span>false</span><span>,</span><span></span><br/></span><span><span>    </span><span>final</span><span> hasNumbers </span><span>=</span><span> </span><span>false</span><span>,</span><span></span><br/></span><span><span>    </span><span>final</span><span> hasSymbols </span><span>=</span><span> </span><span>false</span><span>,</span><span></span><br/></span><span><span>    </span><span>final</span><span> isStrict </span><span>=</span><span> </span><span>false</span><span>,</span><span></span><br/></span><span><span>  </span><span>}</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>    </span><span>String</span><span> chars </span><span>=</span><span> </span><span>&#39;&#39;</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>if</span><span> </span><span>(</span><span>hasLowercaseLetters</span><span>)</span><span> </span><span>{</span><span>chars </span><span>+=</span><span> letters</span><span>;</span><span>}</span><span></span><br/></span><span><span>    </span><span>if</span><span> </span><span>(</span><span>hasUppercaseLetters</span><span>)</span><span> </span><span>{</span><span>chars </span><span>+=</span><span> letters</span><span>.</span><span>toUpperCase</span><span>(</span><span>)</span><span>;</span><span>}</span><span></span><br/></span><span><span>    </span><span>if</span><span> </span><span>(</span><span>hasNumbers</span><span>)</span><span> </span><span>{</span><span>chars </span><span>+=</span><span> numbers</span><span>;</span><span>}</span><span></span><br/></span><span><span>    </span><span>if</span><span> </span><span>(</span><span>hasSymbols</span><span>)</span><span> </span><span>{</span><span>chars </span><span>+=</span><span> symbols</span><span>;</span><span>}</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>assert</span><span>(</span><span>chars</span><span>.</span><span>isNotEmpty</span><span>,</span><span> </span><span>&#39;chart empty&#39;</span><span>)</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>if</span><span> </span><span>(</span><span>!</span><span>isStrict</span><span>)</span><span> </span><span>{</span><span>return</span><span> </span><span>genString</span><span>(</span><span>length</span><span>,</span><span> chars</span><span>)</span><span>;</span><span>}</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>String</span><span> res </span><span>=</span><span> </span><span>&#39;&#39;</span><span>;</span><span></span><br/></span><span><span>    int loose </span><span>=</span><span> length</span><span>;</span><span></span><br/></span><span><span>    </span><span></span><br/></span><span><span>    </span><span></span><br/></span><span><span>    res </span><span>+=</span><span> </span><span>genString</span><span>(</span><span>loose</span><span>,</span><span> chars</span><span>)</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>final</span><span> </span><span>List</span><span>&lt;</span><span>String</span><span>&gt;</span><span> shuffledlist </span><span>=</span><span> res</span><span>.</span><span>split</span><span>(</span><span>&#39;&#39;</span><span>)</span><span>.</span><span>.</span><span>shuffle</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span>    </span><span>return</span><span> shuffledlist</span><span>.</span><span>join</span><span>(</span><span>)</span><span>;</span><span></span><br/></span><span><span>  </span><span>}</span><span></span><br/></span><span><span></span><br/></span><span><span>  </span><span>static</span><span> </span><span>String</span><span> </span><span>genString</span><span>(</span><span>final</span><span> int length</span><span>,</span><span> </span><span>final</span><span> </span><span>String</span><span> chars</span><span>)</span><span> </span><span>=</span><span>&gt;</span><span></span><br/></span><span><span>      </span><span>String</span><span>.</span><span>fromCharCodes</span><span>(</span><span></span><br/></span><span><span>        </span><span>Iterable</span><span>.</span><span>generate</span><span>(</span><span></span><br/></span><span><span>          length</span><span>,</span><span></span><br/></span><span><span>          </span><span>(</span><span>final</span><span> _</span><span>)</span><span> </span><span>=</span><span>&gt;</span><span> chars</span><span>.</span><span>codeUnitAt</span><span>(</span><span></span><br/></span><span><span>            _rnd</span><span>.</span><span>nextInt</span><span>(</span><span>chars</span><span>.</span><span>length</span><span>)</span><span>,</span><span></span><br/></span><span><span>          </span><span>)</span><span>,</span><span></span><br/></span><span><span>        </span><span>)</span><span>,</span><span></span><br/></span><span><span>      </span><span>)</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>  </span><span>static</span><span> </span><span>StringGeneratorFunction</span><span> userPassword </span><span>=</span><span> </span><span>(</span><span>)</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>getRandomString</span><span>(</span><span></span><br/></span><span><span>        </span><span>8</span><span>,</span><span></span><br/></span><span><span>        hasLowercaseLetters</span><span>:</span><span> </span><span>true</span><span>,</span><span></span><br/></span><span><span>        hasUppercaseLetters</span><span>:</span><span> </span><span>true</span><span>,</span><span></span><br/></span><span><span>        hasNumbers</span><span>:</span><span> </span><span>true</span><span>,</span><span></span><br/></span><span><span>        isStrict</span><span>:</span><span> </span><span>true</span><span>,</span><span></span><br/></span><span><span>      </span><span>)</span><span>;</span><br/></span></code></pre></div></div>
<p>Their use of <code>Random _rnd = Random()</code> puts them also at risk, especially if used to generate API tokens that lack proper rate limits when brute forced. Sending <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>32</mn></msup></mrow><annotation encoding="application/x-tex">2^{32}</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>32</span></span></span></span></span></span></span></span></span></span></span></span> requests is not a fast ordeal but very feasible for a persistent attacker. As an additional weakness, the PRNG is not reinitialized when multiple passwords are generated. While it sometimes makes it more difficult to guess the password, it makes it extremely easy to go from one password to the next, as an attacker can recover the entire state of the PRNG and then generate all future passwords stemming from the same session.</p>
<h3 id="timeline-and-conclusion-2">Timeline and Conclusion<a aria-label="Direct link to Timeline and Conclusion" title="Direct link to Timeline and Conclusion" href="https://www.zellic.io/blog/proton-dart-flutter-csprng-prng#timeline-and-conclusion-2">​</a></h3>
<p>The bug was reported August 23, 2024, and it was acknowledged after only 21 minutes, asking to verify their proposed fix. After acknowledging, <a href="https://selfprivacy.org/blog/2024/07/30/version-0.12.0-release/#patch-0122" target="_blank" rel="noopener">a new release<span>↗</span></a> was pushed a few minutes later.</p>
<h2 id="long-story-short">Long Story Short<a aria-label="Direct link to Long Story Short" title="Direct link to Long Story Short" href="https://www.zellic.io/blog/proton-dart-flutter-csprng-prng#long-story-short">​</a></h2>
<p>These three issues were all caused by the same root cause; the usage of a non-cryptographically secure PRNG. All of the bugs were exacerbated by the unexpected low entropy in the Flutter PRNG, where the internal seeds are just 32 bits. We showed practical attacks that will recover secrets within a reasonable time and how they led to attacks on Flutter developers, users of the Proton Wallet mobile application, and users of SelfPrivacy.</p>
<h2 id="about-us">About Us<a aria-label="Direct link to About Us" title="Direct link to About Us" href="https://www.zellic.io/blog/proton-dart-flutter-csprng-prng#about-us">​</a></h2>
<p>Zellic specializes in securing emerging technologies. Our security researchers have uncovered vulnerabilities in the most valuable targets, from Fortune 500s to DeFi giants.</p>
<p>Developers, founders, and investors trust our security assessments to ship quickly, confidently, and without critical vulnerabilities. With our background in real-world offensive security research, we find what others miss.</p>
<p><a href="https://www.zellic.io/contact" target="_blank" rel="noopener">Contact us<span>↗</span></a> for an audit that’s better than the rest. Real audits, not rubber stamps.</p></div></div>
  </body>
</html>
