<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ferd.ca/my-blog-engine-is-the-erlang-build-tool.html">Original</a>
    <h1>My Blog Engine Is the Erlang Build Tool</h1>
    
    <div id="readability-page-1" class="page"><div id="content">
        
<p>From time to time, people ask me what I use to power my blog, maybe because they like the minimalist form it has. I tell them it’s a bad idea and that I use the Erlang compiler infrastructure for it, and they agree to look elsewhere.</p>

<p>After launching my <a href="https://ferd.ca/notes/">notes section</a>, I had to fully clean up my engine. I thought I could write about how it works because it’s fairly unique and interesting, even if you should probably not use it.</p>

<h3>The Requirements</h3>


<p>I first started my blog 14 years ago. It had <a href="https://web.archive.org/web/20100830183556/http://ferd.ca/">roughly the same structure</a> as it does <a href="https://web.archive.org/web/20240808105835/https://ferd.ca/">at the time of writing this</a>: a list of links and text with nothing else. It did poorly with mobile (which was still sort of new but I should really work to improve these days), but okay with screen readers. It’s gotta be minimal enough to load fast on old devices.</p>

<p>There’s absolutely nothing dynamic on here. No JavaScript, no comments, no tracking, and I’m pretty sure I’ve disabled most logging and retention.</p>

<p>I write into a void, either transcribing talks or putting down rants I’ve repeated 2-3 times to other people so it becomes faster to just link things in the future. I mostly don’t know what gets read or not, but over time I found this kept the experience better for me than chasing readers or views.</p>

<p>Basically, a static site is the best technology for me, but from time to time it’s nice to be able to update the layout, add some features (like syntax highlighting or an RSS feed) so it needs to be better than flat HTML files.</p>

<p>Internally it runs with <a href="https://github.com/erlydtl/erlydtl">erlydtl</a>, an Erlang implementation of Django Templates, which I really liked a decade and a half ago. It supports <a href="https://docs.djangoproject.com/en/5.1/ref/templates/language/#id1">template inheritance</a>, which is really neat to minimize files I have to edit. All I have is a bunch of files containing my posts, a few of these templates, and a little bit of Rebar3 config tying them together.</p>

<p>There are some features that erlydtl doesn’t support but that I wanted anyway, notably syntax highlighting (without JavaScript), markdown support, and including subsections of HTML files (a weird corner case to support RSS feeds without powering them with a database).</p>

<p>The feature I want to discuss here is “only rebuild what you strictly need to,” which I covered by using the Rebar3 compiler.</p>

<h3>Rebar3’s Compiler</h3>


<p><a href="https://rebar3.org/">Rebar3</a> is the Erlang community’s build tool, which <a href="https://sloughter.dev/">Tristan</a> and I launched over 10 years ago, a follower to the classic <a href="https://github.com/rebar/rebar">rebar 2.x script</a>.</p>

<p>A funny requirement for Rebar3 is that Erlang has multiple compilers: one for Erlang, but also one for <a href="https://www.erlang.org/doc/apps/snmp/snmp_mib_compiler.html">MIB files (for SNMP)</a>, the <a href="https://www.erlang.org/doc/apps/parsetools/leex.html">Leex</a> syntax analyzer generator, and the <a href="https://www.erlang.org/doc/apps/parsetools/yecc.html">Yecc</a> parser generator. It also is plugin-friendly in order to compile Elixir modules, and other BEAM languages, like <a href="https://github.com/lfe/rebar3">LFE</a>, or very early versions of Gleam.</p>

<p>We needed to support at least four compilers out of the box, and to properly track everything such that we only rebuild what we must. This is done using a Directed Acyclic Graph (DAG) to track all files, including build artifacts.</p>

<p>The Rebar3 compiler infrastructure works by breaking up the flow of compilation in a generic and specific subset.</p>

<p>The specific subset will:</p>

<ol>
<li>Define which file types and paths must be considered by the compiler.</li>
<li>Define which files are dependencies of other files.</li>
<li>Be given a graph of all files and their artifacts with their last modified times (and metadata), and specify which of them need rebuilding.</li>
<li>Compile individual files and provide metadata to track the artifacts.</li>
</ol>
<p>The generic subset will:</p>

<ol>
<li>Scan files and update their timestamps in a graph for the last modifications.</li>
<li>Use the dependency information to complete the dependency graph.</li>
<li>Propagate the timestamps of source files modifications transitively through the graph (assume you update header A, included by header B, applied by macro C, on file D; then B, C, and D are all marked as modified as recently as A in the DAG).</li>
<li>Pass this updated graph to the specific part to get a list of files to build (usually by comparing which source files are newer than their artifacts, but also if build options changed).</li>
<li>Schedule sequential or parallel compilation based on what the specific part specified.</li>
<li>Update the DAG with the artifacts and build metadata, and persist the data to disk.</li>
</ol>
<p>In short, you build a compiler plugin that can name directories, file extensions, dependencies, and can compare timestamps and metadata. Then make sure this plugin can compile individual files, and the rest is handled for you.</p>

<h3>The blog engine</h3>


<p>Since I’m currently the most active Rebar3 maintainer, I’ve definitely got to maintain the compiler infrastructure described earlier.</p>

<p>Since my blog needed to rebuild the fewest static files possible and I already used a template compiler, plugging it into Rebar3 became the solution demanding the least effort.</p>

<p>It requires <a href="https://github.com/ferd/blog3r/blob/1.0.0/src/blog3r_compile.erl#L24-L101">a few hundred lines of code</a> to write <a href="https://github.com/ferd/blog3r/tree/1.0.0?tab=readme-ov-file#configuration">the plugin</a> and a bit of config looking like this:</p>

<div><pre><span></span><span>{</span><span>blog3r</span><span>,</span><span> </span><span>[</span>
<span>    </span><span>{</span><span>vars</span><span>,</span><span> </span><span>[</span>
<span>        </span><span>{</span><span>url</span><span>,</span><span> </span><span>[</span>
<span>               </span><span>{</span><span>base</span><span>,</span><span> </span><span>&#34;https://ferd.ca/&#34;</span><span>},</span>
<span>               </span><span>{</span><span>notes</span><span>,</span><span> </span><span>&#34;https://ferd.ca/notes/&#34;</span><span>},</span>
<span>               </span><span>{</span><span>img</span><span>,</span><span> </span><span>&#34;https://ferd.ca/static/img/&#34;</span><span>},</span>
<span>               </span><span>...</span>
<span>    </span><span>]},</span>
<span>    </span><span>%% Main site</span>
<span>    </span><span>{</span><span>index</span><span>,</span><span> </span><span>#{</span>
<span>        </span><span>template</span><span> </span><span>=&gt;</span><span> </span><span>&#34;index.tpl&#34;</span><span>,</span><span> </span><span>out</span><span> </span><span>=&gt;</span><span> </span><span>&#34;index.html&#34;</span><span>,</span>
<span>        </span><span>section</span><span> </span><span>=&gt;</span><span> </span><span>main</span>
<span>    </span><span>}},</span>
<span>    </span><span>{</span><span>index</span><span>,</span><span> </span><span>#{</span>
<span>        </span><span>template</span><span> </span><span>=&gt;</span><span> </span><span>&#34;rss.tpl&#34;</span><span>,</span><span> </span><span>out</span><span> </span><span>=&gt;</span><span> </span><span>&#34;feed.rss&#34;</span><span>,</span>
<span>        </span><span>section</span><span> </span><span>=&gt;</span><span> </span><span>main</span>
<span>    </span><span>}},</span>
<span>    </span><span>%% Notes section</span>
<span>    </span><span>{</span><span>index</span><span>,</span><span> </span><span>#{</span>
<span>        </span><span>template</span><span> </span><span>=&gt;</span><span> </span><span>&#34;index-notes.tpl&#34;</span><span>,</span><span> </span><span>out</span><span> </span><span>=&gt;</span><span> </span><span>&#34;notes/index.html&#34;</span><span>,</span>
<span>        </span><span>section</span><span> </span><span>=&gt;</span><span> </span><span>notes</span>
<span>    </span><span>}},</span>
<span>    </span><span>{</span><span>index</span><span>,</span><span> </span><span>#{</span>
<span>        </span><span>template</span><span> </span><span>=&gt;</span><span> </span><span>&#34;rss-notes.tpl&#34;</span><span>,</span><span> </span><span>out</span><span> </span><span>=&gt;</span><span> </span><span>&#34;notes/feed.rss&#34;</span><span>,</span>
<span>        </span><span>section</span><span> </span><span>=&gt;</span><span> </span><span>notes</span>
<span>    </span><span>}},</span>
<span>    </span><span>%% All sections&#39; pages.</span>
<span>    </span><span>{</span><span>sections</span><span>,</span><span> </span><span>#{</span>
<span>        </span><span>main</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span>&#34;posts/&#34;</span><span>,</span><span> </span><span>&#34;./&#34;</span><span>,</span><span> </span><span>[</span>
<span>            </span><span>{</span><span>&#34;Mon, 02 Sep 2024 11:00:00 EDT&#34;</span><span>,</span><span> </span><span>&#34;My Blog Engine is the Erlang Build Tool&#34;</span><span>,</span><span> </span><span>&#34;blog-engine-erlang-build-tool.md.tpl&#34;</span><span>},</span>
<span>            </span><span>{</span><span>&#34;Thu, 30 May 2024 15:00:00 EDT&#34;</span><span>,</span><span> </span><span>&#34;The Review Is the Action Item&#34;</span><span>,</span><span> </span><span>&#34;the-review-is-the-action-item.md.tpl&#34;</span><span>},</span>
<span>            </span><span>{</span><span>&#34;Tue, 19 Mar 2024 11:00:00 EDT&#34;</span><span>,</span><span> </span><span>&#34;A Commentary on Defining Observability&#34;</span><span>,</span><span> </span><span>&#34;a-commentary-on-defining-observability.md.tpl&#34;</span><span>},</span>
<span>            </span><span>{</span><span>&#34;Wed, 07 Feb 2024 19:00:00 EST&#34;</span><span>,</span><span> </span><span>&#34;A Distributed Systems Reading List&#34;</span><span>,</span><span> </span><span>&#34;distsys-reading-list.md.tpl&#34;</span><span>},</span>
<span>            </span><span>...</span>
<span>        </span><span>]},</span>
<span>        </span><span>notes</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span>&#34;notes/&#34;</span><span>,</span><span> </span><span>&#34;notes/&#34;</span><span>,</span><span> </span><span>[</span>
<span>            </span><span>{</span><span>&#34;Fri, 16 Aug 2024 10:30:00 EDT&#34;</span><span>,</span><span> </span><span>&#34;Paper: Psychological Safety: The History, Renaissance, and Future of an Interpersonal Construct&#34;</span><span>,</span><span> </span><span>&#34;papers/psychological-safety-interpersonal-construct.md.tpl&#34;</span><span>},</span>
<span>            </span><span>{</span><span>&#34;Fri, 02 Aug 2024 09:30:00 EDT&#34;</span><span>,</span><span> </span><span>&#34;Atomic Accidents and Uneven Blame&#34;</span><span>,</span><span> </span><span>&#34;atomic-accidents-and-uneven-blame.md.tpl&#34;</span><span>},</span>
<span>            </span><span>{</span><span>&#34;Sat, 27 Jul 2024 12:00:00 EDT&#34;</span><span>,</span><span> </span><span>&#34;Paper: Moral Crumple Zones&#34;</span><span>,</span><span> </span><span>&#34;papers/moral-crumple-zones.md.tpl&#34;</span><span>},</span>
<span>            </span><span>{</span><span>&#34;Tue, 16 Jul 2024 19:00:00 EDT&#34;</span><span>,</span><span> </span><span>&#34;Hutchins&#39; Distributed Cognition in The Wild&#34;</span><span>,</span><span> </span><span>&#34;hutchins-distributed-cognition-in-the-wild.md.tpl&#34;</span><span>},</span>
<span>            </span><span>...</span>
<span>        </span><span>]}</span>
<span>    </span><span>}}</span>
<span>]}.</span>
</pre></div>

<p>And blog post entry files like this:</p>
<div><pre>{% extends &#34;base.tpl&#34; %}
{% block content %}

&lt;p&gt;I like cats. I like food. &lt;br /&gt;
   I don&#39;t especially like catfood though.&lt;/p&gt;

{% markdown %}
### Have a subtitle

And then _all sorts_ of content!

- lists
- other lists
- [links]({{ url.base }}section/page))
- and whatever fits a demo

&gt; Have a quote to close this out

{% endmarkdown %}
{% endblock %}</pre></div>
<p>These call to a parent template (see <a href="https://github.com/ferd/blog3r/blob/1.0.0/priv/base.tpl">base.tpl</a> for the structure) to inject their content.</p>

<p>The whole site gets generated that way. Even compiler error messages are lifted from the Rebar3 libraries (although I haven&#39;t wrapped everything perfectly yet), with the following coming up when I forgot to close an <code>if</code> tag before closing a <code>for</code> loop:</p>
<pre>$ rebar3 compile
===&gt; Verifying dependencies...
===&gt; Analyzing applications...
===&gt; Compiling ferd_ca
===&gt; template error:
    ┌─ /home/ferd/code/ferd-ca/templates/rss.tpl:
    │
 24 │      {% endfor %}
    │         ╰── syntax error before: &#34;endfor&#34;

===&gt; Compiling templates/rss.tpl failed
</pre>
<p>As you can see, I build my blog by calling <code>rebar3 compile</code>, the same command as I do for any Erlang project.</p>

<p>I find it interesting that on one hand, this is pretty much the best design possible for me given that it represents almost no new code, no new tools, and no new costs. It’s quite optimal. On the other hand, it’s possibly the worst possible tool chain imaginable for a blog engine for almost anybody else.</p>

        </div></div>
  </body>
</html>
