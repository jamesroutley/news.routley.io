<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lgug2z.com/articles/deploying-a-cloudflare-r2-backed-nix-binary-cache-attic-on-fly-io/">Original</a>
    <h1>Cloudflare R2-Backed Nix Binary Cache on Fly.io</h1>
    
    <div id="readability-page-1" class="page"><div><div>
        <p>I have tried running the <a href="https://github.com/zhaofengli/attic">Attic Nix Binary
Cache</a> on my Hetzner dedicated server in
Germany a few times in the past, but the peering issues and the latency to
Xfinity in Seattle have always made me throw my hands up in frustration.</p>
<p>This morning I noticed <a href="https://github.com/zhaofengli/attic/issues/1#issuecomment-1368527062">a
comment</a>
by Zhaofeng on the repo issue tracker.</p>
<blockquote>
<p>As a NixOS aficionado myself, I begrudgingly admit that I‚Äôve been running my
instance on fly.io üòõ</p>
</blockquote>
<p>I‚Äôm not sure if this is comment is still current, but hey, if Zhaofeng is/was
running his binary cache on <a href="https://fly.io/">fly.io</a>, there‚Äôs no reason why we
can‚Äôt too, right?</p>
<h2 id="storage">Storage<a href="#storage" arialabel="Anchor">‚åó</a> </h2>
<p>While Attic does support local storage, I figured I‚Äôd use Cloudflare‚Äôs R2 as a
storage backend, both as an excuse to try out the <a href="https://developers.cloudflare.com/r2/pricing/">free
tier</a> (10GB), and because it‚Äôll
be easy enough to lift-and-shift if I ever decide to move the server from
fly.io.</p>
<p>It‚Äôs easy enough to create a new R2 bucket and grab a read-write API token
scoped to the bucket on the <a href="https://dash.cloudflare.com">Cloudflare Dashboard</a>.</p>
<h2 id="server-configuration">Server Configuration<a href="#server-configuration" arialabel="Anchor">‚åó</a> </h2>
<p>Once we have our credentials, we can put together a configuration file for the
Attic server based on the <a href="https://github.com/zhaofengli/attic/blob/e6bedf1869f382cfc51b69848d6e09d51585ead6/server/src/config-template.toml">example
config</a>.</p>
<div><pre tabindex="0"><code data-lang="toml"><span><span><span>listen</span> = <span>&#34;[::]:8080&#34;</span>
</span></span><span><span><span>token-hs256-secret-base64</span> = <span>&#34;&lt;generate this with openssl rand 64 | base64 -w0&gt;&#34;</span>
</span></span><span><span>
</span></span><span><span>[<span>database</span>]
</span></span><span><span><span>url</span> = <span>&#34;sqlite:///data/attic.db?mode=rwc&#34;</span>
</span></span><span><span>
</span></span><span><span>[<span>storage</span>]
</span></span><span><span><span>bucket</span> = <span>&#34;&lt;your bucket name&gt;&#34;</span>
</span></span><span><span><span>type</span> = <span>&#34;s3&#34;</span>
</span></span><span><span><span>region</span> = <span>&#34;auto&#34;</span>
</span></span><span><span><span>endpoint</span> = <span>&#34;https://&lt;your cloudflare account id&gt;.r2.cloudflarestorage.com&#34;</span>
</span></span><span><span>
</span></span><span><span>[<span>storage</span>.<span>credentials</span>]
</span></span><span><span><span>access_key_id</span> = <span>&#34;&lt;your access key id&gt;&#34;</span>
</span></span><span><span><span>secret_access_key</span> = <span>&#34;&lt;your secret access key&gt;&#34;</span>
</span></span><span><span>
</span></span><span><span>[<span>chunking</span>]
</span></span><span><span><span>nar-size-threshold</span> = <span>65536</span>
</span></span><span><span><span>min-size</span> = <span>16384</span>
</span></span><span><span><span>avg-size</span> = <span>65536</span>
</span></span><span><span><span>max-size</span> = <span>262144</span>
</span></span><span><span>
</span></span><span><span>[<span>compression</span>]
</span></span><span><span><span>type</span> = <span>&#34;zstd&#34;</span>
</span></span><span><span>
</span></span><span><span>[<span>garbage-collection</span>]
</span></span><span><span><span>interval</span> = <span>&#34;12 hours&#34;</span>
</span></span></code></pre></div><p>One thing to note is that we are storing our SQLite database file at
<code>/data/attic.db</code> - this is going to be a fly volume that we‚Äôll create soon.</p>
<p>You should probably <code>git-crypt</code> this file (or encrypt it with <code>sops</code> or <code>age</code>)
in your configuration repo since it has sensitive credentials.</p>
<p><strong>Not sure about how to handle secrets in NixOS configuration
repos? I have a big old article all about <a href="https://lgug2z.com/articles/handling-secrets-in-nixos-an-overview/">handling secrets in
NixOS</a>!</strong></p>
<h2 id="dockerfile">Dockerfile<a href="#dockerfile" arialabel="Anchor">‚åó</a> </h2>
<p>Luckily, there is an automatically published Docker image available for us to
extend. There isn‚Äôt much to do here except bring in our configration file,
reference it when we start <code>atticd</code> and ensure it‚Äôs running in <code>monolithic</code>
mode.</p>
<div><pre tabindex="0"><code data-lang="dockerfile"><span><span><span>FROM</span><span> ghcr.io/zhaofengli/attic:latest</span><span>
</span></span></span><span><span><span></span><span>COPY</span> ./server.toml /attic/server.toml<span>
</span></span></span><span><span><span></span><span>EXPOSE</span><span> 8080</span><span>
</span></span></span><span><span><span></span><span>CMD</span> [<span>&#34;-f&#34;</span>, <span>&#34;/attic/server.toml&#34;</span>, <span>&#34;--mode&#34;</span>, <span>&#34;monolithic&#34;</span>]<span>
</span></span></span></code></pre></div><h2 id="fly-config">Fly Config<a href="#fly-config" arialabel="Anchor">‚åó</a> </h2>
<p>The last piece of the deployment puzzle is to put together a <code>fly.toml</code> file for our
<code>atticd</code> instance.</p>
<p>Let‚Äôs start by ensuring we have a volume created in our desired region.</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>fly volume create atticdata -r sea -n <span>1</span>
</span></span></code></pre></div><p>The volume can be called whatever we want, we just need to make sure to update
the <code>source</code> in the <code>[mounts]</code> section in our <code>fly.toml</code> file.</p>
<div><pre tabindex="0"><code data-lang="toml"><span><span><span>app</span> = <span>&#34;&lt;pick your own fly app name&gt;&#34;</span>
</span></span><span><span><span>primary_region</span> = <span>&#34;sea&#34;</span>
</span></span><span><span>
</span></span><span><span>[<span>mounts</span>]
</span></span><span><span>  <span>source</span> = <span>&#34;atticdata&#34;</span>
</span></span><span><span>  <span>destination</span> = <span>&#34;/data&#34;</span>
</span></span><span><span>
</span></span><span><span>[<span>http_service</span>]
</span></span><span><span>  <span>internal_port</span> = <span>8080</span>
</span></span><span><span>  <span>force_https</span> = <span>true</span>
</span></span><span><span>  <span>auto_stop_machines</span> = <span>true</span>
</span></span><span><span>  <span>auto_start_machines</span> = <span>true</span>
</span></span><span><span>  <span>min_machines_running</span> = <span>0</span>
</span></span><span><span>  <span>processes</span> = [<span>&#34;app&#34;</span>]
</span></span><span><span>
</span></span><span><span>[<span>services</span>.<span>concurrency</span>]
</span></span><span><span>  <span>type</span> = <span>&#34;connections&#34;</span>
</span></span><span><span>  <span>hard_limit</span> = <span>1000</span>
</span></span><span><span>  <span>soft_limit</span> = <span>1000</span>
</span></span></code></pre></div><p>That‚Äôs pretty much it, time to <code>fly deploy</code>! (I do this with <code>--ha=false</code> since
I don‚Äôt want to create more than one machine)</p>
<h2 id="generating-an-attic-token">Generating an Attic token<a href="#generating-an-attic-token" arialabel="Anchor">‚åó</a> </h2>
<p>We‚Äôll need to execute a command on the newly deployed fly.io machine to
generate a ‚Äúgodmode‚Äù token for ourselves. Let‚Äôs start by getting the machine
ID.</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>fly machine list --json |  jq --raw-output <span>&#39;.[].id&#39;</span>
</span></span></code></pre></div><p>Then we can call the <code>atticadm</code> command on the fly.io machine via <code>fly machine exec</code> to generate our token.</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>fly machine exec &lt;your machine id&gt; <span>&#39;atticadm make-token --sub &#34;&lt;your preferred username&gt;&#34; --validity &#34;10y&#34; --pull &#34;*&#34; --push &#34;*&#34; --create-cache &#34;*&#34; --configure-cache &#34;*&#34; --configure-cache-retention &#34;*&#34; --destroy-cache &#34;*&#34; --delete &#34;*&#34; -f /attic/server.toml&#39;</span>
</span></span></code></pre></div><p>We need to keep this token somewhere safe and preferably encrypted. I keep mine
encrypted with <code>sops-nix</code> in my NixOS configuration monorepo and have it
decrypted and mounted to <code>/run/secrets/attic/token</code> on machines that have been
given access to decrypt it.</p>
<h2 id="logging-into-attic">Logging into Attic<a href="#logging-into-attic" arialabel="Anchor">‚åó</a> </h2>
<p>This part is pretty simple! We can call the server whatever we like in our
configuration; here ‚Äúfly‚Äù will do. The final two arguments are the URL
generated for our fly.io app and our access token.</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span><span># if pkgs.attic is installed in environment.systemPackages</span>
</span></span><span><span>attic login fly https://&lt;your fly app name&gt;.fly.dev <span>$(</span>cat /run/secrets/attic/token<span>)</span>
</span></span><span><span>
</span></span><span><span><span># if pkgs.attic is not installed, we can always run it directly from the flake</span>
</span></span><span><span>nix run github:zhaofengli/attic#default login fly https://&lt;your fly app name&gt;.fly.dev <span>$(</span>cat /run/secrets/attic/token<span>)</span>
</span></span></code></pre></div><h2 id="pushing-to-our-attic-cache">Pushing to our Attic cache<a href="#pushing-to-our-attic-cache" arialabel="Anchor">‚åó</a> </h2>
<p>Now that we have the <code>atticd</code> cache server running on fly.io and our computer
authenticated with a token that allows us to push, let‚Äôs set up a cache and
push our entire(!) system configuration.</p>
<p>Note: In my case 256MB of RAM was not enough to keep up with everything I
wanted to push! I suggest scaling the RAM to at least 512MB, if not 1GB with
<code>fly scale memory 512</code>. The snippet below assumes that you have bumped the RAM
to 512MB which <em>should</em> be able to handle three concurrent jobs (<code>-j 3</code>)
without the machine giving ‚Äúout of memory‚Äù errors and restarting the <code>atticd</code>
process.</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span><span># if pkgs.attic is installed in environment.systemPackages</span>
</span></span><span><span>attic cache create system -j <span>3</span>
</span></span><span><span>attic push system /run/current-system -j <span>3</span>
</span></span><span><span>
</span></span><span><span><span># if pkgs.attic is not installed, we can always run it directly from the flake</span>
</span></span><span><span>nix run github:zhaofengli/attic#default cache create system -j <span>3</span>
</span></span><span><span>nix run github:zhaofengli/attic#default push system /run/current-system -j <span>3</span>
</span></span></code></pre></div><h2 id="configuring-nixos-to-use-our-attic-binary-cache">Configuring NixOS to use our Attic binary cache<a href="#configuring-nixos-to-use-our-attic-binary-cache" arialabel="Anchor">‚åó</a> </h2>
<p>There are two things that we need to do before we can configure NixOS to use
our new binary cache.</p>
<p>First, we need to get the public key of our <code>system</code> cache.</p>
<p>Next, we need to create a <code>netrc</code> file which contains our <code>attic</code> token. The
format looks like this:</p>
<pre tabindex="0"><code>machine &lt;your fly app name&gt;.fly.dev
password &lt;your attic token&gt;
</code></pre><p>Since this file once again contains sensitive information, if you want to store
this in your configuration repo, I recommend encrypting it. In the example
below, I have added the <code>netrc</code> file contents via <code>sops-nix</code>, which mounts the
decrypted contents to <code>/run/secrets/attic/netrc</code> for machines that have been
given decryption access.</p>
<div><pre tabindex="0"><code data-lang="nix"><span><span>{
</span></span><span><span>  nix <span>=</span> {
</span></span><span><span>    settings <span>=</span> {
</span></span><span><span>      substituters <span>=</span> [
</span></span><span><span>        <span>&#34;https://nix-community.cachix.org?priority=41&#34;</span> <span># this is a useful public cache!</span>
</span></span><span><span>        <span>&#34;https://numtide.cachix.org?priority=42&#34;</span> <span># this is also a useful public cache!</span>
</span></span><span><span>        <span>&#34;https://&lt;your fly app name&gt;.fly.dev/system?priority=43&#34;</span>
</span></span><span><span>      ];
</span></span><span><span>      trusted-public-keys <span>=</span> [
</span></span><span><span>        <span>&#34;nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=&#34;</span>
</span></span><span><span>        <span>&#34;numtide.cachix.org-1:2ps1kLBUWjxIneOy1Ik6cQjb41X0iXVXeHigGmycPPE=&#34;</span>
</span></span><span><span>        <span>&#34;&lt;your cache public key&gt;&#34;</span>
</span></span><span><span>      ];
</span></span><span><span>
</span></span><span><span>      netrc-file <span>=</span> config<span>.</span>sops<span>.</span>secrets<span>.</span><span>&#34;attic/netrc&#34;</span><span>.</span>path;
</span></span><span><span>    };
</span></span><span><span>  };
</span></span><span><span>}
</span></span></code></pre></div><p>Now, when our NixOS machines are rebuilt:</p>
<ul>
<li>First the official NixOS cache (with a priority of 40) will be checked</li>
<li>Next, the <code>nix-community</code> public cache (with a priority of 41) will be checked</li>
<li>Next, the <code>numtide</code> public cache (with a priority of 42) will be checked</li>
<li>Finally, our private cache (with a priority of 43) will be checked</li>
<li>If there are no cache hits at all, the package will be built from source</li>
</ul>
<p>What we have at this point is pretty damn cool.</p>
<p><strong>In the next article we‚Äôll make this even cooler still</strong>, by setting up GitHub
Actions jobs <a href="https://hachyderm.io/@LGUG2Z/111767749455052075">to build each of our NixOS system configurations whenever we push
a new commit, and push the outputs of each those builds to our private <code>system</code>
cache</a>!</p>
<p>If you have any questions or comments you can reach out to me on
<a href="https://twitter.com/LGUG2Z">Twitter</a> and
<a href="https://hachyderm.io/@LGUG2Z">Mastodon</a>.</p>
<p>If you‚Äôre interested in what I read to come up with solutions like this one,
you can subscribe to my <a href="https://notado.app/feeds/jado/software-development">Software Development RSS
feed</a>.</p>
<p>If you‚Äôd like to watch me writing code while explaining what I‚Äôm doing, you can
also <a href="https://www.youtube.com/channel/UCeai3-do-9O4MNy9_xjO6mg?sub_confirmation=1">subscribe to my YouTube
channel</a>.</p>
<p>If you found this content valuable, or if you are a happy user of
<a href="https://github.com/LGUG2Z/komorebi"><code>komorebi</code></a> or my <a href="https://github.com/LGUG2Z">NixOS starter
templates</a>, please consider sponsoring me on
<a href="https://github.com/sponsors/LGUG2Z">GitHub</a> or tipping me on
<a href="https://ko-fi.com/lgug2z">Ko-fi</a>.</p>

      </div></div></div>
  </body>
</html>
