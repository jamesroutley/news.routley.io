<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://weiyen.net/articles/an-unusual-google-keyboard-bug">Original</a>
    <h1>An unusual Google Keyboard bug</h1>
    
    <div id="readability-page-1" class="page"><div data-mdx-content="true"><article><p>There&#39;s a subtle bug that happens when you&#39;re using Gboard (the Google keyboard) on Android on certain websites. Watch what happens after I type <code>test</code> into the <a href="https://www.theguardian.com/crosswords/cryptic/29529">Guardian crossword</a>, and try to delete the word:</p><figure><video src="/videos/guardian-crossword-bug.mp4" controls=""></video><figcaption>The bug in the Guardian crossword</figcaption></figure><p>In case you missed it, <strong>after typing T-E-S-T, I have to press <code>Backspace</code> 4 times before letters start getting deleted.</strong></p><p>This isn&#39;t limited to the Guardian crossword. This also happens in the <a href="https://www.typescriptlang.org/play/">Typescript playground</a>:</p><figure><video src="/videos/typescript-playground-bug.mp4" controls=""></video><figcaption>The bug in the Typescript playground</figcaption></figure><p>But this does not happen everywhere. Here are backspaces working as expected in a plain HTML input field:</p><figure><video src="/videos/normal-text-box.mp4" controls=""></video><figcaption>Backspaces working as expected in a plain HTML input field</figcaption></figure><p>This does not happen with iOS keyboards, or with Gboard on iOS. This appears to be specific to Gboard on Android.</p><h2>The bug</h2><p>The cause of the bug is that <strong>Gboard doesn&#39;t issue the correct keyCode in its keydown/keypress/keyup browser events.</strong></p><p>I&#39;ve built a <a href="https://weiyen.net/projects/key-event-viewer">keyboard events viewer</a> to help illustrate the issue.</p><p>Normally, when you type a letter e.g. &#39;t&#39;, the browser should fire a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/keydown_event">keydown</a> event with keyCode <code>84</code>, and then a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/keyup_event">keyup</a> event with keyCode <code>84</code>. Typing a backspace is similar, except the keyCode is <code>8</code>.</p><figure><video src="/videos/desktop-events.mp4" controls=""></video><figcaption>This is on Chrome 130, macOS 15</figcaption></figure><p>However, Gboard has a peculiar behaviour where when it&#39;s generating autocomplete suggestions, backspaces <em>always</em> have keyCode <code>229</code> - <code>Unidentified</code>. But once it&#39;s not generating suggestions, backspaces have the correct keyCode <code>8</code>.</p><figure><video src="/videos/gboard-events.mp4" controls=""></video><figcaption>Keyboard events in Gboard</figcaption></figure><p>This breaks any code that listens for any specific keyCode, e.g. if it&#39;s listening for the Backspace key by listening for keyCode <code>8</code>. This is also why backspaces worked after pressing it 4 times - once the word &#34;test&#34; was cleared from the autocomplete suggestions, the correct keyCode <code>8</code>was fired</p><h3>Is this a problem with Gboard, or with the browser?</h3><p>The same bug happens on Chrome on Android, and on Firefox on Android, but they appear to manifest in different ways.</p><p>In Chrome, <em>all letters</em> have keyCode <code>229</code>. In Firefox, typing letters generate the correct keyCode, but backspaces still have keyCode <code>229</code>, but with keyname <code>Process</code>.</p><p>Given that the one common denominator is Gboard, I&#39;m inclined to think it&#39;s a problem with Gboard.</p><h3>Why does this happen?</h3><p>Honestly, I do not know. If you are a developer for Gboard, and you happen to read this, any insight would be appreciated!</p><h2>The solution</h2><p>If you need to listen for the <code>Backspace</code> key specifically, the best workaround appears to be to listen to the <code>beforeinput</code> event on the input element, and check if the <code>inputType</code> is <code>deleteContentBackward</code>.</p><pre><p><span>let</span><span> input </span><span>=</span><span> </span><span>document</span><span>.</span><span>querySelector</span><span>(</span><span>&#39;input&#39;</span><span>)</span><span>;</span><span></span></p><p><span>input</span><span>.</span><span>addEventListener</span><span>(</span><span>&#39;beforeinput&#39;</span><span>,</span><span> </span><span>(</span><span>event</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span></span></p><p><span>    </span><span>if</span><span> </span><span>(</span><span>event</span><span>.</span><span>inputType</span><span> </span><span>===</span><span> </span><span>&#39;deleteContentBackward&#39;</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>    </span><span>}</span><span></span></p><p><span></span><span>}</span><span>)</span><span>;</span></p></pre><p>Note that if you are using React, there is <a href="https://github.com/facebook/react/issues/11211">yet another problem</a>. The <code>onBeforeInput</code> synthetic event doesn&#39;t contain the <code>inputType</code> property. Fortunately the workaround here is relatively straightforward - avoid using the <code>onBeforeInput</code> event handler on the input element, and instead manually subscribe to the <code>beforeinput</code> using <code>addEventListener</code>, e.g.</p><pre><p><span>const</span><span> ref </span><span>=</span><span> </span><span>useRef</span><span>&lt;</span><span>HTMLInputElement</span><span>&gt;</span><span>(</span><span>null</span><span>)</span><span>;</span><span></span></p><p><span></span><span>useEffect</span><span>(</span><span>(</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span></span></p><p><span>    </span><span>const</span><span> </span><span>listener</span><span> </span><span>=</span><span> </span><span>(</span><span>event</span><span>:</span><span> </span><span>InputEvent</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span></span></p><p><span>        </span><span>if</span><span> </span><span>(</span><span>event</span><span>.</span><span>inputType</span><span> </span><span>===</span><span> </span><span>&#39;deleteContentBackward&#39;</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>        </span><span>}</span><span></span></p><p><span>    </span><span>}</span><span></span></p><p><span>    ref</span><span>.</span><span>current</span><span>?.</span><span>addEventListener</span><span>(</span><span>&#39;beforeinput&#39;</span><span>,</span><span> listener</span><span>)</span><span>;</span><span></span></p><p><span>    </span><span>return</span><span> </span><span>(</span><span>)</span><span> </span><span>=&gt;</span><span> ref</span><span>.</span><span>current</span><span>?.</span><span>removeEventListener</span><span>(</span><span>&#39;beforeinput&#39;</span><span>,</span><span> listener</span><span>)</span><span>;</span><span></span></p><p><span></span><span>}</span><span>,</span><span> </span><span>[</span><span>]</span><span>)</span><span>;</span><span></span></p><p><span></span><span>return</span><span> </span><span>&lt;</span><span>input</span><span> </span><span>ref</span><span>=</span><span>{</span><span>ref</span><span>}</span><span> </span><span>/&gt;</span></p></pre><p>If you want to listen to specific letters, you can try and use the <code>data</code> prop in the <code>beforeinput</code> event.</p></article></div></div>
  </body>
</html>
