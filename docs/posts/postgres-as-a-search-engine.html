<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://anyblockers.com/posts/postgres-as-a-search-engine">Original</a>
    <h1>Postgres as a Search Engine</h1>
    
    <div id="readability-page-1" class="page"><p>Build a retrieval system with semantic, full-text, and fuzzy search in Postgres to be used as a backbone in RAG pipelines.</p><div>  <p><strong>Search is hard</strong>. It’s a critical part of many apps, but getting it right isn’t easy. This is especially true for RAG-pipelines where the quality of retrieval can make or break the entire process.</p>
<p>While semantic search is trendy, good old lexical search is still the backbone. Semantic techniques can improve results, but they work best when added to a solid text-based search foundation.</p>
<p>In this post, we’ll explore how to use Postgres to create a robust search engine. We’ll combine three techniques:</p>
<ol>
<li>Full-text search with <code>tsvector</code></li>
<li>Semantic search with <code>pgvector</code></li>
<li>Fuzzy matching with <code>pg_trgm</code></li>
<li>Bonus: BM25</li>
</ol>
<p>This approach might not be the absolute best for every situation, but it’s a great alternative to setting up a separate search service. It’s a solid starting point that you can implement and scale within your existing Postgres database.</p>
<p>I won’t go into why you should Just Use Postgres™️ for everything, but if you want to read about it, here are a couple of good resources:</p>

<h2 id="table-with-four-legs"><a data-heading-link="" href="#table-with-four-legs">Table with four legs</a></h2>
<p>This is the table we’ll work with as an example.</p>
<pre tabindex="0" data-language="sql"><code><span><span>create</span><span> table</span><span> documents</span><span> (</span></span>
<span><span>    id </span><span>bigint</span><span> primary key</span><span> generated</span><span> always</span><span> as</span><span> identity</span><span>,</span></span>
<span><span>    title </span><span>text</span><span>,</span></span>
<span><span>    fts_title tsvector </span><span>generated</span><span> always</span><span> as</span><span> (to_tsvector(</span><span>&#39;english&#39;</span><span>, title)) stored,</span></span>
<span><span>    embedding vector(</span><span>1536</span><span>)</span></span>
<span><span>);</span></span>
<span></span></code></pre>
<p>We’ll evolve this table down the road.
Since Supabase has a great article on implementing hybrid search, we’ll use that as a starting point. <a href="https://supabase.com/docs/guides/ai/hybrid-search" rel="nofollow" target="_blank">Hybrid search<span><img src="https://www.google.com/s2/favicons?domain=supabase.com&amp;sz=64"/></span></a></p>
<ul>
<li>Follow the guide to implement FTS with GIN-indexes and semantic search with pgvector (also known as bi-encoder dense retrieval).</li>
<li>From personal experience, I’d opt for 1536 dimensional embeddings since it’s gotten me way better results. Source: trust me.</li>
<li>I’ve replaced the Supabase function with just CTEs and a query, as well as prefixed the params with <code>$</code>. Here’s what it’ll look like:</li>
</ul>
<pre tabindex="0" data-language="sql"><code><span><span>with</span><span> full_text </span><span>as</span><span> (</span></span>
<span><span>    select</span></span>
<span><span>        id,</span></span>
<span><span>        -- Note: ts_rank_cd is not indexable but will only rank matches of the where clause</span></span>
<span><span>        -- which shouldn&#39;t be too big</span></span>
<span><span>        row_number</span><span>() </span><span>over</span><span>(</span><span>order by</span><span> ts_rank_cd(fts_title, websearch_to_tsquery($query_text)) </span><span>desc</span><span>) </span><span>as</span><span> rank_ix</span></span>
<span><span>    from</span></span>
<span><span>        documents</span></span>
<span><span>    where</span></span>
<span><span>        fts_title @@ websearch_to_tsquery($query_text)</span></span>
<span><span>    order by</span><span> rank_ix</span></span>
<span><span>    limit</span><span> least</span><span>($match_count, </span><span>30</span><span>)</span></span>
<span><span>),</span></span>
<span><span>semantic </span><span>as</span><span> (</span></span>
<span><span>    select</span></span>
<span><span>        id,</span></span>
<span><span>        row_number</span><span>() </span><span>over</span><span> (</span><span>order by</span><span> embedding </span><span>&lt;</span><span>#</span><span>&gt;</span><span> $query_embedding) </span><span>as</span><span> rank_ix</span></span>
<span><span>    from</span></span>
<span><span>        documents</span></span>
<span><span>    order by</span><span> rank_ix</span></span>
<span><span>    limit</span><span> least</span><span>($match_count, </span><span>30</span><span>)</span></span>
<span><span>)</span></span>
<span><span>select</span></span>
<span><span>    documents.</span><span>*</span></span>
<span><span>from</span></span>
<span><span>    full_text</span></span>
<span><span>    full outer join</span><span> semantic</span></span>
<span><span>        on</span><span> full_text</span><span>.</span><span>id</span><span> =</span><span> semantic</span><span>.</span><span>id</span></span>
<span><span>    join</span><span> documents</span></span>
<span><span>        on</span><span> coalesce</span><span>(</span><span>full_text</span><span>.</span><span>id</span><span>, </span><span>semantic</span><span>.</span><span>id</span><span>) </span><span>=</span><span> documents</span><span>.</span><span>id</span></span>
<span><span>order by</span></span>
<span><span>    coalesce</span><span>(</span><span>1</span><span>.</span><span>0</span><span> /</span><span> ($rrf_k </span><span>+</span><span> full_text</span><span>.</span><span>rank_ix</span><span>), </span><span>0</span><span>.</span><span>0</span><span>) </span><span>*</span><span> $full_text_weight </span><span>+</span></span>
<span><span>    coalesce</span><span>(</span><span>1</span><span>.</span><span>0</span><span> /</span><span> ($rrf_k </span><span>+</span><span> semantic</span><span>.</span><span>rank_ix</span><span>), </span><span>0</span><span>.</span><span>0</span><span>) </span><span>*</span><span> $semantic_weight</span></span>
<span><span>    desc</span></span>
<span><span>limit</span></span>
<span><span>    least</span><span>($match_count, </span><span>30</span><span>);</span></span>
<span></span></code></pre>
<p>Note: We’re using <code>coalesce</code> in several places for important reasons:</p>
<ol>
<li>
<p>In the <code>join</code> clause:</p>
<pre tabindex="0" data-language="sql"><code><span><span>join</span><span> documents</span></span>
<span><span>    on</span><span> coalesce</span><span>(</span><span>full_text</span><span>.</span><span>id</span><span>, </span><span>semantic</span><span>.</span><span>id</span><span>) </span><span>=</span><span> documents</span><span>.</span><span>id</span></span>
<span></span></code></pre>
<p>This ensures that we include results from both full-text and semantic searches, even if a document appears in only one of these result sets. If a document is found by full-text search but not by semantic search (or vice versa), we still want to include it.</p>
</li>
<li>
<p>In the <code>order by</code> clause:</p>
<pre tabindex="0" data-language="sql"><code><span><span>coalesce</span><span>(</span><span>1</span><span>.</span><span>0</span><span> /</span><span> ($rrf_k </span><span>+</span><span> full_text</span><span>.</span><span>rank_ix</span><span>), </span><span>0</span><span>.</span><span>0</span><span>) </span><span>*</span><span> $full_text_weight </span><span>+</span></span>
<span><span>coalesce</span><span>(</span><span>1</span><span>.</span><span>0</span><span> /</span><span> ($rrf_k </span><span>+</span><span> semantic</span><span>.</span><span>rank_ix</span><span>), </span><span>0</span><span>.</span><span>0</span><span>) </span><span>*</span><span> $semantic_weight</span></span>
<span></span></code></pre>
<p>This handles cases where a document might be present in one search result but not the other. If a document isn’t in the full-text results, its <code>full_text.rank_ix</code> will be NULL, so we use <code>coalesce</code> to treat it as 0.0 in the ranking calculation. The same applies for semantic search results.</p>
</li>
</ol>
<p>Here we’re using Reciprocal Ranked Fusion (RRF) to merge the results.</p>
<svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="-8 -8 799.71875 395.890625" style="max-width: 799.71875px;" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid-0"><g><marker orient="auto" markerHeight="12" markerWidth="12" markerUnits="userSpaceOnUse" refY="5" refX="6" viewBox="0 0 10 10" id="mermaid-0_flowchart-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="12" markerWidth="12" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" id="mermaid-0_flowchart-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" id="mermaid-0_flowchart-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" id="mermaid-0_flowchart-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" id="mermaid-0_flowchart-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" id="mermaid-0_flowchart-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g><g><g id="subGraph2"><rect height="83" width="247.90625" y="0" x="535.8125" ry="0" rx="0" style=""></rect><g transform="translate(640.640625, 0)"><foreignObject height="18" width="38.25"><p><span>List 3</span></p></foreignObject></g></g><g id="subGraph1"><rect height="83" width="247.90625" y="0" x="267.90625" ry="0" rx="0" style=""></rect><g transform="translate(372.734375, 0)"><foreignObject height="18" width="38.25"><p><span>List 2</span></p></foreignObject></g></g><g id="subGraph0"><rect height="83" width="247.90625" y="0" x="0" ry="0" rx="0" style=""></rect><g transform="translate(104.828125, 0)"><foreignObject height="18" width="38.25"><p><span>List 1</span></p></foreignObject></g></g></g><g><path marker-end="url(#mermaid-0_flowchart-pointEnd)" style="fill:none;" id="L-L1A-RRF-0" d="M47.836,58L47.836,62.167C47.836,66.333,47.836,74.667,47.836,83C47.836,91.333,47.836,99.667,98.725,113.581C149.615,127.495,251.394,146.989,302.284,156.737L353.173,166.484"></path><path marker-end="url(#mermaid-0_flowchart-pointEnd)" style="fill:none;" id="L-L1B-RRF-0" d="M123.508,58L123.508,62.167C123.508,66.333,123.508,74.667,123.508,83C123.508,91.333,123.508,99.667,162.039,113.292C200.571,126.917,277.634,145.835,316.165,155.293L354.697,164.752"></path><path marker-end="url(#mermaid-0_flowchart-pointEnd)" style="fill:none;" id="L-L1C-RRF-0" d="M199.625,58L199.625,62.167C199.625,66.333,199.625,74.667,199.625,83C199.625,91.333,199.625,99.667,225.883,112.826C252.141,125.985,304.656,143.971,330.914,152.963L357.172,161.956"></path><path marker-end="url(#mermaid-0_flowchart-pointEnd)" style="fill:none;" id="L-L2B-RRF-0" d="M315.742,58L315.742,62.167C315.742,66.333,315.742,74.667,315.742,83C315.742,91.333,315.742,99.667,324.218,111.131C332.693,122.596,349.645,137.193,358.12,144.491L366.596,151.789"></path><path marker-end="url(#mermaid-0_flowchart-pointEnd)" style="fill:none;" id="L-L2C-RRF-0" d="M391.859,58L391.859,62.167C391.859,66.333,391.859,74.667,391.859,83C391.859,91.333,391.859,99.667,391.925,107.2C391.991,114.734,392.123,121.467,392.189,124.834L392.255,128.201"></path><path marker-end="url(#mermaid-0_flowchart-pointEnd)" style="fill:none;" id="L-L2A-RRF-0" d="M467.977,58L467.977,62.167C467.977,66.333,467.977,74.667,467.977,83C467.977,91.333,467.977,99.667,459.662,111.125C451.348,122.584,434.72,137.168,426.405,144.46L418.091,151.752"></path><path marker-end="url(#mermaid-0_flowchart-pointEnd)" style="fill:none;" id="L-L3C-RRF-0" d="M584.094,58L584.094,62.167C584.094,66.333,584.094,74.667,584.094,83C584.094,91.333,584.094,99.667,558.002,112.824C531.91,125.982,479.727,143.964,453.635,152.955L427.543,161.946"></path><path marker-end="url(#mermaid-0_flowchart-pointEnd)" style="fill:none;" id="L-L3A-RRF-0" d="M660.211,58L660.211,62.167C660.211,66.333,660.211,74.667,660.211,83C660.211,91.333,660.211,99.667,621.846,113.291C583.481,126.916,506.751,145.831,468.386,155.289L430.021,164.747"></path><path marker-end="url(#mermaid-0_flowchart-pointEnd)" style="fill:none;" id="L-L3B-RRF-0" d="M735.883,58L735.883,62.167C735.883,66.333,735.883,74.667,735.883,83C735.883,91.333,735.883,99.667,685.16,113.58C634.437,127.494,532.991,146.987,482.268,156.734L431.545,166.481"></path><path marker-end="url(#mermaid-0_flowchart-pointEnd)" style="fill:none;" id="L-RRF-FR-0" d="M392.359,214.391L392.276,218.474C392.193,222.557,392.026,230.724,391.943,238.091C391.859,245.457,391.859,252.024,391.859,255.307L391.859,258.591"></path><path marker-end="url(#mermaid-0_flowchart-pointEnd)" style="fill:none;" id="L-FR-FRA-0" d="M361.684,296.891L354.065,301.057C346.445,305.224,331.205,313.557,323.585,321.007C315.965,328.457,315.965,335.024,315.965,338.307L315.965,341.591"></path><path marker-end="url(#mermaid-0_flowchart-pointEnd)" style="fill:none;" id="L-FR-FRB-0" d="M391.771,296.891L391.748,301.057C391.726,305.224,391.681,313.557,391.659,321.007C391.637,328.457,391.637,335.024,391.637,338.307L391.637,341.591"></path><path marker-end="url(#mermaid-0_flowchart-pointEnd)" style="fill:none;" id="L-FR-FRC-0" d="M422.034,296.891L429.654,301.057C437.274,305.224,452.514,313.557,460.134,321.007C467.754,328.457,467.754,335.024,467.754,338.307L467.754,341.591"></path></g><g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g></g><g><g transform="translate(584.09375, 41.5)" data-id="L3C" data-node="true" id="flowchart-L3C-6"><rect height="33" width="26.5625" y="-16.5" x="-13.28125" ry="0" rx="0" style=""></rect><g transform="translate(-5.78125, -9)" style=""><rect></rect><foreignObject height="18" width="11.5625"><p><span>C</span></p></foreignObject></g></g><g transform="translate(660.2109375, 41.5)" data-id="L3A" data-node="true" id="flowchart-L3A-7"><rect height="33" width="25.671875" y="-16.5" x="-12.8359375" ry="0" rx="0" style=""></rect><g transform="translate(-5.3359375, -9)" style=""><rect></rect><foreignObject height="18" width="10.671875"><p><span>A</span></p></foreignObject></g></g><g transform="translate(735.8828125, 41.5)" data-id="L3B" data-node="true" id="flowchart-L3B-8"><rect height="33" width="25.671875" y="-16.5" x="-12.8359375" ry="0" rx="0" style=""></rect><g transform="translate(-5.3359375, -9)" style=""><rect></rect><foreignObject height="18" width="10.671875"><p><span>B</span></p></foreignObject></g></g><g transform="translate(315.7421875, 41.5)" data-id="L2B" data-node="true" id="flowchart-L2B-3"><rect height="33" width="25.671875" y="-16.5" x="-12.8359375" ry="0" rx="0" style=""></rect><g transform="translate(-5.3359375, -9)" style=""><rect></rect><foreignObject height="18" width="10.671875"><p><span>B</span></p></foreignObject></g></g><g transform="translate(391.859375, 41.5)" data-id="L2C" data-node="true" id="flowchart-L2C-4"><rect height="33" width="26.5625" y="-16.5" x="-13.28125" ry="0" rx="0" style=""></rect><g transform="translate(-5.78125, -9)" style=""><rect></rect><foreignObject height="18" width="11.5625"><p><span>C</span></p></foreignObject></g></g><g transform="translate(467.9765625, 41.5)" data-id="L2A" data-node="true" id="flowchart-L2A-5"><rect height="33" width="25.671875" y="-16.5" x="-12.8359375" ry="0" rx="0" style=""></rect><g transform="translate(-5.3359375, -9)" style=""><rect></rect><foreignObject height="18" width="10.671875"><p><span>A</span></p></foreignObject></g></g><g transform="translate(47.8359375, 41.5)" data-id="L1A" data-node="true" id="flowchart-L1A-0"><rect height="33" width="25.671875" y="-16.5" x="-12.8359375" ry="0" rx="0" style=""></rect><g transform="translate(-5.3359375, -9)" style=""><rect></rect><foreignObject height="18" width="10.671875"><p><span>A</span></p></foreignObject></g></g><g transform="translate(123.5078125, 41.5)" data-id="L1B" data-node="true" id="flowchart-L1B-1"><rect height="33" width="25.671875" y="-16.5" x="-12.8359375" ry="0" rx="0" style=""></rect><g transform="translate(-5.3359375, -9)" style=""><rect></rect><foreignObject height="18" width="10.671875"><p><span>B</span></p></foreignObject></g></g><g transform="translate(199.625, 41.5)" data-id="L1C" data-node="true" id="flowchart-L1C-2"><rect height="33" width="26.5625" y="-16.5" x="-13.28125" ry="0" rx="0" style=""></rect><g transform="translate(-5.78125, -9)" style=""><rect></rect><foreignObject height="18" width="11.5625"><p><span>C</span></p></foreignObject></g></g><g transform="translate(391.859375, 173.4453125)" data-id="RRF" data-node="true" id="flowchart-RRF-10"><polygon style="" transform="translate(-40.4453125,40.4453125)" points="40.4453125,0 80.890625,-40.4453125 40.4453125,-80.890625 0,-40.4453125"></polygon><g transform="translate(-16.4453125, -9)" style=""><rect></rect><foreignObject height="18" width="32.890625"><p><span>RRF</span></p></foreignObject></g></g><g transform="translate(391.859375, 280.390625)" data-id="FR" data-node="true" id="flowchart-FR-28"><rect height="33" width="112.828125" y="-16.5" x="-56.4140625" ry="0" rx="0" style=""></rect><g transform="translate(-48.9140625, -9)" style=""><rect></rect><foreignObject height="18" width="97.828125"><p><span>Final Ranking</span></p></foreignObject></g></g><g transform="translate(315.96484375, 363.390625)" data-id="FRA" data-node="true" id="flowchart-FRA-30"><rect height="33" width="25.671875" y="-16.5" x="-12.8359375" ry="0" rx="0" style=""></rect><g transform="translate(-5.3359375, -9)" style=""><rect></rect><foreignObject height="18" width="10.671875"><p><span>A</span></p></foreignObject></g></g><g transform="translate(391.63671875, 363.390625)" data-id="FRB" data-node="true" id="flowchart-FRB-32"><rect height="33" width="25.671875" y="-16.5" x="-12.8359375" ry="0" rx="0" style=""></rect><g transform="translate(-5.3359375, -9)" style=""><rect></rect><foreignObject height="18" width="10.671875"><p><span>B</span></p></foreignObject></g></g><g transform="translate(467.75390625, 363.390625)" data-id="FRC" data-node="true" id="flowchart-FRC-34"><rect height="33" width="26.5625" y="-16.5" x="-13.28125" ry="0" rx="0" style=""></rect><g transform="translate(-5.78125, -9)" style=""><rect></rect><foreignObject height="18" width="11.5625"><p><span>C</span></p></foreignObject></g></g></g></g></g></svg>
<blockquote>
<p>This method ensures that items ranked high in multiple lists are given a high rank in the final list. It also ensures that items ranked high in only a few lists but low in others are not given a high rank in the final list. Placing the rank in the denominator when calculating score helps penalize the low ranking records.</p>
</blockquote>
<p>It’s also worth noting:</p>
<ul>
<li><code>$rrf_k</code>: To prevent extremely high scores for items ranked first (since we’re dividing by the rank), a k constant is often added to the denominator to smooth the score.</li>
<li><code>$ _weight</code>: We can assign a weight to each method. This is very useful when you’re tuning the results.</li>
</ul>
<h2 id="implementing-fuzzy-search"><a data-heading-link="" href="#implementing-fuzzy-search">Implementing fuzzy search</a></h2>
<p>While this gets us a long way, an immediate issue will be typos in named entities. While semantic search eliminates some of these issues by capturing similarity, it struggles to do so for names, acronyms, and other text that’s not semantically similar. To mitigate this, we’ll introduce the <code>pg_trgm</code> extension to allow for fuzzy searching.</p>
<pre tabindex="0" data-language="sql"><code><span><span>create</span><span> extension </span><span>if</span><span> not</span><span> exists</span><span> pg_trgm;</span></span>
<span></span></code></pre>
<p>It operates with Trigrams. Here’s how it works:</p>
<p><img src="https://anyblockers.com/_astro/trigrams.CyxTPrsW_Z4ew9V.svg" alt="Trigrams" width="800" height="300" loading="lazy" decoding="async"/></p>
<p>Trigrams are useful for fuzzy search because they break down words into three-character sequences. This allows for matching similar words even if they contain typos or slight variations. For example, “hello” and “helo” share many trigrams, making them easier to match in a fuzzy search.</p>
<p>You have to create a new index for the desired column like this:</p>
<pre tabindex="0" data-language="sql"><code><span><span>create</span><span> index</span><span> idx_documents_title_trgm</span><span> on</span><span> documents </span><span>using</span><span> gin (title gin_trgm_ops);</span></span>
<span></span></code></pre>
<p>After that, you need to add it to the full search query. The extension exposes the % operator to filter out text where similarity is larger than <code>pg_trgm.similarity_threshold</code> (default is 0.3). There are also several other operators that are useful. Everything is well documented here: <a href="https://www.Postgres.org/docs/current/pgtrgm.html" rel="nofollow" target="_blank">pg_trgm — support for similarity of text using trigram matching<span><img src="https://www.google.com/s2/favicons?domain=www.postgres.org&amp;sz=64"/></span></a></p>
<p>Here’s the new query with fuzzy searching implemented:</p>
<pre tabindex="0" data-language="sql"><code><span><span>with</span><span> fuzzy </span><span>as</span><span> ( </span></span>
<span><span>    select</span><span> id,</span></span>
<span><span>           similarity(title, $query_text) </span><span>as</span><span> sim_score,</span></span>
<span><span>           row_number</span><span>() </span><span>over</span><span> (</span><span>order by</span><span> similarity(title, $query_text) </span><span>desc</span><span>) </span><span>as</span><span> rank_ix</span></span>
<span><span>    from</span><span> documents</span></span>
<span><span>    where</span><span> title % $query_text</span></span>
<span><span>    order by</span><span> rank_ix</span></span>
<span><span>    limit</span><span> least</span><span>($match_count, </span><span>30</span><span>)</span></span>
<span><span>),</span></span>
<span><span>full_text </span><span>as</span><span> (</span></span>
<span><span>    select</span><span> id,</span></span>
<span><span>           ts_rank_cd(to_tsvector(</span><span>&#39;english&#39;</span><span>, title), websearch_to_tsquery($query_text)) </span><span>as</span><span> rank_score,</span></span>
<span><span>           row_number</span><span>() </span><span>over</span><span> (</span><span>order by</span><span> ts_rank_cd(to_tsvector(</span><span>&#39;english&#39;</span><span>, title), websearch_to_tsquery($query_text)) </span><span>desc</span><span>) </span><span>as</span><span> rank_ix</span></span>
<span><span>    from</span><span> documents</span></span>
<span><span>    where</span><span> to_tsvector(</span><span>&#39;english&#39;</span><span>, title) @@ websearch_to_tsquery($query_text)</span></span>
<span><span>    order by</span><span> rank_ix</span></span>
<span><span>    limit</span><span> least</span><span>($match_count, </span><span>30</span><span>)</span></span>
<span><span>),</span></span>
<span><span>semantic </span><span>as</span><span> (</span></span>
<span><span>    select</span><span> id,</span></span>
<span><span>           row_number</span><span>() </span><span>over</span><span> (</span><span>order by</span><span> embedding </span><span>&lt;</span><span>#</span><span>&gt;</span><span> $query_embedding) </span><span>as</span><span> rank_ix</span></span>
<span><span>    from</span><span> documents</span></span>
<span><span>    order by</span><span> rank_ix</span></span>
<span><span>    limit</span><span> least</span><span>($match_count, </span><span>30</span><span>)</span></span>
<span><span>)</span></span>
<span><span>select</span><span> documents.</span><span>*</span></span>
<span><span>from</span><span> fuzzy</span></span>
<span><span>full outer join</span><span> full_text </span><span>on</span><span> fuzzy</span><span>.</span><span>id</span><span> =</span><span> full_text</span><span>.</span><span>id</span></span>
<span><span>full outer join</span><span> semantic </span><span>on</span><span> coalesce</span><span>(</span><span>fuzzy</span><span>.</span><span>id</span><span>, </span><span>full_text</span><span>.</span><span>id</span><span>) </span><span>=</span><span> semantic</span><span>.</span><span>id</span></span>
<span><span>join</span><span> documents </span><span>on</span><span> coalesce</span><span>(</span><span>fuzzy</span><span>.</span><span>id</span><span>, </span><span>full_text</span><span>.</span><span>id</span><span>, </span><span>semantic</span><span>.</span><span>id</span><span>) </span><span>=</span><span> documents</span><span>.</span><span>id</span></span>
<span><span>order by</span></span>
<span><span>    coalesce</span><span>(</span><span>1</span><span>.</span><span>0</span><span> /</span><span> ($rrf_k </span><span>+</span><span> fuzzy</span><span>.</span><span>rank_ix</span><span>), </span><span>0</span><span>.</span><span>0</span><span>) </span><span>*</span><span> $fuzzy_weight </span><span>+</span></span>
<span><span>    coalesce</span><span>(</span><span>1</span><span>.</span><span>0</span><span> /</span><span> ($rrf_k </span><span>+</span><span> full_text</span><span>.</span><span>rank_ix</span><span>), </span><span>0</span><span>.</span><span>0</span><span>) </span><span>*</span><span> $full_text_weight </span><span>+</span></span>
<span><span>    coalesce</span><span>(</span><span>1</span><span>.</span><span>0</span><span> /</span><span> ($rrf_k </span><span>+</span><span> semantic</span><span>.</span><span>rank_ix</span><span>), </span><span>0</span><span>.</span><span>0</span><span>) </span><span>*</span><span> $semantic_weight</span></span>
<span><span>desc</span></span>
<span><span>limit</span><span> least</span><span>($match_count, </span><span>30</span><span>);</span></span>
<span></span></code></pre>
<h2 id="debugging-the-rankings"><a data-heading-link="" href="#debugging-the-rankings">Debugging the rankings</a></h2>
<p>When getting the results back, it’s very useful to understand why something matched and not. First, we need to ensure we’re returning all scores from the various CTEs.</p>
<pre tabindex="0" data-language="sql"><code><span><span>semantic </span><span>as</span><span> (</span></span>
<span><span>  select</span><span> id,</span></span>
<span><span>  1</span><span> -</span><span> (embedding </span><span>&lt;=&gt;</span><span> $query_embedding) </span><span>as</span><span> cosine_similarity, </span></span>
<span><span>)</span></span>
<span></span></code></pre>
<p>Next, we need to actually include it in the final response. I’ve found it useful to store as a JSON object that you can pass around however you want.</p>
<pre tabindex="0" data-language="sql"><code><span><span>select</span></span>
<span><span>  ...</span></span>
<span><span>  json_build_object(</span></span>
<span><span>      &#39;fuzzy&#39;</span><span>, json_build_object(</span><span>&#39;rank_ix&#39;</span><span>, </span><span>fuzzy</span><span>.</span><span>rank_ix</span><span>, </span><span>&#39;sim_score&#39;</span><span>, </span><span>fuzzy</span><span>.</span><span>sim_score</span><span>),</span></span>
<span><span>      &#39;full_text&#39;</span><span>, json_build_object(</span><span>&#39;rank_ix&#39;</span><span>, </span><span>full_text</span><span>.</span><span>rank_ix</span><span>, </span><span>&#39;rank_score&#39;</span><span>, </span><span>full_text</span><span>.</span><span>rank_score</span><span>),</span></span>
<span><span>      &#39;semantic&#39;</span><span>, json_build_object(</span><span>&#39;rank_ix&#39;</span><span>, </span><span>semantic</span><span>.</span><span>rank_ix</span><span>, </span><span>&#39;cosine_similarity&#39;</span><span>, </span><span>semantic</span><span>.</span><span>cosine_similarity</span><span>)</span></span>
<span><span>  ) </span><span>as</span><span> rankings</span></span>
<span><span>...</span></span>
<span></span></code></pre>
<p>Here’s what it’ll look like:</p>
<pre tabindex="0" data-language="json"><code><span><span>{</span></span>
<span><span>  &#34;rankings&#34;</span><span>: {</span></span>
<span><span>    &#34;fuzzy&#34;</span><span>: {</span></span>
<span><span>      &#34;rank_ix&#34;</span><span>: </span><span>5</span><span>,</span></span>
<span><span>      &#34;sim_score&#34;</span><span>: </span><span>0.6</span></span>
<span><span>    },</span></span>
<span><span>    &#34;full_text&#34;</span><span>: {</span></span>
<span><span>      &#34;rank_ix&#34;</span><span>: </span><span>4</span><span>,</span></span>
<span><span>      &#34;rank_score&#34;</span><span>: </span><span>0.756</span></span>
<span><span>    },</span></span>
<span><span>    &#34;semantic&#34;</span><span>: {</span></span>
<span><span>      &#34;rank_ix&#34;</span><span>: </span><span>1</span><span>,</span></span>
<span><span>      &#34;cosine_similarity&#34;</span><span>: </span><span>0.912</span></span>
<span><span>    }</span></span>
<span><span>  }</span></span>
<span><span>}</span></span>
<span></span></code></pre>
<h2 id="tuning-full-text-search"><a data-heading-link="" href="#tuning-full-text-search">Tuning full text search</a></h2>
<h3 id="weighing-tsvectors"><a data-heading-link="" href="#weighing-tsvectors">Weighing tsvectors</a></h3>
<p>Now, your actual documents might actually include some content and not just a title. Let’s go ahead and add a <code>body</code> column.</p>
<pre tabindex="0" data-language="sql"><code><span><span>create</span><span> table</span><span> documents</span><span> (</span></span>
<span><span>    id </span><span>bigint</span><span> primary key</span><span> generated</span><span> always</span><span> as</span><span> identity</span><span>,</span></span>
<span><span>    title </span><span>text</span><span>,</span></span>
<span><span>    body </span><span>text</span><span>, </span></span>
<span><span>    fts_title tsvector </span><span>generated</span><span> always</span><span> as</span><span> (to_tsvector(</span><span>&#39;english&#39;</span><span>, title)) stored, </span></span>
<span><span>    fts_body tsvector </span><span>generated</span><span> always</span><span> as</span><span> (to_tsvector(</span><span>&#39;english&#39;</span><span>, body)) stored, </span></span>
<span><span>    embedding vector(</span><span>1536</span><span>)</span></span>
<span><span>);</span></span>
<span></span></code></pre>
<p>As you can see, we’ll only keep a single embedding column even though we have multiple fields. Personally, I’ve found no significant performance in keeping multiple embeddings, but instead keeping both <code>title</code> and <code>body</code> in the same. After all, the <code>title</code> should™️ be a short representation of the body. I encourage you to experiment with this based on your needs.</p>
<p>Now, let’s look at the <code>fts_</code> columns. We expect the title to be short and keyword-rich, while the body will be longer and include more details. Thus we need to adjust how the full text search columns are weighed against each other. Read the docs to get a better understanding here: <a href="https://www.Postgres.org/docs/current/textsearch-controls.html#TEXTSEARCH-RANKING" rel="nofollow" target="_blank">12.3.3. Ranking Search Results<span><img src="https://www.google.com/s2/favicons?domain=www.postgres.org&amp;sz=64"/></span></a>. Here’s the tl;dr:</p>
<ul>
<li>Weights allow prioritizing words based on their location or importance in the document.</li>
<li>A-weight: Most important (e.g., title, headers). Default <code>1.0</code></li>
<li>B-weight: Important (e.g., beginning of document, abstract). Default <code>0.4</code></li>
<li>C-weight: Standard importance (e.g., main body text). Default <code>0.2</code></li>
<li>D-weight: Least important (e.g., footnotes, annotations). Default <code>0.1</code></li>
<li>Adjust weights to fine-tune relevance based on document structure and application needs.</li>
</ul>
<p>The title is given more weight than the body because it’s typically a concise representation of the document’s main topic. Users often scan titles first when searching, so matching keywords in the title are usually more relevant to the user’s intent than matches in the body text.</p>
<p>With this information, we can go ahead and update the indexes:</p>
<pre tabindex="0" data-language="sql"><code><span><span>create</span><span> table</span><span> documents</span><span> (</span></span>
<span><span>    id </span><span>bigint</span><span> primary key</span><span> generated</span><span> always</span><span> as</span><span> identity</span><span>,</span></span>
<span><span>    title </span><span>text</span><span>,</span></span>
<span><span>    body </span><span>text</span><span>,</span></span>
<span><span>    fts_title tsvector </span><span>generated</span><span> always</span><span> as</span><span> (setweight(to_tsvector(</span><span>&#39;english&#39;</span><span>, </span><span>coalesce</span><span>(title, </span><span>&#39;&#39;</span><span>)), </span><span>&#39;A&#39;</span><span>)) stored, </span></span>
<span><span>    fts_body tsvector </span><span>generated</span><span> always</span><span> as</span><span> (setweight(to_tsvector(</span><span>&#39;english&#39;</span><span>, </span><span>coalesce</span><span>(body, </span><span>&#39;&#39;</span><span>)), </span><span>&#39;C&#39;</span><span>)) stored, </span></span>
<span><span>    embedding vector(</span><span>1536</span><span>)</span></span>
<span><span>);</span></span>
<span></span></code></pre>
<p>This will make the <code>title</code> have a weight of <code>1.0</code> and <code>body</code> a weight of <code>0.2</code>.</p>
<p>Like before, we’ll add the new <code>fts_body</code> to the final query. I’ve also renamed the previous <code>full_text</code> to <code>fts_title</code>.</p>
<pre tabindex="0" data-language="sql"><code><span><span>...</span></span>
<span><span>fts_body </span><span>as</span><span> (</span></span>
<span><span>    select</span><span> id,</span></span>
<span><span>           ts_rank_cd(fts_body, websearch_to_tsquery($query_text)) </span><span>as</span><span> rank_score,</span></span>
<span><span>           row_number</span><span>() </span><span>over</span><span> (</span><span>order by</span><span> ts_rank_cd(fts_body, websearch_to_tsquery($query_text)) </span><span>desc</span><span>) </span><span>as</span><span> rank_ix</span></span>
<span><span>    from</span><span> documents</span></span>
<span><span>    where</span><span> fts_body @@ websearch_to_tsquery($query_text)</span></span>
<span><span>    order by</span><span> rank_ix</span></span>
<span><span>    limit</span><span> least</span><span>($match_count, </span><span>30</span><span>)</span></span>
<span><span>),</span></span>
<span><span>...</span></span>
<span></span></code></pre>
<p>And the combined query</p>
<pre tabindex="0" data-language="sql"><code><span><span>select</span></span>
<span><span>    documents.</span><span>*</span><span>,</span></span>
<span><span>    coalesce</span><span>(</span><span>1</span><span>.</span><span>0</span><span> /</span><span> ($rrf_k </span><span>+</span><span> fuzzy</span><span>.</span><span>rank_ix</span><span>), </span><span>0</span><span>.</span><span>0</span><span>) </span><span>*</span><span> $fuzzy_weight </span><span>+</span></span>
<span><span>    coalesce</span><span>(</span><span>1</span><span>.</span><span>0</span><span> /</span><span> ($rrf_k </span><span>+</span><span> fts_title</span><span>.</span><span>rank_ix</span><span>), </span><span>0</span><span>.</span><span>0</span><span>) </span><span>*</span><span> $fts_title_weight </span><span>+</span></span>
<span><span>    coalesce</span><span>(</span><span>1</span><span>.</span><span>0</span><span> /</span><span> ($rrf_k </span><span>+</span><span> fts_body</span><span>.</span><span>rank_ix</span><span>), </span><span>0</span><span>.</span><span>0</span><span>) </span><span>*</span><span> $fts_body_weight </span><span>+</span></span>
<span><span>    coalesce</span><span>(</span><span>1</span><span>.</span><span>0</span><span> /</span><span> ($rrf_k </span><span>+</span><span> semantic</span><span>.</span><span>rank_ix</span><span>), </span><span>0</span><span>.</span><span>0</span><span>) </span><span>*</span><span> $semantic_weight </span><span>as</span><span> combined_rank,</span></span>
<span><span>    json_build_object(</span></span>
<span><span>        &#39;fuzzy&#39;</span><span>, json_build_object(</span><span>&#39;rank_ix&#39;</span><span>, </span><span>fuzzy</span><span>.</span><span>rank_ix</span><span>, </span><span>&#39;sim_score&#39;</span><span>, </span><span>fuzzy</span><span>.</span><span>sim_score</span><span>),</span></span>
<span><span>        &#39;fts_title&#39;</span><span>, json_build_object(</span><span>&#39;rank_ix&#39;</span><span>, </span><span>fts_title</span><span>.</span><span>rank_ix</span><span>, </span><span>&#39;rank_score&#39;</span><span>, </span><span>fts_title</span><span>.</span><span>rank_score</span><span>),</span></span>
<span><span>        &#39;fts_body&#39;</span><span>, json_build_object(</span><span>&#39;rank_ix&#39;</span><span>, </span><span>fts_body</span><span>.</span><span>rank_ix</span><span>, </span><span>&#39;rank_score&#39;</span><span>, </span><span>fts_body</span><span>.</span><span>rank_score</span><span>), </span></span>
<span><span>        &#39;semantic&#39;</span><span>, json_build_object(</span><span>&#39;rank_ix&#39;</span><span>, </span><span>semantic</span><span>.</span><span>rank_ix</span><span>, </span><span>&#39;cosine_similarity&#39;</span><span>, </span><span>semantic</span><span>.</span><span>cosine_similarity</span><span>)</span></span>
<span><span>    ) </span><span>as</span><span> debug_rankings</span></span>
<span><span>from</span><span> fuzzy</span></span>
<span><span>full outer join</span><span> fts_title </span><span>on</span><span> fuzzy</span><span>.</span><span>id</span><span> =</span><span> fts_title</span><span>.</span><span>id</span></span>
<span><span>full outer join</span><span> fts_body </span><span>on</span><span> coalesce</span><span>(</span><span>fuzzy</span><span>.</span><span>id</span><span>, </span><span>fts_title</span><span>.</span><span>id</span><span>) </span><span>=</span><span> fts_body</span><span>.</span><span>id</span></span>
<span><span>full outer join</span><span> semantic </span><span>on</span><span> coalesce</span><span>(</span><span>fuzzy</span><span>.</span><span>id</span><span>, </span><span>fts_title</span><span>.</span><span>id</span><span>, </span><span>fts_body</span><span>.</span><span>id</span><span>) </span><span>=</span><span> semantic</span><span>.</span><span>id</span></span>
<span><span>join</span><span> documents </span><span>on</span><span> coalesce</span><span>(</span><span>fuzzy</span><span>.</span><span>id</span><span>, </span><span>fts_title</span><span>.</span><span>id</span><span>, </span><span>fts_body</span><span>.</span><span>id</span><span>, </span><span>semantic</span><span>.</span><span>id</span><span>) </span><span>=</span><span> documents</span><span>.</span><span>id</span></span>
<span><span>order by</span><span> combined_rank </span><span>desc</span></span>
<span><span>limit</span><span> least</span><span>($match_count, </span><span>30</span><span>);</span></span>
<span></span></code></pre>
<h3 id="adjusting-for-length"><a data-heading-link="" href="#adjusting-for-length">Adjusting for length</a></h3>
<p>If you read the documentation for <code>ts_rank_cd</code> you saw that there’s a normalization parameter. If not, here it is:</p>
<blockquote>
<p>Both ranking functions take an integer <code>normalization</code> option that specifies whether and how a document’s length should impact its rank. The integer option controls several behaviors, so it is a bit mask: you can specify one or more behaviors using <code>|</code> (for example, <code>2|4</code>).</p>
</blockquote>
<p>We can use these various options to:</p>
<ul>
<li>Adjust for document length bias</li>
<li>Balance relevance across diverse document sets</li>
<li>Scale ranking results for consistent presentation</li>
</ul>
<p><img src="https://anyblockers.com/_astro/document-length-normalization.DS5tgXDF_Z155tVw.svg" alt="Document Length Normalization" width="800" height="400" loading="lazy" decoding="async"/></p>













































<table><thead><tr><th>Option Value</th><th>When to Use</th><th>Use Case</th></tr></thead><tbody><tr><td>No normalization (<code>0</code>)</td><td>When you want raw ranking scores without adjustments</td><td>Comparing documents of similar length and structure</td></tr><tr><td>Log length normalization (<code>1</code>)</td><td>When you want to mildly reduce the impact of document length</td><td>Mixed-length documents where longer docs shouldn’t dominate</td></tr><tr><td>Length normalization (<code>2</code>)</td><td>When you want to strongly normalize by document length</td><td>Diverse document lengths where content density matters more than total matches</td></tr><tr><td>Harmonic mean distance (ts_rank_cd only) (<code>4</code>)</td><td>When you want to consider term proximity in ranking</td><td>Phrases or closely related terms are important in your search</td></tr><tr><td>Unique word normalization (<code>8</code>)</td><td>When you want to favor documents with more diverse vocabulary</td><td>Rewarding content richness over repetition</td></tr><tr><td>Log unique word normalization (<code>16</code>)</td><td>When you want to mildly reduce the impact of vocabulary diversity</td><td>Balancing between vocabulary richness and raw term frequency</td></tr><tr><td>Scaling to 0-1 range (<code>32</code>)</td><td>When you need a consistent score range for all queries</td><td>Displaying scores as percentages or progress bars</td></tr></tbody></table>
<p>Combine options using bitwise OR (<code>|</code>) for more nuanced normalization. For example:</p>
<p>Use <code>2|4</code> to normalize by both length and term proximity
Use <code>1|8</code> for a balanced approach considering both document length and vocabulary diversity</p>
<p>I’ve found good results with setting <code>0</code> (no normalization) for the title and <code>1</code> (logarithmic doc length) for the body. Again, I encourage you to experiment with different options to find the best fit for your use case.</p>
<h2 id="reranking-with-cross-encoder"><a data-heading-link="" href="#reranking-with-cross-encoder">Reranking with cross-encoder</a></h2>
<p>Many retrieval systems are two-step based. This means you’ll use a bi-directional encoder to retrieve the initial N results, then a cross-encoder to rank these against the search query.</p>
<p>The bi-encoder is fast, making it great for searching a multitude of documents. The cross-encoder is slower but more performant, making it great for reranking retrieved results.</p>
<p>Cross-encoders differ from bi-encoders in that they process the query and document together, allowing for more nuanced understanding of the relationship between them. This results in better ranking accuracy but at the cost of computation time and scalability. Here’s a simple diagram to illustrate the process:</p>
<svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="-8 -8 785.375 215" style="max-width: 785.375px;" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid-1"><g><marker orient="auto" markerHeight="12" markerWidth="12" markerUnits="userSpaceOnUse" refY="5" refX="6" viewBox="0 0 10 10" id="mermaid-1_flowchart-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="12" markerWidth="12" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" id="mermaid-1_flowchart-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" id="mermaid-1_flowchart-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" id="mermaid-1_flowchart-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" id="mermaid-1_flowchart-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" id="mermaid-1_flowchart-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g><g></g><g><path marker-end="url(#mermaid-1_flowchart-pointEnd)" style="fill:none;" id="L-FTS-D1-0" d="M91.031,16.5L102.833,16.5C114.635,16.5,138.24,16.5,153.325,16.5C168.41,16.5,174.977,16.5,178.26,16.5L181.544,16.5"></path><path marker-end="url(#mermaid-1_flowchart-pointEnd)" style="fill:none;" id="L-SS-D2-0" d="M136.844,99.5L141.01,99.5C145.177,99.5,153.51,99.5,160.96,99.5C168.41,99.5,174.977,99.5,178.26,99.5L181.544,99.5"></path><path marker-end="url(#mermaid-1_flowchart-pointEnd)" style="fill:none;" id="L-Fuzzy-D3-0" d="M97.258,182.5L108.022,182.5C118.786,182.5,140.315,182.5,154.363,182.5C168.41,182.5,174.977,182.5,178.26,182.5L181.544,182.5"></path><path marker-end="url(#mermaid-1_flowchart-pointEnd)" style="fill:none;" id="L-D1-CE-0" d="M280.109,16.5L284.276,16.5C288.443,16.5,296.776,16.5,320.655,27.163C344.534,37.826,383.958,59.152,403.67,69.815L423.383,80.478"></path><path marker-end="url(#mermaid-1_flowchart-pointEnd)" style="fill:none;" id="L-D2-CE-0" d="M280.109,99.5L284.276,99.5C288.443,99.5,296.776,99.5,304.226,99.5C311.676,99.5,318.243,99.5,321.526,99.5L324.809,99.5"></path><path marker-end="url(#mermaid-1_flowchart-pointEnd)" style="fill:none;" id="L-D3-CE-0" d="M280.109,182.5L284.276,182.5C288.443,182.5,296.776,182.5,320.655,171.837C344.534,161.174,383.958,139.848,403.67,129.185L423.383,118.522"></path><path marker-end="url(#mermaid-1_flowchart-pointEnd)" style="fill:none;" id="L-CE-FD-0" d="M586.984,99.5L591.151,99.5C595.318,99.5,603.651,99.5,611.101,99.5C618.551,99.5,625.118,99.5,628.401,99.5L631.684,99.5"></path></g><g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g></g><g><g transform="translate(68.421875, 16.5)" data-id="FTS" data-node="true" id="flowchart-FTS-38"><rect height="33" width="45.21875" y="-16.5" x="-22.609375" ry="0" rx="0" style=""></rect><g transform="translate(-15.109375, -9)" style=""><rect></rect><foreignObject height="18" width="30.21875"><p><span>FTS</span></p></foreignObject></g></g><g transform="translate(233.4765625, 16.5)" data-id="D1" data-node="true" id="flowchart-D1-39"><rect height="33" width="93.265625" y="-16.5" x="-46.6328125" ry="0" rx="0" style=""></rect><g transform="translate(-39.1328125, -9)" style=""><rect></rect><foreignObject height="18" width="78.265625"><p><span>documents</span></p></foreignObject></g></g><g transform="translate(68.421875, 99.5)" data-id="SS" data-node="true" id="flowchart-SS-40"><rect height="33" width="136.84375" y="-16.5" x="-68.421875" ry="0" rx="0" style=""></rect><g transform="translate(-60.921875, -9)" style=""><rect></rect><foreignObject height="18" width="121.84375"><p><span>Semantic Search</span></p></foreignObject></g></g><g transform="translate(233.4765625, 99.5)" data-id="D2" data-node="true" id="flowchart-D2-41"><rect height="33" width="93.265625" y="-16.5" x="-46.6328125" ry="0" rx="0" style=""></rect><g transform="translate(-39.1328125, -9)" style=""><rect></rect><foreignObject height="18" width="78.265625"><p><span>documents</span></p></foreignObject></g></g><g transform="translate(68.421875, 182.5)" data-id="Fuzzy" data-node="true" id="flowchart-Fuzzy-42"><rect height="33" width="57.671875" y="-16.5" x="-28.8359375" ry="0" rx="0" style=""></rect><g transform="translate(-21.3359375, -9)" style=""><rect></rect><foreignObject height="18" width="42.671875"><p><span>Fuzzy</span></p></foreignObject></g></g><g transform="translate(233.4765625, 182.5)" data-id="D3" data-node="true" id="flowchart-D3-43"><rect height="33" width="93.265625" y="-16.5" x="-46.6328125" ry="0" rx="0" style=""></rect><g transform="translate(-39.1328125, -9)" style=""><rect></rect><foreignObject height="18" width="78.265625"><p><span>documents</span></p></foreignObject></g></g><g transform="translate(458.546875, 99.5)" data-id="CE" data-node="true" id="flowchart-CE-45"><rect height="33" width="256.875" y="-16.5" x="-128.4375" ry="0" rx="0" style=""></rect><g transform="translate(-120.9375, -9)" style=""><rect></rect><foreignObject height="18" width="241.875"><p><span>Rerank with Cross-encoder model</span></p></foreignObject></g></g><g transform="translate(703.1796875, 99.5)" data-id="FD" data-node="true" id="flowchart-FD-51"><rect height="33" width="132.390625" y="-16.5" x="-66.1953125" ry="0" rx="0" style=""></rect><g transform="translate(-58.6953125, -9)" style=""><rect></rect><foreignObject height="18" width="117.390625"><p><span>Final documents</span></p></foreignObject></g></g></g></g></g></svg>
<p>There are a bunch of different tools out there to do this. One of the best is <a href="https://cohere.com/blog/rerank-3" rel="nofollow" target="_blank">Cohere’s Rerank<span><img src="https://www.google.com/s2/favicons?domain=cohere.com&amp;sz=64"/></span></a>. Another way is to <a href="https://cookbook.openai.com/examples/search_reranking_with_cross-encoders" rel="nofollow" target="_blank">build your own with GPT from OpenAI<span><img src="https://www.google.com/s2/favicons?domain=cookbook.openai.com&amp;sz=64"/></span></a>.</p>
<h2 id="boosting-results-to-improve-ux"><a data-heading-link="" href="#boosting-results-to-improve-ux">Boosting results to improve UX</a></h2>
<p>To provide an even better user experience, you might want to boost certain columns depending on your use case. For example, in a knowledge search, you might want to boost search results that the user has interacted with. You also might want to boost recently changed results.</p>
<p>Boosting recent results or user-specific results can improve UX because it personalizes the search experience. Recent results are often more relevant, especially for time-sensitive information. User-specific boosts can surface content the user has previously found useful, making their search more efficient.</p>
<svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="-8 -8 753.1875 232" style="max-width: 753.1875px;" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid-2"><g><marker orient="auto" markerHeight="12" markerWidth="12" markerUnits="userSpaceOnUse" refY="5" refX="6" viewBox="0 0 10 10" id="mermaid-2_flowchart-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="12" markerWidth="12" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" id="mermaid-2_flowchart-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" id="mermaid-2_flowchart-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" id="mermaid-2_flowchart-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" id="mermaid-2_flowchart-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" id="mermaid-2_flowchart-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g><g><g id="subGraph1"><rect height="83" width="737.1875" y="133" x="0" ry="0" rx="0" style=""></rect><g transform="translate(318.34375, 133)"><foreignObject height="18" width="100.5"><p><span>After Boosting</span></p></foreignObject></g></g><g id="subGraph0"><rect height="83" width="737.1875" y="0" x="0" ry="0" rx="0" style=""></rect><g transform="translate(311.6640625, 0)"><foreignObject height="18" width="113.859375"><p><span>Before Boosting</span></p></foreignObject></g></g></g><g><path marker-end="url(#mermaid-2_flowchart-pointEnd)" style="fill:none;" id="L-B1-A2-0" d="M225.328,58L225.328,62.167C225.328,66.333,225.328,74.667,225.328,83C225.328,91.333,225.328,99.667,225.328,108C225.328,116.333,225.328,124.667,225.328,132.117C225.328,139.567,225.328,146.133,225.328,149.417L225.328,152.7"></path><path marker-end="url(#mermaid-2_flowchart-pointEnd)" style="fill:none;" id="L-B2-A4-0" d="M511.414,58L511.414,62.167C511.414,66.333,511.414,74.667,511.414,83C511.414,91.333,511.414,99.667,511.414,108C511.414,116.333,511.414,124.667,511.414,132.117C511.414,139.567,511.414,146.133,511.414,149.417L511.414,152.7"></path><path marker-end="url(#mermaid-2_flowchart-pointEnd)" style="fill:none;" id="L-B3-A1-0" d="M82.07,58L82.07,62.167C82.07,66.333,82.07,74.667,82.07,83C82.07,91.333,82.07,99.667,82.07,108C82.07,116.333,82.07,124.667,82.07,132.117C82.07,139.567,82.07,146.133,82.07,149.417L82.07,152.7"></path><path marker-end="url(#mermaid-2_flowchart-pointEnd)" style="fill:none;" id="L-B4-A5-0" d="M655.117,58L655.117,62.167C655.117,66.333,655.117,74.667,655.117,83C655.117,91.333,655.117,99.667,655.117,108C655.117,116.333,655.117,124.667,655.117,132.117C655.117,139.567,655.117,146.133,655.117,149.417L655.117,152.7"></path><path marker-end="url(#mermaid-2_flowchart-pointEnd)" style="fill:none;" id="L-B5-A3-0" d="M368.148,58L368.148,62.167C368.148,66.333,368.148,74.667,368.148,83C368.148,91.333,368.148,99.667,368.148,108C368.148,116.333,368.148,124.667,368.148,132.117C368.148,139.567,368.148,146.133,368.148,149.417L368.148,152.7"></path></g><g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g></g><g><g transform="translate(82.0703125, 174.5)" data-id="A1" data-node="true" id="flowchart-A1-57"><rect height="33" width="94.140625" y="-16.5" x="-47.0703125" ry="0" rx="0" style="fill:#ff9999;stroke:#333;stroke-width:2px;"></rect><g transform="translate(-39.5703125, -9)" style=""><rect></rect><foreignObject height="18" width="79.140625"><p><span>1. Result C</span></p></foreignObject></g></g><g transform="translate(225.328125, 174.5)" data-id="A2" data-node="true" id="flowchart-A2-58"><rect height="33" width="92.375" y="-16.5" x="-46.1875" ry="0" rx="0" style=""></rect><g transform="translate(-38.6875, -9)" style=""><rect></rect><foreignObject height="18" width="77.375"><p><span>2. Result A</span></p></foreignObject></g></g><g transform="translate(368.1484375, 174.5)" data-id="A3" data-node="true" id="flowchart-A3-59"><rect height="33" width="93.265625" y="-16.5" x="-46.6328125" ry="0" rx="0" style="fill:#99ff99;stroke:#333;stroke-width:2px;"></rect><g transform="translate(-39.1328125, -9)" style=""><rect></rect><foreignObject height="18" width="78.265625"><p><span>3. Result E</span></p></foreignObject></g></g><g transform="translate(511.4140625, 174.5)" data-id="A4" data-node="true" id="flowchart-A4-60"><rect height="33" width="93.265625" y="-16.5" x="-46.6328125" ry="0" rx="0" style=""></rect><g transform="translate(-39.1328125, -9)" style=""><rect></rect><foreignObject height="18" width="78.265625"><p><span>4. Result B</span></p></foreignObject></g></g><g transform="translate(655.1171875, 174.5)" data-id="A5" data-node="true" id="flowchart-A5-61"><rect height="33" width="94.140625" y="-16.5" x="-47.0703125" ry="0" rx="0" style=""></rect><g transform="translate(-39.5703125, -9)" style=""><rect></rect><foreignObject height="18" width="79.140625"><p><span>5. Result D</span></p></foreignObject></g></g><g transform="translate(225.328125, 41.5)" data-id="B1" data-node="true" id="flowchart-B1-52"><rect height="33" width="92.375" y="-16.5" x="-46.1875" ry="0" rx="0" style=""></rect><g transform="translate(-38.6875, -9)" style=""><rect></rect><foreignObject height="18" width="77.375"><p><span>1. Result A</span></p></foreignObject></g></g><g transform="translate(511.4140625, 41.5)" data-id="B2" data-node="true" id="flowchart-B2-53"><rect height="33" width="93.265625" y="-16.5" x="-46.6328125" ry="0" rx="0" style=""></rect><g transform="translate(-39.1328125, -9)" style=""><rect></rect><foreignObject height="18" width="78.265625"><p><span>2. Result B</span></p></foreignObject></g></g><g transform="translate(82.0703125, 41.5)" data-id="B3" data-node="true" id="flowchart-B3-54"><rect height="33" width="94.140625" y="-16.5" x="-47.0703125" ry="0" rx="0" style="fill:#ff9999;stroke:#333;stroke-width:2px;"></rect><g transform="translate(-39.5703125, -9)" style=""><rect></rect><foreignObject height="18" width="79.140625"><p><span>3. Result C</span></p></foreignObject></g></g><g transform="translate(655.1171875, 41.5)" data-id="B4" data-node="true" id="flowchart-B4-55"><rect height="33" width="94.140625" y="-16.5" x="-47.0703125" ry="0" rx="0" style=""></rect><g transform="translate(-39.5703125, -9)" style=""><rect></rect><foreignObject height="18" width="79.140625"><p><span>4. Result D</span></p></foreignObject></g></g><g transform="translate(368.1484375, 41.5)" data-id="B5" data-node="true" id="flowchart-B5-56"><rect height="33" width="93.265625" y="-16.5" x="-46.6328125" ry="0" rx="0" style="fill:#99ff99;stroke:#333;stroke-width:2px;"></rect><g transform="translate(-39.1328125, -9)" style=""><rect></rect><foreignObject height="18" width="78.265625"><p><span>5. Result E</span></p></foreignObject></g></g></g></g></g></svg>
<p>Assuming we have <code>updated_at</code> and <code>updated_by</code> columns in our documents table, we could implement it like this:</p>
<pre tabindex="0" data-language="sql"><code><span><span>select</span></span>
<span><span>    ...</span></span>
<span><span>    -- Recency boost</span></span>
<span><span>    (</span><span>1</span><span> +</span><span> $recency_boost </span><span>*</span><span> (</span><span>1</span><span> -</span><span> extract(epoch </span><span>from</span><span> (</span><span>now</span><span>() </span><span>-</span><span> documents</span><span>.</span><span>updated_at</span><span>)) </span><span>/</span><span> extract(epoch </span><span>from</span><span> (</span><span>now</span><span>() </span><span>-</span><span> &#39;2020-01-01&#39;</span><span>::</span><span>timestamp</span><span>)))) </span><span>*</span></span>
<span><span>    -- User boost</span></span>
<span><span>    case</span><span> when</span><span> documents</span><span>.</span><span>updated_by</span><span> =</span><span> $current_user_id </span><span>then</span><span> (</span><span>1</span><span> +</span><span> $user_boost) </span><span>else</span><span> 1</span><span> end</span></span>
<span><span>    as</span><span> combined_rank,</span></span>
<span><span>    json_build_object(</span></span>
<span><span>        ...</span></span>
<span><span>        &#39;recency_boost&#39;</span><span>, (</span><span>1</span><span> -</span><span> extract(epoch </span><span>from</span><span> (</span><span>now</span><span>() </span><span>-</span><span> documents</span><span>.</span><span>updated_at</span><span>)) </span><span>/</span><span> extract(epoch </span><span>from</span><span> (</span><span>now</span><span>() </span><span>-</span><span> &#39;2020-01-01&#39;</span><span>::</span><span>timestamp</span><span>))),</span></span>
<span><span>        &#39;user_boost&#39;</span><span>, </span><span>case</span><span> when</span><span> documents</span><span>.</span><span>updated_by</span><span> =</span><span> $current_user_id </span><span>then</span><span> $user_boost </span><span>else</span><span> 0</span><span> end</span></span>
<span><span>    ) </span><span>as</span><span> debug_rankings</span></span>
<span></span></code></pre>
<h2 id="when-should-i-look-for-alternative-solutions"><a data-heading-link="" href="#when-should-i-look-for-alternative-solutions">When should I look for alternative solutions?</a></h2>
<p>While Postgres is a solid choice for many search scenarios, it’s not without limitations. The lack of advanced algorithms like BM25 can be felt when dealing with diverse document lengths. <del>Postgres’s reliance on TF-IDF for full-text search can struggle with very long documents and rare terms in large collections.</del></p>
<p><strong>Edit:</strong> Postgres actually doesn’t use TF-IDF for full-text search. Its built-in ranking functions (ts_rank and ts_rank_cd) primarily consider term frequency within individual documents and term proximity, but don’t take into account corpus-wide statistics. This approach can still struggle with very long documents and doesn’t inherently account for the rarity of terms across the entire collection.</p>
<p>Make sure to measure before you look into alternative solutions. Chances are, it might not be worth it.</p>
<h2 id="bonus-adding-bm25"><a data-heading-link="" href="#bonus-adding-bm25">Bonus: adding BM25</a></h2>
<p>Unlike Postgres’s FTS, BM25 considers corpus-wide statistics and document length normalization. Here are some of the reaons you might want to use it:</p>
<ul>
<li>Better handling of document length variations</li>
<li>Improved relevance for rare terms</li>
<li>Accounts for diminishing returns of term frequency</li>
<li>Industry standard in information retrieval</li>
</ul>
<p>And here are some extensions you can install go get BM25 going:</p>

<h2 id="conclusion"><a data-heading-link="" href="#conclusion">Conclusion</a></h2>
<p>We’ve covered a lot of ground in this post, from basic full-text search to advanced techniques like fuzzy matching, semantic search, and result boosting. By leveraging Postgres’s powerful features, you can create a robust and flexible search engine tailored to your specific needs.</p>
<p>Postgres might not be the first tool that comes to mind for search, but it gets you really far.</p>
<p>Remember, the key to a great search experience is continuous iteration and fine-tuning. Use the debugging techniques we discussed to understand how your search is performing, and don’t be afraid to adjust weights and parameters based on user feedback and behavior.</p>
<p>Let me know if I missed anything! :)</p>  </div></div>
  </body>
</html>
