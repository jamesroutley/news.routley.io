<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://til.simonwillison.net/python/init-subclass">Original</a>
    <h1>Problems once solved by a metaclass can be solved by __init_subclass__</h1>
    
    <div id="readability-page-1" class="page"><section>



<p>David Beazley <a href="https://twitter.com/dabeaz/status/1466731368956809219" rel="nofollow">on Twitter</a> said:</p>
<blockquote>
<p>I think 95% of the problems once solved by a metaclass can be solved by <code>__init_subclass__</code> instead</p>
</blockquote>
<p>This inspired me to finally learn how to use it! I used <a href="https://github.com/simonw/asyncinject/issues/2">my asyncinject project</a> as an experimental playground.</p>
<p>The <code>__init_subclass__</code> class method is called when the class itself is being constructed. It gets passed the <code>cls</code> and can make modifications to it.</p>
<p>Here&#39;s the pattern I used:</p>
<div><pre><span>class</span> <span>AsyncInject</span>:
    <span>def</span> <span>__init_subclass__</span>(<span>cls</span>, <span>**</span><span>kwargs</span>):
        <span>super</span>().<span>__init_subclass__</span>(<span>**</span><span>kwargs</span>)
        <span># Decorate any items that are &#39;async def&#39; methods</span>
        <span>cls</span>.<span>_registry</span> <span>=</span> {}
        <span>inject_all</span> <span>=</span> <span>getattr</span>(<span>cls</span>, <span>&#34;_inject_all&#34;</span>, <span>False</span>)
        <span>for</span> <span>name</span> <span>in</span> <span>dir</span>(<span>cls</span>):
            <span>value</span> <span>=</span> <span>getattr</span>(<span>cls</span>, <span>name</span>)
            <span>if</span> <span>inspect</span>.<span>iscoroutinefunction</span>(<span>value</span>) <span>and</span> (
                <span>inject_all</span> <span>or</span> <span>getattr</span>(<span>value</span>, <span>&#34;_inject&#34;</span>, <span>None</span>)
            ):
                <span>setattr</span>(<span>cls</span>, <span>name</span>, <span>_make_method</span>(<span>value</span>))
                <span>cls</span>.<span>_registry</span>[<span>name</span>] <span>=</span> <span>getattr</span>(<span>cls</span>, <span>name</span>)
        <span># Gather graph for later dependency resolution</span>
        <span>graph</span> <span>=</span> {
            <span>key</span>: {
                <span>p</span>
                <span>for</span> <span>p</span> <span>in</span> <span>inspect</span>.<span>signature</span>(<span>method</span>).<span>parameters</span>.<span>keys</span>()
                <span>if</span> <span>p</span> <span>!=</span> <span>&#34;self&#34;</span> <span>and</span> <span>not</span> <span>p</span>.<span>startswith</span>(<span>&#34;_&#34;</span>)
            }
            <span>for</span> <span>key</span>, <span>method</span> <span>in</span> <span>cls</span>.<span>_registry</span>.<span>items</span>()
        }
        <span>cls</span>.<span>_graph</span> <span>=</span> <span>graph</span></pre></div>
<p>As you can see, it&#39;s using <code>getattr()</code> and <code>setattr()</code> against the <code>cls</code> object to make modifications to the class - in this case it&#39;s running a decorator against various methods and adding two new class properties, <code>_registry</code> and <code>_graph</code>.</p>
<p>The <code>**kwargs</code> thing there is interesting: you can define keyword arguments and use them when you subclass, like this:</p>
<div><pre><span>class</span> <span>MySubClass</span>(<span>AsyncInject</span>, <span>inject_all</span><span>=</span><span>True</span>):
    ...</pre></div>
<p>This doesn&#39;t work with my above example, but I could change it to start like this instead:</p>
<div><pre><span>class</span> <span>AsyncInject</span>:
    <span>def</span> <span>__init_subclass__</span>(<span>cls</span>, <span>inject_all</span><span>=</span><span>False</span>, <span>**</span><span>kwargs</span>):
        <span>super</span>().<span>__init_subclass__</span>(<span>**</span><span>kwargs</span>)
        <span># Decorate any items that are &#39;async def&#39; methods</span>
        <span>cls</span>.<span>_registry</span> <span>=</span> {}
        <span>for</span> <span>name</span> <span>in</span> <span>dir</span>(<span>cls</span>):
            <span>value</span> <span>=</span> <span>getattr</span>(<span>cls</span>, <span>name</span>)
            <span>if</span> <span>inspect</span>.<span>iscoroutinefunction</span>(<span>value</span>) <span>and</span> (
                <span>inject_all</span> <span>or</span> <span>getattr</span>(<span>value</span>, <span>&#34;_inject&#34;</span>, <span>None</span>)
            ):
                <span>setattr</span>(<span>cls</span>, <span>name</span>, <span>_make_method</span>(<span>value</span>))
                <span>cls</span>.<span>_registry</span>[<span>name</span>] <span>=</span> <span>getattr</span>(<span>cls</span>, <span>name</span>)</pre></div>
<h2>
<a id="user-content-further-reading" href="#further-reading" aria-hidden="true"><span aria-hidden="true"></span></a>Further reading</h2>
<ul>
<li>
<a href="https://github.com/rednafi/notes/blob/master/notes/python/use_init_subclass_hook_to_validate_subclasses.md">Use __init_subclass__ hook to validate subclasses</a> <a href="https://twitter.com/rednafi/status/1466833693993930755" rel="nofollow">via Redowan Delowar</a>
</li>
<li><a href="https://www.python.org/dev/peps/pep-0487/" rel="nofollow">PEP 487 -- Simpler customisation of class creation</a></li>
</ul>


<p>Created 2021-12-03T11:19:51-08:00, updated 2021-12-03T11:22:59-08:00 · <a href="https://github.com/simonw/til/commits/main/python/init-subclass.md">History</a> · <a href="https://github.com/simonw/til/blob/main/python/init-subclass.md">Edit</a></p>

</section></div>
  </body>
</html>
