<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://antonz.org/json-virtual-columns/">Original</a>
    <h1>JSON and Virtual Columns in SQLite</h1>
    
    <div id="readability-page-1" class="page"><div>
<div>
<article>
<div>
<div>
<header>

</header>
<p><a href="https://antonz.org/generated-columns/">Generated columns</a> have another great use case.</p>
<p><img src="https://antonz.org/json-virtual-columns/json-data.png" alt="JSON data"/></p>
<p>Let’s say you decide to keep a log of events that occur in the system. There are different types of events, each with its own set of fields. For example, sign-in:</p>
<div><pre tabindex="0"><code data-lang="json">{
    <span>&#34;timestamp&#34;</span>: <span>&#34;2022-05-15T09:31:00Z&#34;</span>,
    <span>&#34;object&#34;</span>: <span>&#34;user&#34;</span>,
    <span>&#34;object_id&#34;</span>: <span>11</span>,
    <span>&#34;action&#34;</span>: <span>&#34;login&#34;</span>,
    <span>&#34;details&#34;</span>: {
        <span>&#34;ip&#34;</span>: <span>&#34;192.168.0.1&#34;</span>
    }
}
</code></pre></div><p>Or account deposit:</p>
<div><pre tabindex="0"><code data-lang="json">{
    <span>&#34;timestamp&#34;</span>: <span>&#34;2022-05-15T09:32:00Z&#34;</span>,
    <span>&#34;object&#34;</span>: <span>&#34;account&#34;</span>,
    <span>&#34;object_id&#34;</span>: <span>12</span>,
    <span>&#34;action&#34;</span>: <span>&#34;deposit&#34;</span>,
    <span>&#34;details&#34;</span>: {
        <span>&#34;amount&#34;</span>: <span>&#34;1000&#34;</span>,
        <span>&#34;currency&#34;</span>: <span>&#34;USD&#34;</span>
    }
}
</code></pre></div><p><img src="https://antonz.org/json-virtual-columns/json-functions.png" alt="JSON functions"/></p>
<p>You decide to store the raw JSON, as normalization is non-trivial. You create an <code>events</code> table with a single <code>value</code> field:</p>
<div><pre tabindex="0"><code data-lang="sql"><span>select</span> <span>value</span> <span>from</span> <span>events</span>;
</code></pre></div><pre tabindex="0"><code>{&#34;timestamp&#34;:&#34;2022-05-15T09:31:00Z&#34;,&#34;object&#34;:&#34;user&#34;,&#34;object_id&#34;:11,&#34;action&#34;:&#34;login&#34;,&#34;details&#34;:{&#34;ip&#34;:&#34;192.168.0.1&#34;}}
{&#34;timestamp&#34;:&#34;2022-05-15T09:32:00Z&#34;,&#34;object&#34;:&#34;account&#34;,&#34;object_id&#34;:12,&#34;action&#34;:&#34;deposit&#34;,&#34;details&#34;:{&#34;amount&#34;:&#34;1000&#34;,&#34;currency&#34;:&#34;USD&#34;}}
{&#34;timestamp&#34;:&#34;2022-05-15T09:33:00Z&#34;,&#34;object&#34;:&#34;company&#34;,&#34;object_id&#34;:13,&#34;action&#34;:&#34;edit&#34;,&#34;details&#34;:{&#34;fields&#34;:[&#34;address&#34;,&#34;phone&#34;]}}
</code></pre><p>And select events for a specific object:</p>
<div><pre tabindex="0"><code data-lang="sql"><span>select</span>
  <span>json_extract</span>(<span>value</span>, <span>&#39;$.object&#39;</span>) <span>as</span> <span>object</span>,
  <span>json_extract</span>(<span>value</span>, <span>&#39;$.action&#39;</span>) <span>as</span> <span>action</span>
<span>from</span> <span>events</span>
<span>where</span> <span>json_extract</span>(<span>value</span>, <span>&#39;$.object_id&#39;</span>) <span>=</span> <span>11</span>;
</code></pre></div><pre tabindex="0"><code>┌────────┬────────┐
│ object │ action │
├────────┼────────┤
│ user   │ login  │
└────────┴────────┘
</code></pre><p>So far, so good. But <code>json_extract()</code> parses the text on each call, so for hundreds of thousands of records the query is slow. What should you do?</p>
<p><img src="https://antonz.org/json-virtual-columns/json-columns.png" alt="JSON columns"/></p>
<p>Define virtual columns:</p>
<div><pre tabindex="0"><code data-lang="sql"><span>alter</span> <span>table</span> <span>events</span>
<span>add</span> <span>column</span> <span>object_id</span> <span>integer</span>
<span>as</span> (<span>json_extract</span>(<span>value</span>, <span>&#39;$.object_id&#39;</span>));

<span>alter</span> <span>table</span> <span>events</span>
<span>add</span> <span>column</span> <span>object</span> <span>text</span>
<span>as</span> (<span>json_extract</span>(<span>value</span>, <span>&#39;$.object&#39;</span>));

<span>alter</span> <span>table</span> <span>events</span>
<span>add</span> <span>column</span> <span>action</span> <span>text</span>
<span>as</span> (<span>json_extract</span>(<span>value</span>, <span>&#39;$.action&#39;</span>));
</code></pre></div><p>Build an index:</p>
<div><pre tabindex="0"><code data-lang="sql"><span>create</span> <span>index</span> <span>events_object_id</span> <span>on</span> <span>events</span>(<span>object_id</span>);
</code></pre></div><p>Now the query works instantly:</p>
<div><pre tabindex="0"><code data-lang="sql"><span>select</span> <span>object</span>, <span>action</span>
<span>from</span> <span>events</span>
<span>where</span> <span>object_id</span> <span>=</span> <span>11</span>;
</code></pre></div><p>Thanks to virtual columns, we almost have a NoSQL database ツ</p>
<p><a href="https://sqlime.org/#gist:c284f7c22684eb74b5dab92d98f7d773">Playground</a></p>
<p><em>Follow <a href="https://twitter.com/ohmypy"><strong>@ohmypy</strong></a> on Twitter and <a href="http://digest.antonz.org/"><strong>subscribe by email</strong></a> to keep up with new posts</em> 🚀</p>
</div>
</div></article>

</div>
</div></div>
  </body>
</html>
