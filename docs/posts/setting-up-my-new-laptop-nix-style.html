<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://bmcgee.ie/posts/2022/12/setting-up-my-new-laptop-nix-style/">Original</a>
    <h1>Setting up my new laptop: Nix style</h1>
    
    <div id="readability-page-1" class="page"><div>
        

<p>This week I received a new <a href="https://frame.work/gb/en/laptop-diy-12-gen-intel" target="_blank">12th Gen Intel</a> laptop from
<a href="https://frame.work" target="_blank">Framework</a>. And like with any new piece of hardware I get these days, my first instinct was
to put <a href="https://nixos.org" target="_blank">NixOS</a> on it üòÑ.</p>

<p>But I wasn‚Äôt just content with firing up the <a href="https://nixos.org/download.html" target="_blank">NixOS installer</a> and getting to work.
Oh no no no. You see, I knew there was a better way. I didn‚Äôt now exactly what that better way looked like just yet, but
I could <em>feel in my bones</em> that it existed.</p>

<p>So I did what I usually do when I suspect there‚Äôs a better way of doing something in Nix land and pinged <a href="https://github.com/mic92" target="_blank">Mic92</a>.
What you‚Äôll read in the rest of this post is the result of our conversations.</p>


    <p><img src="https://bmcgee.ie/posts/2022/12/setting-up-my-new-laptop-nix-style/all-the-things.jpg" alt="All the things meme template with the caption: &#39;Nix all the things!&#39;"/></p><h2 id="customise-the-install-iso">Customise the install iso</h2>

<p>Like with any other distro, <a href="https://nixos.org" target="_blank">NixOS</a> has an <a href="https://nixos.org/download.html" target="_blank">installer</a> that you can
flash onto a USB drive, plug into your computer, and then boot into a Nix based environment that lets you do things like
partition disks, create file systems and ultimately install <a href="https://nixos.org" target="_blank">NixOS</a>.</p>

<p>In my experience though, this means sitting at my desk using my desktop computer to look up various bits of instructions
and then typing them into my laptop. I mean, who remembers how to create a <a href="https://access.redhat.com/solutions/100463" target="_blank">LUKS</a>
partition off the top of their head unless that‚Äôs what you do day in and day out, right?</p>

<p>But what if I told you that you can customise the <a href="https://nixos.org/download.html" target="_blank">NixOS installer</a>?</p>
<div><pre><code data-lang="nix">    packages <span>=</span> {
      sd-image <span>=</span> nixos-generators<span>.</span>nixosGenerate {
        <span>inherit</span> pkgs modules;
        format <span>=</span> <span>&#34;install-iso&#34;</span>;
      };
    };</code></pre></div>
<p>By using the <code>install-iso</code> format in <a href="https://github.com/nix-community/nixos-generators" target="_blank">NixOS Generators</a> we can customise
the installer with our own nixpkgs and nixos modules. This can then be built (assuming flakes) with
<code>nix build .#sd-image</code> and the resulting iso found in <code>./result/iso/...</code> flashed to a USB drive.</p>

<p>Since we can add our own modules, we can then do things like configuring authorized keys for the root account:</p>
<div><pre><code data-lang="shell">  users.extraUsers.root.openssh.authorizedKeys.keys <span>=</span> <span>[</span>
    <span>&#34;ssh-rsa AAAAB3NzaC1yc2etc/etc/etcjwrsh8e596z6J0l7 <a href="https://bmcgee.ie/cdn-cgi/l/email-protection" data-cfemail="385d40595548545d7850574b4c">[email¬†protected]</a>&#34;</span>
    <span>&#34;ssh-ed25519 AAAAC3NzaCetcetera/etceteraJZMfk3QPfQ <a href="https://bmcgee.ie/cdn-cgi/l/email-protection" data-cfemail="3751585877555645">[email¬†protected]</a>&#34;</span>
  <span>]</span>;</code></pre></div>
<p>And that lets us stick in our USB drive, fire up our hardware, boot into the nixos installer, grab its IP
address with <code>ip addr</code> and then continue the rest of the installation <em>remotely</em>.</p>


    <p><img src="https://bmcgee.ie/posts/2022/12/setting-up-my-new-laptop-nix-style/yes.jpg" alt="A woman with her back turned throwing her hands in the air in jubilation"/></p><h2 id="create-the-disk-layout-with-disko">Create the disk layout with Disko</h2>

<p>Now that we can comfortably ssh into our new device and copy and paste to our heart‚Äôs content, the next step is to
partition some disks and create some filesystems.</p>

<p>In my particular case I like encrypting partitions with <a href="https://access.redhat.com/solutions/100463" target="_blank">LUKS</a> and then
using <a href="https://btrfs.readthedocs.io/en/latest/Administration.html" target="_blank">BTRFS</a> as the filesystem. During a typical <a href="https://nixos.org" target="_blank">NixOS</a>
install I would use <code>gdisk</code> to split my root device into a boot and root partition, and then do something like this:</p>
<div><pre><code data-lang="shell"><span># format the root partition with the luks structure</span>
$ cryptsetup luksFormat /dev/nvme0n1p2
<span># open the encrypted partition and map it to /dev/mapper/cryptroot</span>
$ cryptsetup luksOpen /dev/nvme0n1p2 cryptroot
<span># add a filesystem</span>
$ mkfs.btrfs -L nixos /dev/mapper/cryptroot
<span># mount</span>
$ mount /dev/disk/by-label/nixos /mnt
$ mkdir /mnt/boot
$ mount /dev/nvme0n1p1 /mnt/boot</code></pre></div>
<p>Recently though I came across <a href="https://github.com/nix-community/disko" target="_blank">Disko</a> which is maintained by <a href="https://github.com/Lassulus" target="_blank">Lassulus</a>. It
allows for declarative disk partitioning, doing away with the need for the manual steps listed above.</p>

<p><strong>Note:</strong> <em>at the time of writing BTRFS support in Disko had a path issue and was missing the ability to pass mount options to sub volumes. Luckily
<a href="https://github.com/lilyinstarlight" target="_blank">Lilyinstarlight</a> had already created a PR, so I switched to using <a href="https://github.com/nix-community/disko/pull/82" target="_blank">their branch</a>.</em></p>

<p><em>For the sake of simplicity I will reference the original disko url for the flake instead of Lily‚Äôs branch. I expect their PR will be merged soon anyway.</em></p>

<p>Instead of manually creating everything in the terminal, we can instead define our disk layout using nix:</p>
<div><pre><code data-lang="nix">{
  disk <span>=</span> {
    nvme <span>=</span> {
      type <span>=</span> <span>&#34;disk&#34;</span>;
      device <span>=</span> <span>&#34;/dev/nvme0n1&#34;</span>;
      content <span>=</span> {
        type <span>=</span> <span>&#34;table&#34;</span>;
        format <span>=</span> <span>&#34;gpt&#34;</span>;
        partitions <span>=</span> [
          {
            type <span>=</span> <span>&#34;partition&#34;</span>;
            name <span>=</span> <span>&#34;ESP&#34;</span>;
            start <span>=</span> <span>&#34;1MiB&#34;</span>;
            end <span>=</span> <span>&#34;512MiB&#34;</span>;
            bootable <span>=</span> <span>true</span>;
            content <span>=</span> {
              type <span>=</span> <span>&#34;filesystem&#34;</span>;
              format <span>=</span> <span>&#34;vfat&#34;</span>;
              mountpoint <span>=</span> <span>&#34;/boot&#34;</span>;
              options <span>=</span> [
                <span>&#34;defaults&#34;</span>
              ];
            };
          }
          {
            type <span>=</span> <span>&#34;partition&#34;</span>;
            name <span>=</span> <span>&#34;luks&#34;</span>;
            start <span>=</span> <span>&#34;512MiB&#34;</span>;
            end <span>=</span> <span>&#34;100%&#34;</span>;
            content <span>=</span> {
              type <span>=</span> <span>&#34;luks&#34;</span>;
              name <span>=</span> <span>&#34;crypted-root&#34;</span>;
              content <span>=</span> {
                type <span>=</span> <span>&#34;btrfs&#34;</span>;
                mountpoint <span>=</span> <span>&#34;/&#34;</span>;
                mountOptions <span>=</span> [<span>&#34;noatime&#34;</span>];
                subvolumes <span>=</span> {
                  <span>&#34;/home&#34;</span> <span>=</span> {};
                };
              };
            };
          }
        ];
      };
    };
  };
}</code></pre></div>
<p>To apply this configuration we copy it into a file called <code>luks-btrfs.nix</code> and run the following:</p>
<div><pre><code data-lang="shell"><span># create the disk layout</span>
nix run github:nix-community/disko --no-write-lock-file -- -m create ./luks-btrfs.nix
<span># mount the disk layout</span>
nix run github:nix-community/disko --no-write-lock-file -- -m mount ./luks-btrfs.nix</code></pre></div>
<p>We now have everything laid out the way we want, with the <code>crypted-root</code> partition mounted at <code>/mnt</code> and the boot
partition mounted at <code>/mnt/boot</code>, just the way <code>nixos-install</code> likes it.</p>

<p>Even better, we can re-use this nix config in a nixos module for our eventual system configuration:</p>
<div><pre><code data-lang="nix">{inputs<span>,</span> <span>...</span>}: {

  <span># inputs is made accessible by passing it as a specialArg to nixosSystem{}</span>
  imports <span>=</span> [
    inputs<span>.</span>disko<span>.</span>nixosModules<span>.</span>disko
  ];

  disko<span>.</span>devices<span>.</span>disk<span>.</span>nvme <span>=</span> {
    type <span>=</span> <span>&#34;disk&#34;</span>;
    device <span>=</span> <span>&#34;/dev/nvme0n1&#34;</span>;
    content <span>=</span> {
      type <span>=</span> <span>&#34;table&#34;</span>;
      format <span>=</span> <span>&#34;gpt&#34;</span>;
      partitions <span>=</span> [
        {
          type <span>=</span> <span>&#34;partition&#34;</span>;
          name <span>=</span> <span>&#34;ESP&#34;</span>;
          start <span>=</span> <span>&#34;1MiB&#34;</span>;
          end <span>=</span> <span>&#34;512MiB&#34;</span>;
          bootable <span>=</span> <span>true</span>;
          content <span>=</span> {
            type <span>=</span> <span>&#34;filesystem&#34;</span>;
            format <span>=</span> <span>&#34;vfat&#34;</span>;
            mountpoint <span>=</span> <span>&#34;/boot&#34;</span>;
            options <span>=</span> [
              <span>&#34;defaults&#34;</span>
            ];
          };
        }
        {
          type <span>=</span> <span>&#34;partition&#34;</span>;
          name <span>=</span> <span>&#34;luks&#34;</span>;
          start <span>=</span> <span>&#34;512MiB&#34;</span>;
          end <span>=</span> <span>&#34;100%&#34;</span>;
          content <span>=</span> {
            type <span>=</span> <span>&#34;luks&#34;</span>;
            name <span>=</span> <span>&#34;crypted&#34;</span>;
            content <span>=</span> {
              type <span>=</span> <span>&#34;btrfs&#34;</span>;
              mountpoint <span>=</span> <span>&#34;/&#34;</span>;
              mountOptions <span>=</span> [<span>&#34;noatime&#34;</span>];
              subvolumes <span>=</span> {
                <span>&#34;/home&#34;</span> <span>=</span> {};
              };
            };
          };
        }
      ];
    };
  };
}</code></pre></div>
<h2 id="build-locally-and-copy-the-system-closure">Build locally and copy the system closure</h2>

<p>Now that we have our disk partitioned and file system in place, the next step towards a basic installation would be to
run <code>nixos-generate-config</code> followed by <code>nixos-install</code>.</p>

<p>We are still going to use <code>nixos-generate-config</code> because we want to grab the contents of <code>/mnt/etc/nixos/hardware-configuration.nix</code> as
a starting point for our hardware config.</p>

<p>But when it comes to installing, we‚Äôre going to do things a little differently.</p>

<p>By now we should have constructed a basic <code>nixosSystem</code> config for our new piece of hardware. In my case it looked
something like this:</p>
<div><pre><code data-lang="nix">  <span># mkNixosConfig is a wrapper I use for nixosSystem</span>
  nixosConfigurations <span>=</span> {

    pandora <span>=</span> mkNixosConfig {
      <span>inherit</span> baseModules;
      hostName <span>=</span> <span>&#34;pandora&#34;</span>;
      extraModules <span>=</span> [
        hosts<span>.</span>pandora
        modules<span>.</span>docker
        modules<span>.</span>gnome
        modules<span>.</span>gnupg
        modules<span>.</span>vm
        modules<span>.</span>yubikey
        users<span>.</span>brian
      ];
    };

  };</code></pre></div>
<p>We can build this locally with:</p>
<div><pre><code data-lang="shell">nix build .#nixosConfigurations.pandora.config.system.build.toplevel</code></pre></div>
<p>Once finished we are left with a symbolic link <code>./result</code>, the contents of which look like:</p>
<div><pre><code data-lang="shell">‚ùØ readlink -f ./result
/nix/store/xasx6dbw4jv5d1rlqgv5hl3r00bsbz8l-nixos-system-pandora-23.05.20221218.04f574a

‚ùØ ls -l ./result
.r-xr-xr-x  16k root  <span>1</span> Jan  <span>1970</span> activate
lrwxrwxrwx   <span>91</span> root  <span>1</span> Jan  <span>1970</span> append-initrd-secrets -&gt; /nix/store/wnbyi2m14vb5s2i4gn6jqavqrx1bl7pf-append-initrd-secrets/bin/append-initrd-secrets
dr-xr-xr-x    - root  <span>1</span> Jan  <span>1970</span> bin
.r-xr-xr-x <span>3</span>.2k root  <span>1</span> Jan  <span>1970</span> dry-activate
lrwxrwxrwx   <span>51</span> root  <span>1</span> Jan  <span>1970</span> etc -&gt; /nix/store/b52vk4pb5a87jpj3wx1frmbq7fbb5d50-etc/etc
.r--r--r--  <span>133</span> root  <span>1</span> Jan  <span>1970</span> extra-dependencies
lrwxrwxrwx   <span>65</span> root  <span>1</span> Jan  <span>1970</span> firmware -&gt; /nix/store/2n9slzg6n8a7048b1ynlmwzi49kn6h7i-firmware/lib/firmware
lrwxrwxrwx   <span>50</span> root  <span>1</span> Jan  <span>1970</span> flake -&gt; /nix/store/swjgbmppk1n4zds1cz6aq04c2ss4kkgq-source
.r-xr-xr-x <span>4</span>.5k root  <span>1</span> Jan  <span>1970</span> init
.r--r--r--    <span>9</span> root  <span>1</span> Jan  <span>1970</span> init-interface-version
lrwxrwxrwx   <span>67</span> root  <span>1</span> Jan  <span>1970</span> initrd -&gt; /nix/store/kx5qlvl65j6abvi8lwgikfxqkavmcnml-initrd-linux-6.1/initrd
lrwxrwxrwx   <span>61</span> root  <span>1</span> Jan  <span>1970</span> kernel -&gt; /nix/store/963w8y25hn03xfr5cxqi9maj96w523xr-linux-6.1/bzImage
lrwxrwxrwx   <span>58</span> root  <span>1</span> Jan  <span>1970</span> kernel-modules -&gt; /nix/store/4w7rfgwjq7bpkp3slp84w6xk2jc9l3ik-kernel-modules
.r--r--r--  <span>350</span> root  <span>1</span> Jan  <span>1970</span> kernel-params
.r--r--r--   <span>22</span> root  <span>1</span> Jan  <span>1970</span> nixos-version
dr-xr-xr-x    - root  <span>1</span> Jan  <span>1970</span> specialisation
lrwxrwxrwx   <span>55</span> root  <span>1</span> Jan  <span>1970</span> sw -&gt; /nix/store/n5r63syv67yaxy5c8qzym60dq0s4w26b-system-path
.r--r--r--   <span>12</span> root  <span>1</span> Jan  <span>1970</span> system
lrwxrwxrwx   <span>57</span> root  <span>1</span> Jan  <span>1970</span> systemd -&gt; /nix/store/9rjdvhq7hnzwwhib8na2gmllsrh671xg-systemd-252.1</code></pre></div>
<p>In essence <code>./result</code> points to a system closure within our local nix store, one that we want to copy to our target machine.
And that‚Äôs exactly what we can do with <code>nix copy</code>:</p>
<div><pre><code data-lang="shell"><span># host should be the ip address of the target machine</span>
nix copy --to <span>&#34;ssh://<a href="https://bmcgee.ie/cdn-cgi/l/email-protection" data-cfemail="780a17170c38">[email¬†protected]</a></span>$host<span>?remote-store=local?root=/mnt&#34;</span> ./result</code></pre></div>
<p><strong>Note:</strong> <em>This might take a while depending on the size of your system, but it will be a few gigabytes at least.</em></p>

<p>Once the copy has completed, our system closure is now present in our target system‚Äôs local nix store, at the same
path. So all that‚Äôs left to do is set our system closure as the current system.</p>
<div><pre><code data-lang="shell"><span># host should be the ip address of the target machine</span>
ssh <a href="https://bmcgee.ie/cdn-cgi/l/email-protection" data-cfemail="42302d2d3602">[email¬†protected]</a><span>&#34;</span>$host<span>&#34;</span> nix-env -p /nix/var/nix/profiles/system --set ./result</code></pre></div>
<h2 id="restart-profit">Restart &amp; Profit!</h2>

<p>With our system closure installed on our target machine, the last step is to remove the USB drive and reboot. Your
new hardware will start with a full-blown NixOS installation matching the system we were able to construct and test
locally.</p>


    <p><img src="https://bmcgee.ie/posts/2022/12/setting-up-my-new-laptop-nix-style/fireworks.jpg" alt="Fireworks"/></p><p>No need for reading instructions from a screen and typing them in manually. No need for getting a basic installation
up and running first, then manually configuring your ssh keys and cloning a repo etc. before being able to continue.</p>

<p>I was able to go from a blank slate to a copy of my desktop config on my new laptop without doing anything more than
sticking in a USB drive, booting up and grabbing an IP address from said laptop.</p>

<h2 id="summary">Summary</h2>

<p>I like to think that I‚Äôve shown, yet again, just how powerful <a href="https://nixos.org" target="_blank">Nix</a> can be.</p>

<p>That being said, this shit isn‚Äôt easy, and I should acknowledge that I‚Äôm incredibly lucky to be in a position where I can just jump on a call
and get help &amp; advice from high priests of these dark arts like <a href="https://github.com/mic92" target="_blank">Mic92</a>, <a href="https://github.com/zimbatm" target="_blank">Zimbatm</a>
and others at <a href="https://numtide.com/" target="_blank">Numtide</a>.</p>

<p>I‚Äôve been using <a href="https://nixos.org" target="_blank">NixOS</a> as my daily driver for over a year now, and I can‚Äôt imagine ever going back to
something a bit more, normal?</p>

<p><em>P.S. at some point I will make my system config public. Before I do so, I want to clean a few things up. In the meantime,
I would suggest looking over <a href="https://github.com/mic92/dotfiles" target="_blank">Mic92‚Äôs dotfiles</a>. You‚Äôll find much of what I talked about
in there. In fact, his repo layout is shockingly similar to my own‚Ä¶</em> üòâ</p>

      </div></div>
  </body>
</html>
