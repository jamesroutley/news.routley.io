<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lemire.me/blog/2022/05/13/avoid-exception-throwing-in-performance-sensitive-code/">Original</a>
    <h1>Avoid exception throwing in performance-sensitive code</h1>
    
    <div id="readability-page-1" class="page"><article id="post-19727">

<div>
<p>There are various ways in software to handle error conditions. In C or Go, one returns error code. Other programming languages like C++ or Java prefer to throw <em>exceptions</em>. One benefit of using exceptions is that it keeps your code mostly clean since the error-handling code is often separate.</p>
<p>It is debatable whether handling exceptions is better than dealing with error codes. I will happily use one or the other.</p>
<p>What I will object to, however, is the use of exceptions for control flow. It is fine to throw an exception when a file cannot be opened, unexpectedly. But you should not use exceptions to branch on the type of a value.</p>
<p>Let me illustrate.</p>
<p>Suppose that my code expects integers to be always positive. I might then have a function that checks such a condition:</p>
<pre><span>int</span> get_positive_value<span>(</span><span>int</span> x<span>)</span> <span>{</span>
    <span>if</span><span>(</span>x <span>&lt;</span> <span>0</span><span>)</span> <span>{</span> throw std<span>::</span>runtime_error<span>(</span><span>&#34;</span><span>it is not positive!</span><span>&#34;</span><span>)</span><span>;</span> <span>}</span>
    <span>return</span> x<span>;</span>
<span>}</span>
</pre>
<p>So far, so good. I am assuming that the exception is normally never thrown. It gets thrown if I have some kind of error.</p>
<p>If I want to sum the absolute values of the integers contained in an array, the following branching code is fine:</p>
<pre>    <span>int</span> sum <span>=</span> <span>0</span><span>;</span>
    <span>for</span> <span>(</span><span>int</span> x <span>:</span> a<span>)</span> <span>{</span>
        <span>if</span><span>(</span>x <span>&lt;</span> <span>0</span><span>)</span> <span>{</span>
            sum <span>+</span><span>=</span> <span>-</span>x<span>;</span>
        <span>}</span> <span>else</span> <span>{</span>
            sum <span>+</span><span>=</span> x<span>;</span>
        <span>}</span>
    <span>}</span>

</pre>
<p>Unfortunately, I often see solutions abusing exceptions:</p>
<pre>    <span>int</span> sum <span>=</span> <span>0</span><span>;</span>
    <span>for</span> <span>(</span><span>int</span> x <span>:</span> a<span>)</span> <span>{</span>
        try <span>{</span>
            sum <span>+</span><span>=</span> get_positive_value<span>(</span>x<span>)</span><span>;</span>
        <span>}</span> catch <span>(</span><span>.</span><span>.</span><span>.</span><span>)</span> <span>{</span>
            sum <span>+</span><span>=</span> <span>-</span>x<span>;</span>
        <span>}</span>
    <span>}</span>
</pre>
<p>The latter is obviously ugly and hard-to-maintain code. But what is more, it can be highly inefficient. To illustrate, <a href="https://github.com/lemire/Code-used-on-Daniel-Lemire-s-blog/tree/master/2022/05/13">I wrote a small benchmark over random arrays containing a few thousand elements</a>. I use theÂ LLVM clang 12 compiler on a skylake processor. The normal code is 10000 times faster in my tests!</p>
<table>
<tbody>
<tr>
<td>normal code</td>
<td>0.05 ns/value</td>
</tr>
<tr>
<td>exception</td>
<td>500 ns/value</td>
</tr>
</tbody>
</table>
<p>Your results will differ but it is generally the case that using exceptions for control flow leads to suboptimal performance. And it is ugly too!</p>
</div>
<div>

<p><img alt="" src="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=112&amp;d=mm&amp;r=g 2x" height="56" width="56" loading="lazy" decoding="async"/> </p>

</div>

</article></div>
  </body>
</html>
