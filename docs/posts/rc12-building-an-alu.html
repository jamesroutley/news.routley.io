<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.datadoodad.com/recurse%20center/RC12/">Original</a>
    <h1>RC12. Building an ALU</h1>
    
    <div id="readability-page-1" class="page"><div>
      
        <header>
          
          

  <p>
    
      
      <span>
        <i aria-hidden="true"></i>
        
        <time datetime="2023-05-31T00:00:00-07:00">May 31, 2023</time>
      </span>
    

    <span></span>

    
      
      

      <span>
        <i aria-hidden="true"></i>
        
          6 minute read
        
      </span>
    
  </p>


        </header>
      

      <section itemprop="text">
        

        
        <p><i>Daily dispatches from my 12 weeks at the Recurse Center in Summer 2023
</i></p>
        
        <p>Here’s an ALU.</p>

<p><img src="https://www.datadoodad.com/assets/images/RC12_ALU.jpg" alt="ALU"/></p>

<p>Looks confusing. And, well, it sort of is, at least at first. The ALU is the arithmetic logic unit, and it does all sorts of cool things. This one takes as its input two 16-bit numbers, <code>x</code> and <code>y</code>, as well as six 1-bit flags:</p>
<ul>
  <li><code>zx</code>: if this is 1, zero the <code>x</code> input, otherwise leave <code>x</code> as is</li>
  <li><code>nx</code>: if this is 1, negate the <code>x</code> input, otherwise leave as is</li>
  <li><code>zy</code>: if this is 1, zero the <code>y</code> input, otherwise leave <code>y</code> as is</li>
  <li><code>ny</code>: if this is 1, negate the <code>y</code> input, otherwise leave <code>y</code> as is</li>
  <li><code>f</code>: function selector – if 1, then return <code>x + y</code>, otherwise return <code>x &amp; y</code></li>
  <li><code>no</code>: if this is 1, negate the output</li>
</ul>

<p>This ALU also has three outputs:</p>
<ul>
  <li>`f(x, y): this is the 16-bit integer that is the result of all of the above operations</li>
  <li><code>ng</code>: this is a flag that indicates whether the resulting output is a negative number – 1 means yes, 0 means no</li>
  <li><code>zr</code>: this is a flag that indicates whether the resulting output is 0 – 1 means yes, 0 means no</li>
</ul>

<p>As a result of the 6 input flags, an amazing number of operations can be performed on the incoming <code>x</code> and <code>y</code> integers. Here’s an abbreviated truth table that shows the various functions and outputs that can be toggled by turning on and off specific input flags:</p>

<table>
  <tbody><tr>
    <th>zx</th>
    <th>nx</th>
    <th>zy</th>
    <th>ny</th>
    <th>f</th>
    <th>no</th>
    <th>out</th>
  </tr>
  <tr>
    <th>1</th>
    <th>0</th>
    <th>1</th>
    <th>0</th>
    <th>1</th>
    <th>0</th>
    <th>0</th>
  </tr>
  <tr>
    <th>1</th>
    <th>1</th>
    <th>1</th>
    <th>1</th>
    <th>1</th>
    <th>1</th>
    <th>1</th>
  </tr>
  <tr>
    <th>1</th>
    <th>1</th>
    <th>1</th>
    <th>0</th>
    <th>1</th>
    <th>0</th>
    <th>-1</th>
  </tr>
  <tr>
    <th>0</th>
    <th>0</th>
    <th>1</th>
    <th>1</th>
    <th>0</th>
    <th>0</th>
    <th>x</th>
  </tr>
  <tr>
    <th>1</th>
    <th>1</th>
    <th>0</th>
    <th>0</th>
    <th>0</th>
    <th>0</th>
    <th>y</th>
  </tr>
  <tr>
    <th>0</th>
    <th>0</th>
    <th>1</th>
    <th>1</th>
    <th>0</th>
    <th>1</th>
    <th>!x</th>
  </tr>
  <tr>
    <th>1</th>
    <th>1</th>
    <th>0</th>
    <th>0</th>
    <th>0</th>
    <th>1</th>
    <th>!y</th>
  </tr>
  <tr>
    <th>0</th>
    <th>0</th>
    <th>1</th>
    <th>1</th>
    <th>1</th>
    <th>1</th>
    <th>-x</th>
  </tr>
  <tr>
    <th>1</th>
    <th>1</th>
    <th>0</th>
    <th>0</th>
    <th>1</th>
    <th>1</th>
    <th>-y</th>
  </tr>
  <tr>
    <th>0</th>
    <th>1</th>
    <th>1</th>
    <th>1</th>
    <th>1</th>
    <th>1</th>
    <th>x+1</th>
  </tr>
  <tr>
    <th>1</th>
    <th>1</th>
    <th>0</th>
    <th>1</th>
    <th>1</th>
    <th>1</th>
    <th>y+1</th>
  </tr>
  <tr>
    <th>0</th>
    <th>0</th>
    <th>1</th>
    <th>1</th>
    <th>1</th>
    <th>0</th>
    <th>x-1</th>
  </tr>
  <tr>
    <th>1</th>
    <th>1</th>
    <th>0</th>
    <th>0</th>
    <th>1</th>
    <th>0</th>
    <th>y-1</th>
  </tr>
  <tr>
    <th>0</th>
    <th>0</th>
    <th>0</th>
    <th>0</th>
    <th>1</th>
    <th>0</th>
    <th>x+y</th>
  </tr>
  <tr>
    <th>0</th>
    <th>1</th>
    <th>0</th>
    <th>0</th>
    <th>1</th>
    <th>1</th>
    <th>x-y</th>
  </tr>
  <tr>
    <th>0</th>
    <th>0</th>
    <th>0</th>
    <th>1</th>
    <th>1</th>
    <th>1</th>
    <th>y-x</th>
  </tr>
  <tr>
    <th>0</th>
    <th>0</th>
    <th>0</th>
    <th>0</th>
    <th>0</th>
    <th>0</th>
    <th>x&amp;y</th>
  </tr>
  <tr>
    <th>0</th>
    <th>1</th>
    <th>0</th>
    <th>1</th>
    <th>0</th>
    <th>1</th>
    <th>x|y</th>
  </tr>
</tbody></table>

<p>What wasn’t immediately obvious to me until after implementing this is that the input integers <code>x</code> and <code>y</code> are fed through a kind of pipeline, zeroing them out and/or negating them per the <code>nx</code>, <code>zx</code>, <code>ny</code>, and <code>zy</code> flags, and then operated on according to the <code>f</code> flag, and then negated or not depending on the <code>no</code> flag, and then output in three different ways. As a diagram this flow of information is easier to follow:</p>

<p><img src="https://www.datadoodad.com/assets/images/RC12_ALU-schematic.jpg" alt="ALU schematic"/></p>

<p>Effectively what’s happening in the first few steps is that I’m using a series of Mux16s as almost conditional statements that choose between one of two inputs.</p>

<ul>
  <li>The first, leftmost Mux16s, for instance, each take in an input integer (<code>x</code> or <code>y</code>) as one of their inputs and 0 as their other, so that if <code>zx</code>/<code>zy</code> is toggled off, the <code>x</code>/<code>y</code> input is selected, otherwise the <code>0</code>s are selected.</li>
  <li>The next Mux16 pair is responsible for negating the input if needed, so each has the result of the previous Mux16 as one input and its negation for the other, and these are selected using the <code>nx</code>/<code>ny</code> bit.</li>
  <li>The results of the <code>x-&gt;zx-&gt;nx</code> and <code>y-&gt;zy-&gt;ny&#39; operations are both added together and </code>AND<code>ed together, and these two results are fed into yet another Mux 16, which is toggled by the </code>f<code> selector bit. If </code>f` is True/1, then the result of the adder is selected, otherwise the result of the And16 is selected.</li>
  <li>Finally, we pass the result of the above Mux16 and its negation to one final Mux16, which is toggled with the <code>no</code> bit and is responsible for selecting the negated or non-negated output.</li>
</ul>

<p>At this point it’s just a matter of segmenting the output in a few ways: we output the 16-bit result (<code>out</code>) as well as flags to indicate whether the result is negative (<code>ng</code>) or zero (<code>zr</code>).</p>
<ul>
  <li>To determine whether the result is zero, we simpy have to <code>OR</code> all 16 bits together, which here I am using an Or16Way to accomplish. If any of the bits is 1, the result of this Or16Way will also be 1. Only if all the bits are zero (and thus the integer that they represent is also zero) will the result of this Or16Way be 0. Because <code>zr</code> is 1 if all the bits are 0, we have to negate the result.</li>
  <li>As for the <code>ng</code> flag, we simply need to return the most significant bit, which is the sign indicator here. If the most significant bit is 1, that means we’re dealing with a negative number and <code>ng</code> too should be set to 1. Otherwise, the output is positive and <code>ng</code> will be 0.</li>
</ul>


<p>Because following the diagram can be a bit tricky, I wrote a little simulator that shows the various transformations that are happening to the inputs. Let’s look at a few examples.</p>

<h4 id="example-1">Example 1</h4>
<p>According to the chart, we should expect <code>f(x, y)</code> in this case to be <code>y - x</code>:</p>

<div><div><pre><code><span>ALU_sim</span><span>(</span><span>x</span><span>=</span><span>&#39;10010111&#39;</span><span>,</span> <span>y</span><span>=</span><span>&#39;00001010&#39;</span><span>,</span> <span>zx</span><span>=</span><span>0</span><span>,</span> <span>nx</span><span>=</span><span>0</span><span>,</span> <span>zy</span><span>=</span><span>0</span><span>,</span> <span>ny</span><span>=</span><span>1</span><span>,</span> <span>f</span><span>=</span><span>1</span><span>,</span> <span>no</span><span>=</span><span>1</span><span>)</span>
</code></pre></div></div>

<div><div><pre><code>              x                   y

INPUT:    10010111  =&gt; -105   00001010  =&gt; 10
              |                   |
zx=0      10010111  =&gt; -105       |
              |                   |
nx=0      10010111  =&gt; -105       |
              |                   |
zy=0          |               00001010  =&gt; 10
              |                   |
ny=1          |               11110101  =&gt; -11
              |                   |
              ---------------------
                        |
                        |
f: +                10001100  =&gt; -116
                        |
no=1                01110011  =&gt; 115
                        |
              ---------------------
OUTPUT:       |         |         |
ng            0         |         |
                        |         |
zr                      0         |
                                  |
f(x, y)                       01110011  =&gt; 115
</code></pre></div></div>

<h4 id="example-2">Example 2</h4>
<p>Here we should expect <code>f(x, y)</code> to be <code>x-y</code></p>

<div><div><pre><code><span>ALU_sim</span><span>(</span><span>x</span><span>=</span><span>&#39;11001011&#39;</span><span>,</span> <span>y</span><span>=</span><span>&#39;00100011&#39;</span><span>,</span> <span>zx</span><span>=</span><span>0</span><span>,</span> <span>nx</span><span>=</span><span>1</span><span>,</span> <span>zy</span><span>=</span><span>0</span><span>,</span> <span>ny</span><span>=</span><span>0</span><span>,</span> <span>f</span><span>=</span><span>1</span><span>,</span> <span>no</span><span>=</span><span>1</span><span>)</span>
</code></pre></div></div>

<div><div><pre><code>              x                   y

INPUT:    11001011  =&gt; -53    00100011  =&gt; 35
              |                   |
zx=0      11001011  =&gt; -53        |
              |                   |
nx=1      00110100  =&gt; 52         |
              |                   |
zy=0          |               00100011  =&gt; 35
              |                   |
ny=0          |               00100011  =&gt; 35
              |                   |
              ---------------------
                        |
                        |
f: +                01010111  =&gt; 87
                        |
no=1                10101000  =&gt; -88
                        |
              ---------------------
OUTPUT:       |         |         |
ng            1         |         |
                        |         |
zr                      0         |
                                  |
f(x, y)                       10101000  =&gt; -88
</code></pre></div></div>

<h4 id="example-3">Example 3</h4>
<p><code>f(x, y) = y + 1</code>:</p>

<div><div><pre><code><span>ALU_sim</span><span>(</span><span>x</span><span>=</span><span>&#39;11001011&#39;</span><span>,</span> <span>y</span><span>=</span><span>&#39;00100011&#39;</span><span>,</span> <span>zx</span><span>=</span><span>1</span><span>,</span> <span>nx</span><span>=</span><span>1</span><span>,</span> <span>zy</span><span>=</span><span>0</span><span>,</span> <span>ny</span><span>=</span><span>1</span><span>,</span> <span>f</span><span>=</span><span>1</span><span>,</span> <span>no</span><span>=</span><span>1</span><span>)</span>
</code></pre></div></div>

<div><div><pre><code>              x                   y

INPUT:    11001011  =&gt; -53    00100011  =&gt; 35
              |                   |
zx=1      00000000  =&gt; 0          |
              |                   |
nx=1      11111111  =&gt; -1         |
              |                   |
zy=0          |               00100011  =&gt; 35
              |                   |
ny=1          |               11011100  =&gt; -36
              |                   |
              ---------------------
                        |
                        |
f: +                11011011  =&gt; -37
                        |
no=1                00100100  =&gt; 36
                        |
              ---------------------
OUTPUT:       |         |         |
ng            0         |         |
                        |         |
zr                      0         |
                                  |
f(x, y)                       00100100  =&gt; 36
</code></pre></div></div>

<h4 id="example-4">Example 4</h4>
<p>`f(x, y) = -x:</p>

<div><div><pre><code><span>ALU_sim</span><span>(</span><span>x</span><span>=</span><span>&#39;11000010&#39;</span><span>,</span> <span>y</span><span>=</span><span>&#39;10011100&#39;</span><span>,</span> <span>zx</span><span>=</span><span>0</span><span>,</span> <span>nx</span><span>=</span><span>0</span><span>,</span> <span>zy</span><span>=</span><span>1</span><span>,</span> <span>ny</span><span>=</span><span>1</span><span>,</span> <span>f</span><span>=</span><span>1</span><span>,</span> <span>no</span><span>=</span><span>1</span><span>)</span>
</code></pre></div></div>

<div><div><pre><code>              x                   y

INPUT:    11000010  =&gt; -62    10011100  =&gt; -100
              |                   |
zx=0      11000010  =&gt; -62        |
              |                   |
nx=0      11000010  =&gt; -62        |
              |                   |
zy=1          |               00000000  =&gt; 0
              |                   |
ny=1          |               11111111  =&gt; -1
              |                   |
              ---------------------
                        |
                        |
f: +                11000001  =&gt; -63
                        |
no=1                00111110  =&gt; 62
                        |
              ---------------------
OUTPUT:       |         |         |
ng            0         |         |
                        |         |
zr                      0         |
                                  |
f(x, y)                       00111110  =&gt; 62
</code></pre></div></div>

<h4 id="example-5">Example 5</h4>
<p>`f(x, y) = x | y:</p>

<div><div><pre><code><span>ALU_sim</span><span>(</span><span>x</span><span>=</span><span>&#39;11000010&#39;</span><span>,</span> <span>y</span><span>=</span><span>&#39;10011100&#39;</span><span>,</span> <span>zx</span><span>=</span><span>0</span><span>,</span> <span>nx</span><span>=</span><span>1</span><span>,</span> <span>zy</span><span>=</span><span>0</span><span>,</span> <span>ny</span><span>=</span><span>1</span><span>,</span> <span>f</span><span>=</span><span>0</span><span>,</span> <span>no</span><span>=</span><span>1</span><span>)</span>
</code></pre></div></div>

<div><div><pre><code>              x                   y

INPUT:    11000010  =&gt; -62    10011100  =&gt; -100
              |                   |
zx=0      11000010  =&gt; -62        |
              |                   |
nx=1      00111101  =&gt; 61         |
              |                   |
zy=0          |               10011100  =&gt; -100
              |                   |
ny=1          |               01100011  =&gt; 99
              |                   |
              ---------------------
                        |
                        |
f: &amp;                00100001  =&gt; 33
                        |
no=1                11011110  =&gt; -34
                        |
              ---------------------
OUTPUT:       |         |         |
ng            1         |         |
                        |         |
zr                      0         |
                                  |
f(x, y)                       11011110  =&gt; -34
</code></pre></div></div>

<p>There ya go! An ALU in action.</p>



<p>Here’s what else went down today:</p>
<ul>
  <li>excellent coffee chats</li>
  <li>compared ALUs in nand2tetris group</li>
  <li>made some fun leaps in Vim and CLI thanks to some tips from other recursers. Now I know about the ctrl-z / fg window toggling thing in vim. I also installed <code>just</code>, the project-specific command manager, which led to installing <code>vim-plug</code> for a vim plugin manager which I am now using to manage <code>vim-just</code>, my new syntax highlighter. Also <code>ripgrep</code> which seems useful.</li>
</ul>


          

        

        
      </section>

      

      

      
  

    </div></div>
  </body>
</html>
