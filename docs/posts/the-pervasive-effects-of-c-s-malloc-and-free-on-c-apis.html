<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/programming/CAPIsEffectsOfMalloc">Original</a>
    <h1>The pervasive effects of C&#39;s malloc() and free() on C APIs</h1>
    
    <div id="readability-page-1" class="page"><div><h2>The pervasive effects of C&#39;s malloc() and free() on C APIs</h2>

	<p><small>August  6, 2022</small></p>
</div><div><p>In <a href="https://utcc.utoronto.ca/~cks/space/blog/unix/HostLookupHistory">my entry on the history of looking up host addresses in Unix</a>, I touched on how from the beginning
<a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=4.2BSD/usr/man/man3/gethostent.3n"><code>gethostbyname()</code></a>
had an issue in its API, one that the BSD Unix people specifically
called out in its manual page&#39;s BUGS section:</p>

<blockquote><p>All information is contained in a static area so it must be copied if
it is to be saved. [...]</p>
</blockquote>

<p>This became a serious issue when Unix added threads (this static
area isn&#39;t thread safe), but was seen as a problem from the very
beginning. Given that the static return area was known as an issue,
why was the API written this way?</p>

<p>While I don&#39;t know for sure, I think we can point fingers at the
hassles that dynamic memory allocation brings you in a C API. The
<code>gethostbyname()</code> API returns a pointer to a &#39;<code>struct hostent</code>&#39;,
which is (<a href="https://utcc.utoronto.ca/~cks/space/blog/unix/GethostbynameOddOriginalAPI">from 4.3 BSD onward</a>):</p>

<blockquote><pre>struct  hostent {
   char  *h_name;     /* official name of host */
   char **h_aliases;  /* alias list */
   int    h_addrtype; /* address type */
   int    h_length;   /* length of address */
   char **h_addrs;    /* list of addresses */
};
</pre>
</blockquote>

<p>If this structure is dynamically allocated by <code>gethostbyname()</code> and
returned to the caller, either you need an additional API function
to free it or you have to commit to what fields in the structure
have to be freed separately, and how (ie, this is part of the API).
Having the caller free things is also not all that simple. Since
this structure contains embedded pointers (including two that point
to arrays of pointers), there could be quite a lot of things for
the caller to call <code>free()</code> on (and in the right order).</p>

<p>This issue isn&#39;t unique to <code>gethostbyname()</code>; it affects any C API
that wants to return (in a conceptual sense) anything more complicated
than a basic type or a simple structure (even in old C, simple
structures can be &#39;returned&#39; by passing a pointer to the structure
to the function, as is done in <code>stat()</code>). C offers no good solution
to the problem; either you add one or more &#39;free&#39; functions to your
API (one per dynamically allocated structure you&#39;re returning), or
you document and thus freeze the process for freeing what you
return, or you do what BSD opted to in <code>gethostbyname()</code> and return
a pointer to something static.</p>

<p>(Documenting what callers have to free implies that you can&#39;t later
add extra fields to what you return unless they don&#39;t have to be freed
separately.)</p>

<p>In POSIX, this API issue was eventually worked around with the first
approach, when they added a <a href="https://pubs.opengroup.org/onlinepubs/9699919799/functions/freeaddrinfo.html#"><code>freeaddrinfo()</code></a>
function to go with the new <code>getaddrinfo()</code>. This is the only
particularly good solution, but it does mean that you get an
increasing profusion of &#39;free something&#39; functions, which serves
as a disincentive to add APIs which would return something where
you&#39;d need such a function.</p>
</div></div>
  </body>
</html>
