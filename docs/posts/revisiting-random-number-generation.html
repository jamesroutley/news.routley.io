<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://swlody.dev/Posts/Revisiting-random-number-generation">Original</a>
    <h1>Revisiting random number generation</h1>
    
    <div id="readability-page-1" class="page"><article><p>A few months ago, I <a href="https://swlody.dev/Posts/really-really-good-random-number-generator-(rrgrng)" data-slug="Posts/really-really-good-random-number-generator-(rrgrng)">wrote</a> about my experiencing with a <a href="https://github.com/swlody/random-crowdsourced">random number generation service<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> that I threw together over a couple days at the <a href="https://www.recurse.com/scout/click?t=6f1a4828561e63ce05208b7fa4e098df">Recurse Center<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>. I left the site up as it was costing me nothing to host and the domain still had 11 months left, but had mostly forgotten about it until earlier this week. I made this mostly as a learning exercise for using monitoring tools, WebSockets, and Redis, and didn’t expect any real traffic outside of people I showed it to at Recurse.</p>
<p>As a bit of context. The service provides a REST API in addition to a web portal. Users can issue a GET to the API in order to request a random number at which point anyone connected to the website will get an update via WebSockets that someone is requesting a random number. Users can then race to type a random number into the submission field and send it to the requesting user causing that request to be removed from the list for everyone looking at the website. This reduces our reliance on computers to generate random numbers and puts that power back in the hands of humans.</p>
<h2 id="monday">Monday<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#monday"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>The first sign something interesting is going on happens in the afternoon. I receive an email that there was a new <a href="https://github.com/swlody/random-crowdsourced/issues/1">GitHub issue<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> for the website’s repo with the title ‘rrgrng.org down’ and the comment:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="sh" data-theme="catppuccin-latte catppuccin-frappe"><code data-language="sh" data-theme="catppuccin-latte catppuccin-frappe"><span data-line=""><span>&gt;</span><span> curl -m 30 https://rrgrng.org</span></span>
<span data-line=""><span>curl:</span><span> (28) Operation timed out after 30004 milliseconds with 0 bytes received</span></span></code></pre></figure>
<p>Weird. I had set up <a href="https://sentry.io/">Sentry<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> monitoring on a whim, but don’t remember hooking up any GitHub integration. I check and the site was in fact, not responding. I open up my <a href="https://fly.io">fly.io<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> dashboard to check the logs, but don’t see anything obviously wrong. Weird! I restart the server and scale it up from the 1 economy core to 2 cores. Maybe there was some issue with the async runtime blocking on 1 core? I go back to the issue to close it and notice two more weird things:</p>
<ol>
<li>It’s’ in the wrong repo, one for another web project I had been setting up over the weekend for a friend.</li>
<li>It wasn’t reported by any automation, it was a real person!</li>
</ol>
<p>This is, I think, the first issue anyone has ever opened up against one of my personal projects. Exciting! But also confusing. Why was someone looking at this website today, months after I last posted anything about it?</p>
<p>I decide to refresh the website a few more times to make sure everything was fine and… it’s hanging again? I check my Sentry monitoring dashboard to see if I could spot the error transactions but I don’t see any data for the past few months. Uh oh… I’ll get back to that later.</p>
<p>At around this point I get a DM from <a href="https://hannahilea.com/">Hannah Robertson<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> on the Recurse Center Zulip:</p>
<blockquote>
<p>…also, i posted it to <a href="http://lobste.rs/" title="http://lobste.rs/">lobste.rs<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> and it is currently on the front page :)</p>
</blockquote>
<p>It turns out Hannah had remembered the <a href="https://files.swlody.dev/rrgrng.pdf">silly presentation<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> I had given back in September and was still delighted by it! This is very flattering. I had never been blogged about before and certainly never had my work posted on a forum by someone else. I quite enjoy the attention.</p>
<p>Unfortunately, with more attention comes more, well, attention, and that attention seems to be causing some issues with my site. But the traffic is still pretty modest. According to my Grafana dashboard only a few dozen requests per minute. This is definitely more than the 0 per day I was getting prior to today, but certainly not enough to cause any real resource issues, even on my puny 1x core 256 MB VM.</p>
<p><img src="https://swlody.dev/static/re-rrgrng/http-graph.png" width="auto" height="auto" alt="A graph showing the HTTP response rate over a few hours never exceeding 4 responses per second"/></p>
<p><img src="https://swlody.dev/static/re-rrgrng/cpu-graph.png" width="auto" height="auto" alt="Another graph over the same time period showing CPU utilization never going above 33% of the cloud provider&#39;s soft limit"/></p>
<p>Time to start debugging. Obviously the first thing I do is boot up a local instance of the site and spam F5 to see if I can reproduce the issue. Somewhat surprisingly to me, the website hangs pretty quickly. Let’s try again.</p>
<p>F5 F5 F5 F5 F5 … F5 F5. Wait… that’s odd, it started hanging after about the same amount of time. I restart the local server again and start counting:</p>
<p>1 2 3 4 … 39 40 HANG.</p>
<p>One more time:</p>
<p>1 2 3 4 … 39 40 HANG.</p>
<p>wtf</p>
<p>It turns out the server hangs after exactly 40 refreshes, sometimes 41 or 42 if I hit the button a bit more slowly (this is foreshadowing). But at max F5 velocity it’s consistently 40 times. A strangely un-random number. I guess it’s one of <a href="https://web.mit.edu/jemorris/humor/500-miles"><em>those</em><svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> bugs. Well, that’s not really much to go off of in terms of finding out what’s actually going on.</p>
<p>I check the server logs again and notice that I can see the start of the request transaction but no indication that the server ever responded. That makes sense, but where can it possibly be hanging? The route handler for the home page <code>/</code> is just a few lines of code:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rust" data-theme="catppuccin-latte catppuccin-frappe">src/site.rs</figcaption><pre tabindex="0" data-language="rust" data-theme="catppuccin-latte catppuccin-frappe"><code data-language="rust" data-theme="catppuccin-latte catppuccin-frappe"><span data-line=""><span>#</span><span>[</span><span>derive</span><span>(</span><span>askama</span><span>::</span><span>Template</span><span>)]</span></span>
<span data-line=""><span>#</span><span>[</span><span>template</span><span>(</span><span>path </span><span>=</span><span> &#34;index.html&#34;</span><span>)]</span></span>
<span data-line=""><span>struct</span><span> IndexTemplate</span><span> {</span></span>
<span data-line=""><span>    pending_requests</span><span>:</span><span> Vec</span><span>&lt;</span><span>Uuid</span><span>&gt;</span><span>,</span></span>
<span data-line=""><span>    host</span><span>:</span><span> String</span><span>,</span></span>
<span data-line=""><span>}</span></span>
<span data-line=""> </span>
<span data-line=""><span>async</span><span> fn</span><span> index</span><span>(</span><span>Host</span><span>(</span><span>host</span><span>)</span><span>:</span><span> Host</span><span>,</span><span> State</span><span>(</span><span>state</span><span>)</span><span>:</span><span> State</span><span>&lt;</span><span>AppState</span><span>&gt;</span><span>)</span><span> -&gt;</span><span> Result</span><span>&lt;</span><span>Response</span><span>,</span><span> RrgError</span><span>&gt;</span><span> {</span></span>
<span data-line=""><span>    let</span><span> mut</span><span> conn </span><span>=</span><span> state</span><span>.</span><span>redis_connection_pool</span><span>.</span><span>get</span><span>()</span><span>.</span><span>await</span><span>?</span><span>;</span></span>
<span data-line=""><span>    conn</span><span>.</span><span>lrange</span><span>(</span><span>&#34;pending_callbacks&#34;</span><span>,</span><span> 0</span><span>,</span><span> -</span><span>1</span><span>)</span><span>.</span><span>await</span><span>?</span></span>
<span data-line=""><span>    Ok</span><span>(</span><span>IndexTemplate</span><span> {</span></span>
<span data-line=""><span>        pending_requests</span><span>,</span></span>
<span data-line=""><span>        host</span><span>,</span></span>
<span data-line=""><span>    }</span></span>
<span data-line=""><span>    .</span><span>into_response</span><span>())</span></span>
<span data-line=""><span>}</span></span></code></pre></figure>
<p>The code fetches some data from Redis then renders an HTML template using that data and the base URL of the request. I start debugging by setting a breakpoint on line 11 and sending a request to see what data we were getting from Redis. Maybe the data is really big and the template rendering is failing? The breakpoint never hits though. Ok, I guess Redis is taking a long time to return the data. Let’s set a breakpoint at line 10 and step through the Redis code to see where it fails. But that breakpoint never hits either! I set a breakpoint at line 9 and hit step forward, but the program hangs when trying to get a connection from the connection pool. What’s going on?</p>
<p>I add a line to print out the state of the connection pool and run the program.</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="rust" data-theme="catppuccin-latte catppuccin-frappe"><code data-language="rust" data-theme="catppuccin-latte catppuccin-frappe"><span data-line=""><span>tracing</span><span>::</span><span>debug!</span><span>(</span><span>&#34;</span><span>{</span><span>:?</span><span>}</span><span>&#34;</span><span>,</span><span> state</span><span>.</span><span>redis_connection_pool</span><span>);</span></span></code></pre></figure>
<p>I don’t even have to get it to hang again before I have a good hunch of what’s happening.</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="sh" data-theme="catppuccin-latte catppuccin-frappe"><code data-language="sh" data-theme="catppuccin-latte catppuccin-frappe"><span data-line=""><span>2025-01-31T00:50:19.222023Z</span><span> DEBUG</span><span> random_crowdsourced::site:</span><span> Pool</span><span> {</span><span> inner:</span><span> PoolInner</span><span> {</span><span> manager:</span><span> Manager</span><span> {</span><span> client:</span><span> Client</span><span> {</span><span> connection_info:</span><span> ConnectionInfo</span><span> {</span><span> addr:</span><span> Tcp</span><span>(</span><span>&#34;127.0.0.1&#34;</span><span>,</span><span> 6379</span><span>)</span><span>,</span><span> redis:</span><span> RedisConnectionInfo</span><span> {</span><span> db:</span><span> 0,</span><span> username:</span><span> None,</span><span> password:</span><span> None,</span><span> protocol:</span><span> RESP2</span><span> }</span><span> }</span><span> },</span><span> ping_number:</span><span> 0</span><span> },</span><span> slots:</span><span> Mutex</span><span> {</span><span> data:</span><span> Slots</span><span> {</span><span> vec:</span><span> [], size: 0, </span><mark data-highlighted-chars=""><span>max_size: 40</span></mark><span> }, poisoned: false, .. }, used: 0, semaphore: Semaphore </span><span>{</span><span> ll_sem:</span><span> Semaphore</span><span> {</span><span> permits:</span><span> 40</span><span> }</span><span> },</span><span> config:</span><span> PoolConfig</span><span> {</span><span> </span><mark data-highlighted-chars-mark="" data-highlighted-chars=""><span>max_size:</span><span> 40</span></mark><span>,</span><span> timeouts:</span><span> Timeouts</span><span> {</span><span> wait:</span><span> None,</span><span> create:</span><span> None,</span><span> recycle:</span><span> None</span><span> },</span><span> queue_mode:</span><span> Fifo</span><span> },</span><span> runtime:</span><span> Some</span><span>(</span><span>Tokio1</span><span>)</span><span>,</span><span> hooks:</span><span> Hooks</span><span> {</span><span> post_create:</span><span> HookVec</span><span> {</span><span> ..</span><span> },</span><span> pre_recycle:</span><span> HookVec</span><span> {</span><span> ..</span><span> },</span><span> post_recycle:</span><span> HookVec</span><span> {</span><span> ..</span><span> }</span><span> }</span><span> },</span><span> wrapper:</span><span> PhantomData</span><span>&lt;</span><span>fn</span><span>()</span><span> -</span><span>&gt;</span><span> deadpool_redis::Connectio</span><span>n</span><span>&gt;</span><span> }</span></span></code></pre></figure>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="sh" data-theme="catppuccin-latte catppuccin-frappe"><code data-language="sh" data-theme="catppuccin-latte catppuccin-frappe"><span data-line=""><span>data:</span><span> Slots</span><span> {</span><span> vec:</span><span> [], size: 0, </span><mark data-highlighted-chars=""><span>max_size: 40</span></mark><span> }</span></span></code></pre></figure>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="sh" data-theme="catppuccin-latte catppuccin-frappe"><code data-language="sh" data-theme="catppuccin-latte catppuccin-frappe"><span data-line=""><span>max_size:</span><span> </span><mark data-highlighted-chars=""><span>40</span></mark></span></code></pre></figure>
<p>Ahhhhhhhhh.</p>
<p>I hit refresh and see <code>size</code> go up but never go down. Once <code>size</code> hits 40 the connection starts to hang. So we are exhausting the <a href="https://docs.rs/deadpool-redis/latest/deadpool_redis/">deadpool_redis<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> connection pool. But why? The code is pretty straightforward and presumably the connection should be recycled once it is dropped at the end of scope. I’ll get back to this later, for now I just want to get the site working quickly so I go to the <a href="https://docs.rs/redis/latest/redis/">redis-rs<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> documentation and see that I can pass around a single <code>redis::aio::MultiplexedConnection</code> which is freely clone-able and not use a connection pool. I make <a href="https://github.com/swlody/random-crowdsourced/commit/0842fd25c956c49f6af726bd0b02cab6514a9dfe">the change<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>, see that the website isn’t hanging anymore, and push it. Phew, the site was unreliable for about an hour and a half, during which time I had to keep rebooting the server, but we seem to be out of the woods and I shouldn’t have to ever touch this code again.</p>
<p>But just to be safe, I make sure to <a href="https://github.com/swlody/random-crowdsourced/commit/67df6dd96b945a94e7083410daae2edbba26511f">fix<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> the broken Sentry integration so that I can know right away if any more issues happen. Then I go to bed.</p>
<h2 id="tuesday">Tuesday<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#tuesday"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p><img src="https://swlody.dev/static/re-rrgrng/sentry-crash-1.png" width="auto" height="auto" alt="Email from Sentry showing a panic while unwrapping an &#34;Err value: Error(Char { character: &#39;r&#39;, index: 2 })&#34;"/></p>
<p><img src="https://swlody.dev/static/re-rrgrng/limmy.png" width="auto" height="auto" alt="Limmy waking up confused"/></p>
<p>It’s 8 AM and this email is the first thing I see when I wake up. Well, at least I know that my monitoring is working.</p>
<p>The stack trace is a little confusing but I spot <code>tower_http::request_id::PropagateRequestIdResponseFuture&lt;T&gt;::poll</code> and guess that it must be an issue with parsing a <code>Uuid</code> from the <code>x-request-id</code> header. I know my code needs to parse the <code>Uuid</code> because it is used to associate a submitted random number with a waiting request, but I don’t see my code anywhere in the stack trace. Sentry is warning me that it’s missing debug symbols for the code, so I don’t pay much attention to the trace. I’m also confused because I know that the <code>x-request-id</code> is set in the server code when the request arrives, so I know it has to be a valid <code>Uuid</code>.</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rust" data-theme="catppuccin-latte catppuccin-frappe">src/middlware.rs</figcaption><pre tabindex="0" data-language="rust" data-theme="catppuccin-latte catppuccin-frappe"><code data-language="rust" data-theme="catppuccin-latte catppuccin-frappe"><span data-line=""><span>#</span><span>[</span><span>derive</span><span>(</span><span>Clone</span><span>,</span><span> Copy</span><span>)]</span></span>
<span data-line=""><span>pub</span><span> struct</span><span> MakeRequestUuidV7</span><span>;</span></span>
<span data-line=""><span>impl</span><span> MakeRequestId</span><span> for</span><span> MakeRequestUuidV7</span><span> {</span></span>
<span data-line=""><span>    fn</span><span> make_request_id</span><span>&lt;</span><span>B</span><span>&gt;</span><span>(</span><span>&amp;</span><span>mut</span><span> self</span><span>,</span><span> _request</span><span>:</span><span> &amp;</span><span>Request</span><span>&lt;</span><span>B</span><span>&gt;</span><span>)</span><span> -&gt;</span><span> Option</span><span>&lt;</span><span>RequestId</span><span>&gt;</span><span> {</span></span>
<span data-line=""><span>        // Use UUIDv7 so that request ID can be sorted by time</span></span>
<span data-line=""><span>        let</span><span> request_id </span><span>=</span><span> Uuid</span><span>::</span><span>now_v7</span><span>();</span></span>
<span data-line=""><span>        Some</span><span>(</span><span>RequestId</span><span>::</span><span>new</span><span>(</span><span>request_id</span><span>.</span><span>to_string</span><span>()</span><span>.</span><span>parse</span><span>()</span><span>.</span><span>unwrap</span><span>()))</span></span>
<span data-line=""><span>    }</span></span>
<span data-line=""><span>}</span></span></code></pre></figure>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rust" data-theme="catppuccin-latte catppuccin-frappe">src/main.rs</figcaption><pre tabindex="0" data-language="rust" data-theme="catppuccin-latte catppuccin-frappe"><code data-language="rust" data-theme="catppuccin-latte catppuccin-frappe"><span data-line=""><span>    app_router</span><span>.</span><span>layer</span><span>(</span></span>
<span data-line=""><span>        ServiceBuilder</span><span>::</span><span>new</span><span>()</span></span>
<span data-line=""><span>            .</span><span>set_x_request_id</span><span>(</span><span>MakeRequestUuidV7</span><span>)</span></span>
<span data-line=""><span>            .</span><span>propagate_x_request_id</span><span>(),</span></span>
<span data-line=""><span>    );</span></span></code></pre></figure>
<p>So, is this a bug with the <code>tower::PropagateRequestId</code> middleware? Let’s open up the trace for the associated request and check the <code>x-request-id</code> header.</p>
<p><img src="https://swlody.dev/static/re-rrgrng/fred.png" width="auto" height="auto" alt="Screenshot from Sentry showing an X-Request-Id HTTP header with value &#34;fred&#34;"/></p>
<p>It turns out that <code>fred</code> is not a <a href="https://everyuuid.com">valid <code>Uuid</code><svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>, and I hadn’t accounted for someone overriding the header value. Contrary to my assumptions, the <code>SetRequestId</code> middleware only sets the header if there was none set on the initial request. I guess someone looked at my code, noticed my careless <code>unwrap()</code>s, and charitably issued an indirect bug report to me by crashing my server. Thanks stranger!  <a href="https://github.com/swlody/random-crowdsourced/commit/d8efb99c59d9b16eb44d28332467599053dccfc2">Adjusting<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> my docker build to upload the missing debug symbols to Sentry helps to confirms this suspicion.</p>
<p>At least least there’s an easy fix at play here. Just get rid of the <code>unwrap()</code> s and return <code>400 Bad Request</code> if parsing the <code>x-request-id</code> header fails:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rust" data-theme="catppuccin-latte catppuccin-frappe">src/api.rs</figcaption><pre tabindex="0" data-language="rust" data-theme="catppuccin-latte catppuccin-frappe"><code data-language="rust" data-theme="catppuccin-latte catppuccin-frappe"><span data-line=""><span>let</span><span> guid </span><span>=</span><span> Uuid</span><span>::</span><span>parse_str</span><span>(</span><span>headers</span><span>[</span><span>&#34;x-request-id&#34;</span><span>]</span><span>.</span><span>to_str</span><span>()</span><span>.</span><span>unwrap</span><span>())</span><span>.</span><span>unwrap</span><span>();</span></span></code></pre></figure>
<p>Becomes</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="rust" data-theme="catppuccin-latte catppuccin-frappe"><code data-language="rust" data-theme="catppuccin-latte catppuccin-frappe"><span data-line=""><span>let</span><span> request_id_header </span><span>=</span><span> headers</span><span>[</span><span>&#34;x-request-id&#34;</span><span>]</span><span>.</span><span>to_str</span><span>()</span><span>?</span><span>;</span></span>
<span data-line=""><span>let</span><span> guid </span><span>=</span><span> Uuid</span><span>::</span><span>parse_str</span><span>(</span><span>request_id_header</span><span>)</span><span>?</span><span>;</span></span></code></pre></figure>
<p>I push the <a href="https://github.com/swlody/random-crowdsourced/compare/67df6dd...af7d4ee">changes<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> and start snooping around some more in Sentry to see if there’s anyone else trying to mess with my server.</p>
<p><img src="https://swlody.dev/static/re-rrgrng/sentry-submit-spike.png" width="auto" height="auto" alt="Screenshot from Sentry showing a graph over 3 hours of HTTP POST requests, with a large spike in requests during the final hour"/></p>
<p>That’s a lot of number submissions! I wonder what random numbers people are coming up with. Thankfully, Hannah had previously suggested I add a stats page for this purpose. I go to check it and</p>
<p><img src="https://swlody.dev/static/re-rrgrng/siamo-tutti-antifascisti.png" width="auto" height="auto" alt="Screenshot of the page for &#34;Most random numbers&#34; showing &#34;siamo tutti antifascisti&#34; in first place at 2533 times and 69 in third"/></p>
<p><img src="https://swlody.dev/static/re-rrgrng/what-the-hell-sure.jpg" width="auto" height="auto" alt="What the hell, sure."/></p>
<p>Wow, “siamo tutti antifascisti” <em>is</em> a very random number. I knew this could probably happen. I had purposely allowed non-numeric numbers to be submitted to increase the set of available numbers, thereby increasing the system’s randomness. I also knew that having a stats page meant someone could easily write a script to call <code>/api/get</code> and <code>/api/submit</code> in a loop to pad the stats. Thankfully someone had chosen to use their newfound power to write a message I agree with and not use any profanity, but that was no guarantee! I note that I should probably add a list of banned numbers at some point and automatically ban IPs that were trying to submit those numbers (decreasing the system’s randomness but increasing its wholesomeness, a worthy tradeoff).</p>
<p>At this point I have an appointment that I have to head to, so I decide to leave this for later and hope people are well behaved in the meantime.</p>
<p>An hour later I see a message on Zulip from fellow Recurser <a href="https://charlie-volow.com/blog/index.html">Charlie Volow<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>.</p>
<p><img src="https://swlody.dev/static/re-rrgrng/hiiiiiiiiiiiii-zulip.png" width="auto" height="auto" alt="Screenshot of Zulip of a message containing two images and the text &#34;probably the work of fred, knowing fred&#34;"/></p>
<p><img src="https://swlody.dev/static/re-rrgrng/hiiiiiiiiiiiiiiiiii.png" width="auto" height="auto" alt="The first screenshot from the message, a long string of &#39;i&#39;s spanning across the full width of the web page"/></p>
<p><img src="https://swlody.dev/static/re-rrgrng/hiiiiiiiiiiiiiii-inspect-element.png" width="auto" height="auto" alt="The second screenshot from the message of the browser&#39;s inspect element window showing &#34;hiiiiiii... has been random 1339 times&#34;"/></p>
<p>As well as another email from Sentry</p>
<p><img src="https://swlody.dev/static/re-rrgrng/sentry-hiiiiiiiiiiiiii-unwrap.png" width="auto" height="auto" alt="An email from Sentry showing &#34;unwrap on an Err value: ToStrError&#34;"/></p>
<p>At this point the website is down too. <em>Sigh</em>. Obviously I hadn’t added any restrictions on number length. Now I have to wait 20 minutes on the subway before I can get on my laptop to restart the server and fix the bug. In the meantime I look at Sentry on my phone and see this lovely stacktrace:</p>
<p><img src="https://swlody.dev/static/re-rrgrng/ridiculous-stacktrace.png" width="auto" height="auto" alt="Screenshot from Sentry of a failed transaction that took 10 minutes and a stack trace so long it extends well past the bottom of the page"/></p>
<p><span data-rehype-pretty-code-figure=""><code data-language="sh" data-theme="catppuccin-latte catppuccin-frappe"><span data-line=""><span>fly</span><span> machine</span><span> restart</span><span> -i</span><span> [MACHINE_ID]</span></span></code></span></p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rust" data-theme="catppuccin-latte catppuccin-frappe">src/api.rs</figcaption><pre tabindex="0" data-language="rust" data-theme="catppuccin-latte catppuccin-frappe"><code data-language="rust" data-theme="catppuccin-latte catppuccin-frappe"><span data-line=""><span>if</span><span> random_number</span><span>.</span><span>len</span><span>()</span><span> &gt;</span><span> 50</span><span> {</span></span>
<span data-line=""><span>    tracing</span><span>::</span><span>warn!</span><span>(</span><span>&#34;Ignoring banned number&#34;</span><span>);</span></span>
<span data-line=""><span>    return</span><span> StatusCode</span><span>::</span><span>BAD_REQUEST</span><span>;</span></span>
<span data-line=""><span>}</span></span></code></pre></figure>
<p>Now I have to remove the “hiiiiiiiiiii…….“. Looking at redis I see that it is 352,578 characters long. Obviously I can’t paste that into the Redis console to remove with <code>LREM</code>, so how can I do this without deleting the whole Redis db? I know the score of the long “hiiiiiiiiiii……” in the database was <code>1339</code> from Charlie’s screenshot. Redis doesn’t have a <code>ZREMBYSCORE</code> though, so you have to specify a range of scores.</p>
<p><img src="https://swlody.dev/static/re-rrgrng/oops.png" width="auto" height="auto" alt="Screenshot from Zulip of a message I sent: &#34;it might be hard to delete this from redis&#34; follow by &#34;I accidentally deleted the whole redis db oops&#34;"/></p>
<p>Writing this, I don’t remember the exact typo that I made, but I think it had to do with mixing up <code>ZREMRANGEBYRANK</code> and <code>ZREMRANGEBYSCORE</code>. Oops indeed. Thankfully I still have the screenshot of the stats page from earlier in the morning, so I can approximately recreate the top 10 numbers manually.</p>
<pre><code>&gt; ZADD counts 2533 &#34;siamo tutti antifascisti&#34;
(integer) 1
&gt; ZADD counts 448 &#34;abcd&#34;
(integer) 1
&gt; ZADD counts 414 &#34;69&#34;
(integer) 1
...
</code></pre>
<p><img src="https://swlody.dev/static/re-rrgrng/hygiene.png" width="auto" height="auto" alt="Screenshot from Zulip of a message saying &#34;this is why it&#39;s important to screenshot your db at least once a week. hygiene!&#34;"/></p>
<p>With that out of the way, I <a href="https://github.com/swlody/random-crowdsourced/commit/0eadebfccd7544e4e21c608ca6697c3cf7a02af3">add a banned numbers list<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>, add some <a href="https://github.com/swlody/random-crowdsourced/commit/c0a617774d30c5ddb304b15be80182d7c6a4c529">extra<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> <a href="https://github.com/swlody/random-crowdsourced/commit/8a5d542db5939b1258711c76915c00c6d072d1bd">info<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> to my Sentry traces and reduce Sentry’s trace sample rate because I’m getting throttled. Before I go to bed I have one last look at the stats page.</p>
<p><img src="https://swlody.dev/static/re-rrgrng/trans-rights.png" width="auto" height="auto" alt="Screenshot from Zulip of a message I sent saying &#34;it seems like there is currently a battle between 69 and trans rights are human rights&#34; with two trans flag heart reacts"/></p>
<h2 id="wednesday">Wednesday<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#wednesday"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Today is pretty uneventful thankfully. I am starting to get notifications for random <code>Redis(broken pipe)</code> errors, which makes sense since the server is holding a single <code>redis::aio::MultiplexedConnection</code> to the Redis database which may be sporadically unreliable. Unfortunately once the connection is broken, even for a short time, all Redis requests fail until a new connection is established. It seems annoying to add reconnect logic, so I add some <a href="https://github.com/swlody/random-crowdsourced/commit/c9c673d738fb87680f3e96c04bfda1b383c96e15">automated health checks<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> to Fly to try to send a ping message to Redis, and <a href="https://github.com/swlody/random-crowdsourced/commit/490866ed0d834db0eef0dbcda3eff29c4e0382e6">exit the application if it fails<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>, allowing Fly to reboot the machine. This is obviously not ideal, and something that should be solved by switching back to the connection pool, but I decide to let this issue wait until tomorrow.</p>
<p>Otherwise I add some styling to add a colored border around the input field on the website when a number submission succeeds or fails (I had a surprising amount of trouble doing this with <a href="https://htmx.org/">HTMX<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>) and cleanup some other areas of the code.</p>
<h2 id="thursday">Thursday<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#thursday"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>At this point I want to dig into the issue I’m having with <code>deadpool_redis</code> since the <code>Redis(broken pipe)</code> errors aren’t going away. I’m still not sure why the pool is getting exhausted though. Certainly someone else would have had similar problems if it was an issue with the <code>deadpool</code> crate. I comb through my code and try to figure out whether I may be holding onto a connection somewhere. All my API calls are pretty short lived so they should let go of the connection rather quickly. I certainly don’t have enough concurrent requests to be exhausting the size 40 connection pool.</p>
<p>Then it hits me. WebSockets! The WebSocket connections can be open for an arbitrary amount of time, and maybe Firefox doesn’t immediately close the connections when the tab is refreshed or closed? I test my theory and refresh the page a bunch. There are a lot of “Opened WebSocket” logs but no “Closed WebSocket” logs for about 20 seconds. However, when I force quit Firefox, all the connections close at once. I do some research to confirm my theory and find this config option in Firefox: <code>network.websocket.timeout.close: 20</code>. Phew! So we are holding onto an open Redis connection in the task that handles the WebSocket connection and that’s why the pool is getting exhausted. Feeling pretty good about figuring this out, I start getting ready to head to the Recurse Center hub to implement the fix.</p>
<p>Then I take a shower.</p>
<p>Wait, why would the task that is handling the WebSocket connection be utilizing the redis connection at all? My architecture is setup so that a separate task is subscribed to a redis pub/sub on a separate redis connection. The updates from that pub/sub are then broadcast to all the open WebSocket tasks using a <code>tokio::sync::broadcast</code> channel. So there must be something else going on? I jump out of the shower and dried off without moisturizing (!!) and get onto my laptop.</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="rust" data-theme="catppuccin-latte catppuccin-frappe">src/websocket.rs</figcaption><pre tabindex="0" data-language="rust" data-theme="catppuccin-latte catppuccin-frappe"><code data-language="rust" data-theme="catppuccin-latte catppuccin-frappe"><span data-line=""><span>while</span><span> let</span><span> Ok</span><span>(</span><span>update</span><span>)</span><span> =</span><span> rx</span><span>.</span><span>recv</span><span>()</span><span>.</span><span>await</span><span> {</span></span>
<span data-line=""><span>    match</span><span> update </span><span>{</span></span>
<span data-line=""><span>        // </span><mark data-highlighted-chars=""><span>TODO</span></mark><span> do we still need separate added/removed?</span></span>
<span data-line=""><span>        StateUpdate</span><span>::</span><span>Added</span><span>(</span><span>_guid</span><span>)</span><span> |</span><span> StateUpdate</span><span>::</span><span>Removed</span><span>(</span><span>_guid</span><span>)</span><span> =&gt;</span><span> {</span></span>
<span data-line=""><span>            // Re-request the list of pending waiters</span></span>
<span data-line=""><span>            // </span><mark data-highlighted-chars=""><span>TODO</span></mark><span> single waiter updates instead of sending entire list every time</span></span>
<span data-line="" data-highlighted-line=""><span>            let</span><span> pending_requests </span><span>=</span><span> state</span><span>.</span><span>redis</span><span>.</span><span>lrange</span><span>(</span><span>&#34;pending_callbacks&#34;</span><span>,</span><span> 0</span><span>,</span><span> -</span><span>1</span><span>)</span><span>.</span><span>await</span><span>?</span><span>;</span></span>
<span data-line=""> </span>
<span data-line=""><span>            // Re-render and send the list of pending waiters as HTML</span></span>
<span data-line=""><span>            // ...</span></span>
<span data-line=""><span>        }</span></span>
<span data-line=""><span>    }</span></span>
<span data-line=""><span>}</span></span></code></pre></figure>
<p>Oops.</p>
<p>As you may notice from the giant TODOs that had been sitting around for months, I had initially intended to send only a single update to the list of waiting clients whenever an item was added or removed. I was having trouble figuring out how to accomplish this with HTMX so I got lazy and just grabbed the whole list whenever an update happened and sent it off over the WebSocket. Stupidly, I did this inside the WebSocket task instead of rendering the list a single time in the pub/sub task and then broadcasting it to all the WebSocket tasks to be sent off to clients. This was inefficient because it required (number of user * number of updates) x Redis queries instead of just a single query per update, and also (number of user) x Redis connections.</p>
<p>I immediately make the change to make a single query for the list globally and then broadcast that list to the waiting tasks, add <code>deadpool_redis</code> back as a dependency, and spam F5 again. No more hangs! <a href="https://github.com/swlody/random-crowdsourced/commit/c9c673d738fb87680f3e96c04bfda1b383c96e15"><code>git push</code><svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>. With that out of the way I’m able to spend the rest of the day figuring out how to only <a href="https://github.com/swlody/random-crowdsourced/commit/b9c8ed30d0b9a576832e6484474d5aac1deaf5ad">send a single list item<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> instead of the entire list using HTMX. I also add some logic on the server side to send a heartbeat message over the WebSocket connection every 5 seconds and exit the task if it closed.</p>
<h2 id="friday">Friday<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#friday"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Only one more bug to fix today. When a user issues a <code>CURL</code> request to the <code>GET</code> endpoint and then hits <code>CTRL+C</code> to cancel the request, the request sits around indefinitely until someone submits a number, at which point the request is cleared but nobody actually receives the number! I had <a href="https://github.com/swlody/random-crowdsourced/blob/d2d0175453ce01e069a0df2fd4108d1a1572f3c8/src/api.rs#L151-L159">some logic<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> to remove the pending request from the list regardless of whether or not it was successful, but for some reason it wasn’t working. Apparently this is because when using Axum and Tokio, the async task gets automatically cancelled when the request is cancelled, so the code to remove the request from the list of pending requests was never running! I <a href="https://github.com/swlody/random-crowdsourced/commit/229c50ae582e27c7c4561b6deba427d54cb3e3e6">add code<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> to spawn a task at the beginning of each request to clear the request from the list after some timeout.</p>
<p>And there’s still one final thing to deal with. Looking at my metrics there’s still some consistent traffic amounting to about 1000 requests per hour, and it’s mostly coming from a single IP.</p>
<p><img src="https://swlody.dev/static/re-rrgrng/69.png" width="auto" height="auto" alt="Screenshot of a message I sent in Zulip saying &#34;turns out there&#39;s one person who has been continuously spamming the submit endpoint with 69 once a second for the past 2 days&#34;"/></p>
<p>I love a good joke as much as anyone, but this compromises the integrity of the random number generator a bit too much. At this point I turn on Cloudflare’s “are you a human” challenge and traffic essentially drops to zero.<sup><a href="#user-content-fn-1" id="user-content-fnref-1" data-footnote-ref="" aria-describedby="footnote-label">1</a></sup></p>
<p>Well, that was an eventful week and not at all what I was expecting. I had started a new website project that I was excited about over the weekend, largely inspired by <a href="https://eieio.games/">Nolen Royalty<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>’s amazing blogpost about <a href="https://eieio.games/blog/one-million-checkboxes/">One Million Checkboxes<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>,<sup><a href="#user-content-fn-2" id="user-content-fnref-2" data-footnote-ref="" aria-describedby="footnote-label">2</a></sup> and had planned to spend most of the week working on that.<sup><a href="#user-content-fn-3" id="user-content-fnref-3" data-footnote-ref="" aria-describedby="footnote-label">3</a></sup> None of this was especially serious, and the traffic to the server was never super impressive, but it was still a fun exercise to have to live troubleshoot all these issues and to see the creative ways people managed to mess with the site.</p>
<p><img src="https://swlody.dev/static/re-rrgrng/traffic.png" width="auto" height="auto" alt="Screenshot of the past week of traffic proxied by Cloudflare increasing from 0 to a peak on January 29 and a total 554 unique visitors and 112k total requests"/></p>
<p>This experience helped drive home that having good logging, metrics, and monitoring set up is super useful for troubleshooting, even for basic websites that you don’t expect to get much traffic on. There were a few times during the week that I had wished I had more info in the logs and Sentry traces, and adding that extra information helped me debug issues later in the week.</p>
<p>If you made it to the end, thanks for reading! You can see the “finished” code for the project <a href="https://github.com/swlody/random-crowdsourced">here<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>. And if you’re a hiring manager on a backend, infrastructure, DevOps, or SRE team, <a href="https://swlody.dev/resume.pdf">hello<svg aria-hidden="true" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>!</p>
</article></div>
  </body>
</html>
