<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://sharpsec.run/rce-vulnerability-in-qbittorrent/">Original</a>
    <h1>RCE Vulnerability in QBittorrent</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>In qBittorrent, the DownloadManager class has <a href="https://github.com/qbittorrent/qBittorrent/blob/a126a7b4934d9e66fcedb60769523eb891da7086/src/base/net/downloadmanager.cpp#L154">ignored every SSL certificate validation error</a> that has ever happened, on every platform, for 14 years and 6 months since April 6 2010 with commit <a href="https://github.com/qbittorrent/qBittorrent/commit/9824d86a3cbecc9fd91f0462956ca575ef742110">9824d86</a>. The default behaviour changed to verifying on October 12 2024 with commit <a href="https://github.com/qbittorrent/qBittorrent/commit/3d9e9715b4660b8f57c3648a62a4d83c67db9de5">3d9e971</a>. The first patched release is version 5.0.1, released 2 days ago.</p>



<p>Note: this issue has now been assigned to <a href="https://www.cve.org/CVERecord?id=CVE-2024-51774" target="_blank" rel="noreferrer noopener">CVE-2024-51774</a></p>



<p>The usages of DownloadManager across the program are extensive, and affect searches, .torrent downloads, RSS feeds, favicon downloads and more. All of the following code paths accept any certificate whatsoever, whether expired, self-signed or both, in descending order of severity:</p>



<h3><strong>1. Malicious Executable loader with stealth functionality</strong></h3>



<p>If you are running Windows and you do not have a recent enough build of Python installed, at launch qBittorrent will prompt you to install/update Python from a hardcoded URL so you can use the search plugin which requires it, <a href="https://github.com/qbittorrent/qBittorrent/blob/2d185dc1c7932e775ecf5f2b0a7b7639ed8228f7/src/gui/mainwindow.cpp#L1579">source</a>:</p>



<pre><code lang="cpp">#ifdef Q_OS_WIN
            const QMessageBox::StandardButton buttonPressed = QMessageBox::question(this, tr(&#34;Missing Python Runtime&#34;)
                , tr(&#34;Python is required to use the search engine but it does not seem to be installed.\nDo you want to install it now?&#34;)
                , (QMessageBox::Yes | QMessageBox::No), QMessageBox::Yes);
            if (buttonPressed == QMessageBox::Yes)
                installPython();
...

#ifdef Q_OS_WIN
void MainWindow::installPython()
{
    setCursor(QCursor(Qt::WaitCursor));
    // Download python
    const auto installerURL = u&#34;https://www.python.org/ftp/python/3.12.4/python-3.12.4-amd64.exe&#34;_s;
    Net::DownloadManager::instance()-&gt;download(
            Net::DownloadRequest(installerURL).saveToFile(true)
            , Preferences::instance()-&gt;useProxyForGeneralPurposes()
            , this, &amp;MainWindow::pythonDownloadFinished);
}</code></pre>



<p>If you click or hit enter on the auto-selected ‘Yes’ option, qBittorrent will then <strong>**download, execute and then delete the .exe**</strong>, <a href="https://github.com/qbittorrent/qBittorrent/blob/2d185dc1c7932e775ecf5f2b0a7b7639ed8228f7/src/gui/mainwindow.cpp#L1889">source</a>;</p>



<pre><code lang="cpp">void MainWindow::pythonDownloadFinished(const Net::DownloadResult &amp;result)
{
    if (result.status != Net::DownloadStatus::Success)
    {
        ...
    }

    setCursor(QCursor(Qt::ArrowCursor));
    QProcess installer;
    qDebug(&#34;Launching Python installer in passive mode...&#34;);

    const Path exePath = result.filePath + u&#34;.exe&#34;;
    Utils::Fs::renameFile(result.filePath, exePath);
    installer.start(exePath.toString(), {u&#34;/passive&#34;_s});

    // Wait for setup to complete
    installer.waitForFinished(10 * 60 * 1000);

    qDebug(&#34;Installer stdout: %s&#34;, installer.readAllStandardOutput().data());
    qDebug(&#34;Installer stderr: %s&#34;, installer.readAllStandardError().data());
    qDebug(&#34;Setup should be complete!&#34;);

    // Delete temp file
    Utils::Fs::removeFile(exePath);

    // Reload search engine
    if ...
}
#endif // Q_OS_WIN</code></pre>



<p>qBittorrent has had this behaviour from <strong>June 2015</strong> until the present, affecting v3.2.1 through v5.0.0 inclusive. The behaviour does not appear to be replicated for other OS variants, they just disable the search widget if Python is not found or is not recent enough.</p>



<p>When the executable has finished downloading, it will be stored in for example:</p>



<p>C:\Users\_user_\AppData\Local\Temp\\<strong>is-G61QK.tmp</strong></p>



<p>Perhaps due to how `QProcess` instances behave, there will be two threads of the exe running and only one of them is killed after execution, the other persists in a sleeping state.</p>



<p>Obligatory screenshot of calc.exe, injected using mitmproxy:</p>



<figure><img fetchpriority="high" decoding="async" width="972" height="722" src="https://sharpsec.run/wp-content/uploads/2024/10/qBitDropper.png" alt="" srcset="https://sharpsec.run/wp-content/uploads/2024/10/qBitDropper.png 972w, https://sharpsec.run/wp-content/uploads/2024/10/qBitDropper-300x223.png 300w, https://sharpsec.run/wp-content/uploads/2024/10/qBitDropper-768x570.png 768w" sizes="(max-width: 972px) 100vw, 972px"/></figure>



<h3><strong>2. Browser Hijacking + Executable Download (Software Upgrade Context)</strong></h3>



<p>If you are running an installed version of qBittorrent on Windows or Linux and not an `appImage` file, then it will conduct an update check by default on launch, and this entails downloading an RSS feed from a <strong>hardcoded URL</strong> in the form of an <strong>XML document</strong> to parse the information about program releases:</p>



<pre><code lang="cpp">    void ProgramUpdater::checkForUpdates() const
{
    const auto RSS_URL = u&#34;https://www.fosshub.com/feed/5b8793a7f9ee5a5c3e97a3b2.xml&#34;_s;
    // Don&#39;t change this User-Agent. In case our updater goes haywire,
    // the filehost can identify it and contact us.
    Net::DownloadManager::instance()-&gt;download(
            Net::DownloadRequest(RSS_URL).userAgent(QStringLiteral(&#34;qBittorrent/&#34; QBT_VERSION_2 &#34; ProgramUpdater (www.qbittorrent.org)&#34;))
            , Preferences::instance()-&gt;useProxyForGeneralPurposes(), this, &amp;ProgramUpdater::rssDownloadFinished);
}</code></pre>



<p>Then it will parse the XML, extract the URL if the version is higher than currently running, and prompt the user to visit this URL without any filtering or verification:</p>



<pre><code lang="cpp">...
    if (type.compare(variant, Qt::CaseInsensitive) == 0)
            {
                qDebug(&#34;The last update available is %s&#34;, qUtf8Printable(version));
                if (!version.isEmpty())
                {
                    qDebug(&#34;Detected version is %s&#34;, qUtf8Printable(version));
                    if (isVersionMoreRecent(version))
                    {
                        m_newVersion = version;
                        m_updateURL = updateLink;
                    }
                }
                break;
            }
...</code></pre>



<p>If the user accepts this prompt, they open this URL in their default browser. The expectation of the user is to receive an exe file and the context is one of trust, as the link/download came from software they run:</p>



<pre><code lang="cpp">bool ProgramUpdater::updateProgram() const
{
    return QDesktopServices::openUrl(m_updateURL);
}</code></pre>



<p>So, if a user is directed to any given filesharing site such as mediafire etc, they can download an attacker-controlled exe they expect to function like an upgrade. As the project is OSS, the latest version can easily be recompiled with additional backdoor functionality. The devs provide a <a href="https://github.com/qbittorrent/qBittorrent/raw/master/5B7CC9A2.asc">key</a> to check the signature of the binary, but it has to be checked <strong>and a verification failure must be respected</strong> in order to protect a user.</p>



<h3><strong>3. RSS Feeds (Arbitrary URL injection)</strong></h3>



<p>All RSS feeds parsed by the application go through DownloadManager, so they can be hijacked. The URLs visited by a victim can be observed and catalogued, and by nature they are static, long-lived URLs. The `link` element inside each entry is parsed directly and will be downloaded if double-clicked. This applies even without MITM tampering – you are a double click away from any URL inserted into any RSS feed you follow, either by the authors or by attackers who poison the feed.</p>



<pre><code lang="cpp">            else if (name == u&#34;link&#34;)
            {
                const QString link = (xml.attributes().isEmpty()
                                ? xml.readElementText().trimmed()
                                : xml.attributes().value(u&#34;href&#34;_s).toString());

                if (link.startsWith(u&#34;magnet:&#34;, Qt::CaseInsensitive))
                {
                    article[Article::KeyTorrentURL] = link; // magnet link instead of a news URL
                }
                else
                {
                    // Atom feeds can have relative links, work around this and
                    // take the stress of figuring article full URI from UI
                    // Assemble full URI
                    article[Article::KeyLink] = (m_baseUrl.isEmpty() ? link : m_baseUrl + link);
                }
            }</code></pre>



<p>What makes this one even more damaging is <a href="https://www.cvedetails.com/cve/CVE-2019-13640/">CVE-2019-13640</a> which allowed remote command execution via shell metacharacters in the torrent name or current tracker parameters. This combination means the authentic RSS author need not send malicious data, as a MITM attacker can also do it.</p>



<h3><strong>4. Decompression library attack surface (0-click)</strong></h3>



<p>At launch, by default the program will automatically download a .gz extension binary MaxMind GeopIP database from a hardcoded URL, and then extract it. If there are any vulnerabilities in zlib decompression, such as <a href="https://nvd.nist.gov/vuln/detail/CVE-2022-37434">CVE-2022-37434 the CVSS 9.8 Critical buffer overflow from 2022</a>, which <strong>does not apply here </strong>since the `inflateGetHeader()` function is not called, an attacker can target this attack surface with an arbitrary file up to 64MB, logging and returning after any errors;</p>



<pre><code lang="cpp">    ...

    bool ok = false;
    const QByteArray data = Utils::Gzip::decompress(result.data, &amp;ok);
    if (!ok)
    {
        LogMsg(tr(&#34;Could not decompress IP geolocation database file.&#34;), Log::WARNING);
        return;
    }</code></pre>



<p>The code which parses the binary MaxMind database after decompression is well guarded as of 2024 but used to look different, potentially providing more attack surface. There is also an interesting <a href="https://github.com/qbittorrent/qBittorrent/commit/7d1ac06ce215057b3340caaea1fe99aa5a634a0c">commit</a> where a contributor makes adjustments to the `gzip::decompress()` function which hints at a stack overflow, as the destination buffer was changed from static allocation on the stack to dynamic allocation on the heap, though it was not exploitable due to checks before it is written to:</p>



<pre><code lang="cpp">-105           char tmpBuf[BUFSIZE] = {0};
+107           std::vector&lt;char&gt; tmpBuf(BUFSIZE);</code></pre>



<h2>Exploit Possibilities</h2>



<p>Because all the Python installer exe URLs and update RSS feed URLs are hardcoded, they can be trivially enumerated and a malicious script in MITM context can attack every vulnerable version. Better, the RSS feed URLs provide a fingerprint for the software as there is no other reason to visit one of those URLs unless qBittorrent is running. This means mass surveillance programs like PRISM and equivalent can easily detect qBittorrent users via passive traffic monitoring. Then, because there is no cert validation, there is no need for expensive and complex deployments like <a href="https://www.schneier.com/blog/archives/2013/10/how_the_nsa_att.html">QUANTUM</a> to perform a <a href="https://en.wikipedia.org/wiki/Man-on-the-side_attack">Man-On-The-Side</a> attack – you can just spoof the destination server.</p>



<p>Another aspect of the URLs being hardcoded is that an adversary can selectively intercept only requests from qBittorrent which do not verify the connection, instead of alerting a victim when his browser/other applications fails to securely connect to the internet.</p>



<p>Because this software is open source, it is trivial to add a backdoor to it and recompile, and therefore give a victim fully functional software, avoiding the victim’s suspicion.</p>



<p>Scripting possibilities, when used in conjunction with mitmproxy using `-s` to supply a python script:</p>



<ul>
<li>Automated replacement of all Python exes with arbitrary exe: <strong>RCE with a single click</strong></li>



<li>Automated replacement of all qBittorrent update URLs in RSS feed: <strong>Browser Hijacking/RCE with moderate user interaction</strong></li>



<li>Automated replacement of all/specific links in qBittorrent RSS viewer: <strong>RCE until 2019, Download Hijacking</strong></li>
</ul>



<h2>Mitigations</h2>



<p>Upgrade to v5.0.1 by downloading it <strong>manually with a browser</strong>, not via the update prompt in-app.  Or just use another client, as Deluge and Transmission etc do not have this vulnerability.</p>



<h2>Notes</h2>



<p>People dismiss attacks requiring MITM access as theoretical, dangerously forgetting the lessons of recent <a href="https://epic.org/documents/epic-v-doj-prism/">history</a>, and present realities in non-free countries like <a href="https://github.com/net4people/bbs/issues/27">China</a>, <a href="https://news.ycombinator.com/item?id=28541117">UAE</a> and <a href="https://www.f5.com/labs/articles/threat-intelligence/kazakhstan-attempts-to-mitm-itscitizens">Kazakhstan</a>. A CVE has been issued, and I have been in contact with the maintainers of the repo, though they have not commented on whether or not they intend to release a security advisory on Github.</p>
</div></div>
  </body>
</html>
