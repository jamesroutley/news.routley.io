<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://kennyballou.com/blog/2016/12/elixir-hot-swapping/index.html">Original</a>
    <h1>Elixir/Erlang Hot Swapping Code</h1>
    
    <div id="readability-page-1" class="page"><div id="text-org99784cb">
<p>
As the naming might suggest, &#34;appups&#34; and &#34;relups&#34; are the &#34;upgrade&#34;
versions of applications and releases, respectively.  Appups describe how
to take a single application and upgrade its modules, specifically, it
will have instructions for upgrading modules that require &#34;extras&#34;. or,
if we are upgrading supervisors, for example, the Appup will have the
correct instructions for adding and removing child processes.
</p>

<p>
Before we examine some examples of these files, let&#39;s first look at the
type specification for each.
</p>

<p>
Here is the syntax structure for the <code>appup</code> resource file:
</p>

<pre>{Vsn,
  [{UpFromVsn, Instructions}, ...],
  [{DownToVsn, Instructions}, ...]}.
</pre>

<p>
The first element of the triple is the version we are either upgrading to or
downgrading from.  The second element is a keyword list of upgrade instructions
keyed by the version the application would be coming <i>from</i>.  Similarly, the
third element is a keyword list of downgrade instructions keyed by the version
the application will downgrade <i>to</i>.  For more information about the types
themselves, see the <a href="http://erlang.org/doc/man/appup.html">SASL documentation</a>.
</p>

<p>
Now that we have seen the syntax, let&#39;s look at an example of the appup
resource file for the octochat application generated using
<a href="https://github.com/bitwalker/distillery">distillery</a>:
</p>

<pre>± cat rel/octochat/lib/octochat-0.2.1/ebin/octochat.appup
{&#34;0.2.1&#34;,
 [{&#34;0.2.0&#34;,[{load_module,&#39;Elixir.Octochat.Echo&#39;,[]}]}],
 [{&#34;0.2.0&#34;,[{load_module,&#39;Elixir.Octochat.Echo&#39;,[]}]}]}.
</pre>

<p>
Comparing this to the syntax structure above, we see that we have a <code>Vsn</code>
element of <code>&#34;0.2.1&#34;</code>, we have a <code>{UpFromVsn, Instructions}</code> pair:
<code>[{&#34;0.2.0&#34;,[{load_module,&#39;Elixir.Octochat.Echo&#39;,[]}]}]</code>, and we have a single
<code>{DownToVsn, Instructions}</code> pair:
<code>[{&#34;0.2.0&#34;,[{load_module,&#39;Elixir.Octochat.Echo&#39;,[]}]}]</code>.
</p>

<p>
The instructions themselves tell us what exactly is required to go from one
version to the another.  Specifically, in this example, to upgrade, we need to
&#34;load&#34; the <code>Octochat.Echo</code> module into the VM.  Similarly, the instructions to
downgrade are the same.  For a <a href="http://semver.org">semantically versioned</a>
project, this is an understandably small change.
</p>

<p>
It&#39;s worth noting the instructions found in the <code>.appup</code> files are
usually high-level instructions, thus, <code>load_module</code> covers both the
loading of object code into memory and the suspend, replace, resume
process of upgrading applications.
</p>

<p>
Next, let&#39;s look at the syntax structure of a <code>relup</code> resource file:
</p>

<pre>{Vsn,
 [{UpFromVsn, Descr, Instructions}, ...],
 [{DownToVsn, Descr, Instructions}, ...]}.
</pre>

<p>
This should look familiar.  It&#39;s essentially the exact same as the
<code>.appup</code> file.  However, there&#39;s an extra term, <code>Descr</code>.  The <code>Descr</code>
field can be used as part of the version identification, but is
optional.  Otherwise, the syntax of this file is the same as the
<code>.appup</code>.
</p>

<p>
Now, let&#39;s look at an example <code>relup</code> file for the same release of
octochat:
</p>

<pre>± cat rel/octochat/releases/0.2.1/relup
{&#34;0.2.1&#34;,
 [{&#34;0.2.0&#34;,[],
   [{load_object_code,{octochat,&#34;0.2.1&#34;,[&#39;Elixir.Octochat.Echo&#39;]}},
    point_of_no_return,
    {load,{&#39;Elixir.Octochat.Echo&#39;,brutal_purge,brutal_purge}}]}],
 [{&#34;0.2.0&#34;,[],
   [{load_object_code,{octochat,&#34;0.2.0&#34;,[&#39;Elixir.Octochat.Echo&#39;]}},
    point_of_no_return,
    {load,{&#39;Elixir.Octochat.Echo&#39;,brutal_purge,brutal_purge}}]}]}.
</pre>

<p>
This file is a little more dense, but still adheres to the basic triple syntax
we just examined.  Let&#39;s take a closer look at the upgrade instructions:
</p>

<pre>[{load_object_code,{octochat,&#34;0.2.1&#34;,[&#39;Elixir.Octochat.Echo&#39;]}},
 point_of_no_return,
 {load,{&#39;Elixir.Octochat.Echo&#39;,brutal_purge,brutal_purge}}]
</pre>

<p>
The first instruction,
<code>{load_object_code,{octochat,&#34;0.2.1&#34;,[&#39;Elixir.Octochat.Echo&#39;]}}</code>, tells the
<a href="http://erlang.org/doc/man/release_handler.html">release handler</a> to load into memory the new
version of the &#34;Octochat.Echo&#34; module, specifically the one associated with
version &#34;0.2.1&#34;.  But this instruction will not instruct the release handler to
(re)start or replace the existing module yet.  Next, <code>point_of_no_return</code>, tells
the release handler that failure beyond this point is fatal, if the upgrade
fails after this point, the system is restarted from the old release version
(<a href="http://erlang.org/doc/man/appup.html">appup documentation</a>).  The final instruction,
<code>{load,{&#39;Elixir.Octochat.Echo&#39;,brutal_purge,brutal_purge}}</code>, tells the release
handler to replace the running version of the module and use the newly loaded
version.
</p>

<p>
For more information regarding <code>burtal_purge</code>, check out the &#34;PrePurge&#34; and
&#34;PostPurge&#34; values in the <a href="http://erlang.org/doc/man/appup.html">appup documentation</a>.
</p>

<p>
Similar to the <code>.appup</code> file, the third element in the triple describes to the
release handler how to downgrade the release as well.  The version numbers in
this case make this a bit more obvious as well, however, the steps are
essentially the same.
</p>
</div></div>
  </body>
</html>
