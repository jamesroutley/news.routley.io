<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://leontrolski.github.io/grammar.html">Original</a>
    <h1>Adding syntax to the CPython interpreter</h1>
    
    <div id="readability-page-1" class="page">
        <a href="https://leontrolski.github.io/index.html">
            <img src="https://leontrolski.github.io/pic.png"/>
            â‡¦
        </a>
        <p><i>2024-10-17</i></p>
        

<p><em>Condensed version of <a href="https://miguendes.me/what-if-python-had-this-ruby-feature">this cool blog post</a>.</em></p>
<p>Let&#39;s add some new syntax to Python! Making a small change is not so hard.</p>
<p>Our aim is to make ternary statements default to <code>None</code> as they do in Ruby:</p>
<pre><code>&gt;&gt;&gt; <span>&#34;hello&#34;</span> if <span>2</span> + <span>2</span> == <span>4</span>
<span>&#34;hello&#34;</span>
&gt;&gt;&gt; <span>&#34;hello&#34;</span> if <span>2</span> + <span>2</span> == <span>5</span>
None
</code></pre>
<p>In existing Python, we get an error:</p>
<pre><code><span>File</span> <span>&#34;&lt;python-input-0&gt;&#34;</span>, <span>line</span> <span>1</span>
    <span>&#34;hello&#34;</span> <span>if</span> <span>2</span> + <span>2</span> == <span>5</span>
    ^^^^^^^^^^^^^^^^^^^^^
SyntaxError: expected <span>&#39;else</span>&#39; <span>after</span> <span>&#39;if</span>&#39; expression
</code></pre>
<p>First, let&#39;s clone and build Python:</p>
<pre><code>git clone git@github<span>.com</span>:python/cpython<span>.git</span>
cd cpython
./configure
make
</code></pre>
<p>Now let&#39;s run the Python interpreter we built and check it works:</p>
<pre><code>./python.exe
&gt;&gt;&gt; <span>2</span> + <span>2</span>
<span>4</span>
</code></pre>
<p>Now lets&#39;s change the grammar so that if we don&#39;t have an <code>else</code> condition we default to <code>None</code>.</p>
<p>First find the following in <code>Grammar/python.gram</code>:</p>
<pre><code>expression[expr_ty] (memo):
    | <span>invalid_expression</span>
    | <span>invalid_legacy_expression</span>
    | <span>a</span>=disjunction &#39;<span>if</span>&#39; b=disjunction &#39;<span>else</span>&#39; c=expression { _PyAST_IfExp(b, a, c, EXTRA) }
    | <span>disjunction</span>
    | <span>lambdef</span>
</code></pre><p>And change it to:</p>
<pre><code>expression[expr_ty] (memo):
    | <span>invalid_expression</span>
    | <span>invalid_legacy_expression</span>
    | <span>a</span>=disjunction &#39;<span>if</span>&#39; b=disjunction &#39;<span>else</span>&#39; c=expression { _PyAST_IfExp(b, a, c, EXTRA) }
    | <span>a</span>=disjunction &#39;<span>if</span>&#39; b=disjunction { _PyAST_IfExp(b, a, _PyAST_Constant(Py_None, NULL, EXTRA), EXTRA) }
    | <span>disjunction</span>
    | <span>lambdef</span>
</code></pre><p>Now lets regenerate the <code>c</code> files from the grammar:</p>
<pre><code><span>make</span> regen-pegen
git diff  <span># to see what changed</span>
</code></pre>
<p>And compile the interpreter again:</p>
<pre><code><span>make</span>
</code></pre>
<p>Now we have our shiny new ternary expressions:</p>
<pre><code>./python.exe
<span>&gt;&gt;&gt; </span>print(<span>&#34;hello&#34;</span> <span>if</span> <span>2</span> + <span>2</span> == <span>4</span>)
hello
<span>&gt;&gt;&gt; </span>print(<span>&#34;hello&#34;</span> <span>if</span> <span>2</span> + <span>2</span> == <span>5</span>)
<span>None</span>
&gt;&gt;&gt;
</code></pre>
<p>Yay!</p>

    

</div>
  </body>
</html>
