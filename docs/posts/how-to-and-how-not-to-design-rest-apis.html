<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/stickfigure/blog/wiki/How-to-%28and-how-not-to%29-design-REST-APIs">Original</a>
    <h1>How to (and how not to) design REST APIs</h1>
    
    <div id="readability-page-1" class="page"><div data-view-component="true">          <div id="wiki-body">
              <div>
                
<p>In my career, I have consumed hundreds of REST APIs and produced dozens. Since I often see the same mistakes repeated in API design, I thought it might be nice to write down a set of best practices. And poke fun at a couple widely-used APIs.</p>
<p>Much of this may be &#34;duh&#34;, but there might be a few rules you haven&#39;t considered yet.</p>
<h2 id="user-content-rule-1-do-use-plural-nouns-for-collections"><a href="#rule-1-do-use-plural-nouns-for-collections">Rule #1: DO use plural nouns for collections<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p>It&#39;s an arbitrary convention, but it&#39;s well-established and I have found violations tend to be a leading indicator of &#34;this API will have rough edges&#34;.</p>
<div data-snippet-clipboard-copy-content="# GOOD
GET /products              # get all the products
GET /products/{product_id} # get one product

# BAD
GET /product/{product_id}"><pre><code># GOOD
GET /products              # get all the products
GET /products/{product_id} # get one product

# BAD
GET /product/{product_id}
</code></pre></div>
<h2 id="user-content-rule-2-dont-add-unnecessary-path-segments"><a href="#rule-2-dont-add-unnecessary-path-segments">Rule #2: DON&#39;T add unnecessary path segments<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p>A common mistake seems to be trying to build your relational model into your URL structure. Etsy&#39;s <em>new</em> API is <a href="https://developer.etsy.com/documentation/reference#operation/getListing" rel="nofollow">full of this kind of thing</a>:</p>
<div data-snippet-clipboard-copy-content="# GOOD
GET /v3/application/listings/{listing_id}

# BAD
PATCH /v3/application/shops/{shop_id}/listings/{listing_id}
GET /v3/application/shops/{shop_id}/listings/{listing_id}/properties
PUT /v3/application/shops/{shop_id}/listings/{listing_id}/properties/{property_id}"><pre><code># GOOD
GET /v3/application/listings/{listing_id}

# BAD
PATCH /v3/application/shops/{shop_id}/listings/{listing_id}
GET /v3/application/shops/{shop_id}/listings/{listing_id}/properties
PUT /v3/application/shops/{shop_id}/listings/{listing_id}/properties/{property_id}
</code></pre></div>
<p>The <code>{listing_id}</code> is globally unique; there&#39;s no reason for <code>{shop_id}</code> to be part of the URL. Besides irritating your developers with extra clutter, it inevitably causes problems when your invariant changes down the road - say, a listing moves to a different store or can be listed in multiple stores.</p>
<p>I&#39;ve seen this mistake repeated over and over; I can only assume it&#39;s a manifestation of someone&#39;s OCD:</p>
<div data-snippet-clipboard-copy-content="GET /shops/{shop_id}/listings              # normal, expected
GET /shops/{shop_id}/listings/{listing_id} # someone trying to be &#34;consistent&#34;?
GET /listings/{listing_id}                 # a much better endpoint"><pre><code>GET /shops/{shop_id}/listings              # normal, expected
GET /shops/{shop_id}/listings/{listing_id} # someone trying to be &#34;consistent&#34;?
GET /listings/{listing_id}                 # a much better endpoint
</code></pre></div>
<p>Which is not to say that compound URLs don&#39;t make sense - use them when you genuinely have compound keys.</p>
<div data-snippet-clipboard-copy-content="# When {option_id} is not globally unique
GET /listings/{listing_id}/options/{option_id}"><pre><code># When {option_id} is not globally unique
GET /listings/{listing_id}/options/{option_id}
</code></pre></div>
<h2 id="user-content-rule-3-dont-add-json-or-other-extensions-to-the-url"><a href="#rule-3-dont-add-json-or-other-extensions-to-the-url">Rule #3: DON&#39;T add .json or other extensions to the url<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p>This seems to have been some sort of default behavior of Rails, so it shows up intermittently in public APIs. <a href="https://shopify.dev/docs/api/admin-rest" rel="nofollow">Shopify</a> gets shame here.</p>
<ul>
<li>URLs are resource identifiers, not representations. Adding representation information to the URL means there&#39;s no canonical URL for a &#39;thing&#39;. Clients may have trouble uniquely identifying &#39;things&#39; by URL.</li>
<li>&#34;JSON&#34; is not even a complete specification of the representation. What transfer encoding, for example?</li>
<li>HTTP already offers headers (<code>Accept</code>, <code>Accept-Charset</code>, <code>Accept-Encoding</code>, <code>Accept-Language</code>) to negotiate representations.</li>
<li>Putting stock text at the end of URLs annoys the people writing clients.</li>
<li>JSON should be the default anyway.</li>
</ul>
<p>Back in the 2000s there might have been some question about whether clients want JSON or XML, but here in the 2020s it has been settled. Return JSON, and if clients want to negotiate for something else, rely on the standard HTTP headers.</p>
<h2 id="user-content-rule-4-dont-return-arrays-as-top-level-responses"><a href="#rule-4-dont-return-arrays-as-top-level-responses">Rule #4: DON&#39;T return arrays as top level responses<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p>The top level response from an endpoint should always be an object, never an array.</p>
<div data-snippet-clipboard-copy-content="# GOOD
GET /things returns:
{ &#34;data&#34;: [{ ...thing1...}, { ...thing2...}] }

# BAD
GET /things returns:
[{ ...thing1...}, { ...thing2...}]"><pre><code># GOOD
GET /things returns:
{ &#34;data&#34;: [{ ...thing1...}, { ...thing2...}] }

# BAD
GET /things returns:
[{ ...thing1...}, { ...thing2...}]
</code></pre></div>
<p>The problem is that it&#39;s very hard to make backwards compatible changes when you return arrays. Objects let you make additive changes.</p>
<p>The obvious common evolution in this specific example will be to add pagination. You can always add <code>totalCount</code> or <code>hasMore</code> fields and old clients will continue to work. If your endpoint returns a top-level array, you will need a whole new endpoint.</p>
<h2 id="user-content-rule-5-dont-return-map-structures"><a href="#rule-5-dont-return-map-structures">Rule #5: DON&#39;T return map structures<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p>I often see map structures used for collections in JSON responses. Return an array of objects instead.</p>
<div data-snippet-clipboard-copy-content="# BAD
GET /things returns:
{
    &#34;KEY1&#34;: { &#34;id&#34;: &#34;KEY1&#34;, &#34;foo&#34;: &#34;bar&#34; },
    &#34;KEY2&#34;: { &#34;id&#34;: &#34;KEY2&#34;, &#34;foo&#34;: &#34;baz&#34; },
    &#34;KEY3&#34;: { &#34;id&#34;: &#34;KEY3&#34;, &#34;foo&#34;: &#34;bat&#34; }
}

# GOOD (also note application of Rule #4)
GET /things returns:
{
    &#34;data&#34;: [
        { &#34;id&#34;: &#34;KEY1&#34;, &#34;foo&#34;: &#34;bar&#34; },
        { &#34;id&#34;: &#34;KEY2&#34;, &#34;foo&#34;: &#34;baz&#34; },
        { &#34;id&#34;: &#34;KEY3&#34;, &#34;foo&#34;: &#34;bat&#34; }
    ]   
}"><pre><code># BAD
GET /things returns:
{
    &#34;KEY1&#34;: { &#34;id&#34;: &#34;KEY1&#34;, &#34;foo&#34;: &#34;bar&#34; },
    &#34;KEY2&#34;: { &#34;id&#34;: &#34;KEY2&#34;, &#34;foo&#34;: &#34;baz&#34; },
    &#34;KEY3&#34;: { &#34;id&#34;: &#34;KEY3&#34;, &#34;foo&#34;: &#34;bat&#34; }
}

# GOOD (also note application of Rule #4)
GET /things returns:
{
    &#34;data&#34;: [
        { &#34;id&#34;: &#34;KEY1&#34;, &#34;foo&#34;: &#34;bar&#34; },
        { &#34;id&#34;: &#34;KEY2&#34;, &#34;foo&#34;: &#34;baz&#34; },
        { &#34;id&#34;: &#34;KEY3&#34;, &#34;foo&#34;: &#34;bat&#34; }
    ]   
}
</code></pre></div>
<p>Map structures in JSON are bad:</p>
<ul>
<li>The key information is redundant and adds noise to the wire</li>
<li>Unnecessary dynamic keys create headaches for people working in typed languages</li>
<li>Whatever you think a &#34;natural&#34; key is can change, or clients may want a different grouping</li>
</ul>
<p>Converting an array of objects to a map is a one-liner in most languages. If your client wants efficient random-access to the collection of objects, they can create that structure. You don&#39;t need to put it on the wire.</p>
<p>The worst thing about returning map structures is that your conceptual keys may change over time, and the only way to migrate is to break backwards compatibility. OpenAPI is a cautionary tale - <a href="https://github.com/OAI/moonwalk">v3 to v4</a> is full of unnecessary breaking changes because they rely heavily on map structures instead of array structures.</p>
<div data-snippet-clipboard-copy-content="# OpenAPI v3 structure
{
    &#34;paths&#34;: {
        &#34;/speakers&#34;: {
            &#34;post&#34;: { ...information about the endpoint...}
        }
    }
}

# Proposed OpenAPI v4 structure, which names requests by adding a new 
# map layer (eg &#34;createSpeaker&#34;).
{
    &#34;paths&#34;: {
        &#34;/speakers&#34;: {
            &#34;requests&#34;: {
                &#34;createSpeaker&#34;: {
                    &#34;method&#34;: &#34;post&#34;,
                    ...rest of the endpoint info...
                }
            }
        }
    }
}"><pre><code># OpenAPI v3 structure
{
    &#34;paths&#34;: {
        &#34;/speakers&#34;: {
            &#34;post&#34;: { ...information about the endpoint...}
        }
    }
}

# Proposed OpenAPI v4 structure, which names requests by adding a new 
# map layer (eg &#34;createSpeaker&#34;).
{
    &#34;paths&#34;: {
        &#34;/speakers&#34;: {
            &#34;requests&#34;: {
                &#34;createSpeaker&#34;: {
                    &#34;method&#34;: &#34;post&#34;,
                    ...rest of the endpoint info...
                }
            }
        }
    }
}
</code></pre></div>
<p>If this was a flatter list structure, adding a name to an object is a nonbreaking change:</p>
<div data-snippet-clipboard-copy-content="# Hypothetical flat array structure, using fields instead of map keys
{
    &#34;requests&#34;: [
        {
            name: &#34;createSpeaker&#34;,    // adding this field is nonbreaking
            path: &#34;/speakers&#34;,
            method: &#34;post&#34;,
            ...etc...
        }
    ]
}"><pre><code># Hypothetical flat array structure, using fields instead of map keys
{
    &#34;requests&#34;: [
        {
            name: &#34;createSpeaker&#34;,    // adding this field is nonbreaking
            path: &#34;/speakers&#34;,
            method: &#34;post&#34;,
            ...etc...
        }
    ]
}
</code></pre></div>
<h3 id="user-content-exception-to-the-no-map-rule"><a href="#exception-to-the-no-map-rule">Exception to the no-map rule<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p>The exception to the no-map rule is simple key/value pairs, like <a href="https://stripe.com/docs/api/metadata" rel="nofollow">Stripe&#39;s metadata</a>.</p>
<div data-snippet-clipboard-copy-content="# OK
{ 
    &#34;key1&#34;: &#34;value1&#34;,
    &#34;key2&#34;: &#34;value2&#34;
}"><pre><code># OK
{ 
    &#34;key1&#34;: &#34;value1&#34;,
    &#34;key2&#34;: &#34;value2&#34;
}
</code></pre></div>
<p>Nobody will fault you for this structure. But if the values are more than simple strings, prefer arrays of objects instead.</p>
<h2 id="user-content-rule-6-do-use-strings-for-all-identifiers"><a href="#rule-6-do-use-strings-for-all-identifiers">Rule #6: DO use strings for all identifiers<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p>Always use strings for object identifiers, even if your internal representation (ie database column type) is numeric. Just stringify the number.</p>
<div data-snippet-clipboard-copy-content="# BAD
{ &#34;id&#34;: 123 }

# GOOD
{ &#34;id&#34;: &#34;123&#34; }"><pre><code># BAD
{ &#34;id&#34;: 123 }

# GOOD
{ &#34;id&#34;: &#34;123&#34; }
</code></pre></div>
<p>A great API will outlast you, your implementation code, and the company that created it. In that time your infrastructure might be rewritten on a different technology platform, migrated to a new database, or merged with another database that contains conflicting IDs.</p>
<p>String IDs are incredibly flexible. Strings can encode version information or segment ID ranges. Strings can encode composite keys. Numeric IDs put a straightjacket on future developers.</p>
<p>I once worked on a system that (because of a database merge) had to segment numeric ID ranges by giving one group positive IDs, the other negative IDs. Aside from the general ugliness, you can only do this segmentation once.</p>
<p>As a bonus, if all your ID fields are strings, client developers working in typed languages don&#39;t need to think about which type to use. Just use strings!</p>
<h2 id="user-content-rule-7-do-prefix-your-identifiers"><a href="#rule-7-do-prefix-your-identifiers">Rule #7: DO prefix your identifiers<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p>If your application is at all complicated, you&#39;ll end up with a <em>lot</em> of different object types. Keeping opaque IDs straight is a mental challenge for both you and your client developers. You can dramatically improve the ergonomics of your API by making different types of IDs self-describing.</p>
<ul>
<li>Stripe&#39;s identifiers have two-letter-plus-underscore prefixes: <code>in_1MVpWEJVZPfyS2HyRgVDkwiZ</code>
</li>
<li>Shopify&#39;s graphql identifiers look like URLs (though their REST API IDs are numeric, boo): <code>gid://shopify/FulfillmentOrder/1469358604360</code>
</li>
</ul>
<p>It doesn&#39;t matter what format you use, as long as 1) they&#39;re visually distinct and 2) they don&#39;t change.</p>
<p>Everyone will appreciate the reduced support load when you can instantly tell the difference between an &#34;order line item ID&#34;, a &#34;fulfillment order line item ID&#34;, and an &#34;invoice item line item ID&#34;.</p>
<h2 id="user-content-rule-8-dont-use-404-to-indicate-not-found"><a href="#rule-8-dont-use-404-to-indicate-not-found">Rule #8: DON&#39;T use 404 to indicate &#34;not found&#34;<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p>The HTTP spec says you should use 404 to indicate that a resource was not found. A literal interpretation suggests you should return 404 for GET/PUT/DELETE/etc requests to an ID that does not exist. Please do not do this - hear me out.</p>
<p>When calling (say) <code>GET /things/{thing_id}</code> for a thing that doesn&#39;t exist, the response should indicate that 1) the server understood your request, and 2) the thing wasn&#39;t found. Unfortunately, a 404 response does not guarantee #1. There are many layers of software that can return 404 to a request, some of which you may have no control over:</p>
<ul>
<li>Misconfigured client hitting the wrong URL</li>
<li>Misconfigured proxies (client end and server end)</li>
<li>Misconfigured load balancers</li>
<li>Misconfigured routing tables in the server application</li>
</ul>
<p>Returning HTTP 404 for &#34;thing not found&#34; is almost like returning HTTP 500 - it could mean the thing doesn&#39;t exist, or it could mean something went wrong; the client cannot be sure which.</p>
<p>This is not a minor problem. One of the hardest things about distributed systems is maintaining consistency. Let&#39;s say you want to delete a resource from two systems (Alpha and Bravo) and all you have is a simple REST API (no two-phase-commit):</p>
<ol>
<li>In a single database transaction, SystemAlpha deletes Thing123 and enqueues a NotifyBravo job</li>
<li>The NotifyBravo job runs, calling <code>DELETE /things/Thing123</code> on SystemBravo</li>
</ol>
<p>This works because the queue will retry jobs until success. But it may also retry jobs that have succeeded; queues are at-least-once, not <a href="https://en.wikipedia.org/wiki/Two_Generals%27_Problem" rel="nofollow">exactly-once</a>.</p>
<p>Since successfully-executed <code>DELETE</code> jobs may retry anyway, jobs must treat the &#34;not found&#34; response as success. If you treat 404 as success, and a failure in your stack returns 404, your job will be removed from the queue and your delete will not propagate. I have seen this happen in real life.</p>
<p>You could simply have <code>DELETE</code> return 200 (or 204) OK when deleting a nonexistant thing - it makes sense, and I think it&#39;s an acceptable answer for <code>DELETE</code>. But some analogue of this issue exists for <code>GET</code>, <code>PUT</code>, <code>PATCH</code>, and other methods.</p>
<p>You could use 404 but return a custom error body and demand that clients check for a correct error body. This is asking for trouble from lazy client programmers. It might or might not be &#34;your fault&#34; when clients see eventually inconsistent data, but the support calls they send you will be real.</p>
<p>My advice is to pick another 400-level error code that clients can interpret as &#34;I understand what you&#39;re asking for, but I don&#39;t have it&#34;. I use 410 GONE. This diverges slightly from the original intended meaning of 410 (&#34;it existed before, but it doesn&#39;t now&#34;) but nobody actually uses that error, it&#39;s reasonably self-explanatory, and there&#39;s no risk that a future HTTP spec will repurpose your made-up 4XX number.</p>
<p>But almost any strategy is better than returning 404 for entity not found.</p>
<h2 id="user-content-rule-9-be-consistent"><a href="#rule-9-be-consistent">Rule #9: BE consistent<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p>Mostly this section is here so that I can mock Shopify. There are 6 subtly different schemas for an Address in their REST API:</p>
<ul>
<li>
<a href="https://shopify.dev/docs/api/admin-rest/2023-07/resources/draftorder" rel="nofollow">DraftOrder</a> has most of the address fields you would expect, including <code>name</code>, <code>first_name</code>, <code>last_name</code>, <code>province</code>, <code>province_code</code>, <code>country</code>, <code>country_code</code>
</li>
<li>
<a href="https://shopify.dev/docs/api/admin-rest/2023-07/resources/customer-address" rel="nofollow">Customer Address</a> adds <code>country_name</code>
</li>
<li>
<a href="https://shopify.dev/docs/api/admin-rest/2023-07/resources/order" rel="nofollow">Order</a> billing_address adds <code>latitude</code>,  <code>longitude</code> but shipping_address does not</li>
<li>
<a href="https://shopify.dev/docs/api/admin-rest/2023-07/resources/checkout" rel="nofollow">Checkout</a> billing_address and shipping_address have no <code>name</code> (but still have <code>first_name</code>, <code>last_name</code>)</li>
<li>
<a href="https://shopify.dev/docs/api/admin-rest/2023-07/resources/assignedfulfillmentorder" rel="nofollow">AssignedFulfillmentOrder</a> destination is missing <code>name</code>, <code>province_code</code>, <code>country_code</code> (but still has <code>first_name</code>, <code>last_name</code>, and the full <code>country</code> and <code>province</code> names)</li>
<li>
<a href="https://shopify.dev/docs/api/admin-rest/2023-07/resources/location" rel="nofollow">Location</a> has <code>name</code> but not <code>first_name</code> or <code>last_name</code> - at least this one makes sense</li>
</ul>
<p>This is <em>maddening</em>. It feels like someone at Shopify is toying with us: &#34;<em>Simon says</em> there&#39;s a <code>country</code> field. <em>Simon says</em> there&#39;s a <code>country_name</code> field. There&#39;s a <code>country_code</code> field. Hahaha, null pointer exception for you!&#34;</p>
<p>Please <em>please</em> do your best to keep fields consistent among objects with similar meanings. If you&#39;re working in a dynamic language like Ruby or Python, try extra hard!</p>
<h2 id="user-content-rule-10-do-use-a-structured-error-format"><a href="#rule-10-do-use-a-structured-error-format">Rule #10: DO use a structured error format<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p>If you&#39;re building the backend for a simple website you can probably ignore this section. But if you&#39;re building a large system with multiple layers of REST services, you can save yourself a lot of headache by establishing a standard error format up front.</p>
<p>My error formats tend to look something like this, roughly shaped like a (Java) exception:</p>
<div data-snippet-clipboard-copy-content="{
  &#34;message&#34;: &#34;You do not have permission to access this resource&#34;,
  &#34;type&#34;: &#34;Unauthorized&#34;,
  &#34;types&#34;: [&#34;Unauthorized&#34;, &#34;Security&#34;],
  &#34;cause&#34;: { ...recurse for nested any exceptions... }
}"><pre><code>{
  &#34;message&#34;: &#34;You do not have permission to access this resource&#34;,
  &#34;type&#34;: &#34;Unauthorized&#34;,
  &#34;types&#34;: [&#34;Unauthorized&#34;, &#34;Security&#34;],
  &#34;cause&#34;: { ...recurse for nested any exceptions... }
}
</code></pre></div>
<p>The standard error format (with a nested cause) means that you can wrap and rethrow errors multiple layers deep:</p>
<div data-snippet-clipboard-copy-content="ServiceAlpha -&gt; ServiceBravo -&gt; ServiceCharlie -&gt; ServiceDelta"><pre><code>ServiceAlpha -&gt; ServiceBravo -&gt; ServiceCharlie -&gt; ServiceDelta
</code></pre></div>
<p>If ServiceDelta raises an error, ServiceAlpha can return (or log) the complete chain, including the root cause. This is <em>much</em> easier to debug than combing through the logs on four different systems - even with centralized logging.</p>
<h2 id="user-content-rule-11-do-provide-idempotence-mechanisms"><a href="#rule-11-do-provide-idempotence-mechanisms">Rule #11: DO provide idempotence mechanisms<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p>My company&#39;s software routes orders to a dozen different print companies that print and ship physical goods. I&#39;ve had this exact conversation, word-for-word, with different tech teams:</p>
<blockquote>
<p>Jeff: How can I ensure that I don&#39;t submit duplicate orders?</p>
<p>Print company: Can&#39;t you just only submit the order once?</p>
</blockquote>
<p>Sigh. No, I&#39;m afraid I cannot. The quick example I always send back is this one:</p>
<ol>
<li>I submit the order</li>
<li>The network fails and I get a timeout instead of 200 OK</li>
<li>I don&#39;t know if the order succeeded or failed</li>
</ol>
<p>But I need a more detailed answer that I can point people at, so here it goes. If you work for a print company and I sent you here, please don&#39;t take it personally! You are not alone.</p>
<h3 id="user-content-a-brief-primer-on-idempotence"><a href="#a-brief-primer-on-idempotence">A Brief Primer On Idempotence<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p><strong>Idempotence</strong> is the property of an operation such that if you execute it more than once, it doesn&#39;t change the result. You already expect <code>GET</code>, <code>PUT</code>, and <code>DELETE</code> operations to be idempotent:</p>
<div data-snippet-clipboard-copy-content="# GET doesn&#39;t change anything on the server
GET /orders/ORD123

# If you call PUT on the same order more than once, the zip stays the same
PUT /orders/ORD123/address
{&#34;zip&#34;: &#34;91202&#34;} 

# If you call DELETE multiple times, the order stays deleted
DELETE /orders/ORD123"><pre><code># GET doesn&#39;t change anything on the server
GET /orders/ORD123

# If you call PUT on the same order more than once, the zip stays the same
PUT /orders/ORD123/address
{&#34;zip&#34;: &#34;91202&#34;} 

# If you call DELETE multiple times, the order stays deleted
DELETE /orders/ORD123
</code></pre></div>
<p>Create operations, usually associated with <code>POST</code>, are different. Without special handling, they are <em>not</em> idempotent.</p>
<div data-snippet-clipboard-copy-content="# Every time you call this, we create a new order
POST /orders
{&#34;product&#34;: &#34;frisbee&#34;, &#34;address&#34;: {...etc...}}"><pre><code># Every time you call this, we create a new order
POST /orders
{&#34;product&#34;: &#34;frisbee&#34;, &#34;address&#34;: {...etc...}}
</code></pre></div>
<p>Because the network is not reliable, we suffer from the <a href="https://en.wikipedia.org/wiki/Two_Generals%27_Problem" rel="nofollow">Two General&#39;s Problem</a>. If an error occurs, there&#39;s no way for the client to know whether or not the operation successfully completed on the server. If the client submits the order again, we may create duplicate orders (&#34;at-least-once&#34;). If the client does not re-submit the order, we may lose orders (&#34;at-most-once&#34;).</p>
<p>To get exactly-once behavior for non-idempotent operations, we need additional coordination between the client and server. There are generally two good ways and one crappy way to support this.</p>
<h4 id="user-content-good-option-an-idempotency-key-or-client-reference-id"><a href="#good-option-an-idempotency-key-or-client-reference-id">Good option: An &#34;idempotency key&#34; or &#34;client reference ID&#34;<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h4>
<p>Let the client submit a unique value with the POST, and enforce uniqueness of this value on the server. <a href="https://stripe.com/docs/api/idempotent_requests" rel="nofollow">Stripe</a> works this way, using a header. They store the idempotency key for 24 hours, giving you 24 hours of protection against duplication:</p>
<div data-snippet-clipboard-copy-content="POST /v1/customers
Idemptency-Key: blahblahblahblah
{&#34;name&#34;:&#34;Bob Dobbs&#34;}"><pre><code>POST /v1/customers
Idemptency-Key: blahblahblahblah
{&#34;name&#34;:&#34;Bob Dobbs&#34;}
</code></pre></div>
<p>Similarly, many order processing systems allow clients to submit a &#34;customer reference ID&#34; which is persisted with each order and included in customer reports. Enforcing uniqueness of this value protects against duplicate orders in perpetuity.</p>
<p>Make sure the key/id is a string - see Rule #6.</p>
<h4 id="user-content-good-option-let-the-client-pick-ids"><a href="#good-option-let-the-client-pick-ids">Good option: Let the client pick IDs<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h4>
<p>If the client needs to pick a unique idempotency key for each submission, why not just make that the ID?</p>
<div data-snippet-clipboard-copy-content="# Client picks the id
POST /things
{&#34;id&#34;: &#34;mything1&#34;}

# The id can now be used
GET /things/mything1"><pre><code># Client picks the id
POST /things
{&#34;id&#34;: &#34;mything1&#34;}

# The id can now be used
GET /things/mything1
</code></pre></div>
<p>This can result in simple, ergonomic APIs - though it adds implementation complexity in multitenant systems (where the ID must be uniqued to each tenant).</p>
<h4 id="user-content-crappy-option-provide-an-endpoint-to-list-recent-transactions"><a href="#crappy-option-provide-an-endpoint-to-list-recent-transactions">Crappy option: Provide an endpoint to list recent transactions<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h4>
<p>This is a workaround for client developers if the API doesn&#39;t offer any explicit help with idempotence:</p>
<ol>
<li>Before <em>every</em> submission, fetch a list of recent transactions from the server.</li>
<li>Look for an existing transaction that matches your intended submission (hopefully you have a client reference ID to match).</li>
</ol>
<p>For this to work, the client must serialize all create operations - otherwise there is a race condition. It&#39;s slow, and maintaining an N hour safety window means fetching N hours of transactions - potentially prohibitive on a busy system. But if you&#39;re building a client and the API doesn&#39;t provide another idempotence mechanism, this is what you have to do.</p>
<h3 id="user-content-when-a-conflict-occurs"><a href="#when-a-conflict-occurs">When a conflict occurs...<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p>Now that your API offers a (good) idempotence mechanism, there&#39;s one more major consideration: How do you inform the client that there&#39;s a conflict? There are two main schools of thought:</p>
<h4 id="user-content-return-an-error"><a href="#return-an-error">Return an error<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h4>
<p>When a client submits a duplicate idempotency key, I like to return 409 CONFLICT. There is one trick here - unless you&#39;re using user-submitted IDs (&#34;Let the client pick IDs&#34;), you need to include the existing ID in the error message or otherwise provide a mechanism to lookup the ID by idempotency key.</p>
<div data-snippet-clipboard-copy-content="POST /things
{&#34;idempotency_key&#34;: &#34;blahblahblah&#34;, ...etc...}

# Response 409 CONFLICT
{&#34;message&#34;: &#34;This is a duplicate&#34;, old_id&#34;: &#34;THG1234&#34;}"><pre><code>POST /things
{&#34;idempotency_key&#34;: &#34;blahblahblah&#34;, ...etc...}

# Response 409 CONFLICT
{&#34;message&#34;: &#34;This is a duplicate&#34;, old_id&#34;: &#34;THG1234&#34;}
</code></pre></div>
<p>When the client gets a 409 CONFLICT response, it says &#34;oh, already done&#34; and records the created ID. Just like it would have if the first POST returned without error.</p>
<h4 id="user-content-return-the-earlier-response"><a href="#return-the-earlier-response">Return the earlier response<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h4>
<p>Instead of returning an error to the client, give them back the exact response that the client should have gotten the first time.</p>
<p>This allows clients to be a little dumber since they don&#39;t have to explicitly code up a CONFLICT error handler. However, it significantly complicates server implementation: You need to store all responses for a period of time and you need to validate that the client sent the exact same parameters with each request.</p>
<p>Stripe chose this route. I personally never have; it&#39;s a <em>lot</em> of sever work for just a little client convenience.</p>
<h2 id="user-content-tldr"><a href="#tldr">TL;DR<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p>There are a few ways of enabling idempotent behavior for non-idempotent operations. As long as you pick <em>something</em>, your clients will be happy. If you don&#39;t want to think about it too hard, go with this solution:</p>
<ul>
<li>Have the client submit an idempotency key (aka &#34;customer reference ID&#34;) with each POST/create operation</li>
<li>Store it in the database with a unique constraint</li>
<li>Return 409 CONFLICT when you violate the unique constraint</li>
<li>Provide the original ID in the 409 response body</li>
</ul>

<p>I hope this document will help your team make better REST APIs, and in turn make client developers all over the world happier.</p>
<p>What rules am I missing? Let me know on <a href="https://news.ycombinator.com/item?id=38103310" rel="nofollow">Hacker News</a>.</p>

              </div>

          </div>
</div></div>
  </body>
</html>
