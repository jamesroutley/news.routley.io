<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://moerner.com/posts/impossible-day-inode-exhaustion/">Original</a>
    <h1>When Impossible Day Feels Impossible: /tmp Inode Exhaustion</h1>
    
    <div id="readability-page-1" class="page"><section><p>Impossible Stuff Day is a special sprint at the <a href="https://www.recurse.com/">Recurse Center</a> devoted to working beyond the edge of your abilities. I had an ambitious day planned around <a href="https://mirageos.org">MirageOS</a> microkernels, but I made one critical mistake: I did not test my OCaml development environment with MirageOS.</p>
<p>But that’s no problem: There’s a nice guide to <a href="https://mirage.io/docs/install">install MirageOS</a>, and it looks pretty simple. We can install MirageOS and confirm that the <a href="https://mirage.io/docs/hello-world">Hello World</a> tutorial works. However, it very much does not:</p>
<pre tabindex="0"><code>opam-monorepo: [ERROR] Can&#39;t find all required versions.
Selected: noop-unix.zdev ocaml-base-compiler&amp;noop-unix
- cmdliner-stdlib -&gt; (problem)
    No known implementations at all
(etc.)
</code></pre><p>That looks very bad! One thing that immediately came to mind is that most
documents for MirageOS cover OCaml 4.x, but I am on OCaml 5.x. Let’s try the
older version of OCaml first. Same error. Maybe there’s an issue with my whole
switch setup, so let’s try on a clean user with nothing but the default switch.</p>
<pre tabindex="0"><code>[ERROR] Failed to extract archive /home/user/.opam/repo/default.tar.gz: &#34;/usr/bin/tar xfz
        /home/user/.opam/repo/default.tar.gz -C /tmp/opam-47813-6b24e2&#34; exited with code 2.
        Run `opam update --repositories default` to fix the issue
</code></pre><p>That looks even worse! Somehow I can’t even install OCaml at all now. Error 2
is a fatal <code>tar</code> error. Let’s try what it recommends:</p>
<pre tabindex="0"><code>$ opam update --repositories default

&lt;&gt;&lt;&gt; Updating package repositories &gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;
[ERROR] Could not update repository &#34;default&#34;: /usr/bin/opam: &#34;mkdir&#34; failed on /tmp/opam-48052-192552: No space left
        on device
</code></pre><p>Here we go. However, I’m only using 75 MiB out of 1 GiB of space on <code>/tmp</code>.
State is hard, so let’s try one more time with a fresh install. This time,
<code>opam init</code> does install the compiler! But I still get the same <code>opam-monorepo</code>
error as before.</p>
<p>We’ve gotten one “good” error out of this process: The hint that <code>/tmp</code> is out
of space. All the other errors were unhelpful: MirageOS’s <code>make depends</code> gave a
generic error about no implementations found, which looks almost like a network
failure, and <code>tar</code> gave a generic fatal error. I don’t blame <code>tar</code>, it’s
operating under strong requirements for backwards compatibility and it’s not
easy to tweak error reporting. But <code>opam-monorepo</code> is probably failing to
propagate an underlying <code>opam</code> error here. Fortunately, the good error about
<code>/tmp</code> is all we need.</p>
<p>On Linux, there’s actually two ways to run out of “space”: You can run out of
blocks, and you can run out of inodes. Each file is associated with an
<a href="https://en.wikipedia.org/wiki/Inode">inode</a>, which stores relevant metadata
for the file. If we aren’t out of block space, we must be out of inodes:</p>
<pre tabindex="0"><code>$ df -i /tmp
Filesystem     Inodes IUsed IFree IUse% Mounted on
tmpfs           44492 44492     0  100% /tmp
</code></pre><p>That’s the problem! OCaml’s <code>opam</code> uses <code>/tmp</code> for a staging area when
performing various operations, and it was exhausting the number of inodes in
<code>/tmp</code>. Unfortunately, there seems to be highly non-deterministic behavior
lurking here: Some <code>opam</code> runs would exhaust the inodes, others would not. In
fact, I’ve probably run into this error before with <code>opam</code>, but it was always
fixed by cleaning up <code>/tmp</code> or rebooting. I only figured it out, and was forced
to fix it, when <code>opam-monorepo</code> gave me mysterious but reproducible errors.</p>
<p>Now that we know the cause, how can we fix it? There’s another little rabbit
hole here which I will skim over: <code>/tmp</code> is stored in RAM. Back in the day I
remember manually setting this up in <code>/etc/fstab</code>, but there’s no <code>fstab</code> entry
here. (Does anyone else pronounce “fstab” as “f-stab”, or is that just me?)
Sounds like <code>systemd</code> shenanigans, and in fact it is.</p>
<p>The root cause is (in my opinion) a bug in my Linux distribution. In the
process of overriding the <code>systemd</code> config file for mounting <code>/tmp</code> to increase
the memory allocation, they forgot to also increase the inode allocation. This
resulted in the (as far as I can see undocumented) default of 44492 inodes,
which is way too low. Problem fixed locally, and a pull request submitted
upstream: <a href="https://github.com/QubesOS/qubes-core-agent-linux/pull/535">https://github.com/QubesOS/qubes-core-agent-linux/pull/535</a></p>
<p>As far as the rest of Impossible Day: After spending far too much time
debugging this, I didn’t get nearly as far as I hoped. Things seem a lot
simpler when writing them out in a blog post than when trying to debug them
live. I only had time to play around with using <code>Lwt</code> in MirageOS for async
promises. But it was a good experience, and I’m not yet ready to give up on my
broader ambitions yet.</p>
<p>In unrelated news, this blog is now hosted on a different VPS, since my $1/year
deal on <a href="https://hosting.gullo.me">Gullo</a> from last Black Friday has expired.
I’ll be keeping an eye out for new extremely cheap options over the next week.</p>
</section></div>
  </body>
</html>
