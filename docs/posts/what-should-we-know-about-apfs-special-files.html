<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://eclecticlight.co/2024/01/03/what-should-we-know-about-apfs-special-files/">Original</a>
    <h1>What should we know about APFS special files?</h1>
    
    <div id="readability-page-1" class="page"><article id="post-77569">
	
	<!-- .entry-header -->

	
		<div data-first_letter="W">
		<p>We may have been using APFS for nearly seven years, but some of its features remain thoroughly opaque. On Christmas Day, I posed <a href="https://eclecticlight.co/2023/12/25/where-are-the-sanity-checks/">the puzzle</a> of 60 TB of snapshots being removed from a 2 TB disk. While we all accept that may be “technically correct”, for ordinary users it makes no sense. Suggestions that they should be “educated” miss the point that the Finder has to be accessible to all users, whether or not they have a degree in Computer Science. If my eleven year-old granddaughter can’t make sense of it, then the Finder is a failure.</p>
<p>Today I turn to another thorny issue raised by the ingenuity of APFS: the size of its special file types, sparse and ‘clone’ files. As usual, I start with a practical demonstration.</p>
<h4>Demonstration</h4>
<p>If you’re using macOS virtual machines (VMs) on an Apple silicon Mac, one of their VMs is an excellent subject for this. If you don’t have one of those, then you can create a read-write disk image (UDRW) using Disk Utility. Ensure that it’s in APFS format, and make it nice and large, say 25 GB. Once it has been created and mounted, unmount it, mount it again, then unmount it, to ensure that it’s now become stored as a sparse file.</p>
<p>Select the VM or disk image, and use the Finder’s <strong>Get Info</strong> command to check its size.</p>
<p><span><img data-attachment-id="77555" data-permalink="https://eclecticlight.co/clonesparse1/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse1.png" data-orig-size="852,630" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="clonesparse1" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse1.png?w=300" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse1.png?w=852" src="https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse1.png?w=940" alt="clonesparse1" srcset="https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse1.png 852w, https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse1.png?w=150&amp;h=111 150w, https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse1.png?w=300&amp;h=222 300w, https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse1.png?w=768&amp;h=568 768w" sizes="(max-width: 852px) 100vw, 852px"/></span></p>
<p>In my case, I’ve used a 100 GB VM, whose size is given as 107 GB, although it only takes 18.47 GB on disk. Then, select the VM or disk image and press Command-D to duplicate it in the Finder. Select the duplicate, and <strong>Get Info</strong> on it.</p>
<p><span><img data-attachment-id="77556" data-permalink="https://eclecticlight.co/clonesparse2/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse2.png" data-orig-size="852,632" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="clonesparse2" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse2.png?w=300" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse2.png?w=852" src="https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse2.png?w=940" alt="clonesparse2" srcset="https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse2.png 852w, https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse2.png?w=150&amp;h=111 150w, https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse2.png?w=300&amp;h=223 300w, https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse2.png?w=768&amp;h=570 768w" sizes="(max-width: 852px) 100vw, 852px"/></span></p>
<p>That copy has the same size, and the same lesser space taken on disk, although the Finder duplicated it in the twinkling of an eye, which would only be possible if it had been ‘cloned’ rather than copied.</p>
<h4>Sparse files</h4>
<p>APFS is one of many file systems that can reduce the space taken to store some large files not by compression, but by storing only the data they need, as seen in this demonstration. Disk images, whether forming the greatest part of a VM, or as a separate file, start off as being almost entirely empty, and only grow as contents are added to them.</p>
<p>When macOS mounts a disk image, APFS performs a Trim on it, to gather all its free space together. When that image is saved, that free space isn’t written to the file, as it would just waste space. By writing that disk image in a special sparse file format, disk space required is reduced from slightly more than 100 GB to around 18 GB.</p>
<h4>Clone files</h4>
<p>Although known commonly as ‘clones’, these aren’t exact copies at all, but two separate files that, initially at least, share the same data on disk. When the Finder duplicates a file for you, APFS creates the file system metadata for that new file, giving it a new inode number, but the file’s data are initially stored in the same extents as the original. As those two files change, their unique data is written to new extents on disk, and they steadily drift apart until they become completely independent.</p>
<p>The only clue given here by the Finder that two VMs or disk images are clones and share data in this way are their names. Change the name of the copy and move it away, keeping it in the same volume, and you’d never know that its data were being shared with another file, nor the identity of the original.</p>
<h4>Recognising sparse and clone files</h4>
<p>Aside from the intentional discrepancy reported in <strong>Get Info</strong> for sparse files, telling which are sparse and which are clones isn’t possible in the macOS GUI. To understand more, I’ll use my free utility <a href="https://eclecticlight.co/taccy-signet-precize-alifix-utiutility-alisma/">Precize</a>, which reports more information culled from corners of the file system.</p>
<p><span><img data-attachment-id="77557" data-permalink="https://eclecticlight.co/clonesparse3/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse3.png" data-orig-size="1046,728" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="clonesparse3" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse3.png?w=300" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse3.png?w=940" src="https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse3.png?w=940" alt="clonesparse3" srcset="https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse3.png 1046w, https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse3.png?w=150&amp;h=104 150w, https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse3.png?w=300&amp;h=209 300w, https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse3.png?w=768&amp;h=535 768w, https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse3.png?w=1024&amp;h=713 1024w" sizes="(max-width: 1046px) 100vw, 1046px"/></span></p>
<p>The original disk image inside the VM has an inode number of 22513585, given in its volfs and FileRefURL paths at the top, a Disk size considerably smaller than its total file size, and ticks both the Sparse and Clone checkboxes at the foot.</p>
<p><span><img data-attachment-id="77558" data-permalink="https://eclecticlight.co/clonesparse4/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse4.png" data-orig-size="1112,728" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="clonesparse4" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse4.png?w=300" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse4.png?w=940" loading="lazy" src="https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse4.png?w=940" alt="clonesparse4" srcset="https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse4.png 1112w, https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse4.png?w=150&amp;h=98 150w, https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse4.png?w=300&amp;h=196 300w, https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse4.png?w=768&amp;h=503 768w, https://eclecticlightdotcom.files.wordpress.com/2024/01/clonesparse4.png?w=1024&amp;h=670 1024w" sizes="(max-width: 1112px) 100vw, 1112px"/></span></p>
<p>The duplicated disk image has a different inode number of 24847441, identical sizes, and the same two checkboxes ticked. To the left of those checkboxes, the Ref count on each copy is 1, confirming that neither is hard-linked. Even here, using as much information as I can glean from APFS, there’s no way to tell which file has been cloned from which.</p>
<h4>Effect on disk space</h4>
<p>Although the only mention in the macOS GUI is in the context of space taken on disk as sparse files, this could mislead the user into thinking that a VM or disk image that only takes 18.47 GB on disk can be copied to disk with a capacity of 25 GB, for instance. This is easy to test using another disk image: create another read-write disk image with APFS as its file system, of a size sufficient to accommodate that given ‘on disk’ but too small for its full size. Try copying the original VM or disk image to it, and the Finder will refuse on the grounds that it’s too large for that disk.</p>
<p>However, if you copy the VM or disk image to an APFS volume that does have sufficient free space to accommodate its full size, the space used according to Disk Utility and the Finder is considerably less than that size, although significantly larger than it takes on its original volume. In my case, for a VM originally taking 18 GB on disk, when copied to another APFS volume it used 25 GB.</p>
<p>If you try that out, watch the progress dialog carefully during copying. It starts by claiming that it has the full size (100+ GB) to copy, and proceeds as if that were the case. Then, as soon as the progress bar reaches the size actually taken on disk, in this case only a quarter of the way through, copying completes almost instantly. Maybe the Finder was more surprised at that than the user.</p>
<p>While APFS preserves sparse files when copying them to another APFS volume, that doesn’t work for other file systems such as HFS+, where the source file has to be fully expanded as it’s being copied, requiring additional time as well as the full disk space. None of this works for clone files, which can only remain cloned within the same APFS volume, of course.</p>
<h4>The benefits of sparse and clone files</h4>
<p>In terms of disk space used, the benefits of sparse and clone files aren’t as obvious as you might like. Because of their potential to swell to full size, sparse files can’t be copied to a volume that isn’t large enough to cope with that, but once they have been copied they only require their current size on disk. In that sense, telling the user in the <strong>Get Info</strong> dialog that a sparse file only occupies a small amount of disk space can build unrealistic expectations, although currently it’s the only means in macOS for the user to discover that file is stored in sparse format.</p>
<p>As far as the user is concerned, the greatest benefits come in speed of handling, and effects on SSD ‘wear’. Creating clone files is almost instant, even if they’re huge, and because of their efficiency in the use of storage extents they minimise erase-write cycles on SSD storage. Not informing the user that two files are clones of one another also avoids potential confusion that could arise if they were to think that clones behaved like hard-linked files, in that changing one of a pair of clones doesn’t change the content of the other.</p>
<h4>User information</h4>
<p>Sparse and clone files are essentially omitted from user documentation of macOS. One place I had expected Apple to provide information about the storage of disk images in sparse file format was in <a href="https://support.apple.com/en-gb/guide/disk-utility/dskutl11888/mac" target="_blank" rel="noopener">its explanation</a> of different types of disk image and their creation. Although sparse bundles and sparse disk images are described as being “an expandable file that shrinks and grows as needed”, there’s no mention of flexibility of size for read/write disk images now that they’re stored as sparse files. Man <code>hdiutil</code> seems similarly unaware of this change that dates back to Monterey.</p>
<h4>A little knowledge</h4>
<p>The problem for users with sparse and clone files, like so many of the advanced features of APFS, is that knowing just a little is dangerous. An obvious example is giving figures for space taken on disk in the Get Info dialog. Armed with that information, but without deeper understanding, a user might expect to be able to copy a sparse file of 18 GB size on disk, and a full size of 100 GB, to a volume that has only 20 GB available. Equally, they’d be surprised when that same sparse file was copied to an HFS+ volume and exploded to its full size, or it was copied over a network and took forever to transfer the full 100 GB.</p>
<p>These difficulties are no less for the Finder, as illustrated by the behaviour of its progress dialog when copying a sparse file to another volume. For plain files, the amount of data to be transferred is the regular file size. For a sparse file, that depends on whether the transfer mode and destination support its sparse format. Even then, the copied file may not be the same size as the source, as demonstrated above.</p>
<p>Magic works best when the spectator either knows nothing about the sleight of hand involved, or is another skilled magician.</p>
	</div><!-- .entry-content -->

	
	<!-- .entry-footer -->

</article></div>
  </body>
</html>
