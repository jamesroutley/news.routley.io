<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://beej.us/blog/data/mastodon-comments/">Original</a>
    <h1>Adding Mastodon Comments to Your Blog</h1>
    
    <div id="readability-page-1" class="page"><div id="mainbody">
<!-- end common pagetop -->
<!-- end common pre2 -->
<p>2025-02-21</p>

<p><img src="https://beej.us/blog/data/mastodon-comments/images/mastodon_logo_purple.svg" alt="Websockets Logo"/> Comments powered by Mastodon!</p>
<p>I hate ads. I also hate tracking and bloat. But I didn&#39;t actually hate
the latter quite enough to get rid of <a href="https://disqus.com/">Disqus</a> for
comments. It was a free, good service, and you could turn off ads for
the users (which I did).</p>
<p>But recently they sent out a mail saying they were not longer offering a
free ad-free option, and it&#39;s not worth paying for at my usage levels,
so they got the boot.</p>
<p>What to replace them with? The ultimate would be some kind of home-grown
thing, which I <em>could</em> do with the hosting I have. But it&#39;s more than I
want to take on right now.</p>
<p>So that leaves &#34;Comments in Mastodon&#34; as the winner. There&#39;s significant
overlap between Mastodon users and my meager collection of blog readers,
so that&#39;s not too bad.</p>
<p>The only thing that remains is either grabbing someone else&#39;s code to do
the work, or doing it myself. Doing it myself is more fun. Let&#39;s figure
it out!</p>
<p>I assumed correctly there was probably an API that would return JSON
data for public comments, and it seems like it should do so without any
login credentials.</p>
<p>First, get the JSON, then parse it down and convert it to HTML,
then embed that in the page. And style it all with CSS.</p>
<p>Oh, and make it work with my custom static site generator.</p>
<blockquote>
<p><img src="https://beej.us/blog/common/images/goat50.png" alt="Hint Goat"/>
Yes, this is going to be JavaScript-powered. I respect that some
people don&#39;t support JS, but since Mastodon requires it, we&#39;re going
to go with it. Also, it saves me from having a server-side component.</p>
<p>The only assurance I can give is that I don&#39;t use JS for tracking or
ads. So you should go ahead and whitelist my site. üòÅ</p>
</blockquote>
<p>The basic idea is that we&#39;re going to:</p>
<ol>
<li>Write a blog entry.</li>
<li>Post a link to that blog from our Mastodon account.</li>
<li>Link the blog entry back to our Mastodon post.</li>
<li>In the blog entry, show all the replies that have been made to that
Mastodon post.</li>
</ol>
<h2>Audience</h2>
<p>This assumes you know some basic JavaScript/HTML/CSS, e.g. finding DOM
elements, setting <code>innerHTML</code>, styling with CSS, using <code>&lt;script&gt;</code> tags,
etc.</p>
<p>I&#39;m going &#34;high-level overview&#34; here, not &#34;complete source code&#34;.</p>
<h2>Getting the Post ID</h2>
<p>When you make the announcement post to Mastodon, you need the ID of that
post so you can refer to it from your blog page.</p>
<p>The easiest way to get this is to go to your post on Mastodon, and look
at the URL.</p>
<pre><code>https://mastodon.sdf.org/@beejjorgensen/114011021587416866
</code></pre>
<p>That number at the end is your post ID. We&#39;ll need it for later.</p>
<h2>My Site Generator</h2>
<p>I could go off on a tangent here talking about how I think everyone
should write their own static site builder. Preferably in some
POSIX-compliant shell like Bash or Zsh. Because it&#39;s super portable,
fast as hell, already installed, and maximally removes dependencies.</p>
<p>But instead, I&#39;ll just cover the basics. This site is written in
Markdown (I&#39;m writing Markdown right now in this very sentence). And the
site builder converts that to HTML, sticks some common headers and
footers on there, and then, importantly, substitutes some text in the
result with other values.</p>
<p>But that last bit is how we&#39;re going to make a static page aware of the
Mastodon post ID we&#39;re going to be peeling comments off of.</p>
<p>For example, the post with the comments might have ID
<code>114011021587416866</code>. Somehow I need to embed that inside the HTML for
the page to be able to <code>fetch()</code> the data.</p>
<p>I do this by having a placeholder in the pre-built HTML that looks like
this:</p>
<pre><code>MASTODON_POST_ID
</code></pre>
<p>Any place that string appears in the HTML, I replace it with
<code>114011021587416866</code>. (Using <a href="https://en.wikipedia.org/wiki/Sed">sed</a>.)</p>
<p>And where do I get <code>114011021587416866</code>? It&#39;s in a file called <code>env.sh</code>
in the directory for this particular blog entry.</p>
<p>It has content in it like this, setting shell environment variables:</p>
<pre><code>MASTODON_POST_ID=114011021587416866
</code></pre>
<p>I source this into the site builder shell script before the build starts
so I can do the substitution.</p>
<p>If that environment variable isn&#39;t found, no comments section is emitted.</p>
<p>I use that ID a couple places in the code, so the site builder emits
some HTML for &#34;view&#34; and &#34;reply&#34; buttons that look like this (wrapped
for ease):</p>
<pre><code>&lt;a id=&#34;comments-view&#34;
    href=&#34;https://mastodon.sdf.org/@beejjorgensen/114011021587416866&#34;
    data-comments-id=&#34;114011021587416866&#34;&gt;View Comments&lt;/a&gt;
</code></pre>
<p>Note the post ID in the <code>href</code>, but I&#39;ve also added it to
<code>data-comments-id</code>, which means I can get it in JavaScript like this,
thanks to the whole
<a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/dataset">dataset</a>
field:</p>
<pre><code>const a_elem = document.querySelector(&#34;#comments-view&#34;);
const post_id = a_elem.dataset.commentsId;
</code></pre>
<p>However you do it, though, you somehow have to get the Mastodon post ID
into the page.</p>
<h2>What&#39;s the API?</h2>
<p>Now, on to business.</p>
<p>It&#39;s actually pretty simple to get a post and all its attached comments.
You&#39;re going to want to do this for the server you have an account on,
which in my case is <code>mastodon.sdf.org</code>. (<a href="https://sdf.org/">SDF</a> is a
venerable, classic public access Unix system.)</p>
<p>You just have to hit the API endpoint. Let&#39;s use the same post ID from
the previous section in this example. Here is the URL to get the
comments (with my example post ID):</p>
<pre><code>https://mastodon.sdf.org/api/v1/statuses/114011021587416866/context
</code></pre>
<p>That&#39;s it. You can <a href="https://mastodon.sdf.org/api/v1/statuses/114011021587416866/context">go hit it right
now</a>
in your browser and see the JSON output.</p>
<p>And there&#39;s a <em>lot</em> of it.</p>
<p>But for my bit, I only wanted a few pieces from the commenter so that I
could use them to build the comment HTML.</p>
<ol>
<li>Their display name</li>
<li>Their account name</li>
<li>Their avatar URL</li>
<li>Their profile URL</li>
<li>Their content (what they posted)</li>
<li>Their attachments (more on that later)</li>
<li>Their comment Mastodon ID (for blacklist reasons)</li>
</ol>
<p>If we look at the response we got, it has two keys: <code>ancestors</code> and
<code>descendants</code>. The descendants are what we&#39;re interested in, i.e. all
the comments made in reply to our post. And <code>descendants</code> is an array of
all those comments.</p>
<p>Let&#39;s look at those elements and find what&#39;s interesting. Say <code>d = descendants[i]</code>. Then, searching through the JSON, we have:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>d.account.display_name</code></td>
<td>Their display name</td>
</tr>
<tr>
<td><code>d.account.acct</code></td>
<td>Their account name</td>
</tr>
<tr>
<td><code>d.account.avatar_static</code></td>
<td>Their avatar URL</td>
</tr>
<tr>
<td><code>d.account.display_name</code></td>
<td>Their profile URL</td>
</tr>
<tr>
<td><code>d.content</code></td>
<td>Their content (what they posted)</td>
</tr>
<tr>
<td><code>d.media_attachments</code></td>
<td>Their attachments (an array)</td>
</tr>
<tr>
<td><code>d.id</code></td>
<td>Their comment Mastodon ID</td>
</tr>
</tbody>
</table>
<blockquote>
<p><img src="https://beej.us/blog/common/images/goat50.png" alt="Hint Goat"/>
There&#39;s both <code>avatar</code> and <code>avatar_static</code> in the response. The former
might be animated, and the latter is not. You could do something
interesting here like switch to the animated one on mouse-over, but I
didn&#39;t bother. I just always used the <code>_static</code> option for the various
images.</p>
</blockquote>
<p>So we have what we need, right there in each record.</p>
<h2>JavaScript at Last</h2>
<p>All we need to do is <code>fetch()</code> that information with our Mastodon post
ID that we baked into our static HTML. There are no credentials needed
to access public posts (so be sure to make your Mastodon post public).</p>
<p>But when should we fetch? Should we do it on page load? When the element
becomes visible? On a click?</p>
<p>If you have a high-traffic site, you might start raising the ire of your
Mastodon server admins if you repeatedly hit that URL. My site is
nowhere near those limits, so I <em>could</em> just load the comments after my
blog loads.</p>
<p>But I don&#39;t like extra overhead unless the user wants it, so instead I
hooked it up to a link. The comments will only appear on the page if the
user clicks the &#34;View Comments&#34; link.</p>
<p>A compromise might be to lazily load the comments when the user scrolls
down enough for them to be visible. But I just went for manual. (I drive
a <a href="https://en.wikipedia.org/wiki/Manual_transmission">stick</a>, too, BTW.)</p>
<p>In any case, we&#39;ll need a function to load the comments, and it&#39;ll look
like this:</p>
<pre><code>async load_comments(ev) {
    const post_id = MASTODON_POST_ID;

    // Change the URL to your server
    const url = `https://mastodon.sdf.org/api/v1/statuses/${post_id}/context`

    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`Response status: ${response.status}`);
        }

        const json = await response.json();

        populate_comments(json);

    } catch (error) {
        alert(`Error loading comments: ${error.message}`);
        console.error(error.message);
    }

}
</code></pre>
<p>It&#39;s an async function that uses the <code>fetch()</code> API to get the data for
my Mastodon post that corresponds to this blog entry.</p>
<p>Once it has loaded, we call <code>populate_comments()</code> with the JSON data to
actually build out the HTML. Let&#39;s talk about that next.</p>
<h2>Building the HTML</h2>
<p>This all depends on how you want your stuff to look at the end of the
day.</p>
<p>I wanted something that looked like what we have at the bottom of this
page, so I have some code that generates these. Here&#39;s what it looks
like (obviously with values substituted in where appropriate):</p>
<pre><code>&lt;div class=&#34;mast-comment&#34;&gt;
    &lt;div class=&#34;mast-comment-header&#34;&gt;
        &lt;div class=&#34;mast-comment-avatar&#34;&gt;
            &lt;a href=&#34;ACCOUNT_URL&#34;&gt;
                &lt;img src=&#34;ACCOUNT_AVATAR_URL&#34;&gt;
            &lt;/a&gt;
        &lt;/div&gt;
        &lt;div class=&#34;mast-comment-ident&#34;&gt;
            &lt;div class=&#34;mast-comment-acct&#34;&gt;
                &lt;a href=&#34;ACCOUNT_URL&#34;&gt;
                    ACCOUNT_NAME
                &lt;/a&gt;
            &lt;/div&gt;
            &lt;div class=&#34;mast-comment-display-name&#34;&gt;
                &lt;a href=&#34;ACCOUNT_URL&#34;&gt;
                    ACCOUNT_DISPLAY_NAME
                &lt;/a&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&#34;mast-comment-content&#34;&gt;
        COMMENT_CONTENT
    &lt;/div&gt;
    &lt;!-- attachment HTML goes here --&gt;
&lt;/div&gt;
</code></pre>
<p>Having it in that form allowed me to add some <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_flexible_box_layout/Basic_concepts_of_flexbox">flexbox
CSS</a>
to lay out the whole thing.</p>
<p>I basically just appended a bunch of those to a string and then dumped
it into the <code>innerHTML</code> of the comments block.</p>
<p>Note that the record <code>content</code> field is already HTML-encoded so there&#39;s
no need to do that again. (And if you do, you&#39;ll lose the comment
formatting and just display a bunch of HTML tags.)</p>
<h2>Media Attachments</h2>
<p>This was interesting. Users can attach things to their posts. And then
the question becomes what to do with them. The real Mastodon client will
display previews of the attachments that you can click on to get the
whole thing.</p>
<p>I&#39;m going simpler with my stuff. Basically I&#39;m just going to put a link
with a text description. I don&#39;t want the comments to be too polluted
with media.</p>
<p>We can find the media attachments in the <code>media_attachments</code> field,
which, if present, is an array.</p>
<p>I just needed a few pieces of information from each <code>media_attachments</code>
entry. Let&#39;s assume that <code>a = rec.media_attachments[i]</code>, and then we
have:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>a.type</code></td>
<td>The attachment type</td>
</tr>
<tr>
<td><code>a.url</code></td>
<td>The attachment location</td>
</tr>
<tr>
<td><code>a.description</code></td>
<td>The attachment text description</td>
</tr>
</tbody>
</table>
<p>The <a href="https://docs.joinmastodon.org/entities/MediaAttachment/#type">spec
says</a> the
<code>type</code> can be a few things:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>unknown</code></td>
<td>Unsupported or unrecognized file type</td>
</tr>
<tr>
<td><code>image</code></td>
<td>Static image</td>
</tr>
<tr>
<td><code>gifv</code></td>
<td>Looping, soundless animation</td>
</tr>
<tr>
<td><code>video</code></td>
<td>Video clip</td>
</tr>
<tr>
<td><code>audio</code></td>
<td>Audio track</td>
</tr>
</tbody>
</table>
<p>I used the <code>type</code> to choose an emoji icon that was appropriate (üñºÔ∏è üé¶ üé∂
üìé), then used the <code>description</code> for the text underlying a link to the
<code>url</code>. One per line. No preview. Kept it simple.</p>
<p>So I had <code>&lt;div&gt;</code> elements that I tucked into main comment <code>&lt;div&gt;</code> where
the &#34;attachment HTML goes here&#34; comment was, above.</p>
<pre><code>&lt;div class=&#34;mast-comment-attachment&#34;&gt;
    ICON_EMOJI&amp;nbsp;&lt;a href=&#34;URL&#34;&gt;DESCRIPTION&lt;/a&gt;
&lt;/div&gt;
</code></pre>
<h2>Replying</h2>
<p>100% punted on this. You click the &#34;reply&#34; button on my page and it
takes you straight to my blog post announcement on Mastodon. If you want
to reply, you need a Mastodon account and reply from there.</p>
<p>As such, the comments on my page are &#34;read only&#34;. They are just a view
onto the live comments that are on Mastodon.</p>
<h2>Blacklisting</h2>
<p>I wanted to be able to blacklist entire accounts (<code>@user@example.com</code>)
or individual comment IDs (the big number referencing that comment).</p>
<p>This wouldn&#39;t change what was actually on Mastodon, but it would filter
out comments I didn&#39;t want to see on my blog site.</p>
<p>Remember how I jammed the Mastodon announcement post ID into my static
HTML by putting it in the JavaScript variable <code>MASTODON_POST_ID</code>? Well,
I do a similar thing for the blacklist.</p>
<p>In my environment shell script, I include a blacklist like this:</p>
<pre><code>MASTODON_BLACKLIST=@user@example.com,123456789,345678912
</code></pre>
<p>The numbers can be either a post ID or an account ID.</p>
<p>And my processing scripts turn that into JavaScript that looks like
this:</p>
<pre><code>&lt;script&gt;MASTODON_BLACKLIST = new Set([
    &#34;@user@example.com&#34;,
    &#34;123456789&#34;,
    &#34;345678912&#34;
]);&lt;/script&gt;
</code></pre>
<p>And then I can pass an entire <code>descendants</code> record into this function
which will return <code>true</code> if it is blacklisted. It tests the comment
record ID, the poster account ID, and the poster account login to see if
any of them are in the blacklist. If so, no comment block is emitted for
that record.</p>
<pre><code>function blacklisted(rec)
{
    const bl = MASTODON_BLACKLIST;

    return bl.has(rec.id) ||
        bl.has(rec.account.id) ||
        bl.has(rec.account.acct);
}
</code></pre>
<h3>Getting the Comment ID</h3>
<p>If I see some offensive content, I can see who posted it because my
comments viewer shows their name. But my comments viewer does not show
their comment post ID.</p>
<p>And what if I want to block just that one post?</p>
<p>What I did was wire it up so that if I held <code>ALT</code> and clicked on the
comment, it would display the comment ID underneath the comment. (And
remove it if I clicked again.)</p>
<h3>Adding to the Blacklist</h3>
<p>If I want to block someone, I do the following.</p>
<ol>
<li>If I want to block their account, I add their account login to my
<code>MASTODON_BLACKLIST</code> environment variable. If I want to block just
that comment, I <code>ALT</code>-click on it to get the ID, and then add that ID
to the blacklist variable.</li>
<li>I rebuild the site. It&#39;s static, so I need to get the new blacklist
baked into the HTML. (I could also just rebuild this one page, but
since it takes 0.5 seconds to rebuild the entire site currently, I
just go for it.)</li>
<li>I deploy the site.</li>
</ol>
<h3>Global Blacklist</h3>
<p>Right now I&#39;m blacklisting people and comments on a per-blog-entry
basis. But I&#39;ll probably modify my site builder to also support a global
blacklist for people I want to ban on <strong>all</strong> my blog posts.</p>
<p>Hopefully I never have to do that.</p>
<h2>Chicken and Egg</h2>
<p>I have to put the blog post online so I can link to it from the Mastodon
announcement post.</p>
<p>I have to put the Mastodon announcement post online so I can refer to it
from the blog post.</p>
<p>So there&#39;s just a moment where the comments don&#39;t show. Reviewing the
launch process:</p>
<ol>
<li>Make the blog entry live with no comments.</li>
<li>Link to it from Mastodon in the announcement post.</li>
<li>Take the announcement post ID and use it to rebuild the blog entry.</li>
<li>Re-deploy the blog entry.</li>
</ol>
<p>Of course this could all be automated through the appropriate APIs to
minimize that window, but I&#39;m not going to bother for my low traffic.</p>
<h2>Maiden Voyage</h2>
<p>This is the first post where I&#39;m trying this out. So feel free to reply
and I&#39;ll find out where all the breakages are. üòÖ</p>
<!-- begin common pagebottom -->
<!-- begin comments -->
<!-- comment blacklist -->

<h2>Comments</h2>
<p><a id="comments-view" href="https://mastodon.sdf.org/@beejjorgensen/114055638347066398" data-comments-id="114055638347066398">View Comments</a>
<a id="comments-reply" href="https://mastodon.sdf.org/@beejjorgensen/114055638347066398">Reply</a></p>
<!-- end comments -->
</div></div>
  </body>
</html>
