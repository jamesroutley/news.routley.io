<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://simonschreibt.de/gat/deus-ex-alpha-terrain/">Original</a>
    <h1>Deus Ex – Alpha Terrain</h1>
    
    <div id="readability-page-1" class="page"><div>
			
<p>Three years ago, while playing <a rel="noreferrer noopener" href="https://store.steampowered.com/app/337000/Deus_Ex_Mankind_Divided/" data-type="URL" data-id="https://store.steampowered.com/app/337000/Deus_Ex_Mankind_Divided/" target="_blank">Deus Ex: Mankind Divided</a>, I noticed a nice little trick and <a rel="noreferrer noopener" href="https://twitter.com/simonschreibt/status/1344375160904810498?t=_zZwTW4fxDbHV_ULw8Arjg&amp;s=09" data-type="URL" data-id="https://twitter.com/simonschreibt/status/1344375160904810498?t=_zZwTW4fxDbHV_ULw8Arjg&amp;s=09" target="_blank">tweeted</a> about it – today is the day when I finally release it as an article. Do you guess, what’s this about?</p>





<p>Correct answer: The terrain blends nicely with the stone! Let me explain it in more detail: Usually when objects and terrain intersect with each-other, one can see a harsh intersection. In Deus Ex on the other hand, there’s a nice smooth transition between terrain and object:</p>







<p>Now, blending objects with the terrain is <strong>not</strong> a spectacular new idea. A list:</p>



<ul>
<li>I myself described a fun technique for trees in Torchlight <a href="http://simonschreibt.de/gat/world-of-torch-siege-blended-trunks/" data-type="URL" data-id="http://simonschreibt.de/gat/world-of-torch-siege-blended-trunks/" target="_blank" rel="noreferrer noopener">[Link]</a></li>



<li>There is an amazing technique to blend the colors and even normals of the terrain with the mesh (known from Battlefront 2) <a href="https://orikmcfly.artstation.com/projects/9zRna" data-type="URL" data-id="https://orikmcfly.artstation.com/projects/9zRna" target="_blank" rel="noreferrer noopener">[Link]</a></li>



<li><a rel="noreferrer noopener" href="https://forums.tigsource.com/index.php?topic=67068.0" target="_blank"></a>TigSource Thread about Terrain Blending in Zelda: BotW &amp; Farcry 5 <a href="https://forums.tigsource.com/index.php?topic=67068.0" data-type="URL" data-id="https://forums.tigsource.com/index.php?topic=67068.0" target="_blank" rel="noreferrer noopener">[Link]</a></li>



<li>Terrain blending with Unreal Realtime Virtual Texturing (RVT) <a href="https://www.youtube.com/watch?v=0-xXIMjlmqE" data-type="URL" data-id="https://www.youtube.com/watch?v=0-xXIMjlmqE" target="_blank" rel="noreferrer noopener">[Link]</a></li>



<li>There is this fun experiment to use Pixel Depth Offset &amp; Dithering to blend terrain and object <a href="https://www.youtube.com/watch?v=tyLSH5zF-rI" data-type="URL" data-id="https://www.youtube.com/watch?v=tyLSH5zF-rI" target="_blank" rel="noreferrer noopener">[Link]</a></li>
</ul>



<p>What I like about the Deus Ex approach: it’s a simple hack (and you know me, I LOVE tricks like that!). </p>



<figure><video autoplay="" controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2023/05/deusEx_01-4.mp4"></video><figcaption>Source: <a href="https://store.steampowered.com/agecheck/app/337000/" data-type="URL" data-id="https://store.steampowered.com/agecheck/app/337000/" target="_blank" rel="noreferrer noopener">Deus Ex: Mankind Divided</a></figcaption></figure>



<p>The terrain uses a <strong>translucent material</strong>!</p>



<p>Instead of doing a simple depth fade, <a rel="noreferrer noopener" href="https://forums.tigsource.com/index.php?topic=67068.msg1401676#msg1401676" data-type="URL" data-id="https://forums.tigsource.com/index.php?topic=67068.msg1401676#msg1401676" target="_blank">EmilMeiton describes an improved method</a>: <em>“using the depth buffer “raw” to blend my objects works, but the result is heavily dependent on the angle of the camera to the ground. […] I realized we could simply reverse this effect by calculating the tangent of the angle between the terrain normal and the view direction (camera vector) and use this to divide the earlier used distance (between terrain and object beneath). It’s not perfect but it’s way better than the result before,”</em></p>



<p>Allow me to say a few words why seeing a translucent material surprised me:</p>



<ol>
<li><strong>Overdraw</strong>. We always hear: Be careful with overdraw! Avoid huge particles!! It kills your performance!!!!111 So, seeing a terrain (which fills at least half the screen most of the time) using a translucent material seemed counterintuitive to me.<br/> </li>



<li><strong>Sorting</strong>. Translucent objects usually have sorting issues. In the video below, you can see those in the form of polygons being visible <strong>through</strong> other polygons in front:</li>
</ol>



<figure><video autoplay="" controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2023/05/demo_terrain_mountain-2.mp4"></video><figcaption>The usual sorting issues with overlapping translucent surfaces.</figcaption></figure>



<p>Note: Unreal just added <a rel="noreferrer noopener" href="https://youtu.be/o3CemUinXbw?t=849" target="_blank">Order Independent Translucency,</a> and this might be a game changer!</p>



<p>The reason why all of this was a surprise to me was, that usually terrain rendering works like shown below. </p>



<figure><video autoplay="" controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2023/05/gta5_renderOrder.mp4"></video><figcaption>Source: <a href="https://www.adriancourreges.com/blog/2015/11/02/gta-v-graphics-study/" data-type="URL" data-id="https://www.adriancourreges.com/blog/2015/11/02/gta-v-graphics-study/" target="_blank" rel="noreferrer noopener">GTA V Graphics Study by Adrian Courrèges</a></figcaption></figure>



<p>As you can see, the terrain is opaque and drawn <strong>very early</strong>. This makes sense because now you don’t need to render anything which is hidden behind the already rendered pixels. Adrian send me another <a rel="noreferrer noopener" href="https://www.adriancourreges.com/blog/2017/12/15/mgs-v-graphics-study/?s=09#depth-pre-pass" data-type="URL" data-id="https://www.adriancourreges.com/blog/2017/12/15/mgs-v-graphics-study/?s=09#depth-pre-pass" target="_blank">example of Metal Gear Solid V</a> where they render the terrain first to avoid rendering anything behind it – this advantage would be lost in the case of Deus Ex where the terrain is rendered last.<br/></p>



<p>When I saw the Deus Ex approach the first time, I asked on Twitter and Ben Golus answered and explained a bit <a rel="noreferrer noopener" href="https://twitter.com/bgolus/status/1344378238483632128?t=k0c3UnhksAS5c79RCUQntw&amp;s=09" target="_blank">here</a> and <a rel="noreferrer noopener" href="https://twitter.com/bgolus/status/1344385739098734595?t=Ii_N0YZCrmwsvDe5DOkW_w&amp;s=09" target="_blank">here</a> (just in case you want more details).</p>



<p>Let’s now take a look at the mentioned problems (overdraw &amp; sorting):</p>







<p>Here’s my guess why overdraw is <strong>not</strong> a huge problem in this case:</p>



<p>It’s only <strong>one</strong> layer. Usually when artists get warned about overdraw, it’s to avoid that too many translucent layers overlap each other so that 1 pixel is touched 50x during rendering because 50 particles cover its area.</p>



<p>It helps, that the terrain is very <strong>flat</strong> so that we never see it overlapping itself (something like my sorting-example from above, where the hills overlap each other, never occurs in Deus Ex):</p>



<figure><video autoplay="" controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2023/05/deusEx_prison_01.mp4"></video><figcaption>Source: <a rel="noreferrer noopener" href="https://store.steampowered.com/agecheck/app/337000/" data-type="URL" data-id="https://store.steampowered.com/agecheck/app/337000/" target="_blank">Deus Ex: Mankind Divided</a></figcaption></figure>







<p>Just one sentence above I wrote, that the sorting in Deus Ex should not be a problem because of the flatness of the terrain. Still, I’d like to show you the rendering process in Deus Ex and show an example how potential sorting issues could be solved (e.g. if the terrain has overlapping hills).</p>



<p>Like usually in real-time rendering, all opaque objects come first. Usually the terrain is part of that (see GTA V example above), but not so much in Deus Ex! There are some patches of orange sand, but those will be occluded soon:</p>







<p>Now, the terrain is drawn on top. It has a translucent material which allows for the smooth blend with the opaque geometry. Note that it also gets rendered into the depth buffer! <strong>This is special!</strong> Usually this is <strong>not</strong> the case for translucent objects (<a rel="noreferrer noopener" href="https://research.ncl.ac.uk/game/mastersdegree/graphicsforgames/transparencyanddepth/Tutorial%204%20-%20Transparency%20and%20Depth.pdf" data-type="URL" data-id="https://research.ncl.ac.uk/game/mastersdegree/graphicsforgames/transparencyanddepth/Tutorial%204%20-%20Transparency%20and%20Depth.pdf" target="_blank">more details here</a>) but here it’s OK because we know, that nothing needs to be rendered behind the terrain pixels.</p>



<div>
<p>
<figure><video autoplay="" controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2023/05/deusEx_frame_02-03_terrain.mp4"></video><figcaption>Step 2: Translucent Terrain</figcaption></figure>
</p>



<p>
<figure><video autoplay="" controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2023/05/deusEx_frame_02-03_terrain_depth.mp4"></video><figcaption>Step 2: Translucent Terrain</figcaption></figure>
</p>
</div>



<p>The next steps would be shadows, lighting, other translucent elements like particles and of course the UI. But those things are not interesting for us right now.</p>



<p>I’d like to emphasize how important it is, that the (translucent) terrain gets written into the depth buffer because it serves two purposes:</p>



<p>1. <strong>Avoiding sorting issues</strong>. By comparing newly drawn pixels to the already existing depth information, we can discard those pixels, which are behind already rendered ones:</p>



<div>
<p>
<figure><video autoplay="" controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2023/05/demo_terrain_mountain-2.mp4"></video><figcaption>The usual sorting issues with overlapping translucent surfaces.</figcaption></figure>
</p>



<p>
<figure><video autoplay="" controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2023/05/demo_terrain_mountain_fixedSorting-2.mp4"></video><figcaption>No sorting issues by discarding pixels which are behind other surfaces.</figcaption></figure>
</p>
</div>



<p>I made a <a href="https://youtu.be/1YJP55GYFoo" data-type="URL" data-id="https://youtu.be/1YJP55GYFoo" target="_blank" rel="noreferrer noopener">tutorial how to set up the example above to avoid sorting issues</a>.</p>



<p>As mentioned before: My example  is very mountainous, but the terrain in Deus Ex is quite <strong>flat!</strong> So in theory, in this specific case, rendering the (translucent) terrain into the depth buffer would not have been necessary since there are no sorting issues to be expected. <strong>But</strong> we can use the depth information for something else:</p>



<p>2. <strong>Depth Fade for particles</strong>. In the example below, you can see, typical sorting issues (left), a “fix” by forcing the particle to be drawn on top (center) and the nicest way of having the particle “reacting” to the terrain by doing a nice depth fade (right):</p>



<figure><video autoplay="" controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2023/05/demo_particle_01-1.mp4"></video></figure>



<p>Again: Doing such a depth fade is very normal when we’re talking about a particle being close to an <strong>opaque</strong> object because they always render into the depth buffer while <strong>translucent </strong>object like our terrain usually do not!</p>


<div>
<figure><a href="https://simonschreibt.de/wp-content/uploads/2023/05/material_particle_customDepthFade.png"><img decoding="async" loading="lazy" src="https://simonschreibt.de/wp-content/uploads/2023/05/material_particle_customDepthFade-1024x663.png" alt="" width="256" height="166" srcset="https://simonschreibt.de/wp-content/uploads/2023/05/material_particle_customDepthFade-1024x663.png 1024w, https://simonschreibt.de/wp-content/uploads/2023/05/material_particle_customDepthFade-300x194.png 300w, https://simonschreibt.de/wp-content/uploads/2023/05/material_particle_customDepthFade-768x498.png 768w, https://simonschreibt.de/wp-content/uploads/2023/05/material_particle_customDepthFade-624x404.png 624w, https://simonschreibt.de/wp-content/uploads/2023/05/material_particle_customDepthFade.png 1295w" sizes="(max-width: 256px) 100vw, 256px"/></a><figcaption>My material using customDepth for the depth fade.</figcaption></figure></div>


<p>And here you can see it in action in the game. The dust effect has a soft transition with the terrain:</p>



<figure><video autoplay="" controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2023/05/deusEx_particle_01.mp4"></video><figcaption>Source: <a rel="noreferrer noopener" href="https://store.steampowered.com/agecheck/app/337000/" data-type="URL" data-id="https://store.steampowered.com/agecheck/app/337000/" target="_blank">Deus Ex: Mankind Divided</a></figcaption></figure>







<p>Zelda: BotW uses a similar technique, and here is a <a rel="noreferrer noopener" href="https://forum.unity.com/threads/solved-zelda-botw-terrain-intersection-blending.756209/" data-type="URL" data-id="https://forum.unity.com/threads/solved-zelda-botw-terrain-intersection-blending.756209/" target="_blank">thread where flogelz re-creates the terrain blending</a>. They don’t use a translucent material for the terrain but blend everything in the GBuffer, but the render order is the same: First everything else, then the terrain.</p>











<p>Deus Ex uses a nice hack to blend terrain and objects. Three things are special about its terrain rendering:</p>



<ol>
<li>The terrain renders <strong>after</strong> all opaque objects</li>



<li>The terrain uses a <strong>translucent</strong> material</li>



<li>The terrain renders into the depth buffer (usually only opaque objects do)</li>
</ol>



<p>These things are done to:</p>



<ol>
<li>Avoid sorting issues</li>



<li>Blend terrain softly with objects</li>



<li>Blend other translucent elements like particles softly with the (translucent) terrain</li>
</ol>



<p>Resulting problems could be:</p>



<ol>
<li>Potentially waste of rendering opaque objects because they’re completely occluded by the terrain (not the case in Deus Ex)</li>



<li>When looking closely, the hack is quite visible since it depends on the angle between of camera and terrain</li>
</ol>




					</div></div>
  </body>
</html>
