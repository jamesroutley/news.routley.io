<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tech.marksblogg.com/ornl-fema-buildings.html">Original</a>
    <h1>131M American Buildings</h1>
    
    <div id="readability-page-1" class="page"><div id="article_text">
            <p>In May, Nature published an <a href="https://www.nature.com/articles/s41597-024-03219-x">article</a> detailing Oak Ridge National Laboratory&#39;s (ORNL) new, AI-generated US Building Dataset.</p>
<p>ORNL developed a convolutional neural network (CNN) that extracted vector-building footprints from Maxar&#39;s WorldView-02, WorldView-03, QuickBird, GeoEye-1 satellite imagery as well as the National Agriculture Imagery Program&#39;s (NAIP).</p>
<p>Google and Microsoft have both already published building datasets that were produced from satellite imagery but ORNL&#39;s focused on adding much more metadata around the address and use of each building. Lightbox, OpenStreetMap (OSM) and several US government agencies supplied data to help enrich this dataset.</p>
<p>Compared to anything I&#39;ve seen from Microsoft and Google, this dataset appears to have much more accurate building footprints to the point I initially thought they were manually surveyed.</p>
<p>In this post, I&#39;ll walk through downloading and analysing ORNL&#39;s 131M US Building Dataset.</p>
<div id="my-workstation">
<h2>My Workstation</h2>
<p>I&#39;m using a 6 GHz Intel Core <a href="https://www.intel.com/content/www/us/en/products/sku/236773/intel-core-i9-processor-14900k-36m-cache-up-to-6-00-ghz/specifications.html">i9-14900K</a> CPU. It has 8 performance cores and 16 efficiency cores with a total of 32 threads and 32 MB of L2 cache. It has a liquid cooler attached and is housed in a spacious, full-sized, Cooler Master HAF 700 computer case. I&#39;ve come across videos on YouTube where people have managed to overclock the i9-14900KF to <a href="https://www.youtube.com/watch?v=fb7pl7PZOYo">9.1 GHz</a>.</p>
<p>The system has 96 GB of DDR5 RAM clocked at 6,000 MT/s and a 5th-generation, Crucial T700 4 TB NVMe M.2 SSD which can read at speeds up to 12,400 MB/s. There is a heatsink on the SSD to help keep its temperature down. This is my system&#39;s C drive.</p>
<p>The system is powered by a 1,200-watt, fully modular, Corsair Power Supply and is sat on an ASRock Z790 Pro RS Motherboard.</p>
<p>I&#39;m running Ubuntu 22 LTS via Microsoft&#39;s Ubuntu for Windows on Windows 11 Pro. In case you&#39;re wondering why I don&#39;t run a Linux-based desktop as my primary work environment, I&#39;m still using an Nvidia GTX 1080 GPU which has better driver support on Windows and I use ArcGIS Pro from time to time which only supports Windows natively.</p>
</div>
<div id="installing-prerequisites">
<h2>Installing Prerequisites</h2>
<p>I&#39;ll use Python and a few other tools to help analyse the data in this post.</p>
<div><pre><span></span>$<span> </span>sudo<span> </span>apt<span> </span>update
$<span> </span>sudo<span> </span>apt<span> </span>install<span> </span><span>\</span>
<span>    </span>jq<span> </span><span>\</span>
<span>    </span>python3-pip<span> </span><span>\</span>
<span>    </span>python3-virtualenv
</pre></div>
<p>I&#39;ll set up a Python Virtual Environment and install some dependencies.</p>
<div><pre><span></span>$<span> </span>virtualenv<span> </span>~/.ornl
$<span> </span><span>source</span><span> </span>~/.ornl/bin/activate

$<span> </span>pip<span> </span>install<span> </span><span>\</span>
<span>    </span>xmljson
</pre></div>
<p>I&#39;ve been working on a <a href="https://github.com/marklit/pqview">Parquet debugging tool</a>. I&#39;ll use it to examine the results of Parquet compression in this post.</p>
<div><pre><span></span>$<span> </span>git<span> </span>clone<span> </span>https://github.com/marklit/pqview<span> </span><span>\</span>
<span>    </span>~/pqview
$<span> </span>python3<span> </span>-m<span> </span>pip<span> </span>install<span> </span><span>\</span>
<span>          </span>-r<span> </span>~/pqview/requirements.txt
</pre></div>
<p>I&#39;ll use DuckDB, along with its <a href="https://github.com/isaacbrodsky/h3-duckdb">H3</a>, <a href="https://duckdb.org/docs/extensions/json">JSON</a>, <a href="https://community-extensions.duckdb.org/extensions/lindel.html">Lindel</a>, <a href="https://duckdb.org/docs/data/parquet/overview">Parquet</a> and <a href="https://duckdb.org/docs/extensions/spatial.html">Spatial</a> extensions, in this post.</p>
<div><pre><span></span>$<span> </span><span>cd</span><span> </span>~
$<span> </span>wget<span> </span>-c<span> </span>https://github.com/duckdb/duckdb/releases/download/v1.1.1/duckdb_cli-linux-amd64.zip
$<span> </span>unzip<span> </span>-j<span> </span>duckdb_cli-linux-amd64.zip
$<span> </span>chmod<span> </span>+x<span> </span>duckdb
$<span> </span>~/duckdb
</pre></div>
<div><pre><span></span><span>INSTALL</span><span> </span><span>h3</span><span> </span><span>FROM</span><span> </span><span>community</span><span>;</span>
<span>INSTALL</span><span> </span><span>lindel</span><span> </span><span>FROM</span><span> </span><span>community</span><span>;</span>
<span>INSTALL</span><span> </span><span>json</span><span>;</span>
<span>INSTALL</span><span> </span><span>parquet</span><span>;</span>
<span>INSTALL</span><span> </span><span>spatial</span><span>;</span>
</pre></div>
<p>I&#39;ll set up DuckDB to load every installed extension each time it launches.</p>

<div><pre><span></span>.timer on
.width 180
LOAD h3;
LOAD lindel;
LOAD json;
LOAD parquet;
LOAD spatial;
</pre></div>
<p>The maps in this post were rendered with <a href="https://www.qgis.org/en/site/forusers/download.html">QGIS</a> version 3.38.0. QGIS is a desktop application that runs on Windows, macOS and Linux. The application has grown in popularity in recent years and has ~15M application launches from users all around the world each month.</p>
<p>I used QGIS&#39; <a href="https://geoinformaticsworld.com/how-to-download-and-install-google-earth-images-in-qgis-using-tiles-plugin/">Tile+ plugin</a> to add geospatial context with NASA&#39;s Blue Marble and Esri&#39;s World Imagery Basemaps to the maps. Esri&#39;s imagery has been tinted red and darkened to help contrast against overlapping vector data.</p>
</div>
<div id="downloading-ornl-s-buildings-dataset">
<h2>Downloading ORNL&#39;s Buildings Dataset</h2>
<p>The following will download 56 ZIP files with a footprint of 42 GB.</p>
<div><pre><span></span>$<span> </span>mkdir<span> </span>-p<span> </span>~/ornl_buildings
$<span> </span><span>cd</span><span> </span>~/ornl_buildings

$<span> </span>curl<span> </span>-s<span> </span>https://disasters.geoplatform.gov/USA_Structures/<span> </span><span>\</span>
<span>    </span><span>|</span><span> </span>grep<span> </span>-o<span> </span><span>&#39;https.*zip&#39;</span><span> </span><span>\</span>
<span>    </span>&gt;<span> </span>urls.txt
$<span> </span>cat<span> </span>urls.txt<span> </span><span>|</span><span> </span>xargs<span> </span>-P4<span> </span>-I%<span> </span>wget<span> </span>-c<span> </span>%
</pre></div>
</div>
<div id="geodatabase-format">
<h2>Geodatabase Format</h2>
<p>The ZIP files contain Geodatabases for US States and territories. The largest <tt>gdbtable</tt> file within any one ZIP will contain the geometry and related metadata for that ZIP file&#39;s buildings.</p>
<div><pre><span></span>$<span> </span>unzip<span> </span>Deliverable20230630DE.zip
$<span> </span>find<span> </span>Deliverable20230630DE/DE_Structures.gdb/*.gdbtable
</pre></div>
<p>The last file is the one with the data.</p>
<div><pre><span></span>Deliverable20230630DE/DE_Structures.gdb/a00000001.gdbtable
Deliverable20230630DE/DE_Structures.gdb/a00000002.gdbtable
Deliverable20230630DE/DE_Structures.gdb/a00000003.gdbtable
Deliverable20230630DE/DE_Structures.gdb/a00000004.gdbtable
Deliverable20230630DE/DE_Structures.gdb/a00000005.gdbtable
Deliverable20230630DE/DE_Structures.gdb/a00000006.gdbtable
Deliverable20230630DE/DE_Structures.gdb/a00000007.gdbtable
Deliverable20230630DE/DE_Structures.gdb/a0000000b.gdbtable
</pre></div>
<p>Below is an example record.</p>
<div><pre><span></span>$<span> </span>~/duckdb<span> </span><span>\</span>
<span>      </span>-json<span> </span><span>\</span>
<span>      </span>-c<span> </span><span>&#34;FROM ST_READ(&#39;Deliverable20230630DE/DE_Structures.gdb/a0000000b.gdbtable&#39;)</span>
<span>          LIMIT 1&#34;</span><span> </span><span>\</span>
<span>      </span><span>|</span><span> </span>jq<span> </span>-S<span> </span>.
</pre></div>
<div><pre><span></span><span>[</span>
<span>  </span><span>{</span>
<span>    </span><span>&#34;BUILD_ID&#34;</span><span>:</span><span> </span><span>1</span><span>,</span>
<span>    </span><span>&#34;CENSUSCODE&#34;</span><span>:</span><span> </span><span>&#34;10005051205&#34;</span><span>,</span>
<span>    </span><span>&#34;FIPS&#34;</span><span>:</span><span> </span><span>&#34;10005&#34;</span><span>,</span>
<span>    </span><span>&#34;HEIGHT&#34;</span><span>:</span><span> </span><span>null</span><span>,</span>
<span>    </span><span>&#34;H_ADJ_ELEV&#34;</span><span>:</span><span> </span><span>null</span><span>,</span>
<span>    </span><span>&#34;IMAGE_DATE&#34;</span><span>:</span><span> </span><span>&#34;2018-03-24 00:00:00&#34;</span><span>,</span>
<span>    </span><span>&#34;IMAGE_NAME&#34;</span><span>:</span><span> </span><span>&#34;104001003A728B00&#34;</span><span>,</span>
<span>    </span><span>&#34;LATITUDE&#34;</span><span>:</span><span> </span><span>38.45130373941299</span><span>,</span>
<span>    </span><span>&#34;LONGITUDE&#34;</span><span>:</span><span> </span><span>-75.05453241762243</span><span>,</span>
<span>    </span><span>&#34;L_ADJ_ELEV&#34;</span><span>:</span><span> </span><span>null</span><span>,</span>
<span>    </span><span>&#34;OCC_CLS&#34;</span><span>:</span><span> </span><span>&#34;Unclassified&#34;</span><span>,</span>
<span>    </span><span>&#34;OUTBLDG&#34;</span><span>:</span><span> </span><span>null</span><span>,</span>
<span>    </span><span>&#34;PRIM_OCC&#34;</span><span>:</span><span> </span><span>&#34;Unclassified&#34;</span><span>,</span>
<span>    </span><span>&#34;PROD_DATE&#34;</span><span>:</span><span> </span><span>&#34;2020-05-19 00:00:00&#34;</span><span>,</span>
<span>    </span><span>&#34;PROP_ADDR&#34;</span><span>:</span><span> </span><span>&#34;39047 GRAYS LANE&#34;</span><span>,</span>
<span>    </span><span>&#34;PROP_CITY&#34;</span><span>:</span><span> </span><span>&#34;FENWICK ISLAND&#34;</span><span>,</span>
<span>    </span><span>&#34;PROP_ST&#34;</span><span>:</span><span> </span><span>&#34;Delaware&#34;</span><span>,</span>
<span>    </span><span>&#34;PROP_ZIP&#34;</span><span>:</span><span> </span><span>&#34;19944&#34;</span><span>,</span>
<span>    </span><span>&#34;REMARKS&#34;</span><span>:</span><span> </span><span>null</span><span>,</span>
<span>    </span><span>&#34;SEC_OCC&#34;</span><span>:</span><span> </span><span>null</span><span>,</span>
<span>    </span><span>&#34;SOURCE&#34;</span><span>:</span><span> </span><span>&#34;ORNL&#34;</span><span>,</span>
<span>    </span><span>&#34;SQFEET&#34;</span><span>:</span><span> </span><span>638.9439</span><span>,</span>
<span>    </span><span>&#34;SQMETERS&#34;</span><span>:</span><span> </span><span>59.35989</span><span>,</span>
<span>    </span><span>&#34;Shape&#34;</span><span>:</span><span> </span><span>&#34;MULTIPOLYGON (((-75.05458907399998 38.45132615500006, -75.05446143999995 38.45132590600008, -75.05446157999995 38.451281298000026, -75.05458921299999 38.451281546000075, -75.05458907399998 38.45132615500006)))&#34;</span><span>,</span>
<span>    </span><span>&#34;Shape_Area&#34;</span><span>:</span><span> </span><span>5.693573654220543e-09</span><span>,</span>
<span>    </span><span>&#34;Shape_Length&#34;</span><span>:</span><span> </span><span>0.00034448492017148994</span><span>,</span>
<span>    </span><span>&#34;USNG&#34;</span><span>:</span><span> </span><span>&#34;18S VH 95241 55891&#34;</span><span>,</span>
<span>    </span><span>&#34;UUID&#34;</span><span>:</span><span> </span><span>&#34;{9d9aaaa2-f19a-4881-a4cc-daafad3b98d1}&#34;</span><span>,</span>
<span>    </span><span>&#34;VAL_METHOD&#34;</span><span>:</span><span> </span><span>&#34;Automated&#34;</span>
<span>  </span><span>}</span>
<span>]</span>
</pre></div>
<p>I&#39;ll convert Delaware&#39;s Geodatabase into a spatially-sorted, ZStandard-compressed, Parquet file.</p>

<div><pre><span></span><span>COPY</span><span>(</span>
<span>    </span><span>SELECT</span><span>   </span><span>*</span><span> </span><span>EXCLUDE</span><span>(</span><span>Shape</span><span>),</span>
<span>             </span><span>ST_ASWKB</span><span>(</span><span>Shape</span><span>)</span><span> </span><span>AS</span><span> </span><span>geom</span>
<span>    </span><span>FROM</span><span>     </span><span>ST_READ</span><span>(</span><span>&#39;Deliverable20230630DE/DE_Structures.gdb/a0000000b.gdbtable&#39;</span><span>)</span>
<span>    </span><span>ORDER</span><span> </span><span>BY</span><span> </span><span>HILBERT_ENCODE</span><span>([</span><span>ST_Y</span><span>(</span><span>ST_CENTROID</span><span>(</span><span>Shape</span><span>)),</span>
<span>                             </span><span>ST_X</span><span>(</span><span>ST_CENTROID</span><span>(</span><span>Shape</span><span>))]::</span><span>double</span><span>[</span><span>2</span><span>])</span>
<span>)</span><span> </span><span>TO</span><span> </span><span>&#39;DE.pq&#39;</span><span> </span><span>(</span>
<span>    </span><span>FORMAT</span><span>            </span><span>&#39;PARQUET&#39;</span><span>,</span>
<span>    </span><span>CODEC</span><span>             </span><span>&#39;ZSTD&#39;</span><span>,</span>
<span>    </span><span>COMPRESSION_LEVEL</span><span> </span><span>22</span><span>,</span>
<span>    </span><span>ROW_GROUP_SIZE</span><span>    </span><span>15000</span><span>);</span>
</pre></div>
<p>The above 106 MB ZIP file contains 219 MB of uncompressed Geodatabase data. After being converted into Parquet, it now has a footprint of 42 MB. Below is the space usage breakdown by column.</p>
<div><pre><span></span>$<span> </span>python3<span> </span>~/pqview/main.py<span> </span><span>\</span>
<span>    </span>sizes<span> </span><span>\</span>
<span>    </span>DE.pq
</pre></div>
<div><pre><span></span>  20.9 MB geom
   7.3 MB UUID
   2.9 MB Shape_Length
   2.7 MB Shape_Area
   2.0 MB LATITUDE
   2.0 MB LONGITUDE
   1.3 MB SQFEET
   1.3 MB SQMETERS
   1.2 MB PROP_ADDR
   1.2 MB USNG
 604.8 kB BUILD_ID
 181.1 kB HEIGHT
  50.2 kB PRIM_OCC
  31.8 kB OCC_CLS
  20.3 kB PROP_CITY
  19.4 kB PROP_ZIP
  16.9 kB CENSUSCODE
  16.1 kB IMAGE_DATE
  15.0 kB PROD_DATE
  14.8 kB IMAGE_NAME
   9.9 kB VAL_METHOD
   9.7 kB SOURCE
   2.0 kB FIPS
   1.8 kB PROP_ST
   1.2 kB REMARKS
862 Bytes SEC_OCC
862 Bytes OUTBLDG
862 Bytes H_ADJ_ELEV
862 Bytes L_ADJ_ELEV
</pre></div>
</div>
<div id="repackaging-as-parquet">
<h2>Repackaging as Parquet</h2>
<p>I&#39;ll convert the entire dataset&#39;s ~95 GB of uncompressed Geodatabase files into 15 GB worth of Parquet files.</p>
<div><pre><span></span>$<span> </span><span>for</span><span> </span>FILENAME<span> </span><span>in</span><span> </span><span>`</span>ls<span> </span>Deliverable*.zip<span>`</span><span>;</span><span> </span><span>do</span>
<span>      </span><span>STATE</span><span>=</span><span>`</span><span>echo</span><span> </span><span>$FILENAME</span><span> </span><span>|</span><span> </span>grep<span> </span>-oE<span> </span><span>&#39;[A-Z]{2}\.zip&#39;</span><span> </span><span>|</span><span> </span>sed<span> </span><span>&#39;s/.zip//g&#39;</span><span>`</span>

<span>      </span><span>if</span><span> </span>!<span> </span><span>test</span><span> </span>-f<span> </span><span>&#34;</span><span>$STATE</span><span>.pq&#34;</span><span>;</span><span> </span><span>then</span>
<span>          </span><span>echo</span><span> </span><span>$STATE</span>

<span>          </span>mkdir<span> </span>-p<span> </span>working
<span>          </span>rm<span> </span>working/*<span> </span><span>||</span><span> </span><span>true</span>
<span>          </span>unzip<span> </span>-qnj<span> </span><span>$FILENAME</span><span> </span>-d<span> </span>working

<span>          </span><span>GDB</span><span>=</span><span>`</span>ls<span> </span>-S<span> </span>working/*.gdbtable<span> </span><span>|</span><span> </span>head<span> </span>-n1<span>`</span>

<span>          </span><span>echo</span><span> </span><span>&#34;COPY(</span>
<span>                    SELECT   * EXCLUDE(Shape),</span>
<span>                             Shape geom</span>
<span>                    FROM     ST_READ(&#39;</span><span>$GDB</span><span>&#39;, keep_wkb=TRUE)</span>
<span>                    WHERE    (&#39;0x&#39; || substr(Shape::BLOB::TEXT, 7, 2))::int &lt; 8</span>
<span>                    AND      ST_Y(ST_CENTROID(Shape::GEOMETRY)) IS NOT NULL</span>
<span>                    AND      ST_X(ST_CENTROID(Shape::GEOMETRY)) IS NOT NULL</span>
<span>                    ORDER BY HILBERT_ENCODE([</span>
<span>                                  ST_Y(ST_CENTROID(Shape::GEOMETRY)),</span>
<span>                                  ST_X(ST_CENTROID(Shape::GEOMETRY))]::double[2])</span>
<span>                ) TO &#39;</span><span>$STATE</span><span>.pq&#39; (</span>
<span>                    FORMAT            &#39;PARQUET&#39;,</span>
<span>                    CODEC             &#39;ZSTD&#39;,</span>
<span>                    COMPRESSION_LEVEL 22,</span>
<span>                    ROW_GROUP_SIZE    15000);&#34;</span><span> </span><span>\</span>
<span>              </span><span>|</span><span> </span>~/duckdb_111/duckdb
<span>      </span><span>fi</span>
<span>  </span><span>done</span>
</pre></div>
<p>The above did need to exclude some records based on their type of geometry as the GEOS library DuckDB&#39;s spatial extension uses only supports <a href="https://github.com/duckdb/duckdb_spatial/issues/365">seven types of geometry</a>.</p>
<p>Some records contain geometry that DuckDB is unable to calculate a centroid for so I needed the exclude them as well.</p>
<p>Apple-specific metadata files were included in some ZIP files. <tt>unzip</tt> has a flag to not overwrite these files as the folder structure is discarded during the ZIP&#39;s decompression.</p>
<p>DuckDB can embed key-value metadata into Parquet files via a <tt>KV_METADATA</tt> option. It might be worth exploring packaging the metadata described below into each Parquet file so that they are more self-contained.</p>
</div>

<div id="unique-buildings">
<h2>Unique Buildings</h2>
<p>Each building&#39;s UUID is unique to that physical building. If a building is demolished and a new one is created, there will be two UUIDs on that parcel of land. At the moment, there are 131.8M UUIDs in this dataset.</p>

<div><pre><span></span><span>SELECT</span><span> </span><span>COUNT</span><span>(</span><span>DISTINCT</span><span> </span><span>UUID</span><span>)</span><span> </span><span>FROM</span><span> </span><span>READ_PARQUET</span><span>(</span><span>&#39;*.pq&#39;</span><span>);</span>
</pre></div>

<p>The H3 extension for DuckDB can throw errors if erroneous latitude and longitude values are fed to it. I&#39;ve noticed both latitude and longitude fall outside of their valid ranges in this dataset.</p>
<div><pre><span></span><span>.</span><span>mode</span><span> </span><span>line</span>

<span>SELECT</span><span> </span><span>MIN</span><span>(</span><span>LATITUDE</span><span>),</span>
<span>       </span><span>MAX</span><span>(</span><span>LATITUDE</span><span>),</span>
<span>       </span><span>MIN</span><span>(</span><span>LONGITUDE</span><span>),</span>
<span>       </span><span>MAX</span><span>(</span><span>LONGITUDE</span><span>)</span>
<span>FROM</span><span> </span><span>READ_PARQUET</span><span>(</span><span>&#39;*.pq&#39;</span><span>);</span>
</pre></div>
<div><pre><span></span> min(LATITUDE) = -14.363104424403035
 max(LATITUDE) = 4332647.099997337
min(LONGITUDE) = -47766.96837265695
max(LONGITUDE) = 718848.8890845429
</pre></div>
<p>Around 32M buildings have height information in this dataset. Below I&#39;ve calculated the maximum height for each zoom-level-3 hexagon.</p>
<p>I&#39;ve added predicates to only use valid latitude and longitude values and avoid anything near the international dateline as the polygons for that area will cover the earth horizontally when rendered in QGIS.</p>
<div><pre><span></span><span>COPY</span><span> </span><span>(</span>
<span>    </span><span>SELECT</span><span>   </span><span>H3_CELL_TO_BOUNDARY_WKT</span><span>(</span>
<span>                  </span><span>H3_LATLNG_TO_CELL</span><span>(</span><span>LATITUDE</span><span>,</span>
<span>                                    </span><span>LONGITUDE</span><span>,</span>
<span>                                    </span><span>3</span><span>))::</span><span>geometry</span><span> </span><span>geom</span><span>,</span>
<span>             </span><span>MAX</span><span>(</span><span>HEIGHT</span><span>)</span><span> </span><span>as</span><span> </span><span>max_height</span>
<span>    </span><span>FROM</span><span>     </span><span>READ_PARQUET</span><span>(</span><span>&#39;*.pq&#39;</span><span>)</span>
<span>    </span><span>WHERE</span><span>    </span><span>LONGITUDE</span><span> </span><span>&lt;</span><span> </span><span>170</span>
<span>    </span><span>AND</span><span>      </span><span>LONGITUDE</span><span> </span><span>&gt;</span><span> </span><span>-</span><span>170</span>
<span>    </span><span>AND</span><span>      </span><span>HEIGHT</span><span> </span><span>IS</span><span> </span><span>NOT</span><span> </span><span>NULL</span>
<span>    </span><span>GROUP</span><span> </span><span>BY</span><span> </span><span>1</span>
<span>)</span><span> </span><span>TO</span><span> </span><span>&#39;max_height.h3_3.gpkg&#39;</span>
<span>    </span><span>WITH</span><span> </span><span>(</span><span>FORMAT</span><span> </span><span>GDAL</span><span>,</span>
<span>          </span><span>DRIVER</span><span> </span><span>&#39;GPKG&#39;</span><span>,</span>
<span>          </span><span>LAYER_CREATION_OPTIONS</span><span> </span><span>&#39;WRITE_BBOX=YES&#39;</span><span>);</span>
</pre></div>
<p><a href="https://tech.marksblogg.com/theme/images/ornl_fema_buildings/qgis-bin_Uo5UawG7Mt.jpg"><img alt="ORNL&#39;s US Buildings Dataset" src="https://tech.marksblogg.com/theme/images/ornl_fema_buildings/qgis-bin_Uo5UawG7Mt.jpg"/></a>
</p></div>
<div id="building-uses">
<h2>Building Uses</h2>
<p>All but ~6M buildings in this dataset have an occupational class.</p>
<div><pre><span></span><span>SELECT</span><span>   </span><span>OCC_CLS</span><span>,</span>
<span>         </span><span>COUNT</span><span>(</span><span>*</span><span>)</span>
<span>FROM</span><span>     </span><span>READ_PARQUET</span><span>(</span><span>&#39;*.pq&#39;</span><span>)</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>1</span>
<span>ORDER</span><span> </span><span>BY</span><span> </span><span>2</span><span> </span><span>DESC</span><span>;</span>
</pre></div>
<div><pre><span></span>┌──────────────────┬──────────────┐
│     OCC_CLS      │ count_star() │
│     varchar      │    int64     │
├──────────────────┼──────────────┤
│ Residential      │    112422033 │
│ Unclassified     │      5928631 │
│ Commercial       │      5631343 │
│ Agriculture      │      3913083 │
│ Industrial       │      1324540 │
│ Government       │       958829 │
│ Education        │       810984 │
│ Assembly         │       573600 │
│ Utility and Misc │       248909 │
└──────────────────┴──────────────┘
</pre></div>
<p>Here is an image of the occupational classes around Los Angeles International Airport (LAX).</p>
<p><a href="https://tech.marksblogg.com/theme/images/ornl_fema_buildings/sublime_text_TN94b27911.jpg"><img alt="ORNL&#39;s US Buildings Dataset" src="https://tech.marksblogg.com/theme/images/ornl_fema_buildings/sublime_text_TN94b27911.jpg"/></a></p><p>There is also a primary occupancy field that describes the use of any building in greater detail.</p>
<div><pre><span></span><span>SELECT</span><span>   </span><span>PRIM_OCC</span><span>,</span>
<span>         </span><span>COUNT</span><span>(</span><span>*</span><span>)</span>
<span>FROM</span><span>     </span><span>READ_PARQUET</span><span>(</span><span>&#39;*.pq&#39;</span><span>)</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>1</span>
<span>ORDER</span><span> </span><span>BY</span><span> </span><span>2</span><span> </span><span>DESC</span><span>;</span>
</pre></div>
<div><pre><span></span>┌─────────────────────────────────┬──────────────┐
│            PRIM_OCC             │ count_star() │
│             varchar             │    int64     │
├─────────────────────────────────┼──────────────┤
│ Single Family Dwelling          │     96877836 │
│ Unclassified                    │      7941798 │
│ Multi - Family Dwelling         │      6689708 │
│ Manufactured Home               │      6317390 │
│ Agriculture                     │      3913083 │
│ Retail Trade                    │      3063377 │
│ Light                           │      1152866 │
│ Professional/Technical Services │      1068094 │
│ General Services                │       695365 │
│ Entertainment and Recreation    │       622523 │
│ Pre-K - 12 Schools              │       490540 │
│ Personal and Repair Services    │       407753 │
│ Religious                       │       389324 │
│ Temporary Lodging               │       363633 │
│ Wholesale Trade                 │       269162 │
│ Non-Civilian Structures         │       189401 │
│ Aviation                        │       189073 │
│ Colleges/Universities           │       179209 │
│ Community Center                │       175178 │
│ Other Educational Buildings     │       141235 │
│ Nursing Home                    │        96576 │
│ Medical Office/Clinic           │        94729 │
│ Emergency Response              │        74063 │
│ Institutional Dormitory         │        63723 │
│ Metals/Minerals Processing      │        56371 │
│ Parking                         │        55821 │
│ Food/Drugs/Chemicals            │        54896 │
│ Heavy                           │        46620 │
│ Ground                          │        38615 │
│ Hospital                        │        24326 │
│ Theaters                        │        12968 │
│ Veterinary/Pet                  │        12144 │
│ Marine                          │        10415 │
│ High Technology                 │         8558 │
│ Indoor Arena                    │         8149 │
│ Rail                            │         7210 │
│ Construction                    │         5229 │
│ Energy Control Monitoring       │         3596 │
│ Stadium                         │          934 │
│ Banks                           │          446 │
│ Convention Center               │           15 │
├─────────────────────────────────┴──────────────┤
│ 41 rows                              2 columns │
└────────────────────────────────────────────────┘
</pre></div>
<p><a href="https://tech.marksblogg.com/theme/images/ornl_fema_buildings/qgis-bin_weU4TqRVwK.jpg"><img alt="ORNL&#39;s US Buildings Dataset" src="https://tech.marksblogg.com/theme/images/ornl_fema_buildings/qgis-bin_weU4TqRVwK.jpg"/></a>
</p></div>
<div id="building-addresses">
<h2>Building Addresses</h2>
<p>Every record has a state name associated with it.</p>
<div><pre><span></span><span>SELECT</span><span>   </span><span>PROP_ST</span><span>,</span>
<span>         </span><span>COUNT</span><span>(</span><span>*</span><span>)</span>
<span>FROM</span><span>     </span><span>READ_PARQUET</span><span>(</span><span>&#39;*.pq&#39;</span><span>)</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>1</span>
<span>ORDER</span><span> </span><span>BY</span><span> </span><span>2</span><span> </span><span>DESC</span>
<span>LIMIT</span><span>    </span><span>10</span><span>;</span>
</pre></div>
<div><pre><span></span>┌────────────────┬──────────────┐
│    PROP_ST     │ count_star() │
│    varchar     │    int64     │
├────────────────┼──────────────┤
│ Texas          │     11597841 │
│ California     │     10931401 │
│ Florida        │      6987662 │
│ Ohio           │      5773395 │
│ New York       │      5015975 │
│ Pennsylvania   │      4987403 │
│ Illinois       │      4931783 │
│ Michigan       │      4925410 │
│ North Carolina │      4790212 │
│ Georgia        │      3939753 │
├────────────────┴──────────────┤
│ 10 rows             2 columns │
└───────────────────────────────┘
</pre></div>
<p>But 69.5M records don&#39;t have a city name associated with them.</p>
<div><pre><span></span><span>SELECT</span><span>   </span><span>PROP_CITY</span><span>,</span>
<span>         </span><span>COUNT</span><span>(</span><span>*</span><span>)</span>
<span>FROM</span><span>     </span><span>READ_PARQUET</span><span>(</span><span>&#39;*.pq&#39;</span><span>)</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>1</span>
<span>ORDER</span><span> </span><span>BY</span><span> </span><span>2</span><span> </span><span>DESC</span>
<span>LIMIT</span><span>    </span><span>10</span><span>;</span>
</pre></div>
<div><pre><span></span>┌──────────────┬──────────────┐
│  PROP_CITY   │ count_star() │
│   varchar    │    int64     │
├──────────────┼──────────────┤
│              │     69569842 │
│ HOUSTON      │       775873 │
│ CHICAGO      │       548972 │
│ SAN ANTONIO  │       544670 │
│ PHOENIX      │       478703 │
│ DALLAS       │       394747 │
│ JACKSONVILLE │       369970 │
│ TUCSON       │       324066 │
│ FORT WORTH   │       304702 │
│ AUSTIN       │       303199 │
├──────────────┴──────────────┤
│ 10 rows           2 columns │
└─────────────────────────────┘
</pre></div>
<p>Almost 62M buildings don&#39;t have an address.</p>
<div><pre><span></span><span>SELECT</span><span>   </span><span>PROP_ADDR</span><span>,</span>
<span>         </span><span>COUNT</span><span>(</span><span>*</span><span>)</span>
<span>FROM</span><span>     </span><span>READ_PARQUET</span><span>(</span><span>&#39;*.pq&#39;</span><span>)</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>1</span>
<span>ORDER</span><span> </span><span>BY</span><span> </span><span>2</span><span> </span><span>DESC</span>
<span>LIMIT</span><span>    </span><span>10</span><span>;</span>
</pre></div>
<div><pre><span></span>┌─────────────────────────────┬──────────────┐
│          PROP_ADDR          │ count_star() │
│           varchar           │    int64     │
├─────────────────────────────┼──────────────┤
│                             │     61951398 │
│ 7329 SECO BLVD              │       105019 │
│ 5535 NORTHMOOR DR           │        73691 │
│ 15235 S TAMIAMI TRL         │         1304 │
│ 17200 WEST BELL ROAD        │         1197 │
│ 12850 SW 14 ST              │         1156 │
│ 3000 TANGLEWOOD PKWY OFFICE │         1076 │
│ 14205 E COLONIAL DR         │         1074 │
│ 106 EVERGREEN LN            │         1062 │
│ 950 RIDGEWOOD AVE           │         1051 │
├─────────────────────────────┴──────────────┤
│ 10 rows                          2 columns │
└────────────────────────────────────────────┘
</pre></div>
<p>Almost 68M are missing a ZIP code.</p>
<div><pre><span></span><span>SELECT</span><span>   </span><span>PROP_ZIP</span><span>,</span>
<span>         </span><span>COUNT</span><span>(</span><span>*</span><span>)</span>
<span>FROM</span><span>     </span><span>READ_PARQUET</span><span>(</span><span>&#39;*.pq&#39;</span><span>)</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>1</span>
<span>ORDER</span><span> </span><span>BY</span><span> </span><span>2</span><span> </span><span>DESC</span>
<span>LIMIT</span><span>    </span><span>10</span><span>;</span>
</pre></div>
<div><pre><span></span>┌──────────┬──────────────┐
│ PROP_ZIP │ count_star() │
│ varchar  │    int64     │
├──────────┼──────────────┤
│          │     67902480 │
│ 34953    │        54681 │
│ 77494    │        36753 │
│ 77449    │        32062 │
│ 78641    │        31926 │
│ 59901    │        31363 │
│ 60629    │        30671 │
│ 77573    │        30621 │
│ 34950    │        30495 │
│ 28655    │        30459 │
├──────────┴──────────────┤
│ 10 rows       2 columns │
└─────────────────────────┘
</pre></div>
<p>Every building has a FIPS code.</p>
<div><pre><span></span><span>SELECT</span><span>   </span><span>FIPS</span><span>,</span>
<span>         </span><span>COUNT</span><span>(</span><span>*</span><span>)</span>
<span>FROM</span><span>     </span><span>READ_PARQUET</span><span>(</span><span>&#39;*.pq&#39;</span><span>)</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>1</span>
<span>ORDER</span><span> </span><span>BY</span><span> </span><span>2</span><span> </span><span>DESC</span>
<span>LIMIT</span><span>    </span><span>10</span><span>;</span>
</pre></div>
<div><pre><span></span>┌─────────┬──────────────┐
│  FIPS   │ count_star() │
│ varchar │    int64     │
├─────────┼──────────────┤
│ 06037   │      2442352 │
│ 04013   │      1477631 │
│ 17031   │      1320536 │
│ 48201   │      1320215 │
│ 06073   │       821650 │
│ 06059   │       750570 │
│ 26163   │       747480 │
│ 06065   │       731839 │
│ 48113   │       709529 │
│ 48439   │       666556 │
├─────────┴──────────────┤
│ 10 rows      2 columns │
└────────────────────────┘
</pre></div>
<p>Every building has a Census code.</p>
<div><pre><span></span><span>SELECT</span><span>   </span><span>CENSUSCODE</span><span>,</span>
<span>         </span><span>COUNT</span><span>(</span><span>*</span><span>)</span>
<span>FROM</span><span>     </span><span>READ_PARQUET</span><span>(</span><span>&#39;*.pq&#39;</span><span>)</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>1</span>
<span>ORDER</span><span> </span><span>BY</span><span> </span><span>2</span><span> </span><span>DESC</span>
<span>LIMIT</span><span>    </span><span>10</span><span>;</span>
</pre></div>
<div><pre><span></span>┌─────────────┬──────────────┐
│ CENSUSCODE  │ count_star() │
│   varchar   │    int64     │
├─────────────┼──────────────┤
│ 30027030100 │         9709 │
│ 48157673202 │         9504 │
│ 40085094200 │         8382 │
│ 55075960200 │         8053 │
│ 48201542902 │         8044 │
│ 38061955200 │         8010 │
│ 38055961001 │         7845 │
│ 38025962200 │         7837 │
│ 55075960700 │         7830 │
│ 08123002501 │         7729 │
├─────────────┴──────────────┤
│ 10 rows          2 columns │
└────────────────────────────┘
</pre></div>
</div>
<div id="production-details">
<h2>Production Details</h2>
<p>Below are the primary sources for each building.</p>
<div><pre><span></span><span>SELECT</span><span>   </span><span>SOURCE</span><span>,</span>
<span>         </span><span>COUNT</span><span>(</span><span>*</span><span>)</span>
<span>FROM</span><span>     </span><span>READ_PARQUET</span><span>(</span><span>&#39;*.pq&#39;</span><span>)</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>1</span>
<span>ORDER</span><span> </span><span>BY</span><span> </span><span>2</span><span> </span><span>DESC</span><span>;</span>
</pre></div>
<div><pre><span></span>┌─────────┬──────────────┐
│ SOURCE  │ count_star() │
│ varchar │    int64     │
├─────────┼──────────────┤
│ ORNL    │     99696527 │
│ NGA     │     32109289 │
│ NOAA    │         6136 │
└─────────┴──────────────┘
</pre></div>
<p>Underlying imagery filenames are documented in the <tt>IMAGE_NAME</tt> field.</p>
<div><pre><span></span><span>SELECT</span><span>   </span><span>IMAGE_NAME</span><span>,</span>
<span>         </span><span>COUNT</span><span>(</span><span>*</span><span>)</span>
<span>FROM</span><span>     </span><span>READ_PARQUET</span><span>(</span><span>&#39;*.pq&#39;</span><span>)</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>1</span>
<span>ORDER</span><span> </span><span>BY</span><span> </span><span>2</span><span> </span><span>DESC</span><span>;</span>
</pre></div>
<div><pre><span></span>┌─────────────────────────────────────┬──────────────┐
│             IMAGE_NAME              │ count_star() │
│               varchar               │    int64     │
├─────────────────────────────────────┼──────────────┤
│ Li234-Los Angeles                   │      2508188 │
│ Li279-Dallas                        │      1126980 │
│ Li135-Washington                    │      1059116 │
│ Li250-New York City                 │      1052991 │
│ Li213-Chicago                       │      1041121 │
│ Li241-San Fransico- Oakland         │       913385 │
│ Li238-Philadelphia- Wilmington      │       897701 │
│ Li272-Miami                         │       846854 │
│ Li257-Phoenix                       │       781002 │
│ Li219-Minneapolis                   │       738935 │
│ Li227-Denver                        │       723380 │
│ Li275-Detroit                       │       544929 │
│ Li185-Houston                       │       520854 │
│ Li244-Tampa Bay                     │       515032 │
│ Li243-St. Louis                     │       512304 │
│ Li271-Las Vegas                     │       510711 │
│ Li239-San Antonio                   │       507526 │
│ 1040010050CF1C00                    │       473934 │
│ Li218-Atlanta                       │       458947 │
│ Li195-akron- cleveland              │       441440 │
│           ·                         │            · │
│           ·                         │            · │
│           ·                         │            · │
│ m_3708663_sw_16_1_20140705_20141201 │            1 │
│ m_3608240_sw_17_1_20140506_20140728 │            1 │
│ m_3608662_sw_16_1_20140711_20141113 │            1 │
│ m_3508437_sw_16_1_20140503_20140710 │            1 │
│ m_4711831_sw_11_1_20130628_20130820 │            1 │
│ 1045006                             │            1 │
│ 1050410001C9BB00                    │            1 │
│ 103001003FBA5200                    │            1 │
│ 1040010001064900                    │            1 │
│ 103001006AAA3500                    │            1 │
│ 1040010017225600                    │            1 │
│ m_4606936_ne_19_1_20130721_20131029 │            1 │
│ m_3908414_ne_16_1_20130924_20131031 │            1 │
│ 1043752                             │            1 │
│ 1045406                             │            1 │
│ m_4008604_nw_16_1_20141025_20141201 │            1 │
│ m_3708856_se_16_1_20140623_20141201 │            1 │
│ m_4711419_se_11_1_20130821_20131022 │            1 │
│ m_4209707_ne_14_1_20140926_20141113 │            1 │
│ m_3508655_se_16_1_20141022_20141113 │            1 │
├─────────────────────────────────────┴──────────────┤
│ 20394 rows (40 shown)                    2 columns │
└────────────────────────────────────────────────────┘
</pre></div>
<p>Below are the relationships between the imagery source and production dates. I need to look into what they mean by production further.</p>
<div><pre><span></span><span>WITH</span><span> </span><span>a</span><span> </span><span>AS</span><span> </span><span>(</span>
<span>    </span><span>SELECT</span><span>   </span><span>STRFTIME</span><span>(</span><span>IMAGE_DATE</span><span>,</span><span> </span><span>&#39;%Y&#39;</span><span>)</span><span> </span><span>imagery_from</span><span>,</span>
<span>             </span><span>STRFTIME</span><span>(</span><span>PROD_DATE</span><span>,</span><span>  </span><span>&#39;%Y&#39;</span><span>)</span><span> </span><span>produced_at</span><span>,</span>
<span>             </span><span>COUNT</span><span>(</span><span>*</span><span>)</span><span> </span><span>num_rec</span>
<span>    </span><span>FROM</span><span>     </span><span>READ_PARQUET</span><span>(</span><span>&#39;*.pq&#39;</span><span>)</span>
<span>    </span><span>GROUP</span><span> </span><span>BY</span><span> </span><span>1</span><span>,</span><span> </span><span>2</span>
<span>)</span>
<span>PIVOT</span><span>    </span><span>a</span>
<span>ON</span><span>       </span><span>imagery_from</span>
<span>USING</span><span>    </span><span>SUM</span><span>(</span><span>num_rec</span><span>)</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>produced_at</span>
<span>ORDER</span><span> </span><span>BY</span><span> </span><span>produced_at</span><span>;</span>
</pre></div>
<div><pre><span></span>┌─────────────┬────────┬────────┬────────┬────────┬────────┬────────┬─────────┬─────────┬─────────┬─────────┬──────────┬─────────┬─────────┬─────────┬─────────┬─────────┬──────────┬──────────┬─────────┬─────────┐
│ produced_at │  2000  │  2003  │  2004  │  2005  │  2006  │  2007  │  2008   │  2009   │  2010   │  2011   │   2012   │  2013   │  2014   │  2015   │  2016   │  2017   │   2018   │   2019   │  2020   │  2021   │
│   varchar   │ int128 │ int128 │ int128 │ int128 │ int128 │ int128 │ int128  │ int128  │ int128  │ int128  │  int128  │ int128  │ int128  │ int128  │ int128  │ int128  │  int128  │  int128  │ int128  │ int128  │
├─────────────┼────────┼────────┼────────┼────────┼────────┼────────┼─────────┼─────────┼─────────┼─────────┼──────────┼─────────┼─────────┼─────────┼─────────┼─────────┼──────────┼──────────┼─────────┼─────────┤
│ 2000        │  13008 │        │        │        │        │        │         │         │         │         │          │         │         │         │         │         │          │          │         │         │
│ 2003        │        │  65135 │        │        │        │        │         │         │         │         │          │         │         │         │         │         │          │          │         │         │
│ 2004        │        │        │  81034 │        │        │        │         │         │         │         │          │         │         │         │         │         │          │          │         │         │
│ 2005        │        │        │        │  77331 │        │        │         │         │         │         │          │         │         │         │         │         │          │          │         │         │
│ 2006        │        │        │        │        │ 428349 │        │         │         │         │         │          │         │         │         │         │         │          │          │         │         │
│ 2007        │        │        │        │        │        │ 255545 │         │         │         │         │          │         │         │         │         │         │          │          │         │         │
│ 2008        │        │        │        │        │        │        │ 2551704 │         │         │         │          │         │         │         │         │         │          │          │         │         │
│ 2009        │        │        │        │        │        │        │         │ 1433778 │         │         │          │         │         │         │         │         │          │          │         │         │
│ 2010        │        │        │        │        │        │        │         │         │ 2817831 │         │          │         │         │         │         │         │          │          │         │         │
│ 2011        │        │        │        │        │        │        │         │         │         │ 4443349 │          │         │         │         │         │         │          │          │         │         │
│ 2012        │        │        │        │        │        │        │         │         │         │         │ 10193895 │         │         │         │         │         │          │          │         │         │
│ 2013        │        │        │        │        │        │        │         │         │         │         │          │ 2439121 │         │         │         │         │          │          │         │         │
│ 2014        │        │        │        │        │        │        │         │         │         │         │          │         │ 2353654 │         │         │         │          │          │         │         │
│ 2015        │        │        │        │        │        │        │         │         │         │         │          │         │         │ 2616900 │         │         │          │          │         │         │
│ 2018        │        │        │        │        │        │        │         │         │   14451 │   51544 │   164587 │  206082 │  146136 │ 1477598 │ 2543621 │ 3458766 │   124530 │          │         │         │
│ 2019        │        │        │        │        │     93 │        │         │       4 │    3285 │   31067 │     6262 │   39932 │  996916 │ 3402831 │ 6259885 │ 9390253 │ 11508572 │   613431 │         │         │
│ 2020        │        │        │        │        │        │        │         │     911 │  127773 │  229247 │   338299 │  801825 │ 2386198 │ 5424376 │ 6355909 │ 6350048 │ 11148082 │ 11520284 │  483376 │         │
│ 2021        │        │        │        │        │  91297 │    320 │   37017 │  304631 │  390273 │   46241 │   558819 │   95539 │ 1145988 │  565846 │  972673 │ 2443570 │  2404869 │  2238716 │ 3866062 │ 1273283 │
├─────────────┴────────┴────────┴────────┴────────┴────────┴────────┴─────────┴─────────┴─────────┴─────────┴──────────┴─────────┴─────────┴─────────┴─────────┴─────────┴──────────┴──────────┴─────────┴─────────┤
│ 18 rows                                                                                                                                                                                               21 columns │
└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</pre></div>
<p>Below are the methods of validation used.</p>
<div><pre><span></span><span>SELECT</span><span>   </span><span>VAL_METHOD</span><span>,</span>
<span>         </span><span>COUNT</span><span>(</span><span>*</span><span>)</span>
<span>FROM</span><span>     </span><span>READ_PARQUET</span><span>(</span><span>&#39;*.pq&#39;</span><span>)</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>1</span>
<span>ORDER</span><span> </span><span>BY</span><span> </span><span>2</span><span> </span><span>DESC</span><span>;</span>
</pre></div>
<div><pre><span></span>┌────────────┬──────────────┐
│ VAL_METHOD │ count_star() │
│  varchar   │    int64     │
├────────────┼──────────────┤
│ Automated  │     99640705 │
│ Unverified │     32168516 │
│ Manual     │         2731 │
└────────────┴──────────────┘
</pre></div>
</div>

        </div><p>
            Thank you for taking the time to read this post. I offer both consulting and hands-on development services to clients in North America and Europe. If you&#39;d like to discuss how my offerings can help your business please contact me via <a href="https://uk.linkedin.com/in/marklitwintschik/">LinkedIn</a>.
        </p></div>
  </body>
</html>
