<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.fastmail.com/blog/partial-outage-on-30-june-2023/">Original</a>
    <h1>Fastmail 30 June outage post-mortem</h1>
    
    <div id="readability-page-1" class="page"><div>
                    <p>A partial network outage occurred at Fastmail on June 30th, 2023. Most did not notice, but it was severe for the directly affected 3-5% of our customers.</p>
<p>Whether or not you noticed, we’re truly sorry that this happened, and have a plan to avoid it happening again.</p>
<p>This article will get very technical about how our network works! We hope you find it useful.</p>
<h2>A short summary</h2>
<p>For about 19 hours, Fastmail and a portion of the internet were completely unable to communicate with each other, including a fraction of our customers, and also some email servers. This led to delayed email, some mail fetches being disabled, and if you were using one of those networks, Fastmail being entirely offline for you!</p>
<p>We had a single path for traffic out to the internet, and hence were unable to fix this ourselves. As a <a href="https://www.reddit.com/r/fastmail/comments/14mrjk1/comment/jq68lb9/">Reddit comment</a> said, this wasn’t within our control, but it is our responsibility.</p>
<p>It is not acceptable to us that a subset of our customers were unable to access their email for so long, and also that we were unable to send email to a section of the internet.</p>
<p>To prevent this from happening again, we plan to connect directly into an additional transit provider, so we can select between multiple pathways for outbound data. Having this control will allow us to route around individual provider network issues, and be back online for everybody faster.</p>
<h2>What, when, where, who</h2>
<ul>
<li>What: access to all Fastmail services, including mail delivery, was broken – in particular, the ability for network packets leaving our network to reach their destination.</li>
<li>When: starting approximately 03:00 UTC on June 30th and ending about 22:00 UTC on the same day, for a total outage time of 19 hours. We’re quite certain that the root cause of this outage is now fixed.</li>
<li>Where: a fraction of the internet.</li>
<li>Who: We estimate 3-5% of our customers, based on comparing server metrics to similar days.</li>
</ul>
<p>We first became aware of the issue when our customers informed us via support tickets and social media. While we have monitors from multiple locations around the world, neither those monitors nor any of our staff were on networks that had issues. We could tell it was quite isolated, because some reported being able to access from phone but not home network, or vice versa. Also VPNs allowed some users to find a functioning pathway to our servers.</p>
<p>Since we couldn’t see the failing links ourselves, we relied on helpful customers on those networks who provided us with traceroutes — which then gave us some addresses to trace back to from our end and see where the traffic was dropping. We very much appreciate everybody who assisted us with datapoints!</p>
<h2>Some history</h2>
<p>A few years ago, we moved from New York Internet’s Manhattan datacenter to their Bridgewater, New Jersey location. A bit later, this datacenter was sold to 365 Datacenters. We were using the IP address range <tt>66.111.4.0/24</tt> — a range which still belongs to the original NYI.</p>
<p>Thankfully, NYI were willing to lease us those addresses, because <a href="https://postmarkapp.com/blog/how-to-check-your-ip-reputation">IP range reputation</a> is really important in the email world, and those things are hardcoded all over the place — but it has caused us complications due to more complex routing. Over the past year, we’ve been migrating to a new IP range. We’ve been running the two networks concurrently as we build up the trust reputation for the new addresses.</p>
<p>In past years, we have had <a href="https://www.fastmail.com/blog/fastmail-fights-off-ransom-cyberattack/">DDoS attacks against our service</a>, and our previous DDoS protection services couldn’t keep us up through the worst of those attacks, so we’re now bringing all our incoming traffic via a service called MagicTransit from Cloudflare. It routes everything at the IP layer, so all the traffic is encrypted just like it was going over any other network — but Cloudflare has the capacity to soak up a lot of attack, and they’re really quick and proactive.</p>
<p>As part of the MagicTransit setup, we also added a second way into our network. Cloudflare can either route to us over our “Private Public” network IP on the 365 managed network, or via Megaport, a service which provides private virtual cables. We have a fiber link to Megaport, so we can route traffic from Cloudflare into our network without using the uplink to 365’s network. Traffic normally comes in that way, it’s a little faster, so we give it priority.</p>
<p><img decoding="async" loading="lazy" src="https://www.fastmail.com/wp-content/uploads/2023/07/5aCTGXiL.png" alt="active cloudflare configuration" width="1001" height="288" srcset="https://www.fastmail.com/wp-content/uploads/2023/07/5aCTGXiL.png 1001w, https://www.fastmail.com/wp-content/uploads/2023/07/5aCTGXiL-300x86.png 300w, https://www.fastmail.com/wp-content/uploads/2023/07/5aCTGXiL-768x221.png 768w" sizes="(max-width: 1001px) 100vw, 1001px"/></p>
<p>Megaport was up during the entire incident, so packets were getting in to our network reliably. It was outbound packets that weren’t all getting through.</p>
<h2>Our current network structure</h2>
<p><img decoding="async" loading="lazy" src="https://www.fastmail.com/wp-content/uploads/2023/07/temp.png" alt="diagram of our network layout" width="754" height="781" srcset="https://www.fastmail.com/wp-content/uploads/2023/07/temp.png 754w, https://www.fastmail.com/wp-content/uploads/2023/07/temp-290x300.png 290w" sizes="(max-width: 754px) 100vw, 754px"/></p>
<h2>The Future</h2>
<p>Work is now underway to select a provider for a second transit connection directly into our servers — either via Megaport, or from a service with their own physical presence in 365’s New Jersey datacenter. Once we have this, we will be able to directly control our outbound traffic flow and route around any network with issues.</p>
<p>Thanks for reading, and as always thank you for using Fastmail (both those who were unaffected, and those of you who have kept using Fastmail after that very bad day!)</p>
                </div></div>
  </body>
</html>
