<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jnsgr.uk/2024/02/contributing-scrutiny-to-nixpkgs/">Original</a>
    <h1>Contributing Scrutiny to Nixpkgs</h1>
    
    <div id="readability-page-1" class="page"><article><header><ol><li><a href="https://jnsgr.uk/"></a><span>/</span></li><li><a href="https://jnsgr.uk/posts/">Blog</a><span>/</span></li><li><a href="https://jnsgr.uk/2024/02/contributing-scrutiny-to-nixpkgs/">Contributing Scrutiny to nixpkgs</a><span>/</span></li></ol><div><p><time datetime="2024-02-19 00:00:00 +0000 UTC">19 February 2024</time><span>·</span><span>2216 words</span><span>·</span><span title="Reading time">11 mins</span></p></div></header><section><div><h2 id="introduction">Introduction <span><a href="#introduction" aria-label="Anchor">#</a></span></h2><p>I’m quite overwhelmed by the number of people who read, and engaged with my
<a href="https://jnsgr.uk/2024/02/packaging-scrutiny-for-nixos/" target="_blank" rel="noreferrer">last post</a> on packaging
<a href="https://github.com/AnalogJ/scrutiny" target="_blank" rel="noreferrer">Scrutiny</a> for NixOS. I hadn’t intended on posting to this blog more than maybe once per month, but I decided to continue documenting the journey of landing Scrutiny upstream in
<a href="https://github.com/NixOS/nixpkgs" target="_blank" rel="noreferrer">nixpkgs</a>.</p><p>One of the things that really struck me about NixOS early on was how simple the contribution process is. A single Github repository contains all the packages, all the modules, and all the tests.</p><p>I’ve found the community incredibly helpful and respectful in all of my contributions - often with 2-3 people quickly providing reviews to help shape the contribution. I’ve heard complaints that reviews can be quite pedantic, and while I agree to some extent, the reviews nearly always come with concrete suggestions which are a great way to learn. Notwithstanding the fact that you are contributing to an operating system package that could land on many thousands of machines - it’s important to be careful!</p><p>If you’ve been deliberating about whether or not to submit your package, module or otherwise, I’d encourage you to go for it. I’ve always found it rewarding and it’s taught me a lot about Nix and NixOS.</p><p>My
<a href="https://github.com/NixOS/nixpkgs/pull/214193" target="_blank" rel="noreferrer">first contribution</a> was adding a package, module and test for
<a href="https://multipass.run" target="_blank" rel="noreferrer">multipass</a> - as you can see I had plenty to learn, but people were generous with their time and it resulted in a contribution that I use daily to get my work done on NixOS.</p><p>For those losing sleep over the poorly disk I showed in my last post, you’ll be relieved to know that it’s now been replaced! Incidentally this was the first time I’ve replaced a disk in a ZFS array and I was super impressed with how easy the process was!</p><figure><a href="https://jnsgr.uk/2024/02/contributing-scrutiny-to-nixpkgs/02.png"><picture><source srcset="/2024/02/contributing-scrutiny-to-nixpkgs/02_huadf2ee278a6538a3e53d6ce12b8edbcb_288154_330x0_resize_q75_h2_box_3.webp 330w,/2024/02/contributing-scrutiny-to-nixpkgs/02_huadf2ee278a6538a3e53d6ce12b8edbcb_288154_660x0_resize_q75_h2_box_3.webp 660w
,/2024/02/contributing-scrutiny-to-nixpkgs/02_huadf2ee278a6538a3e53d6ce12b8edbcb_288154_1024x0_resize_q75_h2_box_3.webp 1024w
,/2024/02/contributing-scrutiny-to-nixpkgs/02_huadf2ee278a6538a3e53d6ce12b8edbcb_288154_1320x0_resize_q75_h2_box_3.webp 1320w" sizes="100vw" type="image/webp"/><img width="1626" height="1743" alt="healthy disks" loading="lazy" decoding="async" src="https://jnsgr.uk/2024/02/contributing-scrutiny-to-nixpkgs/02_huadf2ee278a6538a3e53d6ce12b8edbcb_288154_660x0_resize_box_3.png" srcset="/2024/02/contributing-scrutiny-to-nixpkgs/02_huadf2ee278a6538a3e53d6ce12b8edbcb_288154_330x0_resize_box_3.png 330w,/2024/02/contributing-scrutiny-to-nixpkgs/02_huadf2ee278a6538a3e53d6ce12b8edbcb_288154_660x0_resize_box_3.png 660w
,/2024/02/contributing-scrutiny-to-nixpkgs/02_huadf2ee278a6538a3e53d6ce12b8edbcb_288154_1024x0_resize_box_3.png 1024w
,/2024/02/contributing-scrutiny-to-nixpkgs/02_huadf2ee278a6538a3e53d6ce12b8edbcb_288154_1320x0_resize_box_3.png 1320w" sizes="100vw"/></picture></a></figure><h2 id="improving-my-work">Improving My Work <span><a href="#improving-my-work" aria-label="Anchor">#</a></span></h2><p>Over the weekend following my first post about Scrutiny, a couple of people identified some small issues and made pull requests to resolve them - thank you to those people! You can see their work
<a href="https://github.com/jnsgruk/nixos-config/pull/14" target="_blank" rel="noreferrer">here</a>,
<a href="https://github.com/jnsgruk/nixos-config/pull/17" target="_blank" rel="noreferrer">here</a> and
<a href="https://github.com/jnsgruk/nixos-config/pull/15" target="_blank" rel="noreferrer">here</a>. Someone also
<a href="https://toot.community/@bouk/111951919753119887" target="_blank" rel="noreferrer">pointed out</a> to me that string-interpolating YAML wasn’t the most ideal solution to rendering the configuration file, and the I could have used
<a href="https://nixos.org/manual/nix/stable/language/builtins.html#builtins-toJSON" target="_blank" rel="noreferrer"><code>builtins.toJSON</code></a>, taking advantage of the fact that JSON is also valid YAML.</p><p>I also wanted to make sure that there was a way for people to use the module with an existing InfluxDB deployment. My original implementation assumed that it could just add <code>services.influxdb2.enable = true</code> to the system configuration and use the default credentials to connect. I added
<a href="https://github.com/jnsgruk/nixos-config/blob/34d91414594d1e492b5a6dfe43514da01c594e83/modules/nixos/scrutiny.nix#L72-L126" target="_blank" rel="noreferrer">some options</a> to the module for configuring a different InfluxDB instance if required. These were later modified slightly to use <code>lib.types.nullOr lib.types.str</code> following a helpful
<a href="https://github.com/NixOS/nixpkgs/pull/289934#discussion_r1495476364" target="_blank" rel="noreferrer">review comment</a>.</p><p>Next up was refactoring the helper function I wrote for generating the configuration file. As mentioned above, Nix comes with a handy
<a href="https://nixos.org/manual/nix/stable/language/builtins.html#builtins-toJSON" target="_blank" rel="noreferrer"><code>builtins.toJSON</code></a> function which takes a native Nix expression (an
<a href="https://nixos.org/guides/nix-pills/basics-of-language#id1366" target="_blank" rel="noreferrer">attribute set</a> in this case) and renders it to JSON. This obviates the need to string-interpolate YAML, which is error prone at the best of times. The renewed function looked like this:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span><span>22
</span><span>23
</span><span>24
</span><span>25
</span><span>26
</span><span>27
</span><span>28
</span><span>29
</span><span>30
</span></code></pre></td><td><pre tabindex="0"><code data-lang="nix"><span><span><span>{</span>
</span></span><span><span>  <span>mkScrutinyCfg</span> <span>=</span> <span>cfg</span><span>:</span> <span>pkgs</span><span>.</span><span>writeTextFile</span> <span>{</span>
</span></span><span><span>    <span>name</span> <span>=</span> <span>&#34;scrutiny.yaml&#34;</span><span>;</span>
</span></span><span><span>    <span>text</span> <span>=</span> <span>builtins</span><span>.</span><span>toJSON</span> <span>{</span>
</span></span><span><span>      <span>version</span> <span>=</span> <span>1</span><span>;</span>
</span></span><span><span>      <span>web</span> <span>=</span> <span>{</span>
</span></span><span><span>        <span>listen</span> <span>=</span> <span>{</span>
</span></span><span><span>          <span>inherit</span> <span>(</span><span>cfg</span><span>)</span> <span>host</span> <span>port</span><span>;</span>
</span></span><span><span>          <span>basepath</span> <span>=</span> <span>if</span> <span>cfg</span><span>.</span><span>basepath</span> <span>!=</span> <span>&#34;&#34;</span> <span>then</span> <span>&#34;/&#34;</span> <span>+</span> <span>cfg</span><span>.</span><span>basepath</span> <span>else</span> <span>&#34;&#34;</span><span>;</span>
</span></span><span><span>        <span>};</span>
</span></span><span><span>
</span></span><span><span>        <span>database</span> <span>=</span> <span>{</span>
</span></span><span><span>          <span>location</span> <span>=</span> <span>&#34;/var/lib/scrutiny/scrutiny.db&#34;</span><span>;</span>
</span></span><span><span>        <span>};</span>
</span></span><span><span>
</span></span><span><span>        <span>src</span> <span>=</span> <span>{</span>
</span></span><span><span>          <span>frontend</span><span>.</span><span>path</span> <span>=</span> <span>&#34;</span><span>${</span><span>pkgs</span><span>.</span><span>scrutiny</span><span>}</span><span>/share/scrutiny&#34;</span><span>;</span>
</span></span><span><span>        <span>};</span>
</span></span><span><span>
</span></span><span><span>        <span>influxdb</span> <span>=</span> <span>{</span>
</span></span><span><span>          <span>inherit</span> <span>(</span><span>cfg</span><span>.</span><span>influxdb</span><span>)</span> <span>scheme</span> <span>host</span> <span>port</span> <span>token</span> <span>org</span> <span>bucket</span><span>;</span>
</span></span><span><span>          <span>tls</span><span>.</span><span>insecure_skip_verify</span> <span>=</span> <span>cfg</span><span>.</span><span>influxdb</span><span>.</span><span>tlsSkipVerify</span><span>;</span>
</span></span><span><span>        <span>};</span>
</span></span><span><span>      <span>};</span>
</span></span><span><span>      <span>log</span> <span>=</span> <span>{</span>
</span></span><span><span>        <span>level</span> <span>=</span> <span>cfg</span><span>.</span><span>logLevel</span><span>;</span>
</span></span><span><span>      <span>};</span>
</span></span><span><span>    <span>};</span>
</span></span><span><span>  <span>};</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>I also noticed that I had hard-coded the path to the binaries in the rendered systemd units. You might recall that each Nix package contains <code>meta</code> block, which adds information about the package such as the license, maintainer, etc. For each of the packages,
<a href="https://github.com/jnsgruk/nixos-config/commit/13b9a0e1d640266fe6b6b6eafad579152198d384" target="_blank" rel="noreferrer">I added</a> a <code>mainProgram</code> attribute which enables the use of something like <code>lib.getExe pkgs.scrutiny</code> rather than <code>${pkgs.scrutiny}/bin/scrutiny</code>.</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span><span>5
</span><span>6
</span><span>7
</span></code></pre></td><td><pre tabindex="0"><code data-lang="nix"><span><span><span>{</span>
</span></span><span><span>  <span># ...</span>
</span></span><span><span>  <span>meta</span> <span>=</span> <span>{</span>
</span></span><span><span>    <span>mainProgram</span> <span>=</span> <span>&#34;scrutiny&#34;</span><span>;</span>
</span></span><span><span>    <span># ...</span>
</span></span><span><span>  <span>};</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>Finally, I wanted to simplify the packaging of the Go programs slightly. In the previous post I used <code>buildPhase</code> to override the default build behaviour of the <code>buildGoModule</code> function. I later discovered the <code>subPackages</code> attribute, which enabled me to achieve the same effect without overriding the process manually. You can see the commit with all the changes
<a href="https://github.com/jnsgruk/nixos-config/commit/34d91414594d1e492b5a6dfe43514da01c594e83" target="_blank" rel="noreferrer">on Github</a>, but below is a (slightly modified) preview of the simplified collector derivation:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span></code></pre></td><td><pre tabindex="0"><code data-lang="nix"><span><span><span>{</span> <span>pkgs</span><span>,</span> <span>lib</span><span>,</span> <span>...</span> <span>}:</span>
</span></span><span><span><span>pkgs</span><span>.</span><span>buildGoModule</span> <span>rec</span> <span>{</span>
</span></span><span><span>    <span># (source, name, version, vendor hash omitted)</span>
</span></span><span><span>
</span></span><span><span>    <span>subPackages</span> <span>=</span> <span>&#34;collector/cmd/collector-metrics/collector-metrics.go&#34;</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>buildInputs</span> <span>=</span> <span>with</span> <span>pkgs</span><span>;</span> <span>[</span> <span>makeWrapper</span> <span>];</span>
</span></span><span><span>
</span></span><span><span>    <span>CGO_ENABLED</span> <span>=</span> <span>0</span><span>;</span>
</span></span><span><span>    <span>ldflags</span> <span>=</span> <span>[</span> <span>&#34;-extldflags=-static&#34;</span> <span>];</span>
</span></span><span><span>    <span>tags</span> <span>=</span> <span>[</span> <span>&#34;netgo&#34;</span> <span>&#34;static&#34;</span> <span>];</span>
</span></span><span><span>
</span></span><span><span>    <span>installPhase</span> <span>=</span> <span>&#39;&#39;
</span></span></span><span><span><span>      mkdir -p $out/bin
</span></span></span><span><span><span>      cp $GOPATH/bin/collector-metrics $out/bin/scrutiny-collector-metrics
</span></span></span><span><span><span>      wrapProgram $out/bin/scrutiny-collector-metrics \
</span></span></span><span><span><span>        --prefix PATH : </span><span>${</span><span>lib</span><span>.</span><span>makeBinPath</span> <span>[</span> <span>pkgs</span><span>.</span><span>smartmontools</span> <span>]</span><span>}</span><span>
</span></span></span><span><span><span>    &#39;&#39;</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span># (meta block omitted)</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="contributing-to-nixpkgs">Contributing To nixpkgs <span><a href="#contributing-to-nixpkgs" aria-label="Anchor">#</a></span></h2><p>With these changes made, it was time to open a pull request. The NixOS community provide some
<a href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md" target="_blank" rel="noreferrer">contributing guidelines</a> which are worth a read before you start.</p><p>There was a structural transition in the <code>pkgs</code> directory lately, so this was my first contribution under that new structure. There was a
<a href="https://media.ccc.de/v/nixcon-2023-35713-not-all-packages-anymore-nix" target="_blank" rel="noreferrer">detailed talk</a> about that transition at Nixcon if you’d like more information.</p><p>I needed to do the following:</p><ul><li>Create the <code>scrutiny</code> and <code>scrutiny-collector</code> packages</li><li>Add the <code>scrutiny</code> module</li><li>Add the tests</li><li>Update the release notes for the next release of NixOS</li></ul><p>Which translated into the following stack of commits on
<a href="https://github.com/NixOS/nixpkgs/pull/289934" target="_blank" rel="noreferrer">PR #289934</a>:</p><figure><a href="https://jnsgr.uk/2024/02/contributing-scrutiny-to-nixpkgs/01.png"><picture><source srcset="/2024/02/contributing-scrutiny-to-nixpkgs/01_hu6dd8b0424166e992d1aa16279c00df68_71685_330x0_resize_q75_h2_box_3.webp 330w,/2024/02/contributing-scrutiny-to-nixpkgs/01_hu6dd8b0424166e992d1aa16279c00df68_71685_660x0_resize_q75_h2_box_3.webp 660w
,/2024/02/contributing-scrutiny-to-nixpkgs/01_hu6dd8b0424166e992d1aa16279c00df68_71685_1014x450_resize_q75_h2_box_3.webp 1014w
,/2024/02/contributing-scrutiny-to-nixpkgs/01_hu6dd8b0424166e992d1aa16279c00df68_71685_1014x450_resize_q75_h2_box_3.webp 1014w" sizes="100vw" type="image/webp"/><img width="1014" height="450" alt="commits on nixpkgs pr" loading="lazy" decoding="async" src="https://jnsgr.uk/2024/02/contributing-scrutiny-to-nixpkgs/01_hu6dd8b0424166e992d1aa16279c00df68_71685_660x0_resize_box_3.png" srcset="/2024/02/contributing-scrutiny-to-nixpkgs/01_hu6dd8b0424166e992d1aa16279c00df68_71685_330x0_resize_box_3.png 330w,/2024/02/contributing-scrutiny-to-nixpkgs/01_hu6dd8b0424166e992d1aa16279c00df68_71685_660x0_resize_box_3.png 660w
,/2024/02/contributing-scrutiny-to-nixpkgs/01.png 1014w
,/2024/02/contributing-scrutiny-to-nixpkgs/01.png 1014w" sizes="100vw"/></picture></a></figure><p>There were a few other minor changes, such as how input packages (like <code>smartmontools</code> and <code>makeWrapper</code>) are passed to the packages. In the nixpkgs repository, packages are passed directly to the derivations, rather than <code>pkgs</code> being passed as a top-level argument and packages being referred to by <code>pkgs.smartmontools</code> etc.</p><p>I also learned something new about module configuration. In the first iteration I had set the default value of <code>services.scrutiny.collector.enable</code> to the value of <code>services.scrutiny.enable</code>, meaning that the collector would be enabled automatically when Scrutiny was enabled if no other configuration was specified. It transpires that this is not permitted in nixpkgs, and resulted in
<a href="https://github.com/NixOS/nixpkgs/actions/runs/7957910596/job/21721675050?pr=289934" target="_blank" rel="noreferrer">this CI failure</a>. I updated the module with a subtle API change, meaning that consumers of the module will now need to do the following to get the same behaviour.</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span><span>5
</span><span>6
</span></code></pre></td><td><pre tabindex="0"><code data-lang="nix"><span><span><span>{</span>
</span></span><span><span>  <span>services</span> <span>=</span> <span>{</span>
</span></span><span><span>    <span>scrutiny</span><span>.</span><span>enable</span> <span>=</span> <span>true</span><span>;</span>
</span></span><span><span>    <span>scrutiny</span><span>.</span><span>collector</span><span>.</span><span>enable</span> <span>=</span> <span>true</span><span>;</span>
</span></span><span><span>  <span>};</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="review-feedback">Review Feedback <span><a href="#review-feedback" aria-label="Anchor">#</a></span></h2><p>From the first review I learned about the
<a href="https://github.com/NixOS/nixpkgs/blob/c6aa0f73ec0204b16a7245c2b39679b5e11bd307/lib/types.nix#L632-L649" target="_blank" rel="noreferrer"><code>lib.types.nullOr</code></a> meta-type which enables the specification of optionally <code>null</code> configuration options in a NixOS module.</p><p>What followed was
<a href="https://github.com/NixOS/nixpkgs/pull/289934#pullrequestreview-1890026984" target="_blank" rel="noreferrer">a suggestion</a> to embrace a different configuration format according to
<a href="https://github.com/NixOS/rfcs/blob/master/rfcs/0042-config-option.md" target="_blank" rel="noreferrer">RFC42</a>: a proposal for structured module configuration which is more rigorously type checked, and more flexible as new options are added to the underlying workload.</p><p>Many NixOS modules solve this problem today with options like <code>extraConfig</code> or <code>configLines</code>, which append strings to the end of any options-generated configuration file. What RFC42 proposes is a hybrid approach whereby certain options are well-defined (and thus feature
<a href="https://search.nixos.org/options?channel=unstable&amp;from=0&amp;size=50&amp;sort=relevance&amp;type=packages&amp;query=services.scrutiny." target="_blank" rel="noreferrer">in the documentation</a>), but additional options can be injected as needed. The has the nice side-effect that modules do not need to support dozens of options which can become a burden to maintain and test over time, but consumers can still make use of new features and options that are introduced to the underlying workload.</p><p>You can see the full resulting options definition
<a href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/services/monitoring/scrutiny.nix" target="_blank" rel="noreferrer">on Github</a>, and small annotated excerpt below:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span><span>22
</span><span>23
</span><span>24
</span><span>25
</span><span>26
</span><span>27
</span><span>28
</span><span>29
</span><span>30
</span><span>31
</span><span>32
</span><span>33
</span><span>34
</span><span>35
</span><span>36
</span><span>37
</span><span>38
</span></code></pre></td><td><pre tabindex="0"><code data-lang="nix"><span><span><span>{</span>
</span></span><span><span>  <span>services</span><span>.</span><span>scrutiny</span> <span>=</span> <span>{</span>
</span></span><span><span>    <span>enable</span> <span>=</span> <span>lib</span><span>.</span><span>mkEnableOption</span> <span>&#34;Enables the scrutiny web application.&#34;</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span># ...</span>
</span></span><span><span>
</span></span><span><span>    <span>settings</span> <span>=</span> <span>lib</span><span>.</span><span>mkOption</span> <span>{</span>
</span></span><span><span>      <span>description</span> <span>=</span> <span>lib</span><span>.</span><span>mdDoc</span> <span>&#39;&#39;
</span></span></span><span><span><span>        Scrutiny settings to be rendered into the configuration file.
</span></span></span><span><span><span>
</span></span></span><span><span><span>        See https://github.com/AnalogJ/scrutiny/blob/master/example.scrutiny.yaml.
</span></span></span><span><span><span>      &#39;&#39;</span><span>;</span>
</span></span><span><span>
</span></span><span><span>      <span>default</span> <span>=</span> <span>{</span> <span>};</span>
</span></span><span><span>
</span></span><span><span>      <span># This is the key to RFC42 - defining `settings` as type `submodule`.</span>
</span></span><span><span>      <span>type</span> <span>=</span> <span>lib</span><span>.</span><span>types</span><span>.</span><span>submodule</span> <span>{</span>
</span></span><span><span>        <span># This ensures that attrsets, lists, etc. are rendered as JSON</span>
</span></span><span><span>        <span>freeformType</span> <span>=</span> <span>(</span><span>pkgs</span><span>.</span><span>formats</span><span>.</span><span>yaml</span> <span>{</span> <span>})</span><span>.</span><span>type</span><span>;</span>
</span></span><span><span>
</span></span><span><span>        <span># The following are examples of &#34;well-defined&#34; options with</span>
</span></span><span><span>        <span># formal types and metadata.</span>
</span></span><span><span>        <span>options</span><span>.</span><span>web</span><span>.</span><span>listen</span><span>.</span><span>port</span> <span>=</span> <span>lib</span><span>.</span><span>mkOption</span> <span>{</span>
</span></span><span><span>          <span>type</span> <span>=</span> <span>lib</span><span>.</span><span>types</span><span>.</span><span>port</span><span>;</span>
</span></span><span><span>          <span>default</span> <span>=</span> <span>8080</span><span>;</span>
</span></span><span><span>          <span>description</span> <span>=</span> <span>lib</span><span>.</span><span>mdDoc</span> <span>&#34;Port for web application to listen on.&#34;</span><span>;</span>
</span></span><span><span>        <span>};</span>
</span></span><span><span>
</span></span><span><span>        <span>options</span><span>.</span><span>web</span><span>.</span><span>listen</span><span>.</span><span>host</span> <span>=</span> <span>lib</span><span>.</span><span>mkOption</span> <span>{</span>
</span></span><span><span>          <span>type</span> <span>=</span> <span>lib</span><span>.</span><span>types</span><span>.</span><span>str</span><span>;</span>
</span></span><span><span>          <span>default</span> <span>=</span> <span>&#34;0.0.0.0&#34;</span><span>;</span>
</span></span><span><span>          <span>description</span> <span>=</span> <span>lib</span><span>.</span><span>mdDoc</span> <span>&#34;Interface address for web application to bind to.&#34;</span><span>;</span>
</span></span><span><span>        <span>};</span>
</span></span><span><span>
</span></span><span><span>        <span># ...</span>
</span></span><span><span>      <span>};</span>
</span></span><span><span>  <span>};</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>This enables the following user configurations:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span><span>22
</span></code></pre></td><td><pre tabindex="0"><code data-lang="nix"><span><span><span>{</span>
</span></span><span><span>  <span>services</span><span>.</span><span>scrutiny</span> <span>=</span> <span>{</span>
</span></span><span><span>    <span>enable</span> <span>=</span> <span>true</span><span>;</span>
</span></span><span><span>    <span>settings</span> <span>=</span> <span>{</span>
</span></span><span><span>      <span># These options are well-defined in the module with types,</span>
</span></span><span><span>      <span># examples, descriptions and are rendered in the docs.</span>
</span></span><span><span>      <span>web</span><span>.</span><span>listen</span> <span>=</span> <span>{</span>
</span></span><span><span>        <span>port</span> <span>=</span> <span>8080</span><span>;</span>
</span></span><span><span>        <span>host</span> <span>=</span> <span>&#34;100.64.12.34&#34;</span><span>;</span>
</span></span><span><span>      <span>};</span>
</span></span><span><span>
</span></span><span><span>      <span># These are not, but will be rendered still as JSON and enable</span>
</span></span><span><span>      <span># people to make use of options supported by Scrutiny, but</span>
</span></span><span><span>      <span># not directly by the module.</span>
</span></span><span><span>      <span>notify</span> <span>=</span> <span>{</span>
</span></span><span><span>        <span>urls</span> <span>=</span> <span>[</span>
</span></span><span><span>          <span>&#34;discord://token@channel&#34;</span>
</span></span><span><span>        <span>];</span>
</span></span><span><span>      <span>};</span>
</span></span><span><span>    <span>};</span>
</span></span><span><span>  <span>};</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>I was impressed by the simplicity of the approach, and subsequently adopted the same for the collector, which now has the ability to take configuration through the
<a href="https://github.com/NixOS/nixpkgs/blob/7713853c8624abf65e020ee7f07c081ac7dbf07b/nixos/modules/services/monitoring/scrutiny.nix#L127-L153" target="_blank" rel="noreferrer"><code>services.scrutiny.collector.settings</code></a> attribute.</p><p>One aspect of Scrutiny’s design that helped is the ability to take configuration either through from file, or through environment variables, or both! I chose to supply some fixed options
<a href="https://github.com/NixOS/nixpkgs/blob/7713853c8624abf65e020ee7f07c081ac7dbf07b/nixos/modules/services/monitoring/scrutiny.nix#L181-L185" target="_blank" rel="noreferrer">as environment variables</a> to the systemd services, and allow the rest of the configuration to be set using the generated file.</p><p><a href="https://github.com/JulienMalka" target="_blank" rel="noreferrer">@JulienMalka</a> reviewed next, suggesting changes to ensure that various <code>preInstall</code> and <code>postInstall</code> hooks were being called where I was overriding <code>installPhase</code>, though what followed from
<a href="https://github.com/katexochen" target="_blank" rel="noreferrer">@katexochen</a>’s review was a simplification that reduced this need slightly.</p><p><a href="https://github.com/katexochen" target="_blank" rel="noreferrer">@katexochen</a> suggested a couple of nice changes, among which was the ability to drop explicitly mentioning the <code>netgo</code> tag in the Go packages, since <code>CGO_ENABLED</code> is disabled already, this implies using the Go internal version of many libraries. They also
<a href="https://github.com/NixOS/nixpkgs/pull/289934#discussion_r1497170464" target="_blank" rel="noreferrer">suggested</a> moving the install of the frontend pieces to <code>postInstall</code>, rather than overriding the standard <code>installPhase</code>.</p><p>And finally
<a href="https://github.com/SuperSandro2000" target="_blank" rel="noreferrer">@SuperSandro2000</a> reviewed with some naming changes to simplify the package definitions and reduce repetition. I also noticed that I was unnecessarily declaring the <code>frontend</code> definition using the
<a href="https://nixos.org/manual/nix/stable/language/constructs.html#recursive-sets" target="_blank" rel="noreferrer"><code>rec</code> keyword</a>. Once these were fixed the PR was merged!</p><h2 id="contribution-tips">Contribution Tips <span><a href="#contribution-tips" aria-label="Anchor">#</a></span></h2><p>I’m still relatively new to this - you can see that my
<a href="https://github.com/NixOS/nixpkgs/commits?author=jnsgruk" target="_blank" rel="noreferrer">list of contributions</a> is not extensive, but I’ve been through the process of adding, updating and refining packages and modules a few times.</p><p>Take this advice for what it is, but I hope you find it helpful:</p><ol><li><strong>Read the
<a href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md" target="_blank" rel="noreferrer">contribution guidelines</a></strong>: This is probably the best start. Try to follow the guidance as best you can, and take a look at some other
<a href="https://github.com/NixOS/nixpkgs/pulls?q=is%3Apr+sort%3Aupdated-desc+is%3Aclosed" target="_blank" rel="noreferrer">recently closed Pull Requests</a> to see if you can pick up on any patterns.</li><li><strong>Be humble</strong>: Everyone is new when they start. You might find some reviews a little terse. Rest assured that this is only because the maintainers are incredibly busy. Assume good intentions, remain polite and respectful. Nixpkgs is one of the
<a href="https://github.com/NixOS/nixpkgs/pulse" target="_blank" rel="noreferrer">busiest Github repositories</a> I’ve seen, and it’s largely maintained by volunteers who often have limited time to give for a huge number of contributions.</li><li><strong>Be patient</strong>: Don’t expect a review immediately. If you’re looking for a preliminary review, feel free to ping me
<a href="https://jnsgr.uk/mastodon" target="_blank" rel="noreferrer">on Mastodon</a> and I’ll try to offer any guidance I can.</li><li><strong>Use the Discourse</strong>: Because of the volume of PRs, the community run ongoing “PRs Ready for Review” threads
<a href="https://discourse.nixos.org/c/dev/14" target="_blank" rel="noreferrer">on Discourse</a> which you can use to attract reviewers if your PR has been stale a while. It’s also a great place to
<a href="https://discourse.nixos.org/c/learn/9" target="_blank" rel="noreferrer">ask for help</a>.</li></ol><p>Once merged, commits trickle through the various branches of the repository. You can track the progress of your PR in that process once it’s merged using the
<a href="https://nixpk.gs/pr-tracker.html" target="_blank" rel="noreferrer">PR Tracker</a>. You can see an example of this by
<a href="https://nixpk.gs/pr-tracker.html?pr=289934" target="_blank" rel="noreferrer">tracking the Scrutiny PR</a>:</p><figure><a href="https://jnsgr.uk/2024/02/contributing-scrutiny-to-nixpkgs/03.png"><picture><source srcset="/2024/02/contributing-scrutiny-to-nixpkgs/03_hu72fb55dcaa240915eaee1045a2d5c6fc_34759_537x472_resize_q75_h2_box_3.webp" sizes="100vw" type="image/webp"/><img width="537" height="472" alt="nixpkgs pr tracker" loading="lazy" decoding="async" src="https://jnsgr.uk/2024/02/contributing-scrutiny-to-nixpkgs/03.png"/></picture></a></figure><h2 id="summary--thanks">Summary &amp; Thanks <span><a href="#summary--thanks" aria-label="Anchor">#</a></span></h2><p>My Scrutiny packages, module and tests landed in nixpkgs approximately 4 days after I submitted the pull request. As ever, I received a bunch of helpful reviews from the community, and Scrutiny is now easier than ever to consume on NixOS.</p><p>You can see the finished components here:</p><ul><li><a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/by-name/sc/scrutiny/package.nix" target="_blank" rel="noreferrer">scrutiny package</a></li><li><a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/by-name/sc/scrutiny-collector/package.nix" target="_blank" rel="noreferrer">scrutiny-collector package</a></li><li><a href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/services/monitoring/scrutiny.nix" target="_blank" rel="noreferrer">nixos module</a></li><li><a href="https://github.com/NixOS/nixpkgs/blob/master/nixos/tests/scrutiny.nix" target="_blank" rel="noreferrer">nixos test</a></li></ul><p>If you were previously using my flake to consume Scrutiny, you’ll now see a deprecation warning. To migrate over, import the module from <code>unstable</code> in your flake and ensure that you explicitly enable the collector:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span><span>5
</span><span>6
</span></code></pre></td><td><pre tabindex="0"><code data-lang="nix"><span><span><span>{</span>
</span></span><span><span>  <span>services</span> <span>=</span> <span>{</span>
</span></span><span><span>    <span>scrutiny</span><span>.</span><span>enable</span> <span>=</span> <span>true</span><span>;</span>
</span></span><span><span>    <span>scrutiny</span><span>.</span><span>collector</span><span>.</span><span>enable</span> <span>=</span> <span>true</span><span>;</span>
</span></span><span><span>  <span>};</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>Before I wrap up, I’d like to thank all those people who took the time to review the PR, and especially
<a href="https://github.com/JulienMalka" target="_blank" rel="noreferrer">@JulienMalka</a> and
<a href="https://github.com/RaitoBezarius" target="_blank" rel="noreferrer">@RaitoBezarius</a> who have helped me through countless contributions over the past months and been incredibly responsive to my questions.</p><p>Give it a go and let me know how you get on!</p></div></section></article></div>
  </body>
</html>
