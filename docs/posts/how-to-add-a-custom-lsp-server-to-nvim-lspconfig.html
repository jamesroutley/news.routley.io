<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ryanisaacg.com/code/nvim-lspconfig-custom-lsp/">Original</a>
    <h1>How to add a custom LSP server to nvim-lspconfig</h1>
    
    <div id="readability-page-1" class="page"><article>
        <p>Normally the <a href="https://github.com/neovim/nvim-lspconfig"><code>nvim-lspconfig</code> package</a> has every language server I could possibly want, so I’ve found it pretty low maintenance. Currently I’m testing out the server for my own programming language, and I needed to add the LSP to my editor’s config. It was a surprisingly annoying task! I wanted to share the little snippet I used to get it configured.</p>
<p>Briefly I considered forking <code>nvim-lspconfig</code> and adding my LSP’s config to the <code>lua/lsp/server_configurations/</code> folder, where all the official implementations live. I decided against because that seemed like an unnecessary hassle. Instead I searched out a way to do it from outside the plugin.</p>
<p>First I found <a href="https://github.com/neovim/nvim-lspconfig#example-custom-config">a Reddit thread</a> which linked to a header within the <code>nvim-lspconfig</code> readme. That header… does not appear in the readme. A bit of trawling through the Wayback Machine got me the <a href="https://web.archive.org/web/20210422212220/https://github.com/neovim/nvim-lspconfig#example-custom-config">snippet I wanted</a>!</p>
<pre is:raw=""><code><span><span>local</span><span> lspconfig </span><span>=</span><span> </span><span>require</span><span>&#39;lspconfig&#39;</span></span>
<span><span>local</span><span> configs </span><span>=</span><span> </span><span>require</span><span>&#39;lspconfig/configs&#39;</span></span>
<span><span>-- Check if it&#39;s already defined for when reloading this file.</span></span>
<span><span>if</span><span> </span><span>not</span><span> lspconfig.foo_lsp </span><span>then</span></span>
<span><span>  configs.foo_lsp </span><span>=</span><span> {</span></span>
<span><span>    default_config </span><span>=</span><span> {</span></span>
<span><span>      cmd </span><span>=</span><span> {</span><span>&#39;/home/ashkan/works/3rd/lua-language-server/run.sh&#39;</span><span>};</span></span>
<span><span>      filetypes </span><span>=</span><span> {</span><span>&#39;lua&#39;</span><span>};</span></span>
<span><span>      root_dir </span><span>=</span><span> </span><span>function</span><span>(</span><span>fname</span><span>)</span></span>
<span><span>        </span><span>return</span><span> lspconfig.util.</span><span>find_git_ancestor</span><span>(fname) </span><span>or</span><span> vim.loop.</span><span>os_homedir</span><span>()</span></span>
<span><span>      </span><span>end</span><span>;</span></span>
<span><span>      settings </span><span>=</span><span> {};</span></span>
<span><span>    };</span></span>
<span><span>  }</span></span>
<span><span>end</span></span>
<span><span>lspconfig.foo_lsp.</span><span>setup</span><span>{}</span></span></code></pre>
<p>But that snippet didn’t do anything. Ugh!</p>
<p>After some reading through <code>nvim-lspconfig</code>’s source code, I took a wild guess: <code>nvim-lspconfig</code> <a href="https://github.com/neovim/nvim-lspconfig/blob/master/lua/lspconfig.lua#L1">internally imports the config file</a> through <code>require(&#39;lspconfig.configs&#39;)</code>, but this snippet is using <code>require&#39;lspconfig/configs&#39;</code>. Could that possibly make a difference? The answer appears to be yes, because the following is what worked for me:</p>
<pre is:raw=""><code><span><span>require</span><span>(</span><span>&#39;lspconfig.configs&#39;</span><span>).my_custom_lsp </span><span>=</span><span> {</span></span>
<span><span>    default_config </span><span>=</span><span> {</span></span>
<span><span>        cmd </span><span>=</span><span> {</span><span>&#39;path/to/my/binary&#39;</span><span>},</span></span>
<span><span>        filetypes </span><span>=</span><span> {</span><span>&#39;filetype&#39;</span><span>};</span></span>
<span><span>        root_dir </span><span>=</span><span> </span><span>function</span><span>(</span><span>fname</span><span>)</span></span>
<span><span>            </span><span>return</span><span> lsp.util.</span><span>find_git_ancestor</span><span>(fname)</span></span>
<span><span>        </span><span>end</span><span>;</span></span>
<span><span>        settings </span><span>=</span><span> {};</span></span>
<span><span>    };</span></span>
<span><span>}</span></span></code></pre>
<p>Now all I have to do is write the rest of the language server—how hard could that be?</p>
    </article></div>
  </body>
</html>
