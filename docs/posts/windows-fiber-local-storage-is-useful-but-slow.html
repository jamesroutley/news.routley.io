<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://iangrunert.com//2025/08/04/fiber-local-storage-slow.html">Original</a>
    <h1>Windows Fiber Local Storage is Useful but Slow</h1>
    
    <div id="readability-page-1" class="page"><div aria-label="Content">
      <div>
        <article itemscope="" itemtype="http://schema.org/BlogPosting">

  

  <div itemprop="articleBody">
    <p>Raymond Chen posted a blog back in 2019 stating that <a href="https://devblogs.microsoft.com/oldnewthing/20191011-00/?p=102989">Fibers aren’t useful for much any more; there’s just one corner of it that remains useful for a reason unrelated to fibers</a>.</p>

<p>The regular Windows thread-local storage APIs like TlsAlloc don’t have a way an easy way to register a per-thread 
destructor to be able to clean up the memory. Blink gets around this with some crazy pragmas to manually insert a 
function to be called on each thread’s exit, <a href="https://source.chromium.org/chromium/chromium/src/+/main:base/threading/thread_local_storage_win.cc;l=38-48">thread_local_storage_win.cc</a>.</p>

<div><div><pre><code>// Thread Termination Callbacks.
// Windows doesn&#39;t support a per-thread destructor with its
// TLS primitives.  So, we build it manually by inserting a
// function to be called on each thread&#39;s exit.
// This magic is from http://www.codeproject.com/threads/tls.asp
// and it works for VC++ 7.0 and later.

// Force a reference to _tls_used to make the linker create the TLS directory
// if it&#39;s not already there.  (e.g. if __declspec(thread) is not used).
// Force a reference to p_thread_callback_base to prevent whole program
// optimization from discarding the variable.
</code></pre></div></div>

<p>Note that the linked forum post in the comment has bit-rotted, it can be viewed via the <a href="https://web.archive.org/">Wayback Machine</a> <a href="https://web.archive.org/web/20070921204540/https://www.codeproject.com/threads/tls.asp">Thread Local Storage - The C++ Way by Roland Schwarz</a>.</p>

<p>Why does Blink go to the trouble of this when fiber-local storage has the useful built-in destruction callback? Unfortunately 
<strong>FlsGetValue is around 2x slower than TlsGetValue on single threaded access</strong>, which is a wide enough performance 
differential to make it worthwhile to deal with the extra complexity.</p>

<p>Hopefully one day TlsAlloc will get a destruction callback, or FlsGetValue will catch up to TlsGetValue in performance. 
Feels like a low-priority for Microsoft though given it hasn’t happened within the past 20+ years since fiber-local 
storage launched, so you might want to use the less-useful but higher-performance TlsAlloc in your code.</p>

  </div>
</article>

      </div>
    </div></div>
  </body>
</html>
