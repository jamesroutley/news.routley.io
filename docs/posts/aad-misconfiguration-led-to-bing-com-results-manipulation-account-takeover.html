<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.wiz.io/blog/azure-active-directory-bing-misconfiguration">Original</a>
    <h1>AAD misconfiguration led to Bing.com results manipulation, account takeover</h1>
    
    <div id="readability-page-1" class="page"><div><h2><span></span><a id="executive-summary"></a>Executive summary</h2><ul><li><p>Wiz Research discovered a new attack vector in Azure Active Directory that exposed misconfigured applications to unauthorized access. </p></li><li><p>These misconfigurations are fairly popular, especially with Azure App Services and Azure Functions. Based on our scans, about 25% of multi-tenant applications turned out to be vulnerable. </p></li><li><p>We found several high-impact, vulnerable Microsoft applications. One of these apps is a content management system (CMS) that powers Bing.com and allowed us to not only modify search results, but also launch high-impact XSS attacks on Bing users. Those attacks could compromise users’ personal data, including Outlook emails and SharePoint documents. </p></li><li><p>All issues were reported to the MSRC team. It fixed the vulnerable applications, updated customer guidance, and patched some AAD functionality to reduce customer exposure. MSRC’s blog can be found <a href="https://msrc.microsoft.com/blog/2023/03/guidance-on-potential-misconfiguration-of-authorization-of-multi-tenant-applications-that-use-azure-ad/">here</a>.</p></li><li><p>To check whether your environment has been affected by this misconfiguration, please refer to the “Customer Remediation Guidelines” section of the blog.</p></li></ul><p><em>BingBang attack flow</em></p><h2><span></span><a id="introduction"></a><strong>Introduction</strong> </h2><p>From Amazon Cognito to Google Firebase or Microsoft Azure Active Directory, there are many cloud-based identity providers on the market serving various business needs. The complexity of each IdP facilitates misconfigurations, which can potentially be leveraged by threat actors to compromise organizations’ production environments. </p><p>In this blog post, we will demonstrate how Microsoft itself fell prey to AAD’s configuration challenges, and inadvertently exposed internal applications to external attackers. These applications allowed us to view and change various types of sensitive Microsoft data. In one particular case, we were able to manipulate search results on Bing.com and perform XSS attacks on Bing users, potentially exposing customers’ Office 365 data such as emails, chats, and documents. This blog will also provide details about the misconfigurations, and how to detect and mitigate them in your environment.</p><h2><span></span><a id="azure-active-directory-aad"></a><strong>Azure Active Directory (AAD)</strong> </h2><p>Microsoft offers its own SSO service in Azure, AAD, which is the most common authentication mechanism for apps created in Azure App Services or Azure Functions. AAD provides different types of account access: single-tenant, multi-tenant, personal accounts, or a combination of the latter two. Single-tenant applications only allow users from the same tenant to issue an OAuth token for the app. Multi-tenant applications on the other hand, allow any Azure tenant to issue an OAuth token for them. Therefore, app developers must inspect the tokens within their code and decide which user should be allowed to log in. </p><p>In the case of Azure App Services and Azure Functions, we see a textbook example of Shared Responsibility confusion. These managed services enable users to add an authentication function with the click of a button, a seemingly smooth process for the application owner. However, the service only ensures the token’s validity. It’s not clear to application owners that it’s their responsibility to validate the user’s identity via OAuth claims and provision access accordingly. </p><p>With single-tenant authentication, the impact is limited to the application’s tenant – all users from the same tenant could connect to the application. </p><p>But with multi-tenant applications, the exposure is as wide as it gets – without proper validation, any Azure user will be able to log in to the application.</p><div><p>Configuring tenancy in Azure App Services</p></div><p>This complicated architecture is not always evident to developers, and the responsibility to validate the end-users’ tokens is unclear. As a result, configuration and validation mistakes are quite prevalent. </p><p>Upon recognizing these issues and their potential impact, we started scanning the internet for exposed applications. The results surprised us: 25% of all the multi-tenant apps we scanned were vulnerable to authentication bypass.  </p><p>The following case study on the “Bing Trivia” application, which we have dubbed “#BingBang,” illustrates how Microsoft itself fell victim to misconfiguration pitfalls and exposed one of its most critical apps to any individual on the internet.</p><h2><span></span><a id="the-bingbang-case-study"></a><strong>The BingBang case study</strong> </h2><h3><span></span><a id="part-1--reconnaissance"></a><strong>Part 1 – Reconnaissance</strong> </h3><p>To measure how common this misconfiguration was, we started scanning Azure App Services and Azure Functions for exposed endpoints. The scan yielded many potentially vulnerable websites, so to narrow the scope of the research, we decided to focus on Microsoft’s own tenant. </p><p>We spotted several Microsoft apps, but the first domain that caught our eyes was <code>bingtrivia.azurewebsites.net</code>. Given Bing is a very popular product these days, anything related to it was of interest to us. To validate the exposure, we created a new user called “Wiz Research” in our own tenant and tried logging in to Bing Trivia with it.</p><div><p>Multi-tenant authentication allows any Azure user to issue an OAuth token</p></div><p>Even though we did not belong to the Microsoft tenant, we successfully logged in and landed on the Bing Trivia home page.  </p><p>We started to examine the page in front of us. At first glance it appeared a bit unremarkable –  just a simple CMS with lots of sections crammed into it. To determine whether the system was intentionally open, we needed to understand its purpose.</p><div><p>The Bing Trivia admin panel, after a successful login</p></div><p>Given the app was named “Bing Trivia”, we assumed it was intended for trivia content. However, upon browsing the app, we noticed several interesting sections related to core Bing content. One of these sections was the “Carousels” section, which contained a table with search result suggestions appearing on Bing. Another section showcased quizzes and background images, which appeared on the Bing.com homepage that same day. This raised the question – can this panel enable us to modify Bing’s search results?</p><div><p>Viewing the daily wallpaper in Bing Trivia</p></div><div><p>Viewing the same wallpaper on Bing.com</p></div><h3><span></span><a id="part-2--altering-search-results"></a><strong>Part 2 – Altering search results</strong> </h3><p>To verify our ability to control Bing search results, we selected a carousel in the CMS and slightly altered its content. We wanted to make a small change, which would be easy to revert. We chose the “best soundtracks” query, which returned a list of highly recommended movie soundtracks; we then proceeded to change the first item, “<em>Dune (2021)</em>,” to our personal favorite, “<em>Hackers (1995),</em>” and saved our edit.</p><div><p>Modifying the search result within Bing Trivia</p></div><p>To our surprise, our new result immediately appeared on Bing.com, complete with our new title, thumbnail, and arbitrary link! </p><div><p>Bing’s search results for the “best soundtracks” keywords</p></div><div><p>The movie “Dune” was replaced with the movie “Hackers”</p></div><p>This proved that we could control Bing’s search results, and as we would later confirm, this control extended to Bing’s homepage content as well. </p><p>In order to ascertain the breadth of the attack surface, we then decided to leverage this access and test XSS viability with a sample harmless payload. The payload also ran as expected, so we quickly reverted our changes and immediately reported our findings to Microsoft. </p><h3><span></span><a id="part-3--attacking-bing-users"></a><strong>Part 3 – Attacking Bing users</strong> </h3><p>While working with Microsoft on the report, we started investigating the impact of the XSS. We saw that Bing has a “Work” section that allows you to search your organizational directory; when inspecting this functionality, we realized it was based on the Office 365 API, with the <code>business.bing.com</code> hostname used by Bing for Office-related communications. </p><p>This really piqued our interest, since many organizations use Office 365 to store their most sensitive business data. One specific endpoint created JWT tokens for the Office 365 API, so we generated a new XSS payload via this endpoint:</p><div><p>Our XSS payload, issuing an Office 365 token on behalf of the user</p></div><p>We then tested this payload against our old injection point and retrieved a valid token from our “victim” user (in this case, our research account).</p><div><p>Victim view of the XSS attack – stealing the user’s Office 365 token</p></div><p>This token enabled us, as “the attacker”, to fetch the victim’s Office 365 data including Outlook emails, calendars, Teams messages, SharePoint documents, and OneDrive files. Here we can see the attacker’s computer, successfully reading emails from the victim’s inbox:</p><div><p>Attacker view of the XSS attack – reading the victim’s Outlook emails</p></div><p>A malicious actor with the same access could’ve hijacked the most popular search results with the same payload and leak sensitive data from millions of users. According to SimilarWeb, Bing is the 27th most visited website in the world, with over a billion pageviews per month – in other words, millions of users could’ve been exposed to malicious search results and Office 365 data theft.</p><div><p>Full BingBang attack flow</p></div><h2><span></span><a id="additional-vulnerable-applications"></a><strong>Additional vulnerable applications</strong> </h2><p>In addition to the Bing Trivia app, we found several other internal Microsoft apps with similar misconfigurations and exposure to anyone trying to log in: </p><p><strong><u>Mag News:</u></strong> A control panel for the MSN Newsletter, capable of sending arbitrary emails from a trusted Microsoft email to a huge audience.</p><p><strong><u>CNS API:</u></strong> An API for Microsoft’s Central Notification Service, capable of reading and sending internal notifications to Microsoft developers.</p><p><strong><u>Contact Center:</u></strong> An API for Microsoft’s Contact Center, controlling call center agents for Microsoft’s customer representatives.</p><p><strong><u>PoliCheck:</u></strong> “PoliCheck” is an internal Microsoft tool that is used to check for forbidden words in Microsoft code. This application was essentially the centralized database for PoliCheck rules. Rules include words in over 100 languages, ranging from profanity and slurs to geopolitically and legally controversial issues.</p><p><strong><u>Power Automate Blog:</u></strong> A WordPress admin panel, controlling a very active blog hosted on <code>powerautomate.microsoft.com</code>. This panel allowed us to create and edit posts with arbitrary HTML content, and publish them to a trusted Microsoft.com domain.</p><p><strong><u>COSMOS:</u></strong> A file management system, managing over 4 exabytes (!) of Microsoft’s internal files. COSMOS categorizes files by Microsoft divisions and teams, and enables in-app file listing, reading, and editing.</p><h2><span></span><a id="customer-remediation-guidelines"></a><strong>Customer remediation guidelines</strong> </h2><h3><span></span><a id="am-i-affected"></a><strong>Am I affected?</strong> </h3><p>The issues we identified in this research may affect any organization with Azure Active Directory applications that have been configured as multi-tenant but lack sufficient authorization checks.</p><p>Based on data from our scans, we assess that exposure is significantly more common across Azure App Service and Azure Functions applications, where validation responsibility is unclear to developers.  </p><h3><span></span><a id="how-do-i-detect-these-issues-in-my-environment"></a><strong>How do I detect these issues in my environment?</strong> </h3><p>Administrators can use the Azure Portal to query their AAD service principals and look for any that are configured to allow multi-tenant access. These should appear under “App Registrations” or the “Authentication” section of each application’s page. </p><p>It is also possible to use the Azure CLI to query for multi-tenant applications:</p><p>To verify whether the application is vulnerable or not, use your web browser to sign in to your app with a user from a different Azure tenant than your own. If this login is successful, and your app is not meant to be exposed to other Azure tenants, the app is vulnerable. </p><p>Wiz customers can use either <a href="https://app.wiz.io/graph#~(query~(type~(~&#39;SERVICE_ACCOUNT)~select~true~where~(aad_signInAudience~(EQUALS~(~&#39;AzureADMultipleOrgs~&#39;AzureADandPersonalMicrosoftAccount))~externalOwners~(IS_SET~false))~relationships~(~(type~(~(type~&#39;ACTING_AS~reverse~true))~with~(type~(~&#39;WEB_SERVICE)~select~true~relationships~(~(type~(~(type~&#39;EXPOSES))~with~(type~(~&#39;ENDPOINT)~select~true~where~(portValidationResult~(NOT_EQUALS~(~&#39;Closed)))))~(type~(~(type~&#39;CONTAINS~reverse~true))~with~(type~(~&#39;SUBSCRIPTION)~select~true))))))))">this query</a> to spot all their potentially vulnerable assets, or <a href="https://app.wiz.io/graph#~(query~(type~(~&#39;SERVICE_ACCOUNT)~select~true~where~(nativeType~(EQUALS~(~&#39;ServicePrincipal*2fApplication))~aad_signInAudience~(EQUALS~(~&#39;AzureADMultipleOrgs~&#39;AzureADandPersonalMicrosoftAccount))~externalOwners~(IS_SET~false))~relationships~(~(type~(~(type~&#39;ACTING_AS~reverse~true))~with~(type~(~&#39;WEB_SERVICE)~select~true~where~(nativeType~(EQUALS~(~&#39;Microsoft.Web*2fsites))~requiresAuth~(EQUALS~true))~relationships~(~(type~(~(type~&#39;EXPOSES))~with~(type~(~&#39;ENDPOINT)~select~true~where~(portValidationResult~(NOT_EQUALS~(~&#39;Closed)))))~(type~(~(type~&#39;CONTAINS~reverse~true))~with~(type~(~&#39;SUBSCRIPTION)~select~true))))))))">this query</a> to spot App Services and Functions specifically. We also recommend Wiz users to refer to <a href="https://docs.wiz.io/wiz-docs/docs/wiz-adv-2023-018">our customer advisory</a> for additional guidance. </p><h3><span></span><a id="how-can-i-resolve-these-issues"></a><strong>How can I resolve these issues?</strong> </h3><p>If your application doesn’t require multi-tenancy, simply go to your app’s page and <a href="https://learn.microsoft.com/en-us/azure/active-directory/develop/howto-modify-supported-accounts#change-the-application-registration-to-support-different-accounts">switch to single-tenant authentication</a>. </p><p>If you do need to grant external tenant access, you have multiple ways to remediate your exposure. </p><p>If your app needs to be available on a specific external tenant other than your own, you can <a href="https://learn.microsoft.com/en-us/azure/active-directory/develop/howto-restrict-your-app-to-a-set-of-users">require user assignment</a> or <a href="https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/7-secure-access-conditional-access">use conditional access policies</a>. </p><p>Otherwise, you will need to implement <a href="https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens#claims-based-authorization">claims-based authorization</a> logic by performing <a href="https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens#claims-in-access-tokens">token checks</a> within your application code. There is no one-size-fits-all solution, and you should consult with your engineering team to find the right solution for your app. However, it is recommended to consult the relevant <a href="https://github.com/Azure-Samples/active-directory-aspnetcore-webapp-openidconnect-v2/blob/master/2-WebApp-graph-user/2-3-Multi-Tenant/README.md#about-the-code">Microsoft documentation</a> beforehand. </p><h3><span></span><a id="how-can-i-know-if-this-issue-has-been-exploited"></a><strong>How can I know if this issue has been exploited?</strong> </h3><p>According to Microsoft, Azure Active Directory logs are insufficient to provide insight on past activity. The recommended solution is to view your application logs and look for any suspicious logins.</p><h2><span></span><a id="takeaways"></a><strong>Takeaways</strong> </h2><p>We see this issue as a case of cloud exposure. Cloud Service Providers allow users to expose many of their cloud resources externally with the click of a button. The same thing happened here, where users could check the wrong box and publicly expose their app by accident. </p><p>Moreover, users of Azure App Service and Azure Functions may not be fully aware of who is responsible for validating access tokens. Users who enable authentication via the Azure Portal may assume their application is fully secured. However, users must implement additional token validation and authentication in their application&#39;s code to ensure authentication security. </p><h2><span></span><a id="summary"></a><strong>Summary</strong></h2><p>In this blog we have covered real-world examples of OAuth misconfigurations, with a focus on Microsoft’s own applications. Based on what we found, we have concluded that this issue is both easily exploitable and severely impactful. This is why we urge anyone who owns multi-tenant apps to scan their environment with the guidelines provided above. </p><h2><span></span><a id="disclosure-timeline"></a><strong>Disclosure timeline</strong> </h2><ul><li><p><strong>Jan. 31, 2023</strong> – Wiz Research reported the Bing issue to MSRC </p></li><li><p><strong>Jan. 31, 2023</strong> – MSRC issues initial fix to Bing app </p></li><li><p><strong>Feb. 25, 2023</strong> – Wiz Research reported the other vulnerable applications to MSRC </p></li><li><p><strong>Feb. 27, 2023</strong> – MSRC starts issuing fixes for said applications </p></li><li><p><strong>Mar. 20, 2023</strong> – MSRC states that all the reported applications are now fixed </p></li><li><p><strong>Mar. 28, 2023</strong> – MSRC awards Wiz Research with $40,000 bug bounty </p></li><li><p><strong>Mar. 29, 2023</strong> – Public disclosure</p></li></ul><h2><span></span><a id="stay-in-touch"></a><strong>Stay in touch!</strong> </h2><p>Hi there! We are Hillai Ben-Sasson (<a href="https://twitter.com/hillai">@hillai</a>), Shir Tamari (<a href="https://twitter.com/shirtamari">@shirtamari</a>), Nir Ohfeld (<a href="https://twitter.com/nirohfeld">@nirohfeld</a>), Sagi Tzadik (<a href="https://twitter.com/sagitz_">@sagitz_</a>) and Ronen Shustin (<a href="https://twitter.com/ronenshh">@ronenshh</a>) from the Wiz Research Team. We are a group of veteran white-hat hackers with a single goal: to make the cloud a safer place for everyone. We primarily focus on finding new attack vectors in the cloud and uncovering isolation issues in cloud vendors. </p><p>We would love to hear from you! Feel free to contact us on Twitter or via email: research@wiz.io. </p></div></div>
  </body>
</html>
