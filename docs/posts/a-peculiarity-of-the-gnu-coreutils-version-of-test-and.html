<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/CoreutilsTestPeculiarity">Original</a>
    <h1>A peculiarity of the GNU Coreutils version of &#39;test&#39; and &#39;[&#39;</h1>
    
    <div id="readability-page-1" class="page"><div><h2>A peculiarity of the GNU Coreutils version of &#39;<code>test</code>&#39; and &#39;<code>[</code>&#39;</h2>

	<p><small>November 24, 2023</small></p>
</div><div><p>Famously, &#39;<code>[</code>&#39; is a program, not a piece of shell syntax, and it&#39;s
also known as &#39;<code>test</code>&#39; (<a href="https://utcc.utoronto.ca/~cks/space/blog/unix/V7TestAndBourneShell">which was the original name for it</a>). On many systems, this was and is
implemented by &#39;<code>[</code>&#39; being a hardlink to &#39;<code>test</code>&#39; (generally &#39;test&#39;
was the primary name for various reasons). However, <a href="https://infosec.exchange/@adb/111467421939302794">today I found
out that GNU Coreutils is an exception</a>. Although the
two names are built from the same source code (<a href="https://git.savannah.gnu.org/cgit/coreutils.git/tree/src/test.c">src/test.c</a>), they&#39;re
different binaries and the &#39;<code>[</code>&#39; binary is larger than the &#39;<code>test</code>&#39;
binary. What is ultimately going on here is a piece of &#39;<code>test</code>&#39;
behavior that I had forgotten about, that of the meaning of running
&#39;<code>test</code>&#39; with a single argument.</p>

<p><a href="https://pubs.opengroup.org/onlinepubs/9699919799/utilities/test.html">The POSIX specification for test</a> is
straightforward. A single argument is taken as a string, and the behavior
is the same as for -n, although POSIX phrases it differently:</p>

<blockquote><dl><dt><em>string</em></dt>
<dd>True if the string string is not the null string; otherwise,
false.</dd>
</dl>
</blockquote>

<p>The problem for GNU Coreutils is that GNU programs like to support
options like --help and --version. Support for these is specifically
disallowed for &#39;<code>test</code>&#39;, where &#39;<code>test --help</code>&#39; and &#39;<code>test --version</code>&#39;
must both be silently true. However, this is not disallowed by POSIX
for &#39;<code>[</code>&#39; if &#39;<code>[</code>&#39; is invoked without the closing &#39;<code>]</code>&#39;:</p>

<blockquote><pre>$ [ --version
[ (GNU coreutils) 9.1
[...]
$ [ foo
[: missing ‘]’
$ [ --version ] &amp;&amp; echo true
true
</pre>
</blockquote>

<p>As we can see here, invoking &#39;test&#39; as &#39;<code>[</code>&#39; without the closing
&#39;<code>]</code>&#39; as an argument is an error, and GNU Coreutils is thus allowed
to interpret the results of your error however it likes, including
making &#39;<code>[ --version</code>&#39; and so on work.</p>

<p>(There&#39;s <a href="https://git.savannah.gnu.org/cgit/coreutils.git/tree/src/test.c#n825">a comment about it in test.c</a>.)</p>

<p>The binary size difference is presumably because the &#39;<code>test</code>&#39; binary
omits the version and help text, along with the code to display it.
But if you look at <a href="https://git.savannah.gnu.org/cgit/coreutils.git/tree/src/test.c#n825">the relevant Coreutils test.c code</a>, the
relevant code isn&#39;t disabled with an #ifdef. Instead, LBRACKET is
#defined to 0 when compiling the &#39;<code>test</code>&#39; binary. So it seems that
modern C compilers are doing dead code elimination on the &#39;<code>if
(LBRACKET) { ...}</code>&#39; section, which is a well established optimization,
and then going on to notice that the called functions like &#39;<code>usage()</code>&#39;
are never invoked and dropping them from the binary. Possibly this is
set with some special link time magic flags.</p>

<p>PS: This handling of a single argument for <code>test</code> goes all the way
back to V7, <a href="https://utcc.utoronto.ca/~cks/space/blog/unix/TestIsQuiteSmart">where <code>test</code> was actually pretty smart</a>. If I&#39;m reading <a href="https://www.tuhs.org/cgi-bin/utree.pl?file=V7/usr/man/man1/test.1">the V7 test(1) manual
page</a>
correctly, this behavior was also documented.</p>

<p>PPS: In theory <a href="https://www.gnu.org/software/coreutils/">GNU Coreutils</a>
is portable and you might find it on any Unix. In practice I believe
it&#39;s only really used on Linux.</p>
</div></div>
  </body>
</html>
