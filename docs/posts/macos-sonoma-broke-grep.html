<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://developer.apple.com/forums/thread/738862">Original</a>
    <h1>macOS Sonoma Broke Grep</h1>
    
    <div id="readability-page-1" class="page"><div id="main-content">
      <nav aria-label="Developer Forums">
  <a href="https://developer.apple.com/forums/">
    <span>Developer</span> Forums
  </a>

  <div>
    <div>
      

<form action="/forums/search/" method="GET" data-action="search-form" role="search" aria-label="Developer Forums" novalidate="novalidate">

  <label for="search-forums-1">Search by keywords or tags</label>

  

  

  

  
    



  

  

</form>

    </div>
  </div>
  

  <div>
    

<form action="/forums/search/" method="GET" data-action="search-form" role="search" aria-label="Developer Forums" novalidate="novalidate">

  <label for="search-forums-2">Search by keywords or tags</label>

  

  

  

  
    



  

  

</form>

  </div>
</nav>


      
    <main class="page" role="main">
      
        
        
          <div id="question-container" data-action="data-container" data-op="cstrahan" data-contributors="eskimo,endecotp,cstrahan,cstrahan,cstrahan,endecotp,">
            

<section role="article" aria-label="Thread post" data-post-id="738862021" id="738862021" data-post-type="QUESTION" data-action="content-post" aria-labelledby="replyname-738862021" aria-describedby="post-status-738862021
    
      
    ">
  
  
    
  
  
    
                
                  
                    
                  
                

                

  


  
    
      
        
          
            
              
            
          
        
      
    
  




                

  


  
    
      
        
          
            
              
            
          
        
      
    
  




              
  
  <div>
    <div>
      <div>
        <div data-post-id="738862021" tabindex="-1" data-post-type="QUESTION" data-action="content-post-body-content">
          
            <p><code>grep</code> is broken on Sonoma:</p>
<pre><code>printf &#39;%s&#39; &#39;3.2.57(1)-release&#39; | grep -o &#39;[0-9.]*&#39;
Assertion failed: (advance &gt; 0), function procline, file util.c, line 732.
zsh: done       printf &#39;%s&#39; &#39;3.2.57(1)-release&#39; | 
zsh: abort      grep -o &#39;[0-9.]*&#39;
</code></pre>
<p>For minimal reproducers, see:</p>
<pre><code># fails
printf &#39;%s&#39; &#39;a&#39; | grep -o &#39;b*&#39;

# works
printf &#39;%s&#39; &#39;a&#39; | grep -o &#39;b&#39;

# also works (note: without -o flag)
printf &#39;%s&#39; &#39;a&#39; | grep &#39;b*&#39;
</code></pre>
<p>This is the source for the assertion: <a href="https://github.com/apple-oss-distributions/text_cmds/blob/c0780aa3432383e0acde7dc7cf42972716925de6/grep/util.c#L732" rel="nofollow nofollow noopener noreferrer" target="blank">https://github.com/apple-oss-distributions/text_cmds/blob/c0780aa3432383e0acde7dc7cf42972716925de6/grep/util.c#L732</a></p>
<p>For posterity:</p>
<pre><code>				/*
				 * rdar://problem/86536080 - if our first match
				 * was 0-length, we wouldn&#39;t progress past that
				 * point.  Incrementing nst here ensures that if
				 * no other pattern matches, we&#39;ll restart the
				 * search at one past the 0-length match and
				 * either make progress or end the search.
				 */
				if (pmatch.rm_so == pmatch.rm_eo) {
					if (MB_CUR_MAX &gt; 1) {
						wchar_t wc;
						int advance;

						advance = mbtowc(&amp;wc,
						    &amp;pc-&gt;ln.dat[nst],
						    MB_CUR_MAX);

						assert(advance &gt; 0);
						nst += advance;
					} else {
						nst++;
					}
				}
</code></pre>
<p>It looks like the macOS devs tried to fix one thing but broke another.</p>
<p>I would update rdar://problem/86536080, but it looks like that&#39;s internal to Apple.</p>
          
        </div>
        
        
          
        
        
        
      </div>
    </div>

    
  </div>

  
    
  

  

  

  


</section>

          </div>
        
        
          <div role="region" aria-labelledby="answers-title" id="answers-list">
            
            
              <h2 id="answers-title">Replies</h2>
            
            
              

<section role="article" data-post-id="767216022" id="767216022" data-post-type="ANSWER" data-action="content-post" aria-labelledby="replyname-767216022" aria-describedby="post-status-767216022
    
      
    ">
  
  
  
    
                  
                    
                      
                    
                  
                
  
  <div>
    <div>
      <div>
        <div data-post-id="767216022" tabindex="-1" data-post-type="ANSWER" data-action="content-post-body-content">
          
            <blockquote>
<p>I would update … 86536080 … but it looks like that&#39;s internal to
Apple.</p>
</blockquote>
<p>Right.  I’d appreciate you <a href="https://developer.apple.com/forums/thread/712889" rel="nofollow nofollow noopener noreferrer" target="blank">filing your own bug</a> about this, including all the info you mentioned above.  Please post your bug number, just for the record.</p>
<p>Share and Enjoy</p>
          
        </div>
        
        
        
        
          
        
      </div>
    </div>

    
  </div>

  

  

  

  


</section>

            
              

<section role="article" data-post-id="767248022" id="767248022" data-post-type="ANSWER" data-action="content-post" aria-labelledby="replyname-767248022" aria-describedby="post-status-767248022
    
      
    ">
  
  
  
    
                  
                    
                      
                    
                  
                
  
  <div>
    <div>
      <div>
        <div data-post-id="767248022" tabindex="-1" data-post-type="ANSWER" data-action="content-post-body-content">
          
            <p>Works for me:</p>
<pre><code>% printf &#39;%s&#39; &#39;3.2.57(1)-release&#39; | grep -o &#39;[0-9.]*&#39;
3.2.57
1
</code></pre>
<p>Is there something unusual about your locale, or some environment variable, or something?</p>
<pre><code>% grep --version
grep (BSD grep, GNU compatible) 2.6.0-FreeBSD
% uname -a
Darwin xxxx 23.0.0 Darwin Kernel Version 23.0.0: Fri Sep 15 14:41:34 PDT 2023; root:xnu-10002.1.13~1/RELEASE_ARM64_T8103 arm64
</code></pre>
          
        </div>
        
        
        
        
          
        
      </div>
    </div>

    
  </div>

  

  

  

  


</section>

            
              

<section role="article" data-post-id="768047022" id="768047022" data-post-type="ANSWER" data-action="content-post" aria-labelledby="replyname-768047022" aria-describedby="post-status-768047022
    
      
    ">
  
  
  
    
                  
                    
                      
                    
                  
                
  
  <div>
    <div>
      <div>
        <div data-post-id="768047022" tabindex="-1" data-post-type="ANSWER" data-action="content-post-body-content">
          
            <p>Okay... I guess comments on replies don&#39;t get formatted, so reposting here:</p>
<p>I don&#39;t think there&#39;s anything unusual about my environment, nor locale:</p>
<pre><code>% locale
LANG=&#34;en_US.UTF-8&#34;
LC_COLLATE=&#34;en_US.UTF-8&#34;
LC_CTYPE=&#34;en_US.UTF-8&#34;
LC_MESSAGES=&#34;en_US.UTF-8&#34;
LC_MONETARY=&#34;en_US.UTF-8&#34;
LC_NUMERIC=&#34;en_US.UTF-8&#34;
LC_TIME=&#34;en_US.UTF-8&#34;
LC_ALL=
</code></pre>
<p>Note that the problem goes away if you specify a locale that does not support multibyte characters (i.e. where MB_CUR_MAX=1):</p>
<pre><code>% printf &#39;%s&#39; &#39;a&#39; | LANG=C grep -o &#39;b*&#39;
</code></pre>
<p>vs</p>
<pre><code>% printf &#39;%s&#39; &#39;a&#39; | LANG=&#34;en_US.UTF-8&#34; grep -o &#39;b*&#39;
Assertion failed: (advance &gt; 0), function procline, file util.c, line 732.
[1]    20179 done       printf &#39;%s&#39; &#39;a&#39; |
       20180 abort      LANG=&#34;en_US.UTF-8&#34; ./grep-debug -o &#39;b*&#39;
</code></pre>
          
        </div>
        
        
        
        
          
        
      </div>
    </div>

    
  </div>

  

  

  

  


</section>

            
              

<section role="article" data-post-id="768005022" id="768005022" data-post-type="ANSWER" data-action="content-post" aria-labelledby="replyname-768005022" aria-describedby="post-status-768005022
    
      
    ">
  
  
  
    
                  
                    
                      
                    
                  
                
  
  <div>
    <div>
      <div>
        <div data-post-id="768005022" tabindex="-1" data-post-type="ANSWER" data-action="content-post-body-content">
          
            <p>Here&#39;s the bug.</p>
<p>Let&#39;s use this example:</p>
<pre><code>% printf &#39;%s&#39; &#39;a&#39; | grep -o &#39;b*&#39;
</code></pre>
<p>The code from earlier:</p>
<pre><code>				/*
				 * rdar://problem/86536080 - if our first match
				 * was 0-length, we wouldn&#39;t progress past that
				 * point.  Incrementing nst here ensures that if
				 * no other pattern matches, we&#39;ll restart the
				 * search at one past the 0-length match and
				 * either make progress or end the search.
				 */
				if (pmatch.rm_so == pmatch.rm_eo) {
					if (MB_CUR_MAX &gt; 1) {
						wchar_t wc;
						int advance;

						advance = mbtowc(&amp;wc,
						    &amp;pc-&gt;ln.dat[nst],
						    MB_CUR_MAX);

						assert(advance &gt; 0);
						nst += advance;
					} else {
						nst++;
					}
				}
</code></pre>
<p>Here&#39;s the problem: <code>pc-&gt;ln.dat</code> is the string for the current line. <code>nst</code> is an offset into that string. Note that this code is enclosed in a loop. The first time around that loop, <code>pc-&gt;ln.dat</code> is &#34;a&#34;, and <code>nst</code> is <code>0</code>. Thus <code>&amp;pc-&gt;ln.dat[nst]</code> is effectively <code>&#34;a&#34;</code>. <code>mbtowc</code> returns <code>1</code> as we would expect.</p>
<p>The loop iterates, and now <code>pc-&gt;ln.dat</code> is still <code>&#34;a&#34;</code>, but <code>nst</code> is <code>1</code>, so <code>&amp;pc-&gt;ln.dat[nst]</code> is <code>&#34;&#34;</code> (the empty string). When <code>mbtowc</code> is given a pointer to a null char (as we have here), it returns <code>0</code>. Given that, the assertion now fails.</p>
<p>The problem can be state in one of two ways:</p>
<ol><li>The loop should have exited early after the first iteration (or at least changed the local match state so that we don&#39;t arrive at the aforementioned code block), <em>or</em></li><li>The code block should be amended so that we neither try to read at nor past the terminating null char.</li></ol>
<p>For option 2, something like this -- as I have tested by compiling Apple&#39;s <code>grep</code> from source -- would suffice:</p>
<pre><code>diff --git a/grep/util.c b/grep/util.c
index f362f97..ab3aec1 100644
--- a/grep/util.c
+++ b/grep/util.c
@@ -691,7 +691,7 @@ procline(struct parsec *pc)
 #ifdef __APPLE__
                                        /* rdar://problem/86536080 */
                                        if (pmatch.rm_so == pmatch.rm_eo) {
-                                               if (MB_CUR_MAX &gt; 1) {
+                                               if (MB_CUR_MAX &gt; 1 &amp;&amp; nst &lt; pc-&gt;ln.len) {
                                                        wchar_t wc;
                                                        int advance;
 
@@ -721,7 +721,7 @@ procline(struct parsec *pc)
                                 * either make progress or end the search.
                                 */
                                if (pmatch.rm_so == pmatch.rm_eo) {
-                                       if (MB_CUR_MAX &gt; 1) {
+                                       if (MB_CUR_MAX &gt; 1 &amp;&amp; nst &lt; pc-&gt;ln.len) {
                                                wchar_t wc;
                                                int advance;
</code></pre>
<p>To restate the problem: the latest <code>grep</code> on macOS indexes into the current string out of bounds, and the only reason the error isn&#39;t more catastrophic is because <code>grep</code> terminates the current line buffer with an additional null character (which is <em>not</em> part of the original input file), which just so happens to tickle an <code>assert</code> that checks how many bytes wide the current character (which is <em>outside</em> of the string!) is.</p>
          
        </div>
        
        
        
        
          
        
      </div>
    </div>

    
  </div>

  

  

  

  


</section>

            
              

<section role="article" data-post-id="768054022" id="768054022" data-post-type="ANSWER" data-action="content-post" aria-labelledby="replyname-768054022" aria-describedby="post-status-768054022
    
      
    ">
  
  
  
    
                  
                    
                      
                    
                  
                
  
  <div>
    <div>
      <div>
        <div data-post-id="768054022" tabindex="-1" data-post-type="ANSWER" data-action="content-post-body-content">
          
            <p>Actually, my &#34;fix&#34; from earlier isn&#39;t quite right -- the line (from whatever input file) could have null chars in it, and <code>grep</code> ought to handle that gracefully instead of exploding (GNU grep handles this just fine). But we see:</p>
<pre><code>% printf &#39;\0&#39; | LANG=&#34;en_US.UTF-8&#34; grep -o &#39;b*&#39;
Assertion failed: (advance &gt; 0), function procline, file util.c, line 732.
[1]    24086 done       printf &#39;\0&#39; |
       24087 abort      LANG=&#34;en_US.UTF-8&#34; ./grep-debug -o &#39;b*&#39;
</code></pre>
<p>Same sort of result, but now the <code>&#39;\0&#39;</code> char is coming from the input, rather than the line buffer&#39;s terminal <code>&#39;\0&#39;</code>.</p>
<p>So maybe something like so:</p>
<pre><code>diff --git a/grep/util.c b/grep/util.c
index f362f97..1689061 100644
--- a/grep/util.c
+++ b/grep/util.c
@@ -691,7 +691,7 @@ procline(struct parsec *pc)
 #ifdef __APPLE__
                                        /* rdar://problem/86536080 */
                                        if (pmatch.rm_so == pmatch.rm_eo) {
-                                               if (MB_CUR_MAX &gt; 1) {
+                                               if (MB_CUR_MAX &gt; 1 &amp;&amp; nst &lt; pc-&gt;ln.len &amp;&amp; pc-&gt;ln.dat[nst] != &#39;\0&#39;) {
                                                        wchar_t wc;
                                                        int advance;
 
@@ -721,7 +721,7 @@ procline(struct parsec *pc)
                                 * either make progress or end the search.
                                 */
                                if (pmatch.rm_so == pmatch.rm_eo) {
-                                       if (MB_CUR_MAX &gt; 1) {
+                                       if (MB_CUR_MAX &gt; 1 &amp;&amp; nst &lt; pc-&gt;ln.len &amp;&amp; pc-&gt;ln.dat[nst] != &#39;\0&#39;) {
                                                wchar_t wc;
                                                int advance;
</code></pre>
          
        </div>
        
        
        
        
          
        
      </div>
    </div>

    
  </div>

  

  

  

  


</section>

            
              

<section role="article" data-post-id="768158022" id="768158022" data-post-type="ANSWER" data-action="content-post" aria-labelledby="replyname-768158022" aria-describedby="post-status-768158022
    
      
    ">
  
  
  
    
                  
                    
                      
                    
                  
                
  
  <div>
    <div>
      <div>
        <div data-post-id="768158022" tabindex="-1" data-post-type="ANSWER" data-action="content-post-body-content">
          
            <blockquote>
<p>Works for me:</p>
</blockquote>
<p>On further investigation, it works for me when I ssh to my Mac. In this case, ssh sets LANG from the client to en_GB.utf8. But when I run the same command in the Mac terminal, it fails as it does for you. In this case, LANG is set to en_GB.UTF-8. Note different capitalisation and hyphenation.</p>
<p>Is the code that you are looking at conditional on UTF-8?</p>
          
        </div>
        
        
        
        
          
        
      </div>
    </div>

    
  </div>

  

  

  

  


</section>

            
          </div>
        
        
        
        
      
      

      
      
        
          

        
      
    </main>
  
    </div></div>
  </body>
</html>
