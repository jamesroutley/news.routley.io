<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mullvad.net/en/blog/2023/9/13/bug-in-macos-14-sonoma-prevents-our-app-from-working/">Original</a>
    <h1>Bug in macOS 14 Sonoma prevents our app from working</h1>
    
    <div id="readability-page-1" class="page"><div>
        <p>The macOS 14 Sonoma betas and release candidate contain a bug that causes the firewall to not filter traffic correctly. As a result, our app does not work.</p>

<p>During the macOS 14 Sonoma beta period Apple introduced a bug in the macOS firewall, packet filter (PF). This bug prevents our app from working, and can result in leaks when some settings (e.g. local network sharing) are enabled. We cannot guarantee functionality or security for users on macOS 14, we have investigated this issue after the 6th beta was released and reported the bug to Apple. Unfortunately the bug is still present in later macOS 14 betas and the release candidate.</p>

<p>We have evaluated whether we can patch our VPN app in such a way that it works and keeps users secure in macOS 14. But unfortunately there is no good solution, as far as we can tell. We believe the firewall bugs must be fixed by Apple.</p>

<p>The bug affects much more than just the Mullvad VPN app. Firewall rules do not get applied properly to network traffic, and traffic that is not supposed to be allowed is allowed. We deem this to be a critical flaw in the firewall, anyone relying on PF filtering, or apps using it in the background on their macOS devices should be cautious about upgrading to macOS 14.</p>

<h2>Our recommendations</h2>

<p>MacOS 14 Sonoma is scheduled to be released on the 26th of September, if the bug is still present we recommend our users to remain on macOS 13 Ventura until it is fixed.</p>

<h2>Technical details</h2>

<p>The following steps can be taken on macOS 14 to reproduce the issue. Warning: This will clear out any firewall rules you might have loaded in PF.</p>

<p>In a terminal, create a virtual logging interface and start watching it for traffic matching the rules you will add later:</p>

<pre>sudo ifconfig pflog1 create
sudo tcpdump -nnn -e -ttt -i pflog1</pre>

<p>Write the following firewall rules to a file named <code>pfrules</code>:</p>

<pre>pass quick log (all, to pflog1) inet from any to 127.0.0.1
block drop quick log (all, to pflog1)</pre>

<p>In another terminal, enable PF and load the rules:</p>

<pre>sudo pfctl -e
sudo pfctl -f pfrules</pre>

<p>Ping the <a href="https://mullvad.net">mullvad.net</a> webserver:</p>

<pre>ping 45.83.223.209</pre>

<h3>Expected results</h3>

<ul>
	<li>Ping is blocked, since it does not match the only <code>pass</code> ruleâ€™s requirements</li>
	<li>The traffic is logged to <code>pflog1</code>. More specifically we expect it to be logged as matching the <code>block</code> rule</li>
</ul>

<h3>Actual results</h3>

<ul>
	<li>Ping is allowed out on the internet, and the response comes back</li>
	<li>No traffic is being logged to <code>pflog1</code></li>
</ul>

<h3>Cleaning up after the experiment</h3>

<p>Disable the firewall and clear all rules.</p>

<pre>sudo pfctl -d
sudo pfctl -f /etc/pf.conf</pre>

<p>Follow our blog for future updates to this issue.</p>
        </div></div>
  </body>
</html>
