<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://dawidpotocki.com/en/2023/01/13/msi-insecure-boot/">Original</a>
    <h1>MSI&#39;s (in)Secure Boot</h1>
    
    <div id="readability-page-1" class="page"><div id="main">
        

<article>
  
  <p><time datetime="2023-01-13">
      posted on 2023-01-13 (UTC)
    </time>
  </p>

  <p>I guess I have found a reason to write my first blog post.</p>
<p>Before we start, maybe I will quickly explain what Secure Boot is. It is
a security feature, which allows our computer to decline booting
operating systems that have not been signed by a key that the firmware
trusts.</p>
<p>On 2022-12-11, I decided to setup Secure Boot on my new desktop with a
help of <a href="https://github.com/Foxboron/sbctl">sbctl</a>. Unfortunately I have
found that my firmware was… accepting every OS image I gave it, no
matter if it was trusted or not. It wasn&#39;t the first time that I have
been self-signing Secure Boot, I wasn&#39;t doing it wrong.</p>
<p>As I have later discovered on 2022-12-16, it wasn&#39;t just broken
firmware, MSI had changed their Secure Boot defaults to allow booting on
security violations(!!).</p>
<p>This can be changed by going to the place where the settings are for
Secure Boot on your motherboard. In my case it&#39;s in <code>Security\Secure Boot</code>. From this place, we can see a menu called &#34;Image Execution
Policy&#34;, which is the culprit.</p>
<p><img src="https://dawidpotocki.com/img/blog/msi-insecure-boot/firmware0.webp" alt="Firmware Screenshot 0"/></p>
<p>When we enter the menu, we can see the disappointing default settings.
It&#39;s doing no verification. It&#39;s useless. It&#39;s just there to satisfy
Windows 11 requirements. OS has no idea that Secure Boot is doing
nothing, it just knows that it&#39;s &#34;enabled&#34;.</p>
<p><img src="https://dawidpotocki.com/img/blog/msi-insecure-boot/firmware1.webp" alt="Firmware Screenshot 1"/></p>
<p>To change the settings to something saner, we have to change &#34;Always
Execute&#34; to &#34;Deny Execute&#34; for &#34;Removable Media&#34; and &#34;Fixed Media&#34;.
What&#39;s funny is that &#34;Allow Execute&#34; and &#34;Query User&#34; options
<a href="https://github.com/tianocore/edk2/blob/9ce09870e721efacc41fa7ee684e9e299f120350/SecurityPkg/SecurityPkg.dec#L267-L278">are breaking UEFI specification</a>,
though I&#39;m not really sure what&#39;s the difference between &#34;Allow Execute&#34;
and &#34;Always Execute&#34;.</p>
<p>We can also change &#34;Option ROM&#34;, about which you can read more about
here:</p>
<ul>
<li><a href="https://github.com/Foxboron/sbctl/wiki/FAQ#option-rom">https://github.com/Foxboron/sbctl/wiki/FAQ#option-rom</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows-hardware/manufacture/desktop/uefi-validation-option-rom-validation-guidance">https://learn.microsoft.com/en-us/windows-hardware/manufacture/desktop/uefi-validation-option-rom-validation-guidance</a></li>
</ul>
<p><img src="https://dawidpotocki.com/img/blog/msi-insecure-boot/firmware2.webp" alt="Firmware Screenshot 2"/></p>
<p>Case closed, everyone can move on, right?</p>
<p>Well, not really. I needed to figure out if this is only affecting my
motherboard or also other models and maybe even other vendors. And also
we need to document this, because even if I know this, there is probably
a lot of people that are not aware about this issue.</p>
<p>I had asked 2 users of B450 TOMAHAWK MAX (thanks Sage Hane and Daniel
Nathan Gray) to check their firmware and what? Unsurprisingly, it&#39;s also
there. We were able to determine that version <code>7C02v3C</code> from 2022-01-18
introduced this issue.</p>
<p><em>EDIT: I have noticed that some websites have misreported about this
issue because they have not fully read my article. This firmware version
only affects B450 TOMAHAWK MAX, other motherboards have different
versions. <code>7C02</code> in the version is the codename for B450 TOMAHAWK MAX.
More information is available down below.</em></p>
<p>Is it mentioned in the changelog? Hah, nope.</p>
<p><img src="https://dawidpotocki.com/img/blog/msi-insecure-boot/firmware3.webp" alt="Firmware Screenshot 3"/></p>
<p>I have also received information from a user of B550-A PRO (CEC) (thanks
Joseph Richey) that they have this issue from <code>7C56vH1</code> (2021-12-20)
onwards.</p>
<p>While I was able to extrapolate this information to guess which versions
for other boards have introduced this issue, that isn&#39;t really enough.
We need to go deeper.</p>
<p>I have tried extracting some information from MSI&#39;s binary firmware
files, but to no avail. I tried using binwalk, UEFITool and others, but
I didn&#39;t really find what I wanted. Until one day I have found out that
UEFI has a thing called &#34;UEFI Internal Form Representation&#34; or in short
&#34;IFR&#34;. It&#39;s a way to describe firmware configuration options. This is
exactly what I need to look for! Now, what do I do with this knowledge?</p>
<p>Once we extract files from the firmware using UEFIExtract from
<a href="https://github.com/LongSoft/UEFITool">UEFITool</a> project, we can find a
file called
<code>Section_PE32_image_899407D7-99FE-43D8-9A21-79EC328CAC21_Setup_body.bin</code>.
It contains most of UEFI GUI stuff and seems to be available on all
firmware from all major desktop motherboard makers, though ASUS decided
to remove &#34;Setup&#34; from the name for some reason or maybe it has to do
something to do with the UEFIExtract, not sure.</p>
<p>Now once we have this file, we have to extract IFR data from it, to do
it we can use <a href="https://github.com/LongSoft/IFRExtractor-RS">IFRExtractor RS</a>.
Funnily enough, it&#39;s made by the same people as UEFITool. Thanks guys
for your hard work, otherwise I would have to do it myself ;p.</p>
<p>Now with IFR extracted, we have what we wanted. We can see all the
UEFI settings available, including &#34;Image Execution Policy&#34;.</p>
<pre tabindex="0"><code>Form FormId: 0x2A79, Title: &#34;Image Execution Policy&#34;
	Text Prompt: &#34;Internal FV&#34;, Help: &#34;&#34;, Text: &#34;Always Execute&#34;
	OneOf Prompt: &#34;Option ROM&#34;, Help: &#34;Image Execution Policy on Security Violation per Device Path&#34;, QuestionFlags: 0x10, QuestionId: 0x1116, VarStoreId: 0x28, VarOffset: 0x4, Flags: 0x10, Size: 8, Min: 0x0, Max: 0x5, Step: 0x0
		Default DefaultId: 0x0 Value: 0
		OneOfOption Option: &#34;Always Execute&#34; Value: 0
		OneOfOption Option: &#34;Always Deny&#34; Value: 1
		OneOfOption Option: &#34;Allow Execute&#34; Value: 2
		OneOfOption Option: &#34;Defer Execute&#34; Value: 3
		OneOfOption Option: &#34;Deny Execute&#34; Value: 4
		OneOfOption Option: &#34;Query User&#34; Value: 5
	End
	OneOf Prompt: &#34;Removable Media&#34;, Help: &#34;Image Execution Policy on Security Violation per Device Path&#34;, QuestionFlags: 0x10, QuestionId: 0x1117, VarStoreId: 0x28, VarOffset: 0x5, Flags: 0x10, Size: 8, Min: 0x0, Max: 0x5, Step: 0x0
		Default DefaultId: 0x0 Value: 0
		OneOfOption Option: &#34;Always Execute&#34; Value: 0
		OneOfOption Option: &#34;Always Deny&#34; Value: 1
		OneOfOption Option: &#34;Allow Execute&#34; Value: 2
		OneOfOption Option: &#34;Defer Execute&#34; Value: 3
		OneOfOption Option: &#34;Deny Execute&#34; Value: 4
		OneOfOption Option: &#34;Query User&#34; Value: 5
	End
	OneOf Prompt: &#34;Fixed Media&#34;, Help: &#34;Image Execution Policy on Security Violation per Device Path&#34;, QuestionFlags: 0x10, QuestionId: 0x1118, VarStoreId: 0x28, VarOffset: 0x6, Flags: 0x10, Size: 8, Min: 0x0, Max: 0x5, Step: 0x0
		Default DefaultId: 0x0 Value: 0
		OneOfOption Option: &#34;Always Execute&#34; Value: 0
		OneOfOption Option: &#34;Always Deny&#34; Value: 1
		OneOfOption Option: &#34;Allow Execute&#34; Value: 2
		OneOfOption Option: &#34;Defer Execute&#34; Value: 3
		OneOfOption Option: &#34;Deny Execute&#34; Value: 4
		OneOfOption Option: &#34;Query User&#34; Value: 5
	End
End
</code></pre><p>I have checked if other vendors (ASRock, ASUS, Biostar, EVGA, Gigabyte
and NZXT) have the same thing and I wasn&#39;t able to find anything like
that in their IFR. Also MSI&#39;s laptops are not affected by this issue.
I&#39;m gonna assume that they figured that Microsoft wouldn&#39;t approve it
and/or that they had less tickets from people about Secure Boot related
issues for their laptops.</p>
<p>Now, doing this manually would be kinda annoying, so I made a small
little shell script which checks if &#34;Image Execution Policy&#34; menu is
available and if any of the three options are set to &#34;Always Execute&#34;.</p>
<div><pre tabindex="0"><code data-lang="sh"><span><span><span>#!/bin/sh
</span></span></span><span><span><span></span>
</span></span><span><span><span>if</span> <span>[</span> ! -d <span>&#34;</span><span>$1</span><span>&#34;</span> <span>]</span><span>;</span> <span>then</span>
</span></span><span><span>	<span>[</span> ! -f <span>&#34;</span><span>$1</span><span>.zip&#34;</span> <span>]</span> <span>&amp;&amp;</span> curl <span>&#34;https://download.msi.com/bos_exe/mb/</span><span>$1</span><span>.zip&#34;</span> -O -#
</span></span><span><span>	bsdtar xf <span>&#34;</span><span>$1</span><span>.zip&#34;</span>
</span></span><span><span><span>fi</span>
</span></span><span><span>
</span></span><span><span><span>cd</span> <span>&#34;</span><span>$1</span><span>&#34;</span> <span>||</span> <span>exit</span>
</span></span><span><span>UEFIExtract ./*MS.* unpack 1&gt;/dev/null
</span></span><span><span>ifrextractor ./*.dump/Section_PE32_image_899407D7-99FE-43D8-9A21-79EC328CAC21_Setup_body.bin 1&gt;/dev/null
</span></span><span><span><span>output</span><span>=</span><span>&#34;</span><span>$(</span>grep -A1 -E <span>&#39;OneOf Prompt: &#34;(Option ROM|Removable Media|Fixed Media)&#34;, Help: &#34;Image Execution Policy&#39;</span> ./*.dump/Section_PE32_image_899407D7-99FE-43D8-9A21-79EC328CAC21_Setup_body.bin.*ifr.txt<span>)</span><span>&#34;</span>
</span></span><span><span>clear
</span></span><span><span>
</span></span><span><span><span>if</span> <span>echo</span> <span>&#34;</span><span>$output</span><span>&#34;</span> <span>|</span> grep -q <span>&#34;DefaultId: 0x0&#34;</span><span>;</span> <span>then</span>
</span></span><span><span>	<span>printf</span> <span>&#34;\033[1;31m%s: Bad\033[0m\n&#34;</span> <span>&#34;</span><span>$1</span><span>&#34;</span>
</span></span><span><span><span>else</span>
</span></span><span><span>	<span>printf</span> <span>&#34;\033[1;32m%s: Good\033[0m\n&#34;</span> <span>&#34;</span><span>$1</span><span>&#34;</span>
</span></span><span><span><span>fi</span>
</span></span></code></pre></div><p>Now this is where the fun part ends. Now I had to check firmware for
MSI&#39;s somewhat recent boards.</p>
<p>While we can get most of the firmware just by going to motherboard&#39;s
support page, MSI usually only lists stable firmware and the newest
beta. The problem is that I need to figure out the earliest affected
version of the firmware for each board, which means that I have to guess
what the betas were called (if they even existed). At least MSI doesn&#39;t
remove <em>most</em> of its beta firmware from their servers, so they are still
accessible if you know the link.</p>
<p>For some AMD boards, I have found a list of beta firmware on some German
forum. Thankfully, I didn&#39;t have to read any German, because contrary to
the popular belief, I don&#39;t know German or Russian, I&#39;m Polish.</p>
<p>This… took forever. I checked every motherboard for:</p>
<ul>
<li>AMD: TRX40, X399, X670, X570, X470, X370, B650, B550, B450, B350, A520, A320</li>
<li>Intel: X299, Z790, Z690, Z590, Z490, Z390, Z370, B760, B660, B560, B460, B360, H670, H510, H410, H370, H310</li>
</ul>
<p>It&#39;s… a lot of motherboards. For a full list of affected motherboards
and their firmware versions, visit
<a href="https://github.com/Foxboron/sbctl/issues/181">sbctl#181</a>.</p>
<p>And now it&#39;s time for some &#34;fun&#34; statistic:</p>
<div><pre tabindex="0"><code data-lang="sh"><span><span><span># The amount of times I ran the script</span>
</span></span><span><span>$ <span>history</span> <span>0</span> <span>|</span> grep <span>&#34;  msi &#34;</span> <span>|</span> wc -l
</span></span><span><span><span>1989</span>
</span></span></code></pre></div><p>According to <a href="https://en.wikipedia.org/wiki/1989">Wikipedia in 1989</a>:</p>
<blockquote>
<p>The first commercial Internet service providers surfaced in this year,
as well as the first written proposal for the World Wide Web and New
Zealand, Japan and Australia&#39;s first Internet connections.</p>
</blockquote>
<p>Well, that was a mistake.</p>
<p>You could ask me, why didn&#39;t I automate it? The reason is… well… some of
it is not really easy to as some beta names have arbitrary suffixes
which was faster for me to guess than having a script bruteforce its way
in. Also some boards weren&#39;t listed on their motherboard list page.</p>
<p>Now, after doing all the work for MSI, I think I should bill them, that
or they should give me a lifetime supply of their motherboards.</p>
<p>If you are curious, yes, I have tried contacting MSI about this issue,
but they ignored my emails and other forms of communication I have
tried.</p>

<h3 id="conclusion">
  <a href="#conclusion">Conclusion</a>
</h3>
<p>Don&#39;t trust that whatever security features you enabled are working,
TEST THEM! Somehow I was the first person to document this, even though
it has been first introduced somewhere in 2021 Q3.</p>

<h3 id="quiz-time">
  <a href="#quiz-time">Quiz time!</a>
</h3>
<p>What&#39;s the difference between these 3 boards:</p>
<ul>
<li><a href="https://www.msi.com/Motherboard/B360-GAMING-ARCTIC/Specification">MSI B360 GAMING ARCTIC</a></li>
<li><a href="https://www.msi.com/Motherboard/B360-GAMING-PLUS/Specification">MSI B360 GAMING PLUS</a></li>
<li><a href="https://www.msi.com/Motherboard/B360-A-PRO/Specification">MSI B360-A PRO</a></li>
</ul>
<p>Heatsink and PCB colours! They are the same board and share the same
firmware! But hey, the red and white one is only for gamers but black is
only suitable for &#34;professionals&#34;.</p>

</article>


      </div></div>
  </body>
</html>
