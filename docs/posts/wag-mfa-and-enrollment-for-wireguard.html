<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/NHAS/wag">Original</a>
    <h1>Show HN: Wag, MFA and Enrollment for WireGuard</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">Wag adds MFA, route restriction and device enrolment to wireguard.</p>
<p dir="auto">Key Features:</p>
<ul dir="auto">
<li>Define routes which require MFA authorisation, or public always accessible routes</li>
<li>Easy API for registering new clients</li>
<li>High Availability</li>
<li>Multiple MFA options, including webauthn, oidc and more</li>
</ul>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://private-user-images.githubusercontent.com/6820641/326241365-3a2b2dd9-15af-40c4-bb81-3e479d48425a.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTU0NDQ0ODAsIm5iZiI6MTcxNTQ0NDE4MCwicGF0aCI6Ii82ODIwNjQxLzMyNjI0MTM2NS0zYTJiMmRkOS0xNWFmLTQwYzQtYmI4MS0zZTQ3OWQ0ODQyNWEucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI0MDUxMSUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNDA1MTFUMTYxNjIwWiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9YmYyNjZkZjI5YjE5OGRmZjliNDNhZWE0MjY0NTkzZGJjOWE1ZTVkZWRiOWI1NzQzNWU5ODM5NDJhMDkzYjYzNSZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QmYWN0b3JfaWQ9MCZrZXlfaWQ9MCZyZXBvX2lkPTAifQ.DlmWO67_Eojy2582enl_ZGjdng7EK4SUUHT1KHfEEGE"><img src="https://private-user-images.githubusercontent.com/6820641/326241365-3a2b2dd9-15af-40c4-bb81-3e479d48425a.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTU0NDQ0ODAsIm5iZiI6MTcxNTQ0NDE4MCwicGF0aCI6Ii82ODIwNjQxLzMyNjI0MTM2NS0zYTJiMmRkOS0xNWFmLTQwYzQtYmI4MS0zZTQ3OWQ0ODQyNWEucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI0MDUxMSUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNDA1MTFUMTYxNjIwWiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9YmYyNjZkZjI5YjE5OGRmZjliNDNhZWE0MjY0NTkzZGJjOWE1ZTVkZWRiOWI1NzQzNWU5ODM5NDJhMDkzYjYzNSZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QmYWN0b3JfaWQ9MCZrZXlfaWQ9MCZyZXBvX2lkPTAifQ.DlmWO67_Eojy2582enl_ZGjdng7EK4SUUHT1KHfEEGE" alt="image"/></a></p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://private-user-images.githubusercontent.com/6820641/326241401-89976794-10af-493a-b8c4-3d02f50417ce.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTU0NDQ0ODAsIm5iZiI6MTcxNTQ0NDE4MCwicGF0aCI6Ii82ODIwNjQxLzMyNjI0MTQwMS04OTk3Njc5NC0xMGFmLTQ5M2EtYjhjNC0zZDAyZjUwNDE3Y2UucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI0MDUxMSUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNDA1MTFUMTYxNjIwWiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9MjE5OGZkYjExNjU3ZTlmNjYwYjIwMDhmMTdmOWMzN2RlYWI0NmE5YWU5YzA0NGQ2MTBhZjU1NzkyMjJjZmU0OSZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QmYWN0b3JfaWQ9MCZrZXlfaWQ9MCZyZXBvX2lkPTAifQ.XBctSkY4x5PeYfGGkJNCYpzPxi2-mTxwu2Q_0Hw-GEw"><img src="https://private-user-images.githubusercontent.com/6820641/326241401-89976794-10af-493a-b8c4-3d02f50417ce.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTU0NDQ0ODAsIm5iZiI6MTcxNTQ0NDE4MCwicGF0aCI6Ii82ODIwNjQxLzMyNjI0MTQwMS04OTk3Njc5NC0xMGFmLTQ5M2EtYjhjNC0zZDAyZjUwNDE3Y2UucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI0MDUxMSUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNDA1MTFUMTYxNjIwWiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9MjE5OGZkYjExNjU3ZTlmNjYwYjIwMDhmMTdmOWMzN2RlYWI0NmE5YWU5YzA0NGQ2MTBhZjU1NzkyMjJjZmU0OSZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QmYWN0b3JfaWQ9MCZrZXlfaWQ9MCZyZXBvX2lkPTAifQ.XBctSkY4x5PeYfGGkJNCYpzPxi2-mTxwu2Q_0Hw-GEw" alt="image"/></a></p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://private-user-images.githubusercontent.com/6820641/326241420-83cae3c0-bb19-4aa0-846f-c045387a0910.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTU0NDQ0ODAsIm5iZiI6MTcxNTQ0NDE4MCwicGF0aCI6Ii82ODIwNjQxLzMyNjI0MTQyMC04M2NhZTNjMC1iYjE5LTRhYTAtODQ2Zi1jMDQ1Mzg3YTA5MTAucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI0MDUxMSUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNDA1MTFUMTYxNjIwWiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9MjdjODlkZTk3YmI0NmQzMmI5MDM0ZDA3ZGEyMTg4YjNiZTIzMGMzYjk0NTQ0NmVjNTljNGViMTVlOGRmNDQyOCZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QmYWN0b3JfaWQ9MCZrZXlfaWQ9MCZyZXBvX2lkPTAifQ.AHsqQmVTpb6USfyfVDnUPNyChEiNnE-YnBvuO4yGSb8"><img src="https://private-user-images.githubusercontent.com/6820641/326241420-83cae3c0-bb19-4aa0-846f-c045387a0910.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTU0NDQ0ODAsIm5iZiI6MTcxNTQ0NDE4MCwicGF0aCI6Ii82ODIwNjQxLzMyNjI0MTQyMC04M2NhZTNjMC1iYjE5LTRhYTAtODQ2Zi1jMDQ1Mzg3YTA5MTAucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI0MDUxMSUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNDA1MTFUMTYxNjIwWiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9MjdjODlkZTk3YmI0NmQzMmI5MDM0ZDA3ZGEyMTg4YjNiZTIzMGMzYjk0NTQ0NmVjNTljNGViMTVlOGRmNDQyOCZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QmYWN0b3JfaWQ9MCZrZXlfaWQ9MCZyZXBvX2lkPTAifQ.AHsqQmVTpb6USfyfVDnUPNyChEiNnE-YnBvuO4yGSb8" alt="image"/></a></p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://private-user-images.githubusercontent.com/6820641/326241440-ff237473-d522-451e-8529-92bd111d4b96.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTU0NDQ0ODAsIm5iZiI6MTcxNTQ0NDE4MCwicGF0aCI6Ii82ODIwNjQxLzMyNjI0MTQ0MC1mZjIzNzQ3My1kNTIyLTQ1MWUtODUyOS05MmJkMTExZDRiOTYucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI0MDUxMSUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNDA1MTFUMTYxNjIwWiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9ZWEwYjJkNDZjMTVkMWE4YjYxNTc5NjVmN2VlMmFiNzkxNTc2NDVhODlmNWZjNjk3NzkwODE1Mjk0MzYzMmEwZCZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QmYWN0b3JfaWQ9MCZrZXlfaWQ9MCZyZXBvX2lkPTAifQ.cXAWumRC8sHk6TC4nLJYLeNalEsj97wSWsq2RM6lvkM"><img src="https://private-user-images.githubusercontent.com/6820641/326241440-ff237473-d522-451e-8529-92bd111d4b96.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTU0NDQ0ODAsIm5iZiI6MTcxNTQ0NDE4MCwicGF0aCI6Ii82ODIwNjQxLzMyNjI0MTQ0MC1mZjIzNzQ3My1kNTIyLTQ1MWUtODUyOS05MmJkMTExZDRiOTYucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI0MDUxMSUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNDA1MTFUMTYxNjIwWiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9ZWEwYjJkNDZjMTVkMWE4YjYxNTc5NjVmN2VlMmFiNzkxNTc2NDVhODlmNWZjNjk3NzkwODE1Mjk0MzYzMmEwZCZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QmYWN0b3JfaWQ9MCZrZXlfaWQ9MCZyZXBvX2lkPTAifQ.cXAWumRC8sHk6TC4nLJYLeNalEsj97wSWsq2RM6lvkM" alt="image"/></a></p>

<p dir="auto">This work was very kindly supported by <a href="https://www.aurainfosec.com/" rel="nofollow">Aura Information Security</a>.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/6820641/181147262-c7baa5a5-36b2-4153-b01f-5064226ec56e.png"><img src="https://user-images.githubusercontent.com/6820641/181147262-c7baa5a5-36b2-4153-b01f-5064226ec56e.png" alt="image"/></a></p>

<p dir="auto"><code>iptables</code> and <code>libpam</code> must be installed.</p>
<p dir="auto">Forwarding must be enabled in <code>sysctl</code>.</p>
<div data-snippet-clipboard-copy-content="sysctl -w net.ipv4.ip_forward=1"><pre><code>sysctl -w net.ipv4.ip_forward=1
</code></pre></div>
<p dir="auto">Wag does not need <code>wg-quick</code> or other equalivent as long as the kernel supports wireguard.</p>

<p dir="auto">Both options require a kernel newer than 5.9+</p>
<p dir="auto">Binary release (requires glibc 2.31+):</p>
<div data-snippet-clipboard-copy-content="curl -L $(curl -s https://api.github.com/repos/NHAS/wag/releases/latest | jq -M -r &#39;.assets[0].browser_download_url&#39;) -o wag
sudo ./wag gen-config

sudo ./wag start -config &lt;generated_config_name&gt;"><pre><code>curl -L $(curl -s https://api.github.com/repos/NHAS/wag/releases/latest | jq -M -r &#39;.assets[0].browser_download_url&#39;) -o wag
sudo ./wag gen-config

sudo ./wag start -config &lt;generated_config_name&gt;
</code></pre></div>
<p dir="auto">From source (will require <code>go1.19</code>, <code>npm</code>, <code>gulp</code>, <code>clang</code>, <code>llvm-strip</code>, <code>libbpf</code>):</p>
<div data-snippet-clipboard-copy-content="git clone git@github.com:NHAS/wag.git
cd wag
make

cp example_config.json config.json

sudo ./wag start"><pre><code>git clone git@github.com:NHAS/wag.git
cd wag
make

cp example_config.json config.json

sudo ./wag start
</code></pre></div>
<p dir="auto">If running behind a reverse proxy, <code>X-Forwarded-For</code> must be set.</p>

<p dir="auto">The root user is able to manage the wag server with the following command:</p>
<div data-snippet-clipboard-copy-content="wag subcommand [-options]"><pre><code>wag subcommand [-options]
</code></pre></div>
<p dir="auto">Supported commands: <code>start</code>, <code>cleanup</code>, <code>reload</code>, <code>version</code>, <code>firewall</code>, <code>registration</code>, <code>devices</code>, <code>users</code>, <code>webadmin</code>, <code>gen-config</code></p>
<p dir="auto"><code>start</code>: starts the wag server</p>
<div data-snippet-clipboard-copy-content="Usage of start:
  Start wag server (does not daemonise)
  -join string
        Cluster join token
  -config string
        Configuration file location (default &#34;./config.json&#34;)"><pre><code>Usage of start:
  Start wag server (does not daemonise)
  -join string
        Cluster join token
  -config string
        Configuration file location (default &#34;./config.json&#34;)
</code></pre></div>
<p dir="auto"><code>cleanup</code>: Will remove all firewall forwards, and shutdown the wireguard device</p>
<p dir="auto"><code>reload</code>: Reloads ACLs from configuration</p>
<p dir="auto"><code>version</code>: Display the version of wag</p>
<p dir="auto"><code>firewall</code>: Get firewall rules</p>
<div data-snippet-clipboard-copy-content="Usage of firewall:
  -list
        List firewall rules
  -socket string
        Wag socket to act on (default &#34;/tmp/wag.sock&#34;)
"><pre><code>Usage of firewall:
  -list
        List firewall rules
  -socket string
        Wag socket to act on (default &#34;/tmp/wag.sock&#34;)

</code></pre></div>
<p dir="auto"><code>registration</code>:  Deals with creating, deleting and listing the registration tokens</p>
<div data-snippet-clipboard-copy-content="Usage of registration:
  -add
        Create a new enrolment token
  -del
        Delete existing enrolment token
  -group value
        Manually set user group (can supply multiple -group, or use -groups for , delimited group list, useful for OIDC)
  -groups string
        Set user groups manually, &#39;,&#39; delimited list of groups, useful for OIDC
  -list
        List tokens
  -overwrite string
        Add registration token for an existing user device, will overwrite wireguard public key (but not 2FA)
  -socket string
        Wag socket to act on (default &#34;/tmp/wag.sock&#34;)
  -token string
        Manually set registration token (Optional)
  -username string
        User to add device to"><pre><code>Usage of registration:
  -add
        Create a new enrolment token
  -del
        Delete existing enrolment token
  -group value
        Manually set user group (can supply multiple -group, or use -groups for , delimited group list, useful for OIDC)
  -groups string
        Set user groups manually, &#39;,&#39; delimited list of groups, useful for OIDC
  -list
        List tokens
  -overwrite string
        Add registration token for an existing user device, will overwrite wireguard public key (but not 2FA)
  -socket string
        Wag socket to act on (default &#34;/tmp/wag.sock&#34;)
  -token string
        Manually set registration token (Optional)
  -username string
        User to add device to
</code></pre></div>
<p dir="auto"><code>devices</code>: Manages devices</p>
<div data-snippet-clipboard-copy-content="Usage of devices:
  -address string
        Address of device
  -del
        Remove device and block wireguard access
  -list
        List wireguard devices
  -lock
        Lock device access to mfa routes
  -mfa_sessions
        Get list of devices with active authorised sessions
  -socket string
        Wag control socket to act on (default &#34;/tmp/wag.sock&#34;)
  -unlock
        Unlock device
  -username string
        Owner of device (indicates that command acts on all devices owned by user)"><pre><code>Usage of devices:
  -address string
        Address of device
  -del
        Remove device and block wireguard access
  -list
        List wireguard devices
  -lock
        Lock device access to mfa routes
  -mfa_sessions
        Get list of devices with active authorised sessions
  -socket string
        Wag control socket to act on (default &#34;/tmp/wag.sock&#34;)
  -unlock
        Unlock device
  -username string
        Owner of device (indicates that command acts on all devices owned by user)
</code></pre></div>
<p dir="auto"><code>users</code>: Manages users MFA and can delete all users devices</p>
<div data-snippet-clipboard-copy-content="Usage of users:
  -del
        Delete user and all associated devices
  -list
        List users, if &#39;-username&#39; supply will filter by user
  -lockaccount
        Lock account disable authention from any device, deauthenticates user active sessions
  -reset-mfa
        Reset MFA details, invalids all session and set MFA to be shown
  -socket string
        Wag socket location, (default &#34;/tmp/wag.sock&#34;)
  -unlockaccount
        Unlock a locked account, does not unlock specific device locks (use device -unlock -username &lt;&gt; for that)
  -username string
        Username to act upon"><pre><code>Usage of users:
  -del
        Delete user and all associated devices
  -list
        List users, if &#39;-username&#39; supply will filter by user
  -lockaccount
        Lock account disable authention from any device, deauthenticates user active sessions
  -reset-mfa
        Reset MFA details, invalids all session and set MFA to be shown
  -socket string
        Wag socket location, (default &#34;/tmp/wag.sock&#34;)
  -unlockaccount
        Unlock a locked account, does not unlock specific device locks (use device -unlock -username &lt;&gt; for that)
  -username string
        Username to act upon
</code></pre></div>
<p dir="auto"><code>webadmin</code>: Manages the administrative users for the web UI</p>
<div data-snippet-clipboard-copy-content="Usage of webadmin:
  -add
        Add web administrator user (requires -password)
  -del
        Delete admin user
  -list
        List web administration users, if &#39;-username&#39; supply will filter by user
  -lockaccount
        Lock admin account disable login for this web administrator user
  -password string
        Username to act upon
  -socket string
        Wag instance control socket (default &#34;/tmp/wag.sock&#34;)
  -unlockaccount
        Unlock a web administrator account
  -username string
        Admin Username to act upon"><pre><code>Usage of webadmin:
  -add
        Add web administrator user (requires -password)
  -del
        Delete admin user
  -list
        List web administration users, if &#39;-username&#39; supply will filter by user
  -lockaccount
        Lock admin account disable login for this web administrator user
  -password string
        Username to act upon
  -socket string
        Wag instance control socket (default &#34;/tmp/wag.sock&#34;)
  -unlockaccount
        Unlock a web administrator account
  -username string
        Admin Username to act upon
</code></pre></div>


<ol dir="auto">
<li>Copy <code>wag</code>, <code>config.json</code> to <code>/opt/wag</code></li>
<li>Generate a wireguard private key with <code>wg genkey</code> set <code>PrivateKey</code> in the example config to it</li>
<li>Copy (or link) <code>wag.service</code> to <code>/etc/systemd/system/</code> and start/enable the service</li>
</ol>
<div dir="auto"><h2 tabindex="-1" dir="auto">Creating new registration tokens</h2><a id="user-content-creating-new-registration-tokens" aria-label="Permalink: Creating new registration tokens" href="#creating-new-registration-tokens"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">First generate a token.</p>
<div data-snippet-clipboard-copy-content="# ./wag registration -add -username tester
token,username
e83253fd9962c68f73aa5088604f3f425d58a963bfb5c0889cca54d63a34b2e3,tester"><pre><code># ./wag registration -add -username tester
token,username
e83253fd9962c68f73aa5088604f3f425d58a963bfb5c0889cca54d63a34b2e3,tester
</code></pre></div>
<p dir="auto">Then curl said token.</p>
<div data-snippet-clipboard-copy-content="curl http://public.server.address:8080/register_device?key=e83253fd9962c68f73aa5088604f3f425d58a963bfb5c0889cca54d63a34b2e3"><pre><code>curl http://public.server.address:8080/register_device?key=e83253fd9962c68f73aa5088604f3f425d58a963bfb5c0889cca54d63a34b2e3
</code></pre></div>
<p dir="auto">The service will return a fully templated response:</p>
<div data-snippet-clipboard-copy-content="[Interface]
PrivateKey = &lt;omitted&gt;
Address = 192.168.1.1

[Peer]
Endpoint =  public.server.address:51820
PublicKey = pnvl40WiRt++0NucEGexlpfwWA8QzBYg2+8ZWZJvejA=
AllowedIPs = 10.7.7.7/32, 192.168.1.1/32, 192.168.3.4/32, 192.168.3.5/32
PersistentKeepAlive = 10"><pre><code>[Interface]
PrivateKey = &lt;omitted&gt;
Address = 192.168.1.1

[Peer]
Endpoint =  public.server.address:51820
PublicKey = pnvl40WiRt++0NucEGexlpfwWA8QzBYg2+8ZWZJvejA=
AllowedIPs = 10.7.7.7/32, 192.168.1.1/32, 192.168.3.4/32, 192.168.3.5/32
PersistentKeepAlive = 10
</code></pre></div>
<p dir="auto">Which can then be written to a config file.</p>

<p dir="auto">To authenticate the user should browse to the servers vpn address, in the example, case <code>192.168.1.1:8080</code>, where they will be prompted for their 2fa code.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Signing in to the Management console</h2><a id="user-content-signing-in-to-the-management-console" aria-label="Permalink: Signing in to the Management console" href="#signing-in-to-the-management-console"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Make sure that you have <code>ManagementUI.Enabled</code> set as <code>true</code>, then do the following from the console:</p>
<div data-snippet-clipboard-copy-content="sudo ./wag webadmin -add -username &lt;your_username&gt; -password &lt;your-password-here&gt;"><pre><code>sudo ./wag webadmin -add -username &lt;your_username&gt; -password &lt;your-password-here&gt;
</code></pre></div>
<p dir="auto">Then browse to your management listening address and enter your credentials.</p>
<p dir="auto">The web interface itself cannot add administrative users.</p>

<p dir="auto"><code>NumberProxies</code>: The number of trusted reverse proxies before the client, makes wag respect the <code>X-Forward-For</code> directive and parses the client IP from it correctly
<code>HelpMail</code>: The email address that is shown on the prompt page</p>
<p dir="auto"><code>ExternalAddress</code>: The public address of the server, the place where wireguard is listening to the internet, and where clients can reach the <code>/register_device</code> endpoint</p>
<p dir="auto"><code>MaxSessionLifetimeMinutes</code>: After authenticating, a device will be allowed to talk to privileged routes for this many minutes, if -1, timeout is disabled</p>
<p dir="auto"><code>DatabaseLocation</code>: Where to load the sqlite3 database from, it will be created if it does not exist</p>
<p dir="auto"><code>Webserver</code>: Object that contains the public and tunnel listening addresses of the webserver</p>
<p dir="auto"><code>WebServer.Public.ListenAddress</code>: Listen address for endpoint</p>
<p dir="auto"><code>WebServer.&lt;endpoint&gt;.CertPath</code>: TLS Certificate path for endpoint</p>
<p dir="auto"><code>Authenticators</code>: Object that contains configurations for the authentication methods wag provides</p>
<p dir="auto"><code>Authenticators.OIDC</code>: Object that contains <code>OIDC</code> specific configuration options
<code>Authenticators.OIDC.IssuerURL</code>: Identity provider endpoint, e.g <code>http://localhost:8080/realms/account</code>
<code>Authenticators.OIDC.ClientID</code>:  OIDC identifier for application
<code>Authenticators.OIDC.ClientSecret</code>: OIDC secret
<code>Authenticators.OIDC.GroupsClaimName</code>: Not yet used.</p>
<p dir="auto"><code>Authenticators.PAM.ServiceName</code>: Name of PAM-Auth file in <code>/etc/pam.d/</code>  will default to <code>/etc/pam.d/login</code> if unset or empty</p>
<p dir="auto"><code>Clustering</code>: Object containing the clustering details</p>
<p dir="auto"><code>Wireguard</code>: Object that contains the wireguard device configuration</p>
<p dir="auto"><code>ManagementUI</code>: Object that contains configurations for the webadministration portal. It is not recommend to expose this portal, I recommend setting <code>ListenAddress</code> to <code>127.0.0.1</code>/<code>localhost</code> and then use ssh forwarding to expose it</p>
<p dir="auto">Full config example</p>
<div dir="auto" data-snippet-clipboard-copy-content="{
    &#34;Proxied&#34;: true,
    &#34;ExposePorts&#34;: [
        &#34;443/tcp&#34;,
        &#34;100-200/udp&#34;
     ],
    &#34;CheckUpdates&#34;: true,
    &#34;Lockout&#34;: 5,
    &#34;NAT&#34;: true,
    &#34;HelpMail&#34;: &#34;help@example.com&#34;,
    &#34;MaxSessionLifetimeMinutes&#34;: 2,
    &#34;SessionInactivityTimeoutMinutes&#34;: 1,
    &#34;ExternalAddress&#34;: &#34;81.80.79.78&#34;,
    &#34;DatabaseLocation&#34;: &#34;devices.db&#34;,
    &#34;Socket&#34;:&#34;/tmp/wag.sock&#34;,
    &#34;Webserver&#34;: {
        &#34;Public&#34;: {
            &#34;ListenAddress&#34;: &#34;192.168.121.61:8080&#34;,
            &#34;CertPath&#34;: &#34;/etc/example/cert/path&#34;,
            &#34;KeyPath&#34;: &#34;/etc/ssl/private/somecert.key&#34;
        },
        &#34;Tunnel&#34;: {
            &#34;Port&#34;: &#34;8080&#34;
        }
    },
    &#34;ManagementUI&#34;: {
        &#34;ListenAddress&#34;: &#34;127.0.0.1:4433&#34;,
        &#34;CertPath&#34;: &#34;/etc/example/cert/path&#34;,
        &#34;KeyPath&#34;: &#34;/etc/ssl/private/somecert.key&#34;,
        &#34;Enabled&#34;: true
    },
    &#34;Authenticators&#34;: {
        &#34;Issuer&#34;: &#34;vpn.test&#34;,
        &#34;DomainURL&#34;: &#34;https://vpn.test:8080&#34;,
        &#34;DefaultMethod&#34;:&#34;webauthn&#34;,
        &#34;Methods&#34;:[&#34;totp&#34;,&#34;webauthn&#34;, &#34;oidc&#34;, &#34;pam&#34;],
        &#34;OIDC&#34;: {
            &#34;IssuerURL&#34;: &#34;http://localhost:8080/&#34;,
            &#34;ClientSecret&#34;: &#34;&lt;OMITTED&gt;&#34;,
            &#34;ClientID&#34;: &#34;account&#34;,
            &#34;GroupsClaimName&#34;: &#34;groups&#34;
        }
    },
    &#34;Clustering&#34;: {
        &#34;ClusterState&#34;: &#34;new&#34;,
        &#34;ETCDLogLevel&#34;: &#34;error&#34;,
        &#34;Witness&#34;: false,
        &#34;TLSManagerListenURL&#34;: &#34;https://wag.server:3434&#34;
    },
    &#34;Wireguard&#34;: {
        &#34;DevName&#34;: &#34;wg0&#34;,
        &#34;ListenPort&#34;: 53230,
        &#34;PrivateKey&#34;: &#34;AN EXAMPLE KEY&#34;,
        &#34;Address&#34;: &#34;192.168.1.1/24&#34;,
        &#34;MTU&#34;: 1420,
        &#34;DNS&#34;: [&#34;1.1.1.1&#34;]
    },
    &#34;Acls&#34;: {
        &#34;Groups&#34;: {
            &#34;group:nerds&#34;: [
                &#34;daviv.test&#34;,
                &#34;franky.someone&#34;,
                &#34;any_username&#34;
            ]
        },
        &#34;Policies&#34;: {
            &#34;*&#34;: {
                &#34;Mfa&#34;: [
                     &#34;10.0.0.2/32 8080/any&#34;
                ],
                &#34;Allow&#34;: [
                    &#34;10.7.7.7/32&#34;,
                    &#34;google.com&#34;
                ]
            },
            &#34;username&#34;: { 
                &#34;Mfa&#34;: [
                     &#34;someinternal.service 9100/tcp&#34;
                ],
                &#34;Allow&#34;:[ &#34;10.0.0.1/32&#34;]
            },
            &#34;group:nerds&#34;: {
                &#34;Mfa&#34;: [
                    &#34;192.168.3.4/32&#34;,
                    &#34;10.0.0.0/24&#34;,
                    &#34;thing.internal 443/tcp icmp&#34;
                ],
                &#34;Allow&#34;: [
                    &#34;192.168.3.5/32&#34;
                ],
                &#34;Deny&#34;: [
                    &#34;10.0.0.5/32&#34;
                 ]
            }
        }
    }
}"><pre>{
    <span>&#34;Proxied&#34;</span>: <span>true</span>,
    <span>&#34;ExposePorts&#34;</span>: [
        <span><span>&#34;</span>443/tcp<span>&#34;</span></span>,
        <span><span>&#34;</span>100-200/udp<span>&#34;</span></span>
     ],
    <span>&#34;CheckUpdates&#34;</span>: <span>true</span>,
    <span>&#34;Lockout&#34;</span>: <span>5</span>,
    <span>&#34;NAT&#34;</span>: <span>true</span>,
    <span>&#34;HelpMail&#34;</span>: <span><span>&#34;</span>help@example.com<span>&#34;</span></span>,
    <span>&#34;MaxSessionLifetimeMinutes&#34;</span>: <span>2</span>,
    <span>&#34;SessionInactivityTimeoutMinutes&#34;</span>: <span>1</span>,
    <span>&#34;ExternalAddress&#34;</span>: <span><span>&#34;</span>81.80.79.78<span>&#34;</span></span>,
    <span>&#34;DatabaseLocation&#34;</span>: <span><span>&#34;</span>devices.db<span>&#34;</span></span>,
    <span>&#34;Socket&#34;</span>:<span><span>&#34;</span>/tmp/wag.sock<span>&#34;</span></span>,
    <span>&#34;Webserver&#34;</span>: {
        <span>&#34;Public&#34;</span>: {
            <span>&#34;ListenAddress&#34;</span>: <span><span>&#34;</span>192.168.121.61:8080<span>&#34;</span></span>,
            <span>&#34;CertPath&#34;</span>: <span><span>&#34;</span>/etc/example/cert/path<span>&#34;</span></span>,
            <span>&#34;KeyPath&#34;</span>: <span><span>&#34;</span>/etc/ssl/private/somecert.key<span>&#34;</span></span>
        },
        <span>&#34;Tunnel&#34;</span>: {
            <span>&#34;Port&#34;</span>: <span><span>&#34;</span>8080<span>&#34;</span></span>
        }
    },
    <span>&#34;ManagementUI&#34;</span>: {
        <span>&#34;ListenAddress&#34;</span>: <span><span>&#34;</span>127.0.0.1:4433<span>&#34;</span></span>,
        <span>&#34;CertPath&#34;</span>: <span><span>&#34;</span>/etc/example/cert/path<span>&#34;</span></span>,
        <span>&#34;KeyPath&#34;</span>: <span><span>&#34;</span>/etc/ssl/private/somecert.key<span>&#34;</span></span>,
        <span>&#34;Enabled&#34;</span>: <span>true</span>
    },
    <span>&#34;Authenticators&#34;</span>: {
        <span>&#34;Issuer&#34;</span>: <span><span>&#34;</span>vpn.test<span>&#34;</span></span>,
        <span>&#34;DomainURL&#34;</span>: <span><span>&#34;</span>https://vpn.test:8080<span>&#34;</span></span>,
        <span>&#34;DefaultMethod&#34;</span>:<span><span>&#34;</span>webauthn<span>&#34;</span></span>,
        <span>&#34;Methods&#34;</span>:[<span><span>&#34;</span>totp<span>&#34;</span></span>,<span><span>&#34;</span>webauthn<span>&#34;</span></span>, <span><span>&#34;</span>oidc<span>&#34;</span></span>, <span><span>&#34;</span>pam<span>&#34;</span></span>],
        <span>&#34;OIDC&#34;</span>: {
            <span>&#34;IssuerURL&#34;</span>: <span><span>&#34;</span>http://localhost:8080/<span>&#34;</span></span>,
            <span>&#34;ClientSecret&#34;</span>: <span><span>&#34;</span>&lt;OMITTED&gt;<span>&#34;</span></span>,
            <span>&#34;ClientID&#34;</span>: <span><span>&#34;</span>account<span>&#34;</span></span>,
            <span>&#34;GroupsClaimName&#34;</span>: <span><span>&#34;</span>groups<span>&#34;</span></span>
        }
    },
    <span>&#34;Clustering&#34;</span>: {
        <span>&#34;ClusterState&#34;</span>: <span><span>&#34;</span>new<span>&#34;</span></span>,
        <span>&#34;ETCDLogLevel&#34;</span>: <span><span>&#34;</span>error<span>&#34;</span></span>,
        <span>&#34;Witness&#34;</span>: <span>false</span>,
        <span>&#34;TLSManagerListenURL&#34;</span>: <span><span>&#34;</span>https://wag.server:3434<span>&#34;</span></span>
    },
    <span>&#34;Wireguard&#34;</span>: {
        <span>&#34;DevName&#34;</span>: <span><span>&#34;</span>wg0<span>&#34;</span></span>,
        <span>&#34;ListenPort&#34;</span>: <span>53230</span>,
        <span>&#34;PrivateKey&#34;</span>: <span><span>&#34;</span>AN EXAMPLE KEY<span>&#34;</span></span>,
        <span>&#34;Address&#34;</span>: <span><span>&#34;</span>192.168.1.1/24<span>&#34;</span></span>,
        <span>&#34;MTU&#34;</span>: <span>1420</span>,
        <span>&#34;DNS&#34;</span>: [<span><span>&#34;</span>1.1.1.1<span>&#34;</span></span>]
    },
    <span>&#34;Acls&#34;</span>: {
        <span>&#34;Groups&#34;</span>: {
            <span>&#34;group:nerds&#34;</span>: [
                <span><span>&#34;</span>daviv.test<span>&#34;</span></span>,
                <span><span>&#34;</span>franky.someone<span>&#34;</span></span>,
                <span><span>&#34;</span>any_username<span>&#34;</span></span>
            ]
        },
        <span>&#34;Policies&#34;</span>: {
            <span>&#34;*&#34;</span>: {
                <span>&#34;Mfa&#34;</span>: [
                     <span><span>&#34;</span>10.0.0.2/32 8080/any<span>&#34;</span></span>
                ],
                <span>&#34;Allow&#34;</span>: [
                    <span><span>&#34;</span>10.7.7.7/32<span>&#34;</span></span>,
                    <span><span>&#34;</span>google.com<span>&#34;</span></span>
                ]
            },
            <span>&#34;username&#34;</span>: { 
                <span>&#34;Mfa&#34;</span>: [
                     <span><span>&#34;</span>someinternal.service 9100/tcp<span>&#34;</span></span>
                ],
                <span>&#34;Allow&#34;</span>:[ <span><span>&#34;</span>10.0.0.1/32<span>&#34;</span></span>]
            },
            <span>&#34;group:nerds&#34;</span>: {
                <span>&#34;Mfa&#34;</span>: [
                    <span><span>&#34;</span>192.168.3.4/32<span>&#34;</span></span>,
                    <span><span>&#34;</span>10.0.0.0/24<span>&#34;</span></span>,
                    <span><span>&#34;</span>thing.internal 443/tcp icmp<span>&#34;</span></span>
                ],
                <span>&#34;Allow&#34;</span>: [
                    <span><span>&#34;</span>192.168.3.5/32<span>&#34;</span></span>
                ],
                <span>&#34;Deny&#34;</span>: [
                    <span><span>&#34;</span>10.0.0.5/32<span>&#34;</span></span>
                 ]
            }
        }
    }
}</pre></div>

<p dir="auto">The <code>Policies</code> section allows you to define what routes should be both captured by the VPN and what ports and protocols are allowed through Wag.</p>
<p dir="auto">Rules use the subnet prefix length to determine which rule applies. The most <em>specific</em> match is use to determine the level of user access to a route.</p>
<div dir="auto" data-snippet-clipboard-copy-content=" &#34;*&#34;: {
                &#34;Mfa&#34;: [
                     &#34;10.0.0.0/16&#34;
                ],
                &#34;Allow&#34;: [
                    &#34;10.0.1.1/32&#34;,
                ]
            },"><pre> <span>&#34;*&#34;</span>: {
                <span>&#34;Mfa&#34;</span>: [
                     <span><span>&#34;</span>10.0.0.0/16<span>&#34;</span></span>
                ],
                <span>&#34;Allow&#34;</span>: [
                    <span><span>&#34;</span>10.0.1.1/32<span>&#34;</span></span>,
                ]
            },</pre></div>
<p dir="auto">Users will be able to access 10.0.1.1 <strong>without</strong> MFA as the match is more specific. This change occured in v6.0.0, previously MFA routes would always take precedence.</p>
<p dir="auto">Additionally if multiple policies are defined for a single route they are composed with MFA rules taking preference.</p>
<div dir="auto" data-snippet-clipboard-copy-content=" &#34;*&#34;: {
            &#34;Mfa&#34;: [
                  &#34;10.0.0.0/16&#34;,
                  &#34;10.0.1.1/32 22/tcp&#34;,
            ]
  },
 &#34;group:users&#34;: {
            &#34;Allow&#34;: [
                  &#34;10.0.1.1/32 443/tcp&#34;,
            ]
 }"><pre> <span>&#34;*&#34;</span>: {
            <span>&#34;Mfa&#34;</span>: [
                  <span><span>&#34;</span>10.0.0.0/16<span>&#34;</span></span>,
                  <span><span>&#34;</span>10.0.1.1/32 22/tcp<span>&#34;</span></span>,
            ]
  },
 <span>&#34;group:users&#34;</span>: {
            <span>&#34;Allow&#34;</span>: [
                  <span><span>&#34;</span>10.0.1.1/32 443/tcp<span>&#34;</span></span>,
            ]
 }</pre></div>
<p dir="auto">All users will be able to access <code>22/tcp</code> on the <code>10.0.1.1/32</code> host, but users in the <code>group:users</code> will be able to access <code>443/tcp</code> on that host as well, along with <code>22/tcp</code> when authorized.</p>
<p dir="auto">As of <strong>[version number, yet to be released]</strong> you can now define deny rules which will block access to a route.</p>
<p dir="auto">Example:</p>
<div dir="auto" data-snippet-clipboard-copy-content=" &#34;*&#34;: {
            &#34;Allow&#34;: [
                  &#34;10.0.0.0/16&#34;,
                  &#34;10.0.1.1/32 443/tcp&#34;,
            ]
  },
 &#34;group:users&#34;: {
            &#34;Deny&#34;: [
                  &#34;10.0.1.1/32 443/tcp&#34;,
            ]
 }"><pre> <span>&#34;*&#34;</span>: {
            <span>&#34;Allow&#34;</span>: [
                  <span><span>&#34;</span>10.0.0.0/16<span>&#34;</span></span>,
                  <span><span>&#34;</span>10.0.1.1/32 443/tcp<span>&#34;</span></span>,
            ]
  },
 <span>&#34;group:users&#34;</span>: {
            <span>&#34;Deny&#34;</span>: [
                  <span><span>&#34;</span>10.0.1.1/32 443/tcp<span>&#34;</span></span>,
            ]
 }</pre></div>
<p dir="auto">Its important to note that the most specific rule effectively creates a new rule &#34;bucket&#34;, so if you do something like:</p>
<div dir="auto" data-snippet-clipboard-copy-content="&#34;group:nerds&#34;: {
      &#34;Allow&#34;: [
            &#34;10.0.0.0/24 443/tcp&#34;
      ],
      &#34;Deny&#34;: [
            &#34;10.0.0.5/32 22/tcp&#34;
      ]
}"><pre><span>&#34;group:nerds&#34;</span>: {
      <span>&#34;Allow&#34;</span>: [
            <span><span>&#34;</span>10.0.0.0/24 443/tcp<span>&#34;</span></span>
      ],
      <span>&#34;Deny&#34;</span>: [
            <span><span>&#34;</span>10.0.0.5/32 22/tcp<span>&#34;</span></span>
      ]
}</pre></div>
<p dir="auto">Your clients will not be able to access <code>10.0.0.5/32 443/tcp</code>, as the only rule in the <code>/32</code> &#34;bucket&#34; is a deny rule. You can solve this by adding the following:</p>
<div dir="auto" data-snippet-clipboard-copy-content="&#34;group:nerds&#34;: {
      &#34;Allow&#34;: [
            &#34;10.0.0.0/24 443/tcp&#34;
            &#34;10.0.0.5/32 22/tcp&#34;
      ],
      &#34;Deny&#34;: [
            &#34;10.0.0.5/32 22/tcp&#34;
      ]
}"><pre><span>&#34;group:nerds&#34;</span>: {
      <span>&#34;Allow&#34;</span>: [
            <span><span>&#34;</span>10.0.0.0/24 443/tcp<span>&#34;</span></span>
            <span><span>&#34;</span>10.0.0.5/32 22/tcp<span>&#34;</span></span>
      ],
      <span>&#34;Deny&#34;</span>: [
            <span><span>&#34;</span>10.0.0.5/32 22/tcp<span>&#34;</span></span>
      ]
}</pre></div>
<p dir="auto">or</p>
<div dir="auto" data-snippet-clipboard-copy-content="&#34;group:nerds&#34;: {
      &#34;Allow&#34;: [
            &#34;10.0.0.0/24 443/tcp&#34;
      ],
      &#34;Deny&#34;: [
            &#34;10.0.0.0/24 22/tcp&#34;
      ]
}"><pre><span>&#34;group:nerds&#34;</span>: {
      <span>&#34;Allow&#34;</span>: [
            <span><span>&#34;</span>10.0.0.0/24 443/tcp<span>&#34;</span></span>
      ],
      <span>&#34;Deny&#34;</span>: [
            <span><span>&#34;</span>10.0.0.0/24 22/tcp<span>&#34;</span></span>
      ]
}</pre></div>
<p dir="auto">As then you&#39;re adding the deny rule to the <code>/24</code> &#34;bucket&#34;.</p>
<p dir="auto">Additionally, It is possible to define what services a user can access by defining port and protocol rules.</p>

<p dir="auto">When no other rules are defined or the <code>any</code> keyword is used wag will allow all services and port combinations.</p>
<p dir="auto">Example:</p>
<div data-snippet-clipboard-copy-content="&#34;1.1.1.1&#34;: Allows all ports and protocols to 1.1.1.1/32
&#34;1.1.1.1 54/any&#34;: Allows both tcp and udp to 1.1.1.1/32"><pre><code>&#34;1.1.1.1&#34;: Allows all ports and protocols to 1.1.1.1/32
&#34;1.1.1.1 54/any&#34;: Allows both tcp and udp to 1.1.1.1/32
</code></pre></div>

<p dir="auto">Example:</p>
<div data-snippet-clipboard-copy-content="192.168.1.1 22/tcp 53/udp: Fairly self explanatory, allows you to hit 22/tcp and 53/udp on a host
1.1.1.1 icmp: As icmp doesnt have ports really you dont need it either"><pre><code>192.168.1.1 22/tcp 53/udp: Fairly self explanatory, allows you to hit 22/tcp and 53/udp on a host
1.1.1.1 icmp: As icmp doesnt have ports really you dont need it either
</code></pre></div>

<p dir="auto">You can also define a range of ports with a protocol. wag requires that the lower port is first.</p>
<p dir="auto">Example:</p>
<div data-snippet-clipboard-copy-content="192.168.1.1 22-1024/tcp 23-53/any: Format is low port-high port/service"><pre><code>192.168.1.1 22-1024/tcp 23-53/any: Format is low port-high port/service
</code></pre></div>

<ul dir="auto">
<li>Only supports clients with one <code>AllowedIP</code>, which is perfect for site to site, or client -&gt; server based architecture.</li>
<li>IPv4 only.</li>
<li>Linux only</li>
<li>Very Modern kernel 5.9+ at least (&gt;5.9 allows loops in ebpf and <code>bpf_link</code>)</li>
</ul>


<p dir="auto">With the introduction of the <code>MFATemplatesDirectory</code> option, you can now specify a directory that contains template files for customising the MFA entry, registration and wireguard config file.</p>
<p dir="auto">When the option is set, you must define <em>all</em> the files this guide is a brief description of what each file is:</p>

<div dir="auto" data-snippet-clipboard-copy-content="cd internal/router
sudo go test -v ."><pre><span>cd</span> internal/router
sudo go <span>test</span> -v <span>.</span></pre></div>
<p dir="auto">Sudo is required to load the eBPF program into the kernel.</p>

<p dir="auto">If you havent build the release docker image (used because it has a stable version of glibc) do the following:</p>
<div data-snippet-clipboard-copy-content="cd release_builder
sudo docker build -t wag_builder .
cd ..

make docker"><pre><code>cd release_builder
sudo docker build -t wag_builder .
cd ..

make docker
</code></pre></div>

<p dir="auto">If you&#39;re looking to add your own features, or bug fixes to wag (thank you!). Please make sure that you&#39;ve written a test for your changes if possible.</p>
<p dir="auto">Then open a pull request and we can discuss it there.</p>

<p dir="auto">If you like <code>wag</code> and use it to support your work flow, consider donating to the project. Your donations go directly towards the time and effort I put in, and the amount of support I can provide.</p>
<p dir="auto">You can do this by either using the <code>Support</code> button on the side or the cryptocurrency wallets detailed below.</p>
<p dir="auto">Monero (XMR):</p>
<p dir="auto">Bitcoin (BTC):</p>
</article></div></div>
  </body>
</html>
