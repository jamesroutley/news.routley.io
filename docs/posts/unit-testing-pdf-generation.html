<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://nibblestew.blogspot.com/2023/02/unit-testing-pdf-generation.html">Original</a>
    <h1>Unit Testing PDF Generation</h1>
    
    <div id="readability-page-1" class="page"><div id="post-body-4183303450228880841" itemprop="description articleBody">
<p>How would you test PDF generation?</p><p>This turns out to be unexpectedly difficult because you need to check that the files are both syntactically and semantically valid. The former could be tested with existing PDF validators and converters but the latter is more difficult.</p><p>If you, say, try to render a red square, the end result should be that the PDF command stream has two commands, a <span>re</span> command and an <span>f</span> command. That could be verified simply by grepping the command stream with some regexps. It would not be very useful, though, as there is no guarantee that those commands actually produce a red square in the output document. There are dozens of ways to make the output stream not produce a red square in the intended location without breaking file &#34;validity&#34; in any way.</p><p>The only reliable way is to render the PDF file into an image and compare it to a <i>ground truth</i> image. Assuming the output is &#34;close enough&#34; then the generator can be said to have worked correctly. The problem, as is often the case, lies inside those quote marks. Fuzzy image equality is a difficult problem. Those interested in details can look it up online. For our case we&#39;ll just ignore it and require pixel perfect reproduction. This means that we can have test failures if we change the PDF rendering backend, run it on a different operating system or even just upgrade it to a new version.</p><p>The other problem comes from the desire to have a plain C API. Writing unit tests in C is cumbersome to say the least. Fortunately there is a simpler solution. Since the project ships its own Python bindings, we can write all of these tests using Python. This affords us all the niceties that exist in Python such as an extensive unit testing suite, the ability to easily spawn external processes and image difference operators (via PIL). After some boilerplate, writing an unit tests reduces to this:</p><div><p><span>@validate_image(&#39;python_simple&#39;, 480, 640)</span></p><p><span>def test_simple(self, ofilename):</span></p><p><span>    ofile = pathlib.Path(ofilename)</span></p><p><span>    with a4pdf.Generator(ofile) as g:</span></p><p><span>        with g.page_draw_context() as ctx:</span></p><p><span>            ctx.set_rgb_nonstroke(1.0, 0.0, 0.0)</span></p><p><span>            ctx.cmd_re(10, 10, 100, 100)</span></p><p><span>            ctx.cmd_f()</span></p><p>Behind the scenes this will generate the PDF, render it with Ghostscript and compare the result to an existing image. If the output is not bitwise identical the test fails.</p></div>

</div></div>
  </body>
</html>
