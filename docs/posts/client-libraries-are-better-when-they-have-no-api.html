<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://csvbase.com/blog/7">Original</a>
    <h1>Client libraries are better when they have no API</h1>
    
    <div id="readability-page-1" class="page"><div>
      <div>
        <p>When I met a friend in a pub recently and I told him I was writing a client
library for csvbase, he did laugh a bit.  &#34;Can&#39;t people just use curl?&#34;</p>
<p>It&#39;s true.  On csvbase, you can just curl any table url and get a csv file.
Through the magic of HTTP, this web-page:</p>
<p><img src="https://csvbase.com/blog-static/stock-exchanges.png" alt="screenshot of csvbase table web
page"/></p>
<p>becomes this csv file inside curl:</p>
<p><img src="https://csvbase.com/blog-static/curl.png" alt="screenshot of csvbase table in
curl"/></p>
<p>[For details of how that trick works, see <a href="https://csvbase.com/blog/2">an older
blog post</a>]</p>
<p>That barely qualifies as an API, it&#39;s just HTTP.  So what possible use could a
client library be?</p>
<p>And of course client libraries add mental overhead of their own.  You have to
read some docs, learn some methods and then and the end you still have to add
some code to use whatever library it is.</p>
<p>Wouldn&#39;t you rather just not?</p>
<p>I would certainly rather not.  With that in mind, I&#39;ve written a client library
that has no API.</p>
<h2>No API</h2>
<p>Wait, no API?:</p>
<div><pre><span></span><span>&gt;&gt;&gt;</span> <span>import</span> <span>pandas</span> <span>as</span> <span>pd</span>
<span>&gt;&gt;&gt;</span> <span>df</span> <span>=</span> <span>pd</span><span>.</span><span>read_csv</span><span>(</span><span>&#34;csvbase://calpaterson/onion-vox-pops&#34;</span><span>)</span>
<span>&gt;&gt;&gt;</span> <span>df</span><span>.</span><span>quote</span><span>[</span><span>0</span><span>]</span>
<span>&#34;&#34;&#34;I realize passengers are concerned, but speaking as a pilot,</span>
<span>there&#39;s no better place to drop acid than 40,000 feet in the air.&#34;&#34;&#34;</span>
</pre></div>
<p>(A man after my own heart.)</p>
<p>But yes, no API.  I resent writing data APIs anyway (that&#39;s why I wrote
csvbase - to do it once, generically).  So if you want, just pull dataframes
down from csvbase with Pandas itself.  pip install
<a href="https://pypi.org/project/csvbase-client/"><code>csvbase-client</code></a> and Pandas will
suddenly learn the <code>csvbase://</code> url scheme.</p>
<p>And what if you want to write a dataframe to csvbase?  Is there an API for
that?  Again: no.  You call the usual method: <code>DataFrame.to_csv</code>:</p>
<div><pre><span></span><span>&gt;&gt;&gt;</span> <span>import</span> <span>string</span>  <span># from the stdlib</span>
<span>&gt;&gt;&gt;</span> <span>alphabet_df</span> <span>=</span> <span>pd</span><span>.</span><span>DataFrame</span><span>(</span><span>zip</span><span>(</span><span>range</span><span>(</span><span>1</span><span>,</span> <span>27</span><span>),</span> <span>string</span><span>.</span><span>ascii_lowercase</span><span>),</span>\
    <span>columns</span><span>=</span><span>(</span><span>&#34;number&#34;</span><span>,</span> <span>&#34;letter&#34;</span><span>))</span><span>.</span><span>set_index</span><span>(</span><span>&#34;number&#34;</span><span>)</span>
<span>&gt;&gt;&gt;</span> <span>alphabet_df</span><span>.</span><span>to_csv</span><span>(</span><span>&#34;csvbase://calpaterson/alphabet&#34;</span><span>)</span>
</pre></div>
<p>You do admittedly need to put your csvbase username and <strong>API key</strong> into
<code>~/.netrc</code> first.  Here&#39;s mine:</p>
<div><pre><span></span><span>machine csvbase.com</span><span></span>
<span>  </span><span>login calpaterson</span><span></span>
<span>  </span><span>password hunter42</span><span></span>
</pre></div>
<p>You can check up on <code>calpaterson/alphabet</code>: it&#39;s a <a href="https://csvbase.com/calpaterson/alphabet">real table on
csvbase.com</a> now.</p>
<p>But perhaps you don&#39;t like Pandas.  You prefer <a href="https://pola.rs/">Polars</a>, that
other dataframe library.  Again: I refuse to write an API.  You can just use
Polars itself:</p>
<div><pre><span></span><span>&gt;&gt;&gt;</span> <span>import</span> <span>polars</span> <span>as</span> <span>pl</span>
<span>&gt;&gt;&gt;</span> <span>pl</span><span>.</span><span>read_csv</span><span>(</span><span>&#34;csvbase://calpaterson/alphabet&#34;</span><span>)</span>
<span>shape</span><span>:</span> <span>(</span><span>26</span><span>,</span> <span>3</span><span>)</span>
<span>┌────────────────┬────────┬────────┐</span>
<span>│</span> <span>csvbase_row_id</span> <span>┆</span> <span>number</span> <span>┆</span> <span>letter</span> <span>│</span>
<span>│</span> <span>---</span>            <span>┆</span> <span>---</span>    <span>┆</span> <span>---</span>    <span>│</span>
<span>│</span> <span>i64</span>            <span>┆</span> <span>i64</span>    <span>┆</span> <span>str</span>    <span>│</span>
<span>╞════════════════╪════════╪════════╡</span>
<span>│</span> <span>1</span>              <span>┆</span> <span>1</span>      <span>┆</span> <span>a</span>      <span>│</span>
<span>│</span> <span>2</span>              <span>┆</span> <span>2</span>      <span>┆</span> <span>b</span>      <span>│</span>
<span>│</span> <span>3</span>              <span>┆</span> <span>3</span>      <span>┆</span> <span>c</span>      <span>│</span>
<span>│</span> <span>4</span>              <span>┆</span> <span>4</span>      <span>┆</span> <span>d</span>      <span>│</span>
<span>│</span> <span>5</span>              <span>┆</span> <span>5</span>      <span>┆</span> <span>e</span>      <span>│</span>
<span>│</span> <span>…</span>              <span>┆</span> <span>…</span>      <span>┆</span> <span>…</span>      <span>│</span>
<span>│</span> <span>22</span>             <span>┆</span> <span>22</span>     <span>┆</span> <span>v</span>      <span>│</span>
<span>│</span> <span>23</span>             <span>┆</span> <span>23</span>     <span>┆</span> <span>w</span>      <span>│</span>
<span>│</span> <span>24</span>             <span>┆</span> <span>24</span>     <span>┆</span> <span>x</span>      <span>│</span>
<span>│</span> <span>25</span>             <span>┆</span> <span>25</span>     <span>┆</span> <span>y</span>      <span>│</span>
<span>│</span> <span>26</span>             <span>┆</span> <span>26</span>     <span>┆</span> <span>z</span>      <span>│</span>
<span>└────────────────┴────────┴────────┘</span>
</pre></div>
<p>What about <a href="https://docs.dask.org/en/stable/">Dask</a>?  Same thing:</p>
<div><pre><span></span><span>&gt;&gt;&gt;</span> <span>import</span> <span>dask.dataframe</span> <span>as</span> <span>dd</span>
<span>&gt;&gt;&gt;</span> <span>dd</span><span>.</span><span>read_csv</span><span>(</span><span>&#34;csvbase://calpaterson/alphabet&#34;</span><span>)</span>
<span>Dask</span> <span>DataFrame</span> <span>Structure</span><span>:</span>
              <span>csvbase_row_id</span> <span>number</span>  <span>letter</span>
<span>npartitions</span><span>=</span><span>1</span>
                       <span>int64</span>  <span>int64</span>  <span>string</span>
                         <span>...</span>    <span>...</span>     <span>...</span>
<span>Dask</span> <span>Name</span><span>:</span> <span>read_csv</span><span>,</span> <span>1</span> <span>expression</span>
<span>Expr</span><span>=</span><span>ReadCSV</span><span>(</span><span>16</span><span>ad101</span><span>)</span>
</pre></div>
<p>I imported <code>pandas as pd</code>, I imported <code>polars as pl</code> and I imported
<code>dask.dataframe as dd</code>.  But I didn&#39;t import <code>csvbase_client</code>.  Unnecessary -
there is no API.</p>
<h2>Enter fsspec</h2>
<p>How is this all working?  Have I perpetrated a kind of grand, <a href="https://www.wired.com/story/jia-tan-xz-backdoor/">Jia Tan</a>-style
jedi mind trick on the maintainers of these dataframe libraries, secretly
sneaking csvbase-specific code into their repos?</p>
<p>I haven&#39;t.  All of these dataframe libraries (and probably others I haven&#39;t
thought of) use a standard filesystem interface library, called
<a href="https://github.com/fsspec/filesystem_spec/">fsspec</a>.  csvbase-client just
implements an adaptor for fsspec:</p>
<div><pre><span></span><span>from</span> <span>fsspec.spec</span> <span>import</span> <span>AbstractFileSystem</span><span>,</span> <span>AbstractBufferedFile</span>

<span>class</span> <span>CSVBaseFileSystem</span><span>(</span><span>AbstractFileSystem</span><span>):</span>
    <span>def</span> <span>_open</span><span>(</span><span>self</span><span>,</span> <span>path</span><span>,</span> <span>mode</span><span>=</span><span>&#34;rb&#34;</span><span>):</span>
        <span>return</span> <span>CSVBaseFile</span><span>(</span><span>self</span><span>,</span> <span>path</span><span>,</span> <span>mode</span><span>)</span>

<span>class</span> <span>CSVBaseFile</span><span>(</span><span>AbstractBufferedFile</span><span>):</span>
    <span>def</span> <span>_fetch_range</span><span>(</span><span>self</span><span>,</span> <span>start</span><span>:</span> <span>int</span><span>,</span> <span>end</span><span>:</span> <span>int</span><span>)</span> <span>-&gt;</span> <span>bytes</span><span>:</span>
        <span>...</span>
</pre></div>
<p>fsspec already comes with built-in adaptors for <a href="https://calpaterson.com/s3.html">object
stores</a>, webdav, Github, Dropbox and lots
more.  It&#39;s a pretty nice abstraction layer.  csvbase&#39;s client is just one more
adaptor.</p>
<p>For whatever reason, fsspec is not that well known.  It has less than 800 stars
<a href="https://github.com/fsspec/filesystem_spec/">on github</a>.  But it is well used:
it&#39;s downloaded <a href="https://pypistats.org/packages/fsspec">more than 8 million times a
day</a>, usually as an automatically
installed dependency of other libraries.  That actually makes it the 20th most
popular Python package - bigger in fact than Pandas.</p>
<p>At any rate, after my classes are written it just takes a short setuptools
incantation to wire my classes into place upon package install:</p>
<div><pre><span></span><span>from</span> <span>setuptools</span> <span>import</span> <span>setup</span>
<span>setup</span><span>(</span>
  <span>name</span><span>=</span><span>&#34;csvbase-client&#34;</span><span>,</span>
  <span>...</span><span>,</span> <span># [snip]</span>
  <span>entry_points</span><span>=</span><span>{</span>
    <span>&#34;fsspec.specs&#34;</span><span>:</span> <span>[</span>
      <span>&#34;csvbase=csvbase_client.fsspec.CSVBaseFileSystem&#34;</span><span>,</span>
    <span>],</span>
  <span>},</span>
<span>)</span>
</pre></div>
<p>Or in pyproject.toml:</p>
<div><pre><span></span><span>[project.entry-points.&#34;fsspec.specs&#34;]</span><span></span>
<span>csvbase</span><span> </span><span>=</span><span> </span><span>&#34;csvbase_client.fsspec.CSVBaseFileSystem&#34;</span><span></span>
</pre></div>
<p>With all this working, the <code>csvbase://</code> url scheme becomes real and you can use
it inside anything which relies on fsspec, which is a surprisingly large number
of things.</p>
<h2>How to use fsspec in your own programs</h2>
<p>fsspec is pretty nice.  It&#39;s very useful when you want, for example, to write a
cli program that can write both to a file, and then later an S3 object.</p>
<p>Instead of calling the Python built-in <code>open</code>, you call <code>fsspec.open</code>.  It is a
mostly drop-in replacement.</p>
<div><pre><span></span><span>import</span> <span>fsspec</span>

<span>with</span> <span>fsspec</span><span>.</span><span>open</span><span>(</span><span>&#34;csvbase://calpaterson/onion-vox-pops&#34;</span><span>)</span> <span>as</span> <span>vox_pops_f</span><span>:</span>
   <span>print</span><span>(</span><span>vox_pops_f</span><span>.</span><span>read</span><span>(</span><span>100</span><span>))</span>
</pre></div>
<p>That&#39;s it.  It is extremely simple to integrate against.</p>
<p>There isn&#39;t just <code>open</code>, either, but <code>touch</code>, <code>rm</code>, <code>cp</code>, <code>mv</code> - the whole
gang.  <code>csvbase-client</code>&#39;s support doesn&#39;t cover all of these yet, but that is
planned.</p>
<h2>And there&#39;s a cli tool</h2>
<p>I can&#39;t get out of writing a cli tool for csvbase.  There is no way to avoid
that - but I did make it a thin veneer over fsspec.</p>
<div><pre><span></span>$ csvbase-client table get calpaterson/alphabet
csvbase_row_id,number,letter
<span>1</span>,1,a
<span>2</span>,2,b
<span>3</span>,3,c
<span>[</span>you know the rest<span>]</span>
</pre></div>
<p>But <a href="https://csvbase.com/blog/5">other examples</a> are more fun:</p>
<div><pre><span></span>$ csvbase-client table get calpaterson/eurofxref-hist <span>|</span> <span>\</span>
grep USD <span>|</span> <span>\</span>
cut -d, -f <span>2</span>,4 <span>|</span> <span>\</span>
gnuplot -e <span>&#34;set datafile separator &#39;,&#39;; set term dumb; \</span>
<span>plot &#39;-&#39; using 1:2 with lines title &#39;usd&#39;&#34;</span>
</pre></div>
<p><img src="https://csvbase.com/blog-static/dumb-term.png" alt="a gnuplot graph in drawn in the
terminal"/></p>
<h2>The bytes on the internet are free and you can take them home with you</h2>
<p>As with <a href="https://github.com/calpaterson/csvbase">csvbase proper</a>,
<a href="https://github.com/calpaterson/csvbase-client">csvbase-client</a> is open source,
so you can just <a href="https://github.com/calpaterson/csvbase-client/blob/main/csvbase_client/fsspec.py">take my
code</a>
as a starting point and write your own fsspec APIs.</p>
<p>I&#39;m looking forward to expanding on it in future.  I&#39;m particularly keen to use
fsspec to <a href="https://filesystem-spec.readthedocs.io/en/latest/features.html#mount-anything-with-fuse">mount csvbase.com as a
filesystem</a>
via FUSE.  That sounds fun.</p>
<p>Help me out:</p>
<ul>
<li>try <a href="https://pypi.org/project/csvbase-client/">csvbase-client</a></li>
<li>
do me a solid by <a href="https://github.com/calpaterson/csvbase-client">starring csvbase-client on
github</a><ul>
<li>star the <a href="https://github.com/calpaterson/csvbase">main
project</a> as well if you&#39;re feeling
extra generous</li>
<li>regardless, shoot <a href="https://github.com/fsspec/filesystem_spec/">fsspec</a> a
github star because they did almost the work</li>
</ul>
</li>
<li><a href="mailto:cal@calpaterson.com">email me your thoughts</a></li>
<li>or <a href="https://github.com/calpaterson/csvbase-client/issues">file bugs on github</a></li>
</ul>

      </div>
    </div></div>
  </body>
</html>
