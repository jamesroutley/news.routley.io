<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.foxy.io/blog/cloudfront-vs-cloudflare-and-how-to-reduce-response-times-for-both-by-35/">Original</a>
    <h1>CloudFront vs. Cloudflare, and how to reduce response times for both (2021)</h1>
    
    <div id="readability-page-1" class="page"><div>
						<p><img width="900" height="600" src="https://www.foxy.io/blog/wp-content/uploads/cloudflare-cloudfront.jpg" alt="Amazon Cloudfront vs Cloudflare" loading="lazy" srcset="https://www.foxy.io/blog/wp-content/uploads/cloudflare-cloudfront.jpg 900w, https://www.foxy.io/blog/wp-content/uploads/cloudflare-cloudfront-300x200.jpg 300w, https://www.foxy.io/blog/wp-content/uploads/cloudflare-cloudfront-768x512.jpg 768w" sizes="(max-width: 900px) 100vw, 900px"/>						</p>
						
<p><strong>PREFACE:</strong> We like to provide a bit of background on our blog posts, but if you want, you can skip ahead to the <a href="#cloudfront_vs_cloudflare">CloudFront v. Cloudflare response times</a>.</p>



<p>üí° Also, important to note: For the purposes of this post, we‚Äôre <em>only</em> talking about our <strong>API</strong>, which is <em>entirely non-cacheable</em>.</p>



<hr/>



<p>As a ‚Äúmature‚Äù SaaS that went live in 2007, we‚Äôve been around long enough to have used a variety of services over the past decade and a half. Over the years, we‚Äôve gone from a single manually-configured bare metal server to a nice and tidy, Terraform-managed AWS infrastructure with all the fixin‚Äôs. We‚Äôve added additional programming languages, serverless systems, micro-services, and more. We‚Äôve seen SSL certs go from costly luxury items to automatically and freely provisioned. </p>



<p>Oh, and remember IE6? Because we do! (Or at least those of us that have at least a few gray hairs, some of which surely were caused by IE6.)</p>



<p>So much progress, both for us at Foxy, and for the internet at large. Truly amazing stuff.</p>



<h2>CloudFront &amp; Illusions of Perfection</h2>



<p>But with all that change, it‚Äôs sometimes easy to think we‚Äôve arrived at the ultimate solution. In our case, we‚Äôve felt that way about <a rel="noreferrer noopener" href="https://aws.amazon.com/route53/" target="_blank">Route53</a> (AWS‚Äôs DNS) and <a rel="noreferrer noopener" href="https://aws.amazon.com/cloudfront/" target="_blank">CloudFront</a> (AWS‚Äôs CDN). Route53 works well and is nice and easy to automate via Terraform and CloudFormation. CloudFront gets us a fantastically powerful and fast CDN to serve traffic globally. Yes, other CDNs exist, but why bother? Surely nobody could really do <em>that</em> much better than AWS, with its near-unlimited resources, right?</p>



<p><em>Well‚Ä¶</em> </p>



<h2>Cracks in the Fa√ßade</h2>



<p>A few months ago we started working with a company operating in Singapore and Hong Kong that‚Äôs using Foxy to expand their online services in the grocery and restaurant industries. Foxy was a perfect fit, but they were finding our API far too slow to meet their needs.</p>



<p>Which was weird, because when we moved to CloudFront a number of years ago, we tested response times from locations around the world, and our testing showed CloudFront absolutely <em>destroying</em> the other options in Asia-Pacific. So we figured CloudFront -&gt; load balancers in us-east-1 was as good as things could get. Surely local traffic to any CloudFront PoP (Point of Presence) should have <em>the fastest possible</em> traffic to servers in AWS US-East-1. Yes?</p>



<p>Apparently not. Our user was indeed seeing <em>really</em> slow API responses from Singapore. Well over a second, at the fastest. Definitely <em>too slow</em>.</p>



<p>Since we‚Äôve recently fallen in love with Terraform, and since Cloudflare could be added to our Terraform setup, we figured it testing our Cloudflare was worth a shot. Our previous concerns with mixing cloud providers primarily had to do with difficulties keeping things fully automated, but Terraform is a game changer in that regard.</p>



<p>So an hour or two later, we had Cloudflare added to a dev environment provisioned by Terraform, duplicating our Route53 DNS and sending traffic to our load balancer in us-east-1.</p>



<h2>First Impressions: Cloudflare is <em>REALLY</em> Impressive</h2>



<p>First we‚Äôll outline how we tested. We used <a rel="noreferrer noopener" href="https://www.site24x7.com/" target="_blank">Zoho‚Äôs Site24x7</a> to set up some basic monitors that made GET requests to our API, which has no caching, and responds with JSON. Good enough for our purposes.</p>



<p>What we‚Äôre calling ‚ÄúCloudFront‚Äù is CloudFront -&gt; ALB (Application Load Balancer) in us-east-1 -&gt; ECS Fargate. What we‚Äôre calling ‚ÄúCloudflare‚Äù is Cloudflare -&gt; ALB -&gt; ECS Fargate.</p>



<p>For our initial testing, we enabled <a rel="noreferrer noopener" href="https://www.cloudflare.com/products/argo-smart-routing/" target="_blank">Cloudflare‚Äôs Argo Smart Routing</a>, thinking that‚Äôd be a fair fight.</p>



<p>It was not.</p>



<p>So what did our tests show? In short, Cloudflare somehow manages to beat CloudFront (sometimes by silly margins), but <em>only</em> with their Argo smart routing enabled. Here are some comparisons for various locations in APAC.</p>



<figure><img loading="lazy" width="1386" height="650" src="https://www.foxy.io/blog/wp-content/uploads/Cloudflare-with-Argo-vs-CloudFront-2.png" alt="" srcset="https://www.foxy.io/blog/wp-content/uploads/Cloudflare-with-Argo-vs-CloudFront-2.png 1386w, https://www.foxy.io/blog/wp-content/uploads/Cloudflare-with-Argo-vs-CloudFront-2-300x141.png 300w, https://www.foxy.io/blog/wp-content/uploads/Cloudflare-with-Argo-vs-CloudFront-2-1024x480.png 1024w, https://www.foxy.io/blog/wp-content/uploads/Cloudflare-with-Argo-vs-CloudFront-2-768x360.png 768w" sizes="(max-width: 1386px) 100vw, 1386px"/><figcaption>Cloudflare on the left. CloudFront on the right.</figcaption></figure>



<p>Let‚Äôs break that down by location, with average response times (over a 7 day period, tested from all locations every 15 minutes) in milliseconds:</p>



<figure><table><tbody><tr><td><strong>Location</strong></td><td><strong>Cloudflare</strong></td><td><strong>CloudFront</strong></td></tr><tr><td>Sydney </td><td>423</td><td>689</td></tr><tr><td>Singapore</td><td>550</td><td>1319</td></tr><tr><td>Hong Kong</td><td>468</td><td>857</td></tr><tr><td>Mumbai</td><td>691</td><td>1012</td></tr><tr><td>Tokyo</td><td>654</td><td>942</td></tr><tr><td>Dubai</td><td>747</td><td>1199</td></tr><tr><td>Seoul</td><td>451</td><td>785</td></tr><tr><td>Manila</td><td>779</td><td>1161</td></tr></tbody></table><figcaption>Average response times in ms</figcaption></figure>



<p>Those results are impressive, to put it mildly. Almost 40% faster, on average, with Singapore showing a 50%+ reduction in pageloads. We know Cloudflare likes to talk about how great they are, but <em>everybody</em> claims they‚Äôre the best and the fastest, so we really didn‚Äôt expect this.</p>



<p>That said, this test was with Cloudflare‚Äôs Argo Smart Routing enabled. It sounds cool, but it‚Äôs an additional cost. Is it really doing anything, or is it just marketing fluff?</p>



<p>Easy answer: Argo is absolutely doing something. We don‚Äôt need to annotate this graph to show where it was disabled:</p>



<figure><img loading="lazy" width="994" height="433" src="https://www.foxy.io/blog/wp-content/uploads/Cloudflare-without-Argo.png" alt="Graph showing a large spike that persists, taking average response time from ~450ms to ~1s." srcset="https://www.foxy.io/blog/wp-content/uploads/Cloudflare-without-Argo.png 994w, https://www.foxy.io/blog/wp-content/uploads/Cloudflare-without-Argo-300x131.png 300w, https://www.foxy.io/blog/wp-content/uploads/Cloudflare-without-Argo-768x335.png 768w" sizes="(max-width: 994px) 100vw, 994px"/></figure>



<p>With Argo disabled, Cloudflare was immediately <em>slower</em> than CloudFront, by ~10%-20%. (We‚Äôll get into those numbers later.)</p>



<p>So at this point, it looked like CloudFront was just not good, to put it mildly.</p>



<h2>But wait‚Ä¶¬†CloudFront‚Äôs Origin Shield to the Rescue?</h2>



<p>We were actually all ready to switch one of our domains over to Cloudflare, but we were still in disbelief that CloudFront was so <em>bad</em>, so we reached out to our friendly AWS rep. He got us a meeting with a CloudFront expert on their end, who mentioned a few things:</p>



<ul><li>Cloudflare‚Äôs Argo is more comparable to <a rel="noreferrer noopener" href="https://aws.amazon.com/global-accelerator/" target="_blank">AWS‚Äôs Global Accelerator</a>. (This won‚Äôt actually work for us for a few reasons, mostly because of how we do so many different domains + SSL, so this was a non-starter. For our purposes, Cloudflare to CloudFront is a more reasonable comparison.)</li><li>Increasing the CloudFront origin keep-alive might help, especially when traffic will keep connections from CloudFront to the origin open. Good to note.</li><li><a href="https://aws.amazon.com/about-aws/whats-new/2020/10/announcing-amazon-cloudfront-origin-shield/#:~:text=Amazon%20CloudFront%20announces%20Origin%20Shield,to%20your%20origin%20per%20object.">CloudFront‚Äôs Origin Shield</a> might help.</li></ul>



<p>That last one was a surprise. According to AWS‚Äôs description of Origin Shield‚Ä¶¬†it doesn‚Äôt make sense that it‚Äôd improve performance for a non-cacheable API:</p>



<blockquote><p>Amazon CloudFront announces Origin Shield, a centralized caching layer that helps increase your cache hit ratio to reduce the load on your origin.</p></blockquote>



<p>For an API that‚Äôs never cacheable, why on earth would this help? Because nestled at the bottom of the <a rel="noreferrer noopener" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/origin-shield.html" target="_blank">Origin Shield Developer Guide</a> is this nugget:</p>



<blockquote><p><strong>Better network performance<br/></strong>When you enable Origin Shield [‚Ä¶] you can get better network performance. For origins in an AWS Region, CloudFront network traffic remains on the high throughput CloudFront network all the way to your origin.</p></blockquote>



<p>Still though‚Ä¶¬†how much could it help, right? <em>Surely</em> if AWS was sitting on some magic functionality that made things 20-50% faster, they wouldn‚Äôt bury that lede.</p>



<p>We weren‚Äôt expecting much, but turns out it brings CloudFront‚Äôs performance <em>about even with Cloudflare with Argo enabled</em>. Because of course it does. And because why not, I guess. It‚Äôs the year 2021 and nothing makes sense anymore.</p>



<h2 id="cloudfront_vs_cloudflare">TL;DR: Turn on Argo or Origin Shield!</h2>



<p>So, in summary: </p>



<ul id="block-51c59abb-0590-4895-95be-afc0999ca464"><li><strong>Turn on Origin Shield</strong> if you use CloudFront and care about response times, even for dynamic / uncacheable content. </li><li><strong>Turn on Argo</strong> if you use Cloudflare and care about response times.</li><li><strong>Talk to your AWS rep</strong> if you‚Äôre seeing another service just absolutely destroy the comparable AWS service. Maybe there‚Äôs a magic switch that you‚Äôd never assume actually solves the problem üôÇ</li></ul>



<h3>Average Response Times Globally</h3>



<p>The following table shows average response times in milliseconds (again, over a 7 day window, tested every 15 minutes). Lower numbers are better.</p>



<figure><table><tbody><tr><td><strong>Locations</strong></td><td><strong>Cloudflare</strong></td><td><strong>CloudFront</strong></td><td><strong>Cloudflare + Argo</strong></td><td><strong>CloudFront + Origin Shield</strong></td></tr><tr><td>Virginia</td><td>99</td><td>112</td><td>96</td><td>144</td></tr><tr><td>Houston</td><td>325</td><td>296</td><td>273</td><td>201</td></tr><tr><td>Los Angeles</td><td>427</td><td>423</td><td>304</td><td>200</td></tr><tr><td>Paris</td><td>499</td><td>401</td><td>261</td><td>214</td></tr><tr><td>London</td><td>519</td><td>443</td><td>304</td><td>200</td></tr><tr><td>Mexico City</td><td>647</td><td>757</td><td>640</td><td>769</td></tr><tr><td>Sydney</td><td>1093</td><td>963</td><td>534</td><td>427</td></tr><tr><td>Singapore</td><td>1208</td><td>1220</td><td>659</td><td>662</td></tr></tbody></table><figcaption>Response times in ms.</figcaption></figure>



<p>And that data graphed‚Ä¶</p>



<figure><img loading="lazy" width="1024" height="553" src="https://www.foxy.io/blog/wp-content/uploads/Screen-Shot-2021-11-08-at-10.48.40-PM-1024x553.png" alt="Bar graph showing response times for Cloudflare, CloudFront, Cloudflare + Argo, and CloudFront + Origin Shield." srcset="https://www.foxy.io/blog/wp-content/uploads/Screen-Shot-2021-11-08-at-10.48.40-PM-1024x553.png 1024w, https://www.foxy.io/blog/wp-content/uploads/Screen-Shot-2021-11-08-at-10.48.40-PM-300x162.png 300w, https://www.foxy.io/blog/wp-content/uploads/Screen-Shot-2021-11-08-at-10.48.40-PM-768x414.png 768w, https://www.foxy.io/blog/wp-content/uploads/Screen-Shot-2021-11-08-at-10.48.40-PM-1536x829.png 1536w, https://www.foxy.io/blog/wp-content/uploads/Screen-Shot-2021-11-08-at-10.48.40-PM.png 1990w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p>Response times from Virginia are a bit weird, as is Mexico City, but the clear average is a significant reduction of response times.</p>



<h3>Data From Our Production API</h3>



<p>The results were so encouraging that we turned on Origin Shield for our production API‚Äôs CloudFront distro. (All the other data we‚Äôve shown is for a staging environment.) Using <a rel="noreferrer noopener" href="https://www.foxy.io/blog/solving-cloudfront-mysteries-with-aws-athena/" target="_blank">AWS Athena</a>, we were able to average the hourly <code>time_taken</code> values for <em>all</em> traffic, globally. We don‚Äôt need to annotate where on the graph Origin Shield was enabled:</p>



<figure><img loading="lazy" width="1024" height="634" src="https://www.foxy.io/blog/wp-content/uploads/CloudFront-time_taken-hourly-average-1024x634.png" alt="" srcset="https://www.foxy.io/blog/wp-content/uploads/CloudFront-time_taken-hourly-average-1024x634.png 1024w, https://www.foxy.io/blog/wp-content/uploads/CloudFront-time_taken-hourly-average-300x186.png 300w, https://www.foxy.io/blog/wp-content/uploads/CloudFront-time_taken-hourly-average-768x476.png 768w, https://www.foxy.io/blog/wp-content/uploads/CloudFront-time_taken-hourly-average.png 1204w" sizes="(max-width: 1024px) 100vw, 1024px"/><figcaption>The data for this graph was obtained from <a href="https://docs.aws.amazon.com/athena/latest/ug/cloudfront-logs.html" target="_blank" rel="noreferrer noopener">AWS Athena querying CloudFront logs</a>, which is pretty slick.</figcaption></figure>



<p>The average went from 0.1419s to 0.0932s. That‚Äôs a ~34% reduction in request time for our production API, on average, for all requests globally (as seen by CloudFront, so excluding DNS and connection times). All from just flipping on a Origin Shield.</p>



<h2>Is this truly an üçé to üçè comparison?</h2>



<p>Sorta. Sorta not:</p>



<ul><li><strong>We‚Äôre only testing our API here.</strong> Cloudflare has a <em>lot</em> of really slick things they can do for more ‚Äúnormal‚Äù website traffic (like image optimization, js optimization, etc.). Our assumption is that, for a public-facing marketing site, Cloudflare is probably <em>much</em> better.</li><li><strong>The WAF (Web Application Firewall).</strong> Cloudflare‚Äôs WAF is almost undeniably ‚Äúbetter‚Äù by most of the metrics <em>most</em> people care about (like ‚Äúset it and forget it‚Äù). AWS‚Äôs WAF is sorta ‚Äúbuild what you want‚Äù, and we have some neat Lambda-powered automations for our specific use cases. But even for us, is that <em>really</em> what we want?</li><li><strong>Pricing is <em>very</em> different.</strong> <ul><li>Cloudflare‚Äôs bandwidth is free, but Argo is 10¬¢/GB. CloudFront‚Äôs is ~8¬¢/GB, but Origin Shield is 0.75¬¢ per 10k requests (for US origins). Let‚Äôs call this about even, assuming you care about the fastest response times.</li><li>Cloudflare‚Äôs WAF is free, but CloudFront‚Äôs WAF definitely isn‚Äôt. AWS WAF costs can add up, especially if you get hit by bots <em>constantly</em> like we do. (We pay hundreds of dollars a month just for traffic we rate-limit.) Note that if the AWS WAF blocks a request, you don‚Äôt pay for Origin Shield, which makes sense. (We‚Äôre not sure about Cloudflare‚Äôs WAF as it relates to Argo pricing.)</li><li>Cloudflare Workers and Lambda@Edge pricing scales a bit differently, but these costs tend to be negligible compared to the other costs (in our experience, at least).</li></ul></li><li><strong>SSL for multiple domains is <em>very</em> different.</strong> Though Cloudflare just recently made their ‚Äú<a rel="noreferrer noopener" href="https://developers.cloudflare.com/ssl/ssl-for-saas" target="_blank">SSL for SaaS</a>‚Äù publicly available (instead of enterprise-only), it‚Äôs $2/mo/domain. CloudFront + ACM is <em>free</em>. If you‚Äôve just got one domain, great, but if you‚Äôre a SaaS that allows custom domains like we do, this pushes Cloudflare from ‚Äúwe could probably save some money!‚Äù to ‚Äúwow‚Ä¶¬†even if we save all of what we‚Äôre paying for bandwidth and WAF, it‚Äôd still cost us a lot :(‚Äú.</li><li><strong>Cloudflare is supposedly faster for <a rel="noreferrer noopener" href="https://www.cloudflare.com/plans/enterprise/" target="_blank">Enterprise Plan </a>users.</strong> We don‚Äôt know if the ‚Äúnetwork prioritization‚Äù would make a significant difference. And though¬†we understand withholding features based on tiers, we prefer AWS‚Äôs <em>a la carte</em> pricing. Certainly feels more like we can get the best they offer without arbitrary pricing tiers.</li><li><strong>Testing more frequent requests may have changed things.</strong> Because of the way CloudFront and Cloudflare connect to origins, and keep connections open, if we tested multiple requests per minute (or second), we may have seen different values.</li><li><strong>Terraform (mostly) works great with both.</strong> If we did want to go with Cloudflare, Terraform makes going multi-cloud just beautifully manageable. So that‚Äôs nice üôÇ</li></ul>



<h2>A Final Note</h2>



<p>If you‚Äôve made it this far, we hope this was helpful. If you need a platform for custom ecommerce, let us know. We‚Äôre here to help üôÇ</p>



<p>We also hope AWS provides data like this in the future. Would have been pretty great if AWS promoted Origin Shield as ‚ÄúHey, turn this on and see a ~35%+ reduction in response times!‚Äù Would have saved us a fair number of hours. üôÇ</p>
						
					</div></div>
  </body>
</html>
