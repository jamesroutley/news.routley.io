<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://eev.ee/blog/2021/01/26/gamedev-from-scratch-1-scaffolding/">Original</a>
    <h1>Gamedev from Scratch 1: Scaffolding</h1>
    
    <div id="readability-page-1" class="page"><div>
            
            <p>Welcome to part 1 of this narrative series about writing a complete video game from scratch, using the <span>PICO</span>-8.  This is actually the second part, because in this house (unlike Lua) we index from 0, so if you’re new here you may want to consult the introductory stuff and table of contents in <a href="https://eev.ee/blog/2020/11/30/gamedev-from-scratch-0-groundwork/">part zero</a>.</p>
<p>If you’ve been following along, welcome back, and let’s dive right in!</p>


<p><strong><a href="https://eev.ee/blog/2020/11/30/gamedev-from-scratch-0-groundwork/">← Part 0: Groundwork</a></strong></p>
<h2 id="recap-and-short-term-plans"><a href="#recap-and-short-term-plans">Recap and short-term plans</a></h2>
<p>So far, I have…  this.  Which is something, and certainly much more than nothing, but all told not a lot.</p>
<p><img src="https://eev.ee/media/gamedev-from-scratch/v1-anise-moving3.gif" alt="Star Anise walking around the screen and turning to face the way he&#39;s moving"/>
</p>

<p>Most conspicuously, this is going to be a <em>platformer</em>, so I need gravity.  The problem with gravity is that it means things are always moving downwards, and if there’s nothing to stop them, they will continue off indefinitely into the void.</p>
<p>What I am trying to say here is that I feel the looming spectre of collision detection hanging over me.  I’m going to need it, and I’m going to need it <em>real soon</em>.</p>
<p>And, hey, that sucks.  Collision detection is a real big pain in the ass to write, so needing it this early is a hell of a big spike in the learning curve.  Luckily for you, someone else has already written it: me!</p>
<p>Before I can get to that, though, I need to add some structure to the code I have so far.  Everything I’ve written is designed to work for Star Anise <em>and only</em> Star Anise.  That’s perfectly fine when he’s the only thing in the game, but I don’t expect he’ll stay alone for long!  Collision detection in particular is a pretty major component of a platformer, so I definitely want to be able to reuse it for other things in the game.  Also, collision detection is a big fucking hairy mess, so I definitely want to be able to shove it in a corner somewhere I’ll never have to look at it again.</p>
<p>A good start would be to build towards having a corner to shove it into.</p>
<h2 id="adding-some-structure"><a href="#adding-some-structure">Adding some structure</a></h2>
<p>As of where I left off last time, my special <code>_update()</code> and <code>_draw()</code> functions are mostly full of code for updating and drawing Star Anise.  That doesn’t really sit right with me; as the main entry points, they should be about updating and drawing <em>the game itself</em>.  Star Anise is <em>part of</em> the game, but he isn’t the whole game.  All that code that’s specific to him should be put off in a little box somewhere.  Cats love to be in little boxes, you see.</p>
<p>This raises the question of how I want to structure this project in general.  And, I note: structuring a software project is <em>hard</em>, and you only really get a good sense of how to do it from experience.  I’m still not sure <em>I</em> have a good sense of how to do it.  Hell, I’m not convinced <em>anyone</em> has a good sense of how to do it.</p>
<p>Thankfully, this is a game, so it’s pretty obvious how to break it into pieces.  (The tradeoff is that everything in a game ends up entangled with everything else no matter how you structure it, alas.)  Star Anise is a separate <em>thing</em> in the game, so he might as well be a separate <em>thing</em> in the code.  Later on I’ll need some more abstract structuring, but as an extremely rough guideline: if I can give it a name, it’s a good candidate to be made into a <em>thing</em>.</p>
<p>But what, exactly, is a <em>thing</em> in code?  Most commonly (but not always), a <em>thing</em> is implemented with what’s called an <em>object</em> — a little bundle of data (what it <em>is</em>) with code (what it can <em>do</em>).  I already have both of these parts for Star Anise: he has data like his position and which way he’s facing, and he has code for doing things like updating or drawing himself.  A great first step would be to extract that stuff into an object, after which some other structure might reveal itself.</p>
<p>I do need to do one thing before I can turn get to that, though.  You see, Lua is one of the few languages in common use today that doesn’t <em>quite</em> have built-in support for objects.  Instead, it has all the building blocks you need to craft your own system for making objects.  On the one hand, the way it does that is very slick and clever.  On the other hand, it means you can’t write much Lua without cobbling together some arcane nonsense first, and also no one’s code quite works the same way.</p>
<p>Which brings me to the following magnificent monstrosity:</p>
<table><tbody><tr><td><div><pre><span> 1</span>
<span> 2</span>
<span> 3</span>
<span> 4</span>
<span> 5</span>
<span> 6</span>
<span> 7</span>
<span> 8</span>
<span> 9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
<span>15</span>
<span>16</span>
<span>17</span>
<span>18</span>
<span>19</span>
<span>20</span>
<span>21</span>
<span>22</span>
<span>23</span>
<span>24</span>
<span>25</span>
<span>26</span>
<span>27</span>
<span>28</span></pre></div></td><td><div><pre><span></span><code><span>function</span> <span>nop</span><span>(...)</span> <span>return</span> <span>...</span> <span>end</span>

<span>--------------------------------</span>
<span>-- simple object type</span>
<span>local</span> <span>obj</span> <span>=</span> <span>{</span><span>init</span> <span>=</span> <span>nop</span><span>}</span>
<span>obj</span><span>.</span><span>__index</span> <span>=</span> <span>obj</span>

<span>function</span> <span>obj</span><span>:</span><span>__call</span><span>(...)</span>
    <span>local</span> <span>o</span> <span>=</span> <span>setmetatable</span><span>({},</span> <span>self</span><span>)</span>
    <span>return</span> <span>o</span><span>,</span> <span>o</span><span>:</span><span>init</span><span>(...)</span>
<span>end</span>

<span>-- subclassing</span>
<span>function</span> <span>obj</span><span>:</span><span>extend</span><span>(</span><span>proto</span><span>)</span>
    <span>proto</span> <span>=</span> <span>proto</span> <span>or</span> <span>{}</span>

    <span>-- copy meta values, since lua doesn&#39;t walk the prototype chain to find them</span>
    <span>for</span> <span>k</span><span>,</span> <span>v</span> <span>in</span> <span>pairs</span><span>(</span><span>self</span><span>)</span> <span>do</span>
        <span>if</span> <span>sub</span><span>(</span><span>k</span><span>,</span> <span>1</span><span>,</span> <span>2</span><span>)</span> <span>==</span> <span>&#34;__&#34;</span> <span>then</span>
            <span>proto</span><span>[</span><span>k</span><span>]</span> <span>=</span> <span>v</span>
        <span>end</span>
    <span>end</span>

    <span>proto</span><span>.</span><span>__index</span> <span>=</span> <span>proto</span>
    <span>proto</span><span>.</span><span>__super</span> <span>=</span> <span>self</span>

    <span>return</span> <span>setmetatable</span><span>(</span><span>proto</span><span>,</span> <span>self</span><span>)</span>
<span>end</span>
</code></pre></div>
</td></tr></tbody></table>
<p>How does this work?  What does this mean?  What <em>is</em> a prototype chain, anyway?  Dearest reader: it extremely does not matter.  No one cares.  I would have to stare at this for ten minutes to even begin to explain it.  Every line is oozing with subtlety.  To be honest, even though I describe this series as “from scratch”, this is one of the very few things that I copy/pasted wholesale from an earlier game.  I know this does the bare minimum I need and I absolutely do not want to waste time reinventing it incorrectly.  To drive that point home: I wrote <em>collision detection</em> from scratch, but I <em>copy/pasted this</em>.  (But if you really want to know, I’ll explain it in an appendix.)</p>
<p>Feel free to copy/paste mine, if you like.  You can also find a number of tiny Lua object systems floating around online, but with tokens at a premium, I wanted something <em>microscopic</em>.  This basically does constructors, inheritance, and nothing else.</p>
<p>(Oh, I don’t think I mentioned, but the <code>--</code> prefix indicates a Lua <em>comment</em>.  Comments are ignored by the computer and tend to contain notes that are helpful for humans to follow.  They don’t count against the <span>PICO</span>-8 token limit, but they <em>do</em> count against the total size limit, alas.)</p>
<p>The upshot is that I can now write stuff like this:</p>
<table><tbody><tr><td><div><pre><span> 1</span>
<span> 2</span>
<span> 3</span>
<span> 4</span>
<span> 5</span>
<span> 6</span>
<span> 7</span>
<span> 8</span>
<span> 9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
<span>15</span>
<span>16</span>
<span>17</span>
<span>18</span>
<span>19</span></pre></div></td><td><div><pre><span></span><code><span>local</span> <span>vec</span> <span>=</span> <span>obj</span><span>:</span><span>extend</span><span>{}</span>

<span>function</span> <span>vec</span><span>:</span><span>init</span><span>(</span><span>x</span><span>,</span> <span>y</span><span>)</span>
    <span>self</span><span>.</span><span>x</span> <span>=</span> <span>x</span> <span>or</span> <span>0</span>
    <span>self</span><span>.</span><span>y</span> <span>=</span> <span>y</span> <span>or</span> <span>0</span>
<span>end</span>

<span>function</span> <span>vec</span><span>:</span><span>__add</span><span>(</span><span>v</span><span>)</span>
    <span>return</span> <span>vec</span><span>(</span><span>self</span><span>.</span><span>x</span> <span>+</span> <span>v</span><span>.</span><span>x</span><span>,</span> <span>self</span><span>.</span><span>y</span> <span>+</span> <span>v</span><span>.</span><span>y</span><span>)</span>
<span>end</span>

<span>function</span> <span>vec</span><span>:</span><span>__sub</span><span>(</span><span>v</span><span>)</span>
    <span>return</span> <span>vec</span><span>(</span><span>self</span><span>.</span><span>x</span> <span>-</span> <span>v</span><span>.</span><span>x</span><span>,</span> <span>self</span><span>.</span><span>y</span> <span>-</span> <span>v</span><span>.</span><span>y</span><span>)</span>
<span>end</span>

<span>function</span> <span>vec</span><span>:</span><span>iadd</span><span>(</span><span>v</span><span>)</span>
    <span>self</span><span>.</span><span>x</span> <span>+=</span> <span>v</span><span>.</span><span>x</span>
    <span>self</span><span>.</span><span>y</span> <span>+=</span> <span>v</span><span>.</span><span>y</span>
<span>end</span>
</code></pre></div>
</td></tr></tbody></table>
<p>This creates a…  well, terminology is tricky, but I’ll call it a <em>type</em> while doing air-quotes and glancing behind me to see if any Haskell programmers are listening.  (It’s not much like the notion of a type in many other languages, but it’s the closest I’m going to get.)  Now I can combine an x- and y-coordinate together as a single object, a single <em>thing</em>, without having to juggle them separately.  I’m calling that kind of thing a <code>vec</code>, short for <em>vector</em>, the name mathematicians give to a set of coordinates.  (More or less.  That’s not quite right, but don’t worry about it yet.)</p>


<p>After the above incantation, I can create <em>a</em> <code>vec</code> by calling it like a function.  Note that the arguments ultimately arrive in <code>vec:init</code>, loosely called a <em>constructor</em>, which stores them in <code>self.x</code> and <code>self.y</code> — where <code>self</code> is the <code>vec</code> being created.</p>
<table><tbody><tr><td><div><pre><span>1</span>
<span>2</span>
<span>3</span></pre></div></td><td><div><pre><span></span><code><span>-- this is example code, not part of the game</span>
<span>local</span> <span>a</span> <span>=</span> <span>vec</span><span>(</span><span>1</span><span>,</span> <span>2</span><span>)</span>
<span>print</span><span>(</span><span>&#34;x = &#34;</span><span>,</span> <span>a</span><span>.</span><span>x</span><span>,</span> <span>&#34; y = &#34;</span><span>,</span> <span>a</span><span>.</span><span>y</span><span>)</span>  <span>-- x = 1 y = 2</span>
</code></pre></div>
</td></tr></tbody></table>
<p>That <code>iadd</code> thing is a <em>method</em>, a special function that I can call <em>on</em> a <code>vec</code>.  It’s like every <code>vec</code> carries around its own little bag of functions anywhere it appears — and since they’re specific to <code>vec</code>, I don’t have to worry about reusing names.  (In fact, reusing names can be very helpful, as we’ll see later!)</p>
<p>The name <code>iadd</code> is (very!) short for “in-place add”, suggesting that the first vector adds the second vector <em>to itself</em> rather than creating a new third vector.  That’s something I expect to be doing a lot, and making a method for it saves me some precious tokens.</p>
<table><tbody><tr><td><div><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span></pre></div></td><td><div><pre><span></span><code><span>-- example code</span>
<span>local</span> <span>v</span> <span>=</span> <span>vec</span><span>(</span><span>1</span><span>,</span> <span>2</span><span>)</span>
<span>local</span> <span>w</span> <span>=</span> <span>vec</span><span>(</span><span>3</span><span>,</span> <span>4</span><span>)</span>
<span>v</span><span>:</span><span>iadd</span><span>(</span><span>w</span><span>)</span>
<span>print</span><span>(</span><span>&#34;x = &#34;</span><span>,</span> <span>v</span><span>.</span><span>x</span><span>,</span> <span>&#34; y = &#34;</span><span>,</span> <span>v</span><span>.</span><span>y</span><span>)</span>  <span>-- x = 4 y = 6</span>
</code></pre></div>
</td></tr></tbody></table>

<p>Finally, those funny <code>__add</code> and <code>__sub</code> methods are special to Lua (if enchanted correctly, which is part of what the <code>obj</code> gobbledygook does) — they let me use <code>+</code> and <code>-</code> on my <code>vec</code>s just like they were numbers.</p>
<table><tbody><tr><td><div><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span></pre></div></td><td><div><pre><span></span><code><span>-- example code</span>
<span>local</span> <span>q</span> <span>=</span> <span>vec</span><span>(</span><span>1</span><span>,</span> <span>2</span><span>)</span>
<span>local</span> <span>r</span> <span>=</span> <span>vec</span><span>(</span><span>3</span><span>,</span> <span>4</span><span>)</span>
<span>local</span> <span>s</span> <span>=</span> <span>q</span> <span>+</span> <span>r</span>
<span>print</span><span>(</span><span>&#34;x = &#34;</span><span>,</span> <span>s</span><span>.</span><span>x</span><span>,</span> <span>&#34; y = &#34;</span><span>,</span> <span>s</span><span>.</span><span>y</span><span>)</span>  <span>-- x = 4 y = 6</span>
</code></pre></div>
</td></tr></tbody></table>

<p>This is the core idea of objects.  A <code>vec</code> has some data — <code>x</code> and <code>y</code> — and some code — for adding another <code>vec</code> to itself.  If I later discover some new thing I want a <code>vec</code> to be able to do, I can add another method here, and it’ll be available on every <code>vec</code> throughout my game.  I can repeat myself a little bit less, <em>and</em> I can keep these related ideas together, separate from everything else.</p>
<p>Get the basic jist?  I hope so, because I’ve really gotta get a move on here.</p>
<h2 id="objectifying-star-anise"><a href="#objectifying-star-anise">Objectifying Star Anise</a></h2>
<p>Now that I have a way to define objects, I can turn Star Anise into one.</p>
<table><tbody><tr><td><div><pre><span> 1</span>
<span> 2</span>
<span> 3</span>
<span> 4</span>
<span> 5</span>
<span> 6</span>
<span> 7</span>
<span> 8</span>
<span> 9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
<span>15</span>
<span>16</span>
<span>17</span>
<span>18</span>
<span>19</span>
<span>20</span>
<span>21</span>
<span>22</span>
<span>23</span>
<span>24</span>
<span>25</span>
<span>26</span>
<span>27</span>
<span>28</span>
<span>29</span>
<span>30</span>
<span>31</span>
<span>32</span>
<span>33</span>
<span>34</span>
<span>35</span>
<span>36</span>
<span>37</span>
<span>38</span>
<span>39</span>
<span>40</span>
<span>41</span>
<span>42</span>
<span>43</span>
<span>44</span>
<span>45</span>
<span>46</span>
<span>47</span>
<span>48</span>
<span>49</span>
<span>50</span>
<span>51</span>
<span>52</span>
<span>53</span>
<span>54</span>
<span>55</span>
<span>56</span>
<span>57</span>
<span>58</span>
<span>59</span>
<span>60</span>
<span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span></pre></div></td><td><div><pre><span></span><code><span>function</span> <span>b2n</span><span>(</span><span>b</span><span>)</span>
    <span>return</span> <span>b</span> <span>and</span> <span>1</span> <span>or</span> <span>0</span>
<span>end</span>

<span>local</span> <span>t</span> <span>=</span> <span>0</span>
<span>local</span> <span>player</span>

<span>local</span> <span>anise_stand</span> <span>=</span> <span>{</span><span>1</span><span>,</span> <span>2</span><span>,</span> <span>17</span><span>,</span> <span>18</span><span>,</span> <span>33</span><span>,</span> <span>34</span><span>}</span>
<span>local</span> <span>anise_jump</span> <span>=</span> <span>{</span><span>3</span><span>,</span> <span>2</span><span>,</span> <span>17</span><span>,</span> <span>18</span><span>,</span> <span>19</span><span>,</span> <span>35</span><span>}</span>
<span>local</span> <span>anise</span> <span>=</span> <span>obj</span><span>:</span><span>extend</span><span>{</span>
    <span>move</span> <span>=</span> <span>vec</span><span>(),</span>
    <span>left</span> <span>=</span> <span>false</span><span>,</span>
<span>}</span>

<span>function</span> <span>anise</span><span>:</span><span>init</span><span>(</span><span>pos</span><span>)</span>
    <span>self</span><span>.</span><span>pos</span> <span>=</span> <span>pos</span>
<span>end</span>

<span>function</span> <span>anise</span><span>:</span><span>update</span><span>()</span>
    <span>if</span> <span>self</span><span>.</span><span>move</span><span>.</span><span>x</span> <span>&gt;</span> <span>0</span> <span>then</span>
        <span>self</span><span>.</span><span>left</span> <span>=</span> <span>false</span>
    <span>elseif</span> <span>self</span><span>.</span><span>move</span><span>.</span><span>x</span> <span>&lt;</span> <span>0</span> <span>then</span>
        <span>self</span><span>.</span><span>left</span> <span>=</span> <span>true</span>
    <span>end</span>

    <span>self</span><span>.</span><span>pos</span><span>:</span><span>iadd</span><span>(</span><span>self</span><span>.</span><span>move</span><span>)</span>
<span>end</span>

<span>function</span> <span>anise</span><span>:</span><span>draw</span><span>()</span>
    <span>local</span> <span>pose</span> <span>=</span> <span>anise_stand</span>
    <span>if</span> <span>(</span><span>self</span><span>.</span><span>move</span><span>.</span><span>x</span> <span>~=</span> <span>0</span> <span>or</span> <span>self</span><span>.</span><span>move</span><span>.</span><span>y</span> <span>~=</span> <span>0</span><span>)</span> <span>and</span> <span>t</span> <span>%</span> <span>8</span> <span>&lt;</span> <span>4</span> <span>then</span>
        <span>pose</span> <span>=</span> <span>anise_jump</span>
    <span>end</span>
    <span>local</span> <span>y</span> <span>=</span> <span>self</span><span>.</span><span>pos</span><span>.</span><span>y</span>
    <span>local</span> <span>x0</span> <span>=</span> <span>self</span><span>.</span><span>pos</span><span>.</span><span>x</span>
    <span>local</span> <span>dx</span> <span>=</span> <span>8</span>
    <span>if</span> <span>self</span><span>.</span><span>left</span> <span>then</span>
        <span>dx</span> <span>=</span> <span>-</span><span>8</span>
        <span>x0</span> <span>+=</span> <span>8</span>
    <span>end</span>
    <span>local</span> <span>x</span> <span>=</span> <span>x0</span>
    <span>for</span> <span>i</span> <span>=</span> <span>1</span><span>,</span> <span>#</span><span>pose</span> <span>do</span>
        <span>spr</span><span>(</span><span>pose</span><span>[</span><span>i</span><span>],</span> <span>x</span><span>,</span> <span>y</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>,</span> <span>self</span><span>.</span><span>left</span><span>)</span>
        <span>if</span> <span>i</span> <span>%</span> <span>2</span> <span>==</span> <span>0</span> <span>then</span>
            <span>x</span> <span>=</span> <span>x0</span>
            <span>y</span> <span>+=</span> <span>8</span>
        <span>else</span>
            <span>x</span> <span>+=</span> <span>dx</span>
        <span>end</span>
    <span>end</span>
<span>end</span>

<span>function</span> <span>_init</span><span>()</span>
    <span>player</span> <span>=</span> <span>anise</span><span>(</span><span>vec</span><span>(</span><span>64</span><span>,</span> <span>64</span><span>))</span>
<span>end</span>

<span>function</span> <span>_update</span><span>()</span>
    <span>t</span> <span>+=</span> <span>1</span>
    <span>t</span> <span>%=</span> <span>120</span>
    <span>player</span><span>.</span><span>move</span> <span>=</span> <span>vec</span><span>(</span>
        <span>b2n</span><span>(</span><span>btn</span><span>(</span><span>➡️</span><span>))</span> <span>-</span> <span>b2n</span><span>(</span><span>btn</span><span>(</span><span>⬅️</span><span>)),</span>
        <span>b2n</span><span>(</span><span>btn</span><span>(</span><span>⬇️</span><span>))</span> <span>-</span> <span>b2n</span><span>(</span><span>btn</span><span>(</span><span>⬆️</span><span>)))</span>
    <span>player</span><span>:</span><span>update</span><span>()</span>
<span>end</span>

<span>function</span> <span>_draw</span><span>()</span>
    <span>cls</span><span>()</span>
    <span>player</span><span>:</span><span>draw</span><span>()</span>
<span>end</span>
</code></pre></div>
</td></tr></tbody></table>
<p>What a mouthful!  But <em>for the most part</em>, this is the same code as before, just rearranged.  For example, the new <code>anise:draw()</code> method has basically been cut and pasted from my old <code>_draw()</code> — all except the <code>cls()</code> call, since that has nothing to do with drawing Star Anise.</p>
<p>I’ve combined the <code>px</code> and <code>py</code> variables into a single vector, <code>pos</code> (short for “position”), which I now have to refer to as <code>self.pos</code> — that’s so <span>PICO</span>-8 knows whose <code>pos</code> I’m talking about.  After all, it’s theoretically possible for me to create more than one Star Anise now.  I won’t, but <span>PICO</span>-8 doesn’t know that!</p>

<p>A Star Anise object is created and assigned to <code>player</code> when the game starts, and then <code>_update()</code> calls <code>player:update()</code> and <code>_draw()</code> calls <code>player:draw()</code> to get the same effects as before.</p>
<p>I did make one moderately dramatic change in this code.  The wordy code I had for reading buttons has become much more compact and inscrutable, and the <code>moving</code> variable is gone.  A big part of the reason for this is that I consider Star Anise’s <em>movement</em> to be part of himself, but reading input to be part of the <em>game</em>, so I wanted to split them up.  That means <code>moving</code> is a bit awkward, since I previously updated it as part of reading input.  Instead, I’ve turned Star Anise’s movement into another vector, which I set in <code>_update()</code> using this mouthful:</p>
<table><tbody><tr><td><div><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span></pre></div></td><td><div><pre><span></span><code><span>-- top-level</span>
<span>function</span> <span>b2n</span><span>(</span><span>b</span><span>)</span>
    <span>return</span> <span>b</span> <span>and</span> <span>1</span> <span>or</span> <span>0</span>
<span>end</span>

<span>-- in _update()</span>
    <span>player</span><span>.</span><span>move</span> <span>=</span> <span>vec</span><span>(</span>
        <span>b2n</span><span>(</span><span>btn</span><span>(</span><span>➡️</span><span>))</span> <span>-</span> <span>b2n</span><span>(</span><span>btn</span><span>(</span><span>⬅️</span><span>)),</span>
        <span>b2n</span><span>(</span><span>btn</span><span>(</span><span>⬇️</span><span>))</span> <span>-</span> <span>b2n</span><span>(</span><span>btn</span><span>(</span><span>⬆️</span><span>)))</span>
</code></pre></div>
</td></tr></tbody></table>
<p>The <code>b2n()</code> function turns a <strong>b</strong>utton into a <strong>n</strong>umber, and I only use it here.  It turns <code>true</code> into 1 and <code>false</code> into 0.  Think of it as measuring “how much” the button is held down, from 0 to 1, except of course there can’t be any answer in the middle.</p>

<p>Unpacking that a bit further, <code>b2n(btn(➡️)) - b2n(btn(⬅️))</code> means “how much we’re holding right, minus how much we’re holding left”.  If the player is only holding the right button, that’s 1 - 0 = 1.  If they’re only holding the left button, that’s 0 - 1 = -1.  If they’re holding both or neither, that’s 0.  The results are the same as before, but the code is smaller.</p>

<p>Once Star Anise’s <code>move</code> is set, the rest works similarly to before: I update <code>left</code> based on horizontal movement (but leave it alone when there isn’t anyway), I alter his position (now using <code>:iadd()</code>), and I use the walk animation when he’s moving at all.  And that’s it!</p>
<h2 id="from-one-to-many"><a href="#from-one-to-many">From one to many</a></h2>
<p>I like to use the term “actor” to refer to a distinct <em>thing</em> in the game world; it conjures a charming and concrete image of various characters performing on a stage.  I think I picked it up from the Doom source code.  “Entity” is more common and is used heavily in Unity, but can be confused with an “entity–component–system” setup, which Unity <em>also</em> supports.  And then there are heretics who refer to game things as “objects” even though that’s also a programming term.</p>
<p>This code is a fine start, but it’s not quite what I want.  There’s nothing here actually called an actor, for starters.  My setup still only works for Star Anise!</p>
<p>I’d better fix that.  The notion of an “actor” is pretty vague, so a generic actor won’t do much by itself, but it’s nice to define one as a template for how I expect real actors to work.</p>
<table><tbody><tr><td><div><pre><span> 1</span>
<span> 2</span>
<span> 3</span>
<span> 4</span>
<span> 5</span>
<span> 6</span>
<span> 7</span>
<span> 8</span>
<span> 9</span>
<span>10</span>
<span>11</span></pre></div></td><td><div><pre><span></span><code><span>local</span> <span>actor</span> <span>=</span> <span>obj</span><span>:</span><span>extend</span><span>{}</span>

<span>function</span> <span>actor</span><span>:</span><span>init</span><span>(</span><span>pos</span><span>)</span>
    <span>self</span><span>.</span><span>pos</span> <span>=</span> <span>pos</span>
<span>end</span>

<span>function</span> <span>actor</span><span>:</span><span>update</span><span>()</span>
<span>end</span>

<span>function</span> <span>actor</span><span>:</span><span>draw</span><span>()</span>
<span>end</span>
</code></pre></div>
</td></tr></tbody></table>
<p>How does a blank actor update or draw itself?  By doing nothing.</p>
<p>(I do assume that every actor has a position; this may not necessarily be the case in games with very broad ideas about what an “actor” is, but it’s reasonable enough for my purposes.)</p>
<p>Now, to link this with Star Anise, I’ll have <code>anise</code> <em>inherit</em> from <code>actor</code>.  That means he’ll become a specialized kind of <code>actor</code>, and in particular, all the methods on <code>actor</code> will also appear on <code>anise</code>.  You may notice that <code>anise</code> was previously a specialized kind of <code>obj</code> (like <code>actor</code> and <code>vec</code>) — in fact, the only reason I can call <code>vec(x, y)</code> like a function is that it inherits some magic stuff from <code>obj</code>. Surprise!</p>
<table><tbody><tr><td><div><pre><span>1</span></pre></div></td><td><div><pre><span></span><code><span>local</span> <span>anise</span> <span>=</span> <span>actor</span><span>:</span><span>extend</span><span>{</span>
</code></pre></div>
</td></tr></tbody></table>
<p>I can now delete <code>anise:init()</code>, since it’s identical to <code>actor:init()</code>.  I still have <code>anise:update()</code> and <code>anise:draw()</code>, which override the methods on <code>actor</code>, so those don’t need changing.</p>
<p>Everything <em>still</em> only works for Star Anise, but I’m getting closer!  I only need one more change.  Instead of having only <code>player</code>, I will make a <em>list</em> of actors.</p>

<table><tbody><tr><td><div><pre><span> 1</span>
<span> 2</span>
<span> 3</span>
<span> 4</span>
<span> 5</span>
<span> 6</span>
<span> 7</span>
<span> 8</span>
<span> 9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
<span>15</span>
<span>16</span>
<span>17</span>
<span>18</span>
<span>19</span>
<span>20</span>
<span>21</span></pre></div></td><td><div><pre><span></span><code><span>-- at the top</span>
<span>local</span> <span>actors</span> <span>=</span> <span>{}</span>

<span>function</span> <span>_init</span><span>()</span>
    <span>player</span> <span>=</span> <span>anise</span><span>(</span><span>vec</span><span>(</span><span>64</span><span>,</span> <span>64</span><span>))</span>
    <span>add</span><span>(</span><span>actors</span><span>,</span> <span>player</span><span>)</span>
<span>end</span>

<span>function</span> <span>_update</span><span>()</span>
    <span>-- ...mostly same as before...</span>
    <span>for</span> <span>actor</span> <span>in</span> <span>all</span><span>(</span><span>actors</span><span>)</span> <span>do</span>
        <span>actor</span><span>:</span><span>update</span><span>()</span>
    <span>end</span>
<span>end</span>

<span>function</span> <span>_draw</span><span>()</span>
    <span>cls</span><span>()</span>
    <span>for</span> <span>actor</span> <span>in</span> <span>all</span><span>(</span><span>actors</span><span>)</span> <span>do</span>
        <span>actor</span><span>:</span><span>draw</span><span>()</span>
    <span>end</span>
<span>end</span>
</code></pre></div>
</td></tr></tbody></table>
<p>This does pretty much what it reads like.  The <code>add()</code> function, specific to <span>PICO</span>-8, adds an item to the end of a list.  The <code>all()</code> function, also specific to <span>PICO</span>-8, helps go through a list.  And the <code>for</code> blocks mean, for each thing in this list, run this code.</p>
<p>Now, at last, I have something that could work for actors other than Star Anise.  All I need to do is define them and add them to the <code>actors</code> list, and they’ll automatically be updated and drawn, just like him!</p>

<p>Admittedly, this hasn’t gotten me anywhere concrete.  The game still plays exactly the same as it did when I started.  I’m betting that I’ll eventually have more than one actor, though, so I might as well lay the groundwork for that now while it’s easy.  It doesn’t take much effort, and I find that if I give myself little early inroads like this, it feels like less of a slog to later come back and expand on the ideas.  This is the sort of thing I meant by more structure revealing itself — once I have <em>one</em> actor, a natural next step is to allow for <em>several</em> actors.</p>
<h2 id="preparing-for-collision-detection"><a href="#preparing-for-collision-detection">Preparing for collision detection</a></h2>
<p>I’ve put it off long enough.  I can’t avoid it any longer.  But it’s complicated enough to deserve its own post, so I don’t quite want to do it yet.</p>
<p>Instead, I’ll write as much code as possible <em>except for</em> the actual collision detection.  There’s a bit more work to do to plug it in.</p>
<p>For example: what am I going to collide <em>with</em>?  The only thing in the universe, currently, is Star Anise himself.  It would be nice to have, say, some ground.  And that’s a great excuse to toodle around a bit in the sprite editor.</p>
<p><img src="https://eev.ee/media/gamedev-from-scratch/v1-ground.png" alt="A set of simple ground tiles, drawn in the PICO-8 sprite editor"/>
</p>

<p>I went through several iterations before landing on this.  Star Anise lives on a moon, so that was my guiding principle.  The moon is gray and dusty and pitted, so at first I tried drawing a tile with tiny craters in it.  Unfortunately, that was a busy mess to look at when tiled, and I didn’t think I’d have enough tile space for having different variants of tiles.  I’m already using 9 tiles here just to have neat edges.</p>
<p>And so I landed on this simple pattern with just enough texture to be reminiscent of <em>something</em>, which is all you really need with low-res sprite art.  It worked out well enough to survive, nearly unchanged, all the way to the final game.  It was inspired by a vague memory of Starbound’s <a href="https://starbounder.org/Moondust">moondust</a> tiles, which I was pretty sure had diagonal striping, though I didn’t actually look at them to be sure.</p>
<p>You may notice I drew these on the second tab of sprites.  I want to be able to find tiles quickly when drawing maps, so I thought I’d put “terrain” on a dedicated tab and reserve the first one for Star Anise, other actors, special effects, and other less-common tiles.  That turned out to be a good idea.</p>
<p>You may <em>also</em> notice that one of those dots on the middle right is lit up.  How mysterious!  We’ll get to that next time.</p>
<p>With a few simple tiles drawn, I can sprinkle a couple in the map tab.  I know I want Metroid-style discrete screens, so I’m not worried about camera scrolling yet; the top-left corner (16×16 tiles) is enough to play with for now.</p>
<p>I draw two rows of tiles at the bottom of that screen.  It’s a little hard to gauge since the toolbar and status bar get in the way, but the bottom row of the screen will be at y = 15.  You can also hold <kbd>Spacebar</kbd> to get a grid, with squares indicating every half-screen.</p>
<p><img src="https://eev.ee/media/gamedev-from-scratch/v1-map.png" alt="PICO-8&#39;s map editor, showing two rows of moon tiles"/>
</p>

<p>Finally, to make this appear in the game, I need only ask <span>PICO</span>-8 to draw the map before I draw actors on top of it.</p>
<table><tbody><tr><td><div><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span></pre></div></td><td><div><pre><span></span><code><span>function</span> <span>_draw</span><span>()</span>
    <span>cls</span><span>()</span>
    <span>map</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>32</span><span>,</span> <span>32</span><span>)</span>
    <span>for</span> <span>actor</span> <span>in</span> <span>all</span><span>(</span><span>actors</span><span>)</span> <span>do</span>
        <span>actor</span><span>:</span><span>draw</span><span>()</span>
    <span>end</span>
<span>end</span>
</code></pre></div>
</td></tr></tbody></table>
<p>The <span>PICO</span>-8 <code>map()</code> function takes (at least) six arguments: the top-left corner of the map to start drawing from, measured in tiles; the top-left corner on the screen to draw to, measured in pixels; and the width/height of the rectangle to draw from the map, measured in tiles.  This will draw a 32×32 block of tiles from the top-left corner of the map to the top-left corner of the screen.</p>

<p>Of course, with no collision detection, those tiles are nothing more than background pixels, and the game treats them as such.</p>
<p><img src="https://eev.ee/media/gamedev-from-scratch/v1-overlap.png" alt="Star Anise standing in front of the moon tiles"/>
</p>

<p>No problem.  I can fix that.  Sort of.</p>
<h2 id="not-quite-collision-detection"><a href="#not-quite-collision-detection">Not quite collision detection</a></h2>
<p>I’m not going into collision detection yet, but I can give you a <em>taste</em>, to give you an idea of the goals.</p>
<p>The core of it comes down to this line, from the end of <code>anise:update()</code>.</p>
<table><tbody><tr><td><div><pre><span>1</span></pre></div></td><td><div><pre><span></span><code>    <span>self</span><span>.</span><span>pos</span><span>:</span><span>iadd</span><span>(</span><span>self</span><span>.</span><span>move</span><span>)</span>
</code></pre></div>
</td></tr></tbody></table>
<p>That moves Star Anise by one pixel in each direction the player is holding.  What I want to do is <em>stop him</em> when he hits something solid.</p>
<p>Hm, sounds hard.  Let’s think for a moment about a simpler problem: how can I stop him falling through the ground, in the dumbest way possible?</p>
<p>The ground is flat, and it takes up the bottow two rows of tiles.  That means its top edge is 14 tiles, or 112 pixels, below the top of the screen.  Thus, Star Anise should not be able to move below that line.</p>
<p>But wait!  Star Anise’s <em>position</em> is a single point at his top left, not even inside his helmet.  What I really want is for his <em>feet</em> to not pass below that line, and the bottom of his feet is three tiles (24 pixels) below his position.  Thus, his position should not pass below y = 112 - 24 = 88.</p>
<p>That sounds doable.</p>
<table><tbody><tr><td><div><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span></pre></div></td><td><div><pre><span></span><code>    <span>self</span><span>.</span><span>pos</span><span>:</span><span>iadd</span><span>(</span><span>self</span><span>.</span><span>move</span><span>)</span>
    <span>if</span> <span>self</span><span>.</span><span>pos</span><span>.</span><span>y</span> <span>&gt;</span> <span>88</span> <span>then</span>
        <span>self</span><span>.</span><span>pos</span><span>.</span><span>y</span> <span>=</span> <span>88</span>
    <span>end</span>
</code></pre></div>
</td></tr></tbody></table>
<p>And sure enough, it works!</p>
<p><img src="https://eev.ee/media/gamedev-from-scratch/v1-collision-taste.gif" alt="Star Anise walking through the air, but not through the floor"/>
</p>

<p>This isn’t going to get us very far, of course.  He still walks through the air, he can still walk off the screen, and if I change the terrain then the code won’t be right any more.  I’m also pretty sure I didn’t actually write this in practice.  But hopefully it gives you the teeniest idea of the problem we’re going to solve next time.</p>
<p><strong>Part 2: Collision →</strong> (coming soon!)</p>
<h2 id="appendix-the-lua-object-model"><a href="#appendix-the-lua-object-model">Appendix: the Lua object model</a></h2>
<p>Really, really, <em>really</em> quickly, here’s how that <code>obj</code> snippet works.</p>
<p>Lua’s primary data structure is the <em>table</em>.  It can be used to make ordered lists of things, as I did above with <code>actors</code>, but it can also be used for arbitrary mappings.  I can assign some value to a particular <em>key</em>, then quickly look that key up again later.  Kind of like a Rolodex.</p>
<table><tbody><tr><td><div><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span></pre></div></td><td><div><pre><span></span><code><span>local</span> <span>lunekos</span> <span>=</span> <span>{</span>
    <span>anise</span> <span>=</span> <span>&#34;star anise is the best&#34;</span><span>,</span>
    <span>purrl</span> <span>=</span> <span>&#34;purrl is very lovely&#34;</span><span>,</span>
<span>}</span>
<span>print</span><span>(</span><span>lunekos</span><span>[</span><span>&#39;anise&#39;</span><span>])</span>
</code></pre></div>
</td></tr></tbody></table>
<p>Note that the values (and keys!) don’t have to be strings; they can be anything you like, even other tables.  But for string keys, you can do something special:</p>
<table><tbody><tr><td><div><pre><span>1</span></pre></div></td><td><div><pre><span></span><code><span>print</span><span>(</span><span>lunekos</span><span>.</span><span>anise</span><span>)</span>  <span>-- same as above</span>
</code></pre></div>
</td></tr></tbody></table>
<p><em>Everywhere</em> you see a dot (or colon) used in Lua, that’s actually looking up a string in a table.</p>
<p>With me so far?  Hope so.</p>
<p>Any Lua table can also be assigned a <em>metatable</em>, which is another table full of various magic stuff that affects the first table’s behavior.  Most of the magic stuff takes the form of a special key, starting with two underscores, whose value is a function that will be called in particular circumstances.  That function is then called a <em>metamethod</em>.  (There’s a <a href="https://www.lua.org/pil/13.html">whole section on this in the Lua book</a>, and <a href="http://lua-users.org/wiki/MetatableEvents">a summary of metamethods on the Lua wiki</a>.)</p>
<p>One common use for metamethods is to make normal Lua operators work on tables.  For example, you can make a table that can be called like a function by providing the <code>__call</code> metamethod.</p>
<table><tbody><tr><td><div><pre><span> 1</span>
<span> 2</span>
<span> 3</span>
<span> 4</span>
<span> 5</span>
<span> 6</span>
<span> 7</span>
<span> 8</span>
<span> 9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span></pre></div></td><td><div><pre><span></span><code><span>local</span> <span>t</span> <span>=</span> <span>{</span>
    <span>stuff</span> <span>=</span> <span>5678</span><span>,</span>
<span>}</span>
<span>local</span> <span>meta</span> <span>=</span> <span>{</span>
    <span>-- this is just a regular table key with a function for its value</span>
    <span>__call</span> <span>=</span> <span>function</span><span>(</span><span>tbl</span><span>)</span>
        <span>print</span><span>(</span><span>&#34;my stuff is&#34;</span><span>,</span> <span>tbl</span><span>[</span><span>&#39;stuff&#39;</span><span>])</span>
    <span>end</span><span>,</span>
<span>}</span>
<span>setmetatable</span><span>(</span><span>t</span><span>,</span> <span>meta</span><span>)</span>
<span>t</span><span>()</span>  <span>-- my stuff is 5678</span>
<span>t</span><span>[</span><span>&#39;stuff&#39;</span><span>]</span> <span>=</span> <span>&#34;yoinky&#34;</span>
<span>t</span><span>()</span>  <span>-- my stuff is yoinky</span>
</code></pre></div>
</td></tr></tbody></table>
<p>One especially useful metamethod is <code>__index</code>, which is called when you try to read a key from the table, but the key doesn’t exist.</p>
<table><tbody><tr><td><div><pre><span> 1</span>
<span> 2</span>
<span> 3</span>
<span> 4</span>
<span> 5</span>
<span> 6</span>
<span> 7</span>
<span> 8</span>
<span> 9</span>
<span>10</span>
<span>11</span>
<span>12</span></pre></div></td><td><div><pre><span></span><code><span>local</span> <span>counts</span> <span>=</span> <span>{</span>
    <span>apples</span> <span>=</span> <span>5</span><span>,</span>
    <span>bananas</span> <span>=</span> <span>3</span><span>,</span>
<span>}</span>
<span>setmetatable</span><span>(</span><span>counts</span><span>,</span> <span>{</span>
    <span>__index</span> <span>=</span> <span>function</span><span>(</span><span>tbl</span><span>,</span> <span>key</span><span>)</span>
        <span>return</span> <span>0</span>
    <span>end</span><span>,</span>
<span>})</span>
<span>print</span><span>(</span><span>counts</span><span>.</span><span>bananas</span><span>)</span>  <span>-- 3</span>
<span>print</span><span>(</span><span>counts</span><span>.</span><span>mangoes</span><span>)</span>  <span>-- 0</span>
<span>print</span><span>(</span><span>counts</span><span>.</span><span>apples</span><span>)</span>  <span>-- 5</span>
</code></pre></div>
</td></tr></tbody></table>
<p>Instead of a function, <code>__index</code> can also be <em>another</em> (third!) table, in which case the key will be looked up in <em>that</em> table instead.  And if that table has a metatable with an <code>__index</code>, Lua will follow that too, and keep on going until it gets an answer.</p>
<p>This is essentially what’s called <em>prototypical inheritance</em>, as seen in JavaScript (and more subtly in Python): an object consists of its own values plus a <em>prototype</em>, and if code tries to fetch something from the object that doesn’t exist, the prototype is checked instead.  Since the prototype might have its own prototype, the whole sequence is called the <em>prototype chain</em>.</p>
<p>That’s all you need to know to follow the <code>obj</code> snippet, so here it is again.</p>
<table><tbody><tr><td><div><pre><span> 1</span>
<span> 2</span>
<span> 3</span>
<span> 4</span>
<span> 5</span>
<span> 6</span>
<span> 7</span>
<span> 8</span>
<span> 9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
<span>15</span>
<span>16</span>
<span>17</span>
<span>18</span>
<span>19</span>
<span>20</span>
<span>21</span>
<span>22</span>
<span>23</span>
<span>24</span>
<span>25</span>
<span>26</span></pre></div></td><td><div><pre><span></span><code><span>function</span> <span>nop</span><span>(...)</span> <span>return</span> <span>...</span> <span>end</span>

<span>local</span> <span>obj</span> <span>=</span> <span>{</span><span>init</span> <span>=</span> <span>nop</span><span>}</span>
<span>obj</span><span>.</span><span>__index</span> <span>=</span> <span>obj</span>

<span>function</span> <span>obj</span><span>:</span><span>__call</span><span>(...)</span>
    <span>local</span> <span>o</span> <span>=</span> <span>setmetatable</span><span>({},</span> <span>self</span><span>)</span>
    <span>return</span> <span>o</span><span>,</span> <span>o</span><span>:</span><span>init</span><span>(...)</span>
<span>end</span>

<span>-- subclassing</span>
<span>function</span> <span>obj</span><span>:</span><span>extend</span><span>(</span><span>proto</span><span>)</span>
    <span>proto</span> <span>=</span> <span>proto</span> <span>or</span> <span>{}</span>

    <span>-- copy meta values, since lua doesn&#39;t walk the prototype chain to find them</span>
    <span>for</span> <span>k</span><span>,</span> <span>v</span> <span>in</span> <span>pairs</span><span>(</span><span>self</span><span>)</span> <span>do</span>
        <span>if</span> <span>sub</span><span>(</span><span>k</span><span>,</span> <span>1</span><span>,</span> <span>2</span><span>)</span> <span>==</span> <span>&#34;__&#34;</span> <span>then</span>
            <span>proto</span><span>[</span><span>k</span><span>]</span> <span>=</span> <span>v</span>
        <span>end</span>
    <span>end</span>

    <span>proto</span><span>.</span><span>__index</span> <span>=</span> <span>proto</span>
    <span>proto</span><span>.</span><span>__super</span> <span>=</span> <span>self</span>

    <span>return</span> <span>setmetatable</span><span>(</span><span>proto</span><span>,</span> <span>self</span><span>)</span>
<span>end</span>
</code></pre></div>
</td></tr></tbody></table>
<p>The idea is that types are used both as metatables <em>and</em> prototypes — they are always their own <code>__index</code>.  At first, we have only <code>obj</code>, which looks like this:</p>
<table><tbody><tr><td><div><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span></pre></div></td><td><div><pre><span></span><code><span>local</span> <span>obj</span> <span>=</span> <span>{</span>
    <span>init</span> <span>=</span> <span>nop</span><span>,</span>
    <span>__index</span> <span>=</span> <span>obj</span><span>,</span>
    <span>__call</span> <span>=</span> <span>function</span><span>()</span> <span>...</span> <span>end</span><span>,</span>
    <span>extend</span> <span>=</span> <span>function</span><span>()</span> <span>...</span> <span>end</span><span>,</span>
<span>}</span>
</code></pre></div>
</td></tr></tbody></table>
<p>Now we use <code>obj:extend{}</code> to create a new type.  Follow along and see what happens.  Lua only looks for metamethods like <code>__call</code> directly in the metatable and ignores <code>__index</code>, so I copy them into the new prototype.  Then I make the prototype its own <code>__index</code>, as with <code>obj</code>, and also remember the “superclass” as <code>__super</code> (though I never end up using it).  Finally I set the “superclass” as the prototype’s metatable.</p>
<p>(Oh, by the way: in Lua, if you call a function with only a single table or string literal as its argument, you can leave off the parentheses.  So <code>foo{}</code> just means <code>foo({})</code>.)</p>
<p>That produces something like the following, noting that this is not quite real Lua syntax:</p>
<table><tbody><tr><td><div><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span></pre></div></td><td><div><pre><span></span><code><span>local</span> <span>vec</span> <span>=</span> <span>{</span>
    <span>__index</span> <span>=</span> <span>vec</span><span>,</span>
    <span>__super</span> <span>=</span> <span>obj</span><span>,</span>
    <span>__call</span> <span>=</span> <span>obj</span><span>.</span><span>__call</span><span>,</span>

    <span>METATABLE</span> <span>=</span> <span>obj</span><span>,</span>
<span>}</span>
</code></pre></div>
</td></tr></tbody></table>
<p>Remember this syntax?</p>
<table><tbody><tr><td><div><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span></pre></div></td><td><div><pre><span></span><code><span>function</span> <span>vec</span><span>:</span><span>init</span><span>(</span><span>x</span><span>,</span> <span>y</span><span>)</span>
    <span>self</span><span>.</span><span>x</span> <span>=</span> <span>x</span> <span>or</span> <span>0</span>
    <span>self</span><span>.</span><span>y</span> <span>=</span> <span>y</span> <span>or</span> <span>0</span>
<span>end</span>
</code></pre></div>
</td></tr></tbody></table>
<p>That is exactly equivalent to:</p>
<table><tbody><tr><td><div><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span></pre></div></td><td><div><pre><span></span><code><span>vec</span><span>.</span><span>init</span> <span>=</span> <span>function</span><span>(</span><span>self</span><span>,</span> <span>x</span><span>,</span> <span>y</span><span>)</span>
    <span>self</span><span>.</span><span>x</span> <span>=</span> <span>x</span> <span>or</span> <span>0</span>
    <span>self</span><span>.</span><span>y</span> <span>=</span> <span>y</span> <span>or</span> <span>0</span>
<span>end</span>
</code></pre></div>
</td></tr></tbody></table>
<p>So after all is said and done, we have:</p>
<table><tbody><tr><td><div><pre><span> 1</span>
<span> 2</span>
<span> 3</span>
<span> 4</span>
<span> 5</span>
<span> 6</span>
<span> 7</span>
<span> 8</span>
<span> 9</span>
<span>10</span>
<span>11</span>
<span>12</span></pre></div></td><td><div><pre><span></span><code><span>local</span> <span>vec</span> <span>=</span> <span>{</span>
    <span>__index</span> <span>=</span> <span>vec</span><span>,</span>
    <span>__super</span> <span>=</span> <span>obj</span><span>,</span>
    <span>__call</span> <span>=</span> <span>obj</span><span>.</span><span>__call</span><span>,</span>

    <span>init</span> <span>=</span> <span>function</span><span>()</span> <span>...</span> <span>end</span><span>,</span>
    <span>__add</span> <span>=</span> <span>function</span><span>()</span> <span>...</span> <span>end</span><span>,</span>
    <span>__sub</span> <span>=</span> <span>function</span><span>()</span> <span>...</span> <span>end</span><span>,</span>
    <span>iadd</span> <span>=</span> <span>function</span><span>()</span> <span>...</span> <span>end</span><span>,</span>

    <span>METATABLE</span> <span>=</span> <span>obj</span><span>,</span>
<span>}</span>
</code></pre></div>
</td></tr></tbody></table>
<p>Now for the magic part.  When I call <code>vec()</code>, Lua checks the metatable.  (The <code>__call</code> in the main table does nothing!)  The metatable is <code>obj</code>, which does have a <code>__call</code>, so Lua calls that function and inserts <code>vec</code> as the first argument.  Then <code>obj.__call</code> creates an empty table, assigns <code>self</code> (which is the first argument, so <code>vec</code>) as the empty table’s metatable, and calls the new table’s <code>init</code> method.</p>
<p>Ah, but the new table is empty, so it doesn’t <em>have</em> an <code>init</code> method.  No problem: it has a metatable with an <code>__index</code>, so Lua consults that instead.  The metatable’s <code>__index</code> is <code>vec</code>, and <code>vec</code> <em>does</em> contain an <code>init</code>, so that’s what gets called.  (If there were no <code>vec.init</code>, then Lua would see that vec <em>also</em> has a metatable with an <code>__index</code>, and continued along.  That’s why I didn’t need an <code>anise.init</code>.)</p>
<p>That’s also why defining <code>vec:__add</code> works — it puts the <code>__add</code> metamethod into <code>vec</code>, which becomes the metatable for all vector objects, thus automatically making <code>+</code> work on them.</p>
<p>That’s all there is to it.  It’s possible to get much more elaborate with this in a number of ways, but this is the bare minimum — and it could still be trimmed down further.</p>
<p>Note that you can’t actually call <code>obj</code> itself.  Pop quiz: why not?</p>
        </div></div>
  </body>
</html>
