<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://cocoindex.io/blogs/knowledge-graph-for-docs/">Original</a>
    <h1>Build real-time knowledge graph for documents with LLM</h1>
    
    <div id="readability-page-1" class="page"><div id="__blog-post-container"><p><img decoding="async" loading="lazy" alt="Building Knowledge Graph for Documents with LLM" src="https://cocoindex.io/blogs/assets/images/cover-3369a7567abd2f4d81d81c6f0d153aea.png" width="3069" height="2697"/></p>
<p>CocoIndex makes it easy to build and maintain knowledge graphs with continuous source updates. In this blog, we will process a list of documents (using CocoIndex documentation as an example). We will use LLM to extract relationships between the concepts in each document. We will generate two kinds of relationships:</p>
<ol>
<li>Relationships between subjects and objects. E.g., &#34;CocoIndex supports Incremental Processing&#34;</li>
<li>Mentions of entities in a document. E.g., &#34;core/basics.mdx&#34; mentions <code>CocoIndex</code> and <code>Incremental Processing</code>.</li>
</ol>
<p>The source code is available at <a href="https://github.com/cocoindex-io/cocoindex/tree/main/examples/docs_to_knowledge_graph" target="_blank" rel="noopener noreferrer">CocoIndex Examples - docs_to_knowledge_graph</a>.</p>
<p><img decoding="async" loading="lazy" alt="Example knowledge graph showing relationships between concepts in CocoIndex documentation" src="https://cocoindex.io/blogs/assets/images/example-explanation-49f2a253cb339f43a69a6b654728063e.png" width="1731" height="837"/></p>
<p>We are constantly improving, and more features and examples are coming soon.
Stay tuned and follow our progress by starring our <a href="https://github.com/cocoindex-io/cocoindex" target="_blank" rel="noopener noreferrer">GitHub repo</a>.</p>
<h2 id="prerequisites">Prerequisites<a href="#prerequisites" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h2>
<ul>
<li><a href="https://cocoindex.io/docs/getting_started/installation#-install-postgres" target="_blank" rel="noopener noreferrer">Install PostgreSQL</a>. CocoIndex uses PostgreSQL internally for incremental processing.</li>
<li><a href="https://cocoindex.io/docs/ops/storages#Neo4j" target="_blank" rel="noopener noreferrer">Install Neo4j</a>, a graph database.</li>
<li><a href="https://cocoindex.io/docs/ai/llm#openai" target="_blank" rel="noopener noreferrer">Configure your OpenAI API key</a>. Alternatively, you can switch to Ollama, which runs LLM models locally - <a href="https://cocoindex.io/docs/ai/llm#ollama" target="_blank" rel="noopener noreferrer">guide</a>.</li>
</ul>
<h2 id="documentation">Documentation<a href="#documentation" aria-label="Direct link to Documentation" title="Direct link to Documentation">​</a></h2>
<p>You can read the official CocoIndex Documentation for Property Graph Targets <a href="https://cocoindex.io/docs/ops/storages#property-graph-targets" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h2 id="data-flow-to-build-knowledge-graph">Data flow to build knowledge graph<a href="#data-flow-to-build-knowledge-graph" aria-label="Direct link to Data flow to build knowledge graph" title="Direct link to Data flow to build knowledge graph">​</a></h2>
<p><img decoding="async" loading="lazy" alt="Data Flow" src="https://cocoindex.io/blogs/assets/images/data-flow-9acf8fc231ceac4ef3b04dc71eb5ed03.png" width="3069" height="1334"/></p>
<h3 id="add-documents-as-source">Add documents as source<a href="#add-documents-as-source" aria-label="Direct link to Add documents as source" title="Direct link to Add documents as source">​</a></h3>
<p>We will process CocoIndex documentation markdown files (<code>.md</code>, <code>.mdx</code>) from the <code>docs/core</code> directory (<a href="https://github.com/cocoindex-io/cocoindex/tree/main/docs/docs/core" target="_blank" rel="noopener noreferrer">markdown files</a>, <a href="https://cocoindex.io/docs/core/basics" target="_blank" rel="noopener noreferrer">deployed docs</a>).</p>
<div><div><pre tabindex="0"><code><span><span>@cocoindex</span><span>.</span><span>flow_def</span><span>(</span><span>name</span><span>=</span><span>&#34;DocsToKG&#34;</span><span>)</span><span></span><br/></span><span><span></span><span>def</span><span> </span><span>docs_to_kg_flow</span><span>(</span><span>flow_builder</span><span>:</span><span> cocoindex</span><span>.</span><span>FlowBuilder</span><span>,</span><span> data_scope</span><span>:</span><span> cocoindex</span><span>.</span><span>DataScope</span><span>)</span><span>:</span><span></span><br/></span><span><span>    data_scope</span><span>[</span><span>&#34;documents&#34;</span><span>]</span><span> </span><span>=</span><span> flow_builder</span><span>.</span><span>add_source</span><span>(</span><span></span><br/></span><span><span>        cocoindex</span><span>.</span><span>sources</span><span>.</span><span>LocalFile</span><span>(</span><span>path</span><span>=</span><span>&#34;../../docs/docs/core&#34;</span><span>,</span><span></span><br/></span><span><span>                                    included_patterns</span><span>=</span><span>[</span><span>&#34;*.md&#34;</span><span>,</span><span> </span><span>&#34;*.mdx&#34;</span><span>]</span><span>)</span><span>)</span><br/></span></code></pre></div></div>
<p>Here <code>flow_builder.add_source</code> creates a <a href="https://cocoindex.io/docs/core/data_types#KTable" target="_blank" rel="noopener noreferrer">KTable</a>.
<code>filename</code> is the key of the KTable.</p>
<p><img decoding="async" loading="lazy" alt="Adding a source to the flow" src="https://cocoindex.io/blogs/assets/images/data-add-source-6f03cf7504f4528d67b9910266752e6f.png" width="1484" height="431"/></p>
<h3 id="add-data-collectors">Add data collectors<a href="#add-data-collectors" aria-label="Direct link to Add data collectors" title="Direct link to Add data collectors">​</a></h3>
<p>Add collectors at the root scope:</p>
<div><div><pre tabindex="0"><code><span><span>document_node </span><span>=</span><span> data_scope</span><span>.</span><span>add_collector</span><span>(</span><span>)</span><span></span><br/></span><span><span>entity_relationship </span><span>=</span><span> data_scope</span><span>.</span><span>add_collector</span><span>(</span><span>)</span><span></span><br/></span><span><span>entity_mention </span><span>=</span><span> data_scope</span><span>.</span><span>add_collector</span><span>(</span><span>)</span><br/></span></code></pre></div></div>
<ul>
<li><code>document_node</code> collects documents. E.g., <a href="https://cocoindex.io/docs/core/basics" target="_blank" rel="noopener noreferrer"><code>core/basics.mdx</code></a> is a document.</li>
<li><code>entity_relationship</code> collects relationships. E.g., &#34;CocoIndex supports Incremental Processing&#34; indicates a relationship between <code>CocoIndex</code> and <code>Incremental Processing</code>.</li>
<li><code>entity_mention</code> collects mentions of entities in a document. E.g., <a href="https://cocoindex.io/docs/core/basics" target="_blank" rel="noopener noreferrer"><code>core/basics.mdx</code></a> mentions <code>CocoIndex</code> and <code>Incremental Processing</code>.</li>
</ul>
<h3 id="process-each-document-and-extract-summary">Process each document and extract summary<a href="#process-each-document-and-extract-summary" aria-label="Direct link to Process each document and extract summary" title="Direct link to Process each document and extract summary">​</a></h3>
<p>Define a <code>DocumentSummary</code> data class to extract the summary of a document.</p>
<div><div><pre tabindex="0"><code><span><span>@dataclasses</span><span>.</span><span>dataclass</span><span></span><br/></span><span><span></span><span>class</span><span> </span><span>DocumentSummary</span><span>:</span><span></span><br/></span><span><span>    title</span><span>:</span><span> </span><span>str</span><span></span><br/></span><span><span>    summary</span><span>:</span><span> </span><span>str</span><br/></span></code></pre></div></div>
<p>Within the flow, use <a href="https://cocoindex.io/docs/ops/functions#extractbyllm" target="_blank" rel="noopener noreferrer"><code>cocoindex.functions.ExtractByLlm</code></a> for structured output.</p>
<div><div><pre tabindex="0"><code><span><span>with</span><span> data_scope</span><span>[</span><span>&#34;documents&#34;</span><span>]</span><span>.</span><span>row</span><span>(</span><span>)</span><span> </span><span>as</span><span> doc</span><span>:</span><span></span><br/></span><span><span>    doc</span><span>[</span><span>&#34;summary&#34;</span><span>]</span><span> </span><span>=</span><span> doc</span><span>[</span><span>&#34;content&#34;</span><span>]</span><span>.</span><span>transform</span><span>(</span><span></span><br/></span><span><span>            cocoindex</span><span>.</span><span>functions</span><span>.</span><span>ExtractByLlm</span><span>(</span><span></span><br/></span><span><span>                llm_spec</span><span>=</span><span>cocoindex</span><span>.</span><span>LlmSpec</span><span>(</span><span></span><br/></span><span><span>                    api_type</span><span>=</span><span>cocoindex</span><span>.</span><span>LlmApiType</span><span>.</span><span>OPENAI</span><span>,</span><span> model</span><span>=</span><span>&#34;gpt-4o&#34;</span><span>)</span><span>,</span><span></span><br/></span><span><span>                output_type</span><span>=</span><span>DocumentSummary</span><span>,</span><span></span><br/></span><span><span>                instruction</span><span>=</span><span>&#34;Please summarize the content of the document.&#34;</span><span>)</span><span>)</span><span></span><br/></span><span><span></span><br/></span><span><span>    document_node</span><span>.</span><span>collect</span><span>(</span><span></span><br/></span><span><span>        filename</span><span>=</span><span>doc</span><span>[</span><span>&#34;filename&#34;</span><span>]</span><span>,</span><span> title</span><span>=</span><span>doc</span><span>[</span><span>&#34;summary&#34;</span><span>]</span><span>[</span><span>&#34;title&#34;</span><span>]</span><span>,</span><span></span><br/></span><span><span>        summary</span><span>=</span><span>doc</span><span>[</span><span>&#34;summary&#34;</span><span>]</span><span>[</span><span>&#34;summary&#34;</span><span>]</span><span>)</span><br/></span></code></pre></div></div>
<p><code>doc[&#34;summary&#34;]</code> adds a new column to the KTable <code>data_scope[&#34;documents&#34;]</code>.</p>
<p><img decoding="async" loading="lazy" alt="Adding summary to the each document" src="https://cocoindex.io/blogs/assets/images/data-add-summary-db507681f2cebd1473d99cd6d1e4cf08.png" width="1484" height="431"/></p>

<p>Define a data class to represent relationship for the LLM extraction.</p>
<div><div><pre tabindex="0"><code><span><span>@dataclasses</span><span>.</span><span>dataclass</span><span></span><br/></span><span><span></span><span>class</span><span> </span><span>Relationship</span><span>:</span><span></span><br/></span><span><span>    </span><span>&#34;&#34;&#34;</span><br/></span><span><span>    Describe a relationship between two entities.</span><br/></span><span><span>    Subject and object should be Core CocoIndex concepts only, should be nouns. For example, `CocoIndex`, `Incremental Processing`, `ETL`,  `Data` etc.</span><br/></span><span><span>    &#34;&#34;&#34;</span><span></span><br/></span><span><span>    subject</span><span>:</span><span> </span><span>str</span><span></span><br/></span><span><span>    predicate</span><span>:</span><span> </span><span>str</span><span></span><br/></span><span><span>    </span><span>object</span><span>:</span><span> </span><span>str</span><br/></span></code></pre></div></div>
<p>The Data class defines a knowledge graph relationship. We recommend putting detailed instructions in the class-level docstring to help the LLM extract relationships correctly.</p>
<ul>
<li><code>subject</code>: Represents the entity the statement is about (e.g., &#39;CocoIndex&#39;).</li>
<li><code>predicate</code>: Describes the type of relationship or property connecting the subject and object (e.g., &#39;supports&#39;).</li>
<li><code>object</code>: Represents the entity or value that the subject is related to via the predicate (e.g., &#39;Incremental Processing&#39;).</li>
</ul>
<p>This structure represents facts like &#34;CocoIndex supports Incremental Processing&#34;. Its graph representation is:</p>
<p><img decoding="async" loading="lazy" alt="Presentation of a relationship in a knowledge graph" src="https://cocoindex.io/blogs/assets/images/cocoindex-triple-explanation-6b40f03edfde69f08176572348d6fadc.png" width="1365" height="354"/></p>
<p>Next, we will use <code>cocoindex.functions.ExtractByLlm</code> to extract the relationships from the document.</p>
<div><div><pre tabindex="0"><code><span><span>doc</span><span>[</span><span>&#34;relationships&#34;</span><span>]</span><span> </span><span>=</span><span> doc</span><span>[</span><span>&#34;content&#34;</span><span>]</span><span>.</span><span>transform</span><span>(</span><span></span><br/></span><span><span>    cocoindex</span><span>.</span><span>functions</span><span>.</span><span>ExtractByLlm</span><span>(</span><span></span><br/></span><span><span>        llm_spec</span><span>=</span><span>cocoindex</span><span>.</span><span>LlmSpec</span><span>(</span><span></span><br/></span><span><span>            api_type</span><span>=</span><span>cocoindex</span><span>.</span><span>LlmApiType</span><span>.</span><span>OPENAI</span><span>,</span><span> </span><br/></span><span><span>            model</span><span>=</span><span>&#34;gpt-4o&#34;</span><span></span><br/></span><span><span>        </span><span>)</span><span>,</span><span></span><br/></span><span><span>        output_type</span><span>=</span><span>list</span><span>[</span><span>Relationship</span><span>]</span><span>,</span><span></span><br/></span><span><span>        instruction</span><span>=</span><span>(</span><span></span><br/></span><span><span>            </span><span>&#34;Please extract relationships from CocoIndex documents. &#34;</span><span></span><br/></span><span><span>            </span><span>&#34;Focus on concepts and ignore examples and code. &#34;</span><span></span><br/></span><span><span>        </span><span>)</span><span></span><br/></span><span><span>    </span><span>)</span><span></span><br/></span><span><span></span><span>)</span><br/></span></code></pre></div></div>
<p><code>doc[&#34;relationships&#34;]</code> adds a new field <code>relationships</code> to each document. <code>output_type=list[Relationship]</code> specifies that the output of the transformation is a <a href="https://cocoindex.io/docs/core/data_types#LTable" target="_blank" rel="noopener noreferrer">LTable</a>.</p>
<p><img decoding="async" loading="lazy" alt="Adding relationships to each document" src="https://cocoindex.io/blogs/assets/images/data-add-relationship-4ea24f4b9af454350fad48b439614a94.png" width="1484" height="828"/></p>
<h3 id="collect-relationships">Collect relationships<a href="#collect-relationships" aria-label="Direct link to Collect relationships" title="Direct link to Collect relationships">​</a></h3>
<div><div><pre tabindex="0"><code><span><span>with</span><span> doc</span><span>[</span><span>&#34;relationships&#34;</span><span>]</span><span>.</span><span>row</span><span>(</span><span>)</span><span> </span><span>as</span><span> relationship</span><span>:</span><span></span><br/></span><span><span>    </span><span></span><br/></span><span><span>    entity_relationship</span><span>.</span><span>collect</span><span>(</span><span></span><br/></span><span><span>        </span><span>id</span><span>=</span><span>cocoindex</span><span>.</span><span>GeneratedField</span><span>.</span><span>UUID</span><span>,</span><span></span><br/></span><span><span>        subject</span><span>=</span><span>relationship</span><span>[</span><span>&#34;subject&#34;</span><span>]</span><span>,</span><span></span><br/></span><span><span>        </span><span>object</span><span>=</span><span>relationship</span><span>[</span><span>&#34;object&#34;</span><span>]</span><span>,</span><span></span><br/></span><span><span>        predicate</span><span>=</span><span>relationship</span><span>[</span><span>&#34;predicate&#34;</span><span>]</span><span>,</span><span></span><br/></span><span><span>    </span><span>)</span><span></span><br/></span><span><span>    </span><span></span><br/></span><span><span>    entity_mention</span><span>.</span><span>collect</span><span>(</span><span></span><br/></span><span><span>        </span><span>id</span><span>=</span><span>cocoindex</span><span>.</span><span>GeneratedField</span><span>.</span><span>UUID</span><span>,</span><span> entity</span><span>=</span><span>relationship</span><span>[</span><span>&#34;subject&#34;</span><span>]</span><span>,</span><span></span><br/></span><span><span>        filename</span><span>=</span><span>doc</span><span>[</span><span>&#34;filename&#34;</span><span>]</span><span>,</span><span></span><br/></span><span><span>    </span><span>)</span><span></span><br/></span><span><span>    </span><span></span><br/></span><span><span>    entity_mention</span><span>.</span><span>collect</span><span>(</span><span></span><br/></span><span><span>        </span><span>id</span><span>=</span><span>cocoindex</span><span>.</span><span>GeneratedField</span><span>.</span><span>UUID</span><span>,</span><span> entity</span><span>=</span><span>relationship</span><span>[</span><span>&#34;object&#34;</span><span>]</span><span>,</span><span></span><br/></span><span><span>        filename</span><span>=</span><span>doc</span><span>[</span><span>&#34;filename&#34;</span><span>]</span><span>,</span><span></span><br/></span><span><span>    </span><span>)</span><span></span><br/></span><span><span></span><br/></span></code></pre></div></div>
<ul>
<li><code>entity_relationship</code> collects relationships between subjects and objects.</li>
<li><code>entity_mention</code> collects mentions of entities (as subjects or objects) in the document separately. For example, <code>core/basics.mdx</code> has a sentence <code>CocoIndex supports Incremental Processing</code>. We want to collect:<!-- -->
<ul>
<li><code>core/basics.mdx</code> mentions <code>CocoIndex</code>.</li>
<li><code>core/basics.mdx</code> mentions <code>Incremental Processing</code>.</li>
</ul>
</li>
</ul>
<h3 id="build-knowledge-graph">Build knowledge graph<a href="#build-knowledge-graph" aria-label="Direct link to Build knowledge graph" title="Direct link to Build knowledge graph">​</a></h3>
<h4 id="basic-concepts">Basic concepts<a href="#basic-concepts" aria-label="Direct link to Basic concepts" title="Direct link to Basic concepts">​</a></h4>
<p>All nodes for Neo4j need two things:</p>
<ol>
<li>Label: The type of the node. E.g., <code>Document</code>, <code>Entity</code>.</li>
<li>Primary key field: The field that uniquely identifies the node. E.g., <code>filename</code> for <code>Document</code> nodes.</li>
</ol>
<p>CocoIndex uses the primary key field to match the nodes and deduplicate them. If you have multiple nodes with the same primary key, CocoIndex keeps only one of them.</p>
<p><img decoding="async" loading="lazy" alt="Deduplication of nodes with the same primary key" src="https://cocoindex.io/blogs/assets/images/deduplicate-6feb8a0f7caa9da640436f7dc18715da.png" width="2750" height="825"/></p>
<p>There are two ways to map nodes:</p>
<ol>
<li>When you have a collector just for the node, you can directly export it to Neo4j.</li>
<li>When you have a collector for relationships connecting to the node, you can map nodes from selected fields in the relationship collector. You must declare a node label and primary key field.</li>
</ol>
<h4 id="configure-neo4j-connection">Configure Neo4j connection:<a href="#configure-neo4j-connection" aria-label="Direct link to Configure Neo4j connection:" title="Direct link to Configure Neo4j connection:">​</a></h4>
<div><div><pre tabindex="0"><code><span><span>conn_spec </span><span>=</span><span> cocoindex</span><span>.</span><span>add_auth_entry</span><span>(</span><span></span><br/></span><span><span>    </span><span>&#34;Neo4jConnection&#34;</span><span>,</span><span></span><br/></span><span><span>    cocoindex</span><span>.</span><span>storages</span><span>.</span><span>Neo4jConnection</span><span>(</span><span></span><br/></span><span><span>        uri</span><span>=</span><span>&#34;bolt://localhost:7687&#34;</span><span>,</span><span></span><br/></span><span><span>        user</span><span>=</span><span>&#34;neo4j&#34;</span><span>,</span><span></span><br/></span><span><span>        password</span><span>=</span><span>&#34;cocoindex&#34;</span><span>,</span><span></span><br/></span><span><span></span><span>)</span><span>)</span><br/></span></code></pre></div></div>
<h4 id="export-document-nodes-to-neo4j">Export <code>Document</code> nodes to Neo4j<a href="#export-document-nodes-to-neo4j" aria-label="Direct link to export-document-nodes-to-neo4j" title="Direct link to export-document-nodes-to-neo4j">​</a></h4>
<p><img decoding="async" loading="lazy" alt="Exporting document nodes to Neo4j" src="https://cocoindex.io/blogs/assets/images/export-document-04623da10bc102aff1d163a14eba7cd4.png" width="1941" height="600"/></p>
<div><div><pre tabindex="0"><code><span><span>document_node</span><span>.</span><span>export</span><span>(</span><span></span><br/></span><span><span>    </span><span>&#34;document_node&#34;</span><span>,</span><span></span><br/></span><span><span>    cocoindex</span><span>.</span><span>storages</span><span>.</span><span>Neo4j</span><span>(</span><span></span><br/></span><span><span>        connection</span><span>=</span><span>conn_spec</span><span>,</span><span></span><br/></span><span><span>        mapping</span><span>=</span><span>cocoindex</span><span>.</span><span>storages</span><span>.</span><span>Nodes</span><span>(</span><span>label</span><span>=</span><span>&#34;Document&#34;</span><span>)</span><span>)</span><span>,</span><span></span><br/></span><span><span>    primary_key_fields</span><span>=</span><span>[</span><span>&#34;filename&#34;</span><span>]</span><span>,</span><span></span><br/></span><span><span></span><span>)</span><br/></span></code></pre></div></div>
<p>This exports Neo4j nodes with label <code>Document</code> from the <code>document_node</code> collector.</p>
<ul>
<li>It declares Neo4j node label <code>Document</code>. It specifies <code>filename</code> as the primary key field.</li>
<li>It carries all the fields from <code>document_node</code> collector to Neo4j nodes with label <code>Document</code>.</li>
</ul>
<h4 id="export-relationship-and-entity-nodes-to-neo4j">Export <code>RELATIONSHIP</code> and <code>Entity</code> nodes to Neo4j<a href="#export-relationship-and-entity-nodes-to-neo4j" aria-label="Direct link to export-relationship-and-entity-nodes-to-neo4j" title="Direct link to export-relationship-and-entity-nodes-to-neo4j">​</a></h4>
<p><img decoding="async" loading="lazy" alt="Exporting relationships and entities to Neo4j" src="https://cocoindex.io/blogs/assets/images/export-relationship-6c28d094bf336190e41cc904b7ca05c4.png" width="1941" height="900"/></p>
<p>We don&#39;t have explicit collector for <code>Entity</code> nodes.
They are part of the <code>entity_relationship</code> collector and fields are collected during the relationship extraction.</p>
<p>To export them as Neo4j nodes, we need to first declare <code>Entity</code> nodes.</p>
<div><div><pre tabindex="0"><code><span><span>flow_builder</span><span>.</span><span>declare</span><span>(</span><span></span><br/></span><span><span>    cocoindex</span><span>.</span><span>storages</span><span>.</span><span>Neo4jDeclaration</span><span>(</span><span></span><br/></span><span><span>        connection</span><span>=</span><span>conn_spec</span><span>,</span><span></span><br/></span><span><span>        nodes_label</span><span>=</span><span>&#34;Entity&#34;</span><span>,</span><span></span><br/></span><span><span>        primary_key_fields</span><span>=</span><span>[</span><span>&#34;value&#34;</span><span>]</span><span>,</span><span></span><br/></span><span><span>    </span><span>)</span><span></span><br/></span><span><span></span><span>)</span><br/></span></code></pre></div></div>
<p>Next, export the <code>entity_relationship</code> to Neo4j.</p>
<div><div><pre tabindex="0"><code><span><span>entity_relationship</span><span>.</span><span>export</span><span>(</span><span></span><br/></span><span><span>    </span><span>&#34;entity_relationship&#34;</span><span>,</span><span></span><br/></span><span><span>    cocoindex</span><span>.</span><span>storages</span><span>.</span><span>Neo4j</span><span>(</span><span></span><br/></span><span><span>        connection</span><span>=</span><span>conn_spec</span><span>,</span><span></span><br/></span><span><span>        mapping</span><span>=</span><span>cocoindex</span><span>.</span><span>storages</span><span>.</span><span>Relationships</span><span>(</span><span></span><br/></span><span><span>            rel_type</span><span>=</span><span>&#34;RELATIONSHIP&#34;</span><span>,</span><span></span><br/></span><span><span>            source</span><span>=</span><span>cocoindex</span><span>.</span><span>storages</span><span>.</span><span>NodeFromFields</span><span>(</span><span></span><br/></span><span><span>                label</span><span>=</span><span>&#34;Entity&#34;</span><span>,</span><span></span><br/></span><span><span>                fields</span><span>=</span><span>[</span><span></span><br/></span><span><span>                    cocoindex</span><span>.</span><span>storages</span><span>.</span><span>TargetFieldMapping</span><span>(</span><span></span><br/></span><span><span>                        source</span><span>=</span><span>&#34;subject&#34;</span><span>,</span><span> target</span><span>=</span><span>&#34;value&#34;</span><span>)</span><span>,</span><span></span><br/></span><span><span>                </span><span>]</span><span></span><br/></span><span><span>            </span><span>)</span><span>,</span><span></span><br/></span><span><span>            target</span><span>=</span><span>cocoindex</span><span>.</span><span>storages</span><span>.</span><span>NodeFromFields</span><span>(</span><span></span><br/></span><span><span>                label</span><span>=</span><span>&#34;Entity&#34;</span><span>,</span><span></span><br/></span><span><span>                fields</span><span>=</span><span>[</span><span></span><br/></span><span><span>                    cocoindex</span><span>.</span><span>storages</span><span>.</span><span>TargetFieldMapping</span><span>(</span><span></span><br/></span><span><span>                        source</span><span>=</span><span>&#34;object&#34;</span><span>,</span><span> target</span><span>=</span><span>&#34;value&#34;</span><span>)</span><span>,</span><span></span><br/></span><span><span>                </span><span>]</span><span></span><br/></span><span><span>            </span><span>)</span><span>,</span><span></span><br/></span><span><span>        </span><span>)</span><span>,</span><span></span><br/></span><span><span>    </span><span>)</span><span>,</span><span></span><br/></span><span><span>    primary_key_fields</span><span>=</span><span>[</span><span>&#34;id&#34;</span><span>]</span><span>,</span><span></span><br/></span><span><span></span><span>)</span><span></span><br/></span><span><span></span><span>)</span><br/></span></code></pre></div></div>
<p>The <code>cocoindex.storages.Relationships</code> declares how to map relationships in Neo4j.</p>
<p>In a relationship, there&#39;s:</p>
<ol>
<li>A source node and a target node.</li>
<li>A relationship connecting the source and target.
Note that different relationships may share the same source and target nodes.</li>
</ol>
<p><code>NodeFromFields</code> takes the fields from the <code>entity_relationship</code> collector and creates <code>Entity</code> nodes.</p>
<h4 id="export-the-entity_mention-to-neo4j">Export the <code>entity_mention</code> to Neo4j.<a href="#export-the-entity_mention-to-neo4j" aria-label="Direct link to export-the-entity_mention-to-neo4j" title="Direct link to export-the-entity_mention-to-neo4j">​</a></h4>
<p><img decoding="async" loading="lazy" alt="Exporting entity mention to Neo4j" src="https://cocoindex.io/blogs/assets/images/example-explanation-49f2a253cb339f43a69a6b654728063e.png" width="1731" height="837"/></p>
<div><div><pre tabindex="0"><code><span><span>entity_mention</span><span>.</span><span>export</span><span>(</span><span></span><br/></span><span><span>    </span><span>&#34;entity_mention&#34;</span><span>,</span><span></span><br/></span><span><span>    cocoindex</span><span>.</span><span>storages</span><span>.</span><span>Neo4j</span><span>(</span><span></span><br/></span><span><span>        connection</span><span>=</span><span>conn_spec</span><span>,</span><span></span><br/></span><span><span>        mapping</span><span>=</span><span>cocoindex</span><span>.</span><span>storages</span><span>.</span><span>Relationships</span><span>(</span><span></span><br/></span><span><span>            rel_type</span><span>=</span><span>&#34;MENTION&#34;</span><span>,</span><span></span><br/></span><span><span>            source</span><span>=</span><span>cocoindex</span><span>.</span><span>storages</span><span>.</span><span>NodesFromFields</span><span>(</span><span></span><br/></span><span><span>                label</span><span>=</span><span>&#34;Document&#34;</span><span>,</span><span></span><br/></span><span><span>                fields</span><span>=</span><span>[</span><span>cocoindex</span><span>.</span><span>storages</span><span>.</span><span>TargetFieldMapping</span><span>(</span><span>&#34;filename&#34;</span><span>)</span><span>]</span><span>,</span><span></span><br/></span><span><span>            </span><span>)</span><span>,</span><span></span><br/></span><span><span>            target</span><span>=</span><span>cocoindex</span><span>.</span><span>storages</span><span>.</span><span>NodesFromFields</span><span>(</span><span></span><br/></span><span><span>                label</span><span>=</span><span>&#34;Entity&#34;</span><span>,</span><span></span><br/></span><span><span>                fields</span><span>=</span><span>[</span><span>cocoindex</span><span>.</span><span>storages</span><span>.</span><span>TargetFieldMapping</span><span>(</span><span></span><br/></span><span><span>                    source</span><span>=</span><span>&#34;entity&#34;</span><span>,</span><span> target</span><span>=</span><span>&#34;value&#34;</span><span>)</span><span>]</span><span>,</span><span></span><br/></span><span><span>            </span><span>)</span><span>,</span><span></span><br/></span><span><span>        </span><span>)</span><span>,</span><span></span><br/></span><span><span>    </span><span>)</span><span>,</span><span></span><br/></span><span><span>    primary_key_fields</span><span>=</span><span>[</span><span>&#34;id&#34;</span><span>]</span><span>,</span><span></span><br/></span><span><span></span><span>)</span><br/></span></code></pre></div></div>
<p>Similarly here, we export <code>entity_mention</code> to Neo4j Relationships using <code>cocoindex.storages.Relationships</code>.
It creates relationships by:</p>
<ul>
<li>Creating <code>Document</code> nodes and <code>Entity</code> nodes from the <code>entity_mention</code> collector.</li>
<li>Connecting <code>Document</code> nodes and <code>Entity</code> nodes with relationship <code>MENTION</code>.</li>
</ul>
<h3 id="main-function">Main function<a href="#main-function" aria-label="Direct link to Main function" title="Direct link to Main function">​</a></h3>
<p>Finally, the main function for the flow initializes the CocoIndex flow and runs it.</p>
<div><div><pre tabindex="0"><code><span><span> </span><span>@cocoindex</span><span>.</span><span>main_fn</span><span>(</span><span>)</span><span></span><br/></span><span><span></span><span>def</span><span> </span><span>_run</span><span>(</span><span>)</span><span>:</span><span></span><br/></span><span><span>    </span><span>pass</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span>if</span><span> __name__ </span><span>==</span><span> </span><span>&#34;__main__&#34;</span><span>:</span><span></span><br/></span><span><span>    load_dotenv</span><span>(</span><span>override</span><span>=</span><span>True</span><span>)</span><span></span><br/></span><span><span>    _run</span><span>(</span><span>)</span><br/></span></code></pre></div></div>
<h2 id="query-and-test-your-index">Query and test your index<a href="#query-and-test-your-index" aria-label="Direct link to Query and test your index" title="Direct link to Query and test your index">​</a></h2>
<p>🎉 Now you are all set!</p>
<ol>
<li>
<p>Install the dependencies:</p>

</li>
<li>
<p>Run following commands to setup and update the index.</p>
<div><div><pre tabindex="0"><code><span><span>python main.py cocoindex setup</span><br/></span><span><span>python main.py cocoindex update</span><br/></span></code></pre></div></div>
<p>You&#39;ll see the index updates state in the terminal. For example, you&#39;ll see the following output:</p>
<div><div><pre tabindex="0"><code><span><span>documents: 7 added, 0 removed, 0 updated</span><br/></span></code></pre></div></div>
</li>
<li>
<p>(Optional) I used CocoInsight to troubleshoot the index generation and understand the data lineage of the pipeline.
It is in free beta now, you can give it a try. Run following command to start CocoInsight:</p>
<div><div><pre tabindex="0"><code><span><span>python3 main.py cocoindex server -c https://cocoindex.io</span><br/></span></code></pre></div></div>
<p>And then open the url <a href="https://cocoindex.io/cocoinsight" target="_blank" rel="noopener noreferrer">https://cocoindex.io/cocoinsight</a>.  It just connects to your local CocoIndex server, with Zero pipeline data retention.</p>
<p><img decoding="async" loading="lazy" alt="CocoInsight" src="https://cocoindex.io/blogs/assets/images/cocoinsight-48cd25b497e0e5ac6bb8a7927be44eba.png" width="2860" height="1216"/></p>
</li>
</ol>
<h3 id="browse-the-knowledge-graph">Browse the knowledge graph<a href="#browse-the-knowledge-graph" aria-label="Direct link to Browse the knowledge graph" title="Direct link to Browse the knowledge graph">​</a></h3>
<p>After the knowledge graph is built, you can explore the knowledge graph you built in Neo4j Browser.</p>
<p>For the dev environment, you can connect to Neo4j browser using credentials:</p>
<ul>
<li>username: <code>Neo4j</code></li>
<li>password: <code>cocoindex</code>
which is pre-configured in our docker compose <a href="https://raw.githubusercontent.com/cocoindex-io/cocoindex/refs/heads/main/dev/Neo4j.yaml" target="_blank" rel="noopener noreferrer">config.yaml</a>.</li>
</ul>
<p>You can open it at <a href="http://localhost:7474" target="_blank" rel="noopener noreferrer">http://localhost:7474</a>, and run the following Cypher query to get all relationships:</p>

<p><img decoding="async" loading="lazy" alt="Neo4j Browser for CocoIndex Docs" src="https://cocoindex.io/blogs/assets/images/neo4j-for-coco-docs-333f04ecd9b74ffc70b1bd89415a57e5.png" width="2732" height="1274"/></p>
<h2 id="support-us">Support us<a href="#support-us" aria-label="Direct link to Support us" title="Direct link to Support us">​</a></h2>
<p>We are constantly improving, and more features and examples are coming soon.
If you love this article, please give us a star ⭐ at <a href="https://github.com/cocoindex-io/cocoindex" target="_blank" rel="noopener noreferrer">GitHub repo</a> to help us grow.</p>
<p>Thanks for reading!</p></div></div>
  </body>
</html>
