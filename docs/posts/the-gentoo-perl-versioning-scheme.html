<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://wiki.gentoo.org/wiki/Project:Perl/Version-Scheme">Original</a>
    <h1>The Gentoo Perl versioning scheme</h1>
    
    <div id="readability-page-1" class="page"><div id="mw-content-text" lang="en" dir="ltr"><div>


<p>A common observation/confusion people have is that the versions used on Perl related things in Gentoo don&#39;t directly correspond to upstream versions.
</p><p>This is because Upstream uses two different schemes, and one of those schemes is fundamentally incompatible with Gentoo&#39;s.
</p>
<h2><span id="The_Problem">The Problem</span></h2>
<p>In most people&#39;s minds, this is how version numbers sort:
</p>
<pre>1.0
1.1
1.5
1.10
1.15
1.20
1.45
</pre>
<p>This is because you read <code>.</code> as a delimiter for multiple integers.
</p><p>However, in Perl, those same versions sort as follows:
</p>
<pre>1.0
1.1  1.10
1.15
1.20
1.45
1.5
</pre>
<p>Because these versions are all treated as floating point, and yes, <code>1.1</code> and <code>1.10</code> are the <b>same</b> version.
</p>
<pre>perl -E &#39;say version-&gt;parse( q[1.1] ) &lt;=&gt; version-&gt;parse( q[1.10] )&#39; 
# 0
</pre>
<p>To make matters interesting, a leading <code>v</code> on a Perl version, or the presence of two or more <code>.</code>&#39;s imply a sort order closer to Gentoo&#39;s. And so, the net result is this mess:
</p>
<pre>perl -E&#39;say for sort map { version-&gt;parse($_) } qw(  1.0 1.10 1.1 1.10 1.15 1.20 1.45 v1.2 v1.3 v1.4 v1.1 v1.100 )&#39;
# 1.0
# v1.1
# v1.2
# v1.3
# v1.4
# 1.10
# 1.1
# 1.10
# v1.100
# 1.15
# 1.20
# 1.45
</pre>
<p>Yes, if you realised <code>v1.100 == 1.1 == 1.10</code> but <code>v1.1 != 1.1</code> you were paying enough attention.
</p><p>Confused? Good. So is everyone else who touches Perl versions, and the <a rel="nofollow" href="http://www.dagolden.com/index.php/369/version-numbers-should-be-boring/">whole host of related historical nightmares</a>
</p>
<h2><span id="Our_Solution">Our Solution</span></h2>
<p>The solution we employ is to decode upstream&#39;s version scheme and translate it into a consistent scheme that, after being translated, preserves upstream&#39;s sorting order when translated to Gentoo versions, and we use this practically everywhere:
</p>
<ul><li>On Package Versions</li>
<li>In dependency specifications</li></ul>
<p>This means as long as you&#39;re familiar with the translation process, you can get highly predictable results instead of a random fractal of confusion.
</p><p><a rel="nofollow" href="https://metacpan.org/pod/Gentoo::PerlMod::Version">Gentoo::PerlMod::Version</a> (<span title="External link to https://packages.gentoo.org for the dev-perl/Gentoo-PerlMod-Version package."><a rel="nofollow" href="https://packages.gentoo.org/packages/dev-perl/Gentoo-PerlMod-Version"><span>dev-perl/Gentoo-PerlMod-Version</span></a><span></span></span>) is a reference implementation of this translation, and it can be used effectively blindly to translate upstream versions to downstream versions.
</p><p>Install that package and run <span>gentoo-perlmod-version.pl SOME_CPAN_VERSION</span> to obtain the Gentoo version.
</p><p>And we then hard-code the &#34;real&#34; upstream version inside the package (because its impossible to convert Gentoo versions generically to upstream ones, because you don&#39;t know which of the many formats it will take)
</p>
<h3><span id="Conversion_of_v-Versions">Conversion of v-Versions</span></h3>
<p>Upstream does have some version schemes that we can use verbatim:
</p>
<ul><li>Any version with more than one <code>.</code> can be treated as an integer sequence like Gentoo Versions</li>
<li>Any version with a leading <code>v</code> can be treated an integer sequence like Gentoo Versions (after stripping the leading v)</li></ul>
<h3><span id="Conversion_of_&#34;Floating&#34;_versions"></span><span id="Conversion_of_.22Floating.22_versions">Conversion of &#34;Floating&#34; versions</span></h3>
<p>First, to understand how this works, you have to first understand how &#34;v-Versions&#34; are converted and compared with &#34;Floating&#34; version upstream:
</p>
<ul><li>Each digit group after the first is interpreted as 3 digits in the range 000-999</li>
<li>The values are concatenated to create the tail</li></ul>
<p>So, for example, upstream: <code>1.1.2</code> means <code>1.001002</code>, <code>1.20.30</code> means <code>1.020030</code>, etc.
</p><p>Our conversion to Gentoo versions basically applies the opposite of this, to convert a &#34;Floating&#34; version into a &#34;v-Version&#34; (without the &#34;v&#34;)
</p>
<ol><li>Take the floating point number</li>
<li>Pad its tail to a multiple of 3 digits with trailing zeros</li>
<li>Split the tail into groups of 3 digits</li>
<li>Strip any leading <code>0</code>&#39;s from each group</li>
<li>Ensure there is a minimum of 3 groups of digits (with each at having at least one digit per group)</li></ol>
<p>So for example:
</p>
<pre>1.1    -&gt;   1.100 -&gt; 1.100.0 
1.001  -&gt;   1.1.0
1.0001 -&gt;   1.000100 -&gt; 1.000.100 -&gt; 1.0.100
</pre>
<p>And you can find a large table of other examples in the tests for <a rel="nofollow" href="https://metacpan.org/source/KENTNL/Gentoo-PerlMod-Version-v0.8.1/t/01_basic.t#L13-60">Gentoo::PerlMod::Version</a>
</p>
<h2><span id="The_End_Result">The End Result</span></h2>
<p>You can thus, pump Gentoo versions for Perl packages into Perl&#39;s version comparison, and it will still treat the normalized verions the same as the pre-normalized ones.
</p>
<pre>perl -MGentoo::PerlMod::Version=gentooize_version -E&#39;say gentooize_version($_) for sort map { version-&gt;parse($_) } qw( 1.0 1.10 1.1 1.10 1.15 1.20 1.45 v1.2 v1.3 v1.4 v1.100 )&#39;
# 1.0.0
# 1.2.0
# 1.3.0
# 1.4.0
# 1.100.0
# 1.100.0
# 1.100.0
# 1.100.0
# 1.150.0
# 1.200.0
# 1.450.0

perl -E&#39;say q[GOOD] if version-&gt;parse(q[1.0001]) == version-&gt;parse(q[1.0.100]) &#39; # GOOD
</pre>

<p>Some competing normalisations have issues in that they don&#39;t retain their comparison positions when fed back into Perl comparison functions, and are thus simply less desirable because it requires much more effort to reason about how they work.
</p><p>They can also risk colliding with alternative existing forms upstream so the risk would occur that upstream could legally ship a new version such that a new version and an old version normalised to the same version Gentoo side, and this is something we wish to avoid.
</p><p>(This problem has already happened, but it happened in a way that was illegal on CPAN as well, because our version scheme ensures that its only illegal when its illegal on CPAN)
</p><p>eg:
</p>
<pre># 2.02 -&gt; 2.1002  
perl -E&#39;say q[BAD] unless version-&gt;parse(q[2.02]) == version-&gt;parse(q[2.1002]) &#39;  # BAD

# 2.02 -&gt; 2.0.2.0
perl -E&#39;say q[BAD] unless version-&gt;parse(q[2.02]) == version-&gt;parse(q[2.0.2.0]) &#39; # BAD
</pre>

<ul><li><a rel="nofollow" href="https://metacpan.org/pod/Gentoo::PerlMod::Version#SYNOPSIS">Gentoo::PerlMod::Version documentation</a></li>
<li><a rel="nofollow" href="http://www.dagolden.com/index.php/369/version-numbers-should-be-boring/">David Goldens compendium of historical version nightmares</a></li></ul>
<!-- 
NewPP limit report
Cached time: 20250721141802
Cache expiry: 86400
Dynamic content: false
Complications: []
[SMW] In‐text annotation parser time: 0 seconds
CPU time usage: 0.011 seconds
Real time usage: 0.012 seconds
Preprocessor visited node count: 118/1000000
Post‐expand include size: 1310/4194304 bytes
Template argument size: 291/4194304 bytes
Highest expansion depth: 7/40
Expensive parser function count: 0/150
Unstrip recursion depth: 0/20
Unstrip post‐expand size: 1185/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%    4.315      1 -total
 73.51%    3.172      1 Template:Package
 31.54%    1.361      2 Template:Trim
 25.70%    1.109      1 Template:C
-->

<!-- Saved in parser cache with key gentoo?hwiki:pcache:idhash:219176-0!canonical and timestamp 20250721141822 and revision id 1406268
 -->
</div></div></div>
  </body>
</html>
