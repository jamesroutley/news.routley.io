<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ounapuu.ee/posts/2024/05/02/smartplugs/">Original</a>
    <h1>Monitoring energy usage with smart plugs, Prometheus and Grafana</h1>
    
    <div id="readability-page-1" class="page"><div>
      
      <p>This post <strong>isn’t</strong> a detailed line-by-line tutorial on how to set up each individual piece of the setup as those types of
guides tend to get out of date really easily, but if you know your way around Linux and the command line, then you can
definitely replicate this setup on your own.</p>
<p>Over the past few years I’ve been interested in learning about how much energy my computing setup and home
appliances use.
I’ve used a simple digital energy meter before to get instantaneous readings, but that was not ideal for monitoring
how an electrical appliance consumes power over a longer time period.</p>
<p>My friend bought a few smart plugs from <a href="https://www.athom.tech/">athom.tech</a>. After getting confirmation
that they don’t suck, I went ahead and ordered some myself.</p>
<p>The smart plugs I bought were the <code>EU style plug V3</code> variant. The shipping times in EU were reasonably fast, shipping in 9
days (and that included Christmas!).</p>
<p>The plugs ship with <a href="https://tasmota.github.io/docs/">Tasmota</a> pre-flashed. The plugs come with a small paper strip explaining
the steps to take to connect the plug to your Wi-Fi network, and after that you can manage the plug in your browser.</p>







  




<figure>
    
    <a href="https://cceckman.com/posts/2024/05/02/smartplugs/media/tasmota-quick-start.jpg">
        <img src="https://cceckman.com/posts/2024/05/02/smartplugs/media/tasmota-quick-start_hud8e7f39a6a53718c04b020d97b33e675_1308648_800x0_resize_q80_box.jpg" width="800" height="314" alt="Quick start instructions that ship with the smart plug."/>
    </a>
    <figcaption>
      Quick start instructions that ship with the smart plug.
    </figcaption>
    
</figure>

<p>Updating the firmware to the latest version is easy and doable in the web GUI with just a few clicks.</p>







  




<figure>
    
    <a href="https://cceckman.com/posts/2024/05/02/smartplugs/media/webui.png">
        <img src="https://cceckman.com/posts/2024/05/02/smartplugs/media/webui_hu9cb46fbfd4c7dc7dc40ad2d15cd826a4_70799_800x800_fit_box_3.png" width="395" height="800" alt="The web UI is simple and very functional."/>
    </a>
    <figcaption>
      The web UI is simple and very functional.
    </figcaption>
    
</figure>

<h3 id="the-software-stack">The software stack</h3>
<p>My initial goal with these plugs was to visually monitor the power consumption of a few devices, such as my home server, router,
workstation setup and the electric water heater.</p>
<p>The power meter data is collected to an existing <a href="https://prometheus.io/">Prometheus</a> instance on my home server.
If you’re not sure what Prometheus is, then think of it as a tool that periodically reads metrics from different
sources, saves them to disk and allows you to later query and manipulate that information.</p>
<p>I run multiple instances of this <a href="https://github.com/astr0n8t/tasmota-power-exporter">tasmota-power-exporter</a> solution on my server, one per plug, which get scraped once
per second by the Prometheus instance. <a href="https://github.com/arendst/Tasmota/issues/9206">It is possible to also make the plugs themselves export these metrics,</a>
but I didn’t fancy building Tasmota firmware myself, yet.<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup></p>
<p>I already had a <a href="https://grafana.com/">Grafana</a> instance running on my home server, so I reused that to show a few basic
graphs for the power meter setup.</p>
<p><em>Free tech tip</em>: make sure to change the <code>min step</code> setting to 1 second to get the most detailed data points on your graphs.</p>







  




<figure>
    
    <a href="https://cceckman.com/posts/2024/05/02/smartplugs/media/grafana-minstep.png">
        <img src="https://cceckman.com/posts/2024/05/02/smartplugs/media/grafana-minstep_hu5952a2b903b7f2b98c216cc3f852d5fc_23721_0x800_resize_q80_box_3.png" width="1388" height="800" alt="It&#39;s this one. "/>
    </a>
    <figcaption>
      It&#39;s this one. 
    </figcaption>
    
</figure>

<h3 id="observations-and-findings">Observations and findings</h3>
<p>So, what have I learned after running this setup for almost 4 months?</p>
<h4 id="water-heater">Water heater</h4>
<p>It shouldn’t come as a surprise that the electric water heater uses up the most power. The one we have is a 30L one,
just enough for a quick shower or two or for washing a large load of dishes.</p>
<p>Typical power usage: 4.51 kWh/day.</p>
<p>Minimum observed: 0.56 kWh/day, happens usually when nobody is at home</p>
<p>Maximum observed: 11.1 kWh/day, a lot of washing and showering happened on that day</p>







  




<figure>
    
    <a href="https://cceckman.com/posts/2024/05/02/smartplugs/media/boiler-graph.png">
        <img src="https://cceckman.com/posts/2024/05/02/smartplugs/media/boiler-graph_hu3c09159cad2bcc54c8ac07b8e29f09e1_40283_1280x800_fit_box_3.png" width="1120" height="475" alt="Typical power consumption pattern of a water heater."/>
    </a>
    <figcaption>
      Typical power consumption pattern of a water heater.
    </figcaption>
    
</figure>

<h4 id="home-server-setup">Home server setup</h4>
<p>I run all my home server workloads off of a <a href="https://cceckman.com/posts/2023/10/09/zimaboard/">Zimaboard</a>. One of its big selling
points for me was its super low power consumption.
When idling, the Zimaboard can use about 2 W, typical power usage with all my services running was about 7 W and the
maximum power consumption was around 15 W.</p>
<p>The Zimaboard was actually using <em>less power</em> than my internet modem/router box (which is hot garbage by the way).
The ISP-provided box used 12-14 W at all times, regardless if it was operating in router or bridge mode.</p>







  




<figure>
    
    <a href="https://cceckman.com/posts/2024/05/02/smartplugs/media/zimaboard-graph.png">
        <img src="https://cceckman.com/posts/2024/05/02/smartplugs/media/zimaboard-graph_hu055bc352ee25bf176b52d5fd4b0b88b3_51555_1280x800_fit_box_3.png" width="1120" height="475" alt="Zimaboard + modem/router box power consumption."/>
    </a>
    <figcaption>
      Zimaboard + modem/router box power consumption.
    </figcaption>
    
</figure>








  




<figure>
    
    <a href="https://cceckman.com/posts/2024/05/02/smartplugs/media/isp-box-graph.png">
        <img src="https://cceckman.com/posts/2024/05/02/smartplugs/media/isp-box-graph_hu1e3c979303e2f87de6a24325c2363805_31156_1280x800_fit_box_3.png" width="1120" height="475" alt="The ISP modem/router box is a horribly inefficient device for what it does."/>
    </a>
    <figcaption>
      The ISP modem/router box is a horribly inefficient device for what it does.
    </figcaption>
    
</figure>

<p>At one point I temporarily switched my home server setup back to <a href="https://ounapuu.ee/posts/2022/01/17/asrock-x300-future-of-desktops/">the ASRock Deskmini X300</a>,
mainly because I added some latency-sensitive workloads onto my home server setup and the Zimaboard was a bit too weak
for those.</p>
<p>One thing that became really obvious from the power meter is that the Deskmini idle power consumption is
horrible in comparison to the Zimaboard, coming in at around 15-20 W. This might be in part because my Deskmini doesn’t
seem to expose any lower CPU power states than C3 while the Zimaboard exposed C-states all the way down to C10. I could not
find a way to expose lower C-states in UEFI settings or the Linux kernel. Based on a quick remark in <a href="https://www.youtube.com/watch?v=J_WJI4hp_B8">this video</a> I believe that it should
be possible to drop ASRock a message and receive a custom BIOS that enables some extra features, but that seems even
more unlikely for a consumer-grade device such as this one.</p>







  




<figure>
    
    <a href="https://cceckman.com/posts/2024/05/02/smartplugs/media/deskmini-graph.png">
        <img src="https://cceckman.com/posts/2024/05/02/smartplugs/media/deskmini-graph_hu12358bc476ba2cd784ed64bf5d0ac17b_59098_1280x800_fit_box_3.png" width="1120" height="475" alt="ASRock Deskmini X300 + ISP box power consumption."/>
    </a>
    <figcaption>
      ASRock Deskmini X300 + ISP box power consumption.
    </figcaption>
    
</figure>

<p>I’ve added a panel to my usual Prometheus node exporter Grafana view that shows the server setup power consumption alongside
other metrics. Higher CPU activity is clearly visible on the power consumption graphs.</p>







  




<figure>
    
    <a href="https://cceckman.com/posts/2024/05/02/smartplugs/media/cpu-power-correlation.png">
        <img src="https://cceckman.com/posts/2024/05/02/smartplugs/media/cpu-power-correlation_hu6a4123be6d182f8d302d750b742423eb_75617_1280x800_fit_box_3.png" width="1280" height="397" alt="A moderate jump in CPU usage can result in a big jump in power consumption."/>
    </a>
    <figcaption>
      A moderate jump in CPU usage can result in a big jump in power consumption.
    </figcaption>
    
</figure>

<h4 id="voltage">Voltage</h4>
<p>The Tasmota plugs also report current voltage values. I graphed them just for fun, but noticed that there is a sort of
seasonality to the values. During the usual peak power consumption hours the voltage drops across the board.</p>







  




<figure>
    
    <a href="https://cceckman.com/posts/2024/05/02/smartplugs/media/voltage-seasonality.png">
        <img src="https://cceckman.com/posts/2024/05/02/smartplugs/media/voltage-seasonality_hubd736162f2fe021fc12c120d470b0510_67975_1280x800_fit_box_3.png" width="1280" height="404" alt="Seasonality as expressed through voltage readings."/>
    </a>
    <figcaption>
      Seasonality as expressed through voltage readings.
    </figcaption>
    
</figure>

<p>This seems like a candidate for testing anomaly detection, as shown in <a href="https://about.gitlab.com/blog/2019/07/23/anomaly-detection-using-prometheus/">this great GitLab article.</a>
I’ve used this concept at work and it works reasonably well for some metrics.</p>
<p>In other cases the voltage drops were caused by running appliances that use a lot of power, such as the water heater, electric kettle, electric stove or the microwave.</p>







  




<figure>
    
    <a href="https://cceckman.com/posts/2024/05/02/smartplugs/media/voltage-correlation.png">
        <img src="https://cceckman.com/posts/2024/05/02/smartplugs/media/voltage-correlation_hue628dc4aa97bc3ea50aef7ac1fc91da1_94305_1280x800_fit_box_3.png" width="1280" height="640" alt="Water heater causing the voltage to drop slightly for all plugs."/>
    </a>
    <figcaption>
      Water heater causing the voltage to drop slightly for all plugs.
    </figcaption>
    
</figure>

<p>During cooking with an electric stove, the on-off cycles were also noticeable on
the voltage reading on all of the plugs.</p>







  




<figure>
    
    <a href="https://cceckman.com/posts/2024/05/02/smartplugs/media/voltage-cooking.png">
        <img src="https://cceckman.com/posts/2024/05/02/smartplugs/media/voltage-cooking_hu41bea76e23e5fc9573d24fc34ba37fd6_47963_1280x800_fit_box_3.png" width="1277" height="483" alt="The impact of an electric stove on the voltage."/>
    </a>
    <figcaption>
      The impact of an electric stove on the voltage.
    </figcaption>
    
</figure>

<h4 id="workstation">Workstation</h4>
<p>I have one plug that reports numbers for everything that’s connected to my home office setup: monitor, USB-C dock,
monitor light bar and anything that might be charging on the table.</p>
<p>The power consumption of this setup varies a lot. Sometimes I do a longer home office stint. Sometimes I recharge various
devices.</p>
<p>The typical power consumption of the whole setup while doing something on my computer is around 45-60 W, with peaks near
90-110 W. For an ultrawide monitor, USB-C dock and my laptop I think this is a pretty good result. I’ve had desktop PC-s
that have used just as much power at idle, and in the olden days there were incandescent light bulbs that used up more
electricity than this!</p>







  




<figure>
    
    <a href="https://cceckman.com/posts/2024/05/02/smartplugs/media/workstation-graph.png">
        <img src="https://cceckman.com/posts/2024/05/02/smartplugs/media/workstation-graph_hu69ef3419847b6fdff7382ac034b83d8c_76961_1280x800_fit_box_3.png" width="1280" height="474" alt="Typical power consumption of my work desk when working from home."/>
    </a>
    <figcaption>
      Typical power consumption of my work desk when working from home.
    </figcaption>
    
</figure>

<p>Typical power usage: 0.95 kWh/day.</p>
<p>Minimum observed: 0.07 kWh/day</p>
<p>Maximum observed: 1.52 kWh/day</p>
<h4 id="charging">Charging</h4>
<p>These plugs are also great for observing the charging patterns of various devices.</p>
<p>A laptop or a power bank charges faster at the beginning, but the speed drops off as the battery gets more full.
At one point trickle charging seems to kick in until the device is fully charged.</p>







  




<figure>
    
    <a href="https://cceckman.com/posts/2024/05/02/smartplugs/media/charging-powerbank.png">
        <img src="https://cceckman.com/posts/2024/05/02/smartplugs/media/charging-powerbank_hu55e72ff27215711fa9d1862b182b4dc9_39049_1280x800_fit_box_3.png" width="1279" height="530" alt="A power bank charges quickly in the beginning and starts slowing down once it gets close to being fully charged."/>
    </a>
    <figcaption>
      A power bank charges quickly in the beginning and starts slowing down once it gets close to being fully charged.
    </figcaption>
    
</figure>

<p>This pattern is similar on most devices that I charge. The battery on my e-bike seems to be an exception to the rule,
with a slighly increasing power consumption throughout, and a faster drop at the end of the charging cycle.</p>







  




<figure>
    
    <a href="https://cceckman.com/posts/2024/05/02/smartplugs/media/charging-ebike-battery.png">
        <img src="https://cceckman.com/posts/2024/05/02/smartplugs/media/charging-ebike-battery_hu3fb1bef274b21cbbf3f2d364478b5fca_40104_1280x800_fit_box_3.png" width="1279" height="530" alt="E-bike battery charging pattern, from nearly empty to full."/>
    </a>
    <figcaption>
      E-bike battery charging pattern, from nearly empty to full.
    </figcaption>
    
</figure>

<p>0.5kWh of power consumed for 60km of range with the “Turbo” preset on the bike doesn’t sound bad at all. Half a cent per
kilometer!</p>
<h4 id="stability">Stability</h4>
<p>The stability of the smart plugs is usually fine, but there are frequent cases where certain plugs don’t report back in time
with the statistics. This may be a Wi-Fi access point issue, but annoying nevertheless.</p>
<p>I’ve had to completely power cycle two plugs a few times because they dropped off from the network completely and would
not come back. Again, could be the fault of my Wi-Fi AP.</p>
<h4 id="future-ideas">Future ideas</h4>
<p>The plugs also provide a way to turn the devices on and off over different
API-s (even over HTTP!), which is something I’d like to utilize either using something like <a href="https://www.home-assistant.io/">Home Assistant</a>, or a simple
script that toggles certain devices on and off based on the current electricity price.</p>
<p>I haven’t gotten around to this part yet, but from my research it seems that <a href="https://github.com/custom-components/nordpool">the necessary integrations
exist for Home Assistant.</a></p>
<h3 id="closing-thoughts">Closing thoughts</h3>
<p>Overall, I’m very happy with this setup. I can get reliable measurements for all sorts of computing setups from now on,
which will make judging the power efficiency of the devices I use much easier. No more guesswork!</p>
<p>If you enjoyed this post, then I highly recommend giving <a href="https://fosdem.org/2024/schedule/event/fosdem-2024-2723-power-profiling-my-entire-house-with-the-firefox-profiler/">this FOSDEM 2024 talk by Florian Quèze a listen.</a>
The talk also goes into details about measuring the power consumption of various devices in the speakers’ home and
observations that they’ve made.</p>


    </div></div>
  </body>
</html>
