<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.riffusion.com/about">Original</a>
    <h1>Riffusion â€“ Stable Diffusion fine-tuned to generate music</h1>
    
    <div id="readability-page-1" class="page"><div><div><h3>(noun): riff + diffusion</h3><p>You&#39;ve heard of<!-- --> <a href="https://en.wikipedia.org/wiki/Stable_Diffusion">Stable Diffusion</a>, the open-source AI model that generates images from text?</p><div><p>photograph of an astronaut riding a horse</p><p><img alt="photograph of an astronaut riding a horse" srcset="/_next/image?url=%2Fabout%2Fastronaut.gif&amp;w=384&amp;q=75 1x, /_next/image?url=%2Fabout%2Fastronaut.gif&amp;w=640&amp;q=75 2x" src="https://www.riffusion.com/_next/image?url=%2Fabout%2Fastronaut.gif&amp;w=640&amp;q=75" width="300" height="300" decoding="async" data-nimg="1" loading="lazy"/></p></div><p>Well, we fine-tuned the model to generate images of spectrograms, like this:</p><div><p>funk bassline with a jazzy saxophone solo</p><p><img alt="funk bassline with a jazzy saxophone solo" srcset="/_next/image?url=%2Fabout%2Ffunky_sax.gif&amp;w=384&amp;q=75 1x, /_next/image?url=%2Fabout%2Ffunky_sax.gif&amp;w=640&amp;q=75 2x" src="https://www.riffusion.com/_next/image?url=%2Fabout%2Ffunky_sax.gif&amp;w=640&amp;q=75" width="300" height="300" decoding="async" data-nimg="1" loading="lazy"/></p></div><p>The magic is that this spectrogram can then be converted to an audio clip:</p><p><audio controls="" src="/about/funky_sax.mp3">Your browser does not support audio.</audio></p><p>ðŸ”¥ðŸ”¥ðŸ”¥ðŸ˜±</p><p><b>Really? </b> Yup.</p><p>This is the v1.5 stable diffusion model with no modifications, just fine-tuned on images of spectrograms paired with text. Audio processing happens downstream of the model.</p><p>It can generate infinite variations of a prompt by varying the seed. All the same web UIs and techniques like img2img, inpainting, negative prompts, and interpolation work out of the box.</p><h2>Spectrograms</h2><p>An audio<!-- --> <a href="https://en.wikipedia.org/wiki/Spectrogram">spectrogram</a> <!-- -->is a visual way to represent the frequency content of a sound clip. The x-axis represents time, and the y-axis represents frequency. The color of each pixel gives the amplitude of the audio at the frequency and time given by its row and column.</p><p><img alt="spectrogram with axes labeled" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fspectrogram_label.8c8aea56.png&amp;w=1920&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fspectrogram_label.8c8aea56.png&amp;w=3840&amp;q=75 2x" src="https://www.riffusion.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fspectrogram_label.8c8aea56.png&amp;w=3840&amp;q=75" width="1356" height="956" decoding="async" data-nimg="1" loading="lazy"/></p><p>The spectogram can be computed from audio using the<!-- --> <a href="https://en.wikipedia.org/wiki/Short-time_Fourier_transform">Short-time Fourier transform</a> <!-- -->(STFT), which approximates the audio as a combination of sine waves of varying amplitudes and phases.</p><p><img alt="fourier transform explanation" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Ffourier_transform.9d53f3d7.png&amp;w=640&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Ffourier_transform.9d53f3d7.png&amp;w=1080&amp;q=75 2x" src="https://www.riffusion.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Ffourier_transform.9d53f3d7.png&amp;w=1080&amp;q=75" width="540" height="378" decoding="async" data-nimg="1" loading="lazy"/></p><p>The STFT is invertible, so the original audio can be reconstructed from a spectrogram. However, the spectrogram images from our model only contain the amplitude of the sine waves and not the phases, because the phases are chaotic and hard to learn. Instead, we use the<!-- --> <a href="https://ieeexplore.ieee.org/document/1164317">Griffin-Lim</a> <!-- -->algorithm to approximate the phase when reconstructing the audio clip.</p><p>The frequency bins in our spectrogram use the<!-- --> <a href="https://en.wikipedia.org/wiki/Mel_scale">Mel scale</a>, which is a perceptual scale of pitches judged by listeners to be equal in distance from one another.</p><p>Below is a hand-drawn image interpreted as a spectrogram and converted to audio. Play it back to get an intuitive sense of how they work. Note how you can hear the pitches of the two curves on the bottom half, and how the four vertical lines at the top make beats similar to a hi-hat sound.</p><p><img alt="hand drawn spectrogram" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fhand_drawn_spectrogram.6a1868fd.png&amp;w=640&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fhand_drawn_spectrogram.6a1868fd.png&amp;w=1080&amp;q=75 2x" src="https://www.riffusion.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fhand_drawn_spectrogram.6a1868fd.png&amp;w=1080&amp;q=75" width="512" height="512" decoding="async" data-nimg="1" loading="lazy"/></p><p><audio controls="" src="/about/hand_drawn.mp3">Your browser does not support audio.</audio></p><p>We use<!-- --> <a href="https://pytorch.org/audio/stable/transforms.html">Torchaudio</a>, which has excellent modules for efficient audio processing on the GPU. Check out our audio processing code<!-- --> <a href="https://github.com/hmartiro/riffusion-inference/blob/main/riffusion/audio.py">here</a>.</p><h2>Image-to-Image</h2><p>With diffusion models, it is possible to condition their creations not only on a text prompt but also on other images. This is incredibly useful for modifying sounds while preserving the structure of the an original clip you like. You can control how much to deviate from the original clip and towards a new prompt using the denoising strength parameter.</p><p>For example, here is that funky sax riff again, followed by a modification to crank up the piano:</p><div><div><div><p>funk bassline with a jazzy saxophone solo</p><p><img alt="funk bassline with a jazzy saxophone solo" srcset="/_next/image?url=%2Fabout%2Ffunky_sax.png&amp;w=384&amp;q=75 1x, /_next/image?url=%2Fabout%2Ffunky_sax.png&amp;w=640&amp;q=75 2x" src="https://www.riffusion.com/_next/image?url=%2Fabout%2Ffunky_sax.png&amp;w=640&amp;q=75" width="300" height="300" decoding="async" data-nimg="1" loading="lazy"/></p></div><p><audio controls="" src="/about/funky_sax.mp3">Your browser does not support audio.</audio></p></div><div><div><p>piano funk</p><p><img alt="piano funk" srcset="/_next/image?url=%2Fabout%2Ffunky_sax_to_piano.png&amp;w=384&amp;q=75 1x, /_next/image?url=%2Fabout%2Ffunky_sax_to_piano.png&amp;w=640&amp;q=75 2x" src="https://www.riffusion.com/_next/image?url=%2Fabout%2Ffunky_sax_to_piano.png&amp;w=640&amp;q=75" width="300" height="300" decoding="async" data-nimg="1" loading="lazy"/></p></div><p><audio controls="" src="/about/funky_sax_to_piano.mp3">Your browser does not support audio.</audio></p></div></div><p>The next example adapts a rock and roll solo to an acoustic folk fiddle:</p><div><div><div><p>rock and roll electric guitar solo</p><p><img alt="rock and roll electric guitar solo" srcset="/_next/image?url=%2Fabout%2Frock_and_roll_electric_guitar_solo.png&amp;w=384&amp;q=75 1x, /_next/image?url=%2Fabout%2Frock_and_roll_electric_guitar_solo.png&amp;w=640&amp;q=75 2x" src="https://www.riffusion.com/_next/image?url=%2Fabout%2Frock_and_roll_electric_guitar_solo.png&amp;w=640&amp;q=75" width="300" height="300" decoding="async" data-nimg="1" loading="lazy"/></p></div><p><audio controls="" src="/about/rock_and_roll_electric_guitar_solo.mp3">Your browser does not support audio.</audio></p></div><div><div><p>acoustic folk fiddle solo</p><p><img alt="acoustic folk fiddle solo" srcset="/_next/image?url=%2Fabout%2Facoustic_folk_fiddle_solo.png&amp;w=384&amp;q=75 1x, /_next/image?url=%2Fabout%2Facoustic_folk_fiddle_solo.png&amp;w=640&amp;q=75 2x" src="https://www.riffusion.com/_next/image?url=%2Fabout%2Facoustic_folk_fiddle_solo.png&amp;w=640&amp;q=75" width="300" height="300" decoding="async" data-nimg="1" loading="lazy"/></p></div><p><audio controls="" src="/about/acoustic_folk_fiddle_solo.mp3">Your browser does not support audio.</audio></p></div></div><h2>Looping and Interpolation</h2><p>Generating short clips is a blast, but we really wanted infinite AI-generated jams.</p><p>Let&#39;s say we put in a prompt and generate 100 clips with varying seeds. We can&#39;t concatenate the resulting clips because they differ in key, tempo, and downbeat.</p><p>Our strategy is to pick one initial image and generate variations of it by running image-to-image generation with different seeds and prompts. This preserves the key properties of the clips. To make them loop-able, we also create initial images that are an exact number of measures.</p><p><img alt="img2img generation example" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fimg2img_example.19e5b353.png&amp;w=1920&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fimg2img_example.19e5b353.png&amp;w=3840&amp;q=75 2x" src="https://www.riffusion.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fimg2img_example.19e5b353.png&amp;w=3840&amp;q=75" width="1878" height="640" decoding="async" data-nimg="1" loading="lazy"/></p><p>However, even with this approach it&#39;s still too abrupt to transition between clips. Multiple interpretations of the same prompt with the same overall structure can still vary greatly in their vibe and melodic motifs.</p><p>To address this, we smoothly interpolate between prompts and seeds<em> in the latent space of the model</em>. In diffusion models, the<!-- --> <a href="https://github.com/hmartiro/riffusion-inference/blob/main/riffusion/audio.py">latent space</a> <!-- -->is a feature vector that embeds the entire possible space of what the model can generate. Items which resemble each other are close in the latent space, and every numerical value of the latent space decodes to a viable output.</p><p>The key is that it&#39;s possible to sample the latent space between a prompt with two different seeds, or two different prompts with the same seed. Here is an example with the visual model:</p><div><p><img alt="" srcset="/_next/image?url=%2Fabout%2Fhappy_cows_interpolation.gif&amp;w=384&amp;q=75 1x, /_next/image?url=%2Fabout%2Fhappy_cows_interpolation.gif&amp;w=640&amp;q=75 2x" src="https://www.riffusion.com/_next/image?url=%2Fabout%2Fhappy_cows_interpolation.gif&amp;w=640&amp;q=75" width="300" height="300" decoding="async" data-nimg="1" loading="lazy"/></p></div><p>We can do the same thing with our model, which often produces buttery smooth transitions, even between starkly different prompts. This is much more interesting than interpolating the raw audio, because in the latent space all in-between points still sound like plausible clips. The figure below is colorized to show the latent space interpolation between two seeds of the same prompt. Playing this sequence is much smoother than just playing the two endpoints. The interpolated clips are often diverse and have their own riffs and motifs come and go.</p><p><img alt="Latent space interpolation example" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flatent_space_interpolation.1adf6eb9.png&amp;w=3840&amp;q=75 1x" src="https://www.riffusion.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flatent_space_interpolation.1adf6eb9.png&amp;w=3840&amp;q=75" width="2244" height="762" decoding="async" data-nimg="1" loading="lazy"/></p><p>Here is one of our favorites, a beautiful 20-step interpolation from<b> typing </b> to <b>jazz</b>:</p><p><audio controls="" src="/about/typing_to_jazz.mp3">Your browser does not support audio.</audio></p><p>And another one from <b>church bells </b> to <b>electronic beats</b>:</p><p><audio controls="" src="/about/church_bells_to_electronic_beats.mp3">Your browser does not support audio.</audio></p><p>Interpolation of <b>arabic gospel</b>, this time with the same prompt between two seeds:</p><p><audio controls="" src="/about/arabic_gospel.mp3">Your browser does not support audio.</audio></p><p>The huggingface<!-- --> <a href="https://github.com/huggingface/diffusers">diffusers</a> <!-- -->library implements a wide range of pipelines including image-to-image and prompt interpolation, but we needed an implementation for interpolation combined with image-to-image conditioning. We implemented this pipeline, along with support for masking to limit generation to only parts of an image. Code<!-- --> <a href="https://github.com/hmartiro/riffusion-inference/blob/main/riffusion/riffusion_pipeline.py">here</a>.</p><h2>Interactive Web App</h2><p>To put it all together, we made an interactive web app to type in prompts and infinitely generate interpolated content in real time, while visualizing the spectrogram timeline in 3D.</p><p>As the user types in new prompts, the audio smoothly transitions to the new prompt. If there is no new prompt, the app will interpolate between different seeds of the same prompt. Spectrograms are visualized as 3D height maps along a timeline with a translucent playhead.</p><p><img alt="web app screenshot" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fweb_app_screenshot.e598a21a.png&amp;w=3840&amp;q=75 1x" src="https://www.riffusion.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fweb_app_screenshot.e598a21a.png&amp;w=3840&amp;q=75" width="2098" height="1158" decoding="async" data-nimg="1" loading="lazy"/></p><p>The app is built using <a href="https://nextjs.org/">Next.js</a>,<!-- --> <a href="https://reactjs.org/">React</a>,<!-- --> <a href="https://www.typescriptlang.org/">Typescript</a>,<!-- --> <a href="https://threejs.org/">three.js</a>,<!-- --> <a href="https://tailwindcss.com/">Tailwind</a>, and<!-- --> <a href="https://vercel.com/">Vercel</a>.</p><p>The app communicates over an API to run the inference calls on a GPU server. We used <a href="https://truss.baseten.co">Truss</a> to package the model and test it locally before deploying it to Baseten which provided GPU-backed inference, auto-scaling, and observability. We used NVIDIA A10Gs in production.</p><p>If you have a GPU powerful enough to generate stable diffusion results in under five seconds, you can run the experience locally using our test flask server.</p><h2>Code</h2><ul><li>Web app:<!-- --> <a href="https://github.com/hmartiro/riffusion-app">https://github.com/hmartiro/ riffusion-app</a></li><li>Inference server:<!-- --> <a href="https://github.com/hmartiro/riffusion-inference">https://github.com/hmartiro/ riffusion-inference</a></li><li>Model checkpoint:<!-- --> <a href="https://huggingface.co/riffusion/riffusion-model-v1">https://huggingface.co/ riffusion/riffusion-model-v1</a></li></ul><h2>Prompt Guide</h2><p>Like other diffusion models, the quality of the results depends on the prompt and other settings. This section provides some tips for getting good results.</p><p><b>Seed image</b> - The app does image-to-image conditioning, and the seed image used for conditioning locks in the BPM and overall vibe of the prompt. There can still be a large amount of diversity with a given seed image, but the effect is present. In the app settings, you can change the seed image to explore this effect.</p><p><b>Denoising</b> - The higher the denoising, the more creative the results but the less they will resemble the seed image. The default denoising is 0.75, which does a good job of keeping on beat for most prompts. The settings allow raising the denoising, which is often fun but can quickly result in chaotic transitions and tempos.</p><p><b>Prompt</b> - When providing prompts, get creative! Try your favorite artists, instruments like saxophone or violin, modifiers like arabic or jamaican, genres like jazz or rock, sounds like church bells or rain, or any combination. Many words that are not present in the training data still work because the text encoder can associate words with similar semantics. The closer a prompt is in spirit to the seed image And BPM, the better the results. For example, a prompt for a genre that is much faster BPM than the seed image will result in poor, generic audio.</p><p><b>Prompt Reweighting</b> - We have support for providing weights for tokens in a prompt, to emphasize certain words more than others. An example syntax to boost a word is (vocals:1.2), which applies a 1.2x multiplier. The shorthand (vocals) is supported for a 1.1x boost or [vocals] for a 1.1x reduction.</p><p>Parameters can also be specified via URL, for example:</p><h2>Examples</h2><p>The app suggests some of our favorite prompts, and the share panel allows grabbing the spectrogram, audio, or a shareable URL. We&#39;re also posting some favorites at<!-- --> <a href="http://reddit.com/r/riffusion" target="_blank" rel="noreferrer">/r/riffusion</a>.</p><p>Here are some longer-form interpolations we like:</p><p><b>Sunrise DJ Set</b> to <b>hard synth solo</b>:</p><p><audio controls="" src="/about/sunrise_dj_set_to_hard_synth.mp3">Your browser does not support audio.</audio></p><p><b>Detroit Rap</b> to <b>Jazz</b>:</p><p><audio controls="" src="/about/detroit_rap_to_jazz_denoising_0_6_seed_50.mp3">Your browser does not support audio.</audio></p><p><b>Cinematic New York City in a Dust Storm</b> to<!-- --> <b>Golden hour vibes</b>:</p><p><audio controls="" src="/about/newyourkduststorm_goldenhourmountain.mp3">Your browser does not support audio.</audio></p><p><b>Techno beat</b> to <b>Jamaican rap</b>:</p><p><audio controls="" src="/about/techno_to_jamaican_rap.mp3">Your browser does not support audio.</audio></p><p><b>Fantasy ballad, female voice</b> to <b>teen boy pop star</b>:</p><p><audio controls="" src="/about/fantasy_ballad_to_teen_boy_pop_star.mp3">Your browser does not support audio.</audio></p><h2>Citation</h2><p>If you build on this work, please cite it as follows:</p><pre>@software{Forsgren_Martiros_2022,
  author = {Forsgren, Seth* 
    and Martiros, Hayk*},
  title = {{Riffusion - 
    Stable diffusion for 
    real-time music generation}},
  url = {https://riffusion.com/about},
  year = {2022}
}</pre></div></div></div>
  </body>
</html>
