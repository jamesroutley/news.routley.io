<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://discuss.python.org/t/contributing-the-pyston-jit/24195">Original</a>
    <h1>Proposal to Merge Pyston with Cpython</h1>
    
    <div id="readability-page-1" class="page"><div id="main-outlet" role="main">
        

  


      <div id="post_1" itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          


          <p><span>
              <time itemprop="datePublished" datetime="2023-02-24T00:13:59Z">
                February 24, 2023, 12:13am
              </time>
              <meta itemprop="dateModified" content="2023-02-24T00:13:59Z"/>
          <span itemprop="position">1</span>
          </span>
        </p></div>
        <div itemprop="articleBody">
          <p>(cross-posting from python-dev)</p>
<p>Hello all, we on the Pyston team would like to propose the contribution of our <a href="https://github.com/pyston/pyston/blob/pyston_main/Python/aot_ceval_jit.c" rel="noopener nofollow ugc">JIT</a> into CPython main. We’re interested in some initial feedback on this idea before putting in the work to rebase the jit to 3.12 for a PEP and more formal discussion.</p>
<p>Our jit is designed to be simple and to generate code quickly, so we believe it’s a good point on the design tradeoff curve for potential inclusion. The runtime behavior is intentionally kept almost completely the same as the interpreter, just lowered to machine code and with optimizations applied.</p>
<p>Our jit currently targets Python 3.7-3.10, and on 3.8 it achieves a 10% speedup on macrobenchmarks (similar to 3.11). It’s hard to estimate the potential speedup of our jit rebased onto 3.12 because there is overlap between what our jit does and the optimizations that have gone into the interpreter since 3.8, but there are several optimizations that would be additive with the current performance work:</p>
<ul>
<li>Eliminating bytecode dispatch overhead</li>
<li>Mostly-eliminating stack management overhead</li>
<li>Reducing the number of reference count operations in the interpreter</li>
<li>Faster function calls, particularly of C functions</li>
<li>More specialization opportunities, both because a jit is not limited by bytecode limits, but also because it is able to do dynamic specializations that are not possible in an interpreter context</li>
</ul>
<p>There is also room for more optimizations – in Pyston we’ve co-optimized the interpreter+jit combination such as by doing more extensive profiling in the interpreter. Our plan would be to submit an initial version that does not contain these optimizations in order to minimize the diff, and add them later.</p>
<p>Our jit uses the DynASM assembler library (part of LuaJIT) to generate machine code. Our jit currently supports Mac and Linux, 64-bit ARM and x86_64. Now that we have two architectures supported, adding additional ones is not too much work.</p>
<p>We think that our jit fits nicely in the technical roadmap of the Faster CPython project, but conflicts with their plan to build a new custom tracing jit.</p>
<p>As mentioned, we’d love to get feedback about the overall appetite for including a jit in CPython!</p>
        </div>

        <meta itemprop="headline" content="Contributing the Pyston jit?"/>
          <meta itemprop="keywords" content=""/>

        

         

      </div>
      <div id="post_2" itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        
        <p>I think this is an appropriate topic of discussion for the Language Summit. Any chance you will be coming to PyCon?</p>

        <meta itemprop="headline" content="Contributing the Pyston jit?"/>

        

         

      </div>
      <div id="post_3" itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        
        <p>I would be interested in helping to do this.</p>

        <meta itemprop="headline" content="Contributing the Pyston jit?"/>

        

         

      </div>
      <div id="post_4" itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        
        <div itemprop="articleBody">
          <p>I think that this is all very exciting and I look forward to seeing progress in the future. Thank you for your efforts!</p>
<p>What sort of overhead does the JIT have? I know that for short scripts, PyPy’s JIT doesn’t get a chance to kick in, so if the overhead is not negligible, there should be a switch to control whether it runs or not.</p>

<p>How practical would it be for the JIT to be selectable at interpreter start up?</p>
<p>Assuming that the two JITs have different strengths and weaknesses, and are better or worse for different code patterns, people could choose whether to run the Pyston JIT or the tracing JIT depending on which one works better for their application. Duelling JITs <img src="https://emoji.discourse-cdn.com/apple/smile.png?v=12" title=":smile:" alt=":smile:" loading="lazy" width="20" height="20"/></p>
        </div>

        <meta itemprop="headline" content="Contributing the Pyston jit?"/>

        

         

      </div>
      <div id="post_5" itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            <a itemprop="url" href="https://discuss.python.org/u/Rosuav"><span itemprop="name">Rosuav</span></a>
            (Chris Angelico)
          </span></p>


          <p><span>
              <time itemprop="datePublished" datetime="2023-02-24T11:19:52Z">
                February 24, 2023, 11:19am
              </time>
              <meta itemprop="dateModified" content="2023-02-24T11:19:52Z"/>
          <span itemprop="position">5</span>
          </span>
        </p></div>
        <div itemprop="articleBody">
          
<p>Dueling with <a href="https://en.wikipedia.org/wiki/Jitte" rel="noopener nofollow ugc">JITtes</a>? <img src="https://emoji.discourse-cdn.com/apple/slight_smile.png?v=12" title=":slight_smile:" alt=":slight_smile:" loading="lazy" width="20" height="20"/></p>
<p>And yeah, this is interesting, but I’ll want to see the performance impact on startup and how the different JITs compare.</p>
        </div>

        <meta itemprop="headline" content="Contributing the Pyston jit?"/>

        

         

      </div>
      <div id="post_6" itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            <a itemprop="url" href="https://discuss.python.org/u/undingen"><span itemprop="name">undingen</span></a>
            (Marius Wachtler)
          </span></p>


          <p><span>
              <time itemprop="datePublished" datetime="2023-02-24T23:12:28Z">
                February 24, 2023, 11:12pm
              </time>
              <meta itemprop="dateModified" content="2023-02-24T23:12:28Z"/>
          <span itemprop="position">6</span>
          </span>
        </p></div>
        <div itemprop="articleBody">
          <p>Our (I’m one of the pyston devs) JIT has very low startup overhead. It works a Python function at a time but just writes out each opcode in the function after each other without an IR and optimization passes.</p>
<p>Also now that CPython is using the adaptive interpreter I assume that some of the profiling/warmup counters it uses can also be reused for the JIT compiler which will likely lower the additional runtime overhead the JIT introduces by a small bit.</p>
<p>It should be possible to support switching between different JITs at startup - the main interpreter will just have to decide which JIT to branch into. But I think it makes sense to only implement it when there is a second JIT because it will likely just complicate things with a lot of additional abstraction layers. I don’t think its desirable to have two general JITs integrated (because of the maintenance complexity).</p>
<p>In general my experience with pyston(-lite) have shown that just implementing a JIT as an extension requires to copy in a lot of code from the interpreter and the JIT compiler really needs access to a lot of low level implementation details of CPython in order to be fast (and for some stuff just can’t be as fast as having it directly in the main executable)…</p>
        </div>

        <meta itemprop="headline" content="Contributing the Pyston jit?"/>

        

         

      </div>






    </div></div>
  </body>
</html>
