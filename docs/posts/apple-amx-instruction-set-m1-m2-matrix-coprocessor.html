<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/corsix/amx">Original</a>
    <h1>Apple AMX instruction set (M1/M2 matrix coprocessor)</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><p dir="auto">Contemporary M1 / M2 machines from Apple have (at least) four different ways for low-level programmers to perform heavy computations:</p>
<ol dir="auto">
<li>Standard ARMv8 SIMD/NEON vector instructions on CPU cores (128 bits wide, issue <a href="https://dougallj.github.io/applecpu/firestorm-simd.html" rel="nofollow">up to four per cycle on Firestorm</a>)</li>
<li>Apple&#39;s undocumented AMX instructions, issued from CPU, executed on a special accelerator execution unit</li>
<li>The Neural Engine (called ANE or NPU)</li>
<li>The GPU (e.g. <a href="https://developer.apple.com/documentation/metal/performing_calculations_on_a_gpu" rel="nofollow">Metal Compute Shaders</a>)</li>
</ol>
<p dir="auto">This repository is all about the 2<sup>nd</sup> of those: Apple&#39;s AMX instructions. Note that these instructions are neither documented nor supported by Apple. As a source of potential great confusion, Apple&#39;s AMX instructions are completely distinct from <a href="https://en.wikipedia.org/wiki/Advanced_Matrix_Extensions" rel="nofollow">Intel&#39;s AMX instructions</a>, though both are intended for issuing matrix multiply operations from a CPU.</p>
<p dir="auto">The research was done on an Apple M1 Max (2021). Older or newer chips might have different AMX instructions. <a href="https://nod.ai/comparing-apple-m1-with-amx2-m1-with-neon/" rel="nofollow">Some sources</a> report that the M1 contains version 2 of the AMX instructions, which seems plausible (possibly everything using 7-bit writemasks comes from version 1, and everything using 9-bit writemasks is new in version 2).</p>
<p dir="auto">A good one-image summary of AMX is the following figure from <a href="https://patents.google.com/patent/US20180074824A1/en" rel="nofollow">abandoned patent US20180074824A1</a>. Consider a 32x32 grid of compute units, where each unit can perform 16-bit multiply-accumulate, or a 2x2 subgrid of units can perform 32-bit multiply-accumulate, or a 4x4 subgrid can perform 64-bit multiply-accumulate. To feed this grid, there is a pool of X registers each containing 32 16-bit elements (or 16 32-bit elements, or 8 64-bit elements) and a pool of Y registers similarly containing 32 16-bit elements (or 16 32-bit elements, or 8 64-bit elements). A single instruction can perform a full outer product: multiply every element of an X register with every element of a Y register, and accumulate with the Z element in the corresponding position.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/corsix/amx/blob/main/fig2.png"><img src="https://github.com/corsix/amx/raw/main/fig2.png" alt="US20180074824A1 Figure 2"/></a></p>
<p dir="auto">A single row of the 32x32 grid can also be used to perform vector operations (rather than matrix operations) between X and Y<sup>T</sup>.</p>
<p dir="auto">In terms of available data types, the general pattern is:</p>
<ul dir="auto">
<li>IEEE754 f16 or f32 or f64 (same width for all three fused-multiply-add operands)</li>
<li>IEEE754 f16 multiplicands, accumulating onto f32</li>
<li>Integer 8-bit or 16-bit multiplicands, accumulating onto 16 or 32 bits (in various signednesses)</li>
</ul>
<p dir="auto">This repository provides:</p>
<ul dir="auto">
<li><a href="https://github.com/corsix/amx/blob/main/aarch64.h">A tiny header for accessing AMX instructions</a> (use at your own risk)</li>
<li><a href="https://github.com/corsix/amx/blob/main/RegisterFile.md">A description of the register file</a></li>
<li><a href="https://github.com/corsix/amx/blob/main/Instructions.md">A full description of every instruction</a></li>
<li><a href="https://github.com/corsix/amx/blob/main/test.md">C code matching the behaviour of every instruction</a> (using inline ARMv8 assembly to express certain things)</li>
<li><a href="https://github.com/corsix/amx/blob/main/References.md">References for further reading</a></li>
</ul>
</article>
          </div></div>
  </body>
</html>
