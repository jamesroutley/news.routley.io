<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://ptspts.blogspot.com/2013/12/how-to-make-smaller-c-and-c-binaries.html">Original</a>
    <h1>How to make smaller C and C&#43;&#43; binaries</h1>
    
    <div id="readability-page-1" class="page"><div id="post-body-4506833503297872843" itemprop="description articleBody">
<p>This blog post presents several techniques to make the binaries resulting from C or C++ compilation smaller with GCC (or Clang). Please note that almost all techniques are tradeoffs, i.e. a smaller binary can be slower and harder to debug. So don&#39;t use the techniques blindly before understanding the tradeoffs.

</p><p>The recommended GCC (and Clang) flags:

</p><ul>
<li>Use <i>-s</i> to strip debug info from the binary (and don&#39;t use <i>-g</i>). 
</li><li>Use <i>-Os</i> to optimize for output file size. (This will make the code run slower than with <i>-O2</i> or <i>-O3</i>.
</li><li>Use <i>-m32</i> to compile a 32-bit binary. 32-bit binaries are smaller than 64-bit binaries because pointers are shorter.
</li><li>In C++, use <i>-fno-exceptions</i> if your code doesn&#39;t use exceptions.
</li><li>In C++, use <i>-fno-rtti</i> if your code doesn&#39;t use RTTI (run-time type identification) or <i>dynamic_cast</i>.
</li><li>In C++, use <i>-fvtable-gc</i> to let the linker know about and remove unused virtual method tables.
</li><li>Use <i>-fno-stack-protector</i> .
</li><li>Use <i>-fomit-frame-pointer</i> (this may make the code larger on amd64).
</li><li>Use <i>-ffunction-sections -fdata-sections -Wl,--gc-sections</i> . Without this all code from each needed <i>.o</i> file will be included. With this only the needed code will be included.
</li><li>For i386, use <i>-mpreferred-stack-boundary=2</i> .
</li><li>For i386, use <i>-falign-functions=1 -falign-jumps=1 -falign-loops=1</i> .
</li><li>In C, use <i>-fno-unwind-tables -fno-asynchronous-unwind-tables</i> . Out of these, <i>-fno-asynchronous-unwind-tables</i> makes the larger difference (can be several kilobytes).
</li><li>Use <i>-fno-math-errno</i>, and don&#39;t check the <i>errno</i> after calling math functions.
</li><li>Try <i>-fno-unroll-loops</i>, sometimes it makes the file smaller.
</li><li>Use <i>-fmerge-all-constants</i>.
</li><li>Use <i>-fno-ident</i>, this will prevent the generation of the <i>.ident</i> assembler directive, which adds an identification of the compiler to the binary.
</li><li>Use <i>-mfpmath=387 -mfancy-math-387</i> to make floating point computations shorter.
</li><li>If you don&#39;t need <i>double</i> precision, but <i>float</i> preecision is enough, use <i>-fshort-double -fsingle-precision-constant</i> .
</li><li>If you don&#39;t need IEEE-conformat floating point calculations, use <i>-ffast-math</i> .
</li><li>Use <i>-Wl,-z,norelro</i> for linking, which is equivalent to <i>ld -z norelro</i> .
</li><li>Use <i>-Wl,--hash-style=gnu</i> for linking, which is equivalent to <i>ld --hash-style=gnu</i> . You may also try <i>=sysv</i> instead of <i>=gnu</i>, sometimes it&#39;s smaller by a couple of bytes. The goal here is to avoid <i>=both</i>, which is the default on some systems.
</li><li>Use <i>-Wl,--build-id=none</i> for linking, which is equivalent to <i>ld --build-id=none</i> .
</li><li>Get more flags from the <i>Os</i> list in <a href="http://github.com/ensc/dietlibc/blob/master/diet.c">diet.c</a> of <i>diet libc</i>, for about 15 architectures.
</li><li>Don&#39;t use these flags: <i>-pie</i>, <i>-fpie</i>, <i>-fPIE</i>, <i>-fpic</i>, <i>-fPIC</i>. Some of these are useful in shared libraries, so enable them only when compiling shared libraries.
</li></ul>

<p>Other ways to reduce the binary size:

</p><ul>http://www.muppetlabs.com/~breadbox/software/elfkickers.html
<li>Run <i>strip -S --strip-unneeded --remove-section=.note.gnu.gold-version --remove-section=.comment --remove-section=.note --remove-section=.note.gnu.build-id --remove-section=.note.ABI-tag</i> on the resulting binary to strip even more unneeded parts. This replaces the <i>gcc -s</i> flag with even more aggressive stripping.
</li><li>If you are using uClibc or <i>diet libc</i>, then additionally run <i>strip --remove-section=.jcr --remove-section=.got.plt</i> on the resulting binary.
</li><li>If you are using uClibc or <i>diet libc</i> with C or C++ with <i>-fno-exceptions</i>, then additionally run <i>strip --remove-section=.eh_frame --remove-section=.eh_frame_ptr</i> on the resulting binary.
</li><li>After running <i>strip ...</i> above, also run <i>sstrip</i> on the binary. Download sstrip from <a href="http://www.muppetlabs.com/~breadbox/software/elfkickers.html">ELF Kickers</a>, and compile it for yourself. Or get the 3.0a binary from <a href="http://pts.50.hu/files/sstrip/sstrip-3.0a">here</a>.
</li><li>In C++, avoid STL. Use C library functions instead.
</li><li>In C++, use as few template types as possible (i.e. code with <i>vector&lt;int&gt;</i> and <i>vector&lt;unsigned&gt;</i> is twice as long as the code with <i>vector&lt;int&gt;</i> only).
</li><li>In C++, have each of your non-POD (plain old data) classes an explicit constructor, destructor, copy-constructor and assignment operator, and implement them outside the class, in the <i>.c</i> file.
</li><li>In C++, move constructor, destructor and method bodies outside the class, in the <i>.c</i> file.
</li><li>In C++, use fewer virtual methods.
</li><li>Compress the binary using <a href="http://upx.sourceforge.net/">UPX</a>. For small binaries, use <i>upx --brute</i> or <i>upx --ultra-brute</i> . For large binaries, use <i>upx --lzma</i> . If you have large initialized arrays in your code, make sure you declare them <i>const</i>, otherwise UPX won&#39;t compress them.
</li><li>Compress the used libraries using UPX.
</li><li>If you use static linking (e.g. <i>gcc -static</i>), use <a href="http://www.uclibc.org/">uClibc</a> (most convenient way: <a href="http://ptspts.blogspot.com/2014/01/announcing-pts-xstatic-tool-for.html">pts-xstatic</a> or <a href="http://www.fefe.de/dietlibc/">diet libc</a> (most convenient way: the included <i>diet</i> tool) or <a href="http://www.musl-libc.org/download.html">musl</a> (most convenient way: the included <i>musl-gcc</i> tool) instead of glibc (GNU C library).
</li><li>Make every function static, create a <i>.c</i> file which includes all other <i>.c</i> files, and compile that with <i>gcc -W -Wall</i>. Remove all code to which the compiler says is unused. Last time this saved about 9.2 bytes per function for me.
</li><li>Don&#39;t use <i>__attribute__((regparm(3)))</i> on functions, it tends to make the code larger.
</li><li>If you have several binaries and shared libraries, consider unifying the binaries into a single one (using symlinks and distinguishing in <i>main</i> with <i>argv[0]</i>), and moving the library code to the binary. This is useful, because the shared libraries use position-independent code (PIC), which is larger.
</li><li>If it&#39;s feasible, rewrite your C++ code as C. Once it&#39;s C, it doesn&#39;t matter if you compile it with <i>gcc</i> or <i>g++</i>.
</li><li>If your binary is already less than 10 kilobytes, consider rewriting it in assembly, and generating the ELF headers manually, see the <a href="http://www.muppetlabs.com/~breadbox/software/tiny/teensy.html">tiny ELF</a> page for inspiration.
</li><li>If your binary is already less than 10 kilobytes, and you don&#39;t use any libc functions, use a linker script to generate tiny ELF headers. See the <a href="http://pts.szit.bme.hu/tinyelf.tar.gz">tarball with the linker script</a>.
</li><li>Drop the <i>--hash-style=...</i> flag passed to <i>ld</i> by <i>gcc</i>. To do so, pass the <i>-Bmydir</i> flag to <i>gcc</i>, and create the executable <i>mydir/ld</i>, which drops these flags and calls the real <i>ld</i>.
</li><li>See more flags and ideas in <a href="http://stackoverflow.com/questions/10551665/how-to-create-4kb-linux-binaries/10552160#10552160">this answer</a>.</li></ul>

</div></div>
  </body>
</html>
