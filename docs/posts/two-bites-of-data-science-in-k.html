<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.zdsmith.com/posts/two-bites-of-data-science-in-k.html">Original</a>
    <h1>Two Bites of Data Science in K</h1>
    
    <div id="readability-page-1" class="page"><div><p>2025-01-23</p><p>Here are two digestible examples of data analysis using <a href="https://wiki.k-language.dev/wiki/Main_Page">K</a>. Both cases
are afternoon-scale projects I’ve done in the last few weeks.</p><h2>The Most Common Consonants Following <em>r</em> and <em>l</em> in English</h2><p>For six months or so I’ve been developing a written shorthand, <a href="https://www.smith-shorthand.com/">Smith
Shorthand</a>. Smith is written more-or-less
<em>on the line</em>, that is: its signs are generally written upright, with their
bases resting on the baseline, just as in normal handwriting. Thus
<em>raising</em> signs from the baseline is meaningful. Raising a sign above the
baseline denotes its sign followed by a <em>t</em>; for instance, the <em>k</em> sign, when
raised, reads <em>kt</em> (as in <em>exact</em>).</p><p>There are two signs in particular that are only half as high as a normal sign:
<em>r</em> and <em>l</em>. Thus, these signs can be raised singly, to denote <em>rt</em> and
<em>lt</em>—but owing to their height they (and only they) can be raised doubly too.</p><p>Thus we ask ourselves: if doubly raising a sign were to denote the
presence of some other sound (and <em>t</em> is already accounted for), what would
be the most useful sound to indicate?</p><h3>The code</h3><p>The file we’re reading from is a copy of the <a href="http://www.speech.cs.cmu.edu/cgi-bin/cmudict">CMU Pronouncing
Dictionary</a>. It consists of a
series of lines shaped like this:</p><pre><code>BRIGADEER  B R IH2 G AH0 D IH1 R
</code></pre><p>That is: a headword, two spaces, and then a sequence of space-separated
consonant and vowel sounds (the numbers here indicate syllable stress; we
can ignore them since we’re only interested in consonants).</p><p>Our K script:</p><pre><code>dict: 0: &#34;cmudict.nopreamble.txt&#34;
sounds: 2_&#39;&#34; &#34;\&#39;dict

isRL: ~^(,&#34;R&#34;;,&#34;L&#34;)?
followsRL: -1=-&#39;: isRL@

followers: (~#:&#39;)_{x@&amp;followsRL[x]}&#39;sounds
counts: #&#39;=,/followers
&gt;counts
</code></pre><p>The output:</p><pre><code data-highlighted="yes">(<span>&#34;AH0&#34;</span>
 <span>&#34;IY0&#34;</span>
 <span>&#34;IH0&#34;</span>
 <span>&#34;EH1&#34;</span>
 <span>&#34;AE1&#34;</span>
 <span>&#34;IH1&#34;</span>
 ,<span>&#34;D&#34;</span>
 ,<span>&#34;T&#34;</span>
 <span>&#34;IY1&#34;</span>
 ,<span>&#34;Z&#34;</span>
 ...
</code></pre><p>Which is a list of sounds, ordered by the frequency with which they occur
after an <code>R</code> or <code>L</code>. We see that the first consonant sound in the list is
<code>D</code>; thus, <a href="https://www.smith-shorthand.com/Smith-Shorthand-8406c503935e452f8fa1877e17f5017e#18296ae7fbf9808eacf1c9967accd531">doubly-raising signs should indicate the presence of a
consonant cluster with
<em>d</em></a>.</p><p>Let us break down the script:</p><h3>Preparing the data</h3><pre><code>dict: 0: &#34;cmudict.nopreamble.txt&#34;
sounds: 2_&#39;&#34; &#34;\&#39;dict
</code></pre><p>In the first line we simply read the text file into <code>dict</code>, breaking on
newlines (the <code>nopreamble</code> here indicates that I had manually gone into
the file and removed some header materials). We then split each line
on <code>&#34; &#34;</code>, and finally we drop the first two tokens of each line: the
headword and an empty string. <code>sounds</code> is thus an array of arrays of
sound tokens, one for each entry in the dictionary.</p><h3>Selecting characters after an R or L</h3><pre><code>isRL: ~^(,&#34;R&#34;;,&#34;L&#34;)?
followsRL: -1=-&#39;: isRL@
</code></pre><p><code>isRL</code> is a simple function which returns whether its arguments are the strings
<code>&#34;R&#34;</code> or <code>&#34;L&#34;</code> (the odd <code>,</code>s there are due to the fact that ngn/k represents
the <em>character</em> <code>R</code> as <code>&#34;R&#34;</code>, and the <em>string</em> <code>R</code> as <code>,&#34;R&#34;</code>). <code>followsRL</code>
applies that function to a sequence, then applies subtraction to the resulting
booleans with the endlessly-useful <code>eachprior</code>. That is, it subtracts each
value from the previous value. Any time a <em>non</em>-RL (a <code>0</code>) follows an RL (a
<code>1</code>), we should expect the result to be <code>-1</code>; thus we highlight all the sounds
we’re interested in.</p><h3>Applying our selector and gathering the results</h3><pre><code>followers: (~#:&#39;)_{x@&amp;followsRL[x]}&#39;sounds
counts: #&#39;=,/followers
&gt;counts
</code></pre><p>Applying <code>{x@followsRL[x]}</code> to each entry in <code>sounds</code> pulls out the sounds
following <code>R</code> and <code>L</code> in each entry; we then filter out any empty sequences.</p><p>To count our occurrences we simply join the results up into a single sequence,
group them and find the size of each group. <code>&gt;</code>, conveniently, sorts the
dictionary by its values.</p><h2>“no bowler with as many wickets has a better average”.</h2><p>I recently saw <a href="https://www.reddit.com/r/Cricket/comments/1hyizaz/male_bowlers_about_whom_you_can_say_no_one_has/">this
post</a>
on r/cricket, which in turn linked to <a href="https://x.com/ovshake42/status/1868193085592842590">this
tweet</a>:</p><blockquote><p>Bumrah now has 190 Test wickets.</p><p>What is special about this number, you may ask.</p><p>190 allows us to use “no bowler with as many wickets has a better average”.</p><p>You see, Barnes had 189 wickets.</p><p>190 is the 6997 for bowlers.</p></blockquote><p>This made me want to do a bit of cricket data science. The linked post tried to
answer the question “how many bowlers you can say this about”, but it seemed to
rather overcomplicate the question. It seems to me that the question is
precisely this:</p><p>For all <em>n</em>, what bowler with a lifetime wickets haul of <em>n</em> has the best
average?</p><p>It bears noting that to be such a bowler is statistically interesting but not
necessarily impressive. There’s a stronger formulation of the question that’s
more impressive.</p><pre><code>\l cricket.k

filtered: {x[`Wkts]&gt;0}#bowling.t
sorted: filtered @&gt; {(x[`Wkts];-x[`Ave])} @&#39; filtered
best: sorted @ &amp;~~&#39;: allWkts:({x[`Wkts]} @&#39; sorted)

bestInClass:best @ &amp;{(*|x)=&amp;/x} @&#39; ,\ best @ `Ave

mostCompetitive: &amp;(#&#39;=allWkts)&gt;15
mostCompetitiveBowlers: {~^mostCompetitive?x[`Wkts]}#best

gap:-2#best @ &amp;-1&gt;-&#39;: ?allWkts
</code></pre><p>The module <code>cricket.k</code> defines a few utilities that I think we can pass over.</p><p>In particular it defines <code>bowling.t</code>, a table containing <a href="https://www.kaggle.com/datasets/veeralakrishna/icc-test-cricket-bowling-figures">this data
set</a>.
That is, “ICC Test Cricket Bowling Figures”: the lifetime test bowling figures
for 3003 cricketers. It’s accurate up until Jan 2020, so we will not be able to
reproduce the finding in the tweet. Anyone who can backfill the data for the
last five years will be greatly appreciated!</p><p>The table looks like this:</p><pre><code data-highlighted="yes">+![ `Player                   `Span       `Mat `Inns `Balls `Runs `Wkts `BBM     `..
 +((<span>&#34;M Muralitharan (ICC/SL)&#34;</span>;<span>&#34;1992-2010&#34;</span>; <span>133</span>;  <span>230</span>; <span>44039</span>;<span>18180</span>;  <span>800</span>;<span>&#34;16/220&#34;</span>;..)
   (<span>&#34;SK Warne (AUS)&#34;</span>         ;<span>&#34;1992-2007&#34;</span>; <span>145</span>;  <span>273</span>; <span>40705</span>;<span>17995</span>;  <span>708</span>;<span>&#34;12/128&#34;</span>;..)
   (<span>&#34;A Kumble (INDIA)&#34;</span>       ;<span>&#34;1990-2008&#34;</span>; <span>132</span>;  <span>236</span>; <span>40850</span>;<span>18355</span>;  <span>619</span>;<span>&#34;14/149&#34;</span>;..)
   (<span>&#34;JM Anderson (ENG)&#34;</span>      ;<span>&#34;2003-2020&#34;</span>; <span>151</span>;  <span>282</span>; <span>32779</span>;<span>15670</span>;  <span>584</span>;<span>&#34;Nov-71&#34;</span>;..)
   (<span>&#34;GD McGrath (AUS)&#34;</span>       ;<span>&#34;1993-2007&#34;</span>; <span>124</span>;  <span>243</span>; <span>29248</span>;<span>12186</span>;  <span>563</span>;<span>&#34;27-Oct&#34;</span>;..)
   (<span>&#34;CA Walsh (WI)&#34;</span>          ;<span>&#34;1984-2001&#34;</span>; <span>132</span>;  <span>242</span>; <span>30019</span>;<span>12688</span>;  <span>519</span>;<span>&#34;13/55&#34;</span> ;..)
   (<span>&#34;SCJ Broad (ENG)&#34;</span>        ;<span>&#34;2007-2020&#34;</span>; <span>136</span>;  <span>250</span>; <span>27793</span>;<span>13730</span>;  <span>479</span>;<span>&#34;11/121&#34;</span>;..)
   (<span>&#34;DW Steyn (SA)&#34;</span>          ;<span>&#34;2004-2019&#34;</span>;  <span>93</span>;  <span>171</span>; <span>18608</span>;<span>10077</span>;  <span>439</span>;<span>&#34;Nov-60&#34;</span>;..)
   (<span>&#34;N Kapil Dev (INDIA)&#34;</span>    ;<span>&#34;1978-1994&#34;</span>; <span>131</span>;  <span>227</span>; <span>27740</span>;<span>12867</span>;  <span>434</span>;<span>&#34;11/146&#34;</span>;..)
   (<span>&#34;HMRKB Herath (SL)&#34;</span>      ;<span>&#34;1999-2018&#34;</span>;  <span>93</span>;  <span>170</span>; <span>25993</span>;<span>12157</span>;  <span>433</span>;<span>&#34;14/184&#34;</span>;..)
   (<span>&#34;Sir RJ Hadlee (NZ)&#34;</span>     ;<span>&#34;1973-1990&#34;</span>;  <span>86</span>;  <span>150</span>; <span>21918</span>; <span>9611</span>;  <span>431</span>;<span>&#34;15/123&#34;</span>;..)
   (<span>&#34;SM Pollock (SA)&#34;</span>        ;<span>&#34;1995-2008&#34;</span>; <span>108</span>;  <span>202</span>; <span>24353</span>; <span>9733</span>;  <span>421</span>;<span>&#34;10/147&#34;</span>;..)
   (<span>&#34;Harbhajan Singh (INDIA)&#34;</span>;<span>&#34;1998-2015&#34;</span>; <span>103</span>;  <span>190</span>; <span>28580</span>;<span>13537</span>;  <span>417</span>;<span>&#34;15/217&#34;</span>;..)
   (<span>&#34;Wasim Akram (PAK)&#34;</span>      ;<span>&#34;1985-2002&#34;</span>; <span>104</span>;  <span>181</span>; <span>22627</span>; <span>9779</span>;  <span>414</span>;<span>&#34;11/110&#34;</span>;..)
   (<span>&#34;CEL Ambrose (WI)&#34;</span>       ;<span>&#34;1988-2000&#34;</span>;  <span>98</span>;  <span>179</span>; <span>22103</span>; <span>8501</span>;  <span>405</span>;<span>&#34;Nov-84&#34;</span>;..)
   (<span>&#34;NM Lyon (AUS)&#34;</span>          ;<span>&#34;2011-2020&#34;</span>;  <span>96</span>;  <span>184</span>; <span>24568</span>;<span>12320</span>;  <span>390</span>;<span>&#34;13/154&#34;</span>;..)
   (<span>&#34;M Ntini (SA)&#34;</span>           ;<span>&#34;1998-2009&#34;</span>; <span>101</span>;  <span>190</span>; <span>20834</span>;<span>11242</span>;  <span>390</span>;<span>&#34;13/132&#34;</span>;..)
   (<span>&#34;IT Botham (ENG)&#34;</span>        ;<span>&#34;1977-1992&#34;</span>; <span>102</span>;  <span>168</span>; <span>21815</span>;<span>10878</span>;  <span>383</span>;<span>&#34;13/106&#34;</span>;..)
</code></pre><p>We’ll be interested in the <code>Wkts</code> and <code>Ave</code> columns.</p><h3>“no bowler with as many wickets has a better average”.</h3><p>Let’s first answer the question as written.</p><pre><code>filtered: {x[`Wkts]&gt;0}#bowling.t
sorted: filtered @&gt; {(x[`Wkts];-x[`Ave])} @&#39; filtered
best: sorted @ &amp;~~&#39;: allWkts:({x[`Wkts]} @&#39; sorted)
</code></pre><p><code>bowling.t</code> is a table, so we’ll be using ngn/k’s syntax for slicing and dicing
tabular data. First we’ll do some basic cleanup by filtering for bowlers who
have taken at least one wicket in their career. That leaves 1784 bowlers.</p><p>We then sort the table by lifetime wickets descending, secondarily by average
ascending.</p><p>Once the table has been correctly sorted we index into it in the right places.
<code>~~&#39;:</code> is another <code>eachprior</code> application, this time of <code>~~</code>—which gives us
the indices of each place that the number of wickets changes. Having sorted,
that is the index of the bowler with the best lifetime average for that number
of wickets. Here are <a href="https://git.sr.ht/~subsetpark/cricket-stats/tree/master/item/out/bestAvgPerLifetimeWkts.json">the bowlers with the best average of all bowlers with the
same number of lifetime
wickets</a>.</p><h3>no bowler with as many wickets <em>or more</em> has a better average</h3><p>I would like to answer the more interesting and impressive question: what
bowlers have a better lifetime average than any other bowler who has taken as
many or more wickets? In other words, what bowlers define the outer edge of the
graph between average and wickets; what bowlers could you credibly claim to be
“best in class”, surpassed in average only by worse wicket-takers, or in
lifetime wickets by bowlers with worse averages?</p><pre><code>bestInClass:best @ &amp;{(*|x)=&amp;/x} @&#39; ,\ best @ `Ave
</code></pre><p>We can reason that every such bowler must have a better average at least than
those bowlers with the same number of wickets, so we can start with the result
of the weaker formulation.</p><p>We’ll then take the lifetime averages of each bowler and take a series of
prefixes with <code>,\</code>: this produces, for each bowler, a sequence of that bowler’s
average as well as the average of every bowler with a better lifetime wickets
than him.</p><p>We then test each sequence for the predicate <code>{(*|x)=&amp;/x}</code>, or: <em>is the last
value in the sequence</em> (the average of the bowler under question) <em>also the
minimum value?</em></p><p>We are left with a more rarified and interesting bunch, about whom we can say
that no bowler had a better average, save those who took fewer wickets:</p><pre><code data-highlighted="yes">+![ `Player                   `Span       `Mat `Inns `Balls `Runs `Wkts `BBM     `..
 +((<span>&#34;M Muralitharan (ICC/SL)&#34;</span>;<span>&#34;1992-2010&#34;</span>; <span>133</span>;  <span>230</span>; <span>44039</span>;<span>18180</span>;  <span>800</span>;<span>&#34;16/220&#34;</span>;..)
   (<span>&#34;GD McGrath (AUS)&#34;</span>       ;<span>&#34;1993-2007&#34;</span>; <span>124</span>;  <span>243</span>; <span>29248</span>;<span>12186</span>;  <span>563</span>;<span>&#34;27-Oct&#34;</span>;..)
   (<span>&#34;CEL Ambrose (WI)&#34;</span>       ;<span>&#34;1988-2000&#34;</span>;  <span>98</span>;  <span>179</span>; <span>22103</span>; <span>8501</span>;  <span>405</span>;<span>&#34;Nov-84&#34;</span>;..)
   (<span>&#34;MD Marshall (WI)&#34;</span>       ;<span>&#34;1978-1991&#34;</span>;  <span>81</span>;  <span>151</span>; <span>17584</span>; <span>7876</span>;  <span>376</span>;<span>&#34;Nov-89&#34;</span>;..)
   (<span>&#34;SF Barnes (ENG)&#34;</span>        ;<span>&#34;1901-1914&#34;</span>;  <span>27</span>;   <span>50</span>;  <span>7873</span>; <span>3106</span>;  <span>189</span>;<span>&#34;17/159&#34;</span>;..)
   (<span>&#34;GA Lohmann (ENG)&#34;</span>       ;<span>&#34;1886-1896&#34;</span>;  <span>18</span>;   <span>36</span>;  <span>3830</span>; <span>1205</span>;  <span>112</span>;<span>&#34;15/45&#34;</span> ;..)
   (<span>&#34;F Martin (ENG)&#34;</span>         ;<span>&#34;1890-1892&#34;</span>;   <span>2</span>;    <span>3</span>;   <span>410</span>;  <span>141</span>;   <span>14</span>;<span>&#34;12/102&#34;</span>;..)
   (<span>&#34;CS Marriott (ENG)&#34;</span>      ;<span>&#34;1933-1933&#34;</span>;   <span>1</span>;    <span>2</span>;   <span>247</span>;   <span>96</span>;   <span>11</span>;<span>&#34;Nov-96&#34;</span>;..)
   (<span>&#34;CA Smith (ENG)&#34;</span>         ;<span>&#34;1889-1889&#34;</span>;   <span>1</span>;    <span>2</span>;   <span>154</span>;   <span>61</span>;    <span>7</span>;<span>&#34;Jul-61&#34;</span>;..)
   (<span>&#34;AJL Hill (ENG)&#34;</span>         ;<span>&#34;1896-1896&#34;</span>;   <span>3</span>;    <span>1</span>;    <span>40</span>;    <span>8</span>;    <span>4</span>;<span>&#34;8-Apr&#34;</span> ;..)
   (<span>&#34;W Barber (ENG)&#34;</span>         ;<span>&#34;1935-1935&#34;</span>;   <span>2</span>;    <span>1</span>;     <span>2</span>;    <span>0</span>;    <span>1</span>;<span>&#34;Jan-00&#34;</span>;..))]
</code></pre><h3>The most “competitive” lifetime wicket counts</h3><p>The original formulation of the question prompts some more trivial questions.
The first: if we are interested in the best lifetime average for each <em>n</em>, what
are the most “competitive” <em>n</em>s—what lifetime wicket counts are held by the
most bowlers?</p><pre><code>mostCompetitive: &amp;(#&#39;=allWkts)&gt;15
mostCompetitiveBowlers: {~^mostCompetitive?x[`Wkts]}#best
</code></pre><p>Here we return to <code>allWkts</code>, which is simply the lifetime wicket count of every
bowler in the table. We group equal values with <code>=</code> and then find the wicket
counts that are held by more than (arbitrarily) 15 bowlers.</p><p>We can then select those members of <code>best</code> whose wicket counts are in the
group, identifying the bowlers who had to beat the most other players to win
their particular bracket.</p><pre><code data-highlighted="yes">+![ `Player                 `Span       `Mat `Inns `Balls `Runs `Wkts `BBM     `Av..
 +((<span>&#34;GF Bissett (SA)&#34;</span>      ;<span>&#34;1927-1928&#34;</span>;   <span>4</span>;    <span>8</span>;   <span>989</span>;  <span>469</span>;   <span>25</span>;<span>&#34;Sep-90&#34;</span>;<span>18.</span>.)
   (<span>&#34;J Middleton (SA)&#34;</span>     ;<span>&#34;1896-1902&#34;</span>;   <span>6</span>;   <span>11</span>;  <span>1064</span>;  <span>442</span>;   <span>24</span>;<span>&#34;9/130&#34;</span> ;<span>18.</span>.)
   (<span>&#34;JB Iverson (AUS)&#34;</span>     ;<span>&#34;1950-1951&#34;</span>;   <span>5</span>;    <span>8</span>;  <span>1108</span>;  <span>320</span>;   <span>21</span>;<span>&#34;Jun-52&#34;</span>;<span>15.</span>.)
   (<span>&#34;Zulfiqar Ahmed (PAK)&#34;</span> ;<span>&#34;1952-1956&#34;</span>;   <span>9</span>;   <span>10</span>;  <span>1285</span>;  <span>366</span>;   <span>20</span>;<span>&#34;Nov-79&#34;</span>;<span>18.</span>.)
   (<span>&#34;J Trim (WI)&#34;</span>          ;<span>&#34;1948-1952&#34;</span>;   <span>4</span>;    <span>8</span>;   <span>794</span>;  <span>291</span>;   <span>18</span>;<span>&#34;Jul-76&#34;</span>;<span>16.</span>.)
   (<span>&#34;TS Roland-Jones (ENG)&#34;</span>;<span>&#34;2017-2017&#34;</span>;   <span>4</span>;    <span>8</span>;   <span>536</span>;  <span>334</span>;   <span>17</span>;<span>&#34;8/129&#34;</span> ;<span>19.</span>.)
...
</code></pre><p>We also see, incidentally, that 25 wickets is the highest total with more than
15 bowlers holding it.</p><h3>The lowest gap in lifetime wickets</h3><p>Having sorted our bowlers by lifetime wickets, another question presents
itself: what is the smallest <em>n</em> that is <em>not</em> held (as of January 2020) as a
lifetime total by any bowler?</p><pre><code>gap:-2#best @ &amp;-1&gt;-&#39;: ?allWkts
</code></pre><p>Once again, we use <code>eachprior</code>: this time, we take the unique values for
lifetime wickets and find the difference between each adjacent value. Wherever
the difference is greater than -1, there’s a gap between the two values. We
then take the indices of the last two and index into <code>best</code> (which is similarly
deduped by number of lifetime wickets).</p><pre><code>((&#34;BKV Prasad (INDIA)&#34;;96;35.0;&#34;http://stats.espncricinfo.com/ci/content/player/32345.html&#34;)
 (&#34;FR Spofforth (AUS)&#34;;94;18.41;&#34;http://stats.espncricinfo.com/ci/content/player/7663.html&#34;))
</code></pre><p>We see that the lowest value not held is <em>95</em>.</p><h3>Bonus: the lowest gap in lifetime wickets, redux</h3><p>Another way of answering the question “what is the smallest <em>n</em> that is not
held as a lifetime total?” is to do some simple set arithmetic. We can also
write</p><pre><code>&amp;/(1+!|/allWkts)^allWkts
</code></pre><p>Which will remove all extent values from the set of all possible values (from 1
to the maximum lifetime wickets value), and find the lowest value in the
remaining set.</p></div></div>
  </body>
</html>
