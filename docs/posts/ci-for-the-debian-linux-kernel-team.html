<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.decadent.org.uk/ben/blog/ci-for-the-debian-kernel-team.html">Original</a>
    <h1>CI for the Debian Linux kernel team</h1>
    
    <div id="readability-page-1" class="page"><div>
<!--*- mode: html -*-->
<p>
  Starting just after Christmas, I have been working on CI for all
  the kernel team&#39;s packages on Salsa.  The salsa-ci-team has done
  great work on producing a common pipeline that is usable for most
  packages with minimal configuration.  However, for some packages
  a lot more work was required.
</p>
<h4>Linux</h4>
<p>
  I started with the most important
  package, <a href="https://salsa.debian.org/kernel-team/linux">linux</a>
  itself.  This now has about 1.1 GiB of source spread over 76,000
  source files.  That turns out to be a
  <a href="https://salsa.debian.org/salsa-ci-team/pipeline/-/issues/195">problem
  for the pipeline</a> which currently puts unpacked source in
  artifacts - it is far beyond the limits of what Salsa allows.  I
  worked around this by using a modified version of the extract-source
  and build jobs that use packed source package as the artifacts.  The
  output of the build job is compatible with the common test jobs.
</p>
<p>
  The linux package also takes a lot of resources to build; around 80
  minutes on the fastest PC I have at home (if ccache is not primed).
  Salsa&#39;s shared CI runners seem to be about 10 times slower than
  that, so it is completely unfeasible to even one full build in CI.
  Instead I defined a new build profile that includes only the
  smallest kernel configuration, without debug info, and the
  user-space packages.  This still takes over an hour with the Salsa
  CI runners, but I don&#39;t think we can improve this much without
  losing a lot of code coverage.
</p>
<p>
  Our Git repository for linux also does not contain the upstream
  source, so the extract-source job has to fetch that.  The common
  extract-source job uses <code>origtargz</code> to do that, and in
  case the orig tarball is not already in the archive this will run
  <code>uscan</code>.  That led me to a new problem: our
  <code>debian/watch</code> file could only find tarballs linked
  from the front of
  <a href="https://www.kernel.org">www.kernel.org</a>, and we&#39;re
  sometimes working with different upstream versions.  There is
  actually no single page listing all tarball releases of Linux, and
  tarballs for release candidates are dynamically generated by CGit
  and unsigned.  So I changed <code>debian/watch</code> to fetch from
  Git, which is what we were already doing with our own
  <code>genorig.py</code> script.
</p>
<p>
  Unfortunately, running <code>uscan</code> against a Git upstream,
  with some files excluded (as there are still a few upstream files we
  consider non-free), is
  <a href="https://bugs.debian.org/1003251">about twice as slow</a>
  as it could be.  Since I had to modify the extract-source job
  anyway, I&#39;ve continued using <code>genorig.py</code> there.
</p>
<p>
  A full build log for linux is over 200 MiB, and even with the
  reduced build profile it would be much longer than Salsa&#39;s limit of
  2 MiB.  I therefore opted to use the &#39;terse&#39; build option (which
  translates to <code>V=0</code>), but made the builds of user-space
  tools ignore this option so that blhc could still do its work.  (The
  kernel itself cannot use the same hardening options, so blhc is not
  useful there.)
</p>
<p>
  Finally, with the CI pipeline running, blhc and lintian showed a lot
  of problems that we hadn&#39;t been attending to.  I&#39;ve fixed all the
  blhc errors (with some careful suppressions), all the lintian
  errors, and the most straightforward lintian warnings.
</p>
<h4>firmware-nonfree</h4>
<p>
  The
  <a href="https://salsa.debian.org/kernel-team/firmware-nonfree">firmware-nonfree</a>
  package also has huge &#34;source&#34; (about 560 MB) and needed some of the
  same modifications, but is quick to build so did not require a
  special build profile.
</p>
<p>
  Running lintian over firmware-nonfree reminded me that I needed to
  sort out the unsuual and inconistent handling of machine-readable
  copyright information in this source package.  I had already done
  most of that work on a private branch in 2020, so this is mostly
  ready but I still need to resolve a licensing issue with AppStream
  metadata.
</p>
<h4>Other packages</h4>
<p>
  For
  <a href="https://salsa.debian.org/kernel-team/kernel-handbook">kernel-handbook</a>,
  there was already a trivial &#34;CI&#34; pipeline used to push static pages
  to
  <a href="https://kernel-team.pages.debian.net/kernel-handbook/">the
  web site</a>.  I&#39;ve replaced this with the common pipeline plus a
  job that will push the pages from each build on the master branch.
</p>
<p>
  For everything else, it was straightforward to enable the
  common pipeline with a little bit of configuration.
</p>

<p>
  posted at: 02:13 | path: <a href="https://www.decadent.org.uk/ben/blog/" title="path">/</a> | <a href="https://www.decadent.org.uk/ben/blog/ci-for-the-debian-kernel-team.html">permanent link to this entry</a>
</p>
</div></div>
  </body>
</html>
