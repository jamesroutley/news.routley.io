<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://positive.security/blog/ms-teams-1-feature-4-vulns">Original</a>
    <h1>Microsoft Teams: 1 feature, 4 vulnerabilities</h1>
    
    <div id="readability-page-1" class="page"><div><ul role="list"><li>We stumbled upon 4 vulnerabilities in Microsoft Team&#39;s link preview feature</li><li>The vulnerabilities allow accessing internal Microsoft services, spoofing the link preview, and, for Android users, leaking their IP address and DoS&#39;ing their Teams app/channels</li><li>We reported the issues to Microsoft in March 2021, who has only remediated one so far</li></ul><p>-- MARKDOWN --</p><p># ToC</p><p>- [Motivation](#motivation)</p><p># Motivation</p><p>While investigating [<a href="https://positive.security/blog/ms-officecmd-rce">the Windows 10 RCE we recently published](https://positive.security/blog/ms-officecmd-rce)</a>, we were [<a href="https://positive.security/blog/ms-officecmd-rce#teams-code-execution-via---inspect-debugger-and-mitm-with-sop-bypass">at one point](https://positive.security/blog/ms-officecmd-rce#teams-code-execution-via---inspect-debugger-and-mitm-with-sop-bypass)</a> looking for a way to bypass Teams&#39;/Electron&#39;s Same-Origin Policy. The idea was to escalate from JavaScript to arbitrary code execution by sending commands to a locally started Node.js debug websocket server. For a successful connection to that server, a UUID is required that is printed during application start and provided by an HTTP server running on the same websocket port.</p><p>One potential way to bypass the SOP in Teams and fetch the UUID from JavaScript is by abusing the link preview feature:</p><ol role="list"><li>Let the client generate a link preview for the target page (e.g. <a href="http://127.0.0.1:1234/json/list">http://127.0.0.1:1234/json/list</a>)</li><li>Use the summary text or perform OCR on the preview image to extract information</li></ol><p>In Teams, this preview is actually generated server-side by Microsoft (which is possible due to the lack of E2E encryption), so the feature cannot be abused to leak information from the user&#39;s local network (e.g. the Node.js debug server). However, while investigating this feature, I stumbled upon a few unrelated vulnerabilities in its implementation.</p><p># 1 SSRF</p><p><strong>**Description:**</strong> While we can&#39;t leak information from the <em>user&#39;s</em> local network, we could theoretically leak information from <em>Microsoft</em>&#39;s local network. Getting slightly distracted from my original goal, I tested the `/urlp/v1/url/info` endpoint for Server-Side Request Forgery and was quite surprised to see that this obvious attack vector has not been protected against.</p><figure><a href="https://positive.security/#zoom" target="_blank"><p><img src="https://uploads-ssl.webflow.com/5f6498c074436c349716e747/61bfe88f4482483c4a4de964_1_all.png" loading="lazy" alt=""/></p></a><figcaption>Fetching link previews for 127.0.0.1:80, 127.0.0.1:8080 and the Azure Metadata service (169.254.169.254)</figcaption></figure><p><strong>**Impact:**</strong> The URL is not filtered, leading to a limited SSRF (response time, code, size and open graph data leaked), which can be used for internal portscanning and sending HTTP-based exploits to the discovered web services.</p><p>Having a slightly closer look at the link preview, I identified 3 more vulnerabilities:</p><p># 2 Spoofing</p><p><strong>**Description:**</strong> The preview link target can be set to any location independent of the main link, preview image and description, the displayed hostname or onhover text.</p><figure><a href="https://positive.security/#zoom" target="_blank"><p><img src="https://uploads-ssl.webflow.com/5f6498c074436c349716e747/61bfce55d742df076da1e92e_2_Spoofing.png" loading="lazy" alt=""/></p></a><figcaption>Changing the actual target URI while keeping the preview data</figcaption></figure><p><figure>
<video preload="none" poster="https://uploads-ssl.webflow.com/5f6498c074436c50c016e745/61bfdd504873db9fd8faa13e_spoofing_demo_censored-poster-00001.jpg" controls="" data-wf-ignore="true" data-object-fit="cover">
<source src="https://uploads-ssl.webflow.com/5f6498c074436c50c016e745/61bfdd504873db9fd8faa13e_spoofing_demo_censored-transcode.mp4" data-wf-ignore="true"/>
<source src="https://uploads-ssl.webflow.com/5f6498c074436c50c016e745/61bfdd504873db9fd8faa13e_spoofing_demo_censored-transcode.webm" data-wf-ignore="true"/></video>
<figcaption>Fully spoofing the link target</figcaption>
</figure></p><p><strong>**Impact:**</strong> When clicking the preview, a different link is opened than what was expected by the user. This can be used either for improved phishing attacks, or to hide malicious links.</p><p><strong>**Additional notes:**</strong>‍</p><p>- Earlier this year, we discovered a [critical vulnerability in WinSCP](https://positive.security/blog/url-open-rce#bonus-vulnerability-winscp) (CVE-2021-3331, fixed in v5.17.10), which can be triggered with the allowed `ftps://` URI scheme. Since there is no `ftps://` default handler in Windows, it&#39;s a bit surprising that this scheme is explicitly allowed in Teams and it might be a good idea for its developers to remove it from the internal `allowedHrefProtocols`-list for further hardening</p><p># 3 IP Address Leak (Android)</p><p><strong>**Description:**</strong> When creating a link preview, the backend fetches the referenced preview thumbnail and makes it available from a Microsoft domain. This ensures that the IP address and user agent data is not leaked when the receiving client loads the thumbnail. However, by intercepting the sending of the message, it&#39;s possible to point the thumbnail URL to a non-Microsoft domain. The Android client does not check the domain/does not have a CSP restricting the allowed domains and loads the thumbnail image from any domain.</p><figure><a href="https://positive.security/#zoom" target="_blank"><p><img src="https://uploads-ssl.webflow.com/5f6498c074436c349716e747/61bfda1004d338dd13c3dab1_3_IP_leak.png" loading="lazy" alt=""/></p></a><figcaption>Changing the original thumbnail URL to reference a picture on our website</figcaption></figure><figure><a href="https://positive.security/#zoom" target="_blank"><p><img src="https://uploads-ssl.webflow.com/5f6498c074436c349716e747/61bfe5b78367b2f73d19545d_3_IP_leak_3.png" loading="lazy" alt=""/></p></a><figcaption>This picture is directly fetched from the referenced website when the message is opened</figcaption></figure><p><strong>**Impact:**</strong> Allows leaking an user&#39;s IP address and user agent data by sending a message with a specially crafted link preview (for Teams users on Android).</p><p>**Note:** This issue seems patched now. See the [disclosure section](#disclosure) below.</p><p># 4 Denial of Service aka Message of Death (Android)</p><p><strong>**Description:**</strong> When receiving a message that includes a link preview with an invalid preview link target (e.g. &#34;boom&#34; instead of &#34;https://...&#34;), the Android app crashes. The app keeps crashing when trying to open the chat/channel with the malicious message, which makes the chat/channel unusable for Android users.</p><figure><a href="https://positive.security/#zoom" target="_blank"><p><img src="https://uploads-ssl.webflow.com/5f6498c074436c349716e747/61bfd9eec26837fb021ec227_4_Android_DoS.png" loading="lazy" alt=""/></p></a></figure><p><figure width="50%">
<video preload="none" poster="https://uploads-ssl.webflow.com/5f6498c074436c50c016e745/61bfe6eb61c7546e7e78e04e_short_dos_w-poster-00001.jpg" controls="" data-wf-ignore="true" data-object-fit="cover">
<source src="https://uploads-ssl.webflow.com/5f6498c074436c50c016e745/61bfe6eb61c7546e7e78e04e_short_dos_w-transcode.mp4" data-wf-ignore="true"/>
<source src="https://uploads-ssl.webflow.com/5f6498c074436c50c016e745/61bfe6eb61c7546e7e78e04e_short_dos_w-transcode.webm" data-wf-ignore="true"/></video>
<figcaption>MS Team crashes on opening a channel containing the malicious message (don&#39;t mind the two channels with the same name)</figcaption>
</figure></p><p><strong>**Impact:**</strong> Allows DoS&#39;ing users and channels with a single message (for Teams users on Android).</p><p># Disclosure</p><p>All four issues have been reported to Microsoft on March 10, 2021 via the MSRC program.</p><p>Only the Android IP address leak has seemingly been patched.</p><p>`2021-03-10`: We report the issues to Microsoft</p><blockquote>Thank you again for submitting this issue to Microsoft. We determined that this issue does not require immediate security service and we assessed this as low severity for temporary DoS that requires restart of application. A fix for this issue will be considered in a future version of this product or service. At this time, we will not be providing ongoing updates of the status of the fix for this issue, and we have closed this case.</blockquote><p>`2021-03-25`: MS closes the SSRF ticket without a patch:</p><blockquote>Microsoft has decided that it will not be fixing this vulnerability in the current version and we are closing this case. At this time, you are able to blog about/discuss this case and/or present your findings publicly about the current version.</blockquote><p>`2021-04-04`: MS closes the IP address leak ticket without a patch:</p><blockquote>MSRC has investigated this issue and concluded that this does not pose an immediate threat that requires urgent attention due to the general data sensitivity of the IP address data. We have shared the report with the team responsible for maintaining the product or service. They will review for a potential fix and take appropriate action as needed to help keep customers protected.</blockquote><p>`2021-04-14`: MS closes the URL preview spoofing ticket without a patch:</p><blockquote>MSRC has investigated this issue and concluded that this does not pose an immediate threat that requires urgent attention because once the user clicks on the URL, they would have to go to that malicious URL which would be a giveaway that it&#39;s not the one the user was expecting.</blockquote><p>`2021-12-15`: We retest all issues; only the IP address leak seems patched</p><p># Conclusion</p><p>While the discovered vulnerabilities have a limited impact, it&#39;s surprising both that such simple attack vectors have seemingly not been tested for before, and that Microsoft does not have the willingness or resources to protect their users from them.</p></div><div><h5>Follow us on Twitter (<a href="https://twitter.com/positive_sec">@positive_sec</a>) to keep up to date with our posts.</h5><p>‍</p></div></div>
  </body>
</html>
