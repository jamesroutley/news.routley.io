<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mclare.blog/posts/using-pulumi-with-hetzner">Original</a>
    <h1>Using Pulumi with Hetzner</h1>
    
    <div id="readability-page-1" class="page"><div id="observablehq-main">

<p>Consolidating domains and moving cloud providers has been a &#34;TODO&#34; on my org list for quite a while.</p>
<p>I&#39;m currently hosting on both Bluehost and Digital Ocean, and both cost significantly more than I would like to be paying. <a href="https://www.hetzner.com/" target="_blank" rel="noopener noreferrer">Hetzner</a> got on my radar a few months ago, and the cost differential (a monthly reduction of 80%) was highly appealing.</p>
<p>While I haven&#39;t finished this process (goal is by the end of the year), I did at least start working on the first part of better managing static (and SPA) sites with Pulumi. In the interest of <em>not</em> borking any of my existing systems, I took a domain I already owned (<a href="https://spitedriven.dev" target="_blank" rel="noopener noreferrer">spitedriven.dev</a>), but had no actual site to see how hard it would be to set up Pulumi to manage my infrastructure.</p>
<h2 id="why-pulumi" tabindex="-1"><a href="#why-pulumi">Why Pulumi?</a></h2>
<p>I&#39;ve used Terraform for work, but I&#39;ve been interested in <a href="https://www.pulumi.com/" target="_blank" rel="noopener noreferrer">Pulumi</a> for a while as an <strong>open source</strong> solution with Python support (among others). Pulumi also had an <a href="https://www.pulumi.com/registry/packages/hcloud/" target="_blank" rel="noopener noreferrer">Hcloud Provider</a> available, so it looked like this could be pretty easy to set up.</p>
<h2 id="what-i-did" tabindex="-1"><a href="#what-i-did">What I Did</a></h2>
<p>The first step was to install the Pulumi CLI (and upgrade XCode). While Pulumi has a bunch of templates, it didn&#39;t have one for Hetzner Cloud (yet), so I opted to start a project just using</p>
<pre data-language="sh"><code>pulumi new python
</code></pre>
<p>I was initially hoping that I could even manage my DNS with Hetzner DNS and Pulumi, but that proved to be an unsuccesful detour. While there is a Github repo for <a href="https://github.com/spion/pulumi-hetznerdns" target="_blank" rel="noopener noreferrer">pulumi-hetznerdns</a>, it doesn&#39;t look like it&#39;s being maintained. The PyPI package has vanished, and attempts to build the site package locally failed. I might revisit this later when I have more time, but it was only a minimal addition of brain space to add the A records to Porkbun to point to the right server.</p>
<p>One thing that was a bit annoying to troubleshoot was that I decided to use <a href="https://docs.astral.sh/uv/" target="_blank" rel="noopener noreferrer">uv</a> for the first time to manage the <code>venv</code> for Pulumi. I kept having issues with <code>pulumi up</code> wiping out the site packages, which then resulted in <code>ImportError: No module named hetzner_hcloud</code>. I needed to add</p>
<pre data-language="yaml"><code><span>dependencies:</span>
  <span>-</span> <span>requirements.txt</span>
</code></pre>
<p>to my <code>Pulumi.yaml</code> file</p>
<p>I also had to manually recreate all the secrets for my <code>Pulumi.dev.yaml</code> via</p>
<pre data-language="sh"><code>pulumi config <span>set</span> --secret dev:<span>${VAR}</span> <span>${VAR_VALUE}</span>
</code></pre>
<p>because I created a new Pulumi <code>stack</code> of <code>dev</code>.</p>
<h2 id="pulumi-main-py" tabindex="-1"><a href="#pulumi-main-py">Pulumi <code>__main__.py</code></a></h2>
<p>My final <code>__main__.py</code> file for the Pulumi project looked like this:</p>
<pre data-language="python"><code><span>import</span> pulumi
<span>from</span> pulumi <span>import</span> ResourceOptions
<span>from</span> pulumi_hcloud <span>import</span> Provider, Server
<span>import</span> pulumi_command <span>as</span> command

config = pulumi.Config()
hcloud = Provider(<span>&#34;hcloud&#34;</span>, token=config.require_secret(<span>&#34;hetzner_token&#34;</span>))

server = Server.get(
    <span>&#34;existing-server&#34;</span>,
    config.require(<span>&#34;server_id&#34;</span>),
    opts=ResourceOptions(provider=hcloud),
)

certbot_install = command.remote.Command(
    <span>&#34;install-certbot&#34;</span>,
    connection={
        <span>&#34;host&#34;</span>: server.ipv4_address,
        <span>&#34;user&#34;</span>: <span>&#34;root&#34;</span>,
        <span>&#34;private_key&#34;</span>: config.require(<span>&#34;ssh_private_key&#34;</span>),
    },
    create=<span>&#34;apt update &amp;&amp; apt install -y certbot python3-certbot-nginx&#34;</span>,
)

site_dir = command.remote.Command(
    <span>&#34;create-dir&#34;</span>,
    connection={
        <span>&#34;host&#34;</span>: server.ipv4_address,
        <span>&#34;user&#34;</span>: <span>&#34;root&#34;</span>,
        <span>&#34;private_key&#34;</span>: config.require(<span>&#34;ssh_private_key&#34;</span>),
    },
    create=pulumi.Output.concat(
        <span>&#34;mkdir -p /var/www/&#34;</span>,
        config.require(<span>&#34;domain&#34;</span>),
        <span>&#34; &amp;&amp; &#34;</span>,
        <span>&#34;chown -R www-data:www-data /var/www/&#34;</span>,
        config.require(<span>&#34;domain&#34;</span>),
    ),
    opts=ResourceOptions(depends_on=[certbot_install]),
)

site_sync = command.local.Command(
    <span>&#34;sync-site&#34;</span>,
    create=pulumi.Output.concat(
        <span>&#34;rsync -avz -e &#39;ssh -i &#34;</span>,
        config.require(<span>&#34;ssh_private_key_path&#34;</span>),
        <span>&#34;&#39; &#34;</span>,
        config.require(<span>&#34;site_path&#34;</span>),
        <span>&#34;/* root@&#34;</span>,
        server.ipv4_address,
        <span>&#34;:/var/www/&#34;</span>,
        config.require(<span>&#34;domain&#34;</span>),
        <span>&#34;/&#34;</span>,
    ),
    opts=ResourceOptions(depends_on=[site_dir]),
)

nginx_config = command.remote.Command(
    <span>&#34;nginx-config&#34;</span>,
    connection={
        <span>&#34;host&#34;</span>: server.ipv4_address,
        <span>&#34;user&#34;</span>: <span>&#34;root&#34;</span>,
        <span>&#34;private_key&#34;</span>: config.require(<span>&#34;ssh_private_key&#34;</span>),
    },
    create=pulumi.Output.concat(
        <span>&#34;cat &gt; /etc/nginx/sites-available/&#34;</span>,
        config.require(<span>&#34;domain&#34;</span>),
        <span>&#34; &lt;&lt; &#39;EOL&#39;\n&#34;</span>,
        <span>&#34;server {\n&#34;</span>,
        <span>&#34;    listen 80;\n&#34;</span>,
        <span>&#34;    listen [::]:80;\n&#34;</span>,
        <span>&#34;    server_name &#34;</span>,
        config.require(<span>&#34;domain&#34;</span>),
        <span>&#34; www.&#34;</span>,
        config.require(<span>&#34;domain&#34;</span>),
        <span>&#34;;\n&#34;</span>,
        <span>&#34;    root /var/www/&#34;</span>,
        config.require(<span>&#34;domain&#34;</span>),
        <span>&#34;;\n&#34;</span>,
        <span>&#34;    index index.html;\n&#34;</span>,
        <span>&#34;}\n&#34;</span>,
        <span>&#34;EOL\n&#34;</span>,
        <span>&#34;ln -sf /etc/nginx/sites-available/&#34;</span>,
        config.require(<span>&#34;domain&#34;</span>),
        <span>&#34; /etc/nginx/sites-enabled/&#34;</span>,
        <span>&#34; &amp;&amp; nginx -t &amp;&amp; systemctl reload nginx&#34;</span>,
    ),
    opts=ResourceOptions(depends_on=[site_sync]),
)

ssl_cert = command.remote.Command(
    <span>&#34;ssl-cert&#34;</span>,
    connection={
        <span>&#34;host&#34;</span>: server.ipv4_address,
        <span>&#34;user&#34;</span>: <span>&#34;root&#34;</span>,
        <span>&#34;private_key&#34;</span>: config.require(<span>&#34;ssh_private_key&#34;</span>),
    },
    create=pulumi.Output.concat(
        <span>&#34;certbot --nginx -d &#34;</span>,
        config.require(<span>&#34;domain&#34;</span>),
        <span>&#34; -d www.&#34;</span>,
        config.require(<span>&#34;domain&#34;</span>),
        <span>&#34; --non-interactive --agree-tos -m &#34;</span>,
        config.require(<span>&#34;email&#34;</span>),
    ),
    opts=ResourceOptions(depends_on=[nginx_config]),
)

pulumi.export(<span>&#34;server_ip&#34;</span>, server.ipv4_address)
</code></pre>
<p>which handles almost everything I&#39;ve previously been handling manually, including setting SSL certs, NGINX configuration, and site syncing from my local machine. Since this is just a static site, I anticipate some additional complications with porting over some applications (including <a href="https://bridge.watch" target="_blank" rel="noopener noreferrer">bridge.watch</a>) which is running off of containers with <code>docker-compose</code>.</p>
<p>The only other hiccup I had with this setup had to do with my SSH keys in Hetzner Cloud. While I had created a key with <code>ssh-keygen</code> and copied the public key to Hetzner Cloud, I was still being prompted for a password on both the server itself at the CLI, and when trying to run <code>ssh root@${MY_SERVER}</code>. It turned out that I needed to either run:</p>
<pre data-language="sh"><code>ssh-add ~/.ssh/<span>${MY_HETZNER_KEY}</span>
</code></pre>
<p>for adding it to the <code>ssh-agent</code></p>
<p>or explicitly passing it in the command line:</p>
<pre data-language="sh"><code>ssh -v -i ~/.ssh/<span>${MY_HETZNER_KEY}</span> root@<span>${MY_HETZNER_SERVER}</span>
</code></pre>
<p><code>pulumi up</code> gave me a preview of what would happen on my server, and then gave me a readout of the status for each command I&#39;d specified in the project file:</p>
<pre data-language="sh"><code>✦ ❯ pulumi up                                                                                       
Previewing update (dev)

     Type                        Name             Plan       
 +   pulumi:pulumi:Stack         dev-dev          create     
 +   ├─ pulumi:providers:hcloud  hcloud           create     
 +   ├─ <span>command</span>:remote:Command   install-certbot  create     
 +   ├─ <span>command</span>:remote:Command   create-dir       create     
 +   ├─ <span>command</span>:<span>local</span>:Command    sync-site        create     
 +   ├─ <span>command</span>:remote:Command   nginx-config     create     
 +   └─ <span>command</span>:remote:Command   ssl-cert         create     

Resources:
    + 7 to create

Do you want to perform this update? <span>yes</span>
Updating (dev)

     Type                        Name             Status              
 +   pulumi:pulumi:Stack         dev-dev          created (16s)       
 +   ├─ pulumi:providers:hcloud  hcloud           created (0.26s)     
 +   ├─ <span>command</span>:remote:Command   install-certbot  created (7s)        
 +   ├─ <span>command</span>:remote:Command   create-dir       created (0.64s)     
 +   ├─ <span>command</span>:<span>local</span>:Command    sync-site        created (0.93s)     
 +   ├─ <span>command</span>:remote:Command   nginx-config     created (0.72s)     
 +   └─ <span>command</span>:remote:Command   ssl-cert         created (3s)        

Resources:
    + 7 created

Duration: 21s
</code></pre>
<p>And with that, I have the scaffold for adding all my other static sites to Hetnzer!
<img src="https://news.ycombinator.com/_file/posts/using-pulumi-with-hetzner/spitedriven_dev.2799652a.png" alt="spitedriven.dev"/></p>
<p>
  <a href="https://spitedriven.dev" target="_blank" rel="noopener noreferrer">Landing page for spitedriven.dev</a>
</p>
</div></div>
  </body>
</html>
