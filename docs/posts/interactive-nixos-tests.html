<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://paperless.blog/interactive-nixos-tests">Original</a>
    <h1>Interactive NixOS Tests</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody">
    <p>A quick guide to running
<a href="https://github.com/NixOS/nixpkgs/tree/master/nixos/tests">NixOS tests</a>
interactively like you would in other testing framework.</p>

<ol>
  <li>
    <p>Insert the following line where you’d like to interact in <code>testScript</code>:</p>

    
  </li>
  <li>
    <p>Build and run the test driver for your test after replacing <code>TEST</code> with your
actual test name:</p>

    <div><div><pre><code><span>&#34;</span><span>$(</span>nix-build <span>-A</span> nixosTests.TEST.driver<span>)</span><span>/bin/nixos-test-driver&#34;</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>Once you get a Python debugger prompt like <code>(Pdb)</code> you’re in an interactive
Python shell, and can run Python commands interactively. This terminal
unfortunately does not have auto-complete enabled, but it <em>does</em> support
discovery via the <code>?</code> special command:</p>

<div><div><pre><code>(Pdb) ?

Documented commands (type help &lt;topic&gt;):
========================================
EOF    c          d        h         list      q        rv       undisplay
a      cl         debug    help      ll        quit     s        unt
alias  clear      disable  ignore    longlist  r        source   until
args   commands   display  interact  n         restart  step     up
b      condition  down     j         next      return   tbreak   w
break  cont       enable   jump      p         retval   u        whatis
bt     continue   exit     l         pp        run      unalias  where
</code></pre></div></div>

<p>⚠ Machine logs will continue to print to your terminal after the prompt shows
up! You can try the <a href="#example-session">example session</a> below to see this in
action. If you suspect that the prompt has been buried in logs, just press
<kbd>Enter</kbd>. If you’ve not yet reached the prompt it should simply draw an
empty line.</p>

<p>You can also get into an interactive shell on any of the nodes you have started
by running the following after replacing <code>NODE</code> with your node name:</p>



<p>Once you’re done, exit with <kbd>Ctrl-d</kbd> like you would a normal shell to
get back into the Python debugger.</p>

<p>Once you’re done in the Python debugger, either run <code>continue</code> to finish running
the tests or press <kbd>Ctrl-d</kbd> to cancel the test run.</p>

<h2 id="example-session">Example session</h2>

<p>Using current nixpkgs:</p>

<ol>
  <li>
    <p>Add a breakpoint after starting all the machines in the SSH audit test:</p>

    <div><div><pre><code><span>sed</span> <span>--in-place</span> <span>--expression</span><span>=</span><span>&#39;/start_all()/a\      breakpoint()&#39;</span> nixos/tests/ssh-audit.nix
</code></pre></div>    </div>
  </li>
  <li>
    <p>Run the test:</p>

    <div><div><pre><code><span>&#34;</span><span>$(</span>nix-build <span>-A</span> nixosTests.ssh-audit.driver<span>)</span><span>/bin/nixos-test-driver&#34;</span>
</code></pre></div>    </div>
  </li>
  <li>Wait for the output to quieten down.</li>
  <li>Press <kbd>Enter</kbd> to re-draw the Python debugger prompt.</li>
  <li>Run <code>server.shell_interact()</code> to start Bash in the server VM.</li>
  <li>Run <code>hostname</code> to verify that you’re indeed on the server VM.</li>
  <li>Press <kbd>Ctrl-d</kbd> to return to the Python debugger prompt.</li>
  <li>Press <kbd>Ctrl-d</kbd> again to end debugging.</li>
  <li>
    <p>Remove the SSH audit test breakpoint:</p>

    <div><div><pre><code><span>sed</span> <span>--in-place</span> <span>--expression</span><span>=</span><span>&#39;/      breakpoint()/d&#39;</span> nixos/tests/ssh-audit.nix
</code></pre></div>    </div>
  </li>
</ol>

<p>⚠ Interactivity broke for me in weird ways during testing. Once after exiting
Bash I got a new Bash prompt rather than going back to the Python debugger, and
the shell seemed to be broken. Another time the shell would no longer show any
of my input, but did show command output. Another user mentioned how pressing
either <kbd>Ctrl-c</kbd> or <kbd>Ctrl-d</kbd> could cause the entire session to
end from within <code>shell_interact()</code>. This points to some broken signal handling,
so try to be careful with using the minimum amount of
<kbd>Ctrl-c</kbd>/<kbd>Ctrl-d</kbd> while debugging. And if anything like this
happens, you’ll probably want to run <code>reset</code> once you get back to your native
shell. Update: I’ve <a href="https://github.com/NixOS/nixpkgs/issues/320919">reported</a>
the easily reproducible findings.</p>

<h2 id="sources--more-info">Sources &amp; more info</h2>

<ul>
  <li><a href="https://nixos.org/manual/nixos/stable/#sec-running-nixos-tests-interactively">Running Tests interactively in the reference</a></li>
  <li><a href="https://blog.thalheim.io/2023/01/08/how-to-execute-nixos-tests-interactively-for-debugging/">How to execute NixOS tests interactively for debugging</a></li>
</ul>

  </div></div>
  </body>
</html>
