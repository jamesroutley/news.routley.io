<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://cloud.google.com/bigquery/docs/pipe-syntax-guide">Original</a>
    <h1>SQL pipe syntax available in public preview in BigQuery</h1>
    
    <div id="readability-page-1" class="page"><div>

  
    
    






































































































































































  

  




























<!-- mdlint off(WHITESPACE_LINE_LENGTH) -->















<p>Pipe query syntax is an extension to GoogleSQL that supports a linear
query structure designed to make your queries easier to read, write, and
maintain. You can use pipe syntax anywhere you write GoogleSQL.</p>

<p>Pipe syntax supports the same operations as existing <a href="https://eieio.games/bigquery/docs/reference/standard-sql/query-syntax">GoogleSQL query
syntax</a>, or <em>standard syntax</em>—for instance, selection,
aggregation and grouping, joining, and filtering—but the operations can be
applied in any order, any number of times. The linear structure of pipe syntax
lets you write queries so that the order of the query syntax matches the order
of logical steps taken to build the result table.</p>

<p>Queries that use pipe syntax are priced, executed, and optimized the same way
as their equivalent standard syntax queries. When you write queries with pipe
syntax, follow the guidelines to
<a href="https://eieio.games/bigquery/docs/best-practices-costs">estimate costs</a> and
<a href="https://eieio.games/bigquery/docs/best-practices-performance-compute">optimize query computation</a>.</p>

<p>Standard syntax suffers from issues that can make it
difficult to read, write, and maintain. The following table shows how pipe
syntax addresses these issues:</p>

<table>
  <thead>
    <tr>
      <th>Standard syntax</th>
      <th>Pipe syntax</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Clauses must appear in a particular order.</td>
      <td>Pipe operators can be applied in any order.</td>
    </tr>
    <tr>
        <td>More complex queries, such as queries with multi-level aggregation,
          usually require CTEs or nested subqueries.</td>
        <td>More complex queries are usually expressed by adding pipe operators
          to the end of the query.</td>
    </tr>
    <tr>
        <td>During aggregation, columns are repeated in the <code translate="no" dir="ltr">SELECT</code>,
        <code translate="no" dir="ltr">GROUP BY</code>, and <code translate="no" dir="ltr">ORDER BY</code> clauses.</td>
        <td>Columns can be listed only once per aggregation.</td>
    </tr>
  </tbody>
</table>

<p>For full syntax details, see the <a href="https://eieio.games/bigquery/docs/reference/standard-sql/pipe-syntax#pipe_query_syntax">Pipe query syntax</a> reference
documentation.</p>

<h2 id="basic_syntax" data-text="Basic syntax" tabindex="-1">Basic syntax</h2>

<p>In pipe syntax, queries start with a standard SQL query or a <code translate="no" dir="ltr">FROM</code> clause. For
example, a standalone <code translate="no" dir="ltr">FROM</code> clause, such as <code translate="no" dir="ltr">FROM MyTable</code>, is valid
pipe syntax. The result of the standard SQL query or the table from the <code translate="no" dir="ltr">FROM</code>
clause can then be passed as input to a pipe symbol, <code translate="no" dir="ltr">|&gt;</code>, followed by a pipe
operator name and any arguments to that operator. The pipe operator transforms
the table in some way, and the result of that transformation can be passed to
another pipe operator.</p>

<p>You can use any number of pipe operators in your query to do things such as
select, order, filter, join, or aggregate columns. The names of pipe operators
match their standard syntax counterparts and generally have the same behavior.
The main difference between standard syntax and pipe syntax is the way you
structure your query. As the logic expressed by your query becomes more complex,
the query can still be expressed as a linear sequence of pipe operators, without
using deeply nested subqueries, making it easier to read and understand.</p>

<p>Pipe syntax has the following key characteristics:</p>

<ul>
<li>Each pipe operator in pipe syntax consists of the pipe symbol, <code translate="no" dir="ltr">|&gt;</code>, an
operator name, and any arguments: </li>
<li>Pipe operators can be added to the end of any valid query.</li>
<li>Pipe operators can be applied in any order, any number of times.</li>
<li>Pipe syntax works anywhere standard syntax is supported: in queries, views,
table-valued functions, and other contexts.</li>
<li>Pipe syntax can be mixed with standard syntax in the same query. For
example, subqueries can use different syntax from the parent query.</li>
<li>A pipe operator can see every alias that exists in the table preceding the
pipe.</li>
<li>A query can <a href="https://eieio.games/bigquery/docs/reference/standard-sql/pipe-syntax#from_queries">start with a <code translate="no" dir="ltr">FROM</code> clause</a>, and pipe operators
can optionally be added after the <code translate="no" dir="ltr">FROM</code> clause.</li>
</ul>

<p>Consider the following table:</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>CREATE</span><span> </span><span>OR</span><span> </span><span>REPLACE</span><span> </span><span>TABLE</span><span> </span><span>Produce</span><span> </span><span>AS</span><span> </span><span>(</span>
<span>  </span><span>SELECT</span><span> </span><span>&#39;apples&#39;</span><span> </span><span>AS</span><span> </span><span>item</span><span>,</span><span> </span><span>2</span><span> </span><span>AS</span><span> </span><span>sales</span><span>,</span><span> </span><span>&#39;fruit&#39;</span><span> </span><span>AS</span><span> </span><span>category</span>
<span>  </span><span>UNION</span><span> </span><span>ALL</span>
<span>  </span><span>SELECT</span><span> </span><span>&#39;apples&#39;</span><span> </span><span>AS</span><span> </span><span>item</span><span>,</span><span> </span><span>7</span><span> </span><span>AS</span><span> </span><span>sales</span><span>,</span><span> </span><span>&#39;fruit&#39;</span><span> </span><span>AS</span><span> </span><span>category</span>
<span>  </span><span>UNION</span><span> </span><span>ALL</span>
<span>  </span><span>SELECT</span><span> </span><span>&#39;carrots&#39;</span><span> </span><span>AS</span><span> </span><span>item</span><span>,</span><span> </span><span>0</span><span> </span><span>AS</span><span> </span><span>sales</span><span>,</span><span> </span><span>&#39;vegetable&#39;</span><span> </span><span>AS</span><span> </span><span>category</span>
<span>  </span><span>UNION</span><span> </span><span>ALL</span>
<span>  </span><span>SELECT</span><span> </span><span>&#39;bananas&#39;</span><span> </span><span>AS</span><span> </span><span>item</span><span>,</span><span> </span><span>15</span><span> </span><span>AS</span><span> </span><span>sales</span><span>,</span><span> </span><span>&#39;fruit&#39;</span><span> </span><span>AS</span><span> </span><span>category</span><span>);</span>
</code></pre></devsite-code>
<p>The following queries each contain valid pipe syntax that shows how you can
build a query sequentially.</p>

<p>Queries can
<a href="https://eieio.games/bigquery/docs/reference/standard-sql/pipe-syntax#from_queries">start with a <code translate="no" dir="ltr">FROM</code> clause</a>
and don&#39;t need to contain a pipe symbol:</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>-- View the table.</span>
<span>FROM</span><span> </span><span>Produce</span><span>;</span>

<span>/*---------+-------+-----------+</span>
<span> | item    | sales | category  |</span>
<span> +---------+-------+-----------+</span>
<span> | apples  | 7     | fruit     |</span>
<span> | apples  | 2     | fruit     |</span>
<span> | carrots | 0     | vegetable |</span>
<span> | bananas | 15    | fruit     |</span>
<span> +---------+-------+-----------*/</span>
</code></pre></devsite-code>
<p>You can filter with a <a href="https://eieio.games/bigquery/docs/reference/standard-sql/pipe-syntax#where_pipe_operator"><code translate="no" dir="ltr">WHERE</code> pipe operator</a>:</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>-- Filter items with no sales.</span>
<span>FROM</span><span> </span><span>Produce</span>
<span>|</span>&gt;<span> </span><span>WHERE</span><span> </span><span>sales</span><span> &gt; </span><span>0</span><span>;</span>

<span>/*---------+-------+-----------+</span>
<span> | item    | sales | category  |</span>
<span> +---------+-------+-----------+</span>
<span> | apples  | 7     | fruit     |</span>
<span> | apples  | 2     | fruit     |</span>
<span> | bananas | 15    | fruit     |</span>
<span> +---------+-------+-----------*/</span>
</code></pre></devsite-code>
<p>To perform aggregation, use the <a href="https://eieio.games/bigquery/docs/reference/standard-sql/pipe-syntax#aggregate_pipe_operator"><code translate="no" dir="ltr">AGGREGATE</code> pipe
operator</a>, followed by any number of aggregate
functions, followed by a <code translate="no" dir="ltr">GROUP BY</code> clause. The <code translate="no" dir="ltr">GROUP BY</code> clause is part of the
<code translate="no" dir="ltr">AGGREGATE</code> pipe operator and isn&#39;t separated by a pipe symbol (<code translate="no" dir="ltr">|&gt;</code>).</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>-- Compute total sales by item.</span>
<span>FROM</span><span> </span><span>Produce</span>
<span>|</span>&gt;<span> </span><span>WHERE</span><span> </span><span>sales</span><span> &gt; </span><span>0</span>
<span>|</span>&gt;<span> </span><span>AGGREGATE</span><span> </span><span>SUM</span><span>(</span><span>sales</span><span>)</span><span> </span><span>AS</span><span> </span><span>total_sales</span><span>,</span><span> </span><span>COUNT</span><span>(</span><span>*</span><span>)</span><span> </span><span>AS</span><span> </span><span>num_sales</span>
<span>   </span><span>GROUP</span><span> </span><span>BY</span><span> </span><span>item</span><span>;</span>

<span>/*---------+-------------+-----------+</span>
<span> | item    | total_sales | num_sales |</span>
<span> +---------+-------------+-----------+</span>
<span> | apples  | 9           | 2         |</span>
<span> | bananas | 15          | 1         |</span>
<span> +---------+-------------+-----------*/</span>
</code></pre></devsite-code>
<p>Now suppose you have the following table that contains an ID for each item:</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>CREATE</span><span> </span><span>OR</span><span> </span><span>REPLACE</span><span> </span><span>TABLE</span><span> </span><span>ItemData</span><span> </span><span>AS</span><span> </span><span>(</span>
<span>  </span><span>SELECT</span><span> </span><span>&#39;apples&#39;</span><span> </span><span>AS</span><span> </span><span>item</span><span>,</span><span> </span><span>&#39;123&#39;</span><span> </span><span>AS</span><span> </span><span>id</span>
<span>  </span><span>UNION</span><span> </span><span>ALL</span>
<span>  </span><span>SELECT</span><span> </span><span>&#39;bananas&#39;</span><span> </span><span>AS</span><span> </span><span>item</span><span>,</span><span> </span><span>&#39;456&#39;</span><span> </span><span>AS</span><span> </span><span>id</span>
<span>  </span><span>UNION</span><span> </span><span>ALL</span>
<span>  </span><span>SELECT</span><span> </span><span>&#39;carrots&#39;</span><span> </span><span>AS</span><span> </span><span>item</span><span>,</span><span> </span><span>&#39;789&#39;</span><span> </span><span>AS</span><span> </span><span>id</span>
<span>);</span>
</code></pre></devsite-code>
<p>You can use the <a href="https://eieio.games/bigquery/docs/reference/standard-sql/pipe-syntax#join_pipe_operator"><code translate="no" dir="ltr">JOIN</code> pipe operator</a> to join the results
of the previous query with this table to include each item&#39;s ID:</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>FROM</span><span> </span><span>Produce</span>
<span>|</span>&gt;<span> </span><span>WHERE</span><span> </span><span>sales</span><span> &gt; </span><span>0</span>
<span>|</span>&gt;<span> </span><span>AGGREGATE</span><span> </span><span>SUM</span><span>(</span><span>sales</span><span>)</span><span> </span><span>AS</span><span> </span><span>total_sales</span><span>,</span><span> </span><span>COUNT</span><span>(</span><span>*</span><span>)</span><span> </span><span>AS</span><span> </span><span>num_sales</span>
<span>   </span><span>GROUP</span><span> </span><span>BY</span><span> </span><span>item</span>
<span>|</span>&gt;<span> </span><span>JOIN</span><span> </span><span>ItemData</span><span> </span><span>USING</span><span>(</span><span>item</span><span>);</span>

<span>/*---------+-------------+-----------+-----+</span>
<span> | item    | total_sales | num_sales | id  |</span>
<span> +---------+-------------+-----------+-----+</span>
<span> | apples  | 9           | 2         | 123 |</span>
<span> | bananas | 15          | 1         | 456 |</span>
<span> +---------+-------------+-----------+-----*/</span>
</code></pre></devsite-code>
<h2 id="key_differences_from_standard_syntax" data-text="Key differences from standard syntax" tabindex="-1">Key differences from standard syntax</h2>

<p>Pipe syntax differs from standard syntax in the following ways:</p>

<ul>
<li>Queries can <a href="https://eieio.games/bigquery/docs/reference/standard-sql/pipe-syntax#from_queries">start with a <code translate="no" dir="ltr">FROM</code> clause</a>.</li>
<li>The <code translate="no" dir="ltr">SELECT</code> pipe operator doesn&#39;t perform aggregation. You must use the
<a href="https://eieio.games/bigquery/docs/reference/standard-sql/pipe-syntax#aggregate_pipe_operator"><code translate="no" dir="ltr">AGGREGATE</code> pipe operator</a> instead.</li>
<li>Filtering is always done with the <a href="https://eieio.games/bigquery/docs/reference/standard-sql/pipe-syntax#where_pipe_operator"><code translate="no" dir="ltr">WHERE</code> pipe
operator</a>, which can be applied anywhere. The <code translate="no" dir="ltr">WHERE</code>
pipe operator, which replaces <code translate="no" dir="ltr">HAVING</code> and
<code translate="no" dir="ltr">QUALIFY</code>, can filter the results of aggregation
 or window functions.</li>
</ul>

<p>For more details, see the complete list of <a href="https://eieio.games/bigquery/docs/reference/standard-sql/pipe-syntax#pipe_operators">pipe operators</a>.</p>

<h2 id="use_cases" data-text="Use cases" tabindex="-1">Use cases</h2>

<p>Common use cases for pipe syntax include the following:</p>

<ul>
<li><strong>Ad-hoc analysis and incremental query building</strong>:
The logical order of operations
makes it easier to write and debug queries. The prefix of any
query up to a pipe symbol <code translate="no" dir="ltr">|&gt;</code> is a valid query, which helps you view
intermediate results in a long query. The productivity gains can
speed up the development process across your organization.</li>
<li><strong>Log analytics</strong>: There exist other types of pipe-like syntax that are
popular among log analytics users. Pipe syntax provides a familiar structure
that simplifies onboarding for those users to
<a href="https://eieio.games/logging/docs/log-analytics#analytics"></a> and
.</li>
</ul>

<h2 id="additional_features_in_pipe_syntax" data-text="Additional features in pipe syntax" tabindex="-1">Additional features in pipe syntax</h2>

<p>With few exceptions, pipe syntax supports all operators that standard syntax
does with the same syntax. In addition, pipe syntax introduces the following
pipe operators.</p>

<h3 id="extend-pipe-operator" data-text="EXTEND pipe operator" tabindex="-1"><code translate="no" dir="ltr">EXTEND</code> pipe operator</h3>

<p>The <a href="https://eieio.games/bigquery/docs/reference/standard-sql/pipe-syntax#extend_pipe_operator"><code translate="no" dir="ltr">EXTEND</code> pipe operator</a> lets you append computed
columns to the current table. The <code translate="no" dir="ltr">EXTEND</code> pipe operator is similar to the
<code translate="no" dir="ltr">SELECT *, new_column</code> statement, but it gives you more flexibility in
referencing column aliases.</p>

<p>Consider the following table that contains two test scores for each person:</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>CREATE</span><span> </span><span>OR</span><span> </span><span>REPLACE</span><span> </span><span>TABLE</span><span> </span><span>Scores</span><span> </span><span>AS</span><span> </span><span>(</span>
<span>  </span><span>SELECT</span><span> </span><span>&#39;Alex&#39;</span><span> </span><span>AS</span><span> </span><span>student</span><span>,</span><span> </span><span>9</span><span> </span><span>AS</span><span> </span><span>score1</span><span>,</span><span> </span><span>10</span><span> </span><span>AS</span><span> </span><span>score2</span><span>,</span><span> </span><span>10</span><span> </span><span>AS</span><span> </span><span>points_possible</span>
<span>  </span><span>UNION</span><span> </span><span>ALL</span>
<span>  </span><span>SELECT</span><span> </span><span>&#39;Dana&#39;</span><span> </span><span>AS</span><span> </span><span>student</span><span>,</span><span> </span><span>5</span><span> </span><span>AS</span><span> </span><span>score1</span><span>,</span><span> </span><span>7</span><span> </span><span>AS</span><span> </span><span>score2</span><span>,</span><span> </span><span>10</span><span> </span><span>AS</span><span> </span><span>points_possible</span><span>);</span>

<span>/*---------+--------+--------+-----------------+</span>
<span> | student | score1 | score2 | points_possible |</span>
<span> +---------+--------+--------+-----------------+</span>
<span> | Alex    | 9      | 10     | 10              |</span>
<span> | Dana    | 5      | 7      | 10              |</span>
<span> +---------+--------+--------+-----------------*/</span>
</code></pre></devsite-code>
<p>Suppose you want to compute the average raw score and average percentage score
that each student received on the test. In standard syntax, later columns in
a <code translate="no" dir="ltr">SELECT</code> statement don&#39;t have visibility to earlier aliases. To avoid a
subquery, you have to repeat the expression for the average:</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>SELECT</span><span> </span><span>student</span><span>,</span>
<span>  </span><span>(</span><span>score1</span><span> </span><span>+</span><span> </span><span>score2</span><span>)</span><span> </span><span>/</span><span> </span><span>2</span><span> </span><span>AS</span><span> </span><span>average_score</span><span>,</span>
<span>  </span><span>(</span><span>score1</span><span> </span><span>+</span><span> </span><span>score2</span><span>)</span><span> </span><span>/</span><span> </span><span>2</span><span> </span><span>/</span><span> </span><span>points_possible</span><span> </span><span>AS</span><span> </span><span>average_percent</span>
<span>FROM</span><span> </span><span>Scores</span><span>;</span>
</code></pre></devsite-code>
<p>The <code translate="no" dir="ltr">EXTEND</code> pipe operator can reference previously used aliases, making the
query easier to read and less error prone:</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>FROM</span><span> </span><span>Scores</span>
<span>|</span>&gt;<span> </span><span>EXTEND</span><span> </span><span>(</span><span>score1</span><span> </span><span>+</span><span> </span><span>score2</span><span>)</span><span> </span><span>/</span><span> </span><span>2</span><span> </span><span>AS</span><span> </span><span>average_score</span>
<span>|</span>&gt;<span> </span><span>EXTEND</span><span> </span><span>average_score</span><span> </span><span>/</span><span> </span><span>points_possible</span><span> </span><span>AS</span><span> </span><span>average_percent</span>
<span>|</span>&gt;<span> </span><span>SELECT</span><span> </span><span>student</span><span>,</span><span> </span><span>average_score</span><span>,</span><span> </span><span>average_percent</span><span>;</span>

<span>/*---------+---------------+-----------------+</span>
<span> | student | average_score | average_percent |</span>
<span> +---------+---------------+-----------------+</span>
<span> | Alex    | 9.5           | .95             |</span>
<span> | Dana    | 6.0           | 0.6             |</span>
<span> +---------+---------------+-----------------*/</span>
</code></pre></devsite-code>
<h3 id="set-pipe-operator" data-text="SET pipe operator" tabindex="-1"><code translate="no" dir="ltr">SET</code> pipe operator</h3>

<p>The <a href="https://eieio.games/bigquery/docs/reference/standard-sql/pipe-syntax#set_pipe_operator"><code translate="no" dir="ltr">SET</code> pipe operator</a> lets you replace the value of
columns in the current table. The <code translate="no" dir="ltr">SET</code> pipe operator is similar to the <code translate="no" dir="ltr">SELECT
* REPLACE (expression AS column)</code> statement. You can reference the original
value by qualifying the column name with a table alias.</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>FROM</span><span> </span><span>(</span><span>SELECT</span><span> </span><span>3</span><span> </span><span>AS</span><span> </span><span>x</span><span>,</span><span> </span><span>5</span><span> </span><span>AS</span><span> </span><span>y</span><span>)</span>
<span>|</span>&gt;<span> </span><span>SET</span><span> </span><span>x</span><span> </span><span>=</span><span> </span><span>2</span><span> </span><span>*</span><span> </span><span>x</span><span>;</span>

<span>/*---+---+</span>
<span> | x | y |</span>
<span> +---+---+</span>
<span> | 6 | 5 |</span>
<span> +---+---*/</span>
</code></pre></devsite-code>
<h3 id="drop-pipe-operator" data-text="DROP pipe operator" tabindex="-1"><code translate="no" dir="ltr">DROP</code> pipe operator</h3>

<p>The <a href="https://eieio.games/bigquery/docs/reference/standard-sql/pipe-syntax#drop_pipe_operator"><code translate="no" dir="ltr">DROP</code> pipe operator</a> lets you remove columns from the
current table. The <code translate="no" dir="ltr">DROP</code> pipe operator is similar to the <code translate="no" dir="ltr">SELECT *
EXCEPT(column)</code> statement. After a column is dropped you can still reference the
original value by qualifying the column name with a table alias.</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>FROM</span><span> </span><span>(</span><span>SELECT</span><span> </span><span>1</span><span> </span><span>AS</span><span> </span><span>x</span><span>,</span><span> </span><span>2</span><span> </span><span>AS</span><span> </span><span>y</span><span>)</span><span> </span><span>AS</span><span> </span><span>t</span>
<span>|</span>&gt;<span> </span><span>DROP</span><span> </span><span>x</span><span>;</span>

<span>/*---+</span>
<span> | y |</span>
<span> +---+</span>
<span> | 2 |</span>
<span> +---*/</span>
</code></pre></devsite-code>
<h3 id="rename-pipe-operator" data-text="RENAME pipe operator" tabindex="-1"><code translate="no" dir="ltr">RENAME</code> pipe operator</h3>

<p>The <a href="https://eieio.games/bigquery/docs/reference/standard-sql/pipe-syntax#rename_pipe_operator"><code translate="no" dir="ltr">RENAME</code> pipe operator</a> lets you rename columns from
the current table. The <code translate="no" dir="ltr">RENAME</code> pipe operator is similar to the <code translate="no" dir="ltr">SELECT *
EXCEPT(old_column), old_column AS new_column</code> statement.</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>FROM</span><span> </span><span>(</span><span>SELECT</span><span> </span><span>1</span><span> </span><span>AS</span><span> </span><span>x</span><span>,</span><span> </span><span>2</span><span> </span><span>AS</span><span> </span><span>y</span><span>,</span><span> </span><span>3</span><span> </span><span>AS</span><span> </span><span>z</span><span>)</span><span> </span><span>AS</span><span> </span><span>t</span>
<span>|</span>&gt;<span> </span><span>RENAME</span><span> </span><span>y</span><span> </span><span>AS</span><span> </span><span>w</span><span>;</span>

<span>/*---+---+---+</span>
<span> | x | w | z |</span>
<span> +---+---+---+</span>
<span> | 1 | 2 | 3 |</span>
<span> +---+---+---*/</span>
</code></pre></devsite-code>
<h3 id="aggregate-pipe-operator" data-text="AGGREGATE pipe operator" tabindex="-1"><code translate="no" dir="ltr">AGGREGATE</code> pipe operator</h3>

<p>To perform aggregation in pipe syntax, use the <a href="https://eieio.games/bigquery/docs/reference/standard-sql/pipe-syntax#aggregate_pipe_operator"><code translate="no" dir="ltr">AGGREGATE</code> pipe
operator</a>, followed by any number of aggregate
functions, followed by a <code translate="no" dir="ltr">GROUP BY</code> clause. You don&#39;t need to repeat columns in
a <code translate="no" dir="ltr">SELECT</code> clause.</p>

<p>The examples in this section use the <code translate="no" dir="ltr">Produce</code> table:</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>CREATE</span><span> </span><span>OR</span><span> </span><span>REPLACE</span><span> </span><span>TABLE</span><span> </span><span>Produce</span><span> </span><span>AS</span><span> </span><span>(</span>
<span>  </span><span>SELECT</span><span> </span><span>&#39;apples&#39;</span><span> </span><span>AS</span><span> </span><span>item</span><span>,</span><span> </span><span>2</span><span> </span><span>AS</span><span> </span><span>sales</span><span>,</span><span> </span><span>&#39;fruit&#39;</span><span> </span><span>AS</span><span> </span><span>category</span>
<span>  </span><span>UNION</span><span> </span><span>ALL</span>
<span>  </span><span>SELECT</span><span> </span><span>&#39;apples&#39;</span><span> </span><span>AS</span><span> </span><span>item</span><span>,</span><span> </span><span>7</span><span> </span><span>AS</span><span> </span><span>sales</span><span>,</span><span> </span><span>&#39;fruit&#39;</span><span> </span><span>AS</span><span> </span><span>category</span>
<span>  </span><span>UNION</span><span> </span><span>ALL</span>
<span>  </span><span>SELECT</span><span> </span><span>&#39;carrots&#39;</span><span> </span><span>AS</span><span> </span><span>item</span><span>,</span><span> </span><span>0</span><span> </span><span>AS</span><span> </span><span>sales</span><span>,</span><span> </span><span>&#39;vegetable&#39;</span><span> </span><span>AS</span><span> </span><span>category</span>
<span>  </span><span>UNION</span><span> </span><span>ALL</span>
<span>  </span><span>SELECT</span><span> </span><span>&#39;bananas&#39;</span><span> </span><span>AS</span><span> </span><span>item</span><span>,</span><span> </span><span>15</span><span> </span><span>AS</span><span> </span><span>sales</span><span>,</span><span> </span><span>&#39;fruit&#39;</span><span> </span><span>AS</span><span> </span><span>category</span><span>);</span>

<span>/*---------+-------+-----------+</span>
<span> | item    | sales | category  |</span>
<span> +---------+-------+-----------+</span>
<span> | apples  | 7     | fruit     |</span>
<span> | apples  | 2     | fruit     |</span>
<span> | carrots | 0     | vegetable |</span>
<span> | bananas | 15    | fruit     |</span>
<span> +---------+-------+-----------*/</span>
</code></pre></devsite-code><devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>FROM</span><span> </span><span>Produce</span>
<span>|</span>&gt;<span> </span><span>AGGREGATE</span><span> </span><span>SUM</span><span>(</span><span>sales</span><span>)</span><span> </span><span>AS</span><span> </span><span>total</span><span>,</span><span> </span><span>COUNT</span><span>(</span><span>*</span><span>)</span><span> </span><span>AS</span><span> </span><span>num_records</span>
<span>   </span><span>GROUP</span><span> </span><span>BY</span><span> </span><span>item</span><span>,</span><span> </span><span>category</span><span>;</span>

<span>/*---------+-----------+-------+-------------+</span>
<span> | item    | category  | total | num_records |</span>
<span> +---------+-----------+-------+-------------+</span>
<span> | apples  | fruit     | 9     | 2           |</span>
<span> | carrots | vegetable | 0     | 1           |</span>
<span> | bananas | fruit     | 15    | 1           |</span>
<span> +---------+-----------+-------+-------------*/</span>
</code></pre></devsite-code>
<p>If you are ready to order your results immediately following aggregation, you
can mark the columns in the <code translate="no" dir="ltr">GROUP BY</code> clause that you want to order with
<code translate="no" dir="ltr">ASC</code> or <code translate="no" dir="ltr">DESC</code>. Unmarked columns aren&#39;t ordered.</p>

<p>If you want to order all columns, then you can replace the <code translate="no" dir="ltr">GROUP BY</code> clause
with a <a href="https://eieio.games/bigquery/docs/reference/standard-sql/pipe-syntax#shorthand_order_pipe_syntax"><code translate="no" dir="ltr">GROUP AND ORDER BY</code> clause</a>, which orders
every column in ascending order by default. You can specify <code translate="no" dir="ltr">DESC</code> following the
columns that you want to order in descending order. For example, the following
three queries are equivalent:</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>-- Use a separate ORDER BY clause.</span>
<span>FROM</span><span> </span><span>Produce</span>
<span>|</span>&gt;<span> </span><span>AGGREGATE</span><span> </span><span>SUM</span><span>(</span><span>sales</span><span>)</span><span> </span><span>AS</span><span> </span><span>total</span><span>,</span><span> </span><span>COUNT</span><span>(</span><span>*</span><span>)</span><span> </span><span>AS</span><span> </span><span>num_records</span>
<span>   </span><span>GROUP</span><span> </span><span>BY</span><span> </span><span>category</span><span>,</span><span> </span><span>item</span>
<span>|</span>&gt;<span> </span><span>ORDER</span><span> </span><span>BY</span><span> </span><span>category</span><span> </span><span>DESC</span><span>,</span><span> </span><span>item</span><span>;</span>
</code></pre></devsite-code><devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>-- Explicitly mark how to order columns in the GROUP BY clause.</span>
<span>FROM</span><span> </span><span>Produce</span>
<span>|</span>&gt;<span> </span><span>AGGREGATE</span><span> </span><span>SUM</span><span>(</span><span>sales</span><span>)</span><span> </span><span>AS</span><span> </span><span>total</span><span>,</span><span> </span><span>COUNT</span><span>(</span><span>*</span><span>)</span><span> </span><span>AS</span><span> </span><span>num_records</span>
<span>   </span><span>GROUP</span><span> </span><span>BY</span><span> </span><span>category</span><span> </span><span>DESC</span><span>,</span><span> </span><span>item</span><span> </span><span>ASC</span><span>;</span>
</code></pre></devsite-code><devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>-- Only mark descending columns in the GROUP AND ORDER BY clause.</span>
<span>FROM</span><span> </span><span>Produce</span>
<span>|</span>&gt;<span> </span><span>AGGREGATE</span><span> </span><span>SUM</span><span>(</span><span>sales</span><span>)</span><span> </span><span>AS</span><span> </span><span>total</span><span>,</span><span> </span><span>COUNT</span><span>(</span><span>*</span><span>)</span><span> </span><span>AS</span><span> </span><span>num_records</span>
<span>   </span><span>GROUP</span><span> </span><span>AND</span><span> </span><span>ORDER</span><span> </span><span>BY</span><span> </span><span>category</span><span> </span><span>DESC</span><span>,</span><span> </span><span>item</span><span>;</span>
</code></pre></devsite-code>
<p>The advantage of using a <code translate="no" dir="ltr">GROUP AND ORDER BY</code> clause is that you don&#39;t have to
repeat column names in two places.</p>

<p>To perform full table aggregation, use <code translate="no" dir="ltr">GROUP BY()</code> or omit the <code translate="no" dir="ltr">GROUP BY</code>
clause entirely:</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>FROM</span><span> </span><span>Produce</span>
<span>|</span>&gt;<span> </span><span>AGGREGATE</span><span> </span><span>SUM</span><span>(</span><span>sales</span><span>)</span><span> </span><span>AS</span><span> </span><span>total</span><span>,</span><span> </span><span>COUNT</span><span>(</span><span>*</span><span>)</span><span> </span><span>AS</span><span> </span><span>num_records</span><span>;</span>

<span>/*-------+-------------+</span>
<span> | total | num_records |</span>
<span> +-------+-------------+</span>
<span> | 24    | 4           |</span>
<span> +-------+-------------*/</span>
</code></pre></devsite-code>
<h3 id="join-pipe-operator" data-text="JOIN pipe operator" tabindex="-1"><code translate="no" dir="ltr">JOIN</code> pipe operator</h3>

<p>The <a href="https://eieio.games/bigquery/docs/reference/standard-sql/pipe-syntax#join_pipe_operator"><code translate="no" dir="ltr">JOIN</code> pipe operator</a> lets you join the current table
with another table and supports the standard <a href="https://eieio.games/bigquery/docs/reference/standard-sql/query-syntax#join_types">join operations</a>,
including <code translate="no" dir="ltr">CROSS</code>, <code translate="no" dir="ltr">INNER</code>, <code translate="no" dir="ltr">LEFT</code>, <code translate="no" dir="ltr">RIGHT</code>, and <code translate="no" dir="ltr">FULL</code>.</p>

<p>The following examples reference the <code translate="no" dir="ltr">Produce</code> and <code translate="no" dir="ltr">ItemData</code> tables:</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>CREATE</span><span> </span><span>OR</span><span> </span><span>REPLACE</span><span> </span><span>TABLE</span><span> </span><span>Produce</span><span> </span><span>AS</span><span> </span><span>(</span>
<span>  </span><span>SELECT</span><span> </span><span>&#39;apples&#39;</span><span> </span><span>AS</span><span> </span><span>item</span><span>,</span><span> </span><span>2</span><span> </span><span>AS</span><span> </span><span>sales</span><span>,</span><span> </span><span>&#39;fruit&#39;</span><span> </span><span>AS</span><span> </span><span>category</span>
<span>  </span><span>UNION</span><span> </span><span>ALL</span>
<span>  </span><span>SELECT</span><span> </span><span>&#39;apples&#39;</span><span> </span><span>AS</span><span> </span><span>item</span><span>,</span><span> </span><span>7</span><span> </span><span>AS</span><span> </span><span>sales</span><span>,</span><span> </span><span>&#39;fruit&#39;</span><span> </span><span>AS</span><span> </span><span>category</span>
<span>  </span><span>UNION</span><span> </span><span>ALL</span>
<span>  </span><span>SELECT</span><span> </span><span>&#39;carrots&#39;</span><span> </span><span>AS</span><span> </span><span>item</span><span>,</span><span> </span><span>0</span><span> </span><span>AS</span><span> </span><span>sales</span><span>,</span><span> </span><span>&#39;vegetable&#39;</span><span> </span><span>AS</span><span> </span><span>category</span>
<span>  </span><span>UNION</span><span> </span><span>ALL</span>
<span>  </span><span>SELECT</span><span> </span><span>&#39;bananas&#39;</span><span> </span><span>AS</span><span> </span><span>item</span><span>,</span><span> </span><span>15</span><span> </span><span>AS</span><span> </span><span>sales</span><span>,</span><span> </span><span>&#39;fruit&#39;</span><span> </span><span>AS</span><span> </span><span>category</span><span>);</span>
</code></pre></devsite-code><devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>CREATE</span><span> </span><span>OR</span><span> </span><span>REPLACE</span><span> </span><span>TABLE</span><span> </span><span>ItemData</span><span> </span><span>AS</span><span> </span><span>(</span>
<span>  </span><span>SELECT</span><span> </span><span>&#39;apples&#39;</span><span> </span><span>AS</span><span> </span><span>item</span><span>,</span><span> </span><span>&#39;123&#39;</span><span> </span><span>AS</span><span> </span><span>id</span>
<span>  </span><span>UNION</span><span> </span><span>ALL</span>
<span>  </span><span>SELECT</span><span> </span><span>&#39;bananas&#39;</span><span> </span><span>AS</span><span> </span><span>item</span><span>,</span><span> </span><span>&#39;456&#39;</span><span> </span><span>AS</span><span> </span><span>id</span>
<span>  </span><span>UNION</span><span> </span><span>ALL</span>
<span>  </span><span>SELECT</span><span> </span><span>&#39;carrots&#39;</span><span> </span><span>AS</span><span> </span><span>item</span><span>,</span><span> </span><span>&#39;789&#39;</span><span> </span><span>AS</span><span> </span><span>id</span>
<span>);</span>
</code></pre></devsite-code>
<p>The following example uses a <code translate="no" dir="ltr">USING</code> clause and avoids column ambiguity:</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>FROM</span><span> </span><span>Produce</span>
<span>|</span>&gt;<span> </span><span>JOIN</span><span> </span><span>`ItemData`</span><span> </span><span>USING</span><span>(</span><span>item</span><span>)</span>
<span>|</span>&gt;<span> </span><span>WHERE</span><span> </span><span>item</span><span> </span><span>=</span><span> </span><span>&#39;apples&#39;</span><span>;</span>

<span>/*--------+-------+----------+-----+</span>
<span> | item   | sales | category | id  |</span>
<span> +--------+-------+----------+-----+</span>
<span> | apples | 2     | fruit    | 123 |</span>
<span> | apples | 7     | fruit    | 123 |</span>
<span> +--------+-------+----------+-----*/</span>
</code></pre></devsite-code>
<p>To reference columns in the current table, such as to disambiguate columns in an
<code translate="no" dir="ltr">ON</code> clause, you need to alias the current table by using the <a href="https://eieio.games/bigquery/docs/reference/standard-sql/pipe-syntax#as_pipe_operator"><code translate="no" dir="ltr">AS</code> pipe
operator</a>. You can optionally alias the joined table. You can
reference both aliases following subsequent pipe operators:</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>FROM</span><span> </span><span>Produce</span>
<span>|</span>&gt;<span> </span><span>AS</span><span> </span><span>produce_table</span>
<span>|</span>&gt;<span> </span><span>JOIN</span><span> </span><span>`ItemData`</span><span> </span><span>AS</span><span> </span><span>item_table</span>
<span>   </span><span>ON</span><span> </span><span>produce_table</span><span>.</span><span>item</span><span> </span><span>=</span><span> </span><span>item_table</span><span>.</span><span>item</span>
<span>|</span>&gt;<span> </span><span>WHERE</span><span> </span><span>produce_table</span><span>.</span><span>item</span><span> </span><span>=</span><span> </span><span>&#39;bananas&#39;</span>
<span>|</span>&gt;<span> </span><span>SELECT</span><span> </span><span>item_table</span><span>.</span><span>item</span><span>,</span><span> </span><span>sales</span><span>,</span><span> </span><span>id</span><span>;</span>

<span>/*---------+-------+-----+</span>
<span> | item    | sales | id  |</span>
<span> +---------+-------+-----+</span>
<span> | bananas | 15    | 123 |</span>
<span> +---------+-------+-----*/</span>
</code></pre></devsite-code>
<p>The right-hand side of the join doesn&#39;t have visibility to the left-hand side
of the join, which means you can&#39;t join the current table with itself. For
example, the following query fails:</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>-- This query doesn&#39;t work.</span>
<span>FROM</span><span> </span><span>Produce</span>
<span>|</span>&gt;<span> </span><span>AS</span><span> </span><span>produce_table</span>
<span>|</span>&gt;<span> </span><span>JOIN</span><span> </span><span>produce_table</span><span> </span><span>AS</span><span> </span><span>produce_table_2</span><span> </span><span>USING</span><span>(</span><span>item</span><span>);</span>
</code></pre></devsite-code>
<p>To perform a self-join with a modified table, you can use a common table
expression (CTE) inside of a <code translate="no" dir="ltr">WITH</code> clause.</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>WITH</span><span> </span><span>cte_table</span><span> </span><span>AS</span><span> </span><span>(</span>
<span>  </span><span>FROM</span><span> </span><span>Produce</span>
<span>  </span><span>|</span>&gt;<span> </span><span>WHERE</span><span> </span><span>item</span><span> </span><span>=</span><span> </span><span>&#39;carrots&#39;</span>
<span>)</span>
<span>FROM</span><span> </span><span>cte_table</span>
<span>|</span>&gt;<span> </span><span>JOIN</span><span> </span><span>cte_table</span><span> </span><span>AS</span><span> </span><span>cte_table_2</span><span> </span><span>USING</span><span>(</span><span>item</span><span>);</span>
</code></pre></devsite-code>
<h2 id="example" data-text="Example" tabindex="-1">Example</h2>

<p>Consider the following table with information about customer orders:</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>CREATE</span><span> </span><span>OR</span><span> </span><span>REPLACE</span><span> </span><span>TABLE</span><span> </span><span>CustomerOrders</span><span> </span><span>AS</span><span> </span><span>(</span>
<span>  </span><span>SELECT</span><span> </span><span>1</span><span> </span><span>AS</span><span> </span><span>customer_id</span><span>,</span><span> </span><span>100</span><span> </span><span>AS</span><span> </span><span>order_id</span><span>,</span><span> </span><span>&#39;WA&#39;</span><span> </span><span>AS</span><span> </span><span>state</span><span>,</span><span> </span><span>5</span><span> </span><span>AS</span><span> </span><span>cost</span><span>,</span><span> </span><span>&#39;clothing&#39;</span><span> </span><span>AS</span><span> </span><span>item_type</span>
<span>  </span><span>UNION</span><span> </span><span>ALL</span>
<span>  </span><span>SELECT</span><span> </span><span>1</span><span> </span><span>AS</span><span> </span><span>customer_id</span><span>,</span><span> </span><span>101</span><span> </span><span>AS</span><span> </span><span>order_id</span><span>,</span><span> </span><span>&#39;WA&#39;</span><span> </span><span>AS</span><span> </span><span>state</span><span>,</span><span> </span><span>20</span><span> </span><span>AS</span><span> </span><span>cost</span><span>,</span><span> </span><span>&#39;clothing&#39;</span><span> </span><span>AS</span><span> </span><span>item_type</span>
<span>  </span><span>UNION</span><span> </span><span>ALL</span>
<span>  </span><span>SELECT</span><span> </span><span>1</span><span> </span><span>AS</span><span> </span><span>customer_id</span><span>,</span><span> </span><span>102</span><span> </span><span>AS</span><span> </span><span>order_id</span><span>,</span><span> </span><span>&#39;WA&#39;</span><span> </span><span>AS</span><span> </span><span>state</span><span>,</span><span> </span><span>3</span><span> </span><span>AS</span><span> </span><span>cost</span><span>,</span><span> </span><span>&#39;food&#39;</span><span> </span><span>AS</span><span> </span><span>item_type</span>
<span>  </span><span>UNION</span><span> </span><span>ALL</span>
<span>  </span><span>SELECT</span><span> </span><span>2</span><span> </span><span>AS</span><span> </span><span>customer_id</span><span>,</span><span> </span><span>103</span><span> </span><span>AS</span><span> </span><span>order_id</span><span>,</span><span> </span><span>&#39;NY&#39;</span><span> </span><span>AS</span><span> </span><span>state</span><span>,</span><span> </span><span>16</span><span> </span><span>AS</span><span> </span><span>cost</span><span>,</span><span> </span><span>&#39;clothing&#39;</span><span> </span><span>AS</span><span> </span><span>item_type</span>
<span>  </span><span>UNION</span><span> </span><span>ALL</span>
<span>  </span><span>SELECT</span><span> </span><span>2</span><span> </span><span>AS</span><span> </span><span>customer_id</span><span>,</span><span> </span><span>104</span><span> </span><span>AS</span><span> </span><span>order_id</span><span>,</span><span> </span><span>&#39;NY&#39;</span><span> </span><span>AS</span><span> </span><span>state</span><span>,</span><span> </span><span>22</span><span> </span><span>AS</span><span> </span><span>cost</span><span>,</span><span> </span><span>&#39;housewares&#39;</span><span> </span><span>AS</span><span> </span><span>item_type</span>
<span>  </span><span>UNION</span><span> </span><span>ALL</span>
<span>  </span><span>SELECT</span><span> </span><span>2</span><span> </span><span>AS</span><span> </span><span>customer_id</span><span>,</span><span> </span><span>104</span><span> </span><span>AS</span><span> </span><span>order_id</span><span>,</span><span> </span><span>&#39;WA&#39;</span><span> </span><span>AS</span><span> </span><span>state</span><span>,</span><span> </span><span>45</span><span> </span><span>AS</span><span> </span><span>cost</span><span>,</span><span> </span><span>&#39;clothing&#39;</span><span> </span><span>AS</span><span> </span><span>item_type</span>
<span>  </span><span>UNION</span><span> </span><span>ALL</span>
<span>  </span><span>SELECT</span><span> </span><span>3</span><span> </span><span>AS</span><span> </span><span>customer_id</span><span>,</span><span> </span><span>105</span><span> </span><span>AS</span><span> </span><span>order_id</span><span>,</span><span> </span><span>&#39;MI&#39;</span><span> </span><span>AS</span><span> </span><span>state</span><span>,</span><span> </span><span>29</span><span> </span><span>AS</span><span> </span><span>cost</span><span>,</span><span> </span><span>&#39;clothing&#39;</span><span> </span><span>AS</span><span> </span><span>item_type</span><span>);</span>
</code></pre></devsite-code>
<p>Suppose you want to know, for each state and item type, the average amount spent
by repeat customers. You could write the query in the following way:</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>SELECT</span><span> </span><span>state</span><span>,</span><span> </span><span>item_type</span><span>,</span><span> </span><span>AVG</span><span>(</span><span>total_cost</span><span>)</span><span> </span><span>AS</span><span> </span><span>average</span>
<span>FROM</span>
<span>  </span><span>(</span>
<span>    </span><span>SELECT</span>
<span>      </span><span>SUM</span><span>(</span><span>cost</span><span>)</span><span> </span><span>AS</span><span> </span><span>total_cost</span><span>,</span>
<span>      </span><span>customer_id</span><span>,</span>
<span>      </span><span>state</span><span>,</span>
<span>      </span><span>item_type</span><span>,</span>
<span>      </span><span>COUNT</span><span>(</span><span>*</span><span>)</span><span> </span><span>OVER</span><span> </span><span>(</span><span>PARTITION</span><span> </span><span>BY</span><span> </span><span>customer_id</span><span>)</span><span> </span><span>AS</span><span> </span><span>num_orders</span>
<span>    </span><span>FROM</span><span> </span><span>CustomerOrders</span>
<span>    </span><span>GROUP</span><span> </span><span>BY</span><span> </span><span>customer_id</span><span>,</span><span> </span><span>state</span><span>,</span><span> </span><span>item_type</span>
<span>    </span><span>QUALIFY</span><span> </span><span>num_orders</span><span> &gt; </span><span>1</span>
<span>  </span><span>)</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>state</span><span>,</span><span> </span><span>item_type</span>
<span>ORDER</span><span> </span><span>BY</span><span> </span><span>state</span><span> </span><span>DESC</span><span>,</span><span> </span><span>item_type</span><span> </span><span>ASC</span><span>;</span>
</code></pre></devsite-code>
<p>If you read the query from top to bottom, you encounter the column <code translate="no" dir="ltr">total_cost</code>
before it has been defined. Even within the subquery, you read the names of
columns before you see which table they come from.</p>

<p>To make sense of this query, it needs to be
read from the inside out. The columns <code translate="no" dir="ltr">state</code> and <code translate="no" dir="ltr">item_type</code> are repeated
numerous times in the <code translate="no" dir="ltr">SELECT</code> and <code translate="no" dir="ltr">GROUP BY</code> clauses, then again
in the <code translate="no" dir="ltr">ORDER BY</code> clause.</p>

<p>The following equivalent query is written using
pipe syntax:</p>
<devsite-code><pre translate="no" dir="ltr" is-upgraded="" syntax="GoogleSQL"><code translate="no" dir="ltr"><span>FROM</span><span> </span><span>CustomerOrders</span>
<span>|</span>&gt;<span> </span><span>AGGREGATE</span><span> </span><span>SUM</span><span>(</span><span>cost</span><span>)</span><span> </span><span>AS</span><span> </span><span>total_cost</span><span>,</span><span> </span><span>GROUP</span><span> </span><span>BY</span><span> </span><span>customer_id</span><span>,</span><span> </span><span>state</span><span>,</span><span> </span><span>item_type</span>
<span>|</span>&gt;<span> </span><span>EXTEND</span><span> </span><span>COUNT</span><span>(</span><span>*</span><span>)</span><span> </span><span>OVER</span><span> </span><span>(</span><span>PARTITION</span><span> </span><span>BY</span><span> </span><span>customer_id</span><span>)</span><span> </span><span>AS</span><span> </span><span>num_orders</span>
<span>|</span>&gt;<span> </span><span>WHERE</span><span> </span><span>num_orders</span><span> &gt; </span><span>1</span>
<span>|</span>&gt;<span> </span><span>AGGREGATE</span><span> </span><span>AVG</span><span>(</span><span>total_cost</span><span>)</span><span> </span><span>AS</span><span> </span><span>average</span><span> </span><span>GROUP</span><span> </span><span>BY</span><span> </span><span>state</span><span> </span><span>DESC</span><span>,</span><span> </span><span>item_type</span><span> </span><span>ASC</span><span>;</span>

<span>/*-------+------------+---------+</span>
<span> | state | item_type  | average |</span>
<span> +-------+------------+---------+</span>
<span> | WA    | clothing   | 35.0    |</span>
<span> | WA    | food       | 3.0     |</span>
<span> | NY    | clothing   | 16.0    |</span>
<span> | NY    | housewares | 22.0    |</span>
<span> +-------+------------+---------*/</span>
</code></pre></devsite-code>
<p>With pipe syntax, you can write the query to follow the logical steps you might
think through to solve the original problem. The lines of syntax in the query
correspond to the following logical steps:</p>

<ul>
<li>Start with the table of customer orders.</li>
<li>Find out how much each customer spent on each type of item by state.</li>
<li>Count the number of orders for each customer.</li>
<li>Restrict the results to repeat customers.</li>
<li>Find the average amount that repeat customers spend for each state and
item type.</li>
</ul>

<h2 id="limitations" data-text="Limitations" tabindex="-1">Limitations</h2>

<ul>
<li>You can&#39;t include a <a href="https://eieio.games/bigquery/docs/reference/standard-sql/query-syntax#dp_clause">differential privacy clause</a> in a <code translate="no" dir="ltr">SELECT</code>
statement following a pipe operator. Instead, use a differential privacy
clause in standard syntax and apply pipe operators following the query.</li>
<li>You can&#39;t use a <a href="https://eieio.games/bigquery/docs/reference/standard-sql/window-function-calls#ref_named_window">named window</a> in pipe syntax.</li>
</ul>



<ul>
<li><a href="https://eieio.games/bigquery/docs/reference/standard-sql/pipe-syntax#pipe_query_syntax">Pipe query syntax reference</a></li>
<li><a href="https://eieio.games/bigquery/docs/reference/standard-sql/query-syntax">Standard query syntax reference</a></li>
<li><a href="https://research.google/pubs/sql-has-problems-we-can-fix-them-pipe-syntax-in-sql/">VLDB 2024</a> conference paper on pipe syntax</li>
</ul>

<!-- mdlint off(WHITESPACE_LINE_LENGTH) -->

<!-- mdlint on -->
  

  
    <devsite-hats-survey hats-id="Nd7nTix2o0eU5NUYprb0ThtUc5jf" listnr-id="83405"></devsite-hats-survey>
  

  
</div></div>
  </body>
</html>
