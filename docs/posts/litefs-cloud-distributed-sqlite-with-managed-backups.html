<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://fly.io/blog/litefs-cloud/">Original</a>
    <h1>LiteFS Cloud: Distributed SQLite with Managed Backups</h1>
    
    <div id="readability-page-1" class="page"><article> <dl> <dt>Author</dt> <dd> <img src="https://fly.io/static/images/darla.webp" alt="Darla Magdalene Shockley" srcset=""/> <dl> <dt>Name</dt> <dd> Darla Magdalene Shockley </dd> <dt>Social Media</dt> <dd> </dd> </dl> </dd> <dt>Author</dt> <dd> <img src="https://fly.io/static/images/ben.webp" alt="Ben Johnson" srcset=""/> <dl> <dt>Name</dt> <dd> Ben Johnson </dd> <dt>Social Media</dt> <dd> <a href="https://twitter.com/benbjohnson" target="_blank" rel="noopener noreferrer"> <span aria-hidden="true">@benbjohnson</span> <span>View Twitter Profile</span> </a> </dd> </dl> </dd> </dl> <section> <figure> <img src="https://fly.io/blog/2023-07-05/litefs-cloud-cover.webp" alt="Cartoon clouds floating in the air."/> <figcaption> <span>Image by</span> <svg role="img" style="pointer-events: none; width: 17px; height: 17px;" viewBox="0 0 20 20" fill="currentColor" fill-rule="evenodd"> <g buffered-rendering="static"> <path fill-rule="evenodd" d="M1 8a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 018.07 3h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0016.07 6H17a2 2 0 012 2v7a2 2 0 01-2 2H3a2 2 0 01-2-2V8zm13.5 3a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM10 14a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path> </g> </svg> <a href="https://annieruygtillustration.com/" target="_blank"> Annie Ruygt </a> </figcaption> </figure> <p> With Fly.io, <a href="https://fly.io/docs/speedrun/">you can get your app running globally in a matter of minutes</a>, and with LiteFS, you can run SQLite alongside your app! Now we&#39;re introducing LiteFS Cloud: managed backups and point-in-time restores for LiteFS—whether your app is running on Fly.io or anywhere else. <a href="https://fly.io/docs/litefs/speedrun/">Try it out for yourself</a>!</p><p>We love <a href="https://fly.io/blog/all-in-on-sqlite-litestream/">SQLite in production</a>, and we&#39;re all about running apps close to users. That&#39;s why we created LiteFS: an open source distributed SQLite database that lives on the same filesystem as your application, and replicates data to all the nodes in your app cluster.</p> <p>With LiteFS, you get the simplicity, flexibility, and lightning-fast local reads of working with vanilla SQLite, but distributed (so it&#39;s close to your users)! It&#39;s especially great for read-heavy web applications. Learn more about LiteFS in the <a href="https://fly.io/docs/litefs/">LiteFS docs</a> and in <a href="https://fly.io/blog/introducing-litefs/">our blog post introducing LiteFS</a>.</p> <p>At Fly.io we&#39;ve been using LiteFS internally for a while now, and it&#39;s awesome!</p> <p>However, something is missing: disaster recovery. Because it&#39;s local to your app, you don&#39;t need to—indeed can&#39;t—pay someone to manage your LiteFS cluster, which means no managed backups. Until now, you&#39;ve had to <a href="https://fly.io/docs/litefs/backup/">build your own</a>: take regular snapshots, store them somewhere, figure out a retention policy, that sort of thing.</p> <p>This also means you can only restore from a point in time when you happen to have taken a snapshot, and you likely need to limit how frequently you snapshot for cost reasons. Wouldn&#39;t it be cool if you could have super-frequent reliable backups to restore from, without having to implement it yourself?</p> <p>Well, that&#39;s why we&#39;re launching, in preview, LiteFS Cloud: backups and restores for LiteFS, managed by Fly.io. It gives you painless and reliable backups, with the equivalent of a snapshot every five minutes (8760 snapshots per month!), whether your database is hosted with us, or anywhere else.</p> <h2 id="how-do-i-use-litefs-cloud"><a href="#how-do-i-use-litefs-cloud" aria-label="Anchor"></a>How do I use LiteFS Cloud?</h2><p>There&#39;s a few steps to get started:</p> <ul> <li>Upgrade LiteFS to version 0.5.1 or greater </li><li>Create a LiteFS Cloud cluster in the Fly.io dashboard, <a href="https://fly.io/dashboard/personal/litefs">LiteFS Cloud section</a> </li><li>Make the LiteFS Cloud auth token available to your LiteFS </li></ul> <p><img src="https://fly.io/blog/2023-07-05/screenshot1.png" alt="Screenshot of Fly.io dashboard, with a red arrow pointing to &#34;LiteFS Cloud&#34; in the left navbar, and another red arrow pointing to the &#34;Create&#34; button on the top right for creating a LiteFS Cloud cluster"/></p> <p><a href="https://fly.io/docs/litefs/cloud-backups">There are some docs here</a>, but that’s literally it. Then your database will start automagically backing up, we’ll manage the backups for you, and you’ll be able to restore your database near instantaneously to any point in time in the last 30 days (with 5 minute granularity).</p> <p>I want to say that again because I think it’s just wild – you can restore your database to <em>any point in time, with 5 minute granularity</em>. <strong><em>Near instantaneously</em></strong>.</p> <p>Speaking of restores—you can do those in the dashboard too. You pick a date and time, and we’ll take the most recent snapshot before that timestamp and restore it. This will take a couple of seconds (or less).</p> <p><img src="https://fly.io/blog/2023-07-05/screenshot2.png" alt="Screenshot of popup modal on Fly.io dashboard, with a date and time selector, and a text field with &#34;lfsc-test-runner/db&#34; typed in it, and a red button at the bottom with text &#34;I understand the consequences. Restore from this snapshot.&#34;"/></p> <p>We&#39;ll introduce pricing in the coming months, but for now LiteFS Cloud is in preview and is free to use. Please go check it out, and let us know how it goes!</p> <h2 id="the-secret-sauce-ltx-compactions"><a href="#the-secret-sauce-ltx-compactions" aria-label="Anchor"></a>The secret sauce: LTX &amp; compactions</h2><p>LiteFS is built on a simple file format called <a href="https://github.com/superfly/ltx">Lite Transaction File (LTX)</a> which is designed for fast, flexible replication and recovery in LiteFS itself and in LiteFS Cloud.</p> <p>But first, let&#39;s start off with what an LTX file represents: <em>a change set of database pages</em>.</p> <p>When you commit a write transaction in SQLite, it updates one or more fixed-sized blocks called pages. By default, these are 4KB in size. An LTX file is simply a sorted list of these changed pages. Whenever you perform a transaction in SQLite, LiteFS will build an LTX file for that transaction.</p> <p>The interesting part of LTX is that contiguous sets of LTX files can be merged together into one LTX file. This merge process is called <em>compaction</em>.</p> <p>For example, let&#39;s say you have 3 transactions in a row that update the following set of pages:</p> <ul> <li>LTX A: Pages 1, 5, 7 </li><li>LTX B: Pages 5, 6 </li><li>LTX C: Pages 5, 7 </li></ul> <p>With LTX compaction, you avoid the duplicate work that comes from overwriting the same pages one transaction at a time. Instead, one LTX file for transactions A through C contains the last version of each page, so the pages are stored and updated only once:</p> <p><img src="https://fly.io/blog/2023-07-05/single-level-compaction.png" alt="Compacting three contiguous LTX files into a single LTX file."/></p> <p>That, in a nutshell, is how a single-level compaction works.</p> <h2 id="it-s-ltx-all-the-way-down"><a href="#it-s-ltx-all-the-way-down" aria-label="Anchor"></a>It&#39;s LTX all the way down</h2><p>Compactions let us take changes for a bunch of transactions and smoosh them down into a single, small file. That&#39;s cool and all but how does that give us fast point-in-time restores? By the magic of multi-level compactions!</p> <p>Compaction levels are progressively larger time intervals that we roll up transaction data. In the following illustration, you can see that the highest level (L3) starts with a full snapshot of the database. This occurs daily and it&#39;s our starting point during a restore.</p> <p>Next, we have an hourly compaction level called L2 so there will be an LTX file with page changes between midnight and 1am, and then another file for 1am to 2am, etc. Below that is L1 which holds 5-minute intervals of data.</p> <p><img src="https://fly.io/blog/2023-07-05/multi-level-compaction.png" alt="Compaction levels for snapshots (L3), hourly (L2), &amp; every five minutes (L1)."/></p> <p>When a restore is requested for a specific timestamp, we can determine a minimal set of LTX files to replay. For example, if we restored to January 10th at 8:15am we would grab the following files:</p> <ul> <li>Start with the snapshot for January 10th. </li><li>Fetch the eight hourly LTX files from midnight to 8am. </li><li>Fetch the three 5-minute interval LTX files from 8:00am to 8:15am. </li></ul> <p>Since LTX files are sorted by page number, we can perform a streaming merge of these twelve files and end up with the state of the database at the given timestamp.</p> <h2 id="department-of-redundancy-department"><a href="#department-of-redundancy-department" aria-label="Anchor"></a>Department of Redundancy Department</h2><p>One of the primary goals of LiteFS is to be simple to use. However, that&#39;s not an easy goal for a distributed database when our industry is moving more and more towards highly dynamic and ephemeral infrastructure. Traditional consensus algorithms require stable membership and adjusting the member set can be complicated.</p> <p>With LiteFS, we chose to use async replication as the primary mode of operation. This has some trade-offs in durability guarantees but it makes the cluster much simpler to operate. LiteFS Cloud alleviates many of the durability trade-offs of async replication by writing data out to S3 which provides eleven 9s of durability. That&#39;s pretty dang durable!</p> <p>However, we don&#39;t write every individual LTX file to S3 immediately. The latency is too high and it&#39;s not cost effective when you write a lot of transactions. Instead, the LiteFS primary node will batch up its changes every second and send a single, compacted LTX file to LiteFS Cloud. Once there, LiteFS Cloud will batch these 1-second files together and flush them to S3 periodically.</p> <p>We track the highest transaction ID of LTX files pushed to S3 and we call this the &#34;high water mark&#34; or HWM. This transaction ID is propagated back down to the nodes of the LiteFS cluster so we can ensure that the transaction file is not removed from any node until it is safely persisted on S3. With this approach, we have multiple layers of redundancy in case your LiteFS cluster can&#39;t communicate with LiteFS Cloud or if we can&#39;t communicate with S3.</p> <h2 id="what-s-next-for-litefs-cloud"><a href="#what-s-next-for-litefs-cloud" aria-label="Anchor"></a>What&#39;s next for LiteFS Cloud?</h2><p>We have a small team dedicated to LiteFS Cloud, and we&#39;re chugging away at new exciting features! Right now, LiteFS Cloud is really just backups and restores, but we are working on a lot of other cool stuff:</p> <ul> <li>Upload your database in the Fly.io dashboard. This way you don&#39;t have to worry about figuring out how to initialize your database when you first deploy it, just upload the database in the dashboard and LiteFS will pull it from LiteFS Cloud. </li><li>Download a point-in-time snapshot of your database from the Fly.io dashboard. You can use this to spin up a local dev env (with production data), do some local analysis, etc. </li><li>Clone your LiteFS Cloud cluster to a new cluster, which you could use for a staging environment (or on-demand test environments for your CI pipelines) with real data. </li><li>Features to support apps that run on serverless platforms like Vercel, Google Cloud Run, Deno, and more. We&#39;ll need to develop a number of different features for this, stay tuned for more information in the coming weeks! </li></ul> <p>We&#39;re really excited about the future of LiteFS Cloud, so we wanted to share what we&#39;re thinking. We&#39;d also love to hear any feedback you have about these ideas that might inform our work.</p>  </section> <dl> <dt> Previous post  ↓ </dt> <dd> <a href="https://fly.io/blog/we-raised-a-bunch-of-money/"> We Raised A Bunch Of Money </a> </dd> </dl> </article></div>
  </body>
</html>
