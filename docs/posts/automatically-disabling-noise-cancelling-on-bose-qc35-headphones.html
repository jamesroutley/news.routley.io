<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ldirer.com/blog/posts/bose-qc35-noise-cancelling-off">Original</a>
    <h1>Automatically disabling noise cancelling on Bose QC35 headphones</h1>
    
    <div id="readability-page-1" class="page"><div><p>I have had a pair of Bose QC35 headphones since 2017.</p>
<p>One thing annoys me is that when bluetooth is turned on, noise cancellation is automatically set to &#39;high&#39;.</p>
<p>The Bose mobile app seems to be the official solution, but it takes a few seconds to start, enough for me to feel mildly offended and look for an alternate solution.</p>
<h2 id="a-linux-solution"><a href="#a-linux-solution"><span>Read the &#34;A Linux solution&#34; section</span><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
              <path d="M13.0607 8.11097L14.4749 9.52518C17.2086 12.2589 17.2086 16.691 14.4749 19.4247L14.1214 19.7782C11.3877 22.5119 6.95555 22.5119 4.22188 19.7782C1.48821 17.0446 1.48821 12.6124 4.22188 9.87874L5.6361 11.293C3.68348 13.2456 3.68348 16.4114 5.6361 18.364C7.58872 20.3166 10.7545 20.3166 12.7072 18.364L13.0607 18.0105C15.0133 16.0578 15.0133 12.892 13.0607 10.9394L11.6465 9.52518L13.0607 8.11097ZM19.7782 14.1214L18.364 12.7072C20.3166 10.7545 20.3166 7.58872 18.364 5.6361C16.4114 3.68348 13.2456 3.68348 11.293 5.6361L10.9394 5.98965C8.98678 7.94227 8.98678 11.1081 10.9394 13.0607L12.3536 14.4749L10.9394 15.8891L9.52518 14.4749C6.79151 11.7413 6.79151 7.30911 9.52518 4.57544L9.87874 4.22188C12.6124 1.48821 17.0446 1.48821 19.7782 4.22188C22.5119 6.95555 22.5119 11.3877 19.7782 14.1214Z"></path>
              </svg></span></a>A Linux solution</h2>
<p>Here&#39;s what I wanted: <strong>every time my headphones connect to my computer, noise cancellation is set to &#39;off&#39;</strong>.</p>
<p>To achieve that, we need to:</p>
<ol>
<li>Know that the headphones just connected over bluetooth.</li>
<li>Tell them to set noise-cancelling to &#39;off&#39;.</li>
</ol>
<p>Part 2 is basically &#39;reverse-engineering&#39; the Bose mobile app and build software that works on Linux. Fortunately, <a href="https://github.com/Denton-L/based-connect">someone already did that</a> üôèüôè.</p>
<p>I installed their software and verified that I could disable noise-cancelling by running <code>/usr/local/bin/based-connect --noise-cancelling=off [MAC address of headphones]</code>.</p>
<p>Now we need to know when the headphones connect, and run the script automatically. This can be done with a combination of udev rules and a systemd service on Linux.</p>
<h2 id="listening-to-bluetooth-connection-events-with-udev"><a href="#listening-to-bluetooth-connection-events-with-udev"><span>Read the &#34;Listening to bluetooth connection events with udev&#34; section</span><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
              <path d="M13.0607 8.11097L14.4749 9.52518C17.2086 12.2589 17.2086 16.691 14.4749 19.4247L14.1214 19.7782C11.3877 22.5119 6.95555 22.5119 4.22188 19.7782C1.48821 17.0446 1.48821 12.6124 4.22188 9.87874L5.6361 11.293C3.68348 13.2456 3.68348 16.4114 5.6361 18.364C7.58872 20.3166 10.7545 20.3166 12.7072 18.364L13.0607 18.0105C15.0133 16.0578 15.0133 12.892 13.0607 10.9394L11.6465 9.52518L13.0607 8.11097ZM19.7782 14.1214L18.364 12.7072C20.3166 10.7545 20.3166 7.58872 18.364 5.6361C16.4114 3.68348 13.2456 3.68348 11.293 5.6361L10.9394 5.98965C8.98678 7.94227 8.98678 11.1081 10.9394 13.0607L12.3536 14.4749L10.9394 15.8891L9.52518 14.4749C6.79151 11.7413 6.79151 7.30911 9.52518 4.57544L9.87874 4.22188C12.6124 1.48821 17.0446 1.48821 19.7782 4.22188C22.5119 6.95555 22.5119 11.3877 19.7782 14.1214Z"></path>
              </svg></span></a>Listening to bluetooth connection events with udev</h2>
<p>udev is a device manager for Linux. From the <a href="https://man7.org/linux/man-pages/man7/udev.7.html">man page</a>, I got that it is a layer on top of the kernel, it gives usable names to devices, and lets us subscribe to device events.</p>
<p>Writing the actual udev rule was a bit tricky.</p>
<ul>
<li>
<p>Run <code>udevadm monitor --property</code> in one terminal to see udev events as they occur.</p>
</li>
<li>
<p>Test the rule matching with:</p>
<pre><code>udevadm <span>test</span> --action=add /devices/virtual/input/input71
</code></pre>
</li>
</ul>
<p>The path to the device comes from watching <code>udevadm monitor --property</code> when the headphones connect.</p>
<ul>
<li>
<p>A helpful debugging rule (credits to someone on some internet forum).</p>
<pre><code>
<span>ACTION</span>==<span>&#34;add&#34;</span>, SUBSYSTEM==<span>&#34;input&#34;</span>, RUN+=<span>&#34;/bin/sh -c &#39;echo == &gt;&gt; /tmp/udev-env.txt; env &gt;&gt; /tmp/udev-env.txt&#39;&#34;</span>
</code></pre>
</li>
</ul>
<p>Initially, I tried to make the udev rule run the script setting noise-cancelling with <code>RUN+=&#34;path-to-my-script&#34;</code>. It did not work because, for security reasons that I am not familiar with, udev scripts run inside a sandbox and cannot access the network.</p>
<h2 id="putting-things-together"><a href="#putting-things-together"><span>Read the &#34;Putting things together&#34; section</span><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
              <path d="M13.0607 8.11097L14.4749 9.52518C17.2086 12.2589 17.2086 16.691 14.4749 19.4247L14.1214 19.7782C11.3877 22.5119 6.95555 22.5119 4.22188 19.7782C1.48821 17.0446 1.48821 12.6124 4.22188 9.87874L5.6361 11.293C3.68348 13.2456 3.68348 16.4114 5.6361 18.364C7.58872 20.3166 10.7545 20.3166 12.7072 18.364L13.0607 18.0105C15.0133 16.0578 15.0133 12.892 13.0607 10.9394L11.6465 9.52518L13.0607 8.11097ZM19.7782 14.1214L18.364 12.7072C20.3166 10.7545 20.3166 7.58872 18.364 5.6361C16.4114 3.68348 13.2456 3.68348 11.293 5.6361L10.9394 5.98965C8.98678 7.94227 8.98678 11.1081 10.9394 13.0607L12.3536 14.4749L10.9394 15.8891L9.52518 14.4749C6.79151 11.7413 6.79151 7.30911 9.52518 4.57544L9.87874 4.22188C12.6124 1.48821 17.0446 1.48821 19.7782 4.22188C22.5119 6.95555 22.5119 11.3877 19.7782 14.1214Z"></path>
              </svg></span></a>Putting things together</h2>
<p>Here&#39;s the complete setup:</p>
<p><code>/etc/systemd/system/custom-bose-noise-canceling-off.service</code></p>
<pre><code>
<span>[Unit]</span>
<span>Description</span>=Set noise canceling to <span>&#39;off&#39;</span> <span>on</span> Bose QC35

<span>[Service]</span>
<span>Type</span>=simple
<span>ExecStart</span>=/home/laurent/programming/scripts/bose/nc_<span>off</span>
<span>User</span>=laurent
</code></pre>
<p><code>/usr/lib/udev/rules.d/99-custom-bose-bluetooth.rules</code></p>
<pre><code><span>ACTION</span>==<span>&#34;add&#34;</span>, SUBSYSTEM==<span>&#34;input&#34;</span>, ENV{PRODUCT}==<span>&#34;1/1e/111c/111&#34;</span>, TAG+=<span>&#34;systemd&#34;</span>, ENV{SYSTEMD_WANTS}=<span>&#34;custom-bose-noise-canceling-off.service&#34;</span>
</code></pre>
<p>The <code>ENV{PRODUCT}</code> value can be obtained by looking at the output of <code>udevadm monitor --property</code>.</p>
<p><code>/home/laurent/programming/scripts/bose/nc_off</code></p>
<pre><code><span>#!/bin/bash</span>



<span>sleep</span> 5
/usr/local/bin/based-connect --noise-cancelling=off &lt;device mac address&gt; 
</code></pre>
<p>Exploring <code>udev</code> was interesting, and now I don&#39;t have to open the Bose app.
Also, it is a small daily reward to hear noise-cancelling turn off automatically ü•≥.</p>
<h2 id="on-android"><a href="#on-android"><span>Read the &#34;On Android&#34; section</span><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
              <path d="M13.0607 8.11097L14.4749 9.52518C17.2086 12.2589 17.2086 16.691 14.4749 19.4247L14.1214 19.7782C11.3877 22.5119 6.95555 22.5119 4.22188 19.7782C1.48821 17.0446 1.48821 12.6124 4.22188 9.87874L5.6361 11.293C3.68348 13.2456 3.68348 16.4114 5.6361 18.364C7.58872 20.3166 10.7545 20.3166 12.7072 18.364L13.0607 18.0105C15.0133 16.0578 15.0133 12.892 13.0607 10.9394L11.6465 9.52518L13.0607 8.11097ZM19.7782 14.1214L18.364 12.7072C20.3166 10.7545 20.3166 7.58872 18.364 5.6361C16.4114 3.68348 13.2456 3.68348 11.293 5.6361L10.9394 5.98965C8.98678 7.94227 8.98678 11.1081 10.9394 13.0607L12.3536 14.4749L10.9394 15.8891L9.52518 14.4749C6.79151 11.7413 6.79151 7.30911 9.52518 4.57544L9.87874 4.22188C12.6124 1.48821 17.0446 1.48821 19.7782 4.22188C22.5119 6.95555 22.5119 11.3877 19.7782 14.1214Z"></path>
              </svg></span></a>On Android</h2>
<p>If you know of a good solution please let me know!</p>
<p>At the moment I use a third-party &#39;Serial Bluetooth Terminal&#39; app (that I had been using for other purposes) to send <code>0x0106020100</code> to the headphones, turning noise-cancelling off.</p>
<h2 id="some-resources-i-used"><a href="#some-resources-i-used"><span>Read the &#34;Some resources I used&#34; section</span><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
              <path d="M13.0607 8.11097L14.4749 9.52518C17.2086 12.2589 17.2086 16.691 14.4749 19.4247L14.1214 19.7782C11.3877 22.5119 6.95555 22.5119 4.22188 19.7782C1.48821 17.0446 1.48821 12.6124 4.22188 9.87874L5.6361 11.293C3.68348 13.2456 3.68348 16.4114 5.6361 18.364C7.58872 20.3166 10.7545 20.3166 12.7072 18.364L13.0607 18.0105C15.0133 16.0578 15.0133 12.892 13.0607 10.9394L11.6465 9.52518L13.0607 8.11097ZM19.7782 14.1214L18.364 12.7072C20.3166 10.7545 20.3166 7.58872 18.364 5.6361C16.4114 3.68348 13.2456 3.68348 11.293 5.6361L10.9394 5.98965C8.98678 7.94227 8.98678 11.1081 10.9394 13.0607L12.3536 14.4749L10.9394 15.8891L9.52518 14.4749C6.79151 11.7413 6.79151 7.30911 9.52518 4.57544L9.87874 4.22188C12.6124 1.48821 17.0446 1.48821 19.7782 4.22188C22.5119 6.95555 22.5119 11.3877 19.7782 14.1214Z"></path>
              </svg></span></a>Some resources I used</h2>
<ul>
<li><a href="https://unix.stackexchange.com/questions/476094/run-a-script-when-bluetooth-device-is-connected">https://unix.stackexchange.com/questions/476094/run-a-script-when-bluetooth-device-is-connected</a></li>
<li><a href="https://reactivated.net/writing_udev_rules.html">https://reactivated.net/writing_udev_rules.html</a>. A bit outdated - <code>udevadm</code> replaced many of the commands listed there - but still useful.</li>
<li>The bytes required to set noise-cancelling to &#34;off&#34; can be found <a href="https://github.com/Denton-L/based-connect/blob/ef66145bf4739ec96c1a6959f63146d12ba87e4c/based.c#L258">in the codebase of the Linux tool</a>.</li>
</ul></div></div>
  </body>
</html>
