<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.infoq.com/news/2023/04/virtual-threads-arrives-jdk21/">Original</a>
    <h1>Virtual Threads Arrive in JDK 21, Ushering a New Era of Concurrency</h1>
    
    <div id="readability-page-1" class="page"><div>
								<p>JEP 444, <a href="https://openjdk.org/jeps/444">Virtual Threads</a>, was <a href="https://mail.openjdk.org/pipermail/jdk-dev/2023-March/007543.html">promoted</a> from <strong>Candidate</strong> to <strong>Proposed to Target</strong> status for JDK 21. This feature provides virtual threads, lightweight threads that dramatically reduce the effort of writing, maintaining, and observing high-throughput concurrent applications on the Java platform. This JEP intends to finalize this feature based on feedback from the previous two rounds of preview: JEP 436, <a href="https://openjdk.org/jeps/436">Virtual Threads (Second Preview)</a>, delivered in JDK 20; and JEP 425, <a href="https://openjdk.org/jeps/425">Virtual Threads (Preview)</a>, delivered in JDK 19.</p>

<p>With this JEP, Java now has two types of threads: traditional threads, also called platform threads, and virtual threads. Platform threads are a one-to-one wrapper over operating system threads, while virtual threads are lightweight implementations provided by the JDK that can run many virtual threads on the same OS thread. Virtual threads offer a more efficient alternative to platform threads, allowing developers to handle a large number of tasks with significantly lower overhead. These threads offer compatibility with existing Java code and a seamless migration path to benefit from enhanced performance and resource utilization. Consider the following example:</p>

<pre><code>try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
    IntStream.range(0, 10_000).forEach(i -&gt; {
        executor.submit(() -&gt; {
            Thread.sleep(Duration.ofSeconds(1));
            return i;
        });
    });
}
</code></pre>

<p>The JDK can now run up to 10,000 concurrent virtual threads on a small number of operating system (OS) threads, as little as one, to execute the simple code above that involves sleeping for one second.</p>

<p>Virtual threads are designed to work with <a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/lang/ThreadLocal.html">thread-local </a>variables and <a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/lang/InheritableThreadLocal.html">inheritable thread-local</a> variables, just like platform threads. However, due to the large number of virtual threads that can be created, developers should use thread-local variables with caution. To assist with the migration to virtual threads, the JDK provides a system property, <strong><code>jdk.traceVirtualThreadLocals</code></strong>, that triggers a stack trace when a virtual thread sets the value of any thread-local variable.</p>

<p>The <strong><code><a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/util/concurrent/package-summary.html">java.util.concurrent</a></code></strong> package now includes support for virtual threads. The <strong><code><a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/util/concurrent/locks/LockSupport.html">LockSupport</a> </code></strong>API has been updated to gracefully park and unpark virtual threads, enabling APIs that use <code><strong>LockSupport</strong></code>, such as <a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/util/concurrent/locks/package-summary.html">Locks</a>, <a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/util/concurrent/Semaphore.html">Semaphores</a>, and <a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/util/concurrent/BlockingQueue.html">blocking queues</a>, to function seamlessly with virtual threads. The <strong><code><a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/util/concurrent/Executors.html#newThreadPerTaskExecutor(java.util.concurrent.ThreadFactory)">Executors.newThreadPerTaskExecutor(ThreadFactory)</a></code></strong> and <strong><code><a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/util/concurrent/Executors.html#newVirtualThreadPerTaskExecutor()">Executors.newVirtualThreadPerTaskExecutor()</a></code></strong> methods provide an <strong><code><a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/util/concurrent/ExecutorService.html">ExecutorService</a></code></strong> that creates a new thread for each task, facilitating the migration and interoperability with existing code that uses thread pools and <strong><code>ExecutorService</code></strong>.</p>

<p>Networking APIs in the<strong> <code><a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/net/package-summary.html">java.net</a></code></strong> and <strong><code><a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/nio/channels/package-summary.html">java.nio.channels</a></code></strong> packages now support virtual threads, enhancing efficiency in concurrent applications. Blocking operations on a virtual thread free up the underlying platform thread, while I/O methods in the <strong><code><a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/net/Socket.html">Socket</a></code></strong>, <strong><code><a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/net/ServerSocket.html">ServerSocket</a></code></strong> and <strong><code><a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/net/DatagramSocket.html">DatagramSocket</a></code></strong> classes have been made <a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/lang/Thread.html#interrupt()">interruptible</a>. This update promotes consistent behavior and improved performance for Java developers working with concurrent applications.</p>

<p>The <strong><code><a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/io/package-summary.html">java.io</a></code></strong> package, which provides APIs for streams of bytes and characters, has been updated to avoid pinning when used in virtual threads. Pinning in virtual threads refers to a lightweight thread being &#34;stuck&#34; to a specific platform thread, limiting concurrency and flexibility due to blocking operations. <strong><code><a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/io/BufferedInputStream.html">BufferedInputStream</a></code></strong>, <strong><code><a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/io/BufferedOutputStream.html">BufferedOutputStream</a></code></strong>, <strong><code><a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/io/BufferedReader.html">BufferedReader</a></code></strong>, <strong><code><a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/io/BufferedWriter.html">BufferedWriter</a></code></strong>, <strong><code><a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/io/PrintStream.html">PrintStream</a></code></strong>, and <strong><code><a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/io/PrintWriter.html">PrintWriter</a></code></strong> now use an explicit lock instead of a monitor when used directly. The stream decoders and encoders used by <strong><code><a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/io/InputStreamReader.html">InputStreamReader</a></code></strong> and <strong><code><a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/io/OutputStreamWriter.html">OutputStreamWriter</a></code></strong> now use the same lock as their enclosing <code><strong>InputStreamReader</strong></code> or <code><strong>OutputStreamWriter</strong></code>.</p>

<p>Java Native Interface (<a href="https://download.java.net/java/early_access/jdk21/docs/specs/jni/index.html">JNI</a>) has introduced a new function, <strong><code><a href="https://download.java.net/java/early_access/jdk21/docs/specs/jni/functions.html#isvirtualthread">IsVirtualThread</a></code></strong>, to test if an object is a virtual thread. The JNI specification otherwise remains unchanged.</p>

<p>The debugging architecture, consisting of the JVM Tool Interface (<a href="https://download.java.net/java/early_access/jdk21/docs/specs/jvmti.html">JVM TI</a>), the Java Debug Wire Protocol (<a href="https://download.java.net/java/early_access/jdk21/docs/specs/jdwp/jdwp-protocol.html">JDWP</a>), and the Java Debug Interface (<a href="https://download.java.net/java/early_access/loom/docs/api/jdk.jdi/module-summary.html">JDI</a>), has been updated to support virtual threads. All three interfaces now support virtual threads, with new capabilities and methods added to handle thread start and end events and bulk suspension and resumption of virtual threads.</p>

<p>JDK Flight Recorder (<a href="https://docs.oracle.com/javacomponents/jmc-5-4/jfr-runtime-guide/about.htm#JFRUH174">JFR</a>) now supports virtual threads with new events such as <strong><code>jdk.VirtualThreadStart</code></strong>, <strong><code>jdk.VirtualThreadEnd</code></strong>, <strong><code>jdk.VirtualThreadPinned</code></strong>, and <strong><code>jdk.VirtualThreadSubmitFailed</code></strong>. These events provide insight into the behavior of virtual threads in the application.</p>

<p>Java Management Extensions (<a href="https://docs.oracle.com/en/java/javase/20/jmx/introduction-jmx-technology.html">JMX</a>) will continue to support only platform threads through the <strong><code><a href="https://download.java.net/java/early_access/jdk21/docs/api/java.management/java/lang/management/ThreadMXBean.html">ThreadMXBean</a></code></strong> interface. A new method in the <strong><code><a href="https://download.java.net/java/early_access/jdk21/docs/api/jdk.management/com/sun/management/HotSpotDiagnosticMXBean.html#dumpThreads(java.lang.String,com.sun.management.HotSpotDiagnosticMXBean.ThreadDumpFormat)">HotSpotDiagnosticsMXBean</a></code></strong> interface generates the new-style thread dump to support virtual threads.</p>

<p>While virtual threads bring significant performance improvements, developers should be aware of compatibility risks due to changes in existing APIs and their implementations. Some of these risks include revisions to the internal locking protocol in the <strong><code>java.io</code></strong> package and source and binary incompatible changes that may impact code that extends the<strong> <code><a href="https://download.java.net/java/early_access/jdk21/docs/api/java.base/java/lang/Thread.html">Thread</a></code></strong> class.</p>

<p>Virtual threads mark a significant milestone in Java&#39;s journey to support highly concurrent and scalable applications. With a more efficient and lightweight threading model, developers can now handle millions of tasks with ease and better utilize system resources. Developers can leverage more details on JEP 425, which can be found in this InfoQ <a href="https://www.infoq.com/news/2022/05/virtual-threads-for-jdk19/">news story</a> and this JEP Café <a href="https://inside.java/2022/06/08/jepcafe11/">screen cast</a> by <a href="https://www.linkedin.com/in/jos%C3%A9-paumard-2458ba5/">José Paumard</a>, Java developer advocate with the Java Platform Group at Oracle.</p>
<quillbot-extension-portal></quillbot-extension-portal><quillbot-extension-portal></quillbot-extension-portal><quillbot-extension-portal></quillbot-extension-portal>
								









  
    

							</div></div>
  </body>
</html>
