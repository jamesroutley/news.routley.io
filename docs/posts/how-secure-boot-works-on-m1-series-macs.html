<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://eclecticlight.co/2021/12/29/how-secure-boot-works-on-m1-series-macs/">Original</a>
    <h1>How Secure Boot Works on M1 Series Macs</h1>
    
    <div id="readability-page-1" class="page"><article id="post-62941">
	
	<!-- .entry-header -->

	
		<div data-first_letter="W">
		<p>We’ve come to assume that what we see in the Unified Log tells us what macOS is doing, once the system has been loaded by firmware. While that’s largely correct for Intel Macs running UEFI firmware, and what the T2 does is kept pretty secret, Macs with M1 series chips are quite different. Look in the log of your M1 and you can watch much of the Secure Boot process in glorious detail, as this article explains.</p>
<p>In the New Year, Apple is expected to update its Platform Security Guide to reflect changes brought in its latest M1 Pro and Max models, and with Monterey. For the time being, I rely on <a href="https://support.apple.com/guide/security/secac71d5623/web" target="_blank">the current account</a>, as summarised in the following diagram.</p>
<p><span><img data-attachment-id="59341" data-permalink="https://eclecticlight.co/m1bootsecurity2/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2021/05/m1bootsecurity2.jpg" data-orig-size="1724,1598" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="M1bootSecurity2" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2021/05/m1bootsecurity2.jpg?w=300" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2021/05/m1bootsecurity2.jpg?w=940" src="https://eclecticlightdotcom.files.wordpress.com/2021/05/m1bootsecurity2.jpg?w=940" alt="M1bootSecurity2" srcset="https://eclecticlightdotcom.files.wordpress.com/2021/05/m1bootsecurity2.jpg?w=940 940w, https://eclecticlightdotcom.files.wordpress.com/2021/05/m1bootsecurity2.jpg?w=150 150w, https://eclecticlightdotcom.files.wordpress.com/2021/05/m1bootsecurity2.jpg?w=300 300w, https://eclecticlightdotcom.files.wordpress.com/2021/05/m1bootsecurity2.jpg?w=768 768w, https://eclecticlightdotcom.files.wordpress.com/2021/05/m1bootsecurity2.jpg?w=1024 1024w, https://eclecticlightdotcom.files.wordpress.com/2021/05/m1bootsecurity2.jpg 1724w" sizes="(max-width: 940px) 100vw, 940px"/></span></p>
<p>The steps here are run first by the Boot ROM, then LLB (the Low-Level Bootloader), followed by iBoot (Stage 2), which hands over to macOS itself.</p>
<p>On an M1 Pro Mac which started to boot at around 00 to 01 seconds on the system clock, the first 7-8 seconds of that process is omitted from the log, and consists of the Boot ROM and LLB phases. The first log entries from the kernel are</p>
<p>To be able to validate and access LocalPolicy, and determine the level of security required, the kernel needs to load its validation tool for Image4 files, which is does next</p>
<p>After that, security policy is loaded:</p>
<p>Next comes starting the Secure Enclave key store:</p>
<p>From this time onwards, other parts of the chip are starting up and initialising. There are often copious log entries from each as it does.</p>
<p>So far, all this has been run on a single core. It’s now time to start all the others, which is performed by a series of calls to <code>cpu_start</code>, beginning with the first E processor</p>
<ul>
<li>cluster 0 contains the two E cores, type 1, numbers 0 and 1;</li>
<li>cluster 1 contains the first four P cores, type 2, numbers 2-5;</li>
<li>cluster 2 contains the remaining four P cores, type 2, numbers 6-9.</li>
</ul>
<p>The original M1 chip has just two clusters:</p>
<ul>
<li>cluster 0 contains the four E cores, type 1, numbers 0-3;</li>
<li>cluster 1 contains the four P cores, type 2, numbers 4-7.</li>
</ul>
<p>Gatekeeper is then enabled</p>
<p>iBoot is now ready to access disk storage, so loads the APFS file system</p>
<p>The next task is to locate the boot volume, ready to mount its snapshot</p>
<p>Only now, nearly 15 seconds after its start, does the Mac get to root from the boot snapshot</p>
<p>The first task with that snapshot is to validate its seal</p>
<p>Next comes the Recovery volume within that boot container</p>
<p>Other volumes mounted include VM, Preboot and Update</p>
<p>Additionally, volumes in the Apple_APFS_ISC container are mounted as required</p>
<p>The end of the kernel-only phase, which is entirely iBoot, comes almost 20 seconds after the start. From then on, processes other than the kernel are running, and filling much of the log. The first of these loads the Wi-Fi firmware</p>
<p>Immediately after that, the system clock is adjusted, and there’s a hiatus when that occurs, here setting the clock back by 3.3 seconds</p>
<p>All this is still within what Apple terms iBoot. Its next task is to validate the Boot Kernel Collection and any auxiliary collection, using <code>kernelmanagerd</code></p>
<p><code>kernelmanagerd</code> then validates each of the Boot Kernel Collection with a log entry such as</p>
<p>Once that’s ready to load as a collection, that’s reported</p>
<p>Each is acknowledged as it is loaded</p>
<p>Once <code>kernelmanagerd</code> has finished, the kernel shuts it down, and no more kernel extensions can be loaded</p>
<p>macOS is now loaded and running at last, almost 30 seconds after the start.</p>
<p><strong><em>Postscript:</em> Isn’t this just xnu?</strong></p>
<p>That’s what I’d always thought the logs recorded, and that appears true for Intel Macs. However, look at the tasks which are being undertaken by the kernel throughout this period, and look at those stated by Apple, in its Platform Security Guide, as being performed by what it terms “iBoot (Stage 2)”. One very simple example is the validation of the Boot Kernel Collection, and any Auxiliary Kernel Collection. Then compare with the log entries by <code>kernelmanagerd</code> above, which record exactly those processes occurring more than 3 seconds after the announcement of the xnu version. Either Apple is confused and incorrect, or these log entries are being made during the iBoot stage.</p>
<p>It’s also worth noting that one of the most important tasks of iBoot is to verify the Seal on the snapshot which forms the boot system and SSV. The log entries above demonstrate that being performed at around 14.9 seconds, once APFS has been loaded, which is a prerequisite for that task. Apple states explicitly that’s a task of iBoot.</p>
	</div><!-- .entry-content -->

	
	<!-- .entry-footer -->

</article></div>
  </body>
</html>
