<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://nicolascarpi.github.io/openbsd/2019/04/03/openbsd-mail-server.html">Original</a>
    <h1>Personal Mail Server on OpenBSD (2019)</h1>
    
    <div id="readability-page-1" class="page"><div>
      <div>
        <div>

  

  <article>
    <p>It’s time to host your email yourself!</p>

<p>A step-by-step guide for installing and configuring a mail server on OpenBSD.</p>

<p>As most of the entries in this blog, this is more of a reminder for me in case I need to do it again. But I publish it in the hope it might be useful to someone planning to do the same thing.</p>

<p>This was done with OpenBSD 6.4.</p>

<h2 id="the-stack">The stack</h2>

<p>Let’s begin with a description of the stack and what we’re going to use:</p>

<ul>
  <li>OS: OpenBSD. Stable, secure, perfect for hosting email, a precious thing in this day and age</li>
  <li>SMTP: Opensmtpd. A clean codebase with a sane config file.</li>
  <li>IMAP: Dovecot. Never used anything else anyway.</li>
  <li>DKIM: Dkimproxy. Works nicely with opensmtpd.</li>
  <li>SPAM: Spamd.</li>
</ul>

<h2 id="os">OS</h2>

<h3 id="the-server">The server</h3>

<p>Ok the first thing to do is to get a hand on an OpenBSD server. If you already have one, great. If not, do like me, get one from Vultr.com. If you use <a href="http://www.vultr.com/?ref=7164540">this link</a> you’ll get $10, so about 2 months free!</p>

<p>Also, Vultr.com is one of the few VPS provider supporting OpenBSD. Another one would be <a href="https://openbsd.amsterdam/">OpenBSD.amsterdam</a>.</p>

<p>The cheapest offer of Vultr.com is more than enough for an email server.</p>

<h3 id="first-steps-on-the-server">First steps on the server</h3>

<p>Once you get the IP address of your server, check to see if the IP is not blacklisted with <a href="https://mxtoolbox.com/blacklists.aspx">this tool</a>. If it is, ask for a new server. If not, go on.</p>

<p>Now to connect to it, edit your ssh config file and add an entry where <code>&lt;hostname&gt;</code> is the name of the instance and <code>&lt;ip&gt;</code> its IP address.</p>

<p>File: <code>~/.ssh/config</code></p>

<div><div><pre><code>Host &lt;hostname&gt;
Hostname &lt;ip&gt;
</code></pre></div></div>

<p>Now connect:</p>



<p>Set source for packages, use a mirror close to the server’s location:</p>

<p>File: <code>/etc/installurl</code></p>

<div><div><pre><code>https://ftp.fr.openbsd.org/pub/OpenBSD/
</code></pre></div></div>

<p>Patch the system and reboot:</p>

<div><div><pre><code>syspatch <span>-c</span>
reboot
<span># wait for reboot</span>
ssh root@&lt;<span>hostname</span><span>&gt;</span>
</code></pre></div></div>

<p>Fix time:</p>

<div><div><pre><code><span>ln</span> <span>-sf</span> /usr/share/zoneinfo/Europe/Paris /etc/localtime
</code></pre></div></div>

<h3 id="install-the-essentials">Install the essentials</h3>

<div><div><pre><code>pkg_add <span>-v</span> vim zsh git htop unzip cmake
<span># select vim no x11 python3 (10)</span>
<span># select unzip iconv (2)</span>
</code></pre></div></div>

<h4 id="dotfiles-install-skip-this-if-youre-not-me">Dotfiles install (skip this if you’re not me)</h4>

<div><div><pre><code>git clone <span>--recursive</span> https://github.com/NicolasCARPi/.dotfiles
./.dotfiles/install.sh
vim ~/.vim/vimrc
<span># set g:ycm_server_python_interpreter to /usr/local/bin/python3</span>
<span># close vim</span>
vim
:PluginInstall
<span># finish YCM install</span>
<span>cd</span> ~/.vim/plugins/YouCompleteMe
python3 install.py
<span># remove the --color=auto from zshrc and fix path in git_prompt plugin in zsh folder</span>
</code></pre></div></div>

<h4 id="configure-ssh">Configure SSH</h4>

<p>In the file <code>/etc/ssh/sshd_config</code>, change the port to something other than 22, preferably &gt; 10000.</p>



<h4 id="add-your-user">Add your user</h4>

<p>Enough with root already, let’s add a user:</p>

<div><div><pre><code>adduser
<span># login groups: &lt;username&gt; staff</span>
</code></pre></div></div>

<p>Allow member of staff to execute commands as root:</p>

<p>File: <code>/etc/doas.conf</code></p>

<div><div><pre><code>permit setenv { -ENV PS1=$DOAS_PS1 SSH_AUTH_SOCK } :staff
</code></pre></div></div>

<p>Disconnect from server.</p>

<p>On your host, edit <code>~/.ssh/config</code> and add a line <code>Port &lt;port&gt;</code> for the server. Add a line <code>User &lt;user&gt;</code> if your local user is different from the one you created on the server.</p>

<p>Copy your public key to the server:</p>

<div><div><pre><code>ssh-copy-id -i ~/.ssh/id_ed25519.pub &lt;hostname&gt;
ssh &lt;hostname&gt;
</code></pre></div></div>

<p>Repeat the dotfiles step.</p>

<p>Edit <code>/etc/ssh/sshd_config</code> and set “EnableRootLogin” to no; <code>doas rcctl reload sshd</code>.</p>

<h2 id="dns">DNS</h2>

<p>Add AAAA and A pointing to IP of the server.
Add MX ponting to <code>&lt;domain&gt;.</code> (point at the end!)</p>

<h2 id="opensmtpd">OpenSMTPD</h2>

<p>Good news, you don’t have to install it as it’s shipped with the base, how great is that! :)</p>

<p>Here is my config file (<code>/etc/mail/smtpd.conf</code>), adapt to your needs:</p>

<div><div><pre><code><span># $OpenBSD: smtpd.conf,v 1.11 2018/06/04 21:10:58 jmc Exp $
</span>
<span># configure TLS
</span><span>pki</span> &lt;<span>domain</span>&gt; <span>key</span> <span>&#34;/etc/letsencrypt/live/&lt;domain&gt;/privkey.pem&#34;</span>
<span>pki</span> &lt;<span>domain</span>&gt; <span>cert</span> <span>&#34;/etc/letsencrypt/live/&lt;domain&gt;/fullchain.pem&#34;</span>

<span># aliases table
</span><span>table</span> <span>aliases</span> <span>file</span>:/<span>etc</span>/<span>mail</span>/<span>aliases</span>

<span># listen directives
</span><span>listen</span> <span>on</span> <span>all</span> <span>tls</span> <span>hostname</span> &lt;<span>domain</span>&gt;
<span>listen</span> <span>on</span> <span>all</span> <span>port</span> <span>587</span> <span>hostname</span> &lt;<span>domain</span>&gt; <span>tls</span> <span>pki</span> &lt;<span>domain</span>&gt; <span>auth</span>
<span>listen</span> <span>on</span> <span>lo0</span> <span>port</span> <span>10028</span> <span>tag</span> <span>DKIM</span>

<span># send mail to maildir ~/.mail for local accounts in alias table
</span><span>action</span> <span>&#34;local&#34;</span> <span>maildir</span> <span>&#34;%{user.directory}/.mail&#34;</span> <span>alias</span> &lt;<span>aliases</span>&gt;

<span>action</span> <span>&#34;relay&#34;</span> <span>relay</span> <span>helo</span> &lt;<span>domain</span>&gt;
<span>action</span> <span>&#34;relay_dkim&#34;</span> <span>relay</span> <span>host</span> <span>smtp</span>://<span>127</span>.<span>0</span>.<span>0</span>.<span>1</span>:<span>10027</span>

<span># &lt;domain&gt;
</span><span>match</span> <span>from</span> <span>any</span> <span>for</span> <span>domain</span> <span>&#34;&lt;domain&gt;&#34;</span> <span>action</span> <span>&#34;local&#34;</span>
<span># local
</span><span>match</span> <span>for</span> <span>local</span> <span>action</span> <span>&#34;local&#34;</span>
<span># dkim
</span><span>match</span> <span>tag</span> <span>DKIM</span> <span>for</span> <span>any</span> <span>action</span> <span>&#34;relay&#34;</span>
<span>##match auth from any for any action &#34;relay&#34;
</span><span>match</span> <span>auth</span> <span>from</span> <span>any</span> <span>for</span> <span>any</span> <span>action</span> <span>&#34;relay_dkim&#34;</span>
</code></pre></div></div>

<h2 id="tls">TLS</h2>

<p>For getting a certificate for the domain, we will use acme-client, shipped with OpenBSD.</p>

<div><div><pre><code>acme-client <span>-ADv</span> &lt;domain&gt;
</code></pre></div></div>

<h2 id="dovecot">Dovecot</h2>



<p>There is an issue with dovecot triggering the max open files limit, so let’s fix that first.</p>

<p>File: <code>/etc/sysctl.conf</code></p>



<p>File: <code>/etc/login.conf</code></p>

<div><div><pre><code><span>dovecot</span>:\
  :<span>openfiles</span>-<span>cur</span>=<span>1024</span>:\
  :<span>openfiles</span>-<span>max</span>=<span>2048</span>:\
  :<span>tc</span>=<span>daemon</span>:
</code></pre></div></div>

<p>Now let’s tweak the base config of Dovecot to our liking.</p>



<p>File: <code>10-mail.conf</code></p>

<div><div><pre><code>mail_location = maildir:~/.mail
</code></pre></div></div>

<p>File: <code>10-ssl.conf</code></p>

<div><div><pre><code>ssl_cert
ssl_key
ssl_dh_parameters_length = 2048
</code></pre></div></div>

<div><div><pre><code>rcctl <span>enable </span>dovecot
rcctl start dovecot
</code></pre></div></div>

<h2 id="dkimproxy">DKIMProxy</h2>

<p>Sign the outgoing emails with DKIM or expect going to the spam folder…</p>



<p>File: <code>/etc/dkimproxy_out.conf</code></p>

<div><div><pre><code>listen    127.0.0.1:10027
relay     127.0.0.1:10028
domain    &lt;domain&gt;
signature dkim(c=relaxed)
keyfile   /etc/mail/private.key
selector  mail
</code></pre></div></div>

<p>Generate the private/public keys for DKIM:</p>

<div><div><pre><code><span>cd</span> /etc/mail
openssl genrsa <span>-out</span> private.key 2048
openssl rsa <span>-in</span> private.key <span>-pubout</span> <span>-out</span> public.key
</code></pre></div></div>

<div><div><pre><code>rcctl <span>enable </span>dkimproxy_out
rcctl start dkimproxy_out
</code></pre></div></div>

<h2 id="spamd">Spamd</h2>

<p>I don’t use it (yet).</p>

<p>ENJOY!</p>

<p>~Nico</p>

  </article>

</div>

      </div>
    </div></div>
  </body>
</html>
