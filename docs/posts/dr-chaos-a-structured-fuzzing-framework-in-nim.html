<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/status-im/nim-drchaos">Original</a>
    <h1>Dr. Chaos â€“ A structured fuzzing framework in Nim</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">A powerful and easy-to-use fuzzing framework in Nim for C/C++/Obj-C targets.</p>
<p dir="auto">Fuzzing is an automated bug finding technique, where randomized inputs are fed to a target
program in order to get it to crash. With fuzzing, you can increase your test coverage to
find edge cases and trigger bugs more effectively.</p>
<p dir="auto">Dr. Chaos extends the Nim interface to LLVM/Clang libFuzzer, an in-process,
coverage-guided, evolutionary fuzzing engine. And adds support for
<a href="https://github.com/google/fuzzing/blob/master/docs/structure-aware-fuzzing.md">structured fuzzing</a>.
The user should define the input type, as a parameter to the target function and the
fuzzer is responsible for providing valid inputs. Behind the scenes it uses value profiling
to guide the fuzzer past these comparisons much more efficiently than simply hoping to
stumble on the exact sequence of bytes by chance.</p>
<h2 dir="auto"><a id="user-content-usage" aria-hidden="true" href="#usage"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Usage</h2>
<p dir="auto">For most cases, it is fairly trivial to define a data type and a target function that
performs some operations and checks if the invariants expressed as assert conditions still
hold. Then call <code>defaultMutator</code> with that function as parameter. That can be as basic as
defining a range type and ensuring your library doesn&#39;t crash or complex as shown bellow.</p>
<h3 dir="auto"><a id="user-content-example" aria-hidden="true" href="#example"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Example</h3>
<p dir="auto">A simple but somewhat contrived example looks like this:</p>
<div data-snippet-clipboard-copy-content="import drchaos

type
  ContentNodeKind = enum
    P, Br, Text
  ContentNode = object
    case kind: ContentNodeKind
    of P: pChildren: seq[ContentNode]
    of Br: discard
    of Text: textStr: string

func `==`(a, b: ContentNode): bool =
  if a.kind != b.kind: return false
  case a.kind
  of P: return a.pChildren == b.pChildren
  of Br: return true
  of Text: return a.textStr == b.textStr

func fuzzTarget(x: ContentNode) =
  # Convert or translate `x` to any format (JSON, HMTL, binary, etc...)
  # and feed it to the API you are testing.

defaultMutator(fuzzTarget)"><pre><span>import</span> drchaos

<span>type</span>
  <span>ContentNodeKind</span> = <span>enum</span>
    P, <span>Br</span>, <span>Text</span>
  <span>ContentNode</span> = <span>object</span>
    <span>case</span> kind: <span>ContentNodeKind</span>
    <span>of</span> P: pChildren: <span>seq</span>[<span>ContentNode</span>]
    <span>of</span> <span>Br</span>: <span>discard</span>
    <span>of</span> <span>Text</span>: textStr: <span>string</span>

<span>func</span> <span>`==`</span>(a, b: <span>ContentNode</span>)<span>:</span> <span>bool</span> <span>=</span>
  <span>if</span> a.kind != b.kind: <span>return</span> <span>false</span>
  <span>case</span> a.kind
  <span>of</span> P: <span>return</span> a.pChildren == b.pChildren
  <span>of</span> <span>Br</span>: <span>return</span> <span>true</span>
  <span>of</span> <span>Text</span>: <span>return</span> a.textStr == b.textStr

<span>func</span> <span>fuzzTarget</span>(x: <span>ContentNode</span>) <span>=</span>
  <span><span># </span><span>Convert or translate `x` to any format (JSON, HMTL, binary, etc...)</span></span>
  <span><span># </span><span>and feed it to the API you are testing.</span></span>

<span>defaultMutator</span>(fuzzTarget)</pre></div>
<p dir="auto">Dr. Chaos will generate millions of inputs and run <code>fuzzTarget</code> under a few seconds.
More articulate examples, such as fuzzing a graph library are in the <code>examples/</code> directory.</p>
<p dir="auto">Defining a <code>==</code> proc for your input type is necessary.</p>
<h3 dir="auto"><a id="user-content-post-processors" aria-hidden="true" href="#post-processors"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Post-processors</h3>
<p dir="auto">Sometimes it is necessary to adjust the random input in order to add magic values or
dependencies between some fields. This is supported with a post-processing step, which for
performance and clarity reasons only runs on compound types such as
object/tuple/ref/seq/string/array/set and by exception distinct types.</p>
<div data-snippet-clipboard-copy-content="proc postProcess(x: var ContentNode; r: var Rand) =
  if x.kind == Text:
    x.textStr = &#34;The man the professor the student has studies Rome.&#34;"><pre><span>proc</span> <span>postProcess</span>(x: <span>var</span> <span>ContentNode</span>; r: <span>var</span> <span>Rand</span>) <span>=</span>
  <span>if</span> x.kind == <span>Text</span>:
    x.textStr = <span>&#34;The man the professor the student has studies Rome.&#34;</span></pre></div>
<h3 dir="auto"><a id="user-content-custom-mutator" aria-hidden="true" href="#custom-mutator"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Custom mutator</h3>
<p dir="auto">Besides <code>defaultMutator</code> there is also <code>customMutator</code> which allows more fine-grained
control of the mutation procedure, like uncompressing a <code>seq[byte]</code> then calling
<code>runMutator</code> on the raw data and compressing the output again.</p>
<div data-snippet-clipboard-copy-content="func myTarget(x: seq[byte]) =
  var data = uncompress(x)
  ...

proc myMutator(x: var seq[byte]; sizeIncreaseHint: Natural; r: var Rand) =
  var data = uncompress(x)
  runMutator(data, sizeIncreaseHint, r)
  x = compress(data)

customMutator(myTarget, myMutator)"><pre><span>func</span> <span>myTarget</span>(x: <span>seq</span>[<span>byte</span>]) <span>=</span>
  <span>var</span> data = <span>uncompress</span>(x)
  <span>...</span>

<span>proc</span> <span>myMutator</span>(x: <span>var</span> <span>seq</span>[<span>byte</span>]; sizeIncreaseHint: <span>Natural</span>; r: <span>var</span> <span>Rand</span>) <span>=</span>
  <span>var</span> data = <span>uncompress</span>(x)
  <span>runMutator</span>(data, sizeIncreaseHint, r)
  x = <span>compress</span>(data)

<span>customMutator</span>(myTarget, myMutator)</pre></div>
<h3 dir="auto"><a id="user-content-user-defined-mutate-procs" aria-hidden="true" href="#user-defined-mutate-procs"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>User-defined mutate procs</h3>
<p dir="auto">It&#39;s possible to use distinct types to provide a mutate overload for fields that have
interesting values, like file signatures or to limit the search space.</p>
<div data-snippet-clipboard-copy-content="# Fuzzed library
when defined(runFuzzTests):
  type
    ClientId = distinct int

  proc `==`(a, b: ClientId): bool {.borrow.}
else:
  type
    ClientId = int

# In a test file
import drchaos/mutator

const
  idA = 0.ClientId
  idB = 2.ClientId
  idC = 4.ClientId

proc mutate(value: var ClientId; sizeIncreaseHint: int; enforceChanges: bool; r: var Rand) =
  # use `rand()` to return a new value.
  repeatMutate(r.sample([idA, idB, idC]))"><pre><span><span># </span><span>Fuzzed library</span></span>
<span>when</span> <span>defined</span>(runFuzzTests)<span>:</span>
  <span>type</span>
    <span>ClientId</span> = <span>distinct</span> <span>int</span>

  <span>proc</span> <span>`==`</span>(a, b: <span>ClientId</span>)<span>:</span> <span>bool</span> {.<span>borrow</span>.}
<span>else</span>:
  <span>type</span>
    <span>ClientId</span> <span>=</span> <span>int</span>

<span><span># </span><span>In a test file</span></span>
<span>import</span> drchaos/mutator

<span>const</span>
  idA = <span>0</span>.<span>ClientId</span>
  idB = <span>2</span>.<span>ClientId</span>
  idC = <span>4</span>.<span>ClientId</span>

<span>proc</span> <span>mutate</span>(value: <span>var</span> <span>ClientId</span>; sizeIncreaseHint: <span>int</span>; enforceChanges: <span>bool</span>; r: <span>var</span> <span>Rand</span>) <span>=</span>
  <span><span># </span><span>use `rand()` to return a new value.</span></span>
  <span>repeatMutate</span>(r.<span>sample</span>([idA, idB, idC]))</pre></div>
<p dir="auto">For aiding the creation of mutate functions, mutators for every supported type are
exported by <code>drchaos/mutator</code>.</p>
<h2 dir="auto"><a id="user-content-whats-not-supported" aria-hidden="true" href="#whats-not-supported"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>What&#39;s not supported</h2>
<ul dir="auto">
<li>Polymorphic types, missing serialization support.</li>
<li>References with cycles. A <code>.noFuzz</code> custom pragma will be added soon for cursors.</li>
</ul>
<h2 dir="auto"><a id="user-content-license" aria-hidden="true" href="#license"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>License</h2>
<p dir="auto">Licensed and distributed under either of</p>
<ul dir="auto">
<li>MIT license: <a href="https://donnywinston.com/status-im/nim-drchaos/blob/master/LICENSE-MIT">LICENSE-MIT</a> or <a href="http://opensource.org/licenses/MIT" rel="nofollow">http://opensource.org/licenses/MIT</a></li>
</ul>
<p dir="auto">or</p>
<ul dir="auto">
<li>Apache License, Version 2.0, (<a href="https://donnywinston.com/status-im/nim-drchaos/blob/master/LICENSE-APACHEv2">LICENSE-APACHEv2</a> or <a href="http://www.apache.org/licenses/LICENSE-2.0" rel="nofollow">http://www.apache.org/licenses/LICENSE-2.0</a>)</li>
</ul>
<p dir="auto">at your option. These files may not be copied, modified, or distributed except according to those terms.</p>
</article>
          </div></div>
  </body>
</html>
