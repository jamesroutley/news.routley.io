<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/supabase/pg_jsonschema">Original</a>
    <h1>Show HN: Pg_jsonschema â€“ A Postgres extension for JSON validation</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">
<a href="https://raphlinus.github.io/supabase/pg_jsonschema/blob/master"><img src="https://camo.githubusercontent.com/658e9bc1bee735c69711908baa07bc300cf9834fbab12ad6346007bf496c8488/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f706f737467726573716c2d31322b2d626c75652e737667" alt="PostgreSQL version" height="18" data-canonical-src="https://img.shields.io/badge/postgresql-12+-blue.svg"/></a>
<a href="https://github.com/supabase/pg_jsonschema/blob/master/LICENSE"><img src="https://camo.githubusercontent.com/a372d105f94cb79db5e3b8e90c86860fb3d5ce5fbf9dfdb6edc310e1dedd53c3/68747470733a2f2f696d672e736869656c64732e696f2f707970692f6c2f6d61726b646f776e2d73756274656d706c6174652e737667" alt="License" height="18" data-canonical-src="https://img.shields.io/pypi/l/markdown-subtemplate.svg"/></a>
</p>
<hr/>
<p dir="auto"><strong>Source Code</strong>: <a href="https://github.com/supabase/pg_jsonschema"></a><a href="https://github.com/supabase/pg_jsonschema">https://github.com/supabase/pg_jsonschema</a></p>
<hr/>
<h2 dir="auto"><a id="user-content-summary" aria-hidden="true" href="#summary"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Summary</h2>
<p dir="auto"><code>pg_jsonschema</code> is a PostgreSQL extension adding support for <a href="https://json-schema.org/" rel="nofollow">JSON schema</a> validation on <code>json</code> and <code>jsonb</code> data types.</p>
<h2 dir="auto"><a id="user-content-api" aria-hidden="true" href="#api"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>API</h2>
<p dir="auto">SQL functions:</p>
<div data-snippet-clipboard-copy-content="-- Validates a json *instance* against a *schema*
json_matches_schema(schema json, instance json) returns bool"><pre><span><span>--</span> Validates a json *instance* against a *schema*</span>
json_matches_schema(schema json, instance json) returns bool</pre></div>
<p dir="auto">and</p>
<div data-snippet-clipboard-copy-content="-- Validates a jsonb *instance* against a *schema*
jsonb_matches_schema(schema json, instance jsonb) returns bool"><pre><span><span>--</span> Validates a jsonb *instance* against a *schema*</span>
jsonb_matches_schema(schema json, instance jsonb) returns bool</pre></div>
<h2 dir="auto"><a id="user-content-usage" aria-hidden="true" href="#usage"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Usage</h2>
<p dir="auto">Those functions can be used to constrain <code>json</code> and <code>jsonb</code> columns to conform to a schema.</p>
<p dir="auto">For example:</p>
<div data-snippet-clipboard-copy-content="create extension pg_jsonschema;

create table customer(
    id serial primary key,
    ...
    metadata json,

    check (
        json_matches_schema(
            &#39;{
                &#34;type&#34;: &#34;object&#34;,
                &#34;properties&#34;: {
                    &#34;tags&#34;: {
                        &#34;type&#34;: &#34;array&#34;,
                        &#34;items&#34;: {
                            &#34;type&#34;: &#34;string&#34;,
                            &#34;maxLength&#34;: 16
                        }
                    }
                }
            }&#39;,
            metadata
        )
    )
);

-- Example: Valid Payload
insert into customer(metadata)
values (&#39;{&#34;tags&#34;: [&#34;vip&#34;, &#34;darkmode-ui&#34;]}&#39;);
-- Result:
--   INSERT 0 1

-- Example: Invalid Payload
insert into customer(metadata)
values (&#39;{&#34;tags&#34;: [1, 3]}&#39;);
-- Result:
--   ERROR:  new row for relation &#34;customer&#34; violates check constraint &#34;customer_metadata_check&#34;
--   DETAIL:  Failing row contains (2, {&#34;tags&#34;: [1, 3]})."><pre>create extension pg_jsonschema;

<span>create</span> <span>table</span> <span>customer</span>(
    id <span>serial</span> <span>primary key</span>,
    ...
    metadata json,

    <span>check</span> (
        json_matches_schema(
            <span><span>&#39;</span>{</span>
<span>                &#34;type&#34;: &#34;object&#34;,</span>
<span>                &#34;properties&#34;: {</span>
<span>                    &#34;tags&#34;: {</span>
<span>                        &#34;type&#34;: &#34;array&#34;,</span>
<span>                        &#34;items&#34;: {</span>
<span>                            &#34;type&#34;: &#34;string&#34;,</span>
<span>                            &#34;maxLength&#34;: 16</span>
<span>                        }</span>
<span>                    }</span>
<span>                }</span>
<span>            }<span>&#39;</span></span>,
            metadata
        )
    )
);

<span><span>--</span> Example: Valid Payload</span>
<span>insert into</span> customer(metadata)
<span>values</span> (<span><span>&#39;</span>{&#34;tags&#34;: [&#34;vip&#34;, &#34;darkmode-ui&#34;]}<span>&#39;</span></span>);
<span><span>--</span> Result:</span>
<span><span>--</span>   INSERT 0 1</span>

<span><span>--</span> Example: Invalid Payload</span>
<span>insert into</span> customer(metadata)
<span>values</span> (<span><span>&#39;</span>{&#34;tags&#34;: [1, 3]}<span>&#39;</span></span>);
<span><span>--</span> Result:</span>
<span><span>--</span>   ERROR:  new row for relation &#34;customer&#34; violates check constraint &#34;customer_metadata_check&#34;</span>
<span><span>--</span>   DETAIL:  Failing row contains (2, {&#34;tags&#34;: [1, 3]}).</span></pre></div>
<h2 dir="auto"><a id="user-content-installation" aria-hidden="true" href="#installation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Installation</h2>
<p dir="auto">Requires:</p>
<ul dir="auto">
<li><a href="https://github.com/tcdi/pgx">pgx</a></li>
</ul>

<p dir="auto">which drops into a psql prompt.</p>
<div data-snippet-clipboard-copy-content="psql (13.6)
Type &#34;help&#34; for help.

pg_jsonschema=# create extension pg_jsonschema;
CREATE EXTENSION

pg_jsonschema=# select json_matches_schema(&#39;{&#34;type&#34;: &#34;object&#34;}&#39;, &#39;{}&#39;);
 json_matches_schema 
---------------------
 t
(1 row)"><pre lang="psql"><code>psql (13.6)
Type &#34;help&#34; for help.

pg_jsonschema=# create extension pg_jsonschema;
CREATE EXTENSION

pg_jsonschema=# select json_matches_schema(&#39;{&#34;type&#34;: &#34;object&#34;}&#39;, &#39;{}&#39;);
 json_matches_schema 
---------------------
 t
(1 row)
</code></pre></div>
<p dir="auto">for more complete installation guidelines see the <a href="https://github.com/tcdi/pgx">pgx</a> docs.</p>
<h2 dir="auto"><a id="user-content-prior-art" aria-hidden="true" href="#prior-art"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Prior Art</h2>
<p dir="auto"><a href="https://github.com/gavinwahl/postgres-json-schema">postgres-json-schema</a> - an implementation of JSON Schema for Postgres written in PL/pgSQL</p>
<h2 dir="auto"><a id="user-content-benchmark" aria-hidden="true" href="#benchmark"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Benchmark</h2>
<h4 dir="auto"><a id="user-content-system" aria-hidden="true" href="#system"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>System</h4>
<ul dir="auto">
<li>2021 MacBook Pro M1 Max (32GB)</li>
<li>macOS 12.4</li>
<li>PostgreSQL 14.1</li>
</ul>
<h3 dir="auto"><a id="user-content-setup" aria-hidden="true" href="#setup"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Setup</h3>
<p dir="auto">Validating the following schema on 20k unique inserts</p>
<div data-snippet-clipboard-copy-content="{
    &#34;type&#34;: &#34;object&#34;,
    &#34;properties&#34;: {
        &#34;a&#34;: {&#34;type&#34;: &#34;number&#34;},
        &#34;b&#34;: {&#34;type&#34;: &#34;string&#34;}
    }
}"><pre>{
    <span>&#34;type&#34;</span>: <span><span>&#34;</span>object<span>&#34;</span></span>,
    <span>&#34;properties&#34;</span>: {
        <span>&#34;a&#34;</span>: {<span>&#34;type&#34;</span>: <span><span>&#34;</span>number<span>&#34;</span></span>},
        <span>&#34;b&#34;</span>: {<span>&#34;type&#34;</span>: <span><span>&#34;</span>string<span>&#34;</span></span>}
    }
}</pre></div>
<div data-snippet-clipboard-copy-content="create table bench_test_pg_jsonschema(
    meta jsonb,
    check (
        jsonb_matches_schema(
            &#39;{&#34;type&#34;: &#34;object&#34;, &#34;properties&#34;: {&#34;a&#34;: {&#34;type&#34;: &#34;number&#34;}, &#34;b&#34;: {&#34;type&#34;: &#34;string&#34;}}}&#39;,
            meta
        )
    )
);

insert into bench_test_pg_jsonschema(meta)
select
    json_build_object(
        &#39;a&#39;, i,
        &#39;b&#39;, i::text
    )
from
    generate_series(1, 200000) t(i);
-- Query Completed in 2.18 seconds "><pre><span>create</span> <span>table</span> <span>bench_test_pg_jsonschema</span>(
    meta jsonb,
    <span>check</span> (
        jsonb_matches_schema(
            <span><span>&#39;</span>{&#34;type&#34;: &#34;object&#34;, &#34;properties&#34;: {&#34;a&#34;: {&#34;type&#34;: &#34;number&#34;}, &#34;b&#34;: {&#34;type&#34;: &#34;string&#34;}}}<span>&#39;</span></span>,
            meta
        )
    )
);

<span>insert into</span> bench_test_pg_jsonschema(meta)
<span>select</span>
    json_build_object(
        <span><span>&#39;</span>a<span>&#39;</span></span>, i,
        <span><span>&#39;</span>b<span>&#39;</span></span>, i::<span>text</span>
    )
<span>from</span>
    generate_series(<span>1</span>, <span>200000</span>) t(i);
<span><span>--</span> Query Completed in 2.18 seconds </span></pre></div>
<p dir="auto">for comparison, the equivalent test using postgres-json-schema&#39;s <code>validate_json_schema</code> function ran in 5.54 seconds. pg_jsonschema&#39;s ~2.5x speedup on this example JSON schema grows quickly as the schema becomes more complex.</p>
</article>
          </div></div>
  </body>
</html>
