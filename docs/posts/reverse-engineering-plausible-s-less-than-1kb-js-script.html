<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://vishnubharathi.codes/blog/reverse-engineering-plausible-less-than-1kb-js-script/">Original</a>
    <h1>Reverse engineering Plausible&#39;s less than 1kb JS script</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody">
    <p>‚ö†Ô∏è oops, I published this blog post by mistake before completing it üòÖ LOL - I am not sure how to unpublish this now :D so I am going to leave this as it is and remove this warning line once the post is complete. ‚ö†Ô∏è</p>
<p><a target="_blank" rel="noopener" href="https://plausible.io/">Plausible</a> is ‚ÄúSimple and privacy-friendly Google Analytics alternative‚Äù. It is an open-source software. While trying to self-host it, I arrived at <a target="_blank" rel="noopener" href="https://plausible.io/lightweight-web-analytics">a page</a> which talks about their less than 1kb analytics script. It got me curious about what would be inside it ü§î</p>
<p>So, here we go. Let us start to understand this from scratch.</p>
<h2 id="Adding-the-script"><a href="#Adding-the-script" title="Adding the script"></a>Adding the script</h2><p>When you want to enable Plausible analytics for your website, it seems like you would start by adding this little snippet to your website.</p>
<figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span><span>&lt;<span>script</span> <span>defer</span> <span>data-domain</span>=<span>&#34;domain.com&#34;</span></span></span></pre></td></tr></tbody></table></figure>
<ul>
<li><code>script</code> tag is used to load JavaScript on the webpage.</li>
<li><code>src</code> is the web address to the contents of the JavaScript.</li>
</ul>
<p>Bigger question here is, ‚Äúwhat does <code>defer</code> and <code>data-domain</code> do?‚Äù</p>
<p>Reading through the MDN docs, I learnt that the browser would defer the execution of the JS script to a time when all of the HTML is loaded and parsed. That means all the HTML tags from <code>&lt;html&gt;....&lt;/html&gt;</code> would be present when the script gets executed.</p>
<p>More specfically, it seems like the script would get eexecuted before the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Document/DOMContentLoaded_event">DOMContentLoaded event</a>. This event waits only for the loading and parsing of HTML and does not wait for other things like stylesheets, images, etc. The more common <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/load_event">load</a> seem to be responsible for catching the occurence of loading the HTML document and all its dependencies like the stylesheets, images, etc.</p>
<p>Okay, so this way the script doesn‚Äôt immediately try to load and block things and it waits for at-least a skeleton of HTML to load.</p>
<p>Regarding the <code>data-domain</code> part, I can‚Äôt seem to find references of it in the MDN docs for the script tag. So it is not an in-built attribute of the <code>script</code> tag. I think it might be a way of passing data from HTML to the JS script. Let us continue and see where this leads us.</p>
<h2 id="The-script"><a href="#The-script" title="The script"></a>The script</h2><p>This is the entire script.</p>
<figure><table><tbody><tr><td><pre><span>1</span><br/></pre></td><td><pre><span>!<span><span>function</span>(<span></span>)</span>{<span>&#34;use strict&#34;</span>;<span>var</span> a=<span>window</span>.location,r=<span>window</span>.document,o=r.currentScript,s=o.getAttribute(<span>&#34;data-api&#34;</span>)||<span>new</span> URL(o.src).origin+<span>&#34;/api/event&#34;</span>;<span><span>function</span> <span>l</span>(<span>t</span>)</span>{<span>console</span>.warn(<span>&#34;Ignoring Event: &#34;</span>+t)}<span><span>function</span> <span>t</span>(<span>t,e</span>)</span>{<span>if</span>(<span>/^localhost$|^127(\.[0-9]+){0,2}\.[0-9]+$|^\[::1?\]$/</span>.test(a.hostname)||<span>&#34;file:&#34;</span>===a.protocol)<span>return</span> l(<span>&#34;localhost&#34;</span>);<span>if</span>(!(<span>window</span>._phantom||<span>window</span>.__nightmare||<span>window</span>.navigator.webdriver||<span>window</span>.Cypress)){<span>try</span>{<span>if</span>(<span>&#34;true&#34;</span>===<span>window</span>.localStorage.plausible_ignore)<span>return</span> l(<span>&#34;localStorage flag&#34;</span>)}<span>catch</span>(t){}<span>var</span> i={};i.n=t,i.u=a.href,i.d=o.getAttribute(<span>&#34;data-domain&#34;</span>),i.r=r.referrer||<span>null</span>,i.w=<span>window</span>.innerWidth,e&amp;&amp;e.meta&amp;&amp;(i.m=<span>JSON</span>.stringify(e.meta)),e&amp;&amp;e.props&amp;&amp;(i.p=e.props);<span>var</span> n=<span>new</span> XMLHttpRequest;n.open(<span>&#34;POST&#34;</span>,s,!<span>0</span>),n.setRequestHeader(<span>&#34;Content-Type&#34;</span>,<span>&#34;text/plain&#34;</span>),n.send(<span>JSON</span>.stringify(i)),n.onreadystatechange=<span><span>function</span>(<span></span>)</span>{<span>4</span>===n.readyState&amp;&amp;e&amp;&amp;e.callback&amp;&amp;e.callback()}}}<span>var</span> e=<span>window</span>.plausible&amp;&amp;<span>window</span>.plausible.q||[];<span>window</span>.plausible=t;<span>for</span>(<span>var</span> i,n=<span>0</span>;n&lt;e.length;n++)t.apply(<span>this</span>,e[n]);<span><span>function</span> <span>p</span>(<span></span>)</span>{i!==a.pathname&amp;&amp;(i=a.pathname,t(<span>&#34;pageview&#34;</span>))}<span>var</span> w,d=<span>window</span>.history;d.pushState&amp;&amp;(w=d.pushState,d.pushState=<span><span>function</span>(<span></span>)</span>{w.apply(<span>this</span>,<span>arguments</span>),p()},<span>window</span>.addEventListener(<span>&#34;popstate&#34;</span>,p)),<span>&#34;prerender&#34;</span>===r.visibilityState?r.addEventListener(<span>&#34;visibilitychange&#34;</span>,<span><span>function</span>(<span></span>)</span>{i||<span>&#34;visible&#34;</span>!==r.visibilityState||p()}):p()}();</span><br/></pre></td></tr></tbody></table></figure>
<p>Feels small. Let me try to get some line breaks to make it more readable.</p>
<p>oh wait! Plausible is an Open Source Software. That means, I can try to get the source code of the un-minified version of the above code.</p>
<p>Going to the plausible <a target="_blank" rel="noopener" href="https://github.com/plausible/analytics">github repo</a>, pressing ‚Äút‚Äù and typing ‚Äúplausible.js‚Äù landed me to the file that is in need: <a target="_blank" rel="noopener" href="https://github.com/plausible/analytics/blob/1772ddff17f5c2880400f7f7c42d7c1aa772feef/tracker/src/plausible.js">https://github.com/plausible/analytics/blob/1772ddff17f5c2880400f7f7c42d7c1aa772feef/tracker/src/plausible.js</a></p>
<p>Let us start reading the code now!</p>
<h2 id="The-code"><a href="#The-code" title="The code"></a>The code</h2><p>The script starts with a good old immediately invoked anonymous function and <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Strict_mode">‚Äòuse strict‚Äô notation</a>.</p>
<figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span>(<span><span>function</span>(<span></span>)</span>{</span></pre></td></tr></tbody></table></figure>
<p>After that some variables and functions are getting defined.</p>
<figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span><span>var</span> location = <span>window</span>.location</span></pre></td></tr></tbody></table></figure>
<p><code>location</code> and <code>document</code> are okay - probably defined to avoid typing <code>window</code> repeatedly. <code>{{#if compat}}</code> seems like a server-renered template language notation. They are using it to get a reference to the script element which is executing the plausible script. After that <code>endpoint</code> variable is set by picking the <code>data-api</code> if it is present on the script tag or by calling a function called <code>defaultEndpoint</code>.</p>
<p>Since the script tag doesn‚Äôt have the <code>data-api</code> attribute, let us look at what <code>defaultEndpoint</code> function does.</p>
<figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span><span><span>function</span> <span>defaultEndpoint</span>(<span>el</span>) </span>{</span></pre></td></tr></tbody></table></figure>
<p>At this point, I am guessing <code>compat</code> is for compatibility with old browsers. For now, my browser us comfortable using the <code>else</code> block. So, let us zoom on to that. It returns <code>new URL(el.src).origin + &#39;/api/event&#39;</code>. That means, it takes the script element‚Äôs src attribute and forms a new URL object and get‚Äôs the origin property.</p>
<figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span>&gt; new URL(&#34;https://plausible.io/js/script.js&#34;).origin</span></pre></td></tr></tbody></table></figure>
<p>Moving on. There is this little <code>warn</code> function that is bugging myself to paste it here.</p>
<figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span><span><span>function</span> <span>warn</span>(<span>reason</span>) </span>{</span></pre></td></tr></tbody></table></figure>
<p>I cleaned up all the server-side rendered templates to make code folding work for the script :D With that, we are entering the real action.</p>
<figure><table><tbody><tr><td><pre><span>1</span><br/></pre></td><td><pre><span><span>var</span> queue = (<span>window</span>.plausible &amp;&amp; <span>window</span>.plausible.q) || []</span><br/></pre></td></tr></tbody></table></figure>
<p>So, we are creating a queue which hopefully is getting saved in <code>window.plausible.q</code> object further down the lane.</p>
<figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span><span>window</span>.plausible = trigger</span></pre></td></tr></tbody></table></figure>
<p><code>trigger</code> is a big function and is getting assigned to <code>window.plausible</code>. After that, we call <code>trigger</code> function for every element in the queue. Initially, the queue will be empty, so I am going to see what is happening when that is the case.</p>
<p>Now there is a divide happening.<br/></p><figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span>{{#<span>if</span> hash}}</span></pre></td></tr></tbody></table></figure></div></div>
  </body>
</html>
