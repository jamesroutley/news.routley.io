<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.benjojo.co.uk/post/multipath-without-mptcp">Original</a>
    <h1>Going multipath without Multipath TCP</h1>
    
    <div id="readability-page-1" class="page"><div>
<h3>Feb 24 2022</h3>

<p><img src="https://blog.benjojo.co.uk/asset/9YYyTX5q2s" alt="title card"/></p>
<p>Gigabit ethernet has been around for a long time, it’s so ubiquitous that there is a very strong chance that if you have a RJ-45 port on your computer, it’s going to be a gigabit ethernet network interface.</p>
<p>Even if you look at computers that are over 20 years old, the only thing that stands out on their spec sheets as still being current is gigabit ethernet.</p>
<p><a href="https://twitter.com/pencoyd/status/1013222685151657985"><img src="https://blog.benjojo.co.uk/asset/qla6Pdw72a" alt="old mac pro"/></a></p>
<p>However, gigabit ethernet (1GBE) sometimes is just not enough these days. Gigabit residential internet access is becoming more and more common, and while most of those consumers are using WiFi and <a href="https://legacy.netdevconf.info/1.1/proceedings/slides/pennarun-google-fiber-wifi-data.pdf">are unlikely to ever get the gigabit performance</a> they were likely expecting. A wired connection could easily max out the internet and LAN link.</p>
<p>10 Gigabit ethernet (10GBE) is creeping into the consumer market slowly, notably <a href="https://www.servethehome.com/apple-mac-mini-m1-10gbe-gets-10gbase-t/">apple products have been shipping with 10 gigabit ethernet for a while now</a> but it’s still rare to find people with 10 gigabit ethernet switches.</p>
<p>Most of the reason I suspect the consumer ethernet speeds have not improved in the last 20 years is that for the most part, it’s already fast enough. However things like storage have sped up remarkably now with not only faster disks (the average SATA hard disk will run at around 2.5 gigabits) but flash storage has given us single drive speeds of 6 gigabits, more if you look at <a href="https://en.wikipedia.org/wiki/NVM_Express">NVMe</a> (<a href="https://blog.benjojo.co.uk/asset/hSVi20NZFg">mine can read at nearly 20 gigabits</a>). But when you look at what we can send to other computers (think remote storage like NAS’es) then we can quickly get limited by 1GBE.</p>
<p>Servers are a different story, while there are still a considerable number of servers still running on 1GBE, 10GBE and 25GBE (or faster!) are used for anything bandwidth intensive, since the network can quickly become the major bottleneck when faced with large compute power and storage capacity.</p>
<h2>Enter Link Aggregation</h2>
<p>However single 10GBE and 25GBE links are not always what you want. What if you want more bandwidth? What if the switch you are attached to needs a software upgrade or crashes? For this reason, a lot of the NICs for servers have two physical ports that are connected to the same switch (for a bandwidth increase) or different switches (for redundancy/failover).</p>
<p>But how do systems make use of multiple ethernet links? They program their switches and the servers to use <a href="https://en.wikipedia.org/wiki/Link_aggregation">Link aggregation (LAG)</a>. Link aggregation means that both links share a single IP and MAC address, and requires the switch and system (at least in the commonly deployed 802.3ad standard) to change their behaviour. Link aggregation goes by different names depending on the vendors you are configuring it on, names include; Aggregate Interfaces, NIC Teaming, Port Channels, and Bond’s. The last one causing <a href="https://blog.cloudflare.com/how-the-cloudflare-team-got-into-bondage-its/">amusing blog titles from time to time</a> <a href="https://web.archive.org/web/20210808222319/https://blog.cloudflare.com/how-the-cloudflare-team-got-into-bondage-its/">(A)</a></p>
<p>However, Link aggregation does not directly cause performance increases for single connections. This is because the OS and network layer typically directs a connection down a single ethernet link at a time. Since TCP and other protocols that do <a href="https://en.wikipedia.org/wiki/TCP_congestion_control">congestion control</a> could become confused when they are presented with inconsistent performance feedback (as different links have different capacities and latencies). While a 2x10GBE may mean that you have 20 gigabits of bandwidth available to you, a single TCP connection will only run at 10 gigabits due to the connection directing/hashing logic.</p>
<h2>Need for (single connection) speed</h2>
<p><img src="https://blog.benjojo.co.uk/asset/8SyUbbfcE2" alt="LTO 6 drive"/></p>
<p>In a previous post <a href="https://blog.benjojo.co.uk/post/lto-tape-backups-for-linux-nerds">I talked about LTO Tape backups</a> and how that drives themselves could read/write than a standard gigabit ethernet link, and that 10 gigabit networking is recommended if you are streaming data to a tape over the network to avoid issues.</p>
<p>Sadly, in my case the machine that held the SAS card required for running the tape drive consumed the last PCIe slot that could have held a 10GBE network card. Even though the systems feeding the PC hosting the tape drive were on 10GBE. This meant that my tape backups were far slower (and stalling on <a href="https://www.freebsd.org/cgi/man.cgi?query=mbuffer&amp;sektion=1&amp;apropos=0&amp;manpath=FreeBSD+9.0-RELEASE+and+Ports">mbuffer</a>) than was needed.</p>
<p>But what I did have was USB 3.0 ports, and where there are USB 3 ports there is the option to use USB gigabit ethernet dongles.</p>
<p>The issue comes however in that while I could have set the motherboard and the USB NIC into a LAG, that would not have improved the speed of my single TCP connection feeding the tape drive (via <a href="https://www.freebsd.org/cgi/man.cgi?query=mbuffer&amp;sektion=1&amp;apropos=0&amp;manpath=FreeBSD+9.0-RELEASE+and+Ports">mbuffer</a>).</p>
<p>I really needed a way to combine the throughput of both NICs into one 2gbit/s stream.</p>
<h2>Going multipath <em>with</em> MPTCP</h2>
<p><img src="https://blog.benjojo.co.uk/asset/sEZ5PoMchS" alt="MPTCP Wireshark"/></p>
<p>Multipath TCP (MPTCP) or <a href="https://datatracker.ietf.org/doc/html/rfc8684">RFC8684</a> is an extension that allows a single TCP socket to span across multiple IP addresses and network interfaces.</p>
<p>This extension is currently used sparsely, with the only two commonly deployed uses being the <a href="https://www.openmptcprouter.com/">OpenMTCPRouter Project</a> and <a href="https://en.wikipedia.org/wiki/Siri">Apple’s Siri</a></p>
<p>OpenMTCPRouter uses MPTCP to proxy/tunnel connections for better throughput, allowing you to chain multiple residential connections into one faster link to a proxy server, while Siri uses it to handle rapid failover between WiFi and Cellular to ensure the best experience when using the voice assistant.</p>
<p>MPTCP was merged into the Linux kernel in 5.6, however I do not know of any mainstream distributions that have it present and enabled. Ubuntu 20.10 ships with MPTCP on it’s 5.13 kernel, while Debian Bullseye uses 5.10 but has MPTCP disabled.</p>
<pre><code>$ cat /boot/config-5.10.0-11-amd64 | grep MPTC
# CONFIG_MPTCP is not set
</code></pre>
<p>Outside of having MPTCP support available in your OS. I have found the MPTCP usability story… Bad? It feels really bad to say this against something but my own research into MPTCP has been maddening.</p>
<p>This post was written on Feb 24th 2022, The situation may have changed by the time you have read this</p>
<p>Since MPTCP is now shipping in mainline Linux, the <a href="https://www.multipath-tcp.org/">actual project website</a> itself appears to have not kept up, the docs on the site sent me down wild goose chases only to find that the things written down are not supported anymore, or maybe I just have not found any way to do the things they have documented. I may just honestly be stupid with this, but I found the best living documentation to be <a href="https://github.com/torvalds/linux/tree/master/tools/testing/selftests/net/mptcp">the kernel tests for MPTCP</a> since they by definition have to reflect the current API for MPTCP.</p>
<p>I think in general a lot of the pain that comes with this is that MPTCP is designed to automatically detect and begin multipathing traffic in a way where the user space has its hands off the details of the connection.</p>
<p>Because of this, I could not find a way to tell the kernel from user space (ignoring netlink etc) about multiple endpoints for a host, for this reason I gave up my attempt to write a mptcp client tool.</p>
<h2>DIY Multipath TCP</h2>
<p>Not satisfied with MPTCP I figured that an entirely userspace version of this concept is possible, and in fact someone I was doing contract work with at the time <a href="https://github.com/getlantern/multipath">had a library</a> that appeared to be able to “bond” together multiple connections. Upon trying to get it working however I found that the library did not achieve speed improvements, and failover behaviour was unpredictable at best.</p>
<p>So I worked on making sure it could, overhauling the library and pushing fixes to it. Once it worked enough to the point where I was making decisions that could break the library. I made my own fork to contain the behaviour changes.</p>
<p>The <code>multipath</code> go library is actually quite an involved bit of machinery. Because while MPTCP has raw packet access to do things with retries and subflow sorting, <code>multipath</code> does not. It takes what is basically an array of <code>net.Conn</code>’s and teams them together for bandwidth and resilience. This means that anything that conforms to <a href="https://pkg.go.dev/net#Conn"><code>net.Conn</code></a> in go and is an ordered reliable stream (Like for example, WebSockets, TLS connections, SCTP in some modes, etc) can be used in this library all combined!</p>
<p>Due to the usage of TCP-like sockets, the performance will never be as good as if you wrote this using UDP yourself but given that is the way the multipath library started, I was determined to keep it that way even after I forked it.</p>
<p>Now that I had the library working though, I still needed a tool that wrapped it for day to day use…</p>
<h2>Introducing bondcat</h2>
<p><img src="https://blog.benjojo.co.uk/asset/Ox4IxmbxdN" alt="bondcat mascot"/></p>
<p>To wrap this all together I made a new utility. <code>bondcat</code>.</p>
<p>Bondcat has a user interface inspired by <a href="https://man7.org/linux/man-pages/man1/ncat.1.html"><code>ncat</code></a> but accepts the ability to connect to a host on multiple IP address/port combos. This means that with some knowledge on address selection (see below) you can easily and in a cross platform way beat the limits of single gigabit ethernet speeds.</p>
<p>I mention gigabit ethernet in particular because as far as I’ve managed I’ve not attempted to optimise the multipath library in going faster than 10 gigabit/s. This is because at that stage there are likely better options for moving very large amounts of data over very fast LAG’d networks, for example <a href="https://en.wikipedia.org/wiki/GridFTP">GridFTP</a>.</p>
<p>But since it acts like netcat/ncat then you can easily wrap connections over it, for example you could use <a href="https://man.openbsd.org/ssh_config.5#ProxyCommand">OpenSSH’s ProxyCommand</a> to obtain faster than gigabit SFTP/SCP transfers:</p>
<pre><code>[11:13:24] ben@metropolis:~$ cat .ssh/config 
Host tapedrive
  ControlMaster no
  ProxyCommand bondcat 192.168.XXX.XXX:2222 192.168.XXX.XXX:2222
</code></pre>
<p>For the listening side, bondcat includes a <code>-relay</code> mode that accepts connections and forwards the data to another tcp endpoint. Meaning to make this ssh setup work we can point the relay mode to</p>
<pre><code>$ bondcat -relay 127.0.0.1:22 -l -p 2222
</code></pre>
<p>If that is not your usage style, you can always just use it as a regular netcat to send stuff around:</p>
<p><img src="https://blog.benjojo.co.uk/asset/ZUeC6Bs501" alt="netcat bondcat"/></p>
<p>Now there are some considerations to be made for bondcat, since MPTCP has a far better idea of your network stack that bondcat can ever do (after all, the library doing the magic just sees a bunch of connections, nothing more) you need to be careful on what addresses you select for your use case:</p>
<h3>Use Case: Going over the internet or trying to escape the limits of LAG bundles</h3>
<p>This use is simple, you just need to invoke it as you would a normal netcat (single address) and use the <code>-multiplier</code> flag for how many extra connections you want to start. This flag also works with other addresses if you want to mix the hosts IPv4 and IPv6 addresses.</p>
<h3>Use Case: Faster LAN transfers</h3>
<p>I find it’s easiest to target IPv6 addresses for LAN’s. But that is all assuming that the LAN you are on has Router Advertisements. Assuming it does then it’s the best option. If not then the local IPv4 address normally works fine.</p>
<p>However this will generally only work in the 10GBE-&gt;{n}x1GBE setup. Bondcat by default tries to connect with every IP address on the machine to aid automatic speed boosts. To help this “automagically” work it’s best to start the connections from the machine that has the most interfaces. This function can be disabled with <code>-a or -no-auto-detect</code></p>
<h3>Use Case: Backup link failover</h3>
<p>Assuming the system you are on has two links, you will need to manually add a route for one of the endpoints to go over your backup link. Other than that, it should transparently work.</p>
<hr/>
<p>You can pick up a copy of bondcat on github: <a href="https://github.com/benjojo/bondcat">https://github.com/benjojo/bondcat</a></p>
<p>I found it very useful for streaming backups to my tape drive, and I’m sure the library itself (the forked version is in the same code repo) would find uses outside of bondcat. However I assume as MPTCP gets better and more supported (with any luck) the tool will slowly become obsolete.</p>
<p>If you want to stay up to date with the blog you can use the <a href="https://blog.benjojo.co.uk/rss.xml">RSS feed</a> or you can follow me on <a href="https://twitter.com/Benjojo12">Twitter</a></p>
<p>Also, I’m currently looking for work from March onwards. If you like what I do or think that you could do with some of my bizarre areas of knowledge, please contact me over at workwith@benjojo.co.uk!</p>
<p>Until next time!</p>

</div></div>
  </body>
</html>
