<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://developer.mozilla.org/en-US/docs/Web/API/Topics_API/Using">Original</a>
    <h1>Using the Topics API (Chrome Only, Opposed by Firefox/Safari)</h1>
    
    <div id="readability-page-1" class="page"><article lang="en-US"><header></header><div><p><strong>Warning:</strong> This feature is currently opposed by two browser vendors. See the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Topics_API#standards_positions">Standards positions</a> section below for details of opposition.</p>
<p><strong>Note:</strong> An <a href="https://developer.mozilla.org/en-US/docs/Web/Privacy/Privacy_sandbox/Enrollment">Enrollment process</a> is required to use the Topics API in your applications. See the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Topics_API#enrollment">Enrollment</a> section for details of what sub-features are gated by enrollment.</p>
<p>This page explains how the Topics API works and how it can be used to create an <strong>interest-based advertising (IBA)</strong> solution.</p></div><section aria-labelledby="high-level_overview"><h2 id="high-level_overview"><a href="#high-level_overview">High-level overview</a></h2><div><p>Let&#39;s say we&#39;ve got an ad tech platform, <code>ad-tech1.example</code>, which is embedding ads via <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe"><code>&lt;iframe&gt;</code></a>s into the following publisher sites:</p>
<ul>
  <li><code>yoga.example</code></li>
  <li><code>knitting.example</code></li>
  <li><code>football.example</code></li>
</ul>
<p>If the <code>&lt;iframe&gt;</code> content from <code>ad-tech1.example</code> implements a <a href="#what_api_features_enable_the_topics_api">feature that enables the Topics API</a>, when each of the sites is loaded the browser will:</p>
<ol>
  <li>Infer <strong>topics of interest</strong> from the site URL. The topics are taken from a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Topics_API#what_topics_are_there">standard taxonomy</a>; for the above URL examples, they would be &#34;Fitness&#34;, &#34;Fibre &amp; textile arts&#34;, and &#34;Soccer&#34;.</li>
  <li><strong>Mark the topics as observed</strong>, which involves recording a <strong>topics history entry</strong> for each one in a private topics history storage. Each topics history entry includes the following information:
    <ul>
      <li>A document id (i.e. an identifier for the current page).</li>
      <li>Topics calculation input data (i.e. the page hostname).</li>
      <li>The time (since the Unix epoch) when the page was first observed.</li>
      <li>The domain(s) where the topic was observed (known as <strong>topic caller domains</strong>).</li>
    </ul>
  </li>
</ol></div></section><section aria-labelledby="selecting_topics_of_interest_to_influence_ad_choice"><h3 id="selecting_topics_of_interest_to_influence_ad_choice"><a href="#selecting_topics_of_interest_to_influence_ad_choice">Selecting topics of interest to influence ad choice</a></h3><div><p><strong>Note:</strong> Different browser implementations may select topics in different ways. The below text is based on how Chrome currently selects topics, for demonstration purposes.</p>
<p>On an ongoing basis, the browser will:</p>
<ol>
  <li>
    Keep track of how often the user observes each topic during each new <strong>epoch</strong>. An epoch is a week by default, but the length can be altered for testing purposes (see <a href="#testing_hints">Testing hints</a>).
    Chrome places each of the 22 root topics (those without an ancestor) from the taxonomy into <a href="https://github.com/patcg-individual-drafts/topics/blob/main/topics-utility-buckets-v1.md" target="_blank">one of two buckets</a> indicating higher or standard utility for the overall ad tech ecosystem. All descendants of the root topics inherit the same bucket assignment from their parent. The assignment of root topics to buckets is based on input about utility Google received from companies across the ecosystem.
  </li>
  <li>Select top topics for each user, at the end of each epoch:
    <ol>
      <li>Chrome converts caller domain hostnames from the user&#39;s browsing history into topics.</li>
      <li>These topics are sorted first by bucket, and then by frequency (how many times they were matched in a hostname). That is, if two topics are in the same bucket but have different frequencies, the higher frequency topic is sorted higher.</li>
      <li>Chrome selects the top five topics as the user&#39;s top topics for that epoch, which are eligible to be shared with callers.</li>
    </ol>
  </li>
  <li>The top topics are returned to <code>ad-tech1.example</code>, only if <code>ad-tech1.example</code> appears in the list of caller domains for each topic, as stored in the topic&#39;s history entry.
    <p><strong>Note:</strong> Initially, no topics are returned, so the <code>&lt;iframe&gt;</code> will likely display a default non-targeted ad. However, once the end of the first epoch is reached, the API will start to return topics and <code>ad-tech1.example</code> can start to show more relevant ads based on the observed topics for the current user.</p>
  </li>
</ol>
<p><code>ad-tech1.example</code> then selects a relevant ad to serve to the user, based on the returned topics.</p></div></section><section aria-labelledby="what_api_features_enable_the_topics_api"><h2 id="what_api_features_enable_the_topics_api"><a href="#what_api_features_enable_the_topics_api">What API features enable the Topics API?</a></h2><div><p>The following features all serve a dual purpose — they return the user&#39;s top topics to the caller and they trigger the browser to record the current page visit as observed by the caller, so the page&#39;s hostname can later be used in topics calculation. To do so, they need to be included in a calling ad tech&#39;s <code>&lt;iframe&gt;</code>; the <code>&lt;iframe&gt;</code> then has to be embedded on the pages where you want topics observed.</p>
<ul>
  <li>You can specify a <code>browsingTopics: true</code> option in the options object of a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/fetch" title="fetch()"><code>fetch()</code></a> call to the ad tech platform.</li>
  <li>You could also pass <code>browsingTopics: true</code> into the options object of a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Request/Request" title="Request()"><code>Request()</code></a> constructor call, and pass the resulting <a href="https://developer.mozilla.org/en-US/docs/Web/API/Request"><code>Request</code></a> object into the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/fetch" title="fetch()"><code>fetch()</code></a> call.</li>
  <li>You can set a <code>browsingtopics</code> attribute on the <code>&lt;iframe&gt;</code>, at the same time or before setting the <code>src</code> attribute to load the source. This could be done:
    <ul>
      <li>Declaratively on the HTML:</li>
    </ul>
    <div><pre data-signature="nIIO/F/+LdXUY0uaYYH05madMpUs0UnR3mA3gJG/v1g="><code><span><span><span>&lt;</span>iframe</span> <span>browsingtopics</span> <span>src</span><span><span>=</span><span>&#34;</span>ad-tech1.example<span>&#34;</span></span><span>&gt;</span></span> ... <span><span><span>&lt;/</span>iframe</span><span>&gt;</span></span>
</code></pre></div>
    <ul>
      <li>Programmatically by setting the equivalent <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLIFrameElement/browsingTopics"><code>HTMLIFrameElement.browsingTopics</code></a> property to <code>true</code>:</li>
    </ul>
    <div><pre data-signature="o8YfWYVqz6VfM/5xRbVdgky6b7NsZ16G8ix8OvvuF+M="><code><span>const</span> iframeElem <span>=</span> document<span>.</span><span>querySelector</span><span>(</span><span>&#34;iframe&#34;</span><span>)</span><span>;</span>
iframeElem<span>.</span>browsingTopics <span>=</span> <span>true</span><span>;</span>
</code></pre></div>
  </li>
</ul>
<p>When the request associated with one of the above features is sent:</p>
<ol>
  <li>A <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Sec-Browsing-Topics"><code>Sec-Browsing-Topics</code></a> header is sent along with the request, which contains the top topic(s) for the current user.</li>
  <li>The ad tech server selects a relevant ad to display in the <code>&lt;iframe&gt;</code>, based on these topics, and sends the required data to display it in the response.</li>
  <li>An <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Observe-Browsing-Topics"><code>Observe-Browsing-Topics</code></a> header should be set on the response to the request — this has the effect of causing the browser to record the current page visit as observed by the calling ad tech provider, so the associated topic(s) will be recorded in a topics history entry, and subsequently be used in <a href="#selecting_topics_of_interest_to_influence_ad_choice">topic selection</a>.
    <p><strong>Note:</strong> It is important to clarify that this doesn&#39;t record the top topics sent in the <code>Sec-Browsing-Topics</code> header as observed. It records the topics inferred from the calling site&#39;s URL (i.e. the site where the ad tech <code>&lt;iframe&gt;</code> is embedded) as observed.</p>
  </li>
</ol></div></section><section aria-labelledby="the_browsingtopics_method"><h3 id="the_browsingtopics_method"><a href="#the_browsingtopics_method">The <code>browsingTopics()</code> method</a></h3><div><p>Alternatively, the embedded <code>&lt;iframe&gt;</code> can call <a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/browsingTopics"><code>Document.browsingTopics()</code></a> to return a user&#39;s current top topic(s), which can then be returned to the ad tech platform in a subsequent fetch request. This does not rely on the HTTP headers, but is somewhat less performant. You are advised to use one of the HTTP header methods listed above, falling back to <code>browsingTopics()</code> only in situations where the headers cannot be modified.</p>
<p><strong>Note:</strong> Because the <code>browsingTopics()</code> method does not rely on the HTTP headers, the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Observe-Browsing-Topics"><code>Observe-Browsing-Topics</code></a> header is not used for setting the topics as observed and recording/updating topics history entries; the browser does this automatically when the method is called.</p></div></section><section aria-labelledby="private_topic_sets"><h2 id="private_topic_sets"><a href="#private_topic_sets">Private topic sets</a></h2><div><p>A caller can only access topics that they themselves have observed for a user — and not topics observed by other callers. For example:</p>
<ul>
  <li>If the <code>ad-tech1.example</code> platform has an <code>&lt;iframe&gt;</code> embedded on <code>tennis.example</code> that includes a Topics API feature, they would observe topics like &#34;Sports&#34; and &#34;Tennis&#34; for a user who visits that site.</li>
  <li>If another ad tech platform, <code>ad-tech2.example</code>, has a Topics API <code>&lt;iframe&gt;</code> embedded on &#34;gardening.example&#34;, they would observe the topic &#34;Gardening&#34;.</li>
</ul>
<p>These ad tech platforms will only get topics for a user that they have observed. In this example, <code>ad-tech1.example</code> won&#39;t get &#34;Gardening&#34; and <code>ad-tech2.example</code> won&#39;t get &#34;Tennis&#34;.</p>
<p>In other words, callers such as ad tech platforms only get topics for pages where they have a presence. More importantly, the recorded topics of interest are the only information that can be accessed via this API — unlike with tracking cookies, no other information can be leaked.</p></div></section><section aria-labelledby="examples"><h2 id="examples"><a href="#examples">Examples</a></h2></section><section aria-labelledby="using_document.browsingtopics"><h3 id="using_document.browsingtopics"><a href="#using_document.browsingtopics">Using <code>Document.browsingTopics()</code></a></h3><div><div><pre data-signature="qtrMLCNyf0a5TNpyv924DeW6VRgG0nRnEFHbT6X1ISA="><code>
<span>const</span> topics <span>=</span> <span>await</span> document<span>.</span><span>browsingTopics</span><span>(</span><span>)</span><span>;</span>


<span>const</span> response <span>=</span> <span>await</span> <span>fetch</span><span>(</span><span>&#34;https://ads.example/get-creative&#34;</span><span>,</span> <span>{</span>
  <span>method</span><span>:</span> <span>&#34;POST&#34;</span><span>,</span>
  <span>headers</span><span>:</span> <span>{</span>
    <span>&#34;Content-Type&#34;</span><span>:</span> <span>&#34;application/json&#34;</span><span>,</span>
  <span>}</span><span>,</span>
  <span>body</span><span>:</span> <span>JSON</span><span>.</span><span>stringify</span><span>(</span>topics<span>)</span><span>,</span>
<span>}</span><span>)</span><span>;</span>


<span>const</span> creative <span>=</span> <span>await</span> response<span>.</span><span>json</span><span>(</span><span>)</span><span>;</span>


</code></pre></div></div></section><section aria-labelledby="passing_the_browsingtopics_option_into_fetch"><h3 id="passing_the_browsingtopics_option_into_fetch"><a href="#passing_the_browsingtopics_option_into_fetch">Passing the <code>browsingTopics</code> option into <code>fetch()</code></a></h3><div><div><pre data-signature="MFzzjTztDVH8GESvoq0ivMDrRpa0PfPdbKbdtX8wSWE="><code>
<span>const</span> response <span>=</span> <span>await</span> <span>fetch</span><span>(</span><span>&#34;https://ads.example/get-creative&#34;</span><span>,</span> <span>{</span>
  <span>browsingTopics</span><span>:</span> <span>true</span><span>,</span>
<span>}</span><span>)</span><span>;</span>


<span>const</span> creative <span>=</span> <span>await</span> response<span>.</span><span>json</span><span>(</span><span>)</span><span>;</span>


</code></pre></div></div></section><section aria-labelledby="including_the_browsingtopics_attribute_in_an_iframe"><h3 id="including_the_browsingtopics_attribute_in_an_iframe"><a href="#including_the_browsingtopics_attribute_in_an_iframe">Including the <code>browsingtopics</code> attribute in an <code>&lt;iframe&gt;</code></a></h3><div><div><pre data-signature="nIIO/F/+LdXUY0uaYYH05madMpUs0UnR3mA3gJG/v1g="><code><span><span><span>&lt;</span>iframe</span> <span>browsingtopics</span> <span>src</span><span><span>=</span><span>&#34;</span>ad-tech1.example<span>&#34;</span></span><span>&gt;</span></span> ... <span><span><span>&lt;/</span>iframe</span><span>&gt;</span></span>
</code></pre></div></div></section><section aria-labelledby="complete_examples"><h3 id="complete_examples"><a href="#complete_examples">Complete examples</a></h3><div><ul>
  <li><a href="https://topics-demo.glitch.me/" target="_blank">Topics API demo</a>: Demonstrates how <code>document.browsingTopics()</code> calls can be used to observe and then access topics (<a href="https://glitch.com/edit/#!/topics-demo" target="_blank">see source code</a>).</li>
  <li><a href="https://topics-fetch-demo.glitch.me/" target="_blank">Topics API header demo</a>: Demonstrates a <code>fetch()</code> request with a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Sec-Browsing-Topics"><code>Sec-Browsing-Topics</code></a> header can be used to observe and then access topics (<a href="https://glitch.com/edit/#!/topics-fetch-demo" target="_blank">see source code</a>).</li>
</ul></div></section><section aria-labelledby="testing_hints"><h2 id="testing_hints"><a href="#testing_hints">Testing hints</a></h2></section><section aria-labelledby="chrome"><h3 id="chrome"><a href="#chrome">Chrome</a></h3><div><p>The default epoch length for observing topics is one week, which is way too long to test code that uses the Topics API. To shorten this for test purposes, in Chrome you can open the browser with a feature flag along the following lines:</p>
<div><pre data-signature="L6f6aYyG4hYnT2Wt1o044HWQEK0F0dNnEumuJn/fty8="><code>BrowsingTopicsParameters:time_period_per_epoch/15s/max_epoch_introduction_delay/3s
</code></pre></div>
<p>See <a href="https://www.chromium.org/developers/how-tos/run-chromium-with-flags/" target="_blank">Run Chromium with command-line switches</a> for more information on how to do this.</p>
<p>You can also test your Topics API code locally without <a href="https://developer.mozilla.org/en-US/docs/Web/API/Topics_API#enrollment">enrollment</a> by enabling the following Chrome developer flag:</p>
<p><code>chrome://flags/#privacy-sandbox-enrollment-overrides</code></p></div></section><section aria-labelledby="see_also"><h2 id="see_also"><a href="#see_also">See also</a></h2><div><ul>
  <li><a href="https://developers.google.com/privacy-sandbox/private-advertising/topics" target="_blank">Topics API</a> on developers.google.com (2023)</li>
</ul></div></section></article></div>
  </body>
</html>
