<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.stenmans.org/theBeamBook/">Original</a>
    <h1>The Erlang Runtime System</h1>
    
    <div id="readability-page-1" class="page"><p>Redbug is safe to be used in production, thanks to a self-protecting
mechanism against overload, which kills the tool in case too many
tracing messages are sent, preventing the Erlang node to become
overloaded. Let’s see it in action:</p><div>
<div>
<pre><code data-lang="erlang"><span>$ </span><span>erl</span>
<span>Erlang</span><span>/</span><span>OTP</span> <span>19</span> <span>[</span><span>erts</span><span>-</span><span>8</span><span>.</span><span>2</span><span>]</span> <span>[...]</span>

<span>Eshell</span> <span>V8</span><span>.</span><span>2</span> <span>(</span><span>abort</span> <span>with</span> <span>^</span><span>G</span><span>)</span>
<span>1</span><span>&gt;</span> <span>l</span><span>(</span><span>redbug</span><span>).</span> <i data-value="1"></i><b>(1)</b>
<span>{</span><span>module</span><span>,</span><span>redbug</span><span>}</span>
<span>2</span><span>&gt;</span> <span>redbug</span><span>:</span><span>start</span><span>(</span><span>&#34;lists:sort/1&#34;</span><span>).</span> <i data-value="2"></i><b>(2)</b>
<span>{</span><span>30</span><span>,</span><span>1</span><span>}</span>
<span>3</span><span>&gt;</span> <span>lists</span><span>:</span><span>sort</span><span>([</span><span>3</span><span>,</span><span>2</span><span>,</span><span>1</span><span>]).</span>
<span>[</span><span>1</span><span>,</span><span>2</span><span>,</span><span>3</span><span>]</span>

<span>% 15:20:20 &lt;0.31.0&gt;({erlang,apply,2}) <i data-value="3"></i><b>(3)</b>
% lists:sort([3,2,1])
</span><span>redbug</span> <span>done</span><span>,</span> <span>timeout</span> <span>-</span> <span>1</span> <i data-value="4"></i><b>(4)</b></code></pre>
</div>
</div><p>Let’s now look at the actual message produced by redbug. By default
messages are printed to the standard output, but it’s also possible to
dump them to file:</p><div>
<div>
<pre><code data-lang="erlang"><span>% 15:20:20 &lt;0.31.0&gt;({erlang,apply,2})
</span><span>%</span> <span>lists</span><span>:</span><span>sort</span><span>([</span><span>3</span><span>,</span><span>2</span><span>,</span><span>1</span><span>])</span></code></pre>
</div>
</div><p>Depending on the version of redbug you are using, you may get a
slightly different message. In this case, the message is split across
two lines. The first line contains a <strong>timestamp</strong>, the <strong>Process Identifier</strong>
(or <em>PID</em>) of the Erlang process which invoked the function and the
<strong>caller</strong> function. The second line contains the function called,
including the input arguments. Both lines are prepended with a <code>%</code>,
which reminds us of the syntax for Erlang comments.</p><p>We can also ask Redbug to produce an extra message for the return
value. This is achieved using the following syntax:</p><div>
<div>
<pre><code data-lang="erlang"><span>4</span><span>&gt;</span> <span>redbug</span><span>:</span><span>start</span><span>(</span><span>&#34;lists:sort/1-&gt;return&#34;</span><span>).</span>
<span>{</span><span>30</span><span>,</span><span>1</span><span>}</span></code></pre>
</div>
</div><p>Let’s invoke the <code>lists:sort/1</code> function again. This time the output
from redbug is slightly different.</p><div>
<div>
<pre><code data-lang="erlang"><span>5</span><span>&gt;</span> <span>lists</span><span>:</span><span>sort</span><span>([</span><span>3</span><span>,</span><span>2</span><span>,</span><span>1</span><span>]).</span>
<span>[</span><span>1</span><span>,</span><span>2</span><span>,</span><span>3</span><span>]</span>

<span>% 15:35:52 &lt;0.31.0&gt;({erlang,apply,2})
% lists:sort([3,2,1])
</span>
<span>% 15:35:52 &lt;0.31.0&gt;({erlang,apply,2})
% lists:sort/1 -&gt; [1,2,3]
</span><span>redbug</span> <span>done</span><span>,</span> <span>timeout</span> <span>-</span> <span>1</span></code></pre>
</div>
</div><p>In this case two messages are produced, one when entering the function
and one when leaving the same function.</p><p>When dealing with real code, trace messages can be complex and
therefore hardly readable. Let’s see what happens if we try to trace
the sorting of a list containing 10.000 elements.</p><div>
<div>
<pre><code data-lang="erlang"><span>6</span><span>&gt;</span> <span>lists</span><span>:</span><span>sort</span><span>(</span><span>lists</span><span>:</span><span>seq</span><span>(</span><span>10000</span><span>,</span> <span>1</span><span>,</span> <span>-</span><span>1</span><span>)).</span>
<span>[</span><span>1</span><span>,</span><span>2</span><span>,</span><span>3</span><span>,</span><span>4</span><span>,</span><span>5</span><span>,</span><span>6</span><span>,</span><span>7</span><span>,</span><span>8</span><span>,</span><span>9</span><span>,</span><span>10</span><span>,</span><span>11</span><span>,</span><span>12</span><span>,</span><span>13</span><span>,</span><span>14</span><span>,</span><span>15</span><span>,</span><span>16</span><span>,</span><span>17</span><span>,</span><span>18</span><span>,</span><span>19</span><span>,</span><span>20</span><span>,</span><span>21</span><span>,</span><span>22</span><span>,</span>
<span>23</span><span>,</span><span>24</span><span>,</span><span>25</span><span>,</span><span>26</span><span>,</span><span>27</span><span>,</span><span>28</span><span>,</span><span>29</span><span>|...]</span>

<span>% 15:48:42.208 &lt;0.77.0&gt;({erlang,apply,2})
% lists:sort([10000,9999,9998,9997,9996,9995,9994,9993,9992,9991,9990,9989,9988,9987,9986,
% 9985,9984,9983,9982,9981,9980,9979,9978,9977,9976,9975,9974,9973,9972,9971,
% 9970,9969,9968,9967,9966,9965,9964,9963,9962,9961,9960,9959,9958,9957,9956,
% 9955,9954,9953,9952,9951,9950,9949,9948,9947,9946,9945,9944,9943,9942,9941,
% 9940,9939,9938,9937,9936,9935,9934,9933,9932,9931,9930,9929,9928,9927,9926,
% 9925,9924,9923,9922,9921,9920,9919,9918,9917,9916,9915,9914,9913,9912,9911,
% [...]
% 84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,
% 59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,
% 34,33,32,31,30,29,28,27,26,25,24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,
% 8,7,6,5,4,3,2,1])
</span>
<span>% 15:48:42.210 &lt;0.77.0&gt;({erlang,apply,2}) lists:sort/1 -&gt;
% [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,
% 23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,
% 42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,
% 61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,
% 80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,
% 99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,
% [...]
% 9951,9952,9953,9954,9955,9956,9957,9958,9959,9960,9961,
% 9962,9963,9964,9965,9966,9967,9968,9969,9970,9971,9972,
% 9973,9974,9975,9976,9977,9978,9979,9980,9981,9982,9983,
% 9984,9985,9986,9987,9988,9989,9990,9991,9992,9993,9994,
% 9995,9996,9997,9998,9999,10000]
</span><span>redbug</span> <span>done</span><span>,</span> <span>timeout</span> <span>-</span> <span>1</span></code></pre>
</div>
</div><p>Most of the output has been truncated here, but you should get the
idea. To improve things, we can use a couple of redbug options.  The
option <code>{arity, true}</code> instructs redbug to only display the number of
input arguments for the given function, instead of their actual
value. The <code>{print_return, false}</code> option tells Redbug not to display
the return value of the function call, and to display a <code>…​</code>  symbol,
instead. Let’s see these options in action.</p><div>
<div>
<pre><code data-lang="erlang"><span>7</span><span>&gt;</span> <span>redbug</span><span>:</span><span>start</span><span>(</span><span>&#34;lists:sort/1-&gt;return&#34;</span><span>,</span> <span>[{</span><span>arity</span><span>,</span> <span>true</span><span>},</span> <span>{</span><span>print_return</span><span>,</span> <span>false</span><span>}]).</span>
<span>{</span><span>30</span><span>,</span><span>1</span><span>}</span>

<span>8</span><span>&gt;</span> <span>lists</span><span>:</span><span>sort</span><span>(</span><span>lists</span><span>:</span><span>seq</span><span>(</span><span>10000</span><span>,</span> <span>1</span><span>,</span> <span>-</span><span>1</span><span>)).</span>
<span>[</span><span>1</span><span>,</span><span>2</span><span>,</span><span>3</span><span>,</span><span>4</span><span>,</span><span>5</span><span>,</span><span>6</span><span>,</span><span>7</span><span>,</span><span>8</span><span>,</span><span>9</span><span>,</span><span>10</span><span>,</span><span>11</span><span>,</span><span>12</span><span>,</span><span>13</span><span>,</span><span>14</span><span>,</span><span>15</span><span>,</span><span>16</span><span>,</span><span>17</span><span>,</span><span>18</span><span>,</span><span>19</span><span>,</span><span>20</span><span>,</span><span>21</span><span>,</span><span>22</span><span>,</span>
<span>23</span><span>,</span><span>24</span><span>,</span><span>25</span><span>,</span><span>26</span><span>,</span><span>27</span><span>,</span><span>28</span><span>,</span><span>29</span><span>|...]</span>

<span>% 15:55:32 &lt;0.77.0&gt;({erlang,apply,2})
% lists:sort/1
</span>
<span>% 15:55:32 &lt;0.77.0&gt;({erlang,apply,2})
% lists:sort/1 -&gt; &#39;...&#39;
</span><span>redbug</span> <span>done</span><span>,</span> <span>timeout</span> <span>-</span> <span>1</span></code></pre>
</div>
</div><p>By default, redbug stops after 15 seconds or after 10 messages are
received. Those values are a safe default, but they are rarely
enough. You can bump those limits by using the <code>time</code> and <code>msgs</code>
options. <code>time</code> is expressed in milliseconds.</p><div>
<div>
<pre><code data-lang="erlang"><span>9</span><span>&gt;</span> <span>redbug</span><span>:</span><span>start</span><span>(</span><span>&#34;lists:sort/1-&gt;return&#34;</span><span>,</span> <span>[{</span><span>arity</span><span>,</span> <span>true</span><span>},</span> <span>{</span><span>print_return</span><span>,</span> <span>false</span><span>},</span> <span>{</span><span>time</span><span>,</span> <span>60</span> <span>*</span> <span>1000</span><span>},</span> <span>{</span><span>msgs</span><span>,</span> <span>100</span><span>}]).</span>
<span>{</span><span>30</span><span>,</span><span>1</span><span>}</span></code></pre>
</div>
</div><p>We can also activate redbug for several function calls
simultaneously. Let’s enable tracing for both functions <code>lists:sort/1</code>
and <code>lists:sort_1/3</code> (an internal function used by the former):</p><div>
<div>
<pre><code data-lang="erlang"><span>10</span><span>&gt;</span> <span>redbug</span><span>:</span><span>start</span><span>([</span><span>&#34;lists:sort/1-&gt;return&#34;</span><span>,</span> <span>&#34;lists:sort_1/3-&gt;return&#34;</span><span>]).</span>
<span>{</span><span>30</span><span>,</span><span>2</span><span>}</span>

<span>11</span><span>&gt;</span> <span>lists</span><span>:</span><span>sort</span><span>([</span><span>4</span><span>,</span><span>4</span><span>,</span><span>2</span><span>,</span><span>1</span><span>]).</span>
<span>[</span><span>1</span><span>,</span><span>2</span><span>,</span><span>4</span><span>,</span><span>4</span><span>]</span>

<span>% 18:39:26 &lt;0.32.0&gt;({erlang,apply,2})
% lists:sort([4,4,2,1])
</span>
<span>% 18:39:26 &lt;0.32.0&gt;({erlang,apply,2})
% lists:sort_1(4, [2,1], [4])
</span>
<span>% 18:39:26 &lt;0.32.0&gt;({erlang,apply,2})
% lists:sort_1/3 -&gt; [1,2,4,4]
</span>
<span>% 18:39:26 &lt;0.32.0&gt;({erlang,apply,2})
% lists:sort/1 -&gt; [1,2,4,4]
</span><span>redbug</span> <span>done</span><span>,</span> <span>timeout</span> <span>-</span> <span>2</span></code></pre>
</div>
</div><p>Last but not least, redbug offers the ability to only display results
for matching input arguments. This is when the syntax looks a bit like
magic.</p><div>
<div>
<pre><code data-lang="erlang"><span>12</span><span>&gt;</span> <span>redbug</span><span>:</span><span>start</span><span>([</span><span>&#34;lists:sort([1,2,5])-&gt;return&#34;</span><span>]).</span>
<span>{</span><span>30</span><span>,</span><span>1</span><span>}</span>

<span>13</span><span>&gt;</span> <span>lists</span><span>:</span><span>sort</span><span>([</span><span>4</span><span>,</span><span>4</span><span>,</span><span>2</span><span>,</span><span>1</span><span>]).</span>
<span>[</span><span>1</span><span>,</span><span>2</span><span>,</span><span>4</span><span>,</span><span>4</span><span>]</span>

<span>14</span><span>&gt;</span> <span>lists</span><span>:</span><span>sort</span><span>([</span><span>1</span><span>,</span><span>2</span><span>,</span><span>5</span><span>]).</span>
<span>[</span><span>1</span><span>,</span><span>2</span><span>,</span><span>5</span><span>]</span>

<span>% 18:45:27 &lt;0.32.0&gt;({erlang,apply,2})
% lists:sort([1,2,5])
</span>
<span>% 18:45:27 &lt;0.32.0&gt;({erlang,apply,2})
% lists:sort/1 -&gt; [1,2,5]
</span><span>redbug</span> <span>done</span><span>,</span> <span>timeout</span> <span>-</span> <span>1</span></code></pre>
</div>
</div><p>In the above example, we are telling redbug that we are only
interested in function calls to the <code>lists:sort/1</code> function when the
input arguments is the list <code>[1,2,5]</code>. This allows us to remove a huge
amount of noise in the case our target function is used by many actors
at the same time and we are only interested in a specific use case.
Oh, and don’t forget that you can use the underscore as a wildcard:</p><div>
<div>
<pre><code data-lang="erlang"><span>15</span><span>&gt;</span> <span>redbug</span><span>:</span><span>start</span><span>([</span><span>&#34;lists:sort([1,_,5])-&gt;return&#34;</span><span>]).</span>  <span>{</span><span>30</span><span>,</span><span>1</span><span>}</span>

<span>16</span><span>&gt;</span> <span>lists</span><span>:</span><span>sort</span><span>([</span><span>1</span><span>,</span><span>2</span><span>,</span><span>5</span><span>]).</span>  <span>[</span><span>1</span><span>,</span><span>2</span><span>,</span><span>5</span><span>]</span>

<span>% 18:49:07 &lt;0.32.0&gt;({erlang,apply,2}) lists:sort([1,2,5])
</span>
<span>% 18:49:07 &lt;0.32.0&gt;({erlang,apply,2}) lists:sort/1 -&gt; [1,2,5]
</span>
<span>17</span><span>&gt;</span> <span>lists</span><span>:</span><span>sort</span><span>([</span><span>1</span><span>,</span><span>4</span><span>,</span><span>5</span><span>]).</span>  <span>[</span><span>1</span><span>,</span><span>4</span><span>,</span><span>5</span><span>]</span>

<span>% 18:49:09 &lt;0.32.0&gt;({erlang,apply,2}) lists:sort([1,4,5])
</span>
<span>% 18:49:09 &lt;0.32.0&gt;({erlang,apply,2}) lists:sort/1 -&gt; [1,4,5] redbug
</span><span>%</span> <span>done</span><span>,</span> <span>timeout</span> <span>-</span> <span>2</span></code></pre>
</div>
</div><p>This section does not pretend to be a comprehensive guide to redbug,
but it should be enough to get you going. To get a full list of the
available options for redbug, you can ask the tool itself:</p></div>
  </body>
</html>
