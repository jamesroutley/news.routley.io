<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/0x0mer/doom-htop">Original</a>
    <h1>Doom-htop: The classic DOOM game over htop</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">Ever wondered whether <code>htop</code> could be used to render the graphics of cult video games? I know I have.
In order to quench our curiosity and for your viewing pleasure, I created <code>doom-htop</code>.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/0x0mer/doom-htop/blob/master/screenshots/doom.gif"><img src="https://github.com/0x0mer/doom-htop/raw/master/screenshots/doom.gif" alt="" data-animated-image=""/></a></p>

<ol dir="auto">
<li><a href="#How-to-build">How to build</a></li>
<li><a href="#How-to-run">How to run</a></li>
<li><a href="#How-it-works">How it works</a></li>
<li><a href="#Platforms">Platforms</a></li>
<li><a href="#Troubleshooting">Troubleshooting</a></li>
<li><a href="#further-work-required">Further work required</a></li>
<li><a href="#faq">F.A.Q</a></li>
<li><a href="#License">License</a></li>
</ol>


<p dir="auto"><strong>Notice!</strong> In order to use this project, you need a WAD (game data) file. The one I included is freedoom1.wad (All credit goes to <a href="https://freedoom.github.io/index.html" rel="nofollow">The Freedoom project</a>!).</p>
<p dir="auto">Of course you&#39;re welcome to download the classic free shareware version DOOM1.wad <a href="https://doomwiki.org/wiki/DOOM1.WAD" rel="nofollow">from here</a>. (I wasn&#39;t sure if I was legally allowed to upload it to github, and decided against it).</p>

<p dir="auto">If I were you, I would probably save any important work I have open before doing this. That being said, I tested this code on a 12-year old Lenovo® ThinkPad T430s with 8GB RAM and an Intel Core i7-3520M @ 2.90GHz running Ubuntu 22.04 and it ran just fine.</p>
<p dir="auto">Anyways, simply run:</p>
<div data-snippet-clipboard-copy-content="sed -i &#39;s/update_process_names=0/update_process_names=1/&#39; ~/.config/htop/htoprc
sudo ./doom-htop -iwad freedoom1.wad
htop -d 1 -s M_VIRT"><pre><code>sed -i &#39;s/update_process_names=0/update_process_names=1/&#39; ~/.config/htop/htoprc
sudo ./doom-htop -iwad freedoom1.wad
htop -d 1 -s M_VIRT
</code></pre></div>
<p dir="auto">It doesn&#39;t matter whether you run <code>doom-htop</code> or <code>htop</code> first.</p>
<p dir="auto">The <code>sudo</code> is only needed in order to open your keyboard&#39;s device.</p>
<p dir="auto">If you&#39;re the kinda person who would rather not run sketchy programs off the <em>Internet™</em> with root privilges, you can go ahead and run it without <code>sudo</code> and just look at the pretty pictures.</p>
<p dir="auto">The <code>-d 1</code> is because we&#39;re going for that sweet, sweet 10 FPS refresh rate, and the <code>-s M_VIRT</code> is because we&#39;re gonna want to sort the processes by virtual memory allocation, which should be pretty indicative of our processes and bunch them up together nicely. If for some reason that doesn&#39;t work for you, you can go ahead and play with the define <code>PROCS_MALLOC_SIZE</code> in <code>main.c</code> until everything looks nice.</p>
<p dir="auto">Finally, the <code>sed</code> command is needed because by default, <code>htop</code> doesn&#39;t refresh the processes&#39; names every time.
This design choice was <em>probably</em> made because <code>htop</code> wasn&#39;t originally designed to render ascii-art videos, but we&#39;ll never know for sure.</p>

<p dir="auto">It&#39;s pretty straight-forward, actually. The amazing project <a href="https://github.com/ozkl/doomgeneric">https://github.com/ozkl/doomgeneric</a> which I forked, did all the heavy lifting.
I simply added the 3 files:</p>
<ol dir="auto">
<li>main.c</li>
<li>keylogger.c</li>
<li>ascii_stuff.c</li>
</ol>
<p dir="auto">And edited a few others.</p>
<p dir="auto">I wrote a simple image-to-ascii converter that generated the long if statement you can find in the file <code>ascii_stuff.c</code>.</p>
<p dir="auto">The main doom process forks and creates as many process as there are lines in the ascii converted image, and then creates a shared memory segment with every single one of them.</p>
<p dir="auto">The main process copies each line in the image to the matching process&#39;s memory segment, and each child-process copies from its segment and writes over its <code>argv[0]</code>. That&#39;s it, really.</p>
<p dir="auto">Originally I wanted to do it with processes sorted by CPU usage, and create a process that consumes a specific CPU percentage, but that turned out to be pretty hard.
Then I though about using linux&#39;s <code>nice</code>, but as a user you&#39;re only allowed 19 possible values, and I wanted better graphics. Eventually I stumbled upon the idea of using virtual memory allocation, which as I said before, as pretty specific per process.</p>
<p dir="auto">I noticed that even when all the forked processes allocate exactly the same amount of memory, <code>htop</code> shows the frame in the right order. I believe that happens because maybe in case of equality the processes are then sorted by time of creation? This works on my system (and is actually a little better, because that way there is less space in which another process could &#34;get into the frame&#34;), but I wasn&#39;t sure how it would work on other people&#39;s systems and didn&#39;t want to take the chance. This also means that I could have probably just given all the processes a unique <code>nice</code> value, but whatever.</p>
<p dir="auto">Anyways, then I created a simple keylogger that works by opening the keyboard&#39;s device. This way the game is always playing in the background regardless of whether <code>htop</code> is open or not, which I think is neat.</p>

<p dir="auto">I only ever tested it on my Ubuntu 22.04. I know the keyboard device is named something else in WSL and Arch, you&#39;re welcome to port it if you like.</p>

<ol dir="auto">
<li>
<p dir="auto"><strong>Keyboard doesn&#39;t work</strong></p>
<p dir="auto">The device I&#39;m trying to open is defined in <code>#define KEYBOARD_DEVICE</code> in the file <code>main.c</code>. I&#39;m sure it won&#39;t work universally. I only tested the code on Ubuntu 22.04, and I know for a fact it won&#39;t work out of the box for WSL, and that the device in Arch is named something else. You&#39;re welcome to port it to your platform.
Try to <code>ll /dev/input/by-path</code>, and choose one of the options that has <code>kbd</code> in it.</p>
</li>
<li>
<p dir="auto"><strong>The frame is frozen</strong></p>
<p dir="auto">Maybe the <code>sed</code> command didn&#39;t work. You can change the <code>htop</code> configuation manually by hitting the F2 key -&gt; &#34;Display options&#34; -&gt; mark <code>[X]</code> on &#34;Update process names on every refresh&#34;</p>
</li>
<li>
<p dir="auto"><code>sed: can&#39;t read /home/&lt;user&gt;/.config/htop/htoprc: No such file or directory</code></p>
<p dir="auto">I guess this will probably happen if you&#39;ve never used <code>htop</code> before. In that case run <code>htop</code>, quit, and run the <code>sed</code> command again.</p>
</li>
<li>
<p dir="auto">For some reason the main doom process crashed, and you&#39;re left with a ton of zombie processes doing nothing:
Run <code>sudo pkill doom-htop</code>.</p>
</li>
</ol>

<ul dir="auto">
<li><code>htop</code> moves the screen around when you&#39;re trying to walk around using the arrow keys which is pretty annoying. A simple but silly solution would be to change <code>htop</code>&#39;s focus after you start your game, for example by pressing <code>a</code>, which opens the menu for selecting your processors, then it won&#39;t be as annoying.</li>
</ul>

<ol dir="auto">
<li>Q: Why did you make this? A: I thought it would be <a href="https://github.com/xoreaxeaxeax/movfuscator?tab=readme-ov-file#faq">funny</a>.</li>
</ol>

<p dir="auto">Freedoom is released under a BSD-like license which can be found in the file freedoom-license.txt in the main directory. I believe all other code is GPL&#39;d.</p>
</article></div></div>
  </body>
</html>
