<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.jacobvosmaer.nl/0007-xhyve/">Original</a>
    <h1>7. Using xhyve for development on macOS</h1>
    
    <div id="readability-page-1" class="page"><div><p><i><a href="https://blog.jacobvosmaer.nl/">Jacob Vosmaer&#39;s blog</a></i></p>

<p>2020-06-30</p>

<p>My work computer is a MacBook Pro but the product we make at work
is Linux software. When this distinction matters I reach for a
virtual machine (VM). I got in the habit of working with Linux VM&#39;s
on macOS years ago and it stuck with me. Never learned to like
Docker for this (and Docker containers are not the same as VM&#39;s
anyway).</p>

<p>For a long time I used VMWare Fusion which works really well. At
one point my work laptop was a bit underpowered though so I tried
to use my home server, which runs FreeBSD, for Linux VM&#39;s. That led
me to learn about bhyve, the FreeBSD equivalent of KVM/QEMU. It is
a very low-level tool so I ended up writing a script that automates
the tasks I learned how to do with it. People writing their own
automation around bhyve appears to be a common thing.</p>

<p>Fast forward to now, where I have a faster work laptop, and it was
time to get VM&#39;s on my laptop again. I was reminded of the existence
of xhyve, which is a macOS port of bhyve. Lucky me, I could apply
what I learned with bhyve.</p>

<h2>What working with xhyve looks like</h2>

<p>At the bare minimum, to run an xhyve VM, you need three things:</p>

<ul>
<li>virtual hardware configuration</li>
<li>a Linux kernel</li>
<li>a Linux ramdisk</li>
</ul>

<p>The virtual hardware configuration is a set of command line flags
for the <code>xhyve</code> command that specify the number of CPU&#39;s, amount
of memory, attached virtual PCI devices etc. This sounds imposing
but you can just copy examples from the repo. The Linux kernel is
a file usually called <code>vmlinuz</code>. When Linux boots it wants to have
a filesystem tree and start running a userspace process. These
things are contained in the &#34;ramdisk&#34;, which is a read-only in-memory
filesystem with essential system utilities on it.</p>

<p>Normally, software on the ramdisk will then look for your actual
hard disk, mount that, and continue the startup process from there.
But this is not strictly necessary. There is a cute example in the
xhyve repository that lets you boot into Linux using just a kernel
and a ramdisk that have been committed into the repository.</p>

<p>One of the amenities you typically provide in the virtual hardware
configuration is a virtual serial port. This is enough to interact
with Linux; with the right boot options (injected via the xhyve
command line) Linux will let you interact with it via that virtual
serial port. From the user perspective, you are just typing into
the terminal where you launched <code>xhyve</code>.</p>

<p>Xhyve makes it easy to attach a virtual PCI network card to your
VM. This allows you to connect to your VM via the local network,
and it allows your Linux VM to connect to the internet. It all feels
an awful lot like a cloud VM and that is no coincidence because
this is more or less the technology that underpins the cloud.</p>

<p>This is all very nice, but how do we get that kernel and ramdisk
to begin with? This is one of the main awkward points of xhyve I
have learned about so far. Normally, your PC has a BIOS. The BIOS
knows how to read a hard drive and can start up a boot loader on
the hard drive. The boot loader then knows where your Linux kernel
and ramdisk are, and loads those into memory.</p>

<p>No such luck with xhyve. There is no BIOS. You have to solve a
chicken-and-egg problem to get the kernel+ramdisk off of the disk
you are trying to boot from onto your Mac. Both when you are
installing Linux on the VM, and everytime you update software on
the VM (because software updates tend to refresh the ramdisk).</p>

<p>Unless you know how to solve such problems and have the patience
for them, you probably don&#39;t want to deal with xhyve.</p>

<p>So far I am able to solve these problems and I have not run out of
patience yet. We&#39;ll see how long that lasts. In the mean time it&#39;s
rewarding to have VM&#39;s that I can manage using the command line and
open source software.</p>

<h2>Yet another xhyve script</h2>


<details><summary>Edit history</summary><table>
<tbody><tr><td>2023-12-08</td><td></td><td>Remove embedded dates in favor of meta.json</td></tr>
<tr><td>2023-12-08</td><td></td><td>Add dates to header</td></tr>
<tr><td>2023-12-08</td><td></td><td>Add empty metadata files</td></tr>
<tr><td>2023-12-07</td><td></td><td>Add atom.xml</td></tr>
<tr><td>2020-06-30</td><td></td><td>Add date</td></tr>
<tr><td>2020-06-30</td><td></td><td>Add 0007 xhyve note</td></tr>
</tbody></table></details><p><a href="https://blog.jacobvosmaer.nl/">Back</a></p>
</div></div>
  </body>
</html>
