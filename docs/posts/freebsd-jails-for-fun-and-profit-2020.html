<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://topikettunen.com/blog/freebsd-jails-for-fun-and-profit/">Original</a>
    <h1>FreeBSD Jails for Fun and Profit (2020)</h1>
    
    <div id="readability-page-1" class="page"><div id="outline-text-headline-1">
<p>
ZFS datasets are a great way of creating templates for jails since, after the
template creation, you can easily create new jails with <code>zfs clone</code> or <code>zfs
send/receive</code>. Typically people tend to divide jails to complete and service
jails, where the former usually resembles a real FreeBSD system, and the latter
is often dedicated to applications/services. I&#39;ll cover complete jails for now.</p>
<p>
Creating templates starts with creating a dataset for your jail and
template. Here I&#39;ll make a new dataset for the base installation of FreeBSD
12.2.</p>
<pre>$ sudo zfs create -o mountpoint=/vm zroot/vm
$ sudo zfs create zroot/vm/tmpl
$ sudo zfs create zroot/vm/tmpl/12.2
</pre>
<p>
After that, fetch the base installation itself:</p>
<pre>$ fetch ftp://ftp.freebsd.org/pub/FreeBSD/releases/amd64/12.2-RELEASE/base.txz
# Fetch all the necessary stuff for your template, e.g. lib32 if needed
$ sudo tar -xJvpf base.txz -C /vm/tmpl/12.2
</pre>
<p>
After that, you should write a minimum viable <code>/etc/rc.conf</code> for the template:</p>
<pre>$ sudo emacs /vm/tmpl/12.2/etc/rc.conf
</pre>
<pre># Start or stop services
sendmail_enable=&#34;NO&#34;
sendmail_submit_enable=&#34;NO&#34;
sendmail_outbound_enable=&#34;NO&#34;
sendmail_msp_queue_enable=&#34;NO&#34;
syslogd_flags=&#34;-ss&#34;
cron_flags=&#34;-J 60&#34;
</pre>
<p>
You can also disable some unnecessary jobs for jails:</p>
<pre>$ sudo emacs /vm/tmpl/12.2/etc/periodic.conf
</pre>
<pre># No output for successful script runs.
daily_show_success=&#34;NO&#34;
weekly_show_success=&#34;NO&#34;
monthly_show_success=&#34;NO&#34;
security_show_success=&#34;NO&#34;
   
# Output to log files which are rotated by default.
daily_output=&#34;/var/log/daily.log&#34;
daily_status_security_output=&#34;/var/log/daily.log&#34;
weekly_output=&#34;/var/log/weekly.log&#34;
weekly_status_security_output=&#34;/var/log/weekly.log&#34;
monthly_output=&#34;/var/log/monthly.log&#34;
monthly_status_security_output=&#34;/var/log/monthly.log&#34;
   
# No need for those without sendmail
daily_clean_hoststat_enable=&#34;NO&#34;
daily_status_mail_rejects_enable=&#34;NO&#34;
daily_status_mailq_enable=&#34;NO&#34;
daily_queuerun_enable=&#34;NO&#34;
   
# Host does those
daily_status_disks_enable=&#34;NO&#34;
daily_status_zfs_zpool_list_enable=&#34;NO&#34;
daily_status_network_enable=&#34;NO&#34;
daily_status_uptime_enable=&#34;NO&#34;
daily_ntpd_leapfile_enable=&#34;NO&#34;
weekly_locate_enable=&#34;NO&#34;
weekly_whatis_enable=&#34;NO&#34;
security_status_chksetuid_enable=&#34;NO&#34;
security_status_neggrpperm_enable=&#34;NO&#34;
security_status_chkuid0_enable=&#34;NO&#34;
security_status_ipfwdenied_enable=&#34;NO&#34;
security_status_ipfdenied_enable=&#34;NO&#34;
security_status_ipfwlimit_enable=&#34;NO&#34;
security_status_ipf6denied_enable=&#34;NO&#34;
security_status_tcpwrap_enable=&#34;NO&#34;
</pre>
<p>
You also might want to enable ports in your jail:</p>
<pre>$ sudo mkdir /vm/tmpl/12.2/usr/ports
$ sudo mkdir -p /vm/tmpl/12.2/var/ports/{distfiles,packages}
$ sudo emacs /vm/tmpl/12.2/etc/make.conf
</pre>
<pre>WRKDIRPREFIX = /var/ports
DISTDIR = /var/ports/distfiles
PACKAGES = /var/ports/packages
</pre>
<p>
Apply system updates to the template:</p>
<pre>$ sudo freebsd-update -b /vm/tmpl/12.2 fetch install
</pre>
<p>
Lastly, take a snapshot: (Note: Strictly speaking, a template is a snapshot, not
a dataset. The snapshot can be cloned or sent/received to generate new datasets
for production jails.)</p>
<pre>$ sudo zfs snapshot zroot/vm/tmpl/12.2@complete
</pre>
<p>
This creates a snapshot of <code>zroot/vm/tmpl/12.2</code> named <code>complete</code>. You can then
check your current snapshots with:</p>
<pre>$ sudo zfs list -t snapshot
</pre>
</div></div>
  </body>
</html>
