<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/programming/BashGoodSetEReports">Original</a>
    <h1>Getting decent error reports in Bash when you&#39;re using &#39;set -e&#39;</h1>
    
    <div id="readability-page-1" class="page"><div><h2>Getting decent error reports in Bash when you&#39;re using &#39;set -e&#39;</h2>

	<p><small>July 23, 2025</small></p>
</div><div><p>Suppose that you have a shell script that&#39;s not necessarily complex
but is at least long. For reliability, you use &#39;set -e&#39; so that the
script will immediately stop on any unexpected errors from commands,
and sometimes this happens. Since this isn&#39;t supposed to happen, it
would be nice to print some useful information about what went wrong,
such as where it happened, what the failing command&#39;s exit status was,
and what the command was. The good news is that if you&#39;re willing to
make your script specifically a Bash script, you can do this quite
easily.</p>

<p>The Bash trick you need is:</p>

<blockquote><pre>trap &#39;echo &#34;Exit status $? at line $LINENO from: $BASH_COMMAND&#34;&#39; ERR
</pre>
</blockquote>

<p>This uses three Bash features: the special <a href="https://www.gnu.org/software/bash/manual/bash.html#index-LINENO">&#39;<code>$LINENO</code>&#39;</a>
and <a href="https://www.gnu.org/software/bash/manual/bash.html#index-BASH_005fCOMMAND">&#39;<code>$BASH_COMMAND</code>&#39;</a>
environment variables (which have the command executed just before
the trap and the line number), and the special &#39;ERR&#39; Bash <a href="https://www.gnu.org/software/bash/manual/bash.html#index-trap">&#39;<code>trap</code>&#39;</a>
condition that causes your &#39;trap&#39; statement to be invoked right
when &#39;set -e&#39; is causing your script to fail and exit.</p>

<p>Using &#39;ERR&#39; instead of &#39;EXIT&#39; (or &#39;0&#39; if you&#39;re a traditionalist
like me) is necessary in order to get the correct line number in
Bash. If you switch this to &#39;trap ... EXIT&#39;, the line number that
Bash will report is the line that the &#39;<code>trap</code>&#39; was defined on, not
the line that the failing command is on (although the command being
executed remains the same). This makes a certain amount of sense
from the right angle; the shell is currently on that line as it&#39;s
exiting.</p>

<p>As far as I know, no other version of the Bourne shell can do all
of this. The OpenBSD version of /bin/sh has a &#39;<code>$LINENO</code>&#39; variable
and &#39;trap ... 0&#39; preserves its value (instead of resetting it to
the line of the &#39;trap&#39;), but it has no access to the current command.
The FreeBSD version of /bin/sh resets &#39;<code>$LINENO</code>&#39; to the line of
your &#39;trap ... 0&#39;, so the best you can do is report the exit status.
Dash, the Ubuntu 24.04 default /bin/sh, doesn&#39;t have &#39;<code>$LINENO</code>&#39;,
effectively putting you in the same situation as FreeBSD.</p>

<p>(On Fedora, /bin/sh is Bash, and the Fedora version of Bash supports
all of &#39;trap .. ERR&#39;, <code>$LINENO</code>, and <code>$BASH_COMMAND</code> even when
invoked as &#39;#!/bin/sh&#39; by your script. You probably shouldn&#39;t count
on this; if you want Bash, use &#39;#!/bin/bash&#39;.)</p>
</div></div>
  </body>
</html>
