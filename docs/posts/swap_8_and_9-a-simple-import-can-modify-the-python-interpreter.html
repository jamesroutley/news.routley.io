<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://kenschutte.com/python-swap-ints/">Original</a>
    <h1>Swap_8_and_9: A simple import can modify the Python interpreter</h1>
    
    <div id="readability-page-1" class="page"><div><div><p>In <code>CPython</code>, everything (integers, strings, dictionaries, functions, etc) is an <span>&#34;object&#34;</span>, and represented by a <code>C struct</code> named <a href="https://docs.python.org/3/c-api/structures.html#c.PyObject"><code>PyObject</code></a>.
Common to all objects is the storage its type (and the data needed for that type) and a <a href="https://devguide.python.org/internals/garbage-collector/">reference count used for garbage collection</a>.</p><p>We are interested in integers — type <code>int</code> within <code>Python</code> and <a href="https://docs.python.org/3/c-api/long.html#c.PyLongObject"><code>PyLongObject</code></a> within <code>CPython</code>.</p><p>Because there is some overhead in creating and destroying objects, <code>CPython</code> maintains a cache for the set of small integers (values -5, …, 256), since these are commonly used.</p><p><i>(At this point, you can probably guess that our module will modify these cached objects</i>).</p><p><a href="https://github.com/python/cpython/blob/d2340ef25721b6a72d45d4508c672c4be38c67d3/Include/internal/pycore_global_objects.h#L16"><code>pycore_global_objects.h</code></a> defines the range of integers that will be cached,</p></div><div><pre><span></span><span>#define _PY_NSMALLPOSINTS           257</span>
<span>#define _PY_NSMALLNEGINTS           5</span>
</pre></div><p>In the same file, <a href="https://github.com/python/cpython/blob/d2340ef25721b6a72d45d4508c672c4be38c67d3/Include/internal/pycore_global_objects.h#L35">a few lines later</a>, we see the array that will hold the cached integers. It is an array of type <code>PyLongObject</code> and named <code>small_ints</code> and is within a struct called <code>_Py_global_objects</code>:</p><div><pre><span></span><span>struct</span><span> </span><span>_Py_global_objects</span><span> </span><span>{</span>
<span>    </span><span>struct</span><span> </span><span>{</span>
<span>        </span><span>/* Small integers are preallocated in this array so that they</span>
<span>         * can be shared.</span>
<span>         * The integers that are preallocated are those in the range</span>
<span>         * -_PY_NSMALLNEGINTS (inclusive) to _PY_NSMALLPOSINTS (exclusive).</span>
<span>         */</span><span>    </span>
<span>        </span><span>PyLongObject</span><span> </span><span>small_ints</span><span>[</span><span>_PY_NSMALLNEGINTS</span><span> </span><span>+</span><span> </span><span>_PY_NSMALLPOSINTS</span><span>];</span>
<span>        </span><span>...</span>
<span>    </span><span>}</span><span> </span><span>singletons</span><span>;</span>
<span>};</span>
</pre></div><p>When and where is this array initialized? In <a href="https://github.com/python/cpython/blob/d2340ef25721b6a72d45d4508c672c4be38c67d3/Include/internal/pycore_runtime_init.h#L126"><code>pycore_runtime_init.h</code></a>, we see a macro (itself generated by a <a href="https://github.com/python/cpython/blob/d2340ef25721b6a72d45d4508c672c4be38c67d3/Tools/scripts/generate_global_objects.py#L224">Python script</a>) that initializes the elements in the <code>small_ints[]</code> array,</p><div><pre><span></span><span>        </span><span>.</span><span>small_ints</span><span> </span><span>=</span><span> </span><span>{</span><span> </span>\
<span>            </span><span>_PyLong_DIGIT_INIT</span><span>(</span><span>-5</span><span>),</span><span> </span>\
<span>            </span><span>_PyLong_DIGIT_INIT</span><span>(</span><span>-4</span><span>),</span><span> </span>\
<span>            </span><span>_PyLong_DIGIT_INIT</span><span>(</span><span>-3</span><span>),</span><span> </span>\
<span>            </span><span>...</span>
<span>            </span><span>_PyLong_DIGIT_INIT</span><span>(</span><span>255</span><span>),</span><span> </span>\
<span>            </span><span>_PyLong_DIGIT_INIT</span><span>(</span><span>256</span><span>),</span><span> </span>\
<span>        </span><span>},</span><span> </span>\
</pre></div><p>It is slightly convoluted to see how this
macro (<code>_Py_global_objects_INIT</code>) gets used,
but <a href="https://github.com/python/cpython/blob/d2340ef25721b6a72d45d4508c672c4be38c67d3/Python/pystate.c#L55">pystate.c</a>
stores it as <code>static const _PyRuntimeState initial = _PyRuntimeState_INIT;</code>
and this <code>initial</code> variable is used when when the interpreter is initialized.</p></div></div>
  </body>
</html>
