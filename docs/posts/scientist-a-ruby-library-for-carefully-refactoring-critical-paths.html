<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/github/scientist">Original</a>
    <h1>Scientist: A Ruby library for carefully refactoring critical paths</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">A Ruby library for carefully refactoring critical paths. <a href="https://github.com/github/scientist/actions/workflows/ci.yml"><img src="https://github.com/github/scientist/actions/workflows/ci.yml/badge.svg" alt="Build Status"/></a></p>
<h2 tabindex="-1" id="user-content-how-do-i-science" dir="auto"><a href="#how-do-i-science">How do I science?<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">Let&#39;s pretend you&#39;re changing the way you handle permissions in a large web app. Tests can help guide your refactoring, but you really want to compare the current and refactored behaviors under load.</p>
<div dir="auto" data-snippet-clipboard-copy-content="require &#34;scientist&#34;

class MyWidget
  def allows?(user)
    experiment = Scientist::Default.new &#34;widget-permissions&#34;
    experiment.use { model.check_user?(user).valid? } # old way
    experiment.try { user.can?(:read, model) } # new way

    experiment.run
  end
end"><pre><span>require</span> <span>&#34;scientist&#34;</span>

<span>class</span> <span>MyWidget</span>
  <span>def</span> <span>allows?</span><span>(</span><span>user</span><span>)</span>
    <span>experiment</span> <span>=</span> <span>Scientist</span>::<span>Default</span><span>.</span><span>new</span> <span>&#34;widget-permissions&#34;</span>
    <span>experiment</span><span>.</span><span>use</span> <span>{</span> <span>model</span><span>.</span><span>check_user?</span><span>(</span><span>user</span><span>)</span><span>.</span><span>valid?</span> <span>}</span> <span># old way</span>
    <span>experiment</span><span>.</span><span>try</span> <span>{</span> <span>user</span><span>.</span><span>can?</span><span>(</span><span>:read</span><span>,</span> <span>model</span><span>)</span> <span>}</span> <span># new way</span>

    <span>experiment</span><span>.</span><span>run</span>
  <span>end</span>
<span>end</span></pre></div>
<p dir="auto">Wrap a <code>use</code> block around the code&#39;s original behavior, and wrap <code>try</code> around the new behavior. <code>experiment.run</code> will always return whatever the <code>use</code> block returns, but it does a bunch of stuff behind the scenes:</p>
<ul dir="auto">
<li>It decides whether or not to run the <code>try</code> block,</li>
<li>Randomizes the order in which <code>use</code> and <code>try</code> blocks are run,</li>
<li>Measures the durations of all behaviors in seconds,</li>
<li>Compares the result of <code>try</code> to the result of <code>use</code>,</li>
<li>Swallow and record exceptions raised in the <code>try</code> block when overriding <code>raised</code>, and</li>
<li>Publishes all this information.</li>
</ul>
<p dir="auto">The <code>use</code> block is called the <strong>control</strong>. The <code>try</code> block is called the <strong>candidate</strong>.</p>
<p dir="auto">Creating an experiment is wordy, but when you include the <code>Scientist</code> module, the <code>science</code> helper will instantiate an experiment and call <code>run</code> for you:</p>
<div dir="auto" data-snippet-clipboard-copy-content="require &#34;scientist&#34;

class MyWidget
  include Scientist

  def allows?(user)
    science &#34;widget-permissions&#34; do |experiment|
      experiment.use { model.check_user(user).valid? } # old way
      experiment.try { user.can?(:read, model) } # new way
    end # returns the control value
  end
end"><pre><span>require</span> <span>&#34;scientist&#34;</span>

<span>class</span> <span>MyWidget</span>
  <span>include</span> <span>Scientist</span>

  <span>def</span> <span>allows?</span><span>(</span><span>user</span><span>)</span>
    <span>science</span> <span>&#34;widget-permissions&#34;</span> <span>do</span> |<span>experiment</span>|
      <span>experiment</span><span>.</span><span>use</span> <span>{</span> <span>model</span><span>.</span><span>check_user</span><span>(</span><span>user</span><span>)</span><span>.</span><span>valid?</span> <span>}</span> <span># old way</span>
      <span>experiment</span><span>.</span><span>try</span> <span>{</span> <span>user</span><span>.</span><span>can?</span><span>(</span><span>:read</span><span>,</span> <span>model</span><span>)</span> <span>}</span> <span># new way</span>
    <span>end</span> <span># returns the control value</span>
  <span>end</span>
<span>end</span></pre></div>
<p dir="auto">If you don&#39;t declare any <code>try</code> blocks, none of the Scientist machinery is invoked and the control value is always returned.</p>
<h2 tabindex="-1" id="user-content-making-science-useful" dir="auto"><a href="#making-science-useful">Making science useful<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">The examples above will run, but they&#39;re not really <em>doing</em> anything. The <code>try</code> blocks don&#39;t run yet and none of the results get published. Replace the default experiment implementation to control execution and reporting:</p>
<div dir="auto" data-snippet-clipboard-copy-content="require &#34;scientist/experiment&#34;

class MyExperiment
  include Scientist::Experiment

  attr_accessor :name

  def initialize(name)
    @name = name
  end

  def enabled?
    # see &#34;Ramping up experiments&#34; below
    true
  end

  def raised(operation, error)
    # see &#34;In a Scientist callback&#34; below
    p &#34;Operation &#39;#{operation}&#39; failed with error &#39;#{error.inspect}&#39;&#34;
    super # will re-raise
  end

  def publish(result)
    # see &#34;Publishing results&#34; below
    p result
  end
end"><pre><span>require</span> <span>&#34;scientist/experiment&#34;</span>

<span>class</span> <span>MyExperiment</span>
  <span>include</span> <span>Scientist</span>::<span>Experiment</span>

  <span>attr_accessor</span> <span>:name</span>

  <span>def</span> <span>initialize</span><span>(</span><span>name</span><span>)</span>
    <span>@name</span> <span>=</span> <span>name</span>
  <span>end</span>

  <span>def</span> <span>enabled?</span>
    <span># see &#34;Ramping up experiments&#34; below</span>
    <span>true</span>
  <span>end</span>

  <span>def</span> <span>raised</span><span>(</span><span>operation</span><span>,</span> <span>error</span><span>)</span>
    <span># see &#34;In a Scientist callback&#34; below</span>
    <span>p</span> <span>&#34;Operation &#39;<span><span>#{</span><span>operation</span><span>}</span></span>&#39; failed with error &#39;<span><span>#{</span><span>error</span><span>.</span><span>inspect</span><span>}</span></span>&#39;&#34;</span>
    <span>super</span> <span># will re-raise</span>
  <span>end</span>

  <span>def</span> <span>publish</span><span>(</span><span>result</span><span>)</span>
    <span># see &#34;Publishing results&#34; below</span>
    <span>p</span> <span>result</span>
  <span>end</span>
<span>end</span></pre></div>
<p dir="auto">When <code>Scientist::Experiment</code> is included in a class, it automatically sets it as the default implementation via <code>Scientist::Experiment.set_default</code>. This <code>set_default</code> call is skipped if you include <code>Scientist::Experiment</code> in a module.</p>
<p dir="auto">Now calls to the <code>science</code> helper will load instances of <code>MyExperiment</code>.</p>
<h3 tabindex="-1" id="user-content-controlling-comparison" dir="auto"><a href="#controlling-comparison">Controlling comparison<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">Scientist compares control and candidate values using <code>==</code>. To override this behavior, use <code>compare</code> to define how to compare observed values instead:</p>
<div dir="auto" data-snippet-clipboard-copy-content="class MyWidget
  include Scientist

  def users
    science &#34;users&#34; do |e|
      e.use { User.all }         # returns User instances
      e.try { UserService.list } # returns UserService::User instances

      e.compare do |control, candidate|
        control.map(&amp;:login) == candidate.map(&amp;:login)
      end
    end
  end
end"><pre><span>class</span> <span>MyWidget</span>
  <span>include</span> <span>Scientist</span>

  <span>def</span> <span>users</span>
    <span>science</span> <span>&#34;users&#34;</span> <span>do</span> |<span>e</span>|
      <span>e</span><span>.</span><span>use</span> <span>{</span> <span>User</span><span>.</span><span>all</span> <span>}</span>         <span># returns User instances</span>
      <span>e</span><span>.</span><span>try</span> <span>{</span> <span>UserService</span><span>.</span><span>list</span> <span>}</span> <span># returns UserService::User instances</span>

      <span>e</span><span>.</span><span>compare</span> <span>do</span> |<span>control</span><span>,</span> <span>candidate</span>|
        <span>control</span><span>.</span><span>map</span><span>(</span>&amp;<span>:login</span><span>)</span> == <span>candidate</span><span>.</span><span>map</span><span>(</span>&amp;<span>:login</span><span>)</span>
      <span>end</span>
    <span>end</span>
  <span>end</span>
<span>end</span></pre></div>
<p dir="auto">If either the control block or candidate block raises an error, Scientist compares the two observations&#39; classes and messages using <code>==</code>. To override this behavior, use <code>compare_errors</code> to define how to compare observed errors instead:</p>
<div dir="auto" data-snippet-clipboard-copy-content="class MyWidget
  include Scientist

  def slug_from_login(login)
    science &#34;slug_from_login&#34; do |e|
      e.use { User.slug_from_login login }         # returns String instance or ArgumentError
      e.try { UserService.slug_from_login login }  # returns String instance or ArgumentError

      compare_error_message_and_class = -&gt; (control, candidate) do
        control.class == candidate.class &amp;&amp; 
        control.message == candidate.message
      end

      compare_argument_errors = -&gt; (control, candidate) do
        control.class == ArgumentError &amp;&amp;
        candidate.class == ArgumentError &amp;&amp;
        control.message.start_with?(&#34;Input has invalid characters&#34;) &amp;&amp;
        candidate.message.start_with?(&#34;Invalid characters in input&#34;) 
      end

      e.compare_errors do |control, candidate|
        compare_error_message_and_class.call(control, candidate) ||
        compare_argument_errors.call(control, candidate)
      end
    end
  end
end"><pre><span>class</span> <span>MyWidget</span>
  <span>include</span> <span>Scientist</span>

  <span>def</span> <span>slug_from_login</span><span>(</span><span>login</span><span>)</span>
    <span>science</span> <span>&#34;slug_from_login&#34;</span> <span>do</span> |<span>e</span>|
      <span>e</span><span>.</span><span>use</span> <span>{</span> <span>User</span><span>.</span><span>slug_from_login</span> <span>login</span> <span>}</span>         <span># returns String instance or ArgumentError</span>
      <span>e</span><span>.</span><span>try</span> <span>{</span> <span>UserService</span><span>.</span><span>slug_from_login</span> <span>login</span> <span>}</span>  <span># returns String instance or ArgumentError</span>

      <span>compare_error_message_and_class</span> <span>=</span> <span>-&gt;</span> <span>(</span><span>control</span><span>,</span> <span>candidate</span><span>)</span> <span>do</span>
        <span>control</span><span>.</span><span>class</span> == <span>candidate</span><span>.</span><span>class</span> &amp;&amp; 
        <span>control</span><span>.</span><span>message</span> == <span>candidate</span><span>.</span><span>message</span>
      <span>end</span>

      <span>compare_argument_errors</span> <span>=</span> <span>-&gt;</span> <span>(</span><span>control</span><span>,</span> <span>candidate</span><span>)</span> <span>do</span>
        <span>control</span><span>.</span><span>class</span> == <span>ArgumentError</span> &amp;&amp;
        <span>candidate</span><span>.</span><span>class</span> == <span>ArgumentError</span> &amp;&amp;
        <span>control</span><span>.</span><span>message</span><span>.</span><span>start_with?</span><span>(</span><span>&#34;Input has invalid characters&#34;</span><span>)</span> &amp;&amp;
        <span>candidate</span><span>.</span><span>message</span><span>.</span><span>start_with?</span><span>(</span><span>&#34;Invalid characters in input&#34;</span><span>)</span> 
      <span>end</span>

      <span>e</span><span>.</span><span>compare_errors</span> <span>do</span> |<span>control</span><span>,</span> <span>candidate</span>|
        <span>compare_error_message_and_class</span><span>.</span><span>call</span><span>(</span><span>control</span><span>,</span> <span>candidate</span><span>)</span> ||
        <span>compare_argument_errors</span><span>.</span><span>call</span><span>(</span><span>control</span><span>,</span> <span>candidate</span><span>)</span>
      <span>end</span>
    <span>end</span>
  <span>end</span>
<span>end</span></pre></div>
<h3 tabindex="-1" id="user-content-adding-context" dir="auto"><a href="#adding-context">Adding context<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">Results aren&#39;t very useful without some way to identify them. Use the <code>context</code> method to add to or retrieve the context for an experiment:</p>
<div dir="auto" data-snippet-clipboard-copy-content="science &#34;widget-permissions&#34; do |e|
  e.context :user =&gt; user

  e.use { model.check_user(user).valid? }
  e.try { user.can?(:read, model) }
end"><pre><span>science</span> <span>&#34;widget-permissions&#34;</span> <span>do</span> |<span>e</span>|
  <span>e</span><span>.</span><span>context</span> <span>:user</span> <span>=&gt;</span> <span>user</span>

  <span>e</span><span>.</span><span>use</span> <span>{</span> <span>model</span><span>.</span><span>check_user</span><span>(</span><span>user</span><span>)</span><span>.</span><span>valid?</span> <span>}</span>
  <span>e</span><span>.</span><span>try</span> <span>{</span> <span>user</span><span>.</span><span>can?</span><span>(</span><span>:read</span><span>,</span> <span>model</span><span>)</span> <span>}</span>
<span>end</span></pre></div>
<p dir="auto"><code>context</code> takes a Symbol-keyed Hash of extra data. The data is available in <code>Experiment#publish</code> via the <code>context</code> method. If you&#39;re using the <code>science</code> helper a lot in a class, you can provide a default context:</p>
<div dir="auto" data-snippet-clipboard-copy-content="class MyWidget
  include Scientist

  def allows?(user)
    science &#34;widget-permissions&#34; do |e|
      e.context :user =&gt; user

      e.use { model.check_user(user).valid? }
      e.try { user.can?(:read, model) }
    end
  end

  def destroy
    science &#34;widget-destruction&#34; do |e|
      e.use { old_scary_destroy }
      e.try { new_safe_destroy }
    end
  end

  def default_scientist_context
    { :widget =&gt; self }
  end
end"><pre><span>class</span> <span>MyWidget</span>
  <span>include</span> <span>Scientist</span>

  <span>def</span> <span>allows?</span><span>(</span><span>user</span><span>)</span>
    <span>science</span> <span>&#34;widget-permissions&#34;</span> <span>do</span> |<span>e</span>|
      <span>e</span><span>.</span><span>context</span> <span>:user</span> <span>=&gt;</span> <span>user</span>

      <span>e</span><span>.</span><span>use</span> <span>{</span> <span>model</span><span>.</span><span>check_user</span><span>(</span><span>user</span><span>)</span><span>.</span><span>valid?</span> <span>}</span>
      <span>e</span><span>.</span><span>try</span> <span>{</span> <span>user</span><span>.</span><span>can?</span><span>(</span><span>:read</span><span>,</span> <span>model</span><span>)</span> <span>}</span>
    <span>end</span>
  <span>end</span>

  <span>def</span> <span>destroy</span>
    <span>science</span> <span>&#34;widget-destruction&#34;</span> <span>do</span> |<span>e</span>|
      <span>e</span><span>.</span><span>use</span> <span>{</span> <span>old_scary_destroy</span> <span>}</span>
      <span>e</span><span>.</span><span>try</span> <span>{</span> <span>new_safe_destroy</span> <span>}</span>
    <span>end</span>
  <span>end</span>

  <span>def</span> <span>default_scientist_context</span>
    <span>{</span> <span>:widget</span> <span>=&gt;</span> <span>self</span> <span>}</span>
  <span>end</span>
<span>end</span></pre></div>
<p dir="auto">The <code>widget-permissions</code> and <code>widget-destruction</code> experiments will both have a <code>:widget</code> key in their contexts.</p>
<h3 tabindex="-1" id="user-content-expensive-setup" dir="auto"><a href="#expensive-setup">Expensive setup<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">If an experiment requires expensive setup that should only occur when the experiment is going to be run, define it with the <code>before_run</code> method:</p>
<div dir="auto" data-snippet-clipboard-copy-content="# Code under test modifies this in-place. We want to copy it for the
# candidate code, but only when needed:
value_for_original_code = big_object
value_for_new_code      = nil

science &#34;expensive-but-worthwhile&#34; do |e|
  e.before_run do
    value_for_new_code = big_object.deep_copy
  end
  e.use { original_code(value_for_original_code) }
  e.try { new_code(value_for_new_code) }
end"><pre><span># Code under test modifies this in-place. We want to copy it for the</span>
<span># candidate code, but only when needed:</span>
<span>value_for_original_code</span> <span>=</span> <span>big_object</span>
<span>value_for_new_code</span>      <span>=</span> <span>nil</span>

<span>science</span> <span>&#34;expensive-but-worthwhile&#34;</span> <span>do</span> |<span>e</span>|
  <span>e</span><span>.</span><span>before_run</span> <span>do</span>
    <span>value_for_new_code</span> <span>=</span> <span>big_object</span><span>.</span><span>deep_copy</span>
  <span>end</span>
  <span>e</span><span>.</span><span>use</span> <span>{</span> <span>original_code</span><span>(</span><span>value_for_original_code</span><span>)</span> <span>}</span>
  <span>e</span><span>.</span><span>try</span> <span>{</span> <span>new_code</span><span>(</span><span>value_for_new_code</span><span>)</span> <span>}</span>
<span>end</span></pre></div>
<h3 tabindex="-1" id="user-content-keeping-it-clean" dir="auto"><a href="#keeping-it-clean">Keeping it clean<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">Sometimes you don&#39;t want to store the full value for later analysis. For example, an experiment may return <code>User</code> instances, but when researching a mismatch, all you care about is the logins. You can define how to clean these values in an experiment:</p>
<div dir="auto" data-snippet-clipboard-copy-content="class MyWidget
  include Scientist

  def users
    science &#34;users&#34; do |e|
      e.use { User.all }
      e.try { UserService.list }

      e.clean do |value|
        value.map(&amp;:login).sort
      end
    end
  end
end"><pre><span>class</span> <span>MyWidget</span>
  <span>include</span> <span>Scientist</span>

  <span>def</span> <span>users</span>
    <span>science</span> <span>&#34;users&#34;</span> <span>do</span> |<span>e</span>|
      <span>e</span><span>.</span><span>use</span> <span>{</span> <span>User</span><span>.</span><span>all</span> <span>}</span>
      <span>e</span><span>.</span><span>try</span> <span>{</span> <span>UserService</span><span>.</span><span>list</span> <span>}</span>

      <span>e</span><span>.</span><span>clean</span> <span>do</span> |<span>value</span>|
        <span>value</span><span>.</span><span>map</span><span>(</span>&amp;<span>:login</span><span>)</span><span>.</span><span>sort</span>
      <span>end</span>
    <span>end</span>
  <span>end</span>
<span>end</span></pre></div>
<p dir="auto">And this cleaned value is available in observations in the final published result:</p>
<div dir="auto" data-snippet-clipboard-copy-content="class MyExperiment
  include Scientist::Experiment

  # ...

  def publish(result)
    result.control.value         # [&lt;User alice&gt;, &lt;User bob&gt;, &lt;User carol&gt;]
    result.control.cleaned_value # [&#34;alice&#34;, &#34;bob&#34;, &#34;carol&#34;]
  end
end"><pre><span>class</span> <span>MyExperiment</span>
  <span>include</span> <span>Scientist</span>::<span>Experiment</span>

  <span># ...</span>

  <span>def</span> <span>publish</span><span>(</span><span>result</span><span>)</span>
    <span>result</span><span>.</span><span>control</span><span>.</span><span>value</span>         <span># [&lt;User alice&gt;, &lt;User bob&gt;, &lt;User carol&gt;]</span>
    <span>result</span><span>.</span><span>control</span><span>.</span><span>cleaned_value</span> <span># [&#34;alice&#34;, &#34;bob&#34;, &#34;carol&#34;]</span>
  <span>end</span>
<span>end</span></pre></div>
<p dir="auto">Note that the <code>#clean</code> method will discard the previous cleaner block if you call it again.  If for some reason you need to access the currently configured cleaner block, <code>Scientist::Experiment#cleaner</code> will return the block without further ado.  <em>(This probably won&#39;t come up in normal usage, but comes in handy if you&#39;re writing, say, a custom experiment runner that provides default cleaners.)</em></p>
<h3 tabindex="-1" id="user-content-ignoring-mismatches" dir="auto"><a href="#ignoring-mismatches">Ignoring mismatches<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">During the early stages of an experiment, it&#39;s possible that some of your code will always generate a mismatch for reasons you know and understand but haven&#39;t yet fixed. Instead of these known cases always showing up as mismatches in your metrics or analysis, you can tell an experiment whether or not to ignore a mismatch using the <code>ignore</code> method. You may include more than one block if needed:</p>
<div dir="auto" data-snippet-clipboard-copy-content="def admin?(user)
  science &#34;widget-permissions&#34; do |e|
    e.use { model.check_user(user).admin? }
    e.try { user.can?(:admin, model) }

    e.ignore { user.staff? } # user is staff, always an admin in the new system
    e.ignore do |control, candidate|
      # new system doesn&#39;t handle unconfirmed users yet:
      control &amp;&amp; !candidate &amp;&amp; !user.confirmed_email?
    end
  end
end"><pre><span>def</span> <span>admin?</span><span>(</span><span>user</span><span>)</span>
  <span>science</span> <span>&#34;widget-permissions&#34;</span> <span>do</span> |<span>e</span>|
    <span>e</span><span>.</span><span>use</span> <span>{</span> <span>model</span><span>.</span><span>check_user</span><span>(</span><span>user</span><span>)</span><span>.</span><span>admin?</span> <span>}</span>
    <span>e</span><span>.</span><span>try</span> <span>{</span> <span>user</span><span>.</span><span>can?</span><span>(</span><span>:admin</span><span>,</span> <span>model</span><span>)</span> <span>}</span>

    <span>e</span><span>.</span><span>ignore</span> <span>{</span> <span>user</span><span>.</span><span>staff?</span> <span>}</span> <span># user is staff, always an admin in the new system</span>
    <span>e</span><span>.</span><span>ignore</span> <span>do</span> |<span>control</span><span>,</span> <span>candidate</span>|
      <span># new system doesn&#39;t handle unconfirmed users yet:</span>
      <span>control</span> &amp;&amp; !<span>candidate</span> &amp;&amp; !<span>user</span><span>.</span><span>confirmed_email?</span>
    <span>end</span>
  <span>end</span>
<span>end</span></pre></div>
<p dir="auto">The ignore blocks are only called if the <em>values</em> don&#39;t match. Unless a <code>compare_errors</code> comparator is defined, two cases are considered mismatches: a) one observation raising an exception and the other not, b) observations raising exceptions with different classes or messages.</p>
<h3 tabindex="-1" id="user-content-enablingdisabling-experiments" dir="auto"><a href="#enablingdisabling-experiments">Enabling/disabling experiments<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">Sometimes you don&#39;t want an experiment to run. Say, disabling a new codepath for anyone who isn&#39;t staff. You can disable an experiment by setting a <code>run_if</code> block. If this returns <code>false</code>, the experiment will merely return the control value. Otherwise, it defers to the experiment&#39;s configured <code>enabled?</code> method.</p>
<div dir="auto" data-snippet-clipboard-copy-content="class DashboardController
  include Scientist

  def dashboard_items
    science &#34;dashboard-items&#34; do |e|
      # only run this experiment for staff members
      e.run_if { current_user.staff? }
      # ...
  end
end"><pre><span>class</span> <span>DashboardController</span>
  <span>include</span> <span>Scientist</span>

  <span>def</span> <span>dashboard_items</span>
    <span>science</span> <span>&#34;dashboard-items&#34;</span> <span>do</span> |<span>e</span>|
      <span># only run this experiment for staff members</span>
      <span>e</span><span>.</span><span>run_if</span> <span>{</span> <span>current_user</span><span>.</span><span>staff?</span> <span>}</span>
      <span># ...</span>
  <span>end</span>
<span>end</span></pre></div>
<h3 tabindex="-1" id="user-content-ramping-up-experiments" dir="auto"><a href="#ramping-up-experiments">Ramping up experiments<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">As a scientist, you know it&#39;s always important to be able to turn your experiment off, lest it run amok and result in villagers with pitchforks on your doorstep. In order to control whether or not an experiment is enabled, you must include the <code>enabled?</code> method in your <code>Scientist::Experiment</code> implementation.</p>
<div dir="auto" data-snippet-clipboard-copy-content="class MyExperiment
  include Scientist::Experiment

  attr_accessor :name, :percent_enabled

  def initialize(name)
    @name = name
    @percent_enabled = 100
  end

  def enabled?
    percent_enabled &gt; 0 &amp;&amp; rand(100) &lt; percent_enabled
  end

  # ...

end"><pre><span>class</span> <span>MyExperiment</span>
  <span>include</span> <span>Scientist</span>::<span>Experiment</span>

  <span>attr_accessor</span> <span>:name</span><span>,</span> <span>:percent_enabled</span>

  <span>def</span> <span>initialize</span><span>(</span><span>name</span><span>)</span>
    <span>@name</span> <span>=</span> <span>name</span>
    <span>@percent_enabled</span> <span>=</span> <span>100</span>
  <span>end</span>

  <span>def</span> <span>enabled?</span>
    <span>percent_enabled</span> &gt; <span>0</span> &amp;&amp; <span>rand</span><span>(</span><span>100</span><span>)</span> &lt; <span>percent_enabled</span>
  <span>end</span>

  <span># ...</span>

<span>end</span></pre></div>
<p dir="auto">This code will be invoked for every method with an experiment every time, so be sensitive about its performance. For example, you can store an experiment in the database but wrap it in various levels of caching such as memcache or per-request thread-locals.</p>
<h3 tabindex="-1" id="user-content-publishing-results" dir="auto"><a href="#publishing-results">Publishing results<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">What good is science if you can&#39;t publish your results?</p>
<p dir="auto">You must implement the <code>publish(result)</code> method, and can publish data however you like. For example, timing data can be sent to graphite, and mismatches can be placed in a capped collection in redis for debugging later.</p>
<p dir="auto">The <code>publish</code> method is given a <code>Scientist::Result</code> instance with its associated <code>Scientist::Observation</code>s:</p>
<div dir="auto" data-snippet-clipboard-copy-content="class MyExperiment
  include Scientist::Experiment

  # ...

  def publish(result)

    # Store the timing for the control value,
    $statsd.timing &#34;science.#{name}.control&#34;, result.control.duration
    # for the candidate (only the first, see &#34;Breaking the rules&#34; below,
    $statsd.timing &#34;science.#{name}.candidate&#34;, result.candidates.first.duration

    # and counts for match/ignore/mismatch:
    if result.matched?
      $statsd.increment &#34;science.#{name}.matched&#34;
    elsif result.ignored?
      $statsd.increment &#34;science.#{name}.ignored&#34;
    else
      $statsd.increment &#34;science.#{name}.mismatched&#34;
      # Finally, store mismatches in redis so they can be retrieved and examined
      # later on, for debugging and research.
      store_mismatch_data(result)
    end
  end

  def store_mismatch_data(result)
    payload = {
      :name            =&gt; name,
      :context         =&gt; context,
      :control         =&gt; observation_payload(result.control),
      :candidate       =&gt; observation_payload(result.candidates.first),
      :execution_order =&gt; result.observations.map(&amp;:name)
    }

    key = &#34;science.#{name}.mismatch&#34;
    $redis.lpush key, payload
    $redis.ltrim key, 0, 1000
  end

  def observation_payload(observation)
    if observation.raised?
      {
        :exception =&gt; observation.exception.class,
        :message   =&gt; observation.exception.message,
        :backtrace =&gt; observation.exception.backtrace
      }
    else
      {
        # see &#34;Keeping it clean&#34; above
        :value =&gt; observation.cleaned_value
      }
    end
  end
end"><pre><span>class</span> <span>MyExperiment</span>
  <span>include</span> <span>Scientist</span>::<span>Experiment</span>

  <span># ...</span>

  <span>def</span> <span>publish</span><span>(</span><span>result</span><span>)</span>

    <span># Store the timing for the control value,</span>
    $statsd<span>.</span><span>timing</span> <span>&#34;science.<span><span>#{</span><span>name</span><span>}</span></span>.control&#34;</span><span>,</span> <span>result</span><span>.</span><span>control</span><span>.</span><span>duration</span>
    <span># for the candidate (only the first, see &#34;Breaking the rules&#34; below,</span>
    $statsd<span>.</span><span>timing</span> <span>&#34;science.<span><span>#{</span><span>name</span><span>}</span></span>.candidate&#34;</span><span>,</span> <span>result</span><span>.</span><span>candidates</span><span>.</span><span>first</span><span>.</span><span>duration</span>

    <span># and counts for match/ignore/mismatch:</span>
    <span>if</span> <span>result</span><span>.</span><span>matched?</span>
      $statsd<span>.</span><span>increment</span> <span>&#34;science.<span><span>#{</span><span>name</span><span>}</span></span>.matched&#34;</span>
    <span>elsif</span> <span>result</span><span>.</span><span>ignored?</span>
      $statsd<span>.</span><span>increment</span> <span>&#34;science.<span><span>#{</span><span>name</span><span>}</span></span>.ignored&#34;</span>
    <span>else</span>
      $statsd<span>.</span><span>increment</span> <span>&#34;science.<span><span>#{</span><span>name</span><span>}</span></span>.mismatched&#34;</span>
      <span># Finally, store mismatches in redis so they can be retrieved and examined</span>
      <span># later on, for debugging and research.</span>
      <span>store_mismatch_data</span><span>(</span><span>result</span><span>)</span>
    <span>end</span>
  <span>end</span>

  <span>def</span> <span>store_mismatch_data</span><span>(</span><span>result</span><span>)</span>
    <span>payload</span> <span>=</span> <span>{</span>
      <span>:name</span>            <span>=&gt;</span> <span>name</span><span>,</span>
      <span>:context</span>         <span>=&gt;</span> <span>context</span><span>,</span>
      <span>:control</span>         <span>=&gt;</span> <span>observation_payload</span><span>(</span><span>result</span><span>.</span><span>control</span><span>)</span><span>,</span>
      <span>:candidate</span>       <span>=&gt;</span> <span>observation_payload</span><span>(</span><span>result</span><span>.</span><span>candidates</span><span>.</span><span>first</span><span>)</span><span>,</span>
      <span>:execution_order</span> <span>=&gt;</span> <span>result</span><span>.</span><span>observations</span><span>.</span><span>map</span><span>(</span>&amp;<span>:name</span><span>)</span>
    <span>}</span>

    <span>key</span> <span>=</span> <span>&#34;science.<span><span>#{</span><span>name</span><span>}</span></span>.mismatch&#34;</span>
    $redis<span>.</span><span>lpush</span> <span>key</span><span>,</span> <span>payload</span>
    $redis<span>.</span><span>ltrim</span> <span>key</span><span>,</span> <span>0</span><span>,</span> <span>1000</span>
  <span>end</span>

  <span>def</span> <span>observation_payload</span><span>(</span><span>observation</span><span>)</span>
    <span>if</span> <span>observation</span><span>.</span><span>raised?</span>
      <span>{</span>
        <span>:exception</span> <span>=&gt;</span> <span>observation</span><span>.</span><span>exception</span><span>.</span><span>class</span><span>,</span>
        <span>:message</span>   <span>=&gt;</span> <span>observation</span><span>.</span><span>exception</span><span>.</span><span>message</span><span>,</span>
        <span>:backtrace</span> <span>=&gt;</span> <span>observation</span><span>.</span><span>exception</span><span>.</span><span>backtrace</span>
      <span>}</span>
    <span>else</span>
      <span>{</span>
        <span># see &#34;Keeping it clean&#34; above</span>
        <span>:value</span> <span>=&gt;</span> <span>observation</span><span>.</span><span>cleaned_value</span>
      <span>}</span>
    <span>end</span>
  <span>end</span>
<span>end</span></pre></div>
<h3 tabindex="-1" id="user-content-testing" dir="auto"><a href="#testing">Testing<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">When running your test suite, it&#39;s helpful to know that the experimental results always match. To help with testing, Scientist defines a <code>raise_on_mismatches</code> class attribute when you include <code>Scientist::Experiment</code>. Only do this in your test suite!</p>
<p dir="auto">To raise on mismatches:</p>
<div dir="auto" data-snippet-clipboard-copy-content="class MyExperiment
  include Scientist::Experiment
  # ... implementation
end

MyExperiment.raise_on_mismatches = true"><pre><span>class</span> <span>MyExperiment</span>
  <span>include</span> <span>Scientist</span>::<span>Experiment</span>
  <span># ... implementation</span>
<span>end</span>

<span>MyExperiment</span><span>.</span><span>raise_on_mismatches</span> <span>=</span> <span>true</span></pre></div>
<p dir="auto">Scientist will raise a <code>Scientist::Experiment::MismatchError</code> exception if any observations don&#39;t match.</p>
<h4 tabindex="-1" id="user-content-custom-mismatch-errors" dir="auto"><a href="#custom-mismatch-errors">Custom mismatch errors<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h4>
<p dir="auto">To instruct Scientist to raise a custom error instead of the default <code>Scientist::Experiment::MismatchError</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="class CustomMismatchError &lt; Scientist::Experiment::MismatchError
  def to_s
    message = &#34;There was a mismatch! Here&#39;s the diff:&#34;

    diffs = result.candidates.map do |candidate|
      Diff.new(result.control, candidate)
    end.join(&#34;\n&#34;)

    &#34;#{message}\n#{diffs}&#34;
  end
end"><pre><span>class</span> <span>CustomMismatchError</span> &lt; <span>Scientist</span>::<span>Experiment</span>::<span>MismatchError</span>
  <span>def</span> <span>to_s</span>
    <span>message</span> <span>=</span> <span>&#34;There was a mismatch! Here&#39;s the diff:&#34;</span>

    <span>diffs</span> <span>=</span> <span>result</span><span>.</span><span>candidates</span><span>.</span><span>map</span> <span>do</span> |<span>candidate</span>|
      <span>Diff</span><span>.</span><span>new</span><span>(</span><span>result</span><span>.</span><span>control</span><span>,</span> <span>candidate</span><span>)</span>
    <span>end</span><span>.</span><span>join</span><span>(</span><span>&#34;<span>\n</span>&#34;</span><span>)</span>

    <span>&#34;<span><span>#{</span><span>message</span><span>}</span></span><span>\n</span><span><span>#{</span><span>diffs</span><span>}</span></span>&#34;</span>
  <span>end</span>
<span>end</span></pre></div>
<div dir="auto" data-snippet-clipboard-copy-content="science &#34;widget-permissions&#34; do |e|
  e.use { Report.find(id) }
  e.try { ReportService.new.fetch(id) }

  e.raise_with CustomMismatchError
end"><pre><span>science</span> <span>&#34;widget-permissions&#34;</span> <span>do</span> |<span>e</span>|
  <span>e</span><span>.</span><span>use</span> <span>{</span> <span>Report</span><span>.</span><span>find</span><span>(</span><span>id</span><span>)</span> <span>}</span>
  <span>e</span><span>.</span><span>try</span> <span>{</span> <span>ReportService</span><span>.</span><span>new</span><span>.</span><span>fetch</span><span>(</span><span>id</span><span>)</span> <span>}</span>

  <span>e</span><span>.</span><span>raise_with</span> <span>CustomMismatchError</span>
<span>end</span></pre></div>
<p dir="auto">This allows for pre-processing on mismatch error exception messages.</p>
<h3 tabindex="-1" id="user-content-handling-errors" dir="auto"><a href="#handling-errors">Handling errors<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<h4 tabindex="-1" id="user-content-in-candidate-code" dir="auto"><a href="#in-candidate-code">In candidate code<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h4>
<p dir="auto">Scientist rescues and tracks <em>all</em> exceptions raised in a <code>try</code> or <code>use</code> block, including some where rescuing may cause unexpected behavior (like <code>SystemExit</code> or <code>ScriptError</code>). To rescue a more restrictive set of exceptions, modify the <code>RESCUES</code> list:</p>
<div dir="auto" data-snippet-clipboard-copy-content="# default is [Exception]
Scientist::Observation::RESCUES.replace [StandardError]"><pre><span># default is [Exception]</span>
<span>Scientist</span>::<span>Observation</span>::<span>RESCUES</span><span>.</span><span>replace</span> <span>[</span><span>StandardError</span><span>]</span></pre></div>
<p dir="auto"><strong>Timeout ⏲️</strong>: If you&#39;re introducing a candidate that could possibly timeout, use caution. <g-emoji alias="warning">⚠️</g-emoji> While Scientist rescues all exceptions that occur in the candidate block, it <em>does not</em> protect you from timeouts, as doing so would be complicated. It would likely require running the candidate code in a background job and tracking the time of a request. We feel the cost of this complexity would outweigh the benefit, so make sure that your code doesn&#39;t cause timeouts. This risk can be reduced by running the experiment on a low percentage so that users can (most likely) bypass the experiment by refreshing the page if they hit a timeout. See <a href="#ramping-up-experiments">Ramping up experiments</a> below for how details on how to set the percentage for your experiment.</p>
<h4 tabindex="-1" id="user-content-in-a-scientist-callback" dir="auto"><a href="#in-a-scientist-callback">In a Scientist callback<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h4>
<p dir="auto">If an exception is raised within any of Scientist&#39;s internal helpers, like <code>publish</code>, <code>compare</code>, or <code>clean</code>, the <code>raised</code> method is called with the symbol name of the internal operation that failed and the exception that was raised. The default behavior of <code>Scientist::Default</code> is to simply re-raise the exception. Since this halts the experiment entirely, it&#39;s often a better idea to handle this error and continue so the experiment as a whole isn&#39;t canceled entirely:</p>
<div dir="auto" data-snippet-clipboard-copy-content="class MyExperiment
  include Scientist::Experiment

  # ...

  def raised(operation, error)
    InternalErrorTracker.track! &#34;science failure in #{name}: #{operation}&#34;, error
  end
end"><pre><span>class</span> <span>MyExperiment</span>
  <span>include</span> <span>Scientist</span>::<span>Experiment</span>

  <span># ...</span>

  <span>def</span> <span>raised</span><span>(</span><span>operation</span><span>,</span> <span>error</span><span>)</span>
    <span>InternalErrorTracker</span><span>.</span><span>track!</span> <span>&#34;science failure in <span><span>#{</span><span>name</span><span>}</span></span>: <span><span>#{</span><span>operation</span><span>}</span></span>&#34;</span><span>,</span> <span>error</span>
  <span>end</span>
<span>end</span></pre></div>
<p dir="auto">The operations that may be handled here are:</p>
<ul dir="auto">
<li><code>:clean</code> - an exception is raised in a <code>clean</code> block</li>
<li><code>:compare</code> - an exception is raised in a <code>compare</code> block</li>
<li><code>:enabled</code> - an exception is raised in the <code>enabled?</code> method</li>
<li><code>:ignore</code> - an exception is raised in an <code>ignore</code> block</li>
<li><code>:publish</code> - an exception is raised in the <code>publish</code> method</li>
<li><code>:run_if</code> - an exception is raised in a <code>run_if</code> block</li>
</ul>
<h3 tabindex="-1" id="user-content-designing-an-experiment" dir="auto"><a href="#designing-an-experiment">Designing an experiment<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">Because <code>enabled?</code> and <code>run_if</code> determine when a candidate runs, it&#39;s impossible to guarantee that it will run every time. For this reason, Scientist is only safe for wrapping methods that aren&#39;t changing data.</p>
<p dir="auto">When using Scientist, we&#39;ve found it most useful to modify both the existing and new systems simultaneously anywhere writes happen, and verify the results at read time with <code>science</code>. <code>raise_on_mismatches</code> has also been useful to ensure that the correct data was written during tests, and reviewing published mismatches has helped us find any situations we overlooked with our production data at runtime. When writing to and reading from two systems, it&#39;s also useful to write some data reconciliation scripts to verify and clean up production data alongside any running experiments.</p>
<h4 tabindex="-1" id="user-content-noise-and-error-rates" dir="auto"><a href="#noise-and-error-rates">Noise and error rates<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h4>
<p dir="auto">Keep in mind that Scientist&#39;s <code>try</code> and <code>use</code> blocks run sequentially in random order. As such, any data upon which your code depends may change before the second block is invoked, potentially yielding a mismatch between the candidate and control return values. To calibrate your expectations with respect to <a href="https://en.wikipedia.org/wiki/Type_I_and_type_II_errors" rel="nofollow">false negatives</a> arising from systemic conditions external to your proposed changes, consider starting with an experiment in which both the <code>try</code> and <code>use</code> blocks invoke the control method. Then proceed with introducing a candidate.</p>
<h3 tabindex="-1" id="user-content-finishing-an-experiment" dir="auto"><a href="#finishing-an-experiment">Finishing an experiment<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">As your candidate behavior converges on the controls, you&#39;ll start thinking about removing an experiment and using the new behavior.</p>
<ul dir="auto">
<li>If there are any ignore blocks, the candidate behavior is <em>guaranteed</em> to be different. If this is unacceptable, you&#39;ll need to remove the ignore blocks and resolve any ongoing mismatches in behavior until the observations match perfectly every time.</li>
<li>When removing a read-behavior experiment, it&#39;s a good idea to keep any write-side duplication between an old and new system in place until well after the new behavior has been in production, in case you need to roll back.</li>
</ul>
<h2 tabindex="-1" id="user-content-breaking-the-rules" dir="auto"><a href="#breaking-the-rules">Breaking the rules<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">Sometimes scientists just gotta do weird stuff. We understand.</p>
<h3 tabindex="-1" id="user-content-ignoring-results-entirely" dir="auto"><a href="#ignoring-results-entirely">Ignoring results entirely<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">Science is useful even when all you care about is the timing data or even whether or not a new code path blew up. If you have the ability to incrementally control how often an experiment runs via your <code>enabled?</code> method, you can use it to silently and carefully test new code paths and ignore the results altogether. You can do this by setting <code>ignore { true }</code>, or for greater efficiency, <code>compare { true }</code>.</p>
<p dir="auto">This will still log mismatches if any exceptions are raised, but will disregard the values entirely.</p>
<h3 tabindex="-1" id="user-content-trying-more-than-one-thing" dir="auto"><a href="#trying-more-than-one-thing">Trying more than one thing<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">It&#39;s not usually a good idea to try more than one alternative simultaneously. Behavior isn&#39;t guaranteed to be isolated and reporting + visualization get quite a bit harder. Still, it&#39;s sometimes useful.</p>
<p dir="auto">To try more than one alternative at once, add names to some <code>try</code> blocks:</p>
<div dir="auto" data-snippet-clipboard-copy-content="require &#34;scientist&#34;

class MyWidget
  include Scientist

  def allows?(user)
    science &#34;widget-permissions&#34; do |e|
      e.use { model.check_user(user).valid? } # old way

      e.try(&#34;api&#34;) { user.can?(:read, model) } # new service API
      e.try(&#34;raw-sql&#34;) { user.can_sql?(:read, model) } # raw query
    end
  end
end"><pre><span>require</span> <span>&#34;scientist&#34;</span>

<span>class</span> <span>MyWidget</span>
  <span>include</span> <span>Scientist</span>

  <span>def</span> <span>allows?</span><span>(</span><span>user</span><span>)</span>
    <span>science</span> <span>&#34;widget-permissions&#34;</span> <span>do</span> |<span>e</span>|
      <span>e</span><span>.</span><span>use</span> <span>{</span> <span>model</span><span>.</span><span>check_user</span><span>(</span><span>user</span><span>)</span><span>.</span><span>valid?</span> <span>}</span> <span># old way</span>

      <span>e</span><span>.</span><span>try</span><span>(</span><span>&#34;api&#34;</span><span>)</span> <span>{</span> <span>user</span><span>.</span><span>can?</span><span>(</span><span>:read</span><span>,</span> <span>model</span><span>)</span> <span>}</span> <span># new service API</span>
      <span>e</span><span>.</span><span>try</span><span>(</span><span>&#34;raw-sql&#34;</span><span>)</span> <span>{</span> <span>user</span><span>.</span><span>can_sql?</span><span>(</span><span>:read</span><span>,</span> <span>model</span><span>)</span> <span>}</span> <span># raw query</span>
    <span>end</span>
  <span>end</span>
<span>end</span></pre></div>
<p dir="auto">When the experiment runs, all candidate behaviors are tested and each candidate observation is compared with the control in turn.</p>
<h3 tabindex="-1" id="user-content-no-control-just-candidates" dir="auto"><a href="#no-control-just-candidates">No control, just candidates<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">Define the candidates with named <code>try</code> blocks, omit a <code>use</code>, and pass a candidate name to <code>run</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="experiment = MyExperiment.new(&#34;various-ways&#34;) do |e|
  e.try(&#34;first-way&#34;)  { ... }
  e.try(&#34;second-way&#34;) { ... }
end

experiment.run(&#34;second-way&#34;)"><pre><span>experiment</span> <span>=</span> <span>MyExperiment</span><span>.</span><span>new</span><span>(</span><span>&#34;various-ways&#34;</span><span>)</span> <span>do</span> |<span>e</span>|
  <span>e</span><span>.</span><span>try</span><span>(</span><span>&#34;first-way&#34;</span><span>)</span>  <span>{</span> ... <span>}</span>
  <span>e</span><span>.</span><span>try</span><span>(</span><span>&#34;second-way&#34;</span><span>)</span> <span>{</span> ... <span>}</span>
<span>end</span>

<span>experiment</span><span>.</span><span>run</span><span>(</span><span>&#34;second-way&#34;</span><span>)</span></pre></div>
<p dir="auto">The <code>science</code> helper also knows this trick:</p>
<div dir="auto" data-snippet-clipboard-copy-content="science &#34;various-ways&#34;, run: &#34;first-way&#34; do |e|
  e.try(&#34;first-way&#34;)  { ... }
  e.try(&#34;second-way&#34;) { ... }
end"><pre><span>science</span> <span>&#34;various-ways&#34;</span><span>,</span> <span>run</span>: <span>&#34;first-way&#34;</span> <span>do</span> |<span>e</span>|
  <span>e</span><span>.</span><span>try</span><span>(</span><span>&#34;first-way&#34;</span><span>)</span>  <span>{</span> ... <span>}</span>
  <span>e</span><span>.</span><span>try</span><span>(</span><span>&#34;second-way&#34;</span><span>)</span> <span>{</span> ... <span>}</span>
<span>end</span></pre></div>
<h4 tabindex="-1" id="user-content-providing-fake-timing-data" dir="auto"><a href="#providing-fake-timing-data">Providing fake timing data<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h4>
<p dir="auto">If you&#39;re writing tests that depend on specific timing values, you can provide canned durations using the <code>fabricate_durations_for_testing_purposes</code> method, and Scientist will report these in <code>Scientist::Observation#duration</code> instead of the actual execution times.</p>
<div dir="auto" data-snippet-clipboard-copy-content="science &#34;absolutely-nothing-suspicious-happening-here&#34; do |e|
  e.use { ... } # &#34;control&#34;
  e.try { ... } # &#34;candidate&#34;
  e.fabricate_durations_for_testing_purposes( &#34;control&#34; =&gt; 1.0, &#34;candidate&#34; =&gt; 0.5 )
end"><pre><span>science</span> <span>&#34;absolutely-nothing-suspicious-happening-here&#34;</span> <span>do</span> |<span>e</span>|
  <span>e</span><span>.</span><span>use</span> <span>{</span> ... <span>}</span> <span># &#34;control&#34;</span>
  <span>e</span><span>.</span><span>try</span> <span>{</span> ... <span>}</span> <span># &#34;candidate&#34;</span>
  <span>e</span><span>.</span><span>fabricate_durations_for_testing_purposes</span><span>(</span> <span>&#34;control&#34;</span> <span>=&gt;</span> <span>1.0</span><span>,</span> <span>&#34;candidate&#34;</span> <span>=&gt;</span> <span>0.5</span> <span>)</span>
<span>end</span></pre></div>
<p dir="auto"><code>fabricate_durations_for_testing_purposes</code> takes a Hash of duration values, keyed by behavior names.  (By default, Scientist uses <code>&#34;control&#34;</code> and <code>&#34;candidate&#34;</code>, but if you override these as shown in <a href="#trying-more-than-one-thing">Trying more than one thing</a> or <a href="#no-control-just-candidates">No control, just candidates</a>, use matching names here.)  If a name is not provided, the actual execution time will be reported instead.</p>
<p dir="auto"><em>Like <code>Scientist::Experiment#cleaner</code>, this probably won&#39;t come up in normal usage.  It&#39;s here to make it easier to test code that extends Scientist.</em></p>
<h3 tabindex="-1" id="user-content-without-including-scientist" dir="auto"><a href="#without-including-scientist">Without including Scientist<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">If you need to use Scientist in a place where you aren&#39;t able to include the Scientist module, you can call <code>Scientist.run</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="Scientist.run &#34;widget-permissions&#34; do |e|
  e.use { model.check_user(user).valid? }
  e.try { user.can?(:read, model) }
end"><pre><span>Scientist</span><span>.</span><span>run</span> <span>&#34;widget-permissions&#34;</span> <span>do</span> |<span>e</span>|
  <span>e</span><span>.</span><span>use</span> <span>{</span> <span>model</span><span>.</span><span>check_user</span><span>(</span><span>user</span><span>)</span><span>.</span><span>valid?</span> <span>}</span>
  <span>e</span><span>.</span><span>try</span> <span>{</span> <span>user</span><span>.</span><span>can?</span><span>(</span><span>:read</span><span>,</span> <span>model</span><span>)</span> <span>}</span>
<span>end</span></pre></div>
<h2 tabindex="-1" id="user-content-hacking" dir="auto"><a href="#hacking">Hacking<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">Be on a Unixy box. Make sure a modern Bundler is available. <code>script/test</code> runs the unit tests. All development dependencies are installed automatically. Scientist requires Ruby 2.3 or newer.</p>
<h2 tabindex="-1" id="user-content-wrappers" dir="auto"><a href="#wrappers">Wrappers<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<ul dir="auto">
<li><a href="https://github.com/RealGeeks/lab_tech">RealGeeks/lab_tech</a> is a Rails engine for using this library by controlling, storing, and analyzing experiment results with ActiveRecord.</li>
</ul>
<h2 tabindex="-1" id="user-content-alternatives" dir="auto"><a href="#alternatives">Alternatives<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<ul dir="auto">
<li><a href="https://github.com/daylerees/scientist">daylerees/scientist</a> (PHP)</li>
<li><a href="https://github.com/scientistproject/Scientist.net">scientistproject/scientist.net</a> (.NET)</li>
<li><a href="https://github.com/joealcorn/laboratory">joealcorn/laboratory</a> (Python)</li>
<li><a href="https://github.com/rawls238/Scientist4J">rawls238/Scientist4J</a> (Java)</li>
<li><a href="https://github.com/tomiaijo/scientist">tomiaijo/scientist</a> (C++)</li>
<li><a href="https://github.com/trello/scientist">trello/scientist</a> (node.js)</li>
<li><a href="https://github.com/ziyasal/scientist.js">ziyasal/scientist.js</a> (node.js, ES6)</li>
<li><a href="https://github.com/TrueWill/tzientist">TrueWill/tzientist</a> (node.js, TypeScript)</li>
<li><a href="https://github.com/TrueWill/paleontologist">TrueWill/paleontologist</a> (Deno, TypeScript)</li>
<li><a href="https://github.com/yeller/laboratory">yeller/laboratory</a> (Clojure)</li>
<li><a href="https://github.com/lancew/Scientist">lancew/Scientist</a> (Perl 5)</li>
<li><a href="https://github.com/lancew/ScientistP6">lancew/ScientistP6</a> (Perl 6)</li>
<li><a href="https://github.com/MadcapJake/Test-Lab">MadcapJake/Test-Lab</a> (Perl 6)</li>
<li><a href="https://github.com/cwbriones/scientist">cwbriones/scientist</a> (Elixir)</li>
<li><a href="https://github.com/calavera/go-scientist">calavera/go-scientist</a> (Go)</li>
<li><a href="https://github.com/jelmersnoeck/experiment">jelmersnoeck/experiment</a> (Go)</li>
<li><a href="https://github.com/spoptchev/scientist">spoptchev/scientist</a> (Kotlin / Java)</li>
<li><a href="https://github.com/junkpiano/scientist">junkpiano/scientist</a> (Swift)</li>
<li><a href="http://serverlessscientist.com/" rel="nofollow">serverless scientist</a> (AWS Lambda)</li>
<li><a href="https://github.com/fightmegg/scientist">fightmegg/scientist</a> (TypeScript, Browser / Node.js)</li>
<li><a href="https://github.com/MisterSpex/misterspex-scientist">MisterSpex/misterspex-scientist</a> (Java, no dependencies)</li>
</ul>
<h2 tabindex="-1" id="user-content-maintainers" dir="auto"><a href="#maintainers">Maintainers<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto"><a href="https://github.com/jbarnette">@jbarnette</a>,
<a href="https://github.com/jesseplusplus">@jesseplusplus</a>,
<a href="https://github.com/rick">@rick</a>,
and <a href="https://github.com/zerowidth">@zerowidth</a></p>
</article>
          </div></div>
  </body>
</html>
