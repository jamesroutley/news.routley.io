<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://marcellerusu.com/using_prolog_as_the_ast.html">Original</a>
    <h1>Using Prolog as the AST</h1>
    
    <div id="readability-page-1" class="page">

<p>I’ve been toying with emitting Prolog from <a href="https://github.com/coil-language/coil-lang">Coil</a> and its been
a ton of fun!</p>
<p>Here’s the basic idea:</p>
<div id="cb1"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span>// coil code</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span>let</span> ten <span>=</span> <span>10</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span>// existing coil ast</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>[</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span>type</span><span>:</span> <span>&#34;let&#34;</span><span>,</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span>assign_expr</span><span>:</span> { <span>type</span><span>:</span> <span>&#34;id_assign&#34;</span><span>,</span> <span>name</span><span>:</span> <span>&#34;ten&#34;</span> }<span>,</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span>expr</span><span>:</span> { <span>type</span><span>:</span> <span>&#34;num&#34;</span><span>,</span> <span>value</span><span>:</span> <span>10</span> }</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
<div id="cb2"><pre><code><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span>% generated prolog ast</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>id_assign(ten<span>,</span> nid_3<span>,</span> nid_2)<span>.</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>let(nid_2<span>,</span> nid_1)<span>.</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>line_and_col(nid_2<span>,</span> <span>1</span><span>,</span> <span>1</span>)<span>.</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>line_and_col(nid_3<span>,</span> <span>1</span><span>,</span> <span>5</span>)<span>.</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>num(<span>10</span><span>,</span> nid_2)<span>.</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span>% lets ignore metadata give better</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span>% names to the nids (node ids)</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>id_assign(ten<span>,</span> <span>_id_assign_ctx</span><span>,</span> let_ctx)<span>.</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>let(let_ctx<span>,</span> <span>_top_level_ctx</span>)<span>.</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>num(<span>10</span><span>,</span> let_ctx)<span>.</span></span></code></pre></div>
<p>The primary difference between these 2 approaches is that with prolog
the relationships are (easily) preserved.</p>
<p>For example when I’m traversing the AST when I’m looking at the node
<code>{ type: &#34;num&#34;, value: 10 }</code>, without doing extra work to go
back up the tree I have no way to tell that it belongs to the name
“ten”.</p>
<p>Ok, cool! But what can we do with that?</p>
<h2 id="queries">Queries</h2>
<p>Prolog has a wonderful query system.</p>
<p>Here are some queries</p>
<div id="cb3"><pre><code><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span>// coil code</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span>let</span> ten <span>=</span> <span>10</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span>let</span> twenty <span>=</span> <span>20</span></span></code></pre></div>
<div id="cb4"><pre><code><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span>% give me the name of the variable</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span>% who has the value 10</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span>?-</span> id_assign(<span>Name</span><span>,</span> <span>_</span><span>,</span> <span>Let</span>)<span>,</span> num(<span>10</span><span>,</span> <span>Let</span>)<span>.</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span>% Output:</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span>Name</span> <span>=</span> ten<span>,</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span>Let</span> <span>=</span> nid_2<span>.</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span>% Give me names for variables who&#39;s value is a number</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span>?-</span> id_assign(<span>Name</span><span>,</span> <span>_</span><span>,</span> <span>Let</span>)<span>,</span> num(<span>Val</span><span>,</span> <span>Let</span>)<span>.</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span>% Output:</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span>% first result</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span>Name</span> <span>=</span> ten<span>,</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span>Let</span> <span>=</span> nid_2<span>,</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span>Val</span> <span>=</span> <span>10</span> <span>;</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span>% second result</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span>Name</span> <span>=</span> twenty<span>,</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span>Let</span> <span>=</span> nid_4<span>,</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span>Val</span> <span>=</span> <span>20</span><span>.</span></span></code></pre></div>
<p>Prolog lets you build up helper predicates to take care of more
complex queries:</p>

<div id="cb6"><pre><code><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span>% extract id names into node context</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>value(<span>Id</span><span>,</span> <span>Out</span>) <span>:-</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  id_assign(<span>Id</span><span>,</span> <span>_</span><span>,</span> <span>Parent</span>)<span>,</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  value(<span>Parent</span><span>,</span> <span>Out</span>)<span>.</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span>% pull out values from array deconstruction</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>value(<span>Id</span><span>,</span> <span>Out</span>) <span>:-</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  array_deconstruction(<span>Id</span><span>,</span> <span>Idx</span><span>,</span> <span>Array</span>)<span>,</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  index_of(<span>Array</span><span>,</span> <span>Idx</span><span>,</span> <span>Out</span>)<span>.</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span>?-</span> value(a<span>,</span> <span>Out</span>)<span>.</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span>Out</span> <span>=</span> <span>1</span><span>.</span></span></code></pre></div>
<p>After building up the helper predicates I’ve been able to do the
following:</p>
<div id="cb7"><pre><code><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span>let</span> object <span>=</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  { <span>:</span>name <span>=&gt;</span> <span>&#34;marcelle&#34;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span>:</span>age <span>=&gt;</span> <span>26</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span>:</span>hobbies <span>=&gt;</span> [<span>:</span><span>code</span> <span>:</span>guitar] }</span></code></pre></div>
<div id="cb8"><pre><code><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span>% find all object keys for the variable &#34;object&#34;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span>?-</span> id_assign(object<span>,</span> <span>_</span><span>,</span> <span>Let</span>)<span>,</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  object_literal(<span>Object</span><span>,</span> <span>Let</span>)<span>,</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  object_key(<span>Object</span><span>,</span> <span>Key</span>)<span>.</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span>% first result</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span>Let</span> <span>=</span> nid_11<span>,</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span>Object</span> <span>=</span> nid_13<span>,</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span>Key</span> <span>=</span> keyword(name) <span>;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span>% second result</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span>Let</span> <span>=</span> nid_11<span>,</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span>Object</span> <span>=</span> nid_13<span>,</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span>Key</span> <span>=</span> keyword(age) <span>;</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span>% third result</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span>Let</span> <span>=</span> nid_11<span>,</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span>Object</span> <span>=</span> nid_13<span>,</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span>Key</span> <span>=</span> keyword(hobbies)<span>.</span></span></code></pre></div>
<div id="cb9"><pre><code><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span>let</span> list <span>=</span> [<span>1</span> <span>2</span>]</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span>let</span> list <span>=</span> <span>2</span></span></code></pre></div>
<div id="cb10"><pre><code><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span>% lets find all times a variable has been</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span>% redefined to a different type</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span>?-</span> value(<span>Name</span><span>,</span> <span>First</span>)<span>,</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  value(<span>Name</span><span>,</span> <span>Second</span>)<span>,</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  type(<span>First</span><span>,</span> <span>FirstType</span>)<span>,</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  type(<span>Second</span><span>,</span> <span>SecondType</span>)<span>,</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span>FirstType</span> <span>\=</span> <span>SecondType</span><span>.</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span>% Output:</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span>Name</span> <span>=</span> list<span>,</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span>First</span> <span>=</span> [<span>1</span>, <span>2</span>]<span>,</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span>Second</span> <span>=</span> <span>2</span><span>,</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span>FirstType</span> <span>=</span> array<span>,</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span>SecondType</span> <span>=</span> <span>number</span><span>.</span></span></code></pre></div>
<h2 id="conclusion">Conclusion</h2>
<p>So now what? Well, mostly I think its cool.</p>
<p>My long term hopes is to build an end-user linter system for coil
using prolog, but that’s the future, for now its just fun :)</p>


</div>
  </body>
</html>
