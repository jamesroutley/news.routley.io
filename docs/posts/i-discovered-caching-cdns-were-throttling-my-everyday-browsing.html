<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.abctaylor.com/how-i-discovered-caching-cdns-were-throttling-my-everyday-browsing/">Original</a>
    <h1>I discovered caching CDNs were throttling my everyday browsing</h1>
    
    <div id="readability-page-1" class="page"><div>
<div>
<div><h2>How I discovered caching CDNs were throttling my everyday browsing</h2>







</div>



<div>
<div><figure><img width="2560" height="1920" src="https://blog.abctaylor.com/wp-content/uploads/2023/11/rack-scaled.jpg" alt="A Cisco ISR 1117-4P router and a Nexus 3K switch, with a patch panel and a Catalyst 3750 switch with lots of wires plugged into it" decoding="async" fetchpriority="high" srcset="https://blog.abctaylor.com/wp-content/uploads/2023/11/rack-scaled.jpg 2560w, https://blog.abctaylor.com/wp-content/uploads/2023/11/rack-300x225.jpg 300w, https://blog.abctaylor.com/wp-content/uploads/2023/11/rack-1024x768.jpg 1024w, https://blog.abctaylor.com/wp-content/uploads/2023/11/rack-768x576.jpg 768w, https://blog.abctaylor.com/wp-content/uploads/2023/11/rack-1536x1152.jpg 1536w, https://blog.abctaylor.com/wp-content/uploads/2023/11/rack-2048x1536.jpg 2048w" sizes="(max-width: 2560px) 100vw, 2560px"/></figure></div>
</div>
</div>
</div><div><div>
<h2>My ISP has never been amazing‚Ä¶</h2>



<p>Browsing the Internet was getting worse and worse, but too unpredictable to see a clear pattern. Speed tests were fine, many websites loaded perfectly, but enough didn‚Äôt work, so it was worth investigating. Apple TV+ would crap out, but only if casting via AirPlay. BBC News wouldn‚Äôt load at all, but iPlayer would slowly.</p>



<h2>The network</h2>



<p>I have a VDSL2 line, Ubiquiti Wi-Fi and standard Catalyst switches. Nothing too weird.  I pay for a /29 block, so I have multiple usable IP addresses. Yes I host my own mail, and yes, I do DKIM, DMARC and SPF, and MXToolbox shows I‚Äôm not on any blocklists.</p>



<figure><img decoding="async" width="1024" height="330" src="https://blog.abctaylor.com/wp-content/uploads/2023/11/image-8-1024x330.png" alt="" srcset="https://blog.abctaylor.com/wp-content/uploads/2023/11/image-8-1024x330.png 1024w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-8-300x97.png 300w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-8-768x247.png 768w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-8.png 1391w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<h2>The symptoms</h2>



<figure><table><thead><tr><th><mark>Working</mark></th><th><mark>Not working</mark></th></tr></thead><tbody><tr><td>most websites load fine</td><td>but many not at all</td></tr><tr><td>800Mbps iperf across the LAN</td><td></td></tr><tr><td>Stable 39 Mbps down / 7 Mbps up</td><td></td></tr><tr><td>Stable 6ms ping to 1.1.1.1</td><td></td></tr><tr><td>PPP is stable and not dropping</td><td></td></tr><tr><td>AirPlay to LG TV works (via a Unifi AP)</td><td>but crashes once per show</td></tr><tr><td>AirPlay to LG TV works (TV wired in)</td><td>still crashes</td></tr><tr><td>Spotify can stream to a Bose Soundbar</td><td>but changing song takes 30sec+</td></tr><tr><td>DNS is fine</td><td></td></tr><tr><td></td><td>iOS app downloads take 3min to start</td></tr><tr><td>Swapping Cisco VDSL2 router for the ISP‚Äôs router makes some sites now work</td><td>but not all sites</td></tr></tbody></table></figure>



<h2>The cause</h2>



<p>The freebie ISP router has IPv6 enabled by default, so would speak to the CDNs from the clean v6 range. <strong>When using my equipment without IPv6 configured, I can only speak on the IPv4 range</strong> that‚Äôs ‚Äúshadow banned‚Äù.</p>



<h2>Proving my theory</h2>



<h3>Step 1: VPN egress traversing bad ISP‚Äôs network</h3>



<p>I set up a WireGuard tunnel to another site I have in the Isle of Man, supplied by another ISP. I forwarded all traffic from my workstation via this tunnel:</p>



<figure><img decoding="async" width="1024" height="219" src="https://blog.abctaylor.com/wp-content/uploads/2023/11/image-12-1024x219.png" alt="" srcset="https://blog.abctaylor.com/wp-content/uploads/2023/11/image-12-1024x219.png 1024w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-12-300x64.png 300w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-12-768x164.png 768w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-12-1536x328.png 1536w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-12.png 1735w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p>I now pop out in the Isle of Man:</p>



<figure><img decoding="async" loading="lazy" width="1024" height="475" src="https://blog.abctaylor.com/wp-content/uploads/2023/11/image-10-1024x475.png" alt="" srcset="https://blog.abctaylor.com/wp-content/uploads/2023/11/image-10-1024x475.png 1024w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-10-300x139.png 300w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-10-768x356.png 768w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-10-1536x712.png 1536w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-10.png 1883w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p>via ASN 42455‚Äôs network (www.infobyip.com to test):</p>



<figure><img decoding="async" loading="lazy" width="1024" height="259" src="https://blog.abctaylor.com/wp-content/uploads/2023/11/image-11-e1700657251771-1024x259.png" alt="" srcset="https://blog.abctaylor.com/wp-content/uploads/2023/11/image-11-e1700657251771-1024x259.png 1024w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-11-e1700657251771-300x76.png 300w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-11-e1700657251771-768x195.png 768w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-11-e1700657251771.png 1216w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p>and can surf and stream as normal:</p>



<figure><video autoplay="" loop="" muted="" src="https://blog.abctaylor.com/wp-content/uploads/2023/11/Websites-reloading-Webm-version.webm" playsinline=""></video></figure>



<h3>Step 2: Wireshark deep-dive</h3>



<p>I took two captures of my workstation visiting bbc.co.uk in Chrome. The first without the WireGuard tunnel on, and the second with it on. Let‚Äôs look at <code>tcp</code> traffic:</p>



<p><strong>Without WireGuard:</strong></p>



<figure><img decoding="async" loading="lazy" src="https://blog.abctaylor.com/wp-content/uploads/2023/11/image-14-1024x635.png" alt="Screen capture of WireShark showing no meaningful TCP traffic making it through" width="740" height="459" srcset="https://blog.abctaylor.com/wp-content/uploads/2023/11/image-14-1024x635.png 1024w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-14-300x186.png 300w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-14-768x476.png 768w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-14-1536x953.png 1536w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-14-2048x1270.png 2048w" sizes="(max-width: 740px) 100vw, 740px"/><figcaption>No meaningful TCP traffic makes it out. A lot of retransmissions and duplicate ACKs are happening</figcaption></figure>



<p><strong>With WireGuard:</strong></p>



<figure><img decoding="async" loading="lazy" width="1024" height="599" src="https://blog.abctaylor.com/wp-content/uploads/2023/11/image-13-1024x599.png" alt="Screen capture of WireShark when the WireGuard VPN is running to the Isle of Man site, showing lots of TCP traffic passing" srcset="https://blog.abctaylor.com/wp-content/uploads/2023/11/image-13-1024x599.png 1024w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-13-300x175.png 300w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-13-768x449.png 768w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-13-1536x898.png 1536w, https://blog.abctaylor.com/wp-content/uploads/2023/11/image-13-2048x1198.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/><figcaption>A nice healthy TCP session</figcaption></figure>



<p><em>(I disabled checksum verification in the screenshots above, as I‚Äôm capturing on the same machine having problems, which also has checksum offloading on the NIC.)</em></p>



<h2><em>Zen Broadband</em>, my ISP (for now)</h2>



<p>I‚Äôll save my views on Zen for when this case is resolved. I‚Äôve got so far through the support process I‚Äôm now dealing with their Network Ops team to investigate this. They can still redeem themselves by simply giving me a different /29 block as far away from 82.71.78.0/29 as possible üôÇ</p>



<h2>Be more specific. What do you mean by ‚Äúthrottled‚Äù?</h2>



<p>The blocking is nondeterministic. Whilst Akamai (who offers a reputation check) returns one of my IPs as clean, websites of their customers like eBay have shown the throttling behaviour. Apple TV+ appears to be served by Akamai too (tv.apple.com), which has been the worst offender for ‚Äúthrottling‚Äù my streaming:</p>



<div data-code-block-pro-font-family="Code-Pro-JetBrains-Mono"><pre tabindex="0"><code><span><span>PS</span><span> </span><span>C</span><span>:\</span><span>WINDOWS</span><span>\system32&gt; nslookup tv.apple.com</span></span>
<span><span>Server</span><span>:  dc1-lon.core.*********.net</span></span>
<span><span>Address</span><span>:  10.*.*.*</span></span>
<span></span>
<span><span>Non</span><span>-authoritative answer:</span></span>
<span><span>Name</span><span>:    e673.dsce9.akamaiedge.net</span></span>
<span><span>Addresses</span><span>:  2a02:26f0:fd00:</span><span>1088</span><span>::2a1</span></span>
<span><span>          2a02:26f0:fd00:109a::2a1</span></span>
<span><span>          2a02:26f0:fd00:</span><span>1081</span><span>::2a1</span></span>
<span><span>          2a02:26f0:fd00:</span><span>1098</span><span>::2a1</span></span>
<span><span>          2a02:26f0:fd00:</span><span>1093</span><span>::2a1</span></span>
<span><span>          </span><span>88.221</span><span>.</span><span>41.37</span></span>
<span><span>Aliases</span><span>:  tv.apple.com</span></span>
<span><span>          itunes-cdn.itunes-apple.com.akadns.net</span></span>
<span><span>          itunes.apple.com.edgekey.net</span></span></code></pre></div>



<p>It‚Äôs also available with IPv6, explaining the freebie ISP router theory.</p>



<p>Fastly doesn‚Äôt offer a rep check on their website but bbc.co.uk right now won‚Äôt load at all. Cloudflare is opaque too about disclosing what IPs they‚Äôre throttling.</p>



<h2>Why would a range get throttled or ‚Äúshadow banned‚Äù?</h2>



<p>This is extremely difficult to answer and I have no good theory. The same IP range handles my email and I generally have no trouble emailing major providers like Gmail, Outlook, Yahoo!, and many other counterparties.</p>
</div>





</div></div>
  </body>
</html>
