<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tldr.engineering/how-i-found-and-fixed-a-vulnerability-in-python/">Original</a>
    <h1>I found (and fixed) a vulnerability in Python</h1>
    
    <div id="readability-page-1" class="page"><div><p>Following <a href="https://portswigger.net/research/practical-web-cache-poisoning">research</a> done by James Kettle on web cache poisoning, I decided to deepen my knowledge in this field and explore these vulnerabilities in the open source domain. I focused my research on the most popular web frameworks, such as Flask, Bottle, and Tornado. I couldn&#39;t imagine that this research would end up in me fixing a security vulnerability in Python 3.9.</p><hr/><p>But wait - let&#39;s start at the beginning. As part of my research, I set up local instances of these frameworks so I can try to exploit them. Many of them were <a href="https://snyk.io/blog/cache-poisoning-in-popular-open-source-packages/">deemed vulnerable</a>, but the Tornado one caught my attention. It was because Tornadoâ€™s maintainer told me that they <a href="https://github.com/tornadoweb/tornado/blob/5913aa43ecfdaa76876fc57867062227b907b1dd/tornado/httputil.py#L382">were using</a> Pythonâ€™s <a href="https://github.com/python/cpython/blob/3c0ac18504cfeed822439024339d5717f42bdd66/Lib/urllib/parse.py#L739">standard library</a> for parsing the URL.</p><h4 id="python%E2%80%99s-source-code">Pythonâ€™s source code</h4><p>When I looked at Pythonâ€™s source code, it became clear to me that the vulnerability was much more critical and profound than I thought it was - all packages that used Pythonâ€™s standard library were vulnerable. </p><p>The <code>urlparse</code> module treated semicolon as a separator - whereas most proxies only took ampersands as separators. That meant that when the attacker could separate query parameters using a semicolon (;), they could have caused a difference in the interpretation of the request between the proxy (running with default configuration) and the server, resulting in malicious requests being cached as safe ones.</p><h4 id="exploitation-example">Exploitation example</h4><pre><code>GET /?link=http://google.com&amp;utm_content=1;link=&#39;&gt;&lt;t&gt;alert(1)&lt;/script&gt; HTTP/1.1

Host: somesite.com

Upgrade-Insecure-Requests: 1		

User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36

Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,imag e/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9 Accept-Encoding: gzip, deflate			

Accept-Language: en-US,en;q=0.9 Connection: close	

</code></pre><p><code>urlparse</code> saw 3 parameters here: <code>link</code>, <code>utm_content</code>, and then <code>link</code> again. On the other hand, the proxy considered this full string: <code>1;link=&#39;&gt;&lt;t&gt;alert(1)&lt;/script&gt;</code> as the value of <code>utm_content</code>, which is why the cache key would have only contained <code>somesite.com/?link=http://google.com </code>.</p><p>I immediately contacted the Python security team and opened a <a href="https://bugs.python.org/issue42967">bug ticket</a>. I also created a <a href="https://github.com/python/cpython/pull/24297">pull request</a> on the CPython repository. It took about a month of going back and forth with the PR, during which I have learned to adhere to Pythonâ€™s contributorsâ€™ rules - and it <strong>got merged </strong>ðŸŽ‰ on Feb 15 and released on <a href="https://docs.python.org/3/whatsnew/3.9.html">Feb 19</a>. The fix was backported to older versions of Python as well.</p><figure><img src="https://tldr.engineering/content/images/2021/12/Screen-Shot-2021-12-25-at-2.11.44.png" alt="" loading="lazy" width="804" height="195" srcset="https://tldr.engineering/content/images/size/w600/2021/12/Screen-Shot-2021-12-25-at-2.11.44.png 600w, https://tldr.engineering/content/images/2021/12/Screen-Shot-2021-12-25-at-2.11.44.png 804w" sizes="(min-width: 720px) 720px"/></figure><hr/><p>The moral of the story is to always strive to dig deeper. You think you found something interesting? <strong>challenge</strong> your hypothesis and think about the <strong>root cause</strong>, try to find it further along the chain, which might lead to even more fascinating results.</p></div></div>
  </body>
</html>
