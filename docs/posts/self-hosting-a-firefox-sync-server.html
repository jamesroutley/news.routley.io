<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.diego.dev/posts/firefox-sync-server/">Original</a>
    <h1>Self-Hosting a Firefox Sync Server</h1>
    
    <div id="readability-page-1" class="page"><div><p>After switching from Firefox to LibreWolf, I became interested in the idea of self-hosting my own Firefox Sync server.
Although I had seen this was possible before, I had never really looked into it—until now. I embarked on a journey to
set this up, and while it wasn’t completely smooth sailing, I eventually got it working. Here’s how it went.</p><h2 id="finding-the-right-sync-server">Finding the Right Sync Server</h2><h3 id="initial-search-mozillas-sync-server-repo">Initial Search: Mozilla’s Sync Server Repo</h3><p>I started by searching for “firefox sync server github” and quickly
found <a href="https://github.com/mozilla-services/syncserver">Mozilla’s syncserver repo</a>. This is an all-in-one package
designed for self-hosting a Firefox Sync server. It bundles both the tokenserver for authentication and syncstorage for
storage, which sounded like exactly what I needed.</p><p>However, there were two red flags:</p><ol><li>The repository had “failed” tags in the build history.</li><li>A warning was prominently displayed stating that the repository was no longer being maintained and pointing to a new
project in Rust.</li></ol><h3 id="switching-to-rust-syncstorage-rs">Switching to Rust: syncstorage-rs</h3><p>With that in mind, I followed the link to <a href="https://github.com/mozilla-services/syncstorage-rs">syncstorage-rs</a>, which is
a modern, Rust-based version of the original project. It seemed like the more viable option, so I decided to move
forward with this one. But first, I wanted to check if there was a ready-to-go Docker image to make deployment easier.
Unfortunately, there wasn’t one, but the documentation did mention running it with Docker.</p><p>This is where things started to get complicated.</p><h2 id="diving-into-docker-confusion-and-complexity">Diving Into Docker: Confusion and Complexity</h2><h3 id="documentation-woes">Documentation Woes</h3><p>The Docker documentation had some strange parts. For example, it mentioned:</p><ul><li>Ensuring that <code>grpcio</code> and <code>protobuf</code> versions matched the versions used by <code>google-cloud-rust-raw</code>. This sounded
odd—shouldn’t Docker handle version dependencies automatically?</li><li>Another confusing part was the instruction to manually copy the contents of <code>mozilla-rust-sdk</code> into the top-level root
directory. Again, why wasn’t this step automated in the Dockerfile?</li></ul><p>At this point, I was feeling a bit uneasy but decided to push forward. I reviewed the repo, the Dockerfile, the
Makefile, and the circleci workflows. Despite all that, I was still unsure how to proceed.</p><h3 id="a-simpler-solution-syncstorage-rs-docker">A Simpler Solution: syncstorage-rs-docker</h3><p>I then stumbled upon <a href="https://github.com/dan-r/syncstorage-rs-docker">dan-r’s syncstorage-rs-docker repo</a>, which had a
much simpler Docker setup. The description explained that the author had also encountered issues with the
original documentation and decided to create a Docker container for their own infrastructure.</p><p>At this point, I felt reassured that I wasn’t alone in my confusion, and decided to give this setup a try.</p><h2 id="setting-up-the-server-docker-compose-and-mariadb">Setting Up the Server: Docker Compose and MariaDB</h2><h3 id="docker-compose-setup">Docker Compose Setup</h3><p>I copied the following services into my <code>docker-compose.yaml</code>:</p><div><pre tabindex="0"><code data-lang="yaml"><span><span><span>  </span><span>firefox_mariadb</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>container_name</span><span>:</span><span> </span><span>firefox_mariadb</span><span>
</span></span></span><span><span><span>    </span><span>image</span><span>:</span><span> </span><span>linuxserver/mariadb:10.6.13</span><span>
</span></span></span><span><span><span>    </span><span>volumes</span><span>:</span><span>
</span></span></span><span><span><span>      </span>- <span>/data/ffsync/dbdata:/config</span><span>
</span></span></span><span><span><span>    </span><span>restart</span><span>:</span><span> </span><span>unless-stopped</span><span>
</span></span></span><span><span><span>    </span><span>environment</span><span>:</span><span>
</span></span></span><span><span><span>      </span><span>MYSQL_DATABASE</span><span>:</span><span> </span><span>syncstorage</span><span>
</span></span></span><span><span><span>      </span><span>MYSQL_USER</span><span>:</span><span> </span><span>sync</span><span>
</span></span></span><span><span><span>      </span><span>MYSQL_PASSWORD</span><span>:</span><span> </span><span>syncpass</span><span>
</span></span></span><span><span><span>      </span><span>MYSQL_ROOT_PASSWORD</span><span>:</span><span> </span><span>rootpass</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>  </span><span>firefox_syncserver</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>container_name</span><span>:</span><span> </span><span>firefox_syncserver</span><span>
</span></span></span><span><span><span>    </span><span>build</span><span>:</span><span>
</span></span></span><span><span><span>      </span><span>context</span><span>:</span><span> </span><span>/root/ffsync</span><span>
</span></span></span><span><span><span>      </span><span>dockerfile</span><span>:</span><span> </span><span>Dockerfile</span><span>
</span></span></span><span><span><span>      </span><span>args</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>BUILDKIT_INLINE_CACHE</span><span>:</span><span> </span><span>1</span><span>
</span></span></span><span><span><span>    </span><span>restart</span><span>:</span><span> </span><span>unless-stopped</span><span>
</span></span></span><span><span><span>    </span><span>ports</span><span>:</span><span>
</span></span></span><span><span><span>      </span>- <span>&#34;8000:8000&#34;</span><span>
</span></span></span><span><span><span>    </span><span>depends_on</span><span>:</span><span>
</span></span></span><span><span><span>      </span>- <span>firefox_mariadb</span><span>
</span></span></span><span><span><span>    </span><span>environment</span><span>:</span><span>
</span></span></span><span><span><span>      </span><span>LOGLEVEL</span><span>:</span><span> </span><span>info</span><span>
</span></span></span><span><span><span>      </span><span>SYNC_URL</span><span>:</span><span> </span><span>https://mydomain/sync</span><span>
</span></span></span><span><span><span>      </span><span>SYNC_CAPACITY</span><span>:</span><span> </span><span>5</span><span>
</span></span></span><span><span><span>      </span><span>SYNC_MASTER_SECRET</span><span>:</span><span> </span><span>mastersecret</span><span>
</span></span></span><span><span><span>      </span><span>METRICS_HASH_SECRET</span><span>:</span><span> </span><span>metricssecret</span><span>
</span></span></span><span><span><span>      </span><span>SYNC_SYNCSTORAGE_DATABASE_URL</span><span>:</span><span> </span><span>mysql://sync:usersync@firefox_mariadb:3306/syncstorage_rs</span><span>
</span></span></span><span><span><span>      </span><span>SYNC_TOKENSERVER_DATABASE_URL</span><span>:</span><span> </span><span>mysql://sync:usersync@firefox_mariadb:3306/tokenserver_rs</span><span>
</span></span></span></code></pre></div><p>A few tips:</p><ul><li>Be cautious with the database passwords. Avoid using special characters like <code>&#34;/|%&#34;</code> as they can cause issues during
setup.</li><li>I added the BUILDKIT_INLINE_CACHE argument to the Docker Compose file to make better use of caching, which reduced
build time while testing.</li></ul><h3 id="initializing-the-database">Initializing the Database</h3><p>I cloned the repository and copied the Dockerfile and <code>initdb.sh</code> script to my server. After making some tweaks, I ran
the following steps to get the database up and running:</p><ol><li>Bring up the MariaDB container:<div><pre tabindex="0"><code data-lang="bash"><span><span>docker-compose up -d firefox_mariadb
</span></span></code></pre></div></li><li>Make the initialization script executable and run it:<div><pre tabindex="0"><code data-lang="bash"><span><span>chmod +x initdb.sh
</span></span><span><span>./initdb.sh
</span></span></code></pre></div></li></ol><h3 id="bringing-the-stack-online">Bringing the Stack Online</h3><p>Finally, I brought up the entire stack with:</p><h2 id="configuring-reverse-proxy-with-caddy">Configuring Reverse Proxy with Caddy</h2><p>Next, I needed to update my Caddy reverse proxy to point to the new Sync server. I added the following configuration:</p><div><pre tabindex="0"><code data-lang="bash"><span><span>mydomain:443 <span>{</span>
</span></span><span><span>     reverse_proxy firefox_syncserver:8000 <span>{</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>After updating Caddy with the DNS entry, I restarted the proxy and the sync server was up and running.</p><h2 id="challenges-faced">Challenges Faced</h2><p>While I eventually got everything working, there were a few notable challenges along the way:</p><ol><li><strong>Database persistence</strong>: I had issues with persistent data when restarting the MariaDB container. Make sure to clear
out old data if needed.</li><li><strong>Server storage</strong>: My server ran out of space during the build process due to the size of the Docker images and
intermediate files.</li><li><strong>Following the right steps</strong>: It took me a while to figure out the right steps, and much of the time was spent
experimenting with the Docker setup.</li></ol><h2 id="final-thoughts">Final Thoughts</h2><p>Setting up a self-hosted Firefox Sync server is not the easiest task, especially if you’re not very familiar with Docker
or database management. The official documentation is confusing, but thanks to community efforts like
the <code>syncstorage-rs-docker</code> repo, it’s doable.</p><p>In the end, it took me about two hours to get everything running, but it was worth it. If you’re looking to control your
own Firefox Sync server, this guide should help you avoid some of the pitfalls I encountered.</p><p>Happy syncing!</p></div></div>
  </body>
</html>
