<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://banteg.xyz/posts/crimsonland/">Original</a>
    <h1>Resurrecting Crimsonland – Decompiling and preserving a cult 2003 classic game</h1>
    
    <div id="readability-page-1" class="page"><div id="quarto-content">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main id="quarto-document-content">



<p>some games die quietly. they get delisted, lose their multiplayer servers, fade into the digital void. others get remastered by the original authors with slightly better graphics and a battle pass.</p>
<p>and then there’s the third way: you open the binary in ghidra and start naming functions.</p>
<section id="the-history">
<h2 data-anchor-id="the-history">the history</h2>
<p><strong>crimsonland</strong> (2003, remastered 2014, resurrected 2026) is a top-down shooter from the era when indie games were still called “shareware” and steam was something that came out of radiators. you play as a small man with a gun. things try to touch you. you shoot them. eventually there are too many things. you die. it’s perfect.</p>
<p>i remember vividly downloading it on a 56k modem and playing with a friend. the tiny 7.5mb game had us entertained for months. it was the first game by a finnish studio 10tons. they initially made a free game in 2002. i preserved a few of those early freeware versions:</p>
<p><a href="https://paq.crimson.banteg.xyz/freeware/crimsonland_v1.0.2.zip">v1.0.2</a> from may 2002 is an early prototype that establishes core mechanics.</p>
<p><a href="https://paq.crimson.banteg.xyz/freeware/crimsonland_v1.3.0.zip">v1.3.0</a> from july 2002 adds 3 music tracks not heard later in the shareware version. you can listen to them <a href="https://soundcloud.com/slepoy/sets/crimsonland-ost">here</a> as tracks 10-12.</p>
<p><a href="https://paq.crimson.banteg.xyz/freeware/crimsonland_v1.4.0.zip">v1.4.0</a> from september 2002 is the final free version before 10tons heard the big news: the game got picked up by reflexive arcade, a major publisher at the time. the shareware version has seen release in april 2003 and it has spread like wildfire, including cover CDs of various game magazines.</p>
<p>the shareware version is known as v1.8.x-1.9.x series, with v1.9.8 from september 2003 receiving a cult following for some of the most overpowered combos possible of all versions. after reflexive shut down in 2010, there was another update v1.9.93 that has added widescreen support (960x800). the very same version has later become a free bonus on <a href="https://www.gog.com/en/game/crimsonland">gog.com</a> when the studio has made a remaster in 2014.</p>
<p>but let’s not get ahead of ourselves. the game got a cult following, the studio was teasing crimsonland 2 with features like network multiplayer and a fully rewritten engine. this archived blog <a href="https://web.archive.org/web/20140810035045/http://legacy.crimsonland.com/?menu=news_2005_2007">page</a> is the most representative of the sequel hopium. the forum was swarming with theories and excitement. here are some of the concepts that were posted (<a href="https://web.archive.org/web/20081025021405/http://www.10tons.org/crimsonforum/viewtopic.php?id=69">source</a>):</p>

<p>by 2010 it was clear that crimsonland 2 was not going to happen. the studio has long shifted their focus to casual mobile games (infinite money glitch) that look more like zuma deluxe rather than their first game.</p>
<p>in 2013 the studio floats a remaster idea via steam greenlight, and the game sees a steam release on june 11, 2014. a gog.com release came a month later, and osx (now macos), linux, ps4, xbox releases have followed.</p>
<div>
<div>
<div>
<div>
<figure>
<p><img src="https://banteg.xyz/posts/crimsonland/cl2003-menu.avif"/></p>
<figcaption>crimsonland 2003</figcaption>
</figure>
</div>
</div>
<div>
<div>
<figure>
<p><img src="https://banteg.xyz/posts/crimsonland/cl2014-menu.avif"/></p>
<figcaption>crimsonland 2014</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>the game has its fans, but my heart lies there, in 2003, with the original mechanics.</p>
</section>
<section id="the-project">
<h2 data-anchor-id="the-project">the project</h2>
<p>not gonna lie, i was interested in understanding what makes this game tick at a deeper level for a long time. i tried decompiling it, i came back to making clones decades apart. something about it was alluring.</p>
<p>by the time i started this project on january 16, 2026, i had a pretty good understanding of things like the custom formats the game uses. i could unpack and repack assets.</p>
<p>in my previous attempt around start of 2025 i loaded it in binary ninja and went back and forth with llms to gradually rename functions. this works for about three hours, then you start questioning your career choices.</p>
<p>now i could partially automate the loop with coding agents that never get tired, and if i set it up well enough, hopefully the errors won’t snowball. for this project i used codex with gpt-5.2 exclusively, as i found it to be the most rigorous agentic model.</p>
<p>about 4 days into the decompile and 653 commits in i finally understood my goal.</p>
<p>not a spiritual successor. not a modernization. not “inspired by.”</p>
<p>the goal is a complete rewrite that matches the original windows binary behavior exactly. if the original has a bug, the rewrite has the same bug. if there’s a texture that’s one pixel too small (there is), i replicate that too. the executable is the spec, and we’re writing the spec back into source code.</p>
<p>three rules:</p>
<ol type="1">
<li><p>full fidelity. all behavior must match the gog classic build (v1.9.93, built february 2011). this is our specimen.</p></li>
<li><p>no guessing. every reimplemented function must trace back to decompiled code or runtime evidence. when the decompiler lies, i instrument the running binary.</p></li>
<li><p>no dependencies on the original runtime. assets load from the original archives, but all code is written from scratch.</p></li>
</ol>
</section>
<section id="the-patient">
<h2 data-anchor-id="the-patient">the patient</h2>
<p>the version of <code>crimsonland.exe</code> we are working with is a directx 8.1 game built in visual studio 2003 (vc++ 7.1 sp1). the binary has zero information that is helpful for reverse engineering it. it also comes with <code>grim.dll</code>, which is the game engine (grim2d). the remaster uses a different engine. i found <code>NX</code> symbols in the linux remaster (unstripped!), so i think it’s called nexus.</p>
<p>the binary is fascinatingly naked. 378kb of uninitialized data in the <code>.data</code> section. no names or types preserved for us to rely on. for the first ~800 commits i was just shooting in the dark.</p>
<p>the more i was looking at the game, this time capsule of early-2000s game architecture, the more i understood that i wouldn’t get any help. there were no lua scripts and everything was hardcoded in the exe.</p>
<p>so our starting point is missing names + missing types + missing calling conventions + c++/com indirection courtesy of directx 8 and grim.dll. everything is “object pointer → vtable → function pointer call”. the usual decompiler output looked somewhat like this:</p>
<div id="cb1"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span>(**(</span>code <span>**)(*(</span><span>int</span> <span>*)</span>this <span>+</span> <span>0x114</span><span>))(</span>this<span>,</span> <span>...)</span></span></code></pre></div>
<p>the rendering engine lives in <code>grim.dll</code>, a separate binary that exports just one function: <code>GRIM__GetInterface</code>. this hands you a pointer to an 84-method vtable wrapping direct3d 8, directinput, and a custom 2d sprite renderer. you don’t call direct3d. you call <code>grim-&gt;BindTexture()</code>, <code>grim-&gt;DrawQuad()</code>. everything is indirect.</p>
<p>that vtable becomes a rosetta stone. map entry <code>0x114</code> to <code>set_color(r,g,b,a)</code> and suddenly you can interpret some draw sequences. record runtime calls and compare them to your rewrite.</p>
<p>i needed a good setup to illuminate the path.</p>
<div>
<figure>
<p><img src="https://banteg.xyz/posts/crimsonland/vtable1.avif"/></p>
<figcaption>the biggest unlock in mapping vtables</figcaption>
</figure>
</div>
</section>
<section id="static-analysis">
<h2 data-anchor-id="static-analysis">static analysis</h2>
<p>there are two different ways to study an executable: static analysis and runtime analysis. i used both in this project extensively.</p>
<p>for static analysis there are basically three heavyweights:</p>
<ul>
<li>ida pro, the oldest and the most expensive, but offers the highest quality decompile for that era.</li>
<li>binary ninja, often just called binja, also paid and quite featureful. it supports multi-level disassembly going from assembly to high-level intermediate language and pseudo rust. binja is easily scriptable with python.</li>
<li>ghidra, which is completely free and also quite scriptable with java. it’s the easiest to run in headless mode.</li>
</ul>
<section id="ghidra">
<h3 data-anchor-id="ghidra">ghidra</h3>
<p>i set up ghidra in a devcontainer and started shaping up the pipeline. within hours i had a 101,412 line long decompile with raw names like <code>FUN_00430af0</code> and <code>DAT_0049bf74</code>. since im only interested in the game logic, the logical first step is to eliminate the embedded <a href="https://crimson.banteg.xyz/third-party-libs/">third-party libraries</a>. <code>grim.dll</code> statically linked libpng, libjpeg, zlib. it was often possible to identify the right versions from things like <code>png_create_read_struct(&#34;1.0.5&#34;, ...)</code>, <code>deflate 1.1.3</code>, provide the appropriate headers, so ghidra could recognize their structs.</p>
<p>on day 1 i started a <code>name_map.json</code>, where i documented all the function renames and types i identified so far. since each rename was only our guess, it was important to document our logic. behavior observed to name inferred. string literals, call patterns, struct sizes, and relationships to already-named functions all serve as evidence.</p>
<p>for example, our agent observes that a function searches existing entry by name, allocates a 0x24 entry when missing, strdup’s name/value, parses float via crt_atof_l, and is used by register_core_cvars with “cv_*” strings. it renames <code>FUN_00402350</code> to <code>console_register_cvar</code> and adds an entry to our map.</p>
<div id="cb2"><pre><code><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span>{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span>&#34;program&#34;</span><span>:</span> <span>&#34;crimsonland.exe&#34;</span><span>,</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span>&#34;address&#34;</span><span>:</span> <span>&#34;0x00402350&#34;</span><span>,</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span>&#34;name&#34;</span><span>:</span> <span>&#34;console_register_cvar&#34;</span><span>,</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span>&#34;signature&#34;</span><span>:</span> <span>&#34;void * console_register_cvar(char *name, char *value)&#34;</span><span>,</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span>&#34;comment&#34;</span><span>:</span> <span>&#34;registers or updates a console cvar entry (stores string + float value)&#34;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span>}</span><span>,</span></span></code></pre></div>
<p>on the next regen more types will propagate. then you repeat it 300 more times and confidently map around 2000 functions and labels we care about. you can see more in my <a href="https://crimson.banteg.xyz/detangling/">detangling notes</a>.</p>
<div>
<figure>
<p><img src="https://banteg.xyz/posts/crimsonland/ghidra1.avif"/></p>
<figcaption>the joy of renaming</figcaption>
</figure>
</div>
<p>if you look at the decompile today, you may notice it has grown by 13,000 lines to 114,473 lines. this is because ghidra initially has missed quite a large chunk of functions, most notably game initialization.</p>
<p>there was also some deliberately obfuscated functions like the credit secret sequence, where i needed to capture the right entrypoint at runtime and manually create a function at that address.</p>
<p>by day 5 i had a pretty good idea of game structs and the engine vtable layout. so i added header files for <code>IGrim2D.h</code> and <code>crimsonland_types.h</code>. later i have found that some versions of the game have shipped with <code>cl_mod_sdk_v1</code> that had some headers, but it was not extremely helpful because i found it when the project was already in an advanced phase.</p>
<p>seeing steady progress was motivating. i set up a knowledge base (with <a href="https://zensical.org/docs/get-started/">zensical</a>) on day one and was mapping whatever patterns codex had high confidence in. here is an example of what i started with and what it looks like now. and it gets more readable with each iteration.</p>
<div>
<ul role="tablist"><li role="presentation"><a id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">1 day in</a></li><li role="presentation"><a id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">16 days in</a></li></ul>
<div>
<div id="tabset-1-1" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div id="cb3"><pre><code><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span>/* FUN_00444980 @ 00444980 */</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span>void</span> __cdecl FUN_00444980<span>(</span><span>char</span> param_1<span>,</span><span>char</span> param_2<span>)</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span>{</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span>// ...</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span>if</span> <span>(</span>fVar2 <span>&lt;</span> <span>0</span><span>.0</span><span>)</span> <span>{</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>      <span>(&amp;</span>DAT_00490bac<span>)[</span>iVar6 <span>*</span> <span>0xd8</span><span>]</span> <span>=</span> <span>0</span><span>;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span>(&amp;</span>DAT_00490b84<span>)[</span>iVar6 <span>*</span> <span>0xd8</span><span>]</span> <span>=</span> <span>0</span><span>;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span>*(</span>undefined4 <span>*)(&amp;</span>DAT_004908cc <span>+</span> iVar7<span>)</span> <span>=</span> <span>0</span><span>;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span>*(</span>undefined4 <span>*)(&amp;</span>DAT_004908d0 <span>+</span> iVar7<span>)</span> <span>=</span> <span>0</span><span>;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span>(&amp;</span>DAT_00490b68<span>)[</span>iVar6 <span>*</span> <span>0xd8</span><span>]</span> <span>=</span> <span>0</span><span>;</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span>(&amp;</span>DAT_00490b7c<span>)[</span>iVar6 <span>*</span> <span>0xd8</span><span>]</span> <span>=</span> <span>(&amp;</span>DAT_00490b74<span>)[</span>iVar6 <span>*</span> <span>0xd8</span><span>];</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span>(&amp;</span>DAT_00490b80<span>)[</span>iVar6 <span>*</span> <span>0xd8</span><span>]</span> <span>=</span> <span>0</span><span>;</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span>if</span> <span>(</span>param_2 <span>!=</span> <span>&#39;</span><span>\0</span><span>&#39;</span><span>)</span> <span>{</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>      FUN_00413430<span>();</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>      iVar6 <span>=</span> DAT_004aaf0c<span>;</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    bVar3 <span>=</span> false<span>;</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span>(&amp;</span>DAT_00490900<span>)[</span>iVar6 <span>*</span> <span>0xd8</span><span>]</span> <span>=</span> <span>*</span>unaff_retaddr<span>;</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span>(&amp;</span>DAT_00490904<span>)[</span>iVar6 <span>*</span> <span>0xd8</span><span>]</span> <span>=</span> unaff_retaddr<span>[</span><span>1</span><span>];</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    fVar9 <span>=</span> <span>(</span>float10<span>)</span>fpatan<span>((</span>float10<span>)(</span><span>float</span><span>)(&amp;</span>DAT_004908c8<span>)[</span>iVar6 <span>*</span> <span>0xd8</span><span>]</span> <span>-</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>                            <span>(</span>float10<span>)(</span><span>float</span><span>)(&amp;</span>DAT_00490904<span>)[</span>iVar6 <span>*</span> <span>0xd8</span><span>],</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>                            <span>(</span>float10<span>)(</span><span>float</span><span>)(&amp;</span>DAT_004908c4<span>)[</span>iVar6 <span>*</span> <span>0xd8</span><span>]</span> <span>-</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>                            <span>(</span>float10<span>)(</span><span>float</span><span>)(&amp;</span>DAT_00490900<span>)[</span>iVar6 <span>*</span> <span>0xd8</span><span>]);</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span>(&amp;</span>DAT_00490bb0<span>)[</span>iVar6 <span>*</span> <span>0xd8</span><span>]</span> <span>=</span> <span>(</span><span>float</span><span>)(</span>fVar9 <span>-</span> <span>(</span>float10<span>)</span><span>1.5707964</span><span>);</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span>if</span> <span>(((</span><span>float</span><span>)(&amp;</span>DAT_00490b84<span>)[</span>iVar6 <span>*</span> <span>0xd8</span><span>]</span> <span>&lt;=</span> <span>0</span><span>.0</span><span>)</span> <span>&amp;&amp;</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>       <span>((</span><span>float</span><span>)(&amp;</span>DAT_00490b80<span>)[</span>iVar6 <span>*</span> <span>0xd8</span><span>]</span> <span>==</span> <span>0</span><span>.0</span><span>))</span> <span>{</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>      bVar3 <span>=</span> true<span>;</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>      <span>(&amp;</span>DAT_00490b78<span>)[</span>iVar6 <span>*</span> <span>0x360</span><span>]</span> <span>=</span> <span>0</span><span>;</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    bVar4 <span>=</span> false<span>;</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span>if</span> <span>((((</span><span>float</span><span>)(&amp;</span>DAT_00490b84<span>)[</span>iVar6 <span>*</span> <span>0xd8</span><span>]</span> <span>&lt;=</span> <span>0</span><span>.0</span><span>)</span> <span>&amp;&amp;</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>        <span>(</span><span>0</span> <span>&lt;</span> <span>(</span><span>int</span><span>)(&amp;</span>DAT_0049095c<span>)[</span>iVar6 <span>*</span> <span>0xd8</span><span>]))</span> <span>&amp;&amp;</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>       <span>((</span>iVar6 <span>=</span> perk_count_get<span>(</span>DAT_004c2bd0<span>),</span> iVar6 <span>!=</span> <span>0</span> <span>||</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>           <span>(</span>iVar7 <span>=</span> perk_count_get<span>(</span>DAT_004c2bc8<span>),</span> iVar6 <span>=</span> DAT_004aaf0c<span>,</span> bVar4 <span>=</span> false<span>,</span> iVar7 <span>!=</span> <span>0</span><span>)))</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>       <span>)</span> <span>{</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>      bVar4 <span>=</span> true<span>;</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>      iVar6 <span>=</span> DAT_004aaf0c<span>;</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    <span>// ...</span></span></code></pre></div>
</div>
<div id="tabset-1-2" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div id="cb4"><pre><code><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span>/* player_fire_weapon @ 00444980 */</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span>void</span> __cdecl player_fire_weapon<span>(</span><span>char</span> param_1<span>,</span><span>char</span> param_2<span>)</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span>{</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span>// ...</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    fVar2 <span>=</span> <span>(&amp;</span>player_state_table<span>)[</span>render_overlay_player_index<span>].</span>muzzle_flash_alpha <span>-</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>            <span>(</span>frame_dt <span>+</span> frame_dt<span>);</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span>(&amp;</span>player_state_table<span>)[</span>render_overlay_player_index<span>].</span>muzzle_flash_alpha <span>=</span> fVar2<span>;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span>if</span> <span>(</span>fVar2 <span>&lt;</span> <span>0</span><span>.0</span><span>)</span> <span>{</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>      <span>(&amp;</span>player_state_table<span>)[</span>iVar5<span>].</span>muzzle_flash_alpha <span>=</span> <span>0</span><span>.0</span><span>;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span>(&amp;</span>player_state_table<span>)[</span>iVar5<span>].</span>shot_cooldown <span>=</span> <span>0</span><span>.0</span><span>;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span>(&amp;</span>player_state_table<span>)[</span>iVar5<span>].</span>move_dx <span>=</span> <span>0</span><span>.0</span><span>;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span>(&amp;</span>player_state_table<span>)[</span>iVar5<span>].</span>move_dy <span>=</span> <span>0</span><span>.0</span><span>;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span>(&amp;</span>player_state_table<span>)[</span>iVar5<span>].</span>spread_heat <span>=</span> <span>0</span><span>.0</span><span>;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span>(&amp;</span>player_state_table<span>)[</span>iVar5<span>].</span>ammo <span>=</span> <span>(&amp;</span>player_state_table<span>)[</span>iVar5<span>].</span>clip_size<span>;</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span>(&amp;</span>player_state_table<span>)[</span>iVar5<span>].</span>reload_timer <span>=</span> <span>0</span><span>.0</span><span>;</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span>if</span> <span>(</span>param_2 <span>!=</span> <span>&#39;</span><span>\0</span><span>&#39;</span><span>)</span> <span>{</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>      player_start_reload<span>();</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>      iVar5 <span>=</span> render_overlay_player_index<span>;</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    bVar3 <span>=</span> false<span>;</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span>(&amp;</span>player_state_table<span>)[</span>iVar5<span>].</span>aim_x <span>=</span> <span>*</span>unaff_retaddr<span>;</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span>(&amp;</span>player_state_table<span>)[</span>iVar5<span>].</span>aim_y <span>=</span> unaff_retaddr<span>[</span><span>1</span><span>];</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    fVar8 <span>=</span> <span>(</span>float10<span>)</span>fpatan<span>((</span>float10<span>)(&amp;</span>player_state_table<span>)[</span>iVar5<span>].</span>pos_y <span>-</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>                            <span>(</span>float10<span>)(&amp;</span>player_state_table<span>)[</span>iVar5<span>].</span>aim_y<span>,</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>                            <span>(</span>float10<span>)(&amp;</span>player_state_table<span>)[</span>iVar5<span>].</span>pos_x <span>-</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>                            <span>(</span>float10<span>)(&amp;</span>player_state_table<span>)[</span>iVar5<span>].</span>aim_x<span>);</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span>(&amp;</span>player_state_table<span>)[</span>iVar5<span>].</span>aim_heading <span>=</span> <span>(</span><span>float</span><span>)(</span>fVar8 <span>-</span> <span>(</span>float10<span>)</span><span>1.5707964</span><span>);</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span>if</span> <span>(((&amp;</span>player_state_table<span>)[</span>iVar5<span>].</span>shot_cooldown <span>&lt;=</span> <span>0</span><span>.0</span><span>)</span> <span>&amp;&amp;</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>       <span>((&amp;</span>player_state_table<span>)[</span>iVar5<span>].</span>reload_timer <span>==</span> <span>0</span><span>.0</span><span>))</span> <span>{</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>      bVar3 <span>=</span> true<span>;</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>      <span>*(</span>undefined1 <span>*)&amp;(&amp;</span>player_state_table<span>)[</span>iVar5<span>].</span>reload_active <span>=</span> <span>0</span><span>;</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    bVar4 <span>=</span> false<span>;</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    <span>if</span> <span>((((&amp;</span>player_state_table<span>)[</span>iVar5<span>].</span>shot_cooldown <span>&lt;=</span> <span>0</span><span>.0</span><span>)</span> <span>&amp;&amp;</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>        <span>(</span><span>0</span> <span>&lt;</span> <span>(&amp;</span>player_state_table<span>)[</span>iVar5<span>].</span>experience<span>))</span> <span>&amp;&amp;</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>       <span>((</span>iVar5 <span>=</span> perk_count_get<span>(</span>perk_id_regression_bullets<span>),</span> iVar5 <span>!=</span> <span>0</span> <span>||</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>        <span>(</span>iVar6 <span>=</span> perk_count_get<span>(</span>perk_id_ammunition_within<span>),</span> iVar5 <span>=</span> render_overlay_player_index<span>,</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>        bVar4 <span>=</span> false<span>,</span> iVar6 <span>!=</span> <span>0</span><span>))))</span> <span>{</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>      bVar4 <span>=</span> true<span>;</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>      iVar5 <span>=</span> render_overlay_player_index<span>;</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span>}</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    <span>// ...</span></span></code></pre></div>
</div>
</div>
</div>
</section>
<section id="binary-ninja">
<h3 data-anchor-id="binary-ninja">binary ninja</h3>
<p>binary ninja only has headless mode in the more expensive version i don’t have. in my version i could use <a href="https://github.com/fosdickio/binary_ninja_mcp">binary_ninja_mcp</a> and connect the agents to it. honestly they love it, and it allows for far more fluid automatic exploration than grepping through a 100k line ghidra decompile. they can easily ask the mcp questions like “what calls this?”, “what references this?”, “show me decompile of this function”, “find functions matching a pattern”.</p>
<p>it can also be used for retyping and renaming, but in my case the source of truth comes from my ghidra maps, which i apply to regen the binja outputs, so i ended up not using this functionality.</p>
</section>
</section>
<section id="runtime-analysis">
<h2 data-anchor-id="runtime-analysis">runtime analysis</h2>
<p>static analysis is at best a hypothesis. i needed a way to validate in runtime. the game runs in wine (poorly), but the translation could look as ridiculous as this. we wouldn’t be capturing useful information after going through so many layers.</p>
<blockquote>
<p>D3D8 → dgVoodoo → D3D11 → DXVK → Vulkan → MoltenVK → Metal</p>
</blockquote>
<p>the truth is, it’s easiest to debug a windows game on windows. first i set up a vm using utm. it was a bit too slow for me to enjoy the project, so i bit the bullet and installed windows on my old macbook using bootcamp.</p>
<p>for runtime analysis i tried a bunch of things, many of them were a dead end. im looking at you, x86dbg, literally the most useless and frustrating program i ever interacted with and i got nowhere with it.</p>
<p>after a lot of trial and error i got two complementary tools working:</p>
<section id="windbg">
<h3 data-anchor-id="windbg">windbg</h3>
<p>this is microsoft’s own debugger, it comes with a cli tool called <code>cdb</code> that shares the same engine. a cli tool is always nice, because it promises us headless analysis and agentic loops working.</p>
<p>cdb can connect to a running process and set breakpoints, read memory, inspect callstacks, all the usual stuff. combined with our data map, it becomes a very powerful extension to speed up the ghidra mapping process.</p>
<p>i tried setting it up with codex with <code>cdb -pn crimsonland.exe</code>. it should be noted that codex runs subprocesses in a pty, so it can talk to them both ways interactively. the only problem is it’s hardwired in a way that it kills the process when it ends the turn and gives you an answer. so you can’t really talk to codex while it sets breakpoints and watchers. of course, codex is open source and you can fork it and patch this behavior, but i found a different solution that works about as reliably.</p>
<p>cdb supports a server/client mode, so you can set this up using a long-running server process that attaches to the process that you start and a couple of commands for your agent. i use a justfile so it just needs to know the shortcuts. the client persists no logs, so we need the server to log into an external file. finally, there is a tiny helper script that remembers the position we have read the file last time and outputs the tail, so the agent can inspect the logs as it was receiving them live.</p>
<div id="cb5"><pre><code><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span>windbg-server:</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    cdb -server tcp:port=5005,password=secret -logo C:\windbg.log -pn crimsonland.exe -noio</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span>windbg-client:</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    cdb -remote tcp:server=127.0.0.1,port=5005,password=secret -bonc</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span>windbg-tail:</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    uv run scripts/windbg_tail.py</span></code></pre></div>
<p>this setup allows interactive windbg sessions.</p>
<div>
<figure>
<p><img src="https://banteg.xyz/posts/crimsonland/cdb1.avif"/></p>
<figcaption>codex controlling windbg using <code>cdb -remote</code></figcaption>
</figure>
</div>
</section>
<section id="frida">
<h3 data-anchor-id="frida">frida</h3>
<p>another tool i use extensively is called frida (<code>uv tool install frida-tools</code>). it allows injecting javascript into a running process. frida can hook functions, trace calls, modify arguments and return values on the fly.</p>
<p>the scripts can get very advanced. for example, i was having trouble with replicating the ground rendering exactly. as i understood later, it was caused by different default conventions between directx8 and opengl. i used frida to capture and save a framebuffer from the game to use it as a test fixture for my renderer.</p>
<p>other useful things possible with frida include different debug style shortcuts like cycling weapons, as well as capturing runtime logs to confirm your hypotheses.</p>
<p>to attach a frida script to a running process, you simply do:</p>
<div id="cb6"><pre><code><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span>frida</span> <span>-n</span> crimsonland.exe <span>-l</span> scripts<span>\f</span>rida<span>\u</span>nlock_secrets.js</span></code></pre></div>
</section>
</section>
<section id="the-formats">
<h2 data-anchor-id="the-formats">the formats</h2>
<p>with any game project you want to start from understanding the custom formats it uses. i was curious about this game before, so i had some understanding already.</p>
<p>crimsonland ships its assets in <strong>paq</strong> files, which is a custom archive format with a four-byte magic (<code>paq\0</code>), then a stream of entries: null-terminated filename, little-endian size, raw bytes. the paths are windows-style with backslashes.</p>
<p>i have used a very good python library called construct that allows to define such formats declaratively.</p>
<div id="cb7"><pre><code><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span>from</span> construct <span>import</span> Bytes, Const, CString, GreedyRange, Int32ul, Struct</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>MAGIC <span>=</span> <span>b&#34;paq</span><span>\x00</span><span>&#34;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>PAQ_ENTRY <span>=</span> Struct(</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span>&#34;name&#34;</span> <span>/</span> CString(<span>&#34;utf8&#34;</span>),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span>&#34;size&#34;</span> <span>/</span> Int32ul,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span>&#34;payload&#34;</span> <span>/</span> Bytes(<span>lambda</span> ctx: ctx.size),</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>PAQ <span>=</span> Struct(</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span>&#34;magic&#34;</span> <span>/</span> Const(MAGIC),</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span>&#34;entries&#34;</span> <span>/</span> GreedyRange(PAQ_ENTRY),</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>inside the paqs are textures in <strong>jaz</strong> format, which is where things get architecturally interesting. it was previously known that jaz is a zlib compressed jpg with some unknown data attached to it.</p>
<p>im happy to announce that codex has understood the meaning of the unknown section in two hours, and has solved something that had previously got me puzzled for days. turns out jaz takes a jpg and wraps it with a custom run length encoded alpha channel, then compresses the whole thing again with zlib. here is a couple of textures extracted with the correct alpha.</p>
<div>
<div>
<div>
<div>
<figure>
<p><img src="https://banteg.xyz/posts/crimsonland/alien.avif"/></p>
<figcaption>game\alien.jaz</figcaption>
</figure>
</div>
</div>
<div>
<div>
<figure>
<p><img src="https://banteg.xyz/posts/crimsonland/spider_sp1.avif"/></p>
<figcaption>game\spider_sp1.jaz</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>the alpha rle expands to <code>width * height</code> bytes. most assets match exactly. interestingly one file is short by exactly one pixel.</p>
<p>i have construct parsers for both formats. <code>uv run paq extract crimsonland/ assets/</code> dumps everything, converting jaz to png.</p>
</section>
<section id="text-rendering">
<h2 data-anchor-id="text-rendering">text rendering</h2>
<p>by the moment you have firmly decided on a from scratch rewrite, the next good thing to understand and implement is text rendering. it will unlock debug views and you are going to need a lot of them before all the systems are wired up together.</p>

<div><div>
<div>
<figure>
<p><img src="https://banteg.xyz/posts/crimsonland/fonts0.avif"/></p>
<figcaption>all your fonts are belong to us</figcaption>
</figure>
</div>
</div></div><p>by now i have a full understanding of where all fonts in the game come from, so technically we can bolt on vector text rendering later. finding the fonts was a funny exercise on its own, you really need to get into the dev’s head. what was he thinking? ah yes, dafont.com.</p>
<p>the identified fonts are xirod regular for the crimsonland logo (with a flipped m), armor piercing regular for the menu labels, pixel arial 11 for the small text, courier new bold for level names.</p>
<p>i eyeballed the pixel font as arial but later was able to find the exact variant used in the game. this finding allows us to either use normal arial or this pixel font and sidestep noticeable jpeg compression artifacts from the game version sprite atlas.</p>
<div>
<figure>
<p><img src="https://banteg.xyz/posts/crimsonland/fonts1.avif"/></p>
<figcaption>possible upgrade paths for small font</figcaption>
</figure>
</div>
</section>
<section id="choosing-the-engine">
<h2 data-anchor-id="choosing-the-engine">choosing the engine</h2>
<p>since i was rewriting the game from scratch, i needed to iterate quickly. so i chose to have a reference intermediate implementation that i could test and refactor easily, before rewriting to something more performant. it was important to me to capture the game logic in a readable way, not just make the game compile on modern systems.</p>
<p>choosing the right engine is extremely important so i spent an entire day going through the options. modern engines tend to abstract things too much with concepts like actors and such. it’s a completely different paradigm from what the game did. directx 8 uses a very direct rendering approach. so we needed something barebones to replicate that. i ultimately chose <a href="https://www.raylib.com/">raylib</a> for my rewrite. so far im happy with the choice.</p>
<p>the engine handles things like creating a game window, drawing textures, playing sounds, streaming music, and handling input. so basically it takes care of some of the stuff <code>grim.dll</code> does. the only thing left to do is to fill in the entire game.</p>
</section>
<section id="the-rewrite">
<h2 data-anchor-id="the-rewrite">the rewrite</h2>
<p>up to this point i was greedily documenting every behavior we could infer from the executable, but we had no code of our own besides the format loaders.</p>
<p>i think of it like getting a noisy picture in path tracing rendering. some details start to come through but the picture is not fully clear yet. we have random things documented but we can’t know for sure if this knowledge is sufficient to reimplement the entire game. there is only one way to know.</p>
<p>we need to change our render settings to scanline. just kidding, but that’s how i thought about it. when my version could boot into the menu, we would have uncovered all the missing pieces that lead up to that point. when we get to the gameplay, we’d have to implement the most systems to get there. our documentation helps, but this forward path leaves no system untouched and eventually we have our working game.</p>
<p>on day 6, when i got to the main menu, i found a funny path that would allow me to cover a lot of ground. i noticed the game still had demo teaser code intact, but <code>game_is_full_version()</code> was hardcoded to 1 in this gog version. naturally, i could write a frida script to <em>uncrack</em> the game and make it behave like a shareware, even though this version never intended such functionality.</p>
<p>the rendering in this game is pretty simple. there is a ground framebuffer (in opengl, i believe, the correct term is render target). first the game generates a terrain, i went great to lengths to get it right. we literally have test fixtures that assert we generate the exact same picture from the same seed. then this framebuffer is used to render all sorts of decals, like bodies, blood, bullet casings, scorch marks. this simple technique allows the game to visually transform the battlefield during gameplay.</p>
<p>the creatures come from sprite atlases you’ve seen above. the projectiles render with either beautiful traces that stay in the air, or at most with a simple texture and additive glow.</p>
<p>so rendering was not a huge obstacle, the hard part was that everything in this game is hardcoded in the exe. for example, all quest spawn scenarios are just one massive 3950 line switch statement. the indirection i mentioned has caused me a bunch of headaches, and i hit off-by-one errors for some things a few times, before they got pinned down with runtime analysis.</p>
<p>obviously, i needed our version more testable, so some of it was destined to be refactored into composable and testable bits. testing is important, because you can turn runtime captures into fixtures, and prove that your behavior is identical. for example, this is how quest builders look in my version (and spawn templates are another work of art).</p>
<div id="cb8"><pre><code><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span>@register_quest</span>(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    level<span>=</span><span>&#34;2.5&#34;</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    title<span>=</span><span>&#34;Sweep Stakes&#34;</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    time_limit_ms<span>=</span><span>35000</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    start_weapon_id<span>=</span><span>6</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    unlock_perk_id<span>=</span>PerkId.BARREL_GREASER,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span>def</span> build_2_5_sweep_stakes(ctx: QuestContext, rng: random.Random <span>|</span> <span>None</span> <span>=</span> <span>None</span>) <span>-&gt;</span> <span>list</span>[SpawnEntry]:</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    rng <span>=</span> rng <span>or</span> random.Random()</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    entries: <span>list</span>[SpawnEntry] <span>=</span> []</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    center_x, center_y <span>=</span> center_point(ctx.width, ctx.height)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    trigger <span>=</span> <span>2000</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    step <span>=</span> <span>2000</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span>while</span> step <span>&gt;</span> <span>720</span>:</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        angle <span>=</span> random_angle(rng)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span>for</span> x, y <span>in</span> radial_points(center_x, center_y, angle, <span>0x54</span>, <span>0xFC</span>, <span>0x2A</span>):</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>            heading <span>=</span> heading_from_center(x, y, center_x, center_y)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>            entries.append(</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>                spawn(</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>                    x<span>=</span>x,</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>                    y<span>=</span>y,</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>                    heading<span>=</span>heading,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>                    spawn_id<span>=</span>SpawnId.ALIEN_AI7_ORBITER_36,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>                    trigger_ms<span>=</span>trigger,</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>                    count<span>=</span><span>1</span>,</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        trigger <span>+=</span> <span>max</span>(step, <span>600</span>)</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        step <span>-=</span> <span>0x50</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    <span>return</span> entries</span></code></pre></div>
<p>some things are harder to test, but we’ll eventually get there, as refactors are free in the agentic era.</p>
<p>some things are outright wild programming choices, but understandable given it’s this studio’s first game. one particularly memorable example is negative hitbox sizes driving animation frames.</p>
<p>over time we moved from stochastic noise of understanding the assembly to the scanline precision of making it run.</p>
</section>
<section id="current-status">
<h2 data-anchor-id="current-status">current status</h2>
<p>46,800 lines of code, 16,000 lines of documentation.</p>
<p>the gameplay is fully wired up, all game modes are playable end to end, all weapons do work, as do all perks. some logic bugs still persist, and there are some gaps in non-gameplay things, like credits and the hidden alien zoo keeper game.</p>
<p>the end goal is a working and thoroughly documented reimplementation. one that a seasoned crimsonland player wouldn’t be able to tell from the original game. i am very close to that goal.</p>
<p>parity with a decompiled binary may sound like a strange goal. you can’t just make it <em>look</em> right. you have to make it <em>be</em> right. as someone ominously joked in an x reply, with 90% of work done, the other 90% of chasing bugs and imperfections remain.</p>
</section>
<section id="whats-next">
<h2 data-anchor-id="whats-next">what’s next</h2>
<p>after the core game is done, we can perhaps resurrect online high scores, or even try to tackle harder things like network multiplayer, promised to us in crimsonland 2.</p>
<p>i specifically didn’t want any graphical enhancements, as my goal was to preserve a childhood memory exactly as i remember it. for people who want a remake, there was already one made in 2014. if someone wants to port the original crimsonland in 2040, they can start with what i have mapped. this game is a lightning in the bottle and it deserves to outlive its original build.</p>
<p>one day i dreamt one enhancement up that i find very fitting. what if we keep everything exactly the same, but add a night mode with an ultra quality lighting. muzzle flash will cast long shadows, and there are plenty emissive projectiles in the game, like plasma (both trooper’s and spider’s), ion weapons, rocket launchers, and nukes.</p>
<p>i immediately researched the most fitting algorithm and implemented <a href="https://iquilezles.org/articles/rmshadows/">soft shadows in raymarched signed distance fields</a>, so we can have long soft shadows with realistic penumbras. it works really well too, i might integrate it into the game as an optional night mode.</p>
<div>
<figure>
<p><img src="https://banteg.xyz/posts/crimsonland/sdf1.avif"/></p>
<figcaption>an early prototype of signed distance field raymarched lighting</figcaption>
</figure>
</div>
</section>
<section id="the-implications">
<h2 data-anchor-id="the-implications">the implications</h2>
<p>in 2014, it took a year to port the game from directx 8 to directx 11, while having the sources. and it wasn’t even complete until later, some modes like typ-o-shooter landed as updates later on.</p>
<blockquote>
<p>it took us a bit more than a year from the old windows version from 2003 to the current multiplatform version of crimsonland. – 10tons</p>
</blockquote>
<p>in 2026, it took me just two weeks and 1666 commits to rewrite the game, starting from nothing but the worst case scenario binaries. the whole time i saw steady progress every day, i didn’t get stuck, the errors didn’t snowball, and the game is actually playable and faithful to the original.</p>
<p>i specifically picked a task that is on the harder end for the current models, and yes, you can discount this on me being a good engineer, knowing my tools well, etc etc. but it surely felt to me that something new was unlocked with gpt-5.2 xhigh and codex. i found it to be an extremely rigorous model that follows instructions to the letter, and doesn’t invent stuff by itself. paired with gpt-5.2 pro for planning, it works extremely well.</p>
<p>i shipped two large and complex projects with it in a month. and honestly im amazed with the capabilities already. in the right hands these tools can give you amazing results. people focus on one shot wonders, but the real test is what you can achieve when you use these models for determined work. and with that im satisfied.</p>
<p>hope you learned something useful and will go and try to preserve a bright memory from your childhood. it will be a lot of work, but it will be worth it in the end.</p>
</section>
<section id="the-invitation">
<h2 data-anchor-id="the-invitation">the invitation</h2>
<p>if the original crimsonland is still in your muscle memory and you can call out subtle inconsistencies like “hmm i think this spider had friendly fire”, you can help speed up squashing the remaining bugs. our binary files are static, we will find all inconsistencies eventually anyway.</p>
<p>you can also join the <a href="https://t.me/+0lAIK7SFOWQ2YzQy">telegram group</a> to follow the project.</p>
<p>if you want to study the code, check out the <a href="https://github.com/banteg/crimson">github repo</a>.</p>
<p>then you can look up how different mechanics work up to the implementation detail in the <a href="https://crimson.banteg.xyz/">knowledge base</a>.</p>
<p>if you just want to enjoy some action, you can play my version right now (you need <a href="https://docs.astral.sh/uv/getting-started/installation/">uv</a> package manager).</p>

<p>p.s. the screenshot labeled crimsonland 2003 is actually from my version</p>


</section>

</main> <!-- /main -->

</div></div>
  </body>
</html>
