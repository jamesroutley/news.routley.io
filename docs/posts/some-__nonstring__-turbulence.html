<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/SubscriberLink/1018486/1dcd29863655cb25/">Original</a>
    <h1>Some __nonstring__ Turbulence</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>
New compiler releases often bring with them new warnings; those warnings
are usually welcome, since they help developers find problems before they
turn into nasty bugs.  Adapting to new warnings can also create disruption
in the development process, though, especially when an important developer
upgrades to a new compiler at an unfortunate time.  This is just the
scenario that played out with the <a href="https://lwn.net/ml/all/CAHk-=wgjZ4fzDKogXwhPXVMA7OmZf9k0o1oB2FJmv-C1e=typA@mail.gmail.com/">6.15-rc3
kernel release</a> and the implementation of
</p><tt>-Wunterminated-string-initialization</tt><p> in GCC 15.
</p><p>
Consider a C declaration like:
</p><pre>    char foo[8] = &#34;bar&#34;;
</pre>
<p>
The array will be initialized with the given string, including the normal
trailing NUL byte indicating the end of the string.  Now consider this
variant:
</p><pre>    char foo[8] = &#34;NUL-free&#34;;
</pre>
<p>
This is a legal declaration, even though the declared array now lacks the
room for the NUL byte.  That byte will simply be omitted, creating an
unterminated string.  That is often not what the developer who wrote that
code wants, and it can lead to unpleasant bugs that are not discovered
until some later time.  The <tt>-Wunterminated-string-initialization</tt>
option emits a warning for this kind of initialization, with the result
that, hopefully, the problem — if there is a problem — is fixed quickly.
</p><blockquote>
<b>Stay on top of Linux kernel development</b> with <a href="https://lwn.net/Promo/kernel-1/claim">a one-month free trial subscription</a> to LWN, no credit card required.
</blockquote>
<p>
The kernel community has worked to make use of this warning and, hopefully,
eliminate a source of bugs.  There is only one little problem with the new
warning, though: sometimes the no-NUL initialization is exactly what is
wanted and intended.  See, for example, <a href="https://elixir.bootlin.com/linux/v6.14.3/source/fs/cachefiles/key.c#L11">this
declaration</a> from <tt>fs/cachefiles/key.c</tt>:
</p><pre>    static const char cachefiles_charmap[64] =
	&#34;0123456789&#34;			/* 0 - 9 */
	&#34;abcdefghijklmnopqrstuvwxyz&#34;	/* 10 - 35 */
	&#34;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#34;	/* 36 - 61 */
	&#34;_-&#34;				/* 62 - 63 */
	;
</pre>
<p>
This <tt>char</tt> array is used as a lookup table, not as a string, so
there is no need for a trailing NUL byte.  GCC 15, being unaware of
that usage, will emit a false-positive warning for this declaration.  There
are many places in the kernel with declarations like this; the ACPI code,
for example, uses a lot of four-byte string arrays to handle the equally
large set of four-letter ACPI acronyms.
</p><p>
Naturally, there is a way to suppress the warning when it does not apply
by adding an attribute to the declaration indicating that the <tt>char</tt>
array is not actually holding a string:
</p><pre>    __attribute__((__nonstring__))
</pre>
<p>
Within the kernel, the macro <tt>__nonstring</tt> is used to shorten that
attribute syntax.  Work has been ongoing, primarily by Kees Cook, to fix
all of the warnings added by GCC 15.  Many patches have been
circulated; quite a few of them are in linux-next.  Cook has also been
working with the GCC developers to improve how this annotation works and to
<a href="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=118095">fix a
problem</a> that the kernel project ran into.  There was some time left
to get this job done, though, since GCC 15 has not actually been
released — or so Cook thought.
</p><p>
Fedora 42 <i>has</i> been released, though, and the Fedora developers, for
better or worse, decided to include a pre-release version of GCC 15
with it as the default compiler.  The Fedora project, it seems, has decided
to follow <a href="https://lwn.net/2000/1005/dists.php3">a venerable Red Hat tradition</a>
with this release.  Linus Torvalds, for better or worse,
decided to update his development systems to Fedora 42 the day before
tagging and releasing 6.15-rc3.  Once he tried building the kernel with the
new compiler, though, things started to go wrong, since the relevant
patches were not yet in his repository.  Torvalds responded with a series
of changes of his own, applied directly to the mainline about two hours
before the release, to fix the problems that he had encountered.  They
included <a href="https://git.kernel.org/linus/4b4bd8c50f48">this patch</a>
fixing warnings in the ACPI subsystem, and <a href="https://git.kernel.org/linus/05e8d261a34e">this one</a> fixing
several others, including the example shown above.  He then tagged and
pushed out 6.15-rc3 with those changes.
</p><p>
Unfortunately, his last-minute changes broke the build on any version of
GCC prior to the GCC 15 pre-release — a problem that was likely to
create a certain amount of inconvenience for any developers who were not
running Fedora 42.  So, shortly after the 6.15-rc3 release, Torvalds
tacked on <a href="https://git.kernel.org/linus/9d7a0577c9db">one more
patch</a> backing out the breaking change and disabling the new warning
altogether.
</p><p>
This drew <a href="https://lwn.net/ml/all/202504201840.3C1F04B09@keescook">a somewhat
grumpy note</a> from Cook, who said that he had already sent patches fixing
all of the problems, including the build-breaking one that Torvalds ran
into.  He asked Torvalds to revert the changes and use the planned fixes,
adding: &#34;<q>It is, once again, really frustrating when you update to
unreleased compiler versions</q>&#34;.  Torvalds <a href="https://lwn.net/ml/all/CAHk-=whryuuKnd_5w6169EjfRr_f+t5BRmKt+qfjALFzfKQNvQ@mail.gmail.com">disagreed</a>,
saying that he needed to make the changes because the kernel failed to
build otherwise.  He also asserted that GCC 15 <i>was</i> released by
virtue of its presence in Fedora 42.  Cook <a href="https://lwn.net/ml/all/202504210909.D4EAB689@keescook">was unimpressed</a>:
</p><blockquote>
	Yes, I understand that, but you didn&#39;t coordinate with anyone. You
	didn&#39;t search lore for the warning strings, you didn&#39;t even check
	-next where you&#39;ve now created merge conflicts. You put
	insufficiently tested patches into the tree at the last minute and
	cut an rc release that broke for everyone using GCC &lt;15. You
	mercilessly flame maintainers for much much less.
</blockquote>
<p>
Torvalds <a href="https://lwn.net/ml/all/CAHk-=whjZ-id_1m7cgp4aC+N6yZj3s5Jy=mf2oiEADJ3Tp8sxw@mail.gmail.com">stood
his ground</a>, though, blaming Cook for not having gotten the fixes into
the mainline quickly enough.
</p><p>
That is where the situation stands, as of this writing.  Others will
undoubtedly take the time to fix the problems properly, adding the changes
that were intended all along.  But this course of events has created some
bad feelings all around, feelings that could maybe have been avoided with a
better understanding of just when a future version of GCC is expected to be
able to build the kernel.
</p><p>
As a sort of coda, it is worth saying that Torvalds also has a fundamental
disagreement with how this attribute is implemented.  The
<tt>__nonstring__</tt> attribute applies to variables, not types, so it
must be used in every place where a <tt>char</tt> array is used without
trailing NUL bytes.  He would rather annotate the type, indicating that
every instance of that type holds bytes rather than a character string, and
avoid the need to mark rather larger numbers of variable declarations.  But
that is not how the attribute works, so the kernel will have to
include <tt>__nonstring</tt> markers for every <tt>char</tt> array that is
used in that way.<br clear="all"/></p><table>
           <tbody><tr><th colspan="2">Index entries for this article</th></tr>
           <tr><td><a href="https://lwn.net/Kernel/Index">Kernel</a></td><td><a href="https://lwn.net/Kernel/Index#GCC">GCC</a></td></tr>
            </tbody></table></div></div>
  </body>
</html>
