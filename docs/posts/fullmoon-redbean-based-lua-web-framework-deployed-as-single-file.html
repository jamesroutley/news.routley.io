<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/pkulchenko/fullmoon">Original</a>
    <h1>Fullmoon â€“ Redbean-based Lua web framework deployed as single file</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
          <article itemprop="text">
<p dir="auto">Fullmoon is a <a href="#benchmark">fast</a> and minimalistic web framework
based on <a href="https://redbean.dev/" rel="nofollow">Redbean</a>
-- a portable, single-file distributable web server.</p>
<p dir="auto">Everything you need comes in a single file with no external dependencies
(both for development and distribution) that runs on Windows, Linux, or
macOS. The following is a complete example of a Fullmoon application:</p>
<div data-snippet-clipboard-copy-content="local fm = require &#34;fullmoon&#34;
fm.setTemplate(&#34;hello&#34;, &#34;Hello, {%&amp; name %}&#34;)
fm.setRoute(&#34;/hello/:name&#34;, function(r)
    return fm.serveContent(&#34;hello&#34;, {name = r.params.name})
  end)
fm.run()"><pre><span>local</span> fm <span>=</span> <span>require</span> <span><span>&#34;</span>fullmoon<span>&#34;</span></span>
fm.<span>setTemplate</span>(<span><span>&#34;</span>hello<span>&#34;</span></span>, <span><span>&#34;</span>Hello, {%&amp; name %}<span>&#34;</span></span>)
fm.<span>setRoute</span>(<span><span>&#34;</span>/hello/:name<span>&#34;</span></span>, <span>function</span>(<span>r</span>)
    <span>return</span> fm.<span>serveContent</span>(<span><span>&#34;</span>hello<span>&#34;</span></span>, {name <span>=</span> r.<span>params</span>.<span>name</span>})
  <span>end</span>)
fm.<span>run</span>()</pre></div>
<p dir="auto">After it&#39;s <a href="#installation">packaged with Redbean</a>, it can be launched
using <code>./redbean.com</code>, which starts a server that returns &#34;Hello, world&#34;
to an HTTP(S) request sent to <a href="http://localhost:8080/hello/world" rel="nofollow">http://localhost:8080/hello/world</a>.</p>
<h2 dir="auto"><a id="user-content-contents" aria-hidden="true" href="#contents"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Contents</h2>
<ul dir="auto">
<li><a href="#why-fullmoon">Why Fullmoon</a>
<ul dir="auto">
<li><a href="#what-redbean-provides">What Redbean provides</a></li>
<li><a href="#what-fullmoon-adds">What Fullmoon adds</a></li>
</ul>
</li>
<li><a href="#installation">Installation</a></li>
<li><a href="#usage">Usage</a></li>
<li><a href="#quick-reference">Quick reference</a></li>
<li><a href="#examples">Examples</a>
<ul dir="auto">
<li><a href="#showcase-example">Showcase example</a></li>
<li><a href="#techempower-benchmark-example">TechEmpower benchmark example</a></li>
<li><a href="#htmx-board-example">htmx board example</a></li>
</ul>
</li>
<li><a href="#documentation">Documentation</a>
<ul dir="auto">
<li><a href="#routes">Routes</a>
<ul dir="auto">
<li><a href="#basic-routes">Basic routes</a></li>
<li><a href="#routes-with-parameters">Routes with parameters</a></li>
<li><a href="#optional-parameters">Optional parameters</a></li>
<li><a href="#custom-parameters">Custom parameters</a></li>
<li><a href="#query-and-form-parameters">Query and Form parameters</a></li>
<li><a href="#multiple-routes">Multiple routes</a></li>
<li><a href="#named-routes">Named routes</a></li>
<li><a href="#external-routes">External routes</a></li>
</ul>
</li>
<li><a href="#conditions">Conditions</a>
<ul dir="auto">
<li><a href="#handling-of-http-methods">Handling of HTTP methods</a></li>
<li><a href="#conditional-routes">Conditional routes</a></li>
<li><a href="#custom-validators">Custom validators</a></li>
<li><a href="#responding-on-failed-conditions">Responding on failed conditions</a></li>
</ul>
</li>
<li><a href="#actions">Actions</a></li>
<li><a href="#requests">Requests</a>
<ul dir="auto">
<li><a href="#headers">Headers</a></li>
<li><a href="#cookies">Cookies</a></li>
<li><a href="#utility-functions">Utility functions</a></li>
</ul>
</li>
<li><a href="#templates">Templates</a>
<ul dir="auto">
<li><a href="#configuring-templates">Configuring templates</a></li>
<li><a href="#serving-template-outputs">Serving template outputs</a></li>
<li><a href="#passing-parameters-to-templates">Passing parameters to templates</a></li>
<li><a href="#including-templates-in-other-templates">Including templates in other templates</a></li>
<li><a href="#processing-layouts">Processing layouts</a></li>
</ul>
</li>
<li><a href="#responses">Responses</a>
<ul dir="auto">
<li><a href="#serving-response">Serving response</a></li>
<li><a href="#serving-redirect">Serving redirect</a></li>
<li><a href="#serving-static-asset">Serving static asset</a></li>
<li><a href="#serving-error">Serving error</a></li>
<li><a href="#serving-directory-index">Serving directory index</a></li>
<li><a href="#serving-path-(internal-redirect)">Serving path (internal redirect)</a></li>
</ul>
</li>
<li><a href="#running-application">Running application</a></li>
<li><a href="#logging">Logging</a></li>
</ul>
</li>
<li><a href="#benchmark">Benchmark</a></li>
<li><a href="#status">Status</a></li>
<li><a href="#author">Author</a></li>
<li><a href="#license">License</a></li>
</ul>
<h2 dir="auto"><a id="user-content-why-fullmoon" aria-hidden="true" href="#why-fullmoon"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Why Fullmoon</h2>
<p dir="auto">Redbean is a single-file distributable cross-platform web server with
unique and powerful qualities. While there are several Lua-based
web frameworks (<a href="https://leafo.net/lapis/" rel="nofollow">Lapis</a>,
<a href="https://github.com/sumory/lor">Lor</a>,
<a href="https://github.com/sailorproject/sailor">Sailor</a>,
<a href="https://github.com/EvandroLG/pegasus.lua">Pegasus</a>, and others),
none of them integrate with Redbean (although there is an experimental
framework <a href="https://git.sr.ht/~shakna/anpan" rel="nofollow">anpan</a>).</p>
<p dir="auto">Fullmoon is a lightweight and minimalistic web framework that is
written from the perspective of showcasing all the capabilities that
Redbean provides by extending and augmenting them in the simplest and
the most efficient way. It runs fast and comes with batteries included
(routes, templates, JSON generation and more).</p>
<p dir="auto">Fullmoon follows the Lua philosophy and provides a minimal set of tools
to combine as needed and use as the basis to build upon.</p>
<h3 dir="auto"><a id="user-content-what-redbean-provides" aria-hidden="true" href="#what-redbean-provides"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>What Redbean provides</h3>
<ul dir="auto">
<li>Single file deployment and distribution (Linux, Windows, and macOS)</li>
<li>Integrated SSL support (using MbedTLS) including SSL virtual hosting</li>
<li>Integrated crypto hashing (SHA1, SHA224/256/384/512, and BLAKE2B256)</li>
<li>Efficient serving of static and gzip encoded assets</li>
<li>Integrated password-hashing (using Argon2)</li>
<li>HTTP/HTTPS client for external requests</li>
<li>Ships with Lua 5.4 and SQLite 3.35</li>
</ul>
<h3 dir="auto"><a id="user-content-what-fullmoon-adds" aria-hidden="true" href="#what-fullmoon-adds"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>What Fullmoon adds</h3>
<ul dir="auto">
<li>Lightweight package (~700 LOC) with no external dependencies</li>
<li>Simple and flexible routing with variables and custom filters</li>
<li>Template engine with JSON support and efficient memory utilization</li>
<li>Optimized execution with pre-compiled routes and lazy loaded methods</li>
<li>Parametrized URL rewrites and re-routing</li>
<li>Cookie/header generation and processing</li>
<li>Custom 404 and other status pages</li>
<li>Access to all Redbean features</li>
</ul>
<h2 dir="auto"><a id="user-content-installation" aria-hidden="true" href="#installation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Installation</h2>
<h3 dir="auto"><a id="user-content-step-1-get-the-latest-redbean-version-15" aria-hidden="true" href="#step-1-get-the-latest-redbean-version-15"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Step 1: Get the latest Redbean (version 1.5+)</h3>
<p dir="auto">You can download a copy of Redbean by running the following commands
(skip the second one if you&#39;re on Windows):</p>
<div data-snippet-clipboard-copy-content="curl -o redbean.com https://justine.lol/redbean/redbean-latest.com
chmod +x redbean.com"><pre>curl -o redbean.com https://justine.lol/redbean/redbean-latest.com
chmod +x redbean.com</pre></div>
<p dir="auto">You can also build Redbean yourself by following instructions for
the <a href="https://redbean.dev/#source" rel="nofollow">source build</a>.</p>
<h3 dir="auto"><a id="user-content-step-2-prepare-fullmoon-code" aria-hidden="true" href="#step-2-prepare-fullmoon-code"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Step 2: Prepare Fullmoon code</h3>
<ul dir="auto">
<li>Copy <code>fullmoon.lua</code> to <code>.lua/</code> folder</li>
<li>Save your code to a file named <code>.init.lua</code> (for example, the Lua
code shown in the <a href="#fullmoon">description</a>).</li>
</ul>
<p dir="auto">Another option is to place your framework code into a separate file
(for example, <code>.lua/myapp.lua</code>) and add <code>require &#34;myapp&#34;</code> to <code>.init.lua</code>.</p>
<h3 dir="auto"><a id="user-content-step-3-package-fullmoon-code-with-redbean" aria-hidden="true" href="#step-3-package-fullmoon-code-with-redbean"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Step 3: Package Fullmoon code with Redbean</h3>
<div data-snippet-clipboard-copy-content="zip redbean.com .init.lua .lua/fullmoon.lua"><pre>zip redbean.com .init.lua .lua/fullmoon.lua</pre></div>
<p dir="auto">If your framework code is stored in a separate Lua file, make sure to
place it inside the <code>.lua/</code> folder and zip that file as well.</p>
<h3 dir="auto"><a id="user-content-step-4-run-the-server" aria-hidden="true" href="#step-4-run-the-server"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Step 4: Run the server</h3>

<p dir="auto">If you run this on Linux and get errors about not finding interpreter, you
should be able to fix that by running the following command (although note that
it may not survive a system restart):</p>
<div data-snippet-clipboard-copy-content="sudo sh -c &#34;echo &#39;:APE:M::MZqFpD::/bin/sh:&#39; &gt;/proc/sys/fs/binfmt_misc/register&#34;"><pre>sudo sh -c <span><span>&#34;</span>echo &#39;:APE:M::MZqFpD::/bin/sh:&#39; &gt;/proc/sys/fs/binfmt_misc/register<span>&#34;</span></span></pre></div>
<h3 dir="auto"><a id="user-content-step-5-check-the-result" aria-hidden="true" href="#step-5-check-the-result"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Step 5: Check the result</h3>
<p dir="auto">Point your browser to <a href="http://127.0.0.1:8080/hello/world" rel="nofollow">http://127.0.0.1:8080/hello/world</a> and you should
see &#34;Hello, world&#34; (assuming you are using the code shown in the
<a href="#fullmoon">introduction</a> or the one in the <a href="#usage">usage</a> section).</p>
<h2 dir="auto"><a id="user-content-usage" aria-hidden="true" href="#usage"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Usage</h2>
<p dir="auto">The simplest application would need to load the module, configure one
route, and run the application:</p>
<div data-snippet-clipboard-copy-content="local fm = require &#34;fullmoon&#34;
fm.setRoute(&#34;/hello&#34;, function(r) return &#34;Hello, world&#34; end)
fm.run()"><pre><span>local</span> fm <span>=</span> <span>require</span> <span><span>&#34;</span>fullmoon<span>&#34;</span></span>
fm.<span>setRoute</span>(<span><span>&#34;</span>/hello<span>&#34;</span></span>, <span>function</span>(<span>r</span>) <span>return</span> <span><span>&#34;</span>Hello, world<span>&#34;</span></span> <span>end</span>)
fm.<span>run</span>()</pre></div>
<p dir="auto">This application responds to any request for <code>/hello</code> URL with returning
&#34;Hello, world&#34; content (and 200 HTTP status) and responds with returning
404 status for all other requests.</p>
<h2 dir="auto"><a id="user-content-quick-reference" aria-hidden="true" href="#quick-reference"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Quick reference</h2>
<ul dir="auto">
<li>
<p dir="auto"><code>setRoute(route[, action])</code>: registers a route.
If <code>route</code> is a string, then it is used as a route <a href="#basic-routes">expression</a>
to compare the request path against. If it is a table, then its
elements are strings that are used as <a href="#multiple-routes">routes</a> and
its hash values are <a href="#conditional-routes">conditions</a> that the routes
are checked against.
If the second parameter is a <a href="#actions">function</a>, then it is executed
if all conditions are satisfied. If it is a string, then it is used as
a route expression and the request is processed as if it is sent at
the specified route (acts as an internal redirect).
If any condition is not satisifed, then the next route is checked. The
route expression can have multiple <a href="#routes-with-parameters">parameters</a>
and <a href="#optional-parameters">optional parts</a>. The action handler accepts
a <a href="#requests">request table</a> that provides access to request and route
parameters, as well as <a href="#headers">headers</a> and <a href="#cookies">cookies</a>.</p>
</li>
<li>
<p dir="auto"><code>setTemplate(name, template)</code>: registers a template with the specified
name.
If <code>template</code> is a string, then it&#39;s compiled into a template handler.
If it is a function, it is stored and called when rendering of the
template is requested. If it&#39;s a table, then its first element is a
template or a function and the rest are used as options. For example,
specifying <code>ContentType</code> as one of the options sets the <code>Content-Type</code>
header for the generated content. Two templates (<code>500</code> and <code>json</code>) are
provided by default and can be overwritten.</p>
</li>
<li>
<p dir="auto"><code>serveResponse(status[, headers][, body])</code>: sends an HTTP response
using provided <code>status</code>, <code>headers</code>, and <code>body</code> values.
<code>headers</code> is an optional table populated with HTTP header name/value
pairs. If provided, this set of headers <em>removes all other headers</em>
set earlier during handling of the same request. Header names are
<em>case-insensitive</em>, but provided aliases for header names with dashes
are <em>case-sensitive</em>: <code>{ContentType = &#34;foo&#34;}</code> is an alternative form
for <code>{[&#34;Content-Type&#34;] = &#34;foo&#34;}</code>. <code>body</code> is an optional string.</p>
</li>
<li>
<p dir="auto"><code>serveContent(name, parameters)</code>: renders a template using provided
parameters.
<code>name</code> is a string that names the template (as set by a <code>setTemplate</code>
call) and <code>parameters</code> is a table with template parameters (referenced
as variables in the template).</p>
</li>
<li>
<p dir="auto"><code>run([options])</code>: runs the server using configured routes.
By default the server listens on localhost and port 8080. These values
can be changed by setting <code>addr</code> and <code>port</code> values in the
<a href="#running-application"><code>options</code> table</a>.</p>
</li>
</ul>
<h2 dir="auto"><a id="user-content-examples" aria-hidden="true" href="#examples"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Examples</h2>
<p dir="auto">Running examples requires including a <code>require</code> statement in the <code>.init.lua</code>
file, which loads the module with each example code, so for the showcase
example implemented in <code>showcase.lua</code>, <code>.init.lua</code> includes the following:</p>

<h3 dir="auto"><a id="user-content-showcase-example" aria-hidden="true" href="#showcase-example"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Showcase example</h3>
<p dir="auto">The <a href="https://github.com/pkulchenko/fullmoon/blob/master/examples/showcase.lua">showcase example</a> demonstrates some of the Fullmoon features:</p>
<ul dir="auto">
<li>serving static assets (using <code>serveAsset</code>)</li>
<li>setting http to https redirect</li>
<li>setting 404 template</li>
<li>configuring internal redirect</li>
<li>configuring external redirect (using <code>serveRedirect</code>)</li>
<li>filtering for loopback ip client addresses</li>
<li>filtering based on parameter values using regex</li>
<li>serving json</li>
</ul>
<p dir="auto">The following files need to be added to redbean executable/archive:</p>
<pre>.init.lua -- require &#34;showcase&#34;
.lua/fullmoon.lua
.lua/showcase.lua
</pre>
<h3 dir="auto"><a id="user-content-techempower-benchmark-example" aria-hidden="true" href="#techempower-benchmark-example"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>TechEmpower benchmark example</h3>
<p dir="auto">The <a href="https://github.com/pkulchenko/fullmoon/blob/master/examples/techbench.lua">TechEmpower example</a> implements various test types
for the <a href="https://www.techempower.com/benchmarks/" rel="nofollow">web framework benchmarks</a>
using Fullmoon and an in-memory sqlite database.</p>
<p dir="auto">This example demonstrates several Fullmoon/redbean features:</p>
<ul dir="auto">
<li>routing for various endpoints</li>
<li>filtering for specific HTTP methods</li>
<li>serving text and json content</li>
<li>using templates with embedded Lua code</li>
<li>using select/insert statements with included SQLite engine</li>
<li>executing prepared SQL statements</li>
</ul>
<p dir="auto">The following files need to be added to redbean executable/archive:</p>
<pre>.init.lua -- require &#34;techbench&#34;
.lua/fullmoon.lua
.lua/techbench.lua
</pre>
<h3 dir="auto"><a id="user-content-htmx-board-example" aria-hidden="true" href="#htmx-board-example"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>htmx board example</h3>
<p dir="auto">The <a href="https://github.com/pkulchenko/fullmoon/blob/master/examples/htmxboard/htmxboard.lua">htmx board example</a> demostrates a simple
fullmoon application that generates HTML fragments delivered to the client
using <a href="https://htmx.org/" rel="nofollow">htmx library</a>.</p>
<p dir="auto">This example demonstrates several Fullmoon/redbean features:</p>
<ul dir="auto">
<li>handling of GET, POST, PUT, and DELETE HTTP methods</li>
<li>processing of required and optional parameters</li>
<li>serving of dynamic HTML fragments</li>
<li>using of 10+ templates of two different types</li>
<li>including templates into other templates and passing parameters to templates</li>
<li>loading of templates from a directory</li>
<li>using internal redirects and serving static assets</li>
<li>using &#34;fallthrough&#34; routes to imitate &#34;before&#34; hook</li>
<li>serving of internal state for debugging purposes as a local-only resource</li>
</ul>
<p dir="auto">The following files need to be added to redbean executable/archive:</p>
<pre>.init.lua -- require &#34;htmxboard&#34;
.lua/fullmoon.lua
.lua/htmxboard.lua
assets/stypes.css
tmpl/* -- all files from examples/htmxboard/tmpl folder
</pre>
<p dir="auto">Note 1: since all the data is stored in memory, <strong>this example requires running
redbean with -u (uniprocess) option.</strong></p>
<p dir="auto">Note 2: this examples retrieves htmx, hyperscript, and sortable libraries from
external resources, but these libraries can be also stored as local assets,
thus providing a completely self-sufficient portable distribution package.</p>
<h2 dir="auto"><a id="user-content-documentation" aria-hidden="true" href="#documentation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Documentation</h2>
<p dir="auto">Each Fullmoon application follows the same basic flow with five main
components:</p>
<ul dir="auto">
<li><a href="#running-application">configures and runs</a> a redbean server, which</li>
<li>filters each request based on specified <a href="#conditions">conditions</a>, and</li>
<li><a href="#routes">routes</a> it to an <a href="#actions">action handler</a>, that</li>
<li>generates content (using provided <a href="#templates">template engine</a>), and</li>
<li>serves a <a href="#responses">response</a>.</li>
</ul>
<p dir="auto">Let&#39;s look at each of the components starting from the request routing.</p>
<h3 dir="auto"><a id="user-content-routes" aria-hidden="true" href="#routes"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Routes</h3>
<p dir="auto">Fullmoon handles each HTTP request using the same process:</p>
<ul dir="auto">
<li>takes the path URL and matches it against each route URL in the order
in which routes are registered</li>
<li>verifies conditions for those routes that match</li>
<li>calls a specified action handler (passing a request table) for those
routes that satisfy all conditions</li>
<li>serves the response if anything other than <code>false</code> or <code>nil</code> returned
from the action handler (and continues the process otherwise)</li>
</ul>
<p dir="auto">In general, route definitions bind request URLs (and a set of conditions)
to action handlers (which are regular Lua function). All conditions are
checked in a random order for each URL that matches the route definition.
As soon as any condition fails, the route processing is aborted and the
next route is checked <em>with one exception</em>: any condition can set the
<a href="#responding-on-failed-conditions"><code>otherwise</code> value</a>, which triggers a
response with the specified status.</p>
<p dir="auto">If no route matches the request, then the default 404 processing is
triggered, which can be customized by registering a custom 404 template
(<code>fm.setTemplate(&#34;404&#34;, &#34;My 404 page...&#34;)</code>).</p>
<h4 dir="auto"><a id="user-content-basic-routes" aria-hidden="true" href="#basic-routes"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Basic routes</h4>
<p dir="auto">Each route takes a path that matches exactly, so the route <code>&#34;/hello&#34;</code>
matches requests for <code>/hello</code> and doesn&#39;t match <code>/hell</code>, <code>/hello-world</code>,
or <code>/hello/world</code>. To match a path where <code>/hello</code> is only a part of it,
<a href="#optional-parameters">optional parameters and splat can be used</a>).</p>
<div data-snippet-clipboard-copy-content="fm.setRoute(&#34;/hello&#34;, function(r) return &#34;Hello, World!&#34; end)"><pre>fm.<span>setRoute</span>(<span><span>&#34;</span>/hello<span>&#34;</span></span>, <span>function</span>(<span>r</span>) <span>return</span> <span><span>&#34;</span>Hello, World!<span>&#34;</span></span> <span>end</span>)</pre></div>
<p dir="auto">This application responds with &#34;Hello, World!&#34; for all requests
directed at the <code>/hello</code> path and returns 404 for all other requests.</p>
<h4 dir="auto"><a id="user-content-routes-with-parameters" aria-hidden="true" href="#routes-with-parameters"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Routes with parameters</h4>
<p dir="auto">In addition to fixed routes, any path may include placeholders for
parameters, which are identified by a <code>:</code> followed immediately by
the parameter name:</p>
<div data-snippet-clipboard-copy-content="fm.setRoute(&#34;/hello/:name&#34;,
  function(r) return &#34;Hello, &#34;..(r.params.name) end)"><pre>fm.<span>setRoute</span>(<span><span>&#34;</span>/hello/:name<span>&#34;</span></span>,
  <span>function</span>(<span>r</span>) <span>return</span> <span><span>&#34;</span>Hello, <span>&#34;</span></span><span>..</span>(r.<span>params</span>.<span>name</span>) <span>end</span>)</pre></div>
<p dir="auto">Each parameter matches one or more characters except <code>/</code>, so the route
<code>&#34;/hello/:name&#34;</code> matches <code>/hello/alice</code>, <code>/hello/bob</code>, <code>/hello/123</code> and
does not match <code>/hello/bob/and/alice</code> (because of the non-matched
forward slashes) or <code>/hello/</code> (because the length of the to-be-matched
fragment is zero).</p>
<p dir="auto">Parameter names can only include alphanumeric characters and <code>_</code>.</p>
<p dir="auto">Parameters can be accessed using the request table and its <code>params</code>
table, such that <code>r.params.name</code> can be used to get the value of the
<code>name</code> parameter from the earlier example.</p>
<p dir="auto">There is another kind of parameter called splat that is written as <code>*</code>
and matches zero or more characters, <em>including</em> a forward slash (<code>/</code>).
The splat is also stored in the <code>params</code> table under the <code>splat</code> name.
For example, the route <code>&#34;/download/*&#34;</code> matches <code>/download/my/file.zip</code>
and the splat gets the value of <code>my/file.zip</code>. If multiple splats are
needed in the same route, then splats can be assigned names similar to
other parameters: <code>/download/*path/*fname.zip</code> (although the same result
can be achieved using <code>/download/*path/:fname.zip</code>, as the first splat
is going to capture all path parts except the filename).</p>
<p dir="auto">All parameters (including the splat) can appear in any part of the path
and can be surrounded by other text, which needs to be matched exactly.
This means that the route <code>&#34;/download/*/:name.:ext&#34;</code> matches
<code>/download/my/path/file.zip</code> and <code>params.name</code> gets <code>file</code>,
<code>params.ext</code> gets <code>zip</code> and <code>params.splat</code> gets <code>my/path</code> values.</p>
<h4 dir="auto"><a id="user-content-optional-parameters" aria-hidden="true" href="#optional-parameters"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Optional parameters</h4>
<p dir="auto">Any specified route fragment or parameter can be declared as optional by
wrapping it into parentheses:</p>
<div data-snippet-clipboard-copy-content="fm.setRoute(&#34;/hello(/:name)&#34;,
  function(r) return &#34;Hello, &#34;..(r.params.name or &#34;World!&#34;) end)"><pre>fm.<span>setRoute</span>(<span><span>&#34;</span>/hello(/:name)<span>&#34;</span></span>,
  <span>function</span>(<span>r</span>) <span>return</span> <span><span>&#34;</span>Hello, <span>&#34;</span></span><span>..</span>(r.<span>params</span>.<span>name</span> <span>or</span> <span><span>&#34;</span>World!<span>&#34;</span></span>) <span>end</span>)</pre></div>
<p dir="auto">In the example above, both <code>/hello</code> and <code>/hello/Bob</code> are going to be
accepted, but not <code>/hello/</code>, as the trailing slash is part of the
optional fragment and <code>:name</code> still expects one or more characters.</p>
<p dir="auto">Any unmatched optional parameter gets <code>false</code> as its value, so in the
case above &#34;Hello, World!&#34; gets returned for the <code>/hello</code> request URL.</p>
<p dir="auto">More than one optional parameter can be specified and optional
fragments can be nested, so both <code>&#34;/posts(/:pid/comments(/:cid))&#34;</code> and
<code>&#34;/posts(/:pid)/comments(/:cid)&#34;</code> are valid route values.</p>
<h4 dir="auto"><a id="user-content-custom-parameters" aria-hidden="true" href="#custom-parameters"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Custom parameters</h4>
<p dir="auto">The default value for the parameters is all characters (except <code>/</code>) of
length one or more. To specify a different set of valid characters, it
can be added at the end of the variable name; for example, using
<code>:id[%d]</code> instead of <code>:id</code> changes the parameter to match only digits.</p>
<div data-snippet-clipboard-copy-content="fm.setRoute(&#34;/hello(/:id[%d])&#34;,
  function(r) return &#34;Hello, &#34;..(r.params.id or &#34;World!&#34;) end)"><pre>fm.<span>setRoute</span>(<span><span>&#34;</span>/hello(/:id[%d])<span>&#34;</span></span>,
  <span>function</span>(<span>r</span>) <span>return</span> <span><span>&#34;</span>Hello, <span>&#34;</span></span><span>..</span>(r.<span>params</span>.<span>id</span> <span>or</span> <span><span>&#34;</span>World!<span>&#34;</span></span>) <span>end</span>)</pre></div>
<p dir="auto">The following Lua character classes are supported: <code>%w</code>, <code>%d</code>, <code>%a</code>,
<code>%l</code>, <code>%u</code>, and <code>%x</code>; any punctuation character (including <code>%</code> and <code>]</code>)
can also be escaped with <code>%</code>. Negative classes (written in Lua as <code>%W</code>)
are <em>not supported</em>, but not-in-set syntax is supported, so <code>[^%d]</code>
matches a parameter that doesn&#39;t include any digits.</p>
<p dir="auto">Note that the number of repetitions can&#39;t be changed (so <code>:id[%d]*</code>
is not a valid way to accept zero-or-more digits), as only sets are
allowed and the values still accept one or more characters. If more
flexibility in describing acceptable formats is needed, then <a href="#custom-valdators">custom
validators</a> can be used to extend the matching logic.</p>
<h4 dir="auto"><a id="user-content-query-and-form-parameters" aria-hidden="true" href="#query-and-form-parameters"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Query and Form parameters</h4>
<p dir="auto">Query and form parameters can be accessed in the same way as the path
parameters using the <code>params</code> table in the <code>request</code> table that is
passed to each action handler. Note that if there is a conflict between
parameter and query/form names, then parameter names take precedence.</p>
<h4 dir="auto"><a id="user-content-multiple-routes" aria-hidden="true" href="#multiple-routes"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Multiple routes</h4>
<p dir="auto">Despite all earlier examples showing a single route, it&#39;s rarely the
case in real applications; when multiple routes are present, they are
always <strong>evaluated in the order in which they are registered</strong>.</p>
<p dir="auto">One <code>setRoute</code> call can also set multiple routes when they have the same
set of conditions and share the same action handler:</p>
<div data-snippet-clipboard-copy-content="fm.setRoute({&#34;/route1&#34;, &#34;/route2&#34;}, handler)"><pre>fm.<span>setRoute</span>({<span><span>&#34;</span>/route1<span>&#34;</span></span>, <span><span>&#34;</span>/route2<span>&#34;</span></span>}, handler)</pre></div>
<p dir="auto">This is equivalent to two calls setting each route individually:</p>
<div data-snippet-clipboard-copy-content="fm.setRoute(&#34;/route1&#34;, handler)
fm.setRoute(&#34;/route2&#34;, handler)"><pre>fm.<span>setRoute</span>(<span><span>&#34;</span>/route1<span>&#34;</span></span>, handler)
fm.<span>setRoute</span>(<span><span>&#34;</span>/route2<span>&#34;</span></span>, handler)</pre></div>
<p dir="auto">Given that routes are evaluated in the order in which they are set, more
selective routes need to be set first, otherwise they may not get a
chance to be evaluated:</p>
<div data-snippet-clipboard-copy-content="fm.setRoute(&#34;/user/bob&#34;, handlerBob)
fm.setRoute(&#34;/user/:name&#34;, handlerName)"><pre>fm.<span>setRoute</span>(<span><span>&#34;</span>/user/bob<span>&#34;</span></span>, handlerBob)
fm.<span>setRoute</span>(<span><span>&#34;</span>/user/:name<span>&#34;</span></span>, handlerName)</pre></div>
<p dir="auto">If the routes are set in the opposite order, <code>/user/bob</code> may never be
checked as long as the <code>&#34;/user/:name&#34;</code> action handler returns some
non-<code>false</code> result.</p>
<h4 dir="auto"><a id="user-content-named-routes" aria-hidden="true" href="#named-routes"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Named routes</h4>
<p dir="auto">Each route can be provided with an optional name, which is useful in
referencing that route when its URL needs to be generated based on
specific parameter values. Provided <code>makePath</code> function accepts either
a route name or a route URL itself as well as the parameter table and
returns a path with populated parameter placeholders:</p>
<div data-snippet-clipboard-copy-content="fm.setRoute(&#34;/user/:name&#34;, handlerName)
fm.setRoute({&#34;/post/:id&#34;, routeName = &#34;post&#34;}, handlerPost)

fm.makePath(&#34;/user/:name&#34;, {name = &#34;Bob&#34;}) --&gt; /user/Bob
fm.makePath(&#34;/post/:id&#34;, {id = 123}) --&gt; /post/123
fm.makePath(&#34;post&#34;, {id = 123}) --&gt; /post/123, same as the previous one"><pre>fm.<span>setRoute</span>(<span><span>&#34;</span>/user/:name<span>&#34;</span></span>, handlerName)
fm.<span>setRoute</span>({<span><span>&#34;</span>/post/:id<span>&#34;</span></span>, routeName <span>=</span> <span><span>&#34;</span>post<span>&#34;</span></span>}, handlerPost)

fm.<span>makePath</span>(<span><span>&#34;</span>/user/:name<span>&#34;</span></span>, {name <span>=</span> <span><span>&#34;</span>Bob<span>&#34;</span></span>}) <span><span>--</span>&gt; /user/Bob</span>
fm.<span>makePath</span>(<span><span>&#34;</span>/post/:id<span>&#34;</span></span>, {id <span>=</span> <span>123</span>}) <span><span>--</span>&gt; /post/123</span>
fm.<span>makePath</span>(<span><span>&#34;</span>post<span>&#34;</span></span>, {id <span>=</span> <span>123</span>}) <span><span>--</span>&gt; /post/123, same as the previous one</span></pre></div>
<p dir="auto">If two routes use the same name, then the name is associated with the
one that was registered last, but both routes are still present.</p>
<p dir="auto">The route name can also be used with external/static routes that are
only used for URL generation.</p>
<h4 dir="auto"><a id="user-content-external-routes" aria-hidden="true" href="#external-routes"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>External routes</h4>
<p dir="auto">If the route is only used for path generation, then it doesn&#39;t even need
to have a route handler:</p>
<div data-snippet-clipboard-copy-content="fm.setRoute({&#34;https://youtu.be/:videoid&#34;, routeName = &#34;youtube&#34;})
fm.makePath(&#34;youtube&#34;, {videoid = &#34;abc&#34;}) --&gt; https://youtu.be/abc"><pre>fm.<span>setRoute</span>({<span><span>&#34;</span>https://youtu.be/:videoid<span>&#34;</span></span>, routeName <span>=</span> <span><span>&#34;</span>youtube<span>&#34;</span></span>})
fm.<span>makePath</span>(<span><span>&#34;</span>youtube<span>&#34;</span></span>, {videoid <span>=</span> <span><span>&#34;</span>abc<span>&#34;</span></span>}) <span><span>--</span>&gt; https://youtu.be/abc</span></pre></div>
<p dir="auto">A route without any action handler is skiped during the route matching
process.</p>
<h3 dir="auto"><a id="user-content-conditions" aria-hidden="true" href="#conditions"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Conditions</h3>
<p dir="auto">If an application needs to execute different functions depending on
specific values of request attributes (for example, a method), this
library provides two main options: (1) check for the attribute value an
action handler (for example, using <code>request.method == &#34;GET&#34;</code> check) and
(2) add a condition that filters out requests such that only requests
using the specified attribute value reach the action handler. This
section describes the second option in more detail.</p>
<h4 dir="auto"><a id="user-content-handling-of-http-methods" aria-hidden="true" href="#handling-of-http-methods"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Handling of HTTP methods</h4>
<p dir="auto">Each registered route by default responds to all HTTP methods (GET, PUT,
POST, etc.), but it&#39;s possible to configure each route to only respond
to specific HTTP methods:</p>
<div data-snippet-clipboard-copy-content="fm.setRoute(fm.GET&#34;/hello(/:name)&#34;,
  function(r) return &#34;Hello, &#34;..(r.params.name or &#34;World!&#34;) end)"><pre>fm.<span>setRoute</span>(fm.<span>GET</span><span><span>&#34;</span>/hello(/:name)<span>&#34;</span></span>,
  <span>function</span>(<span>r</span>) <span>return</span> <span><span>&#34;</span>Hello, <span>&#34;</span></span><span>..</span>(r.<span>params</span>.<span>name</span> <span>or</span> <span><span>&#34;</span>World!<span>&#34;</span></span>) <span>end</span>)</pre></div>
<p dir="auto">In this case, the syntax <code>fm.GET&#34;/hello(/:name)&#34;</code> configures the route
to only accept <code>GET</code> requests. This syntax is equivalent to passing a
table with the route and any additional filtering conditions:</p>
<div data-snippet-clipboard-copy-content="fm.setRoute({&#34;/hello(/:name)&#34;, method = &#34;GET&#34;},
  function(r) return &#34;Hello, &#34;..(r.params.name or &#34;World!&#34;) end)"><pre>fm.<span>setRoute</span>({<span><span>&#34;</span>/hello(/:name)<span>&#34;</span></span>, method <span>=</span> <span><span>&#34;</span>GET<span>&#34;</span></span>},
  <span>function</span>(<span>r</span>) <span>return</span> <span><span>&#34;</span>Hello, <span>&#34;</span></span><span>..</span>(r.<span>params</span>.<span>name</span> <span>or</span> <span><span>&#34;</span>World!<span>&#34;</span></span>) <span>end</span>)</pre></div>
<p dir="auto">If more than one method needs to be specified, then a table with a list
of methods can be passed instead of one string value:</p>
<div data-snippet-clipboard-copy-content="fm.setRoute({&#34;/hello(/:name)&#34;, method = {&#34;GET&#34;, &#34;POST&#34;}},
  function(r) return &#34;Hello, &#34;..(r.params.name or &#34;World!&#34;) end)"><pre>fm.<span>setRoute</span>({<span><span>&#34;</span>/hello(/:name)<span>&#34;</span></span>, method <span>=</span> {<span><span>&#34;</span>GET<span>&#34;</span></span>, <span><span>&#34;</span>POST<span>&#34;</span></span>}},
  <span>function</span>(<span>r</span>) <span>return</span> <span><span>&#34;</span>Hello, <span>&#34;</span></span><span>..</span>(r.<span>params</span>.<span>name</span> <span>or</span> <span><span>&#34;</span>World!<span>&#34;</span></span>) <span>end</span>)</pre></div>
<p dir="auto">Every route that allows a <code>GET</code> request also (implicitly) allows a
<code>HEAD</code> request and that request is handled by returning all headers
without sending the body itself. If for some reason this implicit
handling is not desirable, then adding <code>HEAD = false</code> to the method
table disables it (as in <code>method = {&#34;GET&#34;, &#34;POST&#34;, HEAD = false}</code>).</p>
<p dir="auto">Note that requests with non-matching methods don&#39;t get rejected, but
rather <a href="#actions">fall through</a> to be checked by other routes and
trigger the 404 status returned if they don&#39;t get matched (with one
<a href="#responding-on-failed-conditions">exception</a>).</p>
<h4 dir="auto"><a id="user-content-conditional-routes" aria-hidden="true" href="#conditional-routes"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Conditional routes</h4>
<p dir="auto">In addition to <code>method</code>, other conditions can be applied using <code>host</code>,
<code>clientAddr</code>, <code>serverAddr</code>, <code>scheme</code>, request headers, and parameters.
For example, specifying <code>name = &#34;Bob&#34;</code> as one of the conditions ensures
the value of the <code>name</code> parameter to be &#34;Bob&#34; for the action handler to
be called.</p>
<p dir="auto">Any request header can be checked using the header name as the key, so
<code>ContentType = &#34;multipart/form-data&#34;</code> is satisfied if the value of the
<code>Content-Type</code> header is <code>multipart/form-data</code>. Note that the header
value may include other elements (a boundary or a charset as part of
the <code>Content-Type</code> value) and only the actual media type is compared.</p>
<h4 dir="auto"><a id="user-content-custom-validators" aria-hidden="true" href="#custom-validators"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Custom validators</h4>
<p dir="auto">String values are not the only values that can be used in conditional
routes. If more than one value is acceptable, passing a table allows to
provide a list of acceptable values. For example, if <code>Bob</code> and <code>Alice</code>
are acceptable values, then <code>name = {Bob = true, Alice = true}</code>
expresses this as a condition.</p>
<p dir="auto">Two special values passed in a table allow to apply a <em>regex</em> or a
<em>pattern</em> validation:</p>
<ul dir="auto">
<li><code>regex</code>: accepts a string that has a regular expression. For example,
<code>name = {regex = &#34;^(Bob|Alice)$&#34;}</code> has the same result as the hash
check shown earlier in this section</li>
<li><code>pattern</code>: accepts a string with a Lua patern expression. For example,
<code>name = {pattern = &#34;^%u%l+$&#34;}</code> accepts values that start with an
uppercase character followed by one or more lowercase characters.</li>
</ul>
<p dir="auto">These two checks can be combined with the table existence check:
<code>name = {Bob = true, regex = &#34;^Alice$&#34;}</code> accepts both <code>Bob</code> and <code>Alice</code>
values. If the first table-existence check fails, then the results of
the <code>regex</code> or <code>pattern</code> expression is returned.</p>
<p dir="auto">The last type of a custom validator is a function. The provided function
receives the value to validate and its result is evaluated as <code>false</code> or
<code>true</code>. For example, passing <code>id = tonumber</code> ensures that the <code>id</code> value
is a number. As another example, <code>clientAddr = fm.isLoopbackIp</code> ensures
that the client address is a loopback ip address.</p>
<div data-snippet-clipboard-copy-content="fm.setRoute({&#34;/local-only&#34;, clientAddr = fm.isLoopbackIp},
  function(r) return &#34;Local content&#34; end)"><pre>fm.<span>setRoute</span>({<span><span>&#34;</span>/local-only<span>&#34;</span></span>, clientAddr <span>=</span> fm.<span>isLoopbackIp</span>},
  <span>function</span>(<span>r</span>) <span>return</span> <span><span>&#34;</span>Local content<span>&#34;</span></span> <span>end</span>)</pre></div>
<p dir="auto">As the validator function can be generated dynamically, this works too:</p>
<div data-snippet-clipboard-copy-content="local function isLessThan(n)
  return function(l) return tonumber(l) &lt; n end
end
fm.setRoute(fm.POST{&#34;/upload&#34;, ContentLength = isLessThan(100000)},
  function(r) ...handle the upload... end)"><pre><span>local</span> <span>function</span> <span>isLessThan</span>(<span>n</span>)
  <span>return</span> <span>function</span>(<span>l</span>) <span>return</span> <span>tonumber</span>(l) <span>&lt;</span> n <span>end</span>
<span>end</span>
fm.<span>setRoute</span>(fm.<span>POST</span>{<span><span>&#34;</span>/upload<span>&#34;</span></span>, ContentLength <span>=</span> <span>isLessThan</span>(<span>100000</span>)},
  <span>function</span>(<span>r</span>) <span>...</span>handle the upload<span>...</span> <span>end</span>)</pre></div>
<p dir="auto">It&#39;s important to keep in mind that the validator function actually
returns a function that is going to be called during a request to apply
the check. In the previous example, the returned function accepts a
header value and compares it with the limit passed during its creation.</p>
<h4 dir="auto"><a id="user-content-responding-on-failed-conditions" aria-hidden="true" href="#responding-on-failed-conditions"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Responding on failed conditions</h4>
<p dir="auto">In some cases, failing to satisfy a condition is a sufficient reason to
returns some response back to the client without checking other routes.
In a case like this, setting <code>otherwise</code> value to a number or a function
returns either a response with the specified status or the result of the
function:</p>
<div data-snippet-clipboard-copy-content="local function isLessThan(n)
  return function(l) return tonumber(l) &lt; n end
end
fm.setRoute(fm.POST{&#34;/upload&#34;, ContentLength = isLessThan(100000),
    otherwise = 413}, function(r) ...handle the upload... end)"><pre><span>local</span> <span>function</span> <span>isLessThan</span>(<span>n</span>)
  <span>return</span> <span>function</span>(<span>l</span>) <span>return</span> <span>tonumber</span>(l) <span>&lt;</span> n <span>end</span>
<span>end</span>
fm.<span>setRoute</span>(fm.<span>POST</span>{<span><span>&#34;</span>/upload<span>&#34;</span></span>, ContentLength <span>=</span> <span>isLessThan</span>(<span>100000</span>),
    otherwise <span>=</span> <span>413</span>}, <span>function</span>(<span>r</span>) <span>...</span>handle the upload<span>...</span> <span>end</span>)</pre></div>
<p dir="auto">In this example the routing engine matches the route and then validates
the two conditions comparing the method value with <code>POST</code> and the value
of the <code>Content-Length</code> header with the result of the <code>isLessThen</code>
function. If one of the conditions doesn&#39;t match, the status specified
by the <code>otherwise</code> value is returned with the rest of the response.</p>
<p dir="auto">If the returned status needs to only apply to the <code>ContentLength</code> check,
then the <code>otherwise</code> value along with the validator function can be
moved to a table associated with the <code>ContentLength</code> check:</p>
<div data-snippet-clipboard-copy-content="fm.setRoute(fm.POST{&#34;/upload&#34;,
    ContentLength = {isLessThan(100000), otherwise = 413}
  }, function(r) ...handle the upload... end)"><pre>fm.<span>setRoute</span>(fm.<span>POST</span>{<span><span>&#34;</span>/upload<span>&#34;</span></span>,
    ContentLength <span>=</span> {<span>isLessThan</span>(<span>100000</span>), otherwise <span>=</span> <span>413</span>}
  }, <span>function</span>(<span>r</span>) <span>...</span>handle the upload<span>...</span> <span>end</span>)</pre></div>
<p dir="auto">The difference between the last two examples is that in this example
only the <code>ContentLength</code> check failure triggers the 413 response (and
all other methods falls through to other routes), while in the previous
one both <code>method</code> and <code>ContentLength</code> check failures trigger the same
413 response.</p>
<p dir="auto">Note that when the checked value is <code>nil</code>, the check against a table is
deemed to be valid and the route is not going to be rejected. For
example, a check for an optional parameter made against a string
(<code>name = &#34;Bo&#34;</code>) fails if the value of <code>params.name</code> is <code>nil</code>, but passes
if the same check is made against a table (<code>name = {Bo=true, Mo=true}</code>),
including regex/pattern checks. If this is not desirable, then a custom
validator function can explicitly check for the correct value.</p>
<p dir="auto">Consider the following example:</p>
<div data-snippet-clipboard-copy-content="fm.setRoute({&#34;/hello(/:name)&#34;,
    method = {&#34;GET&#34;, &#34;POST&#34;, otherwise = 405}},
  function(r) return &#34;Hello, &#34;..(r.params.name or &#34;World!&#34;) end)"><pre>fm.<span>setRoute</span>({<span><span>&#34;</span>/hello(/:name)<span>&#34;</span></span>,
    method <span>=</span> {<span><span>&#34;</span>GET<span>&#34;</span></span>, <span><span>&#34;</span>POST<span>&#34;</span></span>, otherwise <span>=</span> <span>405</span>}},
  <span>function</span>(<span>r</span>) <span>return</span> <span><span>&#34;</span>Hello, <span>&#34;</span></span><span>..</span>(r.<span>params</span>.<span>name</span> <span>or</span> <span><span>&#34;</span>World!<span>&#34;</span></span>) <span>end</span>)</pre></div>
<p dir="auto">In this case, if this endpoint is accessed with the <code>PUT</code> method, then
instead of checking other routes (because the <code>method</code> condition is not
satisfied), the 405 status is returned, as configured with the specified
<code>otherwise</code> value. <a href="#handling-of-http-methods">As already mentioned</a>,
this route accepts a <code>HEAD</code> request too (even when not listed), as a
<code>GET</code> request is accepted.</p>
<p dir="auto">When the 405 (Bad method) status is returned and the <code>Allow</code> header is
not set, it is set to the list of methods allowed by the route. In the
case above it is set to <code>GET, POST, HEAD, OPTIONS</code> values, as those are
the methods allowed by this configuration. If the <code>otherwise</code> value is a
function (rather than a number), then returning a proper result and
setting the <code>Allow</code> header is the responsibility of this function.</p>
<p dir="auto">The <code>otherwise</code> value can also be set to a function, which provides more
flexibility than just setting a status value. For example, setting
<code>otherwise = fm.serveResponse(413, &#34;Payload Too Large&#34;)</code> triggers a
response with the specified status and message.</p>
<h3 dir="auto"><a id="user-content-actions" aria-hidden="true" href="#actions"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Actions</h3>
<p dir="auto">An action handler receives all incoming HTTP requests filtered for a
particular route. Each of the examples shown so far includes an action
handler, which is passed as a second parameter to the <code>setRoute</code> method.</p>
<p dir="auto"><strong>Multiple action handlers can be executed in the course of handling one
request and as soon as one handler returns a result that is evaluated as
a non-<code>false</code> value, the route handling process ends.</strong> Returning <code>false</code>
or <code>nil</code> from an action handler continues the processing, which allows
implementing some common processing that applies to multiple routes
(similar to what is done using &#34;before&#34; filters in other frameworks):</p>
<div data-snippet-clipboard-copy-content="local uroute = &#34;/user/:id&#34;
fm.setRoute({uroute..&#34;/*&#34;, method = {&#34;GET&#34;, &#34;POST&#34;, otherwise = 405}},
    function(r)
      -- retrieve user information based on r.params.id
      -- and store in r.user (as one of the options);
      -- return error if user is not found
      return false -- continue handling
  end)
fm.setRoute(fm.GET(uroute..&#34;/view&#34;), function(r) ... end)
fm.setRoute(fm.GET(uroute..&#34;/edit&#34;), function(r) ... end)
fm.setRoute(fm.POST(uroute..&#34;/edit&#34;), function(r) ... end)"><pre><span>local</span> uroute <span>=</span> <span><span>&#34;</span>/user/:id<span>&#34;</span></span>
fm.<span>setRoute</span>({uroute<span>..</span><span><span>&#34;</span>/*<span>&#34;</span></span>, method <span>=</span> {<span><span>&#34;</span>GET<span>&#34;</span></span>, <span><span>&#34;</span>POST<span>&#34;</span></span>, otherwise <span>=</span> <span>405</span>}},
    <span>function</span>(<span>r</span>)
      <span><span>--</span> retrieve user information based on r.params.id</span>
      <span><span>--</span> and store in r.user (as one of the options);</span>
      <span><span>--</span> return error if user is not found</span>
      <span>return</span> <span>false</span> <span><span>--</span> continue handling</span>
  <span>end</span>)
fm.<span>setRoute</span>(fm.<span>GET</span>(uroute<span>..</span><span><span>&#34;</span>/view<span>&#34;</span></span>), <span>function</span>(<span>r</span>) <span>...</span> <span>end</span>)
fm.<span>setRoute</span>(fm.<span>GET</span>(uroute<span>..</span><span><span>&#34;</span>/edit<span>&#34;</span></span>), <span>function</span>(<span>r</span>) <span>...</span> <span>end</span>)
fm.<span>setRoute</span>(fm.<span>POST</span>(uroute<span>..</span><span><span>&#34;</span>/edit<span>&#34;</span></span>), <span>function</span>(<span>r</span>) <span>...</span> <span>end</span>)</pre></div>
<p dir="auto">In this example, the first route can generate three outcomes:</p>
<ul dir="auto">
<li>if the route is not matched, then other (later set) routes are checked</li>
<li>if the route is matched, but the condition (the <code>method</code> check) is not
matched, then 405 status is returned</li>
<li>if the route is matched and the action handler is executed, it either
retrieves the user and returns <code>false</code>, which continues processing
with other routes, or fails to retrieve the user and returns an error.</li>
</ul>
<p dir="auto">In general, an action handler can return any of the following values:</p>
<ul dir="auto">
<li><code>true</code>: this stops any further processing, sets the headers that have
been specified so far and returns the generated or set response body.</li>
<li><code>false</code> or <code>nil</code>: this stops the processing of the current route and
proceeds to the next one.</li>
<li>any string value: this sends a response with 200 as the status and the
returned string as its body. The <code>Content-Type</code> is set based on the
body content (using a primitive heuristic) if not set explicitly.</li>
<li>any <code>serve*</code> method: this executes the requested method and returns
an empty string or <code>true</code> to signal the end of the processing.</li>
<li>any other returned value is ignored and interpreted as if <code>true</code> is
returned (and a warning is logged).</li>
</ul>
<h3 dir="auto"><a id="user-content-requests" aria-hidden="true" href="#requests"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Requests</h3>
<p dir="auto">Each <a href="#actions">action handler</a> accepts a request table that includes
the following attributes:</p>
<ul dir="auto">
<li><code>method</code>: request HTTP method (GET, POST, and others).</li>
<li><code>host</code>: request host (if provided) or the bind address.</li>
<li><code>serverAddr</code>: address to which listening server socket is bound.</li>
<li><code>remoteAddr</code>: client ip4 address encoded as a number. This takes into
consideration reverse proxy scenarios. Use <code>formatIp</code> function to
convert to a string representing the address.</li>
<li><code>scheme</code>: request URL scheme (if any).</li>
<li><code>path</code>: request URL path that is guaranteed to begin with <code>/</code>.</li>
<li><code>authority</code>: request URL with scheme, host, and port present.</li>
<li><code>url</code>: request URL as an ASCII string with illegal characters percent
encoded.</li>
<li><code>body</code>: request message body (if present) or an empty string.</li>
<li><code>date</code>: request date as a Unix timestamp.</li>
<li><code>time</code>: current time as a Unix timestamp with 0.0001s precision.</li>
</ul>
<p dir="auto">The request table also has several <a href="https://github.com/pkulchenko/fullmoon/blob/master/utility-functions">utility functions</a>,
as well as <a href="#headers">headers</a> and <a href="#cookies">cookies</a> tables that allow
retrieving request headers and cookies and setting of headers and
cookies that are included with the response.</p>
<p dir="auto">The same request table is given as a parameter to all (matched) action
handlers, so it can be used as a mechanism to pass values between those
action handlers, as any value assigned as a field in one handler is
available in all other action handlers.</p>
<h4 dir="auto"><a id="user-content-headers" aria-hidden="true" href="#headers"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Headers</h4>
<p dir="auto">The <code>headers</code> table provides access to the request headers. For example,
<code>r.headers[&#34;Content-Type&#34;]</code> returns the value of the <code>Content-Type</code>
header. This form of header access is case-insensitive. A shorter form
is also available (<code>r.headers.ContentType</code>), but only for registered
headers and <em>is</em> case-sensitive and with the capitalization preserved.</p>
<p dir="auto">The request headers can also be set using the same syntax. For example,
<code>r.headers.MyHeader = &#34;value&#34;</code> sets <code>MyHeader: value</code> response header.
As the headers are set at the end of the action handler processing, the
earlier set headers can also be removed by assigning a <code>nil</code> value.</p>
<p dir="auto">Repeatable headers can also be assigned with values separated by commas:
<code>r.headers.Allow = &#34;GET, POST&#34;</code>.</p>
<h4 dir="auto"><a id="user-content-cookies" aria-hidden="true" href="#cookies"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Cookies</h4>
<p dir="auto">The <code>cookies</code> table provides access to the request cookies. For example,
<code>r.cookies.token</code> returns the value of the <code>token</code> cookie.</p>
<p dir="auto">The cookies can also be set using the same syntax. For example,
<code>r.cookies.token = &#34;new value&#34;</code> sets <code>token</code> cookie to <code>new value</code>.
If the cookie needs to have its attributes set as well, then the value
and the attributes need to be passed as a table:
<code>r.cookies.token = {&#34;new value&#34;, Secure = true, HttpOnly = true}</code>.</p>
<p dir="auto">The following cookie attributes are supported (their lowercase spelling
can be used as well):</p>
<ul dir="auto">
<li><code>Expires</code>: sets the maximum lifetime of the cookie as an HTTP-date
timestamp. Can be specified as a date in the RFC1123 (string) format
or as a UNIX timestamp (number of seconds).</li>
<li><code>MaxAge</code>: sets number of seconds until the cookie expires. A zero or
negative number will expire the cookie immediately. If both <code>Expires</code>
and <code>MaxAge</code> are set, <code>MaxAge</code> has precedence.</li>
<li><code>Domain</code>: sets the host to which the cookie will be sent.</li>
<li><code>Path</code>: sets the path that must be present in the request URL, or
the client will not send the Cookie header.</li>
<li><code>Secure</code>: (bool) requests the cookie to be only send to the
server when a request is made with the https: scheme.</li>
<li><code>HttpOnly</code>: (bool) forbids JavaScript from accessing the cookie.</li>
<li><code>SameSite</code>: (<code>Strict</code>, <code>Lax</code>, or <code>None</code>) controls whether a cookie is
sent with cross-origin requests, providing some protection against
cross-site request forgery attacks.</li>
</ul>
<h4 dir="auto"><a id="user-content-utility-functions" aria-hidden="true" href="#utility-functions"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Utility functions</h4>
<p dir="auto">The following functions are available as both request functions (as
fields in the request table) and as library functions:</p>
<ul dir="auto">
<li><code>makePath(route[, parameters])</code>: creates a path from either a route
name or a path string by populating its parameters using values from
the parameters table (when provided).
The path doesn&#39;t need to be just a path component of a URL and can be
a full URL as well. <a href="#optional-parameters">Optional parts</a> are removed
if they include parameters that are not provided.</li>
<li><code>makeUrl([url,] options)</code>: creates a URL using the provided value and
a set of URL parameters provided in the <code>options</code> table: scheme, user,
pass, host, port, path, and fragment.
The <code>url</code> parameter is optional; the current request URL is used if
<code>url</code> is not specified. Any of the options can be provided or removed
(using <code>false</code> as the value). For example, <code>makeUrl({scheme=&#34;https&#34;})</code>
sets the scheme for the current URL to <code>https</code>.</li>
</ul>
<h3 dir="auto"><a id="user-content-templates" aria-hidden="true" href="#templates"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Templates</h3>
<h4 dir="auto"><a id="user-content-configuring-templates" aria-hidden="true" href="#configuring-templates"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Configuring templates</h4>
<h4 dir="auto"><a id="user-content-serving-template-outputs" aria-hidden="true" href="#serving-template-outputs"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Serving template outputs</h4>
<h4 dir="auto"><a id="user-content-passing-parameters-to-templates" aria-hidden="true" href="#passing-parameters-to-templates"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Passing parameters to templates</h4>
<h4 dir="auto"><a id="user-content-including-templates-in-other-templates" aria-hidden="true" href="#including-templates-in-other-templates"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Including templates in other templates</h4>
<h4 dir="auto"><a id="user-content-processing-layouts" aria-hidden="true" href="#processing-layouts"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Processing layouts</h4>
<h3 dir="auto"><a id="user-content-responses" aria-hidden="true" href="#responses"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Responses</h3>
<p dir="auto">Each action handler generates some sort of response to send back to the
client. In addition to <a href="#actions">strings</a>, the application can return
the following results:</p>
<ul dir="auto">
<li>general responses (<code>serveResponse</code>),</li>
<li>templates (<code>serveContent</code>),</li>
<li>redirects (<code>serveRedirect</code>),</li>
<li>static assets (<code>serveAsset</code>),</li>
<li>errors (<code>serveError</code>),</li>
<li>directory index (<code>serveIndex</code>), and</li>
<li>internal redirects/resources (<code>servePath</code>).</li>
</ul>
<p dir="auto">Each of these methods can be used as the return value from an action
handler. <code>serveAsset</code>, <code>servePath</code>, and <code>serveIndex</code> methods can also
be used as action handlers directly:</p>
<div data-snippet-clipboard-copy-content="fm.setRoute(&#34;/static/*&#34;, fm.serveAsset)
fm.setRoute(&#34;/blog/&#34;, fm.serveIndex(&#34;/new-blog/&#34;))"><pre>fm.<span>setRoute</span>(<span><span>&#34;</span>/static/*<span>&#34;</span></span>, fm.<span>serveAsset</span>)
fm.<span>setRoute</span>(<span><span>&#34;</span>/blog/<span>&#34;</span></span>, fm.<span>serveIndex</span>(<span><span>&#34;</span>/new-blog/<span>&#34;</span></span>))</pre></div>
<p dir="auto">The first route configures all existing assets to be served from
<code>/static/*</code> location; the second route configures <code>/blog/</code> URL to return
the index (<code>index.lua</code> or <code>index.html</code> resource) from <code>/new-blog/</code>
folder.</p>
<h4 dir="auto"><a id="user-content-serving-response" aria-hidden="true" href="#serving-response"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Serving response</h4>
<p dir="auto"><code>serveResponse(status[, headers][, body])</code>: sends an HTTP response using
provided <code>status</code>, <code>headers</code>, and <code>body</code> values.
<code>headers</code> is an optional table populated with HTTP header name/value
pairs. If provided, this set of headers <em>removes all other headers</em> set
earlier during handling of the same request. Similar to the headers set
using the <code>request.headers</code> field, the names are <em>case-insensitive</em>, but
provided aliases for header names with dashes are <em>case-sensitive</em>:
<code>{ContentType = &#34;foo&#34;}</code> is an alternative form for
<code>{[&#34;Content-Type&#34;] = &#34;foo&#34;}</code>. <code>body</code> is an optional string.</p>
<p dir="auto">Consider the following example:</p>
<div data-snippet-clipboard-copy-content="return fm.serveResponse(413, &#34;Payload Too Large&#34;)"><pre><span>return</span> fm.<span>serveResponse</span>(<span>413</span>, <span><span>&#34;</span>Payload Too Large<span>&#34;</span></span>)</pre></div>
<p dir="auto">This returns the status value <code>413</code> and sets the body of the returned
message to <code>Payload Too Large</code> (with the header table not specified).</p>
<p dir="auto">If only the status value needs to be set, the library provides a short
form using the <code>serve###</code> syntax:</p>

<p dir="auto">It can also be used as the action handler itself:</p>
<div data-snippet-clipboard-copy-content="fm.setRoute(fm.PUT&#34;/status&#34;, fm.serve402)"><pre>fm.<span>setRoute</span>(fm.<span>PUT</span><span><span>&#34;</span>/status<span>&#34;</span></span>, fm.<span>serve402</span>)</pre></div>
<h4 dir="auto"><a id="user-content-serving-content" aria-hidden="true" href="#serving-content"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Serving content</h4>
<p dir="auto"><code>serveContent(name, parameters)</code> renders a template using provided
parameters. <code>name</code> is a string that names the template (as set by a
<code>setTemplate</code> call) and <code>parameters</code> is a table with template parameters
(referenced as variables in the template).</p>
<h4 dir="auto"><a id="user-content-serving-redirect" aria-hidden="true" href="#serving-redirect"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Serving redirect</h4>
<h4 dir="auto"><a id="user-content-serving-static-asset" aria-hidden="true" href="#serving-static-asset"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Serving static asset</h4>
<h4 dir="auto"><a id="user-content-serving-error" aria-hidden="true" href="#serving-error"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Serving error</h4>
<h4 dir="auto"><a id="user-content-serving-directory-index" aria-hidden="true" href="#serving-directory-index"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Serving directory index</h4>
<h4 dir="auto"><a id="user-content-serving-path-internal-redirect" aria-hidden="true" href="#serving-path-internal-redirect"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Serving path (internal redirect)</h4>
<h3 dir="auto"><a id="user-content-running-application" aria-hidden="true" href="#running-application"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Running application</h3>
<p dir="auto"><code>run</code> method executes the configured application. By default the server
is launched listening on localhost and port 8080. Both of these
values can be changed by passing <code>addr</code> and <code>port</code> options:</p>
<div data-snippet-clipboard-copy-content="fm.run({addr = &#34;localhost&#34;, port = 8080})"><pre>fm.<span>run</span>({addr <span>=</span> <span><span>&#34;</span>localhost<span>&#34;</span></span>, port <span>=</span> <span>8080</span>})</pre></div>
<p dir="auto">The following options are supported; the default values are shown in
parentheses and options marked with <code>mult</code> can set multiple values by
passing a table:</p>
<ul dir="auto">
<li><code>addr</code>: sets the address to listen on (mult)</li>
<li><code>brand</code>: sets the <code>Server</code> header value (<code>&#34;redbean/v# fullmoon/v#&#34;</code>)</li>
<li><code>cache</code>: configures <code>Cache-Control</code> and <code>Expires</code> headers (in seconds)
for all static assets served. A negative value disables the headers.
Zero value means no cache.</li>
<li><code>certificate</code>: sets the TLS certificate value (mult)</li>
<li><code>directory</code>: sets local directory to serve assets from in addition to
serving them from the archive within the executable itself (mult)</li>
<li><code>headers</code>: sets default headers added to each response by passing a
table with HTTP header name/value pairs</li>
<li><code>logMessages</code>: enables logging of response headers</li>
<li><code>logBodies</code>: enables logging of request bodies (POST/PUT/etc.)</li>
<li><code>logPath</code>: sets the log file path on the local file system</li>
<li><code>pidPath</code>: sets the pid file path on the local file system</li>
<li><code>port</code>: sets the port number to listen on (8080)</li>
<li><code>privateKey</code>: sets the TLS private key value (mult)</li>
<li><code>sslTicketLifetime</code>: sets the duration (in seconds) of the ssl ticket
(86400)</li>
</ul>
<p dir="auto">The <code>key</code> and <code>certificate</code> string values can be populated using the
<code>getAsset</code> method that can access both assets packaged within the
webserver archive and those stored in the file system.</p>
<h3 dir="auto"><a id="user-content-logging" aria-hidden="true" href="#logging"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Logging</h3>
<h2 dir="auto"><a id="user-content-benchmark" aria-hidden="true" href="#benchmark"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Benchmark</h2>
<p dir="auto">The results shown are from runs in the same environment and on the same
hardware as the <a href="https://redbean.dev/#benchmark" rel="nofollow">published redbean benchmark</a>
(thanks to <a href="https://github.com/jart/">@jart</a> for executing the tests!).
Even though these tests are using pre-1.5 version of redbean and 0.10 version
of Fullmoon, the current versions of redbean/Fullmoon are expected to deliver
similar performance.</p>
<p dir="auto">The tests are using exactly the same code that is shown in the
<a href="#fullmoon">introduction</a> with one small change: using <code>{%= name %}</code> instead of
<code>{%&amp; name %}</code> in the template, which skips HTML escaping.
This code demonstrates routing, parameter handling and template processing.</p>
<pre>$ wrk -t 12 -c 120 http://127.0.0.1:8080/user/paul
Running 10s test @ http://127.0.0.1:8080/user/paul
  12 threads and 120 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   312.06us    4.39ms 207.16ms   99.85%
    Req/Sec    32.48k     6.69k   71.37k    82.25%
  3913229 requests in 10.10s, 783.71MB read
Requests/sec: <strong>387477.76</strong>
Transfer/sec:     77.60MB
</pre>
<p dir="auto">The following test is using the same configuration, but redbean is compiled
with <code>MODE=optlinux</code> option:</p>
<pre>$ wrk -t 12 -c 120 http://127.0.0.1:8080/user/paul
Running 10s test @ http://127.0.0.1:8080/user/paul
  12 threads and 120 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   346.31us    5.13ms 207.31ms   99.81%
    Req/Sec    36.18k     6.70k   90.47k    80.92%
  4359909 requests in 10.10s, 0.85GB read
Requests/sec: <strong>431684.80</strong>
Transfer/sec:     86.45MB
</pre>
<p dir="auto">The following two tests demonstrate the latency of the request handling by
Fullmoon and by redbean serving a static asset (no concurrency):</p>
<pre>$ wrk -t 1 -c 1 http://127.0.0.1:8080/user/paul
Running 10s test @ http://127.0.0.1:8080/user/paul
  1 threads and 1 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    <strong>15.75us    7.64us 272.00us</strong>   93.32%
    Req/Sec    65.54k   589.15    66.58k    74.26%
  658897 requests in 10.10s, 131.96MB read
Requests/sec:  65241.45
Transfer/sec:     13.07MB
</pre>
<p dir="auto">The following are the results from redbean itself on static compressed assets:</p>
<pre>$ wrk -H &#39;Accept-Encoding: gzip&#39; -t 1 -c 1 htt://10.10.10.124:8080/tool/net/demo/index.html
Running 10s test @ htt://10.10.10.124:8080/tool/net/demo/index.html
  1 threads and 1 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     <strong>7.40us    1.95us 252.00us</strong>   97.05%
    Req/Sec   129.66k     3.20k  135.98k    64.36%
  1302424 requests in 10.10s, 1.01GB read
Requests/sec: 128963.75
Transfer/sec:    102.70MB
</pre>
<h2 dir="auto"><a id="user-content-status" aria-hidden="true" href="#status"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Status</h2>
<p dir="auto">Highly experimental with everything being subject to change.</p>
<h2 dir="auto"><a id="user-content-author" aria-hidden="true" href="#author"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Author</h2>
<p dir="auto">Paul Kulchenko (<a href="mailto:paul@zerobrane.com">paul@zerobrane.com</a>)</p>
<h2 dir="auto"><a id="user-content-license" aria-hidden="true" href="#license"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>License</h2>
<p dir="auto">See <a href="https://github.com/pkulchenko/fullmoon/blob/master/LICENSE">LICENSE</a>.</p>
</article>
        </div></div>
  </body>
</html>
