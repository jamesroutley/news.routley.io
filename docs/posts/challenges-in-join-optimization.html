<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.starrocks.io/blog/inside-starrocks-why-joins-are-faster-than-youd-expect">Original</a>
    <h1>Challenges in join optimization</h1>
    
    <div id="readability-page-1" class="page"><div>
  
  
  <div>
    <div>
      <p>
        Publish date: Jan 20, 2026 9:18:43 PM
      </p> 
      <p><span id="hs_cos_wrapper_post_body" data-hs-cos-general-type="meta_field" data-hs-cos-type="rich_text"><div>
<div aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu">
<div aria-describedby="277" aria-labelledby="277" data-hsprotectrole="tooltip">
<div tabindex="-1">
<div data-page-id="JYFDdBLUEovv04xi6PHczW0FnIc" data-lark-html-role="root" data-docx-has-block-data="false">
<blockquote>
<div data-page-id="UR51dklKPo0vujxdhKXca3prn9g" data-lark-html-role="root" data-docx-has-block-data="false">
<div data-page-id="ShXodcWU7oKjCOxsBzDcpcginEK" data-lark-html-role="root" data-docx-has-block-data="false">
<p><em>âœğŸ¼ About The Author:</em></p>
<div>
<p><em><span>Seaven He, StarRocks Committer, Engineer at Celerdata</span></em></p>
</div>
</div>
</div>
</blockquote>

</div>
</div>
<p><span>Joins are the hardest part of OLAP. Many systems canâ€™t run them efficiently at scale, so teams denormalize into wide tables instead, 10Ã— their storage, dealing with complex stream processing pipelines, and painfully slow and expensive schema evolution that triggers large backfills.</span></p>
</div>
</div>
</div>
<p id="dbcc" data-selectable-paragraph="">StarRocks takes the opposite approach: keep data normalized and make joins fast enough to run on the fly. The challenge is the plan. In a distributed system, the join search space is huge, and a good plan can be orders of magnitude faster.</p>
<p id="ea83" data-selectable-paragraph="">This deep dive explains how StarRocksâ€™ cost-based optimizer makes that possible, in four parts: join fundamentals and optimization challenges, logical join optimizations, join reordering, and distributed join planning. Finally, we examine real-world case studies from<span>Â </span><strong>NAVER, Demandbase, and Shopee</strong><span>Â </span>to illustrate how efficient join execution delivers tangible business value.</p>

<h2 id="19dd" data-selectable-paragraph="">Join Fundamentals and Optimization Challenges</h2>
<h3 id="2a37" data-selectable-paragraph=""><strong>1.1 Join Types</strong></h3>
<figure>
<div data-hsprotectrole="button" tabindex="0">
<div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*YZVDKfBpQCK3B7CU--SeLA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*YZVDKfBpQCK3B7CU--SeLA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*YZVDKfBpQCK3B7CU--SeLA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*YZVDKfBpQCK3B7CU--SeLA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*YZVDKfBpQCK3B7CU--SeLA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*YZVDKfBpQCK3B7CU--SeLA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YZVDKfBpQCK3B7CU--SeLA.png 1400w" type="image/webp" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><source srcset="https://miro.medium.com/v2/resize:fit:640/1*YZVDKfBpQCK3B7CU--SeLA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*YZVDKfBpQCK3B7CU--SeLA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*YZVDKfBpQCK3B7CU--SeLA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*YZVDKfBpQCK3B7CU--SeLA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*YZVDKfBpQCK3B7CU--SeLA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*YZVDKfBpQCK3B7CU--SeLA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*YZVDKfBpQCK3B7CU--SeLA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" data-testid="og"/><img alt="" width="700" height="330" loading="lazy" src="https://miro.medium.com/v2/resize:fit:1400/1*YZVDKfBpQCK3B7CU--SeLA.png" data-hsprotectrole="presentation"/></picture></div>
</div>
</figure>
<p id="2947" data-selectable-paragraph="">The diagram above illustrates several common join types:</p>
<ul>
<li id="d779" data-selectable-paragraph=""><strong>Cross Join</strong>: Produces a Cartesian product between the left and right tables.</li>
<li id="6229" data-selectable-paragraph=""><strong>Full / Left / Right Outer Join</strong>: For rows that do not find a match, outer joins return results with<span>Â </span><code>NULL</code><span>Â </span>values filled in according to the join semanticsâ€”on both tables (full), the left table (left), or the right table (right).</li>
<li id="3f05" data-selectable-paragraph=""><strong>Anti Join</strong>: Returns rows that do<span>Â </span><em>not</em><span>Â </span>have a matching counterpart in the join relationship. Anti-joins typically appear in query plans for<span>Â </span><code>NOT IN</code><span>Â </span>or<span>Â </span><code>NOT EXISTS</code><span>Â </span>subqueries.</li>
<li id="282c" data-selectable-paragraph=""><strong>Semi Join</strong>: The opposite of an anti-join, it returns only rows that<span>Â </span><em>do</em><span>Â </span>have a match in the join relationship, without producing duplicate result rows from the matching side.</li>
<li id="db8d" data-selectable-paragraph=""><strong>Inner Join</strong>: Returns the intersection of the left and right tables. Based on the join condition, it may generate one-to-many result rows.</li>
</ul>

<h3 id="628f" data-selectable-paragraph="">1.2 Challenges in Join Optimization</h3>
<p id="8c2b" data-selectable-paragraph="">Join performance optimization generally falls into two areas:</p>
<ul>
<li id="9403" data-selectable-paragraph="">improving the efficiency of join operators on a single node, and</li>
<li id="6c23" data-selectable-paragraph="">designing a reasonable join plan that minimizes input size and execution cost.</li>
</ul>
<p id="77e3" data-selectable-paragraph="">This article focuses on the second aspect. To set the stage, we begin by examining the key challenges in join optimization.</p>

<p id="c138" data-selectable-paragraph=""><strong>Challenge 1: Multiple Join Implementation Strategies</strong></p>
<figure>
<div data-hsprotectrole="button" tabindex="0">
<div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*wMQLW9fxyeXQEWuaHzfgWA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*wMQLW9fxyeXQEWuaHzfgWA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*wMQLW9fxyeXQEWuaHzfgWA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*wMQLW9fxyeXQEWuaHzfgWA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*wMQLW9fxyeXQEWuaHzfgWA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*wMQLW9fxyeXQEWuaHzfgWA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wMQLW9fxyeXQEWuaHzfgWA.png 1400w" type="image/webp" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><source srcset="https://miro.medium.com/v2/resize:fit:640/1*wMQLW9fxyeXQEWuaHzfgWA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*wMQLW9fxyeXQEWuaHzfgWA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*wMQLW9fxyeXQEWuaHzfgWA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*wMQLW9fxyeXQEWuaHzfgWA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*wMQLW9fxyeXQEWuaHzfgWA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*wMQLW9fxyeXQEWuaHzfgWA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*wMQLW9fxyeXQEWuaHzfgWA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" data-testid="og"/><img alt="" width="700" height="364" loading="lazy" src="https://miro.medium.com/v2/resize:fit:1400/1*wMQLW9fxyeXQEWuaHzfgWA.png" data-hsprotectrole="presentation"/></picture></div>
</div>
</figure>
<p id="14c5" data-selectable-paragraph="">As shown above, different join algorithms perform very differently depending on the scenario. For example, Sort-Merge Join can be significantly more efficient than Hash Join when operating on already sorted data. However, in distributed databases where data is typically hash-partitioned, Hash Join often outperforms Sort-Merge Join by a wide margin. As a result,<span>Â </span><strong>the database must choose the most appropriate join strategy based on the specific workload and data characteristics.</strong></p>

<p id="9df6" data-selectable-paragraph=""><strong>Challenge 2: Join Order Selection in Multi-Table Joins</strong></p>
<figure>
<div data-hsprotectrole="button" tabindex="0">
<div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*b4rcn3vyUFUc5Af-8pcgcA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*b4rcn3vyUFUc5Af-8pcgcA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*b4rcn3vyUFUc5Af-8pcgcA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*b4rcn3vyUFUc5Af-8pcgcA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*b4rcn3vyUFUc5Af-8pcgcA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*b4rcn3vyUFUc5Af-8pcgcA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b4rcn3vyUFUc5Af-8pcgcA.png 1400w" type="image/webp" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><source srcset="https://miro.medium.com/v2/resize:fit:640/1*b4rcn3vyUFUc5Af-8pcgcA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*b4rcn3vyUFUc5Af-8pcgcA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*b4rcn3vyUFUc5Af-8pcgcA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*b4rcn3vyUFUc5Af-8pcgcA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*b4rcn3vyUFUc5Af-8pcgcA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*b4rcn3vyUFUc5Af-8pcgcA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*b4rcn3vyUFUc5Af-8pcgcA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" data-testid="og"/><img alt="" width="700" height="315" loading="lazy" src="https://miro.medium.com/v2/resize:fit:1400/1*b4rcn3vyUFUc5Af-8pcgcA.png" data-hsprotectrole="presentation"/></picture></div>
</div>
</figure>
<p id="6650" data-selectable-paragraph="">In multi-table join scenarios, executing highly selective joins first can significantly improve overall query performance. However, determining the optimal join order is far from trivial.</p>
<p id="e5e3" data-selectable-paragraph="">As illustrated above, under a<span>Â </span><strong>left-deep join tree</strong><span>Â </span>model, the number of possible join orders for<span>Â </span><em>N</em><span>Â </span>tables is on the order of<span>Â </span><code>2^n-1</code>. Under a<span>Â </span><strong>bushy join tree</strong><span>Â </span>model, the number of possible combinations grows even more dramatically, reaching<span>Â </span><code>2^(n-1) * C(n-1)</code>. For a database optimizer, the time and cost required to search for the optimal join order therefore increases<span>Â </span><strong>exponentially</strong>, making join ordering one of the most challenging problems in query optimization.</p>

<p id="bf4f" data-selectable-paragraph=""><strong>Challenge 3: Difficulty in Estimating Join Effectiveness</strong></p>
<figure>
<div data-hsprotectrole="button" tabindex="0">
<div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*7r5XtRg84xirJd16bkkhYw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*7r5XtRg84xirJd16bkkhYw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*7r5XtRg84xirJd16bkkhYw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*7r5XtRg84xirJd16bkkhYw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*7r5XtRg84xirJd16bkkhYw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*7r5XtRg84xirJd16bkkhYw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7r5XtRg84xirJd16bkkhYw.png 1400w" type="image/webp" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><source srcset="https://miro.medium.com/v2/resize:fit:640/1*7r5XtRg84xirJd16bkkhYw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*7r5XtRg84xirJd16bkkhYw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*7r5XtRg84xirJd16bkkhYw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*7r5XtRg84xirJd16bkkhYw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*7r5XtRg84xirJd16bkkhYw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*7r5XtRg84xirJd16bkkhYw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*7r5XtRg84xirJd16bkkhYw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" data-testid="og"/><img alt="" width="700" height="423" loading="lazy" src="https://miro.medium.com/v2/resize:fit:1400/1*7r5XtRg84xirJd16bkkhYw.png" data-hsprotectrole="presentation"/></picture></div>
</div>
</figure>
<p id="2f58" data-selectable-paragraph="">Before query execution, it is extremely difficult for the database to accurately predict the real execution behavior of a join. A common assumption is that joining a small table with a large table is more selective than joining two large tables, but this is not always true.</p>
<p id="0713" data-selectable-paragraph="">In practice, one-to-many relationships are common, and in more complex queries, joins are often combined with filters, aggregations, and other operators. After data flows through multiple transformations, the optimizerâ€™s ability to accurately estimate join input sizes and selectivity degrades significantly.</p>

<p id="c03a" data-selectable-paragraph=""><strong>Challenge 4: A Single-Node Optimal Plan Is Not Necessarily Optimal in Distributed Systems</strong></p>
<figure>
<div data-hsprotectrole="button" tabindex="0"><p><span>Press enter or click to view image in full size</span></p><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*ucqvLhW-jXXukI0K_nMaxg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*ucqvLhW-jXXukI0K_nMaxg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*ucqvLhW-jXXukI0K_nMaxg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*ucqvLhW-jXXukI0K_nMaxg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*ucqvLhW-jXXukI0K_nMaxg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*ucqvLhW-jXXukI0K_nMaxg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ucqvLhW-jXXukI0K_nMaxg.png 1400w" type="image/webp" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><source srcset="https://miro.medium.com/v2/resize:fit:640/1*ucqvLhW-jXXukI0K_nMaxg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*ucqvLhW-jXXukI0K_nMaxg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*ucqvLhW-jXXukI0K_nMaxg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*ucqvLhW-jXXukI0K_nMaxg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*ucqvLhW-jXXukI0K_nMaxg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*ucqvLhW-jXXukI0K_nMaxg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*ucqvLhW-jXXukI0K_nMaxg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" data-testid="og"/><img alt="" width="700" height="257" loading="lazy" src="https://miro.medium.com/v2/resize:fit:1400/1*ucqvLhW-jXXukI0K_nMaxg.png" data-hsprotectrole="presentation"/></picture></div>
</div>
</figure>
<p id="4d66" data-selectable-paragraph="">In distributed systems, data often needs to be<span>Â </span><strong>reshuffled</strong><span>Â </span>or<span>Â </span><strong>broadcast</strong><span>Â </span>across nodes so that the required records can participate in join computation. Distributed joins are no exception.</p>
<p id="31fd" data-selectable-paragraph="">This introduces a key complication: an execution plan that is optimal in a single-node database may perform poorly in a distributed environment because it ignores data distribution and network transfer costs.</p>
<p id="bb04" data-selectable-paragraph="">Therefore, when planning join execution strategies in distributed databases, the optimizer must explicitly account for data placement and communication overhead in addition to local execution efficiency.</p>

<h3 id="a660" data-selectable-paragraph="">1.3 SQL Optimization Workflow</h3>
<figure>
<div data-hsprotectrole="button" tabindex="0">
<div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*8Qv67g56xJrrM9ezy43CQA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*8Qv67g56xJrrM9ezy43CQA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*8Qv67g56xJrrM9ezy43CQA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*8Qv67g56xJrrM9ezy43CQA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*8Qv67g56xJrrM9ezy43CQA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*8Qv67g56xJrrM9ezy43CQA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8Qv67g56xJrrM9ezy43CQA.png 1400w" type="image/webp" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><source srcset="https://miro.medium.com/v2/resize:fit:640/1*8Qv67g56xJrrM9ezy43CQA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*8Qv67g56xJrrM9ezy43CQA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*8Qv67g56xJrrM9ezy43CQA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*8Qv67g56xJrrM9ezy43CQA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*8Qv67g56xJrrM9ezy43CQA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*8Qv67g56xJrrM9ezy43CQA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*8Qv67g56xJrrM9ezy43CQA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" data-testid="og"/><img alt="" width="700" height="255" loading="lazy" src="https://miro.medium.com/v2/resize:fit:1400/1*8Qv67g56xJrrM9ezy43CQA.png" data-hsprotectrole="presentation"/></picture></div>
</div>
</figure>
<p id="392a" data-selectable-paragraph="">In StarRocks, SQL optimization is primarily handled by the query optimizer and is mainly concentrated in the<span>Â </span><strong>Rewrite</strong><span>Â </span>and<span>Â </span><strong>Optimize</strong><span>Â </span>phases.</p>

<h3 id="4e73" data-selectable-paragraph="">1.4 Principles of Join Optimization</h3>
<p id="7347" data-selectable-paragraph="">At present, StarRocks primarily uses<span>Â </span><strong>Hash Join</strong><span>Â </span>as its join algorithm. By default, the<span>Â </span><strong>right-hand table</strong><span>Â </span>is used to build the hash table. Based on this design choice, we summarize five key optimization principles:</p>
<ol>
<li>Different join types have very different performance characteristics. Whenever possible, prefer higher-performance join types and avoid expensive ones. Based on the typical size of join outputs, the rough performance ranking is:<span>Â </span><strong>Semi Join / Anti Join &gt; Inner Join &gt; Outer Join &gt; Full Outer Join &gt; Cross Join</strong>.</li>
<li>When using Hash Join, building the hash table on a smaller input is significantly more efficient than building it on a large table.</li>
<li>In multi-table joins, prioritize joins with high selectivity.</li>
<li>Minimize the amount of data participating in joins whenever possible.</li>
<li>Minimize network overhead introduced by distributed joins.</li>
</ol>

<h2 id="6e9a" data-selectable-paragraph="">Join Logical Optimization</h2>
<p id="34df" data-selectable-paragraph="">This section introduces a set of<span>Â </span><strong>heuristic rules</strong><span>Â </span>used by StarRocks to optimize joins at the logical level.</p>
<h3 id="58ac" data-selectable-paragraph="">2.1 Type Transformations</h3>
<p id="45a4" data-selectable-paragraph="">The first group of optimizations directly follows the first join optimization principle discussed earlier:<span>Â </span><strong>transform low-efficiency join types into more efficient ones whenever the semantics allow it</strong>.</p>
<p id="9aec" data-selectable-paragraph="">StarRocks currently applies three major transformation rules.</p>

<p id="c6a7" data-selectable-paragraph=""><strong>Rule 1: Converting a Cross Join into an Inner Join</strong></p>
<p id="3588" data-selectable-paragraph="">A Cross Join can be rewritten as an Inner Join when it satisfies the following condition:</p>
<ul>
<li id="df4c" data-selectable-paragraph="">There exists at least one predicate that expresses a join relationship between the two tables.</li>
</ul>
<p id="b7f9" data-selectable-paragraph="">For example:</p>
<pre><span id="2acc" data-selectable-paragraph=""><span>-- Before transformation</span></span></pre>

<p id="1448" data-selectable-paragraph=""><strong>Rule 2: Converting an Outer Join into an Inner Join</strong></p>
<p id="d2a6" data-selectable-paragraph="">A Left / Right Outer Join can be rewritten as an Inner Join when the following conditions are met:</p>
<ul>
<li id="541d" data-selectable-paragraph="">There exists a predicate referencing the<span>Â </span><strong>nullable side</strong><span>Â </span>of the outer join (Right table for a Left Outer Join, or Left table for a Right Outer Join).</li>
<li id="c622" data-selectable-paragraph="">The predicate is a<span>Â </span><strong>strict (null-rejecting) predicate</strong>.</li>
</ul>
<p id="2226" data-selectable-paragraph="">Example:</p>
<pre><span id="7d20" data-selectable-paragraph=""><span>-- Before transformation</span></span></pre>
<p id="10e5" data-selectable-paragraph="">âš ï¸<span>Â </span><strong>Important note:</strong><span>Â </span>In an outer join,<span>Â </span><code>ON</code><span>Â </span>clause predicates participate in<span>Â </span><strong>null extension</strong>, not filtering. Therefore, this rule does<span>Â </span><strong>not</strong><span>Â </span>apply to join predicates inside the<span>Â </span><code>ON</code><span>Â </span>clause:</p>
<pre><span id="fd4f" data-selectable-paragraph=""><span>SELECT</span> <span>*</span> <span>FROM</span> t1 <span>LEFT</span> <span>OUTER</span> <span>JOIN</span> t2 <span>ON</span> t1.v1 <span>=</span> t2.v1 <span>AND</span> t2.v1 <span>&gt;</span> <span>1</span>;</span></pre>
<p id="df32" data-selectable-paragraph="">This query is<span>Â </span><strong>not semantically equivalent</strong><span>Â </span>to:</p>
<pre><span id="b856" data-selectable-paragraph=""><span>SELECT</span> <span>*</span> <span>FROM</span> t1 <span>INNER</span> <span>JOIN</span> t2 <span>ON</span> t1.v1 <span>=</span> t2.v1 <span>AND</span> t2.v1 <span>&gt;</span> <span>1</span>;</span></pre>
<p id="560d" data-selectable-paragraph="">This introduces the concept of<span>Â </span><strong>strict (null-rejecting) predicates</strong>. In StarRocks, a predicate that filters out<span>Â </span><code>NULL</code><span>Â </span>values is considered a<span>Â </span><em>strict predicate</em>, for example<span>Â </span><code>a &gt; 0</code>. Predicates that do not eliminate<span>Â </span><code>NULL</code><span>Â </span>values are classified as<span>Â </span><em>non-strict predicates</em>, such as<span>Â </span><code>a IS NULL</code>. Most predicates fall into the strict category; non-strict predicates are primarily those involving<span>Â </span><code>IS NULL</code>,<span>Â </span><code>IF</code>,<span>Â </span><code>CASE WHEN</code>, or certain function-based expressions.</p>
<p id="e1d8" data-selectable-paragraph="">To determine whether a predicate is strict, StarRocks uses a simple yet effective approach: all referenced columns are replaced with<span>Â </span><code>NULL</code>, and the expression is then simplified. If the result evaluates to<span>Â </span><code>TRUE</code>, it means the<span>Â </span><code>WHERE</code><span>Â </span>clause does not filter out rows with<span>Â </span><code>NULL</code><span>Â </span>inputs, and the predicate is therefore non-strict. Conversely, if the result evaluates to<span>Â </span><code>FALSE</code><span>Â </span>or<span>Â </span><code>NULL</code>, the predicate is considered strict.</p>
<figure>

</figure>

<p id="d1a8" data-selectable-paragraph=""><strong>Rule 3: Converting a Full Outer Join into a Left / Right Outer Join</strong></p>
<p id="b4a9" data-selectable-paragraph="">A Full Outer Join can be rewritten as a Left Outer Join or Right Outer Join when the following condition is satisfied:</p>
<ul>
<li id="1472" data-selectable-paragraph="">There exists a strict predicate that can be bound exclusively to the left or right table.</li>
</ul>
<p id="4998" data-selectable-paragraph="">Example:</p>
<pre><span id="ded9" data-selectable-paragraph=""><span>-- Before transformation</span></span></pre>

<h3 id="9a0b" data-selectable-paragraph="">2.2 Predicate Pushdown</h3>
<p id="6ec7" data-selectable-paragraph="">Predicate pushdown is one of the most important and commonly used join optimization techniques. Its primary purpose is to<span>Â </span><strong>filter join inputs as early as possible</strong>, thereby reducing the amount of data involved in the join and improving overall performance.</p>
<p id="72c9" data-selectable-paragraph="">For predicates in the<span>Â </span><code>WHERE</code><span>Â </span>clause, predicate pushdown can be appliedâ€”and may enable join type transformationsâ€”when the following conditions are satisfied:</p>
<ul>
<li id="16ad" data-selectable-paragraph="">The join can be of<span>Â </span><strong>any type</strong>.</li>
<li id="2193" data-selectable-paragraph="">The<span>Â </span><code>WHERE</code><span>Â </span>predicate can be<span>Â </span><strong>bound to one of the join inputs</strong>.</li>
</ul>
<p id="e298" data-selectable-paragraph="">For example:</p>
<pre><span id="844f" data-selectable-paragraph=""><span>Select</span> <span>*</span>  </span></pre>
<p id="c486" data-selectable-paragraph="">The predicate pushdown process proceeds as follows.</p>

<p id="e3c7" data-selectable-paragraph=""><strong>Step 1</strong><span>Â </span>:</p>
<p id="66e2" data-selectable-paragraph="">Push down<span>Â </span><code>(t1.v1 = 1 AND t2.v1 = 2)</code><span>Â </span>and<span>Â </span><code>(t3.v2 = 3)</code><span>Â </span>separately. Since the join type transformation rules are satisfied,<code>(t1 LEFT OUTER JOIN t2) LEFT OUTER JOIN t3</code>can be rewritten as<span>Â </span><code>(t1 LEFT OUTER JOIN t2) INNER JOIN t3</code>.</p>
<figure>
<div data-hsprotectrole="button" tabindex="0">
<div><picture><img alt="" width="700" height="356" loading="lazy" src="https://miro.medium.com/v2/resize:fit:1400/1*Netv3z18n2jrk3NQlwh8og.png" data-hsprotectrole="presentation"/></picture></div>
</div>
</figure>

<p id="27ad" data-selectable-paragraph=""><strong>Step 2:</strong></p>
<p id="f628" data-selectable-paragraph="">Continue pushing down<span>Â </span><code>(t1.v1 = 1)</code><span>Â </span>and<span>Â </span><code>(t2.v1 = 2)</code>. At this point,<code>t1 LEFT OUTER JOIN t2</code><span>Â </span>can be further transformed into<code>t1 INNER JOIN t2</code>.</p>
<figure>
<div data-hsprotectrole="button" tabindex="0">
<div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*ABLo_tRcaIzcmTc-usOMXA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*ABLo_tRcaIzcmTc-usOMXA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*ABLo_tRcaIzcmTc-usOMXA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*ABLo_tRcaIzcmTc-usOMXA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*ABLo_tRcaIzcmTc-usOMXA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*ABLo_tRcaIzcmTc-usOMXA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ABLo_tRcaIzcmTc-usOMXA.png 1400w" type="image/webp" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><source srcset="https://miro.medium.com/v2/resize:fit:640/1*ABLo_tRcaIzcmTc-usOMXA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*ABLo_tRcaIzcmTc-usOMXA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*ABLo_tRcaIzcmTc-usOMXA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*ABLo_tRcaIzcmTc-usOMXA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*ABLo_tRcaIzcmTc-usOMXA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*ABLo_tRcaIzcmTc-usOMXA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*ABLo_tRcaIzcmTc-usOMXA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" data-testid="og"/><img alt="" width="700" height="320" loading="lazy" src="https://miro.medium.com/v2/resize:fit:1400/1*ABLo_tRcaIzcmTc-usOMXA.png" data-hsprotectrole="presentation"/></picture></div>
</div>
</figure>
<p id="09ee" data-selectable-paragraph="">It is important to note that<span>Â </span><strong>predicate pushdown rules for join predicates in the<span>Â </span></strong><code><strong>ON</strong></code><strong><span>Â </span>clause differ from those for the<span>Â </span></strong><code><strong>WHERE</strong></code><strong><span>Â </span>clause</strong>. We distinguish between two cases:<span>Â </span><strong>Inner Joins</strong><span>Â </span>and<span>Â </span><strong>other join types</strong>.</p>

<p id="3d5e" data-selectable-paragraph=""><strong>Case 1: Inner Join</strong></p>
<p id="6731" data-selectable-paragraph="">For<span>Â </span><strong>Inner Joins</strong>, pushing down join predicates in the<span>Â </span><code>ON</code><span>Â </span>clause follows the same rules as<span>Â </span><code>WHERE</code><span>Â </span>clause predicate pushdown. This has already been discussed above and will not be repeated here.</p>

<p id="09b7" data-selectable-paragraph=""><strong>Case 2: Outer / Semi / Anti Joins</strong></p>
<p id="8ffc" data-selectable-paragraph="">For Outer, Semi, and Anti Joins, predicate pushdown on<span>Â </span><code>ON</code><span>Â </span>clause join predicates must satisfy the following constraints, and<span>Â </span><strong>no join type transformation is allowed during the pushdown process</strong>:</p>
<ul>
<li id="cd0b" data-selectable-paragraph="">The join must be a<span>Â </span><strong>Left or Right Outer / Semi / Anti Join</strong>.</li>
<li id="0845" data-selectable-paragraph="">The join predicate must be bindable<span>Â </span><strong>only to the nullable side</strong><span>Â </span>(the right input for a Left Join, or the left input for a Right Join).</li>
</ul>
<p id="fae1" data-selectable-paragraph="">Consider the following example:</p>
<pre><span id="ddcf" data-selectable-paragraph=""><span>Select</span> <span>*</span>  </span></pre>
<p id="1f3f" data-selectable-paragraph="">The predicate pushdown proceeds as follows.</p>

<p id="4049" data-selectable-paragraph=""><strong>Step 1:</strong></p>
<p id="f1f5" data-selectable-paragraph="">Push down the join predicate<span>Â </span><code>(t3.v2 = 3)</code>, which can be bound to the right input of<span>Â </span><code>t1 LEFT JOIN t2 LEFT JOIN t3</code>. At this stage, the<span>Â </span><code>LEFT OUTER JOIN</code><span>Â </span><strong>cannot</strong><span>Â </span>be converted into an<span>Â </span><code>INNER JOIN</code>.</p>
<figure>
<div data-hsprotectrole="button" tabindex="0"><p><span>Press enter or click to view image in full size</span></p><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*j3kx2D5qguB4IJY1WI56YQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*j3kx2D5qguB4IJY1WI56YQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*j3kx2D5qguB4IJY1WI56YQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*j3kx2D5qguB4IJY1WI56YQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*j3kx2D5qguB4IJY1WI56YQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*j3kx2D5qguB4IJY1WI56YQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j3kx2D5qguB4IJY1WI56YQ.png 1400w" type="image/webp" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><source srcset="https://miro.medium.com/v2/resize:fit:640/1*j3kx2D5qguB4IJY1WI56YQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*j3kx2D5qguB4IJY1WI56YQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*j3kx2D5qguB4IJY1WI56YQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*j3kx2D5qguB4IJY1WI56YQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*j3kx2D5qguB4IJY1WI56YQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*j3kx2D5qguB4IJY1WI56YQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*j3kx2D5qguB4IJY1WI56YQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" data-testid="og"/><img alt="" width="700" height="257" loading="lazy" src="https://miro.medium.com/v2/resize:fit:1400/1*j3kx2D5qguB4IJY1WI56YQ.png" data-hsprotectrole="presentation"/></picture></div>
</div>
</figure>
<p id="e9bb" data-selectable-paragraph=""><strong>Step 2:</strong></p>
<p id="c4da" data-selectable-paragraph="">Push down the join predicate<span>Â </span><code>(t2.v1 = 2)</code>, which can be bound to the right input of<code>t1 LEFT JOIN t2</code>.</p>
<p id="a7d3" data-selectable-paragraph="">However, the predicate<span>Â </span><code>(t1.v1 = 1)</code><span>Â </span>is bound to the left input. Pushing it down would filter rows from<span>Â </span><code>t1</code>, violating the semantics of a<span>Â </span><code>LEFT OUTER JOIN</code>. Therefore, this predicate<span>Â </span><strong>cannot be pushed down</strong>.</p>
<figure>
<div data-hsprotectrole="button" tabindex="0"><p><span>Press enter or click to view image in full size</span></p><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*50ZrOVaAU7iHxRi1tZLJbA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*50ZrOVaAU7iHxRi1tZLJbA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*50ZrOVaAU7iHxRi1tZLJbA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*50ZrOVaAU7iHxRi1tZLJbA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*50ZrOVaAU7iHxRi1tZLJbA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*50ZrOVaAU7iHxRi1tZLJbA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*50ZrOVaAU7iHxRi1tZLJbA.png 1400w" type="image/webp" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><source srcset="https://miro.medium.com/v2/resize:fit:640/1*50ZrOVaAU7iHxRi1tZLJbA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*50ZrOVaAU7iHxRi1tZLJbA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*50ZrOVaAU7iHxRi1tZLJbA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*50ZrOVaAU7iHxRi1tZLJbA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*50ZrOVaAU7iHxRi1tZLJbA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*50ZrOVaAU7iHxRi1tZLJbA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*50ZrOVaAU7iHxRi1tZLJbA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" data-testid="og"/><img alt="" width="700" height="266" loading="lazy" src="https://miro.medium.com/v2/resize:fit:1400/1*50ZrOVaAU7iHxRi1tZLJbA.png" data-hsprotectrole="presentation"/></picture></div>
</div>
</figure>
<h3 id="053e" data-selectable-paragraph="">2.3 Predicate Extraction</h3>
<p id="67ad" data-selectable-paragraph="">In the predicate pushdown rules discussed earlier, only predicates with<span>Â </span><strong>conjunctive semantics</strong><span>Â </span>can be pushed down. For example, in<span>Â </span><code>t1.v1 = 1 AND t2.v1 = 2 AND t3.v2 = 3</code>, each sub-predicate is connected by conjunction, making pushdown straightforward. However, predicates with<span>Â </span><strong>disjunctive semantics</strong>, such as<code>t1.v1 = 1 OR t2.v1 = 2 OR t3.v2 = 3</code>, cannot be pushed down directly.</p>
<p id="0fe7" data-selectable-paragraph="">In real-world queries, disjunctive predicates are quite common. To address this, StarRocks introduces an optimization called<span>Â </span><strong>predicate extraction (column value derivation)</strong>. This technique derives conjunctive predicates from disjunctive ones by performing a series of union and intersection operations on column value ranges. The derived conjunctive predicates can then be pushed down to reduce join input size.</p>
<p id="c6fd" data-selectable-paragraph="">For example:</p>
<pre><span id="2103" data-selectable-paragraph=""><span>-- Before predicate extraction</span></span></pre>
<p id="7318" data-selectable-paragraph="">Using column value derivation on<span>Â </span><code>(t2.v1 = 2 AND t1.v2 = 3) OR (t2.v1 &gt; 5 AND t1.v2 = 4)</code>, the optimizer can extract the following predicates:</p>
<ul>
<li id="a1d6" data-selectable-paragraph=""><code>t2.v1 &gt;= 2</code></li>
<li id="d2ab" data-selectable-paragraph=""><code>t1.v2 IN (3, 4)</code></li>
</ul>
<p id="122c" data-selectable-paragraph="">The query can then be rewritten as:</p>
<pre><span id="9d4d" data-selectable-paragraph=""><span>SELECT</span> *</span></pre>
<p id="91da" data-selectable-paragraph="">It is important to note that the extracted predicates may form a superset of the original predicate ranges. As a result, they cannot safely replace the original predicates and must instead be applied in addition to them.</p>

<h3 id="a309" data-selectable-paragraph="">2.4 Equivalence Derivation</h3>
<p id="51af" data-selectable-paragraph="">In addition to predicate extraction, another important predicate-level optimization is<span>Â </span><strong>equivalence derivation</strong>. This technique leverages<span>Â </span><strong>join equality conditions</strong><span>Â </span>to infer value constraints on one side of the join from predicates applied to the other side.</p>
<p id="5501" data-selectable-paragraph="">Specifically, based on the join condition, value ranges on columns from the left table can be used to derive corresponding value ranges on columns from the right table, and vice versa.</p>
<p id="f82b" data-selectable-paragraph="">For example:</p>
<pre><span id="aa20" data-selectable-paragraph=""><span>-- Original SQL</span></span></pre>
<p id="0949" data-selectable-paragraph="">Using predicate extraction on<span>Â </span><code>(t2.v1 = 2 AND t1.v2 = 3) OR (t2.v1 &gt; 5 AND t1.v2 = 4)</code>, the optimizer can derive the following predicates:</p>
<ul>
<li id="ae58" data-selectable-paragraph=""><code>t2.v1 &gt;= 2</code></li>
<li id="a6cd" data-selectable-paragraph=""><code>t1.v2 IN (3, 4)</code></li>
</ul>
<p id="a540" data-selectable-paragraph="">Resulting in:</p>
<pre><span id="97fd" data-selectable-paragraph=""><span>SELECT</span> *</span></pre>
<p id="2923" data-selectable-paragraph="">Next, using the join predicate<span>Â </span><code>(t1.v1 = t2.v1)</code><span>Â </span>together with<span>Â </span><code>t2.v1 &gt;= 2</code>, equivalence derivation can infer an additional predicate:</p>
<ul>
<li id="4283" data-selectable-paragraph=""><code>t1.v1 &gt;= 2</code></li>
</ul>
<p id="e5f4" data-selectable-paragraph="">The query can therefore be further rewritten as:</p>
<pre><span id="411e" data-selectable-paragraph=""><span>SELECT</span> *</span></pre>
<p id="ff55" data-selectable-paragraph=""><strong>Applicability and Constraints</strong></p>
<p id="af51" data-selectable-paragraph="">The scope of equivalence derivation is more limited than predicate extraction. Predicate extraction can be applied to arbitrary predicates, whereas equivalence derivation, like predicate pushdown, has different constraints depending on the join type. As before, we distinguish between<span>Â </span><code>WHERE</code><span>Â </span>predicates and<span>Â </span><code>ON</code><span>Â </span>clause join predicates.</p>
<p id="26f3" data-selectable-paragraph=""><strong>For<span>Â </span></strong><code><strong>WHERE</strong></code><strong><span>Â </span>predicates:</strong></p>
<ul>
<li id="b5bc" data-selectable-paragraph="">There are almost no restrictions. Predicates can be derived from the left table to the right table and vice versa.</li>
</ul>
<p id="d626" data-selectable-paragraph=""><strong>For<span>Â </span></strong><code><strong>ON</strong></code><strong><span>Â </span>clause join predicates:</strong></p>
<ul>
<li id="186e" data-selectable-paragraph="">For<span>Â </span><strong>Inner Joins</strong>, the rules are the same as for<span>Â </span><code>WHERE</code><span>Â </span>predicatesâ€”no additional constraints apply.</li>
<li id="e01c" data-selectable-paragraph="">For join types other than Inner Join, only<span>Â </span><strong>Semi Joins</strong><span>Â </span>and<span>Â </span><strong>Outer Joins</strong><span>Â </span>are supported, and derivation is<span>Â </span><strong>one-directional only</strong>, opposite to the join direction:</li>
<li id="a3b0" data-selectable-paragraph="">For a<span>Â </span><strong>Left Outer Join</strong>, predicates can be derived from the left table to the right table.</li>
<li id="cb11" data-selectable-paragraph="">For a<span>Â </span><strong>Right Outer Join</strong>, predicates can be derived from the right table to the left table.</li>
</ul>

<p id="9208" data-selectable-paragraph=""><strong>Why Is Equivalence Derivation One-Directional for Outer / Semi Joins?</strong></p>
<p id="1b74" data-selectable-paragraph="">The reason is straightforward. Consider a<span>Â </span><strong>Left Outer Join</strong>. As discussed in predicate pushdown rules, only predicates on the<span>Â </span><strong>right table</strong><span>Â </span>can be pushed down; predicates on the left table cannot, as doing so would violate the semantics of a left outer join.</p>
<p id="724a" data-selectable-paragraph="">For the same reason, predicates derived<span>Â </span><em>from the right table</em><span>Â </span>and applied to the left table must also respect this constraint. In practice, such derived predicates on the preserved side do not help filter data early and instead introduce additional evaluation overhead. Therefore, equivalence derivation for Outer and Semi Joins is intentionally restricted to a single direction.</p>

<p id="d4e5" data-selectable-paragraph=""><strong>Implementation Details</strong></p>
<p id="0dcb" data-selectable-paragraph="">StarRocks implements equivalence derivation by maintaining two internal maps:</p>
<ul>
<li id="519e" data-selectable-paragraph="">One map tracks<span>Â </span><strong>column-to-column equivalence relationships</strong>.</li>
<li id="3d49" data-selectable-paragraph="">The other map tracks<span>Â </span><strong>column-to-value or column-to-expression equivalences</strong>.</li>
</ul>
<p id="0011" data-selectable-paragraph="">By performing lookups and inference across these two maps, the optimizer derives additional equivalent predicates. The overall mechanism is illustrated below:</p>
<figure>
<div data-hsprotectrole="button" tabindex="0">
<div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*9kiXjr88eYPoGX4ES1H3UA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*9kiXjr88eYPoGX4ES1H3UA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*9kiXjr88eYPoGX4ES1H3UA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*9kiXjr88eYPoGX4ES1H3UA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*9kiXjr88eYPoGX4ES1H3UA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*9kiXjr88eYPoGX4ES1H3UA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9kiXjr88eYPoGX4ES1H3UA.png 1400w" type="image/webp" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><source srcset="https://miro.medium.com/v2/resize:fit:640/1*9kiXjr88eYPoGX4ES1H3UA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*9kiXjr88eYPoGX4ES1H3UA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*9kiXjr88eYPoGX4ES1H3UA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*9kiXjr88eYPoGX4ES1H3UA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*9kiXjr88eYPoGX4ES1H3UA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*9kiXjr88eYPoGX4ES1H3UA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*9kiXjr88eYPoGX4ES1H3UA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" data-testid="og"/><img alt="" width="700" height="155" loading="lazy" src="https://miro.medium.com/v2/resize:fit:1400/1*9kiXjr88eYPoGX4ES1H3UA.png" data-hsprotectrole="presentation"/></picture></div>
</div>
</figure>
<h3 id="7315" data-selectable-paragraph="">2.5 Limit Pushdown</h3>
<p id="2f9b" data-selectable-paragraph="">In addition to predicates,<span>Â </span><code><strong>LIMIT</strong></code><strong><span>Â </span>clauses can also be pushed down through joins</strong>. When a query involves an<span>Â </span><strong>Outer Join</strong><span>Â </span>or a<span>Â </span><strong>Cross Join</strong>, the<span>Â </span><code>LIMIT</code><span>Â </span>can be pushed down to child operators whose output row count is guaranteed to be stable.</p>
<p id="d423" data-selectable-paragraph="">For example, in a<span>Â </span><strong>Left Outer Join</strong>, the output row count is at least the same as that of the left input. Therefore, the<span>Â </span><code>LIMIT</code><span>Â </span>can be pushed down to the left table (and symmetrically for a Right Outer Join).</p>
<pre><span id="7e76" data-selectable-paragraph=""><span>-- Before pushdown</span></span></pre>
<h3 id="5826" data-selectable-paragraph="">Special Cases: Cross Join and Full Outer Join</h3>
<p id="1677" data-selectable-paragraph="">A Cross Join produces a Cartesian product, with output cardinality equal to<code>rows(left) Ã— rows(right)</code>. A Full Outer Join produces at least<code>rows(left) + rows(right)</code>.</p>
<p id="28d7" data-selectable-paragraph="">For these join types, a<span>Â </span><code>LIMIT</code><span>Â </span>can be pushed down to both inputs independently:</p>
<pre><span id="5ff8" data-selectable-paragraph=""><span>-- Before pushdown</span></span></pre>

<h2 id="c12c" data-selectable-paragraph="">Join Reordering</h2>
<p id="5388" data-selectable-paragraph="">Join reordering is used to determine the execution order of multi-table joins. The optimizer aims to execute<span>Â </span><strong>high-selectivity joins as early as possible</strong>, thereby reducing the size of intermediate results and improving overall query performance.</p>
<p id="703f" data-selectable-paragraph="">In StarRocks, join reordering primarily operates on<span>Â </span><strong>continuous sequences of Inner Joins or Cross Joins</strong>. As illustrated below, StarRocks groups a sequence of consecutive Inner / Cross Joins into a<span>Â </span><strong>Multi Join Node</strong>. A Multi Join Node is the basic unit for join reordering: if a query plan contains multiple such nodes, StarRocks performs join reordering independently for each one.</p>
<figure>
<div data-hsprotectrole="button" tabindex="0">
<div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*K_WRXoOV0ifrH2K9FNSGWA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*K_WRXoOV0ifrH2K9FNSGWA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*K_WRXoOV0ifrH2K9FNSGWA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*K_WRXoOV0ifrH2K9FNSGWA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*K_WRXoOV0ifrH2K9FNSGWA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*K_WRXoOV0ifrH2K9FNSGWA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K_WRXoOV0ifrH2K9FNSGWA.png 1400w" type="image/webp" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><source srcset="https://miro.medium.com/v2/resize:fit:640/1*K_WRXoOV0ifrH2K9FNSGWA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*K_WRXoOV0ifrH2K9FNSGWA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*K_WRXoOV0ifrH2K9FNSGWA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*K_WRXoOV0ifrH2K9FNSGWA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*K_WRXoOV0ifrH2K9FNSGWA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*K_WRXoOV0ifrH2K9FNSGWA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*K_WRXoOV0ifrH2K9FNSGWA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" data-testid="og"/><img alt="" width="700" height="456" loading="lazy" src="https://miro.medium.com/v2/resize:fit:1400/1*K_WRXoOV0ifrH2K9FNSGWA.png" data-hsprotectrole="presentation"/></picture></div>
</div>
</figure>
<p id="dd01" data-selectable-paragraph="">There are many join reordering algorithms in the industry, often based on different optimization models, including:</p>
<ul>
<li id="5a7c" data-selectable-paragraph=""><strong>Heuristic-based approaches:<span>Â </span></strong>Rely on predefined rules, such as those used in MemSQL, where join order is determined around dimension tables and fact tables.</li>
<li id="abcd" data-selectable-paragraph=""><strong>Left-Deep Trees:<span>Â </span></strong>Restrict plans to left-deep trees, significantly reducing the search space, though the resulting plan is not always optimal.</li>
<li id="b1de" data-selectable-paragraph=""><strong>Bushy Trees:<span>Â </span></strong>Allow fully bushy join trees, resulting in a much larger search space that includes the optimal plan. Common reordering algorithms under this model include:</li>
<li id="c56b" data-selectable-paragraph="">Exhaustive search (based on commutativity and associativity)</li>
<li id="53a8" data-selectable-paragraph="">Greedy algorithms</li>
<li id="e917" data-selectable-paragraph="">Simulated annealing</li>
<li id="6955" data-selectable-paragraph="">Dynamic programming (e.g., DPsize, DPsub, DPccp)</li>
<li id="9f59" data-selectable-paragraph="">Genetic algorithms (e.g., Greenplum)</li>
<li id="af73" data-selectable-paragraph="">â€¦â€¦</li>
</ul>
<p id="0ea6" data-selectable-paragraph="">StarRocks currently implements several join reordering strategies, including Left-Deep, Exhaustive, Greedy, and DPsub. In the following sections, we focus on the implementation details of Exhaustive and Greedy join reordering in StarRocks.</p>

<div>
<h3 id="7911" data-selectable-paragraph="">3.1 Exhaustive</h3>
<p id="b4fb" data-selectable-paragraph="">The exhaustive join reordering algorithm is based on systematically enumerating all possible join orders. In practice, this is achieved through two fundamental rules, which together cover nearly the entire space of join permutations.</p>

<p id="5364" data-selectable-paragraph=""><strong>Rule 1: Join Commutativity</strong></p>
<p id="0b44" data-selectable-paragraph="">A join between two relations can be reordered by swapping its inputs:<code>A JOIN B â†’ B JOIN A</code></p>
<p id="dcaa" data-selectable-paragraph="">During this transformation, the<span>Â </span><strong>join type must be adjusted accordingly</strong>. For example, a<span>Â </span><code>LEFT OUTER JOIN</code><span>Â </span>becomes a<span>Â </span><code>RIGHT OUTER JOIN</code><span>Â </span>after swapping the join operands.</p>
<figure>
<div data-hsprotectrole="button" tabindex="0">
<div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*rU6_QCBYsrSAhN314XCR3A.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*rU6_QCBYsrSAhN314XCR3A.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*rU6_QCBYsrSAhN314XCR3A.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*rU6_QCBYsrSAhN314XCR3A.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*rU6_QCBYsrSAhN314XCR3A.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*rU6_QCBYsrSAhN314XCR3A.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rU6_QCBYsrSAhN314XCR3A.png 1400w" type="image/webp" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><source srcset="https://miro.medium.com/v2/resize:fit:640/1*rU6_QCBYsrSAhN314XCR3A.png 640w, https://miro.medium.com/v2/resize:fit:720/1*rU6_QCBYsrSAhN314XCR3A.png 720w, https://miro.medium.com/v2/resize:fit:750/1*rU6_QCBYsrSAhN314XCR3A.png 750w, https://miro.medium.com/v2/resize:fit:786/1*rU6_QCBYsrSAhN314XCR3A.png 786w, https://miro.medium.com/v2/resize:fit:828/1*rU6_QCBYsrSAhN314XCR3A.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*rU6_QCBYsrSAhN314XCR3A.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*rU6_QCBYsrSAhN314XCR3A.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" data-testid="og"/><img alt="" width="700" height="222" loading="lazy" src="https://miro.medium.com/v2/resize:fit:1400/1*rU6_QCBYsrSAhN314XCR3A.png" data-hsprotectrole="presentation"/></picture></div>
</div>
</figure>
<p id="6860" data-selectable-paragraph=""><strong>Rule 2: Join Associativity</strong></p>
<p id="e3a1" data-selectable-paragraph="">Join associativity allows the join order among three relations to be rearranged:<code>(A JOIN B) JOIN C â†’ A JOIN (B JOIN C)</code></p>
<p id="6230" data-selectable-paragraph="">In StarRocks, associativity is handled differently depending on the join type. Specifically, StarRocks distinguishes between:</p>
<ul>
<li id="7311" data-selectable-paragraph="">Associativity for Inner / Cross Joins</li>
<li id="620e" data-selectable-paragraph="">Associativity for Semi Joins</li>
</ul>
<figure>
<div data-hsprotectrole="button" tabindex="0">
<div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*Iap_aIYkg6S8nw-ABdf1Rg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*Iap_aIYkg6S8nw-ABdf1Rg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*Iap_aIYkg6S8nw-ABdf1Rg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*Iap_aIYkg6S8nw-ABdf1Rg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*Iap_aIYkg6S8nw-ABdf1Rg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*Iap_aIYkg6S8nw-ABdf1Rg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Iap_aIYkg6S8nw-ABdf1Rg.png 1400w" type="image/webp" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><source srcset="https://miro.medium.com/v2/resize:fit:640/1*Iap_aIYkg6S8nw-ABdf1Rg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*Iap_aIYkg6S8nw-ABdf1Rg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*Iap_aIYkg6S8nw-ABdf1Rg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*Iap_aIYkg6S8nw-ABdf1Rg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*Iap_aIYkg6S8nw-ABdf1Rg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*Iap_aIYkg6S8nw-ABdf1Rg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*Iap_aIYkg6S8nw-ABdf1Rg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" data-testid="og"/><img alt="" width="700" height="159" loading="lazy" src="https://miro.medium.com/v2/resize:fit:1400/1*Iap_aIYkg6S8nw-ABdf1Rg.png" data-hsprotectrole="presentation"/></picture></div>
</div>
</figure>
<h3 id="02b0" data-selectable-paragraph=""><strong>3.2 Greedy</strong></h3>
<p id="bbde" data-selectable-paragraph="">For its greedy join reordering strategy, StarRocks primarily draws inspiration from<span>Â </span><strong>multi-sequence greedy algorithms</strong>, with a small but important enhancement: at each iteration level, instead of keeping only a single best result, StarRocks<span>Â </span><strong>retains the top 10 candidate plans</strong><span>Â </span>(which may not be globally optimal). These candidates are then carried forward into the next iteration, ultimately producing<span>Â </span><strong>10 greedy-optimized plans</strong>.</p>
<p id="b209" data-selectable-paragraph="">Due to the inherent limitations of greedy algorithms, this approach does not guarantee a globally optimal plan. However, by preserving multiple high-quality candidates at each step, it significantly<span>Â </span><strong>increases the likelihood of finding a near-optimal or optimal solution</strong>.</p>
<figure>
<div data-hsprotectrole="button" tabindex="0"><p><span>Press enter or click to view image in full size</span></p><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*_qw7lgo34ASq3DLIq-g1wA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*_qw7lgo34ASq3DLIq-g1wA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*_qw7lgo34ASq3DLIq-g1wA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*_qw7lgo34ASq3DLIq-g1wA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*_qw7lgo34ASq3DLIq-g1wA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*_qw7lgo34ASq3DLIq-g1wA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_qw7lgo34ASq3DLIq-g1wA.png 1400w" type="image/webp" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><source srcset="https://miro.medium.com/v2/resize:fit:640/1*_qw7lgo34ASq3DLIq-g1wA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*_qw7lgo34ASq3DLIq-g1wA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*_qw7lgo34ASq3DLIq-g1wA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*_qw7lgo34ASq3DLIq-g1wA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*_qw7lgo34ASq3DLIq-g1wA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*_qw7lgo34ASq3DLIq-g1wA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*_qw7lgo34ASq3DLIq-g1wA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" data-testid="og"/><img alt="" width="700" height="304" loading="lazy" src="https://miro.medium.com/v2/resize:fit:1400/1*_qw7lgo34ASq3DLIq-g1wA.png" data-hsprotectrole="presentation"/></picture></div>
</div>
</figure>
<h3 id="aab2" data-selectable-paragraph="">3.3 Cost Model</h3>
<p id="c4ab" data-selectable-paragraph="">StarRocks uses these join reordering algorithms to generate<span>Â </span><em>N</em><span>Â </span>candidate plans. It then evaluates them with a cost model that estimates the cost of each join. The overall cost is computed as:<span>Â </span><strong>Join Cost = CPU Ã— (Row(L) + Row(R)) + Memory Ã— Row(R)</strong></p>
<p id="deaa" data-selectable-paragraph="">Here,<span>Â </span><code>Row(L)</code><span>Â </span>and<span>Â </span><code>Row(R)</code><span>Â </span>are the estimated output row counts of the joinâ€™s left and right children, respectively. This formula primarily accounts for the CPU cost of processing both inputs, as well as the memory cost of building the hash table on the right side of a hash join. The figure below shows how StarRocks estimates join output row counts in more detail.</p>
<figure>
<div data-hsprotectrole="button" tabindex="0">
<div><picture><img alt="" width="700" height="277" loading="lazy" src="https://miro.medium.com/v2/resize:fit:1400/1*fSf38pqoK1VlnYTK7ralcw.png" data-hsprotectrole="presentation"/></picture></div>
</div>
</figure>
<p id="77e5" data-selectable-paragraph="">Because different join reordering algorithms explore search spaces of varying sizes and have different time complexities, StarRocks benchmarks their execution time and complexity characteristics, as shown below.</p>
<figure>
<div data-hsprotectrole="button" tabindex="0">
<div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*5ZQ-adEIhZjMioJnw93J-w.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*5ZQ-adEIhZjMioJnw93J-w.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*5ZQ-adEIhZjMioJnw93J-w.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*5ZQ-adEIhZjMioJnw93J-w.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*5ZQ-adEIhZjMioJnw93J-w.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*5ZQ-adEIhZjMioJnw93J-w.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5ZQ-adEIhZjMioJnw93J-w.png 1400w" type="image/webp" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><source srcset="https://miro.medium.com/v2/resize:fit:640/1*5ZQ-adEIhZjMioJnw93J-w.png 640w, https://miro.medium.com/v2/resize:fit:720/1*5ZQ-adEIhZjMioJnw93J-w.png 720w, https://miro.medium.com/v2/resize:fit:750/1*5ZQ-adEIhZjMioJnw93J-w.png 750w, https://miro.medium.com/v2/resize:fit:786/1*5ZQ-adEIhZjMioJnw93J-w.png 786w, https://miro.medium.com/v2/resize:fit:828/1*5ZQ-adEIhZjMioJnw93J-w.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*5ZQ-adEIhZjMioJnw93J-w.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*5ZQ-adEIhZjMioJnw93J-w.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" data-testid="og"/><img alt="" width="700" height="289" loading="lazy" src="https://miro.medium.com/v2/resize:fit:1400/1*5ZQ-adEIhZjMioJnw93J-w.png" data-hsprotectrole="presentation"/></picture></div>
</div>
</figure>
<p id="42cb" data-selectable-paragraph="">Based on the observed execution costs, StarRocks applies practical limits to how different join reordering algorithms are used:</p>
<ul>
<li id="40df" data-selectable-paragraph=""><strong>For joins involving up to 4 tables</strong>, StarRocks uses the<span>Â </span><strong>exhaustive</strong><span>Â </span>algorithm.</li>
<li id="d9ef" data-selectable-paragraph=""><strong>For joins with 4â€“10 tables</strong>, StarRocks generates:</li>
<li id="95c3" data-selectable-paragraph="">1 plan using the<span>Â </span><strong>left-deep</strong><span>Â </span>strategy,</li>
<li id="d662" data-selectable-paragraph="">10 plans using the<span>Â </span><strong>greedy</strong><span>Â </span>algorithm,</li>
<li id="320d" data-selectable-paragraph="">1 plan using<span>Â </span><strong>dynamic programming</strong>.</li>
</ul>
<p id="91bc" data-selectable-paragraph="">On top of these, StarRocks further explores additional plans using<span>Â </span><strong>join commutativity</strong>.</p>
<ul>
<li id="9c7e" data-selectable-paragraph=""><strong>For joins with more than 10 tables</strong>, StarRocks relies only on the<span>Â </span><strong>greedy</strong><span>Â </span>and<span>Â </span><strong>left-deep</strong><span>Â </span>strategies, producing a total of<span>Â </span><strong>11 candidate plans</strong><span>Â </span>as the basis for reordering.</li>
<li id="6722" data-selectable-paragraph=""><strong>When statistics are unavailable</strong>, cost-based greedy and dynamic programming approaches become unreliable. In this case, StarRocks falls back to using a single<span>Â </span><strong>left-deep</strong><span>Â </span>plan as the basis for join reordering.</li>
</ul>
<figure>
<div data-hsprotectrole="button" tabindex="0">
<div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*PxqZSIXWATMKKwHaTCFnZQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*PxqZSIXWATMKKwHaTCFnZQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*PxqZSIXWATMKKwHaTCFnZQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*PxqZSIXWATMKKwHaTCFnZQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*PxqZSIXWATMKKwHaTCFnZQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*PxqZSIXWATMKKwHaTCFnZQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PxqZSIXWATMKKwHaTCFnZQ.png 1400w" type="image/webp" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><source srcset="https://miro.medium.com/v2/resize:fit:640/1*PxqZSIXWATMKKwHaTCFnZQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*PxqZSIXWATMKKwHaTCFnZQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*PxqZSIXWATMKKwHaTCFnZQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*PxqZSIXWATMKKwHaTCFnZQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*PxqZSIXWATMKKwHaTCFnZQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*PxqZSIXWATMKKwHaTCFnZQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*PxqZSIXWATMKKwHaTCFnZQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" data-testid="og"/><img alt="" width="700" height="377" loading="lazy" src="https://miro.medium.com/v2/resize:fit:1400/1*PxqZSIXWATMKKwHaTCFnZQ.png" data-hsprotectrole="presentation"/></picture></div>
</div>
</figure>
<h2 id="fbd2" data-selectable-paragraph="">Distributed Join Planning</h2>
<p id="d7c7" data-selectable-paragraph="">After covering the logical optimizations involved in join queries, we now turn to join execution in a<span>Â </span><strong>distributed environment</strong>, focusing on how StarRocks optimizes distributed join planning as a distributed database.</p>
<h3 id="a82e" data-selectable-paragraph="">4.1 MPP Parallel Execution</h3>
<p id="1296" data-selectable-paragraph="">StarRocks is built on an<span>Â </span><strong>MPP (Massively Parallel Processing)</strong><span>Â </span>execution framework. The overall architecture is illustrated below. Using a simple join query as an example, the execution of<span>Â </span><code>A JOIN B</code><span>Â </span>in StarRocks typically proceeds as follows:</p>
<ul>
<li id="87db" data-selectable-paragraph="">Data from tables<span>Â </span><strong>A</strong><span>Â </span>and<span>Â </span><strong>B</strong><span>Â </span>is read in parallel from different nodes, based on their respective data distributions.</li>
<li id="cfd1" data-selectable-paragraph="">According to the join predicate, data from<span>Â </span><strong>A</strong><span>Â </span>and<span>Â </span><strong>B</strong><span>Â </span>is<span>Â </span><strong>reshuffled</strong><span>Â </span>so that matching rows are sent to the same set of nodes.</li>
<li id="010d" data-selectable-paragraph="">The join is executed locally on each node, and the partial results are produced.</li>
</ul>
<p id="57f7" data-selectable-paragraph="">As shown, query execution usually involves multiple sets of machines: the nodes reading table A, the nodes reading table B, and the nodes performing the join are not necessarily the same. As a result, execution inevitably involves network transfers and data exchanges.</p>
<p id="40c4" data-selectable-paragraph="">These network operations introduce significant overhead. Therefore, a key goal in optimizing distributed join execution in StarRocks is to minimize network cost, while more intelligently partitioning and distributing the query plan to fully leverage the benefits of parallel execution.</p>
<figure>
<div data-hsprotectrole="button" tabindex="0">
<div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*A9XGLePPai6bWcMYtq_m4g.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*A9XGLePPai6bWcMYtq_m4g.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*A9XGLePPai6bWcMYtq_m4g.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*A9XGLePPai6bWcMYtq_m4g.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*A9XGLePPai6bWcMYtq_m4g.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*A9XGLePPai6bWcMYtq_m4g.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A9XGLePPai6bWcMYtq_m4g.png 1400w" type="image/webp" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><source srcset="https://miro.medium.com/v2/resize:fit:640/1*A9XGLePPai6bWcMYtq_m4g.png 640w, https://miro.medium.com/v2/resize:fit:720/1*A9XGLePPai6bWcMYtq_m4g.png 720w, https://miro.medium.com/v2/resize:fit:750/1*A9XGLePPai6bWcMYtq_m4g.png 750w, https://miro.medium.com/v2/resize:fit:786/1*A9XGLePPai6bWcMYtq_m4g.png 786w, https://miro.medium.com/v2/resize:fit:828/1*A9XGLePPai6bWcMYtq_m4g.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*A9XGLePPai6bWcMYtq_m4g.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*A9XGLePPai6bWcMYtq_m4g.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" data-testid="og"/><img alt="" width="700" height="407" loading="lazy" src="https://miro.medium.com/v2/resize:fit:1400/1*A9XGLePPai6bWcMYtq_m4g.png" data-hsprotectrole="presentation"/></picture></div>
</div>
</figure>

<h3 id="a6da" data-selectable-paragraph="">4.2 Distributed Join Optimization</h3>
<p id="ff7e" data-selectable-paragraph="">We begin by introducing the distributed execution plans that StarRocks can generate. Using a simple join query as an example:</p>
<pre><span id="2e29" data-selectable-paragraph=""><span>Select</span> * <span>From</span> A <span>Join</span> B <span>on</span> A.a = B.b</span></pre>
<figure>
<div data-hsprotectrole="button" tabindex="0"><picture><img alt="" width="700" height="365" loading="lazy" src="https://miro.medium.com/v2/resize:fit:1400/1*3valLMYDVqLwE78VYmKT5w.png" data-hsprotectrole="presentation"/></picture></div>
</figure>
<p id="1b82" data-selectable-paragraph="">In practice, StarRocks can generate five basic types of distributed join plans:</p>
<ul>
<li id="6d48" data-selectable-paragraph=""><strong>Shuffle Join</strong><span>Â </span>Data from both tables A and B is shuffled based on the join key so that matching rows are sent to the same set of nodes, where the join is then executed.</li>
<li id="d129" data-selectable-paragraph=""><strong>Broadcast Join</strong><span>Â </span>The entire table B is broadcast to all nodes that hold table A, and the join is performed locally on those nodes. Compared to a shuffle join, this avoids shuffling table A, but requires broadcasting all of table B. This strategy is suitable when B is a small table.</li>
<li id="bc3d" data-selectable-paragraph=""><strong>Bucket Shuffle Join</strong><span>Â </span>An optimization over broadcast join. Instead of broadcasting table B to all nodes, B is shuffled according to Aâ€™s data distribution and sent only to the corresponding nodes that hold matching buckets of A. Globally, the shuffled data from B exists only once, significantly reducing network traffic compared to broadcast join. This strategy has an important constraint: the join key must be consistent with Aâ€™s distribution key.</li>
<li id="785b" data-selectable-paragraph=""><strong>Colocate Join</strong><span>Â </span>When tables A and B are created within the same colocate group, their data distributions are guaranteed to be identical. If the join key matches the distribution key, StarRocks can execute the join directly on the local nodes holding A and B, without any data shuffle.</li>
<li id="0b5c" data-selectable-paragraph=""><strong>Replicate Join</strong><span>Â </span>An experimental feature in StarRocks. If every node holding table A also contains a full copy of table B, the join can be executed locally. This approach has very strict requirements â€” essentially requiring the replication factor of table B to match the total number of nodes in the cluster â€” making it impractical in most real-world scenarios.</li>
</ul>

<h3 id="40cf" data-selectable-paragraph="">4.3 Exploring Distributed Join Plans</h3>
<p id="a7f0" data-selectable-paragraph="">StarRocks derives distributed join plans through<span>Â </span><strong>distribution property inference</strong>. Using a shuffle join as an example:<code>SELECT * FROM A JOIN B ON A.a = B.b</code>, the join operator propagates shuffle requirements top-down to tables A and B. If a scan node cannot satisfy the required distribution, StarRocks inserts an Enforce operator to introduce a shuffle. In the final execution plan, this shuffle is translated into an Exchange node responsible for network data transfer.</p>
<p id="eb09" data-selectable-paragraph="">Other distributed join strategies are derived in the same way: the join operator requests different distribution properties from its input operators, and the optimizer generates the corresponding distributed execution plans accordingly.</p>

<figure>
<div data-hsprotectrole="button" tabindex="0">
<div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*1Q1Okb8pSE1ORQ86UGsXVA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*1Q1Okb8pSE1ORQ86UGsXVA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*1Q1Okb8pSE1ORQ86UGsXVA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*1Q1Okb8pSE1ORQ86UGsXVA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*1Q1Okb8pSE1ORQ86UGsXVA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*1Q1Okb8pSE1ORQ86UGsXVA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1Q1Okb8pSE1ORQ86UGsXVA.png 1400w" type="image/webp" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><source srcset="https://miro.medium.com/v2/resize:fit:640/1*1Q1Okb8pSE1ORQ86UGsXVA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*1Q1Okb8pSE1ORQ86UGsXVA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*1Q1Okb8pSE1ORQ86UGsXVA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*1Q1Okb8pSE1ORQ86UGsXVA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*1Q1Okb8pSE1ORQ86UGsXVA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*1Q1Okb8pSE1ORQ86UGsXVA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*1Q1Okb8pSE1ORQ86UGsXVA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" data-testid="og"/><img alt="" width="700" height="322" loading="lazy" src="https://miro.medium.com/v2/resize:fit:1400/1*1Q1Okb8pSE1ORQ86UGsXVA.png" data-hsprotectrole="presentation"/></picture></div>
</div>
</figure>

<h3 id="dfd1" data-selectable-paragraph="">4.4 Complex Distributed Joins</h3>
<p id="9704" data-selectable-paragraph="">In real-world workloads, user queries are far more complex than a simple<span>Â </span><code>A JOIN B</code>. They often involve three or more tables. For such queries, StarRocks generates a richer set of distributed execution plans, all derived from the same fundamental join strategies described earlier.</p>
<p id="fe9a" data-selectable-paragraph="">For example:</p>
<pre><span id="171a" data-selectable-paragraph=""><span>Select</span> * <span>From</span> A <span>Join</span> B <span>on</span> A.a = B.b <span>Join</span> C <span>on</span> A.a = C.c</span></pre>
<p id="f3d6" data-selectable-paragraph="">Using combinations of Shuffle Join and Broadcast Join, StarRocks can derive multiple distributed plans, as illustrated below.</p>
<figure>

</figure>
<p id="684a" data-selectable-paragraph="">If Colocate Join and Bucket Shuffle Join are also considered, even more execution plans become possible:</p>
<figure>

</figure>
<p id="55fb" data-selectable-paragraph="">Despite their increased complexity, the underlying derivation logic remains the same. Distribution properties are propagated downward through the plan tree, allowing the optimizer to infer different combinations of distributed join strategies.</p>

<h3 id="28b7" data-selectable-paragraph="">4.5 Global Runtime Filters</h3>
<p id="1517" data-selectable-paragraph="">Beyond exploring distributed execution plans, StarRocks further optimizes join performance by leveraging the execution characteristics of join operators to build<span>Â </span><strong>Global Runtime Filters</strong>.</p>
<p id="60c8" data-selectable-paragraph="">The execution flow of a Hash Join in StarRocks is as follows:</p>
<ol>
<li id="010c" data-selectable-paragraph="">Retrieve the complete data set from the right table.</li>
<li id="2aa0" data-selectable-paragraph="">Build a hash table from the right table.</li>
<li id="2dc7" data-selectable-paragraph="">Fetch data from the left table.</li>
<li id="dcc1" data-selectable-paragraph="">Probe the hash table to evaluate join conditions.</li>
<li id="8f88" data-selectable-paragraph="">Produce the join results.</li>
</ol>
<p id="d09b" data-selectable-paragraph="">Global Runtime Filters are applied between Step 2 and Step 3. After constructing the hash table on the right side, StarRocks derives runtime filter predicates from the observed data and pushes these filters down to the scan nodes of the left table<span>Â </span><em>before</em><span>Â </span>left-side data is read. This allows the left table to filter out irrelevant rows early, significantly reducing join input size.</p>
<p id="e8c5" data-selectable-paragraph="">At present, Global Runtime Filters in StarRocks support the following filtering techniques: Min/Max filters, IN predicates, and Bloom filters. The diagram below illustrates how these filters work in practice.</p>
<figure>

</figure>
<h2 id="fb57" data-selectable-paragraph="">Summary</h2>
<p id="6721" data-selectable-paragraph="">This article has explored StarRocksâ€™ practical experience and ongoing work in join query optimization. All of the techniques discussed are closely aligned with the core optimization principles outlined throughout the article. When optimizing SQL queries in practice, users can also apply the following guidelines together with the features provided by StarRocks to achieve better performance:</p>
<ul>
<li id="b5a5" data-selectable-paragraph=""><strong>Join operators vary significantly in performance.</strong><span>Â </span>Prefer high-performance join types whenever possible and avoid expensive ones. Based on typical join output sizes, the rough performance ranking is:<span>Â </span><em>Semi Join / Anti Join &gt; Inner Join &gt; Outer Join &gt; Full Outer Join &gt; Cross Join</em>.</li>
<li id="34e9" data-selectable-paragraph=""><strong>For hash joins, building the hash table on a smaller input is far more efficient</strong><span>Â </span>than building it on a large table.</li>
<li id="db23" data-selectable-paragraph=""><strong>In multi-table joins, execute highly selective joins first</strong><span>Â </span>to substantially reduce the cost of subsequent joins.</li>
<li id="d8e0" data-selectable-paragraph=""><strong>Minimize the amount of data participating in joins</strong><span>Â </span>through early filtering and pruning.</li>
<li id="1224" data-selectable-paragraph=""><strong>Reduce network overhead in distributed joins</strong><span>Â </span>as much as possible to fully benefit from parallel execution.</li>
</ul>

<h2 id="af4c" data-selectable-paragraph="">Case Studies</h2>
<h3 id="db00" data-selectable-paragraph="">Demandbase</h3>
<p id="2bae" data-selectable-paragraph="">By leveraging StarRocksâ€™ On-the-Fly JOIN capabilities, Demandbase successfully replaced its existing ClickHouse clusters, optimizing performance while significantly reducing costs across multiple areas.</p>
<p id="22d8" data-selectable-paragraph="">Read the case study:<span>Â </span><a rel="noopener" href="https://medium.com/starrocks-engineering/demandbase-ditches-denormalization-by-switching-off-clickhouse-44195d795a83" data-discover="true">Demandbase Ditches Denormalization By Switching off ClickHouse</a></p>
<h3 id="52ba" data-selectable-paragraph="">Naver</h3>
<p id="44ab" data-selectable-paragraph="">NAVER modernized its data infrastructure with StarRocks by enabling scalable, real-time analytics over multi-table joins without denormalization. The case study highlights the critical role of efficient, on-the-fly join execution in supporting production-scale analytical workloads.</p>
<p id="74ef" data-selectable-paragraph="">Read the case study:<span>Â </span><a href="https://celerdata.com/blog/how-join-changed-how-we-approach-data-infra-at-naver" rel="noopener ugc nofollow" target="_blank">How JOIN Changed How We Approach Data Infra At NAVER</a></p>
<h3 id="3a41" data-selectable-paragraph="">Shopee</h3>
<p id="b485" data-selectable-paragraph="">Data Go is a no-code query platform where Shopee business users build queries from multiple tables. Presto struggled with complex join performance and high resource usage. When Shopee switched to StarRocks for multi-table joins, they observed<span>Â </span><em>3Ã—â€“10Ã— performance improvements</em><span>Â </span>and a ~60% reduction in CPU usage compared with Presto on external Hive data.</p>
<p id="eb0a" data-selectable-paragraph="">Read the case study:<span>Â </span><a href="https://www.starrocks.io/blog/how-shopee-3xed-their-query-performance-with-starrocks" rel="noopener ugc nofollow" target="_blank">How Shopee 3xed Their Query Performance With StarRocks</a></p>
</div>

<div>
<div>
<p id="c9ac" data-selectable-paragraph="">Want to dive deeper into technical details or ask questions? Join StarRocks<span>Â </span><a href="https://starrocks.io/redirecting-to-slack" rel="noopener ugc nofollow" target="_blank">Slack</a><span>Â </span>to continue the conversation!</p>
</div>
</div></span>
      </p>
      
    </div>
  </div>
</div></div>
  </body>
</html>
