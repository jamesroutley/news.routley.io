<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://notes.alinpanaitiu.com/Weird%20monitor%20bugs">Original</a>
    <h1>Weird monitor bugs people sent me in the last 5 years</h1>
    
    <div id="readability-page-1" class="page"><article>
<p>I develop üåï <strong><a href="https://lunar.fyi/">Lunar</a></strong>, a macOS app for getting <strong>intelligent adaptive brightness</strong> on <strong>external monitors</strong> and controlling every aspect of your monitor using <a href="https://en.m.wikipedia.org/wiki/Display_Data_Channel">DDC</a> and other obscure protocols.</p>
<p>I get tons of email about Lunar, especially after it became my full time ‚Äújob‚Äù in 2021. A lot of those emails complain about Lunar bugs, but sometimes, after a good multi day chase, I conclude it‚Äôs actually a monitor bug and the user has to kind of.. deal with it.</p>
<p><em>‚ÄùBuy another monitor‚Äù</em> is never a good response, so I try to help and provide a workaround whenever I can.</p>
<p>But anyway, here‚Äôs a small collection of those bugs.</p>
<h2 id="dual-monitors-swapped-positions"><a href="#dual-monitors-swapped-positions">#</a> Dual monitors swapped positions</h2>
<p>You know how people get two identical monitors and place them side by side for a neat ultrawide-like look.</p>
<p><img src="https://notes.alinpanaitiu.com/Weird%20monitor%20bugs_attachments/97746684-1D71-40E2-A97B-1ACD631A99DD.png" alt="image"/></p>
<p>Well a lot of those people experience a very annoying behavior:
<strong>After standby or restart, the monitors get swapped by the OS, so moving the cursor to the left monitor will actually appear on the right monitor, and vice-versa.</strong></p>
<p>If the monitors also had some of the settings different, like resolution or color profile, those also get swapped.</p>
<p>This doesn‚Äôt happen for Apple vendored monitors like the Pro Display XDR in the above image, and you‚Äôll see why in a minute.</p>
<h4 id="how-monitor-settings-are-stored"><a href="#how-monitor-settings-are-stored">#</a> How monitor settings are stored</h4>
<p>Whenever you arrange monitors, the system has to store those coordinates persistently and restore them when the monitor reconnects.
<em>In standby, the monitor is actually disconnected and disappears from the I/O Registry, so on system wake, it reconnects and the OS has to rearrange based on the stored settings.</em></p>
<p>To store something persistently, you need to have a way of identifying that monitor precisely. So the OS computes an <code>UUID</code> from whatever it can find inside the data provided by the monitor.</p>
<p>That data is called the <a href="https://en.m.wikipedia.org/wiki/Extended_Display_Identification_Data">EDID structure</a> and it contains things like vendor ID, week/year of manufacture, <strong>serial number</strong> etc.</p>
<h4 id="why-does-this-happen"><a href="#why-does-this-happen">#</a> Why does this happen?</h4>
<p>The problem comes from vendors who flash the same exact firmware with the same EDID to multiple monitors in the same batch.</p>
<p>Serial number is emphasized above especially because by definition it should be a unique number that increments with each monitor.
Well it doesn‚Äôt. And it has nothing to do with the serial number you see on the back of the monitor or the box or wherever it‚Äôs placed.</p>
<p>So if you have the bad luck to buy two identical monitors, from the same batch, with the same EDID, then the OS will compute the same UUID for both.</p>
<p>That means that on reconnection, the monitors will look identical from the OS side, so the stored settings will have to be assigned randomly for each monitor. That will sometimes, not always, but deterministically when it&#39;s most annoying, cause the swapping bug.</p>
<p>And there‚Äôs nothing you can do to fix it.</p>
<h4 id="workaround"><a href="#workaround">#</a> Workaround</h4>
<p>I wrote a super simple CLI for swapping monitors here:</p>
<p><a href="https://github.com/alin23/mac-utils/blob/main/SwapMonitors.swift">mac-utils/SwapMonitors.swift ¬∑ GitHub</a></p>
<h5 id="installation"><a href="#installation">#</a> Installation</h5>
<ul>
<li>You can either install it from the Terminal:</li>
</ul>
<pre tabindex="0"><code><span><span><span>export</span> <span>BINDIR</span><span>=</span>/usr/local/bin
</span></span><span><span><span>export</span> <span>BINURL</span><span>=</span><span>&#34;https://github.com/alin23/mac-utils/raw/main/bin/SwapMonitors&#34;</span>
</span></span><span><span>
</span></span><span><span><span>mkdir</span> <span>-p</span> <span>&#34;</span><span>$BIN</span><span>&#34;</span> <span>&amp;&amp;</span> <span>\
</span></span></span><span><span><span></span>  <span>curl</span> <span>&#34;</span><span>$BINURL</span><span>&#34;</span> <span>&gt;</span> <span>&#34;</span><span>$BIN</span><span>/SwapMonitors&#34;</span> <span>&amp;&amp;</span> <span>\
</span></span></span><span><span><span></span>  <span>chmod</span> +x <span>&#34;</span><span>$BIN</span><span>/SwapMonitors&#34;</span>
</span></span></code></pre><ul>
<li>Or use a Shortcut that does that automatically</li>
</ul>
<p><a href="https://www.icloud.com/shortcuts/3c9f6a71589a4813904973b3ef493c1f"><img src="https://files.alinpanaitiu.com/add-to-shortcuts.svg" alt="img"/></a></p>
<p>The shortcut also provides a way to bind a hotkey, or run it from the menu bar.</p>
<p><img src="https://notes.alinpanaitiu.com/Weird%20monitor%20bugs_attachments/Shortcuts-000364-Saturday-23-33.png" alt="image"/></p>
<h5 id="usage"><a href="#usage">#</a> Usage</h5>
<ul>
<li>Just run it and let the algorithm find the monitors that should be swapped: <em>(either press the hotkey you assigned to the Shortcut, or run it from the command line)</em></li>
</ul>
<pre tabindex="0"><code><span><span>‚åÅ ‚ùØ SwapMonitors
</span></span><span><span>
</span></span><span><span><span>Swapping</span> Dell U2719D <span>(</span><span>2</span><span>)</span> <span>[</span>ID: <span>17</span><span>]</span> with Dell U2719D <span>(</span><span>1</span><span>)</span> <span>[</span>ID: <span>18</span><span>]</span>
</span></span><span><span>
</span></span><span><span><span>External</span> Display <span>1</span>: <span>x</span><span>=</span><span>4872</span>.<span>0</span> <span>y</span><span>=</span><span>0</span>.<span>0</span> <span>width</span><span>=</span><span>2560</span>.<span>0</span> <span>height</span><span>=</span><span>1440</span>.<span>0</span>
</span></span><span><span>	Moving to: <span>x</span><span>=</span><span>1800</span>.<span>0</span> <span>y</span><span>=</span><span>0</span>.<span>0</span>
</span></span><span><span>
</span></span><span><span><span>External</span> Display <span>2</span>: <span>x</span><span>=</span><span>1800</span>.<span>0</span> <span>y</span><span>=</span><span>0</span>.<span>0</span> <span>width</span><span>=</span><span>3072</span>.<span>0</span> <span>height</span><span>=</span><span>1620</span>.<span>0</span>
</span></span><span><span>	Moving to: <span>x</span><span>=</span><span>4872</span>.<span>0</span> <span>y</span><span>=</span><span>0</span>.<span>0</span>
</span></span></code></pre><ul>
<li>Or pass the IDs of the monitors to swap as arguments</li>
</ul>
<pre tabindex="0"><code><span><span>‚åÅ ‚ùØ SwapMonitors print-ids                                                                                                                       
</span></span><span><span><span>IDs</span> of monitors in order of appearance from left to right: <span>[</span><span>17</span>, <span>19</span>, <span>18</span><span>]</span>
</span></span><span><span><span>Names</span> of monitors in order of appearance from left to right: <span>[</span><span>&#34;Dell U2719D (2)&#34;</span>, <span>&#34;LG Ultrafine&#34;</span>, <span>&#34;Dell U2719D (1)&#34;</span><span>]</span>
</span></span><span><span>
</span></span><span><span>‚åÅ ‚ùØ SwapMonitors <span>17</span> <span>18</span>
</span></span><span><span>
</span></span><span><span><span>Swapping</span> Dell U2719D <span>(</span><span>2</span><span>)</span> <span>[</span>ID: <span>17</span><span>]</span> with Dell U2719D <span>(</span><span>1</span><span>)</span> <span>[</span>ID: <span>18</span><span>]</span>
</span></span><span><span>
</span></span><span><span><span>External</span> Display <span>1</span>: <span>x</span><span>=</span><span>1800</span>.<span>0</span> <span>y</span><span>=</span><span>0</span>.<span>0</span> <span>width</span><span>=</span><span>2560</span>.<span>0</span> <span>height</span><span>=</span><span>1440</span>.<span>0</span>
</span></span><span><span>	Moving to: <span>x</span><span>=</span><span>4360</span>.<span>0</span> <span>y</span><span>=</span><span>0</span>.<span>0</span>
</span></span><span><span>
</span></span><span><span><span>External</span> Display <span>2</span>: <span>x</span><span>=</span><span>4360</span>.<span>0</span> <span>y</span><span>=</span><span>0</span>.<span>0</span> <span>width</span><span>=</span><span>3072</span>.<span>0</span> <span>height</span><span>=</span><span>1620</span>.<span>0</span>
</span></span><span><span>	Moving to: <span>x</span><span>=</span><span>1800</span>.<span>0</span> <span>y</span><span>=</span><span>0</span>.<span>0</span>
</span></span></code></pre><h2 id="monochrome-hdr"><a href="#monochrome-hdr">#</a> Monochrome HDR</h2>
<p>While developing external monitor support for <strong><a href="https://lunar.fyi/#xdr">XDR Brightness</a></strong>, I needed a way to test it.</p>
<p>And since I don&#39;t have a <a href="https://displayhdr.org/#tab-600">600nits+ monitor</a>, I reached out to my friend Istv√°n T√≥th, the developer of <a href="https://betterdisplay.pro/">BetterDisplay</a> <em>(and also a previous Lunar user who became a MonitorControl maintainer by porting <a href="https://alinpanaitiu.com/blog/journey-to-ddc-on-m1-macs/">Lunar&#39;s M1 DDC code</a> to MonitorControl, long story)</em>.</p>
<p>When Istv√°n turned on XDR Brightness on his Lenovo Creator Extreme, it was suddenly stripped of all color and everything became grayscale on it.</p>
<p>Other Lunar users also mentioned this issue on other specific monitor models, even before XDR Brightness was a thing. I thought I had an idea then on what could cause this, but this new data point dismantled my previous theory.</p>
<p>Some causes I can think of:</p>
<ul>
<li>The macOS ICC profile for that monitor computes a <code>0</code> chroma value in specific Gamma table configurations</li>
<li>The monitor internal color profile/preset is reverted to some default value on receiving a DDC command that&#39;s not handled correctly</li>
<li>The grayscale filter of macOS is enabled somehow? ¬Ø\_(„ÉÑ)_/¬Ø</li>
</ul>
<p>In the end, I have no idea what causes the problem, I simply disabled XDR for external monitors by default in Lunar, and made it opt-in.</p>
<h2 id="blacking-out"><a href="#blacking-out">#</a> Blacking out</h2>
<p>This is the bug that causes the most angry and panicky emails I get.</p>
<p>On receiving specific DDC commands, some monitors simply <strong>go black and stop responding to any user input</strong>.</p>
<p>Reconnecting the video cable doesn&#39;t do anything, the power button doesn&#39;t work, from the user perspective it looks like Lunar just bricked their monitors.</p>
<p>The fix is simple: <strong>unplug the power cable, and plug it back again</strong></p>
<h4 id="whats-happening"><a href="#whats-happening">#</a> What&#39;s happening?</h4>
<p>I have an idea.</p>
<h6 id="firmware-bugs"><a href="#firmware-bugs">#</a> Firmware bugs</h6>
<p>Since Lunar doesn&#39;t do anything unusual <em>(it just sends standard DDC commands for setting brightness and contrast)</em>, I assume the bug is in the DDC handler code inside the monitor controller firmware.</p>
<p>It&#39;s possible that either a specific series of bytes, or a burst of DDC messages, causes the firmware to crash, and maybe even enter in a tight loop since it doesn&#39;t seem to restart itself.</p>
<p>I keep an extensive FAQ with possible monitor features and settings that can break DDC and even cause this bug in specific setups: <a href="https://lunar.fyi/faq#brightness-not-changing">FAQ - The brightness or volume doesn&#39;t change</a></p>
<h6 id="long-cables"><a href="#long-cables">#</a> Long cables</h6>
<p>On rare occasions, the issue was actually being caused by a too long Thunderbolt cable.</p>
<p>Most people don&#39;t know that there&#39;s no such thing as a 6 meter Thunderbolt cable, not without built-in signal amplifiers or <a href="https://www.corning.com/optical-cables-by-corning/worldwide/en/products/thunderbolt-optical-cables.html">fiber optics</a> and expensive converter chips.</p>
<p>So, expectedly, when using the data channel for DDC for longer than a few milliseconds, the video signal will drop completely, or revert to a much lower resolution and refresh rate.</p>
<h6 id="custom-color-profiles"><a href="#custom-color-profiles">#</a> Custom color profiles</h6>
<p>In other cases, the issue was a custom color profile, and the problem was actually caused by a macOS bug.</p>
<p>One Lunar user was an astronomer, and had a self-made observatory at home. He created a color profile that pushed most colors towards dark red, to keep his natural night vision when working.</p>
<p>But when Lunar adjusted the Gamma tables, the macOS color formula was sometimes reaching a point where every color computed to <code>rgb(0, 0, 0)</code>.</p>
<p>The Lunar adjustments were completely normal and well within the documented range, and I found no way to predict on what values would the system reach that point.</p>
<p>I had to add a periodic timer that checks if the macOS color curve gets to 0, and reset all color adjustments, then forcefully disable that functionality for the user and let him know about it.</p>
<p><img src="https://files.lunar.fyi/screen-blanking-dialog.png" alt="screen blanking dialog"/></p>
<h2 id="switching-input-just-blinks-the-screen"><a href="#switching-input-just-blinks-the-screen">#</a> Switching input just blinks the screen</h2>
<p>The DDC protocol (or more exactly the <a href="https://files.lunar.fyi/mccs.pdf">Monitor Control Command Set (MCCS)</a> specification), defines a command for switching monitor inputs.</p>
<p>So you might have:</p>
<ul>
<li>a MacBook on the Thunderbolt input of your monitor</li>
<li>a PlayStation on the HDMI1 input</li>
<li>a Raspberry Pi on HDMI2</li>
</ul>
<p>And to switch between those, you can fiddle with the monitor buttons, or you can do that with handy keyboard shortcuts through DDC.</p>
<p>Because KVMs are expensive, I implemented that functionality in Lunar for people that don&#39;t really need the &#34;keyboard switching&#34; part of a KVM, but mostly the &#34;video switching&#34; part.</p>
<p><img src="https://lunar.fyi/static/img/input-key/1280_input-key.webp" alt="switch inputs Lunar"/></p>
<h5 id="so-wheres-the-bug"><a href="#so-wheres-the-bug">#</a> So, where&#39;s the bug?</h5>
<p>The thing is, some monitors lie about this functionality.</p>
<p>Even if the monitor reports that the VCP code <code>0x60</code> for Input Select is implemented, when any input value is sent, the monitor just blinks. By that I mean it goes black for a second, then returns to the previous image.</p>
<p>There&#39;s no software fix for these monitors.</p>
<h2 id="mute-command-doesnt-do-anything"><a href="#mute-command-doesnt-do-anything">#</a> Mute command doesn&#39;t do anything</h2>
<p>Kind of in the same vein as with the input switching bug above, the DDC Mute command just doesn&#39;t do anything on some monitors.</p>
<p>The odd thing is that the monitors do have a mute switch in their OSD, but it&#39;s not controllable by the VCP code <code>0x8D</code> for Audio Mute.</p>
<p>Instead, on some monitors, it seems that setting the volume to some non-standard value like <code>255</code> (or <code>-1</code> if we flip from <code>unsigned</code> to <code>signed</code> integers), might affect the volume setting. On most monitors though, it doesn&#39;t do anything at all.</p>
<p>That&#39;s another workaround that got its own section in Lunar&#39;s settings because of how often it&#39;s encountered.</p>
<p><img src="https://files.lunar.fyi/mute-workarounds.png" alt="mute workarounds Lunar"/></p>
</article></div>
  </body>
</html>
