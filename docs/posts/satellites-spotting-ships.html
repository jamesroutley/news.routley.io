<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tech.marksblogg.com/yolo-umbra-sar-satellites-ship-detection.html">Original</a>
    <h1>Satellites Spotting Ships</h1>
    
    <div id="readability-page-1" class="page"><div id="article_text">
            <p>Umbra Space is a 9-year-old manufacturer and operator of a Synthetic Aperture Radar (SAR) satellite fleet. These satellites can see through clouds, smoke and rain and can capture images day or night at resolutions as fine as 16cm. SpaceX launched Umbra&#39;s first satellite in 2021 and has a total of eight in orbit at the moment. I covered their fleet and open data programme in my <a href="https://tech.marksblogg.com/umbra-open-data-free-satellite-imagery.html">Umbra&#39;s Open Satellite Feed</a> post I published in April.</p>
<p>A few weeks ago, Umbra released almost 1,000 satellite images displaying ships around the world. The images have been made available in a number of SAR image formats and total almost 7.5 TB in size.</p>
<p>Below I&#39;ve annotated one of the images from this dataset. I&#39;ve used QGIS to tint the satellite imagery red, highlighted a few ships in green and used CARTO&#39;s dark basemap for geographical reference.</p>
<p><a href="https://tech.marksblogg.com/theme/images/umbra-yolo/china.png"><img alt="Ship Detection" src="https://tech.marksblogg.com/theme/images/umbra-yolo/china.png"/></a></p><p>These images were taken across a diverse set of locations including many geopolitical hotspots.</p>

<div><pre><span></span><span>from</span>   <span>glob</span>           <span>import</span> <span>glob</span>
<span>import</span> <span>json</span>

<span>from</span> <span>shapely.geometry</span> <span>import</span> <span>shape</span>


<span>pattern</span> <span>=</span> <span>&#39;/home/mark/ship_detection_testdata/*/*/*.json&#39;</span>

<span>with</span> <span>open</span><span>(</span><span>&#39;umbra_ships.csv&#39;</span><span>,</span> <span>&#39;w&#39;</span><span>)</span> <span>as</span> <span>f</span><span>:</span>
    <span>f</span><span>.</span><span>write</span><span>(</span><span>&#39;geom</span><span>\n</span><span>&#39;</span><span>)</span>

    <span>for</span> <span>filename</span> <span>in</span> <span>glob</span><span>(</span><span>pattern</span><span>):</span>
        <span>wkt_</span> <span>=</span> <span>shape</span><span>(</span><span>json</span><span>.</span><span>loads</span><span>(</span><span>open</span><span>(</span><span>filename</span><span>)</span><span>.</span><span>read</span><span>())</span>
                    <span>[</span><span>&#39;collects&#39;</span><span>]</span>
                    <span>[</span><span>0</span><span>]</span>
                    <span>[</span><span>&#39;footprintPolygonLla&#39;</span><span>])</span><span>.</span><span>centroid</span><span>.</span><span>wkt</span>
        <span>f</span><span>.</span><span>write</span><span>(</span><span>&#39;&#34;</span><span>%s</span><span>&#34;</span><span>\n</span><span>&#39;</span> <span>%</span> <span>wkt_</span><span>)</span>
</pre></div>
<p><a href="https://tech.marksblogg.com/theme/images/umbra-yolo/locations.png"><img alt="Umbra Ship Detection Locations" src="https://tech.marksblogg.com/theme/images/umbra-yolo/locations.png"/></a></p><p>In this post, I&#39;m going to train a ship detection model that works on Umbra&#39;s SAR imagery. I&#39;ll be using Ultralytics&#39; <a href="https://github.com/ultralytics/yolov5">YOLOv5</a> and the <a href="https://github.com/chaozhong2010/HRSID">High-Resolution SAR Images Dataset</a> (HRSID) for training the model.</p>
<div id="my-workstation">
<h2>My Workstation</h2>
<p>I&#39;m using a 6 GHz Intel Core <a href="https://www.intel.com/content/www/us/en/products/sku/236773/intel-core-i9-processor-14900k-36m-cache-up-to-6-00-ghz/specifications.html">i9-14900K</a> CPU. It has 8 performance cores and 16 efficiency cores with a total of 32 threads and 32 MB of L2 cache. It has a liquid cooler attached and is housed in a spacious, full-sized, Cooler Master HAF 700 computer case. I&#39;ve come across videos on YouTube where people have managed to overclock the i9-14900KF to <a href="https://www.youtube.com/watch?v=fb7pl7PZOYo">9.1 GHz</a>.</p>
<p>The system has 96 GB of DDR5 RAM clocked at 6,000 MT/s and a 5th-generation, Crucial T700 4 TB NVMe M.2 SSD which can read at speeds up to 12,400 MB/s. There is a heatsink on the SSD to help keep its temperature down. This is my system&#39;s C drive.</p>
<p>The system is powered by a 1,200-watt, fully modular, Corsair Power Supply and is sat on an ASRock Z790 Pro RS Motherboard.</p>
<p>I&#39;m running Ubuntu 22 LTS via Microsoft&#39;s Ubuntu for Windows on Windows 11 Pro. In case you&#39;re wondering why I don&#39;t run a Linux-based desktop as my primary work environment, I&#39;m still using an Nvidia GTX 1080 GPU which has better driver support on Windows and I use ArcGIS Pro from time to time which only supports Windows natively.</p>
</div>
<div id="installing-prerequisites">
<h2>Installing Prerequisites</h2>
<p>I&#39;ll be using Python and a few other tools to help analyse the imagery in this post.</p>
<div><pre><span></span>$<span> </span>sudo<span> </span>apt<span> </span>update
$<span> </span>sudo<span> </span>apt<span> </span>install<span> </span><span>\</span>
<span>    </span>aws-cli<span> </span><span>\</span>
<span>    </span>jq<span> </span><span>\</span>
<span>    </span>python3-pip<span> </span><span>\</span>
<span>    </span>python3-virtualenv
</pre></div>
<p>I&#39;ll set up a Python Virtual Environment and install a few packages.</p>
<div><pre><span></span>$<span> </span>virtualenv<span> </span>~/.umbra_yolo
$<span> </span><span>source</span><span> </span>~/.umbra_yolo/bin/activate
$<span> </span>python3<span> </span>-m<span> </span>pip<span> </span>install<span> </span><span>\</span>
<span>    </span>duckdb<span> </span><span>\</span>
<span>    </span>geopy<span> </span><span>\</span>
<span>    </span>rich<span> </span><span>\</span>
<span>    </span>shapely
</pre></div>
<p>Below will install YOLOv5&#39;s dependencies.</p>
<div><pre><span></span>$<span> </span>git<span> </span>clone<span> </span>https://github.com/ultralytics/yolov5<span> </span>~/yolov5
$<span> </span>pip<span> </span>install<span> </span>-r<span> </span>~/yolov5/requirements.txt
</pre></div>
<p>I&#39;ll be using <a href="https://github.com/kellyjonbrazil/jc?tab=readme-ov-file">JSON Convert</a> (jc) to convert the output of various CLI tools into JSON. This will make it much easier to compile statistics on the git repositories discussed in this post.</p>
<div><pre><span></span>$<span> </span>wget<span> </span>https://github.com/kellyjonbrazil/jc/releases/download/v1.25.2/jc_1.25.2-1_amd64.deb
$<span> </span>sudo<span> </span>dpkg<span> </span>-i<span> </span>jc_1.25.2-1_amd64.deb
</pre></div>
<p>I&#39;ll also use DuckDB, along with its <a href="https://duckdb.org/docs/extensions/json">JSON</a> and <a href="https://duckdb.org/docs/extensions/spatial.html">Spatial</a> extensions, in this post.</p>
<div><pre><span></span>$<span> </span><span>cd</span><span> </span>~
$<span> </span>wget<span> </span>-c<span> </span>https://github.com/duckdb/duckdb/releases/download/v1.0.0/duckdb_cli-linux-amd64.zip
$<span> </span>unzip<span> </span>-j<span> </span>duckdb_cli-linux-amd64.zip
$<span> </span>chmod<span> </span>+x<span> </span>duckdb
$<span> </span>~/duckdb
</pre></div>
<div><pre><span></span><span>INSTALL</span><span> </span><span>json</span><span>;</span>
<span>INSTALL</span><span> </span><span>spatial</span><span>;</span>
</pre></div>
<p>I&#39;ll set up DuckDB to load all these extensions each time it launches.</p>

<div><pre><span></span>.timer on
.width 180
LOAD json;
LOAD spatial;
</pre></div>
<p>The maps in this post were rendered with <a href="https://www.qgis.org/en/site/forusers/download.html">QGIS</a> version 3.34. QGIS is a desktop application that runs on Windows, macOS and Linux.</p>
</div>
<div id="downloading-satellite-imagery">
<h2>Downloading Satellite Imagery</h2>
<p>Umbra currently have 7.4 TB of files in their ship detection folder in their open data S3 bucket.</p>
<div><pre><span></span>$<span> </span>aws<span> </span>s3<span> </span>ls<span> </span>--no-sign-request<span> </span><span>\</span>
<span>            </span>--summarize<span> </span><span>\</span>
<span>            </span>--human<span> </span><span>\</span>
<span>            </span>--recursive<span> </span><span>\</span>
<span>            </span>s3://umbra-open-data-catalog/sar-data/tasks/ship_detection_testdata/<span> </span><span>\</span>
<span>    </span><span>|</span><span> </span>tail<span> </span>-n2
</pre></div>
<div><pre><span></span>Total<span> </span>Objects:<span> </span><span>4573</span>
<span>   </span>Total<span> </span>Size:<span> </span><span>7</span>.4<span> </span>TiB
</pre></div>
<p>I&#39;ll download the JSON metadata and GeoTIFFs. These add up to 394 GB in size.</p>
<div><pre><span></span>$<span> </span>mkdir<span> </span>-p<span> </span>~/ship_detection_testdata
$<span> </span><span>cd</span><span> </span>~/ship_detection_testdata

$<span> </span><span>for</span><span> </span>FORMAT<span> </span><span>in</span><span> </span>json<span> </span>tif<span>;</span><span> </span><span>do</span>
<span>    </span>aws<span> </span>s3<span> </span>--no-sign-request<span> </span><span>\</span>
<span>           </span>sync<span> </span><span>\</span>
<span>           </span>--exclude<span>=</span><span>&#34;*&#34;</span><span> </span><span>\</span>
<span>           </span>--include<span>=</span><span>&#34;*.</span><span>$FORMAT</span><span>&#34;</span><span> </span><span>\</span>
<span>           </span>s3://umbra-open-data-catalog/sar-data/tasks/ship_detection_testdata/<span> </span><span>\</span>
<span>           </span>./
<span>  </span><span>done</span>
</pre></div>
<p>Below is a breakdown of the file counts bucketed to the nearest GB.</p>
<div><pre><span></span>$<span> </span>ls<span> </span>-lR<span> </span><span>\</span>
<span>    </span><span>|</span><span> </span>jc<span> </span>--ls<span> </span><span>\</span>
<span>    </span><span>|</span><span> </span>~/duckdb<span> </span>-c<span> </span><span>&#34;</span>
<span>            SELECT   ROUND(size / 1024 / 1024 / 1024)::int AS size_gb,</span>
<span>                     COUNT(*)</span>
<span>            FROM     READ_JSON_AUTO(&#39;/dev/stdin&#39;)</span>
<span>            GROUP BY 1</span>
<span>            ORDER BY 1;&#34;</span>
</pre></div>
<div><pre><span></span>┌─────────┬──────────────┐
│ size_gb │ count_star() │
│  int32  │    int64     │
├─────────┼──────────────┤
│       0 │         3787 │
│       1 │          180 │
│       2 │           11 │
│       3 │            9 │
│       4 │            3 │
│       5 │            3 │
└─────────┴──────────────┘
</pre></div>
<p>The majority of files are under a GB but some are as large as five GB.</p>
<div><pre><span></span>$<span> </span>ls<span> </span>-lR<span> </span><span>\</span>
<span>    </span><span>|</span><span> </span>jc<span> </span>--ls<span> </span><span>\</span>
<span>    </span><span>|</span><span> </span>~/duckdb<span> </span>-c<span> </span><span>&#34;</span>
<span>            SELECT   size,</span>
<span>                     filename</span>
<span>            FROM     READ_JSON_AUTO(&#39;/dev/stdin&#39;)</span>
<span>            ORDER BY size DESC</span>
<span>            LIMIT    10;&#34;</span>
</pre></div>
<div><pre><span></span>┌────────────┬──────────────────────────────────────┐
│    size    │               filename               │
│   int64    │               varchar                │
├────────────┼──────────────────────────────────────┤
│ 5125833514 │ 2023-12-06-14-30-39_UMBRA-05_GEC.tif │
│ 4973515962 │ 2023-12-30-02-56-59_UMBRA-04_GEC.tif │
│ 4880185578 │ 2023-12-30-01-23-15_UMBRA-04_GEC.tif │
│ 4722625282 │ 2023-12-06-01-53-34_UMBRA-05_GEC.tif │
│ 4351925386 │ 2023-12-04-03-54-25_UMBRA-05_GEC.tif │
│ 4027566020 │ 2023-10-26-05-39-39_UMBRA-05_GEC.tif │
│ 3271758578 │ 2023-12-06-12-24-10_UMBRA-05_GEC.tif │
│ 3196780818 │ 2024-02-10-19-06-27_UMBRA-07_GEC.tif │
│ 3078709927 │ 2024-03-29-17-52-28_UMBRA-05_GEC.tif │
│ 2867770018 │ 2023-10-06-02-28-43_UMBRA-05_GEC.tif │
├────────────┴──────────────────────────────────────┤
│ 10 rows                                 2 columns │
└───────────────────────────────────────────────────┘
</pre></div>
</div>
<div id="locations-and-equipment">
<h2>Locations and Equipment</h2>
<p>There are a lot of complexities as to who&#39;s water a ship is in. I&#39;ve made an attempt to use OSM&#39;s reverse geocoder to determine which country the centre of each SAR image&#39;s footprint is in.</p>

<div><pre><span></span><span>import</span> <span>json</span>
<span>from</span>   <span>glob</span>             <span>import</span> <span>glob</span>
<span>from</span>   <span>time</span>             <span>import</span> <span>sleep</span>

<span>from</span>   <span>geopy.geocoders</span>  <span>import</span> <span>Nominatim</span>
<span>from</span>   <span>rich.progress</span>    <span>import</span> <span>track</span>
<span>from</span>   <span>shapely</span>          <span>import</span> <span>wkt</span>
<span>from</span>   <span>shapely.geometry</span> <span>import</span> <span>shape</span>


<span>geolocator</span> <span>=</span> <span>Nominatim</span><span>(</span><span>user_agent</span><span>=</span><span>&#39;geopy&#39;</span><span>)</span>

<span>with</span> <span>open</span><span>(</span><span>&#39;imagery.json&#39;</span><span>,</span> <span>&#39;w&#39;</span><span>)</span> <span>as</span> <span>f</span><span>:</span>
    <span>for</span> <span>filename</span> <span>in</span> <span>track</span><span>(</span><span>glob</span><span>(</span><span>&#39;*/*/*.json&#39;</span><span>)):</span>
        <span>rec</span> <span>=</span> <span>json</span><span>.</span><span>loads</span><span>(</span><span>open</span><span>(</span><span>filename</span><span>)</span><span>.</span><span>read</span><span>())</span>

        <span>for</span> <span>collect_num</span><span>,</span> <span>collect</span> <span>in</span> <span>enumerate</span><span>(</span><span>rec</span><span>[</span><span>&#39;collects&#39;</span><span>]):</span>
            <span>geom</span> <span>=</span> <span>shape</span><span>(</span><span>collect</span><span>[</span><span>&#39;footprintPolygonLla&#39;</span><span>])</span>

            <span># Convert the POLYGON Z to a POLYGON</span>
            <span>geom</span> <span>=</span> <span>wkt</span><span>.</span><span>loads</span><span>(</span><span>wkt</span><span>.</span><span>dumps</span><span>(</span><span>geom</span><span>,</span> <span>output_dimension</span><span>=</span><span>2</span><span>))</span>

            <span>try</span><span>:</span>
                <span>osm</span> <span>=</span> <span>geolocator</span><span>.</span><span>reverse</span><span>(</span><span>&#39;</span><span>%f</span><span> </span><span>%f</span><span>&#39;</span> <span>%</span> <span>(</span><span>geom</span><span>.</span><span>centroid</span><span>.</span><span>y</span><span>,</span>
                                                    <span>geom</span><span>.</span><span>centroid</span><span>.</span><span>x</span><span>))</span><span>.</span><span>raw</span>
            <span>except</span> <span>Exception</span> <span>as</span> <span>exc</span><span>:</span>
                <span>print</span><span>(</span><span>exc</span><span>)</span>
                <span>osm</span> <span>=</span> <span>None</span>

            <span>f</span><span>.</span><span>write</span><span>(</span><span>json</span><span>.</span><span>dumps</span><span>({</span>
                <span>&#39;osm&#39;</span><span>:</span>         <span>osm</span><span>,</span>
                <span>&#39;collect_num&#39;</span><span>:</span> <span>collect_num</span><span>,</span>
                <span>&#39;sku&#39;</span><span>:</span>         <span>rec</span><span>[</span><span>&#39;productSku&#39;</span><span>],</span>
                <span>&#39;sat&#39;</span><span>:</span>         <span>rec</span><span>[</span><span>&#39;umbraSatelliteName&#39;</span><span>],</span>
                <span>&#39;filename&#39;</span><span>:</span>    <span>filename</span><span>,</span>
                <span>&#39;yyyy_mm&#39;</span><span>:</span>     <span>rec</span><span>[</span><span>&#39;collects&#39;</span><span>][</span><span>0</span><span>][</span><span>&#39;startAtUTC&#39;</span><span>][:</span><span>7</span><span>],</span>
                <span>&#39;centroid_x&#39;</span><span>:</span>  <span>geom</span><span>.</span><span>centroid</span><span>.</span><span>x</span><span>,</span>
                <span>&#39;centroid_y&#39;</span><span>:</span>  <span>geom</span><span>.</span><span>centroid</span><span>.</span><span>y</span><span>,</span>
                <span>&#39;geom&#39;</span><span>:</span>        <span>geom</span><span>.</span><span>wkt</span><span>},</span>
                <span>sort_keys</span><span>=</span><span>True</span><span>)</span> <span>+</span> <span>&#39;</span><span>\n</span><span>&#39;</span><span>)</span>
            <span>sleep</span><span>(</span><span>1</span><span>)</span>
</pre></div>
<p>The imagery covers at least 53 countries and international waters. Below are the top ten countries represented.</p>
<div><pre><span></span>$<span> </span>jq<span> </span>-S<span> </span>.osm.address.country_code<span> </span>imagery.json<span> </span><span>\</span>
<span>    </span><span>|</span><span> </span>sort<span> </span><span>\</span>
<span>    </span><span>|</span><span> </span>uniq<span> </span>-c<span> </span><span>\</span>
<span>    </span><span>|</span><span> </span>sort<span> </span>-rn<span> </span><span>\</span>
<span>    </span><span>|</span><span> </span>head
</pre></div>
<div><pre><span></span>321 &#34;cn&#34;
 80 &#34;us&#34;
 59 &#34;ir&#34;
 34 &#34;kr&#34;
 33 &#34;ru&#34;
 31 &#34;ae&#34;
 30 &#34;sg&#34;
 29 &#34;my&#34;
 29 &#34;dj&#34;
 26 &#34;nl&#34;
</pre></div>
<p><a href="https://marineregions.org/downloads.php">Marine Regions</a> has GeoPackage files delineating maritime boundaries. Seven of the nine files contain polygons that I&#39;ll use to determine the waters a given centroid is in.</p>
<div><pre><span></span>$<span> </span><span>cd</span><span> </span>~/marineregions_org
$<span> </span>ls<span> </span>-lh<span> </span>*.gpkg
</pre></div>
<div><pre><span></span>..  69M .. eez_12nm_v4.gpkg
..  60M .. eez_24nm_v4.gpkg
..  77M .. eez_internal_waters_v4.gpkg
..  16M .. eez_boundaries_v12.gpkg
.. 157M .. eez_v12.gpkg
..  39M .. eez_archipelagic_waters_v4.gpkg
.. 2.1M .. ecs_boundaries_v01.gpkg
.. 7.0M .. ecs_v01.gpkg
.. 8.8M .. High_Seas_v1.gpkg
</pre></div>
<p>Below is a rendering of this dataset.</p>
<p><a href="https://tech.marksblogg.com/theme/images/umbra-yolo/baltic.png"><img alt="Marine Regions" src="https://tech.marksblogg.com/theme/images/umbra-yolo/baltic.png"/></a></p><p>I&#39;ll first import these GeoPackage files into DuckDB.</p>
<div><pre><span></span>$<span> </span><span>for</span><span> </span>FILENAME<span> </span><span>in</span><span> </span>*.gpkg<span>;</span><span> </span><span>do</span>
<span>      </span><span>BASENAME</span><span>=</span><span>`</span><span>echo</span><span> </span><span>&#34;</span><span>$FILENAME</span><span>&#34;</span><span> </span><span>|</span><span> </span>cut<span> </span>-d.<span> </span>-f1<span>`</span>
<span>      </span>~/duckdb<span> </span>-c<span> </span><span>&#34;CREATE OR REPLACE TABLE </span><span>$BASENAME</span><span> AS</span>
<span>                      SELECT *</span>
<span>                      FROM   ST_READ(&#39;</span><span>$FILENAME</span><span>&#39;);&#34;</span><span> </span><span>\</span>
<span>          </span>waters.duckdb
<span>  </span><span>done</span>
</pre></div>
<p>Polygons can overlap one another so I&#39;ll first get every point-polygon collision there is.</p>

<div><pre><span></span><span>import</span> <span>json</span>

<span>import</span> <span>duckdb</span>
<span>from</span>   <span>rich.progress</span> <span>import</span> <span>track</span>


<span>tables</span> <span>=</span> <span>(</span>
    <span>&#39;High_Seas_v1&#39;</span><span>,</span>
    <span>&#39;eez_archipelagic_waters_v4&#39;</span><span>,</span>
    <span>&#39;ecs_boundaries_v01&#39;</span><span>,</span>
    <span>&#39;eez_boundaries_v12&#39;</span><span>,</span>
    <span>&#39;ecs_v01&#39;</span><span>,</span>
    <span>&#39;eez_internal_waters_v4&#39;</span><span>,</span>
    <span>&#39;eez_12nm_v4&#39;</span><span>,</span>
    <span>&#39;eez_v12&#39;</span><span>,</span>
    <span>&#39;eez_24nm_v4&#39;</span><span>)</span>

<span>con</span> <span>=</span> <span>duckdb</span><span>.</span><span>connect</span><span>(</span><span>database</span><span>=</span><span>&#39;waters.duckdb&#39;</span><span>)</span>
<span>df</span> <span>=</span> <span>con</span><span>.</span><span>sql</span><span>(</span><span>&#39;INSTALL spatial;&#39;</span><span>)</span>

<span>with</span> <span>open</span><span>(</span><span>&#39;waters.json&#39;</span><span>,</span> <span>&#39;w&#39;</span><span>)</span> <span>as</span> <span>f</span><span>:</span>
    <span>centroid_num</span> <span>=</span> <span>0</span>

    <span>for</span> <span>geom</span> <span>in</span> <span>track</span><span>(</span><span>open</span><span>(</span><span>&#39;/home/mark/umbra_ships.csv&#39;</span><span>),</span> <span>total</span><span>=</span><span>996</span><span>):</span>
        <span>try</span><span>:</span>
            <span>lon</span><span>,</span> <span>lat</span> <span>=</span> <span>[</span><span>float</span><span>(</span><span>x</span><span>)</span>
                        <span>for</span> <span>x</span> <span>in</span> <span>geom</span><span>.</span><span>strip</span><span>()</span>
                                     <span>.</span><span>split</span><span>(</span><span>&#39;(&#39;</span><span>)[</span><span>-</span><span>1</span><span>]</span>
                                     <span>.</span><span>split</span><span>(</span><span>&#39;)&#39;</span><span>)[</span><span>0</span><span>]</span>
                                     <span>.</span><span>split</span><span>(</span><span>&#39; &#39;</span><span>)]</span>
        <span>except</span><span>:</span>
            <span>continue</span>

        <span>for</span> <span>table</span> <span>in</span> <span>tables</span><span>:</span>
            <span>df</span> <span>=</span> <span>con</span><span>.</span><span>sql</span><span>(</span><span>&#34;&#34;&#34;LOAD    spatial;</span>

<span>                            SELECT *</span>
<span>                            FROM   &#34;&#34;&#34;</span> <span>+</span> <span>table</span> <span>+</span> <span>&#34;&#34;&#34;</span>
<span>                            WHERE  ST_CONTAINS(geom, ST_POINT(?, ?));&#34;&#34;&#34;</span><span>,</span>
                         <span>params</span><span>=</span><span>(</span><span>lon</span><span>,</span> <span>lat</span><span>))</span><span>.</span><span>to_df</span><span>()</span>
            <span>if</span> <span>not</span> <span>df</span><span>.</span><span>empty</span><span>:</span>
                <span>out</span> <span>=</span> <span>{</span><span>&#39;lon&#39;</span><span>:</span>          <span>lon</span><span>,</span>
                       <span>&#39;lat&#39;</span><span>:</span>          <span>lat</span><span>,</span>
                       <span>&#39;centroid_num&#39;</span><span>:</span> <span>centroid_num</span><span>}</span>
                <span>out</span><span>[</span><span>table</span><span>]</span> <span>=</span> <span>json</span><span>.</span><span>loads</span><span>(</span><span>df</span><span>.</span><span>to_json</span><span>())</span>

                <span>f</span><span>.</span><span>write</span><span>(</span><span>json</span><span>.</span><span>dumps</span><span>(</span><span>out</span><span>,</span> <span>sort_keys</span><span>=</span><span>True</span><span>)</span> <span>+</span> <span>&#39;</span><span>\n</span><span>&#39;</span><span>)</span>

        <span>centroid_num</span> <span>=</span> <span>centroid_num</span> <span>+</span> <span>1</span>
</pre></div>
<p>I&#39;ll then take the last point-polygon collision from the results and use it as the location for each image&#39;s centroid.</p>
<div><pre><span></span><span>with</span> <span>open</span><span>(</span><span>&#39;waters_last_geoname.json&#39;</span><span>,</span> <span>&#39;w&#39;</span><span>)</span> <span>as</span> <span>f</span><span>:</span>
    <span>for</span> <span>line</span> <span>in</span> <span>open</span><span>(</span><span>&#39;waters.json&#39;</span><span>):</span>
        <span>rec</span> <span>=</span> <span>json</span><span>.</span><span>loads</span><span>(</span><span>line</span><span>)</span>

        <span>out</span> <span>=</span> <span>{</span><span>&#39;centroid_num&#39;</span><span>:</span> <span>rec</span><span>[</span><span>&#39;centroid_num&#39;</span><span>],</span>
               <span>&#39;lat&#39;</span><span>:</span>          <span>rec</span><span>[</span><span>&#39;lat&#39;</span><span>],</span>
               <span>&#39;lon&#39;</span><span>:</span>          <span>rec</span><span>[</span><span>&#39;lon&#39;</span><span>]}</span>

        <span>tables</span> <span>=</span> <span>[</span><span>x</span>
                  <span>for</span> <span>x</span> <span>in</span> <span>rec</span><span>.</span><span>keys</span><span>()</span>
                  <span>if</span> <span>x</span> <span>not</span> <span>in</span> <span>(</span><span>&#39;centroid_num&#39;</span><span>,</span> <span>&#39;lat&#39;</span><span>,</span> <span>&#39;lon&#39;</span><span>)]</span>

        <span>for</span> <span>table</span> <span>in</span> <span>tables</span><span>:</span>
            <span>out</span><span>[</span><span>&#39;GEONAME&#39;</span><span>]</span> <span>=</span> <span>rec</span><span>[</span><span>table</span><span>][</span><span>&#39;GEONAME&#39;</span><span>][</span><span>&#39;0&#39;</span><span>]</span>

        <span>f</span><span>.</span><span>write</span><span>(</span><span>json</span><span>.</span><span>dumps</span><span>(</span><span>out</span><span>,</span> <span>sort_keys</span><span>=</span><span>True</span><span>)</span> <span>+</span> <span>&#39;</span><span>\n</span><span>&#39;</span><span>)</span>
</pre></div>
<p>The above returned 881 results out of the 998 image centroids in this dataset. Below are the top 40 locations for the imagery in Umbra&#39;s dataset.</p>

<div><pre><span></span><span>.</span><span>maxrows</span><span> </span><span>100</span>

<span>SELECT</span><span>   </span><span>GEONAME</span><span>,</span>
<span>         </span><span>COUNT</span><span>(</span><span>*</span><span>)</span>
<span>FROM</span><span>     </span><span>READ_JSON</span><span>(</span><span>&#39;waters_last_geoname.json&#39;</span><span>)</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>1</span>
<span>ORDER</span><span> </span><span>BY</span><span> </span><span>2</span><span> </span><span>DESC</span>
<span>LIMIT</span><span>    </span><span>40</span><span>;</span>
</pre></div>
<div><pre><span></span>┌──────────────────────────────────────────┬──────────────┐
│                 GEONAME                  │ count_star() │
│                 varchar                  │    int64     │
├──────────────────────────────────────────┼──────────────┤
│ Chinese Exclusive Economic Zone          │          165 │
│ Chinese Internal Waters                  │          112 │
│ Chinese 12 NM                            │           36 │
│ United States Exclusive Economic Zone    │           31 │
│ United States 12 NM                      │           31 │
│ Russian Exclusive Economic Zone          │           23 │
│ Russian Internal Waters                  │           23 │
│ Malaysian Exclusive Economic Zone        │           22 │
│ Djiboutian Exclusive Economic Zone       │           18 │
│ Iranian Exclusive Economic Zone          │           17 │
│ Iranian Internal Waters                  │           16 │
│ Indonesian Exclusive Economic Zone       │           16 │
│ Panamanian Exclusive Economic Zone       │           13 │
│ Panamanian Internal Waters               │           13 │
│ Malaysian Internal Waters                │           13 │
│ Sri Lankan 12 NM                         │           12 │
│ Sri Lankan Exclusive Economic Zone       │           12 │
│ Yemeni Exclusive Economic Zone           │           12 │
│ Philippine Exclusive Economic Zone       │           12 │
│ Djiboutian Internal Waters               │           12 │
│ Emirati Exclusive Economic Zone          │           11 │
│ Emirati 12 NM                            │           11 │
│ Overlapping claim Taiwan: Taiwan / China │           10 │
│ Maldivian Exclusive Economic Zone        │           10 │
│ Maldivian Archipelagic Waters            │           10 │
│ South Korean Exclusive Economic Zone     │            9 │
│ Malaysian 12 NM                          │            9 │
│ South Korean Internal Waters             │            9 │
│ North Korean 12 NM                       │            8 │
│ North Korean Exclusive Economic Zone     │            8 │
│ Yemeni 12 NM                             │            7 │
│ Egyptian Exclusive Economic Zone         │            7 │
│ Venezuelan Exclusive Economic Zone       │            6 │
│ Djiboutian 12 NM                         │            6 │
│ Indonesian 12 NM                         │            6 │
│ Thai Internal Waters                     │            5 │
│ Thailand Exclusive Economic Zone         │            5 │
│ Singaporean 12 NM                        │            5 │
│ Pakistani Internal Waters                │            5 │
│ Indian Exclusive Economic Zone           │            5 │
├──────────────────────────────────────────┴──────────────┤
│ 40 rows                                       2 columns │
└─────────────────────────────────────────────────────────┘
</pre></div>
<p>Below is a breakdown of the satellites and the months in which the images were captured.</p>

<div><pre><span></span><span>PIVOT</span><span>    </span><span>READ_JSON_AUTO</span><span>(</span><span>&#39;imagery.json&#39;</span><span>)</span>
<span>ON</span><span>       </span><span>sat</span>
<span>USING</span><span>    </span><span>COUNT</span><span>(</span><span>*</span><span>)</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>yyyy_mm</span>
<span>ORDER</span><span> </span><span>BY</span><span> </span><span>yyyy_mm</span><span>;</span>
</pre></div>
<div><pre><span></span>┌─────────┬──────────┬──────────┬──────────┬──────────┬──────────┐
│ yyyy_mm │ UMBRA_04 │ UMBRA_05 │ UMBRA_06 │ UMBRA_07 │ UMBRA_08 │
│ varchar │  int64   │  int64   │  int64   │  int64   │  int64   │
├─────────┼──────────┼──────────┼──────────┼──────────┼──────────┤
│ 2023-01 │       62 │       32 │        0 │        0 │        0 │
│ 2023-02 │       49 │       54 │        0 │        0 │        0 │
│ 2023-03 │       22 │       24 │        0 │        0 │        0 │
│ 2023-04 │       18 │       17 │        1 │        0 │        0 │
│ 2023-05 │       11 │       11 │        1 │        0 │        0 │
│ 2023-06 │       30 │       33 │       45 │        0 │        0 │
│ 2023-07 │       38 │       43 │        8 │        0 │        0 │
│ 2023-08 │        9 │       31 │        9 │        0 │        0 │
│ 2023-09 │       23 │       26 │       19 │        0 │        0 │
│ 2023-10 │       57 │       50 │        4 │        0 │        0 │
│ 2023-11 │       24 │       15 │        1 │        0 │        0 │
│ 2023-12 │       36 │       46 │       22 │        0 │        0 │
│ 2024-01 │        7 │        2 │        7 │        0 │        0 │
│ 2024-02 │       12 │       10 │        4 │        9 │        7 │
│ 2024-03 │       20 │       18 │       12 │        6 │        8 │
│ 2024-04 │        1 │        0 │        1 │        0 │        0 │
├─────────┴──────────┴──────────┴──────────┴──────────┴──────────┤
│ 16 rows                                              6 columns │
└────────────────────────────────────────────────────────────────┘
</pre></div>
</div>
<div id="ship-detection-training-data">
<h2>Ship Detection Training Data</h2>
<p>HRSID contains imagery of 16,951 ships across 5,604 images. The images span a wide range of resolutions, polarisations, sea conditions and geographies.</p>
<p>I found a GitHub repository of HRSID&#39;s training data already nicely organised. The repository is 2.6 GB including the <tt>.git</tt> folder.</p>
<div><pre><span></span>$<span> </span>git<span> </span>clone<span> </span>https://github.com/Akashkalasagond/SAR-Ship-Detection/<span> </span><span>\</span>
<span>    </span>~/SAR-Ship-Detection
</pre></div>
</div>
<div id="training-with-yolov5">
<h2>Training with YOLOv5</h2>
<p>I&#39;ll download one of YOLOv5&#39;s pre-trained weights.</p>
<div><pre><span></span>$<span> </span><span>cd</span><span> </span>~
$<span> </span>wget<span> </span>https://github.com/ultralytics/assets/releases/download/v8.2.0/yolov5nu.pt
</pre></div>
<p>Below I&#39;ll set up a training configuration for YOLOv5.</p>
<div><pre><span></span>$<span> </span><span>cd</span><span> </span>~/SAR-Ship-Detection
$<span> </span>vi<span> </span>settings.yaml
</pre></div>
<div><pre><span></span><span>path</span><span>:</span><span> </span><span>&#34;/home/mark/SAR-Ship-Detection/&#34;</span>
<span>train</span><span>:</span><span> </span><span>&#34;/home/mark/SAR-Ship-Detection/train/images&#34;</span>
<span>val</span><span>:</span><span> </span><span>&#34;/home/mark/SAR-Ship-Detection/test/images&#34;</span>

<span># class names</span>
<span>names</span><span>:</span>
<span>  </span><span>0</span><span>:</span><span> </span><span>&#39;ship&#39;</span>
</pre></div>
<p>I&#39;ll train a model using the above settings on my Nvidia GeForce GTX 1080.</p>

<div><pre><span></span><span>from</span> <span>ultralytics</span> <span>import</span> <span>YOLO</span>


<span>model</span>   <span>=</span> <span>YOLO</span><span>(</span><span>&#39;/home/mark/yolov5nu.pt&#39;</span><span>)</span>
<span>results</span> <span>=</span> <span>model</span><span>.</span><span>train</span><span>(</span><span>data</span><span>=</span><span>&#39;/home/mark/SAR-Ship-Detection/settings.yaml&#39;</span><span>,</span>
                      <span>epochs</span><span>=</span><span>100</span><span>,</span>
                      <span>batch</span><span>=</span><span>8</span><span>,</span>
                      <span>imgsz</span><span>=</span><span>800</span><span>,</span>
                      <span>plots</span><span>=</span><span>True</span><span>)</span>
</pre></div>
<div><pre><span></span>Ultralytics YOLOv8.2.32 🚀 Python-3.10.12 torch-2.3.1+cu121 CUDA:0 (NVIDIA GeForce GTX 1080, 8192MiB)
...
100 epochs completed in 2.885 hours.
Optimizer stripped from runs/detect/train/weights/last.pt, 5.3MB
Optimizer stripped from runs/detect/train/weights/best.pt, 5.3MB
</pre></div>
<p>The training finished in just under 3 hours and produced a 5.3 MB weights model.</p>
</div>
<div id="inferring-umbra-s-imagery">
<h2>Inferring Umbra&#39;s Imagery</h2>
<p>Below I&#39;ll attempt to detect ships in Umbra&#39;s 998 SAR images using the model I trained.</p>

<div><pre><span></span><span>from</span> <span>glob</span> <span>import</span> <span>glob</span>
<span>import</span> <span>json</span>

<span>from</span>   <span>rich.progress</span> <span>import</span> <span>track</span>
<span>from</span>   <span>ultralytics</span> <span>import</span> <span>YOLO</span>


<span>model</span>   <span>=</span> <span>YOLO</span><span>(</span><span>&#39;runs/detect/train/weights/best.pt&#39;</span><span>)</span>
<span>pattern</span> <span>=</span> <span>&#39;/home/mark/ship_detection_testdata/*/*/*_GEC.tif&#39;</span>

<span>with</span> <span>open</span><span>(</span><span>&#39;ship_detections.jsonl&#39;</span><span>,</span> <span>&#39;w&#39;</span><span>)</span> <span>as</span> <span>f</span><span>:</span>
    <span>for</span> <span>filename</span> <span>in</span> <span>track</span><span>(</span><span>glob</span><span>(</span><span>pattern</span><span>),</span> <span>total</span><span>=</span><span>998</span><span>):</span>
        <span>try</span><span>:</span>
            <span>for</span> <span>results</span> <span>in</span> <span>model</span><span>(</span><span>filename</span><span>):</span>
                <span>for</span> <span>result</span> <span>in</span> <span>results</span><span>:</span>
                    <span>ships</span> <span>=</span> <span>json</span><span>.</span><span>loads</span><span>(</span><span>result</span><span>.</span><span>tojson</span><span>())</span>

                    <span>for</span> <span>ship</span> <span>in</span> <span>ships</span><span>:</span>
                        <span>f</span><span>.</span><span>write</span><span>(</span><span>json</span><span>.</span><span>dumps</span><span>({</span><span>**</span><span>ship</span><span>,</span>
                                            <span>**</span><span>{</span><span>&#39;filename&#39;</span><span>:</span> <span>result</span><span>.</span><span>path</span><span>}},</span>
                                           <span>sort_keys</span><span>=</span><span>True</span><span>)</span> <span>+</span> <span>&#39;</span><span>\n</span><span>&#39;</span><span>)</span>
        <span>except</span> <span>Exception</span> <span>as</span> <span>exc</span><span>:</span>
            <span>print</span><span>(</span><span>exc</span><span>)</span>
</pre></div>
<p>During the run, the 5 GB GeoTIFF caused the following exception.</p>
<div><pre><span></span>error: OpenCV(4.10.0) /io/opencv/modules/imgcodecs/src/loadsave.cpp:79: error: (-215:Assertion failed) pixels &lt;= CV_IO_MAX_IMAGE_PIXELS in function &#39;validateInputImageSize&#39;
</pre></div>
<p>I wasn&#39;t able to adjust OpenCV&#39;s settings within the allotted time box I had for this post so I wrapped the inference in a try/except statement so to not hold back the rest of the job.</p>
<p>Below is a section of YOLO&#39;s output during inference.</p>
<div><pre><span></span>..2023-04-15-01-17-53_UMBRA-05_GEC.tif: 800x800 3 ships, 41.6ms
..2023-08-07-13-53-00_UMBRA-04_GEC.tif: 800x800 (no detections), 45.4ms
..2023-03-25-02-22-27_UMBRA-04_GEC.tif: 800x800 4 ships, 39.1ms
..2023-01-23-18-25-33_UMBRA-05_GEC.tif: 800x800 (no detections), 40.5ms
..2023-08-10-13-17-17_UMBRA-05_GEC.tif: 800x800 4 ships, 38.7ms
..2023-10-25-10-31-48_UMBRA-05_GEC.tif: 800x640 (no detections), 31.7ms
..2023-06-18-01-56-53_UMBRA-04_GEC.tif: 800x800 6 ships, 43.8ms
..2023-11-01-13-52-39_UMBRA-05_GEC.tif: 800x800 1 ship, 43.1ms
..2023-04-23-07-12-19_UMBRA-05_GEC.tif: 800x800 3 ships, 52.2ms
..2023-03-06-02-08-59_UMBRA-04_GEC.tif: 800x800 8 ships, 40.0ms
..2023-10-06-02-14-22_UMBRA-04_GEC.tif: 800x800 (no detections), 80.0ms
..2023-03-09-02-49-06_UMBRA-05_GEC.tif: 800x800 (no detections), 39.5ms
..2023-02-26-14-24-37_UMBRA-04_GEC.tif: 800x800 6 ships, 44.9ms
...
</pre></div>
<p>There were 2,534 ships detected. Below is an example record from the results file.</p>
<div><pre><span></span>$<span> </span>wc<span> </span>-l<span> </span>ship_detections.jsonl<span> </span><span># 2,534 lines</span>
$<span> </span>head<span> </span>-n1<span> </span>ship_detections.jsonl<span> </span><span>|</span><span> </span>jq<span> </span>-S<span> </span>.
</pre></div>
<div><pre><span></span><span>{</span>
<span>  </span><span>&#34;box&#34;</span><span>:</span><span> </span><span>{</span>
<span>    </span><span>&#34;x1&#34;</span><span>:</span><span> </span><span>12475.06152</span><span>,</span>
<span>    </span><span>&#34;x2&#34;</span><span>:</span><span> </span><span>13001.17188</span><span>,</span>
<span>    </span><span>&#34;y1&#34;</span><span>:</span><span> </span><span>9329.18945</span><span>,</span>
<span>    </span><span>&#34;y2&#34;</span><span>:</span><span> </span><span>9791.08105</span>
<span>  </span><span>},</span>
<span>  </span><span>&#34;class&#34;</span><span>:</span><span> </span><span>0</span><span>,</span>
<span>  </span><span>&#34;confidence&#34;</span><span>:</span><span> </span><span>0.45151</span><span>,</span>
<span>  </span><span>&#34;filename&#34;</span><span>:</span><span> </span><span>&#34;/home/mark/ship_detection_testdata/00174818-00fe-4c89-bf45-cc6149253707/2023-04-15-01-17-53_UMBRA-05/2023-04-15-01-17-53_UMBRA-05_GEC.tif&#34;</span><span>,</span>
<span>  </span><span>&#34;name&#34;</span><span>:</span><span> </span><span>&#34;ship&#34;</span>
<span>}</span>
</pre></div>
<p>Below are the ship counts across each confidence bracket.</p>

<div><pre><span></span><span>SELECT</span><span>   </span><span>ROUND</span><span>(</span><span>confidence</span><span>,</span><span> </span><span>1</span><span>),</span>
<span>         </span><span>COUNT</span><span>(</span><span>*</span><span>)</span>
<span>FROM</span><span>     </span><span>READ_JSON</span><span>(</span><span>&#39;ship_detections.jsonl&#39;</span><span>)</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>1</span>
<span>ORDER</span><span> </span><span>BY</span><span> </span><span>1</span><span>;</span>
</pre></div>
<div><pre><span></span>┌──────────────────────┬──────────────┐
│ round(confidence, 1) │ count_star() │
│        double        │    int64     │
├──────────────────────┼──────────────┤
│                  0.3 │          615 │
│                  0.4 │          466 │
│                  0.5 │          364 │
│                  0.6 │          320 │
│                  0.7 │          306 │
│                  0.8 │          384 │
│                  0.9 │           79 │
└──────────────────────┴──────────────┘
</pre></div>
</div>
<div id="visualising-ship-detections">
<h2>Visualising Ship Detections</h2>
<p>I&#39;ll get YOLOv5 to annotate Umbra&#39;s imagery.</p>

<div><pre><span></span><span>from</span>   <span>glob</span>          <span>import</span> <span>glob</span>
<span>import</span> <span>json</span>
<span>from</span>   <span>os.path</span>       <span>import</span> <span>abspath</span><span>,</span> <span>dirname</span>

<span>from</span>   <span>rich.progress</span> <span>import</span> <span>track</span>
<span>from</span>   <span>ultralytics</span>   <span>import</span> <span>YOLO</span>


<span>model</span>   <span>=</span> <span>YOLO</span><span>(</span><span>&#39;runs/detect/train/weights/best.pt&#39;</span><span>)</span>
<span>pattern</span> <span>=</span> <span>&#39;/home/mark/ship_detection_testdata/*/*/*_GEC.tif&#39;</span>

<span>for</span> <span>filename</span> <span>in</span> <span>track</span><span>(</span><span>glob</span><span>(</span><span>pattern</span><span>),</span> <span>total</span><span>=</span><span>998</span><span>):</span>
    <span>try</span><span>:</span>
        <span>for</span> <span>results</span> <span>in</span> <span>model</span><span>(</span><span>filename</span><span>):</span>
            <span>for</span> <span>res_num</span><span>,</span> <span>result</span> <span>in</span> <span>enumerate</span><span>(</span><span>results</span><span>):</span>
                <span>result</span><span>.</span><span>save</span><span>(</span><span>filename</span><span>=</span><span>&#39;</span><span>%s</span><span>/</span><span>%04d</span><span>.jpg&#39;</span> <span>%</span> <span>(</span><span>dirname</span><span>(</span><span>filename</span><span>),</span> <span>res_num</span><span>))</span>
    <span>except</span> <span>Exception</span> <span>as</span> <span>exc</span><span>:</span>
        <span>print</span><span>(</span><span>exc</span><span>)</span>
</pre></div>
<p>I re-drew the above images in QGIS to control their formatting and layout better.</p>
<p>Below is a harbour in Taiwan. The model identified three ships correctly but missed out on 10s of others.</p>
<p><a href="https://tech.marksblogg.com/theme/images/umbra-yolo/taiwan.jpg"><img alt="Ship Detection" src="https://tech.marksblogg.com/theme/images/umbra-yolo/taiwan.jpg"/></a></p><p>Below is an image taken in Singapore and every detection, even with low confidence, is spot on but there are many more ships that go undetected.</p>
<p><a href="https://tech.marksblogg.com/theme/images/umbra-yolo/singapore.jpg"><img alt="Ship Detection" src="https://tech.marksblogg.com/theme/images/umbra-yolo/singapore.jpg"/></a></p><p>In this port in China, the confidence scores of some of the matches are pretty high but there are a huge number of ships that remain undetected.</p>
<p><a href="https://tech.marksblogg.com/theme/images/umbra-yolo/china.png"><img alt="Ship Detection" src="https://tech.marksblogg.com/theme/images/umbra-yolo/china.png"/></a>
</p></div>

        </div><p>
            Thank you for taking the time to read this post. I offer both consulting and hands-on development services to clients in North America and Europe. If you&#39;d like to discuss how my offerings can help your business please contact me via <a href="https://uk.linkedin.com/in/marklitwintschik/">LinkedIn</a>.
        </p></div>
  </body>
</html>
