<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lapcatsoftware.com/articles/2024/2/3.html">Original</a>
    <h1>Mac app launches slowed by malware scan (2024)</h1>
    
    <div id="readability-page-1" class="page">
<nav>
Previous: <a href="https://lapcatsoftware.com/articles/2024/2/2.html">How to stop Upgrade to macOS Sonoma notifications</a>
</nav>
<header><a href="https://lapcatsoftware.com">Jeff Johnson</a> (<a href="https://underpassapp.com">My apps</a>, <a href="https://www.paypal.me/JeffJohnsonWI">PayPal.Me</a>, <a href="https://mastodon.social/@lapcatsoftware" title="@lapcatsoftware@mastodon.social">Mastodon</a>)</header>
<p><a href="https://lapcatsoftware.com/FeedbackAssistantBoycott/">Feedback Assistant Boycott</a></p>

<h3>February 14 2024</h3>

<p>I&#39;ve always attributed slow Xcode launches to Xcode simply sucking, but I&#39;ve noticed that the FileMerge app frequently launches slowly too. When this happens, the app can take a dozen bounces in the Dock before finally opening. FileMerge resides in the folder <code>Xcode.app/Contents/Applications/</code> within the Xcode bundle and can be opened from the Xcode main menu under the Open Developer Tool submenu. I actually keep FileMerge in my Dock for quick access, because I use FileMerge a lot for diffing files and folders. I finally got fed up with slow launches and decided to investigate by taking a spindump from Activity Monitor. Spindumps are a nice way to see what exactly is consuming resources on your Mac, because they show the &#34;CPU Time&#34; used by each process on your system and each thread in the process.</p>
<p>From the spindump I discovered that the slow launches are caused by the <code>syspolicyd</code> process, specifically <code>DispatchQueue &#34;com.apple.security.syspolicy.yara&#34;</code>. The backtrace showed <code>syspolicyd</code> calling the <code>yr_rules_scan_file</code> function. According to <a href="https://wikipedia.org/wiki/YARA">Wikipedia</a>:</p>
<blockquote>YARA is the name of a tool primarily used in malware research and detection. It provides a rule-based approach to create descriptions of malware families based on regular expression, textual or binary patterns.</blockquote>
<p>Thus, macOS is periodically scanning FileMerge for malware on launch, which causes very slow app launches. I don&#39;t know what the exact period is between scans, but rebooting the Mac seems to reset the cache, which made it convenient for me to test the malware scans while writing this blog post (but otherwise makes it extremely inconvenient for me). I&#39;ve noticed the same <code>syspolicyd</code> malware scanning and consequent slow launches with some other apps such as Xcode itself, Google Chrome, and Wireshark. You can even see <code>syspolicyd</code> spinning up % CPU in Activity Monitor when the malware scan happens. (In order to catch this, make sure to increase Update Frequency to 1 sec.)</p>
<p>Xcode, Chrome, and Wireshark are very large apps, so it makes sense that a malware scan of them would be slow. However, FileMerge is much smaller, only 2 MB. Why does that take so long? My theory is that <code>syspolicyd</code> also scans the launched app&#39;s linked libraries. The command <code>otool -L</code> in Terminal will show them:</p>
<blockquote><code>otool -L /Applications/<wbr/>Xcode.app/<wbr/>Contents/<wbr/>Applications/<wbr/>FileMerge.app/<wbr/>Contents/<wbr/>MacOS/<wbr/>FileMerge</code></blockquote>
<p>I doubt that the built-in system libraries are scanned for malware, because they reside on a separate cryptographically-signed read-only disk volume. But FileMerge also links to non-system libraries:</p>
<pre><code>	@rpath/IDEFoundation.framework/Versions/A/IDEFoundation (compatibility version 1.0.0, current version 22551.0.0)
	@rpath/DVTKit.framework/Versions/A/DVTKit (compatibility version 1.0.0, current version 1.0.0)
	@rpath/DVTFoundation.framework/Versions/A/DVTFoundation (compatibility version 1.0.0, current version 1.0.0)
	@rpath/DeltaFoundation.framework/Versions/A/DeltaFoundation (compatibility version 1.0.0, current version 1.0.0)
	@rpath/DeltaKit.framework/Versions/A/DeltaKit (compatibility version 1.0.0, current version 1.0.0)
	@rpath/DVTUserInterfaceKit.framework/Versions/A/DVTUserInterfaceKit (compatibility version 1.0.0, current version 1.0.0)
	@rpath/libXCTestSwiftSupport.dylib (compatibility version 1.0.0, current version 22516.0.0, weak)</code></pre>
<p>These libraries are located within the Xcode bundle in the <code>Xcode.app/Contents/SharedFrameworks/</code> folder.</p>
<p>In my testing, I also saw somewhat slow launching from another app bundled with Xcode, Accessibility Inspector. This app is larger than FileMerge, yet it launches much more quickly. I suspect the reason is that it links to fewer Xcode frameworks:</p>
<pre><code>	@rpath/AccessibilitySupport.framework/Versions/B/AccessibilitySupport (compatibility version 0.0.0, current version 0.0.0)
	@rpath/DVTFoundation.framework/Versions/A/DVTFoundation (compatibility version 1.0.0, current version 1.0.0)
	@rpath/DVTKit.framework/Versions/A/DVTKit (compatibility version 1.0.0, current version 1.0.0)
	@rpath/AccessibilityAudit.framework/Versions/B/AccessibilityAudit (compatibility version 1.0.0, current version 1.0.0)
	@rpath/AccessibilityAuditDeviceManager.framework/Versions/A/AccessibilityAuditDeviceManager (compatibility version 1.0.0, current version 1.0.0)
</code></pre>
<p>In case you&#39;re wondering, Apple hasn&#39;t exempted Mac App Store apps from malware scanning, not even its own apps. I downloaded Xcode from the <a href="https://developer.apple.com/download/">Apple Developer website</a> rather than from the Mac App Store, but I can see the <code>syspolicyd</code> malware scan when launching large Mac App Store apps such as Pages and Numbers. Again, though, I think that the built-in read-only system apps are exempt.</p>
<p>Here&#39;s a mystery: I see frequent slow launches and malware scans with Google Chrome but never with <a href="https://www.google.com/chrome/beta/">Google Chrome Beta</a>, despite the fact that the Google Chrome beta app is about the same size as the Google Chrome app. I don&#39;t yet have an explanation for the difference in behavior.</p>
<p>By the way, the existence or nonexistence of extended attributes such as <code>com.apple.quarantine</code> makes no difference. Removing all the extended attributes from an app bundle doesn&#39;t stop the malware scans.</p>
<p>You may remember our friend <code>syspolicyd</code> as the process that <a href="https://lapcatsoftware.com/articles/catalina-executables.html">phones home to Apple when running unsigned executables</a>. It was also the culprit in making <a href="https://lapcatsoftware.com/articles/xcrun.html">Xcode tools slow after reboot</a>. I guess I should have already known the cause of the slow app launches, but I must have forgotten and/or failed to put two and two together. In any case, <code>syspolicyd</code> sucks, and I really wish there were a way to completely disable the malware scanning and allow my apps to always launch quickly. I&#39;m very careful about what I install, and I&#39;ve never had malware in over twenty years of full-time Mac usage, so I think it&#39;s safe to say that for me, <code>syspolicyd</code> is security theater, and I&#39;d rather not have to sit through its &#34;play&#34;, full of sound and fury, signifying nothing. To be fair, I don&#39;t have an issue with malware scanning in the <em>background</em>; I just don&#39;t want malware scanning to hold up my apps launching in the foreground. Instead of interrupting me and scanning an app during the seconds when I&#39;m launching it—what <em>should</em> be a fraction of a second—how about scanning the app during the innumerable seconds when I&#39;m <em>not</em> launching it?</p>
<p>Perhaps <a href="https://developer.apple.com/documentation/security/disabling_and_enabling_system_integrity_protection">disabling System Integrity Protection</a> disables the malware scan too? I haven&#39;t checked this, but it&#39;s not really viable for me as a Mac software developer, because I need to test the same runtime environment as my users, otherwise I could write code that works for me but not for my users. I believe that disabling SIP also disables some Apple services on your Mac that are &#34;protected&#34; by DRM (in order to make reverse engineering more difficult).</p>

<h3>Addendum</h3>
<p>I&#39;ve now confirmed that disabling SIP does indeed eliminate the <code>syspolicyd</code> malware scan. Xcode launches so fast, it&#39;s beautiful. I feel like I&#39;m in heaven! I don&#39;t think I can go back to the previous hell. I&#39;ll live with the consequences, whatever they may be.</p>

<p><a href="https://lapcatsoftware.com/FeedbackAssistantBoycott/">Feedback Assistant Boycott</a></p>

<header><a href="https://lapcatsoftware.com">Jeff Johnson</a> (<a href="https://underpassapp.com">My apps</a>, <a href="https://www.paypal.me/JeffJohnsonWI">PayPal.Me</a>, <a href="https://mastodon.social/@lapcatsoftware" title="@lapcatsoftware@mastodon.social">Mastodon</a>)</header>
<nav><a href="https://lapcatsoftware.com/articles/index.html" title="The Desolation of Blog">Articles index</a></nav>


</div>
  </body>
</html>
