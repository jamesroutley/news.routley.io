<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://kasmweb.com/docs/latest/how_to/lossless.html">Original</a>
    <h1>Streaming lossless VNC to a web browser with Quite OK image format</h1>
    
    <div id="readability-page-1" class="page"><div>
        <div>
          
          <div role="main" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="lossless-encoding">

<p>Kasm Workspaces allows an optional true Lossless mode to be enabled using an installation flag. Before enabling and using this mode, it is important to understand the bandwidth/compute requirements especially in shared environments.</p>
<p>Lossless encoding can and will consume all available bandwidth available to a client and is designed to be run on local networks. This means under even moderate motion and activity at 60 frames per second any resolution 1920x1080 and up will likely consume an entire gigabit connection. Bandwidth consumed depends heavily on the client’s capabilities, however, most quad core x86_64 CPUs produced after 2014 should be capable of decoding at a sustained 1000mbps.</p>
<p>In this document we will be reviewing how to enable and use this mode along with brief technical notes on how this was implemented to function in any modern web browser.</p>
<section id="enabling-lossless">
<h2>Enabling Lossless<a href="#enabling-lossless" title="Permalink to this heading"></a></h2>
<div>
<p>Important</p>
<p>Lossless encoding is disabled by default and enabling it has consequences that can break certain configurations or integrations between Kasm and other systems. Lossless requires <a href="https://developer.chrome.com/docs/extensions/mv3/cross-origin-isolation">Cross-origin isolation</a>, which blocks requests on the page to all external sites. Enabling Cross-origin isolation may break certain configurations such as <a href="https://kasmweb.com/docs/latest/how_to/branding.html"><span>branding</span></a> or referencing external images for Workspace thumbnails. If you have integrated Kasm Workspaces with other systems, enabling Cross-origin isolation will need to be thoroughly tested with your environment.</p>
</div>
<p>During installation or upgrade of Kasm Workspaces 1.12.0 you can pass the flag <code><span>--enable-lossless</span></code>:</p>
<pre>cd /tmp
curl -O https://kasm-static-content.s3.amazonaws.com/kasm_release_1.12.0.d4fd8a.tar.gz
tar -xf kasm_release*.tar.gz
sudo bash kasm_release/install.sh --enable-lossless</pre>
<pre>cd /tmp
curl -O https://kasm-static-content.s3.amazonaws.com/kasm_release_1.12.0.d4fd8a.tar.gz
tar -xf kasm_release*.tar.gz
sudo bash kasm_release/upgrade.sh --enable-lossless</pre>
<p>During installation this will set the apropriate headers needed by Lossless mode and the software will detect the presence of these headers unlocking quality level 5 Lossless for all clients connecting to this Kasm Workspaces deployment.</p>
</section>
<section id="using-lossless">
<h2>Using Lossless<a href="#using-lossless" title="Permalink to this heading"></a></h2>
<p>Enabling lossless is pretty straightforward once enabled by the installation. After connecting to a Workspaces session, navigate to Streaming Quality in the sidebar and move the quality slider all the way to the right (Quality level 5 Lossless). If this option is unavailable re-check your installation/upgrade settings and ensure <code><span>--enable-lossless</span></code> was passed.</p>
<figure>
<img alt="../_images/setting-lossless.png" src="https://kasmweb.com/docs/latest/_images/setting-lossless.png"/>
</figure>
<p>With lossless enabled you should be able to play videos/games at near 60fps with very little latency.</p>
<div>
<p>Note</p>
<p>While Lossless mode will function on any modern web browser the best experience will be had on <a href="https://www.chromium.org/">Chromium</a> based browsers.</p>
</div>
</section>
<section id="technical-background">
<h2>Technical Background<a href="#technical-background" title="Permalink to this heading"></a></h2>
<figure>
<img alt="../_images/qoi-flow.png" src="https://kasmweb.com/docs/latest/_images/qoi-flow.png"/>
</figure>
<p>Lossless encoding uses <a href="https://qoiformat.org/">The Quite OK Image Format</a> which is a very fast to encode and decode lossless image format. While it is a great image format for delivering truly lossless image compression it has no native support in any modern web browser. Without native image decoding support it is necessary to pass the VNC rect images to worker threads to be decoded into raw image data that can be painted to the canvas presented to the end user.</p>
<p>The server side headers are needed to enable <a href="https://developer.chrome.com/blog/enabling-shared-array-buffer/">SharedArrayBuffer</a> support, specifically known as <a href="https://developer.chrome.com/docs/extensions/mv3/cross-origin-isolation">Cross-origin isolation</a>. This enables a high speed in memory methodology to pass the huge amounts data back and forth from the workers to the main browser javascript thread for rendering. These headers specifically in NGINX format:</p>
<div><div><pre><span></span><span>add_header</span> <span>&#39;Cross-Origin-Embedder-Policy&#39;</span> <span>&#39;require-corp&#39;</span><span>;</span>
<span>add_header</span> <span>&#39;Cross-Origin-Opener-Policy&#39;</span> <span>&#39;same-origin&#39;</span><span>;</span>
<span>add_header</span> <span>&#39;Cross-Origin-Resource-Policy&#39;</span> <span>&#39;same-site&#39;</span><span>;</span>
</pre></div>
</div>
<p>Because this is all happening manually leveraging WebAssembly and pure CPU decoding the overhead is significant in comparison with decoding native browser formats like JPEG and WebP. For comparative image delivery it is at least double CPU usage and 10x the bandwidth of near lossless JPEG as native image formats can leverage GPU and worker threads baked into the browser for rendering DOM elements. The main advantages of using this form of lossless compression are we are no longer bound by a single thread and the image is truly lossless. When leveraging workers this means we can achieve a higher framerate versus native browser decoding at the expense of bandwidth and CPU overhead.</p>
<p>As with anything lossless it is impossible to convey the quality and experience in a video or technical document, it is something that needs to be experienced.</p>
</section>
</section>


           </div>
          </div>
          
        </div>
      </div></div>
  </body>
</html>
