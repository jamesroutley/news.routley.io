<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://anarc.at/blog/2022-04-27-lsp-in-debian/">Original</a>
    <h1>Using LSP in Emacs and Debian</h1>
    
    <div id="readability-page-1" class="page"><div id="content">


          

            <p>The <a href="https://microsoft.github.io/language-server-protocol/">Language Server Protocol</a> (LSP) is a neat mechanism that
provides a common interface to what used to be language-specific
lookup mechanisms (like, say, running a Python interpreter in the
background to find function definitions).</p>

<p>There <em>is</em> also <a href="https://en.wikipedia.org/wiki/Ctags">ctags</a> shipped with UNIX since forever, but that
doesn&#39;t support looking <em>backwards</em> (&#34;who uses this function&#34;),
linting, or refactoring. In short, LSP rocks, and how do I use it
right now in my editor of choice (Emacs, in my case) and OS (Debian)
please?</p>



<p>First, you need to setup your editor. The <a href="https://emacs-lsp.github.io/">Emacs LSP mode</a> has
pretty good <a href="https://emacs-lsp.github.io/lsp-mode/page/installation/">installation instructions</a> which, for me, currently
mean:</p>

<pre><code>apt install elpa-lsp-mode
</code></pre>

<p>and this <code>.emacs</code> snippet:</p>

<pre><code>(use-package lsp-mode
  :commands (lsp lsp-deferred)
  :hook ((python-mode go-mode) . lsp-deferred)
  :demand t
  :init
  (setq lsp-keymap-prefix &#34;C-c l&#34;)
  ;; TODO: https://emacs-lsp.github.io/lsp-mode/page/performance/
  ;; also note re &#34;native compilation&#34;: &lt;+varemara&gt; it&#39;s the
  ;; difference between lsp-mode being usable or not, for me
  :config
  (setq lsp-auto-configure t))

(use-package lsp-ui
  :config
  (setq lsp-ui-flycheck-enable t)
  (add-to-list &#39;lsp-ui-doc-frame-parameters &#39;(no-accept-focus . t))
  (define-key lsp-ui-mode-map [remap xref-find-definitions] #&#39;lsp-ui-peek-find-definitions)
  (define-key lsp-ui-mode-map [remap xref-find-references] #&#39;lsp-ui-peek-find-references))
</code></pre>

<p>Note: this configuration might have changed since I wrote this, see
<a href="https://gitlab.com/anarcat/emacs-d/blob/master/init.el">my init.el configuration for the most recent config</a>.</p>

<p>The main reason for choosing <code>lsp-mode</code> over eglot is that it&#39;s in
Debian (and eglot is not). (Apparently, eglot has more chance of being
upstreamed, &#34;when it&#39;s done&#34;, but I guess I&#39;ll cross that bridge when
I get there.)</p>

<p>I already had <code>lsp-mode</code> partially setup in Emacs so I only had to do
<a href="https://gitlab.com/anarcat/emacs-d/-/commit/753ac702b08850322e92c56c2bbcc9afc70d599f">this small tweak to switch</a> and <a href="https://gitlab.com/anarcat/emacs-d/-/commit/68331e54bd43a28fc75b28efb4de7f491ab77b72">change the prefix key</a>
(because <kbd>s-l</kbd> or <kbd>mod</kbd> is used by my window
manager). I also had to pin LSP packages to bookworm <a href="https://gitlab.com/anarcat/puppet/-/blob/976d911e7abfedd3e3d4dcae87912b351ab89a0b/site-modules/profile/manifests/emacs.pp">here</a> so that
it properly detects <code>pylsp</code> (the older version in Debian bullseye only
supports <code>pyls</code>, not packaged in Debian).</p>

<p>This won&#39;t do anything by itself: Emacs will need <em>something</em> to talk
with to provide the magic. Those are called &#34;servers&#34; and are
basically different programs, for each programming language, that
provide the magic.</p>



<p>The Emacs package provides a way (<kbd>M-x lsp-install-server</kbd>)
to install <em>some</em> of them, but I prefer to manage those tools through
Debian packages if possible, just like <code>lsp-mode</code> itself. Those are
the servers I currently know of in Debian:</p>

<table>
<thead>
<tr>
<th> package                   </th>
<th> languages          </th>
</tr>
</thead>
<tbody>
<tr>
<td> <code>ccls</code>                    </td>
<td> C, C++, ObjectiveC </td>
</tr>
<tr>
<td> <code>clangd</code>                  </td>
<td> C, C++, ObjectiveC </td>
</tr>
<tr>
<td> <code>elpa-lsp-haskell</code>        </td>
<td> Haskell            </td>
</tr>
<tr>
<td> <code>fortran-language-server</code> </td>
<td> Fortran            </td>
</tr>
<tr>
<td> <code>gopls</code>                   </td>
<td> Golang             </td>
</tr>
<tr>
<td> <code>python3-pyls</code>            </td>
<td> Python             </td>
</tr>
</tbody>
</table>


<p>There might be more such packages, but those are surprisingly hard to
find. I found a few with <code>apt search &#34;Language Server Protocol&#34;</code>, but
that didn&#39;t find <code>ccls</code>, for example, because that just said &#34;Language
Server&#34; in the description (which also found a few more <code>pyls</code> plugins,
e.g. <code>black</code> support).</p>

<p>Note that the Python packages, in particular, need to be upgraded to
their bookworm releases to work properly (<a href="https://gitlab.com/anarcat/puppet/-/blob/976d911e7abfedd3e3d4dcae87912b351ab89a0b/site-modules/profile/manifests/lsp.pp">here</a>). It seems like
there&#39;s some interoperability problems there that I haven&#39;t quite
figured out yet. See also my <a href="https://gitlab.com/anarcat/puppet/-/blob/main/site-modules/profile/manifests/lsp.pp">Puppet configuration for LSP</a>.</p>

<p>Finally, note that I have now completely switched away from <a href="https://elpy.readthedocs.io/">Elpy</a>
to pyls, and I&#39;m quite happy with the results. <code>lsp-mode</code> feels slower
than <code>elpy</code> but I haven&#39;t done <em>any</em> of the <a href="https://emacs-lsp.github.io/lsp-mode/page/performance/">performance tuning</a>
and this will improve even more with native compilation. And
<code>lsp-mode</code> is much more powerful. I particularly like the &#34;rename
symbol&#34; functionality, which ... mostly works.</p>



<h2 id="puppet-and-ruby">Puppet and Ruby</h2>

<p>I still have to figure how to actually use this: I mostly spend my
time in Puppet these days, there is no server listed in the <a href="https://emacs-lsp.github.io/lsp-mode/page/languages/">Emacs
lsp-mode language list</a>, but there <em>is</em> one listed over at the
<a href="https://microsoft.github.io/language-server-protocol/implementors/servers/">upstream language list</a>, the <a href="https://github.com/puppetlabs/puppet-editor-services">puppet-editor-services</a>
server.</p>

<p>But it&#39;s not packaged in Debian, and seems somewhat... involved. It
could still be a good productivity boost. The <a href="https://voxpupuli.org/">Voxpupuli team</a> have
<a href="https://voxpupuli.org/blog/2019/04/08/puppet-lsp-vim/">vim install instructions</a> which also suggest installing
<a href="https://github.com/castwide/solargraph">solargraph</a>, the Ruby language server, also not packaged in
Debian.</p>

<h2 id="bash">Bash</h2>

<p>I guess I do a bit of shell scripting from time to time nowadays, even
though I don&#39;t like it. So the <a href="https://github.com/bash-lsp/bash-language-server">bash-language-server</a> may prove
useful as well.</p>

<h2 id="other-languages">Other languages</h2>

<p>Here are more language servers available:</p>

<ul>
<li><a href="https://microsoft.github.io/language-server-protocol/implementors/servers/">upstream language list</a>: all servers known to upstream</li>
<li><a href="https://emacs-lsp.github.io/lsp-mode/page/languages/">Emacs lsp-mode language list</a>: all servers known to the Emacs
mode</li>
</ul>



            

            
              
  
  <nav>
    
  </nav>
  


            

            
            
            
            

            <div>
            <p><span>Created <time datetime="2022-04-27T20:36:07Z" pubdate="pubdate" title="Wed, 27 Apr 2022 16:36:07 -0400">Wednesday après-midi, April 27th, 2022</time>.</span>
            <span>
            
            <a href="http://source.anarcat.wiki.orangeseeds.org/?p=source.git;a=history;f=blog/2022-04-27-lsp-in-debian.md">Edited <time datetime="2022-04-27T20:55:33Z" title="Wed, 27 Apr 2022 16:55:33 -0400">Wednesday après-midi, April 27th, 2022</time>.</a>
            
            </span>
            </p></div>

            <nav>
                
            
            
            </nav>
            

            
    </div></div>
  </body>
</html>
