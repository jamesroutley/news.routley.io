<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/o8vm/octox">Original</a>
    <h1>Octox: Unix-like OS in Rust inspired by xv6-riscv</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">octox is a Unix-like operating system inspired by xv6-riscv. octox loosely
  follows the structure and style of xv6, but is implemented in pure Rust.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/1aa9584e6c812c231ad6aeb525954b1afff7ac723b40f65f096566a634e00a1f/68747470733a2f2f7668732e636861726d2e73682f7668732d364d51424979416f33447042724152427848784c33352e676966"><img src="https://camo.githubusercontent.com/1aa9584e6c812c231ad6aeb525954b1afff7ac723b40f65f096566a634e00a1f/68747470733a2f2f7668732e636861726d2e73682f7668732d364d51424979416f33447042724152427848784c33352e676966" alt="https://vhs.charm.sh/vhs-6MQBIyAo3DpBrARBxHxL35.gif" data-animated-image="" data-canonical-src="https://vhs.charm.sh/vhs-6MQBIyAo3DpBrARBxHxL35.gif"/></a></p>
<ul dir="auto">
  <li>Everything from kernel, userland, mkfs, to build system is written in safe
    Rust as much as possible.</li>
  <li>There are no dependencies on external crates.</li>
  <li>The userland has a library similar to Rust’s std with K&amp;R malloc.</li>
  <li>Multi-core support, buddy allocator as kernel-side memory allocator, file
    system with logging support, etc.</li>
</ul>

<h2 tabindex="-1" dir="auto"><a id="user-content-requirements" aria-hidden="true" href="#requirements"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Requirements</h2>
<ul dir="auto">
  <li>Install the rust toolchain to have cargo installed by following
    <a href="https://www.rust-lang.org/tools/install" rel="nofollow">this</a> guide.</li>
  <li>Install <code>qemu-system-riscv</code></li>
  <li>(option) Install <code>gdb-multiarch</code></li>
</ul>
<h2 tabindex="-1" dir="auto"><a id="user-content-build-and-run" aria-hidden="true" href="#build-and-run"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Build and Run</h2>
<ul dir="auto">
  <li>Clone this project &amp; enter: <code>git clone ... &amp;&amp; cd octox</code></li>
  <li>Build: <code>cargo build --target riscv64gc-unknown-none-elf</code>.</li>
  <li>Run: <code>cargo run --target riscv64gc-unknown-none-elf</code>, then qemu will boot
    octox. To exit, press <code>Ctrl+a</code> and <code>x</code>.</li>
</ul>
<h2 tabindex="-1" dir="auto"><a id="user-content-play-with-the-shell" aria-hidden="true" href="#play-with-the-shell"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Play with the Shell</h2>
<p dir="auto">A very simple shell is implemented.
  In addition to executing commands, you can only do the following things.</p>
<ul dir="auto">
  <li>Pipe: <code>cat file | head | grep test</code></li>
  <li>Dump processes: <code>Ctrl + P</code></li>
  <li>End of line: <code>Ctrl + D</code></li>
  <li>Redirect output: <code>&gt;</code>, <code>&gt;&gt;</code></li>
</ul>

<h2 tabindex="-1" dir="auto"><a id="user-content-userland-application" aria-hidden="true" href="#userland-application"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Userland Application</h2>
<p dir="auto">The userland comes with a user library called ulib that is similar to Rust’s
  std, so you can use it to develop your favorite commands. If you create a bin
  crate named <code>_command</code> in src/user, the build.rs and mkfs.rs will place a file
  named <code>command</code> in the file system and make it available for use.</p>
<ul dir="auto">
  <li>In src/user/Cargo.toml, define a bin crate with the name of the command you
    want to create with a <code>_</code> prefix
    <div dir="auto" data-snippet-clipboard-copy-content="[[bin]]
name = &#34;_rm&#34;
path = &#34;rm.rs&#34;
    "><pre>[[<span>bin</span>]]
<span>name</span> = <span><span>&#34;</span>_rm<span>&#34;</span></span>
<span>path</span> = <span><span>&#34;</span>rm.rs<span>&#34;</span></span>
    </pre></div>
  </li>
  <li>userland is also no_std, so don’t forget to add <code>#[no_std]</code>. Use ulib to
    develop any command you like. Here is an example of the rm command.
    <div dir="auto" data-snippet-clipboard-copy-content="#![no_std]
use ulib::{env, fs};

fn main() {
    let mut args = env::args().skip(1).peekable();

    if args.peek().is_none() {
        panic!(&#34;Usage: rm files...&#34;)
    }
    for arg in args {
        fs::remove_file(arg).unwrap()
    }
}
    "><pre><span>#!<span>[</span>no_std<span>]</span></span>
<span>use</span> ulib<span>::</span><span>{</span>env<span>,</span> fs<span>}</span><span>;</span>

<span>fn</span> <span>main</span><span>(</span><span>)</span> <span>{</span>
    <span>let</span> <span>mut</span> args = env<span>::</span><span>args</span><span>(</span><span>)</span><span>.</span><span>skip</span><span>(</span><span>1</span><span>)</span><span>.</span><span>peekable</span><span>(</span><span>)</span><span>;</span>

    <span>if</span> args<span>.</span><span>peek</span><span>(</span><span>)</span><span>.</span><span>is_none</span><span>(</span><span>)</span> <span>{</span>
        <span>panic</span><span>!</span><span>(</span><span>&#34;Usage: rm files...&#34;</span><span>)</span>
    <span>}</span>
    <span>for</span> arg <span>in</span> args <span>{</span>
        fs<span>::</span><span>remove_file</span><span>(</span>arg<span>)</span><span>.</span><span>unwrap</span><span>(</span><span>)</span>
    <span>}</span>
<span>}</span>
    </pre></div>
  </li>
  <li>Then, <code>cargo run --target riscv64gc-unknown-none-elf</code> in the root of octox.</li>
  <li>To use <code>Vec</code> and <code>String</code>, etc, do the following:
    <div dir="auto" data-snippet-clipboard-copy-content="extern crate alloc;
use alloc::{string::String, vec::Vec};
    "><pre><span>extern</span> <span>crate</span> alloc<span>;</span>
<span>use</span> alloc<span>::</span><span>{</span>string<span>::</span><span>String</span><span>,</span> vec<span>::</span><span>Vec</span><span>}</span><span>;</span>
    </pre></div>
  </li>
</ul>
<h2 tabindex="-1" dir="auto"><a id="user-content-kernel" aria-hidden="true" href="#kernel"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Kernel</h2>
<p dir="auto">Developing in src/kernel. Here is an example of adding a system call. If you
  want to add a new system call, you only need to add a definition to the system
  call table in libkernel, and the userland library will be automatically
  generated by build.rs.</p>
<ul dir="auto">
  <li>Add a variant and Syscall Number to <code>enum SysCalls</code> in src/kernel/syscall.rs.
    Here is <code>Dup2</code> as an example:
    <div dir="auto" data-snippet-clipboard-copy-content="pub enum SysCalls {
    Fork = 1,
    ...,
    Dup2 = 23,
    Invalid = 0,
}
    "><pre><span>pub</span> <span>enum</span> <span>SysCalls</span> <span>{</span>
    <span>Fork</span> = <span>1</span><span>,</span>
    ...<span>,</span>
    <span>Dup2</span> = <span>23</span><span>,</span>
    <span>Invalid</span> = <span>0</span><span>,</span>
<span>}</span>
    </pre></div>
  </li>
  <li>Define the function signature of the system call in the <code>TABLE</code> of
    <code>SysCalls</code>. Use the enum type <code>Fn</code> to describe the return type(<code>U</code> (Unit),
    <code>I</code> (Integer), <code>N</code> (never)) and use <code>&amp;str</code> to represent arguments. then,
    define kernel-side implementation as a method on <code>SysCalls</code>. <code>cfg</code> flag is
    used to control the compilation target for kernel and the rest. Here is an
    example of <code>dup2</code>:
    <div dir="auto" data-snippet-clipboard-copy-content="impl SysCalls {
    pub const TABLE: [(fn, &amp;&#39;static str); variant_count::&lt;Self&gt;()] = [
        (Fn::N(Self::Invalid), &#34;&#34;),
        (Fn::I(Self::fork), &#34;()&#34;),
        (Fn::N(Self::exit), &#34;(xstatus: i32)&#34;),
        ...,
        (Fn::I(Self::dup2), &#34;(src: usize, dst: usize)&#34;),
    ];
    pub fn dup2() -&gt; Result&lt;usize&gt; {
        #[cfg(not(all(target_os = &#34;none&#34;, feature = &#34;kernel&#34;)))]
        return Ok(0);
        #[cfg(all(target_os = &#34;none&#34;, feature = &#34;kernel&#34;))]
        {
            let p = Cpus::myproc().unwrap().data_mut();
            let src_fd = argraw(0); let dst_fd = argraw(1);
            if src_fd != dst_fd {
                let mut src = p.ofile.get_mut(src_fd).unwrap()
                    .take().unwrap();
                src.clear_cloexec();
                p.ofile.get_mut(dst_fd)
                    .ok_or(FileDescriptorTooLarge)?.replace(src);
            }
            Ok(dst_fd)
        }
    }
    "><pre><span>impl</span> <span>SysCalls</span> <span>{</span>
    <span>pub</span> <span>const</span> <span>TABLE</span><span>:</span> <span>[</span><span>(</span><span>fn</span><span>,</span> <span>&amp;</span><span>&#39;</span><span>static</span> <span>str</span><span>)</span><span>;</span> <span>variant_count</span><span>::</span><span>&lt;</span><span>Self</span><span>&gt;</span><span>(</span><span>)</span><span>]</span> = <span>[</span>
        <span>(</span><span>Fn</span><span>::</span><span>N</span><span>(</span><span>Self</span><span>::</span><span>Invalid</span><span>)</span><span>,</span> <span>&#34;&#34;</span><span>)</span><span>,</span>
        <span>(</span><span>Fn</span><span>::</span><span>I</span><span>(</span><span>Self</span><span>::</span>fork<span>)</span><span>,</span> <span>&#34;()&#34;</span><span>)</span><span>,</span>
        <span>(</span><span>Fn</span><span>::</span><span>N</span><span>(</span><span>Self</span><span>::</span>exit<span>)</span><span>,</span> <span>&#34;(xstatus: i32)&#34;</span><span>)</span><span>,</span>
        ..<span>.</span><span>,</span>
        <span>(</span><span>Fn</span><span>::</span><span>I</span><span>(</span><span>Self</span><span>::</span>dup2<span>)</span><span>,</span> <span>&#34;(src: usize, dst: usize)&#34;</span><span>)</span><span>,</span>
    <span>]</span><span>;</span>
    <span>pub</span> <span>fn</span> <span>dup2</span><span>(</span><span>)</span> -&gt; <span>Result</span><span>&lt;</span><span>usize</span><span>&gt;</span> <span>{</span>
        <span>#<span>[</span>cfg<span>(</span>not<span>(</span>all<span>(</span>target_os = <span>&#34;none&#34;</span><span>,</span> feature = <span>&#34;kernel&#34;</span><span>)</span><span>)</span><span>)</span><span>]</span></span>
        <span>return</span> <span>Ok</span><span>(</span><span>0</span><span>)</span><span>;</span>
        <span>#<span>[</span>cfg<span>(</span>all<span>(</span>target_os = <span>&#34;none&#34;</span><span>,</span> feature = <span>&#34;kernel&#34;</span><span>)</span><span>)</span><span>]</span></span>
        <span>{</span>
            <span>let</span> p = <span>Cpus</span><span>::</span><span>myproc</span><span>(</span><span>)</span><span>.</span><span>unwrap</span><span>(</span><span>)</span><span>.</span><span>data_mut</span><span>(</span><span>)</span><span>;</span>
            <span>let</span> src_fd = <span>argraw</span><span>(</span><span>0</span><span>)</span><span>;</span> <span>let</span> dst_fd = <span>argraw</span><span>(</span><span>1</span><span>)</span><span>;</span>
            <span>if</span> src_fd != dst_fd <span>{</span>
                <span>let</span> <span>mut</span> src = p<span>.</span><span>ofile</span><span>.</span><span>get_mut</span><span>(</span>src_fd<span>)</span><span>.</span><span>unwrap</span><span>(</span><span>)</span>
                    <span>.</span><span>take</span><span>(</span><span>)</span><span>.</span><span>unwrap</span><span>(</span><span>)</span><span>;</span>
                src<span>.</span><span>clear_cloexec</span><span>(</span><span>)</span><span>;</span>
                p<span>.</span><span>ofile</span><span>.</span><span>get_mut</span><span>(</span>dst_fd<span>)</span>
                    <span>.</span><span>ok_or</span><span>(</span><span>FileDescriptorTooLarge</span><span>)</span>?<span>.</span><span>replace</span><span>(</span>src<span>)</span><span>;</span>
            <span>}</span>
            <span>Ok</span><span>(</span>dst_fd<span>)</span>
        <span>}</span>
    <span>}</span><span></span>
    </pre></div>
  </li>
  <li>With just these steps, the dup2 system call is implemented in both kernel and
    userland.</li>
</ul>

<p dir="auto">Licensed under either of</p>
<ul dir="auto">
  <li><a href="http://www.apache.org/licenses/LICENSE-2.0" rel="nofollow">Apache License, Version 2.0</a></li>
  <li><a href="http://opensource.org/licenses/MIT" rel="nofollow">MIT license</a></li>
</ul>
<p dir="auto">at your option.</p>

<p dir="auto">octox is inspired by <a href="https://github.com/mit-pdos/xv6-riscv">xv6-riscv</a>.</p>
<p dir="auto">I’m also grateful for the bug reports and discussion about the implementation
  contributed by Takahiro Itazuri and Kuniyuki Iwashima.</p>

<p dir="auto">This is a learning project for me, and I will not be accepting pull requests
  until I consider the implementation complete. However, discussions and advice
  are welcome.</p>
</article>
          </div></div>
  </body>
</html>
