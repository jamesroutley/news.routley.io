<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://int10h.org/blog/2022/06/ibm-5153-color-true-cga-palette/">Original</a>
    <h1>The IBM 5153&#39;s True CGA Palette and Color Output (2022)</h1>
    
    <div id="readability-page-1" class="page"><article>
		
		<div>
			
			

<p>If you used a PC throughout any part of the DOS era, then unless you were the monochrome type, you&#39;re probably familiar with the default set of 16 colors.  CGA represented them as <strong>RGBI</strong>: one bit each for <strong>R</strong>ed, <strong>G</strong>reen, <strong>B</strong>lue and <strong>I</strong>ntensity.  Those were the only colors that (<em>digital</em>) CGA was capable of, but later standards retained them as defaults for text mode and for 4/16-color graphics.</p>

<p>Those later standards mapped them to higher bit-depth RGB, and resulting palette of the 16 CGA colors is what most of us are familiar with.  But is it a good match for the output of IBM&#39;s original CGA monitor, the 5153 Personal Computer Color Display?</p>

<p>If it was, I wouldn&#39;t be typing this up, so let&#39;s find out what the deal is.</p>

<h3 id="the-standard-canonical-cga-palette">The Standard (Canonical) CGA Palette</h3>

<p>This is the common mapping of CGA&#39;s 16 RGBI colors to RGB - it reflects how they&#39;re rendered on practically all post-CGA systems, and by current PC emulators.  The baseline standard these days is 24-bit RGB (8 bits per channel), so the common version has a range of 0..255 for each component, shown here as <a href="https://en.wikipedia.org/wiki/Web_colors#Hex_triplet" target="_blank">hex triplets</a>:</p>

<figure><table>
    <tbody>
        <tr>
            <td>00:</td>
            <td>01:</td>
            <td>02:</td>
            <td>03:</td>
            <td>04:</td>
            <td>05:</td>
            <td>06:</td>
            <td>07:</td>
        </tr>
        <tr>
            <td>08:</td>
            <td>09:</td>
            <td>10:</td>
            <td>11:</td>
            <td>12:</td>
            <td>13:</td>
            <td>14:</td>
            <td>15:</td>
        </tr>
    </tbody>
</table>
<figcaption><p>The &#34;Canonical&#34; RGBI-to-rgb24 CGA palette​</p></figcaption></figure>

<p>The idea is pretty straightforward.  CGA color numbers are 4-bit values: <strong>I</strong>, <strong>R</strong>, <strong>G</strong> and <strong>B</strong> (most to least significant).  This palette assigns a level of <strong>2/3</strong> to the original R,G,B signals, and treats I as additional white, by adding <strong>1/3</strong> to all three channels.  The exception is color #6: CGA modifies it from a dim yellow to brown, using a circuit in the <em>monitor</em> to detect the bit combination &#39;0110&#39; and tone down its G component.  The above palette represents that by cutting the G level from 2/3 to 1/3.</p>

<p>But here&#39;s the catch: this palette doesn&#39;t necessarily reflect the appearance of a CGA monitor like the 5153.  Nothing in the RGBI color model calls for this precise mapping, and IBM&#39;s CGA specs don&#39;t explicitly define one at all.  Rather, it&#39;s derived from how <em>EGA</em> (and VGA) rendered those 16 colors for backward compatibility.</p>

<p>EGA moved from 4-bit RGBI to 6-bit RGB (2 bits per color channel).  Each component could take 4 discrete levels, 0 to 3.  That&#39;s where the canonical CGA palette gets its &#34;0, 1/3, 2/3, 3/3&#34; quantization from: the 16 CGA-derived colors had to be represented by this &#34;rule of thirds&#34;.  VGA took it further to 18-bit RGB (6 bpc), and &#39;truecolor&#39; gave us 24-bit (8 bpc), so the same values were normalized to the higher bit depths.</p>

<p><strong><em>This palette really is canonical</em></strong> - after all, it&#39;s based on IBM&#39;s own method of translating CGA colors to later RGB standards.  But I&#39;ve had my 5153 for a while now, and it&#39;s pretty clear that these colors don&#39;t do a great job of representing its actual CGA output, no matter what the knobs are set to.</p>

<h3 id="a-more-accurate-model">A More Accurate Model?</h3>

<p>A better representation would be difficult without some hard data.  Fortunately an unofficial source exists: electronics engineer and CRT enthusiast <a href="https://www.worldphaco.com/" target="_blank">Dr. Hugo Holden</a> has made some very informative investigations into the IBM 5153&#39;s innards, and one of them involved measuring the voltages that drive the gun amplifiers for each RGBI color.</p>

<p>These levels were measured with the contrast control at the maximum position; see later for why this is important.  Here is the relevant data, reproduced from the original document:</p>

<table>
    <thead>
        <tr>
            <th colspan="10" scope="colgroup"><strong>IBM 5153 CGA Monitor Color Processing</strong></th>
        </tr>
        <tr>
            <td colspan="10"><em>Drive level: Volts peak above black level to gun amplifiers</em></td>
        </tr>
    </thead>
    <tbody>
        <tr>
            <th rowspan="4" scope="rowgroup">Normal:</th>
            <th scope="row">Color Number</th>
            <th scope="col">0</th>
            <th scope="col">1</th>
            <th scope="col">2</th>
            <th scope="col">3</th>
            <th scope="col">4</th>
            <th scope="col">5</th>
            <th scope="col">6</th>
            <th scope="col">7</th>
        </tr>
        <tr>
            <th scope="row">R</th>
            <td>0</td>
            <td>0</td>
            <td>0</td>
            <td>0</td>
            <td>1.00</td>
            <td>1.00</td>
            <td>1.00</td>
            <td>1.00</td>
        </tr>
        <tr>
            <th scope="row">G</th>
            <td>0</td>
            <td>0</td>
            <td>1.00</td>
            <td>1.00</td>
            <td>0</td>
            <td>0</td>
            <td>0.64<span>*</span></td>
            <td>1.00</td>
        </tr>
        <tr>
            <th scope="row">B</th>
            <td>0</td>
            <td>1.00</td>
            <td>0</td>
            <td>1.00</td>
            <td>0</td>
            <td>1.00</td>
            <td>0</td>
            <td>1.00</td>
        </tr>
        <tr>
            <th rowspan="4" scope="rowgroup">Intensified:</th>
            <th scope="row">Color Number</th>
            <th scope="col">8</th>
            <th scope="col">9</th>
            <th scope="col">10</th>
            <th scope="col">11</th>
            <th scope="col">12</th>
            <th scope="col">13</th>
            <th scope="col">14</th>
            <th scope="col">15</th>
        </tr>
        <tr>
            <th scope="row">R</th>
            <td>0.40</td>
            <td>0.40</td>
            <td>0.40</td>
            <td>0.40</td>
            <td>1.12</td>
            <td>1.24</td>
            <td>1.24</td>
            <td>1.30</td>
        </tr>
        <tr>
            <th scope="row">G</th>
            <td>0.40</td>
            <td>0.40</td>
            <td>1.12</td>
            <td>1.24</td>
            <td>0.40</td>
            <td>0.40</td>
            <td>1.24</td>
            <td>1.30</td>
        </tr>
        <tr>
            <th scope="row">B</th>
            <td>0.40</td>
            <td>1.12</td>
            <td>0.40</td>
            <td>1.24</td>
            <td>0.40</td>
            <td>1.24</td>
            <td>0.40</td>
            <td>1.30</td>
        </tr>
    </tbody>
</table>
<p><span>*</span> = level reduced by Q206</p>

<p>These values deviate from what the canonical CGA-to-RGB palette might lead you to expect:</p>

<ol>
<li>There is no quantization of voltage levels to a &#39;rule of thirds&#39; (0, 1/3, 2/3, 1)</li>
<li>For color #6, the &#34;brown fix&#34; (transistor Q206) applies a green reduction of only <em>36%</em>, not 50%</li>
<li>Intensity does <em>not</em> add a uniform value to all three channels</li>
<li>For the intensified colors, the maximum level additionally depends on the <em>count(!)</em> of primary color components
</li>
</ol>

<p>Those are direct consequences of IBM&#39;s circuit design, which Hugo Holden&#39;s referenced write-up explains in much greater detail.  All in all, this gives us a much better starting point if we want to improve our model of the 5153&#39;s color output.</p>

<p>By taking the measured voltage range of 0 to 1.30 (<em>above</em> black level) and normalizing it to the RGB24 range of 0..255, we get this:</p>

<figure><table>
    <tbody>
        <tr>
            <td>00:</td>
            <td>01:</td>
            <td>02:</td>
            <td>03:</td>
            <td>04:</td>
            <td>05:</td>
            <td>06:</td>
            <td>07:</td>
        </tr>
        <tr>
            <td>08:</td>
            <td>09:</td>
            <td>10:</td>
            <td>11:</td>
            <td>12:</td>
            <td>13:</td>
            <td>14:</td>
            <td>15:</td>
        </tr>
    </tbody>
</table>
<figcaption><p>A revised CGA palette for the IBM 5153, based on gun drive level measurements</p></figcaption></figure>

<p>At this point, you might raise an important question:  <strong><em>Hold it!  A linear conversion of voltages to RGB levels?!  Who said you could do that?  What about gamma correction? </em></strong> After all, the transfer function of a CRT is not a linear input-to-output mapping; it&#39;s best approximated by a power law, AKA the <em>gamma function</em>.  The above translation can&#39;t be valid - unless the IBM 5153 CRT has the <em>same</em> gamma function as the display showing our RGB colors (probably not a CRT at all).  And how likely is <em>that</em>?</p>

<p>Pretty likely, actually.  Regardless of display type, virtually all current video systems are standardized for a gamma value of 2.2; for historical reasons this was chosen to reflect the gamma transfer function inherent in cathode ray tube technology.  This value does not vary much across properly adjusted CRT monitors, modulo minor corrections for viewing conditions (the nominal value is somewhere between 2.25 and 2.5).</p>

<p>So although IBM never published a gamma value for the 5153 (to my knowledge), we can make an educated guess that it&#39;s close enough, so this revised palette is <em>more or less</em> valid.  But more importantly, it really is a good match for the 5153&#39;s visible output... as I will attempt to show below.</p>

<h3 id="let-s-compare">Let&#39;s Compare</h3>

<p>Here&#39;s a camera still of the 16 CGA colors as shown on my IBM 5153 (with the contrast knob at the maximum position), right next to our two CGA-to-RGB palettes: the &#39;canonical&#39; one, and the revised one based on Holden&#39;s voltage measurements.</p>

<p>The photo was white-balanced so that color #7 is grey - apparently the color correction isn&#39;t 100% perfect (e.g. green and magenta), but it&#39;s as good as I could get it without introducing other errors.  Aging electronics can affect the voltage bias on the three gun amplifiers and make them drift slightly out of adjustment, so it&#39;s not too unexpected.</p>

<p>The photo is still close enough to the perceptual result when looking at the monitor, so you should be able to judge which palette is more like the real thing:</p>



<p>On first glance the revised palette seems to have one immediate point in its favor: the difference between the normal (0-7) and intensified (8-15) colors.  The revised version has less of a brightness difference between the two groups, quite like in the photo.  But that difference is precisely what the 5153&#39;s contrast knob modifies (see below), so it&#39;s not an independent variable.  Our new palette is simply based on measurements made with that knob at maximum.</p>

<p>On the other hand, there are other aspects which make the revised palette a better match:</p>

<ul>
<li>The greater difference between red (4) and brown (6) - in the canonical palette they&#39;re often hard to distinguish.</li>
<li>The brightness levels aren&#39;t so uniform across the intensified colors.</li>
<li>In particular, there&#39;s more separation between colors 10 and 11, between 12 and 13, and between 14 and 15.
<br/></li>
</ul>

<h3 id="and-let-s-contrast">...And Let&#39;s Contrast</h3>

<p>The 5153 has an interesting little quirk compared to typical CRT monitors.  Its brightness control behaves pretty much as you&#39;d expect, modifying the levels uniformly by applying a fixed DC offset to the video signals.  But the contrast control does something a little more unusual.</p>

<p>Contrast in most CRTs adjusts the amplifier&#39;s static AC gain, to control the <em>difference</em> between black level and maximum brightness across the entire image.  But here, it affects only the non-intensified colors: whenever the intensity signal is high, the contrast pot is effectively bypassed and gain is not attenuated.</p>

<p>In other words, contrast is applied dynamically across the raster depending on the contents of the image.  Turning the knob down makes the normal colors (0-7) dimmer, but the intensified colors (8-15) are completely unaffected:</p>



<p>To simulate this oddity when mapping the RGBI colors to RGB, it&#39;s not enough to apply a static levels adjustment to the entire palette: you&#39;d have to tune the values for colors 0-7 <em>only</em>.  It&#39;s a bit useless to give precise RGB values here because they vary smoothly across the range of the adjustment, but all 3 color components have to be reduced proportionally, to preserve hues.  I say &#34;reduced&#34; because our revised palette has the contrast knob at maximum, so from here you can only go down.</p>

<p>One more thing I&#39;ve noticed is that the contrast control has a subtle effect on color #6 (brown).  At max, it looks close enough to the one in our new palette; but when you start dialing down the contrast, its hue changes slightly and becomes a bit less reddish and more greenish.  This change isn&#39;t sustained: it seems to happen around a specific point a little below maximum contrast, but then it stays like that the rest of the way down.  Could be a quirk of circuitry design coupled with the special treatment of color #6 for chroma correction, or maybe just another little symptom of age.</p>

<h3 id="yes-but-why-does-it-even-matter">Yes, But Why does it Even Matter?</h3>

<p>The benefit here isn&#39;t very obvious - we&#39;re splitting hairs about <em>one particular monitor</em>, and a <em>CGA</em> one at that.  99% of the time, viewers aren&#39;t going to notice or care as long as the palette is kinda-sorta in the ballpark, and even then they&#39;ll probably wish it wasn&#39;t.  So where&#39;s the practical value in all this OCD color nitpicking?</p>

<p>OK then: imagine you&#39;re working on a little project with the IBM 5153 as a possible target.  You&#39;re doing the visuals on your modern PC, so you simulate CGA using the 16 canonical colors.  Now, imagine you&#39;re trying to make a simple color gradient in text mode.  In time-honored ANSI art tradition, you use the half-shade (&#34;▒&#34;) character and tweak the foreground and background colors until it all looks nice and smooth.  But then you check the result on your 5153, and it looks like stripy vomit:</p>

<figure>
    
    <a href="https://int10h.org/blog/img/5153color/gradient.webp" target="_blank">
        <img src="https://int10h.org/blog/img/5153color/gradient.webp" alt="Color gradient comparison"/>
    </a>
    
    <figcaption>
         
    </figcaption>
    
</figure>


<p>Working with the canonical palette (top) leads you to expect a passable color ramp, reducing in brightness from left to right.  But on the 5153, the differences in color relationships mess up the perceptual effect, so you get ugly discontinuities (center).  The <em>revised</em> 5153 palette (bottom) would have shown you something much closer to the real thing; at which point you&#39;d probably want to make a better gradient, but that&#39;s a whole other can of worms.</p>

<p>Even with the revised palette, the RGB rendering still deviates from what we see on the CRT screen.  That&#39;s partly down to the camera settings, but this monitor isn&#39;t quite done with its surprises.</p>

<h3 id="dithering-and-color-mixing-oddities">Dithering and Color Mixing Oddities</h3>

<p>Looking at the idealized RGB rendering vs. the 5153&#39;s actual output, you&#39;ll naturally notice that the real monitor blends pixels gradually in the horizontal direction; there are no sharp edges.  But that&#39;s not all: the dithered &#34;colors&#34; you get with the alternating-dot trick are <strong><em>darker</em></strong> than expected - even though the true, solid colors are not. </p>

<p>If you generate the same color ramp in 80-column mode instead of 40, you increase the resolution from 320 to 640 dots per line.  The smaller dots blend together even more smoothly, so the dither patterns are pretty much invisible.  <em>But the darkening effect is stronger, too</em>:</p>

<figure>
    <a href="https://int10h.org/blog/img/5153color/darken1.webp">
        <img src="https://int10h.org/blog/img/5153color/darken1.webp" alt="Color blending with alternate dot patterns shows a darkening effect: 40 vs. 80 columns"/>
    </a>
    <figcaption><p>5153 color blending with alternate dot patterns shows a darkening effect: 40 vs. 80 columns</p></figcaption>
</figure>

<p>Those blended colors that were darkened in 40-column mode are darker still at 80 columns.  Meanwhile the solid colors are still unaffected.  In the sharp RGB rendering, <em>both resolutions have the same apparent brightness</em> - but on the 5153, finer dithering seems to amplify the darkening effect.</p>

<p>By looking at further examples we can start to discern a certain logic:</p>

<ul>
<li>Colors generated by blending pixels together are darker on the 5153, vs. the simple crisp rendering on a modern display.</li>
<li>Fine patterns (with horizontally-shorter dots) are darkened more than coarse patterns composed of longer dots.</li>
<li>The bigger the difference between the two dot colors, the stronger the darkening effect.
</li>
</ul>

<p>With two different dot-pattern chars (0xB0 ░ <em>and</em> 0xB1 ▒), we can illustrate the effect on pixel sequences of varying lengths:</p>

<figure>
    <a href="https://int10h.org/blog/img/5153color/darken2.webp">
        <img src="https://int10h.org/blog/img/5153color/darken2.webp" alt="5153 color blending using two different characters: 40 vs. 80 columns"/>
    </a>
</figure><p>
­</p>

<p>The cause of all this is most likely the <em>bandwidth</em> of the CRT gun amplifier - which determines how fast it can modulate the voltages at the CRT cathodes.  These voltages control the color being displayed as the beam scans, so the time they take to change defines the sharpness of the horizontal boundaries between pixels, and the maximum resolution that can be clearly displayed.  We can see that the IBM 5153&#39;s video amplifier isn&#39;t terribly high-bandwidth, at least not after all these years, since it has trouble achieving full separation at 640 H-dots (80 columns).</p>

<p>That&#39;s what blurs the dot edges; but why do they also appear <em>darker</em>?  That depends on the gun voltage&#39;s rise and fall times.  If it rises more slowly than it falls, total output for repeated oscillations is reduced.  Or possibly the rise/<wbr/>fall times <strong><em>are</em></strong> equal, and the rising/<wbr/>falling edges have roughly linear slopes; but as the tube&#39;s transfer function <em>isn&#39;t</em> linear (there&#39;s that gamma law again), the actual light emission rises and falls in concave-up curves - which again decreases overall ouptut for the duration.</p>

<p>Since this only occurs when colors actually change between pixels, we can see why shorter dot stretches are darkened to a greater degree, making the effect stronger for finer patterns.  Also: because the bandwidth limitation lengthens rise/<wbr/>fall times for larger voltage deltas, we see why increasing the difference between colors reinforces the effect.</p>

<p>Here are a couple of test patterns I made to see how various color mixtures are affected.  If you compare the 40 and 80 column versions of each screen (say in two browser tabs), you&#39;ll see it:</p>



<p>Maybe this sort of thing simply happens when monitors get old.  I&#39;ve had friends test this on their own 5153s, to verify that mine isn&#39;t just trying to be special, and the results were pretty much the same.  Whether or not they had better resolution when they were new, it&#39;s probably safe enough to expect the average 5153 to be like this today.</p>

<h3 id="tying-it-all-together">Tying it All Together</h3>

<p>If that&#39;s the case, how can we simulate the fuzzy edges <em>and</em> the darkening effect in a plain RGB rendering?</p>

<p>One method that seems to work is applying horizontal motion blur to act as a low-pass filter - but <em>without performing any gamma correction</em>.  In almost any other situation, <a href="https://blog.johnnovak.net/2016/09/21/what-every-coder-should-know-about-gamma/#effects-of-gamma-incorrectness" target="_blank">that&#39;s a paddlin&#39;</a>.  But if my above hunch is correct, we may actually have a good reason to do that here: in the real monitor, the voltage swings are smoothed out at the amps, <em>before</em> the tube de-linearizes the color space.  By blending pixel values as if they were linear and displaying them as sRGB, we simulate just that.</p>

<p>By massaging the above examples this way, we get:</p>

<figure>
    <a href="https://int10h.org/blog/img/5153color/blend1.webp">
        <img src="https://int10h.org/blog/img/5153color/blend1.webp" alt="Color gradient (w/RGB blended version): 40 vs. 80 columns"/>
    </a>
</figure><p>
­</p>

<figure>
    <a href="https://int10h.org/blog/img/5153color/blend2.webp">
        <img src="https://int10h.org/blog/img/5153color/blend2.webp" alt="Color blending using two different characters (w/RGB blended version): 40 vs. 80 columns"/>
    </a>
</figure><p>
­</p>



<p>Ahhh, much better! <small><em>(Duke Nukem voice and flushing water sound are optional.)</em></small>  There are still a few mismatches, but honestly if I consider all the factors that could (and probably did) introduce errors between the 5153&#39;s video circuits and the photos on my PC, even getting somewhat close at all is satisfying enough.  This gives me a pretty good indication of what a given image will look like on the 5153, and that&#39;s better than none at all.</p>

<h3 id="what-about-other-cga-monitors">What About Other CGA Monitors?</h3>

<p>This bears repeating: all of this really only applies to the IBM 5153.  Since nothing about CGA&#39;s specifications mandates this exact interpretation of the RGBI signals, other CGA CRTs don&#39;t necessarily follow it all that closely, especially with those special little twists (brown, intensity, contrast).  In reality, some of them <em>are</em> different enough.  Let&#39;s start with IBM&#39;s other CGA-<wbr/>capable monitors:</p>

<ul>
<li><p><span>5154 Enhanced Color Display:</span> this is the original EGA monitor, and as already noted, EGA gave us the &#34;canonical&#34; CGA palette by adapting those 16 colors to its 6-<wbr/>bit RGB color model.  However the 5154 can also handle RGBI video directly, either from a CGA card or from EGA in 200-line (15.7 KHz) mode.</p></li>

<li><p><span>4863 PCjr Color Display:</span> this was manufactured by Mitsubishi, not by Tatung like the 5153, and the one <a href="https://forum.vcfed.org/index.php?threads/ibm-4863-pcjr-monitor-power-supply-schematic.1225242/#post-1225823" target="_blank">schematic</a> I can find makes it look rather different internally (too bad it&#39;s not very readable).  Although I don&#39;t own this one, enough photos exist to show that the brown color behaves about the same as on the 5153, but I can&#39;t be sure about the rest.</p></li>

<li><p><span>5515 12&#34; Color Display (for the IBM JX):</span> photos of this one tell us that there&#39;s no brown as such, and color #6 is clearly shown as dark yellow, so evidently it doesn&#39;t have the &#34;chroma correction&#34; circuitry.  You can see three of these at the top <a href="http://www.thepcmuseum.com/ibmjx/" target="_blank">here</a>.  That&#39;s the third variation (at least!) on the CGA color set just from IBM themselves.</p></li>

<li><p>There&#39;s also the <span>5145 PC Convertible Color Display</span>, from a different manufacturer yet again, this time in Korea (probably Samsung, which also made the 5154).  But this one seems to be the rarest of IBM&#39;s consumer-market CGA CRTs, and info/<wbr/>schematics/<wbr/>photos are just as scarce.</p></li>
</ul>

<p>As for non-IBM ones, they&#39;re all over the place - I have a later Samsung/Samtron monitor where brown is extremely close to red, and others have said the same about Tandy models; Philips/<wbr/>Commodore 1084s with CGA support seem to have a 5153-like brown, but intensity looks a little different.  Third-party vendors were offering digital CGA monitors before IBM even introduced its own in 1983, and <em>they</em> didn&#39;t even have the 5153 as a reference.</p>

<p>Moral of the story: there&#39;s no such thing as the One True CGA-to-RGB Palette, not when the guys who invented the standard couldn&#39;t decide on one.  The canonical mapping isn&#39;t a particularly bad model for &#34;generic&#34; CGA displays, but to represent the output of a particular monitor, you have to pay attention to its characteristics.  The revised 5153 palette (and other tweaks described here) seem to do the trick for this one.</p>


		</div>
		

	</article></div>
  </body>
</html>
