<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/antonblanchard/microwatt">Original</a>
    <h1>Microwatt: A tiny Open POWER ISA softcore written in VHDL 2008</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><p dir="auto">
<a target="_blank" rel="noopener noreferrer" href="https://riskmusings.substack.com/antonblanchard/microwatt/blob/master/media/microwatt-title.png"><img src="https://riskmusings.substack.com/antonblanchard/microwatt/raw/master/media/microwatt-title.png" alt="Microwatt"/></a>
</p>

<p dir="auto">A tiny Open POWER ISA softcore written in VHDL 2008. It aims to be simple and easy
to understand.</p>
<h2 tabindex="-1" id="user-content-simulation-using-ghdl" dir="auto"><a href="#simulation-using-ghdl">Simulation using ghdl<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">
<a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/fef790b5fc71f2acb41496a07b7cfac962e67b994bb8a3a9b821fd27be3009ce/687474703a2f2f6e65756c696e672e6f72672f6d6963726f776174742d6d6963726f707974686f6e2e676966"><img src="https://camo.githubusercontent.com/fef790b5fc71f2acb41496a07b7cfac962e67b994bb8a3a9b821fd27be3009ce/687474703a2f2f6e65756c696e672e6f72672f6d6963726f776174742d6d6963726f707974686f6e2e676966" alt="MicroPython running on Microwatt" data-animated-image="" data-canonical-src="http://neuling.org/microwatt-micropython.gif"/></a>
</p>
<p dir="auto">You can try out Microwatt/Micropython without hardware by using the ghdl simulator. If you want to build directly for a hardware target board, see below.</p>
<ul dir="auto">
<li>Build micropython. If you aren&#39;t building on a ppc64le box you
will need a cross compiler. If it isn&#39;t available on your distro
grab the powerpc64le-power8 toolchain from <a href="https://toolchains.bootlin.com" rel="nofollow">https://toolchains.bootlin.com</a>.
You may need to set the CROSS_COMPILE environment variable
to the prefix used for your cross compilers.  The default is
powerpc64le-linux-gnu-.</li>
</ul>
<div data-snippet-clipboard-copy-content="git clone https://github.com/micropython/micropython.git
cd micropython
cd ports/powerpc
make -j$(nproc)
cd ../../../"><pre><code>git clone https://github.com/micropython/micropython.git
cd micropython
cd ports/powerpc
make -j$(nproc)
cd ../../../
</code></pre></div>
<p dir="auto">A prebuilt micropython image is also available in the micropython/ directory.</p>
<ul dir="auto">
<li>
<p dir="auto">Microwatt uses ghdl for simulation. Either install this from your
distro or build it. Microwatt requires ghdl to be built with the LLVM
or gcc backend, which not all distros do (Fedora does, Debian/Ubuntu
appears not to). ghdl with the LLVM backend is likely easier to build.</p>
<p dir="auto">If building ghdl from scratch is too much for you, the microwatt Makefile
supports using Docker or Podman.</p>
</li>
<li>
<p dir="auto">Next build microwatt:</p>
</li>
</ul>
<div data-snippet-clipboard-copy-content="git clone https://github.com/antonblanchard/microwatt
cd microwatt
make"><pre><code>git clone https://github.com/antonblanchard/microwatt
cd microwatt
make
</code></pre></div>
<p dir="auto">To build using Docker:</p>

<p dir="auto">and to build using Podman:</p>

<ul dir="auto">
<li>Link in the micropython image:</li>
</ul>
<div data-snippet-clipboard-copy-content="ln -s ../micropython/ports/powerpc/build/firmware.bin main_ram.bin"><pre><code>ln -s ../micropython/ports/powerpc/build/firmware.bin main_ram.bin
</code></pre></div>
<p dir="auto">Or if you were using the pre-built image:</p>
<div data-snippet-clipboard-copy-content="ln -s micropython/firmware.bin main_ram.bin"><pre><code>ln -s micropython/firmware.bin main_ram.bin
</code></pre></div>
<ul dir="auto">
<li>Now run microwatt, sending debug output to /dev/null:</li>
</ul>

<h2 tabindex="-1" id="user-content-synthesis-on-xilinx-fpgas-using-vivado" dir="auto"><a href="#synthesis-on-xilinx-fpgas-using-vivado">Synthesis on Xilinx FPGAs using Vivado<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<ul dir="auto">
<li>
<p dir="auto">Install Vivado (I&#39;m using the free 2019.1 webpack edition).</p>
</li>
<li>
<p dir="auto">Setup Vivado paths:</p>
</li>
</ul>
<div data-snippet-clipboard-copy-content="source /opt/Xilinx/Vivado/2019.1/settings64.sh"><pre><code>source /opt/Xilinx/Vivado/2019.1/settings64.sh
</code></pre></div>
<ul dir="auto">
<li>Install FuseSoC:</li>
</ul>
<div data-snippet-clipboard-copy-content="pip3 install --user -U fusesoc"><pre><code>pip3 install --user -U fusesoc
</code></pre></div>
<p dir="auto">Fedora users can get FuseSoC package via</p>
<div data-snippet-clipboard-copy-content="sudo dnf copr enable sharkcz/danny
sudo dnf install fusesoc"><pre><code>sudo dnf copr enable sharkcz/danny
sudo dnf install fusesoc
</code></pre></div>
<ul dir="auto">
<li>If this is your first time using fusesoc, initialize fusesoc.
This is needed to be able to pull down fussoc library components referenced
by microwatt. Run</li>
</ul>
<div data-snippet-clipboard-copy-content="fusesoc init
fusesoc fetch uart16550
fusesoc library add microwatt /path/to/microwatt"><pre><code>fusesoc init
fusesoc fetch uart16550
fusesoc library add microwatt /path/to/microwatt
</code></pre></div>
<ul dir="auto">
<li>Build using FuseSoC. For hello world (Replace nexys_video with your FPGA board such as --target=arty_a7-100):
You may wish to ensure you have <a href="https://reference.digilentinc.com/vivado/installing-vivado/start#installing_digilent_board_files" rel="nofollow">installed Digilent Board files</a>
or appropriate files for your board first.</li>
</ul>
<div data-snippet-clipboard-copy-content="fusesoc run --target=nexys_video microwatt --memory_size=16384 --ram_init_file=/path/to/microwatt/fpga/hello_world.hex"><pre><code>fusesoc run --target=nexys_video microwatt --memory_size=16384 --ram_init_file=/path/to/microwatt/fpga/hello_world.hex
</code></pre></div>
<p dir="auto">You should then be able to see output via the serial port of the board (/dev/ttyUSB1, 115200 for example assuming standard clock speeds). There is a know bug where initial output may not be sent - try the reset (not programming button) on your board if you don&#39;t see anything.</p>
<ul dir="auto">
<li>To build micropython (currently requires 1MB of BRAM eg an Artix-7 A200):</li>
</ul>
<div data-snippet-clipboard-copy-content="fusesoc run --target=nexys_video microwatt"><pre><code>fusesoc run --target=nexys_video microwatt
</code></pre></div>
<h2 tabindex="-1" id="user-content-linux-on-microwatt" dir="auto"><a href="#linux-on-microwatt">Linux on Microwatt<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">Mainline Linux supports Microwatt as of v5.14. The Arty A7 is the best tested
platform, but it&#39;s also been tested on the OrangeCrab and ButterStick.</p>
<ol dir="auto">
<li>
<p dir="auto">Use buildroot to create a userspace</p>
<p dir="auto">A small change is required to glibc in order to support the VMX/AltiVec-less
Microwatt, as float128 support is mandiatory and for this in GCC requires
VSX/AltiVec. This change is included in Joel&#39;s buildroot fork, along with a
defconfig:</p>
<div data-snippet-clipboard-copy-content="git clone -b microwatt https://github.com/shenki/buildroot
cd buildroot
make ppc64le_microwatt_defconfig
make"><pre><code>git clone -b microwatt https://github.com/shenki/buildroot
cd buildroot
make ppc64le_microwatt_defconfig
make
</code></pre></div>
<p dir="auto">The output is <code>output/images/rootfs.cpio</code>.</p>
</li>
<li>
<p dir="auto">Build the Linux kernel</p>
<div data-snippet-clipboard-copy-content="git clone https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
cd linux
make ARCH=powerpc microwatt_defconfig
make ARCH=powerpc CROSS_COMPILE=powerpc64le-linux-gnu- \
  CONFIG_INITRAMFS_SOURCE=/buildroot/output/images/rootfs.cpio -j`nproc`"><pre><code>git clone https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
cd linux
make ARCH=powerpc microwatt_defconfig
make ARCH=powerpc CROSS_COMPILE=powerpc64le-linux-gnu- \
  CONFIG_INITRAMFS_SOURCE=/buildroot/output/images/rootfs.cpio -j`nproc`
</code></pre></div>
<p dir="auto">The output is <code>arch/powerpc/boot/dtbImage.microwatt.elf</code>.</p>
</li>
<li>
<p dir="auto">Build gateware using FuseSoC</p>
<p dir="auto">First configure FuseSoC as above.</p>
<div data-snippet-clipboard-copy-content="fusesoc run --build --target=arty_a7-100 microwatt --no_bram --memory_size=0"><pre><code>fusesoc run --build --target=arty_a7-100 microwatt --no_bram --memory_size=0
</code></pre></div>
<p dir="auto">The output is <code>build/microwatt_0/arty_a7-100-vivado/microwatt_0.bit</code>.</p>
</li>
<li>
<p dir="auto">Program the flash</p>
<p dir="auto">This operation will overwrite the contents of your flash.</p>
<p dir="auto">For the Arty A7 A100, set <code>FLASH_ADDRESS</code> to <code>0x400000</code> and pass <code>-f a100</code>.</p>
<p dir="auto">For the Arty A7 A35, set <code>FLASH_ADDRESS</code> to <code>0x300000</code> and pass <code>-f a35</code>.</p>
<div data-snippet-clipboard-copy-content="microwatt/openocd/flash-arty -f a100 build/microwatt_0/arty_a7-100-vivado/microwatt_0.bit
microwatt/openocd/flash-arty -f a100 dtbImage.microwatt.elf -t bin -a $FLASH_ADDRESS"><pre><code>microwatt/openocd/flash-arty -f a100 build/microwatt_0/arty_a7-100-vivado/microwatt_0.bit
microwatt/openocd/flash-arty -f a100 dtbImage.microwatt.elf -t bin -a $FLASH_ADDRESS
</code></pre></div>
</li>
<li>
<p dir="auto">Connect to the second USB TTY device exposed by the FPGA</p>

<p dir="auto">The gateware has firmware that will look at <code>FLASH_ADDRESS</code> and attempt to
parse an ELF there, loading it to the address specified in the ELF header
and jumping to it.</p>
</li>
</ol>
<h2 tabindex="-1" id="user-content-testing" dir="auto"><a href="#testing">Testing<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<ul dir="auto">
<li>A simple test suite containing random execution test cases and a couple of
micropython test cases can be run with:</li>
</ul>

<h2 tabindex="-1" id="user-content-issues" dir="auto"><a href="#issues">Issues<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<ul dir="auto">
<li>There are a few instructions still to be implemented:
<ul dir="auto">
<li>Vector/VMX/VSX</li>
</ul>
</li>
</ul>
</article>
          </div></div>
  </body>
</html>
