<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://j3s.sh/thought/my-deployment-platform-is-a-shell-script.html">Original</a>
    <h1>My deployment platform is a shell script</h1>
    
    <div id="readability-page-1" class="page"><div>
  <p><small><a href="https://j3s.sh/thoughts.html">â†µreturn</a></small>
  </p><p>my deployment platform is a shell script</p>
  <p><b>
    <img height="30" src="https://j3s.sh/static/unnamed-puffy.png" alt="another pufferfish drawn by rekka"/>
  </b>
</p></div>
<p>my deployment platform is a shell script
2024-04-09

like many people, i fell in love with free software
because i could install it. i&#39;d come home from work and
install a bunch of software.

what fun! tee hee! a playground and i&#39;m the prince!

but eventually, relentlessly, it all starts to feel more
like a horror show.

proxmox needs an upgrade! *SPOOKY WIND*
how the fuck does k8s work again?? *SPOOKY CRICKETS*
promql *EXISTENTIAL SCREAM*


i&#39;m too old now - i&#39;m more fickle with my time. i like
things that work for years with as little interaction
from me as possible.

when it comes to my own projects, i always prioritize
maintainability.

to that end, i built a little deployment system that i
run on a single virtual machine - it&#39;s a shell script!

i run it every minute via cron.

here&#39;s the script, in its entirety:

  #!/bin/sh

  println() {
    printf &#34;%s\n&#34; &#34;$1&#34; &gt;&gt; /root/gocicd.log
  }

  die() {
    printf &#34;%s\n&#34; &#34;$1&#34; &gt;&gt; /root/gocicd.log
    exit 1
  }

  cd /root
  for project in $(ls go-cicd); do
    cd &#34;/root/go-cicd/$project&#34; 2&gt;&amp;1 &gt;&gt; /root/gocicd.log
    git fetch origin 2&gt;&amp;1 &gt;&gt; /root/gocicd.log
    if git status | grep -q behind; then
      println &#34;$(date): building $project&#34;
      git merge origin/main ||
        git merge origin/master ||
	  die &#34;could not merge $project&#34;
      go build ||
        die &#34;could not build $project&#34;
      mv &#34;$project&#34; &#34;/usr/local/bin/$project&#34;
      cat &lt;&lt;EOF &gt;/etc/init.d/$project&#34;
      #!/sbin/openrc-run

      supervisor=&#34;supervise-daemon&#34;
      command=&#34;/usr/local/bin/$project&#34;
      directory=&#34;/root/go-cicd/$project&#34;
      EOF
      service &#34;$project&#34; restart
    fi
  done

whenever i make an upstream change to any of my tracked
projects, it is cloned, built, and running within 60
seconds.

this gives me a lot of joy. the blog post you&#39;re reading
right now was deployed using this system (j3s.sh is a go
application).

this has worked for many years with no maintenance at
all!

my script will never:
  - go down
  - require an upgrade
  - force me to migrate
  - surprise me
  - keep me up at night

all of this makes jes very happy.


digging in a little, the contents of the go-cicd dir look like this:

  $ ls go-cicd/
  existentialcrisis.sh  jackal                nekobot
  j3s.sh                vore                  neoarkbot

these are all of my &#34;tracked projects&#34;.

to start tracking a new project, i only need to clone a
repository:

  $ cd go-cicd
  $ git clone git.j3s.sh/newproject

now whenever a new commit is made to
git.j3s.sh/newproject, it is deployed within 60 seconds.

ez.

here&#39;s a little taste of the log file:

  $ tail -n 5 go-cicd.log
  Thu Feb  8 00:13:12 UTC 2024: building vore
  Fri Feb  9 22:08:25 UTC 2024: building vore
  Mon Apr  8 02:07:00 UTC 2024: building j3s.sh
  Mon Apr  8 02:59:00 UTC 2024: building j3s.sh
  Tue Apr  9 21:11:00 UTC 2024: building vore

cool! i wonder what happened in march.
(oh, i moved to Virginia, right)


i recognize that this script is pretty limited. it can
only deploy golang applications to my alpine system, but
that&#39;s exactly the point i&#39;m trying to prove:

a little, specific solution might be  easier to maintain
and straight up more enjoyable than a larger, more
general system.

i spent maybe 10 minutes writing this script in December
of 2021, and i&#39;m proud of how reliable it has been.

consider keeping your little things little.

it worked for little old me.


until next time, with love from virginia,


  lil jes

</p><p>follow me on <a href="https://merveilles.town/@j3s">mastodon!</a>
</p><p>last updated 2024-04-09T00:00:00.000Z

</p></div>
  </body>
</html>
