<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://engineering.fb.com/2022/07/25/production-engineering/its-time-to-leave-the-leap-second-in-the-past/">Original</a>
    <h1>It’s time to leave the leap second in the past</h1>
    
    <div id="readability-page-1" class="page"><div>

		<p><span>The leap second concept was first introduced in 1972 by the </span><a href="https://en.wikipedia.org/wiki/International_Earth_Rotation_and_Reference_Systems_Service" target="_blank" rel="noopener"><span>International Earth Rotation and Reference Systems Service</span></a><span> (IERS) in an attempt to periodically update </span><a href="https://en.wikipedia.org/wiki/Coordinated_Universal_Time" target="_blank" rel="noopener"><span>Coordinated Universal Time</span></a><span> (UTC) due to imprecise </span><a href="https://en.wikipedia.org/wiki/Solar_time#Mean_solar_time" target="_blank" rel="noopener"><span>observed solar time</span></a><span> (</span><span>UT1</span><span>) and the long-term </span><a href="https://en.wikipedia.org/wiki/%CE%94T_(timekeeping)" target="_blank" rel="noopener"><span>slowdown in the Earth’s rotation</span></a><span>. This periodic adjustment mainly benefits scientists and astronomers as it allows them to observe celestial bodies using UTC for most purposes. If there were no UTC correction, then adjustments would have to be made to the legacy equipment and software that synchronize to UTC for astronomical observations.</span></p>
<p><span>As of today, since the introduction of the leap second, UTC has been updated 27 times.</span></p>
<p><span>While the leap second might have been an acceptable solution in 1972, when it made both the scientific community and the telecom industry happy, these days UTC is equally bad for both digital applications and scientists, who often choose TAI or UT1 instead.</span></p>
<p><span>At Meta, we’re supporting an industry effort to stop future introductions of leap seconds and stay at a current level of 27. Introducing new leap seconds is a risky practice that does more harm than good, and we believe it is time to introduce new technologies to replace it.</span></p>
<p><img src="https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_02-1.jpg?w=1024" alt="" width="1024" height="576" srcset="https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_02-1.jpg 1920w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_02-1.jpg?resize=580,326 580w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_02-1.jpg?resize=916,515 916w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_02-1.jpg?resize=768,432 768w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_02-1.jpg?resize=1024,576 1024w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_02-1.jpg?resize=1536,864 1536w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_02-1.jpg?resize=96,54 96w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_02-1.jpg?resize=192,108 192w" sizes="(max-width: 992px) 100vw, 62vw"/></p>
<h2><span>Leap of faith</span></h2>
<p><span>One of many contributing factors to irregularities in the Earth’s rotation is the constant melting and refreezing of ice caps on the world’s tallest mountains. This phenomenon can be simply visualized by thinking about a spinning figure skater, who manages angular velocity by controlling their arms and hands. As they spread their arms the angular velocity decreases, preserving the skater’s momentum. As soon as the skater tucks their arms back in the angular velocity increases.</span></p>
<figure id="attachment_19075" aria-describedby="caption-attachment-19075"><img loading="lazy" src="https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Hero-3.gif?w=1024" alt="" width="1024" height="576"/><figcaption id="caption-attachment-19075">To visualize angular velocity change, think of a spinning figure skater.</figcaption></figure>
<p><span>So far, only positive leap seconds have been added. In the early days, this was done by simply adding an extra second, resulting in an unusual timestamp:</span></p>
<p><span>23:59:59 -&gt; 23:59:60 -&gt; 00:00:00</span></p>
<p><span>At best, such a time jump crashed programs or even corrupted data, due to weird timestamps in the data storage.</span></p>
<p><span>With the Earth’s rotation pattern changing, it’s very likely that we will get a negative leap second at some point in the future. The timestamp will then look like this:</span></p>
<p><span>23:59:58 -&gt; 00:00:00</span></p>
<p><span>The impact of a negative leap second has never been tested on a large scale; it could have a devastating effect on the software relying on timers or schedulers.</span></p>
<p><span>In any case, every leap second is a major source of pain for people who manage hardware infrastructures.</span></p>
<h2><span>Smearing</span></h2>
<p><span>More recently, it has become a common practice to “smear” a leap second by simply slowing down or speeding up the clock. There is no universal way to do this, but at Meta we smear the leap second throughout 17 hours, starting at 00:00:00 UTC </span><a href="https://engineering.fb.com/2020/03/18/production-engineering/ntp-service/" target="_blank" rel="noopener"><span>based on the time zone data (tzdata) package content</span></a><span>.</span></p>
<figure id="attachment_19056" aria-describedby="caption-attachment-19056"><img loading="lazy" src="https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_04.jpg?w=1024" alt="leap second" width="1024" height="576" srcset="https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_04.jpg 1920w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_04.jpg?resize=580,326 580w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_04.jpg?resize=916,515 916w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_04.jpg?resize=768,432 768w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_04.jpg?resize=1024,576 1024w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_04.jpg?resize=1536,864 1536w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_04.jpg?resize=96,54 96w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_04.jpg?resize=192,108 192w" sizes="(max-width: 992px) 100vw, 62vw"/><figcaption id="caption-attachment-19056">Leap second smearing at Meta.</figcaption></figure>
<p><span>Let’s break this down a bit.</span></p>
<p><span>We chose a 17-hour duration primarily because smearing is happening on Stratum 2, where hundreds of </span><a href="https://engineering.fb.com/2020/03/18/production-engineering/ntp-service/"><span>NTP</span></a><span> servers perform smearing at the same time. To ensure that the difference between them is tolerable, the steps must be minimal. If the smearing steps are too big, NTP clients may consider some devices faulty and exclude them from quorum, which may lead to an outage.</span></p>
<p><span>The starting point at 00:00:00 UTC is also not standardized, and there are many possible options. For example, some companies begin smearing at 12:00:00 UTC the day before and throughout 24 hours; some do so two hours before the event, and others right at the edge.</span></p>
<p><span>There are also different algorithms on the smearing itself. There is a kernel leap second correction, linear smearing (when equal steps are applied), cosine, and quadratic (which Meta uses). The algorithms are based on different mathematical models and produce different offset graphs:</span></p>
<figure id="attachment_19109" aria-describedby="caption-attachment-19109"><img loading="lazy" src="https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_03-1.jpg?w=1024" alt="leap second" width="1024" height="576" srcset="https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_03-1.jpg 1920w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_03-1.jpg?resize=580,326 580w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_03-1.jpg?resize=916,515 916w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_03-1.jpg?resize=768,432 768w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_03-1.jpg?resize=1024,576 1024w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_03-1.jpg?resize=1536,864 1536w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_03-1.jpg?resize=96,54 96w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_03-1.jpg?resize=192,108 192w" sizes="(max-width: 992px) 100vw, 62vw"/><figcaption id="caption-attachment-19109">Kernel leap second smearing with NTPD</figcaption></figure>
<p><span>The source of the leap indicator differs between GNSS constellations (e.g., GPS, GLONASS, Galileo, and BeiDou). In some cases, it is broadcast by satellites several hours in advance. In other cases, time is propagated in UTC with the leap already applied. In different constellations, the leap second value differs depending on when it was launched.</span></p>
<figure id="attachment_19098" aria-describedby="caption-attachment-19098"><img loading="lazy" src="https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_05-2.jpg?w=1024" alt="leap second" width="1024" height="576" srcset="https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_05-2.jpg 1920w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_05-2.jpg?resize=580,326 580w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_05-2.jpg?resize=916,515 916w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_05-2.jpg?resize=768,432 768w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_05-2.jpg?resize=1024,576 1024w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_05-2.jpg?resize=1536,864 1536w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_05-2.jpg?resize=96,54 96w, https://engineering.fb.com/wp-content/uploads/2022/07/CD22_475-Eng-Blog-Metas-Position-on-the-Leap-Second_Visual_05-2.jpg?resize=192,108 192w" sizes="(max-width: 992px) 100vw, 62vw"/><figcaption id="caption-attachment-19098">Difference in leap second values between GNSS constellations.</figcaption></figure>
<p><span>All of this requires the nontrivial conversion logic inside of the time sources, including our very own </span><a href="https://engineering.fb.com/2021/08/11/open-source/time-appliance/" target="_blank" rel="noopener"><span>Time Appliance</span></a><span>. Loss of a GNSS signal during such a sensitive time may lead to a loss of a leap indicator and a split-brain situation, which could lead to an outage.</span></p>
<p><span>The leap event is also propagated via tzdata package months in advance, and for ntpd fans, via a </span><a href="https://www.ietf.org/timezones/data/leap-seconds.list" target="_blank" rel="noopener"><span>leap second file</span></a><span> distributed through the Internet Engineering Taskforce (IETF) website. Not having a fresh copy of the file may lead to forgetting about a leap second and causing an outage.</span></p>
<p><span>As already mentioned, the smearing is a very sensitive moment. If the NTP server is restarted during this period, we will likely end up with either “old” or “new” time, which may propagate to the clients and lead to an outage.</span></p>
<p><span>Because of such ambiguities, public NTP pools don’t do smearing, sometimes passing a leap indicator to the clients to figure this out. SNTP clients usually end up stepping the clock and dealing with the consequences described earlier. Smarter clients may choose a default strategy to smear the leap locally. All in all, this means big players like Meta, who perform smearing on public services, can’t join the public pools.</span></p>
<p><span>And even after the leap event, things are still at risk. NTP software needs to constantly apply offset compared to the source of time it’s using (GNSS, TAI, or Atomic Clock), and PTP software needs to propagate a so-called UTC offset flag in the announce messages. </span></p>
<h2><span>The negative impact of leap seconds</span></h2>
<p><span>The leap second and the offset it creates cause issues all over the industry. One of the simplest ways to cause an outage is to bake in an assumption of time always going forward. Say we have a code like this:</span></p>
<p><span>start := time.Now()</span></p>
<p><span>// do something</span></p>
<p><span>spent := time.Now().Sub(start)</span></p>
<p><span>Depending on how </span><span>spent</span><span> is used, we may end up in a situation relying on a negative value during a leap second event. Such assumptions have caused numerous outages, and there are plenty of articles that describe these cases.</span></p>
<p><span>Back in 2012, Reddit </span><a href="https://www.wired.com/2012/07/leap-second-glitch-explained/"><span>experienced</span></a><span> a massive outage because of a leap second; the site was inaccessible for 30 to 40 minutes. This happened when the time change confused the high-resolution timer (hrtimer), sparking hyperactivity on the servers, which locked up the machines’ CPUs.</span></p>
<p><span>In 2017, Cloudflare posted a very </span><a href="https://blog.cloudflare.com/how-and-why-the-leap-second-affected-cloudflare-dns/"><span>detailed article</span></a><span> about the impact of a leap second on the company’s public DNS. The root cause of the bug that affected their DNS service was the belief that time cannot go backward. The code took the upstream time values and fed them to Go’s rand.Int63n() function. The rand.Int63n() function promptly panicked because the argument was negative, which caused the DNS server to fail.</span></p>
<h2><span>Moving beyond the leap second</span></h2>
<p><span>Leap second events have caused issues across the industry and continue to present many risks. As an industry, we bump into problems whenever a leap second is introduced. And because it’s such a rare event, it devastates the community every time it happens. With a growing demand for clock precision across all industries, the leap second is now causing more damage than good, resulting in disturbances and outages.</span></p>
<p><span>As engineers at Meta, we are supporting a larger community push to stop the future introduction of leap seconds and remain at the current level of 27, which we believe will be enough for the next millennium.</span></p>

		
	</div></div>
  </body>
</html>
