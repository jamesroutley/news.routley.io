<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://aartaka.me/lisp-indent.html">Original</a>
    <h1>All Lisp indentation schemes are ugly</h1>
    
    <div id="readability-page-1" class="page"><div>

<a href="https://jamiepalatnik.com/day-9-python-skills-accelerator/about.html">By Artyom Bologov</a>

<picture>
<source srcset="assets/lisp-indent-dark.png" media="screen and (prefers-color-scheme: dark)"/>
<img src="https://jamiepalatnik.com/day-9-python-skills-accelerator/assets/lisp-indent.png" dark="assets/lisp-indent-dark.png" alt="Pinky beige thumbnail with &#39;UGLY LISP INDENT&#39; in huge letters.     Every word is indented with a return char &#39;⮑&#39;.     In the right top corner, &#39;Artyom aartaka.me Bologov&#39; is written in likewise indented way."/>
</picture>

<p>
Once you get used to Lisp, you stop noticing the parentheses and rely on indentation instead.
That&#39;s partially why there are several alternative syntaxes based solely on indentation.
<a href="https://jamiepalatnik.com/day-9-python-skills-accelerator/wisp.html">Like Wisp</a>,
<a href="https://srfi.schemers.org/srfi-110">or sweet expressions</a>.
But then, the question stands: how to indent the code, actually?
Especially so—in Lispy syntax.

</p><section id="no-indent"><h2><a href="#no-indent">No Indent: One Can Only Go So Far</a></h2>

<p>
A solution that will likely satisfy a proponent of any indentation style:
&#34;Just put it all on one line lol.&#34;
Of course, lines are not infinitely readable and there&#39;s a column cap,
(whether natural or enforced.)
So this line (adapted from
<a href="https://github.com/aartaka/cl-blc">cl-blc</a>,)
while devoid of indentation problems, is unreadable:

</p><figure><pre lang="lisp">(list (tree-transform-if predicate transformer (first tree) depth) (tree-transform-if predicate transformer (second tree) depth))
</pre><figcaption>Absurdly long line of a Lisp code</figcaption></figure>

<p>
That&#39;s the problem statement: some forms need multiple lines and indentation.
But what kind of indentation?

</p></section> <section id="function-indent"><h2><a href="#function-indent">(Dis)Functional Aligned Indent</a></h2>

<p>
There&#39;s an established style of indentation: align the function arguments on the same column:

</p><figure><pre lang="lisp">(list (tree-transform-if predicate transformer (first tree) depth)
      (tree-transform-if predicate transformer (second tree) depth))
(inc! d (/ (* (mtx:get x i k)
              (mtx:get x j k))
           (1+ (* (vec:get dl l)
                  (vec:get eval k)))))
(let ((s (if (&lt; j i) j i))
      (l (if (&lt; j i) i j)))
  (+ (* s 1/2 (- (* 2 d-size) (1+ s)))
     l
     (- s)))
</pre><figcaption>Examples of function-like indentation</figcaption></figure>

<p>
This style if useful in reflecting the code structure: just look at what&#39;s indented and what&#39;s outdented.
It works especially well for short function/macro/form names, like <code>+</code> or <code>vec:get</code>.
Not so well for long ones:

</p><figure><pre lang="lisp">(tree-transform-if predicate
                   transformer
                   (second tree)
                   depth)
</pre><figcaption>A problematic function indentation</figcaption></figure>

<p>
Nineteen!
Nineteen spaces of indentation!
It&#39;s getting unruly.
Such an indent, when used in deeply nested code, makes it too wide and unreadable.
If you add the strict one-per-line alignment of arguments, it&#39;s also painfully long line-wise.
Let&#39;s handle the verticality first:

</p></section><section id="filling-indent"><h2><a href="#filling-indent">Space-filling Indent</a></h2>

<p>
No sane Lisper would write a <code>loop</code> with every keyword on its own line:

</p><figure><pre lang="lisp">(loop for
      i
      below
      10
      collect
      i)
</pre><figcaption>Ugly loop</figcaption></figure>

<p>
(Some pretty-printers do that too (I&#39;m looking at you, ECL!), but that&#39;s a topic for another day.)

</p><p>
We don&#39;t have to put every argument on its own line.
That&#39;s the intuition behind the space-filling indent:

</p><figure><pre lang="lisp">(loop for i below 10
      collect i)
</pre><figcaption>Less ugly loop</figcaption></figure>

<p>
One can go as far as splitting the argument list in arbitrary places.
Regardless of semantics.
(Looking at you, SBCL!)
Putting some keyword arguments on the first line, and then some on the second/third/etc.
This utilizes the space efficiently enough to be used.
But what if one&#39;s stuck really deep in nesting levels?

</p></section><section id="macro-indent"><h2><a href="#macro-indent">Sick Macro Indent</a></h2>

<p>
Now what I&#39;m about to suggest is likely not to your taste:

</p><figure><pre lang="lisp">(tree-transform-if
 predicate transformer (second tree) depth)
</pre><figcaption>My indentation style suited for deeply nested code</figcaption></figure>

<p>
This style of indentation
(putting function name on one line, and arguments on the other)
was frowned upon more than once in my practice:

</p><ul><li> It messes up with nesting identification: one space is not enough.
</li><li> It makes the code too vertical.
</li><li> And it certainly isn&#39;t idiomatic.
</li></ul>

<p>
But what this style achieves is perfect indentation control.
You only get one space of indentation per form.
Complex algorithms are easier to read when written in this style.

</p><p>
And!
This style also plays well with most indentation tools, even the simplest ones.
I had this situation more than once:

</p><ul><li> Writing a <code>with-*</code> macro in Scheme;
</li><li> Using it;
</li><li> And realizing that Emacs/Geiser indentation functions think that this macro is a procedure.
</li></ul>

<p>
Indenting all the arguments of the <code>progn</code>/<code>begin</code>-like macro in this sick style helps:

</p><figure><pre lang="scheme">;; From
(mtx:with-column (uab-col uab index-ab)
                 (mtx:set!
                  ppab 0 index-ab
                  (blas:dot hi-hi-eval uab-col)))
;; To
(mtx:with-column
 (uab-col uab index-ab)
 (mtx:set!
  ppab 0 index-ab
  (blas:dot hi-hi-eval uab-col)))
</pre><figcaption>Sick indent helps you to manage macros</figcaption></figure>

</section><section id="threading"><h2><a href="#threading">Another Solution: Threading Macros</a></h2>

<p>
I worked on a deeply nested corporate codebase functions.
In Clojure.
And I realized why threading macros exist.
To make the logic more sequential and readable, true.
But also to tame excessive nesting!

</p><p>
Unfortunately, threading/arrow macros don&#39;t always work.
Common Lisp in particular is extremely unfriendly to threading macros.
Arrows imply a consistent thread-first or thread-last functions.
But CL&#39;s standard lib is too inconsistent for that to work.
So we&#39;re left with picking an indentation style we don&#39;t necessarily like.

</p></section><section id="favorite"><h2><a href="#favorite">What Is Your Favorite Style?</a></h2>

<p>
I often prefer the macro-like indentation, because I sometimes write deeply nested code.
But I see the value in all the other indentation schemes!

</p></section><section id="feedback"><h2><a href="#feedback">Leave feedback! (via email)</a></h2>
<form action="mailto:lisp-indent@aartaka.me">
<label for="subject">Topic/subject</label>

<label for="body">Feedback (required)</label>


</form>
</section>
</div></div>
  </body>
</html>
