<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/ben-n93/SQL-tips-and-tricks">Original</a>
    <h1>SQL Tips and Tricks</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">A (somewhat opinionated) list of SQL tips and tricks I&#39;ve picked up over the years.</p>
<p dir="auto">Please note that some of these tips might not be relevant for all RDBMs. For example, the <code>::</code> syntax (<a href="#you-can-use-the--operator-to-cast-the-data-type-of-a-value">tip 5</a>) does not work in SQLite.</p>


<ol dir="auto">
<li><a href="#use-a-leading-comma-to-separate-fields">Use a leading comma to seperate fields</a></li>
<li><a href="#use-a-dummy-value-in-the-where-clause">Use a dummy value in the WHERE clause</a></li>
<li><a href="#ident-your-code-where-appropriate">Ident your code where appropriate</a></li>
</ol>

<ol start="5" dir="auto">
<li><a href="#you-can-use-the--operator-to-cast-the-data-type-of-a-value">You can use the <code>::</code> operator to cast the data type of a value</a></li>
<li><a href="#anti-joins-are-your-friend">Anti-joins are your friend</a></li>
<li><a href="#use-qualify-to-filter-window-functions">Use <code>QUALIFY</code> to filter window functions</a></li>
<li><a href="#you-can-but-shouldnt-always-group-by-column-position">You can (but shouldn&#39;t always) <code>GROUP BY</code> column position</a></li>
</ol>

<ol start="9" dir="auto">
<li><a href="#be-aware-of-how-not-in-behaves-with-null-values">Be aware of how <code>NOT IN</code> behaves with NULL values</a></li>
<li><a href="#rename-calculated-fields-to-avoiding-ambiguity">Rename calculated fields to avoid ambiguity</a></li>
<li><a href="#always-specify-which-column-belongs-to-which-table">Always specify which column belongs to which table</a></li>
<li><a href="#understand-the-order-of-execution">Understand the order of execution</a></li>
<li><a href="#comment-your-code">Comment your code!</a></li>
<li><a href="#read-the-documentation-in-full">Read the documentation (in full)</a></li>
</ol>

<div dir="auto"><h3 tabindex="-1" dir="auto">Use a leading comma to separate fields</h3><a id="user-content-use-a-leading-comma-to-separate-fields" aria-label="Permalink: Use a leading comma to separate fields" href="#use-a-leading-comma-to-separate-fields"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Use a leading comma to seperate fields in the <code>SELECT</code> clause rather than a trailing comma.</p>
<ul dir="auto">
<li>
<p dir="auto">Clearly defines that this is a new column vs code that&#39;s wrapped to multiple lines.</p>
</li>
<li>
<p dir="auto">Visual cue to easily identify if the comma is missing or not. Varying line lengths makes it harder to determine.</p>
</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="SELECT
employee_id
, employee_name
, job
, salary
FROM employees
;"><pre><span>SELECT</span>
employee_id
, employee_name
, job
, salary
<span>FROM</span> employees
;</pre></div>
<ul dir="auto">
<li>Also use a leading <code>AND</code> in the <code>WHERE</code> clause, for the same reasons (following tip demonstrates this).</li>
</ul>
<div dir="auto"><h3 tabindex="-1" dir="auto"><strong>Use a dummy value in the WHERE clause</strong></h3><a id="user-content-use-a-dummy-value-in-the-where-clause" aria-label="Permalink: Use a dummy value in the WHERE clause" href="#use-a-dummy-value-in-the-where-clause"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Use a dummy value in the <code>WHERE</code> clause so you can dynamically add and remove conditions with ease:</p>
<div dir="auto" data-snippet-clipboard-copy-content="SELECT *
FROM employees
WHERE 1=1 -- Dummy value.
AND job IN (&#39;Clerk&#39;, &#39;Manager&#39;)
AND dept_no != 5
;"><pre><span>SELECT</span> <span>*</span>
<span>FROM</span> employees
<span>WHERE</span> <span>1</span><span>=</span><span>1</span> <span><span>--</span> Dummy value.</span>
<span>AND</span> job <span>IN</span> (<span><span>&#39;</span>Clerk<span>&#39;</span></span>, <span><span>&#39;</span>Manager<span>&#39;</span></span>)
<span>AND</span> dept_no <span>!=</span> <span>5</span>
;</pre></div>
<div dir="auto"><h3 tabindex="-1" dir="auto">Indent your code where appropriate</h3><a id="user-content-indent-your-code-where-appropriate" aria-label="Permalink: Indent your code where appropriate" href="#indent-your-code-where-appropriate"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Indent your code to make it more readable to colleagues and your future self:</p>
<div dir="auto" data-snippet-clipboard-copy-content="-- Bad:
SELECT 
timeslot_date
, timeslot_channel 
, overnight_fta_share
, IFF(DATEDIFF(DAY, timeslot_date, CURRENT_DATE()) &gt; 7, LAG(overnight_fta_share, 1) OVER (PARTITION BY timeslot_date, timeslot_channel ORDER BY timeslot_activity), NULL) AS C7_fta_share
, IFF(DATEDIFF(DAY, timeslot_date, CURRENT_DATE()) &gt;= 29, LAG(overnight_fta_share, 2) OVER (PARTITION BY timeslot_date, timeslot_channel ORDER BY timeslot_activity), NULL) AS C28_fta_share
FROM timeslot_data
;

-- Good:
SELECT 
timeslot_date
, timeslot_channel 
, overnight_fta_share
, IFF(DATEDIFF(DAY, timeslot_date, CURRENT_DATE()) &gt; 7, -- First argument of IFF.
	LAG(overnight_fta_share, 1) OVER (PARTITION BY timeslot_date, timeslot_channel ORDER BY timeslot_activity), -- Second argument of IFF.
		NULL) AS C7_fta_share -- Third argument of IFF.
, IFF(DATEDIFF(DAY, timeslot_date, CURRENT_DATE()) &gt;= 29, 
		LAG(overnight_fta_share, 2) OVER (PARTITION BY timeslot_date, timeslot_channel ORDER BY timeslot_activity), 
			NULL) AS C28_fta_share
FROM timeslot_data
;"><pre><span><span>--</span> Bad:</span>
<span>SELECT</span> 
timeslot_date
, timeslot_channel 
, overnight_fta_share
, IFF(DATEDIFF(DAY, timeslot_date, <span>CURRENT_DATE</span>()) <span>&gt;</span> <span>7</span>, LAG(overnight_fta_share, <span>1</span>) OVER (PARTITION BY timeslot_date, timeslot_channel <span>ORDER BY</span> timeslot_activity), <span>NULL</span>) <span>AS</span> C7_fta_share
, IFF(DATEDIFF(DAY, timeslot_date, <span>CURRENT_DATE</span>()) <span>&gt;=</span> <span>29</span>, LAG(overnight_fta_share, <span>2</span>) OVER (PARTITION BY timeslot_date, timeslot_channel <span>ORDER BY</span> timeslot_activity), <span>NULL</span>) <span>AS</span> C28_fta_share
<span>FROM</span> timeslot_data
;

<span><span>--</span> Good:</span>
<span>SELECT</span> 
timeslot_date
, timeslot_channel 
, overnight_fta_share
, IFF(DATEDIFF(DAY, timeslot_date, <span>CURRENT_DATE</span>()) <span>&gt;</span> <span>7</span>, <span><span>--</span> First argument of IFF.</span>
	LAG(overnight_fta_share, <span>1</span>) OVER (PARTITION BY timeslot_date, timeslot_channel <span>ORDER BY</span> timeslot_activity), <span><span>--</span> Second argument of IFF.</span>
		<span>NULL</span>) <span>AS</span> C7_fta_share <span><span>--</span> Third argument of IFF.</span>
, IFF(DATEDIFF(DAY, timeslot_date, <span>CURRENT_DATE</span>()) <span>&gt;=</span> <span>29</span>, 
		LAG(overnight_fta_share, <span>2</span>) OVER (PARTITION BY timeslot_date, timeslot_channel <span>ORDER BY</span> timeslot_activity), 
			<span>NULL</span>) <span>AS</span> C28_fta_share
<span>FROM</span> timeslot_data
;</pre></div>

<div dir="auto"><h3 tabindex="-1" dir="auto">You can use the <code>::</code> operator to cast the data type of a value</h3><a id="user-content-you-can-use-the--operator-to-cast-the-data-type-of-a-value" aria-label="Permalink: You can use the :: operator to cast the data type of a value" href="#you-can-use-the--operator-to-cast-the-data-type-of-a-value"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">In some RDBMs you can use the <code>::</code> operator to cast a value from one data type to another:</p>
<div dir="auto" data-snippet-clipboard-copy-content="SELECT CAST(&#39;5&#39; AS INTEGER); -- Using the CAST function.
SELECT &#39;5&#39;::INTEGER; -- Using :: syntax."><pre><span>SELECT</span> CAST(<span><span>&#39;</span>5<span>&#39;</span></span> <span>AS</span> <span>INTEGER</span>); <span><span>--</span> Using the CAST function.</span>
<span>SELECT</span> <span><span>&#39;</span>5<span>&#39;</span></span>::<span>INTEGER</span>; <span><span>--</span> Using :: syntax.</span></pre></div>
<div dir="auto"><h3 tabindex="-1" dir="auto">Anti-joins are your friend</h3><a id="user-content-anti-joins-are-your-friend" aria-label="Permalink: Anti-joins are your friend" href="#anti-joins-are-your-friend"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Anti-joins are incredible useful, mostly (in my experience) for when when you only want to return rows/values from one table that aren&#39;t present in another table.</p>
<ul dir="auto">
<li>You could instead use a subquery although conventional wisdom dictates that
anti-joins are faster.</li>
<li><code>EXCEPT</code> is an interesting operator for removing rows from one table which appear in another query table but I suggest you read up on it further before using it.</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="-- Anti-join.
SELECT 
video_content.*
FROM video_content
    LEFT JOIN archive
    on video_content.series_id = archive.series_id
WHERE 1=1
AND archive.series_id IS NULL -- Any rows with no match will have a NULL value.

-- Subquery.
SELECT 
*
FROM video_content
WHERE 1=1
AND series_id NOT IN (SELECT DISTINCT SERIES_ID FROM archive) -- Be mindful of NULL values (see tip 9).

-- Correlated subquery.
SELECT 
*
FROM video_content
WHERE 1=1
AND NOT EXISTS (
        SELECT 1
        FROM archive a
        WHERE a.series_id = vc.series_id
    )

-- EXCEPT.
SELECT series_id
FROM video_content
EXCEPT
SELECT series_id
FROM archive"><pre><span><span>--</span> Anti-join.</span>
<span>SELECT</span> 
video_content.<span>*</span>
<span>FROM</span> video_content
    <span>LEFT JOIN</span> archive
    <span>on</span> <span>video_content</span>.<span>series_id</span> <span>=</span> <span>archive</span>.<span>series_id</span>
<span>WHERE</span> <span>1</span><span>=</span><span>1</span>
<span>AND</span> <span>archive</span>.<span>series_id</span> IS <span>NULL</span> <span><span>--</span> Any rows with no match will have a NULL value.</span>

<span><span>--</span> Subquery.</span>
<span>SELECT</span> 
<span>*</span>
<span>FROM</span> video_content
<span>WHERE</span> <span>1</span><span>=</span><span>1</span>
<span>AND</span> series_id NOT <span>IN</span> (<span>SELECT DISTINCT</span> SERIES_ID <span>FROM</span> archive) <span><span>--</span> Be mindful of NULL values (see tip 9).</span>

<span><span>--</span> Correlated subquery.</span>
<span>SELECT</span> 
<span>*</span>
<span>FROM</span> video_content
<span>WHERE</span> <span>1</span><span>=</span><span>1</span>
<span>AND</span> NOT EXISTS (
        <span>SELECT</span> <span>1</span>
        <span>FROM</span> archive a
        <span>WHERE</span> <span>a</span>.<span>series_id</span> <span>=</span> <span>vc</span>.<span>series_id</span>
    )

<span><span>--</span> EXCEPT.</span>
<span>SELECT</span> series_id
<span>FROM</span> video_content
EXCEPT
<span>SELECT</span> series_id
<span>FROM</span> archive</pre></div>
<div dir="auto"><h3 tabindex="-1" dir="auto">Use QUALIFY to filter window functions</h3><a id="user-content-use-qualify-to-filter-window-functions" aria-label="Permalink: Use QUALIFY to filter window functions" href="#use-qualify-to-filter-window-functions"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>QUALIFY</code> lets you filter the results of a query based on a window function. This is useful for a variety of reasons, including to
reduce the number of lines of code needed.</p>
<p dir="auto">For example, if I want to return the top 10 markets per product I can use
<code>QUALIFY</code> rather than an in-line view:</p>
<div dir="auto" data-snippet-clipboard-copy-content="-- Using QUALIFY:
SELECT 
product
, market
, SUM(revenue) as market_revenue 
FROM sales
GROUP BY product, market
QUALIFY DENSE_RANK() OVER (PARTITION BY product ORDER BY SUM(revenue) DESC)  &lt;= 10
ORDER BY product, market_revenue
;

-- Without QUALIFY:
SELECT 
product
, market
, market_revenue 
FROM
(
SELECT 
product
, market
, SUM(revenue) as market_revenue
, DENSE_RANK() OVER (PARTITION BY product ORDER BY SUM(revenue) DESC) AS market_rank
FROM sales
GROUP BY product, market
)
WHERE market_rank  &lt;= 10
ORDER BY product, market_revenue
;"><pre><span><span>--</span> Using QUALIFY:</span>
<span>SELECT</span> 
product
, market
, <span>SUM</span>(revenue) <span>as</span> market_revenue 
<span>FROM</span> sales
<span>GROUP BY</span> product, market
QUALIFY DENSE_RANK() OVER (PARTITION BY product <span>ORDER BY</span> <span>SUM</span>(revenue) <span>DESC</span>)  <span>&lt;=</span> <span>10</span>
<span>ORDER BY</span> product, market_revenue
;

<span><span>--</span> Without QUALIFY:</span>
<span>SELECT</span> 
product
, market
, market_revenue 
<span>FROM</span>
(
<span>SELECT</span> 
product
, market
, <span>SUM</span>(revenue) <span>as</span> market_revenue
, DENSE_RANK() OVER (PARTITION BY product <span>ORDER BY</span> <span>SUM</span>(revenue) <span>DESC</span>) <span>AS</span> market_rank
<span>FROM</span> sales
<span>GROUP BY</span> product, market
)
<span>WHERE</span> market_rank  <span>&lt;=</span> <span>10</span>
<span>ORDER BY</span> product, market_revenue
;</pre></div>
<div dir="auto"><h3 tabindex="-1" dir="auto">You can (but shouldn&#39;t always) <code>GROUP BY</code> column position</h3><a id="user-content-you-can-but-shouldnt-always-group-by-column-position" aria-label="Permalink: You can (but shouldn&#39;t always) GROUP BY column position" href="#you-can-but-shouldnt-always-group-by-column-position"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Rather than use the column name you can <code>GROUP BY</code> or <code>ORDER BY</code> using
column position.</p>
<ul dir="auto">
<li>For ad-hoc/one-off queries this can be useful but for production code
you should always refer to a column by its name.</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="SELECT 
dept_no
, SUM(salary) as dept_salary
FROM employees
GROUP BY 1 -- dept_no is the first column in the SELECT clause.
ORDER BY 2 DESC
;"><pre><span>SELECT</span> 
dept_no
, <span>SUM</span>(salary) <span>as</span> dept_salary
<span>FROM</span> employees
<span>GROUP BY</span> <span>1</span> <span><span>--</span> dept_no is the first column in the SELECT clause.</span>
<span>ORDER BY</span> <span>2</span> <span>DESC</span>
;</pre></div>

<div dir="auto"><h3 tabindex="-1" dir="auto">Be aware of how <code>NOT IN</code> behaves with <code>NULL</code> values</h3><a id="user-content-be-aware-of-how-not-in-behaves-with-null-values" aria-label="Permalink: Be aware of how NOT IN behaves with NULL values" href="#be-aware-of-how-not-in-behaves-with-null-values"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>NOT IN</code> doesn&#39;t work if <code>NULL</code> is present in the values being checked against. As <code>NULL</code> represents Unknown the SQL engine can&#39;t verify that the value being checked is not present in the list.</p>
<ul dir="auto">
<li>Instead use <code>NOT EXISTS</code>.</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="INSERT INTO departments (id)
VALUES (1), (2), (NULL);

-- Doesn&#39;t work due to NULL being present.
SELECT * 
FROM employees 
WHERE department_id NOT IN (SELECT DISTINCT id from departments)

-- Solution.
SELECT * 
FROM employees e
WHERE NOT EXISTS (
    SELECT 1 
    FROM departments d 
    WHERE d.id = e.department_id
)
;"><pre><span>INSERT INTO</span> departments (id)
<span>VALUES</span> (<span>1</span>), (<span>2</span>), (<span>NULL</span>);

<span><span>--</span> Doesn&#39;t work due to NULL being present.</span>
<span>SELECT</span> <span>*</span> 
<span>FROM</span> employees 
<span>WHERE</span> department_id NOT <span>IN</span> (<span>SELECT DISTINCT</span> id <span>from</span> departments)

<span><span>--</span> Solution.</span>
<span>SELECT</span> <span>*</span> 
<span>FROM</span> employees e
<span>WHERE</span> NOT EXISTS (
    <span>SELECT</span> <span>1</span> 
    <span>FROM</span> departments d 
    <span>WHERE</span> <span>d</span>.<span>id</span> <span>=</span> <span>e</span>.<span>department_id</span>
)
;</pre></div>
<div dir="auto"><h3 tabindex="-1" dir="auto">Rename calculated fields to avoiding ambiguity</h3><a id="user-content-rename-calculated-fields-to-avoiding-ambiguity" aria-label="Permalink: Rename calculated fields to avoiding ambiguity" href="#rename-calculated-fields-to-avoiding-ambiguity"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">When creating a calculated field you might be tempted to rename it to an
existing column but this can lead to unexpected behaviour, such as a
window function operating on the wrong field:</p>
<div dir="auto" data-snippet-clipboard-copy-content="INSERT INTO products (product, revenue)
VALUES 
    (&#39;Shark&#39;, 100),
    (&#39;Robot&#39;, 150),
    (&#39;Alien&#39;, 90);

-- The window function will rank the &#39;Robot&#39; product as 1 when it should be 3.
SELECT 
product
, CASE product WHEN &#39;Robot&#39; THEN 0 ELSE revenue END AS revenue
, RANK() OVER (ORDER BY revenue DESC)
FROM products "><pre><span>INSERT INTO</span> products (product, revenue)
<span>VALUES</span> 
    (<span><span>&#39;</span>Shark<span>&#39;</span></span>, <span>100</span>),
    (<span><span>&#39;</span>Robot<span>&#39;</span></span>, <span>150</span>),
    (<span><span>&#39;</span>Alien<span>&#39;</span></span>, <span>90</span>);

<span><span>--</span> The window function will rank the &#39;Robot&#39; product as 1 when it should be 3.</span>
<span>SELECT</span> 
product
, CASE product WHEN <span><span>&#39;</span>Robot<span>&#39;</span></span> THEN <span>0</span> ELSE revenue END <span>AS</span> revenue
, RANK() OVER (<span>ORDER BY</span> revenue <span>DESC</span>)
<span>FROM</span> products </pre></div>
<div dir="auto"><h3 tabindex="-1" dir="auto">Always specify which column belongs to which table</h3><a id="user-content-always-specify-which-column-belongs-to-which-table" aria-label="Permalink: Always specify which column belongs to which table" href="#always-specify-which-column-belongs-to-which-table"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">When you have complex queries with multiple joins it pays to be able to
trace back an issue with a value to its source.</p>
<p dir="auto">Additionally, your RDBMS might raise an error if two tables share the same
column name and you don&#39;t specify which column you are using.</p>
<div dir="auto" data-snippet-clipboard-copy-content="SELECT 
vc.video_id
, vc.series_name
, metadata.season
, metadata.episode_number
FROM video_content as vc 
    INNER JOIN video_metadata as metadata
    ON vc.video_id = metadata.video_id"><pre><span>SELECT</span> 
<span>vc</span>.<span>video_id</span>
, <span>vc</span>.<span>series_name</span>
, <span>metadata</span>.<span>season</span>
, <span>metadata</span>.<span>episode_number</span>
<span>FROM</span> video_content <span>as</span> vc 
    <span>INNER JOIN</span> video_metadata <span>as</span> metadata
    <span>ON</span> <span>vc</span>.<span>video_id</span> <span>=</span> <span>metadata</span>.<span>video_id</span></pre></div>
<div dir="auto"><h3 tabindex="-1" dir="auto">Understand the order of execution</h3><a id="user-content-understand-the-order-of-execution" aria-label="Permalink: Understand the order of execution" href="#understand-the-order-of-execution"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">If I had to give one piece of advice to someone learning SQL it&#39;d be to understand the order of
execution (of clauses). It will completely change how you write queries. This <a href="https://blog.jooq.org/a-beginners-guide-to-the-true-order-of-sql-operations/" rel="nofollow">blog post</a> is a fantastic resource for learning.</p>

<p dir="auto">While in the moment you know why you did something if you revisit
the code weeks, months or years later you might not remember.</p>
<ul dir="auto">
<li>In general you should strive to write comments that explain why you did something, not how.</li>
<li>Your colleagues and future self will thank you!</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="SELECT 
video_content.*
FROM video_content
    LEFT JOIN archive -- New CMS cannot process archive video formats. 
    on video_content.series_id = archive.series_id
WHERE 1=1
AND archive.series_id IS NULL"><pre><span>SELECT</span> 
video_content.<span>*</span>
<span>FROM</span> video_content
    <span>LEFT JOIN</span> archive <span><span>--</span> New CMS cannot process archive video formats. </span>
    <span>on</span> <span>video_content</span>.<span>series_id</span> <span>=</span> <span>archive</span>.<span>series_id</span>
<span>WHERE</span> <span>1</span><span>=</span><span>1</span>
<span>AND</span> <span>archive</span>.<span>series_id</span> IS <span>NULL</span></pre></div>
<div dir="auto"><h3 tabindex="-1" dir="auto">Read the documentation (in full)</h3><a id="user-content-read-the-documentation-in-full" aria-label="Permalink: Read the documentation (in full)" href="#read-the-documentation-in-full"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Using Snowflake I once needed to return the latest date from a list of columns
and so I decided to use <code>GREATEST()</code>.</p>
<p dir="auto">What I didn&#39;t realise was that if one of the
arguments is <code>NULL</code> then the function returns <code>NULL</code>.</p>
<p dir="auto">If I&#39;d read the documentation in full I&#39;d have known! In many cases it can take just a minute or less to scan
the documentation and it will save you the headache of having to work
out why something isn&#39;t working the way you expected:</p>
<div dir="auto" data-snippet-clipboard-copy-content="-- If I&#39;d read the documentation further I&#39;d also have realised that my solution
--to the NULL problem with GREATEST()...

SELECT COALESCE(GREATEST(signup_date, consumption_date), signup_date, consumption_date)

-- ... could have been solved with the following function:
SELECT GREATEST_IGNORE_NULLS(signup_date, consumption_date)"><pre><span><span>--</span> If I&#39;d read the documentation further I&#39;d also have realised that my solution</span>
<span><span>--</span>to the NULL problem with GREATEST()...</span>

<span>SELECT</span> COALESCE(GREATEST(signup_date, consumption_date), signup_date, consumption_date)

<span><span>--</span> ... could have been solved with the following function:</span>
<span>SELECT</span> GREATEST_IGNORE_NULLS(signup_date, consumption_date)</pre></div>
</article></div></div>
  </body>
</html>
