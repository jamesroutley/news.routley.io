<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://thomask.sdf.org/blog/2023/11/14/rust-without-crates-io.html">Original</a>
    <h1>Rust without crates.io</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody">
    <p>Rust is a lovely programming language but I’ve never quite come to terms with crates.io, or any other of these language-specific repositories where everyone uploads and downloads code willy-nilly. I have several objections:</p>

<ul>
  <li>If crates.io goes down or access is otherwise disrupted then the Rust community will stop work. It is profoundly unresilient to have a single point of failure like this. Certainly some people will have <a href="https://doc.rust-lang.org/cargo/commands/cargo-vendor.html">vendored their deps</a> and others will have a <a href="https://crates.io/crates/panamax"><code>panamax</code> mirror</a> handy, but for most, Rust as we know it stops if this one particular web service goes down.</li>
  <li>There is no mediation of any kind between when a new library/version is published and when it is consumed. You need only one author in your maybe-hundreds-of-dependencies tree to be hacked, coerced or in a malicious mood for you to have a <em>really</em> bad day.</li>
  <li>Any tampering with crates.io itself (espionage, disgruntlement, national security) could have an incredibly wide blast radius, or a incredibly wide set of targets from which to choose.</li>
  <li>Since crates.io is <em>the</em> source for crates, it is normal for both developers and CI machines to be hitting this web service all the time. Opportunities for mischief are exacerbated when clients are phoning home so frequently.</li>
</ul>

<p>So what’s the alternative? I think we all need to take a step back from the altar of developer velocity and take a deep breath. I don’t want dependencies hot off the press. Ideally I want someone independent of the authors playing a curatorial role.</p>

<p>Now, actually getting some human review of dependency updates is quite a hard thing to do. <a href="https://github.com/crev-dev/cargo-crev"><code>cargo-crev</code></a> has been trying for years to make this happen. I would love if it was the solution but it isn’t yet, and I think it’s a little ambitious. Yes we would like to have super-experienced software developers reviewing all our libraries with cryptographic stamps of approval, but if they’re not available we could be the target of remote shell in a <code>build.rs</code>. Surely there’s a middle ground here?</p>

<p>What’s interesting is that this problem is largely solved for C and C++: Linux distributions like Debian package such a wide range of libraries that for many things that you want to develop or install, you don’t need any third-party libraries <em>at all</em>. It’s just a matter of finding the right <code>apt-get</code> incantations and off you go. Even if you can get 95% of your libraries from a common trusted source then your risk is decreased considerably.</p>

<p>Rust libraries don’t work quite the same as C/C++ ones. Normal Rust code can’t be dynamically linked—a binary will have all of its dependencies statically linked at build time, so you won’t typically see <code>.so</code> files for Rust libraries that are going to be consumed by other Rust code. Since there is no <code>.so</code> file, Debian has no package that installs the library. However if they want to ship a binary that was written in Rust, their builders can’t just be downloading stuff from crates.io. They need a way to package all of the software that represents that Debian release. To solve that problem they’ve taken all these little dependencies and put their <em>full Rust source code</em> in packages with names like <code>librust-cratename-dev</code>.</p>

<p>Hmm, how many such packages? Running on trixie (testing)…</p>

<div><div><pre><code>$ aptitude search librust- | grep -vE &#34;^v &#34; | wc -l
2336
</code></pre></div></div>

<p>This is starting to look like a serious curation of the most important Rust crates, available from any Debian mirror. There are some double-ups to be sure, since in some cases multiple incompatible versions of the same crate had to be packaged. Still. Maybe there is enough Rust in Debian now that it’s viable to write interesting Rust software independently of crates.io? That would solve basically all my concerns and the situation is only going to improve as more Rust software gets packaged.</p>

<p>To be clear, I don’t expect that Debian Developers are auditing these packages in the manner of <code>cargo-crev</code>. The good thing is that they <em>don’t actually need to</em> for it to be a major improvement.</p>

<ul>
  <li>A DD isn’t going to upload a new patch release <em>just ‘cause</em>. It’s going to be because it has an important fix or because some other program has depended on it. On crates.io a maintainer is free to create new releases for any reason and <code>cargo update</code> is not going to evaluate how good that reason is.</li>
  <li>A simple time delay will allow egregious malware like malicious <code>build.rs</code> scripts to be caught, whether that’s the super-long Debian stable cycle or even the several days required to migrate from <em>unstable</em> to <em>testing</em>. I assume that an urgent security issue would be distributed the same as any other Debian update.</li>
  <li>They might decide to give the diff at least a cursory look, which is better than nothing.</li>
</ul>

<p>How do we do this? It’s actually quite easy because the big-brained Debian developers have arranged all the Rust dependencies to follow the format of a cargo <a href="https://doc.rust-lang.org/cargo/reference/source-replacement.html#directory-sources">Directory Source</a>. That is, all of the packages are installed in their own directories under <code>/usr/share/cargo/registry</code>, including implementing <a href="https://github.com/rust-lang/cargo/issues/11063">a cheeky workaround</a> for the required <code>.cargo-checksum.json</code> files.</p>

<p>You can then add some brief incantations to your <code>.cargo/config.toml</code>, whether on a project- or user-wide basis:</p>

<div><div><pre><code><span>[net]</span>
<span>offline</span> <span>=</span> <span>true</span>

<span>[source]</span>

<span>[source.apt]</span>
<span>directory</span> <span>=</span> <span>&#34;/usr/share/cargo/registry&#34;</span>

<span>[source.crates-io]</span>
<span>replace-with</span> <span>=</span> <span>&#34;apt&#34;</span>
</code></pre></div></div>

<p>This overrides the default crates.io source and ensures dependencies can only be fulfilled locally by installing the relevant packages. This happily doesn’t require any changes to your projects themselves—you just have to be careful to use versions in your <code>Cargo.toml</code> (and <code>Cargo.lock</code>) that are resolvable on Debian, since it is a subset of those available on the wider crates.io.</p>

<p>I am quite certain that Debian wouldn’t have enough coverage yet for the monorepo at work, but I gave this a go on my <a href="https://github.com/thombles/hashgood">one of my little CLI projects</a> that has half a dozen dependencies. Apart from having to downgrade <code>copypasta</code> from 0.8.2 to 0.8.1 in the <code>Cargo.lock</code>, this builds and runs just fine. What a treat.</p>

<p>This little investigation has given me much more confidence in using Rust generally into the future. I feared that the “grab any dependency version you like” approach facilitated by crates.io would render Rust impervious to any sort of curation effort, such that anyone who was serious about my earlier concerns would have to stick to a language used to the old ways like C++. Fortunately, Debian is here to prove me wrong. A+ work by their Rust packaging team.</p>

<p>All power to those who like to live on the edge; I’ll be over here trying to minimise different types of dependencies.</p>

  </div></div>
  </body>
</html>
