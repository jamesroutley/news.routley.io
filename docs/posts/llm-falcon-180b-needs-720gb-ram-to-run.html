<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://kaitchup.substack.com/p/falcon-180b-can-it-run-on-your-computer">Original</a>
    <h1>LLM Falcon 180B Needs 720GB RAM to Run</h1>
    
    <div id="readability-page-1" class="page"><div><h4>Discover more from The Kaitchup – AI on a Budget</h4><p>Weekly news, tips, and tutorials on fine-tuning, running, and serving large language models on your computer. Each tutorial is published along with a notebook ready to run.</p> </div><div class=""><div><div dir="auto"><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbe09d541-6bb3-49a5-984a-3c726b142c91_2248x1467.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbe09d541-6bb3-49a5-984a-3c726b142c91_2248x1467.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbe09d541-6bb3-49a5-984a-3c726b142c91_2248x1467.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbe09d541-6bb3-49a5-984a-3c726b142c91_2248x1467.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbe09d541-6bb3-49a5-984a-3c726b142c91_2248x1467.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbe09d541-6bb3-49a5-984a-3c726b142c91_2248x1467.png" width="728" height="475" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/be09d541-6bb3-49a5-984a-3c726b142c91_2248x1467.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:false,&#34;imageSize&#34;:&#34;normal&#34;,&#34;height&#34;:950,&#34;width&#34;:1456,&#34;resizeWidth&#34;:728,&#34;bytes&#34;:756603,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:false,&#34;topImage&#34;:true,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbe09d541-6bb3-49a5-984a-3c726b142c91_2248x1467.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbe09d541-6bb3-49a5-984a-3c726b142c91_2248x1467.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbe09d541-6bb3-49a5-984a-3c726b142c91_2248x1467.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbe09d541-6bb3-49a5-984a-3c726b142c91_2248x1467.png 1456w" sizes="100vw" fetchpriority="high"/></picture></div></a></figure></div><p><span>In May 2023, The Technology Innovation Institute (TII) of Abu-Dhabi released two pre-trained LLMs: Falcon-7B and Falcon-40B, and their chat versions. These two models demonstrated very good performance and were ranked first on the </span><a href="https://huggingface.co/spaces/HuggingFaceH4/open_llm_leaderboard" rel="">OpenLLM leaderboard</a><span>.</span></p><p>A third model released by TII just joined the Falcon family: Falcon 180B, a 180 billion parameter model. It has 2.5 more parameters than Llama 2 70B and 4.5 more than Falcon-40B.</p><p><span>Here are some facts about Falcon 180B (source: </span><a href="https://huggingface.co/tiiuae/falcon-180B" rel="">Falcon 180B model card</a><span>):</span></p><ul><li><p><span>Pre-trained on 3.5 trillion tokens (</span><a href="https://huggingface.co/datasets/tiiuae/falcon-refinedweb" rel="">RefinedWeb</a><span>)</span></p></li><li><p>Distributed with an Apache 2.0 license (which makes it more “open” than Llama 2)</p></li><li><p>Has a size of 360 GB</p></li><li><p><span>Is ranked first (as of 11th September 2023) on the </span><a href="https://huggingface.co/spaces/HuggingFaceH4/open_llm_leaderboard" rel="">OpenLLM leaderboard</a><span>:</span></p></li></ul><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F86dd057b-1503-4dfb-b05a-ebf4e61dfd85_2245x1098.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F86dd057b-1503-4dfb-b05a-ebf4e61dfd85_2245x1098.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F86dd057b-1503-4dfb-b05a-ebf4e61dfd85_2245x1098.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F86dd057b-1503-4dfb-b05a-ebf4e61dfd85_2245x1098.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F86dd057b-1503-4dfb-b05a-ebf4e61dfd85_2245x1098.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_2400,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F86dd057b-1503-4dfb-b05a-ebf4e61dfd85_2245x1098.png" width="1200" height="586.8131868131868" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/86dd057b-1503-4dfb-b05a-ebf4e61dfd85_2245x1098.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:false,&#34;imageSize&#34;:&#34;large&#34;,&#34;height&#34;:712,&#34;width&#34;:1456,&#34;resizeWidth&#34;:1200,&#34;bytes&#34;:217967,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:false,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F86dd057b-1503-4dfb-b05a-ebf4e61dfd85_2245x1098.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F86dd057b-1503-4dfb-b05a-ebf4e61dfd85_2245x1098.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F86dd057b-1503-4dfb-b05a-ebf4e61dfd85_2245x1098.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F86dd057b-1503-4dfb-b05a-ebf4e61dfd85_2245x1098.png 1456w" sizes="100vw"/></picture></div></a><figcaption>Screenshot of the OpenLLM leaderboard (11th September 2023)</figcaption></figure></div><p>There is also a chat version. The models are available on the Hugging Face hub:</p><ul><li><p><a href="https://huggingface.co/tiiuae/falcon-180B" rel="">Falcon 180B</a></p></li><li><p><a href="https://huggingface.co/tiiuae/falcon-180B-chat" rel="">Falcon 180B Chat</a></p></li></ul><p>Falcon 180B is completely free and state-of-the-art. But it’s also a huge model.</p><p><em>Can it run on your computer?</em></p><p>Unless your computer is ready for very intensive computing, it can’t run Falcon 180B out-of-the-box. You will need to upgrade your computer and use a quantized version of the model. </p><p>In this article, I explain how you can run Falcon-180B on consumer hardware. We will see that it can be reasonably affordable to run a 180 billion parameter model on a modern computer. I also discuss several techniques that help reduce the hardware requirements.</p><p data-attrs="{&#34;url&#34;:&#34;https://kaitchup.substack.com/p/falcon-180b-can-it-run-on-your-computer?utm_source=substack&amp;utm_medium=email&amp;utm_content=share&amp;action=share&#34;,&#34;text&#34;:&#34;Share&#34;,&#34;action&#34;:null,&#34;class&#34;:null}" data-component-name="ButtonCreateButton"><a href="https://kaitchup.substack.com/p/falcon-180b-can-it-run-on-your-computer?utm_source=substack&amp;utm_medium=email&amp;utm_content=share&amp;action=share" rel=""><span>Share</span></a></p><p>The first thing you need to know is that Falcon 180B has 180 billion parameters stored as bfloat16. A (b)float16 parameter is 2 bytes in memory.</p><p>When you load a model, the standard Pytorch pipeline works like this:</p><ol><li><p>An empty model is created: 180B parameters * 2 bytes = 360 GB </p></li><li><p>Load in memory its weights: 180B parameters * 2 bytes = 360 GB </p></li><li><p>Load the weights loaded at step 2 in the empty model created at step 1</p></li><li><p>Move the model obtained at step 3 on the device for inference, e.g., a GPU</p></li></ol><p>Step 1 and step 2 are the ones that consume memory. In total, you would need 720 GB of memory available. This can be CPU RAM, but for fast inference, you may want to use GPUs, e.g., 9 A100 with 80 GB of VRAM. This wouldn’t be enough for batch inference.</p><p>With either CPU RAM or VRAM, that’s a lot of memory. Fortunately, these requirements can be easily reduced.</p><p>On the Hugging Face Hub, Falcon 180B is distributed using the safetensors format. This format has several advantages over the standard Pytorch format. It (almost) does zero copy so the model is directly loaded into the empty model created at step 1. It saves a lot of memory.</p><blockquote><p><strong>About safetensors</strong></p><p><a href="https://huggingface.co/docs/safetensors/index" rel="">safetensors</a><span> is a really cool project by Hugging Face. It saves memory but it also makes the model safer to run since no arbitrary code can be stored in this format. safetensors models are also much faster to load. Hugging Face automatically converts to safetensors the models uploaded to the hub. Use this format instead of the “.bin” format when you download models from the hub for faster, safe, and memory-efficient loading.</span></p></blockquote><p><span>Even though it looks like we skip step 2, there is still some memory overhead to expect. TII wrote on </span><a href="https://huggingface.co/tiiuae/falcon-180B" rel="">the model card</a><span> that 400 GB of memory would work. That’s still a lot but 220 GB less than using the Pytorch format.</span></p><p>We need a device with 400 GB, e.g., 5 A100 GPUs with 80 GB of VRAM. We are still far from a “consumer” configuration.</p><p>You may not have a single memory device with 400 GB, but your computer has likely more than 400 GB of memory if you combine the memory of all the following devices: </p><p><em>Note: I included some examples of computer parts that you can get to upgrade your configuration for running Falcon 180B. The links are Amazon affiliate links.</em></p><ul><li><p>The GPUs VRAM: If you have an NVIDIA RTX 3090 or 4090, that’s already 24 GB.</p><p><span>The GPU cards with 24 GB are getting quite cheap, for instance, the </span><a href="https://www.amazon.com/PNY-GeForce-Gaming-Graphics-Renewed/dp/B092XB1JGD?crid=188YHGT8R1YY8&amp;keywords=rtx%2B3090%2B24gb&amp;qid=1694378798&amp;sprefix=RTX%2B3090%2Caps%2C175&amp;sr=8-1&amp;th=1&amp;linkCode=ll1&amp;tag=thekaitchup-20&amp;linkId=be3161253f11bb01f7cf5f09dafe52df&amp;language=en_US&amp;ref_=as_li_ss_tl" rel="">PNY GeForce RTX 3090 24 GB</a><span>, or if you have a bigger budget, the </span><a href="https://www.amazon.com/PNY-GeForce-RTXTM-4090-Triple-Graphics/dp/B0BHBTJ2X2?crid=1XU87Y9DMTWNQ&amp;keywords=rtx%2B4090%2B24gb&amp;qid=1694378839&amp;sprefix=rtx%2B4090%2B24gb%2Caps%2C156&amp;sr=8-1&amp;th=1&amp;linkCode=ll1&amp;tag=thekaitchup-20&amp;linkId=e9fede67d66755659775455029b7e6aa&amp;language=en_US&amp;ref_=as_li_ss_tl" rel="">PNY GeForce RTX 4090 24GB</a><span> is still affordable for a card of this size.</span></p></li><li><p>The CPU RAM: Most modern computers have at least 12 GB of CPU RAM. CPU RAM is also very cheap to extend.</p><p><span>I recommend the </span><a href="https://www.amazon.com/G-Skill-RipJaws-PC4-28800-CL18-22-22-42-F4-3600C18Q-128GVK/dp/B08B87BM4K?crid=2O4PYV431C82D&amp;keywords=cpu+ram+4+128gb&amp;qid=1694511248&amp;sprefix=cpu+ram+4+128gb%2Caps%2C152&amp;sr=8-2&amp;linkCode=ll1&amp;tag=thekaitchup-20&amp;linkId=26f5e96cf65552f8a0bd9780a16a27af&amp;language=en_US&amp;ref_=as_li_ss_tl" rel="">G.SKILL Ripjaws V Series (Intel XMP) DDR4 RAM 128GB (4x32GB) kit</a><span>. It’s enough to run the quantized version of Falcon 180B, as we will see below.</span></p></li><li><p>The hard drive (or SSD): That can be several terabytes of free memory. Note that an SSD (type NVMe M2) would be much faster than a typical hard drive if you plan to use it to run an LLM.</p><p><span>For instance, the </span><a href="https://www.amazon.com/Samsung-970-EVO-Plus-MZ-V7S500B/dp/B07M7Q21N7?crid=279TOKQIOMYZQ&amp;keywords=ssd%2B500gb&amp;qid=1694378076&amp;sprefix=ssd%2B500%2Caps%2C185&amp;sr=8-3&amp;th=1&amp;linkCode=ll1&amp;tag=thekaitchup-20&amp;linkId=f3cd24f6f999c8c7fc8745b74e4c6941&amp;language=en_US&amp;ref_=as_li_ss_tl" rel="">SAMSUNG 970 EVO Plus 500 GB</a><span> if your motherboard supports NVMe M2 SSD or the </span><a href="https://www.amazon.com/SAMSUNG-500GB-Internal-MZ-77E500B-AM/dp/B08QBMD6P4?crid=279TOKQIOMYZQ&amp;keywords=ssd%2B500gb&amp;qid=1694378373&amp;sprefix=ssd%2B500%2Caps%2C185&amp;sr=8-4&amp;th=1&amp;linkCode=ll1&amp;tag=thekaitchup-20&amp;linkId=1543650dfd90049ee943cbfefa63765b&amp;language=en_US&amp;ref_=as_li_ss_tl" rel="">SAMSUNG 870 EVO SATA SSD 500GB</a><span>.</span></p></li></ul><p>To take advantage of the devices available, we can split Falcon 180B so that it uses the maximum memory available of a device in this order of priority: GPU, CPU RAM, and hard drive.</p><p><span>This is easily achievable with </span><a href="https://huggingface.co/docs/accelerate/index" rel="">Accelerate</a><span> device_map. I wrote two articles explaining device_map and how to use it. You can read them here:</span></p><div data-component-name="DigestPostEmbed"><div><a href="https://kaitchup.substack.com/p/device-map-avoid-out-of-memory-errors-when-running-large-language-models-af7de5076f9d" target="_blank" rel="noopener" class=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_140,h_140,c_fill,f_webp,q_auto:good,fl_progressive:steep,g_auto/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa984517a-530e-4c07-b351-aa0f5a30de6d_800x693.png"/><img src="https://substackcdn.com/image/fetch/w_140,h_140,c_fill,f_auto,q_auto:good,fl_progressive:steep,g_auto/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa984517a-530e-4c07-b351-aa0f5a30de6d_800x693.png" sizes="100vw" alt="Device Map: Avoid Out-of-Memory Errors When Running Large Language Models" width="140" height="140"/></picture></div></a></div></div><div data-component-name="DigestPostEmbed"><div><a href="https://kaitchup.substack.com/p/run-very-large-language-models-on-your-computer-390dd33838bb" target="_blank" rel="noopener" class=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_140,h_140,c_fill,f_webp,q_auto:good,fl_progressive:steep,g_auto/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdfdb7e84-e06c-4359-876a-18769b4ad1ca_800x533.jpeg"/><img src="https://substackcdn.com/image/fetch/w_140,h_140,c_fill,f_auto,q_auto:good,fl_progressive:steep,g_auto/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdfdb7e84-e06c-4359-876a-18769b4ad1ca_800x533.jpeg" sizes="100vw" alt="Run Very Large Language Models on Your Computer" width="140" height="140"/></picture></div></a></div></div><p>I use device_map in most of the notebooks:</p><p data-attrs="{&#34;url&#34;:&#34;https://kaitchup.substack.com/p/notebooks&#34;,&#34;text&#34;:&#34;See all the notebooks&#34;,&#34;action&#34;:null,&#34;class&#34;:null}" data-component-name="ButtonCreateButton"><a href="https://kaitchup.substack.com/p/notebooks" rel=""><span>See all the notebooks</span></a></p><p>device_map puts entire layers of the model on the different devices that you have. </p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F877e319e-95a2-4718-b89c-110a2b383931_800x693.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F877e319e-95a2-4718-b89c-110a2b383931_800x693.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F877e319e-95a2-4718-b89c-110a2b383931_800x693.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F877e319e-95a2-4718-b89c-110a2b383931_800x693.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F877e319e-95a2-4718-b89c-110a2b383931_800x693.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F877e319e-95a2-4718-b89c-110a2b383931_800x693.png" width="800" height="693" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/877e319e-95a2-4718-b89c-110a2b383931_800x693.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:693,&#34;width&#34;:800,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:null,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:null,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F877e319e-95a2-4718-b89c-110a2b383931_800x693.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F877e319e-95a2-4718-b89c-110a2b383931_800x693.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F877e319e-95a2-4718-b89c-110a2b383931_800x693.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F877e319e-95a2-4718-b89c-110a2b383931_800x693.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>device_map</figcaption></figure></div><p>device_map is very convenient to avoid CUDA out-of-memory errors. But still far from ideal if you plan to use Falcon 180B on consumer hardware. Even with a high-end configuration with 24 GB of VRAM and 32 GB of CPU RAM, it would leave several hundred GBs on the hard drive.</p><p>This is an issue for two reasons:</p><ul><li><p><span>hard drives and SSDs are much </span><strong>slower than the VRAM and CPU RAM</strong><span>. Loading and running Falcon 180B from a hard drive would take a very long time.</span></p></li><li><p><span>consumer hard drives and SSDs were </span><strong>not designed and tested for this kind of intensive use</strong><span>. If many parts of the model are offloaded on the hard drive, the system would have to access and read the huge splits of the models many times during inference. It’s a huge number of reading operations for a prolonged time. If you do inference for days, e.g., to generate some synthetic datasets, that may break your hard drive or at least significantly reduce its life expectancy.</span></p></li></ul><p>To avoid overusing the hard drive, we don’t have many solutions:</p><ul><li><p>Add one more GPU: Most high-end motherboards can hold two RTX 3090/4090. It would give you 48 GB of VRAM.</p></li><li><p><span>Extend the CPU RAM: Most motherboards have 4 slots available for CPU RAM kits. Kits of 4*128GB CPU RAM are sold but not easy to find and are still expensive. </span><em>Note: There is also a limit on the total amount of CPU RAM that your OS can support. For Windows 10, it’s 2 TB. If you have an older OS you should have a look at its documentation before buying more RAM.</em></p></li><li><p>Quantize Falcon 180B and extend the CPU RAM.</p></li></ul><p>The quantization of Falcon 180B is one of the best options to reduce its memory consumption. </p><p><span>It’s now common practice to quantize very large language models to a lower precision. </span><a href="https://arxiv.org/abs/2210.17323" rel="">GPTQ</a><span> and </span><a href="https://arxiv.org/abs/2305.14314" rel="">bitsandbytes nf4</a><span> are two popular ways to quantize LLM to 4-bit precision.</span></p><p>Falcon 180B uses bfloat16. We saw that it’s 360 GB.</p><p>Once quantized to 4-bit precision, it’s only 90 GB (180 billion parameters * 0.5 Bytes). We can load the 4-bit Falcon 180B with 100 GB of memory (90GB + some memory overhead).</p><p><span>If you have 24 GB of VRAM, you “only” need 75 GB of CPU RAM. It is still a lot but much more affordable than loading the original model, and it wouldn’t offload layers of the models on the hard drive during inference. </span><em>Note: You still need 100 GB of free space on the hard drive to store the model.</em></p><p>You don’t even need a GPU. With 128 GB of CPU RAM, you could do inference using only your CPU. </p><p><span>The quantization itself is extremely costly. Thankfully, we can already find quantized versions online. </span><a href="https://huggingface.co/TheBloke" rel="">TheBloke</a><span> released 4-bit versions made with GPTQ:</span></p><ul><li><p><a href="https://huggingface.co/TheBloke/Falcon-180B-GPTQ" rel="">4-bit Falcon 180B</a><span> </span></p></li><li><p><a href="https://huggingface.co/TheBloke/Falcon-180B-Chat-GPTQ" rel="">4-bit Faclon 180B Chat</a></p></li></ul><p><em>Note: There are also 3-bit models available as “branches” of the models. Follow the instructions from the 4-bit model cards to get them.  </em></p><p><span>While the precision of the model is reduced, the performance of the model remains similar according to </span><a href="https://huggingface.co/blog/falcon-180b" rel="">Hugging Face’s experiments</a><span>.</span></p><p>GPTQ models are fast for inference and you can fine-tune them with LoRA adapters. For instance, I show how to fine-tune Llama 2 quantized with GPTQ in this article:</p><div data-component-name="DigestPostEmbed"><div><a href="https://kaitchup.substack.com/p/quantize-and-fine-tune-llms-with" target="_blank" rel="noopener" class=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_140,h_140,c_fill,f_webp,q_auto:good,fl_progressive:steep,g_auto/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7245b287-a395-4075-9e3b-c3a88b7df075_827x433.png"/><img src="https://substackcdn.com/image/fetch/w_140,h_140,c_fill,f_auto,q_auto:good,fl_progressive:steep,g_auto/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7245b287-a395-4075-9e3b-c3a88b7df075_827x433.png" sizes="100vw" alt="Quantize and Fine-tune LLMs with GPTQ Using Transformers and TRL" width="140" height="140"/></picture></div></a></div></div><p><span>While it’s possible to fine-tune GPTQ models, I don’t recommend it. Fine-tuning with QLoRA has a similar memory consumption but yields better models thanks to the better quantization with nf4 as shown in the </span><a href="https://arxiv.org/abs/2305.14314" rel="">QLoRA paper</a><span>.</span></p><p>To sum up, you need quantization and 100 GB of memory to run Falcon 180B on a reasonably affordable computer.</p><p>For fast inference or fine-tuning, you will need a GPU. The RTX 4090 (or the RTX 3090 24GB, which is more affordable but slower) would be enough to load 1/4 of the quantized model. If you have enough space in your computer case, you could even put two RTX cards.</p><p>If you want to run Falcon-180B on a CPU-only configuration, i.e., without a GPU, forget about fine-tuning, it would be too slow. Inference would also be slow but with a recent high-end CPU and software optimized for faster inference, such as llama.cpp, running Falcon 180B is possible.</p><p>If you are interested in using llama.cpp have a look at my article explaining how to run Vicuna using only the CPU:</p><div data-component-name="DigestPostEmbed"><div><a href="https://kaitchup.substack.com/p/high-speed-inference-with-llama-cpp-and-vicuna-on-cpu-136d28e7887b" target="_blank" rel="noopener" class=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_140,h_140,c_fill,f_webp,q_auto:good,fl_progressive:steep,g_auto/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd7225acc-9eac-4f41-ba0c-2c6a99da490d_800x535.jpeg"/><img src="https://substackcdn.com/image/fetch/w_140,h_140,c_fill,f_auto,q_auto:good,fl_progressive:steep,g_auto/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd7225acc-9eac-4f41-ba0c-2c6a99da490d_800x535.jpeg" sizes="100vw" alt="High-Speed Inference with llama.cpp and Vicuna on CPU" width="140" height="140"/></picture></div></a></div></div><p data-attrs="{&#34;url&#34;:&#34;https://kaitchup.substack.com/?utm_source=substack&amp;utm_medium=email&amp;utm_content=share&amp;action=share&#34;,&#34;text&#34;:&#34;Share The Kaitchup – AI on a Budget&#34;,&#34;action&#34;:null,&#34;class&#34;:null}" data-component-name="ButtonCreateButton"><a href="https://kaitchup.substack.com/?utm_source=substack&amp;utm_medium=email&amp;utm_content=share&amp;action=share" rel=""><span>Share The Kaitchup – AI on a Budget</span></a></p></div></div></div></div>
  </body>
</html>
