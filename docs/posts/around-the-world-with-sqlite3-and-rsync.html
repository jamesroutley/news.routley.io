<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://fly.io/ruby-dispatch/smooth-fly-dev/">Original</a>
    <h1>Around the World with SQLite3 and Rsync</h1>
    
    <div id="readability-page-1" class="page"><article> <dl> <dt>Author</dt> <dd> <img src="https://fly.io/static/images/sam.webp" alt="Sam Ruby" srcset=""/> <dl> <dt>Name</dt> <dd> Sam Ruby </dd> <dt>Social Media</dt> <dd> <a href="https://ruby.social/@samruby" target="_blank" rel="noopener noreferrer"> <span aria-hidden="true">@samruby</span> <span>View Fediverse Profile</span> </a> </dd> </dl> </dd> </dl> <section> <figure> <img src="https://fly.io/ruby-dispatch/2023-06-22/smooth-fly-dev-cover.webp" alt="Michael Jackson&#39;s anti-gravity lean from Smooth Criminal"/> <figcaption> <span>Image by</span> <svg role="img" style="pointer-events: none; width: 17px; height: 17px;" viewBox="0 0 20 20" fill="currentColor" fill-rule="evenodd"> <g buffered-rendering="static"> <path fill-rule="evenodd" d="M1 8a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 018.07 3h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0016.07 6H17a2 2 0 012 2v7a2 2 0 01-2 2H3a2 2 0 01-2-2V8zm13.5 3a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM10 14a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path> </g> </svg> <a href="https://annieruygtillustration.com/" target="_blank"> Annie Ruygt </a> </figcaption> </figure> <p><a href="http://fly.io/">Fly.io</a> runs apps close to users around the world. This same infrastructure can be used to route requests to where the data resides. <a href="https://fly.io/docs/speedrun/">Give us a whirl</a> and get up and running quickly.</p><p>Take a typical Rails application, run <code>fly launch</code>, then <code>fly deploy</code>, say yes a few times and you will have a Dockerfile provided for you, with two instances of your application up and running, a PostgreSQL database, and an Upstash Redis database.</p> <p>This is a great default, but should you desire to do so you are welcome to configure your application however you want. This can be done by updating your Dockerfile yourself, but you will rarely need to resort to this as <a href="https://github.com/fly-apps/dockerfile-rails">dockerfile-rails</a> provides lots of options to help with this process.</p> <p>This blog post will take you through the configuration of the <a href="https://github.com/rubys/showcase#showcase">showcase</a> application. Highlights:</p> <ul> <li>Each event is a separate instance of the same Rails application, with a separate sqlite3 database, and a separate active storage directory, both on a mounted <a href="https://fly.io/docs/reference/volumes/">volume</a>. </li><li>Multiple events in the same region run on the same machine using <a href="https://www.phusionpassenger.com/">Phusion Passenger</a> and share the same Action Cable process and redis instance. </li><li>Requests are <a href="https://fly.io/docs/reference/dynamic-request-routing/">dynamically routed</a> to the machine nearest to the event, and data is synchronized between machines using <a href="https://rsync.samba.org/">rsync</a>. </li><li>I&#39;m not sure I&#39;m going to keep it, but each machine is also running sshd enabling me to syncronize the content with machines outside of fly. </li></ul> <p>This application is running at <a href="https://smooth.fly.dev/showcase/">smooth.fly.dev</a>. You are welcome to see the index, but access to the individual event pages are password protected as they contain customer names, invoicing information, and scores.</p> <p>While a large number of techniques will be shown below, your needs are undoubtedly different, but hopefully these examples will inspire you to make your own customizations.</p> <h2 id="starting-with-a-single-event"><a href="#starting-with-a-single-event" aria-label="Anchor"></a>Starting with a single event</h2><p>We are going to start with one event, but in the process we will prepare for multiple events and multiple regions. This can be done using the following steps:</p> <ul> <li><p>Create a volume, and mount it. <code>fly launch</code> will do this automatically for Rails applications unless you select PostgreSQL.</p> </li><li><p>Set <code>DATABASE_URL</code> to <code>sqlite3:///data/db/2022-harrisburg.sqlite3</code>. This places the database on the volume, with a unique name per event. This can be done via <code>bin/rails generate dockerfile env=DATABASE_URL:sqlite3:///data/db/2022-harrisburg.sqlite3</code></p> </li><li><p>Set <code>RAILS_STORAGE</code> to <code>/data/storage/2022-harrisburg</code>, and update <code>config/storage.yml</code> as follows:</p> <pre>   local:
       service: Disk
       public: true
       root: &lt;%= ENV.fetch(&#39;RAILS_STORAGE&#39;,
                 Rails.root.join(&#34;storage&#34;)) %&gt;</pre> <p>This will place active storage files on the volume, again in a separate location per event.</p> </li><li><p>Install, configure, and launch redis. This requires a number of sub-steps:</p> <ul> <li><p>Create a <code>Procfile.fly</code> with the following contents:</p> <pre>   web: bin/rails server
   redis: redis-server /etc/redis/redis.conf </pre> <p>This will launch the rails and redis servers in separate processes.</p> </li><li><p>Create <code>config/deploy.fly</code> with the following contents:</p> <pre>   # configure redis
   RUN sed -i &#39;s/^daemonize yes/daemonize no/&#39; /etc/redis/redis.conf &amp;&amp;\
     sed -i &#39;s/^bind/# bind/&#39; /etc/redis/redis.conf &amp;&amp;\
     sed -i &#39;s/^protected-mode yes/protected-mode no/&#39; /etc/redis/redis.conf &amp;&amp;\
     sed -i &#39;s/^logfile/# logfile/&#39; /etc/redis/redis.conf &amp;&amp;\
     echo &#34;vm.overcommit_memory = 1&#34; &gt;&gt; /etc/sysctl.conf </pre> <p>Configuration of redis is beyond the scope of this blog post, but hopefully the above example makes clear that any Dockerfile instructions can be included.</p> </li><li><p>Run the following command to update your Dockerfile:</p> <pre>   bin/rails generate dockerfile --add=redis \
     --procfile=Procfile.fly --instructions=config/deploy.fly</pre> </li></ul> </li></ul> <p>While the above is indeed a fair amount of preparation, it illustrates how you can set environment variables, add packages, run multiple processes, and even add custom instructions to your Dockerfile in a way that retains the ability to regenerate the remaining portions of your Dockerfile at any time.</p> <figure> <figcaption> <p> It&#39;ll take less than 10 minutes to get your Rails application running globally.</p><p><a href="https://fly.io/docs/rails/"> Try Fly for free  <span>→</span> </a></p> </figcaption><p><img src="https://fly.io/static/images/cta-turtle.webp" srcset="/static/images/cta-turtle@2x.webp 2x" alt=""/></p></figure><h2 id="add-additional-events-in-the-same-region"><a href="#add-additional-events-in-the-same-region" aria-label="Anchor"></a>Add additional events in the same region</h2><p>While the Phusion Passenger documentation for <a href="https://www.phusionpassenger.com/library/dev/ruby/multitenancy_and_microservices.html">developing multiple applications and microservices with Passenger + Nginx</a> isn&#39;t written yet, it really is just a matter of following the instructions for <a href="https://www.phusionpassenger.com/library/deploy/nginx/deploy/ruby/#deploying-an-app-to-a-sub-uri-or-subdirectory">deploying an app to a sub-URI or subdirectory</a>, and repeating this step as many times as necessary.</p> <p>Once again, this involves multiple discrete steps. In the showcase application it starts with a <a href="https://github.com/rubys/showcase/blob/main/config/tenant/showcases.yml">showcases.yml</a> file containing the list of events and an <a href="https://github.com/rubys/showcase/blob/main/config/tenant/nginx-config.rb">nginx-config</a> script which generates the nginx configuration from this data and places the results into the <code>/etc/nginx/sites-enabled</code> directory.</p> <p>This script also has another responsibility: it runs <code>db:prepare</code> (and therefore <code>db:migrate</code>) against each of the databases in this region.</p> <p>This also implies that the right time to run this script is in place of the rails <code>db:prepare</code> script. Doing both, namely installing passenger and reconfiguring what script is run at startup, can be done with a single command:</p> <div><pre><code>bin/rails generate dockerfile --passenger \
  --migrate=config/tenant/nginx-config.rb
</code></pre></div><p>One last change needs to be made. In <code>Procfile.fly</code> we need to run <code>nginx</code> instead of <code>bin/rails server</code>:</p> <div><pre><code>web: nginx
redis: redis-server /etc/redis/redis.conf
</code></pre></div><h2 id="events-in-multiple-regions"><a href="#events-in-multiple-regions" aria-label="Anchor"></a>Events in multiple regions</h2><p>Much of this step builds on concepts in previous steps.</p> <p>We already have a script that builds an nginx configuration file. Fly machines have a number of <a href="https://fly.io/docs/reference/runtime-environment/">environment variables</a> set. We will make use of <code>FLY_REGION</code> and <code>PRIMARY_REGION</code>.</p> <p>In that generated nginx configuration we will produce <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/409">HTTP 409</a> responses that add the <a href="https://fly.io/docs/reference/dynamic-request-routing/#the-fly-replay-response-header">FLY-Replay</a> header, thus:</p> <div><pre><code># Charlotte
location /showcase/2023/charlotte {
  return 409 &#34;wrong region\n&#34;;
  add_header Fly-Replay region=atl always;
}

# Chicago
location /showcase/2023/chicago {
  return 409 &#34;wrong region\n&#34;;
  add_header Fly-Replay region=ord always;
}

# Clearwater - Glass Slipper Gala
location /showcase/2023/clearwater/glassslipper {
  return 409 &#34;wrong region\n&#34;;
  add_header Fly-Replay region=mia always;
}
</code></pre></div><p>Events that are in the current <code>FLY_REGION</code> continue to contain passenger directives. This means that the nginx configurtion file is different in each region. <a href="https://fly.io/ruby-dispatch/2023-06-22/showcase.conf">showcase.conf</a> contains an example of a full generated configuration.</p> <p>Perhaps more interesting is the use of <a href="https://rsync.samba.org/">rsync</a> and <a href="https://www.openssh.com/">openssh</a> to initially load and synchronize data. Installation is done via passing <code>--add rsync openssh-server</code> to the generate dockerfile command. Configuration is done by <a href="https://github.com/rubys/showcase/blob/main/config/deploy.fly">config/deploy.fly</a>. Next the migration script is changed to <a href="https://github.com/rubys/showcase/blob/main/bin/deploy">bin/deploy</a> which will load the volume with data from the primary region during startup. A few notes:</p> <ul> <li>Configuration is a matter of mapping directories to user ids, and allowing all accesses. As the port is not exposed to the external internet, this is safe. </li><li>As the rsync server is started as a daemon it can&#39;t be launched by a procfile. Instead it is launched by the deploy/migrate script. </li><li>Rsync is called on both the db and storage subdirectories, passing the <code>--update</code> flag indicating that only files that are newer in the primary region are to be copied. </li></ul> <p>Finally, a <a href="https://www.phusionpassenger.com/library/indepth/hooks.html#detached_process">detached_process</a> <a href="https://github.com/rubys/showcase/blob/main/bin/passenger-hook">passenger hook</a> is defined which is called after <a href="https://www.phusionpassenger.com/library/config/nginx/reference/#passenger_pool_idle_time">300 seconds of idle time</a>. This hook script checks how many processes remain and when there are no non-cable processes left it will use <a href="#">dig</a> commands to identify other <a href="https://fly.io/docs/reference/private-networking/#fly-internal-addresses">app instances</a> and call rsync to copy all files to them. Again the <code>--update</code> flag is specified so that only files that are newer on the source will be copied to the receiver.</p> <p>Rsync between fly machines runs quite fast, and running it when machines are idle means that eventually all machines have complete copies of all databases. In the future I may refine this strategy but as the databases are small (typically one megabyte or less), the comfort of knowing that there are multiple backups and the regions can be reconfigured at will outweigh the concerns of the additional disk space required.</p> <p>Separately, ssh is also set up to enable machines outside of the fly network to rsync automatically rsync data to and from volumes. Placing lines like the following in <code>~/.ssh/config</code> makes it easy:</p> <div><pre><code>Host smooth
  HostName smooth.fly.dev
  Port 2222
  User rails
Host mia.smooth
  HostName mia.smooth.internal
  ProxyJump rails@smooth.fly.dev:2222
  Port 2222
  User rails
</code></pre></div><h2 id="recap"><a href="#recap" aria-label="Anchor"></a>Recap</h2><p>The joy of this setup is that provisioning a new regions is as easy as running <a href="https://fly.io/docs/flyctl/machine-clone/">flyctl machine clone</a> passing the name of the new region. Adding events to existing or new regions is merely a matter of updating <a href="https://github.com/rubys/showcase/blob/main/config/tenant/showcases.yml">showcase.yml</a> and running <code>fly deploy</code>.</p> <p>I&#39;m also continuing to <a href="https://rubix.intertwingly.net/showcase/docs/ops/Hosting">host this application both at home and on Hetzner</a>. The experience I have gained from each has lead to numerous improvements in making dockerfile-rails work with fly.io. I still need to work out synchronization of authentication and do more testing before I make fly.io the primary for future events, but that will happen soon.</p> <p>As with everything distributed, a number of engineering trade-effs are involved, specifically:</p> <ul> <li>all static files (css, js, images) as well as the index page are all served from the machine closest to the requester. </li><li>accesses (both read and write) from users near to events will be fast. </li><li>accesses (even read-only) from users distant from events will be routed to the machine hosting the event. </li><li>while scaling CPUs and RAM is possible, creating a second machine in the same region is not supported. </li><li>deploying changes will require momentary downtime. </li></ul> <p>This blog post covered a lot of ground. It contained a mix of step by step instructions and a description and pointers to running code. It is not expected that others will mimic exactly this setup, but hopefully seeing how this application was set up will inspire others to configure their own network of machines using <a href="https://github.com/fly-apps/dockerfile-rails">dockerfile-rails</a>. Should there be interest, similar functionality can be added to <a href="https://github.com/fly-apps/dockerfile-node">dockerfile-node</a> and, over time, spread to other frameworks.</p> <p>Finally, take a peek at <a href="https://github.com/rubys/showcase/blob/main/config/dockerfile.yml">config/dockerfile.yml</a> to see the complete list of options I use, as well as the resulting <a href="https://github.com/rubys/showcase/blob/main/Dockerfile">Dockerfile</a>. If you have an interesting use case or set of options that believe may be useful to others, start a <a href="https://github.com/fly-apps/dockerfile-rails/discussions">discussion</a>, open an <a href="https://github.com/fly-apps/dockerfile-rails/issues">issue</a> or make a <a href="https://github.com/fly-apps/dockerfile-rails/pulls">pull request</a>.</p> <p>And you can always use <a href="https://community.fly.io/">community.fly.io</a> for more generic, or fly.io specific questions.</p>  </section> <dl> <dt> Previous post  ↓ </dt> <dd> <a href="https://fly.io/ruby-dispatch/ruby-kaigi-2023/"> RubyKaigi 2023: Matsumoto </a> </dd> </dl> </article></div>
  </body>
</html>
