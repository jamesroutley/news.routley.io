<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://wagslane.dev/posts/guard-keyword-error-handling-golang/">Original</a>
    <h1>Thoughts on the “Guard” Proposal for Go&#39;s Error Handling</h1>
    
    <div id="readability-page-1" class="page"><div>
        <p>I found <a href="https://github.com/golang/go/issues/31442">this proposal</a> for improvements to error handling in Go interesting, but still not something I’d be happy to see implemented.</p>
<p>Allow me to clear up my thoughts on Go’s errors. Overall, I <em>prefer</em> how Go forces me to think about errors at every turn. When working in try/catch languages like JavaScript, I often easily forget which functions can throw. Even if I do remember, it’s easy to think “I think this gets caught somewhere up the call chain”. It’s easy to ignore the fact that <em>things can go wrong</em>. I almost never have issues with unhandled errors in Go, and I love that.</p>
<p>Okay, so what <em>don’t</em> I like? Well like everyone else, I think 3 extra lines after most function calls just to do the same old error handling can bloat a codebase real quick. The <a href="https://go.googlesource.com/proposal/+/master/design/go2draft-error-handling-overview.md">classic example</a> looks like this.</p>
<p><em>The simple CopyFile function:</em></p>
<div><pre><code data-lang="go"><span>func</span> <span>CopyFile</span>(<span>src</span>, <span>dst</span> <span>string</span>) <span>throws</span> <span>error</span> {
	<span>r</span> <span>:=</span> <span>os</span>.<span>Open</span>(<span>src</span>)
	<span>defer</span> <span>r</span>.<span>Close</span>()

	<span>w</span> <span>:=</span> <span>os</span>.<span>Create</span>(<span>dst</span>)
	<span>io</span>.<span>Copy</span>(<span>w</span>, <span>r</span>)
	<span>w</span>.<span>Close</span>()
}
</code></pre></div><p><em>The actual CopyFile function:</em></p>
<div><pre><code data-lang="go"><span>func</span> <span>CopyFile</span>(<span>src</span>, <span>dst</span> <span>string</span>) <span>error</span> {
	<span>r</span>, <span>err</span> <span>:=</span> <span>os</span>.<span>Open</span>(<span>src</span>)
	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
		<span>return</span> <span>err</span>
	}
	<span>defer</span> <span>r</span>.<span>Close</span>()

	<span>w</span>, <span>err</span> <span>:=</span> <span>os</span>.<span>Create</span>(<span>dst</span>)
	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
		<span>return</span> <span>err</span>
	}
	<span>defer</span> <span>w</span>.<span>Close</span>()

	<span>if</span> <span>_</span>, <span>err</span> <span>:=</span> <span>io</span>.<span>Copy</span>(<span>w</span>, <span>r</span>); <span>err</span> <span>!=</span> <span>nil</span> {
		<span>return</span> <span>err</span>
	}
	<span>if</span> <span>err</span> <span>:=</span> <span>w</span>.<span>Close</span>(); <span>err</span> <span>!=</span> <span>nil</span> {
		<span>return</span> <span>err</span>
	}
}
</code></pre></div><h2 id="the-guardmust-proposal">The “guard/must” proposal</h2>
<div><pre><code data-lang="go"><span>func</span> <span>CopyFile</span>(<span>src</span>, <span>dst</span> <span>string</span>) (<span>err</span> <span>error</span>) {
	<span>defer</span> <span>func</span>() {
		<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
			<span>err</span> = <span>fmt</span>.<span>Errorf</span>(<span>&#34;copy %s to %s: %v&#34;</span>, <span>src</span>, <span>dst</span>, <span>err</span>)
		}
	}()

	<span>r</span> <span>:=</span> <span>guard</span> <span>os</span>.<span>Open</span>(<span>src</span>) 
	<span>defer</span> <span>must</span> <span>r</span>.<span>Close</span>()		

	<span>w</span> <span>:=</span> <span>guard</span> <span>os</span>.<span>Create</span>(<span>dst</span>)
	<span>defer</span> <span>must</span> <span>w</span>.<span>Close</span>()

	<span>err</span> = <span>io</span>.<span>Copy</span>(<span>w</span>, <span>r</span>)
	
	<span>// here we need to do extra stuff when an Copy error happens: now we must use the &#39;normal&#39; error handling method, and cannot use guard or must
</span><span></span>	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> { 
		<span>_</span> <span>:=</span> <span>os</span>.<span>Remove</span>(<span>dst</span>) <span>// fail silently if errors happen during error handling
</span><span></span>	}
	<span>return</span>
}
</code></pre></div><p>I’m going to be honest, I don’t think this “guard/must” proposal is a big improvement in terms of practicality. The basic idea here is that:</p>
<ul>
<li>The <code>guard</code> keyword is syntactic sugar to return from a function when a function call returns in an error</li>
<li>The <code>must</code> keyword is syntactic sugar to <code>panic</code> on any error returned by a function call</li>
</ul>
<h2 id="problem-1---we-dont-need-syntactic-sugar-for-panic">Problem #1 - We don’t need syntactic sugar for panic</h2>
<p><a href="https://go.dev/doc/effective_go#panic">Panicking in Go is a code smell</a>. We shouldn’t be doing it very often, and when we do, I’m okay with it being a bit of a pain to write.</p>
<h2 id="problem-2---missing-context">Problem #2 - Missing context</h2>
<p>Strictly returning errors in Go isn’t always the best way to handle them, in fact it’s usually not. It’s best to <a href="https://blog.boot.dev/golang/wrapping-errors-in-go-how-to-handle-nested-errors/">wrap them</a> with additional context. For example:</p>
<div><pre><code data-lang="go"><span>func</span> <span>CopyFile</span>(<span>src</span>, <span>dst</span> <span>string</span>) <span>error</span> {
    <span>r</span>, <span>err</span> <span>:=</span> <span>os</span>.<span>Open</span>(<span>src</span>)
    <span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
        <span>return</span> <span>fmt</span>.<span>Errorf</span>(<span>&#34;could not copy file: %w&#34;</span>, <span>err</span>)
    }
    <span>...</span>
}
</code></pre></div><p>This proposal uses a <code>defer</code> function to add context to errors, which has several problems:</p>
<ul>
<li>Any lines of code salvaged by the <code>guard</code> keyword are lost by the new deferred func</li>
<li>It’s not simple, clear, or easy to understand</li>
<li>The context added to all the errors in the function must be identical</li>
</ul>
<h2 id="whats-a-better-solution">What’s a better solution?</h2>
<p>I love the idea of a <code>guard</code> keyword. I think it fits nicely within the pattern of <a href="https://blog.boot.dev/clean-code/guard-clauses/">guard clauses in Go</a>.</p>
<p>What if, instead, we forget the <code>must</code> keyword, and the <code>guard</code> keyword simply operates on a single error expression? Here’s what that could look like:</p>
<div><pre><code data-lang="go"><span>func</span> <span>CopyFile</span>(<span>src</span>, <span>dst</span> <span>string</span>) <span>error</span> {
	<span>r</span>, <span>err</span> <span>:=</span> <span>os</span>.<span>Open</span>(<span>src</span>)
	<span>guard</span> <span>err</span>
	<span>defer</span> <span>r</span>.<span>Close</span>()

	<span>w</span>, <span>err</span> <span>:=</span> <span>os</span>.<span>Create</span>(<span>dst</span>)
	<span>guard</span> <span>fmt</span>.<span>Guardf</span>(<span>&#34;could not create file to copy: %w&#34;</span>, <span>err</span>)
	<span>defer</span> <span>w</span>.<span>Close</span>()

	<span>guard</span> <span>io</span>.<span>Copy</span>(<span>w</span>, <span>r</span>)
	<span>guard</span> <span>w</span>.<span>Close</span>()
}
</code></pre></div><h3 id="notes">Notes</h3>
<ol>
<li>In the case that the <code>CopyFile</code> returns more than just a single error, <code>guard</code> would return zero values for everything but the non-nil error.</li>
<li>I made up the <code>fmt.Guardf</code> function. We would need <em>something</em> like this. It’s a version of <code>fmt.Errorf</code> that returns <code>nil</code> if the error that’s passed in is <code>nil</code>.</li>
</ol>
<p>I think <em>something like this</em> could solve the only real problem with Go errors: How do we save those 3 lines of code while still encouraging good error wrapping?</p>

    </div></div>
  </body>
</html>
