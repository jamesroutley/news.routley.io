<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.otterstack.com/posts/202512-gbshader/">Original</a>
    <h1>I put a real-time 3D shader on the Game Boy Color</h1>
    
    <div id="readability-page-1" class="page"><article><h2 id="demonstration">Demonstration</h2>
<p>I made a Game Boy Color game that renders images in real time. The player controls an orbiting light and spins an object.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/SAQXEW3ePwo?si=YgqBeQYtj3VWzm8G" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>
<h3 id="play-it-here">Play it here</h3>

<h3 id="check-out-the-code-download-the-roms">Check out the code, download the ROMs</h3>
<p><a href="https://github.com/nukep/gbshader" target="_blank" rel="noopener noreferrer nofollow">https://github.com/nukep/gbshader</a></p>
<h2 id="3d-workflow">3D Workflow</h2>
<h3 id="early-lookdev">Early lookdev</h3>
<p>Before really diving into this project, I experimented with the look in Blender to see if it would even look good. IMO it did, so I went ahead with it!</p>
<p>I experimented with a &#34;pseudo-dither&#34; on the Blender monkey by adding a small random vector to each normal.</p>
<p><img src="https://blog.otterstack.com/posts/202512-gbshader/teapot-optimizeddot.gif" alt="" loading="lazy"/> <img src="https://blog.otterstack.com/posts/202512-gbshader/monkey.gif" alt="" loading="lazy"/></p>
<p><img src="https://blog.otterstack.com/posts/202512-gbshader/lookdev-0824.png" alt="" loading="lazy" width="800" height="358"/></p>
<h3 id="blender-to-normal-map-workflow">Blender to normal map workflow</h3>
<p>tl;dr: Cryptomattes and custom shaders to adjust normal maps</p>
<p>It doesn&#39;t really matter what software I used to produce the normal maps. Blender was the path of least resistance for me, so I chose that.</p>
<p>For the teapot, I simply put in a teapot, rotated a camera around it, and exported the normal AOV as a PNG sequence. Pretty straight-forward.</p>
<p>For the spinning Game Boy Color, I wanted to ensure that certain colors were solid, so I used cryptomattes in the compositor to identify specific geometry and output hard-coded values in the output.</p>
<p>The geometry in the screen was done by rendering a separate scene, then compositing it in the final render using a cryptomatte for the screen.</p>
<p><img src="https://blog.otterstack.com/posts/202512-gbshader/lookdev-0830.png" alt="" loading="lazy" width="800" height="392"/></p>
<h2 id="the-math">The Math</h2>
<h3 id="normal-maps">Normal Maps</h3>
<p><img src="https://blog.otterstack.com/posts/202512-gbshader/gbspin_normal.gif" alt="" loading="lazy"/> <img src="https://blog.otterstack.com/posts/202512-gbshader/teapot_normal.gif" alt="" loading="lazy"/></p>
<p><em>The above animations are normal map frames that are used to solve the value of each pixel</em></p>
<p>Normal maps are a core concept of this project. They&#39;re already used everywhere in 3D graphics.</p>
<p><strong>And indeed, normal map images are secretly a vector field</strong>. The reason normal maps tend to have a blue-ish baseline color, is because everyone likes to associate XYZ with RGB, and +Z is the forward vector by convention.</p>
<p>In a typical 3D workflow, a normal map is used to encode the normal vector at any given point on a textured mesh.</p>

<p><em>Source: Own work (Danny Spencer). Suzanne model (c) Blender Foundation.</em></p>
<h3 id="calculating-a-lambert-shader-using-dot-products">Calculating a Lambert shader using dot products</h3>
<p>The simplest way to shade a 3D object is using the dot product:</p>
<p><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>v</mi><mo>=</mo><mi mathvariant="bold">N</mi><mo>⋅</mo><mi mathvariant="bold">L</mi></mrow><annotation encoding="application/x-tex">v = \mathbf{N} \cdot \mathbf{L}</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>v</span><span></span><span>=</span><span></span></span><span><span></span><span>N</span><span></span><span>⋅</span><span></span></span><span><span></span><span>L</span></span></span></span></span></p>
<p>where <span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>N</span></span></span></span></span> is the normal vector, and <span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>L</span></span></span></span></span> is the light position when it points towards the origin (or equivalently: the negative light direction).</p>
<p>Expanded out component-wise, this is:</p>
<p><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>v</mi><mo>=</mo><msub><mi mathvariant="bold">N</mi><mi>x</mi></msub><msub><mi mathvariant="bold">L</mi><mi>x</mi></msub><mo>+</mo><msub><mi mathvariant="bold">N</mi><mi>y</mi></msub><msub><mi mathvariant="bold">L</mi><mi>y</mi></msub><mo>+</mo><msub><mi mathvariant="bold">N</mi><mi>z</mi></msub><msub><mi mathvariant="bold">L</mi><mi>z</mi></msub></mrow><annotation encoding="application/x-tex">v = \mathbf{N}_x\mathbf{L}_x + \mathbf{N}_y \mathbf{L}_y + \mathbf{N}_z\mathbf{L}_z</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>v</span><span></span><span>=</span><span></span></span><span><span></span><span><span>N</span><span><span><span><span><span><span></span><span><span>x</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>L</span><span><span><span><span><span><span></span><span><span>x</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>N</span><span><span><span><span><span><span></span><span><span>y</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>L</span><span><span><span><span><span><span></span><span><span>y</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>N</span><span><span><span><span><span><span></span><span><span>z</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>L</span><span><span><span><span><span><span></span><span><span>z</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></p>
<p>When the light vector is constant for all pixels, it models what most 3D graphics software calls a &#34;distant light&#34;, or a &#34;sun light&#34;.</p>
<h3 id="spherical-coordinates">Spherical Coordinates</h3>
<p>To speed up computation on the Game Boy, I use an alternate version of the dot product, using spherical coordinates.</p>
<p>A <strong>spherical coordinate</strong> is a point represented by a radius <span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>r</span></span></span></span></span>, a primary angle <span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>θ</span></span></span></span></span> &#34;theta&#34;, and a secondary angle <span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi></mrow><annotation encoding="application/x-tex">\varphi</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>φ</span></span></span></span></span> &#34;phi&#34;. This is represented as a tuple: <span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>r</mi><mo separator="true">,</mo><mi>θ</mi><mo separator="true">,</mo><mi>φ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(r, \theta, \varphi)</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>(</span><span>r</span><span>,</span><span></span><span>θ</span><span>,</span><span></span><span>φ</span><span>)</span></span></span></span></span></p>
<p>The dot product of two spherical coordinates:</p>
<p><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>r</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>θ</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>φ</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo>⋅</mo><mo stretchy="false">(</mo><msub><mi>r</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>θ</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>φ</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>=</mo><msub><mi>r</mi><mn>1</mn></msub><msub><mi>r</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>sin</mi><mo>⁡</mo><msub><mi>θ</mi><mn>1</mn></msub><mi>sin</mi><mo>⁡</mo><msub><mi>θ</mi><mn>2</mn></msub><mi>cos</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>φ</mi><mn>1</mn></msub><mo>−</mo><msub><mi>φ</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>+</mo><mi>cos</mi><mo>⁡</mo><msub><mi>θ</mi><mn>1</mn></msub><mi>cos</mi><mo>⁡</mo><msub><mi>θ</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(r_1, \theta_1, \varphi_1) \cdot (r_2, \theta_2, \varphi_2) = r_1r_2 (\sin \theta_1 \sin \theta_2 \cos(\varphi_1 - \varphi_2) + \cos \theta_1 \cos \theta_2)</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>(</span><span><span>r</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>θ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>φ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>⋅</span><span></span></span><span><span></span><span>(</span><span><span>r</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>θ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span><span>φ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>r</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span><span>r</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>sin</span><span></span><span><span>θ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>sin</span><span></span><span><span>θ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>cos</span><span>(</span><span><span>φ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>−</span><span></span></span><span><span></span><span><span>φ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span>cos</span><span></span><span><span>θ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>cos</span><span></span><span><span>θ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span></span></span></span></span></p>
<p>Because all normal vectors are unit length, and the light vector is unit length, we can just assume the radius <span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>r</span></span></span></span></span> is equal to 1. This simplifies to:</p>
<p><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>v</mi><mo>=</mo><mi>sin</mi><mo>⁡</mo><msub><mi>θ</mi><mn>1</mn></msub><mi>sin</mi><mo>⁡</mo><msub><mi>θ</mi><mn>2</mn></msub><mi>cos</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>φ</mi><mn>1</mn></msub><mo>−</mo><msub><mi>φ</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>+</mo><mi>cos</mi><mo>⁡</mo><msub><mi>θ</mi><mn>1</mn></msub><mi>cos</mi><mo>⁡</mo><msub><mi>θ</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">v = \sin \theta_1 \sin \theta_2 \cos(\varphi_1 - \varphi_2) + \cos \theta_1 \cos \theta_2</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>v</span><span></span><span>=</span><span></span></span><span><span></span><span>sin</span><span></span><span><span>θ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>sin</span><span></span><span><span>θ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>cos</span><span>(</span><span><span>φ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>−</span><span></span></span><span><span></span><span><span>φ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span>cos</span><span></span><span><span>θ</span><span><span><span><span><span><span></span><span><span>1</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>cos</span><span></span><span><span>θ</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></p>
<p>And using the previous variable names, we get the formula:</p>
<p><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>v</mi><mo>=</mo><mi>sin</mi><mo>⁡</mo><msub><mi>N</mi><mi>θ</mi></msub><mi>sin</mi><mo>⁡</mo><msub><mi>L</mi><mi>θ</mi></msub><mi>cos</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>N</mi><mi>φ</mi></msub><mo>−</mo><msub><mi>L</mi><mi>φ</mi></msub><mo stretchy="false">)</mo><mo>+</mo><mi>cos</mi><mo>⁡</mo><msub><mi>N</mi><mi>θ</mi></msub><mi>cos</mi><mo>⁡</mo><msub><mi>L</mi><mi>θ</mi></msub></mrow><annotation encoding="application/x-tex">v = \sin N_\theta \sin L_\theta \cos(N_\varphi - L_\varphi) + \cos N_\theta \cos L_\theta</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>v</span><span></span><span>=</span><span></span></span><span><span></span><span>sin</span><span></span><span><span>N</span><span><span><span><span><span><span></span><span><span>θ</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>sin</span><span></span><span><span>L</span><span><span><span><span><span><span></span><span><span>θ</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>cos</span><span>(</span><span><span>N</span><span><span><span><span><span><span></span><span><span>φ</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>−</span><span></span></span><span><span></span><span><span>L</span><span><span><span><span><span><span></span><span><span>φ</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span>cos</span><span></span><span><span>N</span><span><span><span><span><span><span></span><span><span>θ</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>cos</span><span></span><span><span>L</span><span><span><span><span><span><span></span><span><span>θ</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></p>
<h2 id="making-it-work-on-the-game-boy">Making it work on the Game Boy</h2>
<h3 id="encoding-normal-maps-in-the-game-boy-rom">Encoding normal maps in the Game Boy ROM</h3>
<p>In the ROM, I decided to fix <span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mi>θ</mi></msub></mrow><annotation encoding="application/x-tex">L_\theta</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span>L</span><span><span><span><span><span><span></span><span><span>θ</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> &#34;L-theta&#34; to a constant value for performance reasons. The player gets to control <span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mi>φ</mi></msub></mrow><annotation encoding="application/x-tex">L_\varphi</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span>L</span><span><span><span><span><span><span></span><span><span>φ</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span> &#34;L-phi&#34;, creating an <strong>orbiting light</strong> effect.</p>
<p>This means that we can extract constant coefficients <span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>m</span></span></span></span></span> and <span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>b</span></span></span></span></span> and rewrite the formula:</p>
<p><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>m</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>sin</mi><mo>⁡</mo><msub><mi>N</mi><mi>θ</mi></msub><mi>sin</mi><mo>⁡</mo><msub><mi>L</mi><mi>θ</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>b</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>cos</mi><mo>⁡</mo><msub><mi>N</mi><mi>θ</mi></msub><mi>cos</mi><mo>⁡</mo><msub><mi>L</mi><mi>θ</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>v</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>m</mi><mi>cos</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>N</mi><mi>φ</mi></msub><mo>−</mo><msub><mi>L</mi><mi>φ</mi></msub><mo stretchy="false">)</mo><mo>+</mo><mi>b</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
m &amp;= \sin N_\theta \sin L_\theta \\
b &amp;= \cos N_\theta \cos L_\theta \\
v &amp;= m \cos(N_\varphi - L_\varphi) + b
\end{aligned}</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span><span><span><span><span><span><span></span><span><span>m</span></span></span><span><span></span><span><span>b</span></span></span><span><span></span><span><span>v</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>sin</span><span></span><span><span>N</span><span><span><span><span><span><span></span><span><span>θ</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>sin</span><span></span><span><span>L</span><span><span><span><span><span><span></span><span><span>θ</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>cos</span><span></span><span><span>N</span><span><span><span><span><span><span></span><span><span>θ</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>cos</span><span></span><span><span>L</span><span><span><span><span><span><span></span><span><span>θ</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>m</span><span></span><span>cos</span><span>(</span><span><span>N</span><span><span><span><span><span><span></span><span><span>φ</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>−</span><span></span><span><span>L</span><span><span><span><span><span><span></span><span><span>φ</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span><span>b</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>The ROM encodes each pixel as a 3-byte tuple of <span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>N</mi><mi>φ</mi></msub><mo separator="true">,</mo><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(N_\varphi, \log(m), b)</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>(</span><span><span>N</span><span><span><span><span><span><span></span><span><span>φ</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>,</span><span></span><span>lo<span>g</span></span><span>(</span><span>m</span><span>)</span><span>,</span><span></span><span>b</span><span>)</span></span></span></span></span>.</p>
<p>Why <span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\log(m)</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>lo<span>g</span></span><span>(</span><span>m</span><span>)</span></span></span></span></span>? Well...</p>
<h3 id="the-game-boy-has-no-multiply-instruction">The Game Boy has no multiply instruction</h3>
<p>Not only does the SM83 CPU <em>not</em> support multiplication, but it also doesn&#39;t support floats. That&#39;s a real bummer.</p>
<p>We have to get really creative when the entire mathematical foundation of this project involves multiplying non-integer numbers.</p>
<p>What do we do instead? We use logarithms and lookup tables!</p>
<p>Logarithms have this nice property of being able to factor products to outside the <span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>log</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\log</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>lo<span>g</span></span></span></span></span></span>. This way, we can add values instead!</p>
<p><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mi>b</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo>⋅</mo><mi>y</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mi>b</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>+</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mi>b</mi></msub><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>x</mi><mo>⋅</mo><mi>y</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msup><mi>b</mi><mrow><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>+</mo><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo></mrow></msup></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\log_b(x \cdot y) &amp;= \log_b(x) + \log_b(y) \\
x \cdot y &amp;= b^{\log(x) + \log(y)}
\end{aligned}</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span><span><span><span><span><span><span></span><span><span><span>lo<span>g</span></span><span><span><span><span><span><span></span><span><span>b</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>x</span><span></span><span>⋅</span><span></span><span>y</span><span>)</span></span></span><span><span></span><span><span>x</span><span></span><span>⋅</span><span></span><span>y</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span>lo<span>g</span></span><span><span><span><span><span><span></span><span><span>b</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>x</span><span>)</span><span></span><span>+</span><span></span><span><span>lo<span>g</span></span><span><span><span><span><span><span></span><span><span>b</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span>y</span><span>)</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span>b</span><span><span><span><span><span><span></span><span><span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>x</span><span>)</span><span>+</span><span><span>l</span><span>o</span><span>g</span></span><span>(</span><span>y</span><span>)</span></span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>This requires two lookups: a <code>log</code> lookup, and a <code>pow</code> lookup.</p>
<p>In pseudocode, multiplying 0.3 and 0.5 looks like this:</p>
<pre><code><span>pow</span> = [ ... ]              



x = float_to_logspace(<span>0.3</span>) 
y = float_to_logspace(<span>0.5</span>)

result = <span>pow</span>[x + y]
</code></pre>
<p>One limitation of this is that it&#39;s not possible to take the log of a negative number. e.g. <span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\log(-1)</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>lo<span>g</span></span><span>(</span><span>−</span><span>1</span><span>)</span></span></span></span></span> has no real solution.</p>
<p>We can overcome this by encoding a &#34;sign&#34; bit in the MSB of the log-space value. When adding two log-space values together, the sign bit is effectively XOR&#39;d (toggled). We just need to ensure the remaining bits don&#39;t overflow into it. We ensure this by keeping the remaining bits small enough.</p>
<p>The <code>pow</code> lookup accounts for this bit and returns a positive or negative result based on it.</p>
<h3 id="all-scalars-and-lookups-are-8-bit-fractions">All scalars and lookups are 8-bit fractions</h3>
<p>It&#39;s advantageous to restrict numbers to a single byte, for both run-time performance and ROM size. 8-bit fractions are pretty extreme by today&#39;s standards, but believe it or not, it works. It&#39;s lossy as hell, but it works!</p>
<p>All scalars we&#39;re working with are between -1.0 and +1.0.</p>
<div>





































































<table><thead><tr><th>Byte</th><th>Resolved linear-space value</th><th>Resolved log-space value</th></tr></thead><tbody><tr><td>0</td><td><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>0</mn><mn>127</mn></mfrac><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">{0 \over 127} = 0</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>127</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>0</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>0</span></span></span></span></span></td><td><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>0</mn></msup><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{0} = 1</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>0</span></span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>1</span></span></span></span></span></td></tr><tr><td>1</td><td><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><mn>127</mn></mfrac><mo>≈</mo><mn>0.0079</mn></mrow><annotation encoding="application/x-tex">{1 \over 127} \approx 0.0079</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>127</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span><span></span><span>≈</span><span></span></span><span><span></span><span>0.0079</span></span></span></span></span></td><td><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mrow><mo>−</mo><mfrac><mn>1</mn><mn>6</mn></mfrac></mrow></msup><mo>≈</mo><mn>0.89</mn></mrow><annotation encoding="application/x-tex">2^{- {1 \over 6}} \approx 0.89</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>−</span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>6</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>≈</span><span></span></span><span><span></span><span>0.89</span></span></span></span></span></td></tr><tr><td>2</td><td><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>2</mn><mn>127</mn></mfrac><mo>≈</mo><mn>0.0158</mn></mrow><annotation encoding="application/x-tex">{2 \over 127} \approx 0.0158</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>127</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>2</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span><span></span><span>≈</span><span></span></span><span><span></span><span>0.0158</span></span></span></span></span></td><td><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mrow><mo>−</mo><mfrac><mn>2</mn><mn>6</mn></mfrac></mrow></msup><mo>≈</mo><mn>0.79</mn></mrow><annotation encoding="application/x-tex">2^{- {2 \over 6}} \approx 0.79</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>−</span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>6</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>2</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>≈</span><span></span></span><span><span></span><span>0.79</span></span></span></span></span></td></tr><tr><td>...</td><td></td><td></td></tr><tr><td>126</td><td><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>126</mn><mn>127</mn></mfrac><mo>≈</mo><mn>0.9921</mn></mrow><annotation encoding="application/x-tex">{126 \over 127} \approx 0.9921</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>127</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>126</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span><span></span><span>≈</span><span></span></span><span><span></span><span>0.9921</span></span></span></span></span></td><td><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mrow><mo>−</mo><mfrac><mn>126</mn><mn>6</mn></mfrac></mrow></msup><mo>≈</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">{2^{-{126 \over 6}}} \approx 0</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>−</span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>6</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>126</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>≈</span><span></span></span><span><span></span><span>0</span></span></span></span></span></td></tr><tr><td>127</td><td><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>127</mn><mn>127</mn></mfrac><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">{127 \over 127} = 1</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>127</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>127</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>1</span></span></span></span></span></td><td><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mrow><mo>−</mo><mfrac><mn>127</mn><mn>6</mn></mfrac></mrow></msup><mo>≈</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">{2^{-{127 \over 6}}} \approx 0</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>−</span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>6</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>127</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>≈</span><span></span></span><span><span></span><span>0</span></span></span></span></span></td></tr><tr><td>128</td><td>undefined</td><td><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><msup><mn>2</mn><mn>0</mn></msup><mo>=</mo><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">-2^{0} = -1</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>−</span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>0</span></span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>−</span><span>1</span></span></span></span></span></td></tr><tr><td>129</td><td><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mfrac><mn>127</mn><mn>127</mn></mfrac><mo>=</mo><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">-{127 \over 127} = -1</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>−</span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>127</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>127</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span>−</span><span>1</span></span></span></span></span></td><td><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><msup><mn>2</mn><mrow><mo>−</mo><mfrac><mn>1</mn><mn>6</mn></mfrac></mrow></msup><mo>≈</mo><mo>−</mo><mn>0.89</mn></mrow><annotation encoding="application/x-tex">-2^{- {1 \over 6}} \approx -0.89</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>−</span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>−</span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>6</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>≈</span><span></span></span><span><span></span><span>−</span><span>0.89</span></span></span></span></span></td></tr><tr><td>130</td><td><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mfrac><mn>126</mn><mn>127</mn></mfrac><mo>≈</mo><mo>−</mo><mn>0.9921</mn></mrow><annotation encoding="application/x-tex">-{126 \over 127} \approx -0.9921</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>−</span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>127</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>126</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span><span></span><span>≈</span><span></span></span><span><span></span><span>−</span><span>0.9921</span></span></span></span></span></td><td><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><msup><mn>2</mn><mrow><mo>−</mo><mfrac><mn>2</mn><mn>6</mn></mfrac></mrow></msup><mo>≈</mo><mo>−</mo><mn>0.79</mn></mrow><annotation encoding="application/x-tex">-2^{- {2 \over 6}} \approx -0.79</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>−</span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>−</span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>6</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>2</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>≈</span><span></span></span><span><span></span><span>−</span><span>0.79</span></span></span></span></span></td></tr><tr><td>...</td><td></td><td></td></tr><tr><td>254</td><td><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mfrac><mn>2</mn><mn>127</mn></mfrac><mo>≈</mo><mo>−</mo><mn>0.0158</mn></mrow><annotation encoding="application/x-tex">-{2 \over 127} \approx -0.0158</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>−</span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>127</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>2</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span><span></span><span>≈</span><span></span></span><span><span></span><span>−</span><span>0.0158</span></span></span></span></span></td><td><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><msup><mn>2</mn><mrow><mo>−</mo><mfrac><mn>126</mn><mn>6</mn></mfrac></mrow></msup><mo>≈</mo><mo>−</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">-{2^{-{126 \over 6}}} \approx -0</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>−</span><span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>−</span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>6</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>126</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>≈</span><span></span></span><span><span></span><span>−</span><span>0</span></span></span></span></span></td></tr><tr><td>255</td><td><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mfrac><mn>1</mn><mn>127</mn></mfrac><mo>≈</mo><mo>−</mo><mn>0.0079</mn></mrow><annotation encoding="application/x-tex">-{1 \over 127} \approx -0.0079</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>−</span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>127</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span><span></span><span>≈</span><span></span></span><span><span></span><span>−</span><span>0.0079</span></span></span></span></span></td><td><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><msup><mn>2</mn><mrow><mo>−</mo><mfrac><mn>127</mn><mn>6</mn></mfrac></mrow></msup><mo>≈</mo><mo>−</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">-{2^{-{127 \over 6}}} \approx -0</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>−</span><span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>−</span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>6</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>127</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>≈</span><span></span></span><span><span></span><span>−</span><span>0</span></span></span></span></span></td></tr></tbody></table></div>
<p>Addition and multiplication both use... addition!</p>
<p>Consider adding the two bytes: 5 + 10 = 15</p>
<ul>
<li><strong>Addition uses linear-space values</strong>: <span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>5</mn><mn>127</mn></mfrac><mo>+</mo><mfrac><mn>10</mn><mn>127</mn></mfrac><mo>=</mo><mfrac><mn>15</mn><mn>127</mn></mfrac></mrow><annotation encoding="application/x-tex">{5 \over 127} + {10 \over 127} = {15 \over 127}</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>127</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>5</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>127</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>10</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>127</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>15</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span></span></span></span></li>
<li><strong>Multiplication uses log-space values:</strong>  <span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mrow><mo>−</mo><mfrac><mn>5</mn><mn>6</mn></mfrac></mrow></msup><mo>⋅</mo><msup><mn>2</mn><mrow><mo>−</mo><mfrac><mn>10</mn><mn>6</mn></mfrac></mrow></msup><mo>=</mo><msup><mn>2</mn><mrow><mo>−</mo><mfrac><mn>15</mn><mn>6</mn></mfrac></mrow></msup></mrow><annotation encoding="application/x-tex">2^{-{5 \over 6}} \cdot 2^{-{10 \over 6}} = 2^{-{15 \over 6}}</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>−</span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>6</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>5</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>⋅</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>−</span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>6</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>10</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span></span></span></span></span></span></span></span><span></span><span>=</span><span></span></span><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span>−</span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>6</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>15</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></li>
</ul>
<p>Why is the denominator 127 instead of 128? It&#39;s because I needed to represent both positive and negative 1. In a two&#39;s-complement encoding, signed positive 128 doesn&#39;t exist.</p>
<p>You might notice that the log-space values cycle and become negative at byte 128. The log-space values use bit 7 of the byte to encode the &#34;sign&#34; bit. As mentioned in the previous section, this is important for toggling the sign during multiplication.</p>
<p>The log-space values also use <span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mfrac><mn>1</mn><mn>6</mn></mfrac></msup></mrow><annotation encoding="application/x-tex">2^{1 \over 6}</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span>2</span><span><span><span><span><span><span></span><span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>6</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>1</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> as a base, because I chose this as a sufficiently small base to meet the requirement that adding 3 of these log-space values won&#39;t overflow (42+42+42 = 126). Bytes 43 thru 127 are near 0, so in practice the ROM doesn&#39;t encode these values.</p>
<p>The lookup tables look like this:</p>
<p><img src="https://blog.otterstack.com/posts/202512-gbshader/lookup_tables.png" alt="" loading="lazy" width="800" height="285"/></p>
<p>Where:</p>
<ul>
<li><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>encode</mtext><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{encode}(y)</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span>encode</span></span><span>(</span><span>y</span><span>)</span></span></span></span></span> takes a real number and returns an unsigned byte.</li>
<li><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>decode</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{decode}(x)</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span>decode</span></span><span>(</span><span>x</span><span>)</span></span></span></span></span> takes an unsigned byte and returns a return number.
And:</li>
<li><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>encode</mtext><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>round</mtext><mo stretchy="false">(</mo><mn>127</mn><mi>y</mi><mo stretchy="false">)</mo><mtext> </mtext><mo lspace="0.22em" rspace="0.22em"><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow></mo><mtext> </mtext><mn>256</mn></mrow><annotation encoding="application/x-tex">\text{encode}(y) = \text{round}(127y) \bmod 256</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span>encode</span></span><span>(</span><span>y</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span>round</span></span><span>(</span><span>127</span><span>y</span><span>)</span><span></span><span></span><span><span><span>mod</span></span></span><span></span><span></span></span><span><span></span><span>256</span></span></span></span></span></li>
<li><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>decode</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mtext>signedbyte</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><mn>127</mn></mfrac></mrow><annotation encoding="application/x-tex">\text{decode}(x) = {\text{signedbyte}(x) \over 127}</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span>decode</span></span><span>(</span><span>x</span><span>)</span><span></span><span>=</span><span></span></span><span><span></span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>127</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span><span>signedbyte</span></span><span>(</span><span>x</span><span>)</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span></span></span></span></li>
</ul>
<p>Reconstructed functions look like this. The precision error is shown in the jagged &#34;staircase&#34; patterns:</p>
<p><img src="https://blog.otterstack.com/posts/202512-gbshader/lookups_reconstructed.png" alt="" loading="lazy" width="800" height="305"/></p>
<p>It may look like there&#39;s a lot of error, but it&#39;s fast and it&#39;s passable enough to look alright! ;)</p>
<h3 id="whats-with-cos_log">What&#39;s with cos_log?</h3>
<p>It&#39;s basically a combined <span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>cos</mi><mo>⁡</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\log(\cos x)</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>lo<span>g</span></span><span>(</span><span>cos</span><span></span><span>x</span><span>)</span></span></span></span></span>. This exists because in practice, cosine is always used with a multiplication.</p>
<p>The core calculation for the shader is:</p>
<p><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>v</mi><mo>=</mo><mi>m</mi><mi>cos</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>N</mi><mi>φ</mi></msub><mo>−</mo><msub><mi>L</mi><mi>φ</mi></msub><mo stretchy="false">)</mo><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">v = m \cos(N_\varphi - L_\varphi) + b</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>v</span><span></span><span>=</span><span></span></span><span><span></span><span>m</span><span></span><span>cos</span><span>(</span><span><span>N</span><span><span><span><span><span><span></span><span><span>φ</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>−</span><span></span></span><span><span></span><span><span>L</span><span><span><span><span><span><span></span><span><span>φ</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>)</span><span></span><span>+</span><span></span></span><span><span></span><span>b</span></span></span></span></span></p>
<p>And we can rewrite it as:</p>
<p><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>v</mi><mo>=</mo><mtext>pow</mtext><mo stretchy="false">(</mo><msub><mi>m</mi><mrow><mi>l</mi><mi>o</mi><mi>g</mi></mrow></msub><mo>+</mo><msub><mrow><mi>cos</mi><mo>⁡</mo></mrow><mrow><mi>l</mi><mi>o</mi><mi>g</mi></mrow></msub><mo stretchy="false">(</mo><msub><mi>N</mi><mi>φ</mi></msub><mo>−</mo><msub><mi>L</mi><mi>φ</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">v = \text{pow}(m_{log} + \cos_{log}(N_\varphi - L_\varphi)) + b</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>v</span><span></span><span>=</span><span></span></span><span><span></span><span><span>pow</span></span><span>(</span><span><span>m</span><span><span><span><span><span><span></span><span><span><span>l</span><span>o</span><span>g</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>+</span><span></span></span><span><span></span><span><span>cos</span><span><span><span><span><span><span></span><span><span><span>l</span><span>o</span><span>g</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>(</span><span><span>N</span><span><span><span><span><span><span></span><span><span>φ</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span></span><span>−</span><span></span></span><span><span></span><span><span>L</span><span><span><span><span><span><span></span><span><span>φ</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span><span>))</span><span></span><span>+</span><span></span></span><span><span></span><span>b</span></span></span></span></span></p>
<p>This amounts to, per-pixel:</p>
<ul>
<li>1 subtraction</li>
<li>1 lookup to <code>cos_log</code></li>
<li>1 addition</li>
<li>1 lookup to <code>pow</code></li>
<li>1 addition</li>
</ul>
<p>For a total of, per-pixel:</p>
<ul>
<li>3 additions/subtractions</li>
<li>2 lookups</li>
</ul>
<h3 id="how-fast-is-it">How fast is it?</h3>
<p><strong>The procedure processes 15 tiles per frame</strong>. It can process more if some of the tile&#39;s rows are empty (all 0), but it&#39;s guaranteed to process at least 15.</p>
<p><img src="https://blog.otterstack.com/posts/202512-gbshader/debugger_critical_loop_events.png" alt="" loading="lazy" width="800" height="630"/></p>
<p><em>Figure: Mesen&#39;s &#34;Event Viewer&#34; window, showing a dot for each iteration (tile row) of the shader&#39;s critical loop.</em></p>
<p>There&#39;s some intentional visual tearing as well. The image itself is more than 15 tiles, so the ROM actually switches to rendering different portions of the image for each frame. The tearing is less noticeable because of ghosting on the LCD display, so I thought it was acceptable.</p>
<p><strong>A pixel takes about 130 cycles, and an empty row&#39;s pixel takes about 3 cycles.</strong></p>
<p>At one point I had calculated 15 tiles rendering at exactly 123,972 cycles, including the call and branch overhead. This is an overestimate now, because I since added an optimization for empty rows.</p>
<p>The Game Boy Color&#39;s CPU runs up to 8.388608 MHz, or roughly 139,810 T-cycles per frame (1/60 of a second).</p>
<p><span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>123972</mn><mn>139810</mn></mfrac><mo>≈</mo><mn>89</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">{123972 \over 139810} \approx 89 \%</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span><span></span><span><span><span><span><span><span></span><span><span><span>139810</span></span></span></span><span><span></span><span></span></span><span><span></span><span><span><span>123972</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span><span></span><span>≈</span><span></span></span><span><span></span><span>89%</span></span></span></span></span>
About 89% of a frame&#39;s available CPU time goes to rendering the 15 tiles per frame. The remaining time goes to other functionality like responding to user input and performing hardware IO.</p>
<h3 id="self-modifying-code">Self-modifying code</h3>
<p><img src="https://blog.otterstack.com/posts/202512-gbshader/hex_patched.gif" alt="" loading="lazy"/></p>
<p><em>Figure: A hex representation of the shader subroutine instructions in RAM. The blue digits show a patch to change <code>sub a, 0</code> into <code>sub a, 8</code>.</em></p>
<p>The core shader subroutine contains a hot path that processes about 960 pixels per frame. It&#39;s really important to make this as fast as possible!</p>
<p>Self-modifying code is a super-effective way to make code <em>fast</em>. But most modern developers don&#39;t do this anymore, and there are good reasons: It&#39;s difficult, rarely portable, and it&#39;s hard to do it right without introducing serious security vulnerabilities. Modern developers are spoiled by an abundance of processing power, super-scalar processors that take optimal paths, and modern JIT (Just-In-Time) runtimes that generate code on the fly. But we&#39;re on the Game Boy, baybeee, so we don&#39;t have those options.</p>
<p>If you&#39;re a developer who uses higher-level languages like Python and JavaScript, the closest equivalent to self-modifying code is <code>eval()</code>. Think about how nervous <code>eval()</code> makes you feel. That&#39;s almost exactly how native developers feel about modifying instructions.</p>
<p>On the Game Boy&#39;s <strong>SM83</strong> processor, it&#39;s faster to add and subtract by a hard-coded number than it is to load that number from memory.</p>
<p>i.e. <code>x += 5</code> is faster than <code>x += variable</code>.</p>
<pre><code><span>unsigned</span> <span>char</span> Ltheta = <span>8</span>;


v = (*in++) - Ltheta;


v = (*in++) - <span>8</span>;
</code></pre>
<p>In SM83 assembly, this looks like:</p>
<pre><code>; Slower: 28 cycles
ld a, [Ltheta]   ; 12 cycles: Read variable &#34;Ltheta&#34; from HRAM
ld b, a          ; 4 cycles:  Move value to B register
ld a, [hl+]      ; 8 cycles:  Read from the HL pointer
sub a, b         ; 4 cycles:  A = A - B

; Faster: 16 cycles
ld a, [hl+]      ; 8 cycles: Read from the HL pointer
sub a, 8         ; 8 cycles: A = A - 8
</code></pre>
<p>The faster way shaves off 12 cycles. If we&#39;re rendering 960 pixels, this saves a total of 11,520 cycles. This doesn&#39;t sound like a lot, but it&#39;s roughly 10% of the shader&#39;s runtime!</p>
<p>So how can we get the faster subtraction if the value we&#39;re subtracting with changes?</p>
<p>By modifying the instruction operand!</p>
<pre><code>2A      ld a, [hl+]
D6 08   sub a, 8
</code></pre>
<h2 id="an-overall-failed-attempt-at-using-ai">An overall failed attempt at using AI</h2>
<blockquote>
<p>&#34;AI Will Be Writing 90% of Code in 3 to 6 Months&#34;
</p>
</blockquote>
<p><strong>95% of this project was made by hand</strong>. Large language models struggle to write Game Boy assembly. I don&#39;t blame them.</p>

<p><em>Update: 2026-02-03:</em>  I attempted to use AI to try out the process, mostly because 1) the industry won&#39;t shut up about AI, and 2) I wanted a grounded opinion of it for novel projects, so I have a concrete and personal reference point when talking about it in the wild. At the end of the day, this is still a hobbyist project, so AI really isn&#39;t the point! But still...</p>
<p>I believe in disclosing all attempts or actual uses of generative AI output, because I think it&#39;s unethical to deceive people about the process of your work. Not doing so undermines trust, and amounts to disinformation or plagiarism. Disclosure also invites people who have disagreements to engage with the work, which they should be able to. I&#39;m open to feedback, btw.</p>
<p><strong>I&#39;ll probably write something about my experiences with AI in the future.</strong></p>
<p><strong>As far as disclosures go, I used AI for</strong>:</p>
<ol>
<li>Python: Reading OpenEXR layers, as part of a conversion script to read normal map data</li>
<li>Python/Blender: Some Python scripts for populating Blender scenes, to demo the process in Blender</li>
<li>SM83 assembly: Snippets for Game Boy Color features like double-speed and VRAM DMA. Unsurprising, because these are likely available somewhere else.</li>
</ol>
<p>I <em>attempted</em> - and failed - to use AI for:</p>
<ol>
<li>SM83 assembly: <em>(Unused)</em> Generating an initial revision of the shader code</li>
</ol>
<p>I&#39;ll also choose to disclose what <strong>I did NOT use AI for:</strong></p>
<ol>
<li>Writing this article</li>
<li>The algorithms, lookups, all other SM83 assembly</li>
<li>3D assets</li>
<li>The soul 🌟 (AI techbros are groaning right now)</li>
</ol>
<h3 id="i-tried-to-make-ai-write-game-boy-assembly">I tried to make AI write Game Boy assembly</h3>
<p>Just to see what it would do, <strong>I fed pseudocode into Claude Sonnet 4</strong> (the industry claims that it&#39;s the best AI model for coding in 2025), and got it to generate SM83 assembly:</p>
<p><a href="https://claude.ai/share/846cb7d4-e4a6-40ab-8aaa-6e4c308e3da3" target="_blank" rel="noopener noreferrer nofollow">https://claude.ai/share/846cb7d4-e4a6-40ab-8aaa-6e4c308e3da3</a></p>
<p>It was an interesting process. To start, I chewed Claude&#39;s food and gave it pseudocode, because I had a data format in mind, and I assumed it&#39;d struggle with a higher-level description.</p>
<p>I was skeptical that it wouldn&#39;t do well, but it did better than I thought it would. It even produced code that worked when I persisted it and guided it enough. However, it wasn&#39;t very fast, and it made some initial mistakes by assuming the SM83 processor was the Z80 processor. I attempted to get Claude to optimize it by offering suggestions. It did well initially, but it introduced errors until I reached the conversation limit.</p>
<p>After that point, I manually rewrote everything. My final implementation is aggressively optimized and barely has any resemblance to Claude&#39;s take.</p>
<p><strong>And it <em>loved</em> telling me how &#34;absolutely right&#34; I always was.</strong> 🥺</p>
<p><img src="https://blog.otterstack.com/posts/202512-gbshader/claude_glazing_me.png" alt="" loading="lazy" width="539" height="800"/></p>
<p>It was better for small tasks and snippets of code. The tile demo in my video was partially AI scripted. A Game Boy subroutine for copying to VRAM was authored by AI. Few issues there.</p>
<p><del>An early iteration of the normal map conversion script accepted OpenEXR files. I didn&#39;t feel like drudging through a new library, so I asked ChatGPT to convert an OpenEXR file to a numpy array. It did pretty well! It however also introduced a very subtle bug that I didn&#39;t catch for weeks. Once I finally read the code, I realized it was sorting channel names alphabetically (so XYZ sorts as XYZ, but RGB sorts as BGR). It&#39;s the sort of error I&#39;d never make myself.</del></p>
<p>Update: 2026-02-03 - Yeah, so the OpenEXR code could&#39;ve been done in two lines this whole time. One of the first examples in <a href="https://pypi.org/project/OpenEXR/" target="_blank" rel="noopener noreferrer nofollow">the official PyPi readme</a> shows how to get a numpy array from an OpenEXR file - exactly what I needed. I could update this snippet for different channels too in theory, but basically it&#39;s this. ChatGPT gave me 30 lines to handle edge cases that simply won&#39;t happen.</p>
<pre><code><span>with</span> OpenEXR.File(<span>&#34;readme.exr&#34;</span>) <span>as</span> infile:
    RGB = infile.channels()[<span>&#34;RGB&#34;</span>].pixels
</code></pre>
<p>At this point, I can&#39;t emphasize <strong>verifiable</strong> enough.</p>
<p>This, and other experiences, made me realize how easy it is to let your guard down when using AI like this, even if you&#39;re an experienced coder. AI can be helpful, but discretion is very much a required skill. <a href="https://en.wikipedia.org/wiki/Slopsquatting" target="_blank" rel="noopener noreferrer nofollow">I&#39;m just thankful I never relied on it for installing hallucinated packages</a>.</p>

<p>If you like this, share this post or like and comment on the YouTube video!</p>
<p><a href="https://www.youtube.com/watch?v=SAQXEW3ePwo" target="_blank" rel="noopener noreferrer nofollow">https://www.youtube.com/watch?v=SAQXEW3ePwo</a></p>
<p>(post will be updated once I post on Bluesky)</p></article></div>
  </body>
</html>
