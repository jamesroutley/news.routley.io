<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://xenodium.com/an-accentuated-emacs-experiment/">Original</a>
    <h1>An accentuated Emacs experiment (à la macOS)</h1>
    
    <div id="readability-page-1" class="page"><div id="text-an-accentuated-emacs-experiment">
<p>
macOS has a wonderful input mechanism where you press and hold a key on your keyboard to display the accent menu. It&#39;s easy to internalize: <i>long press &#34;a&#34; if you want to input &#34;á&#34;</i>.
</p>


<p><img src="https://xenodium.com/images/an-accentuated-emacs-experiment/macosaccent.webp" alt="macosaccent.webp" width="70%" height="70%"/>
</p>

<p>
On Emacs, <i>C-x 8 &#39; a</i> would be the equivalent, but it just didn&#39;t stick for me. Fortunately, there&#39;s an alternative, using dead keys. Mickey Petersen gives a <a href="https://www.masteringemacs.org/article/diacritics-in-emacs">wonderful introduction</a>. Having said all this, I still longed for macOS&#39;s input mechanism.
</p>

<p>
Thanks to Christian Tietze&#39;s <a href="https://twitter.com/ctietze/status/1552446492559958017">post</a>, I discovered the <a href="https://github.com/elias94/accent">accent</a> package. While it doesn&#39;t handle <i>press-and-hold</i>, it does the heavy lifting of offering a menu with character options. If I could just bring that <i>press-and-hold</i>…
</p>

<p>
My initial attempt was to use <a href="https://github.com/emacsorphanage/key-chord">key chords</a> (via <a href="https://github.com/jwiegley/use-package">use-package</a>):
</p>

<div>
<pre>(<span>use-package</span> <span>accent</span>
  <span>:ensure</span> t
  <span>:chords</span> ((<span>&#34;aa&#34;</span> . ar/spanish-accent-menu)
           (<span>&#34;ee&#34;</span> . ar/spanish-accent-menu)
           (<span>&#34;ii&#34;</span> . ar/spanish-accent-menu)
           (<span>&#34;oo&#34;</span> . ar/spanish-accent-menu)
           (<span>&#34;uu&#34;</span> . ar/spanish-accent-menu)
           (<span>&#34;AA&#34;</span> . ar/spanish-accent-menu)
           (<span>&#34;EE&#34;</span> . ar/spanish-accent-menu)
           (<span>&#34;II&#34;</span> . ar/spanish-accent-menu)
           (<span>&#34;OO&#34;</span> . ar/spanish-accent-menu)
           (<span>&#34;UU&#34;</span> . ar/spanish-accent-menu)
           (<span>&#34;nn&#34;</span> . ar/spanish-accent-menu)
           (<span>&#34;NN&#34;</span> . ar/spanish-accent-menu)
           (<span>&#34;??&#34;</span> . ar/spanish-accent-menu)
           (<span>&#34;!!&#34;</span> . ar/spanish-accent-menu))
  <span>:config</span>
  (<span>defun</span> <span>ar/spanish-accent-menu</span> ()
    (<span>interactive</span>)
    (<span>let</span> ((accent-diacritics
           &#39;((a (á))
             (e (é))
             (i (í))
             (o (ó))
             (u (ú ü))
             (A (Á))
             (E (É))
             (I (Í))
             (O (Ó))
             (U (Ú Ü))
             (n (ñ))
             (N (Ñ))
             (\? (¿))
             (! (¡)))))
      (<span>ignore-error</span> quit
        (accent-menu)))))
</pre>
</div>

<p>
While it kinda works, &#34;nn&#34; quickly got in the way of my n/p <a href="https://magit.vc/">magit</a> navigation. Perhaps key chords are still an option for someone who doesn&#39;t need the &#34;nn&#34; chord, but being a Spanish speaker, I need that &#34;ñ&#34; from long &#34;n&#34; presses!
</p>

<p>
I&#39;m now trying a little experiment using an <code>after-change-functions</code> hook to monitor text input and present the accent menu. I&#39;m sure there&#39;s a better way (anyone with ideas?). For now, it gives me something akin to <i>press-and-hold.</i>
</p>


<p><img src="https://xenodium.com/images/an-accentuated-emacs-experiment/accentuated.webp" alt="accentuated.webp" width="80%" height="80%"/>
</p>

<p>
I&#39;m wrapping the hook with a minor mode to easily enable/disable whenever needed. I&#39;m also overriding <code>accent-diacritics</code> to only include the characters I typically need.
</p>

<div>
<pre>(<span>use-package</span> <span>accent</span>
  <span>:ensure</span> t
  <span>:hook</span> ((text-mode . accent-menu-mode)
         (org-mode . accent-menu-mode)
         (message-mode . accent-menu-mode))
  <span>:config</span>
  (<span>setq</span> accent-diacritics &#39;((a (á))
                            (e (é))
                            (i (í))
                            (o (ó))
                            (u (ú ü))
                            (A (Á))
                            (E (É))
                            (I (Í))
                            (O (Ó))
                            (U (Ú Ü))
                            (n (ñ))
                            (N (Ñ))
                            (\? (¿))
                            (! (¡))))
  (<span>defvar</span> <span>accent-menu-monitor--last-edit-time</span> nil)

  (<span>define-minor-mode</span> <span>accent-menu-mode</span>
    <span>&#34;Toggle `</span><span>accent-menu</span><span>&#39; if repeated keys are detected.&#34;</span>
    <span>:lighter</span> <span>&#34; accent-menu mode&#34;</span>
    (<span>if</span> accent-menu-mode
        (<span>progn</span>
          (remove-hook &#39;after-change-functions #&#39;accent-menu-monitor--text-change t)
          (add-hook &#39;after-change-functions #&#39;accent-menu-monitor--text-change 0 t))
      (remove-hook &#39;after-change-functions #&#39;accent-menu-monitor--text-change t)))

  (<span>defun</span> <span>accent-menu-monitor--text-change</span> (beginning end length)
    <span>&#34;Monitors text change BEGINNING, END, and LENGTH.&#34;</span>
    (<span>let</span> ((last-edit-time accent-menu-monitor--last-edit-time)
          (edit-time (float-time)))
      (<span>when</span> (<span>and</span> (&gt; end beginning)
                 (eq length 0)
                 last-edit-time
                 <span>;; </span><span>0.27 seems to work for my macOS keyboard settings.</span>
                 <span>;; </span><span>Key Repeat: Fast | Delay Until Repeat: Short.</span>
                 (&lt; (- edit-time last-edit-time) 0.27)
                 (float-time (time-subtract (current-time) edit-time))
                 (accent-menu-monitor--buffer-char-string (1- beginning))
                 (seq-contains-p (mapcar (<span>lambda</span> (item)
                                           (symbol-name (car item)))
                                         accent-diacritics)
                                 (accent-menu-monitor--buffer-char-string beginning))
                 (string-equal (accent-menu-monitor--buffer-char-string (1- beginning))
                               (accent-menu-monitor--buffer-char-string beginning)))
        (delete-backward-char 1)
        (<span>ignore-error</span> quit
          (accent-menu)))
      (<span>setq</span> accent-menu-monitor--last-edit-time edit-time)))

  (<span>defun</span> <span>accent-menu-monitor--buffer-char-string</span> (at)
    (<span>when</span> (&gt; at 0)
      (buffer-substring-no-properties at (+ at 1)))))
</pre>
</div>

<p>
As a bonus, it ocurred to me that I could use the same <i>press-and-hold</i> to handle question marks in Spanish (from my UK keyboard).
</p>


<p><img src="https://xenodium.com/images/an-accentuated-emacs-experiment/porque.webp" alt="porque.webp" width="40%" height="40%"/>
</p>
</div></div>
  </body>
</html>
