<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://wasmer.io/posts/introducing-the-wasmer-js-sdk">Original</a>
    <h1>Wasmer JavaScript SDK</h1>
    
    <div id="readability-page-1" class="page"><div><p>Dive into a world where running any WASI and WASIX package in your browser is a breeze. Whether it&#39;s Python, Bash, FFmpeg, or <a href="https://docs.wasmer.io/registry/get-started">any package published</a> in the registry, Wasmer Javascript SDK makes it all seamlessly possible.</p>
<p>We think this is incredibly exciting, because the <code>@wasmer/sdk</code> allows running any UNIX programs using <strong>threads</strong>, <strong>signals</strong>, <strong>subprocesses</strong> and other features in the browser (via <a href="https://wasix.org/">WASIX</a>).</p>
<p>With the new SDK, you just need to point to the desired Wasmer package and the SDK will download all the files (.wasm and the filesystem required) for you.</p>
<p>Let&#39;s see some cool examples running the Wasmer JS SDK, shall we?</p>
<ul>
<li>FFMpeg</li>
<li>CPython (with threads and signals!)</li>
<li>Bash (<a href="https://wasmer.sh">wasmer.sh</a> demo!)</li>
</ul>
<p><em>Note: <code>@wasmer/sdk</code> supersedes the <code>@wasmer/wasi</code> package</em></p>
<blockquote>
<p>Any WASIX package published to Wasmer will be instantly usable with the Wasmer Javascript SDK: in this article we will showcase how to use FFMpeg and Python, but you can use your <a href="https://docs.wasmer.io/registry/get-started">own package</a> just as easily.</p>
</blockquote>
<h2>A love story: FFMpeg</h2>
<p>FFMpeg is one of the most useful and popular packages in the world. It’s used by Youtube, Facebook, Netflix and many other industry leaders. It allows them to transform and edit videos very easily.</p>
<p>FFMpeg has been ported a few times to Javascript already, thanks to Emscripten and WebAssembly. However, these ports required a lot of manual changes from the maintainers to plug in all the features and make the package easily usable for developers.</p>
<p>Thanks to the new Wasmer JS SDK, the ffmpeg WASIX version published in Wasmer can now be easily in the browser.</p>
<p>Let&#39;s see an example where we retrieve a video (<a href="https://cdn.wasmer.io/media/wordpress.mp4"><code>wordpress.mp4</code></a>) and extract its audio:</p>
<pre tabindex="0"><code><span><span>import</span><span> { init, Wasmer } </span><span>from</span><span> </span><span>&#34;@wasmer/sdk&#34;</span><span>;</span></span>
<span></span>
<span><span>await</span><span> </span><span>init</span><span>();</span></span>
<span></span>
<span><span>let</span><span> ffmpeg </span><span>=</span><span> </span><span>await</span><span> Wasmer.</span><span>fromRegistry</span><span>(</span><span>&#34;wasmer/ffmpeg&#34;</span><span>);</span></span>
<span><span>let</span><span> resp </span><span>=</span><span> </span><span>await</span><span> </span><span>fetch</span><span>(</span><span>&#34;https://cdn.wasmer.io/media/wordpress.mp4&#34;</span><span>);</span></span>
<span><span>let</span><span> video </span><span>=</span><span> </span><span>await</span><span> resp.</span><span>arrayBuffer</span><span>();</span></span>
<span></span>
<span><span>// We take stdin (&#34;-&#34;) as input and write the output to stdout (&#34;-&#34;) as a</span></span>
<span><span>// WAV audio stream.</span></span>
<span><span>const</span><span> </span><span>instance</span><span> </span><span>=</span><span> </span><span>await</span><span> ffmpeg.entrypoint.</span><span>run</span><span>({</span></span>
<span><span>  args: [</span><span>&#34;-i&#34;</span><span>, </span><span>&#34;-&#34;</span><span>, </span><span>&#34;-f&#34;</span><span>, </span><span>&#34;wav&#34;</span><span>, </span><span>&#34;-&#34;</span><span>],</span></span>
<span><span>  stdin: </span><span>new</span><span> </span><span>Uint8Array</span><span>(video),</span></span>
<span><span>});</span></span>
<span></span>
<span><span>const</span><span> { </span><span>stdoutBytes</span><span> } </span><span>=</span><span> </span><span>await</span><span> instance.</span><span>wait</span><span>();</span></span>
<span><span>console.</span><span>log</span><span>(</span><span>`The audio stream: ${</span><span>output</span><span>.</span><span>stdoutBytes</span><span>}`</span><span>);</span></span></code></pre>
<p>Et voilá, you have the audio now created: <a href="https://cdn.wasmer.io/media/wordpress-ffmpeg-out.wav">wordpress-ffmpeg-out.wav</a></p>
<blockquote>
<p>You can get the audio  file by running ffmpeg locally with wasmer: <code>cat wordpress.mp4 | wasmer run wasmer/ffmpeg -- -i - -f wav - &gt; audio.wav</code></p>
</blockquote>
<h2>Running CPython in the browser</h2>
<p>There was another project that allowed using CPython in the browser: Pyodide. However, Pyodide is based on Emscripten and as such only runs on the browser, but not only that... Pyodide doesn&#39;t support threading.</p>
<p>Wasmer <a href="https://wasmer.io/python/python"><code>python</code> package</a> can run on both the browser and the server seamlessly, and requires no manual intervention to run in the browser (no extra packages needed other than the SDK!).</p>
<p>Here&#39;s how you can handle CPython with the Filesystem API of the Wasmer JS SDK:</p>
<pre tabindex="0"><code><span><span>import</span><span> { init, Directory, Wasmer } </span><span>from</span><span> </span><span>&#34;@wasmer/sdk&#34;</span><span>;</span></span>
<span><span> </span></span>
<span><span>// Initialize the Wasmer SDK</span></span>
<span><span>await</span><span> </span><span>init</span><span>();</span></span>
<span><span> </span></span>
<span><span>// Download the Python package</span></span>
<span><span>const</span><span> </span><span>python</span><span> </span><span>=</span><span> </span><span>await</span><span> Wasmer.</span><span>fromRegistry</span><span>(</span><span>&#34;python/python&#34;</span><span>);</span></span>
<span><span> </span></span>
<span><span>// The script to be executed</span></span>
<span><span>const</span><span> </span><span>script</span><span> </span><span>=</span><span> </span><span>`</span></span>
<span><span>import sys</span></span>
<span><span> </span></span>
<span><span>with open(&#34;/out/version.txt&#34;, &#34;w&#34;) as f:</span></span>
<span><span>  f.write(sys.version)</span></span>
<span><span>`</span><span>;</span></span>
<span><span>// A shared directory where the output will be written</span></span>
<span><span>const</span><span> </span><span>out</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Directory</span><span>();</span></span>
<span><span> </span></span>
<span><span>// Running the Python script</span></span>
<span><span>const</span><span> </span><span>instance</span><span> </span><span>=</span><span> </span><span>await</span><span> python.entrypoint.</span><span>run</span><span>({</span></span>
<span><span>  args: [</span><span>&#34;/src/main.py&#34;</span><span>],</span></span>
<span><span>  mount: {</span></span>
<span><span>    </span><span>&#34;/out&#34;</span><span>: out,</span></span>
<span><span>    </span><span>&#34;/src&#34;</span><span>: {</span></span>
<span><span>      </span><span>&#34;main.py&#34;</span><span>: script,</span></span>
<span><span>    }</span></span>
<span><span>  },</span></span>
<span><span>});</span></span>
<span><span>const</span><span> </span><span>output</span><span> </span><span>=</span><span> </span><span>await</span><span> instance.</span><span>wait</span><span>();</span></span>
<span><span> </span></span>
<span><span>if</span><span> (</span><span>!</span><span>output.ok) {</span></span>
<span><span>  </span><span>throw</span><span> </span><span>new</span><span> </span><span>Error</span><span>(</span><span>`Python failed ${</span><span>output</span><span>.</span><span>code</span><span>}: ${</span><span>output</span><span>.</span><span>stderr</span><span>}`</span><span>);</span></span>
<span><span>}</span></span>
<span><span> </span></span>
<span><span>// Read the version string back</span></span>
<span><span>const</span><span> </span><span>pythonVersion</span><span> </span><span>=</span><span> </span><span>await</span><span> out.</span><span>readTextFile</span><span>(</span><span>&#34;/version.txt&#34;</span><span>);</span></span>
<span><span>console.</span><span>log</span><span>(pythonVersion) </span><span>// 3.11.6 (main, ...)</span></span></code></pre>
<blockquote>
<p>Check out the <a href="https://docs.wasmer.io/javascript-sdk/how-to/use-filesystem"><em>FileSystem guide</em></a> to learn more.</p>
</blockquote>
<h2>Wasmer.sh</h2>
<p>As an example, our own <a href="https://wasmer.sh">wasmer.sh</a> website has now an incredibly simple implementation that just fetches the bash package, and pipes it over <a href="https://xtermjs.org/">xterm.js</a> using the Wasmer Javascript SDK.</p>
<p><img src="https://wasmer.io/_next/image?url=https%3A%2F%2Fcdn.wasmer.io%2Fimages%2FScreenshot_2023-12-21_at_7.36.18PM.original.png&amp;w=1920&amp;q=75" alt="Wasmer.sh using new Wasmer JS SDK"/></p>
<blockquote>
<p>Something that before required 1,000 lines of code in Rust + JS glue code manually written, now can be written in <a href="https://github.com/wasmerio/wasmer-js/blob/main/examples/wasmer.sh/index.ts">less than 50 lines of clear JavaScript code</a></p>
</blockquote>
<p>You can now have your own terminal emulator running in your website very easily using XTerm.js and the Wasmer JS SDK:</p>
<pre tabindex="0"><code><span><span>// This is a simplified version of:</span></span>
<span><span>// https://github.com/wasmerio/wasmer-js/blob/main/examples/wasmer.sh/index.ts</span></span>
<span><span>import</span><span> { Terminal } </span><span>from</span><span> </span><span>&#34;xterm&#34;</span><span>;</span></span>
<span></span>
<span><span>async</span><span> </span><span>function</span><span> </span><span>main</span><span>() {</span></span>
<span><span>  </span><span>const</span><span> { </span><span>Wasmer</span><span>, </span><span>init</span><span> } </span><span>=</span><span> </span><span>await</span><span> </span><span>import</span><span>(</span><span>&#34;@wasmer/sdk&#34;</span><span>);</span></span>
<span><span>  </span><span>await</span><span> </span><span>init</span><span>();</span></span>
<span></span>
<span><span>  </span><span>const</span><span> </span><span>term</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Terminal</span><span>();</span></span>
<span><span>  term.</span><span>open</span><span>(document.</span><span>getElementById</span><span>(</span><span>&#34;terminal&#34;</span><span>)</span><span>!</span><span>);</span></span>
<span></span>
<span><span>  </span><span>const</span><span> </span><span>pkg</span><span> </span><span>=</span><span> </span><span>await</span><span> Wasmer.</span><span>fromRegistry</span><span>(</span><span>&#34;sharrattj/bash&#34;</span><span>);</span></span>
<span><span>  </span><span>const</span><span> </span><span>instance</span><span> </span><span>=</span><span> </span><span>await</span><span> pkg.entrypoint</span><span>!</span><span>.</span><span>run</span><span>();</span></span>
<span><span>	</span></span>
<span><span>  </span><span>connectStreams</span><span>(instance, term);</span></span>
<span><span>}</span></span>
<span></span>
<span><span>function</span><span> </span><span>connectStreams</span><span>(</span><span>instance</span><span>, </span><span>term</span><span>) {</span></span>
<span><span>  </span><span>const</span><span> </span><span>stdin</span><span> </span><span>=</span><span> instance.stdin?.</span><span>getWriter</span><span>();</span></span>
<span><span>  </span><span>const</span><span> </span><span>encoder</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>TextEncoder</span><span>();</span></span>
<span><span>  term.</span><span>onData</span><span>(</span><span>data</span><span> </span><span>=&gt;</span><span> stdin?.</span><span>write</span><span>(encoder.</span><span>encode</span><span>(data)));</span></span>
<span><span>  instance.stdout.</span><span>pipeTo</span><span>(</span><span>new</span><span> </span><span>WritableStream</span><span>({ </span><span>write</span><span>: </span><span>chunk</span><span> </span><span>=&gt;</span><span> term.</span><span>write</span><span>(chunk) }));</span></span>
<span><span>  instance.stderr.</span><span>pipeTo</span><span>(</span><span>new</span><span> </span><span>WritableStream</span><span>({ </span><span>write</span><span>: </span><span>chunk</span><span> </span><span>=&gt;</span><span> term.</span><span>write</span><span>(chunk) }));</span></span>
<span><span>}</span></span>
<span></span>
<span><span>main</span><span>();</span></span></code></pre>
<h2>Technical feat</h2>
<p>Making the Wasmer JS SDK to work was not an easy task.
We had to to achieve incredibly hard challenges, so you don&#39;t need to worry about solving them yourself:</p>
<ul>
<li>Using asyncify to be able to <code>fork</code> processes</li>
<li>Using a universal format to containerize the Wasm and filesystem together</li>
<li>A Filesystem abstraction to ease the container use</li>
</ul>
<p>Lets get into this a bit more!</p>
<h4>Supporting multithreading</h4>
<p>Javascript runs in a single thread. However, it is possible to use JS Workers to enable multithreading in the browser.
The Workers API differs from the typical threading API (that you would use in Python, Go or Rust), in the sense that there&#39;s no <code>join</code> (to wait for a thread to finish). The JS Worker communicates with the main process via a message channel/bus.</p>
<p>At the end, we were able to allow UNIX-like threading to run via JS Workers by reusing the shared memory from the main WebAssembly process and notifying the memory upon changes (using Wasm notify/wait syntax).</p>
<h4>Running <code>fork</code> in the browser</h4>
<p>Running <code>fork</code> in the browser is almost an impossible task, as it requires dumping the stack and being able to resume it from a different process.</p>
<p>We used <a href="https://kripken.github.io/blog/wasm/2019/07/16/asyncify.html"><code>asyncify</code></a> to freeze the program with the current stack, and then resume it later in a newly created Worker.</p>
<h4>An universal container format</h4>
<p>The Wasmer API now ships a special container format (that we will cover in future blogposts) that allows serving both the Wasm assets along with the filesystem ones. That way, you can download one package with all it&#39;s filesystem dependencies at once (such as Python!).</p>
<p>This container format is the format also used in both the native runtime and Wasmer Edge. More to come on this later!</p>
<h4>A Filesystem API</h4>
<p>We realized that using the Filesystem was critical to allow any developer achieving their needs.</p>
<p>Read more about the Wasmer JS SDK Filesystem API here: <a href="https://docs.wasmer.io/javascript-sdk/how-to/use-filesystem">https://docs.wasmer.io/javascript-sdk/how-to/use-filesystem</a></p>
<hr/>

<p>We can’t wait to see how you use the Wasmer JS SDK to use all packages published in the Wasmer ecosystem.</p>
<p>We have many examples on how to use Wasmer-JS:</p>
<ul>
<li>Github Pages: <a href="https://github.com/wasmerio/wasmer-js/tree/main/examples/cdn-coi-serviceworker">cdn-coi-serviceworker</a></li>
<li>FFMpeg with React: <a href="https://github.com/wasmerio/wasmer-js/tree/main/examples/ffmpeg-react">ffmpeg-react</a></li>
<li>Markdown editor: <a href="https://github.com/wasmerio/wasmer-js/tree/main/examples/markdown-editor">markdown-editor</a></li>
<li>Wasmer.sh: <a href="https://github.com/wasmerio/wasmer-js/tree/main/examples/wasmer.sh">wasmer.sh</a></li>
<li>Any other? Open an issue or a PR in the Wasmer-JS repo!</li>
</ul>
<blockquote>
<p>Using Wasmer SDK in the browser requires you setting the Cross-origin isolation headers (<a href="https://web.dev/coop-coep/">COOP and COEP</a>) in the pages that use the SDK.
If you can’t do this (because you are publishing to Github Pages, for example) you can use <a href="https://docs.wasmer.io/javascript-sdk/how-to/coop-coep-headers"><code>coi-serviceworker</code></a> to automatically patch the headers client-side (<a href="https://github.com/wasmerio/wasmer-js/tree/main/examples/cdn-coi-serviceworker">see example</a>).</p>
<p>For more details, check out <a href="https://docs.wasmer.io/javascript-sdk/explainers/troubleshooting#sharedarraybuffer-and-cross-origin-isolation"><em>SharedArrayBuffer and Cross-Origin Isolation</em></a> in the JavaScript SDK docs.</p>
</blockquote>
<p>Bash, Python, FFMpeg, QuickJS, OpenSSL, and many more packages are waiting for you!</p>
<p>Get started with the Wasmer JS SDK docs : <a href="https://docs.wasmer.io/javascript-sdk">https://docs.wasmer.io/javascript-sdk</a></p>
<p>Let us know what you build next on <a href="https://discord.gg/rWkMNStrEW">Wasmer&#39;s discord</a></p></div></div>
  </body>
</html>
