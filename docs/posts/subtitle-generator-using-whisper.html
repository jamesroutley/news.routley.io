<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://kracekumar.com/post/subtitle-generator-using-whisper/">Original</a>
    <h1>Subtitle Generator Using Whisper</h1>
    
    <div id="readability-page-1" class="page"><div>
    <div>
  
  <p><time datetime="2025-01-12T22:30:34+0530">Sun, Jan 12, 2025</time></p><p>I want to generate the subtitles for the <code>Normal People</code>TV series in my laptop using LLM. After searching a bit, whisper from OpenAI was a proper fit.</p>

<p>The first step is to extract the audio from the video file using <code>ffmpeg</code> and store it separately.</p>
<div><pre tabindex="0"><code data-lang="python"><span><span><span>ffmpeg</span> <span>-</span><span>i</span> <span>/</span><span>Users</span><span>/</span><span>kracekumar</span><span>/</span><span>Movies</span><span>/</span><span>TV</span><span>/</span><span>Normal</span><span>.</span><span>People</span><span>.</span><span>S01</span><span>/</span><span>Normal</span><span>.</span><span>People</span><span>.</span><span>S01E01</span><span>.</span><span>mp4</span> <span>-</span><span>vn</span> <span>-</span><span>acodec</span> <span>copy</span> <span>/</span><span>Users</span><span>/</span><span>kracekumar</span><span>/</span><span>Movies</span><span>/</span><span>TV</span><span>/</span><span>Normal</span><span>.</span><span>People</span><span>.</span><span>S01</span><span>/</span><span>audio</span><span>/</span><span>Normal</span><span>.</span><span>People</span><span>.</span><span>S01E01</span><span>.</span><span>aac</span>
</span></span></code></pre></div><h3 id="step-2-converting-audio-to-text">Step 2: Converting Audio to Text</h3>
<p>The second step is to run the audio file through the <a href="https://github.com/openai/whisper">whisper model</a> from OpenAI. I use uv to install and run inside a project.</p>
<div><pre tabindex="0"><code data-lang="python"><span><span><span>uv</span> <span>run</span> <span>whisper</span> <span>/</span><span>Users</span><span>/</span><span>kracekumar</span><span>/</span><span>Movies</span><span>/</span><span>TV</span><span>/</span><span>Normal</span><span>.</span><span>People</span><span>.</span><span>S01</span><span>/</span><span>audio</span><span>/</span><span>Normal</span><span>.</span><span>People</span><span>.</span><span>S01E01</span><span>.</span><span>aac</span> <span>--</span><span>model</span> <span>turbo</span> <span>-</span><span>f</span> <span>srt</span> <span>--</span><span>output_dir</span> <span>/</span><span>Users</span><span>/</span><span>kracekumar</span><span>/</span><span>Movies</span><span>/</span><span>TV</span><span>/</span><span>Normal</span><span>.</span><span>People</span><span>.</span><span>S01</span><span>/</span><span>generated_subs</span><span>/</span>
</span></span></code></pre></div><p>Here is the first ten subtitles generated from the model</p>
<pre tabindex="0"><code>1
00:00:00,000 --&gt; 00:00:24,000
It&#39;s a simple game. You have 15 players. Give one of them the ball. Get it into the net.

2
00:00:24,000 --&gt; 00:00:26,000
Very simple. Isn&#39;t it?

3
00:00:26,000 --&gt; 00:00:31,000
Brilliant. How&#39;s it going, Rachel? Talking tactics there for the big game.

4
00:00:31,000 --&gt; 00:00:35,000
We&#39;re getting a masterclass. How incredibly boring of you.

5
00:00:35,000 --&gt; 00:00:39,000
Yeah. Did you use your hair though? I did, yeah.

6
00:00:39,000 --&gt; 00:00:44,000
It&#39;s very pretty. Thanks. Can I use my locker? By any chance?

7
00:00:44,000 --&gt; 00:00:50,000
Yeah. Yeah, I sorta need you to move, Connell.

8
00:00:50,000 --&gt; 00:00:55,000
Oh, sorry. Excuse me. Sorry. Excuse me. Right, relax, will ya?

9
00:00:55,000 --&gt; 00:01:00,000
Okay, now that&#39;s important because it&#39;s turned up in the exam twice out of the last three years.

10
00:01:02,000 --&gt; 00:01:03,000
Marianne.
</code></pre><p>Here is subtitles from the other site</p>
<pre tabindex="0"><code>1
00:00:18,989 --&gt; 00:00:20,269
It&#39;s a simple game.

2
00:00:20,320 --&gt; 00:00:22,642
You have 15 players.
Give one of them the ball,

3
00:00:22,693 --&gt; 00:00:24,048
get it into the net.

4
00:00:24,099 --&gt; 00:00:25,708
- Very simple.
- Isn&#39;t it?

5
00:00:26,052 --&gt; 00:00:27,192
Oh, what?

6
00:00:27,415 --&gt; 00:00:28,535
Brilliant.

7
00:00:28,833 --&gt; 00:00:31,520
How&#39;s it going, Rachel?
Talking tactics, there, for the game.

8
00:00:31,571 --&gt; 00:00:33,200
We&#39;re getting a master class.

9
00:00:33,598 --&gt; 00:00:35,965
- How incredibly boring of you.
- Yeah.

10
00:00:36,601 --&gt; 00:00:38,570
- Did you get your hair done?
- I did, yeah.
</code></pre><p>The complete generated subtitles can be found in <a href="https://gist.github.com/kracekumar/efe9da9ea0d13e42b10f1fc7eaad5c50">gist</a></p>
<h3 id="comparison-with-original-subtitles">Comparison with original subtitles</h3>
<p>The LLM produced close to perfect subtitles in terms of text and highly useful with certain annoying behaviours</p>
<ol>
<li><strong>Text appears before characters starts to speak</strong>: The first generated text appears as soon a video starts whereas in the original file, starts at 18th second. When there is a long pause in the video, the next dialogue appears immediately.</li>
<li><strong>Subtitle Length</strong>: The first subtitle, <code>It&#39;s a simple game. You have 15 players. Give one of them the ball. Get it into the net.</code>is longer and represents 6 seconds of dialogue.  The splitting these into multiple sequences would be useful especially for movie subtitles but may not matter for speech to text.(couldn’t find any CLI options)</li>
<li><strong>Inconsistent Punctuation</strong>: While some generated text includes proper punctuation, other sections lack it. The CLI offers <code>--append_punctuations, --prepend_punctations</code>  to address this, but I haven’t tried.</li>
</ol>
<h3 id="script-to-bulk-convert">Script to bulk convert</h3>
<div><pre tabindex="0"><code data-lang="python"><span><span><span>import</span> <span>os</span>
</span></span><span><span><span>import</span> <span>subprocess</span>
</span></span><span><span><span>import</span> <span>argparse</span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>extract_audio</span><span>(</span><span>input_dir</span><span>,</span> <span>output_dir</span><span>):</span>
</span></span><span><span>    <span>&#34;&#34;&#34;
</span></span></span><span><span><span>    Extracts audio from video files in the input directory and saves them to the output directory.
</span></span></span><span><span><span>
</span></span></span><span><span><span>    Args:
</span></span></span><span><span><span>        input_dir: Path to the directory containing video files.
</span></span></span><span><span><span>        output_dir: Path to the directory where audio files will be saved.
</span></span></span><span><span><span>    &#34;&#34;&#34;</span>
</span></span><span><span>    <span>if</span> <span>not</span> <span>os</span><span>.</span><span>path</span><span>.</span><span>exists</span><span>(</span><span>output_dir</span><span>):</span>
</span></span><span><span>        <span>os</span><span>.</span><span>makedirs</span><span>(</span><span>output_dir</span><span>)</span>
</span></span><span><span>
</span></span><span><span>    <span>for</span> <span>filename</span> <span>in</span> <span>os</span><span>.</span><span>listdir</span><span>(</span><span>input_dir</span><span>):</span>
</span></span><span><span>        <span>if</span> <span>filename</span><span>.</span><span>endswith</span><span>((</span><span>&#39;.mp4&#39;</span><span>,</span> <span>&#39;.avi&#39;</span><span>,</span> <span>&#39;.mov&#39;</span><span>)):</span>  <span># Add more video extensions if needed</span>
</span></span><span><span>            <span>input_path</span> <span>=</span> <span>os</span><span>.</span><span>path</span><span>.</span><span>join</span><span>(</span><span>input_dir</span><span>,</span> <span>filename</span><span>)</span>
</span></span><span><span>            <span>output_path</span> <span>=</span> <span>os</span><span>.</span><span>path</span><span>.</span><span>join</span><span>(</span><span>output_dir</span><span>,</span> <span>os</span><span>.</span><span>path</span><span>.</span><span>splitext</span><span>(</span><span>filename</span><span>)[</span><span>0</span><span>]</span> <span>+</span> <span>&#39;.aac&#39;</span><span>)</span>
</span></span><span><span>            <span>command</span> <span>=</span> <span>f</span><span>&#34;ffmpeg -i </span><span>{</span><span>input_path</span><span>}</span><span> -vn -acodec copy </span><span>{</span><span>output_path</span><span>}</span><span>&#34;</span>
</span></span><span><span>            <span># Add logging to track</span>
</span></span><span><span>            <span>print</span><span>(</span><span>f</span><span>&#34;Running the command: </span><span>{</span><span>command</span><span>}</span><span>&#34;</span><span>)</span>
</span></span><span><span>            <span>subprocess</span><span>.</span><span>run</span><span>(</span><span>command</span><span>,</span> <span>shell</span><span>=</span><span>True</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>generate_subtitles</span><span>(</span><span>input_dir</span><span>,</span> <span>output_dir</span><span>):</span>
</span></span><span><span>    <span>&#34;&#34;&#34;
</span></span></span><span><span><span>    Generates subtitles for audio files using the Whisper LLM model.
</span></span></span><span><span><span>
</span></span></span><span><span><span>    Args:
</span></span></span><span><span><span>        input_dir: Path to the directory containing audio files.
</span></span></span><span><span><span>        output_dir: Path to the directory where subtitle files will be saved.
</span></span></span><span><span><span>    &#34;&#34;&#34;</span>
</span></span><span><span>    <span>if</span> <span>not</span> <span>os</span><span>.</span><span>path</span><span>.</span><span>exists</span><span>(</span><span>output_dir</span><span>):</span>
</span></span><span><span>        <span>os</span><span>.</span><span>makedirs</span><span>(</span><span>output_dir</span><span>)</span>
</span></span><span><span>
</span></span><span><span>    <span>for</span> <span>filename</span> <span>in</span> <span>os</span><span>.</span><span>listdir</span><span>(</span><span>input_dir</span><span>):</span>
</span></span><span><span>        <span>if</span> <span>filename</span><span>.</span><span>endswith</span><span>((</span><span>&#39;.aac&#39;</span><span>,</span> <span>&#39;.wav&#39;</span><span>)):</span>
</span></span><span><span>            <span>input_path</span> <span>=</span> <span>os</span><span>.</span><span>path</span><span>.</span><span>join</span><span>(</span><span>input_dir</span><span>,</span> <span>filename</span><span>)</span>
</span></span><span><span>            <span>command</span> <span>=</span> <span>f</span><span>&#34;whisper </span><span>{</span><span>input_path</span><span>}</span><span> --model turbo -f srt --output_dir </span><span>{</span><span>output_dir</span><span>}</span><span>&#34;</span>
</span></span><span><span>            <span># Adjust model size (&#39;tiny&#39;, &#39;base&#39;, &#39;small&#39;, &#39;medium&#39;, &#39;large&#39;) as needed</span>
</span></span><span><span>            
</span></span><span><span>            <span>print</span><span>(</span><span>f</span><span>&#34;Running the command: </span><span>{</span><span>command</span><span>}</span><span>&#34;</span><span>)</span>
</span></span><span><span>            <span>subprocess</span><span>.</span><span>run</span><span>(</span><span>command</span><span>,</span> <span>shell</span><span>=</span><span>True</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span>if</span> <span>__name__</span> <span>==</span> <span>&#34;__main__&#34;</span><span>:</span>
</span></span><span><span>    <span>parser</span> <span>=</span> <span>argparse</span><span>.</span><span>ArgumentParser</span><span>(</span><span>description</span><span>=</span><span>&#34;Extract audio and generate subtitles.&#34;</span><span>)</span>
</span></span><span><span>    <span>parser</span><span>.</span><span>add_argument</span><span>(</span><span>&#34;input_dir&#34;</span><span>,</span> <span>help</span><span>=</span><span>&#34;Path to the directory containing video files.&#34;</span><span>)</span>
</span></span><span><span>    <span>parser</span><span>.</span><span>add_argument</span><span>(</span><span>&#34;audio_dir&#34;</span><span>,</span> <span>help</span><span>=</span><span>&#34;Path to the directory to save extracted audio files.&#34;</span><span>)</span>
</span></span><span><span>    <span>parser</span><span>.</span><span>add_argument</span><span>(</span><span>&#34;subtitle_dir&#34;</span><span>,</span> <span>help</span><span>=</span><span>&#34;Path to the directory to save generated subtitles.&#34;</span><span>)</span>
</span></span><span><span>
</span></span><span><span>    <span>args</span> <span>=</span> <span>parser</span><span>.</span><span>parse_args</span><span>()</span>
</span></span><span><span>
</span></span><span><span>    <span>extract_audio</span><span>(</span><span>args</span><span>.</span><span>input_dir</span><span>,</span> <span>args</span><span>.</span><span>audio_dir</span><span>)</span>
</span></span><span><span>    <span>generate_subtitles</span><span>(</span><span>args</span><span>.</span><span>audio_dir</span><span>,</span> <span>args</span><span>.</span><span>subtitle_dir</span><span>)</span>
</span></span></code></pre></div><p>I asked Gemini to generate the code for the task. The following is the code that was generated by the model. The prompt was basic and as follows</p>
<pre tabindex="0"><code>Write a Python program that takes a command line arguments to do following tasks

1) Get a directory that contains video files and extracts the audio from the video and stores the audio in a separate directory using ffmpeg command. If the output directory is missing, new directory should be created.

2) Then audio file is passed on to the command of whisper llm model to produce the sub ttitles for the audio file. The output should be stored in a new directory
</code></pre><p>From the generated code, I modified two things</p>
<ol>
<li>The command line arguments to ffmpeg and whisper command</li>
<li>Add a log line to print the current command to track progress.</li>
</ol>
<h3 id="chinese-language">Chinese language</h3>
<p>After successful english subtitles generation, I was tempted to try non-english audio. for <code>In the mood for love</code> movie. The whisper model failed to convert the generated chinese translation to English.</p>
<div><pre tabindex="0"><code data-lang="python"><span><span><span>$</span><span>uv</span> <span>run</span> <span>whisper</span> <span>/</span><span>Users</span><span>/</span><span>kracekumar</span><span>/</span><span>Movies</span><span>/</span><span>In</span><span>.</span><span>the</span><span>.</span><span>Mood</span><span>.</span><span>for</span><span>.</span><span>Love</span><span>/</span><span>audio</span><span>/</span><span>In</span><span>.</span><span>the</span><span>.</span><span>Mood</span><span>.</span><span>for</span><span>.</span><span>Love</span><span>.</span><span>mp4</span> <span>--</span><span>model</span> <span>turbo</span> <span>-</span><span>f</span> <span>srt</span> <span>--</span><span>output_dir</span> <span>/</span><span>Users</span><span>/</span><span>kracekumar</span><span>/</span><span>Movies</span><span>/</span><span>In</span><span>.</span><span>the</span><span>.</span><span>Mood</span><span>.</span><span>for</span><span>.</span><span>Love</span><span>/</span><span>generated_sub</span> <span>--</span><span>language</span> <span>zh</span> <span>--</span><span>task</span> <span>translate</span>
</span></span><span><span><span>[</span><span>00</span><span>:</span><span>00.000</span> <span>--&gt;</span> <span>00</span><span>:</span><span>00.180</span><span>]</span>
</span></span><span><span><span>[</span><span>00</span><span>:</span><span>30.000</span> <span>--&gt;</span> <span>00</span><span>:</span><span>30.180</span><span>]</span>
</span></span><span><span><span>[</span><span>01</span><span>:</span><span>00.000</span> <span>--&gt;</span> <span>01</span><span>:</span><span>00.160</span><span>]</span>  <span>The</span> <span>frustrating</span> <span>is</span> <span>for</span> <span>thoseatks</span><span>.</span> <span>It</span><span>&#39;s beautiful and adorable and significant. It&#39;</span><span>s</span> <span>adorable</span> <span>and</span> <span>typical</span><span>.</span> <span>There</span><span>&#39;s a blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank blank</span>
</span></span><span><span><span>[</span><span>01</span><span>:</span><span>30.000</span> <span>--&gt;</span> <span>01</span><span>:</span><span>30.180</span><span>]</span>
</span></span><span><span><span>[</span><span>02</span><span>:</span><span>00.000</span> <span>--&gt;</span> <span>02</span><span>:</span><span>05.200</span><span>]</span> <span>謝謝你</span><span>,</span> <span>那我先走了</span>
</span></span><span><span><span>[</span><span>02</span><span>:</span><span>05.260</span> <span>--&gt;</span> <span>02</span><span>:</span><span>06.680</span><span>]</span> <span>of息</span><span>,</span> <span>再見</span>
</span></span><span><span><span>[</span><span>02</span><span>:</span><span>07.800</span> <span>--&gt;</span> <span>02</span><span>:</span><span>11.360</span><span>]</span> <span>請問你們有嗎</span><span>?</span>
</span></span><span><span><span>[</span><span>02</span><span>:</span><span>11.520</span> <span>--&gt;</span> <span>02</span><span>:</span><span>15.200</span><span>]</span> <span>對不起</span><span>,</span> <span>房間剛剛租給一位太太</span>
</span></span><span><span><span>[</span><span>02</span><span>:</span><span>15.520</span> <span>--&gt;</span> <span>02</span><span>:</span><span>16.520</span><span>]</span> <span>謝謝你</span>
</span></span><span><span><span>...</span>
</span></span><span><span><span>[</span><span>01</span><span>:</span><span>28</span><span>:</span><span>35.420</span> <span>--&gt;</span> <span>01</span><span>:</span><span>28</span><span>:</span><span>36.420</span><span>]</span> <span>謝謝</span>
</span></span><span><span><span>[</span><span>01</span><span>:</span><span>28</span><span>:</span><span>36.420</span> <span>--&gt;</span> <span>01</span><span>:</span><span>28</span><span>:</span><span>37.420</span><span>]</span>
</span></span><span><span><span>Traceback</span> <span>(</span><span>most</span> <span>recent</span> <span>call</span> <span>last</span><span>):</span>
</span></span><span><span>  <span>File</span> <span>&#34;/Users/kracekumar/code/s2t/.venv/lib/python3.12/site-packages/whisper/transcribe.py&#34;</span><span>,</span> <span>line</span> <span>598</span><span>,</span> <span>in</span> <span>cli</span>
</span></span><span><span>    <span>writer</span><span>(</span><span>result</span><span>,</span> <span>audio_path</span><span>,</span> <span>**</span><span>writer_args</span><span>)</span>
</span></span><span><span>  <span>File</span> <span>&#34;/Users/kracekumar/code/s2t/.venv/lib/python3.12/site-packages/whisper/utils.py&#34;</span><span>,</span> <span>line</span> <span>101</span><span>,</span> <span>in</span> <span>__call__</span>
</span></span><span><span>    <span>self</span><span>.</span><span>write_result</span><span>(</span><span>result</span><span>,</span> <span>file</span><span>=</span><span>f</span><span>,</span> <span>options</span><span>=</span><span>options</span><span>,</span> <span>**</span><span>kwargs</span><span>)</span>
</span></span><span><span>  <span>File</span> <span>&#34;/Users/kracekumar/code/s2t/.venv/lib/python3.12/site-packages/whisper/utils.py&#34;</span><span>,</span> <span>line</span> <span>257</span><span>,</span> <span>in</span> <span>write_result</span>
</span></span><span><span>    <span>for</span> <span>i</span><span>,</span> <span>(</span><span>start</span><span>,</span> <span>end</span><span>,</span> <span>text</span><span>)</span> <span>in</span> <span>enumerate</span><span>(</span>
</span></span><span><span>                                 <span>^^^^^^^^^^</span>
</span></span><span><span>  <span>File</span> <span>&#34;/Users/kracekumar/code/s2t/.venv/lib/python3.12/site-packages/whisper/utils.py&#34;</span><span>,</span> <span>line</span> <span>197</span><span>,</span> <span>in</span> <span>iterate_result</span>
</span></span><span><span>    <span>for</span> <span>subtitle</span> <span>in</span> <span>iterate_subtitles</span><span>():</span>
</span></span><span><span>                    <span>^^^^^^^^^^^^^^^^^^^</span>
</span></span><span><span>  <span>File</span> <span>&#34;/Users/kracekumar/code/s2t/.venv/lib/python3.12/site-packages/whisper/utils.py&#34;</span><span>,</span> <span>line</span> <span>147</span><span>,</span> <span>in</span> <span>iterate_subtitles</span>
</span></span><span><span>    <span>last</span><span>:</span> <span>float</span> <span>=</span> <span>get_start</span><span>(</span><span>result</span><span>[</span><span>&#34;segments&#34;</span><span>])</span> <span>or</span> <span>0.0</span>
</span></span><span><span>                  <span>^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
</span></span><span><span>  <span>File</span> <span>&#34;/Users/kracekumar/code/s2t/.venv/lib/python3.12/site-packages/whisper/utils.py&#34;</span><span>,</span> <span>line</span> <span>72</span><span>,</span> <span>in</span> <span>get_start</span>
</span></span><span><span>    <span>return</span> <span>next</span><span>(</span>
</span></span><span><span>           <span>^^^^^</span>
</span></span><span><span>  <span>File</span> <span>&#34;/Users/kracekumar/code/s2t/.venv/lib/python3.12/site-packages/whisper/utils.py&#34;</span><span>,</span> <span>line</span> <span>73</span><span>,</span> <span>in</span> <span>&lt;</span><span>genexpr</span><span>&gt;</span>
</span></span><span><span>    <span>(</span><span>w</span><span>[</span><span>&#34;start&#34;</span><span>]</span> <span>for</span> <span>s</span> <span>in</span> <span>segments</span> <span>for</span> <span>w</span> <span>in</span> <span>s</span><span>[</span><span>&#34;words&#34;</span><span>]),</span>
</span></span><span><span>                                           <span>~^^^^^^^^^</span>
</span></span><span><span><span>KeyError</span><span>:</span> <span>&#39;words&#39;</span>
</span></span></code></pre></div><h3 id="conclusion">Conclusion</h3>
<p>Whisper model was able to provide useable and close to accurate subtitles for the audio. There are a lot of rough edges like producing long text without proper truncation that hampers the experience. I’m pretty sure, there are tweaks to get the perfect subtitles with enough effort.</p>

</div>


    </div></div>
  </body>
</html>
