<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.agwa.name/blog/post/google_suspended_sslmates_cloud_account_again">Original</a>
    <h1>Google Suspended My Company&#39;s Google Cloud Account for the Third Time</h1>
    
    <div id="readability-page-1" class="page"><div>


<p>
On each of the last two Fridays, Google has suspended <a href="https://sslmate.com/" rel="external">SSLMate</a>&#39;s Google Cloud access without notification, having previously suspended
it in 2024 without notification. But this isn&#39;t just another cautionary tale about using Google Cloud
Platform; it&#39;s also a story about usable security and how Google&#39;s capriciousness is forcing me to choose
between weakening security or reducing usability.
</p>

<p>
Apart from testing and experimentation, the only reason SSLMate still has a Google Cloud presence
is to enable integrations with our customers&#39; Google Cloud accounts so that we can
publish certificate validation DNS records and discover domain names to monitor
on their behalf.  We create a service account for each customer under our Google Cloud project,
and ask the customer to authorize this service account to access Cloud DNS and Cloud Domains.
When SSLMate needs to access a customer&#39;s Google Cloud account, it impersonates the corresponding
service account.  I developed this system based on a suggestion in <a href="https://support.google.com/cloud/answer/13463817?sjid=3625613075585023337-NA#zippy=%2Chow-can-i-access-data-from-my-users-google-cloud-project-using-cloud-apis" rel="external">Google&#39;s own documentation</a> (under &#34;How can I access data from my users&#39; Google Cloud project using Cloud APIs?&#34;) and it works really well.
It is both very easy for the customer to configure, and secure: there are no long-lived credentials or confused
deputy vulnerabilities.
</p>

<p>
Easy <em>and</em> secure: I love it when that&#39;s possible!
</p>

<p>
The only problem is that Google keeps suspending our Google Cloud access.
</p>


<h4>The First Suspension</h4>

<p>
Google suspended us for the first time in 2024.  Our customer integrations began failing, and
logging into the Google Cloud console returned this error:
</p>

<p><a href="https://www.agwa.name/blog/post/google_suspended_sslmates_cloud_account_again/media/1.png"><img src="https://www.agwa.name/blog/post/google_suspended_sslmates_cloud_account_again/media/1.png" alt="Screenshot of Google Cloud web page stating &#34;Your account has been disabled&#34;"/></a></p>

<p>
Although Google&#39;s customer support people were surprisingly responsive considering Google&#39;s
rock-bottom reputation in this area, the process to recover our account was super frustrating:
</p>

<ol>
<li>
<p>Google required me to email them from the address associated with the account, but when
I did so, the message was bounced with the error &#34;The account [redacted] is disabled&#34; (the
redacted portion being the email address I sent from).  When I emailed from a different address, the message went
through, but the support people initially refused to communicate with it because it was the wrong address.
</p>
</li>

<li>
<p>
At one point Google asked me to provide the IDs of our Google Cloud projects - information which I could not retrieve
because I couldn&#39;t log in to the console.  Have <em>you</em> saved your project IDs in a safe place in case your account gets suspended?
</p>
</li>



<li>
<p>
After several emails back and forth with Google support, and verifying a phone number, I was able to log back into the
Google Cloud console, but two of our projects were still suspended, including the one needed for the customer integrations.
(At the time, we still had some domains registered through Google Cloud Domains, and thankfully the project
for this was accessible, allowing me to begin transferring all of our domains out to a more dependable registrar.)
</p>
</li>

<li>
<p>
The day after I regained access to the console, I received an
automated email from no-reply@accounts.google.com stating that my
access to Google Cloud Platform had been restricted.  Once again, I could no
longer access the console, but the error message was different this time:
</p>

<p><a href="https://www.agwa.name/blog/post/google_suspended_sslmates_cloud_account_again/media/2.png"><img src="https://www.agwa.name/blog/post/google_suspended_sslmates_cloud_account_again/media/2.png" alt="Screenshot of Google Cloud web page stating &#34;Access to a service or feature has been restricted&#34; and listing Google Cloud Platform as &#34;Entire service unavailable&#34;"/></a></p>
</li>

<li>
<p>
Twelve hours later, I received multiple automated
emails from google-cloud-compliance@google.com stating that my Google
Cloud projects had been &#34;reinstated&#34; but I still could not access the
console.
</p>
</li>

<li>
<p>
Seven hours after that, I got another automated email from
no-reply@accounts.google.com stating that my access to Google Cloud
Platform had been restored.  Everything began working after this.
</p>
</li>
</ol>

<p>
I was never told why our account was suspended or what could be done to
prevent it from happening again.
Although <a href="https://cloud.google.com/resource-manager/docs/project-suspension-guidelines" rel="external">Google claims
to send emails when an account or project is suspended</a>, they never did so for the initial suspension.
Since errors with customer integrations were only being displayed in our customers&#39; SSLMate consoles (usually
an error indicates the customer made a mistake), I didn&#39;t learn about the suspension right away.  I fixed this by
adding a health check that fails if a large percentage of Google Cloud integrations have errors.
</p>

<h4>The Second Suspension</h4>

<p>
Two Fridays ago, that health check failed.  I immediately investigated and saw
that all but one Google Cloud integrations were failing with the same error as during
last year&#39;s suspension (&#34;Invalid grant: account not found&#34;).  Groaning, I tried logging into the Google Cloud console,
bracing myself for another Kafkaesque reinstatement process.  <em>At least I know
the project IDs this time</em>, I reassured myself.  Surprisingly, I was able to log in
successfully.  Then I got emails, one per Google Cloud project, informing me
that my projects had been reinstated &#34;based on information that [I] have provided.&#34;
Naturally, I had received no emails that they had been suspended in the first place.
The integrations started working again.
</p>



<h4>The Third Suspension</h4>

<p>
Last Friday, the health check failed again.  I logged in to the Google Cloud console,
unsure what to expect.  This time, I was presented with a <em>third</em>
type of error message:
</p>

<p><a href="https://www.agwa.name/blog/post/google_suspended_sslmates_cloud_account_again/media/3.png"><img src="https://www.agwa.name/blog/post/google_suspended_sslmates_cloud_account_again/media/3.png" alt="Screenshot of Google Cloud web page stating &#34;We have detected a Terms of Service violation in SSLMate Integrations&#34; and containing a form to submit an appeal"/></a></p>

<p>
Most, but not all, of SSLMate&#39;s Google Cloud projects were suspended, including the one needed
for customer integrations.
</p>

<p>
I submitted an appeal on Friday. 
On Sunday, I received an email from Google. Was it a response to the appeal? Nope!
It was an automated email stating that SSLMate&#39;s access to Google Cloud was now <em>completely</em> suspended.
</p>

<h4>The Lucky Customer</h4>

<p>
Incredibly, we have one lucky customer whose integration has continued to work
during every suspension, even though it uses a service account in the same suspended project
as all the other customer integrations.
</p>

<h4>What Now?</h4>

<p>
Clearly, I cannot rely on having a Google account for production use cases.
Google has built a complex, unreliable system in which
some or all of the following can be suspended: an entire Google account, a Google
Cloud Platform account, or individual Google Cloud projects.
</p>

<p>Unfortunately, the alternatives for integrations are not great.</p>



<p>
The first alternative is to ask customers to create a service account for SSLMate and have SSLMate
authenticate to it using a long-lived key.  This is pretty easy, but less secure since the
long-lived key could leak and can never be rotated in practice.
</p>

<p>
The second alternative is to use OpenID Connect, aka OIDC.  In recent years, OIDC has become the de facto standard
for integrations between service providers.  For example, you can use OIDC to let <a href="https://docs.github.com/en/actions/how-tos/secure-your-work/security-harden-deployments/oidc-in-google-cloud-platform" rel="external">GitHub Actions
access your Google Cloud account</a> without the need for long-lived credentials.  SSLMate&#39;s Azure integration
uses OIDC and it works well.
</p>

<p>
Unfortunately, Google has made setting up OIDC unnecessarily difficult.  What is currently
a simple one step process for our customers to add an integration (assign some roles to a service account) would
become a complicated seven step process:
</p>

<ol>
<li>Enable the IAM Service Account Credentials API.</li>
<li>Create a service account.</li>
<li>Create a workload identity pool.</li>
<li>Create a workload identity provider in the pool created in step 3.</li>
<li>Allow SSLMate to impersonate the service account created in step 2 (this requires knowing the ID of the pool created in step 3).</li>
<li>Assign roles to the service account created in step 2.</li>
<li>Provide SSLMate with the ID of the service account created in step 2, and the ID of the workload identity provider created in step 4.</li>
</ol>

<p>
Since many of the steps require knowing the identifiers of resources created in previous steps, it&#39;s hard for SSLMate to provide easy-to-follow instructions.
</p>

<p>
This is more complicated than it needs to be:
</p>

<ul><li><p>Creating a service account (steps 1, 2, and 5) should not be necessary.  While it is possible to forgo a service account and assign roles directly to an identity from the pool, not all Google Cloud services support this. If you want your integration to work with all current and future services, you have to impersonate a service account.  Google should stop treating OIDC like a second-class citizen and guarantee that all current and future services will directly support it.</p></li><li><p>Creating an identity pool shouldn&#39;t be necessary either.  While I&#39;m sure some use
cases are nicely served by pools, it seems like most setups
are going to have just one provider per pool, making the extra step
of creating a pool nothing but unnecessary busy work.</p></li><li><p>Even creating a provider shouldn&#39;t be necessary; it should be possible to assign roles
directly to an OIDC issuer URL and subject. You should only have to create
a provider if you need to do more advanced configuration, such as mapping
attributes.</p></li></ul>

<p>
I find this state of affairs unacceptable, because it&#39;s really, really important to move away
from long-lived credentials and Google ought to be doing everything possible
to encourage more secure alternatives.  Sadly, SSLMate&#39;s current solution of
provider-created service accounts is susceptible to
arbitrary account suspensions, and OIDC is hampered by an unnecessarily complicated setup process.
</p>

<p>
In summary, when setting up cross-provider access with Google Cloud, you can have only two of the following:
</p>

<ol>
<li>No dangerous long-lived credentials.</li>
<li>Easy for the customer to set up.</li>
<li>Safe from arbitrary account suspensions.</li>
</ol>


<table>
	<thead>
		
		<tr>
			<th>Provider-created service accounts</th>
			<th>Service account + key</th>
			<th>OpenID Connect</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>No long-lived keys</td>
			<td></td>
			<td>No long-lived keys</td>
		</tr>
		<tr>
			<td>Easy setup</td>
			<td>Easy setup</td>
			<td></td>
		</tr>
		<tr>
			<td></td>
			<td>Safe from suspension</td>
			<td>Safe from suspension</td>
		</tr>
	</tbody>
</table>

<p>Which two would you pick?</p>


</div></div>
  </body>
</html>
