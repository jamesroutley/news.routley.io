<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/unix/DaemonizationAndRestarts">Original</a>
    <h1>Daemonization in Unix programs is probably about restarting programs</h1>
    
    <div id="readability-page-1" class="page"><div><h2>Daemonization in Unix programs is probably about restarting programs</h2>

	<p><small>October  5, 2024</small></p>
</div><div><p>It&#39;s standard for Unix daemon programs to <a href="https://utcc.utoronto.ca/~cks/space/blog/unix/BackgroundingTypes">&#39;daemonize&#39; themselves</a> when they start, completely detaching from how
they were run; <a href="https://utcc.utoronto.ca/~cks/space/blog/unix/DaemonizationIsQuiteOld">this behavior is quite old</a>
and these days it&#39;s somewhat controversial and sometimes considered
undesirable. At this point you might ask why programs even daemonize
themselves in the first place, and while I don&#39;t know for sure, I
do have an opinion. My belief is that <strong>daemonization is because
of restarting daemon programs</strong>, not starting them at boot.</p>

<p>During system boot, programs don&#39;t need to daemonize in order to
start properly. The general Unix boot time environment has long
been able to detach programs into the background (although <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=V7/etc/rc">the
V7 <code>/etc/rc</code></a>
didn&#39;t bother to do this with <code>/etc/update</code> and <code>/etc/cron</code>, <a href="https://www.tuhs.org/cgi-bin/utree.pl?file=4.2BSD/etc/rc">the
4.2BSD <code>/etc/rc</code></a>
did do this for the new BSD network daemons). In general, programs
started at boot time don&#39;t need to worry that they will be inheriting
things like stray file descriptors or a controlling terminal. It&#39;s
the job of the overall boot time environment to insure that they
start in a clean environment, and if there&#39;s a problem there you
should fix it centrally, not make it every program&#39;s job to deal
with the failure of your <code>init</code> and boot sequence.</p>

<p>However, <a href="https://utcc.utoronto.ca/~cks/space/blog/unix/InitWasNotAServiceManager">init is not a service manager</a>
(not historically), which meant that for a long time, starting or
restarting daemons after boot was entirely in your hands with no
assistance from the system. Even if you remembered to restart a
program as &#39;daemon &amp;&#39; so that it was backgrounded, the newly started
program could inherit all sorts of things from your login session.
It might have some random current directory, it might have stray
file descriptors that were inherited from your shell or login
environment, its standard input, output, and error would be connected
to your terminal, and it would have a <a href="https://utcc.utoronto.ca/~cks/space/blog/unix/JobControlAndTTYs">controlling terminal</a>, leaving it exposed to various bad things
happening to it when, for example, you logged out (which often would
deliver a SIGHUP to it).</p>

<p>This is the sort of thing that even <a href="https://utcc.utoronto.ca/~cks/space/blog/unix/DaemonizationIsQuiteOld">very old daemonization code</a> deals with, which is to say that it fixes.
The 4.2BSD daemonization code closes (stray) file descriptors and
removes any controlling terminal the process may have, in addition
to detaching itself from your shell (in case you forgot or didn&#39;t
use the &#39;&amp;&#39; when starting it). It&#39;s also easy to see how people
writing Unix daemons might drift into adding this sort of code to
them as people restarted the daemons (by hand) and ran into the
various problems (<a href="https://mastodon.social/@cks/113189813361804001">cf</a>).
In fact the 4.2BSD code for it is conditional on &#39;<code>DEBUG</code>&#39; not being
defined; presumably if you were debugging, say, rlogind, you&#39;d build
a version that didn&#39;t detach itself on you so you could easily run
it under a debugger or whatever.</p>

<p>It&#39;s a bit of a pity that 4.2 BSD and its successors didn&#39;t create
a general &#39;daemonize&#39; program that did all of this for you and then
told people to restart daemons with &#39;daemonize &lt;program&gt;&#39; instead
of &#39;&lt;program&gt;&#39;. But we got the Unix that we have, not the Unix that
we&#39;d like to have, and Unixes did eventually grow various forms of
service management that tried to encapsulate all of the things
required to restart daemons in one place.</p>

<p>(Even then, I&#39;m not sure that old System V init systems would
properly daemonize something that you restarted through
&#39;/etc/init.d/&lt;whatever&gt; restart&#39;, or if it was up to the program
to do things like close extra file descriptors and get rid of any
controlling terminal.)</p>

<p>PS: Much later, people did write tools for this, such as <a href="https://software.clapper.org/daemonize/">daemonize</a>. It&#39;s surprisingly handy
to have such a program lying around for when you want or need it.</p>
</div></div>
  </body>
</html>
