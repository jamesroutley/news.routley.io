<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://benhoyt.com/writings/goawk-csv/?m">Original</a>
    <h1>Modernizing AWK, a 45-year old language, by adding CSV support</h1>
    
    <div id="readability-page-1" class="page"><div id="container">



<div id="content">

<p>May 2022</p>

<p>I recently added proper handling of CSV files to <a href="https://github.com/benhoyt/goawk">GoAWK</a>, my POSIX-compatible AWK interpreter, and I think it’s a feature that will make AWK significantly more useful for developers and data analysts in our data-heavy world.</p>

<p>Whether it’s producing input for a spreadsheet, analyzing data from a public data source, or writing scripts to process “big data”, <a href="https://en.wikipedia.org/wiki/Comma-separated_values">CSV</a> and <a href="https://en.wikipedia.org/wiki/Tab-separated_values">TSV</a> files are ubiquitous today. Whether it’s the <em>best</em> format is up for debate, but like guy said, there are only two kinds of data formats: the ones people complain about and the ones nobody uses.</p>

<p>I’ve been thinking about adding CSV support to GoAWK since a Hacker News <a href="https://news.ycombinator.com/item?id=17786824">comment</a>, shortly after I released GoAWK in 2018:</p>

<blockquote>
  <p>Ha. I was just thinking how useful it would be to have the awk programming language available in a tool that natively understood csv files. Suddenly that seems a lot more doable!</p>
</blockquote>

<p>At the time I replied with a noncommittal response:</p>

<blockquote>
  <p>Interesting point. I’ve thought that AWK should have a mode where it does proper quote parsing of CSV files. Maybe I’ll add a -csv option for that (or just have it do it automatically when the FS is ‘,’ – though that wouldn’t be backwards compatible).</p>
</blockquote>

<p>Well, now we do have such a mode! The command line option ended up being <code>-i csv</code> (“input CSV”), but close enough.</p>

<p>A big thank-you to the <a href="https://www.uantwerpen.be/en/library/">library of the University of Antwerp</a>, who sponsored this feature. They’re one of two major teams or projects I know of that use GoAWK – the other one is the <a href="https://github.com/benthosdev/benthos">Benthos</a> stream processor.</p>

<h2 id="but-why">But why?</h2>

<p>Why do we need this in the first place? Unfortunately standard AWK doesn’t have a way to handle CSV files with quoted fields, which is very important for processing real-world CSV files.</p>

<p>You can set the field separator to comma (<code>-F,</code> or <code>FS=&#34;,&#34;</code>), but it’s a total hack, and will break on the first whiff of a quoted field. For example:</p>

<div><div><pre><code>$ cat quoted.csv
&#34;Smith, Bob&#34;,42
$ awk -F, &#39;{ print $1 }&#39; quoted.csv
&#34;Smith    # you want to print the first field: Smith, Bob
</code></pre></div></div>

<p>There are currently several workarounds to process CSV using AWK, such as <a href="https://www.gnu.org/software/gawk/manual/html_node/Splitting-By-Content.html">Gawk’s FPAT feature</a>, various <a href="http://mcollado.z15.es/xgawk/">CSV extensions</a> for Gawk, or Adam Gordon Bell’s <a href="https://github.com/adamgordonbell/csvquote">csvquote</a> tool, which you run to transform your input before running <code>awk</code>, and then run <code>csvquote -u</code> to undo the transform afterwards.</p>

<p>There’s also <a href="https://github.com/ezrosent/frawk">frawk</a>, which is an amazing tool by Eli Rosenthal that natively supports CSV, but unfortunately it deviates somewhat from POSIX-standard AWK. (Frawk inspired some of GoAWK’s CSV support, including the <code>-i</code> and <code>-o</code> command line options.)</p>

<p>So I think there’s a real need for proper CSV support in a POSIX-compatible version of AWK, and GoAWK provides that.</p>

<p>Before we dive in, let’s correct the quoting problem in the example above by using GoAWK’s CSV input mode:</p>

<div><div><pre><code>$ goawk -i csv &#39;{ print $1 }&#39; quoted.csv
Smith, Bob    # that&#39;s better!
</code></pre></div></div>

<h2 id="features">Features</h2>

<p><strong>CSV input mode.</strong> The <code>-i csv</code> option tells GoAWK to use CSV input mode: in other words, ignore the standard field and record separators (<code>FS</code> and <code>RS</code>), and use CSV parsing instead. There’s also a TSV mode, or you can use a custom separator character.</p>

<p>In addition, if you use the <code>-H</code> option, GoAWK uses the first row of the input as field names and adds a useful <code>@&#34;named-field&#34;</code> syntax that allows you to fetch a field by name instead of number.</p>

<p>For example, if we have a <code>states.csv</code> file whose contents are as follows:</p>

<div><div><pre><code>&#34;State&#34;,&#34;Abbreviation&#34;
&#34;Alabama&#34;,&#34;AL&#34;
&#34;Alaska&#34;,&#34;AK&#34;
&#34;Arizona&#34;,&#34;AZ&#34;
...
</code></pre></div></div>

<p>We can output just the state’s abbreviation using this script:</p>

<div><div><pre><code>$ goawk -i csv -H &#39;{ print @&#34;Abbreviation&#34; }&#39; states.csv
AL
AK
AZ
...
</code></pre></div></div>

<p>Or, to count the number of states that have “New” in the name:</p>

<div><div><pre><code>$ goawk -i csv -H &#39;@&#34;State&#34; ~ /New/ { n++ } END { print n }&#39; states.csv
4
</code></pre></div></div>

<p>The <code>~</code> is the regular expression match operator from standard AWK, so this code means: for records where the State field matches the regular expression <code>New</code>, increment <code>n</code>; at the end, print <code>n</code>.</p>

<p><strong>CSV output mode.</strong> The <code>-o csv</code> command line argument tells GoAWK to use CSV output mode: this makes <code>print</code> with one or more arguments write its output with proper CSV encoding.</p>

<p>For example, to convert <code>states.csv</code> to TSV, you could use the following (here we’re <em>not</em> using <code>-H</code>, so the header row is included):</p>

<div><div><pre><code>$ goawk -i csv -o tsv &#39;{ print $1, $2 }&#39; states.csv
State   Abbreviation
Alabama AL
Alaska  AK
Arizona AZ
...
</code></pre></div></div>

<p>Plus, we have all the features of standard AWK, so there’s a lot more you can do.</p>

<p><strong><a href="https://github.com/benhoyt/goawk/blob/master/csv.md">Read the CSV documentation</a> for full details and many more examples.</strong></p>

<h2 id="implementation-notes">Implementation notes</h2>

<p>The <a href="https://github.com/benhoyt/goawk/pull/107">implementation</a> is about 2000 lines of code, including extensive tests.</p>

<p>There is of course a Go API that allows you to enable CSV input or output mode using the <a href="https://pkg.go.dev/github.com/benhoyt/goawk/interp#Config"><code>interp.Config</code></a> struct to configure the options. You can also set the <code>INPUTMODE</code> or <code>OUTPUTMODE</code> special variables in the <code>BEGIN</code> block.</p>

<p>For various reasons, I wasn’t able to use <a href="https://pkg.go.dev/encoding/csv#Reader"><code>encoding/csv.Reader</code></a> directly for CSV input mode, but I reused the structure of the standard library code in my <a href="https://github.com/benhoyt/goawk/blob/acb9a737b8df4628a3fd980254d1b88a87e1933d/interp/io.go#L422"><code>csvSplitter</code></a> and massaged it into a <a href="https://pkg.go.dev/bufio#SplitFunc"><code>bufio.SplitFunc</code></a> that parses the fields and provides the entire row as the token.</p>

<p>In addition to <a href="https://github.com/benhoyt/goawk/blob/acb9a737b8df4628a3fd980254d1b88a87e1933d/interp/interp_test.go#L1453">many of my own tests</a>, I run the <a href="https://github.com/benhoyt/goawk/blob/master/interp/csvreader_test.go">relevant subset</a> of the standard library’s <code>csv.Reader</code> tests on my implementation to make sure I didn’t mess anything up and am still conforming to <a href="https://www.rfc-editor.org/rfc/rfc4180.html">RFC 4180</a>.</p>

<p>For CSV output mode, I <em>was</em> able to use <a href="https://pkg.go.dev/encoding/csv#Writer"><code>encoding/csv.Writer</code></a> directly (though writing CSV is significantly simpler than reading it). See the <a href="https://github.com/benhoyt/goawk/blob/acb9a737b8df4628a3fd980254d1b88a87e1933d/interp/io.go#L67"><code>writeCSV</code></a> function for details.</p>

<h2 id="performance">Performance</h2>

<p>I haven’t yet spent much time on performance. I intend to profile it properly at some point, but for now, it’s “good enough”: on a par with using Go’s <code>encoding/csv</code> package directly, and much faster than the <code>csv</code> module in Python. It can process a gigabyte of complex CSV input in under five seconds on my laptop.</p>

<p>Compared to <code>frawk</code>, CSV input speed is significantly slower, though (somewhat surprisingly) CSV output speed is significantly faster.</p>

<p>Below are the results of some simple read and write <a href="https://github.com/benhoyt/goawk/blob/master/scripts/csvbench">benchmarks</a> using <code>goawk</code> and <code>frawk</code> as well as plain Python and Go. The input for the read benchmarks is a large 1.5GB, 749,818-row input file with many columns (286). Times are in seconds, showing the best of three runs on my 64-bit Linux laptop with an SSD drive:</p>

<table>
  <thead>
    <tr>
      <th>Test</th>
      <th>goawk</th>
      <th>frawk</th>
      <th>Python</th>
      <th>Go</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Reading 1.5GB CSV</td>
      <td>6.49</td>
      <td>2.03</td>
      <td>20.2</td>
      <td>6.95</td>
    </tr>
    <tr>
      <td>Writing 0.6GB CSV</td>
      <td>3.25</td>
      <td>7.36</td>
      <td>10.5</td>
      <td>2.10</td>
    </tr>
  </tbody>
</table>

<h2 id="conclusion">Conclusion</h2>

<p>Computers are really fast now, so you can use GoAWK to process most CSV datasets, even gigabyte-sized ones, using just your developer laptop or a relatively small virtual machine. Who needs Hadoop anyway?</p>

<p>So please try out GoAWK on your next CSV processing task. AWK is 45 years old and <a href="https://lwn.net/Articles/820829/">still widely used</a>, and my hope is that this feature will make it even more useful in developers’ data tool kits.</p>

<p>I’d love it if you <a href="https://github.com/sponsors/benhoyt/">sponsored me on GitHub</a> – it will motivate me to work on my open source projects and write more good content. Thanks!</p>


</div>

</div></div>
  </body>
</html>
