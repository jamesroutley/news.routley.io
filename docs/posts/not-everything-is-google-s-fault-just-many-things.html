<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.railway.app/p/gcp-incidents">Original</a>
    <h1>Not Everything Is Google&#39;s Fault (Just Many Things)</h1>
    
    <div id="readability-page-1" class="page"><section><hr/><p><span>Over the last 18 months, we’ve had </span><span>more than a handful of issues</span><span> with Google. I was waiting to write about them until AFTER we got off Google, but now seems like a good time as any.</span></p><a href="https://blog.railway.app/p/gcp-incidents#background"><span id="background" aria-hidden="true"></span></a><p><span>Railway uses Google Cloud Platform </span><span>products such as Google’s Compute Engine</span><span> to power our application development platform.</span></p><p><span>On November 30th, at </span><span>1</span><span>6:40 UTC, Google unexpectedly restarted a workload running customer traffic. While this isn’t unexpected, it is a rare occurrence.</span></p><p><span>We have automated systems in place to detect and resolve this. We’re notified in Discord and if the box doesn’t become healthy after failover, we’re paged.</span></p><p><span>By </span><span>20:53 UTC</span><span>, the issue had been resolved, all workloads failed over successfully, and service was subsequently restored.</span></p><a href="https://blog.railway.app/p/gcp-incidents#google-cloud-history"><span id="google-cloud-history" aria-hidden="true"></span></a><a href="https://blog.railway.app/p/gcp-incidents#networking"><span id="networking" aria-hidden="true"></span><h2><span>Networking</span></h2></a><p><span>In 2022, we experienced continual networking blips from Google’s cloud products. After escalating to Google on multiple occasions, </span><span>we got frustrated</span><span>. </span></p><p><span>So we built our own networking stack — a resilient eBPF/IPv6 Wireguard network that now powers all our deployments</span></p><p><span>Suddenly, no more networking issues. </span></p><a href="https://blog.railway.app/p/gcp-incidents#registry"><span id="registry" aria-hidden="true"></span><h2><span>Registry</span></h2></a><p><span>In 2023</span><span>, Google randomly throttled our quota on their Artifact Registry down to nothing.</span></p><p><span>This caused our builds to be delayed as throughput of image distribution was cut substantially. Again, </span><span>we got frustrated.</span></p><p><span>Following this, we built our own registry product. </span></p><p><span>Voila, no more registry throughput issues.</span></p><a href="https://blog.railway.app/p/gcp-incidents#support"><span id="support" aria-hidden="true"></span><h2><span>Support</span></h2></a><p><span>After the issues above, I was fuming. How could Google do this? We paid them multiple millions of dollars per year, yet they simply couldn’t be bothered to care that their actions were affecting user workloads (both ours and </span><a href="https://twitter.com/zuhayeer/status/1696409759627551025?s=20" target="_blank" rel="noreferrer noopener"><span>many</span></a><span>. </span><a href="https://twitter.com/anuraggoel/status/1670863526272077825" target="_blank" rel="noreferrer noopener"><span>other</span></a><span>. </span><a href="https://twitter.com/itstonyhb/status/1669440932780077057" target="_blank" rel="noreferrer noopener"><span>customers</span></a><span>).</span></p><p><span>So, I did what any self-respecting founder does: I started </span><a href="https://x.com/JustJake/status/1667478906591666176?s=20" target="_blank" rel="noreferrer noopener"><span>tweeting</span></a><span>.</span></p><div><p><img alt="" sizes="100vw" srcset="/_next/image?url=https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fa63b5cbc-d4d5-4113-9555-0919a5dd0f1f%2Fb6cdb211-637a-4f6a-bcac-d87b585bde3d%2Ftweet-1667478906591666176_%25281%2529.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45HZZMZUHI%252F20231202%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20231202T111034Z%26X-Amz-Expires%3D3600%26X-Amz-Signature%3D832063e65692e9be8eae4ec15485c7f7ef351114d164ba36ab8a4481c8af5457%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject&amp;w=640&amp;q=75 640w, /_next/image?url=https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fa63b5cbc-d4d5-4113-9555-0919a5dd0f1f%2Fb6cdb211-637a-4f6a-bcac-d87b585bde3d%2Ftweet-1667478906591666176_%25281%2529.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45HZZMZUHI%252F20231202%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20231202T111034Z%26X-Amz-Expires%3D3600%26X-Amz-Signature%3D832063e65692e9be8eae4ec15485c7f7ef351114d164ba36ab8a4481c8af5457%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject&amp;w=750&amp;q=75 750w, /_next/image?url=https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fa63b5cbc-d4d5-4113-9555-0919a5dd0f1f%2Fb6cdb211-637a-4f6a-bcac-d87b585bde3d%2Ftweet-1667478906591666176_%25281%2529.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45HZZMZUHI%252F20231202%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20231202T111034Z%26X-Amz-Expires%3D3600%26X-Amz-Signature%3D832063e65692e9be8eae4ec15485c7f7ef351114d164ba36ab8a4481c8af5457%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject&amp;w=828&amp;q=75 828w, /_next/image?url=https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fa63b5cbc-d4d5-4113-9555-0919a5dd0f1f%2Fb6cdb211-637a-4f6a-bcac-d87b585bde3d%2Ftweet-1667478906591666176_%25281%2529.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45HZZMZUHI%252F20231202%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20231202T111034Z%26X-Amz-Expires%3D3600%26X-Amz-Signature%3D832063e65692e9be8eae4ec15485c7f7ef351114d164ba36ab8a4481c8af5457%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject&amp;w=1080&amp;q=75 1080w, /_next/image?url=https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fa63b5cbc-d4d5-4113-9555-0919a5dd0f1f%2Fb6cdb211-637a-4f6a-bcac-d87b585bde3d%2Ftweet-1667478906591666176_%25281%2529.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45HZZMZUHI%252F20231202%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20231202T111034Z%26X-Amz-Expires%3D3600%26X-Amz-Signature%3D832063e65692e9be8eae4ec15485c7f7ef351114d164ba36ab8a4481c8af5457%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject&amp;w=1200&amp;q=75 1200w, /_next/image?url=https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fa63b5cbc-d4d5-4113-9555-0919a5dd0f1f%2Fb6cdb211-637a-4f6a-bcac-d87b585bde3d%2Ftweet-1667478906591666176_%25281%2529.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45HZZMZUHI%252F20231202%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20231202T111034Z%26X-Amz-Expires%3D3600%26X-Amz-Signature%3D832063e65692e9be8eae4ec15485c7f7ef351114d164ba36ab8a4481c8af5457%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject&amp;w=1920&amp;q=75 1920w, /_next/image?url=https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fa63b5cbc-d4d5-4113-9555-0919a5dd0f1f%2Fb6cdb211-637a-4f6a-bcac-d87b585bde3d%2Ftweet-1667478906591666176_%25281%2529.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45HZZMZUHI%252F20231202%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20231202T111034Z%26X-Amz-Expires%3D3600%26X-Amz-Signature%3D832063e65692e9be8eae4ec15485c7f7ef351114d164ba36ab8a4481c8af5457%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject&amp;w=2048&amp;q=75 2048w, /_next/image?url=https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fa63b5cbc-d4d5-4113-9555-0919a5dd0f1f%2Fb6cdb211-637a-4f6a-bcac-d87b585bde3d%2Ftweet-1667478906591666176_%25281%2529.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45HZZMZUHI%252F20231202%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20231202T111034Z%26X-Amz-Expires%3D3600%26X-Amz-Signature%3D832063e65692e9be8eae4ec15485c7f7ef351114d164ba36ab8a4481c8af5457%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject&amp;w=3840&amp;q=75 3840w" src="https://blog.railway.app/_next/image?url=https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fa63b5cbc-d4d5-4113-9555-0919a5dd0f1f%2Fb6cdb211-637a-4f6a-bcac-d87b585bde3d%2Ftweet-1667478906591666176_%25281%2529.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45HZZMZUHI%252F20231202%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20231202T111034Z%26X-Amz-Expires%3D3600%26X-Amz-Signature%3D832063e65692e9be8eae4ec15485c7f7ef351114d164ba36ab8a4481c8af5457%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject&amp;w=3840&amp;q=75" decoding="async" data-nimg="fill" loading="lazy"/></p></div><p><span>Google reached out, and I took it upon myself to sit down with a few of their VPs to get to the bottom of what happened, so it never happened to anybody else.</span></p><p><span>As it turns out, a Google engineer was able to arbitrarily change the quota on GCP.</span></p><p><span>I expressed to the VPs that this wasn’t acceptable. They agreed and said “We’re digging in heavily to this. It’s going all the way to the top!”</span></p><p><span>That was </span><span>June. To this day, I’m still following up</span><span> to get that retro and official response + policy added to prevent arbitrary quota changes</span></p><div><p><img alt="" sizes="100vw" srcset="/_next/image?url=https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fa63b5cbc-d4d5-4113-9555-0919a5dd0f1f%2Fb241e00f-661d-49a7-81dd-13e8a0b8ae69%2FCleanShot_2023-12-01_at_16.47.062x.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45HZZMZUHI%252F20231202%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20231202T111034Z%26X-Amz-Expires%3D3600%26X-Amz-Signature%3D03b671faa7a5d9f18da801a8bed0810ccc8240d996cf40e9e71751ddb72e7d15%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject&amp;w=640&amp;q=75 640w, /_next/image?url=https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fa63b5cbc-d4d5-4113-9555-0919a5dd0f1f%2Fb241e00f-661d-49a7-81dd-13e8a0b8ae69%2FCleanShot_2023-12-01_at_16.47.062x.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45HZZMZUHI%252F20231202%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20231202T111034Z%26X-Amz-Expires%3D3600%26X-Amz-Signature%3D03b671faa7a5d9f18da801a8bed0810ccc8240d996cf40e9e71751ddb72e7d15%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject&amp;w=750&amp;q=75 750w, /_next/image?url=https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fa63b5cbc-d4d5-4113-9555-0919a5dd0f1f%2Fb241e00f-661d-49a7-81dd-13e8a0b8ae69%2FCleanShot_2023-12-01_at_16.47.062x.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45HZZMZUHI%252F20231202%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20231202T111034Z%26X-Amz-Expires%3D3600%26X-Amz-Signature%3D03b671faa7a5d9f18da801a8bed0810ccc8240d996cf40e9e71751ddb72e7d15%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject&amp;w=828&amp;q=75 828w, /_next/image?url=https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fa63b5cbc-d4d5-4113-9555-0919a5dd0f1f%2Fb241e00f-661d-49a7-81dd-13e8a0b8ae69%2FCleanShot_2023-12-01_at_16.47.062x.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45HZZMZUHI%252F20231202%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20231202T111034Z%26X-Amz-Expires%3D3600%26X-Amz-Signature%3D03b671faa7a5d9f18da801a8bed0810ccc8240d996cf40e9e71751ddb72e7d15%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject&amp;w=1080&amp;q=75 1080w, /_next/image?url=https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fa63b5cbc-d4d5-4113-9555-0919a5dd0f1f%2Fb241e00f-661d-49a7-81dd-13e8a0b8ae69%2FCleanShot_2023-12-01_at_16.47.062x.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45HZZMZUHI%252F20231202%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20231202T111034Z%26X-Amz-Expires%3D3600%26X-Amz-Signature%3D03b671faa7a5d9f18da801a8bed0810ccc8240d996cf40e9e71751ddb72e7d15%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject&amp;w=1200&amp;q=75 1200w, /_next/image?url=https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fa63b5cbc-d4d5-4113-9555-0919a5dd0f1f%2Fb241e00f-661d-49a7-81dd-13e8a0b8ae69%2FCleanShot_2023-12-01_at_16.47.062x.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45HZZMZUHI%252F20231202%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20231202T111034Z%26X-Amz-Expires%3D3600%26X-Amz-Signature%3D03b671faa7a5d9f18da801a8bed0810ccc8240d996cf40e9e71751ddb72e7d15%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject&amp;w=1920&amp;q=75 1920w, /_next/image?url=https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fa63b5cbc-d4d5-4113-9555-0919a5dd0f1f%2Fb241e00f-661d-49a7-81dd-13e8a0b8ae69%2FCleanShot_2023-12-01_at_16.47.062x.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45HZZMZUHI%252F20231202%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20231202T111034Z%26X-Amz-Expires%3D3600%26X-Amz-Signature%3D03b671faa7a5d9f18da801a8bed0810ccc8240d996cf40e9e71751ddb72e7d15%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject&amp;w=2048&amp;q=75 2048w, /_next/image?url=https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fa63b5cbc-d4d5-4113-9555-0919a5dd0f1f%2Fb241e00f-661d-49a7-81dd-13e8a0b8ae69%2FCleanShot_2023-12-01_at_16.47.062x.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45HZZMZUHI%252F20231202%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20231202T111034Z%26X-Amz-Expires%3D3600%26X-Amz-Signature%3D03b671faa7a5d9f18da801a8bed0810ccc8240d996cf40e9e71751ddb72e7d15%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject&amp;w=3840&amp;q=75 3840w" src="https://blog.railway.app/_next/image?url=https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2Fa63b5cbc-d4d5-4113-9555-0919a5dd0f1f%2Fb241e00f-661d-49a7-81dd-13e8a0b8ae69%2FCleanShot_2023-12-01_at_16.47.062x.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45HZZMZUHI%252F20231202%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20231202T111034Z%26X-Amz-Expires%3D3600%26X-Amz-Signature%3D03b671faa7a5d9f18da801a8bed0810ccc8240d996cf40e9e71751ddb72e7d15%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject&amp;w=3840&amp;q=75" decoding="async" data-nimg="fill" loading="lazy"/></p></div><div><p>💡</p><p><span>Bonus: During this whole exchange, they changed their ToS without warning to cause our costs to go up by 20%</span></p></div><p><span>After citing </span><a href="https://gist.github.com/chitchcock/1281611" target="_blank" rel="noreferrer noopener"><span>Steve Yegge’s Platform Rant</span></a><span> to any VP that would listen, I felt defeated.</span></p><p><span>Last quarter, we made the decision internally to sunset all Google Cloud services and move to our own bare metal instances. We got our first one up a couple weeks ago, and will be moving all our instances in 2024.</span></p><p><span>In our experience, Google isn’t the place for reliable cloud compute, and it’s sure as heck not the place for reliable customer support.</span></p><p><span>That leads us to today’s incident.</span></p><a href="https://blog.railway.app/p/gcp-incidents#incident-retro"><span id="incident-retro" aria-hidden="true"></span></a><p><span>On December 1st, at 8:52am PST, a box dropped offline; inaccessible.</span><span> And then, instead of automatically coming back after failover — it didn’t.</span></p><p><span>Our primary on-call engineer was alerted for this and dug in. While digging in, another box fell offline and didn’t come back.</span></p><p><span>We started manually failing over these boxes (~10 minutes of downtime each), but soon enough there were a dozen of these boxes and half the company was called in to go through runbooks.</span></p><p><span>Given our experience with Google Cloud, and what we saw in the serial logs lining up with what we’d seen prior for Google Cloud’s automated live-migration, we filed a ticket with both our cloud reseller, as well as the Googlers who said they’d “Support us, day or night.” By the time Google got back to us hours later, we’d already resolved the incident.</span></p><p><span>As we were manually failing these over, we kept digging.</span></p><p><span>Our first reaction was to look through the serial console </span><span>logs</span><span> — these logs come straight from the kernel via a virtualized serial device.</span></p><p><span>When we scrubbed through the serial console logs, we noticed </span><span>soft</span><span>-locked CPU cores as well as stack traces for locked CPUs showing entries such as </span><code>kvm_wait</code><span> or </span><code>__pv_queued_spin_lock_slowpath</code><span>.</span></p><p><span>The last time we had seen similar logs and behavior within the serial console logs was during a Google-initiated restart which occurred on three boxes last year, also in December.</span></p><p><span>As we dug into this more, we found additional kernel errors which lined up with a few threads on GCP’s nested kernel virtualization causing soft lockups. You can see Google acknowledge this bug </span><a href="https://github.com/kubernetes/kubernetes/issues/37853#issuecomment-264587949" target="_blank" rel="noreferrer noopener"><span>here</span></a><span>. Additionally, other users have complained about it </span><a href="https://stackoverflow.com/questions/49495429/google-cloud-engine-kernelnmi-watchdog-bug-soft-lockup" target="_blank" rel="noreferrer noopener"><span>here</span></a><span> and </span><a href="https://stackoverflow.com/questions/60233338/cpu-soft-lockup-on-gcp-kvm-on-centos" target="_blank" rel="noreferrer noopener"><span>here</span></a><span>. All on GCP.</span></p><p><span>Because we don’t use virtualization ourselves on these hosts (yet), these messages re: kvm and paravirtualization would relate to the guest kernel code that interacts with the GCP hypervisor.</span></p><p><span>The users in the 3 issues above seemed to experience the same thing, all on GCP. GCP seems to have dismissed this as “</span><a href="https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/issues/138" target="_blank" rel="noreferrer noopener"><span>not reproducible</span></a><span>,” but we strongly believe we experienced the same thing here.</span></p><p><span>Specifically, we b</span><span>elieve that there is a potentially fatal interaction in userspace-to-kernel memory transfer on GCP guests which causes softlocks in rare cases</span><span>. </span></p><p><span>More accurately, we believe this to be related to the paravirtualized memory management and how these pages are mapped and remapped on the hypervisor during certain kinds of resource pressure. The one common factor in all the reports we’ve seen is that nearly all reports are from GCP users.</span></p><div><p>💡</p><p><span>This would make sense given Google now does most of it’s MMIO instructs in userspace (See: </span><a href="https://cloud.google.com/blog/products/gcp/7-ways-we-harden-our-kvm-hypervisor-at-google-cloud-security-in-plaintext/" target="_blank" rel="noreferrer noopener"><span>Google Blog</span></a><span> and </span><a href="https://youtu.be/vj5PA_D03Vg?t=858" target="_blank" rel="noreferrer noopener"><span>YouTube Video</span></a><span>)</span></p></div><p><span>If the above is true, much like the quota issue we experienced prior, this means there is an arbitrary, unposted speed limit/threshold/condition in which your boxes softlock, despite being well below utilization on all possible observed telemetry (CPU/mem/IOPS). These machines were around 50% of their posted resource limits, which is inline with this </span><a href="https://stackoverflow.com/questions/49495429/google-cloud-engine-kernelnmi-watchdog-bug-soft-lockup" target="_blank" rel="noreferrer noopener"><span>article</span></a><span> about GCP nested virtualization.</span></p><p><span>After a manual reboot, we disabled some internal services to decrease resource pressure on the affected instances, and the instances became stable after that point.</span></p><a href="https://blog.railway.app/p/gcp-incidents#the-bottom-line-for-users"><span id="the-bottom-line-for-users" aria-hidden="true"></span></a><p><span>During manual failover of these machines, there was a 10 minute per host downtime. However, as many people are running multi-service workloads, this downtime can be multiplied many times as boxes subsequently went offline.</span></p><p><span>For all of our users, </span><span>we’re deeply sorry</span><span>. </span></p><p><span>This is obscenely frustrating for us and, as mentioned, we’re moving to our own bare metal to give you all increased reliability.</span></p></section></div>
  </body>
</html>
