<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://code.blender.org/2022/10/wayland-support-on-linux/">Original</a>
    <h1>Blender: Wayland Support on Linux</h1>
    
    <div id="readability-page-1" class="page"><article id="post-9834 class=" post-9834="" post="" type-post="" status-publish="" format-standard="" has-post-thumbnail="" hentry="" category-gendev="" tag-linux""="">
														<!-- blog_article_header -->
														<div>
								
<!--?xml encoding="utf-8"?--><figure><a href="https://code.blender.org/wp-content/uploads/2022/10/layer1-3-1.png?x10630"><img width="488" height="196" src="https://code.blender.org/wp-content/uploads/2022/10/layer1-3-1.png?x10630" alt="" srcset="https://code.blender.org/wp-content/uploads/2022/10/layer1-3-1.png 488w, https://code.blender.org/wp-content/uploads/2022/10/layer1-3-1-300x120.png 300w" sizes="(max-width: 488px) 100vw, 488px"/></a></figure>



<p>Recently we have been working on native Wayland support on Linux.</p>



<p>Wayland is now enabled for daily builds and if all goes well, it will be enabled for Blender 3.4 release too.</p>



<p>If you’re a Wayland user, try a recent build.</p>



<ul><li>The library <code>libdecor</code> needs to be installed.</li><li>To see if native Wayland is used, check the  “About” splash (accessed from the “Blender” icon menu, top left). You should see:</li></ul>



<p>Please report bugs for any Wayland specific issues you run into.</p>



<a href="#why-wayland"><h2 id="why-wayland">Why Wayland?</h2></a>



<p>Even though Wayland has existed since ~2008 as a replacement for X11, it’s only recently that some Linux distributions have been enabling it by default.</p>



<p>Long term, native Wayland support should give us the best user experience, allowing Blender to support features exposed by Wayland without being limited by the X11 compatibility layer.</p>



<a href="#why-not-sdl"><h2 id="why-not-sdl">Why not SDL?</h2></a>



<p>It’s possible for Blender to be built against SDL – a cross-platform library that interfaces multiple windowing environments, handle user input … etc. A case can be made for avoiding the work of supporting Wayland directly and using a library that abstracts away the platform specific details.</p>



<p>The challenge with using 3rd party libraries for windowing is it can make using platform specific features more difficult. Blender also uses input devices SDL doesn’t support: tablets &amp; NDOF (3D-mouse) devices.</p>



<p>Nevertheless, we seriously considered using SDL, concluding that it would require us becoming SDL developers to properly support Blender. As SDL’s focus is on gaming, this isn’t necessarily aligned with the needs of applications – so we felt it best to continue using native support for the windowing environment.</p>



<a href="#some-back-story"><h2 id="some-back-story">Some Back Story</h2></a>



<p>Initial support for Wayland landed back in 2020 (<a href="https://developer.blender.org/D6567">big thanks to Christian Rauch for his contributions</a>).</p>



<p>Examples of remaining issues included:</p>



<ul><li>No tablet support.</li><li>No NDOF (3D mouse) support.</li><li>No cursor warping.</li><li>No window frames.</li><li>No Hi-DPI support.</li><li>Wayland was a requirement, even for X11 or users running Blender on render-farms.</li></ul>



<p>See the <a href="https://developer.blender.org/T76428">GHOST/Wayland Support</a> task for a full list of TODO’s.</p>



<p>Around May this year I tried switching to Wayland (no XWayland), as I had upgraded my computer and switched to an AMD graphics card (which runs Wayland well). Emacs had just added native Wayland support so there wasn’t anything holding me back.</p>



<p>Since then I’ve been using Wayland exclusively, fixing issues when they arise and investigating bugs reported by users.</p>



<p>Now Wayland is enabled in our official builds, I hope to validate it for the up coming release. So unless issues arise which we’re unable to resolve, it will be officially supported in Blender 3.4x onward.</p>



<a href="#technical-details"><h2 id="technical-details">Technical Details</h2></a>



<ul><li>Wayland has some intentional constraints that impact Blender, for example:<ul><li>Setting the cursor position directly isn’t supported. To support cursor warping the cursor is locked in-place, then a virtual cursor is drawn in software for e.g.</li><li>Positioning windows <a href="https://lists.freedesktop.org/archives/wayland-devel/2022-August/042326.html">on a particular monitor</a> or relative to other windows isn’t supported. This means dragging content (color, icons in the outliner … etc) isn’t supported between windows. We have to use system-level drag events (the same kinds of drag &amp; drop support used by file browsers) – something Blender should be doing anyway.</li></ul></li><li><a href="https://gitlab.gnome.org/GNOME/mutter/-/issues/217">Gnome-shell has decided not to support server side decorations</a>, meaning it’s up to each application to define it’s own window frame (title bar &amp; window borders). For developers of tool-kits such as GTK/QT, this makes some sense as they can build window drawing into their toolkit. For a cross-platform applications like as Blender it isn’t so convenient, although longer term we might look into client-side decorations. For now we’re using <code><a href="https://gitlab.gnome.org/jadahl/libdecor">libdecor</a></code> and we’ll see how it evolves.</li><li>Initially Wayland was difficult to troubleshoot, when something went wrong often the window would just close without a crash or warning that pointed to the problem. Eventually I found <code>wl_log_set_handler_client</code> could be set (which now prints a stack-trace to help track down issues). So the situation isn’t as bad, although there are still a <a href="https://developer.blender.org/T100855">closing window issue that need investigation</a>.</li><li>While X11 carries many of it’s own quirks &amp; historic baggage in practice we only needed to support a single implementation (Xorg). As Wayland has multiple compositors, each of these can behave differently <a href="https://gitlab.gnome.org/GNOME/mutter/-/issues/2231">calling event handlers in a different order</a> or <a href="https://gitlab.gnome.org/GNOME/mutter/-/issues/2457">omitting some arguments</a>. Although there are 3 main compositors: (gnome-shell, KDE &amp; Sway (with various compositors based on Sway’s <code>wlroots</code> library). Hopefully these differences will be ironed out over time, for now we have to keep some workarounds for composites that misbehave (reporting bugs up-stream).</li><li>Support for dynamically linking <code>libwayland</code> (and related Wayland libraries), proved to be much more of an ordeal than I’d expected (<a href="https://lists.freedesktop.org/archives/wayland-devel/2022-June/042264.html">due to the API’s use of <code>varargs</code></a>), making it impractical to forward arguments without compiler specific workarounds. This was solved by <a href="https://developer.blender.org/rBe58e023e1a3e10f4ff2557aedcd730b5dba23579">replacing function calls in auto-generated headers</a>, while not ideal it’s functional.</li><li>Wayland development unexpectedly lead to fixing an <a href="https://developer.blender.org/T40059" data-type="URL" data-id="https://developer.blender.org/T40059">8 year old bug on MS-Windows</a>. Supporting modifier key detection on Wayland involved changes to modifier handling on all platforms. I stumbled on error prone logic that caused issues with modifier key detection (commits <a href="https://developer.blender.org/rB37d835f0bca28a7cbf577385d9828636e7811cc5">1</a>, <a href="https://developer.blender.org/rB37d835f0bca28a7cbf577385d9828636e7811cc5">2</a>).</li></ul>



<p>Campbell Barton</p>



<p>Australia, 11th October. 2022</p>

							</div>
						</article></div>
  </body>
</html>
