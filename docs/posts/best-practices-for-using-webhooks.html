<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://stripe.com/docs/webhooks/best-practices">Original</a>
    <h1>Best Practices for Using Webhooks</h1>
    
    <div id="readability-page-1" class="page"><div><p>Webhooks provide a powerful method to track the state of transactions and to take actions within your Stripe account. Review these best practices to ensure your webhooks remain secure and function seamlessly with your integration.</p><h2 id="api-versions"><span>API versions </span></h2><p>The structure of an <code>Event</code> object sent in a webhook is dictated by the API version in your account settings at the time of the event’s occurrence. For example, if your account is set to an older API version, such as <strong>2015-02-16</strong>, and you change the API version for a specific request via <a href="https://stripe.com/docs/api#versioning">versioning</a>, the <code>Event</code> object generated and sent to your endpoint is still based upon the <strong>2015-02-16</strong> API version.</p><p><code>Event</code> objects can never be changed once created. For example, if a charge is updated, the original charge event remains unchanged. This means that subsequent updates to your account’s API version do not retroactively alter existing <code>Event</code> objects. Fetching older events by calling <code>/v1/events</code> using a newer API version also has no impact on the structure of the received events.</p><p>You can set test webhook endpoints to either your default API version or the latest API version. The <code>Event</code> sent to the webhook URL is structured for the endpoint’s specified version. You can also programmatically create endpoints with a specific <a href="https://stripe.com/docs/api/webhook_endpoints/create#create_webhook_endpoint-api_version">api_version</a>.</p><h2 id="event-types"><span>Event types </span></h2><p>Your webhook endpoints should be configured to receive only the types of events required by your integration. Listening for extra events (or all events) will put undue strain on your server and is not recommended.</p><p>You can <a href="https://stripe.com/docs/api/webhook_endpoints/update#update_webhook_endpoint-enabled_events">change the events</a> a webhook endpoint will receive in the Dashboard or with the API.</p><h2 id="events-and-retries"><span>Delivery attempts and retries </span></h2><p>Understand how to view delivery attempts, event logs, and the retry logic when webhook events aren’t acknowledged.</p><h3 id="view-events"><span>View events </span></h3><p>When viewing information about a <a href="https://dashboard.stripe.com/events">specific event</a> through the Dashboard, you can check how many times Stripe attempted to send an event to an endpoint by clicking on that endpoint URL in the <strong>Webhooks</strong> section. This shows the latest response from your endpoint, a list of all attempted webhooks, and the respective HTTP status codes Stripe received.</p><h3 id="retry-logic"><span>Retry logic </span></h3><p>In live mode, Stripe attempts to deliver your webhooks for up to three days with an exponential back off. In the <a href="https://dashboard.stripe.com/events">Events</a> section of the Dashboard, you can view when the next retry will occur.</p><p>In test mode, Stripe retries three times over a few hours. Webhooks can be manually retried after this time in the Dashboard, and you can also <a href="https://stripe.com/docs/api/events/list">query for missed events</a> to reconcile the data over any time period.</p><p>If your endpoint has been disabled or deleted when we attempt a retry, future retries of that event will be prevented. However, if you disable and then re-enable a webhook endpoint before we’re able to retry, you should still expect to see future retry attempts.</p><h3 id="disable-logic"><span>Disable logic </span></h3><p>In live and test mode, Stripe will attempt to notify you of a misconfigured endpoint via email if an endpoint has not responded with a <code>2xx</code> HTTP status code for multiple days in a row. The email also states when the endpoint will be automatically disabled.</p><h2 id="event-handling"><span>Event handling </span></h2><p>Handling webhook events correctly is crucial to making sure your integration’s business logic works as expected.</p><h3 id="duplicate-events"><span>Handle duplicate events </span></h3><p>Webhook endpoints might occasionally receive the same event more than once. We advise you to guard against duplicated event receipts by making your event processing <a href="https://en.wikipedia.org/wiki/Idempotence">idempotent</a>. One way of doing this is logging the events you’ve processed, and then not processing already-logged events.</p><h3 id="event-ordering"><span>Order of events </span></h3><p>Stripe does not guarantee delivery of events in the order in which they are generated. For example, creating a subscription might generate the following events:</p><ul><li><code>customer.subscription.created</code></li><li><code>invoice.created</code></li><li><code>invoice.paid</code></li><li><code>charge.created</code> (if there’s a charge)</li></ul><p>Your endpoint shouldn’t expect delivery of these events in this order and should handle this accordingly. You can also use the API to fetch any missing objects (for example, you can fetch the <span><span><a title="invoices" href="https://stripe.com/docs/api/invoices">invoice</a></span></span>, charge, and subscription objects using the information from <code>invoice.paid</code> if you happen to receive this event first).</p><h2 id="security"><span>Security </span></h2><p>Keeping your endpoints secure is critical to protecting your customers’ information. Stripe provides several ways for you to verify events are coming from Stripe in a secure manner.</p><h3 id="csrf-protection"><span>CSRF protection </span></h3><p>If you’re using Rails, Django, or another web framework, your site might automatically check that every POST request contains a <em>CSRF token</em>. This is an important security feature that helps protect you and your users from <a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)">cross-site request forgery</a> attempts. However, this security measure might also prevent your site from processing legitimate events. If so, you might need to exempt the webhooks route from CSRF protection.</p><div id="codetabs_215a8918f8daaf24795d30e09222a73899fa772a"><p><span><div><div data-language="ruby"><pre><p><code><span>class</span> <span>StripeController</span> <span>&lt;</span> <span>ApplicationController</span>
  
  
  
  
  protect_from_forgery except<span>:</span> <span>:webhook</span>

  <span>def</span> <span>webhook</span>
    
  <span>end</span>
<span>end</span></code><span aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></p></pre></div></div></span></p></div><h3 id="webhooks-with-https"><span>Receive events with an HTTPS server </span></h3><p>If you use an HTTPS URL for your webhook endpoint, Stripe validates that the connection to your server is secure before sending your webhook data. For this to work, your server must be correctly configured to support HTTPS with a valid server certificate. Live mode requires HTTPS URLs. Stripe webhooks don’t currently support <span><span><a title="TLS" href="https://stripe.com/docs/security/guide#tls">TLS</a></span></span> v1.3.</p><h3 id="endpoint-secrets"><span>Roll endpoint secrets </span></h3><p>The secret used for verifying that events come from Stripe is modifiable in the <a href="https://dashboard.stripe.com/webhooks">Webhooks section</a> section of the Dashboard. For each endpoint, click <strong>Roll secret</strong>. You can choose to immediately expire the current secret or delay its expiration for up to 24 hours to allow yourself time to update the verification code on your server. During this time, multiple secrets are active for the endpoint. Stripe generates one signature per secret until expiration.</p><h3 id="verify-events"><span>Verify events are sent from Stripe </span></h3><p><a href="https://stripe.com/docs/webhooks/signatures">Verify webhook signatures</a> to confirm that received events are sent from Stripe. Additionally, Stripe sends webhook events from a set list of IP addresses. Only trust events coming from these <a href="https://stripe.com/docs/ips">IP addresses</a>.</p></div></div>
  </body>
</html>
