<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/ncruces/go-sqlite-bench">Original</a>
    <h1>Show HN: My Go SQLite driver did poorly on a benchmark, so I fixed it</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">

<p dir="auto">This work is sponsored by Monibot - Easy Server and Application Monitoring.
Try out Monibot at <a href="https://monibot.io?ref=go-sqlite-bench" rel="nofollow">https://monibot.io</a>.
It&#39;s free.</p>
<p dir="auto">For benchmarks I used the following libraries:</p>
<ul dir="auto">
<li>
<p dir="auto">craw, <code>crawshaw.io/sqlite</code>, a CGO-based solution. This is not a <code>database/sql</code> driver.</p>
</li>
<li>
<p dir="auto">mattn, <code>github.com/mattn/go-sqlite3</code>, a CGO-based solution. This library is
(still) the de-facto standard and widely used.</p>
</li>
<li>
<p dir="auto">modernc, <code>modernc.org/sqlite</code>, a pure Go solution. This is a newer library,
based on the SQLite C code re-written in Go.</p>
</li>
<li>
<p dir="auto">ncruces, <code>github.com/ncruces/go-sqlite3</code>, a pure Go solution based on WASM (?).</p>
</li>
<li>
<p dir="auto">sqinn, <code>github.com/cvilsmeier/sqinn-go</code>, a solution without CGO. It uses
<code>github.com/cvilsmeier/sqinn</code> to access SQLite database files.</p>
</li>
<li>
<p dir="auto">zombie, <code>github.com/zombiezen/go-sqlite</code>, a rewrite of the crawshaw driver, using the
modernc libraries. This is not a <code>database/sql</code> driver.</p>
</li>
</ul>
<p dir="auto">The test setup is as follows:</p>
<ul dir="auto">
<li>OS: Debian/GNU Linux amd64 version 12.3</li>
<li>CPU: 11th Gen Intel(R) Core(TM) i7-1165G7 @ 2.80GHz, 4 physical cores, 8 logical cores</li>
<li>RAM: 16GB</li>
<li>Disk: 1TB NVME SSD</li>
<li>go version go1.21.5 linux/amd64</li>
</ul>
<p dir="auto">The benchmark was run on 2023-12-09, with then-current library versions.
See go.mod for library versions. Each test was run once for warmup.
The second run was then recorded.</p>
<p dir="auto">A general note on benchmarks:</p>
<p dir="auto">Do not trust benchmarks, write your own. This specific benchmark is modelled
after my very own database usage scenarios. Your scenarios may be totally
different.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-database-schema" aria-hidden="true" tabindex="-1" href="#database-schema"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Database Schema</h2>
<p dir="auto">The test database consist of the following tables and indizes:</p>
<div data-snippet-clipboard-copy-content="PRAGMA journal_mode=DELETE;
PRAGMA synchronous=FULL;
PRAGMA foreign_keys=1;
PRAGMA busy_timeout=5000;

CREATE TABLE users (
    id INTEGER PRIMARY KEY NOT NULL,
    created INTEGER NOT NULL,
    email TEXT NOT NULL,
    active INTEGER NOT NULL);
CREATE INDEX users_created ON users(created);

CREATE TABLE articles (
    id INTEGER PRIMARY KEY NOT NULL,
    created INTEGER NOT NULL,  
    userId INTEGER NOT NULL REFERENCES users(id),
    text TEXT NOT NULL);
CREATE INDEX articles_created ON articles(created);
CREATE INDEX articles_userId ON articles(userId);

CREATE TABLE comments (
    id INTEGER PRIMARY KEY NOT NULL,
    created INTEGER NOT NULL,
    articleId INTEGER NOT NULL REFERENCES articles(id),
    text TEXT NOT NULL);
CREATE INDEX comments_created ON comments(created);
CREATE INDEX comments_articleId ON comments(articleId);"><pre><code>PRAGMA journal_mode=DELETE;
PRAGMA synchronous=FULL;
PRAGMA foreign_keys=1;
PRAGMA busy_timeout=5000;

CREATE TABLE users (
    id INTEGER PRIMARY KEY NOT NULL,
    created INTEGER NOT NULL,
    email TEXT NOT NULL,
    active INTEGER NOT NULL);
CREATE INDEX users_created ON users(created);

CREATE TABLE articles (
    id INTEGER PRIMARY KEY NOT NULL,
    created INTEGER NOT NULL,  
    userId INTEGER NOT NULL REFERENCES users(id),
    text TEXT NOT NULL);
CREATE INDEX articles_created ON articles(created);
CREATE INDEX articles_userId ON articles(userId);

CREATE TABLE comments (
    id INTEGER PRIMARY KEY NOT NULL,
    created INTEGER NOT NULL,
    articleId INTEGER NOT NULL REFERENCES articles(id),
    text TEXT NOT NULL);
CREATE INDEX comments_created ON comments(created);
CREATE INDEX comments_articleId ON comments(articleId);
</code></pre></div>
<h2 tabindex="-1" dir="auto"><a id="user-content-benchmarks" aria-hidden="true" tabindex="-1" href="#benchmarks"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Benchmarks</h2>
<p dir="auto">Result times are measured in milliseconds. Lower numbers indicate better
performance.</p>
<h3 tabindex="-1" dir="auto"><a id="user-content-simple" aria-hidden="true" tabindex="-1" href="#simple"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Simple</h3>
<p dir="auto">Insert 1 million user rows in one database transaction.
Then query all users once.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://blog.paulbiggar.com/ncruces/go-sqlite-bench/blob/master/results/simple.svg"><img src="https://blog.paulbiggar.com/ncruces/go-sqlite-bench/raw/master/results/simple.svg" alt=""/></a></p>
<div data-snippet-clipboard-copy-content="                  insert        query
-------------------------------------
craw             1622 ms       908 ms
mattn            2035 ms      1851 ms
modernc          7218 ms      1851 ms
ncruces          4706 ms      1959 ms
sqinn            1337 ms       927 ms
zombie           2623 ms       584 ms"><pre><code>                  insert        query
-------------------------------------
craw             1622 ms       908 ms
mattn            2035 ms      1851 ms
modernc          7218 ms      1851 ms
ncruces          4706 ms      1959 ms
sqinn            1337 ms       927 ms
zombie           2623 ms       584 ms
</code></pre></div>
<h3 tabindex="-1" dir="auto"><a id="user-content-complex" aria-hidden="true" tabindex="-1" href="#complex"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Complex</h3>
<p dir="auto">Insert 200 users in one database transaction.
Then insert 20000 articles (100 articles for each user) in another transaction.
Then insert 400000 comments (20 comments for each article) in another transaction.
Then query all users, articles and comments in one big JOIN statement.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://blog.paulbiggar.com/ncruces/go-sqlite-bench/blob/master/results/complex.svg"><img src="https://blog.paulbiggar.com/ncruces/go-sqlite-bench/raw/master/results/complex.svg" alt=""/></a></p>
<div data-snippet-clipboard-copy-content="                   insert       query
-------------------------------------
craw              1011 ms      972 ms
mattn             1231 ms     2047 ms
modernc           4414 ms     2290 ms
ncruces           2985 ms     2577 ms
sqinn              911 ms     1068 ms
zombie            2187 ms      858 ms"><pre><code>                   insert       query
-------------------------------------
craw              1011 ms      972 ms
mattn             1231 ms     2047 ms
modernc           4414 ms     2290 ms
ncruces           2985 ms     2577 ms
sqinn              911 ms     1068 ms
zombie            2187 ms      858 ms
</code></pre></div>
<h3 tabindex="-1" dir="auto"><a id="user-content-many" aria-hidden="true" tabindex="-1" href="#many"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Many</h3>
<p dir="auto">Insert N users in one database transaction.
Then query all users 1000 times.
This benchmark is used to simluate a read-heavy use case.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://blog.paulbiggar.com/ncruces/go-sqlite-bench/blob/master/results/many.svg"><img src="https://blog.paulbiggar.com/ncruces/go-sqlite-bench/raw/master/results/many.svg" alt=""/></a></p>
<div data-snippet-clipboard-copy-content="        query/N=10  query/N=100  query/N=1000
--------------------------------------------------------
craw         58 ms       168 ms       1282 ms
mattn        52 ms       165 ms       2003 ms
modernc      58 ms       186 ms       2335 ms
ncruces      73 ms       375 ms       2665 ms
sqinn       112 ms       331 ms       3071 ms
zombie       34 ms        58 ms        646 ms"><pre><code>        query/N=10  query/N=100  query/N=1000
--------------------------------------------------------
craw         58 ms       168 ms       1282 ms
mattn        52 ms       165 ms       2003 ms
modernc      58 ms       186 ms       2335 ms
ncruces      73 ms       375 ms       2665 ms
sqinn       112 ms       331 ms       3071 ms
zombie       34 ms        58 ms        646 ms
</code></pre></div>
<h3 tabindex="-1" dir="auto"><a id="user-content-large" aria-hidden="true" tabindex="-1" href="#large"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Large</h3>
<p dir="auto">Insert 10000 users with N bytes of row content.
Then query all users.
This benchmark is used to simluate reading of large (gigabytes) databases.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://blog.paulbiggar.com/ncruces/go-sqlite-bench/blob/master/results/large.svg"><img src="https://blog.paulbiggar.com/ncruces/go-sqlite-bench/raw/master/results/large.svg" alt=""/></a></p>
<div data-snippet-clipboard-copy-content="      query/N=50000  query/N=100000  query/N=200000
---------------------------------------------------
craw         429 ms          784 ms         1639 ms
mattn        308 ms          624 ms         1098 ms
modernc      599 ms         1054 ms         1983 ms
ncruces      395 ms          678 ms         1271 ms
sqinn       1269 ms         2553 ms         5707 ms
zombie      1064 ms         2057 ms         4115 ms"><pre><code>      query/N=50000  query/N=100000  query/N=200000
---------------------------------------------------
craw         429 ms          784 ms         1639 ms
mattn        308 ms          624 ms         1098 ms
modernc      599 ms         1054 ms         1983 ms
ncruces      395 ms          678 ms         1271 ms
sqinn       1269 ms         2553 ms         5707 ms
zombie      1064 ms         2057 ms         4115 ms
</code></pre></div>
<h3 tabindex="-1" dir="auto"><a id="user-content-concurrent" aria-hidden="true" tabindex="-1" href="#concurrent"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Concurrent</h3>
<p dir="auto">Insert one million users.
Then have N goroutines query all users.
This benchmark is used to simulate concurrent reads.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://blog.paulbiggar.com/ncruces/go-sqlite-bench/blob/master/results/concurrent.svg"><img src="https://blog.paulbiggar.com/ncruces/go-sqlite-bench/raw/master/results/concurrent.svg" alt=""/></a></p>
<div data-snippet-clipboard-copy-content="        query/N=2  query/N=4  query/N=8
---------------------------------------
craw       796 ms    1145 ms    1553 ms
mattn     1782 ms    2019 ms    2642 ms
modernc   3554 ms   10789 ms   39959 ms
ncruces   2075 ms    2321 ms    3203 ms
sqinn      910 ms    1327 ms    1965 ms
zombie     509 ms     777 ms    1054 ms"><pre><code>        query/N=2  query/N=4  query/N=8
---------------------------------------
craw       796 ms    1145 ms    1553 ms
mattn     1782 ms    2019 ms    2642 ms
modernc   3554 ms   10789 ms   39959 ms
ncruces   2075 ms    2321 ms    3203 ms
sqinn      910 ms    1327 ms    1965 ms
zombie     509 ms     777 ms    1054 ms
</code></pre></div>
<h2 tabindex="-1" dir="auto"><a id="user-content-summary" aria-hidden="true" tabindex="-1" href="#summary"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Summary</h2>
<ul dir="auto">
<li>We cannot declare a winner, it all depends on the use case.</li>
<li>Crawshaw and Zombiezen are pretty fast.</li>
<li>Mattn, although the de-facto standard, is not the best overall solution.</li>
<li>SQLite without CGO is possible.</li>
</ul>
<p dir="auto">This work is sponsored by Monibot - Easy Server and Application Monitoring.
Try out Monibot at <a href="https://monibot.io?ref=go-sqlite-bench" rel="nofollow">https://monibot.io</a>.
It&#39;s free.</p>
</article>
          </div></div>
  </body>
</html>
