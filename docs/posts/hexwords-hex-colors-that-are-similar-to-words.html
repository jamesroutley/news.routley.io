<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://hexwords.netlify.app/">Original</a>
    <h1>Hexwords: Hex colors that are similar to words</h1>
    
    <div id="readability-page-1" class="page"><div><p>This guide will show you how to generate and view XHProf reports of your WordPress Site.</p>
<p>This is useful so you can drill-down and see exactly how many microseconds each of your scripts and functions (themes &amp; plugins) are running when generating a page -- slowing down your website visitors&#39; page load speed.</p>

<p><a href="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/wordpress_xhprof_featuredImage.jpg"><img src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress_xhprof_featuredImage.jpg.pagespeed.ic.RFs0GiHUmK.jpg" alt="Debugging &amp; Optimizing WordPress Speed with XHProf" width="1200" height="628" srcset="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress_xhprof_featuredImage.jpg.pagespeed.ic.RFs0GiHUmK.jpg 1200w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress_xhprof_featuredImage-300x157.jpg.pagespeed.ic.UPGYm_nrtg.jpg 300w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress_xhprof_featuredImage-1024x536.jpg.pagespeed.ic.7zXr-TM1XV.jpg 1024w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress_xhprof_featuredImage-768x402.jpg.pagespeed.ic.4Jfs_ZAcT5.jpg 768w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress_xhprof_featuredImage-150x79.jpg.pagespeed.ic.yzzpyHOZvS.jpg 150w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress_xhprof_featuredImage-400x209.jpg.pagespeed.ic.2xyjovP7cZ.jpg 400w" sizes="(max-width: 1200px) 100vw, 1200px"/></a></p>

<p>Profiling is a critical tool for debugging the performance of your web application in production.</p>
<p>XHProf was originally developed by Facebook to profile (and optimize) their PHP web application (facebook.com). It was <a href="https://code-dev.fb.com/2009/04/02/production-engineering/xhproflive-continuous-function-level-performance-stats-from-production/">open-sourced in 2009</a>.</p>
<p>Facebook no longer maintains XHProf, and as development continued past PHP7, the XHProf code rot lead to a number of XHProf forks, including:</p>
<ul>
<li><a href="https://github.com/phacility/xhprof">https://github.com/phacility/xhprof</a></li>
<ul>
<li><a href="https://github.com/phacility/xhprof/tree/experimental">(fork with experimental PHP7 support)</a></li>
</ul>
<li><a href="https://github.com/preinheimer/xhprof">https://github.com/preinheimer/xhprof</a></li>
<li><a href="https://github.com/patrickallaert/xhprof">https://github.com/patrickallaert/xhprof</a></li>
<li><a href="https://github.com/longxinH/xhprof">https://github.com/longxinH/xhprof</a></li>
<li><a href="https://github.com/tideways/php-xhprof-extension">https://github.com/tideways/php-xhprof-extension</a></li>
</ul>
<p>In this guide, we will be using the <a href="https://tideways.com/profiler/xhprof-for-php7">XHProf fork maintained by Tideways</a> -- as it is available in the Debian repos and therefore can be securely downloaded &amp; installed without downloading &amp; compiling code from the Internet.</p>

<h2>Versions</h2>
<p>This guide was written in June 2022, and it uses the following software and versions:</p>
<ol>
<li>Debian 11 (bullseye)</li>
<li>Apache 2.4</li>
<li>WordPress 5.9.3</li>
<li>php-tideways v5.0.4-2</li>
<li>longxinH/xhprof v2.3.5</li>
</ol>
<p>If you&#39;re using a different OS, web server, wordpress, or xhprof versions, then adaptations to the below commands &amp; files may be necessary.</p>
<h2>WordPress Document Root</h2>
<p>This guide assumes that your wordpress document root is located at the following directory</p>
<blockquote><p>
/var/www/html/wordpress/htdocs/
</p></blockquote>
<p>If your wordpress install is located in a distinct directory, then adaptations to the below commands will be necessary.</p>
<h2>xhprof-html Document Root</h2>
<p>This guide assumes that you will install a new `<code>xhprof-html</code>` vhost with a document root at the following directory</p>
<blockquote><p>
/var/www/html/xhprof/htdocs/
</p></blockquote>
<p>If you&#39;d like to keep your web server&#39;s document roots organized in a distinct path, then adaptations to the below commands will be necessary.</p>
<h2>XHProf File Storage Dir</h2>
<p>This guide assumes that you will be writing your `<code>.xhprof</code>` files to the following directory:</p>
<blockquote><p>
/var/www/html/wordpress/xhprof/
</p></blockquote>
<p>If you&#39;d like to store your `<code>.xhprof</code>` files in a distinct path, then adaptations to the below commands will be necessary.</p>

<p>Most XHProf guides on the &#39;net tell you to clone some random git repo and then (without doing any cryptographic authenticity nor integrity checks), proceed to compile binaries on your machine, then run `<code>make install</code>` as root.</p>
<p>There are numerous <a href="https://github.com/chainguard-dev/ssc-reading-list">supply chain</a> risks in <a href="https://github.com/cncf/tag-security/tree/main/supply-chain-security/compromises">blindly trusting public publishing infrastructure</a> like that.</p>
<p>As such, the fork of XHProf that we choose to use for this guide is the only one that can be securely downloaded from the Debian repos using apt: `<code>php-tideways</code>`</p>
<h2>Install Debian Packages</h2>
<p>Of course, you should already have a functioning apache2 web server installed with php modules installed &amp; enabled</p>
<pre title="">sudo apt-get install apache2 libapache2-mod-php php-common
</pre>
<p>And to install the `<code>php-tideways</code>` extension, run</p>
<pre title="">sudo apt-get install php-tideways
</pre>
<p>The above <code>php-tideways</code> package should have:</p>
<ol>
<li>installed the <code>tideways_xhprof.so</code> module on your system and
</li><li>added the <code>tideways.ini</code> file to be dynamically added to your main PHP <code>php.ini</code> config file</li>
</ol>
<p>For a list of files added to your system by installing the `<code>php-tideways</code>` module, run</p>
<pre title="">sudo dpkg-query -L php-tideways
</pre>
<p>Finally, restart apache to apply the config changes</p>
<pre title="">sudo systemctl restart apache2
</pre>
<p>You can also confirm in the CLI that the tideways module is enabled in PHP with the following command:</p>
<pre title="">root@host:~# php -m | grep -i tideways
tideways_xhprof
root@host:~# 
</pre>
<h2>Configuring WordPress to use XHProf</h2>
<p>XHProf is a tool for profiling PHP Applications <em>generally</em>. As such, the <a href="https://www.php.net/manual/en/xhprof.examples.php">official PHP documentation</a> describing how to use XHProf usually says something like this:</p>
<pre title="">&lt;?php
tideways_xhprof_enable();

my_app()

$data = tideways_xhprof_disable();
file_put_contents( &#39;my_app.xhprof&#39;, serialize($data) );
</pre>
<p>So, basically:</p>
<ol>
<li>You need to enable XHProf with `<code>tideways_xhprof_enable()</code>` at the <em>start</em> of your page load,</li>
<li>You need to disable XHProf with `<code>tideways_xhprof_disable()</code>` (and collect its output) at the <em>end</em> of your page load, and</li>
<li>You need to write the output from the `<code>tideways_xhprof_disable()</code>` function above to a file somewhere (for later analysis)</li>
</ol>
<p>...but what does that mean for a wordpress site?</p>
<p>Well, one solution is to integrate it into your theme&#39;s `<code>header.php</code>` and `<code>footer.php</code>` files.</p>
<p>But <strong>better than `<code>header.php</code>` is to put it at the end of your <a href="https://developer.wordpress.org/apis/wp-config-php/">wp-config.php</a> file</strong> -- just before the `<code>require()</code>` for `<code>wp-settings.php</code>`.</p>
<p>And <strong>better than `<code>footer.php</code>` is to use PHP&#39;s <a href="https://www.php.net/manual/en/function.register-shutdown-function.php">register_shutdown_function()</a></strong> to disable XHProf and save our results to the `<code>.xhprof</code>` file.</p>
<h3 id="profile-on-demand">Profile only on-demand</h3>
<p>Modify your `<code>wp-config.php</code>` file so that it looks like this at the bottom:</p>
<pre title="">/* That&#39;s all, stop editing! Happy publishing. */

/** Absolute path to the WordPress directory. */
if ( ! defined( &#39;ABSPATH&#39; ) ) {
	define( &#39;ABSPATH&#39;, __DIR__ . &#39;/&#39; );
}

# PHP profiling with tideways-xhprof 
#  * https://tech.michaelaltfield.net/wordpress-xhprof/
if ( isset( $_GET[&#39;profile&#39;] ) &amp;&amp; $_GET[&#39;profile&#39;] === &#39;secret-string&#39; ) {
   tideways_xhprof_enable( TIDEWAYS_FLAGS_MEMORY + TIDEWAYS_FLAGS_CPU );
   register_shutdown_function( function() {
      $results = tideways_xhprof_disable();
      include_once( &#39;/var/www/html/xhprof/htdocs/xhprof_lib/utils/xhprof_runs.php&#39; );
      $XHProfRuns = new XHProfRuns_Default( &#39;/var/www/html/wordpress/xhprof/&#39; );
      $XHProfRuns-&gt;save_run( $results, date(&#39;Y-m-d\TH:i:s\Z&#39;, time() - date(&#39;Z&#39;)) );
   });
}

/** Sets up WordPress vars and included files. */
require_once ABSPATH . &#39;wp-settings.php&#39;;
</pre>
<p>The above code block will check to see if a GET variable named `<code>profile</code>` was defined and if it was set to `<code>secret-string</code>`. For example, if your wordpress website is available at <code>https://wordpress.example.com/</code>, then loading the following page will trigger XHProf to run and generate a timestamped `<code>.xhprof</code>` file in `<code>/var/www/html/wordpress/xhprof/</code>`</p>
<ul>
<li><a href="https://wordpress.example.com/?profile=secret-string">https://wordpress.example.com/?profile=secret-string</a></li>
</ul>
<p>Note that running XHProf does add some performance penalty. Depending on your options, it could slow your site down 4% - <a href="https://techblog.wikimedia.org/2021/03/03/profiling-php-in-production-at-scale/#fnr1">200%</a>.</p>
<blockquote><p>
⚠ WARNING: To prevent <a href="https://en.wikipedia.org/wiki/Alice_and_Bob#Mallory">Mallory</a> from launching a DDoS attack on your website, you should probably change `<code>secret-string</code>`  above to some unique passphrase that only you know 🙂
</p></blockquote>
<h3>Profile every 1,000 requests</h3>
<p>Alternatively, you can capture a random 1 out if every 1,000 requests to your wordpress site by adding something like this to the bottom of your `<code>wp-config.php</code>` file</p>
<pre title="">/* That&#39;s all, stop editing! Happy publishing. */

/** Absolute path to the WordPress directory. */
if ( ! defined( &#39;ABSPATH&#39; ) ) {
	define( &#39;ABSPATH&#39;, __DIR__ . &#39;/&#39; );
}

# PHP profiling with tideways-xhprof 
#  * https://tech.michaelaltfield.net/wordpress-xhprof/
if ( rand( 1, 1000 ) === 1 ) {
   tideways_xhprof_enable( TIDEWAYS_FLAGS_MEMORY + TIDEWAYS_FLAGS_CPU );
   register_shutdown_function( function() {
      $results = tideways_xhprof_disable();
      include_once( &#39;/var/www/html/xhprof/htdocs/xhprof_lib/utils/xhprof_runs.php&#39; );
      $XHProfRuns = new XHProfRuns_Default( &#39;/var/www/html/wordpress/xhprof/&#39; );
      $XHProfRuns-&gt;save_run( $results, date(&#39;Y-m-d\TH:i:s\Z&#39;, time() - date(&#39;Z&#39;)) );
   });
}

/** Sets up WordPress vars and included files. */
require_once ABSPATH . &#39;wp-settings.php&#39;;
</pre>
<p>Just make sure to periodically clean-out your XHProf File Storage Dir, as it will grow over time 🙂</p>
<h3>XHProf File Storage Dir</h3>
<p>Of course, we need to create the XHProf Storage Directory.</p>
<p>By default, XHProf generally likes to store your `<code>.xhprof</code>` files to the PHP `<code>sys_temp_dir</code>`, which is often system-wide readable &amp; writable. That&#39;s not very secure, so we should specify a more locked-down path.</p>
<p>We create the XHProf File Storage dir inside the wordpress vhost dir (but outside the document root). Make sure your web server has read/write access to this directory.</p>
<pre title="">sudo mkdir -p /var/www/html/wordpress/xhprof/
sudo chown root:www-data /var/www/html/wordpress/xhprof/
sudo chmod 0770 /var/www/html/wordpress/xhprof/
</pre>
<h2>xhprof_lib &amp; xhprof_html</h2>
<p>Simply installing `<code>php-tideways</code>` and updating your `<code>wp-config.php</code>` file with the code block above is not enough. We still need:</p>
<ol>
<li>To install the `<code>xhprof_lib</code>` dir (note the `<code>include_once()</code>` above)</li>
<li>To install the <code>xhprof_html</code>` dir to actually visualize and understand the `<code>.xhprof</code>` files (else you&#39;ll just have to read an enormous array dumped to a file in plaintext)</li>
</ol>
<h3>xhprof_html</h3>
<p>There&#39;s a lot of fancy SaaS tools for capturing and visualizing web application profiling data at scale in the cloud. This guide doesn&#39;t cover such solutions. What we use is `<code>xhprof_html</code>` -- which is sometimes referred to as the &#34;poor man&#39;s XHProf GUI&#34;</p>
<p>The original (no longer maintained) <a href="https://github.com/phacility/xhprof">Facebook xhprof repo</a> included a simple tool to drill-down and visualize the xhprof results saved to `<code>.xhprof</code>` files. It&#39;s located in a directory called `<code>xhprof_html</code>`</p>
<p>Curiously, The tideways repo itself (forked from the original repo) does not include the `<code>xhprof_html</code>` directory (possibly because tideways is one of these businesses that sells xhprof visualization SaaS). Rather, the tideways website actually links you to the original Facebook repo to obtain the `<code>xhprof_lib</code>` &amp; `<code>xhprof_html</code>` directories.</p>
<blockquote><p>
[tideways] stores the trace in your temporary directory which the <a href="https://github.com/phacility/xhprof">default UI</a> uses to look for data. Install the <code>xhprof_lib</code> and <code>xhprof_html</code> directories from this repository into your webfolder and navigate to <code>xhprof_html/index.php</code> to see a list of trace.</p>
<p>(<a href="https://tideways.com/profiler/xhprof-for-php7">source</a>)
</p></blockquote>
<h3>xhprof_lib</h3>
<p>I&#39;ve <a href="https://pressjitsu.com/blog/profiling-wordpress-performance/">read</a> that the `<code>.xhprof</code>` file format is basically just the serialized output of the `<code>xhprof_disable()</code>`, but I had <a href="https://stackoverflow.com/questions/72393257/xhprof-html-wont-show-run-report-no-xhprof-runs-specified-in-the-url">issues</a> getting `<code>xhprof_html/index.php</code>` to read my `<code>.xhprof</code>` files written this way.</p>
<pre title=""># this won&#39;t work
#  * https://stackoverflow.com/questions/72393257/xhprof-html-wont-show-run-report-no-xhprof-runs-specified-in-the-url
$results = tideways_xhprof_disable();
file_put_contents( &#39;/var/www/html/wordpress/xhprof/&#39; .date(&#39;Y-m-d\TH:i:s\Z&#39;, time() - date(&#39;Z&#39;)). &#39;.xhprof&#39; , serialize( $results ) );
</pre>
<p>Instead, I found that I needed to write the files using the `<code>XHProfRuns_Default()</code>`&#39;s `<code>save_run()</code>` method.</p>
<pre title=""># this will work
$results = tideways_xhprof_disable();
include_once( &#39;/var/www/html/xhprof/htdocs/xhprof_lib/utils/xhprof_runs.php&#39; );
$XHProfRuns = new XHProfRuns_Default( &#39;/var/www/html/wordpress/xhprof/&#39; );
$XHProfRuns-&gt;save_run( $results, date(&#39;Y-m-d\TH:i:s\Z&#39;, time() - date(&#39;Z&#39;)) );
</pre>
<p>As the `<code>XHProfRuns_Default()</code>` object is defined in `<code>xhprof_lib/utils/xhprof_runs.php&#39;</code> file, this is why we need the `<code>xhprof_lib/</code>` dir.</p>
<h3>vhost</h3>
<p>Both `<code>xhprof_lib</code>` &amp; <code>xhprof_html</code>` are available together in the same repo. Here we use the `<code>longxinH</code>` fork because it seems to be the most maintained fork of xhprof at the time of writing.</p>
<ul>
<li><a href="https://github.com/longxinH/xhprof">https://github.com/longxinH/xhprof</a></li>
</ul>
<p>First, we create a new web server document root for the vhost.</p>
<pre title="">sudo mkdir -p /var/www/html/xhprof/htdocs/
</pre>
<p>Now we checkout the <code>xhprof</code> git repo into this directory</p>
<pre title="">cd /var/www/html/xhprof/htdocs/ 
sudo git clone https://github.com/longxinH/xhprof.git .
</pre>
<p>By default, `<code>xhprof_lib</code>` will write your `<code>.xhprof</code>` files to the PHP `<code>sys_temp_dir</code>`, which is often system-wide readable &amp; writable. That&#39;s not very secure, so we should specify a more locked-down path.</p>
<p>You can <a href="https://github.com/phacility/xhprof/blob/0bbf2a2ac34f495e42aa852293fe0ed821659047/xhprof_lib/utils/xhprof_runs.php#L100-L104">specify the directory location for XHProf runs</a> in at least two places:</p>
<ol>
<li>As `<code>xhprof.output_dir</code>` in your `<code>php.ini</code>` file or</li>
<li>As the first argument to the `<code>XHProfRuns_Default()</code>` constructor</li>
</ol>
<p>We choose the latter, so make a backup of your `<code>xhprof_html/index.php</code>` file, and edit it so that `<code>new XHProfRuns_Default()</code>` becomes `<code>new XHProfRuns_Default(&#39;/var/www/html/wordpress/xhprof/&#39;)</code>`</p>
<pre title="">root@host:/var/www/html/xhprof/htdocs/# sudo cp xhprof_html/index.php xhprof_html/index.orig.php
root@host:/var/www/html/xhprof/htdocs/# sudo vim xhprof_html/index.php
root@host:/var/www/html/xhprof/htdocs/# 

root@host:/var/www/html/xhprof/htdocs/# diff index.orig.php index.php 
83c83
&lt; $xhprof_runs_impl = new XHProfRuns_Default();
---
&gt; $xhprof_runs_impl = new XHProfRuns_Default( &#39;/var/www/html/wordpress/xhprof/&#39; );
root@host:/var/www/html/xhprof/xhprof-html#
</pre>
<p>Before we create the vhost (so apache actually serves the `<code>/var/www/html/xhprof/htdocs</code>` docroot), let&#39;s create an `<code>htpasswd</code>` file (in the xhprof vhost dir but <strong>outside the document root</strong>) so that we can use it to password-protect the xhprof vhost (so it&#39;s not available to everyone on the internet unless they have the username &amp; password)</p>
<p>Run this command to add a user `<code>xhprof-admin</code>`. Type your passphrase at the prompt.</p>
<pre title="">sudo htpasswd -Bc /var/www/html/xhprof/.htpasswd xhprof-admin
</pre>
<p>Now, let&#39;s harden the permissions of these web server files</p>
<pre title="">sudo chown -R root:www-data &#34;/var/www/html/xhprof/&#34;
sudo find &#34;/var/www/html/xhprof/&#34; -type d -exec chmod 0050 {} \;
sudo find &#34;/var/www/html/xhprof/&#34; -type f -exec chmod 0040 {} \;
</pre>
<p>Finally, we add the apache vhost file.</p>
<pre title="">

sudo bash -c &#39;cat &lt;&lt; EOF &gt; /etc/apache2/sites-available/xhprof.conf
&lt;VirtualHost 127.0.0.1:443&gt;

   ServerName xhprof.example.com
   DocumentRoot &#34;/var/www/html/xhprof/htdocs&#34;

   # block dot (hidden) files
   &lt;LocationMatch &#34;/\.(?!well\-known)&#34;&gt;
      Require all denied
   &lt;/LocationMatch&gt;

   # block config files
   &lt;LocationMatch &#34;config.php&#34;&gt;
      Require all denied
   &lt;/LocationMatch&gt;

   &lt;Directory &#34;/var/www/html/xhprof/htdocs&#34;&gt;
      AuthType Basic
      AuthName &#34;Protected&#34;
      AuthUserFile /var/www/html/xhprof/.htpasswd
      Require valid-user

      # Harden vhost docroot by blocking all request types except the 3 essentials
      # Note: The debian wiki actually says not to use this since it can result in
      #       disabling auth modules, so be careful
      #        * https://wiki.debian.org/Apache/Hardening
      &lt;LimitExcept GET POST HEAD&gt;
         Require all denied
      &lt;/LimitExcept&gt;

      Options -Indexes -Includes
      AllowOverride None
   &lt;/Directory&gt;

&lt;/VirtualHost&gt;
EOF&#39;

sudo ln -s /etc/apache2/sites-available/xhprof.conf /etc/apache2/sites-enabled/xhprof.conf

sudo vim /etc/apache2/sites-available/xhprof.conf
</pre>
<p>Be sure to change:</p>
<ol>
<li>`<code>example.com</code>` to your domain</li>
<li>`<code>127.0.0.1</code>` to your server&#39;s IP address (if you want to serve it publicly)</li>
<li>Add lines for your TLS cert for https, which is outside the scope of this article</li>
</ol>
<p>Test the sanity of your apache config and restart the `<code>apache2</code>` service</p>
<pre title="">sudo apachectl configtest &amp;&amp; sudo systemctl restart apache2
</pre>

<p>You should now be able to generate `<code>.xhprof</code>` files!</p>
<p>If you added the <em>first</em> code block <a href="#profile-on-demand">above</a> to your `<code>wp-config.php</code>` file, then just access your site and set the `<code>profile</code>` GET variable to your `<code>secret-string</code>`.</p>
<ul>
<li><a href="https://wordpress.example.com/?profile=secret-string">https://wordpress.example.com/?profile=secret-string</a></li>
</ul>
<p>Your wordpress site will load like normal, but it will spit-out a timestamped `<code>.xhprof</code>` file to your XHProf Storage Directory.</p>
<pre title="">root@host:/var/www/html# du -sh /var/www/html/wordpress/xhprof/*
1,8M    wordpress/xhprof/62906fb2c49b4.2022-05-27T06:29:06Z.xhprof
root@host:/var/www/html# 
</pre>

<p>You should now be able to view your `<code>.xhprof</code>` files using your xhprof vhost (password protected username = `<code>xhprof-admin</code>` and the password you typed into `<code>htpasswd</code>` above).</p>
<ul>
<li><a href="https://xhprof.example.com/xhprof_html/index.php">https://xhprof.example.com/xhprof_html/index.php</a></li>
</ul>
<p>After authenticating in the above page, you should be prompted with a list of `<code>.xhprof</code>` files.</p>
<p>If you click on a given report, then it will show you the list of all the functions that were called to generate the page. By default, they&#39;re sorted by the wall time that the function call ran in microseconds (1,000,000 microseconds = 1 second)</p>
<p>In this example, we see that the wordpress `<code>main()</code>` function&#39;s wall clock runtime was 1,498,090 microseconds = 1.5 seconds.</p>
<div>
<div id="attachment_2658"><p><a href="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/wordpress-xhprof_list.png"><img aria-describedby="caption-attachment-2658" src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/400xNxwordpress-xhprof_list.png.pagespeed.ic.JpoqO4xOTR.png" alt="Screenshot shows a list of XHProf runs" width="400" srcset="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress-xhprof_list.png.pagespeed.ic.arLkEftNDj.png 640w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress-xhprof_list-300x185.png.pagespeed.ic.uRA6PIiVlH.png 300w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress-xhprof_list-150x93.png.pagespeed.ic.aS8qv7lF-t.png 150w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress-xhprof_list-400x247.png.pagespeed.ic.9zvX40RUZG.png 400w" sizes="(max-width: 640px) 100vw, 640px"/></a></p><p id="caption-attachment-2658">The XHProf vhost shows the list of XHProf runs. Clicking on a run will show you the report.</p></div>
<div id="attachment_2659"><p><a href="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/wordpress-xhprof_report.png"><img aria-describedby="caption-attachment-2659" src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/400xNxwordpress-xhprof_report.png.pagespeed.ic.s6jGxBgkcn.png" alt="Screenshot shows the top of an XHProf report" width="400" srcset="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress-xhprof_report.png.pagespeed.ic.5j-0ZGYMhA.png 1000w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress-xhprof_report-300x236.png.pagespeed.ic.mqAQr0yY-Z.jpg 300w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress-xhprof_report-768x603.png.pagespeed.ic.symJRcvrGk.png 768w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress-xhprof_report-150x118.png.pagespeed.ic.m3mRFy8oe-.jpg 150w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress-xhprof_report-400x314.png.pagespeed.ic.Yu1jEUN-9Q.png 400w" sizes="(max-width: 1000px) 100vw, 1000px"/></a></p><p id="caption-attachment-2659">List of functions and their run time (in microseconds)</p></div>

<p>Once you know which functions are slow, you can drill-down into them and begin debugging to see what are your webpage generation bottlenecks.</p>
<p><a href="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/wordpress-xhprof_report-full.png"><img loading="lazy" src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress-xhprof_report-full.png.pagespeed.ic.6d2Nnxr-zS.jpg" alt="Screenshot shows the whole first page of the xhprof report" width="526" height="1493" srcset="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress-xhprof_report-full.png.pagespeed.ic.6d2Nnxr-zS.jpg 526w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress-xhprof_report-full-106x300.png.pagespeed.ic.cbpfoF6Y1M.jpg 106w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress-xhprof_report-full-361x1024.png.pagespeed.ic.wV6i6qyEM1.jpg 361w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress-xhprof_report-full-53x150.png.pagespeed.ic.OjNEwm5ySl.jpg 53w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xwordpress-xhprof_report-full-400x1135.png.pagespeed.ic.CDk7NiJKgR.jpg 400w" sizes="(max-width: 526px) 100vw, 526px"/></a></p>
</div>

<ul>
<li><a href="https://www.php.net/manual/en/book.xhprof.php">Official PHP Documentation on Xhprof</a></li>
<li><a href="https://www.jeffgeerling.com/blog/2017/profiling-drupal-8-sites-drupal-vm-xhprof-and-tideways">Profiling Drupal with XHProf</a></li>
<li><a href="https://github.com/preinheimer/xhprof/">XHGUI</a> - scaleable alternative to xhprof_html</li>
<li><a href="https://techblog.wikimedia.org/2021/03/03/profiling-php-in-production-at-scale/">excimer</a> - An XHProf alternative used by Wikipedia</li>
<li><a href="https://varnish-cache.org/">Varnish Cache</a> - a critically important tool to optimize wordpress page loads</li>
</ul>
<blockquote>
<h2>Struggling to follow this guide?</h2>
<p>If your organization has a wordpress site that&#39;s running slow, and you can&#39;t figure out why, please <a href="https://email.michaelaltfield.net">contact me</a> about your project.</p>
<p>I can provide support for an hourly fee.
</p></blockquote>
<div itemtype="http://schema.org/Person" itemscope="" itemprop="author"><div><p><img src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/2019/04/100x100xavatar_square_150.jpg.pagespeed.ic.lvLST4AWRQ.jpg" width="100" height="100" alt="headshot of Michael Altfield" itemprop="image"/></p><div><div itemprop="description"><p>Hi, I’m Michael Altfield. I write articles about opsec, privacy, and devops <a href="https://michaelaltfield.net/biography/">➡</a></p>
<p><a href="https://michaelaltfield.net/biography/">About Michael</a></p>
</div></div></div></div></div></div>
  </body>
</html>
