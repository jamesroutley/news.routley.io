<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.karltarvas.com/2020/10/25/macos-app-sandboxing-via-sandbox-exec.html">Original</a>
    <h1>macOS: App sandboxing via sandbox-exec (2020)</h1>
    
    <div id="readability-page-1" class="page"><div aria-label="Content">
        <article>
    
    <time>25th October 2020</time>
    <p>It isn’t widely advertised, but macOS ships with a standalone sandboxing utility out of the box: <code>sandbox-exec</code>. While the very short manpage says the utility has been marked deprecated, and for quite a few major releases now, it’s used heavily by internal systems so it’s unlikely go away anytime soon.</p>

<p>Sandbox configurations are writen in a subset of Scheme. A minimal useful starter example for wrapping a modern application might look something like this:</p>

<div><div><pre><code><span>(</span><span>version</span> <span>1</span><span>)</span>
<span>;; Disallow everything by default</span>
<span>(</span><span>deny</span> <span>default</span><span>)</span>

<span>;;</span>
<span>;; This system profile grants access to a number of things, such as:</span>
<span>;;</span>
<span>;;  - locale info</span>
<span>;;  - system libraries (/System/Library, /usr/lib, etc)</span>
<span>;;  - access to to basic tools (/etc, /dev/urandom, etc)</span>
<span>;;  - Apple services (com.apple.system, com.apple.dyld, etc)</span>
<span>;;</span>
<span>;; and more, see bsd.sb and system.sb in the corresponding directory.</span>
<span>;;</span>
<span>(</span><span>import</span> <span>&#34;/System/Library/Sandbox/Profiles/bsd.sb&#34;</span><span>)</span>
</code></pre></div></div>

<p>Saving the above as <code>config.sb</code>, you can use it to sandbox an app as follows:</p>

<div><div><pre><code><span>$ </span>sandbox-exec <span>-f</span> config.sb /Applications/Foo.app/Contents/MacOS/Foo
</code></pre></div></div>

<p>To see all the operations that were denied, open Applications → Utilities → Console and search for <code>sandbox</code> and the application name. Historically, you could use the <code>(trace &#34;output&#34;)</code> command, but this seems dysfunctional on the latest macOS.</p>

<p>Most modern applications will not function with such limited permissions, so expect some back and forth before your sandbox profile works.</p>

<p>Depending on your OS version, you can find some system sandbox examples in some of the following locations:</p>
<ul>
  <li><code>/Library/Sandbox/Profiles</code></li>
  <li><code>/System/Library/Sandbox/Profiles</code></li>
  <li><code>/usr/share/sandbox</code></li>
</ul>

<p>The tool has virtually no official documentation so some hacker insight can come very handy. There’s a number of useful examples here:</p>
<ul>
  <li><a href="https://chromium.googlesource.com/chromium/src/+/master/sandbox/mac/seatbelt_sandbox_design.md" target="_blank" rel="noopener noreferrer">“Mac Sandbox V2 Design Doc” on chromium.googlesource.com</a></li>
  <li><a href="https://paolozaino.wordpress.com/2015/08/04/how-to-run-your-applications-in-a-mac-os-x-sandbox-to-enhance-security/" target="_blank" rel="noopener noreferrer">“macOS: How to run your Applications in a Mac OS X sandbox to enhance security” on paolozaino.wordpress.com</a></li>
  <li><a href="https://jmmv.dev/2019/11/macos-sandbox-exec.html" target="_blank" rel="noopener noreferrer">“A quick glance at macOS’ sandbox-exec” on jmmv.dev</a></li>
</ul>

<p>Further historical background and technical details can be found here:</p>
<ul>
  <li><a href="https://wiki.mozilla.org/Sandbox/OS_X_Rule_Set" target="_blank" rel="noopener noreferrer">“Sandbox/OS X Rule Set” on the Mozilla wiki</a></li>
  <li><a href="https://github.com/Ozymandias42/macOS-Sandbox-Profiles/blob/master/telegram.sb" target="_blank" rel="noopener noreferrer">Ozymandias42/macOS-Sandbox-Profiles</a></li>
  <li><a href="https://craftware.xyz/tips/MacOS-sandbox.html" target="_blank" rel="noopener noreferrer">“Test The MacOS Sandbox” on craftware.xyz</a></li>
  <li><a href="https://blog.squarelemon.com/2015/02/os-x-sandbox-quickstart/" target="_blank" rel="noopener noreferrer">“OS X sandbox quickstart” on blog.squarelemon.com</a></li>
  <li><a href="https://developer.apple.com/forums/thread/661176?answerId=635519022#635519022" target="_blank" rel="noopener noreferrer">This answer by Eskimo on the Apple Developer Forums</a></li>
</ul>

<p>Setting up a Sandbox from scratch can often be largely trial and error — disallow everything, and then follow the trail of errors to see what you need to enable as a bare minimum to make the app work.</p>

<p>On the upside, it’s a great way to gain insight into what closed source binaries are trying to do on your system.</p>

</article>

    </div></div>
  </body>
</html>
