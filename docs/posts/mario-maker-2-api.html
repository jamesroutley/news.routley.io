<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tgrcode.com/posts/mario_maker_2_api">Original</a>
    <h1>Mario Maker 2 API</h1>
    
    <div id="readability-page-1" class="page"><div><p>Mario Maker 2 is a game I&#39;ve played for years, since launch, and I&#39;ve always been interested in putting my skills in programming to the test here. I&#39;ve finally done just that. Using the <a href="https://github.com/kinnay/NintendoClients">incredible NintendoClients</a> made by <a href="https://github.com/kinnay">Kinnay</a>, I, and individuals from the Ninji Speedrunning discord, 0% discord, and Kinnay himself, we now have an entirely free and public way of accessing data previously only available to the switch itself.</p>

<p>Nintendo Switch Online games tend to use a specific library with a specific protocol to communicate with Nintendo&#39;s servers. Since the WiiU, this protocol has been NEX. NEX, partially due to the incredible success of many of the games using it like Mario Kart 8 and Splatoon 2, has been extensively documented, to the point where it is fully possible to spoof both the client and server. The Pretendo project has been working on a WiiU NEX server for years, and alongside it NintendoClients, a NEX client, has been becoming more stable and safe to run on your personal account.</p>
<p>In October 2021 I finally took the plunge and started using NintendoClients for a dream I had years prior: to make all Mario Maker 2 data easily accessible to computers. After watching the project for years, debating whether to purchase a digital copy of the game and put my Switch certificate on the line, Tatiaus, a talented kaizo player, contacted me about using the API for the 0% team as I had mentioned it in passing earlier. Once I realized there was interest past my own goals I bought the game and began working. On the 13th, I released the first build, publicly available with no login required.</p>
<h2>First release to a small group of Switch modders</h2>
<p><img src="https://jvns.ca/posts/file?id=mario_maker_2_api&amp;sub=file1" alt="First release on discord"/></p>

<p>First, the Ninji server used it to round out their leaderboards, making them 100% accurate for the first time ever. The features I considered most important, the <code>level_info</code> and <code>level_data</code> endpoints, went unused. Not many people outside the Ninji Speedrunning discord knew this existed. Slowly, the API got around, but it stayed a novelty. One of the funniest misconceptions I saw was the guess that my switch was running 24/7 and downloading levels for me. The truth is that this was running on a linux server, using a complete recreation of the NEX client. No switch was involved, except for the various credentials the NEX protocol needs to authenticate with the server.</p>

<p>In November a kaizo player well known for performing incredibly difficult &#34;trump jumps&#34;, jumps in the game which were pixel perfect, came to me about using the API for a level viewer he had designed. In time Ji Xiaomai released <a href="https://github.com/JiXiaomai/SMM2LevelViewer">his viewer</a>, and that was the spark that ignited the entire community. Suddenly now anyone could view any level without the game and even without a switch. Tricky levels that were only possible due to information only the creator could know were exposed. Suddenly now no level could hide secrets.</p>
<p>After the release of this viewer, I <a href="https://github.com/TheGreatRambler/toost">ported it to C++</a> and made it portable enough to <a href="https://tgrcode.com/level_viewer/">run in the browser</a>, so now it wasn&#39;t even neccesary to download the app to your PC. With time came new incredible viewers, including one that <a href="https://smm2.wizul.us/">had animated textures</a>. The count of level viewers was now 5, including the continuation of an old level viewer by streamer and programmer <a href="https://twitter.com/toransushoujo">Shoujo</a> and one made from the ground up by <a href="https://twitter.com/andrewingram">Ingram</a>. The community had collectively come together to tear the game apart, utterly destroying the roughly 1 level viewer made for the first game. And in another impressive effort, almost every field of every endpoint was determined, so now stats previously thought impossible to obtain, like the boos on a level or the k/d ratio of a player, were accessible. All this hype has generated an impressive amount of traffic as well:</p>
<h2>Web traffic after release</h2>
<p><img src="https://jvns.ca/posts/file?id=mario_maker_2_api&amp;sub=file2" alt="Web traffic after release"/></p>

<p>Through all this, the API has stayed public and free. Information should always be as accessible as possible and designed to be as easy to parse as possible by people and computers alike. While I am putting my personal Nintendo Switch Online account on the line, this tool is invaluable to research about the game. So I can proudly say, while Youtube made dislikes private, we made Mario Maker 2 dislikes public.</p>
<p>The logical conclusion to this venture is to pull as much data as we can. So I did the only reasonable thing, went out and bought a 14 terabyte hard drive in order to download Mario Maker 2&#39;s entire database. Now it might seem impossible to simply download everything, we can request up to 300 random levels at a time through endpoints like <code>search_endless_mode</code>, but statistically we will recieve less and less unique items over time, almost guaranteed to take years to download 100% of available levels. Nintendo, however, made this easy for us:</p>
<pre><code><span>def</span> <span>course_id_to_dataid</span>(<span><span>id</span></span>):
	course_id = <span>id</span>[::-<span>1</span>]
	charset = <span>&#34;0123456789BCDFGHJKLMNPQRSTVWXY&#34;</span>
	number = <span>0</span>
	<span>for</span> char <span>in</span> course_id:
		number = number * <span>30</span> + charset.index(char)
	left_side = number
	left_side = left_side &lt;&lt; <span>34</span>
	left_side_replace_mask = <span>0b1111111111110000000000000000000000000000000000</span>
	number = number ^ ((number ^ left_side) &amp; left_side_replace_mask)
	number = number &gt;&gt; <span>14</span>
	number = number ^ <span>0b00010110100000001110000001111100</span>
	<span>return</span> number
</code></pre>
<p>Course ids are constructed from a regular algorithm from a consistent incrementing index called a <code>data_id</code>. Internally these ids are used to request many known levels, like a list of your own uploaded levels. Because these data ids increment regularly and we know both the first data id, 3 million, and the last through a call to <code>search_new</code>, we can download <em>every uploaded level</em> by sweeping through all 31 million data ids currently allocated. Because users follow similar rules, downloading every user account is also possible.</p>
<p>Running a python program for 4 straight weeks to generate a 2 terabyte database may seem foolish to most, but I&#39;m not putting this perfectly good PC to waste by turning it off. Instead, I did it, ran my computer for all of those 4 weeks, and the resulting data will be a goldmine into how players interact with levels and each other.</p>

<pre><code><span>CREATE</span> <span>TABLE</span> level (
    data_id <span>INTEGER</span>,                    
    name TEXT,                          
    description TEXT,                   
    uploaded <span>INTEGER</span>,                   
    course_id TEXT,                     
    gamestyle <span>INTEGER</span>,                  
    theme <span>INTEGER</span>,                      
    difficulty <span>INTEGER</span>,                 
    tag1 <span>INTEGER</span>,                       
    tag2 <span>INTEGER</span>,                       
    world_record <span>INTEGER</span>,               
    upload_time <span>INTEGER</span>,                
    num_comments <span>INTEGER</span>,               
    clear_condition <span>INTEGER</span>,            
    clear_condition_magnitude <span>INTEGER</span>,  
    clears <span>INTEGER</span>,                     
    attempts <span>INTEGER</span>,                   
    clear_rate <span>REAL</span>,                    
    plays <span>INTEGER</span>,                      
    versus_matches <span>INTEGER</span>,             
    coop_matches <span>INTEGER</span>,               
    likes <span>INTEGER</span>,                      
    boos <span>INTEGER</span>,                       
    unique_players_and_versus <span>INTEGER</span>,  
    weekly_likes <span>INTEGER</span>,               
    weekly_plays <span>INTEGER</span>,               
    one_screen_thumbnail <span>BLOB</span>,          
    one_screen_thumbnail_url TEXT,      
    one_screen_thumbnail_size <span>INTEGER</span>,  
    one_screen_thumbnail_filename TEXT, 
    entire_thumbnail <span>BLOB</span>,              
    entire_thumbnail_url TEXT,          
    entire_thumbnail_size <span>INTEGER</span>,      
    entire_thumbnail_filename TEXT,     
    uploader_pid TEXT,                  
    first_completer_pid TEXT,           
    record_holder_pid TEXT,             
    level_data <span>BLOB</span>,                    
    unk2 <span>INTEGER</span>,                       
    unk3 <span>BLOB</span>,                          
    unk9 <span>INTEGER</span>,                       
    unk10 <span>INTEGER</span>,                      
    unk11 <span>INTEGER</span>,                      
    unk12 <span>INTEGER</span>                       
);
<span>CREATE</span> <span>TABLE</span> <span>user</span> (
    pid TEXT,                           
    data_id <span>INTEGER</span>,                    
    code TEXT,                          
    region <span>INTEGER</span>,                     
    name TEXT,                          
    country TEXT,                       
    last_active <span>INTEGER</span>,                
    mii_data <span>BLOB</span>,                      
    mii_image TEXT,                     
    mii_studio_code TEXT,               
    pose <span>INTEGER</span>,                       
    hat <span>INTEGER</span>,                        
    shirt <span>INTEGER</span>,                      
    pants <span>INTEGER</span>,                      
    wearing_outfit <span>INTEGER</span>,             
    courses_played <span>INTEGER</span>,             
    courses_cleared <span>INTEGER</span>,            
    courses_attempted <span>INTEGER</span>,          
    courses_deaths <span>INTEGER</span>,             
    likes <span>INTEGER</span>,                      
    maker_points <span>INTEGER</span>,               
    easy_highscore <span>INTEGER</span>,             
    normal_highscore <span>INTEGER</span>,           
    expert_highscore <span>INTEGER</span>,           
    super_expert_highscore <span>INTEGER</span>,     
    versus_rating <span>INTEGER</span>,              
    versus_rank <span>INTEGER</span>,                
    versus_won <span>INTEGER</span>,                 
    versus_lost <span>INTEGER</span>,                
    versus_win_streak <span>INTEGER</span>,          
    versus_lose_streak <span>INTEGER</span>,         
    versus_plays <span>INTEGER</span>,               
    versus_disconnected <span>INTEGER</span>,        
    coop_clears <span>INTEGER</span>,                
    coop_plays <span>INTEGER</span>,                 
    recent_performance <span>INTEGER</span>,         
    versus_kills <span>INTEGER</span>,               
    versus_killed_by_others <span>INTEGER</span>,    
    multiplayer_unk13 <span>INTEGER</span>,          
    multiplayer_unk14 <span>INTEGER</span>,          
    first_clears <span>INTEGER</span>,               
    world_records <span>INTEGER</span>,              
    unique_super_world_clears <span>INTEGER</span>,  
    uploaded_levels <span>INTEGER</span>,            
    maximum_uploaded_levels <span>INTEGER</span>,    
    weekly_maker_points <span>INTEGER</span>,        
    last_uploaded_level <span>INTEGER</span>,        
    is_nintendo_employee <span>INTEGER</span>,       
    comments_enabled <span>INTEGER</span>,           
    tags_enabled <span>INTEGER</span>,               
    super_world_id TEXT,                
    unk3 <span>INTEGER</span>,                       
    unk12 <span>INTEGER</span>,                      
    unk16 <span>INTEGER</span>                       
);
<span>CREATE</span> <span>TABLE</span> user_badges (
    pid TEXT,                           
    type <span>INTEGER</span>,                       
    rank <span>INTEGER</span>                        
);
<span>CREATE</span> <span>TABLE</span> level_comments (
    data_id <span>INTEGER</span>,                    
    comment_id TEXT,                    
    type <span>INTEGER</span>,                       
    pid TEXT,                           
    posted <span>INTEGER</span>,                     
    clear_required <span>INTEGER</span>,             
    text TEXT,                          
    reaction_image_id <span>INTEGER</span>,          
    custom_image <span>BLOB</span>,                  
    custom_image_url TEXT,              
    custom_image_size <span>INTEGER</span>,          
    custom_image_filename TEXT,         
    has_beaten <span>INTEGER</span>,                 
    x <span>INTEGER</span>,                          
    y <span>INTEGER</span>,                          
    reaction_face <span>INTEGER</span>,              
    unk8 <span>INTEGER</span>,                       
    unk10 <span>INTEGER</span>,                      
    unk12 <span>INTEGER</span>,                      
    unk14 <span>BLOB</span>,                         
    unk17 <span>INTEGER</span>                       
);
<span>CREATE</span> <span>TABLE</span> level_played (
    data_id <span>INTEGER</span>,                    
    pid TEXT,                           
    cleared <span>INTEGER</span>,                    
    liked <span>INTEGER</span>                       
);
<span>CREATE</span> <span>TABLE</span> level_deaths (
    data_id <span>INTEGER</span>,                    
    x <span>INTEGER</span>,                          
    y <span>INTEGER</span>,                          
    is_subworld <span>INTEGER</span>                 
);
<span>CREATE</span> <span>TABLE</span> world (
    pid TEXT,                           
    world_id TEXT,                      
    worlds <span>INTEGER</span>,                     
    levels <span>INTEGER</span>,                     
    planet_type <span>INTEGER</span>,                
    created <span>INTEGER</span>,                    
    unk1 <span>BLOB</span>,                          
    unk5 <span>INTEGER</span>,                       
    unk6 <span>INTEGER</span>,                       
    unk7 <span>INTEGER</span>,                       
    thumbnail <span>BLOB</span>,                     
    thumbnail_url TEXT,                 
    thumbnail_size <span>INTEGER</span>,             
    thumbnail_filename TEXT             
);
<span>CREATE</span> <span>TABLE</span> world_levels (
    pid TEXT,                           
    data_id <span>INTEGER</span>,                    
    ninjis <span>INTEGER</span>                      
);
<span>CREATE</span> <span>TABLE</span> user_posted (
    pid TEXT,                           
    data_id <span>INTEGER</span>                     
);
<span>CREATE</span> <span>TABLE</span> user_liked (
    pid TEXT,                           
    data_id <span>INTEGER</span>                     
);
<span>CREATE</span> <span>TABLE</span> user_played (
    pid TEXT,                           
    data_id <span>INTEGER</span>                     
);
<span>CREATE</span> <span>TABLE</span> user_first_cleared (
    pid TEXT,                           
    data_id <span>INTEGER</span>                     
);
<span>CREATE</span> <span>TABLE</span> user_world_record (
    pid TEXT,                           
    data_id <span>INTEGER</span>                     
);
<span>CREATE</span> <span>TABLE</span> ninji (
    data_id <span>INTEGER</span>,                    
    pid TEXT,                           
    <span>time</span> <span>INTEGER</span>,                       
    replay <span>BLOB</span>,                        
    replay_url TEXT,                    
    replay_size <span>INTEGER</span>,                
    replay_filename TEXT                
);
<span>CREATE</span> <span>TABLE</span> ninji_level (
    data_id <span>INTEGER</span>,                    
    name TEXT,                          
    description TEXT,                   
    uploaded <span>INTEGER</span>,                   
    ended <span>INTEGER</span>,                      
    gamestyle <span>INTEGER</span>,                  
    theme <span>INTEGER</span>,                      
    medal_time <span>INTEGER</span>,                 
    clear_condition <span>INTEGER</span>,            
    clear_condition_magnitude <span>INTEGER</span>,  
    unk3_0 <span>INTEGER</span>,                     
    unk3_1 <span>INTEGER</span>,                     
    unk3_2 <span>INTEGER</span>,                     
    unk5 <span>INTEGER</span>,                       
    unk6 <span>INTEGER</span>,                       
    unk9 <span>INTEGER</span>,                       
    level_data <span>BLOB</span>,                    
    one_screen_thumbnail <span>BLOB</span>,          
    one_screen_thumbnail_url TEXT,      
    one_screen_thumbnail_size <span>INTEGER</span>,  
    one_screen_thumbnail_filename TEXT, 
    entire_thumbnail <span>BLOB</span>,              
    entire_thumbnail_url TEXT,          
    entire_thumbnail_size <span>INTEGER</span>,      
    entire_thumbnail_filename TEXT      
);
<span>CREATE</span> INDEX idx_level_data_id <span>ON</span> level (data_id);
<span>CREATE</span> INDEX idx_level_comments_data_id <span>ON</span> level_comments (data_id);
<span>CREATE</span> INDEX idx_level_deaths_data_id <span>ON</span> level_deaths (data_id);
<span>CREATE</span> INDEX idx_level_played_data_id <span>ON</span> level_played (data_id);
<span>CREATE</span> INDEX idx_ninji_data_id <span>ON</span> ninji (data_id);
<span>CREATE</span> INDEX idx_user_pid <span>ON</span> <span>user</span> (pid);
<span>CREATE</span> INDEX idx_user_badges_pid <span>ON</span> user_badges (pid);
<span>CREATE</span> INDEX idx_user_first_cleared_pid <span>ON</span> user_first_cleared (pid);
<span>CREATE</span> INDEX idx_user_liked_pid <span>ON</span> user_liked (pid);
<span>CREATE</span> INDEX idx_user_played_pid <span>ON</span> user_played (pid);
<span>CREATE</span> INDEX idx_user_posted_pid <span>ON</span> user_posted (pid);
<span>CREATE</span> INDEX idx_user_world_record_pid <span>ON</span> user_world_record (pid);
<span>CREATE</span> INDEX idx_world_pid <span>ON</span> world (pid);
<span>CREATE</span> INDEX idx_world_levels_pid <span>ON</span> world_levels (pid);
</code></pre>
<p>In an update post I&#39;ll cover the data analysis I do on this massive archive, and release it publicly. Make sure to look out for that!</p></div></div>
  </body>
</html>
