<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://sander.ai/2024/09/02/spectral-autoregression.html">Original</a>
    <h1>Diffusion Is Spectral Autoregression</h1>
    
    <div id="readability-page-1" class="page"><div>
      <p>A bit of signal processing swiftly reveals that diffusion models and autoregressive models aren’t all that different: <strong>diffusion models of images perform approximate autoregression in the frequency domain!</strong></p>

<p>
This blog post is also available as a <a href="https://colab.research.google.com/drive/1siywvhvl1OxI1UmqRrJHiFUK0M5SHlcx">Python notebook in Google Colab <img src="https://sander.ai/images/colab_logo.png"/></a>, with the code used to produce all the plots and animations.</p>

<p>Last year, I wrote a blog post describing various different <a href="https://sander.ai/2023/07/20/perspectives.html">perspectives on diffusion</a>. The idea was to highlight a number of connections between diffusion models and other classes of models and concepts. In recent months, I have given a few talks where I discussed some of these perspectives. My talk at the <a href="https://www.eeml.eu/">EEML 2024 summer school</a> in Novi Sad, Serbia, was recorded and is <a href="https://www.youtube.com/watch?v=9BHQvQlsVdE">available on YouTube</a>. Based on the response I got from this talk, the link between diffusion models and <strong>autoregressive models</strong> seems to be particularly thought-provoking. That’s why I figured it could be useful to explore this a bit further.</p>

<p>In this blog post, I will unpack the above claim, and try to make it obvious that this is the case, at least for visual data. To make things more tangible, I decided to write this entire blog post in the form of <a href="https://colab.research.google.com/drive/1siywvhvl1OxI1UmqRrJHiFUK0M5SHlcx">a Python notebook</a> (using Google Colab). That way, <strong>you can easily reproduce the plots and analyses yourself</strong>, and modify them to observe what happens. I hope this format will also help drive home the point that this connection between diffusion models and autoregressive models is “real”, and not just a theoretical idealisation that doesn’t hold up in practice.</p>

<p>In what follows, I will assume a basic understanding of diffusion models and the core concepts behind them. If you’ve watched the talk I linked above, you should be able to follow along. Alternatively, the <a href="https://sander.ai/2023/07/20/perspectives.html">perspectives on diffusion</a> blog post should also suffice as preparatory reading. Some knowledge of the Fourier transform will also be helpful.</p>

<p>Below is an overview of the different sections of this post. Click to jump directly to a particular section.</p>

<ol>
  <li><em><a href="#iterative-refinement">Two forms of iterative refinement</a></em></li>
  <li><em><a href="#spectral-view">A spectral view of diffusion</a></em></li>
  <li><em><a href="#sound">What about sound?</a></em></li>
  <li><em><a href="#unstable-equilibrium">Unstable equilibrium</a></em></li>
  <li><em><a href="#closing-thoughts">Closing thoughts</a></em></li>
  <li><em><a href="#acknowledgements">Acknowledgements</a></em></li>
  <li><em><a href="#references">References</a></em></li>
</ol>

<h2 id="-two-forms-of-iterative-refinement"><a name="iterative-refinement"></a> Two forms of iterative refinement</h2>

<figure>
  <a href="https://sander.ai/images/jonction.jpg"><img src="https://sander.ai/images/jonction.jpg"/></a>
</figure>

<p>Autoregression and diffusion are currently the two dominant generative modelling paradigms. There are many more ways to build generative models: <a href="https://en.wikipedia.org/wiki/Flow-based_generative_model">flow-based models</a> and <a href="https://en.wikipedia.org/wiki/Generative_adversarial_network">adversarial models</a> are just two possible alternatives (I discussed a few more in <a href="https://sander.ai/2020/03/24/audio-generation.html#generative-models">an earlier blog post</a>).</p>

<p>Both autoregression and diffusion differ from most of these alternatives, by splitting up the difficult task of generating data from complex distributions into smaller subtasks that are easier to learn. Autoregression does this by casting the data to be modelled into the shape of a sequence, and recursively predicting one sequence element at a time. Diffusion instead works by defining a corruption process that gradually destroys all structure in the data, and training a model to learn to invert this process step by step.</p>

<p>This <strong>iterative refinement</strong> approach to generative modelling is very powerful, because it allows us to construct very deep computational graphs for generation, without having to backpropagate through them during training. Indeed, both autoregressive models and diffusion models learn to perform a single step of refinement at a time – the generative process is not trained end-to-end. It is only when we try to sample from the model that we connect all these steps together, by sequentially performing the subtasks: predicting one sequence element after another in the case of autoregression, or gradually denoising the input step-by-step in the case of diffusion.</p>

<p>Because this underlying iterative approach is common to both paradigms, people have often sought to connect the two. One could frame autoregression as a special case of discrete diffusion, for example, with a corruption process that gradually replaces tokens by “mask tokens” from right to left, eventually ending up with a fully masked sequence. In the next few sections, we will do the opposite, framing diffusion as a special case of autoregression, albeit approximate.</p>

<p>Today, most language models are autoregressive, while most models of images and video are diffusion-based. In many other application domains (e.g. protein design, planning in reinforcement learning, …), diffusion models are also becoming more prevalent. I think this dichotomy, which can be summarised as “autoregression for language, and diffusion for everything else”, is quite interesting. I have <a href="https://sander.ai/2023/01/09/diffusion-language.html">written about it before</a>, and I will have more to say about it in a later section of this post.</p>

<h2 id="-a-spectral-view-of-diffusion"><a name="spectral-view"></a> A spectral view of diffusion</h2>

<figure>
  <a href="https://sander.ai/images/prism.jpg"><img src="https://sander.ai/images/prism.jpg"/></a>
</figure>

<h3 id="-image-spectra"><a name="image-spectra"></a> Image spectra</h3>

<p>When diffusion models rose to prominence for image generation, people noticed quite quickly that they tend to produce images in a coarse-to-fine manner. The large-scale structure present in the image seems to be decided in earlier denoising steps, whereas later denoising steps add more and more fine-grained details.</p>

<p>To formalise this observation, we can use signal processing, and more specifically <strong>spectral analysis</strong>. By decomposing an image into its constituent <strong>spatial frequency</strong> components, we can more precisely tease apart its coarse- and fine-grained structure, which correspond to low and high frequencies respectively.</p>

<p>We can use the 2D <a href="https://en.wikipedia.org/wiki/Fourier_transform">Fourier transform</a> to obtain a frequency representation of an image. This representation is invertible, i.e. it contains the same information as the pixel representation – it is just organised in a different way. Like the pixel representation, it is a 2D grid-structured object, with the same width and height as the original image, but the axes now correspond to horizontal and vertical spatial frequencies, rather than spatial positions.</p>

<p>To see what this looks like, let’s take some images and visualise their spectra.</p>

<figure>
  <a href="https://sander.ai/images/plot_image_spectra.png"><img src="https://sander.ai/images/plot_image_spectra.png" alt="Four images from the Imagenette dataset (top), along with their magnitude spectra (middle) and their phase spectra (bottom)."/></a>
  <figcaption>Four images from the <a href="https://github.com/fastai/imagenette">Imagenette dataset</a> (top), along with their magnitude spectra (middle) and their phase spectra (bottom).</figcaption>
</figure>

<p>Shown above on the first row are four images from the <a href="https://github.com/fastai/imagenette">Imagenette dataset</a>, a subset of the ImageNet dataset (I picked it because it is relatively fast to load).</p>

<p>The Fourier transform is typically complex-valued, so the next two rows visualise the <em>magnitude</em> and the <em>phase</em> of the spectrum respectively. Because the magnitude varies greatly across different frequencies, its logarithm is shown. The phase is an angle, which varies between \(-\pi\) and \(\pi\). Note that we only calculate the spectrum for the green colour channel – we could calculate it for the other two channels as well, but they would look very similar.</p>

<p>The centre of the spectrum corresponds to the lowest spatial frequencies, and the frequencies increase as we move outward to the edges. This allows us to see where most of the energy in the input signal is concentrated. Note that by default, it is the other way around (low frequencies in the corner, high frequencies in the middle), but <code>np.fft.fftshift</code> allows us to swap these, which yields a much nicer looking visualisation that makes the structure of the spectrum more apparent.</p>

<p>A lot of interesting things can be said about the phase structure of natural images, but in what follows, we will primarily focus on the magnitude spectrum. The square of the magnitude is the <em>power</em>, so in practice we often look at the <em>power spectrum</em> instead. Note that the logarithm of the power spectrum is simply that of the magnitude spectrum, multiplied by two.</p>

<p>Looking at the spectra, we now have a more formal way to reason about different feature scales in images, but that still doesn’t explain why diffusion models exhibit this coarse-to-fine behaviour. To see why this happens, we need to examine what a typical image spectrum looks like. To do this, we will <strong>make abstraction of the directional nature of frequencies in 2D space</strong>, simply by slicing the spectrum along a certain angle, rotating that slice all around, and then averaging the slices across all rotations. This yields a one-dimensional curve: <strong>the <em>radially averaged power spectral density</em>, or RAPSD</strong>.</p>

<p>Below is an animation that shows individual directional slices of the 2D spectrum on a log-log plot, which are averaged to obtain the RAPSD.</p>

<figure>
  <a href="https://sander.ai/images/image_spectrum.gif"><img src="https://sander.ai/images/image_spectrum.gif" alt="Animation that shows individual directional slices of the 2D spectrum of an image on a log-log plot."/></a>
  <figcaption>Animation that shows individual directional slices of the 2D spectrum of an image on a log-log plot.</figcaption>
</figure>

<p>Let’s see what that looks like for the four images above. We will use the <code>pysteps</code> library, which comes with a handy function to calculate the RAPSD in one go.</p>

<figure>
  <a href="https://sander.ai/images/plot_image_rapsd.png"><img src="https://sander.ai/images/plot_image_rapsd.png" alt="Four images from the Imagenette dataset (top), along with their radially averaged spectral power densities (RAPSDs, bottom)."/></a>
  <figcaption>Four images from the Imagenette dataset (top), along with their radially averaged spectral power densities (RAPSDs, bottom).</figcaption>
</figure>

<p>The RAPSD is best visualised on a log-log plot, to account for the large variation in scale. We chop off the so-called DC component (with frequency 0) to avoid taking the logarithm of 0.</p>

<p>Another thing this visualisation makes apparent is that the curves are remarkably close to being straight lines. A straight line on a log-log plot implies that there might be a power law lurking behind all of this.</p>

<p>Indeed, this turns out to be the case: <strong>natural image spectra tend to approximately follow a power law</strong>, which means that the power \(P(f)\) of a particular frequency \(f\) is proportional to \(f^{-\alpha}\), where \(\alpha\) is a parameter<sup id="fnref:schaaf" role="doc-noteref"><a href="#fn:schaaf" rel="footnote">1</a></sup> <sup id="fnref:torralba" role="doc-noteref"><a href="#fn:torralba" rel="footnote">2</a></sup> <sup id="fnref:hyvarinen" role="doc-noteref"><a href="#fn:hyvarinen" rel="footnote">3</a></sup>. In practice, \(\alpha\) is often remarkably close to 2 (which corresponds to the spectrum of <a href="https://en.wikipedia.org/wiki/Pink_noise">pink noise</a> in two dimensions).</p>

<p>We can get closer to the “typical” RAPSD by taking the average across a bunch of images (in the log-domain).</p>

<figure>
  <a href="https://sander.ai/images/mean_log_rapsd.png"><img src="https://sander.ai/images/mean_log_rapsd.png" alt="The average of RAPSDs of a set of images in the log-domain."/></a>
  <figcaption>The average of RAPSDs of a set of images in the log-domain.</figcaption>
</figure>

<p>As I’m sure you will agree, that is pretty unequivocally a power law!</p>

<p>To estimate the exponent \(\alpha\), we can simply use linear regression in log-log space. Before proceeding however, it is useful to resample our averaged RAPSD so the sample points are linearly spaced in log-log space – otherwise our fit will be dominated by the high frequencies, where we have many more sample points.</p>

<p>We obtain an estimate \(\hat{\alpha} = 2.454\), which is a bit higher than the typical value of 2. As far as I understand, this can be explained by the presence of man-made objects in many of the images we used, because they tend to have smooth surfaces and straight angles, which results in comparatively more low-frequency content and less high-frequency content compared to images of nature. Let’s see what our fit looks like.</p>

<figure>
  <a href="https://sander.ai/images/mean_log_rapsd_fit.png"><img src="https://sander.ai/images/mean_log_rapsd_fit.png" alt="The average of RAPSDs of a set of images in the log-domain (red line), along with a linear fit (dotted black line)."/></a>
  <figcaption>The average of RAPSDs of a set of images in the log-domain (red line), along with a linear fit (dotted black line).</figcaption>
</figure>

<h3 id="-noisy-image-spectra"><a name="noisy-spectra"></a> Noisy image spectra</h3>

<p>A crucial aspect of diffusion models is the corruption process, which involves adding Gaussian noise. Let’s see what this does to the spectrum. The first question to ask is: what does the spectrum of noise look like? We can repeat the previous procedure, but replace the image input with standard Gaussian noise. For contrast, we will visualise the spectrum of the noise alongside that of the images from before.</p>

<figure>
  <a href="https://sander.ai/images/mean_log_rapsd_noise.png"><img src="https://sander.ai/images/mean_log_rapsd_noise.png" alt="The average of RAPSDs of a set of images in the log-domain (red line), along with the average of RAPSDs of standard Gaussian noise (blue line)."/></a>
  <figcaption>The average of RAPSDs of a set of images in the log-domain (red line), along with the average of RAPSDs of standard Gaussian noise (blue line).</figcaption>
</figure>

<p>The RAPSD of Gaussian noise is also a straight line on a log-log plot; but a horizontal one, rather than one that slopes down. This reflects the fact that <strong>Gaussian noise contains all frequencies in equal measure</strong>. The Fourier transform of Gaussian noise is itself Gaussian noise, so its power must be equal across all frequencies in expectation.</p>

<p>When we add noise to the images and look at the spectrum of the resulting noisy images, we see a hinge shape:</p>

<figure>
  <a href="https://sander.ai/images/mean_log_rapsd_sum.png"><img src="https://sander.ai/images/mean_log_rapsd_sum.png" alt="The average of RAPSDs of a set of images in the log-domain (red line), along with the average of RAPSDs of standard Gaussian noise (blue line) and the average of RAPSDs of their sum (green line)."/></a>
  <figcaption>The average of RAPSDs of a set of images in the log-domain (red line), along with the average of RAPSDs of standard Gaussian noise (blue line) and the average of RAPSDs of their sum (green line).</figcaption>
</figure>

<p>Why does this happen? Recall that the <strong>Fourier transform is linear</strong>: the Fourier transform of the sum of two things, is the sum of the Fourier transforms of those things. Because the power of the different frequencies varies across orders of magnitude, <strong>one of the terms in this sum tends to drown out the other</strong>. This is what happens at low frequencies, where the image spectrum dominates, and hence the green curve overlaps with the red curve. At high frequencies on the other hand, the noise spectrum dominates, and the green curve overlaps with the blue curve. In between, there is a transition zone where the power of both spectra is roughly matched.</p>

<p>If we increase the variance of the noise by scaling the noise term, we increase its power, and as a result, its RAPSD will shift upward (which is also a consequence of the linearity of the Fourier transform). This means a smaller part of the image spectrum now juts out above the waterline: <strong>the increasing power of the noise looks like the rising tide!</strong></p>

<figure>
  <a href="https://sander.ai/images/mean_log_rapsd_high_noise.png"><img src="https://sander.ai/images/mean_log_rapsd_high_noise.png" alt="The average of RAPSDs of a set of images in the log-domain (red line), along with the average of RAPSDs of Gaussian noise with variance 16 (blue line) and the average of RAPSDs of their sum (green line)."/></a>
  <figcaption>The average of RAPSDs of a set of images in the log-domain (red line), along with the average of RAPSDs of Gaussian noise with variance 16 (blue line) and the average of RAPSDs of their sum (green line).</figcaption>
</figure>

<p>At this point, I’d like to revisit a diagram from the <a href="https://sander.ai/2023/07/20/perspectives.html#autoregressive">perspectives on diffusion blog post</a>, where I originally drew the connection between diffusion and autoregression in frequency space, which is shown below.</p>

<figure>
  <a href="https://sander.ai/images/image_spectra.png"><img src="https://sander.ai/images/image_spectra.png" alt="Magnitude spectra of natural images, Gaussian noise, and noisy images."/></a>
  <figcaption>Magnitude spectra of natural images, Gaussian noise, and noisy images.</figcaption>
</figure>

<p>These idealised plots of the spectra of images, noise, and their superposition match up pretty well with the real versions. When I originally drew this, I didn’t actually realise just how closely this reflects reality!</p>

<p>What these plots reveal is an approximate equivalence (in expectation) between adding noise to images, and <strong>low-pass filtering</strong> them. The noise will drown out some portion of the high frequencies, and leave the low frequencies untouched. The variance of the noise determines the <strong>cut-off frequency</strong> of the filter. Note that this is the case only because of the characteristic shape of natural image spectra.</p>

<p>The animation below shows how the spectrum changes as we gradually add more noise, until it eventually overpowers all frequency components, and all image content is gone.</p>

<figure>
  <a href="https://sander.ai/images/rising_tide.gif"><img src="https://sander.ai/images/rising_tide.gif" alt="Animation that shows the changing averaged RAPSD as more and more noise is added to a set of images."/></a>
  <figcaption>Animation that shows the changing averaged RAPSD as more and more noise is added to a set of images.</figcaption>
</figure>

<h3 id="-diffusion"><a name="diffuion"></a> Diffusion</h3>

<p>With this in mind, it becomes apparent that the corruption process used in diffusion models is actually gradually filtering out more and more high-frequency information from the input image, and the different time steps of the process correspond to a frequency decomposition: basically an approximate version of the <strong>Fourier transform</strong>!</p>

<p>Since diffusion models themselves are tasked with reversing this corruption process step-by-step, they end up roughly predicting the next higher frequency component at each step of the generative process, given all preceding (lower) frequency components. This is a soft version of <strong>autoregression in frequency space</strong>, or if you want to make it sound fancier, <strong>approximate spectral autoregression</strong>.</p>

<p>To the best of my knowledge, <a href="https://arxiv.org/abs/2206.13397">Rissanen et al. (2022)</a><sup id="fnref:heat" role="doc-noteref"><a href="#fn:heat" rel="footnote">4</a></sup> were the first to apply this kind of analysis to diffusion in the context of generative modelling (see §2.2 in the paper). Their work directly inspired this blog post.</p>

<p>In many popular formulations of diffusion, the corruption process does not just involve adding noise, but also rescaling the input to keep the total variance within a reasonable range (or constant, in the case of variance-preserving diffusion). I have largely ignored this so far, because it doesn’t materially change anything about the intuitive interpretation. Scaling the input simply results in the RAPSD shifting up or down a bit.</p>

<h3 id="-which-frequencies-are-modelled-at-which-noise-levels"><a name="quantitative"></a> Which frequencies are modelled at which noise levels?</h3>

<p>There seems to be a monotonic relationship between noise levels and spatial frequencies (and hence feature scales). Can we characterise this quantitatively?</p>

<p>We can try, but it is important to emphasise that this relationship is only really valid in expectation, averaged across many images: <strong>for individual images, the spectrum will not be a perfectly straight line, and it will not typically be monotonically decreasing</strong>.</p>

<p>Even if we ignore all that, the “elbow” of the hinge-shaped spectrum of a noisy image is not very sharp, so it is clear that there is quite a large transition zone where we cannot unequivocally say that a particular frequency is dominated by either signal or noise. So this is, at best, a very smooth approximation to the “hard” autoregression used in e.g. large language models.</p>

<p>Keeping all of that in mind, let us construct a mapping from noise levels to frequencies for a particular diffusion process and a particular image distribution, by choosing a signal-to-noise ratio (SNR) threshold, below which we will consider the signal to be undetectable. This choice is quite arbitrary, and we will just have to choose a value and stick with it. We can choose 1 to keep things simple, which means that we consider the signal to be detectable if its power is equal to or greater than the power of the noise.</p>

<p>Consider a Gaussian diffusion process for which \(\mathbf{x}_t = \alpha(t)\mathbf{x}_0 + \sigma(t) \mathbf{\varepsilon}\), with \(\mathbf{x}_0\) an example from the data distribution, and \(\mathbf{\varepsilon}\) standard Gaussian noise.</p>

<p>Let us define \(\mathcal{R}[\mathbf{x}](f)\) as the RAPSD of an image \(\mathbf{x}\) evaluated at frequency \(f\). We will call the SNR threshold \(\tau\). If we consider a particular time step \(t\), then assuming the RAPSD is monotonically decreasing, we can define the <strong>maximal detectable frequency</strong> \(f_\max\) at this time step in the process as the maximal value of \(f\) for which:</p><p>

\[\mathcal{R}[\alpha(t)\mathbf{x}_0](f) &gt; \tau \cdot \mathcal{R}[\sigma(t)\mathbf{\varepsilon}](f).\]

</p><p>Recall that the Fourier transform is a linear operator, and \(\mathcal{R}\) is a radial average of the square of its magnitude. Therefore, scaling the input to \(\mathcal{R}\) by a real value means the output gets scaled by its square. We can use this to simplify things:</p><p>

\[\mathcal{R}[\mathbf{x}_0](f) &gt; \tau \cdot \frac{\sigma(t)^2}{\alpha(t)^2} \mathcal{R}[\mathbf{\varepsilon}](f).\]

</p><p>We can further simplify this by noting that \(\forall f: \mathcal{R}[\mathbf{\varepsilon}](f) = 1\):</p><p>

\[\mathcal{R}[\mathbf{x}_0](f) &gt; \tau \cdot \frac{\sigma(t)^2}{\alpha(t)^2}.\]

</p><p>To construct such a mapping in practice, we first have to choose a diffusion process, which gives us the functional form of \(\sigma(t)\) and \(\alpha(t)\). To keep things simple, we can use the rectified flow<sup id="fnref:rectifiedflow" role="doc-noteref"><a href="#fn:rectifiedflow" rel="footnote">5</a></sup> / flow matching<sup id="fnref:flowmatching" role="doc-noteref"><a href="#fn:flowmatching" rel="footnote">6</a></sup> process, as used in Stable Diffusion 3<sup id="fnref:sd3" role="doc-noteref"><a href="#fn:sd3" rel="footnote">7</a></sup>, for which \(\sigma(t) = t\) and \(\alpha(t) = 1 - t\). Combined with \(\tau = 1\), this yields:</p><p>

\[\mathcal{R}[\mathbf{x}_0](f) &gt; \left(\frac{t}{1 - t}\right)^2.\]

</p><p>With these choices, we can now determine the shape of \(f_\max(t)\) and visualise it.</p>

<figure>
  <a href="https://sander.ai/images/max_detectable_frequency.png"><img src="https://sander.ai/images/max_detectable_frequency.png" alt="Maximum detectable frequency as a function of diffusion time, for a given set of images and the diffusion process used in rectified flow and flow matching formalisms."/></a>
  <figcaption>Maximum detectable frequency as a function of diffusion time, for a given set of images and the diffusion process used in rectified flow and flow matching formalisms.</figcaption>
</figure>

<p>The frequencies here are relative: if the bandwidth of the signal is 1, then 0.5 corresponds to the <a href="https://en.wikipedia.org/wiki/Nyquist_frequency">Nyquist frequency</a>, i.e. the maximal frequency that is representable with the given bandwidth.</p>

<p>Note that all representable frequencies are detectable at time steps near 0. As \(t\) increases, so does the noise level, and hence \(f_\max\) starts dropping, until it eventually reaches 0 (no detectable signal frequencies are left) close to \(t = 1\).</p>

<h2 id="-what-about-sound"><a name="sound"></a> What about sound?</h2>

<figure>
  <a href="https://sander.ai/images/mixer.jpg"><img src="https://sander.ai/images/mixer.jpg"/></a>
</figure>

<p>All of the analysis above hinges on the fact that spectra of natural images typically follow a power law. Diffusion models have also been used to generate audio<sup id="fnref:wavegrad" role="doc-noteref"><a href="#fn:wavegrad" rel="footnote">8</a></sup> <sup id="fnref:diffwave" role="doc-noteref"><a href="#fn:diffwave" rel="footnote">9</a></sup>, which is the other main perceptual modality besides the visual. A very natural question to ask is whether the same interpretation makes sense in the audio domain as well.</p>

<p>To establish that, we will grab a dataset of typical audio recordings that we might want to build a generative model of: speech and music.</p>

<figure>
    <audio controls="" src="/files/audio_clip1.wav"><a href="https://sander.ai/files/audio_clip1.wav">Audio clip 1</a></audio>
    <a href="https://sander.ai/images/spectrogram_clip1.png"><img src="https://sander.ai/images/spectrogram_clip1.png" alt="Magnitude spectrogram for audio clip 1."/></a>
    <audio controls="" src="/files/audio_clip2.wav"><a href="https://sander.ai/files/audio_clip2.wav">Audio clip 2</a></audio>
    <a href="https://sander.ai/images/spectrogram_clip2.png"><img src="https://sander.ai/images/spectrogram_clip2.png" alt="Magnitude spectrogram for audio clip 2."/></a>
    <audio controls="" src="/files/audio_clip3.wav"><a href="https://sander.ai/files/audio_clip3.wav">Audio clip 3</a></audio>
    <a href="https://sander.ai/images/spectrogram_clip3.png"><img src="https://sander.ai/images/spectrogram_clip3.png" alt="Magnitude spectrogram for audio clip 3."/></a>
    <audio controls="" src="/files/audio_clip4.wav"><a href="https://sander.ai/files/audio_clip4.wav">Audio clip 4</a></audio>
    <a href="https://sander.ai/images/spectrogram_clip4.png"><img src="https://sander.ai/images/spectrogram_clip4.png" alt="Magnitude spectrogram for audio clip 4."/></a>
    <figcaption>Four audio clips from the <a href="https://www.kaggle.com/datasets/lnicalo/gtzan-musicspeech-collection">GTZAN music/speech dataset</a>, and their corresponding spectrograms.</figcaption>
</figure>

<p>Along with each audio player, a <em>spectrogram</em> is shown: this is a time-frequency representation of the sound, which is obtained by applying the Fourier transform to short overlapping windows of the waveform and stacking the resulting magnitude vectors together in a 2D matrix.</p>

<p>For the purpose of comparing the spectrum of sound with that of images, we will use the 1-dimensional analogue of the RAPSD, which is simply the squared magnitude of the 1D Fourier transform.</p>

<figure>
  <a href="https://sander.ai/images/plot_sound_spectra.png"><img src="https://sander.ai/images/plot_sound_spectra.png" alt="Magnitude spectra of four audio clips from the GTZAN music/speech dataset."/></a>
  <figcaption>Magnitude spectra of four audio clips from the <a href="https://www.kaggle.com/datasets/lnicalo/gtzan-musicspeech-collection">GTZAN music/speech dataset</a>.</figcaption>
</figure>

<p>These are a lot noisier than the image spectra, which is not surprising as these are not averaged over directions, like the RAPSD is. But aside from that, they don’t really look like straight lines either – the power law shape is nowhere to be seen!</p>

<p>I won’t speculate about why images exhibit this behaviour and sound seemingly doesn’t, but it is certainly interesting (feel free to speculate away in the comments!). To get a cleaner view, we can again average the spectra of many clips in the log domain, as we did with the RAPSDs of images.</p>

<figure>
  <a href="https://sander.ai/images/mean_log_spec.png"><img src="https://sander.ai/images/mean_log_spec.png" alt="The average of magnitude spectra of a set of audio clips the log-domain."/></a>
  <figcaption>The average of magnitude spectra of a set of audio clips the log-domain.</figcaption>
</figure>

<p>Definitely not a power law. More importantly, it is not monotonic, so adding progressively more Gaussian noise to this does not obfuscate frequencies in descending order: <strong>the “diffusion is just spectral autoregression” meme does not apply to audio waveforms!</strong></p>

<p>The average spectrum of our dataset exhibits a peak around 300-400 Hz. This is not too far off the typical spectrum of <a href="https://en.wikipedia.org/wiki/Colors_of_noise#Green_noise">green noise</a>, which has more energy in the region of 500 Hz. Green noise is supposed to sound like “the background noise of the world”.</p>

<figure>
  <a href="https://sander.ai/images/rising_tide_sound.gif"><img src="https://sander.ai/images/rising_tide_sound.gif" alt="Animation that shows the changing averaged magnitude spectrum as more and more noise is added to a set of audio clips."/></a>
  <figcaption>Animation that shows the changing averaged magnitude spectrum as more and more noise is added to a set of audio clips.</figcaption>
</figure>

<p>As the animation above shows, the different frequencies present in audio signals still get filtered out gradually from least powerful to most powerful, because the spectrum of Gaussian noise is still flat, just like in the image domain. But as the audio spectrum does not monotonically decay with increasing frequency, the order is not monotonic in terms of the frequencies themselves.</p>

<p>What does this mean for diffusion in the waveform domain? That’s not entirely clear to me. It certainly makes the link with autoregressive models weaker, but I’m not sure if there are any negative implications for generative modelling performance.</p>

<p>One observation that does perhaps indicate that this is the case, is that a lot of diffusion models of audio described in the literature <strong>do not operate directly in the waveform domain</strong>. It is quite common to first extract some form of spectrogram (as we did earlier), and perform diffusion in that space, essentially treating it like an image<sup id="fnref:hawthorne" role="doc-noteref"><a href="#fn:hawthorne" rel="footnote">10</a></sup> <sup id="fnref:riffusion" role="doc-noteref"><a href="#fn:riffusion" rel="footnote">11</a></sup> <sup id="fnref:edmsound" role="doc-noteref"><a href="#fn:edmsound" rel="footnote">12</a></sup>. Note that spectrograms are a somewhat lossy representation of sound, because <a href="https://sander.ai/2020/03/24/audio-generation.html#why-waveforms">phase information is typically discarded</a>.</p>

<p>To understand the implications of this for diffusion models, we will extract <strong>log-scaled mel-spectrograms</strong> from the sound clips we have used before. The <a href="https://en.wikipedia.org/wiki/Mel_scale">mel scale</a> is a nonlinear frequency scale which is intended to be perceptually uniform, and which is very commonly used in spectral analysis of sound.</p>

<p>Next, we will interpret these spectrograms as images and look at their spectra. Taking the spectrum of a spectrum might seem odd – some of you might even suggest that it is pointless, because the Fourier transform is its own inverse! But note that there are a few nonlinear operations happening in between: taking the magnitude (discarding the phase information), mel-binning and log-scaling. As a result, this second Fourier transform doesn’t just undo the first one.</p>

<figure>
  <a href="https://sander.ai/images/plot_sound_melspec_rapsd.png"><img src="https://sander.ai/images/plot_sound_melspec_rapsd.png" alt="RAPSDs of mel-spectrograms of four audio clips from the GTZAN music/speech dataset."/></a>
  <figcaption>RAPSDs of mel-spectrograms of four audio clips from the <a href="https://www.kaggle.com/datasets/lnicalo/gtzan-musicspeech-collection">GTZAN music/speech dataset</a>.</figcaption>
</figure>

<p>It seems like the power law has resurfaced! We can look at the average in the log-domain again to get a smoother curve.</p>

<figure>
  <a href="https://sander.ai/images/mean_log_melspec_rapsd.png"><img src="https://sander.ai/images/mean_log_melspec_rapsd.png" alt="The average of RAPSDs of mel-spectrograms of a set of sound clips in the log-domain (red line), along with a linear fit (dotted black line)."/></a>
  <figcaption>The average of RAPSDs of mel-spectrograms of a set of sound clips in the log-domain (red line), along with a linear fit (dotted black line).</figcaption>
</figure>

<p>I found this pretty surprising. I actually used to object quite strongly to the idea of treating spectrograms as images, as in this tweet in response to <a href="https://en.wikipedia.org/wiki/Riffusion">Riffusion</a>, a variant of Stable Diffusion finetuned on spectrograms:</p>

<blockquote><p lang="en" dir="ltr">Me: &#34;NOOO, you can&#39;t just treat spectrograms as images, the frequency and time axes have completely different semantics, there is no locality in frequency and ...&#34;</p>— Sander Dieleman (@sedielem) <a href="https://twitter.com/sedielem/status/1603412454427574279?ref_src=twsrc%5Etfw">December 15, 2022</a></blockquote>


<p>… but I have always had to concede that it seems to work pretty well in practice, and perhaps the fact that spectrograms exhibit power-law spectra is one reason why.</p>

<p>There is also an interesting link with <a href="https://en.wikipedia.org/wiki/Mel-frequency_cepstrum">mel-frequency cepstral coefficients (MFCCs)</a>, a popular feature representation for speech and music processing which predates the advent of deep learning. These features are constructed by taking the <a href="https://en.wikipedia.org/wiki/Discrete_cosine_transform">discrete cosine transform (DCT)</a> of a mel-spectrogram. The resulting spectrum-of-a-spectrum is often referred to as the <strong>cepstrum</strong>.</p>

<p>So with this approach, perhaps the meme applies to sound after all, albeit with a slight adjustment: <strong>diffusion on spectrograms is just cepstral autoregression</strong>.</p>

<h2 id="-unstable-equilibrium"><a name="unstable-equilibrium"></a> Unstable equilibrium</h2>

<figure>
  <a href="https://sander.ai/images/spinningtop.jpg"><img src="https://sander.ai/images/spinningtop.jpg"/></a>
</figure>

<p>So far, we have talked about a spectral perspective on diffusion, but we have not really discussed how it can be used to explain why diffusion works so well for images. The fact that this interpretation is possible for images, but not for some other domains, does not automatically imply that the method should also work better.</p>

<p>However, it does mean that the diffusion loss, which is a weighted average across all noise levels, is also implicitly a weighted average over all spatial frequencies in the image domain. Being able to individually weight these frequencies in the loss according to their relative importance is key, because the sensitivity of the human visual system to particular frequencies varies greatly. <strong>This effectively makes the diffusion training objective a kind of perceptual loss</strong>, and I believe it largely explains the success of diffusion models in the visual domain (together with <a href="https://sander.ai/2023/08/28/geometry.html">classifier-free guidance</a>).</p>

<p>Going beyond images, one could use the same line of reasoning to try and understand why diffusion models <em>haven’t</em> really caught on in the domain of language modelling so far (I wrote more about this <a href="https://sander.ai/2023/01/09/diffusion-language.html">last year</a>). The interpretation in terms of a frequency decomposition is not really applicable there, and hence being able to change the relative weighting of noise levels in the loss doesn’t quite have the same impact on the quality of generated outputs.</p>

<p>For language modelling, autoregression is currently the dominant modelling paradigm, and while diffusion-based approaches have been making inroads recently<sup id="fnref:ratios" role="doc-noteref"><a href="#fn:ratios" rel="footnote">13</a></sup> <sup id="fnref:sahoo" role="doc-noteref"><a href="#fn:sahoo" rel="footnote">14</a></sup> <sup id="fnref:shi" role="doc-noteref"><a href="#fn:shi" rel="footnote">15</a></sup>, a full-on takeover does not look like it is in the cards in the short term.</p>

<p>This results in the following status quo: <strong>we use autoregression for language, and we use diffusion for pretty much everything else</strong>. Of course, I realise that I have just been arguing that these two approaches are not all that different in spirit. But in practice, their implementations can look quite different, and a lot of knowledge and experience that practitioners have built up is specific to each paradigm.</p>

<p>To me, this feels like an <strong>unstable equilibrium, because the future is multimodal</strong>. We will ultimately want models that natively understand language, images, sound and other modalities mixed together. Grafting these two different modelling paradigms together to construct multimodal models is effective to some extent, and certainly interesting from a research perspective, but it brings with it an increased level of complexity (i.e. having to master two different modelling paradigms) which I don’t believe practitioners will tolerate in the long run.</p>

<p>So in the longer term, it seems plausible that we could go back to using autoregression across all modalities, perhaps borrowing some ideas from diffusion in the process<sup id="fnref:var" role="doc-noteref"><a href="#fn:var" rel="footnote">16</a></sup> <sup id="fnref:arnovq" role="doc-noteref"><a href="#fn:arnovq" rel="footnote">17</a></sup>. Alternatively, we might figure out how to build multimodal diffusion models for all modalities, including language. I don’t know which it is going to be, but both of those outcomes ultimately seem more likely than the current situation persisting.</p>

<p>One might ask, if diffusion is really just approximate autoregression in frequency space, why not just do exact autoregression in frequency space instead, and maybe that will work just as well? That would mean we can use autoregression across all modalities, and resolve the “instability” in one go. <a href="https://arxiv.org/abs/2103.03841">Nash et al. (2021)</a><sup id="fnref:dctransformer" role="doc-noteref"><a href="#fn:dctransformer" rel="footnote">18</a></sup>, <a href="https://arxiv.org/abs/2404.02905">Tian et al. (2024)</a><sup id="fnref:var:1" role="doc-noteref"><a href="#fn:var" rel="footnote">16</a></sup> and <a href="https://arxiv.org/abs/2406.19997">Mattar et al. (2024)</a><sup id="fnref:wavelets" role="doc-noteref"><a href="#fn:wavelets" rel="footnote">19</a></sup> explore this direction.</p>

<p>There is a good reason not to take this shortcut, however: the diffusion sampling procedure is exceptionally flexible, in ways that autoregressive sampling is not. For example, the number of sampling steps can be chosen at test time (this isn’t impossible for autoregressive models, but it is much less straightforward to achieve). This flexibility also enables <a href="https://sander.ai/2024/02/28/paradox.html">various distillation methods</a> to reduce the number of steps required, and <a href="https://sander.ai/2023/08/28/geometry.html">classifier-free guidance</a> to improve sample quality. Before we do anything rash and ditch diffusion altogether, we will probably want to figure out a way to avoid having to give up some of these benefits.</p>

<h2 id="-closing-thoughts"><a name="closing-thoughts"></a> Closing thoughts</h2>

<figure>
  <a href="https://sander.ai/images/lake_sunset.jpg"><img src="https://sander.ai/images/lake_sunset.jpg"/></a>
</figure>

<p>When I first had a closer look at the spectra of real images myself, I realised that the link between diffusion models and autoregressive models is even stronger than I had originally thought – in the image domain, at least. This is ultimately why I decided to write this blog post in <a href="https://colab.research.google.com/drive/1siywvhvl1OxI1UmqRrJHiFUK0M5SHlcx">a notebook</a>, to make it easier for others to see this for themselves as well. More broadly speaking, I find that learning by “doing” has a much more lasting effect than learning by reading, and hopefully making this post interactive can help with that.</p>

<p>There are of course many other ways to connect the two modelling paradigms of diffusion and autoregression, which I won’t go into here, but it is becoming a rather popular topic of inquiry<sup id="fnref:rolling" role="doc-noteref"><a href="#fn:rolling" rel="footnote">20</a></sup> <sup id="fnref:fifo" role="doc-noteref"><a href="#fn:fifo" rel="footnote">21</a></sup> <sup id="fnref:forcing" role="doc-noteref"><a href="#fn:forcing" rel="footnote">22</a></sup>.</p>

<p>If you enjoyed this post, I strongly recommend also reading <a href="https://arxiv.org/abs/2206.13397">Rissanen et al. (2022)</a>’s paper on generative modelling with inverse heat dissipation<sup id="fnref:heat:1" role="doc-noteref"><a href="#fn:heat" rel="footnote">4</a></sup>, which inspired it.</p>

<p>This blog-post-in-a-notebook was an experiment, so any feedback on the format is very welcome! It’s a bit more work, but hopefully some readers will derive some benefit from it. If there are enough of you, perhaps I will do more of these in the future. <strong>Please share your thoughts in the comments!</strong></p>

<p>To wrap up, below are some low-effort memes I made when I should have been working on this blog post instead.</p>

<blockquote><p lang="en" dir="ltr">The interpretation of diffusion as autoregression in the frequency domain seems to be stirring up a lot of thought! (I may or may not have a new blog post in the works 🧐) <a href="https://t.co/XSxP27pKSt">pic.twitter.com/XSxP27pKSt</a></p>— Sander Dieleman (@sedielem) <a href="https://twitter.com/sedielem/status/1820233922287919263?ref_src=twsrc%5Etfw">August 4, 2024</a></blockquote>


<blockquote><p lang="en" dir="ltr">It&#39;s so much easier to tweet low-effort memes which assert that diffusion is just autoregression in frequency space, than it is to write a blog post about it 🤷 (but I&#39;m doing both!) <a href="https://t.co/snLQavtZBf">pic.twitter.com/snLQavtZBf</a></p>— Sander Dieleman (@sedielem) <a href="https://twitter.com/sedielem/status/1826728256542052800?ref_src=twsrc%5Etfw">August 22, 2024</a></blockquote>




<p><em>If you would like to cite this post in an academic context, you can use this BibTeX snippet:</em></p>

<div><div><pre><code>@misc{dieleman2024spectral,
  author = {Dieleman, Sander},
  title = {Diffusion is spectral autoregression},
  url = {https://sander.ai/2024/09/02/spectral-autoregression.html},
  year = {2024}
}
</code></pre></div></div>

<h2 id="-acknowledgements"><a name="acknowledgements"></a> Acknowledgements</h2>

<p>Thanks to my colleagues at Google DeepMind for various discussions, which continue to shape my thoughts on this topic! In particular, thanks to Robert Riachi, Ruben Villegas and Daniel Zoran.</p>

<h2 id="-references"><a name="references"></a> References</h2>



      
    </div></div>
  </body>
</html>
