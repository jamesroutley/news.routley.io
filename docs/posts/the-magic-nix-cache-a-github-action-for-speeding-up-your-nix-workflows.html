<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://determinate.systems/posts/magic-nix-cache">Original</a>
    <h1>The Magic Nix Cache, a GitHub Action for speeding up your Nix workflows</h1>
    
    <div id="readability-page-1" class="page"><div data-v-2f4fd870=""><p data-v-5504712b="">We at <a target="_blank" href="https://determinate.systems/" data-v-56a74208="" data-v-20921e01="">Determinate Systems</a> are thrilled to announce the release of the <a target="_blank" href="https://github.com/DeterminateSystems/magic-nix-cache-action" data-v-56a74208="" data-v-20921e01=""><strong data-v-16388f31="">Magic Nix Cache</strong></a>, a <a target="_blank" href="https://github.com/features/actions" data-v-56a74208="" data-v-20921e01="">GitHub Action</a> that can dramatically speed up your <a target="_blank" href="https://zero-to-nix.com" data-v-56a74208="" data-v-20921e01="">Nix</a>-related workflows.
You can use it today—no signup, setup, or cost—by adding just one line to your YAML configuration:</p>
<a id="one-liner"></a>
<div data-lang="yaml"><pre><code><span>-</span> <span>uses</span><span>:</span> DeterminateSystems/magic<span>-</span>nix<span>-</span>cache<span>-</span>action@v1</code></pre></div>
<p data-v-5504712b="">Here&#39;s a more complete example:</p>
<div data-lang="yaml"><pre><code><span>jobs</span><span>:</span>
  <span>build</span><span>:</span>
    <span>steps</span><span>:</span>
      <span>-</span> <span>uses</span><span>:</span> actions/checkout@v3
      <span>-</span> <span>name</span><span>:</span> Install Nix
        <span>uses</span><span>:</span> DeterminateSystems/nix<span>-</span>installer<span>-</span>action@v4
      <span>-</span> <span>name</span><span>:</span> Run the Magic Nix Cache
        <span>uses</span><span>:</span> DeterminateSystems/magic<span>-</span>nix<span>-</span>cache<span>-</span>action@v1
      <span>-</span> <span>name</span><span>:</span> Build server and client
        <span>run</span><span>:</span> <span>|</span><span>
          nix build .#server
          nix build .#client</span></code></pre></div>
<p data-v-5504712b="">We created the Magic Nix Cache in close collaboration with <a target="_blank" href="#kudos-and-thanks" data-v-56a74208="" data-v-20921e01="">Zhaofeng Li</a> and we&#39;re confident that its power and ease of use will provide immediate benefits to the Nix community at large.</p>

<p data-v-5504712b="">We at <a target="_blank" href="https://determinate.systems/" data-v-56a74208="" data-v-20921e01="">Determinate Systems</a> use <a target="_blank" href="https://zero-to-nix.com" data-v-56a74208="" data-v-20921e01="">Nix</a> for all of our <a target="_blank" href="https://github.com/features/actions" data-v-56a74208="" data-v-20921e01="">GitHub Actions</a> builds.
Synchronizing environments <a target="_blank" href="https://determinate.systems/posts/nix-github-actions" data-v-56a74208="" data-v-20921e01="">across dev, prod, and CI</a> is, after all, one of Nix&#39;s major <a target="_blank" href="https://zero-to-nix.com/#features" data-v-56a74208="" data-v-20921e01="">strong points</a>.
But let&#39;s be frank: Nix builds can be quite slow.
Nix always <a target="_blank" href="https://zero-to-nix.com/concepts/realisation" data-v-56a74208="" data-v-20921e01="">realises</a> a <a target="_blank" href="https://zero-to-nix.com/concepts/derivations" data-v-56a74208="" data-v-20921e01="">derivation</a>&#39;s entire dependency tree when it builds something, and that tree can be quite vast.</p>
<p data-v-5504712b="">Fortunately, Nix is extremely good at <a target="_blank" href="https://zero-to-nix.com/concepts/caching" data-v-56a74208="" data-v-20921e01="">caching</a>.
Because everything stored in the <a target="_blank" href="https://zero-to-nix.com/concepts/nix-store" data-v-56a74208="" data-v-20921e01="">Nix store</a> has a <a target="_blank" href="https://zero-to-nix.com/concepts/nix-store#store-paths" data-v-56a74208="" data-v-20921e01="">content-derived hash</a> in the store path, Nix can quickly determine if something needs to be built or if it can be fetched from a known <a target="_blank" href="https://zero-to-nix.com/concepts/caching/#binary-caches" data-v-56a74208="" data-v-20921e01="">binary cache</a> instead.
Caching can cut build times by orders of magnitude (depending on the context).</p>
<p data-v-5504712b="">To reap the benefits of caching in a CI environment like GitHub Actions, you previously needed to either:</p>
<ol>
<li data-v-747113f2="">Run your own binary cache backed by a storage platform like <a target="_blank" href="https://aws.amazon.com/s3" data-v-56a74208="" data-v-20921e01="">Amazon S3</a> or S3-compatible <a target="_blank" href="https://github.com/minio/minio" data-v-56a74208="" data-v-20921e01="">Minio</a>.</li>
<li data-v-747113f2="">Use a dedicated SaaS service like <a target="_blank" href="https://cachix.org" data-v-56a74208="" data-v-20921e01="">Cachix</a>.</li>
</ol>
<p data-v-5504712b="">The Magic Nix Cache provides a new option that doesn&#39;t require you to deploy any new infrastructure or sign up for an external service.</p>
<p data-v-8e9c326e=""><h2 data-v-8e9c326e="">Find out more about how Determinate Systems is transforming the developer experience around Nix</h2></p>

<p data-v-5504712b="">The Magic Nix Cache relies on a daemon called <a target="_blank" href="https://github.com/DeterminateSystems/magic-nix-cache" data-v-56a74208="" data-v-20921e01=""><code>magic-nix-cache</code></a>, which is written in <a target="_blank" href="https://rust-lang.org" data-v-56a74208="" data-v-20921e01="">Rust</a>.
This daemon acts just like a standard <a target="_blank" href="https://zero-to-nix.com/concepts/caching/#binary-caches" data-v-56a74208="" data-v-20921e01="">binary cache server</a> from the standpoint of Nix, but with the important difference that it writes to the <a target="_blank" href="https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows" data-v-56a74208="" data-v-20921e01="">GitHub Actions Cache</a> using the <a target="_blank" href="https://docs.github.com/en/rest/actions/cache" data-v-56a74208="" data-v-20921e01="">Github Actions Cache API</a> instead of writing to disk, as a standard binary cache would.</p>
<p data-v-5504712b="">When you add the Magic Nix Cache to an Actions workflow, here&#39;s what happens:</p>
<ul>
<li data-v-747113f2="">When the Action is triggered, it first downloads and runs the binary for the <code>magic-nix-cache</code> daemon.
The daemon then fetches a list of what&#39;s currently stored in the GitHub Actions Cache.</li>
<li data-v-747113f2="">The rest of your workflow logic, including all of your Nix commands, proceeds.</li>
<li data-v-747113f2="">When the workflow is finished, the <code>magic-nix-cache</code> daemon calculates a list of Nix store paths that haven&#39;t yet been written to the GitHub Actions Cache and writes them.</li>
</ul>
<p data-v-5504712b="">With this approach, the Magic Nix Cache caches <em data-v-d9f05f47="">everything</em> written to the Nix store during your workflow run.
That includes your Nix sources (including bulkier things like revisions of <a target="_blank" href="https://zero-to-nix.com/concepts/nixpkgs" data-v-56a74208="" data-v-20921e01="">Nixpkgs</a>), <a target="_blank" href="https://zero-to-nix.com/concepts/dev-env" data-v-56a74208="" data-v-20921e01="">development environments</a>, all the intermediate dependencies from <code>nix build</code> invocations, <a target="_blank" href="https://docker.com" data-v-56a74208="" data-v-20921e01="">Docker</a> images you build with Nix, and more.
And it does this automatically, without requiring a workflow step of this sort:</p>
<div data-lang="yaml"><pre><code>
<span>-</span> <span>name</span><span>:</span> Cache Nix artifacts
  <span>run</span><span>:</span> ./complex<span>-</span>nix<span>-</span>cache<span>-</span>script.sh</code></pre></div>
<h2 id="security" data-v-41080cce="">Security</h2>
<p data-v-5504712b="">The Magic Nix Cache provides the same <a target="_blank" href="https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows#restrictions-for-accessing-a-cache" data-v-56a74208="" data-v-20921e01="">security guarantees</a> as the <a target="_blank" href="https://docs.github.com/en/rest/actions/cache" data-v-56a74208="" data-v-20921e01="">Actions Cache API</a>, which includes <strong data-v-16388f31="">cache isolation</strong> across different branches and tags.
Concretely, this means that the cache for a project can never be polluted by a malicious pull request because workflow runs never restore caches created for child or sibling branches.
If someone submits a pull request for a branch called <code>uh-oh-bitcoin-miner-incoming</code>, for example, the Magic Nix Cache <em data-v-d9f05f47="">will</em> indeed cache the Nix artifacts for that workflow but nothing from that cache will ever be used by your other branches, including your default branch (such as <code>main</code>).</p>
<h2 id="what-about-rate-limits" data-v-41080cce="">What about rate limits?</h2>
<p data-v-5504712b="">Rate limits are a persistent concern for GitHub Actions users, and many of us have been bitten by workflow runs that fail by inadvertently exceeding those limits.
The Magic Nix Cache <em data-v-d9f05f47="">is</em> subject to the rate limits of the <a target="_blank" href="https://docs.github.com/en/rest/actions/cache" data-v-56a74208="" data-v-20921e01="">Actions Cache API</a> and large projects or builds may run up against those constraints.
If that happens, you&#39;ll see log messages like this:</p>
<div data-lang="log"><pre><code><span>error:</span> unable to download <span>&#39;http://127.0.0.1:37515/&lt;...&gt;&#39;</span><span>:</span> HTTP error <span>418</span>
       <span>response body:</span>
       <span>GitHub API error:</span> <span>API error (429 Too Many Requests):</span> StructuredApiError <span>{</span> message<span>:</span> <span>&#34;Request was blocked due to exceeding usage of resource &#39;Count&#39; in namespace &#39;&#39;.&#34;</span> <span>}</span></code></pre></div>
<p data-v-5504712b="">Fortunately, the Magic Nix Cache handles any rate limiting gracefully.
If your workflow exceeds the limit when it&#39;s pulling Nix dependencies from your Actions cache, Nix will build those dependencies rather than fetching them from the cache.
And if your workflow exceeds the limit when pushing to the cache, the Magic Nix Cache will stop caching and wait for the next workflow run to push those store paths to the cache.</p>
<p data-v-5504712b="">Rate limiting may thus increase build times on specific workflow runs but it will <em data-v-d9f05f47="">not</em> cause your runs to fail.</p>

<p data-v-5504712b="">Because the Magic Nix Cache uses the <a target="_blank" href="https://docs.github.com/en/rest/actions/cache" data-v-56a74208="" data-v-20921e01="">Actions Cache API</a>, the artifacts it caches are availably only to workflow runs for your project.
This means that:</p>
<ul>
<li data-v-747113f2=""><strong data-v-16388f31="">Caches are shared across workflow runs but not across GitHub repos</strong>.
We suspect, however, that any potential speed benefits of cross-project caching would be marginal at best.</li>
<li data-v-747113f2=""><strong data-v-16388f31="">Caches aren&#39;t publicly available</strong>.
If you&#39;d like your Actions workflows to be used by members of your org or Nix users more broadly, you&#39;ll need to push your Nix artifacts to a standard <a target="_blank" href="https://zero-to-nix.com/concepts/caching/#binary-caches" data-v-56a74208="" data-v-20921e01="">binary cache</a>.
But there&#39;s nothing preventing you from using the Magic Nix Cache to speed future up Nix workflow runs <em data-v-d9f05f47="">and</em> pushing to a standard binary cache outside of the Actions environment.</li>
</ul>
<p data-v-5504712b="">These aren&#39;t major drawbacks given the limited scope of the Action but they are worth keeping in mind.</p>

<p data-v-5504712b="">The Magic Nix Cache is a collaborative project with <a target="_blank" href="https://github.com/zhaofengli" data-v-56a74208="" data-v-20921e01="">Zhaofeng Li</a>.
Zhaofeng is a major contributor to the Nix community perhaps best known as the author of two widely used projects:</p>
<ul>
<li data-v-747113f2=""><a target="_blank" href="https://github.com/zhaofengli/attic" data-v-56a74208="" data-v-20921e01="">Attic</a>, a self-hosted, multi-tenant, <a target="_blank" href="https://aws.amazon.com/s3" data-v-56a74208="" data-v-20921e01="">S3</a>-compatible Nix <a target="_blank" href="https://zero-to-nix.com/concepts/caching/#binary-caches" data-v-56a74208="" data-v-20921e01="">binary cache</a></li>
<li data-v-747113f2=""><a target="_blank" href="https://github.com/zhaofengli/colmena" data-v-56a74208="" data-v-20921e01="">Colmena</a>, a <a target="_blank" href="https://github.com/NixOS/nixops" data-v-56a74208="" data-v-20921e01="">NixOps</a>-inspired deployment tool for <a target="_blank" href="https://zero-to-nix.com/concepts/nixos" data-v-56a74208="" data-v-20921e01="">NixOS</a> written in <a target="_blank" href="https://rust-lang.org" data-v-56a74208="" data-v-20921e01="">Rust</a></li>
</ul>
<p data-v-5504712b="">We&#39;d like to express our deep gratitude to Zhaofeng for his tremendous work on this project.
The Magic Nix Cache is part of an already-impressive legacy and we&#39;re beyond eager to see what he contributes to Nix in the coming years.</p>

<p data-v-5504712b="">The Magic Nix Cache provides immediate benefits to your Nix workflows in GitHub Actions with few trade-offs or downsides.
And while it isn&#39;t ideal <a target="_blank" href="#drawbacks" data-v-56a74208="" data-v-20921e01="">for <em data-v-d9f05f47="">all</em> use cases</a>, we&#39;re confident that a wide variety of Nix projects can reduce Nix-related build times in Actions by 30-50% (and in some cases even more) with no configuration changes beyond the <a target="_blank" href="#one-liner" data-v-56a74208="" data-v-20921e01="">single line of YAML</a> shown above.</p>
<p data-v-5504712b="">As with everything we build at <a target="_blank" href="https://determinate.systems/" data-v-56a74208="" data-v-20921e01="">Determinate Systems</a>, we hope that this will provide a dramatically improved experience around using Nix.
Our internal usage of Nix in GitHub Actions has already been radically improved by the Magic Nix Cache, and we&#39;re confident that your experience with it will mirror our own.</p></div></div>
  </body>
</html>
