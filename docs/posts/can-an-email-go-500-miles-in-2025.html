<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://flak.tedunangst.com/post/can-an-email-go-500-miles-in-2025">Original</a>
    <h1>Can an email go 500 miles in 2025?</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>Once upon a time, there was a university president who couldn’t send an email more than 500 miles, and the wise sysadmin said that’s not possible, so the president said come to my office, and lo and behold, the emails stopped before going 500 miles. Has technology improved? Can we send an email farther than 500 miles in 2025?</p><p>There’s a lot to the story that’s obviously made up, but if we fix the details so that it can happen, we can reproduce it.</p><h3 id="connect">connect</h3><p>We need some code to do a nonblocking connect that will timeout quickly. This is mostly copied from the examples in <a href="https://man.openbsd.org/getaddrinfo">getaddrinfo</a> for lookups and connect, and <a href="https://man.openbsd.org/connect">connect</a> for the nonblocking check, adapted slightly to have a very short timeout and report errors.</p><p>The <i>poll</i> timeout is 3ms, as specified by the lore. I think this is nonsense, why would an invalid or incomplete sendmail configuration default to <i>three</i> milliseconds? But that’s the time you get backing a lightspeed delay out of 500 miles. We’ll see if it matters.</p><details><summary>code</summary><pre><code><span>#include &lt;sys/types.h&gt;</span>
<span>#include &lt;sys/socket.h&gt;</span>
<span>#include &lt;sys/select.h&gt;</span>
<span>#include &lt;poll.h&gt;</span>
<span>#include &lt;netdb.h&gt;</span>
<span>#include &lt;err.h&gt;</span>
<span>#include &lt;unistd.h&gt;</span>
<span>#include &lt;string.h&gt;</span>
<span>#include &lt;errno.h&gt;</span>
<span>#include &lt;stdio.h&gt;</span>

<span>int</span>
connect_wait<span>(</span><span>int</span> s<span>)</span>
<span>{</span>
    <span>struct</span> pollfd pfd<span>[</span><span>1</span><span>]</span>;
    <span>int</span> error <span>=</span> <span>0</span>;
    socklen_t len <span>=</span> sizeof<span>(</span>error<span>)</span>;

    pfd<span>[</span><span>0</span><span>]</span><span>.</span>fd <span>=</span> s;
    pfd<span>[</span><span>0</span><span>]</span><span>.</span>events <span>=</span> POLLOUT;

    error <span>=</span> poll<span>(</span>pfd<span>,</span> <span>1</span><span>,</span> <span>3</span><span>)</span>;
    <span>if</span> <span>(</span>error <span>==</span> <span>-</span><span>1</span><span>)</span>
        <span>return</span> <span>-</span><span>1</span>;
    <span>if</span> <span>(</span>error <span>==</span> <span>0</span><span>)</span> <span>{</span>
        errno <span>=</span> ETIMEDOUT;
        <span>return</span> <span>-</span><span>1</span>;
    <span>}</span>
    <span>if</span> <span>(</span>getsockopt<span>(</span>s<span>,</span> SOL_SOCKET<span>,</span> SO_ERROR<span>,</span> &amp;error<span>,</span> &amp;len<span>)</span> <span>==</span> <span>-</span><span>1</span><span>)</span>
        <span>return</span> <span>-</span><span>1</span>;
    <span>if</span> <span>(</span>error <span>!=</span> <span>0</span><span>)</span> <span>{</span>
        errno <span>=</span> error;
        <span>return</span> <span>-</span><span>1</span>;
    <span>}</span>
    <span>return</span> <span>0</span>;
<span>}</span>
<span>int</span>
main<span>(</span><span>int</span> argc<span>,</span> <span>char</span> <span>**</span>argv<span>)</span>
<span>{</span>
    <span>struct</span> addrinfo hints<span>,</span> <span>*</span>res<span>,</span> <span>*</span>res0;
    <span>int</span> error;
    <span>int</span> save_errno;
    <span>int</span> s;

    memset<span>(</span>&amp;hints<span>,</span> <span>0</span><span>,</span> sizeof<span>(</span>hints<span>)</span><span>)</span>;
    hints<span>.</span>ai_family <span>=</span> AF_UNSPEC;
    hints<span>.</span>ai_socktype <span>=</span> SOCK_STREAM;
    error <span>=</span> getaddrinfo<span>(</span>argv<span>[</span><span>1</span><span>]</span> ?<span>:</span> <span>&#34;www.openbsd.org&#34;</span><span>,</span> <span>&#34;www&#34;</span><span>,</span> &amp;hints<span>,</span> &amp;res0<span>)</span>;
    <span>if</span> <span>(</span>error<span>)</span>
        errx<span>(</span><span>1</span><span>,</span> <span>&#34;%s&#34;</span><span>,</span> gai_strerror<span>(</span>error<span>)</span><span>)</span>;
    s <span>=</span> <span>-</span><span>1</span>;
    <span>for</span> <span>(</span>res <span>=</span> res0; res; res <span>=</span> res<span>-&gt;</span>ai_next<span>)</span> <span>{</span>
        s <span>=</span> socket<span>(</span>res<span>-&gt;</span>ai_family<span>,</span> res<span>-&gt;</span>ai_socktype | SOCK_NONBLOCK<span>,</span>
            res<span>-&gt;</span>ai_protocol<span>)</span>;
        <span>if</span> <span>(</span>s <span>==</span> <span>-</span><span>1</span><span>)</span>
            <span>continue</span>;

        error <span>=</span> connect<span>(</span>s<span>,</span> res<span>-&gt;</span>ai_addr<span>,</span> res<span>-&gt;</span>ai_addrlen<span>)</span>;
        <span>if</span> <span>(</span>error <span>==</span> <span>-</span><span>1</span> &amp;&amp; errno <span>==</span> EINPROGRESS<span>)</span>
            error <span>=</span> connect_wait<span>(</span>s<span>)</span>;
        <span>if</span> <span>(</span>error <span>==</span> <span>-</span><span>1</span><span>)</span> <span>{</span>
            warn<span>(</span><span>&#34;connect failure&#34;</span><span>)</span>;
            close<span>(</span>s<span>)</span>;
            s <span>=</span> <span>-</span><span>1</span>;
            <span>continue</span>;
        <span>}</span>
        <span>break</span>;  <span>/* okay we got one */</span>
    <span>}</span>
    <span>if</span> <span>(</span>s <span>==</span> <span>-</span><span>1</span><span>)</span>
        <span>return</span> <span>-</span><span>1</span>;
    printf<span>(</span><span>&#34;it&#39;s a live one!\n&#34;</span><span>)</span>;
    freeaddrinfo<span>(</span>res0<span>)</span>;
<span>}</span></code></pre></details></div><div><p>
Posted 04 Jul 2025 15:49 by tedu Updated: 04 Jul 2025 15:49 
</p></div></div>
  </body>
</html>
