<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://rya.nc/vpp-hack.html">Original</a>
    <h1>Hacking a Virtual Power Plant</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody"><p>I recently had solar panels and a battery storage system from <a href="https://givenergy.co.uk/">GivEnergy</a> installed at my house. A major selling point for me was that they have a local network API which can be used to monitor and control everything without relying on their cloud services. My plan is to set up <a href="https://www.home-assistant.io/">Home Assistant</a> and integrate it with that, but in the meantime, I decided to let it talk to the cloud. I set up some scheduled charging, then started experimenting with the API.</p><p>The next evening, I had control over a <a href="https://en.wikipedia.org/wiki/Virtual_power_plant">virtual power plant</a> comprised of tens of thousands of grid connected batteries.</p><div id="trying-out-the-api"><h2><a href="#trying-out-the-api" rel="bookmark">Trying Out the API</a></h2><p>When I went to generate an API token, I was pleasantly surprised to find options for expiration time and fine-grained control over permissions. I clicked “generate”, and got:</p><div><p><code>eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.<wbr/>eyJhdWQiOiJjMWI4NWFmYS1lMzIyLTQ3NTAtYTQyMi01NDQxYjNkNjgzYzIiLCJqdGkiOiJhZDI5ZTViNDM3OTBkNmZhY2Q2YWRjOGUxMjE0YjI0YzcwYTZhMWE3YzJmZDc5YzRhODBjMmVjNzU4YmViMDNhOGM2ZTE4MWFlMTk3YmU5NyIsImlhdCI6MTcyMDM3ODAxMi4wMjg4NTgsIm5iZiI6MTcyMDM3ODAxMi4wMjg4NjEsImV4cCI6MTcyMDk4MjgxMi4wMTg5NzIsInN1YiI6IjMxMzM3Iiwic2NvcGVzIjpbImFwaSJdfQ.<wbr/>Q8UVWQ__jNd11u6tonBnu75idIwam9vrLXObdkD3R0ynXK30tBW-<wbr/>9MwujEC-<wbr/>NQZFNLuE9riMGrP30VPSFGhTlw</code></p></div><p>From the <code>eyJ</code> prefix, I recognized a base64 encoded JSON object. Upon closer inspection, it turned out to be two JSON objects and some binary data, separated by periods:</p><div><p><code><span>{</span><span>&#34;typ&#34;</span><span>:</span><span>&#34;JWT&#34;</span><span>,</span><span>&#34;alg&#34;</span><span>:</span><span>&#34;RS256&#34;</span><span>}</span></code></p></div><div><p><code><span>{<wbr/></span><span>&#34;<wbr/>aud&#34;<wbr/></span><span>:<wbr/></span><span>&#34;<wbr/>c1b85afa-<wbr/>e322-<wbr/>4750-<wbr/>a422-<wbr/>5441b3d683c2&#34;<wbr/></span><span>,<wbr/></span><span>&#34;<wbr/>jti&#34;<wbr/></span><span>:<wbr/></span><span>&#34;<wbr/>ad29e5b43790d6facd6adc8e1214b24c70a6a1a7c2fd79c4a80c2ec758beb03a8c6e181ae197be97&#34;<wbr/></span><span>,<wbr/></span><span>&#34;<wbr/>iat&#34;<wbr/></span><span>:<wbr/></span><span>1720378012.<wbr/>028858</span><span>,<wbr/></span><span>&#34;<wbr/>nbf&#34;<wbr/></span><span>:<wbr/></span><span>1720378012.<wbr/>028861</span><span>,<wbr/></span><span>&#34;<wbr/>exp&#34;<wbr/></span><span>:<wbr/></span><span>1720982812.<wbr/>018972</span><span>,<wbr/></span><span>&#34;<wbr/>sub&#34;<wbr/></span><span>:<wbr/></span><span>&#34;<wbr/>31337&#34;<wbr/></span><span>,<wbr/></span><span>&#34;<wbr/>scopes&#34;<wbr/></span><span>:<wbr/>[<wbr/></span><span>&#34;<wbr/>api&#34;<wbr/></span><span>]<wbr/>}<wbr/></span></code></p></div><div><table><tbody><tr><td><code><span>00000000</span><span>:</span><span> </span><span>43</span><span> </span><span>c5</span><span> </span><span>15</span><span> </span><span>59</span><span> </span><span>0f</span><span> </span><span>be</span><span> </span><span>8c</span><span> </span><span>d7</span><span> </span><span>75</span><span> </span><span>d6</span><span> </span><span>ee</span><span> </span><span>ad</span><span> </span><span>a2</span><span> </span><span>70</span><span> </span><span>67</span><span> </span><span>bb</span><span>  </span><span>|</span><span>C..Y....u....pg.</span><span>|</span></code></td></tr><tr><td><code><span>00000010</span><span>:</span><span> </span><span>be</span><span> </span><span>62</span><span> </span><span>74</span><span> </span><span>8c</span><span> </span><span>1a</span><span> </span><span>9b</span><span> </span><span>db</span><span> </span><span>eb</span><span> </span><span>2d</span><span> </span><span>73</span><span> </span><span>9b</span><span> </span><span>76</span><span> </span><span>40</span><span> </span><span>f7</span><span> </span><span>47</span><span> </span><span>4c</span><span>  </span><span>|</span><span>.bt.....-s.v@.GL</span><span>|</span></code></td></tr><tr><td><code><span>00000020</span><span>:</span><span> </span><span>a7</span><span> </span><span>5c</span><span> </span><span>ad</span><span> </span><span>f4</span><span> </span><span>b4</span><span> </span><span>15</span><span> </span><span>bf</span><span> </span><span>f4</span><span> </span><span>cc</span><span> </span><span>2e</span><span> </span><span>8c</span><span> </span><span>40</span><span> </span><span>bf</span><span> </span><span>35</span><span> </span><span>06</span><span> </span><span>45</span><span>  </span><span>|</span><span>.\.........@.5.E</span><span>|</span></code></td></tr><tr><td><code><span>00000030</span><span>:</span><span> </span><span>34</span><span> </span><span>bb</span><span> </span><span>84</span><span> </span><span>f6</span><span> </span><span>b8</span><span> </span><span>8c</span><span> </span><span>1a</span><span> </span><span>b3</span><span> </span><span>f7</span><span> </span><span>d1</span><span> </span><span>53</span><span> </span><span>d2</span><span> </span><span>14</span><span> </span><span>68</span><span> </span><span>53</span><span> </span><span>97</span><span>  </span><span>|</span><span>4.........S..hS.</span><span>|</span></code></td></tr></tbody></table></div><p>More precisely, a <a href="https://en.wikipedia.org/wiki/JSON_Web_Token">JSON Web Token</a> (JWT) signed with an RSA+SHA-256.</p><p>In the past, some JWT implementations allowed verification to be bypassed by changing the algorithm to “none”, so I tried that. It didn’t work, which was a relief. That signature though... 64 bytes? At eight bits per byte that’s 512 bits. But that would mean an easily crackable 512 bit RSA key. I hoped this wasn’t as bad as it seemed. Perhaps each account had a different key?</p></div><div id="signing-like-its-1999"><h2><a href="#signing-like-its-1999" rel="bookmark">Signing Like It’s 1999</a></h2><p>The first publicly known <a href="https://www.iacr.org/archive/eurocrypt2000/1807/18070001-new.pdf">factorization of a 512 bit RSA modulus</a> was completed in August of 1999.</p><blockquote><p>[W]e estimate that within three years the algorithmic and computer technology which we used to factor RSA–155 will be widespread […]. This makes these keys useless for authentication or for the protection of data required to be secure for a period longer than a few days.</p><p>—Cavallar et al.</p></blockquote><p>In 2009, several 512 bit RSA signing keys for Texas Instruments graphing calculators were <a href="https://www.theregister.com/2009/09/23/texas_instruments_calculator_hacking/">cracked by hobbyists</a>. The point was further driven home in 2015 by the <a href="https://arstechnica.com/information-technology/2015/10/breaking-512-bit-rsa-with-amazon-ec2-is-a-cinch-so-why-all-the-weak-keys/">factoring as a service</a> paper:</p><blockquote><p>In this paper, we present an improved implementation which is able to factor a 512-bit RSA key on Amazon EC2 in as little as four hours for $75.</p><p>—<a href="https://eprint.iacr.org/2015/1000.pdf">Valenta et al.</a></p></blockquote><p>Despite this, many modern cryptography libraries still support using and even creating the these keys almost a decade later.</p></div><div id="recovering-the-modulus"><h2><a href="#recovering-the-modulus" rel="bookmark">Recovering the Modulus</a></h2><p>With the factors of the JWT private signing key, I could reconstruct the rest of the parameters and produce modified API tokens that should be accepted as valid. I’d factored eBay’s 512 bit <a href="https://en.wikipedia.org/wiki/DomainKeys_Identified_Mail">DKIM</a> key in April of 2012, so I had a pretty good idea of what to do. The problem was, I had nothing to factor. Just some signed data. Maybe I could use that to get what I needed?</p><p><i>Skip the rest of this section if you’re not interested in the math.</i></p><p>RSA needs three values to work, the modulus <span><i>n</i></span>, the private exponent <span><i>d</i></span>, and the public exponent <span><i>e</i></span>. An RSA signature is computed as <span><i>s</i> = <i>m</i><sup><i>d</i></sup> <span>mod</span> <i>n</i></span> — message <span><i>m</i></span> is raised to the power of <span><i>d</i></span> modulo <span><i>n</i></span>. It’s validated by checking that <span><i>s</i><sup><i>e</i></sup> <span>mod</span> <i>n</i> ≡ <i>m</i></span>. With the prime factors of <span><i>n</i></span>, it’s trivial to calculate <span><i>d</i></span>, and for a 512 bit key finding the prime factors is doable, but I didn’t have <span><i>n</i></span> or <span><i>e</i></span>. By convention, <span><i>e</i></span> is nearly always 65537, but I had no idea what <span><i>n</i></span> was. I do, however, know algebra.</p><p>Subtracting <span><i>m</i></span> from both sides of the signature verification equation gives <span><i>s</i><sup><i>e</i></sup> <span>mod</span> <i>n</i> − <i>m</i> ≡ 0</span>. Since modular subtraction is associative, that also means that <span><i>s</i><sup><i>e</i></sup> − <i>m</i> <span>mod</span> <i>n</i> ≡ 0</span>. The modulo operation finds the remainder, so <span><i>s</i><sup><i>e</i></sup> − <i>m</i></span> is an integer multiple of <span><i>n</i></span>. This is not useful on its own, but it means that with another message and signature, I’d have two different integer multiples of <span><i>n</i></span>. Running those through a <a href="https://en.wikipedia.org/wiki/Greatest_common_divisor">GCD</a> algorithm would give me <span><i>n</i> × <i>x</i></span> where <span><i>x</i></span> is a small integer, easily factored out by trial division.</p></div><div id="this-isnt-textbook-rsa"><h2><a href="#this-isnt-textbook-rsa" rel="bookmark">This Isn’t Textbook RSA</a></h2><p>The math above only covers “<a href="https://crypto.stackexchange.com/a/1449/">Textbook RSA</a>” operating on raw numbers, which has a number of problems in practice. It can only operate on numbers smaller than the key’s modulus. The numbers also can’t be too small, otherwise various attacks are possible. To address this, the message is hashed and padded using <a href="https://datatracker.ietf.org/doc/html/rfc2437#section-9.2.1">PKCS #1 v1.5 encoding</a> before being signed. Not wanting to deal with the encoding, I went looking for a pre-existing tool. After a few false starts, I found <a href="https://github.com/FlorianPicca/JWT-Key-Recovery">JWT-Key-Recovery</a>, which quickly provided the modulus.</p></div><div id="cracking-the-key"><h2><a href="#cracking-the-key" rel="bookmark">Cracking the Key</a></h2><p>The modulus is generated by picking large prime numbers, usually denoted <span><i>p</i></span> and <span><i>q</i></span>, and multiplying them together. If you want more detail, please see my previous post, <a href="https://rya.nc/artisanal-rsa.html#a-quick-review-of-rsa-keys">Artisnal RSA</a>. The most efficient known algorithm for factoring the modulus back into primes is called <a href="https://en.wikipedia.org/wiki/General_number_field_sieve">general number field sieve</a> (GNFS). This wasn’t my first time cracking an RSA key, but it’d been a while, so I found <a href="https://y5c4l3.net/2023/08/19/recovering-rsa-key-pair-with-cado-nfs/#recover-key-pair">some instructions</a>. I started <code>cado-nfs</code> on my workstation and let it run overnight. By the time I got done with work the next day, I was feeling impatient and rented a few hundred CPU cores to make it go faster. A few hours and a $70 compute bill later, I had the two prime numbers I needed.</p></div><div id="exploiting-the-vulnerability"><h2><a href="#exploiting-the-vulnerability" rel="bookmark">Exploiting the Vulnerability</a></h2><p>I used <a href="https://rya.nc/artisanal-rsa.html#mprsa-py">my own tool</a> to generate the private key, made a trivial change to my API token, signed it, and made a request. It worked. I still wasn’t sure whether the key was specific to my account, so I needed another to try.</p><p>The easy way would have been to just try a random account id, but that would expose that customer’s personal information, which would be a bit rude to say the least. Poking around a bit, I noticed “View Demo Dashboard” on the login page. That’d do. A few minutes of fiddling with developer tools and I had the account id.</p><p>Changing the API token, I requested “my” account details:</p><div><table><tbody><tr><td><code><span>{</span></code></td></tr><tr><td><code><span>  </span><span>&#34;address&#34;</span><span>:</span><span> </span><span>&#34;Unit C4 Fenton Trade Park&#34;</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;country&#34;</span><span>:</span><span> </span><span>&#34;UNITED_KINGDOM&#34;</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;email&#34;</span><span>:</span><span> </span><span>&#34;████@givenergy.co.uk&#34;</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;first_name&#34;</span><span>:</span><span> </span><span>&#34;Demo&#34;</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;id&#34;</span><span>:</span><span> </span><span>8533</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;name&#34;</span><span>:</span><span> </span><span>&#34;DemoAccount20&#34;</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;postcode&#34;</span><span>:</span><span> </span><span>&#34;ST4 2TE&#34;</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;role&#34;</span><span>:</span><span> </span><span>&#34;VIEWER&#34;</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;standard_timezone&#34;</span><span>:</span><span> </span><span>&#34;Europe/London&#34;</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;surname&#34;</span><span>:</span><span> </span><span>&#34;User&#34;</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;telephone_number&#34;</span><span>:</span><span> </span><span>&#34;███████████&#34;</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;timezone&#34;</span><span>:</span><span> </span><span>&#34;GMT&#34;</span></code></td></tr><tr><td><code><span>}</span></code></td></tr></tbody></table></div><p>The account ids seemed to be sequential, so I could just change that and access any of them. I had another look at the <a href="https://givenergy.cloud/docs/api/v1#account-GETaccount--user_id-">API documentation</a> and saw there were some methods limited to “engineer+”. Plus? I tried setting the account id to “1”, figuring it’d probably be an admin account. Indeed it was, and seemingly subject to no permissions checks, as I could access data for my own system from it.</p><p>All your battery are belong to us.</p></div><div id="the-vendor-response"><h2><a href="#the-vendor-response" rel="bookmark">The Vendor Response</a></h2><p>Just before bed on July 8<sup>th</sup> I sent off an email to their head of security<a href="#id2">[1]</a><a id="id1"></a> politely explaining what I’d done and why it was a problem. I included the following as proof:</p><div><table><tbody><tr><td><code><span>{</span></code></td></tr><tr><td><code><span>  </span><span>&#34;address&#34;</span><span>:</span><span> </span><span>&#34;Unit 1 Osprey House, Brymbo Road&#34;</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;country&#34;</span><span>:</span><span> </span><span>&#34;UNITED_KINGDOM&#34;</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;email&#34;</span><span>:</span><span> </span><span>&#34;███████@givenergy.co.uk&#34;</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;first_name&#34;</span><span>:</span><span> </span><span>&#34;Giv&#34;</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;id&#34;</span><span>:</span><span> </span><span>1</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;name&#34;</span><span>:</span><span> </span><span>&#34;Givenergy01&#34;</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;postcode&#34;</span><span>:</span><span> </span><span>&#34;ST5 9HX&#34;</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;role&#34;</span><span>:</span><span> </span><span>&#34;ADMIN&#34;</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;standard_timezone&#34;</span><span>:</span><span> </span><span>&#34;Europe/London&#34;</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;surname&#34;</span><span>:</span><span> </span><span>&#34;Energy&#34;</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;telephone_number&#34;</span><span>:</span><span> </span><span>&#34;███████████&#34;</span><span>,</span></code></td></tr><tr><td><code><span>  </span><span>&#34;timezone&#34;</span><span>:</span><span> </span><span>&#34;GMT&#34;</span></code></td></tr><tr><td><code><span>}</span></code></td></tr></tbody></table></div><p>A response was waiting for me in the morning, thanking me and making it clear that they were taking it seriously and a fix was their top priority.</p><p>I followed up thanking them for the update, and offering to confirm their fix for them when it was ready.</p><p>Their CTO followed up late that evening, thanking me again and asking if he could take me up on my offer to test their fix. Which was already deployed.</p><p>They did what now? I read the email again. Twice. I did some testing. They’d switch to a 4096 bit RSA key, but not only was I no longer able to mint my own API tokens, the legitimate ones I’d initially generated still worked. Was I dreaming?</p><p>My confirmation led with:</p><blockquote> Wow, this is by far the best vendor response I’ve ever seen.</blockquote><p>Seriously. A+++++ would tell them I pwned their stuff again.</p><p>They’ve posted <a href="https://givenergy.co.uk/real-world-example-givenergy-security-and-cyberthreat-response/">their take</a> on the issue.</p></div><div id="the-bigger-picture"><h2><a href="#the-bigger-picture" rel="bookmark">The Bigger Picture</a></h2><p>Expecting developers to know that 512 bit RSA is insecure clearly doesn’t work. They’re not cryptographers. This is not their job. The failure wasn’t that someone used 512 bit RSA. It was that a library they were relying on <em>let them</em>.</p><p>I’m in favor of task-oriented cryptography libraries which provide tools to solve problems without forcing non-experts to make security decisions.</p><p>Python’s <a href="https://cryptography.io/en/latest/">cryptography</a> library has been working to provide this, as well as the low level stuff for when it’s needed - they call it “hazmat”. It comes with a warning:</p><blockquote> This is a “Hazardous Materials” module. You should <strong>ONLY</strong> use it if you’re 100% absolutely sure that you know what you’re doing because this module is full of land mines, dragons, and dinosaurs with laser guns.</blockquote><p>Support for 512 bit RSA is a land mine, but it’s one that can be defused.</p><p>I’m now working to get major cryptography libraries to drop support for it.</p><p>Python’s cryptography library did so coincidentally in a release a few weeks ago (the <a href="https://github.com/pyca/cryptography/commit/83dcbc190165ad5c1f86bddaee76e0b288803c43">commit</a> was in January).</p><p>I’ve submitted a <a href="https://github.com/openssl/openssl/pull/25094">pull request</a> to OpenSSL.</p><p>Similar changes for Go’s crypto library are now <a href="https://github.com/golang/go/issues/68762">under discussion</a>.</p><p>These changes will take some time to become widely distributed, but eventually people will no longer make this mistake.</p><p><i>This blog post was covered in <a href="https://arstechnica.com/security/2024/08/home-energy-system-gives-researcher-control-of-virtual-power-plant/">Ars Technica</a>.</i></p></div></div></div>
  </body>
</html>
