<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/ringtailsoftware/uvm32">Original</a>
    <h1>Show HN: Tiny VM sandbox in C with apps in Rust, C and Zig</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">uvm32 is a minimalist, dependency-free virtual machine sandbox designed for microcontrollers and other resource-constrained devices. Single C file, no dynamic memory allocations, asynchronous design, pure C99.</p>
<p dir="auto">On an <a href="https://www.st.com/en/microcontrollers-microprocessors/stm32l0-series.html" rel="nofollow">STM32L0</a> (ARM Cortex-M0+) the required footprint is under 4KB flash/1KB RAM.</p>
<p dir="auto">uvm32 is a RISC-V emulator, wrapped in a management interface and provided with tools to build efficient code to run in it.</p>

<ul dir="auto">
<li>As a no-frills alternative to embedded script engines (<a href="https://www.lua.org/" rel="nofollow">Lua</a>, <a href="https://duktape.org/" rel="nofollow">Duktape</a>, <a href="https://micropython.org/" rel="nofollow">MicroPython</a>, etc)</li>
<li>As a <a href="https://en.wikipedia.org/wiki/Write_once,_run_anywhere" rel="nofollow">sandbox</a> to isolate untrusted or unreliable elements of a system</li>
<li>As a way to allow development in modern systems programming languages where a compiler for the target may not be available (<a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/apps/rust-hello">rust-hello</a>)</li>
<li>As a way to <a href="https://en.wikipedia.org/wiki/Write_once,_run_anywhere" rel="nofollow">write once, run anywhere</a> and avoid maintaining multiple software variants</li>
</ul>

<ul dir="auto">
<li>Bytecode example apps written in C, Zig, Rust and assembly</li>
<li>Non-blocking design, preventing misbehaving bytecode from stalling the host</li>
<li>No assumptions about host IO capabilities (no stdio)</li>
<li>Simple, opinionated execution model</li>
<li>Safe minimally typed FFI</li>
<li>Small enough for &#34;if this then that&#34; scripts/plugins, capable enough for <a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/apps/zigdoom">much more</a></li>
<li>Aims for safety over speed, bad code running in the VM should never be able to crash the host</li>
</ul>
<p dir="auto">Although based on a <a href="https://github.com/cnlohr/mini-rv32ima">fully fledged CPU emulator</a>, uvm32 is intended for executing custom script like logic, not for simulating hardware.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">How does it compare to the alternatives?</h2><a id="user-content-how-does-it-compare-to-the-alternatives" aria-label="Permalink: How does it compare to the alternatives?" href="#how-does-it-compare-to-the-alternatives"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Many scripting languages and virtual machines are available for embedding in small systems and they all make tradeoffs in different dimensions.</p>
<p dir="auto">uvm32 aims for:</p>
<ul dir="auto">
<li>Small footprint (suitable for embedded devices, games and apps)</li>
<li>Support well-known programming languages for VM code (with high quality dev tools)</li>
<li>Ease of integration into existing software</li>
<li>Flexibility of paradigm (event driven, polling, multi-processor)</li>
<li>Robustness against misbehaving VM code</li>
</ul>
<p dir="auto">uvm32 does <em>not</em> aim for:</p>
<ul dir="auto">
<li>Frictionless <a href="https://en.wikipedia.org/wiki/Foreign_function_interface" rel="nofollow">FFI</a> (no direct function calls between host and VM code)</li>
<li>Maximum possible efficiency</li>
<li>The simplest scripting experience for VM code (a develop-compile-run cycle is expected)</li>
<li>&#34;Batteries included&#34; libraries to do stdio, networking, etc</li>
</ul>

<p dir="auto">uvm32 is a tiny virtual machine, all of the code is in <a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/uvm32">uvm32</a>.</p>
<p dir="auto">A minimal example of a host to run code in is at <a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/hosts/host-mini">host-mini</a>.</p>
<p dir="auto">Everything else is a more advanced host example, or a sample application which could be run in a host.</p>

<p dir="auto">A simple VM host from <a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/hosts/host-mini">host-mini</a></p>
<div dir="auto" data-snippet-clipboard-copy-content="#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &#34;uvm32.h&#34;
#include &#34;uvm32_common_custom.h&#34;

uint8_t rom[] = { // mandel.bin
  0x23, 0x26, 0x11, 0x00, 0xef, 0x00, 0xc0, 0x00, 0xb7, 0x08, 0x00, 0x01,
  ...
  ...
};

int main(int argc, char *argv[]) {
    uvm32_state_t vmst;
    uvm32_evt_t evt;
    bool isrunning = true;

    uvm32_init(&amp;vmst);
    uvm32_load(&amp;vmst, rom, sizeof(rom));

    while(isrunning) {
        uvm32_run(&amp;vmst, &amp;evt, 100);   // num instructions before vm considered hung

        switch(evt.typ) {
            case UVM32_EVT_END:
                isrunning = false;
            break;
            case UVM32_EVT_SYSCALL:    // vm has paused to handle UVM32_SYSCALL
                switch(evt.data.syscall.code) {
                    case UVM32_SYSCALL_PUTC:
                        printf(&#34;%c&#34;, uvm32_arg_getval(&amp;vmst, &amp;evt, ARG0));
                    break;
                    case UVM32_SYSCALL_PRINTLN: {
                        const char *str = uvm32_arg_getcstr(&amp;vmst, &amp;evt, ARG0);
                        printf(&#34;%s\n&#34;, str);
                    } break;
                    case UVM32_SYSCALL_YIELD:
                    break;
                    default:
                        printf(&#34;Unhandled syscall 0x%08x\n&#34;, evt.data.syscall.code);
                    break;
                }
            break;
            case UVM32_EVT_ERR:
                printf(&#34;UVM32_EVT_ERR &#39;%s&#39; (%d)\n&#34;, evt.data.err.errstr, (int)evt.data.err.errcode);
            break;
            default:
            break;
        }
    }

    return 0;
}"><pre><span>#include</span> <span>&lt;stdio.h&gt;</span>
<span>#include</span> <span>&lt;string.h&gt;</span>
<span>#include</span> <span>&lt;stdlib.h&gt;</span>
<span>#include</span> <span>&#34;uvm32.h&#34;</span>
<span>#include</span> <span>&#34;uvm32_common_custom.h&#34;</span>

<span>uint8_t</span> <span>rom</span>[] <span>=</span> { <span>// mandel.bin</span>
  <span>0x23</span>, <span>0x26</span>, <span>0x11</span>, <span>0x00</span>, <span>0xef</span>, <span>0x00</span>, <span>0xc0</span>, <span>0x00</span>, <span>0xb7</span>, <span>0x08</span>, <span>0x00</span>, <span>0x01</span>,
  ...
  ...
};

<span>int</span> <span>main</span>(<span>int</span> <span>argc</span>, <span>char</span> <span>*</span><span>argv</span>[]) {
    <span>uvm32_state_t</span> <span>vmst</span>;
    <span>uvm32_evt_t</span> <span>evt</span>;
    <span>bool</span> <span>isrunning</span> <span>=</span> true;

    <span>uvm32_init</span>(<span>&amp;</span><span>vmst</span>);
    <span>uvm32_load</span>(<span>&amp;</span><span>vmst</span>, <span>rom</span>, <span>sizeof</span>(<span>rom</span>));

    <span>while</span>(<span>isrunning</span>) {
        <span>uvm32_run</span>(<span>&amp;</span><span>vmst</span>, <span>&amp;</span><span>evt</span>, <span>100</span>);   <span>// num instructions before vm considered hung</span>

        <span>switch</span>(<span>evt</span>.<span>typ</span>) {
            <span>case</span> <span>UVM32_EVT_END</span>:
                <span>isrunning</span> <span>=</span> false;
            <span>break</span>;
            <span>case</span> <span>UVM32_EVT_SYSCALL</span>:    <span>// vm has paused to handle UVM32_SYSCALL</span>
                <span>switch</span>(<span>evt</span>.<span>data</span>.<span>syscall</span>.<span>code</span>) {
                    <span>case</span> <span>UVM32_SYSCALL_PUTC</span>:
                        <span>printf</span>(<span>&#34;%c&#34;</span>, <span>uvm32_arg_getval</span>(<span>&amp;</span><span>vmst</span>, <span>&amp;</span><span>evt</span>, <span>ARG0</span>));
                    <span>break</span>;
                    <span>case</span> <span>UVM32_SYSCALL_PRINTLN</span>: {
                        <span>const</span> <span>char</span> <span>*</span><span>str</span> <span>=</span> <span>uvm32_arg_getcstr</span>(<span>&amp;</span><span>vmst</span>, <span>&amp;</span><span>evt</span>, <span>ARG0</span>);
                        <span>printf</span>(<span>&#34;%s\n&#34;</span>, <span>str</span>);
                    } <span>break</span>;
                    <span>case</span> <span>UVM32_SYSCALL_YIELD</span>:
                    <span>break</span>;
                    <span>default</span>:
                        <span>printf</span>(<span>&#34;Unhandled syscall 0x%08x\n&#34;</span>, <span>evt</span>.<span>data</span>.<span>syscall</span>.<span>code</span>);
                    <span>break</span>;
                }
            <span>break</span>;
            <span>case</span> <span>UVM32_EVT_ERR</span>:
                <span>printf</span>(<span>&#34;UVM32_EVT_ERR &#39;%s&#39; (%d)\n&#34;</span>, <span>evt</span>.<span>data</span>.<span>err</span>.<span>errstr</span>, (<span>int</span>)<span>evt</span>.<span>data</span>.<span>err</span>.<span>errcode</span>);
            <span>break</span>;
            <span>default</span>:
            <span>break</span>;
        }
    }

    <span>return</span> <span>0</span>;
}</pre></div>

<ul dir="auto">
<li>VM hosts
<ul dir="auto">
<li><a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/hosts/host">host</a> vm host which loads a binary and runs to completion, handling multiple syscall types</li>
<li><a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/hosts/host-mini">host-mini</a> minimal vm host (shown above), with baked in bytecode</li>
<li><a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/hosts/host-parallel">host-parallel</a> parallel vm host running multiple vm instances concurrently, with baked in bytecode</li>
<li><a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/hosts/host-arduino">host-arduino</a> vm host as Arduino sketch (<code>make test</code> to run AVR code in qemu)</li>
</ul>
</li>
<li>C sample apps
<ul dir="auto">
<li><a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/apps/helloworld">apps/helloworld</a> C hello world program</li>
<li><a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/apps/heap">apps/heap</a> Demonstration of <code>malloc()</code> on extram in C</li>
<li><a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/apps/conio">apps/conio</a> C console IO demo</li>
<li><a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/apps/lissajous">apps/lissajous</a> C console lissajous curve (showing softfp, floating point)</li>
<li><a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/apps/maze">apps/maze</a> C ASCII art recursive maze generation</li>
<li><a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/apps/fib">apps/fib</a> C fibonacci series program (iterative and recursive)</li>
<li><a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/apps/sketch">apps/sketch</a> C Arduino/Wiring/Processing type program in <code>setup()</code> and <code>loop()</code> style</li>
</ul>
</li>
<li>Rust sample apps
<ul dir="auto">
<li><a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/apps/rust-hello">apps/rust-hello</a> Rust hello world program (note, the version of rust installed by brew on mac has issues, use the official rust installer from <a href="https://rust-lang.org/learn/get-started/" rel="nofollow">https://rust-lang.org/learn/get-started/</a>)</li>
</ul>
</li>
<li>Zig sample apps
<ul dir="auto">
<li><a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/apps/zig-mandel">apps/zig-mandel</a> Zig ASCII mandelbrot generator program</li>
<li><a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/apps/zigtris">apps/zigtris</a> Zig Tetris (<a href="https://github.com/ringtailsoftware/zigtris">https://github.com/ringtailsoftware/zigtris</a>)</li>
<li><a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/apps/zigalloc">apps/zigalloc</a> Demonstration of using extram with zig allocator</li>
<li><a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/apps/zigdoom">apps/zigdoom</a> Port of PureDOOM (making use of Zig to provide an allocator and libc like functions)</li>
</ul>
</li>
<li>Assembly sample apps
<ul dir="auto">
<li><a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/apps/hello-asm">apps/hello-asm</a> Minimal hello world assembly</li>
</ul>
</li>
<li>VM host as an app
<ul dir="auto">
<li><a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/apps/self">apps/self</a> host-mini with embedded mandelbrot generation program, compiled as an app (VM running VM)</li>
</ul>
</li>
</ul>

<p dir="auto">The code in <a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/uvm32">uvm32</a> to build a VM host is very portable and requires only a C compiler. However, many of the examples provided show how to build target code with different languages and tools. A Dockerfile is provided to set up the required environment.</p>
<div data-snippet-clipboard-copy-content="make dockerbuild
make dockershell"><pre><code>make dockerbuild
make dockershell
</code></pre></div>
<p dir="auto">Then, from inside the docker shell</p>
<div data-snippet-clipboard-copy-content="make

./hosts/host/host apps/helloworld/helloworld.bin"><pre><code>make

./hosts/host/host apps/helloworld/helloworld.bin
</code></pre></div>
<p dir="auto"><code>host</code> is the command line test VM for running samples. Run <code>host -h</code> for a full list of options.</p>

<p dir="auto">The best source of information is the header file <a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/uvm32/uvm32.h">uvm32/uvm32.h</a> and the <a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/test">tests</a>.</p>
<p dir="auto">Also see <a href="https://amontalenti.com/ringtailsoftware/uvm32/blob/main/doc/README.md">doc/README.md</a></p>

<p dir="auto">This project is licensed under the MIT License. Feel free to use in research, products and embedded devices.</p>
</article></div></div>
  </body>
</html>
