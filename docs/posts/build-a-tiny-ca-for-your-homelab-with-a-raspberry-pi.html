<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://smallstep.com/blog/build-a-tiny-ca-with-raspberry-pi-yubikey/">Original</a>
    <h1>Build a tiny CA for your homelab with a Raspberry Pi</h1>
    
    <div id="readability-page-1" class="page"><article><time datetime="{updatedAt}">Updated on: <!-- -->January 19, 2025</time><p><img src="https://smallstep.imgix.net/tiny_ca_4ab20bb2d1.png?auto=format%2Ccompress&amp;fit=max&amp;q=50" alt="tiny-ca.png"/></p>
<p><strong>TL;DR</strong> In this tutorial, we&#39;re going to build a tiny, standalone, online Certificate Authority (CA) that will mint TLS certificates and is secured with a YubiKey. It will be an internal ACME server on our local network (ACME is the same protocol used by <a href="https://letsencrypt.org/" target="_blank" rel="nofollow noopener noreferrer">Let&#39;s Encrypt</a>). The YubiKey will securely store the CA private keys and sign certificates, acting as a cheap alternative to a Hardware Security Module (HSM). We&#39;ll also use an open-source True Random Number Generator, called <a href="https://www.crowdsupply.com/13-37/infinite-noise-trng/" target="_blank" rel="nofollow noopener noreferrer">Infinite Noise TRNG</a>, to spice up the Linux entropy pool.</p>

<ul>
<li>Because end-to-end TLS is great and you should easily be able to run TLS wherever you need it. Especially in your homelab. Internal networks are no longer perceived as a safe zone where unencrypted traffic is okay. But you need certificates.</li>
<li>Because TLS client authentication is becoming <a href="https://smallstep.com/hello-mtls" target="_blank" rel="nofollow noopener noreferrer">more widely supported in different services</a>, and it&#39;s a lot better than passwords. But you need certificates.</li>
<li>Because the ACME protocol (used by Let&#39;s Encrypt) can easily be deployed internally, so you can automate renewal and never have to think about your certificates.</li>
<li>Because maybe you&#39;ve done the &#39;self-signed certificate&#39; rigmarole with OpenSSL a dozen times already. Might as well formalize things and get your devices to trust a CA that you can use wherever you need it.</li>
<li>Because setting up a simple CA is a great learning experience.</li>
<li>Still not convinced? Spin up a free hosted homelab CA using our <a href="https://smallstep.com/certificate-manager" target="_blank" rel="nofollow noopener noreferrer">Certificate Manager offering</a> instead.</li>
</ul>
<h3 id="tiny-ca-specs">Tiny CA Specs<a href="#tiny-ca-specs"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<ul>
<li><a href="https://www.adafruit.com/product/4292" target="_blank" rel="nofollow noopener noreferrer">Raspberry Pi 4 Model B 2GB</a> + microSD card</li>
<li>Any YubiKey that supports the <a href="https://developers.yubico.com/yubico-piv-tool/YubiKey_PIV_introduction.html" target="_blank" rel="nofollow noopener noreferrer">Personal Identity Verification (PIV)</a> application, for CA signing operations.
I&#39;m using a <a href="https://www.yubico.com/product/yubikey-5-nfc/" target="_blank" rel="nofollow noopener noreferrer">YubiKey 5 NFC</a>.</li>
<li>Optional: <a href="https://www.crowdsupply.com/13-37/infinite-noise-trng/" target="_blank" rel="nofollow noopener noreferrer">Infinite Noise TRNG</a> for outboard random number generation.</li>
<li>A USB thumb drive—or a second YubiKey—for storing an offline backup of our CA</li>
<li>We&#39;ll be running the <a href="https://github.com/smallstep/certificates" target="_blank" rel="nofollow noopener noreferrer"><code>step-ca</code></a> open-source online Certificate Authority.</li>
<li>Total cost: Around US$100</li>
</ul>
<h2 id="part-1-system-setup">Part 1: System Setup<a href="#part-1-system-setup"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h2>
<h3 id="basic-os--networking-setup">Basic OS &amp; Networking Setup<a href="#basic-os--networking-setup"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<ul>
<li>On your laptop, burn the <a href="https://cdimage.ubuntu.com/releases/22.10/release/" target="_blank" rel="nofollow noopener noreferrer">Ubuntu 22.10 Server</a> <a href="https://cdimage.ubuntu.com/releases/22.10/release/ubuntu-22.10-preinstalled-server-arm64+raspi.img.xz" target="_blank" rel="nofollow noopener noreferrer">64-bit ARM pre-installed server image</a> onto the microSD card using the <a href="https://www.raspberrypi.org/software/" target="_blank" rel="nofollow noopener noreferrer">Raspberry Pi Imager</a>.</li>
<li>Fire up the Raspberry Pi, plug it into your network, and find its initial IP address.
You can run <code>arp -na | grep -e &#34;b8:27:eb&#34; -e &#34;dc:a6:32&#34; -e &#34;e4:5f:01&#34;</code> to discover Raspberry Pi devices on the local network.</li>
<li>Login via SSH (username and password will be <code>ubuntu</code>), and change the password.</li>
<li>Set the hostname via <code>hostnamectl set-hostname tinyca</code></li>
<li>Set the timezone using <code>timedatectl set-timezone America/Los_Angeles</code> (or whatever your timezone is; <code>timedatectl list-timezones</code> will list them all)</li>
<li>Be sure NTP is working. Check status with <code>timedatectl</code>— make sure &#34;NTP Service&#34; is &#34;active&#34;. If not, you can add some NTP servers to <code>/etc/systemd/timesyncd.conf</code> and run <code>systemctl restart systemd-timesyncd</code>.</li>
<li>You&#39;ll need the machine to have a DNS name (for me it&#39;s <code>tinyca.internal</code>) and/or a static IP on your network.</li>
</ul>
<p>Now that you have good time synchronization and a stable hostname, we can proceed.</p>
<h3 id="install-prerequisite-ykman">Install prerequisite: <code>ykman</code><a href="#install-prerequisite-ykman"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<p>Now, insert your YubiKey. Let&#39;s install the <code>yubikey-manager</code> (and dependency <code>pcscd</code>) and make sure you can connect to the YubiKey:</p>
<pre><section><code><pre>$ sudo apt update
$ sudo apt install -y yubikey-manager
$ ykman info
Device type: YubiKey 5 NFC
Serial number: 13910388
Firmware version: 5.2.7
Form factor: Keychain (USB-A)
Enabled USB interfaces: OTP+FIDO+CCID
NFC interface is enabled.
</pre></code></section></pre>
<h3 id="install-prerequisite-go">Install prerequisite: Go<a href="#install-prerequisite-go"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<p>You&#39;ll need Go in order to build the <code>step-ca</code> server.</p>
<pre><section><code><pre>$ cd
$ curl -LO https://go.dev/dl/go1.20.1.linux-arm64.tar.gz
$ sudo tar -C /usr/local -xzf go1.20.1.linux-arm64.tar.gz
$ echo &#34;export PATH=\$PATH:/usr/local/go/bin&#34; &gt;&gt; .profile
$ source .profile
$ go version
go version go1.20.1 linux/arm64
</pre></code></section></pre>
<h3 id="build-and-install-step-ca-and-step">Build and install <code>step-ca</code> and <code>step</code><a href="#build-and-install-step-ca-and-step"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<p>You&#39;ll need to install both <code>step-ca</code> (the CA server software) and <code>step</code> (the command used to configure and control <code>step-ca</code>).</p>
<p>First, download <a href="https://github.com/smallstep/certificates/releases/latest" target="_blank" rel="nofollow noopener noreferrer">the source for <code>step-ca</code></a> and <a href="https://smallstep.com/docs/step-ca/configuration#yubikey" target="_blank" rel="nofollow noopener noreferrer">build it with experimental YubiKey support enabled</a>:</p>
<pre><section><code><pre>$ curl -LO https://github.com/smallstep/certificates/releases/download/v0.23.2/step-ca_0.23.2.tar.gz
$ mkdir step-ca
$ tar -xvzf step-ca_0.23.2.tar.gz -C step-ca
$ cd step-ca
</pre></code></section></pre>
<p>Now build <code>step-ca</code>. This will take some time on a Raspberry Pi, so be patient:</p>
<pre><section><code><pre>$ sudo apt-get install -y libpcsclite-dev gcc make pkg-config
$ make bootstrap
$ make build GOFLAGS=&#34;&#34;
....
Build Complete!
$ sudo cp bin/step-ca /usr/local/bin
$ sudo setcap CAP_NET_BIND_SERVICE=+eip /usr/local/bin/step-ca
$ step-ca version
Smallstep CA/0.23.2 (linux/arm64)
Release Date: 2023-02-16 22:25 UTC
</pre></code></section></pre>
<p>Now <a href="https://github.com/smallstep/cli/releases/latest" target="_blank" rel="nofollow noopener noreferrer">install <code>step</code></a> from a prebuilt binary:</p>
<pre><section><code><pre>$ cd
$ curl -LO https://github.com/smallstep/cli/releases/download/v0.23.2/step_linux_0.23.2_arm64.tar.gz
$ tar xvzf step_linux_0.23.2_arm64.tar.gz
$ sudo cp step_0.23.2/bin/step /usr/local/bin
$ step version
Smallstep CLI/0.23.2 (linux/arm64)
Release Date: 2023-02-07T00:53:54Z
</pre></code></section></pre>
<h3 id="optional-but--set-up-the-outboard-random-number-generator">Optional, but 🔥: Set up the outboard random number generator<a href="#optional-but--set-up-the-outboard-random-number-generator"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<p><a href="https://www.crowdsupply.com/13-37/infinite-noise-trng" target="_blank" rel="nofollow noopener noreferrer">Infinite Noise TRNG</a> is an open-source USB True Random Number Generator. It uses a &#34;modular entropy multiplier&#34; architecture to generate a <em>lot</em> of random data quickly. For this setup, a daemon will continuously feed entropy into Linux&#39;s system entropy pool by writing to <code>/dev/random</code>.</p>
<blockquote>
<p><strong>But will this lovely new entropy generator actually be used by the CA?</strong> I needed to answer two questions here:</p>
<ol>
<li>How does the CA generate random numbers? I had to dig around a little to confirm this. <code>step-ca</code> uses Go&#39;s <code>crypto/rand</code> for all of its key generation, and <code>cyrpto/rand</code> uses <code>/dev/urandom</code> as its random data source on Linux systems.</li>
<li>Does the entropy created via writing to <code>/dev/random</code> actually affects what is read from <code>/dev/urandom</code>? It does—because Linux has only one entropy pool, shared by <code>/dev/random</code> and <code>/dev/urandom</code>.</li>
</ol>
<p>We also need to confirm that the outboard TRNG is actually generating high quality noise. We&#39;ll do that in a minute.
You&#39;ll need to <a href="https://github.com/13-37-org/infnoise/releases" target="_blank" rel="nofollow noopener noreferrer">compile the driver from source</a>, because there&#39;s no pre-built <code>arm64</code> package available.</p>
</blockquote>
<pre><section><code><pre>$ curl -LO https://github.com/leetronics/infnoise/archive/refs/tags/0.3.3.tar.gz
$ tar xvzf 0.3.3.tar.gz
$ cd infnoise-0.3.3/software
$ sudo apt-get install -y libftdi-dev libusb-dev
$ make -f Makefile.linux
$ sudo make -f Makefile.linux install
install -d /usr/local/sbin
install -m 0755 infnoise /usr/local/sbin/
install -d /usr/local/lib/udev/rules.d/
install -m 0644 init_scripts/75-infnoise.rules /usr/local/lib/udev/rules.d/
install -d /usr/local/lib/systemd/system
install -m 0644 init_scripts/infnoise.service /usr/local/lib/systemd/system
$ infnoise --version
GIT VERSION -
GIT COMMIT  -
GIT DATE    -
</pre></code></section></pre>
<p>Now, plug in the TRNG and restart your system.</p>
<pre><section><code><pre>$ sudo reboot
</pre></code></section></pre>
<p>After a restart, you should see that the driver has started up. It will start and stop based on whether the TRNG is present.</p>
<pre><section><code><pre>$ systemctl status infnoise
● infnoise.service - Wayward Geek InfNoise TRNG driver
     Loaded: loaded (/usr/local/lib/systemd/system/infnoise.service; disabled; preset: enabled)
     Active: active (running) since Thu 2023-02-16 14:43:02 PST; 1min 44s ago
    Process: 655 ExecStart=/usr/local/sbin/infnoise --dev-random --daemon --pidfile /var/run/infnoise.pid (code=e&gt;
   Main PID: 661 (infnoise)
      Tasks: 1 (limit: 2082)
     Memory: 700.0K
        CPU: 162ms
     CGroup: /system.slice/infnoise.service
             └─661 /usr/local/sbin/infnoise --dev-random --daemon --pidfile /var/run/infnoise.pid

Feb 16 14:43:02 tinyca systemd[1]: Starting Wayward Geek InfNoise TRNG driver...
Feb 16 14:43:02 tinyca systemd[1]: Started Wayward Geek InfNoise TRNG driver.
</pre></code></section></pre>
<p>Finally, let&#39;s run a health check to make sure the TRNG is ready for use:</p>
<pre><section><code><pre>$ infnoise --debug --no-output
Generated 1048576 bits.  OK to use data.  Estimated entropy per bit: 0.878415, estimated K: 1.838354
num1s:50.466260%, even misfires:0.119403%, odd misfires:0.156459%
^C
</pre></code></section></pre>
<p>Entropy is written to <code>/dev/random</code> by <code>infnoise.service</code> every second. You&#39;re all set on randomness! Now that you have more than enough entropy, you&#39;re ready to generate your CA keys.</p>
<h2 id="part-2-creating-your-pki">Part 2: Creating Your PKI<a href="#part-2-creating-your-pki"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h2>
<p>Now you&#39;ll create your root and intermediate CA certificates and keys, and store them securely on the YubiKey.</p>
<p>Ideally, your Raspberry Pi should be kept offline for this section. Disconnect the Ethernet cable, and connect directly to the device via HDMI and a keyboard.</p>
<h3 id="prepare-a-usb-thumb-drive-for-storing-the-private-keys">Prepare a USB thumb drive for storing the private keys<a href="#prepare-a-usb-thumb-drive-for-storing-the-private-keys"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<p>You can&#39;t just have your CA private keys live <em>only</em> on the YubiKey. You&#39;ll want at least one backup of them, in case the YubiKey breaks!</p>
<p>Insert a USB thumb drive. You&#39;ll generate the keys directly on this drive, so that they never touch the Pi&#39;s microSD card. First, find the device name of your USB drive:</p>
<pre><section><code><pre>$ sudo fdisk -l
...
Disk /dev/sda: 14.91 GiB, 16005464064 bytes, 31260672 sectors
Disk model: Cruzer Fit
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
...
</pre></code></section></pre>
<p>In this case, the drive is <code>/dev/sda</code>. Let&#39;s initialize it with a single <code>ext4</code> partition:</p>
<pre><section><code><pre>$ sudo fdisk /dev/sda
Welcome to fdisk (util-linux 2.36).
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.
Command (m for help): n
Partition type
   p   primary (0 primary, 0 extended, 4 free)
   e   extended (container for logical partitions)
Select (default p): p
Partition number (1-4, default 1):
First sector (2048-31260671, default 2048):
Last sector, +/-sectors or +/-size{K,M,G,T,P} (2048-31260671, default 31260671):
Created a new partition 1 of type &#39;Linux&#39; and of size 14.9 GiB.
Command (m for help): w
The partition table has been altered.
Calling ioctl() to re-read partition table.
Syncing disks.
$ sudo mkfs.ext4 /dev/sda1 -v
mke2fs 1.45.6 (20-Mar-2020)
fs_types for mke2fs.conf resolution: &#39;ext4&#39;
Filesystem label=
OS type: Linux
...
Creating journal (16384 blocks): done
Writing superblocks and filesystem accounting information: done
</pre></code></section></pre>
<h3 id="generate-your-pki-on-the-thumb-drive">Generate your PKI on the thumb drive<a href="#generate-your-pki-on-the-thumb-drive"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<p>Great, now you&#39;re ready to create your Public Key Infrastructure (PKI). Specifically, you&#39;ll be creating CA keys and certificates.</p>
<blockquote>
<p><strong>Tiny CA PKI Highlights</strong>:</p>
<ul>
<li>Tiny CA has a root CA key and certificate, and an intermediate CA key and certificate.</li>
<li>The root CA key signs the Intermediate CA certificate.</li>
<li>The root CA certificate is self-signed (signed with the root CA key)</li>
<li>The intermediate CA key will sign all of your TLS certificates.</li>
<li>By default, <code>step-ca</code> issues certificates with a 24-hour lifetime. I hope this default will compel you to <a href="https://smallstep.com/docs/step-ca/renewal" target="_blank" rel="nofollow noopener noreferrer">set up automated renewal</a> on your clients. And you can always increase the TLS certificate duration in the CA configuration, if you want something a bit more relaxed.</li>
<li>If a device is configured to trust your root CA, it will trust certificates you create with <code>step-ca</code>.</li>
<li>You can throw away the root CA key if you never need another intermediate.</li>
<li>Need a refresher on X.509 certificates? See our post, <a href="https://smallstep.com/blog/everything-pki/" target="_blank" rel="nofollow noopener noreferrer">Everything you should know about certificates and PKI but are too afraid to ask</a>.
Use a strong password when prompted, and save your password separately, offline, somewhere super duper safe.</li>
</ul>
</blockquote>
<pre><section><code><pre>$ sudo mount /dev/sda1 /mnt
$ cd /mnt
$ sudo mkdir ca
$ sudo chown ubuntu:ubuntu ca
$ export STEPPATH=/mnt/ca
$ step ca init --pki --name=&#34;Tiny&#34; --deployment-type standalone
✔ What do you want your password to be? [leave empty and we&#39;ll generate one]: ...
Generating root certificate...
all done!
Generating intermediate certificate...
all done!
✔ Root certificate: /mnt/ca/certs/root_ca.crt
✔ Root private key: /mnt/ca/secrets/root_ca_key
✔ Root fingerprint: d6b3b9ef79a42aeeabcd5580b2b516458ddb25d1af4ea7ff0845e624ec1bb609
✔ Intermediate certificate: /mnt/ca/certs/intermediate_ca.crt
✔ Intermediate private key: /mnt/ca/secrets/intermediate_ca_key
FEEDBACK 😍 🍻
      The step utility is not instrumented for usage statistics. It does not
      phone home. But your feedback is extremely valuable. Any information you
      can provide regarding how you’re using `step` helps. Please send us a
      sentence or two, good or bad: feedback@smallstep.com or join
      https://github.com/smallstep/certificates/discussions.
</pre></code></section></pre>
<p>Don&#39;t forget to give your CA a cute name! It will appear on all of your certificates. Hold onto your root fingerprint, too; you&#39;ll need it to bootstrap your clients later.</p>
<h3 id="import-the-ca-into-the-yubikey">Import the CA into the YubiKey<a href="#import-the-ca-into-the-yubikey"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<p>Now, let&#39;s import our PKI to the YubiKey.</p>
<pre><section><code><pre>$ sudo systemctl enable pcscd
$ sudo systemctl start pcscd
$ ykman piv certificates import 9a /mnt/ca/certs/root_ca.crt
Successfully imported a new certificate.
$ ykman piv keys import 9a /mnt/ca/secrets/root_ca_key
Enter PEM pass phrase: ...
Successfully imported a new private key.
$ ykman piv certificates import 9c /mnt/ca/certs/intermediate_ca.crt
Successfully imported a new certificate.
$ ykman piv keys import 9c /mnt/ca/secrets/intermediate_ca_key
Enter PEM pass phrase: ...
Successfully imported a new private key.
$ ykman piv info
PIV version: 5.2.7
PIN tries remaining: 3
CHUID:	3019d4e739da739ced39ce739d836858210842108421c84210c3eb34104610300df33f7fd273e44f17361ce7c4350832303330303130313e00fe00
CCC: 	No data available.
Slot 9a:
	Algorithm:	ECCP256
	Subject DN:	CN=Tiny CA Root CA
	Issuer DN:	CN=Tiny CA Root CA
	Serial:		280998571002718115143415195266043025218
	Fingerprint:	d6b3b9ef79a42aeeabcd5580b2b516458ddb25d1af4ea7ff0845e624ec1bb609
	Not before:	2020-12-08 20:12:15
	Not after:	2030-12-08 20:12:15
Slot 9c:
	Algorithm:	ECCP256
	Subject DN:	CN=Tiny CA Intermediate CA
	Issuer DN:	CN=Tiny CA Root CA
	Serial:		38398140468675846143165983044297636289
	Fingerprint:	fa21279c114ef44be899cb41e830b920faa6ce2c0ec5bc4f1c9310194e5837d2
	Not before:	2020-12-08 20:12:15
	Not after:	2030-12-08 20:12:15
</pre></code></section></pre>
<p>OK! Now you&#39;ll copy out the CA certificate files, leave the private keys on the USB stick, and continue creating your CA.</p>
<pre><section><code><pre>$ sudo cp /mnt/ca/certs/intermediate_ca.crt /mnt/ca/certs/root_ca.crt /root
$ cd
$ sudo umount /mnt
</pre></code></section></pre>
<p>Finally, reconnect your CA to your local network to continue the setup.</p>
<h2 id="part-3-configuring-your-ca">Part 3: Configuring Your CA<a href="#part-3-configuring-your-ca"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h2>
<p>You&#39;re going to re-run <code>step ca init</code> now, but <em>you&#39;re not going to use the certificates or keys that it generates</em>.
You&#39;re just doing this to create the configuration files.
The password you choose when prompted will be your <em>admin provisioner password</em>.
Anyone with this password will be able to administer your CA and get any certificate from it,
using the <code>step ca certificate</code> subcommand.</p>
<p>Don&#39;t use your root CA password for your provisioner,
but pick something strong and store it somewhere safe.</p>
<pre><section><code><pre>$ sudo useradd step
$ sudo passwd -l step
$ sudo mkdir /etc/step-ca
$ export STEPPATH=/etc/step-ca
$ sudo --preserve-env step ca init --name=&#34;Tiny CA&#34; \
    --dns=&#34;tinyca.internal,10.20.30.42&#34; --address=&#34;:443&#34; \
    --provisioner=&#34;you@example.com&#34; \
    --deployment-type standalone \
    --remote-management
Choose a password for your CA keys and first provisioner.
✔ [leave empty and we&#39;ll generate one]:

Generating root certificate... done!
Generating intermediate certificate... done!

✔ Root certificate: /etc/step-ca/certs/root_ca.crt
✔ Root private key: /etc/step-ca/secrets/root_ca_key
✔ Root fingerprint: 60440dc6ef5b923810b22f85a907f307badb58314c5fdc2231a3c1a892d6c275
✔ Intermediate certificate: /etc/step-ca/certs/intermediate_ca.crt
✔ Intermediate private key: /etc/step-ca/secrets/intermediate_ca_key
✔ Database folder: /etc/step-ca/db
✔ Default configuration: /etc/step-ca/config/defaults.json
✔ Certificate Authority configuration: /etc/step-ca/config/ca.json
✔ Admin provisioner: you@example.com (JWK)
✔ Super admin subject: step

Your PKI is ready to go. To generate certificates for individual services see &#39;step help ca&#39;.
</pre></code></section></pre>
<p>Next, let&#39;s get your certificates in place.</p>
<pre><section><code><pre>$ sudo mv /root/root_ca.crt /root/intermediate_ca.crt /etc/step-ca/certs
$ sudo rm -rf /etc/step-ca/secrets
</pre></code></section></pre>
<p>Next, you&#39;ll need to configure <code>step-ca</code> to use your YubiKey to sign certificates, using the intermediate key on the YubiKey. Notice that the default YubiKey PIN (<code>123456</code>) is shown here, too.</p>
<blockquote>
<p>You should change your YubiKey PIN, PUK, and management key if you haven&#39;t already! <a href="https://developers.yubico.com/PIV/Guides/Device_setup.html" target="_blank" rel="nofollow noopener noreferrer">Learn how in this guide.</a>
Now edit the file <code>/etc/step-ca/config/ca.json</code>. You&#39;ll want the top of the file to look like this:</p>
</blockquote>
<pre><section><code><pre><span>{</span>
        <span>&#34;root&#34;</span><span>:</span> <span>&#34;/etc/step-ca/certs/root_ca.crt&#34;</span><span>,</span>
        <span>&#34;federatedRoots&#34;</span><span>:</span> <span>[</span><span>]</span><span>,</span>
        <span>&#34;crt&#34;</span><span>:</span> <span>&#34;/etc/step-ca/certs/intermediate_ca.crt&#34;</span><span>,</span>
        <span>&#34;key&#34;</span><span>:</span> <span>&#34;yubikey:slot-id=9c&#34;</span><span>,</span>
        <span>&#34;kms&#34;</span><span>:</span> <span>{</span>
            <span>&#34;type&#34;</span><span>:</span> <span>&#34;yubikey&#34;</span><span>,</span>
            <span>&#34;pin&#34;</span><span>:</span> <span>&#34;123456&#34;</span>
        <span>}</span><span>,</span>
        <span>&#34;address&#34;</span><span>:</span> <span>&#34;:443&#34;</span><span>,</span>
...
</pre></code></section></pre>
<p>Now you&#39;ll start up the CA and make sure it&#39;s running properly:</p>
<pre><section><code><pre>$ sudo chown -R step:step /etc/step-ca
$ sudo -u step step-ca /etc/step-ca/config/ca.json
2020/12/08 14:17:06 Serving HTTPS on :443 ...
</pre></code></section></pre>
<p>In another window, you&#39;ll generate a test certificate for localhost.
This is where you&#39;ll need the CA fingerprint, which is displayed when you start up the CA. Run:</p>
<pre><section><code><pre>$ step ca bootstrap --ca-url &#34;https://tinyca.internal&#34; --fingerprint d6b3b9ef79a42aeeabcd5580b2b516458ddb25d1af4ea7ff0845e624ec1bb609
The root certificate has been saved in /home/ubuntu/.step/certs/root_ca.crt.
Your configuration has been saved in /home/ubuntu/.step/config/defaults.json.
$ step ca certificate &#34;localhost&#34; localhost.crt localhost.key
✔ Provisioner: you@example.com (JWK) [kid: izgi9tn1YWbVnY_rmIUKzE-Dn-XIuKz-_J1dnnKeDRA]
✔ Please enter the password to decrypt the provisioner key:
✔ CA: https://tinyca.internal:443
✔ Certificate: localhost.crt
✔ Private Key: localhost.key
$ step certificate inspect localhost.crt --short
X.509v3 TLS Certificate (ECDSA P-256) [Serial: 2903...3061]
  Subject:     localhost
  Issuer:      Tiny Intermediate CA
  Provisioner: you@example.com [ID: izgi...eDRA]
  Valid from:  2023-02-16T23:03:52Z
          to:  2023-02-17T23:04:52Z
</pre></code></section></pre>
<p>Great! You just signed your first X.509 TLS leaf certificate using the YubiKey and <code>step-ca</code>.</p>
<p>When you ask the CA to issue a leaf certificate for a TLS endpoint, you&#39;ll get a certificate file and a (locally-generated) private key file.  The certificate file will contain both the intermediate CA certificate and the leaf certificate you requested. This way, a device which trusts your root CA can verify the chain of trust from the root to the intermediate, and from the intermediate to the leaf.</p>
<p>Finally, you&#39;ll add an ACME provisioner, which will turn your Tiny CA into a tiny Let&#39;s Encrypt!</p>
<pre><section><code><pre>$ step ca provisioner add acme --type acme --admin-name step
No admin credentials found. You must login to execute admin commands.
✔ Provisioner: you@example.com (JWK) [kid: izgi9tn1YWbVnY_rmIUKzE-Dn-XIuKz-_J1dnnKeDRA]
Please enter the password to decrypt the provisioner key:
</pre></code></section></pre>
<p>Sign in with your admin password, and your new new ACME provisioner will be created.</p>
<p>You can now shut down the <code>step-ca</code> process you started in the other terminal window.</p>
<h3 id="configure-systemd-to-start-the-ca">Configure <code>systemd</code> to start the CA<a href="#configure-systemd-to-start-the-ca"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<p>In this section you&#39;ll set up a systemd service for <code>step-ca</code> so it starts when the system starts up.
You&#39;ll also configure systemd to stop the CA when the YubiKey is removed, and restart it when the YubiKey is reinserted.
First, you need to tell <a href="https://wiki.archlinux.org/index.php/Udev" target="_blank" rel="nofollow noopener noreferrer">udev</a> about your YubiKey by adding some udev rules, which will help make the YubiKey visible to systemd as a device.</p>
<pre><section><code><pre>$ sudo tee /etc/udev/rules.d/75-yubikey.rules &gt; /dev/null &lt;&lt; EOF
ACTION==&#34;add&#34;, SUBSYSTEM==&#34;usb&#34;, ENV{PRODUCT}==&#34;1050/407/*&#34;, TAG+=&#34;systemd&#34;, SYMLINK+=&#34;yubikey&#34;
ACTION==&#34;remove&#34;, SUBSYSTEM==&#34;usb&#34;, ENV{PRODUCT}==&#34;1050/407/*&#34;, TAG+=&#34;systemd&#34;
EOF
$ sudo udevadm control --reload-rules
</pre></code></section></pre>
<p>Here, the format of the <code>ENV{PRODUCT}</code> value is <code>{vendorId}/{productId}/*</code>. Yubico&#39;s vendor ID is <code>1050</code>, and <code>407</code> is the product ID for the YubiKey 5 NFC. If you&#39;re using a different YubiKey, <a href="https://devicehunt.com/view/type/usb/vendor/1050" target="_blank" rel="nofollow noopener noreferrer">you can find your model number here</a>.</p>
<p>Now you&#39;ll <a href="https://smallstep.com/docs/step-ca/certificate-authority-server-production#running-step-ca-as-a-daemon" target="_blank" rel="nofollow noopener noreferrer">set up the CA as a systemd service</a> that will:</p>
<ul>
<li>run on system startup, when the YubiKey is inserted</li>
<li>stop when the YubiKey is removed</li>
<li>start again when the YubiKey is reinserted</li>
</ul>
<pre><section><code><pre>$ sudo tee /etc/systemd/system/step-ca.service &gt; /dev/null &lt;&lt; EOF
[Unit]
Description=step-ca
BindsTo=dev-yubikey.device
After=dev-yubikey.device
[Service]
User=step
Group=step
ExecStart=/bin/sh -c &#39;/usr/local/bin/step-ca /etc/step-ca/config/ca.json&#39;
Type=simple
Restart=on-failure
RestartSec=10
[Install]
WantedBy=multi-user.target
EOF
$ sudo mkdir /etc/systemd/system/dev-yubikey.device.wants
$ sudo ln -s /etc/systemd/system/step-ca.service /etc/systemd/system/dev-yubikey.device.wants/
$ sudo systemctl daemon-reload
$ sudo systemctl enable step-ca
</pre></code></section></pre>
<p>Now insert the YubiKey and the service should start:</p>
<pre><section><code><pre>$ sudo systemctl status step-ca
● step-ca.service - step-ca
     Loaded: loaded (/etc/systemd/system/step-ca.service; enabled; vendor preset: enabled)
     Active: active (running) since Tue 2020-12-08 14:27:02 PST; 3s ago
   Main PID: 3269 (sh)
      Tasks: 9 (limit: 2099)
     CGroup: /system.slice/step-ca.service
             ├─3269 /bin/sh -c /usr/local/bin/step-ca /etc/step-ca/config/ca.json
             └─3270 /usr/local/bin/step-ca /etc/step-ca/config/ca.json
Dec 08 14:27:02 tinyca systemd[1]: Started step-ca.
Dec 08 14:27:02 tinyca sh[3270]: 2020/12/08 14:27:02 Serving HTTPS on :443 ...
</pre></code></section></pre>
<p>Now restart your system and ensure that the CA starts up automatically.</p>
<p>Test out removing the YubiKey, and you should see that the CA stops.</p>
<p>Reinsert it, and the CA should start up again.</p>
<h3 id="finally-turn-on-the-firewall-and-disable-ssh-access">Finally, turn on the firewall and disable SSH access<a href="#finally-turn-on-the-firewall-and-disable-ssh-access"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<p>Your tiny CA will be most secure without any SSH access at all. The only open port will be 443, for the CA. For maintenance, you&#39;ll need to plug in a keyboard and a display.</p>
<pre><section><code><pre>$ sudo tee /etc/ufw/applications.d/step-ca-server &gt; /dev/null &lt;&lt; EOF
[step-ca]
title=Smallstep CA
description=step-ca is an online X.509 and SSH Certificate Authority
ports=443/tcp
EOF
$ sudo ufw allow step-ca
$ sudo ufw enable
Command may disrupt existing ssh connections. Proceed with operation (y|n)? y
Firewall is active and enabled on system startup
</pre></code></section></pre>
<h3 id="using-your-ca">Using Your CA<a href="#using-your-ca"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<p>You did it! Your CA is up and running.</p>
<h4 id="bootstrapping-a-new-device-into-your-pki">Bootstrapping a new device into your PKI<a href="#bootstrapping-a-new-device-into-your-pki"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h4>
<p>When you run <a href="https://smallstep.com/docs/step-cli/reference/ca/bootstrap" target="_blank" rel="nofollow noopener noreferrer"><code>step ca bootstrap</code></a> (as above) on a new device,
the root certificate <code>root_ca.crt</code> is downloaded from the CA.
If you run <code>step ca bootstrap --install --ca-url=https://your.ca --fingerprint=your-ca-fingerprint</code>,
it will install the root certificate into your device&#39;s trust store.</p>
<p>You can also use the <code>step</code> command for easy installation of your root CA certificate (<a href="https://smallstep.com/docs/step-cli/reference/certificate/install" target="_blank" rel="nofollow noopener noreferrer"><code>step certificate install</code></a>),
for ACME enrollment (<code>step ca certificate example.com example.crt example.key --provisioner acme</code>)
and for renewal of any certificate that hasn&#39;t yet expired (<code>step ca renew example.crt example.key</code>).</p>
<p>For mobile devices, you can usually install a certificate by sending it to yourself via Bluetooth or AirDrop, or as an email attachment. Make sure the certificate isn&#39;t just installed, but actually trusted by the device. This usually involves a couple of confirmation steps on the device.</p>
<h4 id="use-acme">Use ACME!<a href="#use-acme"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h4>
<p>With the ACME provisioner, you can use software like <a href="https://certbot.eff.org/" target="_blank" rel="nofollow noopener noreferrer">Certbot</a> or <a href="https://go-acme.github.io/lego/usage/cli/" target="_blank" rel="nofollow noopener noreferrer">LEGO CLI</a> to easily get and renew certificates for any endpoint. Our tutorials on <a href="https://smallstep.com/docs/tutorials/acme-challenge" target="_blank" rel="nofollow noopener noreferrer">running a private ACME server</a> and <a href="https://smallstep.com/docs/tutorials/acme-protocol-acme-clients" target="_blank" rel="nofollow noopener noreferrer">configuring popular ACME clients to use a private ACME server</a> will show you how to get ACME certificates from your CA using the most common ACME clients and ACME-supporting services.</p>
<h4 id="automating-certificate-renewal">Automating certificate renewal<a href="#automating-certificate-renewal"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h4>
<p>Because certificates from your CA have a 24-hour lifetime, you&#39;ll want to renew them every 16ish hours.
Our <a href="https://smallstep.com/docs/step-ca/renewal" target="_blank" rel="nofollow noopener noreferrer">renewal documentation</a> has a few options
for setting up renewal on your clients.</p>
<h4 id="further-reading">Further Reading<a href="#further-reading"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h4>
<p>Now that you have an internal CA, here&#39;s a few useful resources:</p>
<ul>
<li>To get more familiar with the <code>step</code> command and how it interfaces with your CA, try out some of the examples in <a href="https://smallstep.com/docs/step-ca/basic-certificate-authority-operations" target="_blank" rel="nofollow noopener noreferrer">Basic Certificate Authority Operations</a>.</li>
<li><a href="https://smallstep.com/hello-mtls" target="_blank" rel="nofollow noopener noreferrer">Hello mTLS</a> shows you how to get mutual TLS authentication configured for several common services and programming languages, using the <code>step</code> command.</li>
<li>There&#39;s also a lot to learn about the different provisioners you can add to your CA to suit your workflows.
See <a href="https://smallstep.com/docs/step-ca/configuration" target="_blank" rel="nofollow noopener noreferrer">Configuring <code>step-ca</code></a>.</li>
<li>Bonus: Want to use SSH certificates?
You can turn your tiny CA into an SSH CA, and use certificates and single sign-on for your SSH hosts.
We have a <a href="https://smallstep.com/blog/diy-single-sign-on-for-ssh/" target="_blank" rel="nofollow noopener noreferrer">blog post</a> and <a href="https://www.youtube.com/watch?v=ZhxLRlcNUM4" target="_blank" rel="nofollow noopener noreferrer">video walk-through</a> that describes how to set it up.</li>
</ul>
<div><p>Carl Tashian (<a href="https://tashian.com">Website</a>, <a href="https://www.linkedin.com/in/tashian/">LinkedIn</a>) is an engineer, writer, exec coach, and startup all-rounder. He&#39;s currently an Offroad Engineer at Smallstep. He co-founded and built the engineering team at Trove, and he wrote the code that opens your Zipcar. He lives in San Francisco with his wife Siobhan and he loves to play the modular synthesizer 🎛️🎚️</p></div></article></div>
  </body>
</html>
