<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/SubscriberLink/923656/b15e2aa9b44ac718/">Original</a>
    <h1>Passwordless authentication with FIDO2–beyond just the web</h1>
    
    <div id="readability-page-1" class="page"><p>

<h2>[LWN subscriber-only content]</h2>
</p><div>
<!-- $Id: slink-none,v 1.2 2005-11-04 22:11:18 corbet Exp $ -->
<blockquote>
<div>
<h3>Welcome to LWN.net</h3>
<p>
The following subscription-only content has been made available to you 
by an LWN subscriber.  Thousands of subscribers depend on LWN for the 
best news from the Linux and free software communities.  If you enjoy this 
article, please consider <a href="https://samgeo.codes/subscribe/">subscribing to LWN</a>.  Thank you
for visiting LWN.net!
</p></div>
</blockquote>

<p><a href="https://fidoalliance.org/fido2/">FIDO2</a> is a standard for
authenticating users without the need for passwords. While the technology has
been introduced mainly to protect accounts on web sites, it&#39;s also useful
for other purposes, such as logging into Linux systems. The same technology
can even be used beyond authentication, for example to sign files or Git
commits. A couple of talks at <a href="https://fosdem.org/2023/">FOSDEM
2023</a> in Brussels presented the possibilities for Linux users. 
</p>

<p>The FIDO2 standard is a joint effort between the <a href="https://fidoalliance.org/">FIDO Alliance</a> (FIDO stands for Fast
Identity Online) and the <a href="https://www.w3.org/">World Wide Web
Consortium</a> (W3C) to develop standards for strong authentication. Users
can securely authenticate themselves with a FIDO2 security key (a hardware
token), which is more convenient, faster, and more secure than traditional
password-based authentication. The security key can ask the user to touch a
button or enter a PIN for authentication; alternatively, it can
include a fingerprint reader or other 
means for biometric authentication. FIDO2 can be used as an extra factor
added to a traditional password as part of multi-factor authentication or
as the only means of authentication. In the latter case, this is called
passwordless authentication. Note that a previous FIDO standard, <a href="https://fidoalliance.org/specs/u2f-specs-master/fido-u2f-overview.html">FIDO
U2F</a>, was primarily designed for two-factor authentication. 
</p>

<p>The FIDO2 standard consists of two parts. <a href="https://www.w3.org/TR/webauthn-1/">Web Authentication</a> (WebAuthn)
is a W3C recommendation with <a href="https://caniuse.com/?search=webauthn">broad browser support</a> that
describes an API allowing web sites to add FIDO2 authentication to
their login pages. FIDO&#39;s <a href="https://fidoalliance.org/specs/fido-v2.1-ps-20210615/fido-client-to-authenticator-protocol-v2.1-ps-errata-20220621.html">Client
to Authenticator Protocol</a> (CTAP) complements WebAuthn by enabling an
external authenticator, such as a security key or a mobile phone, to work
with the browser. So in short: the browser talks WebAuthn to the server and
CTAP to the authenticator device. 
</p>

<p>Both standards are open, and anyone can manufacture FIDO2 security
keys. Various manufacturers have built such hardware tokens. Yubico
has some YubiKey models that <a href="https://www.yubico.com/authentication-standards/fido2/">support
FIDO2</a>, as well as a dedicated FIDO2 
security key. <a href="https://www.ftsafe.com/products/FIDO">Feitian</a>,
<a href="https://shop.nitrokey.com/shop/product/nkfi2-nitrokey-fido2-55">Nitrokey</a>,
<a href="https://solokeys.com/">SoloKeys</a>, and <a href="https://onlykey.io/">OnlyKey</a> offer FIDO2 tokens too. 
</p>

<h4>How FIDO2 works</h4>

<p>FIDO2 is a challenge-response authentication system using asymmetric
encryption. When a user registers with a web site, WebAuthn and CTAP work
together to make the authenticator (usually a security key) create a new
key pair. This is only done after the user proves possession of the
authenticator, for example by pressing a button on the device, scanning a
finger, or entering a PIN. The private key never leaves the device, while
the public key is sent to the web site and associated with the user&#39;s
account there. 
</p>

<p>When logging into the web site, the site sends a challenge and its
origin (such as its domain) to the web browser using the WebAuthn API. The
web browser then sends the challenge to the authenticator using CTAP. The
user again proves possession of the authenticator and the device
generates a response by signing the challenge with its private key. The
response is returned to the web browser (using CTAP) and then to the
web site (using WebAuthn). The web site verifies the response against the
original challenge using the public key that was used to register the
account. 
</p>

<p>The FIDO2 token can store multiple credentials, each of which consists
of a credential
ID, the private key, the user ID, and a relying party ID corresponding to
the web site&#39;s domain. The web site stores the same user ID and credential
ID, as well as the public key. The way FIDO2 works protects users against
phishing. The web browser only accepts WebAuthn calls using <a href="https://www.w3.org/TR/webauthn-2/#rp-id">a relying party ID allowed
from the web site&#39;s domain</a>, and only HTTPS connections are allowed. So
when the authenticator signs the challenge, the browser already knows that it&#39;s
talking to the right web site, because it has verified this
using the web site&#39;s TLS certificate. As a result, the user doesn&#39;t have to
check the domain manually. 
</p>

<h4>Using FIDO2 beyond the web</h4>

<p>Most of the documentation about FIDO2 is  about its use in web
sites as if that&#39;s the only possible use. An example is the unofficial but
helpful <a href="https://webauthn.guide/">WebAuthn Guide</a> made by Duo
Security. However, the specifications can be used 
beyond the web. That was the topic of a <a href="https://fosdem.org/2023/schedule/event/security_fido_beyond/">talk</a>
by Joost van Dijk, a developer advocate at Yubico. 
</p>

<p>Yubico developed <a href="https://github.com/Yubico/libfido2">libfido2</a>, a C library and
corresponding command-line tools to communicate with a FIDO device (not
only the ones made by Yubico) over USB or NFC. It supports the FIDO U2F and
FIDO2 protocols. The project is licensed under the BSD 2-clause license and
supports Linux, macOS, Windows, OpenBSD, and FreeBSD. Some external
projects have built upon libfido2 to create bindings for <a href="https://github.com/borrrden/Fido2Net">.NET</a>, <a href="https://github.com/keys-pub/go-libfido2">Go</a>, <a href="https://github.com/jacquesg/p5-FIDO-Raw">Perl</a>, and <a href="https://github.com/PvdBerg1998/libfido2">Rust</a>. Yubico also
maintains a Python library, <a href="https://github.com/Yubico/python-fido2">python-fido2</a>, that is
tested on 
Linux, macOS, and Windows. 
</p>

<p>One of the projects using libfido2 is <a href="https://github.com/Yubico/pam-u2f">pam-u2f</a>, also developed by
Yubico and included in the repositories of many Linux distributions. It
integrates FIDO2 security keys into <a href="https://github.com/linux-pam/linux-pam">Pluggable Authentication
Modules</a> (PAM), which is the flexible and extensible authentication
framework for 
Linux systems that allows multiple authentication methods to be
used. Requiring a credential on a FIDO2 device for a specific purpose is as
easy as registering a new credential, saving it in a configuration file,
and then adding a reference to <tt>pam_u2f.so</tt> in the PAM
configuration, referring to the file with the saved credential. As an
example, Van Dijk showed how to enable two-factor authentication for sudo
with a FIDO2 token as the second factor. The pam-u2f <a href="https://developers.yubico.com/pam-u2f/">documentation</a> shows some
other examples. 
</p>

<h4>New types of SSH keys</h4>

<p>Another use case Van Dijk described is an SSH key that is backed by a FIDO2
authenticator. <a href="https://samgeo.codes/Articles/812537/">OpenSSH 8.2</a>
(released in February 2020) introduced support for FIDO2 security keys,
using the libfido2 library under the hood. The challenge-response mechanism
works not unlike on the web, but this time the authenticator talks to the
<tt>ssh</tt> client using CTAP, and the <tt>ssh</tt> client talks to the
<tt>sshd</tt> server using the normal SSH protocol. 
</p>

<p>To make this work, OpenSSH introduced new public key types &#34;ecdsa-sk&#34;
and &#34;ed25519-sk&#34;, along with corresponding certificate types. If the user
generates a new SSH key pair of one of those types with
<tt>ssh-keygen</tt>, the private key is generated and stored inside the
hardware token, together with the relying party ID <tt>&#34;ssh:&#34;</tt> and
optionally a key handle. The authenticator returns the public key and the
key handle to <tt>ssh-keygen</tt>. The program saves the public key in a
file as usual, while the file that normally stores the private key now
includes the key handle. 
</p>

<p>Authenticating with this type of key to the SSH server involves a
challenge-response mechanism. The SSH server sends a challenge to the
client, which sends it to the FIDO2 authenticator. The latter signs the
server&#39;s challenge with the private key to create a digital signature that
is sent to the client and then to the server. The SSH server is able to
verify this signature by the corresponding public key known to be
associated to the FIDO2 authenticator. The private key never leaves the
authenticator during this process, even the ssh client doesn&#39;t get access
to it. 
A hardware-backed SSH key may be used like any other key type supported
by OpenSSH, as long as the hardware token is attached when the key is
used. 
</p>

<p>Van Dijk showed some examples of what&#39;s possible with a hardware-backed
SSH key: <a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh">authenticating
to GitHub</a> when cloning a Git repository over SSH, <a href="https://docs.github.com/en/authentication/managing-commit-signature-verification/telling-git-about-your-signing-key#telling-git-about-your-ssh-key">signing
Git commits and tags and verifying their signatures</a>, and signing and
verifying files. 
</p>

<h4>Unlocking LUKS2 volumes with a hardware token</h4>

<p>CTAP also offers the <a href="https://fidoalliance.org/specs/fido-v2.1-ps-20210615/fido-client-to-authenticator-protocol-v2.1-ps-errata-20220621.html#sctn-hmac-secret-extension">hmac-secret</a>
extension, which is supported by most FIDO2 tokens. This is used to retrieve a
secret from the authenticator in order to encrypt or decrypt data. To
prevent offline attacks, part of the secret (the salt) is held 
by the client, while the other part is stored on the authenticator. The
client hands its salt to the authenticator, the device combines the salt
with its own part of the secret using the  HMAC-SHA-256 <a href="https://en.wikipedia.org/wiki/HMAC">hash-based message
authentication</a> (HMAC), and returns the resulting key. Van Dijk showed how to
use this key to encrypt data, after which it&#39;s safe to delete the key. To
decrypt the data later, the client hands the salt back to the
authenticator, which regenerates the key from the salt and its own secret. 
</p>

<p>One application of this hmac-secret extension that Van Dijk demonstrated
is in 
<a href="https://en.wikipedia.org/wiki/Linux_Unified_Key_Setup">Linux
Unified Key Setup</a> (LUKS) disk encryption. Systemd 248 introduced 
support for <a href="https://0pointer.net/blog/unlocking-luks2-volumes-with-tpm2-fido2-pkcs11-security-hardware-on-systemd-248.html">unlocking
LUKS2 volumes with a FIDO2 security key</a>. After <a href="https://www.freedesktop.org/software/systemd/man/systemd-cryptenroll.html">enrolling</a>
a FIDO2 authenticator to a LUKS2 encrypted volume, the <a href="https://www.freedesktop.org/software/systemd/man/systemd-cryptsetup@.service.html">systemd-cryptsetup</a>
component waits for the FIDO2 token to be plugged in at boot, hands it the
salt, gets back the key, and unlocks the volume with the key. 
</p>

<h4>FIDO2 security keys instead of smart cards</h4>

<p>With all this functionality of FIDO2 security keys, one has to wonder
why traditional smart cards or <a href="https://samgeo.codes/Articles/736231/">hardware keys</a> implementing <a href="https://www.openpgp.org/">OpenPGP</a> aren&#39;t enough. These have been
used for a long time to store private keys offline for
encryption, authentication, signing, and verification. Van Dijk considers
that the biggest advantage of FIDO2 security keys is that they are cheaper
and more 
user-friendly.
</p>

<p>Open-source support is also improving a lot in many domains. For
example, at FOSDEM Red Hat&#39;s Alexander Bokovoy gave two talks about his
work on <a href="https://fosdem.org/2023/schedule/event/security_remote_fido/">integrating
FIDO2 in FreeIPA</a> for <a href="https://fosdem.org/2023/schedule/event/passwordless/">passwordless
authentication</a> for  
centrally managed users. Under the hood, this also uses the libfido2
library. His colleague Iker Pedrosa has some <a href="https://ikerexxe.github.io/idm/2022/12/19/passkey-central-auth.html">instructions</a>
on his blog. 
</p>

<p>
With Microsoft, Apple, and Google jumping on the FIDO2
bandwagon during the last few years, surely more and more affordable FIDO2
devices will come to market.  With software support improving as well, it
won&#39;t be long before users start replacing their passwords with cheap FIDO2 
security keys.
</p></div></div>
  </body>
</html>
