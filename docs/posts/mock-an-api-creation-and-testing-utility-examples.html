<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://dhuan.github.io/mock/latest/examples.html">Original</a>
    <h1>Mock – An API creation and testing utility: Examples</h1>
    
    <div id="readability-page-1" class="page"><article role="main" id="furo-main-content">
          <section id="how-tos-examples">

<section id="delaying-specific-endpoints">
<h2>Delaying specific endpoints<a href="#delaying-specific-endpoints" title="Link to this heading">¶</a></h2>
<p>Making an existing API slow can be easily accomplished combining mock’s
<a href="https://dhuan.github.io/mock/latest/base_apis.html#base-api"><span>Base APIs</span></a> and the <a href="https://dhuan.github.io/mock/latest/cmd_reference.html#cmd-options-reference-delay"><span>delay option.</span></a></p>
<div><div><pre><span></span>$<span> </span>mock<span> </span>serve<span> </span>-p<span> </span><span>8000</span><span> </span>--base<span> </span>example.com<span> </span>--delay<span> </span><span>2000</span>
</pre></div>
</div>
<p>You may want however to make a specific endpoint slow instead of the whole API.
This can be achieved using <a href="https://dhuan.github.io/mock/latest/middlewares.html#middlewares"><span>middlewares</span></a>:</p>
<div><div><pre><span></span>$<span> </span>mock<span> </span>serve<span> </span>-p<span> </span><span>8000</span><span> </span>--base<span> </span>example.com<span> </span>--middleware<span> </span><span>&#39;</span>
<span>if [ &#34;${MOCK_REQUEST_ENDPOINT}&#34; = &#34;some/endpoint&#34; ]</span>
<span>then</span>
<span>    sleep 2 # wait two seconds</span>
<span>fi</span>
<span>&#39;</span>
</pre></div>
</div>
<p>With that last example, our API at <code><span>localhost:8000</span></code> will act as a proxy to
<code><span>example.com</span></code>. All requests will be responded immediately except
<code><span>some/endpoint</span></code> which will have a delay of 2 seconds.</p>
</section>
<section id="an-api-powered-by-multiple-languages">
<h2>An API powered by multiple languages<a href="#an-api-powered-by-multiple-languages" title="Link to this heading">¶</a></h2>
<div><div><pre><span></span>$<span> </span>mock<span> </span>serve<span> </span>-p<span> </span><span>3000</span><span> </span><span>\</span>
<span>    </span>--route<span> </span>js<span> </span><span>\</span>
<span>    </span>--exec<span> </span><span>&#39;</span>
<span>node &lt;&lt;EOF | mock write</span>
<span>console.log(&#34;Hello from Node.js!&#34;)</span>
<span>EOF</span>
<span>&#39;</span><span> </span><span>\</span>
<span>    </span>--route<span> </span>python<span> </span><span>\</span>
<span>    </span>--exec<span> </span><span>&#39;</span>
<span>python3 &lt;&lt;EOF | mock write</span>
<span>print(&#34;Hello from Python!&#34;)</span>
<span>EOF</span>
<span>&#39;</span><span> </span><span>\</span>
<span>    </span>--route<span> </span>php<span> </span><span>\</span>
<span>    </span>--exec<span> </span><span>&#39;</span>
<span>php &lt;&lt;EOF | mock write</span>
<span>&lt;?php</span>
<span>echo &#34;Hello from PHP!\n&#34;;</span>
<span>?&gt;</span>
<span>EOF</span>
<span>&#39;</span>
</pre></div>
</div>
<p>Let’s test it:</p>
<div><div><pre><span></span>$<span> </span>curl<span> </span>localhost:3000/js
<span># Prints out: Hello from Node.js!</span>
$<span> </span>curl<span> </span>localhost:3000/python
<span># Prints out: Hello from Python!</span>
$<span> </span>curl<span> </span>localhost:3000/php
<span># Prints out: Hello from PHP!</span>
</pre></div>
</div>
</section>
<section id="a-stateful-api">
<h2>A stateful API<a href="#a-stateful-api" title="Link to this heading">¶</a></h2>
<div><div><pre><span></span>$<span> </span><span>export</span><span> </span><span>TMP</span><span>=</span><span>$(</span>mktemp<span>)</span>
$<span> </span><span>printf</span><span> </span><span>&#34;0&#34;</span><span> </span>&gt;<span> </span><span>&#34;</span><span>${</span><span>TMP</span><span>}</span><span>&#34;</span>

$<span> </span>mock<span> </span>serve<span> </span>-p<span> </span><span>3000</span><span> </span><span>\</span>
<span>    </span>--route<span> </span><span>&#39;/hello&#39;</span><span> </span><span>\</span>
<span>    </span>--exec<span> </span><span>&#39;</span>
<span>printf &#34;%s + 1\n&#34; &#34;$(cat ${TMP})&#34; | bc | sponge &#34;${TMP}&#34;</span>

<span>printf &#34;This server has received %s request(s) so far.&#34; &#34;$(cat &#39;</span><span>&#34;</span><span>${</span><span>TMP</span><span>}</span><span>&#34;</span><span>&#39;)&#34; | mock write</span>
<span>&#39;</span>
</pre></div>
</div>
<p>Let’s test it:</p>
<div><div><pre><span></span>$<span> </span>curl<span> </span>localhost:3000/hello
<span># Prints out: This server has received 1 request(s) so far.</span>
$<span> </span>curl<span> </span>localhost:3000/hello
<span># Prints out: This server has received 2 request(s) so far.</span>
$<span> </span>curl<span> </span>localhost:3000/hello
<span># Prints out: This server has received 3 request(s) so far.</span>
</pre></div>
</div>
</section>
<section id="a-crud-api-with-a-simple-data-storage">
<h2>A CRUD API with a simple data storage<a href="#a-crud-api-with-a-simple-data-storage" title="Link to this heading">¶</a></h2>
<p>The following API does two tasks: add users and fetch users.</p>
<div>
<p>Warning</p>
<p>To run this example, you’ll need to have <a href="https://github.com/jqlang/jq">jq</a> installed, as the “/users”
endpoint uses it for parsing.</p>
</div>
<div><div><pre><span></span>$<span> </span><span>export</span><span> </span><span>DATA_DIR</span><span>=</span><span>$(</span>mktemp<span> </span>-d<span>)</span>

$<span> </span>mock<span> </span>serve<span> </span>-p<span> </span><span>3000</span><span> </span><span>\</span>
<span>    </span>--route<span> </span><span>&#39;user&#39;</span><span> </span><span>\</span>
<span>    </span>--method<span> </span>POST<span> </span><span>\</span>
<span>    </span>--exec<span> </span><span>&#39;</span>
<span># Insert a new user</span>

<span>USER_NAME=$(mock get-payload name)</span>
<span>USER_EMAIL=$(mock get-payload email)</span>
<span>USER_COUNT=$(ls $DATA_DIR | wc -l)</span>
<span>NEW_USER_ID=&#34;$(printf &#34;%s + 1\n&#34; &#34;${USER_COUNT}&#34; | bc)&#34;</span>

<span>printf &#34;New user ID generated: %s\n&#34; &#34;${NEW_USER_ID}&#34;</span>

<span>printf &#39;</span><span>&#34;&#39;&#34;</span><span>&#39;{&#34;name&#34;:&#34;%s&#34;,&#34;email&#34;:&#34;%s&#34;}&#39;</span><span>&#34;&#39;&#34;</span><span>&#39; &#34;${USER_NAME}&#34; &#34;${USER_EMAIL}&#34; &gt; &#34;${DATA_DIR}/${NEW_USER_ID}.json&#34;</span>

<span>printf &#39;</span><span>&#34;&#39;&#34;</span><span>&#39;{&#34;id&#34;:&#34;%s&#34;}&#39;</span><span>&#34;&#39;&#34;</span><span>&#39; &#34;${NEW_USER_ID}&#34; | mock write</span>
<span>&#39;</span><span> </span><span>\</span>
<span>    </span>--route<span> </span><span>&#39;user/{user_id}&#39;</span><span> </span><span>\</span>
<span>    </span>--exec<span> </span><span>&#39;</span>
<span># Get an existing user</span>

<span>USER_ID=&#34;$(mock get-route-param user_id)&#34;</span>
<span>USER_FILE=&#34;${DATA_DIR}/${USER_ID}.json&#34;</span>

<span>if [ ! -f &#34;${USER_FILE}&#34; ]</span>
<span>then</span>
<span>    mock set-status 400</span>

<span>    exit 0</span>
<span>fi</span>

<span>mock write &lt; &#34;${USER_FILE}&#34;</span>
<span>&#39;</span><span> </span><span>\</span>
<span>    </span>--route<span> </span><span>&#39;users&#39;</span><span> </span><span>\</span>
<span>    </span>--exec<span> </span><span>&#39;</span>
<span># Gets ALL users</span>

<span>cat $DATA_DIR/*.json | jq -s | mock write</span>
<span>&#39;</span>
</pre></div>
</div>
<p>Let’s now test it:</p>
<div><div><pre><span></span>$<span> </span>curl<span> </span>-X<span> </span>POST<span> </span>localhost:3000/user<span> </span><span>\</span>
<span>    </span>-H<span> </span><span>&#39;Content-Type: application/json&#39;</span><span> </span><span>\</span>
<span>    </span>-d<span> </span>@-<span> </span><span>&lt;&lt;EOF</span>
<span>{&#34;name&#34;:&#34;John Doe&#34;,&#34;email&#34;:&#34;john.doe@example.com&#34;}</span>
<span>EOF</span>
<span># Prints out: {&#34;id&#34;:&#34;1&#34;}</span>

$<span> </span>curl<span> </span>-X<span> </span>POST<span> </span>localhost:3000/user<span> </span><span>\</span>
<span>    </span>-H<span> </span><span>&#39;Content-Type: application/json&#39;</span><span> </span><span>\</span>
<span>    </span>-d<span> </span>@-<span> </span><span>&lt;&lt;EOF</span>
<span>{&#34;name&#34;:&#34;Jane Doe&#34;,&#34;email&#34;:&#34;jane.doe@example.com&#34;}</span>
<span>EOF</span>
<span># Prints out: {&#34;id&#34;:&#34;2&#34;}</span>

$<span> </span>curl<span> </span>-v<span> </span>localhost:3000/user/1
<span># Prints out: {&#34;name&#34;:&#34;John Doe&#34;,&#34;email&#34;:&#34;john.doe@example.com&#34;}</span>
$<span> </span>curl<span> </span>-v<span> </span>localhost:3000/user/2
<span># Prints out: {&#34;name&#34;:&#34;Jane Doe&#34;,&#34;email&#34;:&#34;jane.doe@example.com&#34;}</span>
$<span> </span>curl<span> </span>-v<span> </span>localhost:3000/users
<span># Prints out: [</span>
<span>#  {&#34;name&#34;:&#34;John Doe&#34;,&#34;email&#34;:&#34;john.doe@example.com&#34;},</span>
<span>#  {&#34;name&#34;:&#34;Jane Doe&#34;,&#34;email&#34;:&#34;jane.doe@example.com&#34;}</span>
<span># ]</span>
</pre></div>
</div>
</section>
</section>

        </article></div>
  </body>
</html>
