<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.packagecloud.io/set-environment-variable-save-thousands-of-system-calls/">Original</a>
    <h1>Setting the TZ environment variable avoids thousands of system calls (2017)</h1>
    
    <div id="readability-page-1" class="page"><div>
          
          
 <h2 id="tldr">TL;DR</h2>
<p>This blog post explains how setting an environment variable can save thousands (or in some cases, tens of thousands) of unnecessary system calls that can be generated by glibc over small periods of time.</p>
<p>This has been tested on Ubuntu Precise (12.04) and Ubuntu Xenial (16.04). It likely applies to other flavors of Linux, as well. It is very easy to test if this applies to you and to correct it, if so. Keep reading for more details!</p>

<h2 id="quick-summary">Quick summary</h2>
<p>To avoid extra system calls on server processes where you won’t be updating the timezone (or can restart processes when you do) simply set the<span> </span><code>TZ</code><span> </span>environment variable to<span> </span><code>:/etc/localtime</code><span> </span>(or some other timezone file of your choice) for a process. This will cause glibc to avoid making extra (and unnecessary) system calls.</p>
<p>To understand why this is and how to test if your processes can benefit, read on!</p>

<h2 id="the-problem">The problem</h2>
<p>In our previous blog post about<span> </span><a href="https://packagecloud.io/blog/the-definitive-guide-to-linux-system-calls/">Linux system calls</a>, we explained the different system call methods and highlighted a very interesting method in particular: the<span> </span><a href="https://packagecloud.io/blog/the-definitive-guide-to-linux-system-calls/#virtual-system-calls">vDSO system call method</a>.</p>
<p>The purpose of the vDSO system call method was to create a way for certain, very frequently used system calls (like<span> </span><code>gettimeofday</code>,<span> </span><code>time</code>,<span> </span><code>clock_gettime</code>, etc) to avoid needing to actually enter the kernel and cause a context switch from user land to kernel land. The result of this method is that certain system calls, like those listed, can be used by programs at much, much lower cost.</p>
<p>What would happen if every time you called one of these fast vDSO system calls (like<span> </span><code>time</code>) you also called a normal system call like, say<span> </span><code>stat</code>, which does not pass through the vDSO?</p>
<p>If you did that, you’d essentially be negating some of the performance improvement you were meant to gain by the vDSO optimization in the first place; you’d be making a slow system call very often.</p>
<p>It turns out that this situation happens rather often with a pair of functions that are commonly used together:</p>
<ul>
<li><code>time</code>: A vDSO-enabled system call used to obtain the number of seconds since the epoch, and</li>
<li><code>localtime</code>: A glibc provided function which converts the output of<span> </span><code>time</code><span> </span>to a local time in the user’s timezone. This is not a system call, but internally<span> </span><code>localtime</code><span> </span>can make a system call in some cases.</li>
</ul>
<p>The<span> </span><code>time</code><span> </span>vDSO-enabled system call and the<span> </span><code>localtime</code><span> </span>function from glibc are often used together in applications either directly by the programmer, or at a lower level unbeknownst to the programmer for formatting dates and times for everything from log messages to SQL queries. This pair is commonly used in Ruby on Rails.</p>
<p>It turns out that the<span> </span><code>localtime</code><span> </span>function in glibc will check if the<span> </span><code>TZ</code><span> </span>environment variable is set. If it is not set (the two Ubuntus I’ve tested do not set it), then glibc will use the<span> </span><code>stat</code><span> </span>system call<span> </span><em>every time<span> </span><code>localtime</code><span> </span>is called</em>.</p>
<p>In other words: your system supports calling the<span> </span><code>time</code><span> </span>system call via the Linux kernel’s vDSO to avoid the cost of switching to the kernel. But, as soon as your program calls<span> </span><code>time</code>, it calls<span> </span><code>localtime</code><span> </span>immediately after, which invokes a system call anyway. So, you’ve eliminated one system call with the vDSO, but replaced it with another.</p>
<p>Let’s see a sample program that shows this behavior, how to use<span> </span><code>strace</code><span> </span>to detect this, and finally how to prevent it by setting the<span> </span><code>TZ</code><span> </span>environment variable.</p>

<h3 id="sample-program-showing-the-issue">Sample program showing the issue</h3>
<p>Let’s start by creating a simple test program that reproduces this issue:</p>
<figure>
<pre><span>#include &lt;time.h&gt;
#include &lt;stdio.h&gt;
</span>
<span>int</span>
<span>main</span><span>(</span><span>int</span> <span>argc</span><span>,</span> <span>char</span> <span>*</span><span>argv</span><span>[])</span> <span>{</span>
  <span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span>
  <span>time_t</span> <span>timep</span><span>;</span>

  <span>printf</span><span>(</span><span>&#34;Greetings!</span><span>\n</span><span>&#34;</span><span>);</span>

  <span>for</span><span>(</span><span>i</span><span>=</span><span>0</span><span>;</span> <span>i</span><span>&lt;</span><span>10</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>{</span>
    <span>time</span><span>(</span><span>&amp;</span><span>timep</span><span>);</span>
    <span>localtime</span><span>(</span><span>&amp;</span><span>timep</span><span>);</span>
  <span>}</span>

  <span>printf</span><span>(</span><span>&#34;Godspeed, dear friend!</span><span>\n</span><span>&#34;</span><span>);</span>
  <span>return</span> <span>0</span><span>;</span>
<span>}</span></pre>
</figure>
<p>You can compile this program by simply running<span> </span><code>gcc -o test test.c</code>. As you can see, this program simply calls<span> </span><code>time</code><span> </span>and<span> </span><code>localtime</code><span> </span>in a loop 10 times.</p>

<h3 id="verifying-this-with-strace">Verifying this with<span> </span><code>strace</code></h3>
<p>Every single call to the<span> </span><code>localtime</code><span> </span>glibc function will generate a system call to<span> </span><code>stat</code>. Don’t believe me? Let’s use<span> </span><code>strace</code><span> </span>to prove it using the program shown above:</p>
<figure>
<pre><span>$ </span>gcc <span>-o</span> <span>test </span>test.c
<span>$ </span>strace <span>-ttT</span> ./test
... truncated output ...
23:55:16.957457 write<span>(</span>1, <span>&#34;Greetings!</span><span>\n</span><span>&#34;</span>, 11<span>)</span> <span>=</span> 11 &lt;0.000033&gt;
23:55:16.957560 open<span>(</span><span>&#34;/etc/localtime&#34;</span>, O_RDONLY|O_CLOEXEC<span>)</span> <span>=</span> 3 &lt;0.000013&gt;
23:55:16.957650 fstat<span>(</span>3, <span>{</span><span>st_mode</span><span>=</span>S_IFREG|0644, <span>st_size</span><span>=</span>127, ...<span>})</span> <span>=</span> 0 &lt;0.000007&gt;
23:55:16.957723 fstat<span>(</span>3, <span>{</span><span>st_mode</span><span>=</span>S_IFREG|0644, <span>st_size</span><span>=</span>127, ...<span>})</span> <span>=</span> 0 &lt;0.000006&gt;
23:55:16.957797 <span>read</span><span>(</span>3, <span>&#34;TZif2</span><span>\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\1\0\0\0\1\0\0\0\0</span><span>&#34;</span>..., 4096<span>)</span> <span>=</span> 127 &lt;0.000011&gt;
23:55:16.957904 lseek<span>(</span>3, <span>-71</span>, SEEK_CUR<span>)</span> <span>=</span> 56 &lt;0.000008&gt;
23:55:16.957975 <span>read</span><span>(</span>3, <span>&#34;TZif2</span><span>\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\1\0\0\0\1\0\0\0\0</span><span>&#34;</span>..., 4096<span>)</span> <span>=</span> 71 &lt;0.000008&gt;
23:55:16.958048 close<span>(</span>3<span>)</span>                <span>=</span> 0 &lt;0.000009&gt;
23:55:16.958130 <span>stat</span><span>(</span><span>&#34;/etc/localtime&#34;</span>, <span>{</span><span>st_mode</span><span>=</span>S_IFREG|0644, <span>st_size</span><span>=</span>127, ...<span>})</span> <span>=</span> 0 &lt;0.000009&gt;
23:55:16.958215 <span>stat</span><span>(</span><span>&#34;/etc/localtime&#34;</span>, <span>{</span><span>st_mode</span><span>=</span>S_IFREG|0644, <span>st_size</span><span>=</span>127, ...<span>})</span> <span>=</span> 0 &lt;0.000009&gt;
23:55:16.958296 <span>stat</span><span>(</span><span>&#34;/etc/localtime&#34;</span>, <span>{</span><span>st_mode</span><span>=</span>S_IFREG|0644, <span>st_size</span><span>=</span>127, ...<span>})</span> <span>=</span> 0 &lt;0.000010&gt;
23:55:16.958375 <span>stat</span><span>(</span><span>&#34;/etc/localtime&#34;</span>, <span>{</span><span>st_mode</span><span>=</span>S_IFREG|0644, <span>st_size</span><span>=</span>127, ...<span>})</span> <span>=</span> 0 &lt;0.000009&gt;
23:55:16.958454 <span>stat</span><span>(</span><span>&#34;/etc/localtime&#34;</span>, <span>{</span><span>st_mode</span><span>=</span>S_IFREG|0644, <span>st_size</span><span>=</span>127, ...<span>})</span> <span>=</span> 0 &lt;0.000009&gt;
23:55:16.958533 <span>stat</span><span>(</span><span>&#34;/etc/localtime&#34;</span>, <span>{</span><span>st_mode</span><span>=</span>S_IFREG|0644, <span>st_size</span><span>=</span>127, ...<span>})</span> <span>=</span> 0 &lt;0.000009&gt;
23:55:16.958611 <span>stat</span><span>(</span><span>&#34;/etc/localtime&#34;</span>, <span>{</span><span>st_mode</span><span>=</span>S_IFREG|0644, <span>st_size</span><span>=</span>127, ...<span>})</span> <span>=</span> 0 &lt;0.000009&gt;
23:55:16.958690 <span>stat</span><span>(</span><span>&#34;/etc/localtime&#34;</span>, <span>{</span><span>st_mode</span><span>=</span>S_IFREG|0644, <span>st_size</span><span>=</span>127, ...<span>})</span> <span>=</span> 0 &lt;0.000009&gt;
23:55:16.958769 <span>stat</span><span>(</span><span>&#34;/etc/localtime&#34;</span>, <span>{</span><span>st_mode</span><span>=</span>S_IFREG|0644, <span>st_size</span><span>=</span>127, ...<span>})</span> <span>=</span> 0 &lt;0.000009&gt;
23:55:16.958848 write<span>(</span>1, <span>&#34;Godspeed, dear friend!</span><span>\n</span><span>&#34;</span>, 23<span>)</span> <span>=</span> 23 &lt;0.000020&gt;</pre>
</figure>
<p>In the<span> </span><code>strace</code><span> </span>output above we see a few things:</p>
<ol>
<li>The<span> </span><code>/etc/localtime</code><span> </span>file is opened.</li>
<li><code>fstat</code><span> </span>is called twice, followed by two reads to the file to pull in the timezone data.</li>
<li>Next, 9 calls to<span> </span><code>stat</code><span> </span>are made passing<span> </span><code>/etc/localtime</code><span> </span>over and over.</li>
</ol>
<p>Notice that the<span> </span><code>strace</code><span> </span>output does not show the call to<span> </span><code>time</code>. This is expected. System calls made via the vDSO do not appear in<span> </span><code>strace</code><span> </span>output. To see them, you’d need to use<span> </span><code>ltrace</code><span> </span>instead.</p>
<p>What’s going on here is that the first call to<span> </span><code>localtime</code><span> </span>in glibc opens and reads the contents of<span> </span><code>/etc/localtime</code>. All subsequent calls to<span> </span><code>localtime</code><span> </span>internally call<span> </span><code>stat</code>, but they do this to ensure that the timezone file has not changed.</p>
<p>On many systems<span> </span><code>/etc/localtime</code><span> </span>is a symlink to a timezone file. It is conceivable that a program might be running when the<span> </span><code>/etc/localtime</code><span> </span>symlink is updated. If this were to happen, glibc would notice this when<span> </span><code>localtime</code><span> </span>is called and re-read the file before doing any time conversions.</p>


<p>Many production systems use the UTC timezone and don’t ever need (or want) to change that. For this use case, there’s no reason to<span> </span><code>stat</code><span> </span>the<span> </span><code>/etc/localtime</code><span> </span>file or symlink over and over and over when<span> </span><code>localtime</code><span> </span>is called. The timezone is never going to change from UTC (or if it does, the application can just be restarted).</p>
<p>The easiest way to prevent these<span> </span><code>stat</code><span> </span>calls is to set the<span> </span><code>TZ</code><span> </span>environment variable. When the<span> </span><code>TZ</code><span> </span>environment variable is set glibc will:</p>
<ol>
<li>Notice you’ve told it explicitly what timezone file to use for your program.</li>
<li>Read the file and cache it internally.</li>
<li>Never<span> </span><code>stat</code><span> </span>or<span> </span><code>read</code><span> </span>that file path again, as long as the value of the<span> </span><code>TZ</code><span> </span>environment variable is left unchanged.</li>
</ol>
<p>Let’s set the<span> </span><code>TZ</code><span> </span>variable and check with<span> </span><code>strace</code>:</p>
<figure>
<pre><span>$</span> <span>TZ</span><span>=:/</span><span>etc</span><span>/</span><span>localtime</span> <span>strace</span> <span>-</span><span>ttT</span> <span>.</span><span>/</span><span>test</span>
<span>00</span><span>:</span><span>14</span><span>:</span><span>53</span><span>.</span><span>274564</span> <span>write</span><span>(</span><span>1</span><span>,</span> <span>&#34;Greetings!</span><span>\n</span><span>&#34;</span><span>,</span> <span>11</span><span>)</span> <span>=</span> <span>11</span> <span>&lt;</span><span>0</span><span>.</span><span>000051</span><span>&gt;</span>
<span>00</span><span>:</span><span>14</span><span>:</span><span>53</span><span>.</span><span>274721</span> <span>open</span><span>(</span><span>&#34;/etc/localtime&#34;</span><span>,</span> <span>O_RDONLY</span><span>|</span><span>O_CLOEXEC</span><span>)</span> <span>=</span> <span>3</span> <span>&lt;</span><span>0</span><span>.</span><span>00003</span><span>8</span><span>&gt;</span>
<span>00</span><span>:</span><span>14</span><span>:</span><span>53</span><span>.</span><span>274873</span> <span>fstat</span><span>(</span><span>3</span><span>,</span> <span>{</span><span>st_mode</span><span>=</span><span>S_IFREG</span><span>|</span><span>0644</span><span>,</span> <span>st_size</span><span>=</span><span>127</span><span>,</span> <span>...})</span> <span>=</span> <span>0</span> <span>&lt;</span><span>0</span><span>.</span><span>000026</span><span>&gt;</span>
<span>00</span><span>:</span><span>14</span><span>:</span><span>53</span><span>.</span><span>275001</span> <span>fstat</span><span>(</span><span>3</span><span>,</span> <span>{</span><span>st_mode</span><span>=</span><span>S_IFREG</span><span>|</span><span>0644</span><span>,</span> <span>st_size</span><span>=</span><span>127</span><span>,</span> <span>...})</span> <span>=</span> <span>0</span> <span>&lt;</span><span>0</span><span>.</span><span>000026</span><span>&gt;</span>
<span>00</span><span>:</span><span>14</span><span>:</span><span>53</span><span>.</span><span>275129</span> <span>read</span><span>(</span><span>3</span><span>,</span> <span>&#34;TZif2</span><span>\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\1\0\0\0\1\0\0\0\0</span><span>&#34;</span><span>...,</span> <span>4096</span><span>)</span> <span>=</span> <span>127</span> <span>&lt;</span><span>0</span><span>.</span><span>00002</span><span>8</span><span>&gt;</span>
<span>00</span><span>:</span><span>14</span><span>:</span><span>53</span><span>.</span><span>275257</span> <span>lseek</span><span>(</span><span>3</span><span>,</span> <span>-</span><span>71</span><span>,</span> <span>SEEK_CUR</span><span>)</span> <span>=</span> <span>56</span> <span>&lt;</span><span>0</span><span>.</span><span>000027</span><span>&gt;</span>
<span>00</span><span>:</span><span>14</span><span>:</span><span>53</span><span>.</span><span>275379</span> <span>read</span><span>(</span><span>3</span><span>,</span> <span>&#34;TZif2</span><span>\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\1\0\0\0\1\0\0\0\0</span><span>&#34;</span><span>...,</span> <span>4096</span><span>)</span> <span>=</span> <span>71</span> <span>&lt;</span><span>0</span><span>.</span><span>000033</span><span>&gt;</span>
<span>00</span><span>:</span><span>14</span><span>:</span><span>53</span><span>.</span><span>275512</span> <span>close</span><span>(</span><span>3</span><span>)</span>                <span>=</span> <span>0</span> <span>&lt;</span><span>0</span><span>.</span><span>00002</span><span>9</span><span>&gt;</span>
<span>00</span><span>:</span><span>14</span><span>:</span><span>53</span><span>.</span><span>275657</span> <span>write</span><span>(</span><span>1</span><span>,</span> <span>&#34;Godspeed, dear friend!</span><span>\n</span><span>&#34;</span><span>,</span> <span>23</span><span>)</span> <span>=</span> <span>23</span> <span>&lt;</span><span>0</span><span>.</span><span>00004</span><span>8</span><span>&gt;</span></pre>
</figure>
<p>As you can see, simply setting<span> </span><code>TZ</code><span> </span>causes glibc to read<span> </span><code>/etc/localtime</code><span> </span>a single time and never again. The same program runs with 9 fewer system calls all because of a single environment variable.</p>

<h3 id="effect-on-production-systems">Effect on production systems</h3>
<p>The effect of setting<span> </span><code>TZ</code><span> </span>on a production system will depend mostly on how often<span> </span><code>localtime</code><span> </span>is called. This is application specific and can vary with request load. All that said, if you aren’t changing your timezone often (or ever), it may be worth simply eliminating these unnecessary calls even if your system isn’t making many of them.</p>
<p>On my test system with a real life app (not the example shown above):</p>
<ul>
<li>Without setting<span> </span><code>TZ</code><span> </span>during normal operations yields approximately: 14,925 calls to<span> </span><code>stat</code><span> </span>over a 30 second period (or roughly 497<span> </span><code>stat</code>s per second).</li>
<li>With<span> </span><code>TZ</code><span> </span>set during the same time period results in 8 calls to<span> </span><code>stat</code><span> </span>over a 30 second period.</li>
</ul>
<p>So, I’ve eliminated on the order of 10,000 extra system calls (and their associated context switches) without changing anything other than an environment variable. Pretty cool.</p>

<h2 id="conclusion">Conclusion</h2>
<p>Using<span> </span><code>strace</code><span> </span>and questioning why patterns of system calls emerge from your infrastructure can help you better understand exactly what your systems are doing and why. You may even be able to remove unncessary system calls and save some system resources, too.</p>
          
        </div></div>
  </body>
</html>
