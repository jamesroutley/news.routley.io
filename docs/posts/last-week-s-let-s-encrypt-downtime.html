<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.agwa.name/blog/post/last_weeks_lets_encrypt_downtime">Original</a>
    <h1>Last week&#39;s Let&#39;s Encrypt downtime</h1>
    
    <div id="readability-page-1" class="page"><div>



<p>
Last Thursday (June 15th, 2023), Let&#39;s Encrypt <a href="https://letsencrypt.status.io/pages/incident/55957a99e800baa4470002da/648b36899c7c1405303ea8c4" rel="external">went down for about
an hour</a>, during which time it was not possible to obtain certificates
from Let&#39;s Encrypt.  Immediately prior to the outage, Let&#39;s Encrypt issued
645 certificates which did not work in Chrome or Safari.  In this post,
I&#39;m going to explain what went wrong and how I detected it.
</p>


<h4>The Law of Precertificates</h4>

<p>
Before I can explain the incident, we need to talk about <a href="https://certificate.transparency.dev/" rel="external">Certificate
Transparency</a>.  Certificate Transparency (CT) is a system for putting
certificates issued by publicly-trusted CAs, such as Let&#39;s Encrypt,
in public, append-only logs.  Certificate authorities have a tremendous amount
of power, and if they misuse their power by issuing certificates that they shouldn&#39;t, traffic to HTTPS websites
could be intercepted by attackers.  Historically, CAs have not used their power well, and Certificate
Transparency is an effort to fix that by letting anyone examine the certificates
that CAs issue.
</p>

<p>
A key concept in Certificate Transparency is the &#34;precertificate&#34;.
Before issuing a certificate, the certificate authority creates a
precertificate, which contains all of the information that will
be in the certificate, plus a &#34;poison extension&#34; that prevents the
precertificate from being used like a real certificate.  The CA submits
the precertificate to multiple Certificate Transparency logs.  Each log
returns a Signed Certificate Timestamp (SCT), which is a signed statement
acknowledging receipt of the precertificate and promising to publish the
precertificate in the log for anyone to download.  The CA takes all of
the SCTs and embeds them in the certificate.  When a CT-enforcing browser
(like Chrome or Safari) validates the certificate, it makes sure that
the certificate embeds a sufficient number of SCTs from trustworthy logs.
This doesn&#39;t prevent the browser from accepting a malicious certificate,
but it does ensure that the precertificate is in public logs, allowing
the attack to be detected and action taken against the CA.
</p>

<p>
The certificate itself may or may not end up in CT logs.  Some CAs,
notably Let&#39;s Encrypt and Sectigo, automatically submit their
certificates.  Certificates from other CAs only end up in logs if
someone else finds and submits them.  <strong>Since only the precertificate is
guaranteed to be logged, it is essential that a precertificate be treated
as incontrovertible proof that a certificate containing the same data exists.</strong>
When someone finds a precertificate for a malicious or non-compliant certificate,
the CA can&#39;t be allowed to evade responsibility by saying &#34;just kidding,
we never actually issued the real certificate&#34; (and boy, have they tried).
Otherwise, CT would be useless.
</p>

<p>
There are two ways a CA could create a certificate.  They could
take the precertificate, remove the poison extension, add the SCTs,
and re-sign it.  Or, they could create the certificate from scratch,
making sure to add the same data, in the same order, as used in the
precertificate.
</p>

<p>
The first way is robust because it&#39;s guaranteed to produce a certificate
which matches the precertificate.  At least one CA, Sectigo, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1838667#c2" rel="external">uses this
approach</a>.  Let&#39;s Encrypt uses the second approach.  You can probably see
where this is going...
</p>


<h4>The Let&#39;s Encrypt incident</h4>

<p>
On June 15, 2023, Let&#39;s Encrypt deployed a <a href="https://community.letsencrypt.org/t/small-change-to-end-entity-certificates-cps-url-and-oid-will-not-be-included-from-june-15/198206" rel="external">planned change</a> to their certificate
configuration which altered the contents of the Certificate Policies extension from:
</p>

<p><code>X509v3 Certificate Policies: 
    Policy: 2.23.140.1.2.1
    Policy: 1.3.6.1.4.1.44947.1.1.1
      CPS: http://cps.letsencrypt.org</code></p><p>to:</p>

<p><code>X509v3 Certificate Policies: 
    Policy: 2.23.140.1.2.1</code></p><p>
Unfortunately, any certificate which was requested while the change
was being rolled out could have its precertificate and certificate created
with different configurations.  For example, when Let&#39;s Encrypt issued
the certificate with serial number 03:e2:26:7b:78:6b:7e:33:83:17:dd:d6:2e:76:4f:cb:3c:71,
the <a href="https://understandingwebpki.com/?cert=MIIFGjCCBAKgAwIBAgISA%2BIme3hrfjODF93WLnZPyzxxMA0GCSqGSIb3DQEBCwUAMDIxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1MZXQncyBFbmNyeXB0MQswCQYDVQQDEwJSMzAeFw0yMzA2MTUxNDM2MTZaFw0yMzA5MTMxNDM2MTVaMB4xHDAaBgNVBAMMEyouN2FjbnIubW9uZ29kYi5uZXQwggIiMA0GCSqGSIb3DQEBAQUAA4ICDwAwggIKAoICAQCjLiLXI%2FmTBSEkSKVucC3NcnXGu%2FM2qwLIk1uenifnoNMmdJmEyp%2BoWFUSn9rIXtHw27YTlJLRRYLSIzqqujDV5PmXzFrSJ%2F9JrgIbNUowaVF3j9bf1%2BNPENEH81RnNGevtKUN5NoEo3fAmZaMWrGjWioNnpIsegSjvvuHeqMqC7SNrGSvtKLBiPkObL5oScPYj%2FcHzt3RYJ17ru6xWgUDV6aqvEblrxcXvPmd%2F1SxB3Vkdkc%2BbCuSLSNM%2FNmcET0YUhWizanjodJarpYJRuW1SjGmPda0jBAQZQDPmZHCEgwTBcCEIg5J3XzAfFUZPPlTVgE%2B7Mbjd%2FDK7iz46D0uHOigVTZto3lPYRdRiyVFNUMAN0GLAlkaJ7Td0FnAxvhE74lSjI7lFqDNtiyA8ovp%2FJbKfPmnvfH%2BfQa7vEFbR5H9v4UZt0XLeI6WdV4pYoCwuK5mfr0NQLCy%2F015OAU8WF4MLM%2BFyt%2BGG%2BsOk2Maz6ysAShMOvdNH7B3GSn65xBVgBxlPWyYpodW9SS1NSVgrgbKMg0yHzx%2FPdosQehyh9p6OpuTaeEi2iQgyTODKGHX%2BcmjzUx0iCG2ByC9bvMo32eZXiC%2BitZCaHb0FGXh%2BK7UcOCsvsi7NLGRngVKK7u7gZmPu4UkVUBpF3jz%2FOK3OsudHcflZIGd6nf8w4lp0wIDAQABo4IBPDCCATgwDgYDVR0PAQH%2FBAQDAgWgMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjAMBgNVHRMBAf8EAjAAMB0GA1UdDgQWBBREcOX3VXl7%2BuM7aqTQ%2FconiJsAAjAfBgNVHSMEGDAWgBQULrMXt1hWy65QCUDmH6%2BdixTCxjBVBggrBgEFBQcBAQRJMEcwIQYIKwYBBQUHMAGGFWh0dHA6Ly9yMy5vLmxlbmNyLm9yZzAiBggrBgEFBQcwAoYWaHR0cDovL3IzLmkubGVuY3Iub3JnLzA4BgNVHREEMTAvghgqLjdhY25yLm1lc2gubW9uZ29kYi5uZXSCEyouN2FjbnIubW9uZ29kYi5uZXQwEwYDVR0gBAwwCjAIBgZngQwBAgEwEwYKKwYBBAHWeQIEAwEB%2FwQCBQAwDQYJKoZIhvcNAQELBQADggEBALIUrHns6TWfT%2FkfJ60D9R1Ek4YGB%2FjVsrh2d3uiIU2hiRBBjgDkCLyKd7oXM761uXX3LL4H4JPegqTrZAPO88tUtzBSb3IF4yA0o1NWhE6ceLnBk9fl5TRCC8QASliApsOigDgRi1VFmyFOHpHnVZdbpPucy6T%2BCdKXKfj4iNw%2BaOZcoQxJ70XECXxQbdqJ7VdYf0B%2Bwtk5HZU8cuVVCj1i%2FiDv1zqITCzaavbz870QugiHO%2F8rj2ctrA07SX3Ovs4JGbCGuMzlpxeIFtQDWVufVbu1ZZltzPlSHFqv6mPKW9stYtt8JCjmPwNW6UdrlBtNgvFgkgDpz%2BQ6%2FVu%2Bu7g%3D" rel="external">precertificate</a> contained the new Certificate Policies extension,
and the <a href="https://understandingwebpki.com/?cert=MIIGRjCCBS6gAwIBAgISA%2BIme3hrfjODF93WLnZPyzxxMA0GCSqGSIb3DQEBCwUAMDIxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1MZXQncyBFbmNyeXB0MQswCQYDVQQDEwJSMzAeFw0yMzA2MTUxNDM2MTZaFw0yMzA5MTMxNDM2MTVaMB4xHDAaBgNVBAMMEyouN2FjbnIubW9uZ29kYi5uZXQwggIiMA0GCSqGSIb3DQEBAQUAA4ICDwAwggIKAoICAQCjLiLXI%2FmTBSEkSKVucC3NcnXGu%2FM2qwLIk1uenifnoNMmdJmEyp%2BoWFUSn9rIXtHw27YTlJLRRYLSIzqqujDV5PmXzFrSJ%2F9JrgIbNUowaVF3j9bf1%2BNPENEH81RnNGevtKUN5NoEo3fAmZaMWrGjWioNnpIsegSjvvuHeqMqC7SNrGSvtKLBiPkObL5oScPYj%2FcHzt3RYJ17ru6xWgUDV6aqvEblrxcXvPmd%2F1SxB3Vkdkc%2BbCuSLSNM%2FNmcET0YUhWizanjodJarpYJRuW1SjGmPda0jBAQZQDPmZHCEgwTBcCEIg5J3XzAfFUZPPlTVgE%2B7Mbjd%2FDK7iz46D0uHOigVTZto3lPYRdRiyVFNUMAN0GLAlkaJ7Td0FnAxvhE74lSjI7lFqDNtiyA8ovp%2FJbKfPmnvfH%2BfQa7vEFbR5H9v4UZt0XLeI6WdV4pYoCwuK5mfr0NQLCy%2F015OAU8WF4MLM%2BFyt%2BGG%2BsOk2Maz6ysAShMOvdNH7B3GSn65xBVgBxlPWyYpodW9SS1NSVgrgbKMg0yHzx%2FPdosQehyh9p6OpuTaeEi2iQgyTODKGHX%2BcmjzUx0iCG2ByC9bvMo32eZXiC%2BitZCaHb0FGXh%2BK7UcOCsvsi7NLGRngVKK7u7gZmPu4UkVUBpF3jz%2FOK3OsudHcflZIGd6nf8w4lp0wIDAQABo4ICaDCCAmQwDgYDVR0PAQH%2FBAQDAgWgMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjAMBgNVHRMBAf8EAjAAMB0GA1UdDgQWBBREcOX3VXl7%2BuM7aqTQ%2FconiJsAAjAfBgNVHSMEGDAWgBQULrMXt1hWy65QCUDmH6%2BdixTCxjBVBggrBgEFBQcBAQRJMEcwIQYIKwYBBQUHMAGGFWh0dHA6Ly9yMy5vLmxlbmNyLm9yZzAiBggrBgEFBQcwAoYWaHR0cDovL3IzLmkubGVuY3Iub3JnLzA4BgNVHREEMTAvghgqLjdhY25yLm1lc2gubW9uZ29kYi5uZXSCEyouN2FjbnIubW9uZ29kYi5uZXQwTAYDVR0gBEUwQzAIBgZngQwBAgEwNwYLKwYBBAGC3xMBAQEwKDAmBggrBgEFBQcCARYaaHR0cDovL2Nwcy5sZXRzZW5jcnlwdC5vcmcwggEEBgorBgEEAdZ5AgQCBIH1BIHyAPAAdgC3Pvsk35xNunXyOcW6WPRsXfxCz3qfNcSeHQmBJe20mQAAAYi%2Fs0QZAAAEAwBHMEUCID4vc7PNWNauTkmkS7CqSwdiyOV%2BLYIT9g8KygWW4atTAiEA6Re4Cz7BsEMi%2B%2FU8G%2Br9LmqbqwGXGS4mXG7RiEfeQEcAdgB6MoxU2LcttiDqOOBSHumEFnAyE4VNO9IrwTpXo1LrUgAAAYi%2Fs0RQAAAEAwBHMEUCIQD95SqDycwXGZ%2BJKBUVBR%2BhBxn4BRIQ7EPIaMTI%2F%2B854gIgDpJm5BFX9vKUf5tKWn9f%2FFagktt5J6hPnrmURSV%2FegAwDQYJKoZIhvcNAQELBQADggEBAKWyDSRmiM9N%2B2AhYgRuzh3JnxtvhmEXUBEgwuFnlQyCm5ZvScvWKmw2sqcj%2BgI2UNUxmWjq3PbIVBrTLDEgXtVN%2BJU6HwC4TdYPIB4LzfrWsGY7cc2aaY76YbWlwEyhN9niQLijZORKhZ6HLM7MI76FM7oJ9eZmvnfypjJ7E0J9ek%2Fy7S1wqg5EM%2BQiAf03YcjSxUCyL3%2F%2BEzlYRz65diLh7Eb6gBd58rWLOa1nbgTOFsToAkBE7qR3HymfWysxApDN8x95jDzubbkqiyuk3dvzjn3oouN1H8NsG%2FxYrYmMMwnJ8xul1AJ31ZMxJ9hr29G122DSEaX9smAyyzWhAwM%3D" rel="external">certificate</a> contained the old Certificate Policies extension.
</p>

<p>
This had two consequences:
</p>

<p>
First, this certificate won&#39;t work in Chrome or Safari, because its SCTs
are for a precertificate containing different data from the certificate.
Specifically, the SCTs fail signature validation.  When logs sign
SCTs, they compute the signature over the data in the precertificate,
and when browsers verify SCTs, they compute the signature over the data
in the certificate.  In this case, that data was not the same.
</p>

<p>
Second, remember how I said that precertificates are treated as
incontrovertible proof that a certificate containing the same data exists?
When Let&#39;s Encrypt issued a precertificate with the new Certificate
Policies value, it implied that they also issued a certificate with
the new Certificate Policies value.  Thus, according to the Law of
Precertificates, Let&#39;s Encrypt issued two certificates with
serial number 03:e2:26:7b:78:6b:7e:33:83:17:dd:d6:2e:76:4f:cb:3c:71:
</p>

<ol>
<li>A <a href="https://understandingwebpki.com/?cert=MIIGRjCCBS6gAwIBAgISA%2BIme3hrfjODF93WLnZPyzxxMA0GCSqGSIb3DQEBCwUAMDIxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1MZXQncyBFbmNyeXB0MQswCQYDVQQDEwJSMzAeFw0yMzA2MTUxNDM2MTZaFw0yMzA5MTMxNDM2MTVaMB4xHDAaBgNVBAMMEyouN2FjbnIubW9uZ29kYi5uZXQwggIiMA0GCSqGSIb3DQEBAQUAA4ICDwAwggIKAoICAQCjLiLXI%2FmTBSEkSKVucC3NcnXGu%2FM2qwLIk1uenifnoNMmdJmEyp%2BoWFUSn9rIXtHw27YTlJLRRYLSIzqqujDV5PmXzFrSJ%2F9JrgIbNUowaVF3j9bf1%2BNPENEH81RnNGevtKUN5NoEo3fAmZaMWrGjWioNnpIsegSjvvuHeqMqC7SNrGSvtKLBiPkObL5oScPYj%2FcHzt3RYJ17ru6xWgUDV6aqvEblrxcXvPmd%2F1SxB3Vkdkc%2BbCuSLSNM%2FNmcET0YUhWizanjodJarpYJRuW1SjGmPda0jBAQZQDPmZHCEgwTBcCEIg5J3XzAfFUZPPlTVgE%2B7Mbjd%2FDK7iz46D0uHOigVTZto3lPYRdRiyVFNUMAN0GLAlkaJ7Td0FnAxvhE74lSjI7lFqDNtiyA8ovp%2FJbKfPmnvfH%2BfQa7vEFbR5H9v4UZt0XLeI6WdV4pYoCwuK5mfr0NQLCy%2F015OAU8WF4MLM%2BFyt%2BGG%2BsOk2Maz6ysAShMOvdNH7B3GSn65xBVgBxlPWyYpodW9SS1NSVgrgbKMg0yHzx%2FPdosQehyh9p6OpuTaeEi2iQgyTODKGHX%2BcmjzUx0iCG2ByC9bvMo32eZXiC%2BitZCaHb0FGXh%2BK7UcOCsvsi7NLGRngVKK7u7gZmPu4UkVUBpF3jz%2FOK3OsudHcflZIGd6nf8w4lp0wIDAQABo4ICaDCCAmQwDgYDVR0PAQH%2FBAQDAgWgMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjAMBgNVHRMBAf8EAjAAMB0GA1UdDgQWBBREcOX3VXl7%2BuM7aqTQ%2FconiJsAAjAfBgNVHSMEGDAWgBQULrMXt1hWy65QCUDmH6%2BdixTCxjBVBggrBgEFBQcBAQRJMEcwIQYIKwYBBQUHMAGGFWh0dHA6Ly9yMy5vLmxlbmNyLm9yZzAiBggrBgEFBQcwAoYWaHR0cDovL3IzLmkubGVuY3Iub3JnLzA4BgNVHREEMTAvghgqLjdhY25yLm1lc2gubW9uZ29kYi5uZXSCEyouN2FjbnIubW9uZ29kYi5uZXQwTAYDVR0gBEUwQzAIBgZngQwBAgEwNwYLKwYBBAGC3xMBAQEwKDAmBggrBgEFBQcCARYaaHR0cDovL2Nwcy5sZXRzZW5jcnlwdC5vcmcwggEEBgorBgEEAdZ5AgQCBIH1BIHyAPAAdgC3Pvsk35xNunXyOcW6WPRsXfxCz3qfNcSeHQmBJe20mQAAAYi%2Fs0QZAAAEAwBHMEUCID4vc7PNWNauTkmkS7CqSwdiyOV%2BLYIT9g8KygWW4atTAiEA6Re4Cz7BsEMi%2B%2FU8G%2Br9LmqbqwGXGS4mXG7RiEfeQEcAdgB6MoxU2LcttiDqOOBSHumEFnAyE4VNO9IrwTpXo1LrUgAAAYi%2Fs0RQAAAEAwBHMEUCIQD95SqDycwXGZ%2BJKBUVBR%2BhBxn4BRIQ7EPIaMTI%2F%2B854gIgDpJm5BFX9vKUf5tKWn9f%2FFagktt5J6hPnrmURSV%2FegAwDQYJKoZIhvcNAQELBQADggEBAKWyDSRmiM9N%2B2AhYgRuzh3JnxtvhmEXUBEgwuFnlQyCm5ZvScvWKmw2sqcj%2BgI2UNUxmWjq3PbIVBrTLDEgXtVN%2BJU6HwC4TdYPIB4LzfrWsGY7cc2aaY76YbWlwEyhN9niQLijZORKhZ6HLM7MI76FM7oJ9eZmvnfypjJ7E0J9ek%2Fy7S1wqg5EM%2BQiAf03YcjSxUCyL3%2F%2BEzlYRz65diLh7Eb6gBd58rWLOa1nbgTOFsToAkBE7qR3HymfWysxApDN8x95jDzubbkqiyuk3dvzjn3oouN1H8NsG%2FxYrYmMMwnJ8xul1AJ31ZMxJ9hr29G122DSEaX9smAyyzWhAwM%3D" rel="external">certificate</a> containing the old Certificate Policies extension</li>
<li>A certificate containing the new Certificate Policies extension (implied by the existence of the <a href="https://understandingwebpki.com/?cert=MIIFGjCCBAKgAwIBAgISA%2BIme3hrfjODF93WLnZPyzxxMA0GCSqGSIb3DQEBCwUAMDIxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1MZXQncyBFbmNyeXB0MQswCQYDVQQDEwJSMzAeFw0yMzA2MTUxNDM2MTZaFw0yMzA5MTMxNDM2MTVaMB4xHDAaBgNVBAMMEyouN2FjbnIubW9uZ29kYi5uZXQwggIiMA0GCSqGSIb3DQEBAQUAA4ICDwAwggIKAoICAQCjLiLXI%2FmTBSEkSKVucC3NcnXGu%2FM2qwLIk1uenifnoNMmdJmEyp%2BoWFUSn9rIXtHw27YTlJLRRYLSIzqqujDV5PmXzFrSJ%2F9JrgIbNUowaVF3j9bf1%2BNPENEH81RnNGevtKUN5NoEo3fAmZaMWrGjWioNnpIsegSjvvuHeqMqC7SNrGSvtKLBiPkObL5oScPYj%2FcHzt3RYJ17ru6xWgUDV6aqvEblrxcXvPmd%2F1SxB3Vkdkc%2BbCuSLSNM%2FNmcET0YUhWizanjodJarpYJRuW1SjGmPda0jBAQZQDPmZHCEgwTBcCEIg5J3XzAfFUZPPlTVgE%2B7Mbjd%2FDK7iz46D0uHOigVTZto3lPYRdRiyVFNUMAN0GLAlkaJ7Td0FnAxvhE74lSjI7lFqDNtiyA8ovp%2FJbKfPmnvfH%2BfQa7vEFbR5H9v4UZt0XLeI6WdV4pYoCwuK5mfr0NQLCy%2F015OAU8WF4MLM%2BFyt%2BGG%2BsOk2Maz6ysAShMOvdNH7B3GSn65xBVgBxlPWyYpodW9SS1NSVgrgbKMg0yHzx%2FPdosQehyh9p6OpuTaeEi2iQgyTODKGHX%2BcmjzUx0iCG2ByC9bvMo32eZXiC%2BitZCaHb0FGXh%2BK7UcOCsvsi7NLGRngVKK7u7gZmPu4UkVUBpF3jz%2FOK3OsudHcflZIGd6nf8w4lp0wIDAQABo4IBPDCCATgwDgYDVR0PAQH%2FBAQDAgWgMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjAMBgNVHRMBAf8EAjAAMB0GA1UdDgQWBBREcOX3VXl7%2BuM7aqTQ%2FconiJsAAjAfBgNVHSMEGDAWgBQULrMXt1hWy65QCUDmH6%2BdixTCxjBVBggrBgEFBQcBAQRJMEcwIQYIKwYBBQUHMAGGFWh0dHA6Ly9yMy5vLmxlbmNyLm9yZzAiBggrBgEFBQcwAoYWaHR0cDovL3IzLmkubGVuY3Iub3JnLzA4BgNVHREEMTAvghgqLjdhY25yLm1lc2gubW9uZ29kYi5uZXSCEyouN2FjbnIubW9uZ29kYi5uZXQwEwYDVR0gBAwwCjAIBgZngQwBAgEwEwYKKwYBBAHWeQIEAwEB%2FwQCBQAwDQYJKoZIhvcNAQELBQADggEBALIUrHns6TWfT%2FkfJ60D9R1Ek4YGB%2FjVsrh2d3uiIU2hiRBBjgDkCLyKd7oXM761uXX3LL4H4JPegqTrZAPO88tUtzBSb3IF4yA0o1NWhE6ceLnBk9fl5TRCC8QASliApsOigDgRi1VFmyFOHpHnVZdbpPucy6T%2BCdKXKfj4iNw%2BaOZcoQxJ70XECXxQbdqJ7VdYf0B%2Bwtk5HZU8cuVVCj1i%2FiDv1zqITCzaavbz870QugiHO%2F8rj2ctrA07SX3Ovs4JGbCGuMzlpxeIFtQDWVufVbu1ZZltzPlSHFqv6mPKW9stYtt8JCjmPwNW6UdrlBtNgvFgkgDpz%2BQ6%2FVu%2Bu7g%3D" rel="external">precertificate</a> with the new Certificate Policies extension)</li>
</ol>

<p>
Issuing two certificates with the same serial number is a violation of
the <a href="https://cabforum.org/baseline-requirements/" rel="external">Baseline Requirements for the Issuance and Management of Publicly-Trusted Certificates</a>. Consequentially, Let&#39;s Encrypt must
revoke the certificate and post a public incident report,
which must be noted on their next audit statement.
</p>

<p>
You might think that it&#39;s harsh to treat this as a compliance incident
if Let&#39;s Encrypt didn&#39;t really issue two certificates with the same
serial number.  Unfortunately, they have no way of proving this, and
the whole reason for Certificate Transparency is so we don&#39;t have to take CAs
at their word that they aren&#39;t issuing certificates that they shouldn&#39;t.
Any exception to the Law of Precertificates creates an opening
for a malicious CA to exploit.
</p>

<h4>How I found this</h4>

<p>
My company, <a href="https://sslmate.com/" rel="external">SSLMate</a>, operates a Certificate Transparency monitor called
<a href="https://sslmate.com/certspotter/" rel="external">Cert Spotter</a>, which continuously downloads and indexes the contents of every
Certificate Transparency log.  You can use Cert Spotter to get notifications
when a certificate is issued for one of your domains, or search the database
using a <a href="https://sslmate.com/ct_search_api/" rel="external">JSON API</a>.
</p>

<p>
When Cert Spotter ingests a certificate containing embedded SCTs, it
verifies each SCT&#39;s signature and audits that the log really published
the precertificate.  (If it detects that a log has broken its promise
to publish a precertificate, I&#39;ll publicly disclose the SCT and the log
will be distrusted.   Happily, Cert Spotter has never found a bogus SCT,
though it has detected logs violating other requirements.)
</p>

<p>
On Thursday, June 15, 2023 at 15:41 UTC, Cert Spotter began sending me
alerts about certificates containing embedded SCTs with
invalid signatures.  Since I was getting hundreds of alerts, I decided
to stop what I was doing and investigate.
</p>

<p>
I had received these alerts several times before, and have gotten pretty
good at zeroing in on the problem.  When only one SCT in a certificate
has an invalid signature, it probably means that the CT log screwed up.
When all of the embedded SCTs have an invalid signature, it probably
means the CA screwed up.  The most common reason is issuing certificates
that don&#39;t match the precertificate.  So I took one of the affected
certificates and searched for precertificates containing the same serial
number in Cert Spotter&#39;s database of every
(pre)certificate ever logged to Certificate Transparency. Decoding the
certificate and precertificate with the openssl command immediately
revealed the different Certificate Policies extension.
</p>

<p>
Since I was continuing to get alerts from Cert Spotter about invalid
SCT signatures, I quickly fired off an email to Let&#39;s Encrypt&#39;s problem
reporting address alerting them to the problem.
</p>

<p>
I sent the email at 15:52 UTC.  At 16:08, Let&#39;s Encrypt replied
that they had paused issuance to investigate.  Meanwhile, I filed
a <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1838667" rel="external">CA
Certificate Compliance bug</a> in Bugzilla, which is where Mozilla
and Chrome track compliance incidents by publicly-trusted certificate authorities.
</p>

<p>
At 16:54, Let&#39;s Encrypt resumed issuance after confirming that they would
not issue any more certificates with mismatched precertificates.
</p>

<p>
On Friday, June 16, 2023, Let&#39;s Encrypt emailed the subscribers of
the affected certificates to inform them of the need to replace
their certificates.
</p>

<p>
On Monday, June 19, 2023 at 18:00 UTC, Let&#39;s Encrypt revoked the 645 affected
certificates, as required by the Baseline Requirements.  This will cause
the certificates to stop working in any client that checks revocation,
but remember that these certificates were already being rejected by Chrome
and Safari for having invalid SCTs.
</p>

<p>
On Tuesday, June 20, 2023, Let&#39;s Encrypt posted their <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1838667#c6" rel="external">public incident report</a>, which explained the root cause of the incident and what they&#39;re doing to prevent it
from happening again.  Specifically, they plan to add a pre-issuance check
that ensures certificates contain the same data as the precertificate.
</p>

<h4>Hundreds of websites are still serving broken certificates</h4>

<p>
I&#39;ve been periodically checking port 443 of every DNS name
in the affected certificates, and as of publication time, 261 certificates are still in use,
despite not working in CT-enforcing or revocation-checking
clients.
</p>

<p>
I find it alarming that a week after the incident, 40% of the affected certificates
are still in use, despite being rejected by the most popular browsers and despite affected
subscribers being emailed by Let&#39;s Encrypt.  I thought
that maybe these certificates were being used by API endpoints which are accessed
by non-browser clients that don&#39;t enforce CT or check revocation, but this doesn&#39;t
appear to be the case, as most of the DNS names are for bare domains or www subdomains.
It&#39;s fortunate that Let&#39;s Encrypt issued only a small number of non-compliant
certificates, because otherwise it would have broken a lot of websites.
</p>

<p>
There is a new standard under development
called <a href="https://datatracker.ietf.org/doc/draft-ietf-acme-ari/" rel="external">ACME Renewal Information</a>
which enables certificate authorities to inform ACME clients to renew certificates ahead of
their normal expiration.  Let&#39;s Encrypt supports ARI, and used it in this incident to trigger
early renewal of the affected certificates.  Clearly, more ACME clients need to add support for ARI.
</p>

<h4>This is my 50th CA compliance bug</h4>

<p>
It turns out this is the 50th CA compliance bug that <a href="https://bugzilla.mozilla.org/buglist.cgi?emailtype1=exact&amp;emailreporter1=1&amp;query_format=advanced&amp;resolution=---&amp;resolution=FIXED&amp;product=CA%20Program&amp;component=CA%20Certificate%20Compliance&amp;email1=agwa-bugs%40mm.beanwood.com" rel="external">I&#39;ve filed
in Bugzilla</a>, and the 5th which was uncovered by Cert Spotter&#39;s SCT
signature checks.  Additionally, I reported a number of incidents before
2018 which didn&#39;t end up in Bugzilla.
</p>

<p>
Some of the problems I uncovered were quite serious (like issuing certificates
without doing domain validation) and snowballed until the CA was ultimately
distrusted.  Most are minor in comparison, and ten years ago, no one would
have cared about them: there was no Certificate Transparency to unearth non-compliant
certificates, and even when someone did notice, the revocation requirement was not
enforced, and CAs were not required to file incident reports or document the non-compliance on
their next audit.  Thankfully, that&#39;s no longer the case,
and even compliance violations that seem minor are treated seriously,
which has led to enormous improvements in the certificate ecosystem:
</p>

<ol>
<li>
The improvements which certificate authorities make in response
to seemingly-minor incidents also improve their compliance with
the most security-critical rules.
</li>

<li>TLS clients no longer need to work around non-standards-compliant
certificates, which means they can be simpler.  Simpler code is easier to make
secure.</li>

<li>The way that CAs handle minor incidents can uncover much larger problems.
Minor compliance problems are like <a href="https://effectiviology.com/brown-mms/" rel="external">&#34;Brown M&amp;M&#39;s&#34;</a>.</li>
</ol>

<p>
Mozilla deserves enormous credit for being the first to require
public incident reports from CAs, as does Google for creating and
fostering Certificate Transparency.
</p>

<h4>You should monitor Certificate Transparency too</h4>

<p>
One limitation of my compliance monitoring is that I am generally only able to
detect certificates that are intrinsically non-compliant, like those which
violate encoding rules or are valid for too many days.
While I do monitor certificates for domains that are likely to be abused,
like <a href="https://groups.google.com/g/mozilla.dev.security.policy/c/fyJ3EK2YOP8" rel="external">example.com</a>
and <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1496088" rel="external">test.com</a>,
I can&#39;t tell if a certificate issued for your domain is authorized or not.
Only you know that.
</p>

<p>
Fortunately, it&#39;s pretty easy to monitor Certificate Transparency and get
alerts when a certificate is issued for one of your domains.
Cert Spotter has a <a href="https://github.com/SSLMate/certspotter" rel="external">standalone, open source version</a>
that&#39;s easy to set up.  The <a href="https://sslmate.com/certspotter/" rel="external">paid version</a>
has additional features like expiration monitoring, Slack integration, and ways to filter alerts
so you&#39;re not bothered about legitimate certificates.  But most importantly, subscribing to the paid
version helps me continue my compliance monitoring of the certificate authority ecosystem.
</p>


</div></div>
  </body>
</html>
