<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://purplehoisin.com/i-built-a-bus-clock-with-a-raspberry-pi/">Original</a>
    <h1>Show HN: Tracking my local bus with a RaspberryPi</h1>
    
    <div id="readability-page-1" class="page"><div>
		<div>
			
<p>Let me tell you about a problem I have. It‚Äôs not really a big problem, but every time it happens I promise myself that I will never, ever let it happen again. But it did happen, again and again. So what actually is this problem I‚Äôm facing? I missed the bus by two seconds and now I have to wait 15 minutes for the next one. I‚Äôm coming out of my house and there it is, passing by right in front of me without stopping because I‚Äôm still a few seconds away from the stop.</p>



<p>So, how do I step out of the loop and start avoiding this? Yes of course, I could just navigate through the local transport app and see the live bus arrival times. But, being a techy, I had to create a solution for this. And that‚Äôs what this post is about! I created a <strong>bus clock</strong> üöå üïö for my house, so that I can always see when to hurry up and get out to catch the bus.</p>



<h2><strong>What is a bus clock?</strong></h2>



<p><strong>Well, just like a clock:</strong></p>



<ul>
<li>It tells you a time; the time until the bus arrives. All the time.</li>



<li>It hangs from a wall in your house ‚Äì just like an old-school clock.</li>
</ul>



<p>And this is what Dall-E, the AI image generator from OpenAI, thinks about a bus clock:</p>


<div>
<figure><img decoding="async" src="http://purplehoisin.com/wp-content/uploads/2022/11/busclock_dalle.png" alt="Bus Clock image generated by DALL-E" width="387" height="387" srcset="https://purplehoisin.com/wp-content/uploads/2022/11/busclock_dalle.png 1024w, https://purplehoisin.com/wp-content/uploads/2022/11/busclock_dalle-300x300.png 300w, https://purplehoisin.com/wp-content/uploads/2022/11/busclock_dalle-150x150.png 150w, https://purplehoisin.com/wp-content/uploads/2022/11/busclock_dalle-768x768.png 768w" sizes="(max-width: 387px) 100vw, 387px"/><figcaption>Bus Clock By DALL-E</figcaption></figure></div>


<h2>How I built it</h2>



<p>Since I already had an unopened Raspberry Pi 3B that I ordered in 2016 (6 years ago!!) I decided it was now the perfect opportunity to start using it. I also needed a screen to display the times but I was a bit hesitant to buy it before the project even started, considering I bought the Raspberry Pi and never even touched it. But just like many times before, I told myself this time it would be different and I would take this project over the finish line so I went ahead and ordered a 4-inch, plug-and-play (mostly) HDMI display.</p>


<div>
<figure><img decoding="async" loading="lazy" src="http://purplehoisin.com/wp-content/uploads/2022/11/PXL_20221009_210310563-copy-771x1024.jpg" alt="Raspberry PI 3B with a HDMI screen" width="383" height="510" srcset="https://purplehoisin.com/wp-content/uploads/2022/11/PXL_20221009_210310563-copy-771x1024.jpg 771w, https://purplehoisin.com/wp-content/uploads/2022/11/PXL_20221009_210310563-copy-226x300.jpg 226w, https://purplehoisin.com/wp-content/uploads/2022/11/PXL_20221009_210310563-copy-768x1020.jpg 768w, https://purplehoisin.com/wp-content/uploads/2022/11/PXL_20221009_210310563-copy-1542x2048.jpg 1542w, https://purplehoisin.com/wp-content/uploads/2022/11/PXL_20221009_210310563-copy-scaled.jpg 1928w" sizes="(max-width: 383px) 100vw, 383px"/><figcaption>Raspberry PI 3B with a HDMI screen</figcaption></figure></div>


<p>Fortunately, the Raspberry PI runs a full Unix system and you can program it with whatever you want, unlike other simpler chips out there. On top of that, I didn‚Äôt have the patience to read a data sheet, program I/O pins or learn a chip-specific language ‚Äì so I went with Python üêç. I almost had a sad moment when I couldn‚Äôt create a modern Python 3+ Conda environment on the Raspberry Pi 3B, but <a href="https://stackoverflow.com/questions/39371772/how-to-install-anaconda-on-raspberry-pi-3-model-b" target="_blank" rel="noreferrer noopener">berryconda is maintaining a miniconda installer for Python 3.6</a>, so at least I got <a href="https://www.geeksforgeeks.org/formatted-string-literals-f-strings-python/" target="_blank" rel="noreferrer noopener">f-strings</a> :D. </p>



<p>Once the Python environment was up and running, I had to somehow fetch the live bus data from TFL (Transport for London) and for that I decided to just scrape the local transport website using the good old <code>requests</code> package and <code>BeautifulSoup4</code>. The full code is available at <a rel="noreferrer noopener" href="https://github.com/purplehoisincoder/purplehoisin/blob/main/bus_time.py" target="_blank">github.com/purplehoisincoder/‚Ä¶/bus_time.py</a> but here‚Äôs a snippet</p>



<pre><code lang="python"># London Transport URLs
TFL_URL = &#34;https://tfl.gov.uk/&#34;
BUS_LINE_STOPS_URL = &#34;https://tfl.gov.uk/bus/route/{bus_number}/?direction={in_or_out}&#34;


def find_link_for_bus_stop(bus_route_page, bus_stop_name):
    &#34;&#34;&#34; Given the page for the bus route, find the link for the input bus stop &#34;&#34;&#34;
    soup = BeautifulSoup(bus_route_page, &#34;html.parser&#34;)

    destination = None
    bus_stop_link = None
    h1s = soup.select(&#34;h1&#34;)
    for h1 in h1s:
        text = h1.text
        if text.startswith(&#34;Towards&#34;):
            destination = text.replace(&#34;Towards &#34;, &#34;&#34;)

    links = soup.select(&#34;a.stop-link&#34;)
    for link in links:
        link_text = link.text
        if bus_stop_name.lower() in link_text.lower():
            bus_stop_link = link.get(&#39;href&#39;)
            break

    return bus_stop_link, destination

def find_arrival_times(bus_stop_page):
    &#34;&#34;&#34; Given a bus stop page for one bus route, extract the bus arrival times
        Example page: https://tfl.gov.uk/bus/stop/490000022C/bethnal-green-station?lineId=254
    &#34;&#34;&#34;
    soup = BeautifulSoup(bus_stop_page, &#34;html.parser&#34;)
    arrival_items = soup.select(&#34;li.live-board-feed-item&#34;)
    times = []
    for item in arrival_items:
        eta = item.select_one(&#34;span.live-board-eta&#34;)
        if eta:
            times.append(eta.text)

    return times

def get_arrival_times(args):
		
    bus_route_url = BUS_LINE_STOPS_URL.format(bus_number=args.bus_number, in_or_out=args.inbound_or_outbound)
    bus_route_page = fetch_page(bus_route_url)
    bus_stop_relative_url, destination = find_link_for_bus_stop(bus_route_page, args.bus_stop_name)

    if not bus_stop_relative_url:
        print(f&#34;Could not get bus_stop_link for {args}&#34;)
        return

    bus_stop_url = f&#34;{TFL_URL}{bus_stop_relative_url}&#34;
    bus_stop_page = fetch_page(bus_stop_url)
    arrival_times = find_arrival_times(bus_stop_page)
    return arrival_times, destination
</code></pre>



<p>Good now we need to do that periodically, so that every time I walk past my bus clock, I know if I should hurry up or not. I went for a 30 second refresh rate and this is how it looked:</p>



<pre><code lang="python">ordinal_numbers = [&#39;1st&#39;, &#39;2nd&#39;, &#39;3rd&#39;, &#39;4th&#39;, &#39;5th&#39;, &#39;6th&#39;, &#39;7th&#39;, &#39;8th&#39;, &#39;9th&#39;]
while True:
    os.system(&#39;clear&#39;)
    arrival_times, destination = get_arrival_times(args)
    time_now = datetime.now().strftime(&#34;%c&#34;)
    print(f&#34;Bus {args.bus_number} to {destination} at stop &#39;{args.bus_stop_name.title()}&#39;&#34;)
    for index, arrival_time in enumerate(arrival_times):
        if not arrival_time:
            continue

        print(f&#34;{ordinal_numbers[index]}   {arrival_time}&#34;)

    print(f&#34;{time_now}&#34;)
    time.sleep(30)
</code></pre>







<p>And this is the output for a random bus station on line 254:</p>



<pre><code lang="vim">$ python bus_time.py --bus-number 254 --bus-stop-name &#34;Bethnal Green Station&#34;
Bus 254 to Aldgate at stop &#39;Bethnal Green Station&#39;
1st                              Due
2nd                              1 min
3rd                              1 min
4th                              1 min
5th                              8 mins
6th                              11 mins
7th                              17 mins
8th                              19 mins
9th                              19 mins
Wed Nov  2 21:48:40 2022</code></pre>



<p>Nice! it works! üéâ From this point onwards, we know the magic is there and we just need to make it more usable. So let‚Äôs make the text a bit bigger so it can be seen on the tiny Raspberry screen on a glance as you walk by. I did still want it to be a simple terminal app, so I started testing ASCII art and colors:</p>


<div>
<figure><img decoding="async" loading="lazy" src="http://purplehoisin.com/wp-content/uploads/2022/11/PXL_20221016_174138097-2-771x1024.jpg" alt="Bus Clock on Raspberry PI small HDMI screen" width="538" height="715" srcset="https://purplehoisin.com/wp-content/uploads/2022/11/PXL_20221016_174138097-2-771x1024.jpg 771w, https://purplehoisin.com/wp-content/uploads/2022/11/PXL_20221016_174138097-2-226x300.jpg 226w, https://purplehoisin.com/wp-content/uploads/2022/11/PXL_20221016_174138097-2-768x1020.jpg 768w, https://purplehoisin.com/wp-content/uploads/2022/11/PXL_20221016_174138097-2-1157x1536.jpg 1157w, https://purplehoisin.com/wp-content/uploads/2022/11/PXL_20221016_174138097-2-1542x2048.jpg 1542w, https://purplehoisin.com/wp-content/uploads/2022/11/PXL_20221016_174138097-2-scaled.jpg 1928w" sizes="(max-width: 538px) 100vw, 538px"/><figcaption>Bus Clock on Raspberry PI small HDMI screen</figcaption></figure></div>


<p>Pretty nice, right? The bus clock is now live and my Raspberry Pi is less lonely.</p>



<p>I would love to hear your thoughts via <a rel="noreferrer noopener" href="mailto:hello@purplehoisin.com" target="_blank">hello@purplehoisin.com</a> or let‚Äôs connect via <a rel="noreferrer noopener" href="https://twitter.com/purplehoisin" target="_blank">twitter.com/purplehoisin</a>.</p>



<h2>Future Work</h2>



<ul>
<li>Now that my partner is also using the bus clock, she already asked for more bus lines and more than one direction.</li>



<li>It bugs me that I‚Äôm fetching this information every 30 seconds even though most of the time I won‚Äôt use it. Perhaps I could add a microphone that only fetches the information when it hears steps near by. I think fetching it after a voice command would defeat the purpose since it might just be faster to open the transport app. But perhaps it‚Äôs interesting to add this anyway to be able to get the information from somewhere else in the house.</li>
</ul>
		</div><!-- .entry-content -->
	</div></div>
  </body>
</html>
