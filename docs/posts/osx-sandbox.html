<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://bea.goth.cafe/osx-sandbox/">Original</a>
    <h1>OSX Sandbox</h1>
    
    <div id="readability-page-1" class="page"><div><p>Did you know that OSX has a native sandbox? It does! It’s called <code>sandbox-exec</code> and it’s pretty cool. The rules are written in a language called <code>sbx</code> and it’s pretty easy to use. Here’s an example of a simple sandbox rule that allows everything by default.</p><div><pre tabindex="0"><code data-lang="clojure"><span><span><span>; Indicate the version of the sandbox profile language.</span>
</span></span><span><span><span>; As of my knowledge cutoff in September 2021, the only version is 1.</span>
</span></span><span><span>(<span>version</span> <span>1</span>)
</span></span><span><span>
</span></span><span><span><span>; Allow all operations by default. </span>
</span></span><span><span><span>; This means that processes running under this profile have all permissions </span>
</span></span><span><span><span>; except those explicitly denied in the rules that follow.</span>
</span></span><span><span>(<span>allow</span> default)
</span></span></code></pre></div><p>You can write an explicit allow all by listing all of the rules you want to allow.</p><div><pre tabindex="0"><code data-lang="clojure"><span><span>(<span>version</span> <span>1</span>)
</span></span><span><span>(<span>deny</span> default)
</span></span><span><span>(<span>allow</span> process*)
</span></span><span><span>(<span>allow</span> file*)
</span></span><span><span>(<span>allow</span> network*)
</span></span><span><span>(<span>allow</span> signal)
</span></span><span><span>(<span>allow</span> ipc*)
</span></span><span><span>(<span>allow</span> sysctl*)
</span></span><span><span>(<span>allow</span> system*)
</span></span><span><span>(<span>allow</span> mach*)
</span></span><span><span>(<span>allow</span> iokit*)
</span></span><span><span>(<span>allow</span> user-preference*)
</span></span><span><span>(<span>allow</span> lsopen)
</span></span><span><span>(<span>allow</span> nvram*)
</span></span></code></pre></div><p>Lets write some rules to restrict a bash shell from network access.</p><div><pre tabindex="0"><code data-lang="clojure"><span><span>(<span>version</span> <span>1</span>)
</span></span><span><span>(<span>allow</span> default)
</span></span><span><span>(<span>deny</span> network*)
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="bash"><span><span>% sandbox-exec -f sandbox.sb /bin/bash
</span></span><span><span>
</span></span><span><span>bash-3.2$ ping 1.1.1.1
</span></span><span><span>PING 1.1.1.1 <span>(</span>1.1.1.1<span>)</span>: <span>56</span> data bytes
</span></span><span><span>ping: sendto: Operation not permitted
</span></span><span><span>ping: sendto: Operation not permitted
</span></span><span><span>Request timeout <span>for</span> icmp_seq <span>0</span>
</span></span><span><span>ping: sendto: Operation not permitted
</span></span></code></pre></div><p>You can also specify the rules on the command line.</p><div><pre tabindex="0"><code data-lang="bash"><span><span>bash-3.2$ sandbox-exec -p <span>&#39;(version 1) (allow default) (deny file-write*)&#39;</span> touch foo
</span></span><span><span>sandbox-exec: sandbox_apply: Operation not permitted
</span></span></code></pre></div><p>Finally heres a simple profile to prevent file writes outside of a directory.</p><div><pre tabindex="0"><code data-lang="clojure"><span><span><span>; Indicate the version of the sandbox profile language.</span>
</span></span><span><span><span>; As of my knowledge cutoff in September 2021, the only version is 1.</span>
</span></span><span><span>(<span>version</span> <span>1</span>)
</span></span><span><span>
</span></span><span><span><span>; Allow all operations by default. </span>
</span></span><span><span><span>; This means that processes running under this profile have all permissions </span>
</span></span><span><span><span>; except those explicitly denied in the rules that follow.</span>
</span></span><span><span>(<span>allow</span> default)
</span></span><span><span>
</span></span><span><span><span>; Deny all file-write operations. </span>
</span></span><span><span><span>; This includes writing data to a file, creating new files, and deleting files.</span>
</span></span><span><span><span>; This rule is applied to all files on the system because no path is specified.</span>
</span></span><span><span>(<span>deny</span> file-write*)
</span></span><span><span>
</span></span><span><span><span>; Allow file-write operations to a specific directory.</span>
</span></span><span><span><span>; Despite the earlier rule that denies all file-write operations,</span>
</span></span><span><span><span>; this rule allows processes to write to files in the specified directory</span>
</span></span><span><span><span>; and any of its subdirectories. </span>
</span></span><span><span><span>; The rules in a sandbox profile are evaluated from top to bottom,</span>
</span></span><span><span><span>; and the last matching rule for an operation is the one that takes effect.</span>
</span></span><span><span><span>; So for paths under &#34;/Users/bea/sandbox&#34;, this rule will be the last one that matches,</span>
</span></span><span><span><span>; and so file-write operations are allowed.</span>
</span></span><span><span>(<span>allow</span> file-write*
</span></span><span><span>  (<span>subpath</span> <span>&#34;/Users/bea/sandbox&#34;</span>)
</span></span><span><span>)
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="bash"><span><span>bea@beahive sandbox % sandbox-exec -f sandbox.sb /bin/bash
</span></span><span><span>
</span></span><span><span>bash-3.2$ echo <span>&#34;hello world&#34;</span> &gt; test.file
</span></span><span><span>bash-3.2$ cat test.file 
</span></span><span><span>hello world
</span></span><span><span>bash-3.2$ echo <span>&#34;hello world&#34;</span> &gt; /tmp/test.file
</span></span><span><span>bash: /tmp/test.file: Operation not permitted
</span></span><span><span>bash-3.2$ exit
</span></span></code></pre></div><p>Well thats it for now. Theres lots to learn about this sandbox, but I’m going to leave it here for now. I’ll probably write more about this in the future. Sending good vibes your way.</p></div></div>
  </body>
</html>
