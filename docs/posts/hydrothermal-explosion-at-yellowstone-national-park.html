<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.jhnewsandguide.com/the_hole_scroll/video-biscuit-basin-geyser-explodes-sending-yellowstone-tourists-packing/article_6862fda2-4923-11ef-b5c4-abdc9bc8cd83.html">Original</a>
    <h1>Hydrothermal explosion at Yellowstone National Park</h1>
    
    <div id="readability-page-1" class="page"><div><p>Last week&#39;s blog post accidentally got published a few hours early<sup><a href="#this-too">1</a></sup>.
One of the keen-eyed among you even submitted it to the orange site before it was officially up, since it was in my RSS feed briefly and was picked up by various RSS readers.
Resolving that issue led me to discover the command <code>faketime</code> and a wonderful way of validating processes that are time and timezone dependent.</p>
<p>I&#39;m going to first talk about <a href="https://ntietz.com/blog/til-testing-future-using-faketime/#bug">the bug</a>, then separately about <a href="https://ntietz.com/blog/til-testing-future-using-faketime/#testing-future">how I tested a fix</a>.
Feel free to skip ahead to <a href="https://ntietz.com/blog/til-testing-future-using-faketime/#testing-future">the testing</a> part if you want to skip the story.</p>

<p>Last week&#39;s post went up early because I was testing out a new way of publishing previews of posts, and that process had a bug.
Previously, I would publish my entire site with drafts to a separate hosting stack just for blog previews.
I didn&#39;t love that this required two separate deployment processes, though, and I kept admiring how <a href="https://erikarow.land/">a friend</a> has unlisted posts on her regular site for previews.
So I wanted to do that!</p>
<p>Since my static site generator <a href="https://github.com/getzola/zola/issues/2391">doesn&#39;t have hidden pages</a>, I accomplished it by customizing my site templates.
One of the comments in that issue thread yields a way to achieve this.
Adapting it for all the files I needed, I put something like this inside my templates for <code>atom.xml</code> and my blog/tag pages<sup><a href="#tag-bug">2</a></sup>:</p>
<pre><code>&lt;!-- snippet from templates/blog.html --&gt;
{% set ts_now = now() | date(format=&#34;%Y-%m-%d&#34;) | date(format=&#34;%s&#34;) | int %}

{% for page in section.pages %}
  {% set ts_page = page.date|default(value=0)|date(format=&#34;%s&#34;)|int %}
  {% if ts_page &lt;= ts_now %}
    &lt;li&gt;{{page.date}}: &lt;a href=&#34;{{ page.permalink | safe }}&#34;&gt;{{ page.title }}&lt;/a&gt;&lt;/li&gt;
  {%- endif -%}
{% endfor %}
</code></pre>
<p>This worked great, and I was able to get feedback on last week&#39;s post by sending a link to the hidden page!
Neat!</p>
<p>The problem came when I published a typo fix before going to bed on Sunday.
The post was scheduled for Monday, and when I published a typo fix, it had already become Monday in UTC.
I am on the US east coast, and my computer is set to use Eastern Time.
So imagine my surprise when, upon publishing a typo fix, this post also became public and appeared in the feeds!
My static site generator was using UTC for the post dates.</p>
<p>I quickly made a small change to remove it from the feeds (I set the post a year in the future).
But I couldn&#39;t let go of the bug, and I came back to it this week.</p>
<p>I eventually made another tweak to my templates to, effectively, strip out timezone information.
It&#39;s hacky, but it works.
But how do I make sure of that?</p>

<p>To verify my change, I had to figure out how to check it at a few critical times.
Since I want posts to publish on a particular calendar day in my local timezone, I wanted to check if the day before at 11pm filters it out and the next day at 1am includes it.</p>
<p>I stumbled across <a href="https://github.com/wolfcw/libfaketime">faketime</a>, which I installed from a system package.
It&#39;s available on Fedora via <code>sudo dnf install libfaketime</code>, and similar packages exist on other distributions.</p>
<p>Using it is straightforward.
You give it a timestamp and a program to run.
Then it runs the program while intercepting system calls to time functions.
This lets you very easily test something out at a few different times without any modifications to your program or system clock.</p>
<p>Here&#39;s how I used it for testing this issue:</p>
<pre data-lang="bash"><code data-lang="bash"># verify that the post disappears before publication time
faketime &#34;sunday 11pm&#34; zola serve

# verify that the post appears after publication time
faketime &#34;monday 1am&#34; zola serve
</code></pre>
<p>It can do a few other really useful things, too.</p>
<ul>
<li>Set a specific time: <code>faketime &#34;2024-01-01 12:00:00&#34; zola serve</code></li>
<li>Start at a time, and go 10x faster: <code>faketime -f &#34;@2024-07-21 23:59:00 x10&#34; zola serve</code></li>
<li>Advance by an interval (here, 10 seconds) on each call to get the system time: <code>faketime -f &#34;@2024-07-21 23:59:00 i10.0&#34; zola serve</code></li>
</ul>
<p>I just use the simple ones with relative times usually, but it&#39;s very nice being able to speed up time!
<code>faketime</code> is available as a program or a C library, so it can also be integrated into other programs for testing.</p>
<hr/>
<div id="this-too"><p><sup>1</sup></p><p>With a deep dose of irony, this post <em>also</em> published early.
I spent a couple of hours digging in last night and fixing something, because originally I&#39;d not really fixed the bug!
Now it is truly fixed, but wow was that a funny twist.</p>
</div>
<div id="tag-bug"><p><sup>2</sup></p><p>This approach does yield a minor bug: hidden posts are included in the count for tags, but are <em>not</em> displayed in the list.
In an ideal world, I&#39;d not include them in the count.
But this is not an ideal world.</p>
</div>
</div><p>
    If this post was enjoyable or useful for you, <strong>please share it!</strong>
    If you have comments, questions, or feedback, you can email <a href="mailto:me@ntietz.com">my personal email</a>.
    To get new posts and support my work, subscribe to the <a href="https://ntietz.com/newsletter/">newsletter</a>. There is also an <a href="https://ntietz.com/atom.xml">RSS feed</a>.
  </p></div>
  </body>
</html>
