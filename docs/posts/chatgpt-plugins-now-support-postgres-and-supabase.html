<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://supabase.com/blog/chatgpt-plugins-support-postgres">Original</a>
    <h1>ChatGPT plugins now support Postgres and Supabase</h1>
    
    <div id="readability-page-1" class="page"><article><div><p><span><img alt="ChatGPT plugins now support Postgres &amp; Supabase" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="fill"/></span></p><p>One of the challenges that ChatGPT faces is being able to answer questions from a private dataset. We can solve this with “retrieval plugins”, which allow ChatGPT to access information from a database.</p>
<p>Supabase recently contributed to the OpenAI repo with a <a href="https://github.com/openai/chatgpt-retrieval-plugin#postgres">Postgres</a> and a <a href="https://github.com/openai/chatgpt-retrieval-plugin#supabase">Supabase</a> implementation to help developers build plugins using pgvector.</p>
<p>Let’s dig into the specifics of Retrieval plugins, then we can implement an example - we’ll ingest all of the Postgres docs into a Supabase database, then get ChatGPT to answer questions. It’s a contrived example since ChatGPT already knows about Postgres, but what other data source would Supabase want to use?</p>
<h2 id="what-is-chatgpt-retrieval-plugin">What is ChatGPT Retrieval Plugin?</h2>
<p>ChatGPT recently released <a href="https://openai.com/blog/chatgpt-plugins">Plugins</a> which help ChatGPT access up-to-date information, run computations, or use third-party services.</p>
<p>A <a href="https://github.com/openai/chatgpt-retrieval-plugin">Retrieval Plugin</a> is a Python project designed to inject external data into the ChatGPT. It allows ChatGPT to dynamically pull relevant information into conversations from your data sources. This could be PDF documents, Confluence, or Notion knowledge bases.</p>
<p>A retrieval plugin does a few things:</p>
<ol>
<li>Turn documents into smaller chunks.</li>
<li>Converts chunks into embeddings using OpenAI&#39;s <code>text-embedding-ada-002</code> model.</li>
<li>Stores the embeddings into a vector database.</li>
<li>Queries the vector database for relevant documents when a question is asked.</li>
</ol>
<p>You can choose your preferred vector database provider from a list of <a href="https://github.com/openai/chatgpt-retrieval-plugin#choosing-a-vector-database">supported options</a>.</p>
<h2 id="adding-supabase-and-postgres-as-datastore-options-for-chatgpt-retrieval-plugin">Adding Supabase and Postgres as Datastore options for ChatGPT Retrieval Plugin</h2>
<p>We&#39;ve implemented two vector provider options: one for Postgres and one for Supabase. The main differences are:</p>
<ul>
<li>The Postgres version uses the <code>psycopg2</code> python library to directly connect to the database.</li>
<li>The Supabase version interacts with the database via PostgREST. This is helpful if you want to use <a href="https://supabase.com/docs/guides/auth/row-level-security">Row Level Security</a> or if you are planning to use the data in the Retrieval store beyond ChatGPT.</li>
</ul>
<p>The Postgres implementation is great to start with because there are now a <a href="https://github.com/pgvector/pgvector/issues/54">large number of providers</a> supporting pgvector.</p>
<p>Both have the same schema so you can easily switch between them:</p>

<p>When you create the retrieval store inside your database, a stored function is implemented to query and find relevant information for your question to ChatGPT:</p>

<p>We apply filters based on the source, author, document, and date, and find the closest embeddings using the inner product distance function. This function offers the best performance when the embeddings are normalized, which is the case for OpenAI embeddings. The similarity is calculated as: <code>(documents.embedding &lt;#&gt; in_embedding) * -1 as similarity</code>. And that’s it, you can now seamlessly use the Retrieval Plugin with a Postgres Database underneath, eliminating the need for any manual implementation on your end.</p>
<h2 id="example-chat-with-postgres-docs">Example: Chat with Postgres Docs</h2>
<p>Let’s build an example where we can “ask ChatGPT questions” about the Postgres documentation.</p>
<p>This will require several steps:</p>
<ol>
<li>Download all the <a href="https://www.postgresql.org/files/documentation/pdf/15/postgresql-15-US.pdf">Postgres docs as a PDF</a></li>
<li>Convert the docs into chunks of embedded text and store them in Supabase</li>
<li>Run our plugin locally so that we can ask questions about the Postgres docs.</li>
</ol>
<p><img alt="diagram reference" src="https://supabase.com/images/blog/2023-05-25-chatgpt-plugins-support-postgres/chatgpt-plugin-scheme--light.png"/>
<img alt="diagram reference" src="https://supabase.com/images/blog/2023-05-25-chatgpt-plugins-support-postgres/chatgpt-plugin-scheme--dark.png"/></p><h3 id="step-1-fork-the-chatgpt-retrieval-plugin-repository">Step 1: Fork the ChatGPT Retrieval Plugin repository</h3>
<p>Fork the ChatGPT Retrieval Plugin repository to your GitHub account and clone it to your local machine. Read through the <code>README.md</code> file to understand the project structure.</p>
<h3 id="step-2-install-dependencies">Step 2: Install dependencies</h3>
<p>Choose your desired datastore provider and remove unused dependencies from <code>pyproject.toml</code>. For this example, we&#39;ll use Supabase. And install dependencies with Poetry:</p>

<h3 id="step-3-create-a-supabase-project">Step 3: Create a Supabase project</h3>
<p>Create a <a href="https://supabase.com/dashboard">Supabase project</a> and database by following the instructions <a href="https://supabase.com/docs/guides/platform">here</a>. Export the environment variables required for the retrieval plugin to work:</p>

<p>For Postgres datastore, you&#39;ll need to export these environment variables instead:</p>

<h3 id="step-4-run-postgres-locally">Step 4: Run Postgres Locally</h3>
<p>To start quicker you may use Supabase CLI to spin everything up locally as it already includes pgvector from the start. Install <code>supabase-cli</code>, go to the <code>examples/providers</code> folder in the repo and run:</p>

<p>This will pull all docker images and run supabase stack in docker on your local machine. It will also apply all the necessary migrations to set the whole thing up. You can then use your local setup the same way, just export the environment variables and follow to the next steps.</p>
<p>Using <code>supabase-cli</code> is not required and you can use any other docker image or hosted version of PostgresDB that includes <code>pgvector</code>. Just make sure you run migrations from <code>examples/providers/supabase/migrations/20230414142107_init_pg_vector.sql</code>.</p>
<h3 id="step-5-obtain-openai-api-key">Step 5: Obtain OpenAI API key</h3>
<p>To create embeddings Plugin uses OpenAI API and <code>text-embedding-ada-002</code> model. Each time we add some data to our datastore, or try to query relevant information from it, embedding will be created either for inserted data chunk, or for the query itself. To make it work we need to export <code>OPENAI_API_KEY</code>. If you already have an account in OpenAI, you just need to go to <a href="https://platform.openai.com/account/api-keys">User Settings - API keys</a> and Create new secret key.</p>
<p><span><span><img alt="OpenAI Secret Keys" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="fill"/></span></span></p>
<h3 id="step-6-run-the-plugin">Step 6: Run the plugin!</h3>
<p>Execute the following command to run the plugin:</p>

<p>The plugin will start on your localhost - port :3333 by default.</p>
<h3 id="step-6-populating-data-in-the-datastore">Step 6: Populating data in the datastore</h3>
<p>For this example, we&#39;ll upload Postgres documentation to the datastore. Download the <a href="https://www.postgresql.org/files/documentation/pdf/15/postgresql-15-US.pdf">Postgres documentation</a> and use the <code>/upsert-file</code> endpoint to upload it:</p>

<p>The plugin will split your data and documents into smaller chunks automatically. You can view the chunks using the Supabase dashboard or any other SQL client you prefer. For the whole Postgres Documentation I got 7,904 records in my documents table, which is not a lot, but we can try to add index for <code>embedding</code> column to speed things up by a little. To do so, you should run the following SQL command:</p>

<p>This will create an index for the inner product distance function. Important to note that it is an approximate index. It will change the logic from performing the exact nearest neighbor search to the approximate nearest neighbor search.</p>
<p>We are using <code>lists = 10</code>, because as a general guideline, you should start looking for optimal lists constant value with the formula: <code>rows / 1000</code> when you have less than 1 million records in your table.</p>
<p>Now, it is time to add our plugin to ChatGPT.</p>
<h3 id="empowering-chatgpt-with-postgres-knowledge">Empowering ChatGPT with Postgres knowledge</h3>
<p>To integrate our plugin with ChatGPT, register it in the ChatGPT dashboard. Assuming you have access to ChatGPT Plugins and plugin development, select the Plugins model in a new chat, then choose &#34;Plugin store&#34; and &#34;Develop your own plugin.&#34; Enter <code>localhost:3333</code> into the domain input, and your plugin is now part of ChatGPT.</p>
<p><span><span><img alt="ChatGPT Change Model" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="fill"/></span></span></p>
<p><span><span><img alt="ChatGPT Plugin Store" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="fill"/></span></span></p>
<p><span><span><img alt="ChatGPT Local Plugin" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="fill"/></span></span></p>
<p>You can now ask questions about Postgres and receive answers derived from the documentation!</p>
<p>Let&#39;s try it out: ask ChatGPT to find out when to use <code>check</code> and when to use <code>using</code>. You will be able to see what queries were sent to our plugin and what it responded to.</p>
<p><span><span><img alt="Ask ChatGPT" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="fill"/></span></span></p>
<p><span><span><img alt="ChatGPT Query" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="fill"/></span></span></p>
<p>And after ChatGPT receives a response from the plugin it will answer your question with the data from the documentation.</p>
<p><span><span><img alt="ChatGPT Reply" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="fill"/></span></span></p>
<h2 id="wrap-up">Wrap up</h2>
<p>It&#39;s easy to bring any context into the datastore and utilize it with ChatGPT. Simply export your knowledge base from platforms like Notion or Confluence, upload it to the datastore, and you&#39;re good to go. You can also use any other datastore provider you prefer.</p>
<p>And the good news is that you’re not limited by using it with ChatGPT, you can embed it in your website or documentation, and build a Slack bot or telegram bot to answer questions about your company or product. For that, you will only need to add a single call to OpenAI API to create a summary of data retrieved from the Plugin. You can find some inspiration on how to do that in our blog post about building <a href="https://supabase.com/blog/chatgpt-supabase-docs">Supabase Clippy assistant</a>.</p>
<p>Let us know on <a href="https://twitter.com/Supabase">Twitter</a> if you are building ChatGPT Plugins. We can’t wait to see what you will build!</p>
<h2 id="more-ai-resources">More AI resources</h2>
<ul>
<li><a href="https://platform.openai.com/docs/plugins/introduction">OpenAI ChatGPT Plugin docs</a></li>
<li><a href="https://github.com/openai/chatgpt-retrieval-plugin">ChatGPT Retrieval Plugin Repo</a></li>
<li><a href="https://supabase.com/blog/building-chatgpt-plugins-template">How to build ChatGPT Plugin from scratch with Supabase Edge Runtime</a>.</li>
<li><a href="https://supabase.com/docs/guides/database/extensions/pgvector">Docs pgvector: Embeddings and vector similarity</a></li>
</ul></div></article></div>
  </body>
</html>
