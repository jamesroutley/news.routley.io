<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://feyor.sh/blog/my-other-email-client-is-a-mail-daemon/">Original</a>
    <h1>My other email client is a daemon</h1>
    
    <div id="readability-page-1" class="page"><div id="main-content">




<content>
  <figure><img src="https://feyor.sh/blog/my-other-email-client-is-a-mail-daemon/yodawg.jpg"/>
</figure>

<p>I have a slight problem wherein every time I start up a game of NetHack, I completely loose touch with my surroundings for hours on end.
Thankfully <a href="https://nethackwiki.com/wiki/The_DevTeam_Thinks_of_Everything">The DevTeam Thinks Of Everything</a> and there’s a solution that allows communication with the outside world without breaking immersion: the mail daemon!</p>
<p>If compiled with <code>-DMAIL</code> and <code>OPTIONS=mail</code> (the default on Linux), NetHack will periodically check a user specified mbox file (<code>MAIL</code>) for new mail, and upon receiving an email a mail daemon will spawn in and deliver a scroll of mail to the player.
Upon reading this scroll a mail program (<code>MAILREADER</code>) will be executed, which hopefully allows you to read your mail.</p>
<p>I use the <a href="https://github.com/Feyorsh/nethack-el">Lisp window port</a> to play NetHack (the way God intended), and I <em>really</em> don’t like leaving Emacs, so let’s figure out how to integrate this feature with mu4e.
<kbd>mu</kbd> uses <a href="https://man.cx/maildir(5)">maildir</a>, not <a href="https://datatracker.ietf.org/doc/html/rfc4155">mbox</a>, so I decided to write a cron job that periodically converts my maildir to mbox format.</p>
<p>An important insight is that NetHack never checks the contents of the mailbox file, just the <code>mtime</code>.
Therefore all our script needs to do is check if our maildir contains any messages received within the last <math xmlns="http://www.w3.org/1998/Math/MathML" alttext="n" display="inline">
<mi>n</mi>
</math>
minutes, and if so <kbd>touch</kbd> the mbox file.</p>





<details open="">
  <summary>Python</summary>
  <div><pre tabindex="0"><code data-lang="python"><span><span><span>import</span> os
</span></span><span><span><span>import</span> mailbox
</span></span><span><span><span>from</span> datetime <span>import</span> datetime, timedelta
</span></span><span><span><span>import</span> pathlib
</span></span><span><span>
</span></span><span><span>MAILDIR <span>=</span> os<span>.</span>path<span>.</span>expanduser(<span>&#34;~/Mail/personal/INBOX&#34;</span>)
</span></span><span><span>MBOX <span>=</span> <span>&#34;/tmp/nh.mbox&#34;</span>
</span></span><span><span>
</span></span><span><span>maildir <span>=</span> mailbox<span>.</span>Maildir(MAILDIR)
</span></span><span><span><span>for</span> msg <span>in</span> maildir:
</span></span><span><span>    <span>if</span> datetime<span>.</span>fromtimestamp(msg<span>.</span>get_date()) <span>&gt;</span> datetime<span>.</span>now() <span>-</span> timedelta(minutes<span>=</span><span>5</span>):
</span></span><span><span>        pathlib<span>.</span>Path(MBOX)<span>.</span>touch()
</span></span><span><span>        <span>break</span>
</span></span><span><span>maildir<span>.</span>close()</span></span></code></pre></div>
</details>
<p>Next, we need a script that will open up mu4e.</p>





<details open="">
  <summary>Bash</summary>
  <div><pre tabindex="0"><code data-lang="bash"><span><span>emacsclient -n --eval <span>&#34;(progn (require &#39;mu4e) (mu4e-context-switch nil \&#34;Personal\&#34;) (mu4e-search-bookmark \&#34;maildir:/personal/INBOX AND flag:unread\&#34;))&#34;</span></span></span></code></pre></div>
</details>
<p>I’m using <kbd>emacsclient</kbd> instead of plain old <kbd>emacs</kbd> partly because only one process at a time can hold the lock on <kbd>mu</kbd>’s database, so I don’t want to spin up another Emacs process.
It’s also worth mentioning that my <kbd>emacsclient</kbd> is wrapped such that it opens a new frame if invoked outside of Emacs and reuses the current frame if invoked from within Emacs:</p>





<details open="">
  <summary>Bash</summary>
  <div><pre tabindex="0"><code data-lang="bash"><span><span><span>export</span> <span>_t</span><span>=</span><span>&#39;-c&#39;</span>
</span></span><span><span><span>exec</span> <span>&#34;/nix/store/...-emacs/bin/.emacsclient-wrapped&#34;</span>  <span>&#34;</span><span>${</span><span>_t</span>/<span>${</span><span>INSIDE_EMACS</span>:+*<span>}</span>/-u<span>}</span><span>&#34;</span> -a /nix/store/...-emacs/Applications/Emacs.app/Contents/MacOS/Emacs <span>&#34;</span><span>$@</span><span>&#34;</span></span></span></code></pre></div>
</details>
<p>Here’s some riveting gameplay footage of dungeon level 1:</p>
<figure><img src="https://feyor.sh/blog/my-other-email-client-is-a-mail-daemon/demo.gif"/>
</figure>


</content>
<p>
  
    <a href="https://feyor.sh/tags/emacs/">#emacs</a>  
  
</p>

  </div></div>
  </body>
</html>
