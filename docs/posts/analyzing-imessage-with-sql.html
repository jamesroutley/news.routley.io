<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://arctype.com/blog/search-imessage/">Original</a>
    <h1>Analyzing iMessage with SQL</h1>
    
    <div id="readability-page-1" class="page"><div>
                <p>SQLite is an often overlooked flavor of SQL engines. Some have suggested it is the most prolific SQL engine in existence due to its highly flexible nature and ability to run on almost any platform with limited resources. Unlike other SQL engines like MySQL, PostgreSQL, MSSQL, or Oracle, SQLite runs without a server. SQLite does not rely on a data directory or a constantly running daemon: a database is encapsulated in a single file.</p><h2 id="sqlite-and-imessage">SQLite and iMessage</h2><p>iMessage is one of the most <a href="https://techplanet.today/post/why-imessage-is-so-popular">popular messaging platforms</a> today, largely because it is built into iOS and Mac devices. Since its release, it has evolved significantly. But, at its core, it is simply an instant messaging platform. iMessage uses SQLite in the background to store relational data about messages, conversations, and their participants.</p><p>As a long-time Apple user, I have backed up and transferred my iPhone data since my first time using an iPhone, which was November 10, 2009. Because I have been digitally hoarding my text data for so long, my iMessage database is nearly 1GB in size.</p><p>Until a few years ago, the built-in search feature for iMessage was <a href="https://pxlnv.com/linklog/messages-search/">very limited and buggy</a>. Although it has recently improved significantly, it is, like nearly any end-user tool, very limited in how you can query it. Those of us who frequently work with data that is trapped behind a limited front-end often wish we could get direct access to the SQL database. Fortunately, the iMessage database is not inaccessible - in fact, it is very easy to access.</p><h3 id="finding-the-imessage-sql-database">Finding the iMessage SQL Database</h3><h4 id="on-your-mac">On Your Mac</h4><p>If you have iMessage enabled on your Mac as well as your iPhone, you have 2 different databases from which to choose. The database on your Mac is very easy to find, as it is simply under <code>~/Library/Messages/chat.db</code>. If you do not use your Mac for iMessage, or, as in my case, your Mac iMessages do not go as far back, you can extract your iPhone&#39;s database by performing a backup to your Mac.</p><h4 id="on-your-iphone">On Your iPhone</h4><p>Follow these instructions to extract your iPhone&#39;s iMessage database:</p><ol><li>Open Finder and select your iPhone under &#34;Locations&#34;.</li><li>Find the &#34;Backups&#34; section and select &#34;Back up all of the data on your iPhone to this Mac&#34;, then press Back Up Now to immediately create a new backup. This process may take a while.</li><li>Once it is complete, you will find the SQLite file under <code>/Users/[username]/Library/Application Support/MobileSync/Backup/[backup name]/3d/3d0d7e5fb2ce288813306e4d4636395e047a3d28</code>.</li><li>If you plan to open this database with Arctype, you&#39;ll want to copy and rename the file with a <code>.db</code> extension to indicate that it is a SQLite file.</li></ol><h2 id="getting-started-with-sqlite">Getting Started with SQLite</h2><p>Unlike most SQL servers, you do not need a connection string, host, or username to connect to a SQLite database. All you need to do is point your SQL client to the database file. <a href="https://arctype.com/blog/search-imessage/arctype.com">Arctype</a> makes it simple and convenient to load in SQLite databases within the same workspace as your other connections.</p><h3 id="with-arctype">With Arctype</h3><figure><img src="https://arctype.com/blog/content/images/2022/02/7_add_sqlite.png" alt="Add new SQLite connection" loading="lazy" width="1080" height="938" srcset="https://arctype.com/blog/content/images/size/w600/2022/02/7_add_sqlite.png 600w, https://arctype.com/blog/content/images/size/w1000/2022/02/7_add_sqlite.png 1000w, https://arctype.com/blog/content/images/2022/02/7_add_sqlite.png 1080w" sizes="(min-width: 720px) 720px"/><figcaption><center>Add new SQLite connection</center></figcaption></figure><ol><li>Under the Connections dropdown, select &#34;Add new data source&#34;</li><li>Select &#34;SQLite&#34;</li><li>Find the SQLite database file. The file must have a .sqlite3 or .db extension for Arctype to open it.</li></ol><p>More detailed instructions can be found in the <a href="https://docs.arctype.com/connect/postgresql">Arctype Docs</a>.</p><h3 id="with-command-line">With Command Line</h3><p>From a UNIX terminal, type <code>sqlite3 [filename]</code>.</p><h2 id="imessage-schema">iMessage Schema</h2><p>One of my favorite parts about Arctype is how easy it is to analyze database schema. I&#39;m a long-time user of command-line tools and old-school editors, but sometimes having a more visually interactive tool is a lifesaver. Let&#39;s dig into the schema Apple has created for iMessage. Today we will focus on the <code>chat</code>, <code>message</code>, and <code>handle</code> tables, as well as a few join tables to connect related records.</p><figure><img src="https://arctype.com/blog/content/images/2022/02/7_schema.png" alt="Key iMessage Tables" loading="lazy" width="908" height="2000" srcset="https://arctype.com/blog/content/images/size/w600/2022/02/7_schema.png 600w, https://arctype.com/blog/content/images/2022/02/7_schema.png 908w" sizes="(min-width: 720px) 720px"/><figcaption><center>Key iMessage Tables</center></figcaption></figure><p>Note that I have created a custom view called <code>handle2</code> which adds a field <code>id2</code> that obfuscates the phone numbers and email addresses of my personal contacts, and you will see this view referenced in the examples in this article.</p><h2 id="digging-into-imessage">Digging Into iMessage</h2><p>Let&#39;s write some queries and makes some observations that would not be possible without direct SQL access.</p><h3 id="pique-your-nostalgia-with-old-messages">Pique Your Nostalgia with Old Messages</h3><p>To get started, let&#39;s begin with a simple query to view your first 50 messages. If you have chat threads that go back years and years, there is no easy way to access early messages from your iPhone or Mac.</p><p>The interface on both platforms requires you to scroll back by about 25 messages at a time. This is prohibitively time-consuming and can result in a crash or reset if the user sends you a new message while you&#39;re scrolled back.</p><p>Fortunately, we have custom SQL to save us:</p><figure><pre><code>select
   h.id2 as sender_name,
   m.text as message_body
from
   message m
   join handle2 h on h.rowid = m.handle_id
order by
   m.date
limit
   50;
</code></pre><figcaption>Query to find old messages</figcaption></figure><figure><img src="https://arctype.com/blog/content/images/2022/02/7_old.png" alt="Use SQL to view old messages." loading="lazy" width="866" height="1266" srcset="https://arctype.com/blog/content/images/size/w600/2022/02/7_old.png 600w, https://arctype.com/blog/content/images/2022/02/7_old.png 866w" sizes="(min-width: 720px) 720px"/><figcaption><center>Use SQL to view old messages.</center></figcaption></figure><p><code>handle.id</code> represents the readable identifier for the user. It will be either a phone number or an email address.</p><h3 id="rate-your-friendships-with-sql">Rate Your Friendships with SQL</h3><p>Let&#39;s use SQL to find out who our best friends are. Assuming you view the quality of friendships as a function of the quantity of sent text messages, this should be very accurate!</p><p>First, let&#39;s divide the number of messages that are <code>from_me</code> by those that are not to produce a reply ratio. This query shows the top 10 people we have been messaging by the total amount of messages, as well as the reply ratio.</p><p>Multiplication by 1.0 casts to the <code>REAL</code> data type to avoid integer division, which would result in 1 or 0 instead of a decimal. You can use the link <a href="https://datacomy.com/sql/sqlite/division/">here</a> to see the rules for integer division in SQLite.</p><figure><pre><code>select
    h.id2,
    count(1) as cnt,
    round(
        sum(
            case
                when m.is_from_me then 1
                else 0
            end
        ) * 1.0 / count(1) * 100.0,
        2
    )
from
    message m
    join handle2 h on h.rowid = m.handle_id
group by
    h.id
order by
    cnt desc
limit
    10;
</code></pre><figcaption>The query for generating the reply ratio</figcaption></figure><figure><img src="https://arctype.com/blog/content/images/2022/02/7_reply.png" alt="Reply ratio between contacts." loading="lazy" width="818" height="1836" srcset="https://arctype.com/blog/content/images/size/w600/2022/02/7_reply.png 600w, https://arctype.com/blog/content/images/2022/02/7_reply.png 818w" sizes="(min-width: 720px) 720px"/><figcaption><center>Reply ratio between contacts.</center></figcaption></figure><p>One issue with this analysis is that fewer sent messages does not necessarily imply fewer words sent. Let&#39;s add some more fields to get a better insight.</p><p>Here we can see the total amount of characters sent and received, the average length of text message sent and received, the total ratio of characters sent and received, and the reply ratio. In my case, people from whom I tend to receive more messages also send longer messages than me.</p><figure><pre><code>select
    h.id,
    count(1) as cnt,
    sum(length(m.text)) as chars,
    sum(length(m.text)) filter (where m.is_from_me) as chars_sent,
    sum(length(m.text)) filter (where not m.is_from_me) as chars_received,

    round(avg(length(m.text)) filter (where m.is_from_me)) as avg_length_sent,
    round(avg(length(m.text)) filter (where not m.is_from_me)) as avg_length_received,

    round((sum(length(m.text)) filter (where m.is_from_me) * 1.0 / sum(length(m.text)) filter (where not m.is_from_me)), 2) as characters_sent_ratio,
    round((count(1) filter (where m.is_from_me)) * 1.0 / (count(1) filter (where not m.is_from_me)), 2) as reply_ratio
from
    message m
    join handle h on h.rowid = m.handle_id
group by
    h.id
order by
    cnt desc
limit
    10; 
</code></pre><figcaption>Expanding the query to see message length</figcaption></figure><figure><img src="https://arctype.com/blog/content/images/2022/02/7_character.png" alt="Friend iMessage statistics." loading="lazy" width="2000" height="1774" srcset="https://arctype.com/blog/content/images/size/w600/2022/02/7_character.png 600w, https://arctype.com/blog/content/images/size/w1000/2022/02/7_character.png 1000w, https://arctype.com/blog/content/images/size/w1600/2022/02/7_character.png 1600w, https://arctype.com/blog/content/images/2022/02/7_character.png 2212w" sizes="(min-width: 720px) 720px"/><figcaption>Friend iMessage statistics</figcaption></figure><p>This query makes heavy use of <a href="https://modern-sql.com/feature/filter">aggregate filters</a>. Aggregate filters allow you to use an aggregate function on only a part of the data by specifying a <code>WHERE</code> clause to filter out unwanted records.</p><h3 id="examining-imessage-reactions">Examining iMessage Reactions</h3><p>There are 2 newer iMessage features whose implementations, in the context of their schema design, are interesting to look into. Recently <a href="https://www.droid-life.com/2022/01/31/imessage-reactions-google-android/">an announcement was made</a> that Android phones will be able to show iMessage &#34;reactions&#34; properly. Historically, if you send an iMessage reaction to a non-Apple device, it will show up as a textual addition instead of an icon.</p><figure><img src="https://arctype.com/blog/content/images/2022/02/7_reactions_diff.png" alt="iMessage reactions show up as messages on an Android phone" loading="lazy" width="1000" height="1000" srcset="https://arctype.com/blog/content/images/size/w600/2022/02/7_reactions_diff.png 600w, https://arctype.com/blog/content/images/2022/02/7_reactions_diff.png 1000w" sizes="(min-width: 720px) 720px"/><figcaption><center>iMessage reactions show up as messages on an Android phone</center></figcaption></figure><p>With the announcement of the new compatibility with Android devices, I was curious to learn how the current implementation of the feature works.</p><p>I <code>SELECT</code>ed a few records with and without a reaction and compared the results. I discovered that the <code>associated_message_type</code> column was usually set to 0, but in messages with a reaction, it was an integer value between 2000-2005. I also noticed that <code>associated_message_guid</code> was present. Apple appears to be using 2000-2005 for its 5 reaction types, 3000-3005 for when a user removed a reaction, and 3 for an Apple Pay request.</p><figure><img src="https://arctype.com/blog/content/images/2022/02/7_reactions.png" alt="Rows with associated_message_guid" loading="lazy" width="1816" height="820" srcset="https://arctype.com/blog/content/images/size/w600/2022/02/7_reactions.png 600w, https://arctype.com/blog/content/images/size/w1000/2022/02/7_reactions.png 1000w, https://arctype.com/blog/content/images/size/w1600/2022/02/7_reactions.png 1600w, https://arctype.com/blog/content/images/2022/02/7_reactions.png 1816w" sizes="(min-width: 720px) 720px"/><figcaption><center>Rows with associated_message_guid</center></figcaption></figure><p>From this investigation, it appears that reactions are sent as iMessages with the reaction&#39;s textual equivalent appended and a foreign key relation to the parent message. This allows the messages to seamlessly be sent and received by non-Apple devices.</p><p>If the message is sent over SMS, the metadata linking the reaction to the message it references is simply lost. If the device is iMessage capable, Apple devices will ignore the <code>text</code> part of the message, find the associated message and add the proper reaction as a visual overlay.</p><p>Note that the <code>message</code> table includes both a <code>ROWID</code> and a <code>guid</code>. <code>ROWID</code> is a typical auto-increment integer <code>id</code> field, which is useful for joining on within the local database. However, the auto-incremented primary key will not be the same for the same message across devices. The <code>GUID</code> is globally unique, generated by the author of the message, and sent to all of its recipients. This allows foreign key references across different databases, devices, and users. For more information about the utility of GUIDs, check out <a href="https://arctype.com/blog/postgres-uuid/">this article</a>.</p><h3 id="find-your-most-popular-group-chats">Find Your Most Popular Group Chats</h3><p>Group chats are stored in the <code>chat</code> table. Join tables <code>chat_handle_join</code> and <code>chat_message_join</code> are used to associate users and messages, respectively, with group chats. Here&#39;s a query to find out most used group chats (chat with &gt; 1 members) and the identities of their participants.</p><figure><pre><code>select
    group_concat(distinct h.id2) as participants,
    count(m. &#34;ROWID&#34;) as message_count
from
    chat c
    join chat_handle_join chj on chj.chat_id = c.&#34;ROWID&#34;
    join handle2 h on h. &#34;ROWID&#34; = chj.handle_id
    join chat_message_join cmj on cmj.chat_id = c.&#34;ROWID&#34;
    join message m on m. &#34;ROWID&#34; = cmj.message_id
group by
    c.&#34;ROWID&#34;
having
    count(distinct h.id) &gt; 1
order by
    message_count desc
limit
    10
</code></pre><figcaption>Query to find the most popular group chats</figcaption></figure><figure><img src="https://arctype.com/blog/content/images/2022/02/7_chat.png" alt="Find your most popular group chats." loading="lazy" width="1372" height="1802" srcset="https://arctype.com/blog/content/images/size/w600/2022/02/7_chat.png 600w, https://arctype.com/blog/content/images/size/w1000/2022/02/7_chat.png 1000w, https://arctype.com/blog/content/images/2022/02/7_chat.png 1372w" sizes="(min-width: 720px) 720px"/><figcaption><center>Find your most popular group chats.</center></figcaption></figure><figure><img src="https://arctype.com/blog/content/images/2022/03/image--3-.png" alt="Chart screeshot" loading="lazy" width="2000" height="1435" srcset="https://arctype.com/blog/content/images/size/w600/2022/03/image--3-.png 600w, https://arctype.com/blog/content/images/size/w1000/2022/03/image--3-.png 1000w, https://arctype.com/blog/content/images/size/w1600/2022/03/image--3-.png 1600w, https://arctype.com/blog/content/images/size/w2400/2022/03/image--3-.png 2400w" sizes="(min-width: 720px) 720px"/><figcaption>Visualizing the result in <a href="https://arctype.com/blog/search-imessage/arctype.com">Arctype</a></figcaption></figure><p>The <code>group_concat</code> function, which is familiar from MySQL by the same name and familiar to PostgreSQL users as <code>string_agg</code>, is an aggregate function that concatenates strings together. See more on how it can be used within SQLite <a href="https://www.sqlite.org/lang_aggfunc.html#group_concat">here</a>.</p><p>The <code>HAVING</code> clause is similar to a <code>WHERE</code> clause but operates on aggregate functions. If you&#39;ve wanted to write a query conditional on an aggregate but are not able to inside of your <code>WHERE</code> clause, <code>HAVING</code> is <a href="https://www.sqlitetutorial.net/sqlite-having/">there for you</a>.</p><h2 id="conclusion">Conclusion</h2><p>SQLite is a powerful tool whose prolific reach across devices and numerous use cases make it one of the most impressive software projects around. If you&#39;re curious about what&#39;s behind the scenes, SQLite&#39;s <a href="https://sqlite.org/src/doc/trunk/README.md">source code</a> is well known to be well-organized and fun (well, to some of us) to peek into.</p><p>iMessage is just one of many pieces of software that rely on SQLite and are used by millions of end-users. You can try out a SQL client <a href="https://arctype.com/blog/search-imessage/arctype.com">like Arctype</a> for free and start exploring the databases that power the tools you use daily!</p><!--kg-card-begin: html--><div>
    <p>JOIN the Arctype Newsletter</p>
    <p>Programming stories, tutorials, and database tips every 2 weeks</p>
    
</div><!--kg-card-end: html-->
            </div></div>
  </body>
</html>
