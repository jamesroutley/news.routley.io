<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://nns.ee/blog/2021/04/03/modem-rce.html">Original</a>
    <h1>Code execution as root via AT commands on the Quectel EG25-G modem (2021)</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody">
                <p>As I mentioned towards the end of my <a href="https://nns.ee/blog/2021/04/01/modem-blog.html">previous blog post</a>, where I detailed running my blog on the PinePhone&#39;s GSM/WWAN/GPS modem, I suspected that the daemon responsible for parsing AT commands on the modem&#39;s side is susceptible to OS command injection, as it uses a <em>lot</em> of <code>system()</code> calls. My hunch turned out to be true.</p>
                <!--description-->
                <h2 id="communication-with-the-pinephone">Communication with the PinePhone</h2>
                <p>Among other channels, the PinePhone communicates with the Quectel modem by sending <a href="https://en.wikipedia.org/wiki/Hayes_command_set">AT commands</a> to the modem over a serial line - <code>/dev/ttyUSB2</code> on the PinePhone&#39;s side and <code>/dev/ttyHSL0</code> on the modem&#39;s side.</p>
                <p>The modem, which runs a <a href="https://nns.ee/blog/2021/04/01/modem-blog.html">full Linux install</a> separate from the PinePhone&#39;s main OS, receives these commands, parses them, and executes them according to program logic. After this, the modem either returns <code>OK</code> or <code>ERROR</code> over the serial line back to the PinePhone. The daemon primarily responsible for this is <code>atfwd_daemon</code>.</p>
                <h2 id="analyzing-atfwd_daemon">Analyzing <code>atfwd_daemon</code></h2>
                <p>Getting the daemon is easy. It&#39;s possible to set up <a href="https://xnux.eu/devices/feature/modem-pp.html#toc-unlock-adb-access"><code>adb</code> access</a> and extract it using <code>adb</code>. It&#39;s also possible to simply extract it from the firmware&#39;s update packages, as it&#39;s not encrypted in any way.</p>
                <p>Loading <code>atfwd_daemon</code> in Ghidra reveals that the executable uses <code>system()</code> in 233 different places across the file. That&#39;sâ€¦ quite a lot.</p>
                <p>While using <code>system()</code> with user input is never a good idea, most of the calls cannot be exploited due to being hardcoded or the fact that user input is converted to an integer using <code>sprintf()</code>:</p>
                <p><a href="https://arse.ee/1BSw4BQZ.png"><img src="https://arse.ee/1BSw4BQZ.png" alt="https://arse.ee/1BSw4BQZ.png"/></a></p>
                <p>However, there are a few places where user input is <code>sprintf()</code>-d as <code>%s</code> and no checks or sanitization is performed on user input.</p>
                <p>One of these places is in a routine called <code>quectel_handle_fumo_cfg_command()</code>:</p>
                <p><a href="https://arse.ee/EnUTEnhj.png"><img src="https://arse.ee/EnUTEnhj.png" alt="https://arse.ee/EnUTEnhj.png"/></a></p>
                <p>Here we can see that <code>param1[1]</code> is being formatted as <code>ipth_dme -dmacc %s &amp;</code>, which is then passed to <code>system()</code>. What&#39;s interesting to note here is that <code>ipth_dme</code> does not exist on the system at all, so this program would never run.</p>
                <p>Traversing the program execution flow, we can see that the switch case in the previous screenshot is triggered when some part of user input begins with &#34;dmacc&#34;. This is checked in a routine called <code>quectel_parse_fumo_cfg_cmd_params()</code>:</p>
                <p><a href="https://arse.ee/DSuRVPK1.png"><img src="https://arse.ee/DSuRVPK1.png" alt="https://arse.ee/DSuRVPK1.png"/></a></p>
                <p>The rest of the input remains relatively untouched.</p>
                <p>Going further up the program flow, we can see that the command in question which parses this input is <code>+QFUMOCFG</code>:</p>
                <p><a href="https://arse.ee/wCONynTY.png"><img src="https://arse.ee/wCONynTY.png" alt="https://arse.ee/wCONynTY.png"/></a></p>
                <h2 id="code-execution">Code execution</h2>
                <p>From this, we can deduce that arbitrary command execution is possible. We can, for example, use backticks to execute our commands in a subshell. As an example, to reboot the modem:</p>
                <div>
                  <div>
                    <pre><code>AT+QFUMOCFG=&#34;dmacc&#34;,&#34;`reboot`&#34;
</code></pre>
                  </div>
                </div>
                <p>Due to the fact that the daemon runs as root, the code is also being executed as the root user on the modem.</p>
                <p>As an example, in this <a href="https://asciinema.org/a/IANZkjwk9lw82pOKFLsWvsi9k">Asciinema recording</a>, I <code>cat /etc/passwd</code> and run <code>id</code>, and return the data to the PinePhone&#39;s OS over a serial line:</p>
                <p><a href="https://asciinema.org/a/IANZkjwk9lw82pOKFLsWvsi9k"><img src="https://asciinema.org/a/IANZkjwk9lw82pOKFLsWvsi9k.svg" alt="asciicast"/></a></p>
                <p>It&#39;s very possible that this vulnerability affects other Quectel products as well, as firmware is commonly reused, but I do not possess other hardware to test it on.</p>
                <div>
                  <hr/>
                  <h3>Timeline</h3>
                  <ul>
                    <li><b>03/04/2021</b> - Attempted to contact vendor</li>
                    <li><b>13/04/2021</b> - Vendor confirmed vulnerability</li>
                    <li><b>23/04/2021</b> - Vendor issued $2,000 bounty</li>
                    <li><b>24/04/2021</b> - Assigned ID CVE-2021-31698</li>
                    <li><b>08/09/2021</b> - Write-up published</li>
                  </ul>
                </div>
              </div></div>
  </body>
</html>
