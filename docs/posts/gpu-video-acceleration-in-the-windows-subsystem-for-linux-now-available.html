<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://devblogs.microsoft.com/commandline/d3d12-gpu-video-acceleration-in-the-windows-subsystem-for-linux-now-available/">Original</a>
    <h1>GPU Video acceleration in the Windows Subsystem for Linux now available</h1>
    
    <div id="readability-page-1" class="page"><div id="featured">

	<div>
                         <p>
            February 13th, 2023</p><!-- .entry-meta -->
        

<p>In <a href="https://devblogs.microsoft.com/directx/directx-heart-linux/">DirectX ❤ Linux – DirectX Developer Blog</a> we wrote about DXCore &amp; D3D12 support on WSLg and described OpenGL &amp; OpenCL support by adding a D3D12 backend to <a href="https://mesa3d.org/">Mesa 3D</a>, allowing such 3D and compute workloads to be offloaded to the GPU. </p><figure id="attachment_8402" aria-describedby="caption-attachment-8402"><img decoding="async" data-src="https://devblogs.microsoft.com/commandline/wp-content/uploads/sites/33/2023/02/wsl_gst_animation.gif" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAA4AQMAAAAxYM+bAAAAA1BMVEXW1taWrGEgAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAEElEQVQokWNgGAWjYBTAAAADEAABC3uRhAAAAABJRU5ErkJggg==" alt="Gstreamer playing an mp4 video in an X11 Windows in WSL using GPU acceleration." width="426" height="240"/><figcaption id="caption-attachment-8402"><a href="https://devblogs.microsoft.com/commandline/wp-content/uploads/sites/33/2023/02/wsl_gst_animation.gif">3</a> Gstreamer playing an mp4 video in an X11 Windows in WSL using GPU acceleration.</figcaption></figure>
<p>To extend the types of workloads that we can accelerate with the GPU in WSLg, we also recently added support for GPU Video Acceleration by building on top of the existing <a href="https://mesa3d.org/">Mesa 3D</a> D3D12 backend and integrating the <a href="https://github.com/intel/libva">VAAPI</a> mesa frontend. Several linux media apps use the VAAPI interface to access hardware video acceleration when available, and this can now be leveraged in WSLg.</p>
<p>When decoding, encoding or processing a video, you have the option to do so using the CPU or -when available- offload it to accelerator hardware, usually delegating it to the GPU. Leveraging video hardware acceleration instead of using the CPU usually has several benefits: increased performance, lower power consumption and it frees up those CPU cycles to be available for other tasks in WSL or even in the Windows host, increasing overall performance. The benefits of using the GPU increase as the resolution of the video gets higher.</p>
<p>When running the samples at the end of this post, you can check out in the Windows Task Manager the CPU/GPU usage difference when enabling WSLg hardware video acceleration or when using the CPU. More information about this at: <a href="https://devblogs.microsoft.com/directx/gpus-in-the-task-manager/">GPUs in the task manager – DirectX Developer Blog.</a></p>

<p>Customers can now run video workloads <span>such as </span><span>decode</span><span>, </span><span>encode</span><span> and video processing i</span>n WSLg accelerated on the GPU with apps supporting VAAPI, for example: <a href="https://ffmpeg.org/">FFmpeg</a> or <a href="https://gstreamer.freedesktop.org/">GStreamer</a>. The following are the VA entrypoints and profiles implemented on top of D3D12.</p>
<table>
<tbody>
<tr>
<td>
<h3>
          Profile name
        </h3>
</td>
<td>
<h3>
          Entrypoint name
        </h3>
</td>
<td>
<h3>
          Mesa version required
        </h3>
</td>
</tr>
<tr>
<td>
        <span>VAProfileH264ConstrainedBaseline</span>
      </td>
<td>
        <span>VAEntrypointVLD</span>
      </td>
<td>
        <span>22.2</span>
      </td>
</tr>
<tr>
<td>
        <span>VAProfileH264ConstrainedBaseline</span>
      </td>
<td>
        <span>VAEntrypointEncSlice</span>
      </td>
<td>
        <span>22.2</span>
      </td>
</tr>
<tr>
<td>
        <span>VAProfileH264Main</span>
      </td>
<td>
        <span>VAEntrypointVLD</span>
      </td>
<td>
        <span>22.2</span>
      </td>
</tr>
<tr>
<td>
        <span>VAProfileH264Main</span>
      </td>
<td>
        <span>VAEntrypointEncSlice</span>
      </td>
<td>
        <span>22.2</span>
      </td>
</tr>
<tr>
<td>
        <span>VAProfileH264High</span>
      </td>
<td>
        <span>VAEntrypointVLD</span>
      </td>
<td>
        <span>22.2</span>
      </td>
</tr>
<tr>
<td>
        <span>VAProfileH264High</span>
      </td>
<td>
        <span>VAEntrypointEncSlice</span>
      </td>
<td>
        <span>22.2</span>
      </td>
</tr>
<tr>
<td>
        <span>VAProfileHEVCMain</span>
      </td>
<td>
        <span>VAEntrypointVLD</span>
      </td>
<td>
        <span>22.3</span>
      </td>
</tr>
<tr>
<td>
        <span>VAProfileHEVCMain</span>
      </td>
<td>
        <span>VAEntrypointEncSlice</span>
      </td>
<td>
        <span>22.3</span>
      </td>
</tr>
<tr>
<td>
        <span>VAProfileHEVCMain10</span>
      </td>
<td>
        <span>VAEntrypointVLD</span>
      </td>
<td>
        <span>22.3</span>
      </td>
</tr>
<tr>
<td>
        <span>VAProfileHEVCMain10</span>
      </td>
<td>
        <span>VAEntrypointEncSlice</span>
      </td>
<td>
        <span>22.3</span>
      </td>
</tr>
<tr>
<td>
        <span>VAProfileVP9Profile0</span>
      </td>
<td>
        <span>VAEntrypointVLD</span>
      </td>
<td>
        <span>22.3</span>
      </td>
</tr>
<tr>
<td>
        <span>VAProfileVP9Profile2</span>
      </td>
<td>
        <span>VAEntrypointVLD</span>
      </td>
<td>
        <span>22.3</span>
      </td>
</tr>
<tr>
<td>
        <span>VAProfileAV1Profile0</span>
      </td>
<td>
        <span>VAEntrypointVLD</span>
      </td>
<td>
        <span>22.3</span>
      </td>
</tr>
<tr>
<td>
        <span>VAProfileNone</span>
      </td>
<td>
        <span>VAEntrypointVideoProc</span>
      </td>
<td>
        <span>22.2</span>
      </td>
</tr>
</tbody>
</table>
<p><span><em>This list is illustrative of a GPU and vendor driver supporting all possible entrypoints/profiles using mesa 22.3. The actual capabilities reported in </em><a href="https://github.com/intel/libva/blob/6e86b4fb4dafa123b1e31821f61da88f10cfbe91/va/va.h#L1447"><em>vaQueryConfigProfiles</em></a><em>, </em><a href="https://github.com/intel/libva/blob/6e86b4fb4dafa123b1e31821f61da88f10cfbe91/va/va.h#L1459"><em>vaQueryConfigEntrypoints</em></a><em> , </em><a href="https://github.com/intel/libva/blob/6e86b4fb4dafa123b1e31821f61da88f10cfbe91/va/va.h#L1474"><em>vaQueryConfigAttributes</em></a><em>, </em><a href="https://github.com/intel/libva/blob/6e86b4fb4dafa123b1e31821f61da88f10cfbe91/va/va_vpp.h#L1576"><em>VaQueryVideoProcPipelineCaps</em></a><em> and others are dynamically queried from the underlying GPU and might vary between platforms and driver versions. The vainfo utility will list the actual subset of entrypoints/profiles supported by your hardware and applications will adjust to the available features reported.</em></span></p>


<ol>
<li>Install <a href="https://apps.microsoft.com/store/detail/windows-subsystem-for-linux/9P9TQF7MRM4R?hl=en-us&amp;gl=us">Windows Subsystem for Linux – Microsoft Store Apps</a> (version <a href="https://github.com/microsoft/WSL/releases/tag/1.1.0">1.1.0</a> or newer)</li>
<li>Install a distro like <a href="https://apps.microsoft.com/store/detail/ubuntu-22041-lts/9PN20MSR04DW">Ubuntu 22.04.1 LTS – Microsoft Store Apps</a></li>
<li>Enable <a href="https://devblogs.microsoft.com/commandline/systemd-support-is-now-available-in-wsl/#set-the-systemd-flag-set-in-your-wsl-distro-settings">systemd in WSL</a>.</li>
<li>Follow the table in the hardware platforms support section and install a GPU driver from your vendor’s website with a version higher or equal than specified.</li>
</ol>

<p>The scenarios mentioned in this article are upstreamed to <a href="https://gitlab.freedesktop.org/mesa/mesa">mesa/main</a> and available in <a href="https://docs.mesa3d.org/relnotes/22.2.0.html">mesa 22.2.0</a> and <a href="https://docs.mesa3d.org/relnotes/22.3.0.html">mesa 22.3.0</a> stable releases. However, it takes time for the distros to refresh their package repositories to pick up new versions and when you install <strong>mesa-va-drivers</strong> you may get an older version until they’re updated automatically after some time.</p>
<p>For example, in distros with apt you can check the latest available version in the repositories with the commands:</p>
<pre><code>sudo apt-get update
apt list mesa-va-drivers -a</code></pre>
<p>If the available mesa version in your distro is older than the mesa version required for the profile/entrypoint from the “Scenarios” section table you’d like to try, there are a couple of different options you choose to follow, described below.</p>
<h3 id="option-1-build-mesa-from-source-code">Option 1. Build mesa from source code</h3>
<p>In this option, you will build and install mesa from the <a href="https://archive.mesa3d.org/mesa-22.3.0.tar.xz">mesa-22.3.0.tar.xz release</a> or newer. If you follow this route, you can skip installing the <strong>mesa-va-drivers</strong> package in the section “Setting up Video acceleration in WSLg”.</p>
<ol>
<li>Make sure to include the following meson configuration flags </li>
</ol>
<pre><code>-Dgallium-drivers=swrast,d3d12 -Dgallium-va=true -Dvideo-codecs=h264dec,h264enc,h265dec,h265enc,vc1dec</code></pre>
<ol>
<li>Build and install mesa</li>
<li>Set the <strong>LIBVA_DRIVERS_PATH</strong> environment variable to the directory containing the custom built and installed <strong>d3d12_drv_video.so</strong>. You may want to add this in your <strong>~/.bashrc</strong> file as it’s necessary on every new WSL console session.</li>
<li>Follow the instructions in the section “Setting up Video acceleration in WSLg”.</li>
</ol>
<h3 id="option-2-use-a-3rd-party-repository-for-the-mesa-library-packages">Option 2. Use a 3<sup>rd</sup> party repository for the mesa library packages</h3>
<h4 id="adding-the-3rd-party-repository">Adding the 3<sup>rd</sup> party repository</h4>
<p>In Ubuntu 22.04 and newer, you can add this 3<sup>rd</sup> party repository to make available <strong>the bleeding edge/unstable daily mesa packages built from</strong> <a href="https://gitlab.freedesktop.org/mesa/mesa">mesa/main</a> with the following commands.</p>
<pre><code>sudo add-apt-repository ppa:oibaf/graphics-drivers
sudo apt-get update &amp;&amp; sudo apt-get upgrade</code></pre>
<p><span>After adding the repository, follow the instructions in the section “Setting up Video acceleration in WSLg”.</span></p>
<h4 id="removing-the-3rd-party-repository">Removing the 3<sup>rd</sup> party repository</h4>
<p>In the case you added the <strong><em>ppa:oibaf</em></strong> repository and followed the setup steps in the section “Setting up Video acceleration in WSLg”, and now want <strong>to revert back to the previous state</strong>, please follow these steps.</p>
<pre><code>sudo apt-get install ppa-purge
sudo ppa-purge ppa:oibaf/graphics-drivers
sudo apt-get update &amp;&amp; sudo apt-get upgrade</code></pre>

<p>Open the WSL console and run the following commands to install the required components. The following steps use the apt package manager, but you may replace it with the appropriate equivalent on your distro.</p>
<p>1.Make sure you have the latest updates installed</p>
<pre><code>sudo apt-get update &amp;&amp; sudo apt-get upgrade</code></pre>
<p>2. Install vainfo (and libva dependencies)</p>
<pre><code>sudo apt-get install vainfo</code></pre>
<p><em>3. *Install mesa libraries *(skip this if built from mesa source code)</em></p>
<pre><code>sudo apt-get mesa-va-drivers</code></pre>
<p>4. Configure libva environment. You may want to add this in your <strong>~/.bashrc</strong> file as it’s necessary on every new WSL console session.</p>
<pre><code>export LIBVA_DRIVER_NAME=d3d12</code><code></code></pre>
<p>5. Enumerate libva capabilities for your current hardware</p>
<pre><code>vainfo --display drm --device /dev/dri/card0</code></pre>
<p>The vainfo utility <strong>will indicate the libva and mesa</strong> <strong>versions</strong> <strong>installed</strong> and list the subset of entrypoints and profiles supported by your hardware, for example:</p>
<pre><code>vainfo: VA-API version: 1.15 (libva 2.12.0)
vainfo: Driver version: Mesa Gallium driver 22.2.1 for D3D12
vainfo: Supported profile and entrypoints
VAProfileH264ConstrainedBaseline: VAEntrypointVLD
VAProfileH264ConstrainedBaseline: VAEntrypointEncSlice
VAProfileH264Main               : VAEntrypointVLD
VAProfileH264Main               : VAEntrypointEncSlice
VAProfileH264High               : VAEntrypointVLD
VAProfileH264High               : VAEntrypointEncSlice
VAProfileNone                   : VAEntrypointVideoProc</code></pre>
<p><span><em>This list is illustrative of a GPU supporting only a subset of the implemented features on the indicated libva/mesa versions.</em></span></p>
<p>Adding the “<strong>-a</strong>” argument to the vainfo command will give you more detailed support information such as rate control modes, max reference frames, slice modes, etc for each entrypoint/profile available on your hardware.</p>

<figure id="attachment_8406" aria-describedby="caption-attachment-8406"><img decoding="async" data-src="https://devblogs.microsoft.com/commandline/wp-content/uploads/sites/33/2023/02/Screenshot-2023-02-09-163918-300x250.png" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABTAQMAAABTUzACAAAAA1BMVEXW1taWrGEgAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAEklEQVQ4jWNgGAWjYBSMgoEGAASKAAEXJYxOAAAAAElFTkSuQmCC" alt="Gstreamer in WSL performing GPU accelerated alpha blend composition and rendering into an X11 window" width="300" height="250" data-srcset="https://devblogs.microsoft.com/commandline/wp-content/uploads/sites/33/2023/02/Screenshot-2023-02-09-163918-300x250.png 300w, https://devblogs.microsoft.com/commandline/wp-content/uploads/sites/33/2023/02/Screenshot-2023-02-09-163918.png 749w" sizes="(max-width: 300px) 100vw, 300px"/><figcaption id="caption-attachment-8406">]<a href="https://devblogs.microsoft.com/commandline/wp-content/uploads/sites/33/2023/02/Screenshot-2023-02-09-163918.png">16</a> Gstreamer in WSL performing GPU accelerated alpha blend composition and rendering into an X11 window</figcaption></figure>
<p>You can now install some media apps with VA acceleration and use GPU video acceleration, below are some examples you can try. Please check that the mesa version and the entrypoints required for each example are supported on your platform by checking the vainfo utility.</p>
<p>The Windows Task Manager will show the CPU/GPU usage for each of these samples, and you can compare the results for different samples using CPU only or GPU acceleration.</p>
<p>To begin please follow the steps below to install ffmpeg and/or gstreamer and then you can try some of the command line samples below.</p>
<h3 id="install-ffmpeg-and-gstreamer"><span>Install ffmpeg and gstreamer</span></h3>
<pre><code>sudo apt-get install ffmpeg
sudo apt-get install gstreamer1.0-plugins-bad gstreamer1.0-tools gstreamer1.0-vaapi</code></pre>
<h3 id="command-line-examples"><span>Command line examples</span></h3>
<p>1.Requires mesa 22.2 + H264 VAEntrypointEncSlice. Generate 250 test frames and encode to an H.264 file using the GPU with VAAPI.</p>
<pre><code>gst-launch-1.0 -v videotestsrc num-buffers=250 ! video/x-raw,width=1920,height=1200 ! vaapipostproc ! vaapih264enc ! filesink location=~/wsl_test.h264</code></pre>
<p>2. Requires mesa 22.2 + H264 VAEntrypointVLD. Decode wsl_test.h264 using the GPU with VAAPI and encode using H264 software encoder.</p>
<pre><code>gst-launch-1.0 -v -m filesrc location=~/wsl_test.h264 ! h264parse ! vaapih264dec ! x264enc qp-max=5 tune=zerolatency ! filesink location=~/x264enc_output.h264</code></pre>
<p>3. Requires mesa 22.2 + H264 VAEntrypointVLD + VAEntrypointEncSlice. Decode wsl_test.h264 using the GPU with VAAPI and encode using the GPU VAAPI encoder.</p>
<pre><code>gst-launch-1.0 -v -m filesrc location=~/wsl_test.h264 ! h264parse ! vaapih264dec ! vaapih264enc ! filesink location=~/va264enc_output.h264</code></pre>
<p>4. Requires mesa 22.2 + H264 VAEntrypointVLD + VAEntrypointEncSlice + <a href="https://github.com/intel/libva/blob/6e86b4fb4dafa123b1e31821f61da88f10cfbe91/va/va_vpp.h#L1576">VaQueryVideoProcPipelineCaps</a> supporting scale + rotation. Decode wsl_test.h264 using the GPU with VAAPI, scale, rotate and encode using the GPU VAAPI encoder.</p>
<pre><code>gst-launch-1.0 -v -m filesrc location=~/wsl_test.h264 ! h264parse ! vaapih264dec ! vaapipostproc width=800 height=600 video-direction=180 ! vaapih264enc ! filesink location=~/va264enc_proc_output.h264</code></pre>
<p>5. Requires mesa 22.3 + H264 VAEntrypointVLD + HEVC VAEntrypointEncSlice + <a href="https://github.com/intel/libva/blob/6e86b4fb4dafa123b1e31821f61da88f10cfbe91/va/va_vpp.h#L1576">VaQueryVideoProcPipelineCaps</a> supporting scale. Decode wsl_test.h264 using the H264 GPU decoder, scale it using the GPU video processor, and re-encode it using the H265 GPU encoder.</p>
<pre><code>ffmpeg -hwaccel vaapi -hwaccel_output_format vaapi -hwaccel_device /dev/dri/card0 -i ~/wsl_test.h264 -vf &#39;scale_vaapi=w=640:h=480&#39; -c:v hevc_vaapi ~/scaled_output.h265</code></pre>
<p>6. Requires mesa 22.3 + HEVC VAEntrypointVLD. Given an H265 file, play it in window using the GPU decoder.</p>
<pre><code>gst-launch-1.0 -vf filesrc location=~/scaled_output.h265 ! h265parse ! vaapih265dec ! autovideosink</code></pre>
<p>7. Transcode wsl_test.h264 using only the CPU. This sample is intended for comparison with the next one which uses GPU acceleration.</p>
<pre><code>ffmpeg -i ~/wsl_test.h264 -c:v h264 ~/output_sw.h264</code></pre>
<p>8. Requires mesa 22.2 + H264 VAEntrypointVLD + H264 VAEntrypointEncSlice. Transcode wsl_test.h264 using only the GPU.</p>
<pre><code>ffmpeg -hwaccel vaapi -hwaccel_output_format vaapi -hwaccel_device /dev/dri/renderD128 -i ~/wsl_test.h264 -c:v h264_vaapi ~/output_hw.h264</code></pre>
<p>Here you can find the related command line documentation for <a href="https://ffmpeg.org/ffmpeg.html">ffmpeg</a> and <a href="https://gstreamer.freedesktop.org/documentation/plugins_doc.html?gi-language=c">gstreamer plugins</a> used in the command lines for further reference.</p>

<p>Please see below the list of hardware platforms that currently have support for Video acceleration in WSLg.</p>
<table>
<tbody>
<tr>
<td>
        Vendor
      </td>
<td>
        Supported platforms
      </td>
<td>
        Minimum video driver version
      </td>
</tr>
<tr>
<td>
        AMD
      </td>
<td>
<p>
          Radeon RX 5000 series or greater
        </p>
<p>
          Ryzen 4000 series or greater
        </p>
</td>
<td>
<p>
          Adrenalin 23.3.1
        </p>
<p>
          ETA March 2023
        </p>
</td>
</tr>
<tr>
<td>
        Intel
      </td>
<td>
<p>
          11th Gen Intel® Core™ processor family (Codename Tiger Lake, Rocket Lake)
        </p>
<p>
          12th Gen Intel® Core™ processor family (Codename Alder Lake)
        </p>
<p>
          13th Gen Intel® Core™ processor family (Codename Raptor Lake)
        </p>
<p>
          Intel® Iris® Xe Dedicated Graphics family (Codename DG1)
        </p>
<p>
          Intel® Arc® Graphics family (Codename Alchemist)
        </p>
</td>
<td>
        31.0.101.4032
      </td>
</tr>
<tr>
<td>
        NVIDIA
      </td>
<td>
<p>
          GeForce GTX 10 Series and newer
        </p>
<p>
          GeForce RTX 20 Series and newer
        </p>
<p>
          Quadro RTX
        </p>
<p>
          NVIDIA RTX
        </p>
</td>
<td>
        526.47
      </td>
</tr>
</tbody>
</table>


        

		
        
	</div><!-- .entry-content -->

</div></div>
  </body>
</html>
