<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://martypc.blogspot.com/2023/09/a-test-suite-for-intel-8088.html">Original</a>
    <h1>A Test Suite for the Intel 8088</h1>
    
    <div id="readability-page-1" class="page"><p>In a previous article, I revealed one of the secrets to <a href="https://github.com/dbalsom/martypc" target="_blank">MartyPC</a>&#39;s accuracy, <a href="https://martypc.blogspot.com/2023/06/hardware-validating-emulator.html" target="_blank">hardware validation</a>. To summarize, it is a method of using a microcontroller to run an instruction on a real 8088 CPU at the same time as the emulator executes the same an instruction, and then comparing the resulting cycle states (and optionally registers) for consistency.</p><p>Once again, credit goes to phix and his <a href="https://phix.itch.io/virtualxt" target="_blank">VirtualXT emulator</a> for pioneering this basic idea. </p><p>The downside to this method is that it is quite slow, and requires going out and buying a Raspberry Pi or an Arduino, ordering some vintage chips off eBay, then either breadboarding up a CPU or ordering a custom PCB and soldering it together, not to mention the the effort of integrating client communication and test logic into your emulator.  All this presents a barrier to entry that makes this method probably only suitable for an especially dedicated few. </p><p>Compounding things, it&#39;s not really practical to validate instructions that frequently. Every time you tweak something as fundamental as BIU logic, you need to validate your emulator all over again, and validating the entire ISA can take many hours.  </p><p>In that same blog post I bemoaned the lack of a JSON test suite for the 8088 CPU. I&#39;m happy to announce that as of now, the 8088 no longer lacks a test suite! With the help of my friend <a href="https://www.vanheusden.com/" target="_blank">Folkert van Heusden</a>, we have taken three <a href="https://github.com/dbalsom/arduino_8088" target="_blank">Arduino8088 </a>hardware boards and spent the past week or so generating the first <a href="https://github.com/TomHarte/ProcessorTests/tree/main/8088" target="_blank">complete JSON CPU test suite for the 8088</a>. </p><p>A bit of a background if you&#39;re not familiar with the concept of a JSON CPU test suite. The idea was originally popularized by <a href="https://github.com/TomHarte" target="_blank">Tom Harte</a>, as far as I can tell. JSON is a highly portable data format with readily available parsers in almost every language, saving emulator developers the trouble of writing a custom parser for a binary format. JSON isn&#39;t the most efficient storage format, so these JSON files can be a big weighty - larger test sets are gzipped to keep the repository sizes reasonable.</p><p>Each JSON file typically corresponds to a single opcode, and contains an array of randomized tests that include the initial and final states of memory and CPU registers, and an array of data for each cycle spent executing that opcode.</p><p><a href="https://github.com/TomHarte/ProcessorTests" target="_blank">Tom&#39;s CPU tests</a> have been very well received in the emulation development community, giving a valuable and convenient way to quickly locate and squash emulation bugs that might otherwise take weeks of debugging to catch. Ever since developing the Arduino8088, I realized that using it to generate a set of tests was theoretically possible if I put in the work.</p><p>Since Tom popularized the concept, and these tests follow the same basic format as his other tests, it only seemed fair to contribute the 8088 CPU test suite to Tom&#39;s repository. </p><p>The 8088 Test Suite is fairly comprehensive, exercising 10,000 tests not just on the opcode level but on the opcode extension level as well, with only a handful of opcodes omitted due to practicality (WAIT, HALT) or unpredictability (mostly certain undefined opcode forms).</p><p>The test suite contains 324 opcode forms, over 3 million instruction tests in total, including nearly 90 million cycle states. Compressed, the collection weighs in at 677 MB. The uncompressed, pretty-printed JSON totals 9.68GB.</p><div><pre>{
    <span>&#34;name&#34;</span>: <span>&#34;add byte ds:[bx+si+C2h], al&#34;</span>,
    <span>&#34;bytes&#34;</span>: [<span>0</span>, <span>64</span>, <span>194</span>],
    <span>&#34;initial&#34;</span>: {
        <span>&#34;regs&#34;</span>: {
            <span>&#34;ax&#34;</span>: <span>52773</span>,
            <span>&#34;bx&#34;</span>: <span>22214</span>,
            <span>&#34;cx&#34;</span>: <span>16054</span>,
            <span>&#34;dx&#34;</span>: <span>57938</span>,
            <span>&#34;cs&#34;</span>: <span>60492</span>,
            <span>&#34;ss&#34;</span>: <span>17184</span>,
            <span>&#34;ds&#34;</span>: <span>15619</span>,
            <span>&#34;es&#34;</span>: <span>60510</span>,
            <span>&#34;sp&#34;</span>: <span>56738</span>,
            <span>&#34;bp&#34;</span>: <span>13363</span>,
            <span>&#34;si&#34;</span>: <span>58400</span>,
            <span>&#34;di&#34;</span>: <span>31158</span>,
            <span>&#34;ip&#34;</span>: <span>16937</span>,
            <span>&#34;flags&#34;</span>: <span>62535</span>
        },
        <span>&#34;ram&#34;</span>: [
            [<span>264920</span>, <span>71</span>],
            [<span>984809</span>, <span>0</span>],
            [<span>984810</span>, <span>64</span>],
            [<span>984811</span>, <span>194</span>],
            [<span>984812</span>, <span>144</span>],
            [<span>984813</span>, <span>144</span>],
            [<span>984814</span>, <span>144</span>],
            [<span>984815</span>, <span>144</span>]
        ],
        <span>&#34;queue&#34;</span>: []
    },
    <span>&#34;final&#34;</span>: {
        <span>&#34;regs&#34;</span>: {
            <span>&#34;ax&#34;</span>: <span>52773</span>,
            <span>&#34;bx&#34;</span>: <span>22214</span>,
            <span>&#34;cx&#34;</span>: <span>16054</span>,
            <span>&#34;dx&#34;</span>: <span>57938</span>,
            <span>&#34;cs&#34;</span>: <span>60492</span>,
            <span>&#34;ss&#34;</span>: <span>17184</span>,
            <span>&#34;ds&#34;</span>: <span>15619</span>,
            <span>&#34;es&#34;</span>: <span>60510</span>,
            <span>&#34;sp&#34;</span>: <span>56738</span>,
            <span>&#34;bp&#34;</span>: <span>13363</span>,
            <span>&#34;si&#34;</span>: <span>58400</span>,
            <span>&#34;di&#34;</span>: <span>31158</span>,
            <span>&#34;ip&#34;</span>: <span>16940</span>,
            <span>&#34;flags&#34;</span>: <span>62470</span>
        },
        <span>&#34;ram&#34;</span>: [
            [<span>264920</span>, <span>108</span>],
            [<span>984809</span>, <span>0</span>],
            [<span>984810</span>, <span>64</span>],
            [<span>984811</span>, <span>194</span>],
            [<span>984812</span>, <span>144</span>],
            [<span>984813</span>, <span>144</span>],
            [<span>984814</span>, <span>144</span>],
            [<span>984815</span>, <span>144</span>]
        ],
        <span>&#34;queue&#34;</span>: [<span>144</span>, <span>144</span>, <span>144</span>]
    },
    <span>&#34;cycles&#34;</span>: [
        [<span>&#34;-&#34;</span>, <span>984810</span>, <span>&#34;CS&#34;</span>, <span>&#34;R--&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;CODE&#34;</span>, <span>&#34;T2&#34;</span>, <span>&#34;F&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>984810</span>, <span>&#34;CS&#34;</span>, <span>&#34;R--&#34;</span>, <span>&#34;---&#34;</span>, <span>64</span>, <span>&#34;PASV&#34;</span>, <span>&#34;T3&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>984810</span>, <span>&#34;CS&#34;</span>, <span>&#34;---&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;PASV&#34;</span>, <span>&#34;T4&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;A&#34;</span>, <span>984811</span>, <span>&#34;--&#34;</span>, <span>&#34;---&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;CODE&#34;</span>, <span>&#34;T1&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>984811</span>, <span>&#34;CS&#34;</span>, <span>&#34;R--&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;CODE&#34;</span>, <span>&#34;T2&#34;</span>, <span>&#34;S&#34;</span>, <span>64</span>],
        [<span>&#34;-&#34;</span>, <span>984811</span>, <span>&#34;CS&#34;</span>, <span>&#34;R--&#34;</span>, <span>&#34;---&#34;</span>, <span>194</span>, <span>&#34;PASV&#34;</span>, <span>&#34;T3&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>984811</span>, <span>&#34;CS&#34;</span>, <span>&#34;---&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;PASV&#34;</span>, <span>&#34;T4&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;A&#34;</span>, <span>984812</span>, <span>&#34;--&#34;</span>, <span>&#34;---&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;CODE&#34;</span>, <span>&#34;T1&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>984812</span>, <span>&#34;CS&#34;</span>, <span>&#34;R--&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;CODE&#34;</span>, <span>&#34;T2&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>984812</span>, <span>&#34;CS&#34;</span>, <span>&#34;R--&#34;</span>, <span>&#34;---&#34;</span>, <span>144</span>, <span>&#34;PASV&#34;</span>, <span>&#34;T3&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>984812</span>, <span>&#34;CS&#34;</span>, <span>&#34;---&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;PASV&#34;</span>, <span>&#34;T4&#34;</span>, <span>&#34;S&#34;</span>, <span>194</span>],
        [<span>&#34;A&#34;</span>, <span>984813</span>, <span>&#34;--&#34;</span>, <span>&#34;---&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;CODE&#34;</span>, <span>&#34;T1&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>984813</span>, <span>&#34;CS&#34;</span>, <span>&#34;R--&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;CODE&#34;</span>, <span>&#34;T2&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>984813</span>, <span>&#34;CS&#34;</span>, <span>&#34;R--&#34;</span>, <span>&#34;---&#34;</span>, <span>144</span>, <span>&#34;PASV&#34;</span>, <span>&#34;T3&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>984813</span>, <span>&#34;CS&#34;</span>, <span>&#34;---&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;PASV&#34;</span>, <span>&#34;T4&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>984813</span>, <span>&#34;--&#34;</span>, <span>&#34;---&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;PASV&#34;</span>, <span>&#34;Ti&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>984813</span>, <span>&#34;--&#34;</span>, <span>&#34;---&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;PASV&#34;</span>, <span>&#34;Ti&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;A&#34;</span>, <span>264920</span>, <span>&#34;--&#34;</span>, <span>&#34;---&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;MEMR&#34;</span>, <span>&#34;T1&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>264920</span>, <span>&#34;DS&#34;</span>, <span>&#34;R--&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;MEMR&#34;</span>, <span>&#34;T2&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>264920</span>, <span>&#34;DS&#34;</span>, <span>&#34;R--&#34;</span>, <span>&#34;---&#34;</span>, <span>71</span>, <span>&#34;PASV&#34;</span>, <span>&#34;T3&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>264920</span>, <span>&#34;DS&#34;</span>, <span>&#34;---&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;PASV&#34;</span>, <span>&#34;T4&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;A&#34;</span>, <span>984814</span>, <span>&#34;--&#34;</span>, <span>&#34;---&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;CODE&#34;</span>, <span>&#34;T1&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>984814</span>, <span>&#34;CS&#34;</span>, <span>&#34;R--&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;CODE&#34;</span>, <span>&#34;T2&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>984814</span>, <span>&#34;CS&#34;</span>, <span>&#34;R--&#34;</span>, <span>&#34;---&#34;</span>, <span>144</span>, <span>&#34;PASV&#34;</span>, <span>&#34;T3&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>984814</span>, <span>&#34;CS&#34;</span>, <span>&#34;---&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;PASV&#34;</span>, <span>&#34;T4&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;A&#34;</span>, <span>984815</span>, <span>&#34;--&#34;</span>, <span>&#34;---&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;CODE&#34;</span>, <span>&#34;T1&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>984815</span>, <span>&#34;CS&#34;</span>, <span>&#34;R--&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;CODE&#34;</span>, <span>&#34;T2&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>984815</span>, <span>&#34;CS&#34;</span>, <span>&#34;R--&#34;</span>, <span>&#34;---&#34;</span>, <span>144</span>, <span>&#34;PASV&#34;</span>, <span>&#34;T3&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>984815</span>, <span>&#34;CS&#34;</span>, <span>&#34;---&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;PASV&#34;</span>, <span>&#34;T4&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;A&#34;</span>, <span>264920</span>, <span>&#34;--&#34;</span>, <span>&#34;---&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;MEMW&#34;</span>, <span>&#34;T1&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>264920</span>, <span>&#34;DS&#34;</span>, <span>&#34;-A-&#34;</span>, <span>&#34;---&#34;</span>, <span>0</span>, <span>&#34;MEMW&#34;</span>, <span>&#34;T2&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>],
        [<span>&#34;-&#34;</span>, <span>264920</span>, <span>&#34;DS&#34;</span>, <span>&#34;-AW&#34;</span>, <span>&#34;---&#34;</span>, <span>108</span>, <span>&#34;PASV&#34;</span>, <span>&#34;T3&#34;</span>, <span>&#34;-&#34;</span>, <span>0</span>]
    ]
}
</pre></div></div>
  </body>
</html>
