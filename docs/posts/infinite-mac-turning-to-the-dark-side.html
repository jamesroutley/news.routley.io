<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.persistent.info/2024/03/infinite-mac-nextstep.html">Original</a>
    <h1>Infinite Mac: Turning to the dark side</h1>
    
    <div id="readability-page-1" class="page"><article>
<p><b>tl;dr:</b> No, not Windows¹, but I’ve decided to expand Infinite Mac to the the black hardware that Mac users secretly lusted after in the 80s and 90s: NeXT.  There is now <a href="https://infinitemac.org/?filter=next">a runnable collection of all notable NeXTStep versions</a>, going from the initial <a href="https://infinitemac.org/1988/NeXTStep%200.8">0.8 preview</a> in 1988 to the final <a href="https://infinitemac.org/1997/OPENSTEP%204.2">OPENSTEP 4.2</a> release in 1997.</p>

<p>
  <img alt="NeXTSTEP 3.3 running DOOM, DoomEd and WorldWideWeb" height="1000" src="https://persistent.info/images/previous-ns3.3.png" width="1288"/>
</p>

<h3>Porting Previous</h3>

<p><a href="https://github.com/mihaip/infinite-mac/issues/121">About a year ago</a> I came across the <a href="https://sourceforge.net/projects/previous/">Previous</a> emulator – it appeared to be a faithful simulation of the NeXT hardware and thus capable of running NeXTStep. While including it in Infinite Mac would be scope-creep, NeXT’s <a href="https://en.wikipedia.org/wiki/NeXT#1997%E2%80%932006:_Acquisition_by_Apple">legacy</a> is in many ways more relevant to today’s macOS than classic Mac OS. It also helped that it’s under active development by its original creator (see <a href="https://www.nextcomputers.org/forums/index.php?topic=2642.0">the epic thread</a> in the <a href="https://www.nextcomputers.org/forums/index.php">NeXT Computers</a> forums), and thus a modern, living codebase².</p>

<p>Previous is the fifth emulator that I’ve ported to WebAssembly/Emscripten and the Infinite Mac runtime, and it’s gotten easier. As I&#39;m doing this work, I’m developing more and more empathy for <a href="http://www.glendaadams.com/my-work/">those</a> <a href="https://en.wikipedia.org/wiki/List_of_games_ported_by_Aspyr">doing</a> Mac game ports – some things are really easy and others become yak shaves due to the unintended consequences of choices made by the original developers. Previous is available on multiple platforms and has good abstractions, so overall it was a pretty pleasant experience.</p>

<p>The main challenge was the pervasive use of the <a href="https://www.libsdl.org/">SDL</a> library – I don’t want any of it as a platform abstraction, since I have my own. I chose to <a href="https://github.com/mihaip/previous/commit/c18917332d6736bdd25aea79ec5b38713d229386">replace the entry-point</a> and several subsystems to avoid bringing in too much SDL code. Even with that, I still needed to have some <a href="https://github.com/mihaip/previous/blob/main/src/gui-js/jsgui.c">stub</a> <a href="https://github.com/mihaip/previous/blob/main/src/dimension/nd_js.cpp">files</a> for dependencies that I couldn’t omit altogether. On the other hand, it was a pleasant surprise that adding sound support <a href="https://github.com/mihaip/previous/commit/023ef5db4d25e4c17cfaddcc75559c8d036f67bd">was trivial</a> — the APIs that it needed mapped 1:1 with the ones I’d already exposed from the Infinite Mac runtime.</p>

<p>With the initial emulator being brought up, there were some more fun tasks, like adding a NeXT-style monitor frame and a NeXT appearance to the Infinite Mac controls (working on them is giving me <a href="https://web.archive.org/web/20001207174800fw_/http://www.kaleidoscope.net/cgi-bin/schemes.cgi?author=mihaiparparita">Kaleidoscope scheme</a> flashbacks).</p>

<p>
  <img alt="Infinite Mac custom instance configuration dialog, rendered with a NeXTStep appearance" height="590" src="https://persistent.info/images/previous-custom-instance.png" width="636"/>
</p>

<p>Once I had Previous running I did some profiling and was discovered the same excessive <code>wasm-to-js</code>/<code>js-to-wasm</code> ping-ponging that I noticed <a href="https://blog.persistent.info/2023/12/dingusppc.html#dingusppc-wasm-js">in DingusPPC</a> – it also uses <code>setjmp</code>/<code>longjmp</code> to implement an <a href="https://github.com/mihaip/previous/blob/180f1d5c4868a0927f8f10abf9bb8c0e70e5bc62/src/cpu/mmu_common.h#L30-L36">exception handling mechanism</a> for the MMU. The <a href="https://github.com/mihaip/previous/commit/71b41e4ea4412d7a6aee1e59860ed275f8f5889a?w=1">fix</a> was also very similar: intentionally add an extra wrapping function that contains the CPU emulation loop.</p>

<p>The performance impact of the fix was not as noticeable because Previous tries to accurately simulate the performance characteristics of the original hardware (this is also why boot times are much longer). In fact, I had originally <a href="https://github.com/mihaip/previous/commit/56e62988389df26eea09fa99ad28c6bd1fcb6d87">missed the speed checking</a> that the native main loop does, and the emulator was running too fast, leading to timing-dependent things like double-clicking not working.</p>

<p>Speaking of mouse input, Previous uses relative mouse input — it accurately simulates real hardware so all it can do is behave as though a physical mouse is moving and generating updates. This was the case with <a href="https://blog.persistent.info/2023/12/dingusppc.html#dingusppc-mouse">DingusPPC too</a>, and while the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Pointer_Lock_API">Pointer Lock API</a> makes this work reasonably well on desktop browsers, it’s not a good fit for the mobile web. To make input more accessible on touch-enabled devices, I added <a href="https://github.com/mihaip/infinite-mac/blob/main/src/emulator/emulator-ui-trackpad.ts">a virtual trackpad mode</a> that turns swipes and taps on the screen into mouse movements and clicks. This also helps with double-clicking and making pre-Mac OS 8.0 pull-down menus more usable, though it is somewhat finicky to trigger the drag-lock gesture (I now see why it’s so hard for other touchpad vendors to replicate all of Apple’s gestures).</p>

<p>As part of doing some of the integration work I became aware of just how much of a minority player NeXT was in the 80s and 90s computing world (even more so than Macs). For example, they had their <a href="https://en.wikipedia.org/wiki/NeXT_character_set">text encoding/character set</a>, and while <a href="https://github.com/python/cpython/blob/main/Lib/encodings/mac_roman.py">Python</a> (and other systems) have native support for the contemporary MacRoman encoding, I had <a href="https://github.com/mihaip/infinite-mac/blob/main/scripts/nextstep.py">to add my own</a> to handle NeXT’s. Similarly, there is <a href="https://github.com/elliotnunn/machfs">a convenient Python library</a> for dealing with HFS disk images, but I could not find any for the <a href="https://en.wikipedia.org/wiki/Unix_File_System">UFS</a> <a href="https://github.com/osxfuse/filesystems/blob/aee39765ffe32b426a1089f617d21bff387f5c91/filesystems-c/unixfs/ufs/ufs.c#L66">variant</a> that NeXT used³.</p>

<p>The disk images with NeXTStep installs are quite large (hundreds of megabytes per version), and the <a href="https://developers.cloudflare.com/kv/">Workers KV</a>-based storage that I had been using was becoming increasingly ill-suited for them (and <a href="https://developers.cloudflare.com/workers/platform/pricing/#workers-kv">expensive</a>). As part of this project I also <a href="https://github.com/mihaip/infinite-mac/commit/b79cdaf0bdcd440ed946c134d2bf708e720c1282">switched to Cloudflare R2</a> (their S3-like object storage system). On one hand I’m not thrilled with the site becoming dependent on additional services, but on the other I do want to keep costs down. Luckily the dependency is not invasive — it would be trivial to store the disk chunks anywhere else (or to keep storing them as static files, the way I do in the local dev server).</p>

<h3>Exploring NeXTStep</h3>

<p>Although I was familiar with NeXTStep at a theoretical level and had spent a few hours using a slab in the mid 1990s, this was my first time using it in-depth. My first observation was that having it side-by-side with the contemporary Mac system software makes it even more apparent how much of an advance it was.</p>

<p>
  <img alt="Notable OS releases of 1988: System 6.0 and NeXTStep 0.8" height="380" src="https://persistent.info/images/previous-1988.png" width="916"/></p>


As I was preparing the system images with the various NeXTStep/NexTSTEP/OPENSTEP releases⁴, it was fascinating to see NeXT’s various strategy shifts over the years represented in the canned email from Steve Jobs that was present in the Mail app:</article></div>
  </body>
</html>
