<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.daemonology.net/blog/2022-10-18-FreeBSD-Firecracker.html">Original</a>
    <h1>The FreeBSD/Firecracker Platform</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>
The <a href="https://firecracker-microvm.github.io/">Firecracker</a>
Virtual Machine Monitor was developed at Amazon Web Services as a
building block for services like
<a href="https://aws.amazon.com/lambda/">AWS Lambda</a> and
<a href="https://aws.amazon.com/fargate/">AWS Fargate</a>.
While there are many ways of launching and managing VMs, Firecracker
distinguishes itself with its focus on minimalism — important
both for security (fewer devices means less attack surface) and reducing
the startup time, which is very important if you&#39;re launching VMs on
demand in response to incoming HTTP requests.
When Firecracker was first released, the only OS which it supported
was Linux; six months later, Waldek Kozaczuk
<a href="http://blog.osv.io/blog/2019/04/19/making-OSv-run-on-firecraker/">ported
the OSv unikernel</a> to run on Firecracker.  As of
<a href="https://cgit.freebsd.org/src/commit/?id=469ad8603127bf8fea094d47223ccb3d0a3481cd">a
few minutes ago</a>, there are three options: FreeBSD can now run in Firecracker.
</p><p>
I started working on this on June 20th mainly out of curiosity: I had heard
that Firecracker had PVH boot support (which was in fact mistaken!) and I
knew that FreeBSD could boot in PVH mode from Xen, so I wondered just how
hard it would be to get FreeBSD up and running.  Not impossible, as it
turned out, but a bit more work than I was hoping for.
</p><p>
I had a lot of help from other FreeBSD developers, and I&#39;d like to thank
in particular Bryan, Ed, Jessica, John, Kyle, Mark, Roger, and Warner for
explaining code to me, helping review my patches, and even writing
entirely new code which I needed.  Among the changes which went into
getting the FreeBSD/Firecracker platform working:
</p><ul><li>
The PVH boot mechanism uses an ELF Note to tell the loader where the PVH
kernel entry point is located; FreeBSD was using an SHT_NOTE while
Firecracker (or rather, linux-loader) was looking only for PT_NOTEs.
Once I tracked down the problem this was fixed quite quickly by Ed and
Roger.
</li><li>
When PVH booting, the loader provides the requested images (kernel, and
potentially kernel modules and ramdisk), and also a &#34;start into&#34; structure
with metadata needed for the boot process.  In Xen, the kernel and
modules are loaded into memory first and the start info structure is
placed immediately after them; Firecracker places the start info page first
and loads the rest later.  Very early in the boot process, FreeBSD needs
a page of temporary space — and it was using the page immediately
after the start info page.  Mark and Roger reworked the FreeBSD PVH boot
code to use the first page after <i>all</i> of the data provided by the
PVH loader — not overwriting important data makes a difference.
</li><li>
Firecracker doesn&#39;t provide ACPI, instead providing information about
CPUs and interrupt controllers via the MPTable interface defined in the
historical Intel MultiProcessor Specification.  Support for this isn&#39;t
included in the FreeBSD GENERIC kernel — no matter, I was going to
provide a customized &#34;FIRECRACKER&#34; kernel configuration anyway —
but Firecracker&#39;s implementation had two bugs: It placed the MPTable in
the wrong place (<i>above</i> the advertised top of system memory rather
than in the last kB) and it set a field containing the number of table
entries to zero rather than the appropriate count.  In both cases, Linux
accepts the broken behaviour; so I added a &#34;bug for bug compatibility&#34;
option to the FreeBSD MPTable code.
</li><li>
Upon entering userland, the FreeBSD serial console died after printing
16 characters.  This bug I recognized, since I ran into it with EC2:
The UART is losing an interrupt on the transmission FIFO.  Fortunately
the FreeBSD kernel still had a workaround in place and setting
<tt>hw.broken_txfifo=&#34;1&#34;</tt> fixed that problem.
</li><li>
The serial console also couldn&#39;t <i>read</i> input — in fact,
Firecracker wouldn&#39;t read input, and any keypresses stayed in the
terminal buffer until after Firecracker exited.  This turned out to
be due to a bug — or perhaps I should say missing feature —
in Firecracker&#39;s UART emulation: Firecracker doesn&#39;t emulate the FCR
(FIFO Control Register), which FreeBSD uses to flush the FIFO.  I
added code to check if flushing the FIFO via the FCR succeeded, and
if not switched to the (slower) approach of reading bytes and discarding
them.  (Why do we need to flush the FIFO?  When the UART is first
attached, we write data into it to see how large the buffers are, and
then throw away the dummy data.)
</li><li>
Firecracker uses Virtio to present virtual devices to guest operating
systems; no problem, FreeBSD has Virtio support.  Except... FreeBSD
discovers Virtio devices via ACPI, which doesn&#39;t exist on Firecracker.
Instead, Firecracker exposes device parameters (memory-mapped I/O
address and interrupt number) via the kernel command line.  This took
quite a bit of plumbing to handle — not least of which because
FreeBSD interprets the kernel command line as environment variables,
and the Virtio MMIO specification calls for devices to be exposed as
a series of <tt>virtio_mmio.device=...</tt> arguments — i.e.,
with the same &#34;variable name&#34; for each of them.  The FreeBSD kernel
now handles such duplicate environment variables by appending
suffixes, so that we end up with <tt>virtio_mmio.device</tt>,
<tt>virtio_mmio.device_1</tt>, <tt>virtio_mmio.device_2</tt>, et cetera,
and the Virtio driver looks for those environment variables to create
device instances.
</li><li>
Most Virtio hosts handle disk I/Os consisting of multiple segments of data;
QEMU for example handles 128 segments.  Firecracker is more minimalist:
It rejects I/Os with more than one segment.  This causes problems for
FreeBSD with unaligned I/Os from userland, since a buffer which is
contiguous in <i>virtual</i> address space might span non-contiguous
pages in <i>physical</i> address space.  I modified FreeBSD&#39;s virtio
block device driver to make use of the busdma system, which &#34;bounces&#34;
(aka. copies via a buffer) data as needed to comply with alignment
(and other) requirements.  Now when a Virtio block device only supports
single-segment I/Os, if we get an unaligned request we bounce the data.
</li></ul><p>
Now that FreeBSD supported Firecracker, there was one more thing to do:
Make Firecracker support FreeBSD.  I mentioned earlier that I
mistakenly thought that Firecracker supported PVH booting; as it turned
out, Alejandro Jimenez
<a href="https://github.com/firecracker-microvm/firecracker/pull/1818">contributed
patches</a> two years ago, but they were never merged.  Some of his
code ended up in the linux-loader project (which Firecracker uses);
but I spent a few weeks digging through his thousand lines of changes
to figure out which went into linux-loader, which still applied
cleanly to Firecracker, and which I had to rewrite from scratch —
a task made more difficult by the fact that Firecracker is written in
Rust, and I had never used Rust before!  Nevertheless, I was eventually
successful, and opened a
<a href="https://github.com/firecracker-microvm/firecracker/pull/3155">PR</a>
with updated patches which I hope to see merged into mainline Firecracker
in the upcoming weeks.
</p><h3>How to try FreeBSD/Firecracker</h3><p>
To try FreeBSD on Firecracker, you&#39;ll need to build a FreeBSD amd64
FIRECRACKER kernel, and build Firecracker with my patches:
</p><ul><li>
To build the FreeBSD kernel (on a FreeBSD system):
<pre># git clone https://git.freebsd.org/src.git /usr/src
# cd /usr/src &amp;&amp; make buildkernel TARGET=amd64 KERNCONF=FIRECRACKER
</pre>
and the built kernel will be found in
<tt>/usr/obj/usr/src/amd64.amd64/sys/FIRECRACKER/kernel</tt>.
</li><li>
To build Firecracker with PVH boot support (on a Linux system):
<pre># git clone -b pvh-v3 https://github.com/cperciva/firecracker.git 
</pre>
and follow the instructions in the
<a href="https://github.com/firecracker-microvm/firecracker/blob/main/docs/getting-started.md">getting
started</a> documentation to build from source
</li></ul><p>
You&#39;ll probably also want to build a disk image so that FreeBSD has
something to boot from; place </p><tt>vfs.root.mountfrom=ufs:/dev/vtbd0</tt><p>
into Firecracker&#39;s </p><tt>boot_args</tt><p> to tell FreeBSD to use the disk
you attach (aka. the first Virtio block device) as the root disk.
If there&#39;s significant community interest in
experimenting with FreeBSD/Firecracker, I&#39;ll provide a prebuilt FreeBSD
kernel, FreeBSD root disk, and Firecracker binary so people can skip
the process of building these themselves.
</p><p>
Have fun! 
</p>



<p><a href="https://disqus.com">blog comments powered by <span>Disqus</span></a>
</p></div></div>
  </body>
</html>
