<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://overreacted.io/jsx-over-the-wire/">Original</a>
    <h1>JSX over the Wire</h1>
    
    <div id="readability-page-1" class="page"><div><p>Suppose you have an API route that returns some data as JSON:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>app</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>/api/likes/:postId</span><span>&#39;</span><span>,</span><span> </span><span>async</span><span> </span><span>(</span><span>req</span><span>,</span><span> res</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const </span><span>postId</span><span> </span><span>=</span><span> req</span><span>.</span><span>params</span><span>.</span><span>postId</span><span>;</span></span>
<span data-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line=""><span>    </span><span>getFriendLikes</span><span>(</span><span>postId</span><span>,</span><span> </span><span>{</span><span> limit</span><span>:</span><span> </span><span>2</span><span> </span><span>}),</span></span>
<span data-line=""><span>  </span><span>]);</span></span>
<span data-line=""><span>  </span><span>const </span><span>json</span><span> </span><span>=</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>totalLikeCount</span><span>:</span><span> </span><span>post</span><span>.</span><span>totalLikeCount</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>isLikedByUser</span><span>:</span><span> </span><span>post</span><span>.</span><span>isLikedByUser</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>friendLikes</span><span>:</span><span> friendLikes</span><span>,</span></span>
<span data-line=""><span>  </span><span>};</span></span>
<span data-line=""><span>  </span><span>res</span><span>.</span><span>json</span><span>(</span><span>json</span><span>);</span></span>
<span data-line=""><span>});</span></span></code></pre></div>
<p>You also have a React component that needs that data:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>function</span><span> </span><span>LikeButton</span><span>(</span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>  totalLikeCount</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>  isLikedByUser</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>  friendLikes</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>let </span><span>buttonText</span><span> </span><span>=</span><span> </span><span>&#39;</span><span>Like</span><span>&#39;</span><span>;</span></span>
<span data-line=""><span>  </span><span>if</span><span> </span><span>(</span><span>totalLikeCount </span><span>&gt;</span><span> </span><span>0</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>    </span><span>// e.g. &#34;Liked by You, Alice, and 13 others&#34;</span></span>
<span data-line=""><span>    buttonText </span><span>=</span><span> </span><span>formatLikeText</span><span>(</span><span>totalLikeCount</span><span>,</span><span> isLikedByUser</span><span>,</span><span> friendLikes</span><span>);</span></span>
<span data-line=""><span>  </span><span>}</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>(</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>button</span><span> className={</span><span>isLikedByUser</span><span> ? </span><span>&#39;</span><span>liked</span><span>&#39;</span><span> : </span><span>&#39;&#39;</span><span>}&gt;</span></span>
<span data-line=""><span>      </span><span>{</span><span>buttonText</span><span>}</span></span>
<span data-line=""><span>    </span><span>&lt;/</span><span>button</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>);</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>How do you get that data into that component?</p>
<p>You could pass it from a parent component using some data fetching library:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>function</span><span> </span><span>PostLikeButton</span><span>(</span><span>{ postId }</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const [</span><span>json</span><span>,</span><span> </span><span>isLoading</span><span>] </span><span>=</span><span> </span><span>useData</span><span>(</span><span>`/api/likes/</span><span>${</span><span>postId</span><span>}</span><span>`</span><span>);</span></span>
<span data-line=""><span>  </span><span>// ...</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>(</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>LikeButton</span></span>
<span data-line=""><span>      totalLikeCount={</span><span>json</span><span>.</span><span>totalLikeCount</span><span>}</span></span>
<span data-line=""><span>      isLikedByUser={</span><span>json</span><span>.</span><span>isLikedByUser</span><span>}</span></span>
<span data-line=""><span>      friendLikes={</span><span>json</span><span>.</span><span>friendLikes</span><span>}</span></span>
<span data-line=""><span>    /&gt;</span></span>
<span data-line=""><span>  </span><span>);</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>That’s one way of thinking about it.</p>
<p>But have another look at your API:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>app</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>/api/likes/:postId</span><span>&#39;</span><span>,</span><span> </span><span>async</span><span> </span><span>(</span><span>req</span><span>,</span><span> res</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const </span><span>postId</span><span> </span><span>=</span><span> req</span><span>.</span><span>params</span><span>.</span><span>postId</span><span>;</span></span>
<span data-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line=""><span>    </span><span>getFriendLikes</span><span>(</span><span>postId</span><span>,</span><span> </span><span>{</span><span> limit</span><span>:</span><span> </span><span>2</span><span> </span><span>}),</span></span>
<span data-line=""><span>  </span><span>]);</span></span>
<span data-line=""><span>  </span><span>const </span><span>json</span><span> </span><span>=</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>totalLikeCount</span><span>:</span><span> </span><span>post</span><span>.</span><span>totalLikeCount</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>isLikedByUser</span><span>:</span><span> </span><span>post</span><span>.</span><span>isLikedByUser</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>friendLikes</span><span>:</span><span> friendLikes</span><span>,</span></span>
<span data-line=""><span>  </span><span>};</span></span>
<span data-line=""><span>  </span><span>res</span><span>.</span><span>json</span><span>(</span><span>json</span><span>);</span></span>
<span data-line=""><span>});</span></span></code></pre></div>
<p>Do these lines remind you of anything?</p>
<p>Props. <em>You’re passing props.</em> You just didn’t specify <em>where to</em>.</p>
<p>But you already know their final destination—<code>LikeButton</code>.</p>
<p>Why not just fill that in?</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>app</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>/api/likes/:postId</span><span>&#39;</span><span>,</span><span> </span><span>async</span><span> </span><span>(</span><span>req</span><span>,</span><span> res</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const </span><span>postId</span><span> </span><span>=</span><span> req</span><span>.</span><span>params</span><span>.</span><span>postId</span><span>;</span></span>
<span data-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line=""><span>    </span><span>getFriendLikes</span><span>(</span><span>postId</span><span>,</span><span> </span><span>{</span><span> limit</span><span>:</span><span> </span><span>2</span><span> </span><span>}),</span></span>
<span data-line=""><span>  </span><span>]);</span></span>
<span data-line=""><span>  </span><span>const </span><span>json</span><span> </span><span>=</span><span> </span><span>(</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>&lt;</span><span>LikeButton</span></span>
<span data-line=""><span>      totalLikeCount={</span><span>post</span><span>.</span><span>totalLikeCount</span><span>}</span></span>
<span data-line=""><span>      isLikedByUser={</span><span>post</span><span>.</span><span>isLikedByUser</span><span>}</span></span>
<span data-line=""><span>      friendLikes={</span><span>friendLikes</span><span>}</span></span>
<span data-line="" data-highlighted-line=""><span>    /&gt;</span></span>
<span data-line=""><span>  </span><span>);</span></span>
<span data-line=""><span>  </span><span>res</span><span>.</span><span>json</span><span>(</span><span>json</span><span>);</span></span>
<span data-line=""><span>});</span></span></code></pre></div>
<p>Now the “parent component” of <code>LikeButton</code> is the <em>API itself</em>.</p>
<p>Wait, what?</p>
<p>Weird, I know. We’re going to worry about whether it’s a good idea later. But for now, notice how this inverts the relationship between components and the API. This is sometimes known as the Hollywood Principle: “Don’t call me, I’ll call you.”</p>
<p>Your components don’t call your API.</p>
<p>Instead, your API <em>returns</em> your components.</p>
<p>Why would you ever want to do that?</p>
<hr/>
<ul>
<li><a href="#part-1-json-as-components">Part 1: JSON as Components</a></li>
<li><a href="#part-2-components-as-json">Part 2: Components as JSON</a></li>
<li><a href="#part-3-jsx-over-the-wire">Part 3: JSX Over The Wire</a></li>
</ul>
<hr/>
<h2 id="part-1-json-as-components"><a target="_self" href="#part-1-json-as-components">Part 1: JSON as Components</a></h2>
<h3 id="model-view-viewmodel"><a target="_self" href="#model-view-viewmodel">Model, View, ViewModel</a></h3>
<p>There is a fundamental tension between how we want to <em>store</em> information and how we want to <em>display</em> it. We generally want to store more things than we display.</p>
<p>For example, consider a Like button on a Post. When we store Likes for a given Post, we might want to represent them as a table of <code>Like</code> rows like this:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>type</span><span> Like </span><span>=</span><span> </span><span>{</span></span>
<span data-line=""><span>  createdAt</span><span>:</span><span> </span><span>string</span><span>,</span><span> </span><span>// Timestamp</span></span>
<span data-line=""><span>  likedById</span><span>:</span><span> </span><span>number</span><span>,</span><span> </span><span>// User ID</span></span>
<span data-line=""><span>  postId</span><span>:</span><span> </span><span>number</span><span>     </span><span>// Post ID</span></span>
<span data-line=""><span>};</span></span></code></pre></div>
<p>Let’s call this kind of data a “Model”. It represents the raw shape of the data.</p>

<p>So our Likes database table might contain data of that shape:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>[{</span></span>
<span data-line=""><span>  createdAt</span><span>:</span><span> </span><span>&#39;</span><span>2025-04-13T02:04:41.668Z</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>  likedById</span><span>:</span><span> </span><span>123</span><span>,</span></span>
<span data-line=""><span>  postId</span><span>:</span><span> </span><span>1001</span></span>
<span data-line=""><span>},</span><span> </span><span>{</span></span>
<span data-line=""><span>  createdAt</span><span>:</span><span> </span><span>&#39;</span><span>2025-04-13T02:04:42.668Z</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>  likedById</span><span>:</span><span> </span><span>456</span><span>,</span></span>
<span data-line=""><span>  postId</span><span>:</span><span> </span><span>1001</span></span>
<span data-line=""><span>},</span><span> </span><span>{</span></span>
<span data-line=""><span>  createdAt</span><span>:</span><span> </span><span>&#39;</span><span>2025-04-13T02:04:43.668Z</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>  likedById</span><span>:</span><span> </span><span>789</span><span>,</span></span>
<span data-line=""><span>  postId</span><span>:</span><span> </span><span>1002</span></span>
<span data-line=""><span>},</span><span> </span><span>/* ... */</span><span>]</span></span></code></pre></div>
<p>However, what we want to <em>display</em> to the user is different.</p>
<p>What we want to display is the <em>number of Likes</em> for that Post, whether the <em>user has already liked it</em>, and the names of <em>their friends who also liked it</em>. For example, the Like button could appear pressed in (which means that you already liked this post) and say “You, Alice, and 13 others liked this.” Or “Alice, Bob, and 12 others liked this.”</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>type</span><span> LikeButtonProps </span><span>=</span><span> </span><span>{</span></span>
<span data-line=""><span>  totalLikeCount</span><span>:</span><span> </span><span>number</span><span>,</span></span>
<span data-line=""><span>  isLikedByUser</span><span>:</span><span> </span><span>boolean</span><span>,</span></span>
<span data-line=""><span>  friendLikes</span><span>:</span><span> </span><span>string</span><span>[]</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>Let’s call this kind of data a “ViewModel”.</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>type</span><span> ViewModel </span><span>=</span><span> </span><span>LikeButtonProps</span><span>;</span></span></code></pre></div>
<p>A ViewModel represents data in a way that is directly consumable by the UI (i.e the <em>view</em>). It is often significantly different from the raw Model. In our example:</p>
<ul>
<li>ViewModel’s <code>totalLikeCount</code> is aggregated from individual <code>Like</code> models.</li>
<li>ViewModel’s <code>isLikedByUser</code> is personalized and depends on the user.</li>
<li>ViewModel’s <code>friendLikes</code> is both aggregated and personalized. To calculate it, you’d have to takes the Likes for this post, filter them down to likes from friends, and get the first few friends’ names (which are likely stored in a different table).</li>
</ul>
<p>Clearly, Models will need to turn into ViewModels at some point. The question is <em>where</em> and <em>when</em> this happens in the code, and how that code evolves over time.</p>
<hr/>
<h3 id="rest-and-json-api"><a target="_self" href="#rest-and-json-api">REST and JSON API</a></h3>
<p>The most common way to solve this problem is to expose some kind of a JSON API that the client can hit to assemble the ViewModel. There are different ways to design such an API, but the most common way is what’s usually known as REST.</p>
<p>The typical way to approach REST (<a target="_blank" href="https://htmx.org/essays/how-did-rest-come-to-mean-the-opposite-of-rest/">let’s say we’ve never read this article</a>) is to pick some “Resources”—such as a Post, or a Like—and provide JSON API endpoints that list, create, update, and delete such Resources. Naturally, REST does not specify anything about how you should <em>shape</em> these Resources so there’s a lot of flexibility.</p>
<p>Often, you might start by returning the shape of the Model:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>// GET /api/post/123</span></span>
<span data-line=""><span>{</span></span>
<span data-line=""><span>  title: </span><span>&#39;</span><span>My Post</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>  content: </span><span>&#39;</span><span>Hello world...</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>  authorId: </span><span>123</span><span>,</span></span>
<span data-line=""><span>  createdAt: </span><span>&#39;</span><span>2025-04-13T02:04:40.668Z</span><span>&#39;</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>So far so good. But how would you incorporate Likes into this? Maybe <code>totalLikeCount</code> and <code>isLikedByUser</code> could be a part of the Post Resource:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>// GET /api/post/123</span></span>
<span data-line=""><span>{</span></span>
<span data-line=""><span>  title: </span><span>&#39;</span><span>My Post</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>  content: </span><span>&#39;</span><span>Hello world...</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>  authorId: </span><span>123</span><span>,</span></span>
<span data-line=""><span>  createdAt: </span><span>&#39;</span><span>2025-04-13T02:04:40.668Z</span><span>&#39;</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>  totalLikeCount: </span><span>13</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>  isLikedByUser: </span><span>true</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>Now, should <code>friendLikes</code> also go there? We need this information on the client.</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>// GET /api/post/123</span></span>
<span data-line=""><span>{</span></span>
<span data-line=""><span>  title: </span><span>&#39;</span><span>My Post</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>  authorId: </span><span>123</span><span>,</span></span>
<span data-line=""><span>  content: </span><span>&#39;</span><span>Hello world...</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>  createdAt: </span><span>&#39;</span><span>2025-04-13T02:04:40.668Z</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>  totalLikeCount: </span><span>13</span><span>,</span></span>
<span data-line=""><span>  isLikedByUser: </span><span>true</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>  friendLikes: </span><span>[</span><span>&#39;</span><span>Alice</span><span>&#39;</span><span>,</span><span> </span><span>&#39;</span><span>Bob</span><span>&#39;</span><span>]</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>Or are we starting to abuse the notion of a Post by adding too much stuff to it? Okay, how about this, maybe we could offer a separate endpoint for a Post’s Likes:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line="" data-highlighted-line=""><span>// GET /api/post/123/likes</span></span>
<span data-line=""><span>{</span></span>
<span data-line=""><span>  totalCount: </span><span>13</span><span>,</span></span>
<span data-line=""><span>  likes: </span><span>[{</span></span>
<span data-line=""><span>    createdAt</span><span>:</span><span> </span><span>&#39;</span><span>2025-04-13T02:04:41.668Z</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>    likedById</span><span>:</span><span> </span><span>123</span><span>,</span></span>
<span data-line=""><span>  </span><span>},</span><span> </span><span>{</span></span>
<span data-line=""><span>    createdAt</span><span>:</span><span> </span><span>&#39;</span><span>2025-04-13T02:04:42.668Z</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>    likedById</span><span>:</span><span> </span><span>768</span><span>,</span></span>
<span data-line=""><span>  </span><span>},</span><span> </span><span>/* ... */</span><span>]</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>So a Post’s Like becomes its own “Resource”.</p>
<p>That’s nice in theory but we’re going to need to know the likers’ names, and we don’t want to make a request for each Like. So we need to “expand” the users here:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>// GET /api/post/123/likes</span></span>
<span data-line=""><span>{</span></span>
<span data-line=""><span>  totalCount: </span><span>13</span><span>,</span></span>
<span data-line=""><span>  likes: </span><span>[{</span></span>
<span data-line=""><span>    createdAt</span><span>:</span><span> </span><span>&#39;</span><span>2025-04-13T02:04:41.668Z</span><span>&#39;</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    likedBy</span><span>:</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>      id</span><span>:</span><span> </span><span>123</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      firstName</span><span>:</span><span> </span><span>&#39;</span><span>Alice</span><span>&#39;</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      lastName</span><span>:</span><span> </span><span>&#39;</span><span>Lovelace</span><span>&#39;</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>}</span></span>
<span data-line=""><span>  </span><span>},</span><span> </span><span>{</span></span>
<span data-line=""><span>    createdAt</span><span>:</span><span> </span><span>&#39;</span><span>2025-04-13T02:04:42.668Z</span><span>&#39;</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    likedBy</span><span>:</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>      id</span><span>:</span><span> </span><span>768</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      firstName</span><span>:</span><span> </span><span>&#39;</span><span>Bob</span><span>&#39;</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      lastName</span><span>:</span><span> </span><span>&#39;</span><span>Babbage</span><span>&#39;</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>}</span></span>
<span data-line=""><span>  </span><span>}]</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>We also “forgot” which of these Likes are from friends. Should we solve this by having a separate <code>/api/post/123/friend-likes</code> endpoint? Or should we order by friends first and include <code>isFriend</code> into the <code>likes</code> array items so we can disambiguate friends from other likes? Or should we add <code>?filter=friends</code>?</p>
<p>Or should we include the friend likes directly into the Post to avoid two API calls?</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>// GET /api/post/123</span></span>
<span data-line=""><span>{</span></span>
<span data-line=""><span>  title: </span><span>&#39;</span><span>My Post</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>  authorId: </span><span>123</span><span>,</span></span>
<span data-line=""><span>  content: </span><span>&#39;</span><span>Hello world...</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>  createdAt: </span><span>&#39;</span><span>2025-04-13T02:04:40.668Z</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>  totalLikeCount: </span><span>13</span><span>,</span></span>
<span data-line=""><span>  isLikedByUser: </span><span>true</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>  friendLikes: </span><span>[{</span></span>
<span data-line="" data-highlighted-line=""><span>    createdAt</span><span>:</span><span> </span><span>&#39;</span><span>2025-04-13T02:04:41.668Z</span><span>&#39;</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    likedBy</span><span>:</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>      id</span><span>:</span><span> </span><span>123</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      firstName</span><span>:</span><span> </span><span>&#39;</span><span>Alice</span><span>&#39;</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      lastName</span><span>:</span><span> </span><span>&#39;</span><span>Lovelace</span><span>&#39;</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>}</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>},</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>    createdAt</span><span>:</span><span> </span><span>&#39;</span><span>2025-04-13T02:04:42.668Z</span><span>&#39;</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    likedBy</span><span>:</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>      id</span><span>:</span><span> </span><span>768</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      firstName</span><span>:</span><span> </span><span>&#39;</span><span>Bob</span><span>&#39;</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      lastName</span><span>:</span><span> </span><span>&#39;</span><span>Babbage</span><span>&#39;</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>}</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>}]</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>This seems useful but what if <code>/api/post/123</code> gets called from other screens that don’t need this information—and you’d rather not slow them down? Maybe there could be an opt-in like <code>/api/post/123?expand=friendLikes</code>?</p>
<p>Anyway, the point I’m trying to make here is not that it’s <em>impossible</em> to design a good REST API. The vast majority of apps I’ve seen works this way so it’s at the very least doable. But anyone who designed one and then worked on it for more than a few months knows the drill. <em>Evolving REST endpoints is a pain in the ass.</em></p>
<p>It usually goes like this:</p>
<ol>
<li>Initially, you have to decide how to structure the JSON output. None of the options are <em>clearly better</em> than the rest; mostly you’re just guessing how the app will evolve.</li>
<li>The initial decisions tend to settle down after a few back-and-forth iterations… until the next UI redesign which causes ViewModels to have slightly different shapes. The already existing REST endpoints don’t quite cover the new needs.</li>
<li>It’s possible to add new REST API endpoints, but at some point you’re not really “supposed to” add more because you already defined all the possible Resources. For example, if <code>/posts/123</code> exists, you likely won’t add another “get post” API.</li>
<li>Now you’re running into issues with calculating and sending either <em>not enough</em> or <em>too much</em> data. You either aggressively “expand” fields in the existing Resources or come up with an elaborate set of conventions for doing it on-demand.</li>
<li>Some ViewModels are only needed by a subset of screens but they’re always included in the response because that’s easier than making them configurable.</li>
<li>Some screens resort to cobbling their ViewModels together from multiple API calls because no single response contains all the necessary information anymore.</li>
<li>Then the design and the functionality of your product changes again. <em>Repeat.</em></li>
</ol>
<p>There’s clearly some fundamental tension here, but what is causing it?</p>
<p>First, note how the shape of the ViewModels is determined by the UI. It’s not a reflection of some platonic idea of a Like; rather, it’s dictated by the design. We want to show “You, Ann, and 13 others liked this”, <em>therefore</em> we need these fields:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>type</span><span> LikeButtonProps </span><span>=</span><span> </span><span>{</span></span>
<span data-line=""><span>  totalLikeCount</span><span>:</span><span> </span><span>number</span><span>,</span></span>
<span data-line=""><span>  isLikedByUser</span><span>:</span><span> </span><span>boolean</span><span>,</span></span>
<span data-line=""><span>  friendLikes</span><span>:</span><span> </span><span>string</span><span>[]</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>If this screen’s design or functionality changes (for example, if you want to show the avatars of your friends who liked the post), the ViewModel will change as well:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>type</span><span> LikeButtonProps </span><span>=</span><span> </span><span>{</span></span>
<span data-line=""><span>  totalLikeCount</span><span>:</span><span> </span><span>number</span><span>,</span></span>
<span data-line=""><span>  isLikedByUser</span><span>:</span><span> </span><span>boolean</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>  friendLikes</span><span>:</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>    firstName</span><span>:</span><span> </span><span>string</span></span>
<span data-line="" data-highlighted-line=""><span>    avatar</span><span>:</span><span> </span><span>string</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>}[]</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>But here’s the rub.</p>
<p>REST (or, rather, how REST is broadly used) encourages you to think in terms of Resources rather than Models <em>or</em> ViewModels. At first, your Resources start out as mirroring Models. But a single Model rarely has enough data for a screen, so you develop ad-hoc conventions for nesting Models in a Resource. However, including <em>all</em> the relevant Models (e.g. all Likes of a Post) is often impossible or impractical, so you start adding ViewModel-ish fields like <code>friendLikes</code> to your Resources.</p>
<p>But putting ViewModels in Resources also doesn’t work very well. ViewModels are not abstract concepts like “a post”; each ViewModel describes a <em>specific piece of UI</em>. As a result, the shape of your “Post” Resource grows to encompass the needs of every screen displaying a post. But those needs also <em>change over time,</em> so the “Post” Resource’s shape is at best a compromise between what different screens need now, and at worst a fossilized record of everything they’ve ever needed in the past.</p>
<p>Let me put this more bluntly:</p>
<p><strong>REST Resources don’t have a firm grounding in the reality.</strong> Their shapes are not sufficiently constrained—we’re making up concepts mostly out of thin air. Unlike Models, they’re not grounded in the reality of how the data is stored. And unlike ViewModels, they’re not grounded in the reality of how the data is presented. Unfortunately, nudging them in either direction only makes things worse.</p>
<p>If you keep REST Resources close to the Models, you’ll hurt the user experience. Now things that could be fetched in a single request would require a couple or, god forbid, N calls. This is especially noticeable in products from companies where the backend team “hands off” a REST API to the frontend team and takes no feedback. The API may look simple and elegant but it is completely impractical to consume.</p>
<p>On the other hand, if you nudge REST Resources to stay closer to the ViewModels, you’re hurting maintainability. ViewModels are fickle! Most ViewModels are going to change the next time the corresponding piece of UI is redesigned. But changing the shape of REST Resources is hard—the same Resources are being fetched by many screens. As a result, their shape gradually drifts away from the needs of the current ViewModels, and becomes difficult to evolve. There’s a reason the backend teams often resist adding UI-specific fields to the response: they’ll likely get stale!</p>
<p>This doesn’t necessarily mean that REST itself, as it’s broadly understood, is broken. It can be very nice to use when the Resources are well-defined and their fields are well-chosen. But this often goes against the client’s needs, which is to get all the data <em>for a particular screen</em>. There’s something missing in the middle.</p>
<p>We need a translation layer.</p>
<hr/>
<h3 id="api-for-viewmodels"><a target="_self" href="#api-for-viewmodels">API for ViewModels</a></h3>
<p>There is a way to resolve this tension.</p>
<p>You have some latitude with how exactly you could approach it but the main idea is that your client should be able to request <em>all data for a specific screen at once</em>.</p>
<p>It’s such a simple idea!</p>
<p>Instead of requesting “canonical” REST Resources from the client such as:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="bash" data-theme="default"><code data-language="bash" data-theme="default"><span data-line=""><span>GET</span><span> </span><span>/data/post/123</span><span>       </span><span># Get Post Resource</span></span>
<span data-line=""><span>GET</span><span> </span><span>/data/post/123/likes</span><span> </span><span># Get Post Likes Resource</span></span></code></pre></div>
<p>you request a ViewModel for <em>a specific screen</em> (i.e. a route):</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="bash" data-theme="default"><code data-language="bash" data-theme="default"><span data-line=""><span>GET</span><span> </span><span>/screens/post-details/123</span><span> </span><span># Get ViewModel for the PostDetails screen</span></span></code></pre></div>
<p>This data would include <em>everything</em> that screen needs.</p>
<p>The difference is subtle but profound. You’re no longer trying to define a universal canonical shape of a <em>Post</em>. Rather, you send whatever data the <em>PostDetails screen</em> needs in order to display its components <em>today</em>. If the PostDetails screen gets deleted, this endpoint gets deleted too. If a different screen wants to display some related information (for example, a PostLikedBy popup), it will gets its own route:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="bash" data-theme="default"><code data-language="bash" data-theme="default"><span data-line=""><span>GET</span><span> </span><span>/screens/post-details/123</span><span> </span><span># Get ViewModel for the PostDetails screen</span></span>
<span data-line="" data-highlighted-line=""><span>GET</span><span> </span><span>/screens/post-liked-by/123</span><span> </span><span># Get ViewModel for the PostLikedBy screen</span></span></code></pre></div>
<p>Okay, but how does this help?</p>
<p>This avoids the trap of “ungrounded” abstraction. The ViewModel interface for every screen precisely specifies the shape of the server response. If you need to change it or fine-tune it, you can do that without affecting any other screens.</p>
<p>For example, a <code>PostDetails</code> screen ViewModel might look like this:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>type</span><span> PostDetailsViewModel </span><span>=</span><span> </span><span>{</span></span>
<span data-line=""><span>  postTitle</span><span>:</span><span> </span><span>string</span><span>,</span></span>
<span data-line=""><span>  postContent</span><span>:</span><span> </span><span>string</span><span>,</span></span>
<span data-line=""><span>  postAuthor</span><span>:</span><span> </span><span>{</span></span>
<span data-line=""><span>    name</span><span>:</span><span> </span><span>string</span><span>,</span></span>
<span data-line=""><span>    avatar</span><span>:</span><span> </span><span>string</span><span>,</span></span>
<span data-line=""><span>    id</span><span>:</span><span> </span><span>number</span></span>
<span data-line=""><span>  </span><span>},</span></span>
<span data-line=""><span>  friendLikes</span><span>:</span><span> </span><span>{</span></span>
<span data-line=""><span>    totalLikeCount</span><span>:</span><span> </span><span>number</span><span>,</span></span>
<span data-line=""><span>    isLikedByUser</span><span>:</span><span> </span><span>boolean</span><span>,</span></span>
<span data-line=""><span>    friendLikes</span><span>:</span><span> </span><span>string</span><span>[]</span></span>
<span data-line=""><span>  </span><span>}</span></span>
<span data-line=""><span>};</span></span></code></pre></div>
<p>So that’s what the server would return for <code>/screens/post-details/123</code>. Later, if you want to display avatars of friend likes, you’d just add it to <em>that</em> ViewModel:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>type</span><span> PostDetailsViewModel </span><span>=</span><span> </span><span>{</span></span>
<span data-line=""><span>  postTitle</span><span>:</span><span> </span><span>string</span><span>,</span></span>
<span data-line=""><span>  postContent</span><span>:</span><span> </span><span>string</span><span>,</span></span>
<span data-line=""><span>  postAuthor</span><span>:</span><span> </span><span>{</span></span>
<span data-line=""><span>    name</span><span>:</span><span> </span><span>string</span><span>,</span></span>
<span data-line=""><span>    avatar</span><span>:</span><span> </span><span>string</span><span>,</span></span>
<span data-line=""><span>    id</span><span>:</span><span> </span><span>number</span></span>
<span data-line=""><span>  </span><span>},</span></span>
<span data-line=""><span>  friendLikes</span><span>:</span><span> </span><span>{</span></span>
<span data-line=""><span>    totalLikeCount</span><span>:</span><span> </span><span>number</span><span>,</span></span>
<span data-line=""><span>    isLikedByUser</span><span>:</span><span> </span><span>boolean</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    friendLikes</span><span>:</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>      firstName</span><span>:</span><span> </span><span>string</span></span>
<span data-line="" data-highlighted-line=""><span>      avatar</span><span>:</span><span> </span><span>string</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>}[]</span></span>
<span data-line=""><span>  </span><span>}</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>Note that you’d only have to update <em>that screen’s endpoint</em>. You’re no longer forced to balance what one screen needs with what another screen needs. There are no questions like “which Resource does this field belong to?”, or whether it should be “expanded”. If some screen needs more data than others, you can just include more data in <em>that</em> screen’s response—it doesn’t have to be generic or configurable. <strong>The shape of the server response is exactly determined by each screen’s needs.</strong></p>
<p>This <em>does</em> solve the stated problems with REST.</p>
<p>It also introduces a few novel questions:</p>
<ol>
<li>There’s going to be <em>a lot</em> more endpoints than with REST Resources—an endpoint per screen. How will these endpoints be structured and kept maintainable?</li>
<li>How do you reuse code between the endpoints? Presumably there would be a lot of duplicated data access and other business logic between those endpoints.</li>
<li>How do you convince the backend team to pivot from their REST APIs to this?</li>
</ol>
<p>The last question is probably the first we need to resolve. The backend team will likely have very warranted reservations about this approach. At the very least, if this approach proves terrible, it would be good to have a way to migrate back.</p>
<p>Luckily, there’s no need to throw anything away.</p>
<hr/>
<h3 id="backend-for-frontend"><a target="_self" href="#backend-for-frontend">Backend For Frontend</a></h3>
<p>Instead or <em>replacing</em> your existing REST API, you can add a new <em>layer</em> in front of it:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line="" data-highlighted-line=""><span>// You&#39;re adding new screen-specific endpoints...</span></span>
<span data-line="" data-highlighted-line=""><span>app</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>/screen/post-details/:postId</span><span>&#39;</span><span>,</span><span> </span><span>async</span><span> </span><span>(</span><span>req</span><span>,</span><span> res</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>// ...which call your existing REST API here</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>fetch</span><span>(</span><span>`/api/post/</span><span>${</span><span>postId</span><span>}</span><span>`</span><span>).</span><span>then</span><span>(</span><span>r </span><span>=&gt;</span><span> </span><span>r</span><span>.</span><span>json</span><span>()),</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>fetch</span><span>(</span><span>`/api/post/</span><span>${</span><span>postId</span><span>}</span><span>/friend-likes`</span><span>).</span><span>then</span><span>(</span><span>r </span><span>=&gt;</span><span> </span><span>r</span><span>.</span><span>json</span><span>()),</span></span>
<span data-line=""><span>  </span><span>]);</span></span>
<span data-line=""><span>  </span><span>const </span><span>viewModel</span><span> </span><span>=</span><span> </span><span>{</span></span>
<span data-line=""><span>    </span><span>postTitle</span><span>:</span><span> </span><span>post</span><span>.</span><span>title</span><span>,</span></span>
<span data-line=""><span>    </span><span>postContent</span><span>:</span><span> </span><span>parseMarkdown</span><span>(</span><span>post</span><span>.</span><span>content</span><span>),</span></span>
<span data-line=""><span>    </span><span>postAuthor</span><span>:</span><span> </span><span>post</span><span>.</span><span>author</span><span>,</span></span>
<span data-line=""><span>    </span><span>postLikes</span><span>:</span><span> </span><span>{</span></span>
<span data-line=""><span>      totalLikeCount</span><span>:</span><span> </span><span>post</span><span>.</span><span>totalLikeCount</span><span>,</span></span>
<span data-line=""><span>      isLikedByUser</span><span>:</span><span> </span><span>post</span><span>.</span><span>isLikedByUser</span><span>,</span></span>
<span data-line=""><span>      friendLikes</span><span>:</span><span> </span><span>friendLikes</span><span>.</span><span>likes</span><span>.</span><span>map</span><span>(</span><span>l </span><span>=&gt;</span><span> </span><span>l</span><span>.</span><span>firstName</span><span>)</span></span>
<span data-line=""><span>    </span><span>}</span></span>
<span data-line=""><span>  </span><span>};</span></span>
<span data-line=""><span>  </span><span>res</span><span>.</span><span>json</span><span>(</span><span>viewModel</span><span>);</span></span>
<span data-line=""><span>});</span></span></code></pre></div>
<p>This is not a new idea. Such a layer is often called BFF, or <em>Backend for Frontend.</em> In this case, the job of the BFF is to adapt your REST API to returning ViewModels.</p>
<p><strong>If some screen needs more data, a BFF lets you serve more data to it without changing your entire data model. It keeps screen-specific changes scoped. Crucially, it lets you deliver all the data any screen needs in a single roundtrip.</strong></p>
<p>The BFF doesn’t have to be written in the same language as your REST API. For reasons we’ll get into later, it’s advantageous to write BFF in the same language as your frontend code. You can think of it as <em>a piece of the frontend that happens to run on the server</em>. It’s like the frontend’s “ambassador” to the server. It “adapts” the REST responses into the shape that each screen of the frontend UI actually wants.</p>
<p>Although you can get some of the benefits of BFF with client-only per-route loaders like <a target="_blank" href="https://reactrouter.com/start/framework/data-loading#client-data-loading"><code>clientLoader</code> in React Router</a>, there’s a lot you unlock by actually deploying this layer on the server close to where the REST endpoints are deployed.</p>
<p>For example, even if you <em>do</em> have to make several REST API requests serially one after another to load all the necessary data for a screen, the latency between the BFF and your REST API would be much lower than when making multiple serial requests from the client. If your REST API responses are fast on the internal network, you can cut down literal seconds of what used to be client/sever waterfalls without actually parallelizing the (sometimes inevitable) serial calls.</p>
<p>A BFF also lets you apply data transformations <em>before</em> sending data to the client, which can significantly improve performance on low-end client devices. You can even go as far as to cache or persist some computations on the disk, even <em>between</em> different users, since you have access to the disk—and to server caches like Redis. In that sense, a BFF lets a frontend team have <em>their very own little slice of the server</em>.</p>
<p>Importantly, a BFF gives you a way to experiment with alternatives to your REST APIs without affecting the client application. For example, if your REST API has no other consumers, you can turn it into an internal microservice and avoid exposing it to the world. Moreover, you could turn it into a <em>data access layer</em> rather than an HTTP service, and simply <em>import</em> that data access layer in-process from your BFF:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line="" data-highlighted-line=""><span>import</span><span> </span><span>{</span><span> getPost</span><span>,</span><span> getFriendLikes </span><span>}</span><span> </span><span>from</span><span> </span><span>&#39;</span><span>@your-company/data-layer</span><span>&#39;</span><span>;</span></span>
<span data-line=""> </span>
<span data-line=""><span>app</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>/screen/post-details/:postId</span><span>&#39;</span><span>,</span><span> </span><span>async</span><span> </span><span>(</span><span>req</span><span>,</span><span> res</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const </span><span>postId</span><span> </span><span>=</span><span> req</span><span>.</span><span>params</span><span>.</span><span>postId</span><span>;</span></span>
<span data-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>// Reads from an ORM and applies business logic.</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>getFriendLikes</span><span>(</span><span>postId</span><span>,</span><span> </span><span>{</span><span> limit</span><span>:</span><span> </span><span>2</span><span> </span><span>}),</span></span>
<span data-line=""><span>  </span><span>]);</span></span>
<span data-line=""><span>  </span><span>const </span><span>viewModel</span><span> </span><span>=</span><span> </span><span>{</span></span>
<span data-line=""><span>    </span><span>postTitle</span><span>:</span><span> </span><span>post</span><span>.</span><span>title</span><span>,</span></span>
<span data-line=""><span>    </span><span>postContent</span><span>:</span><span> </span><span>parseMarkdown</span><span>(</span><span>post</span><span>.</span><span>content</span><span>),</span></span>
<span data-line=""><span>    </span><span>postAuthor</span><span>:</span><span> </span><span>post</span><span>.</span><span>author</span><span>,</span></span>
<span data-line=""><span>    </span><span>postLikes</span><span>:</span><span> </span><span>{</span></span>
<span data-line=""><span>      totalLikeCount</span><span>:</span><span> </span><span>post</span><span>.</span><span>totalLikeCount</span><span>,</span></span>
<span data-line=""><span>      isLikedByUser</span><span>:</span><span> </span><span>post</span><span>.</span><span>isLikedByUser</span><span>,</span></span>
<span data-line=""><span>      friendLikes</span><span>:</span><span> </span><span>friendLikes</span><span>.</span><span>likes</span><span>.</span><span>map</span><span>(</span><span>l </span><span>=&gt;</span><span> </span><span>l</span><span>.</span><span>firstName</span><span>)</span></span>
<span data-line=""><span>    </span><span>}</span></span>
<span data-line=""><span>  </span><span>};</span></span>
<span data-line=""><span>  </span><span>res</span><span>.</span><span>json</span><span>(</span><span>viewModel</span><span>);</span></span>
<span data-line=""><span>});</span></span></code></pre></div>
<p>(Of course, this part only works if you can write lower-level backend logic in JS.)</p>
<p>This can help you avoid problems like loading the same information many times from the database (no <code>fetch</code> calls means database reads can be batched). It also lets you “drop down” the abstraction level when needed—for example, to run a fine-tuned stored database procedure that isn’t neatly exposed over the REST API.</p>
<p>There’s a lot to like about the BFF pattern. It solves quite a few problems but it also raises new questions. For example, how do you organize its code? If each screen is essentially its own API method, how do you avoid duplication of code? And how do you keep your BFF synchronized with data requirements of the front-end side?</p>
<p>Let’s try to make some progress on answering those.</p>
<hr/>
<h3 id="composable-bff"><a target="_self" href="#composable-bff">Composable BFF</a></h3>
<p>Suppose you’re adding a new <code>PostList</code> screen. It’s going to render <em>an array</em> of <code>&lt;PostDetails&gt;</code> components, each of which needs the same data as before:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>type</span><span> PostDetailsViewModel </span><span>=</span><span> </span><span>{</span></span>
<span data-line=""><span>  postTitle</span><span>:</span><span> </span><span>string</span><span>,</span></span>
<span data-line=""><span>  postContent</span><span>:</span><span> </span><span>string</span><span>,</span></span>
<span data-line=""><span>  postAuthor</span><span>:</span><span> </span><span>{</span></span>
<span data-line=""><span>    name</span><span>:</span><span> </span><span>string</span><span>,</span></span>
<span data-line=""><span>    avatar</span><span>:</span><span> </span><span>string</span><span>,</span></span>
<span data-line=""><span>    id</span><span>:</span><span> </span><span>number</span></span>
<span data-line=""><span>  </span><span>},</span></span>
<span data-line=""><span>  friendLikes</span><span>:</span><span> </span><span>{</span></span>
<span data-line=""><span>    totalLikeCount</span><span>:</span><span> </span><span>number</span><span>,</span></span>
<span data-line=""><span>    isLikedByUser</span><span>:</span><span> </span><span>boolean</span><span>,</span></span>
<span data-line=""><span>    friendLikes</span><span>:</span><span> </span><span>string</span><span>[]</span></span>
<span data-line=""><span>  </span><span>}</span></span>
<span data-line=""><span>};</span></span></code></pre></div>
<p>So the ViewModel for <code>PostList</code> contains an array of <code>PostDetailsViewModel</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>type</span><span> PostListViewModel </span><span>=</span><span> </span><span>{</span></span>
<span data-line=""><span>  posts</span><span>:</span><span> </span><span>PostDetailsViewModel</span><span>[]</span></span>
<span data-line=""><span>};</span></span></code></pre></div>
<p>How would you load the data for <code>PostList</code>?</p>
<p>Your first inclination may be to make a series of requests from the client to the existing <code>/screen/post-details/:postId</code> endpoint which already knows how to prepare a ViewModel for a single post. We just need to call it for every post.</p>
<p>But wait, this defeats the entire purpose of the BFF! Making many requests for a single screen is inefficient and is precisely the kind of compromise that we’ve been trying to avoid. <strong>Instead, we’ll add a new BFF endpoint for the new screen.</strong></p>
<p>The new endpoint might initially look like this:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>import</span><span> </span><span>{</span><span> getPost</span><span>,</span><span> getFriendLikes</span><span>,</span><span> getRecentPostIds </span><span>}</span><span> </span><span>from</span><span> </span><span>&#39;</span><span>@your-company/data-layer</span><span>&#39;</span><span>;</span></span>
<span data-line=""> </span>
<span data-line=""><span>app</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>/screen/post-details/:postId</span><span>&#39;</span><span>,</span><span> </span><span>async</span><span> </span><span>(</span><span>req</span><span>,</span><span> res</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const </span><span>postId</span><span> </span><span>=</span><span> req</span><span>.</span><span>params</span><span>.</span><span>postId</span><span>;</span></span>
<span data-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line=""><span>    </span><span>getFriendLikes</span><span>(</span><span>postId</span><span>,</span><span> </span><span>{</span><span> limit</span><span>:</span><span> </span><span>2</span><span> </span><span>}),</span></span>
<span data-line=""><span>  </span><span>]);</span></span>
<span data-line=""><span>  </span><span>const </span><span>viewModel</span><span> </span><span>=</span><span> </span><span>{</span></span>
<span data-line=""><span>    </span><span>postTitle</span><span>:</span><span> </span><span>post</span><span>.</span><span>title</span><span>,</span></span>
<span data-line=""><span>    </span><span>postContent</span><span>:</span><span> </span><span>parseMarkdown</span><span>(</span><span>post</span><span>.</span><span>content</span><span>),</span></span>
<span data-line=""><span>    </span><span>postAuthor</span><span>:</span><span> </span><span>post</span><span>.</span><span>author</span><span>,</span></span>
<span data-line=""><span>    </span><span>postLikes</span><span>:</span><span> </span><span>{</span></span>
<span data-line=""><span>      totalLikeCount</span><span>:</span><span> </span><span>post</span><span>.</span><span>totalLikeCount</span><span>,</span></span>
<span data-line=""><span>      isLikedByUser</span><span>:</span><span> </span><span>post</span><span>.</span><span>isLikedByUser</span><span>,</span></span>
<span data-line=""><span>      friendLikes</span><span>:</span><span> </span><span>friendLikes</span><span>.</span><span>likes</span><span>.</span><span>map</span><span>(</span><span>l </span><span>=&gt;</span><span> </span><span>l</span><span>.</span><span>firstName</span><span>)</span></span>
<span data-line=""><span>    </span><span>}</span></span>
<span data-line=""><span>  </span><span>};</span></span>
<span data-line=""><span>  </span><span>res</span><span>.</span><span>json</span><span>(</span><span>viewModel</span><span>);</span></span>
<span data-line=""><span>});</span></span>
<span data-line=""> </span>
<span data-line="" data-highlighted-line=""><span>app</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>/screen/post-list</span><span>&#39;</span><span>,</span><span> </span><span>async</span><span> </span><span>(</span><span>req</span><span>,</span><span> res</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>// Grab the recent post IDs</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>const </span><span>postIds</span><span> </span><span>=</span><span> await </span><span>getRecentPostIds</span><span>();</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>const </span><span>viewModel</span><span> </span><span>=</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>// For each post ID, load the data in parallel</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>posts</span><span>:</span><span> </span><span>await</span><span> </span><span>Promise</span><span>.</span><span>all</span><span>(</span><span>postIds</span><span>.</span><span>map</span><span>(</span><span>async</span><span> postId </span><span>=&gt;</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>      </span><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line="" data-highlighted-line=""><span>        </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line="" data-highlighted-line=""><span>        </span><span>getFriendLikes</span><span>(</span><span>postId</span><span>,</span><span> </span><span>{</span><span> limit</span><span>:</span><span> </span><span>2</span><span> </span><span>}),</span></span>
<span data-line="" data-highlighted-line=""><span>      </span><span>]);</span></span>
<span data-line="" data-highlighted-line=""><span>      </span><span>const </span><span>postDetailsViewModel</span><span> </span><span>=</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>        </span><span>postTitle</span><span>:</span><span> </span><span>post</span><span>.</span><span>title</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>        </span><span>postContent</span><span>:</span><span> </span><span>parseMarkdown</span><span>(</span><span>post</span><span>.</span><span>content</span><span>),</span></span>
<span data-line="" data-highlighted-line=""><span>        </span><span>postAuthor</span><span>:</span><span> </span><span>post</span><span>.</span><span>author</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>        </span><span>postLikes</span><span>:</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>          totalLikeCount</span><span>:</span><span> </span><span>post</span><span>.</span><span>totalLikeCount</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>          isLikedByUser</span><span>:</span><span> </span><span>post</span><span>.</span><span>isLikedByUser</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>          friendLikes</span><span>:</span><span> </span><span>friendLikes</span><span>.</span><span>likes</span><span>.</span><span>map</span><span>(</span><span>l </span><span>=&gt;</span><span> </span><span>l</span><span>.</span><span>firstName</span><span>)</span></span>
<span data-line="" data-highlighted-line=""><span>        </span><span>}</span></span>
<span data-line="" data-highlighted-line=""><span>      </span><span>};</span></span>
<span data-line="" data-highlighted-line=""><span>      </span><span>return</span><span> postDetailsViewModel</span><span>;</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>}))</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>};</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>res</span><span>.</span><span>json</span><span>(</span><span>viewModel</span><span>);</span></span>
<span data-line="" data-highlighted-line=""><span>});</span></span></code></pre></div>
<p>However, note that there’s significant code duplication between the endpoints:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>import</span><span> </span><span>{</span><span> getPost</span><span>,</span><span> getFriendLikes</span><span>,</span><span> getRecentPostIds </span><span>}</span><span> </span><span>from</span><span> </span><span>&#39;</span><span>@your-company/data-layer</span><span>&#39;</span><span>;</span></span>
<span data-line=""> </span>
<span data-line=""><span>app</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>/screen/post-details/:postId</span><span>&#39;</span><span>,</span><span> </span><span>async</span><span> </span><span>(</span><span>req</span><span>,</span><span> res</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const </span><span>postId</span><span> </span><span>=</span><span> req</span><span>.</span><span>params</span><span>.</span><span>postId</span><span>;</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>getFriendLikes</span><span>(</span><span>postId</span><span>,</span><span> </span><span>{</span><span> limit</span><span>:</span><span> </span><span>2</span><span> </span><span>}),</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>]);</span></span>
<span data-line=""><span>  </span><span>const </span><span>viewModel</span><span> </span><span>=</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>postTitle</span><span>:</span><span> </span><span>post</span><span>.</span><span>title</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>postContent</span><span>:</span><span> </span><span>parseMarkdown</span><span>(</span><span>post</span><span>.</span><span>content</span><span>),</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>postAuthor</span><span>:</span><span> </span><span>post</span><span>.</span><span>author</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>postLikes</span><span>:</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>      totalLikeCount</span><span>:</span><span> </span><span>post</span><span>.</span><span>totalLikeCount</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      isLikedByUser</span><span>:</span><span> </span><span>post</span><span>.</span><span>isLikedByUser</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      friendLikes</span><span>:</span><span> </span><span>friendLikes</span><span>.</span><span>likes</span><span>.</span><span>map</span><span>(</span><span>l </span><span>=&gt;</span><span> </span><span>l</span><span>.</span><span>firstName</span><span>)</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>}</span></span>
<span data-line=""><span>  </span><span>};</span></span>
<span data-line=""><span>  </span><span>res</span><span>.</span><span>json</span><span>(</span><span>viewModel</span><span>);</span></span>
<span data-line=""><span>});</span></span>
<span data-line=""> </span>
<span data-line=""><span>app</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>/screen/post-list</span><span>&#39;</span><span>,</span><span> </span><span>async</span><span> </span><span>(</span><span>req</span><span>,</span><span> res</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const </span><span>postIds</span><span> </span><span>=</span><span> await </span><span>getRecentPostIds</span><span>();</span></span>
<span data-line=""><span>  </span><span>const </span><span>viewModel</span><span> </span><span>=</span><span> </span><span>{</span></span>
<span data-line=""><span>    </span><span>posts</span><span>:</span><span> </span><span>await</span><span> </span><span>Promise</span><span>.</span><span>all</span><span>(</span><span>postIds</span><span>.</span><span>map</span><span>(</span><span>async</span><span> postId </span><span>=&gt;</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>      </span><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line="" data-highlighted-line=""><span>        </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line="" data-highlighted-line=""><span>        </span><span>getFriendLikes</span><span>(</span><span>postId</span><span>,</span><span> </span><span>{</span><span> limit</span><span>:</span><span> </span><span>2</span><span> </span><span>}),</span></span>
<span data-line="" data-highlighted-line=""><span>      </span><span>]);</span></span>
<span data-line=""><span>      </span><span>const </span><span>postDetailsViewModel</span><span> </span><span>=</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>        </span><span>postTitle</span><span>:</span><span> </span><span>post</span><span>.</span><span>title</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>        </span><span>postAuthor</span><span>:</span><span> </span><span>post</span><span>.</span><span>author</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>        </span><span>postContent</span><span>:</span><span> </span><span>parseMarkdown</span><span>(</span><span>post</span><span>.</span><span>content</span><span>),</span></span>
<span data-line="" data-highlighted-line=""><span>        </span><span>postLikes</span><span>:</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>          totalLikeCount</span><span>:</span><span> </span><span>post</span><span>.</span><span>totalLikeCount</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>          isLikedByUser</span><span>:</span><span> </span><span>post</span><span>.</span><span>isLikedByUser</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>          friendLikes</span><span>:</span><span> </span><span>friendLikes</span><span>.</span><span>likes</span><span>.</span><span>map</span><span>(</span><span>l </span><span>=&gt;</span><span> </span><span>l</span><span>.</span><span>firstName</span><span>)</span></span>
<span data-line="" data-highlighted-line=""><span>        </span><span>}</span></span>
<span data-line=""><span>      </span><span>};</span></span>
<span data-line=""><span>      </span><span>return</span><span> postDetailsViewModel</span><span>;</span></span>
<span data-line=""><span>    </span><span>}))</span></span>
<span data-line=""><span>  </span><span>};</span></span>
<span data-line=""><span>  </span><span>res</span><span>.</span><span>json</span><span>(</span><span>viewModel</span><span>);</span></span>
<span data-line=""><span>});</span></span></code></pre></div>
<p>It’s almost like there is a notion of “<code>PostDetails</code> ViewModel” begging to be extracted. This should not be surprising—both screens render the same <code>&lt;PostDetails&gt;</code> component, so they need similar code to load the data for it.</p>
<hr/>

<p>Let’s extract a <code>PostDetailsViewModel</code> function:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>import</span><span> </span><span>{</span><span> getPost</span><span>,</span><span> getFriendLikes</span><span>,</span><span> getRecentPostIds </span><span>}</span><span> </span><span>from</span><span> </span><span>&#39;</span><span>@your-company/data-layer</span><span>&#39;</span><span>;</span></span>
<span data-line=""> </span>
<span data-line="" data-highlighted-line=""><span>async</span><span> </span><span>function</span><span> </span><span>PostDetailsViewModel</span><span>(</span><span>{ postId }</span><span>)</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>getFriendLikes</span><span>(</span><span>postId</span><span>,</span><span> </span><span>{</span><span> limit</span><span>:</span><span> </span><span>2</span><span> </span><span>}),</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>]);</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>return</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>    postTitle</span><span>:</span><span> </span><span>post</span><span>.</span><span>title</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    postContent</span><span>:</span><span> </span><span>parseMarkdown</span><span>(</span><span>post</span><span>.</span><span>content</span><span>),</span></span>
<span data-line="" data-highlighted-line=""><span>    postAuthor</span><span>:</span><span> </span><span>post</span><span>.</span><span>author</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    postLikes</span><span>:</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>      totalLikeCount</span><span>:</span><span> </span><span>post</span><span>.</span><span>totalLikeCount</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      isLikedByUser</span><span>:</span><span> </span><span>post</span><span>.</span><span>isLikedByUser</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      friendLikes</span><span>:</span><span> </span><span>friendLikes</span><span>.</span><span>likes</span><span>.</span><span>map</span><span>(</span><span>l </span><span>=&gt;</span><span> </span><span>l</span><span>.</span><span>firstName</span><span>)</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>}</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>};</span></span>
<span data-line="" data-highlighted-line=""><span>}</span></span>
<span data-line=""> </span>
<span data-line=""><span>app</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>/screen/post-details/:postId</span><span>&#39;</span><span>,</span><span> </span><span>async</span><span> </span><span>(</span><span>req</span><span>,</span><span> res</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const </span><span>postId</span><span> </span><span>=</span><span> req</span><span>.</span><span>params</span><span>.</span><span>postId</span><span>;</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>const </span><span>viewModel</span><span> </span><span>=</span><span> await </span><span>PostDetailsViewModel</span><span>({</span><span> </span><span>postId </span><span>});</span></span>
<span data-line=""><span>  </span><span>res</span><span>.</span><span>json</span><span>(</span><span>viewModel</span><span>);</span></span>
<span data-line=""><span>});</span></span>
<span data-line=""> </span>
<span data-line=""><span>app</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>/screen/post-list</span><span>&#39;</span><span>,</span><span> </span><span>async</span><span> </span><span>(</span><span>req</span><span>,</span><span> res</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const </span><span>postIds</span><span> </span><span>=</span><span> await </span><span>getRecentPostIds</span><span>();</span></span>
<span data-line=""><span>  </span><span>const </span><span>viewModel</span><span> </span><span>=</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>posts</span><span>:</span><span> </span><span>await</span><span> </span><span>Promise</span><span>.</span><span>all</span><span>(</span><span>postIds</span><span>.</span><span>map</span><span>(</span><span>postId </span><span>=&gt;</span></span>
<span data-line="" data-highlighted-line=""><span>      </span><span>PostDetailsViewModel</span><span>({</span><span> postId </span><span>})</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>))</span></span>
<span data-line=""><span>  </span><span>};</span></span>
<span data-line=""><span>  </span><span>res</span><span>.</span><span>json</span><span>(</span><span>viewModel</span><span>);</span></span>
<span data-line=""><span>});</span></span></code></pre></div>
<p>This makes our BFF endpoints significantly simpler.</p>
<p>In fact, we can go a bit further. Look at this part of <code>PostDetailsViewModel</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>PostDetailsViewModel</span><span>(</span><span>{ postId }</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line=""><span>    </span><span>getFriendLikes</span><span>(</span><span>postId</span><span>,</span><span> </span><span>{</span><span> limit</span><span>:</span><span> </span><span>2</span><span> </span><span>}),</span></span>
<span data-line=""><span>  </span><span>]);</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>{</span></span>
<span data-line=""><span>    postTitle</span><span>:</span><span> </span><span>post</span><span>.</span><span>title</span><span>,</span></span>
<span data-line=""><span>    postContent</span><span>:</span><span> </span><span>parseMarkdown</span><span>(</span><span>post</span><span>.</span><span>content</span><span>),</span></span>
<span data-line=""><span>    postAuthor</span><span>:</span><span> </span><span>post</span><span>.</span><span>author</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    postLikes</span><span>:</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>      totalLikeCount</span><span>:</span><span> </span><span>post</span><span>.</span><span>totalLikeCount</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      isLikedByUser</span><span>:</span><span> </span><span>post</span><span>.</span><span>isLikedByUser</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      friendLikes</span><span>:</span><span> </span><span>friendLikes</span><span>.</span><span>likes</span><span>.</span><span>map</span><span>(</span><span>l </span><span>=&gt;</span><span> </span><span>l</span><span>.</span><span>firstName</span><span>)</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>}</span></span>
<span data-line=""><span>  </span><span>};</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>We know that the purpose of the <code>postLikes</code> field is to eventually become props for the <code>LikeButton</code> component—i.e. this field is <code>LikeButton</code>’s ViewModel:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>function</span><span> </span><span>LikeButton</span><span>(</span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>  totalLikeCount</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>  isLikedByUser</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>  friendLikes</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>// ...</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>So let’s extract the logic preparing these props into <code>LikeButtonViewModel</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>import</span><span> </span><span>{</span><span> getPost</span><span>,</span><span> getFriendLikes</span><span>,</span><span> getRecentPostIds </span><span>}</span><span> </span><span>from</span><span> </span><span>&#39;</span><span>@your-company/data-layer</span><span>&#39;</span><span>;</span></span>
<span data-line=""> </span>
<span data-line="" data-highlighted-line=""><span>async</span><span> </span><span>function</span><span> </span><span>LikeButtonViewModel</span><span>(</span><span>{ postId }</span><span>)</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>getFriendLikes</span><span>(</span><span>postId</span><span>,</span><span> </span><span>{</span><span> limit</span><span>:</span><span> </span><span>2</span><span> </span><span>}),</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>]);</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>return</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>    totalLikeCount</span><span>:</span><span> </span><span>post</span><span>.</span><span>totalLikeCount</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    isLikedByUser</span><span>:</span><span> </span><span>post</span><span>.</span><span>isLikedByUser</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    friendLikes</span><span>:</span><span> </span><span>friendLikes</span><span>.</span><span>likes</span><span>.</span><span>map</span><span>(</span><span>l </span><span>=&gt;</span><span> </span><span>l</span><span>.</span><span>firstName</span><span>)</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>};</span></span>
<span data-line=""><span>}</span></span>
<span data-line=""> </span>
<span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>PostDetailsViewModel</span><span>(</span><span>{ postId }</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>postLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span><span> </span><span>// It&#39;s fine to getPost() here again. Our data layer deduplicates calls via an in-memory cache.</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>LikeButtonViewModel</span><span>({</span><span> postId </span><span>}),</span></span>
<span data-line=""><span>  </span><span>]);</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>{</span></span>
<span data-line=""><span>    postTitle</span><span>:</span><span> </span><span>post</span><span>.</span><span>title</span><span>,</span></span>
<span data-line=""><span>    postContent</span><span>:</span><span> </span><span>parseMarkdown</span><span>(</span><span>post</span><span>.</span><span>content</span><span>),</span></span>
<span data-line=""><span>    postAuthor</span><span>:</span><span> </span><span>post</span><span>.</span><span>author</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    postLikes</span></span>
<span data-line=""><span>  </span><span>};</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>Now we have a tree of functions that load data as JSON—our ViewModels.</p>
<p>Depending on your background, this might remind you of a few other things. It might remind you of composing Redux reducers out of smaller reducers. It might also remind you of composing GraphQL fragments out of smaller fragments. Or it might remind you of composing React components from other React components.</p>
<p>Although the code style is a little verbose now, there is something oddly satisfying in breaking apart a screen’s ViewModel into smaller ViewModels. It feels similar to writing a React component tree, except that we’re decomposing a backend API. It’s like <em>the data has its own shape but it roughly lines up with your React component tree</em>.</p>
<p>Let’s see what happens when the UI needs to evolve.</p>
<hr/>
<h3 id="evolving-a-viewmodel"><a target="_self" href="#evolving-a-viewmodel">Evolving a ViewModel</a></h3>
<p>Suppose the UI design changes, and we want to display friends’ avatars too:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>type</span><span> LikeButtonProps </span><span>=</span><span> </span><span>{</span></span>
<span data-line=""><span>  totalLikeCount</span><span>:</span><span> </span><span>number</span><span>,</span></span>
<span data-line=""><span>  isLikedByUser</span><span>:</span><span> </span><span>boolean</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>  friendLikes</span><span>:</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>    firstName</span><span>:</span><span> </span><span>string</span></span>
<span data-line="" data-highlighted-line=""><span>    avatar</span><span>:</span><span> </span><span>string</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>}[]</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>Assuming we use TypeScript, we’ll immediately get a type error in the ViewModel:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>LikeButtonViewModel</span><span>(</span></span>
<span data-line=""><span>  { postId } </span><span>:</span><span> </span><span>{</span><span> postId</span><span>:</span><span> </span><span>number</span><span> </span><span>}</span></span>
<span data-line="" data-highlighted-line=""><span>)</span><span> </span><span>:</span><span> </span><span>LikeButtonProps</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line=""><span>    </span><span>getFriendLikes</span><span>(</span><span>postId</span><span>,</span><span> </span><span>{</span><span> limit</span><span>:</span><span> </span><span>2</span><span> </span><span>}),</span></span>
<span data-line=""><span>  </span><span>]);</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>{</span></span>
<span data-line=""><span>    totalLikeCount</span><span>:</span><span> </span><span>post</span><span>.</span><span>totalLikeCount</span><span>,</span></span>
<span data-line=""><span>    isLikedByUser</span><span>:</span><span> </span><span>post</span><span>.</span><span>isLikedByUser</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>// 🔴 Type &#39;string[]&#39; is not assignable to type &#39;{ firstName: string; avatar: string; }[]&#39;.</span></span>
<span data-line="" data-highlighted-line=""><span>    friendLikes</span><span>:</span><span> </span><span>friendLikes</span><span>.</span><span>likes</span><span>.</span><span>map</span><span>(</span><span>l </span><span>=&gt;</span><span> </span><span>l</span><span>.</span><span>firstName</span><span>)</span></span>
<span data-line=""><span>  </span><span>};</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>Let’s fix it:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>LikeButtonViewModel</span><span>(</span></span>
<span data-line=""><span>  { postId } </span><span>:</span><span> </span><span>{</span><span> postId</span><span>:</span><span> </span><span>number</span><span> </span><span>}</span></span>
<span data-line=""><span>)</span><span> </span><span>:</span><span> </span><span>LikeButtonProps</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line=""><span>    </span><span>getFriendLikes</span><span>(</span><span>postId</span><span>,</span><span> </span><span>{</span><span> limit</span><span>:</span><span> </span><span>2</span><span> </span><span>}),</span></span>
<span data-line=""><span>  </span><span>]);</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>{</span></span>
<span data-line=""><span>    totalLikeCount</span><span>:</span><span> </span><span>post</span><span>.</span><span>totalLikeCount</span><span>,</span></span>
<span data-line=""><span>    isLikedByUser</span><span>:</span><span> </span><span>post</span><span>.</span><span>isLikedByUser</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    friendLikes</span><span>:</span><span> </span><span>friendLikes</span><span>.</span><span>likes</span><span>.</span><span>map</span><span>(</span><span>l </span><span>=&gt;</span><span> </span><span>({</span></span>
<span data-line="" data-highlighted-line=""><span>      firstName</span><span>:</span><span> </span><span>l</span><span>.</span><span>firstName</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      avatar</span><span>:</span><span> </span><span>l</span><span>.</span><span>avatar</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>}))</span></span>
<span data-line=""><span>  </span><span>};</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>Now the BFF response for every screen that includes a <code>LikeButton</code> ViewModel will use the new <code>friendLikes</code> format, which is exactly what the <code>LikeButton</code> React component wants. There are no further changes to make—<em>it just works</em>. We <em>know</em> that it works because <code>LikeButtonViewModel</code> is the only place generating props for a <code>LikeButton</code>, no matter which screen we’re requesting from the BFF. (For now assume that this is true; we’re still yet to decide how exactly to tie them.)</p>
<p>I’d like to call attention to the previous fact because this is quite profound.</p>
<p>When was the last time you could clearly trace the correspondence between a deeply nested piece of server code generating a fragment of data, and a deeply nested piece of the client code consuming that data? We’re clearly onto <em>something</em>.</p>
<hr/>
<h3 id="viewmodel-parameters"><a target="_self" href="#viewmodel-parameters">ViewModel Parameters</a></h3>
<p>You might have noticed that ViewModel functions can take parameters. Importantly, these parameters can be specified by the “parent” ViewModel functions and plumbed down—so the client doesn’t need to be aware of them.</p>
<p>For example, suppose you wanted to make the Post List page only display the first paragraph of every post’s content. Let’s add a parameter to its ViewModel:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>PostDetailsViewModel</span><span>(</span><span>{</span></span>
<span data-line=""><span>  postId</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>  truncateContent</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>postLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line=""><span>    </span><span>LikeButtonViewModel</span><span>({</span><span> postId </span><span>}),</span></span>
<span data-line=""><span>  </span><span>]);</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>{</span></span>
<span data-line=""><span>    postTitle</span><span>:</span><span> </span><span>post</span><span>.</span><span>title</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    postContent</span><span>:</span><span> </span><span>parseMarkdown</span><span>(</span><span>post</span><span>.</span><span>content</span><span>,</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>      maxParagraphs</span><span>:</span><span> truncateContent </span><span>?</span><span> </span><span>1</span><span> </span><span>:</span><span> </span><span>undefined</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>}),</span></span>
<span data-line=""><span>    postAuthor</span><span>:</span><span> </span><span>post</span><span>.</span><span>author</span><span>,</span></span>
<span data-line=""><span>    postLikes</span></span>
<span data-line=""><span>  </span><span>};</span></span>
<span data-line=""><span>}</span></span>
<span data-line=""> </span>
<span data-line=""><span>app</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>/screen/post-details/:postId</span><span>&#39;</span><span>,</span><span> </span><span>async</span><span> </span><span>(</span><span>req</span><span>,</span><span> res</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const </span><span>postId</span><span> </span><span>=</span><span> req</span><span>.</span><span>params</span><span>.</span><span>postId</span><span>;</span></span>
<span data-line=""><span>  </span><span>const </span><span>viewModel</span><span> </span><span>=</span><span> await </span><span>PostDetailsViewModel</span><span>({</span></span>
<span data-line=""><span>    </span><span>postId</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>truncateContent</span><span>:</span><span> </span><span>false</span></span>
<span data-line=""><span>  </span><span>});</span></span>
<span data-line=""><span>  </span><span>res</span><span>.</span><span>json</span><span>(</span><span>viewModel</span><span>);</span></span>
<span data-line=""><span>});</span></span>
<span data-line=""> </span>
<span data-line=""><span>app</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>/screen/post-list</span><span>&#39;</span><span>,</span><span> </span><span>async</span><span> </span><span>(</span><span>req</span><span>,</span><span> res</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const </span><span>postIds</span><span> </span><span>=</span><span> await </span><span>getRecentPostIds</span><span>();</span></span>
<span data-line=""><span>  </span><span>const </span><span>viewModel</span><span> </span><span>=</span><span> </span><span>{</span></span>
<span data-line=""><span>    </span><span>posts</span><span>:</span><span> </span><span>await</span><span> </span><span>Promise</span><span>.</span><span>all</span><span>(</span><span>postIds</span><span>.</span><span>map</span><span>(</span><span>postId </span><span>=&gt;</span></span>
<span data-line=""><span>      </span><span>PostDetailsViewModel</span><span>({</span></span>
<span data-line=""><span>        postId</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>        truncateContent</span><span>:</span><span> </span><span>true</span></span>
<span data-line=""><span>      </span><span>})</span></span>
<span data-line=""><span>    </span><span>))</span></span>
<span data-line=""><span>  </span><span>};</span></span>
<span data-line=""><span>  </span><span>res</span><span>.</span><span>json</span><span>(</span><span>viewModel</span><span>);</span></span>
<span data-line=""><span>});</span></span></code></pre></div>
<p>The JSON response for the <code>post-details</code> endpoint still includes the entire posts, but the <code>post-list</code> JSON endpoint will now only serve their abridged summaries. This is a <em>view model</em> concern, and now we have a natural place to express it in code.</p>
<hr/>
<h3 id="plumbing-viewmodel-parameters"><a target="_self" href="#plumbing-viewmodel-parameters">Plumbing ViewModel Parameters</a></h3>
<p>Next, suppose you wanted to include avatars only on the Details screen. Let’s edit <code>LikeButtonViewModel</code> to take and respect an <code>includeAvatars</code> parameter:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>LikeButtonViewModel</span><span>(</span><span>{</span></span>
<span data-line=""><span>  postId</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>  includeAvatars</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line=""><span>    </span><span>getFriendLikes</span><span>(</span><span>postId</span><span>,</span><span> </span><span>{</span><span> limit</span><span>:</span><span> </span><span>2</span><span> </span><span>}),</span></span>
<span data-line=""><span>  </span><span>]);</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>{</span></span>
<span data-line=""><span>    totalLikeCount</span><span>:</span><span> </span><span>post</span><span>.</span><span>totalLikeCount</span><span>,</span></span>
<span data-line=""><span>    isLikedByUser</span><span>:</span><span> </span><span>post</span><span>.</span><span>isLikedByUser</span><span>,</span></span>
<span data-line=""><span>    friendLikes</span><span>:</span><span> </span><span>friendLikes</span><span>.</span><span>likes</span><span>.</span><span>map</span><span>(</span><span>l </span><span>=&gt;</span><span> </span><span>({</span></span>
<span data-line=""><span>      firstName</span><span>:</span><span> </span><span>l</span><span>.</span><span>firstName</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      avatar</span><span>:</span><span> includeAvatars </span><span>?</span><span> </span><span>l</span><span>.</span><span>avatar </span><span>:</span><span> </span><span>null</span><span>,</span></span>
<span data-line=""><span>    </span><span>}))</span></span>
<span data-line=""><span>  </span><span>};</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>Now you can plumb it down all the way from the BFF endpoints:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>PostDetailsViewModel</span><span>(</span><span>{</span></span>
<span data-line=""><span>  postId</span><span>,</span></span>
<span data-line=""><span>  truncateContent</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>  includeAvatars</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>postLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>LikeButtonViewModel</span><span>({</span><span> postId</span><span>,</span><span> includeAvatars </span><span>}),</span></span>
<span data-line=""><span>  </span><span>]);</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>{</span></span>
<span data-line=""><span>    postTitle</span><span>:</span><span> </span><span>post</span><span>.</span><span>title</span><span>,</span></span>
<span data-line=""><span>    postContent</span><span>:</span><span> </span><span>parseMarkdown</span><span>(</span><span>post</span><span>.</span><span>content</span><span>,</span><span> </span><span>{</span></span>
<span data-line=""><span>      maxParagraphs</span><span>:</span><span> truncateContent </span><span>?</span><span> </span><span>1</span><span> </span><span>:</span><span> </span><span>undefined</span></span>
<span data-line=""><span>    </span><span>}),</span></span>
<span data-line=""><span>    postAuthor</span><span>:</span><span> </span><span>post</span><span>.</span><span>author</span><span>,</span></span>
<span data-line=""><span>    postLikes</span></span>
<span data-line=""><span>  </span><span>};</span></span>
<span data-line=""><span>}</span></span>
<span data-line=""> </span>
<span data-line=""><span>app</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>/screen/post-details/:postId</span><span>&#39;</span><span>,</span><span> </span><span>async</span><span> </span><span>(</span><span>req</span><span>,</span><span> res</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const </span><span>postId</span><span> </span><span>=</span><span> req</span><span>.</span><span>params</span><span>.</span><span>postId</span><span>;</span></span>
<span data-line=""><span>  </span><span>const </span><span>viewModel</span><span> </span><span>=</span><span> await </span><span>PostDetailsViewModel</span><span>({</span></span>
<span data-line=""><span>    </span><span>postId</span><span>,</span></span>
<span data-line=""><span>    </span><span>truncateContent</span><span>:</span><span> </span><span>false</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>includeAvatars</span><span>:</span><span> </span><span>true</span></span>
<span data-line=""><span>  </span><span>});</span></span>
<span data-line=""><span>  </span><span>res</span><span>.</span><span>json</span><span>(</span><span>viewModel</span><span>);</span></span>
<span data-line=""><span>});</span></span>
<span data-line=""> </span>
<span data-line=""><span>app</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>/screen/post-list</span><span>&#39;</span><span>,</span><span> </span><span>async</span><span> </span><span>(</span><span>req</span><span>,</span><span> res</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const </span><span>postIds</span><span> </span><span>=</span><span> await </span><span>getRecentPostIds</span><span>();</span></span>
<span data-line=""><span>  </span><span>const </span><span>viewModel</span><span> </span><span>=</span><span> </span><span>{</span></span>
<span data-line=""><span>    </span><span>posts</span><span>:</span><span> </span><span>await</span><span> </span><span>Promise</span><span>.</span><span>all</span><span>(</span><span>postIds</span><span>.</span><span>map</span><span>(</span><span>postId </span><span>=&gt;</span></span>
<span data-line=""><span>      </span><span>PostDetailsViewModel</span><span>({</span></span>
<span data-line=""><span>        postId</span><span>,</span></span>
<span data-line=""><span>        truncateContent</span><span>:</span><span> </span><span>true</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>        includeAvatars</span><span>:</span><span> </span><span>false</span></span>
<span data-line=""><span>      </span><span>})</span></span>
<span data-line=""><span>    </span><span>))</span></span>
<span data-line=""><span>  </span><span>};</span></span>
<span data-line=""><span>  </span><span>res</span><span>.</span><span>json</span><span>(</span><span>viewModel</span><span>);</span></span>
<span data-line=""><span>});</span></span></code></pre></div>
<p>Again, the client doesn’t pass ad-hoc parameters like <code>?includeAvatars=true</code> to the server to ensure that the avatars are included in the JSON response. Instead, the <code>post-list</code> BFF endpoint itself <em>knows</em> a Post List shouldn’t include avatars, so it can pass <code>includeAvatars: false</code> to <code>PostDetailsViewModel</code>, which plumbs it down to <code>LikeButtonViewModel</code>. The client code doesn’t need to be aware of the server logic at all—all it cares about is that it gets the props that it wants.</p>
<p>For the case when we <em>do</em> show avatars of friends, we might want to show five rather than two. We can make that change directly in <code>LikeButtonViewModel</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>LikeButtonViewModel</span><span>(</span><span>{</span></span>
<span data-line=""><span>  postId</span><span>,</span></span>
<span data-line=""><span>  includeAvatars</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>getFriendLikes</span><span>(</span><span>postId</span><span>,</span><span> </span><span>{</span><span> limit</span><span>:</span><span> includeAvatars </span><span>?</span><span> </span><span>5</span><span> </span><span>:</span><span> </span><span>2</span><span> </span><span>}),</span></span>
<span data-line=""><span>  </span><span>]);</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>{</span></span>
<span data-line=""><span>    totalLikeCount</span><span>:</span><span> </span><span>post</span><span>.</span><span>totalLikeCount</span><span>,</span></span>
<span data-line=""><span>    isLikedByUser</span><span>:</span><span> </span><span>post</span><span>.</span><span>isLikedByUser</span><span>,</span></span>
<span data-line=""><span>    friendLikes</span><span>:</span><span> </span><span>friendLikes</span><span>.</span><span>likes</span><span>.</span><span>map</span><span>(</span><span>l </span><span>=&gt;</span><span> </span><span>({</span></span>
<span data-line=""><span>      firstName</span><span>:</span><span> </span><span>l</span><span>.</span><span>firstName</span><span>,</span></span>
<span data-line=""><span>      avatar</span><span>:</span><span> includeAvatars </span><span>?</span><span> </span><span>l</span><span>.</span><span>avatar </span><span>:</span><span> </span><span>null</span><span>,</span></span>
<span data-line=""><span>    </span><span>}))</span></span>
<span data-line=""><span>  </span><span>};</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>Since the <code>LikeButtonViewModel</code> function exists solely to generate the <code>LikeButton</code> props, adding more presentational logic here feels natural. It’s a <em>view</em> model, right? If another view <em>wanted</em> to show a different number of avatars, it could do that. Unlike with REST, there is no canonical notion of a “post”—so any UI can specify <em>exactly</em> the data it needs, from a screen all the way down to a button.</p>
<p>Our ViewModels evolve in the exact lockstep with the needs of the client.</p>
<hr/>
<h3 id="composing-viewmodels"><a target="_self" href="#composing-viewmodels">Composing ViewModels</a></h3>
<p>Something interesting is taking shape. We’ve started to split our BFF endpoints into units of reusable logic, and we’ve found that these units let us encapsulate <em>data loading</em> in a similar way as we’ve been encapsulating the <em>user interface</em>. If you squint at ViewModels, you might even see some parallels to components.</p>
<p>And yet the end result of the ViewModel tree is not a UI tree—it’s just JSON.</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>// GET /screen/post-list</span></span>
<span data-line=""><span>{</span></span>
<span data-line=""><span>  </span><span>/* Begin screen/post-list ViewModel */</span></span>
<span data-line=""><span>  posts: </span><span>[{</span></span>
<span data-line=""><span>    </span><span>/* Begin PostDetailsViewModel */</span></span>
<span data-line=""><span>    postTitle</span><span>:</span><span> </span><span>&#34;</span><span>JSX Over The Wire</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>    postAuthor</span><span>:</span><span> </span><span>&#34;</span><span>Dan</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>    postContent</span><span>:</span><span> </span><span>&#34;</span><span>Suppose you have an API route that returns some data as JSON.</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>    postLikes</span><span>:</span><span> </span><span>{</span></span>
<span data-line=""><span>      </span><span>/* Begin LikeButtonViewModel */</span></span>
<span data-line=""><span>      totalLikeCount</span><span>:</span><span> </span><span>8</span><span>,</span></span>
<span data-line=""><span>      isLikedByUser</span><span>:</span><span> </span><span>false</span><span>,</span></span>
<span data-line=""><span>      friendLikes</span><span>:</span><span> </span><span>[{</span></span>
<span data-line=""><span>        firstName</span><span>:</span><span> </span><span>&#34;</span><span>Alice</span><span>&#34;</span></span>
<span data-line=""><span>      </span><span>},</span><span> </span><span>{</span></span>
<span data-line=""><span>        firstName</span><span>:</span><span> </span><span>&#34;</span><span>Bob</span><span>&#34;</span></span>
<span data-line=""><span>      </span><span>}]</span></span>
<span data-line=""><span>      </span><span>/* End LikeButtonViewModel */</span></span>
<span data-line=""><span>    </span><span>}</span></span>
<span data-line=""><span>    </span><span>/* End PostDetailsViewModel */</span></span>
<span data-line=""><span>  </span><span>},</span><span> </span><span>{</span></span>
<span data-line=""><span>    </span><span>/* Begin PostDetailsViewModel */</span></span>
<span data-line=""><span>    postTitle</span><span>:</span><span> </span><span>&#34;</span><span>React for Two Computers</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>    postAuthor</span><span>:</span><span> </span><span>&#34;</span><span>Dan</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>    postContent</span><span>:</span><span> </span><span>&#34;</span><span>I’ve been trying to write this post at least a dozen times.</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>    postLikes</span><span>:</span><span> </span><span>{</span></span>
<span data-line=""><span>      </span><span>/* Begin LikeButtonViewModel */</span></span>
<span data-line=""><span>      totalLikeCount</span><span>:</span><span> </span><span>13</span><span>,</span></span>
<span data-line=""><span>      isLikedByUser</span><span>:</span><span> </span><span>true</span><span>,</span></span>
<span data-line=""><span>      friendLikes</span><span>:</span><span> </span><span>[{</span></span>
<span data-line=""><span>        firstName</span><span>:</span><span> </span><span>&#34;</span><span>Bob</span><span>&#34;</span></span>
<span data-line=""><span>      </span><span>}]</span></span>
<span data-line=""><span>      </span><span>/* End LikeButtonViewModel */</span></span>
<span data-line=""><span>    </span><span>}</span></span>
<span data-line=""><span>    </span><span>/* End PostDetailsViewModel */</span></span>
<span data-line=""><span>  </span><span>}]</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>But what should we <em>do</em> with that JSON?</p>
<p>In the end, <em>somehow</em> we want the props generated by <code>LikeButtonViewModel</code> to end up in the <code>LikeButton</code> component. Likewise, <em>somehow</em> we want the props generated by <code>PostDetailsViewModel</code> to get to the <code>PostDetails</code> component. We don’t want to generate a huge ViewModel tree of JSON just to manually plumb every piece of it down exactly to the component that needs that ViewModel’s data.</p>
<p>We’re building two parallel hierarchies in the two worlds.</p>
<p>But these worlds are not connected yet.</p>
<p>Something is missing.</p>
<hr/>
<h3 id="recap-json-as-components"><a target="_self" href="#recap-json-as-components">Recap: JSON as Components</a></h3>
<ul>
<li>For any UI, the data begins its life as Models and ends its life as ViewModels. The transformation between Models and ViewModels has to happen somewhere.</li>
<li>The shape of ViewModels is fully dictated by the design of our user interface. This means that they will evolve over time together with our designs. Also, different screens need different ViewModels aggregated from the same underlying Models.</li>
<li>Modeling data from the server as REST Resources creates a tension. If REST Resources are close to raw Models, it may require multiple roundtrips and complex ad-hoc conventions to obtain the necessary ViewModels for a screen. If REST Resources are close to ViewModels, they get too coupled to the initial screens they were designed to represent, and don’t evolve together with the needs of the client.</li>
<li>We can resolve this tension by creating another layer—a <em>Backend For Frontend</em> (BFF). The job of the BFF is to translate the needs of the client (“give me data for this screen”) to REST calls on the backend. A BFF can also evolve beyond being a facade for REST, and instead load data directly using an in-process data layer.</li>
<li>Since the BFF’s job is to return all the data needed for each screen as a piece of JSON, it is natural to split up the data loading logic into reusable units. A screen’s ViewModel can be decomposed into a tree of ViewModels, corresponding to the pieces of server data that different components will want to receive on the client. These individual ViewModels can then be recombined and composed together.</li>
<li>These ViewModel functions can pass information to each other. This lets us customize the JSON we’re sending depending on the screen. Unlike with REST, we’re no longer trying to design canonical shapes like a “a post object” used throughout all responses. At any point, we can diverge and serve different ViewModels for the same information to different screens—whatever <em>they</em> want. These ViewModels are <em>view</em> models. They can—should?—have presentation logic.</li>
<li>We’re beginning to realize that ViewModels form a very similar structure to React components. <em>ViewModels are like components, but for generating JSON</em>. However, we still haven’t figured out how to actually <em>pass</em> the JSON they’re generating on the server to the components that need it on the client. It’s also annoying to deal with two parallel hierarchies. We’re onto something, but we’re missing something.</li>
</ul>
<p>What are we missing?</p>
<hr/>
<h2 id="part-2-components-as-json"><a target="_self" href="#part-2-components-as-json">Part 2: Components as JSON</a></h2>
<h3 id="html-ssi-and-cgi"><a target="_self" href="#html-ssi-and-cgi">HTML, SSI, and CGI</a></h3>
<p>JSON, MVVM, BFF, what the hell was that?!</p>
<p>What an incredibly overengineered way to make a website. These React complexity peddlers are <em>so</em> out of touch. If only they knew the <em>history</em>.</p>
<p>Back in <em>my</em> days, we’d just write a bit of HTML and call it a day.</p>
<p>My <code>index.html</code> homepage would look like this:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>&lt;</span><span>html</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>&lt;</span><span>body</span><span>&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>h1</span><span>&gt;</span><span>Welcome to my blog!</span><span>&lt;/</span><span>h1</span><span>&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>h2</span><span>&gt;</span><span>Latest posts</span><span>&lt;/</span><span>h2</span><span>&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>h3</span><span>&gt;</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>a</span><span> href=</span><span>&#34;</span><span>/jsx-over-the-wire.html</span><span>&#34;</span><span>&gt;</span></span>
<span data-line=""><span>        JSX Over The Wire</span></span>
<span data-line=""><span>      </span><span>&lt;/</span><span>a</span><span>&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;/</span><span>h3</span><span>&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>p</span><span>&gt;</span></span>
<span data-line=""><span>      Suppose you have an API route that returns some data as JSON. [...]</span></span>
<span data-line=""><span>    </span><span>&lt;/</span><span>p</span><span>&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>h3</span><span>&gt;</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>a</span><span> href=</span><span>&#34;</span><span>/jsx-over-the-wire.html</span><span>&#34;</span><span>&gt;</span></span>
<span data-line=""><span>        React for Two Computers</span></span>
<span data-line=""><span>      </span><span>&lt;/</span><span>a</span><span>&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;/</span><span>h3</span><span>&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>p</span><span>&gt;</span></span>
<span data-line=""><span>      I’ve been trying to write this post at least a dozen times. [...]</span></span>
<span data-line=""><span>    </span><span>&lt;/</span><span>p</span><span>&gt;</span></span>
<span data-line=""><span>    ...</span></span>
<span data-line=""><span>  </span><span>&lt;/</span><span>body</span><span>&gt;</span></span>
<span data-line=""><span>&lt;/</span><span>html</span><span>&gt;</span></span></code></pre></div>
<p>Then my <code>jsx-over-the-wire.html</code> post details page would look like this:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>&lt;</span><span>html</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>&lt;</span><span>body</span><span>&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>h1</span><span>&gt;</span><span>JSX Over The Wire</span><span>&lt;/</span><span>h1</span><span>&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>p</span><span>&gt;</span></span>
<span data-line=""><span>      Suppose you have an API route that returns some data as JSON.</span></span>
<span data-line=""><span>    </span><span>&lt;/</span><span>p</span><span>&gt;</span></span>
<span data-line=""><span>    ...</span></span>
<span data-line=""><span>  </span><span>&lt;/</span><span>body</span><span>&gt;</span></span>
<span data-line=""><span>&lt;/</span><span>html</span><span>&gt;</span></span></code></pre></div>
<p>I’d put these files on a box with Apache and that would be it!</p>
<p>Now suppose I wanted to add a footer to all my pages. That couldn’t be easier. First, let me create a file called <code>includes/footer.html</code> with my footer:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>&lt;</span><span>marquee</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>&lt;</span><span>a</span><span> href=</span><span>&#34;</span><span>/</span><span>&#34;</span><span>&gt;</span><span>overreacted</span><span>&lt;/</span><span>a</span><span>&gt;</span></span>
<span data-line=""><span>&lt;/</span><span>marquee</span><span>&gt;</span></span></code></pre></div>
<p>Now I can include my footer on any page with <a target="_blank" href="https://en.wikipedia.org/wiki/Server_Side_Includes">Server-Side Includes  (SSI)</a>:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>&lt;</span><span>html</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>&lt;</span><span>body</span><span>&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>h1</span><span>&gt;</span><span>Welcome to my blog!</span><span>&lt;/</span><span>h1</span><span>&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>h2</span><span>&gt;</span><span>Latest posts</span><span>&lt;/</span><span>h2</span><span>&gt;</span></span>
<span data-line=""><span>    ...</span></span>
<span data-line="" data-highlighted-line=""><span>    &lt;!--#include virtual=&#34;/includes/footer.html&#34; --&gt;</span></span>
<span data-line=""><span>  </span><span>&lt;/</span><span>body</span><span>&gt;</span></span>
<span data-line=""><span>&lt;/</span><span>html</span><span>&gt;</span></span></code></pre></div>
<p>In fact, I don’t want to copy and paste the first paragraph of each blog post into my <code>index.html</code> file so I might use SSI together with <a target="_blank" href="https://en.wikipedia.org/wiki/Common_Gateway_Interface">CGI</a> to <em>generate</em> my index page:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>&lt;</span><span>html</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>&lt;</span><span>body</span><span>&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>h1</span><span>&gt;</span><span>Welcome to my blog!</span><span>&lt;/</span><span>h1</span><span>&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>h2</span><span>&gt;</span><span>Latest posts</span><span>&lt;/</span><span>h2</span><span>&gt;</span></span>
<span data-line="" data-highlighted-line=""><span>    &lt;!--#include virtual=&#34;/cgi-bin/post-details.cgi?jsx-over-the-wire&amp;truncateContent=true&#34; --&gt;</span></span>
<span data-line="" data-highlighted-line=""><span>    &lt;!--#include virtual=&#34;/cgi-bin/post-details.cgi?react-for-two-computers&amp;truncateContent=true&#34; --&gt;</span></span>
<span data-line=""><span>    &lt;!--#include virtual=&#34;/includes/footer.html&#34; --&gt;</span></span>
<span data-line=""><span>  </span><span>&lt;/</span><span>body</span><span>&gt;</span></span>
<span data-line=""><span>&lt;/</span><span>html</span><span>&gt;</span></span></code></pre></div>
<p>Likewise, the details page will delegate to the same <code>post-details.cgi</code> script:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>&lt;</span><span>html</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>&lt;</span><span>body</span><span>&gt;</span></span>
<span data-line="" data-highlighted-line=""><span>    &lt;!--#include virtual=&#34;/cgi-bin/post-details.cgi?jsx-over-the-wire&amp;truncateContent=false&#34; --&gt;</span></span>
<span data-line=""><span>    &lt;!--#include virtual=&#34;/includes/footer.html&#34; --&gt;</span></span>
<span data-line=""><span>  </span><span>&lt;/</span><span>body</span><span>&gt;</span></span>
<span data-line=""><span>&lt;/</span><span>html</span><span>&gt;</span></span></code></pre></div>
<p>Finally, the <code>post-details.cgi</code> script might talk to the database:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="bash" data-theme="default"><code data-language="bash" data-theme="default"><span data-line=""><span>#!/bin/sh</span></span>
<span data-line=""><span>echo</span><span> </span><span>&#34;</span><span>Content-type: text/html</span><span>&#34;</span></span>
<span data-line=""><span>echo</span><span> </span><span>&#34;&#34;</span></span>
<span data-line=""> </span>
<span data-line=""><span>POST_ID</span><span>=</span><span>&#34;$(</span><span>echo</span><span> &#34;</span><span>$QUERY_STRING</span><span>&#34; | </span><span>cut</span><span> </span><span>-d</span><span>&#39;</span><span>&amp;</span><span>&#39; </span><span>-f1</span><span> | </span><span>tr</span><span> </span><span>-cd</span><span> &#39;</span><span>[:alnum:]._-</span><span>&#39;)&#34;</span></span>
<span data-line=""><span>TRUNCATE</span><span>=</span><span>&#34;$(</span><span>echo</span><span> &#34;</span><span>$QUERY_STRING</span><span>&#34; | </span><span>grep</span><span> </span><span>-c</span><span> &#34;</span><span>truncateContent=true</span><span>&#34;)&#34;</span></span>
<span data-line=""> </span>
<span data-line=""><span>TITLE</span><span>=</span><span>$(</span><span>mysql</span><span> </span><span>-u</span><span> admin </span><span>-p</span><span>&#39;</span><span>password</span><span>&#39; </span><span>-D</span><span> blog </span><span>--skip-column-names</span><span> </span><span>-e</span><span> </span><span>\</span></span>
<span data-line=""><span>  &#34;</span><span>SELECT title FROM posts WHERE url=&#39;</span><span>$POST_ID</span><span>&#39;</span><span>&#34;)</span></span>
<span data-line=""><span>CONTENT</span><span>=</span><span>$(</span><span>mysql</span><span> </span><span>-u</span><span> admin </span><span>-p</span><span>&#39;</span><span>password</span><span>&#39; </span><span>-D</span><span> blog </span><span>--skip-column-names</span><span> </span><span>-e</span><span> </span><span>\</span></span>
<span data-line=""><span>  &#34;</span><span>SELECT content FROM posts WHERE url=&#39;</span><span>$POST_ID</span><span>&#39;</span><span>&#34;)</span></span>
<span data-line=""> </span>
<span data-line=""><span>if</span><span> [ </span><span>&#34;</span><span>$TRUNCATE</span><span>&#34;</span><span> </span><span>=</span><span> </span><span>&#34;</span><span>1</span><span>&#34;</span><span> ]</span><span>;</span><span> </span><span>then</span></span>
<span data-line=""><span>  FIRST_PARAGRAPH</span><span>=</span><span>&#34;$(</span><span>printf</span><span> &#34;</span><span>%s</span><span>&#34; &#34;</span><span>$CONTENT</span><span>&#34; | </span><span>sed</span><span> &#39;</span><span>/^$/q</span><span>&#39;)&#34;</span></span>
<span data-line=""><span>  </span><span>echo</span><span> </span><span>&#34;</span><span>&lt;h3&gt;&lt;a href=</span><span>\&#34;</span><span>/</span><span>$POST_ID</span><span>.html</span><span>\&#34;</span><span>&gt;</span><span>$TITLE</span><span>&lt;/a&gt;&lt;/h3&gt;</span><span>&#34;</span></span>
<span data-line=""><span>  </span><span>echo</span><span> </span><span>&#34;</span><span>&lt;p&gt;</span><span>$FIRST_PARAGRAPH</span><span> [...]&lt;/p&gt;</span><span>&#34;</span></span>
<span data-line=""><span>else</span></span>
<span data-line=""><span>  </span><span>echo</span><span> </span><span>&#34;</span><span>&lt;h1&gt;</span><span>$TITLE</span><span>&lt;/h1&gt;</span><span>&#34;</span></span>
<span data-line=""><span>  </span><span>echo</span><span> </span><span>&#34;</span><span>&lt;p&gt;</span><span>&#34;</span></span>
<span data-line=""><span>  </span><span>echo</span><span> </span><span>&#34;</span><span>$CONTENT</span><span>&#34;</span></span>
<span data-line=""><span>  </span><span>echo</span><span> </span><span>&#34;</span><span>&lt;/p&gt;</span><span>&#34;</span></span>
<span data-line=""><span>fi</span></span></code></pre></div>
<p>We’re in the <em>nineties</em>, okay?</p>
<p>So far everything is very simple, even if a bit tedious to write. What we have here is a server that returns <em>all the data necessary for any given screen in one roundtrip</em>.</p>
<p><em>(Hmm…)</em></p>
<p>Of course, different screens may need the same data, and we don’t want to duplicate the logic. Luckily, we can <em>reuse dynamic includes</em> such as <code>post-details.cgi</code>. We can <em>even pass parameters</em> to them like <code>truncateContent</code>.</p>
<p>The most annoying thing about this code is that working in Bash is really not for the faint-hearted (i.e. not for me). Let’s see if we can improve on that part.</p>
<hr/>
<h3 id="php-and-xhp"><a target="_self" href="#php-and-xhp">PHP and XHP</a></h3>
<p>We could translate this entire example to old school PHP, which gives us better control flow, function calls, variables, and so on. However, I want to skip ahead.</p>
<p>No, not to the modern PHP MVC frameworks.</p>
<p>I want to skip ahead to <a target="_blank" href="https://codebeforethehorse.tumblr.com/post/3096387855/an-introduction-to-xhp">XHP</a>.</p>
<p>You see, the problem with the early PHP programs was that they relied on string manipulation of HTML. In that sense the PHP version doesn’t improve by much:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="php" data-theme="default"><code data-language="php" data-theme="default"><span data-line=""><span>if</span><span> (</span><span>$truncate</span><span>) {</span></span>
<span data-line=""><span>  </span><span>$splitContent</span><span> </span><span>=</span><span> </span><span>explode</span><span>(</span><span>&#34;</span><span>\n\n</span><span>&#34;</span><span>,</span><span> </span><span>$</span><span>content</span><span>);</span></span>
<span data-line=""><span>  </span><span>$firstParagraph</span><span> </span><span>=</span><span> </span><span>$splitContent</span><span>[</span><span>0</span><span>];</span></span>
<span data-line=""><span>  </span><span>echo</span><span> </span><span>&#34;</span><span>&lt;h3&gt;&lt;a href=</span><span>\&#34;</span><span>/</span><span>$postId</span><span>.php</span><span>\&#34;</span><span>&gt;</span><span>$title</span><span>&lt;/a&gt;&lt;/h3&gt;</span><span>&#34;</span><span>;</span></span>
<span data-line=""><span>  </span><span>echo</span><span> </span><span>&#34;</span><span>&lt;p&gt;</span><span>$firstParagraph</span><span> [...]&lt;/p&gt;</span><span>&#34;</span><span>;</span></span>
<span data-line=""><span>} </span><span>else</span><span> {</span></span>
<span data-line=""><span>  </span><span>echo</span><span> </span><span>&#34;</span><span>&lt;h1&gt;</span><span>$title</span><span>&lt;/h1&gt;</span><span>&#34;</span><span>;</span></span>
<span data-line=""><span>  </span><span>echo</span><span> </span><span>&#34;</span><span>&lt;p&gt;</span><span>$content</span><span>&lt;/p&gt;</span><span>&#34;</span><span>;</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>Manipulating HTML as strings leads to code that’s tangled, insecure, and difficult to maintain. Most people in the web development community took that as a signal to embrace <a target="_blank" href="https://guides.rubyonrails.org/layouts_and_rendering.html">Rails-style MVC</a> where all the HTML was safely moved out of the code into separate files called <em>templates</em> (and all the data fetching moved to <em>controllers</em>).</p>
<p>However, that’s not what happened at Facebook.</p>
<p>At Facebook, they had a different idea.</p>
<p>The problem with PHP, said Facebook engineers, was not the manipulation of markup <em>per se</em>. What was bad is <em>unprincipled</em> manipulation of markup, i.e. treating markup as a plain string. Markup has a certain <em>shape</em> to it—stuff contained in other stuff. What we need is a way to build and manipulate that markup without accidentally destroying its contents or interpolating unsafe content into it:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="php" data-theme="default"><code data-language="php" data-theme="default"><span data-line=""><span>if</span><span> (</span><span>$truncate</span><span>) {</span></span>
<span data-line=""><span>  </span><span>$splitContent</span><span> </span><span>=</span><span> </span><span>explode</span><span>(</span><span>&#34;</span><span>\n\n</span><span>&#34;</span><span>,</span><span> </span><span>$</span><span>content</span><span>);</span></span>
<span data-line=""><span>  </span><span>$firstParagraph</span><span> </span><span>=</span><span> </span><span>$splitContent</span><span>[</span><span>0</span><span>];</span></span>
<span data-line=""><span>  </span><span>echo</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>x</span><span>:</span><span>frag</span><span>&gt;</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>h3</span><span>&gt;&lt;</span><span>a</span><span> </span><span>href</span><span>=</span><span>{</span><span>&#34;</span><span>/{</span><span>$postId</span><span>}.php</span><span>&#34;</span><span>}</span><span>&gt;</span><span>{</span><span>$title</span><span>}</span><span>&lt;/</span><span>a</span><span>&gt;&lt;/</span><span>h3</span><span>&gt;</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>p</span><span>&gt;</span><span>{</span><span>$firstParagraph</span><span>} </span><span>[...]&lt;/</span><span>p</span><span>&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;/</span><span>x</span><span>:</span><span>frag</span><span>&gt;;</span></span>
<span data-line=""><span>} </span><span>else</span><span> {</span></span>
<span data-line=""><span>  </span><span>echo</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>x</span><span>:</span><span>frag</span><span>&gt;</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>h1</span><span>&gt;</span><span>{</span><span>$title</span><span>}</span><span>&lt;/</span><span>h1</span><span>&gt;</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>p</span><span>&gt;</span><span>{</span><span>$content</span><span>}</span><span>&lt;/</span><span>p</span><span>&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;/</span><span>x</span><span>:</span><span>frag</span><span>&gt;;</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>These tags are not strings of HTML! They’re <em>objects</em> than can be <em>turned</em> into HTML.</p>
<p>Now that we’ve moved markup <em>into</em> our code in a maintainable way, we can create our own abstractions. For example, we can define our own <code>&lt;ui:post-details&gt;</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="php" data-theme="default"><code data-language="php" data-theme="default"><span data-line="" data-highlighted-line=""><span>class</span><span> </span><span>:</span><span>ui</span><span>:</span><span>post</span><span>-</span><span>details</span><span> </span><span>extends</span><span> </span><span>:</span><span>x</span><span>:</span><span>element</span><span> {</span></span>
<span data-line=""><span>  </span><span>protected</span><span> </span><span>function</span><span> </span><span>render</span><span>():</span><span> </span><span>XHPRoot</span><span> {</span></span>
<span data-line=""><span>    </span><span>if</span><span> (</span><span>$this</span><span>-&gt;:</span><span>truncateContent</span><span>) {</span></span>
<span data-line=""><span>      </span><span>$splitContent</span><span> </span><span>=</span><span> </span><span>explode</span><span>(</span><span>&#34;</span><span>\n\n</span><span>&#34;</span><span>,</span><span> </span><span>$</span><span>this</span><span>-&gt;:</span><span>content</span><span>);</span></span>
<span data-line=""><span>      </span><span>$firstParagraph</span><span> </span><span>=</span><span> </span><span>$splitContent</span><span>[</span><span>0</span><span>];</span></span>
<span data-line=""><span>      </span><span>return</span></span>
<span data-line=""><span>        </span><span>&lt;</span><span>x</span><span>:</span><span>frag</span><span>&gt;</span></span>
<span data-line=""><span>          </span><span>&lt;</span><span>h3</span><span>&gt;&lt;</span><span>a</span><span> </span><span>href</span><span>=</span><span>{</span><span>&#34;</span><span>/{</span><span>$postId</span><span>}.php</span><span>&#34;</span><span>}</span><span>&gt;</span><span>{</span><span>$this</span><span>-&gt;:</span><span>title</span><span>}</span><span>&lt;/</span><span>a</span><span>&gt;&lt;/</span><span>h3</span><span>&gt;</span></span>
<span data-line=""><span>          </span><span>&lt;</span><span>p</span><span>&gt;</span><span>{</span><span>$firstParagraph</span><span>} </span><span>[...]&lt;/</span><span>p</span><span>&gt;</span></span>
<span data-line=""><span>        </span><span>&lt;/</span><span>x</span><span>:</span><span>frag</span><span>&gt;;</span></span>
<span data-line=""><span>    } </span><span>else</span><span> {</span></span>
<span data-line=""><span>      </span><span>return</span></span>
<span data-line=""><span>        </span><span>&lt;</span><span>x</span><span>:</span><span>frag</span><span>&gt;</span></span>
<span data-line=""><span>          </span><span>&lt;</span><span>h1</span><span>&gt;</span><span>{</span><span>$this</span><span>-&gt;:</span><span>title</span><span>}</span><span>&lt;/</span><span>h1</span><span>&gt;</span></span>
<span data-line=""><span>          </span><span>&lt;</span><span>p</span><span>&gt;</span><span>{</span><span>$this</span><span>-&gt;:</span><span>content</span><span>}</span><span>&lt;/</span><span>p</span><span>&gt;</span></span>
<span data-line=""><span>        </span><span>&lt;/</span><span>x</span><span>:</span><span>frag</span><span>&gt;;</span></span>
<span data-line=""><span>    }</span></span>
<span data-line=""><span>  }</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>And then we can render it to the page:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="php" data-theme="default"><code data-language="php" data-theme="default"><span data-line=""><span>echo</span></span>
<span data-line=""><span>  </span><span>&lt;</span><span>ui</span><span>:</span><span>post</span><span>-</span><span>details</span></span>
<span data-line=""><span>    </span><span>postId</span><span>=</span><span>&#34;</span><span>jsx-over-the-wire</span><span>&#34;</span></span>
<span data-line=""><span>    </span><span>truncateContent</span><span>=</span><span>{true}</span></span>
<span data-line=""><span>    </span><span>title</span><span>=</span><span>&#34;</span><span>JSX Over The Wire</span><span>&#34;</span></span>
<span data-line=""><span>    </span><span>content</span><span>=</span><span>&#34;</span><span>Suppose you have an API route that returns some data...</span><span>&#34;</span></span>
<span data-line=""><span>  </span><span>/&gt;;</span></span></code></pre></div>
<p>In fact, we can build an entire web application this way. Tags render other tags, which render other tags, and so on. By eschewing the Rails-style MVC model, we’ve accidentally discovered a much older principle: function composition.</p>
<p>One downside of XHP is that it isn’t very well-suited to client interactivity. Since XHP executes on a server that emits HTML, the most that you can do relatively seamlessly is to replace <em>parts</em> of an existing markup with the newly generated HTML markup from the server by updating <code>innerHTML</code> of some DOM node.</p>
<p>Replacing <code>innerHTML</code> wasn’t working out particularly well—especially for the highly interative Ads product—which made an engineer (who was not me, by the way) wonder whether it’s possible to run an XHP-style “tags render other tags” paradigm directly on the client computer without losing state between the re-renders. As you might gave guessed, this led to the <a target="_blank" href="https://legacy.reactjs.org/blog/2016/09/28/our-first-50000-stars.html#archeology">invention of JSX and React.</a></p>
<p>Who cares about React though?</p>
<p>We’re here to shill XHP.</p>
<hr/>
<h3 id="async-xhp"><a target="_self" href="#async-xhp">Async XHP</a></h3>
<p>Earlier, <code>&lt;ui:post-details&gt;</code> got <code>title</code> and <code>content</code> from the calling code:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="php" data-theme="default"><code data-language="php" data-theme="default"><span data-line=""><span>echo</span></span>
<span data-line=""><span>  </span><span>&lt;</span><span>ui</span><span>:</span><span>post</span><span>-</span><span>details</span></span>
<span data-line=""><span>    </span><span>postId</span><span>=</span><span>&#34;</span><span>jsx-over-the-wire</span><span>&#34;</span></span>
<span data-line=""><span>    </span><span>truncateContent</span><span>=</span><span>{true}</span></span>
<span data-line=""><span>    </span><span>title</span><span>=</span><span>&#34;</span><span>JSX Over The Wire</span><span>&#34;</span></span>
<span data-line=""><span>    </span><span>content</span><span>=</span><span>&#34;</span><span>Suppose you have an API route that returns some data...</span><span>&#34;</span></span>
<span data-line=""><span>  </span><span>/&gt;;</span></span></code></pre></div>
<p>It was not reading <code>title</code> or <code>content</code> on its own—after all, reading them from a database is (ideally) an <em>asynchronous</em> operation, while XHP tags are synchronous.</p>
<p><em>Were.</em></p>
<p>At some point, engineers at Facebook realized that XHP tags would be a lot more powerful if they could load their own data. <a target="_blank" href="https://hhvm.github.io/xhp-lib/2015/06/01/new-features-in-depth.html#asynchronous-xhp-rendering">Async XHP tags</a> were born:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="php" data-theme="default"><code data-language="php" data-theme="default"><span data-line=""><span>class</span><span> </span><span>:</span><span>ui</span><span>:</span><span>post</span><span>-</span><span>details</span><span> </span><span>extends</span><span> </span><span>:</span><span>x</span><span>:</span><span>element</span><span> {</span></span>
<span data-line=""><span>  </span><span>use</span><span> </span><span>XHPAsync</span><span>;</span></span>
<span data-line=""> </span>
<span data-line="" data-highlighted-line=""><span>  </span><span>protected</span><span> </span><span>async</span><span> </span><span>function</span><span> </span><span>asyncRender</span><span>(</span><span>): Awaitable&lt;XHPRoot&gt; {</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>$post</span><span> </span><span>=</span><span> </span><span>await</span><span> </span><span>loadPost</span><span>(</span><span>$this</span><span>-&gt;:</span><span>postId</span><span>);</span></span>
<span data-line=""><span>    </span><span>$title</span><span> </span><span>=</span><span> </span><span>$post</span><span>-&gt;</span><span>title</span><span>;</span></span>
<span data-line=""><span>    </span><span>$content</span><span> </span><span>=</span><span> </span><span>$post</span><span>-&gt;</span><span>content</span><span>;</span></span>
<span data-line=""><span>    </span><span>// ...</span></span>
<span data-line=""><span>  }</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>Now the <code>&lt;ui:post-details&gt;</code> can <em>load its own data</em> based on <code>postId</code> alone:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="php" data-theme="default"><code data-language="php" data-theme="default"><span data-line=""><span>class</span><span> </span><span>:</span><span>ui</span><span>:</span><span>post</span><span>-</span><span>list</span><span> </span><span>extends</span><span> </span><span>:</span><span>x</span><span>:</span><span>element</span><span> {</span></span>
<span data-line=""><span>  </span><span>protected</span><span> </span><span>function</span><span> </span><span>render</span><span>():</span><span> </span><span>XHPRoot</span><span> {</span></span>
<span data-line=""><span>    </span><span>return</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>x</span><span>:</span><span>frag</span><span>&gt;</span></span>
<span data-line=""><span>        </span><span>&lt;</span><span>ui</span><span>:</span><span>post</span><span>-</span><span>details</span></span>
<span data-line="" data-highlighted-line=""><span>          </span><span>postId</span><span>=</span><span>&#34;</span><span>jsx-over-the-wire</span><span>&#34;</span></span>
<span data-line=""><span>          </span><span>truncateContent</span><span>=</span><span>{true}</span></span>
<span data-line=""><span>        </span><span>/&gt;</span></span>
<span data-line=""><span>        </span><span>&lt;</span><span>ui</span><span>:</span><span>post</span><span>-</span><span>details</span></span>
<span data-line="" data-highlighted-line=""><span>          </span><span>postId</span><span>=</span><span>&#34;</span><span>react-for-two-computers</span><span>&#34;</span></span>
<span data-line=""><span>          </span><span>truncateContent</span><span>=</span><span>{true}</span></span>
<span data-line=""><span>        </span><span>/&gt;</span></span>
<span data-line=""><span>        </span><span>...</span></span>
<span data-line=""><span>      </span><span>&lt;/</span><span>x</span><span>:</span><span>frag</span><span>&gt;;</span></span>
<span data-line=""><span>  }</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>This approach lets you write the entire UI as <em>asynchronous</em> tags rendering other <em>asynchronous</em> tags—until the final HTML is generated. It’s a powerful way to think about UI and data. It lets you write self-contained components that load their own data, and then plug those components anywhere in the tree with a one-liner. And since XHP tags run on the server, the entire screen is resolved <em>in a single roundtrip</em>.</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="php" data-theme="default"><code data-language="php" data-theme="default"><span data-line=""><span>&lt;</span><span>ui</span><span>:</span><span>post</span><span>-</span><span>list</span><span> </span><span>/&gt;</span><span> </span><span>// An entire page of HTML</span></span></code></pre></div>
<p><strong>I need to emphasize this again. Async XHP allowed <em>self-contained components that load their own data</em> — but! — <em>displaying a screen took a single client/server roundtrip.</em> There aren’t many UI frameworks that satisfy both of these points.</strong></p>
<p>If you’re making a similar framework, there’s a few details you should think about:</p>
<ol>
<li>You want the siblings to be resolved in parallel. For example, the two <code>&lt;ui:post-details&gt;</code> above should <code>loadPost</code> around the same time. Async XHP did this.</li>
<li>You also need some way to <em>unblock</em> the rest of the page if a particular branch of the tree is taking too long. Facebook had a <a target="_blank" href="https://engineering.fb.com/2010/06/04/web/bigpipe-pipelining-web-pages-for-high-performance/">BigPipe  “pagelet”</a> system that flushes the tree “in parts” with explicitly designed loading states acting as the seams.</li>
<li>Ideally, you want a data access layer that’s able to batch reads and share an in-memory cache across different parts of the request. This ensures that even if tags deeper in the tree start “fetching” later than their parents, you’re utilizing both CPU and IO well—there are always some tags to render while waiting for the DB.</li>
</ol>
<p>Overall, async XHP was an incredibly productive mental model to work with—as long as your app was not very interactive. Unfortunately, for highly interactive apps, emitting HTML is not enough. You <em>need</em> to be able to navigate, handle mutations, and refresh content without losing the client-side state. Since XHP targeted HTML, it was a poor fit for rich interfaces, and React gradually took over.</p>
<p><strong>Still, as interfaces were being converted to React, there was a noticeable loss in conceptual simplicity. The UI and the <em>data that it needs</em>—two things that are so naturally described together—were being pulled apart into separate codebases.</strong></p>
<p>GraphQL with <a target="_blank" href="https://relay.dev/">Relay</a> were somewhat bridging that gap and contributed some very important innovations, but using them never felt <em>as direct</em> as writing async XHP.</p>
<hr/>
<h3 id="native-templates"><a target="_self" href="#native-templates">Native Templates</a></h3>
<p>XHP had an unlikely comeback at Facebook.</p>
<p>The mental model it offered was so productive that people didn’t just want to write web interfaces with it. They also wanted to make <em>native apps</em> with it.</p>
<p>Think about it.</p>
<p>This piece of XHP is an <em>object:</em></p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>&lt;</span><span>x</span><span>:</span><span>frag</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>&lt;</span><span>h1</span><span>&gt;{</span><span>$this</span><span>-&gt;</span><span>:title</span><span>}&lt;/</span><span>h1</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>&lt;</span><span>p</span><span>&gt;{</span><span>$this</span><span>-&gt;</span><span>:content</span><span>}&lt;/</span><span>p</span><span>&gt;</span></span>
<span data-line=""><span>&lt;/</span><span>x</span><span>:</span><span>frag</span><span>&gt;</span></span></code></pre></div>
<p>Yes, it <em>can</em> be turned into a piece of HTML:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>&lt;</span><span>h1</span><span>&gt;</span><span>JSX Over The Wire</span><span>&lt;/</span><span>h1</span><span>&gt;</span></span>
<span data-line=""><span>&lt;</span><span>p</span><span>&gt;</span><span>Suppose you have an API route that returns some data as JSON</span><span>&lt;/</span><span>p</span><span>&gt;</span></span></code></pre></div>
<p>But it could also be turned into another representation, such as JSON:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>{</span></span>
<span data-line=""><span>  type: </span><span>&#39;</span><span>x:frag</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>  props: </span><span>{</span></span>
<span data-line=""><span>    children: </span><span>[{</span></span>
<span data-line=""><span>      type</span><span>:</span><span> </span><span>&#39;</span><span>h1</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>      props</span><span>:</span><span> </span><span>{</span></span>
<span data-line=""><span>        children</span><span>:</span><span> </span><span>&#39;</span><span>JSX Over The Wire</span><span>&#39;</span></span>
<span data-line=""><span>      </span><span>}</span></span>
<span data-line=""><span>    </span><span>},</span></span>
<span data-line=""><span>    </span><span>{</span></span>
<span data-line=""><span>      type</span><span>:</span><span> </span><span>&#39;</span><span>p</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>      props</span><span>:</span><span> </span><span>{</span></span>
<span data-line=""><span>        children</span><span>:</span><span> </span><span>&#39;</span><span>Suppose you have an API route that returns some data as JSON</span><span>&#39;</span></span>
<span data-line=""><span>      </span><span>}</span></span>
<span data-line=""><span>    </span><span>}]</span></span>
<span data-line=""><span>  </span><span>}</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>There’s nothing that <em>actually</em> constrains you to the primitives available in HTML. For example, <code>&lt;ui:post-details&gt;</code> could have been emitting <a target="_blank" href="https://developer.apple.com/documentation/uikit/uitextview">iOS views</a> instead:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>&lt;</span><span>x</span><span>:</span><span>frag</span><span>&gt;</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>&lt;</span><span>ios</span><span>:</span><span>UITextView</span><span>&gt;{</span><span>$this</span><span>-&gt;</span><span>:title</span><span>}&lt;/</span><span>ios</span><span>:</span><span>UITextView</span><span>&gt;</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>&lt;</span><span>ios</span><span>:</span><span>UITextView</span><span>&gt;{</span><span>$this</span><span>-&gt;</span><span>:content</span><span>}&lt;/</span><span>ios</span><span>:</span><span>UITextView</span><span>&gt;</span></span>
<span data-line=""><span>&lt;/</span><span>x</span><span>:</span><span>frag</span><span>&gt;</span></span></code></pre></div>
<p>These tags could be transported as JSON over the network to a native iOS app that would read that JSON and construct a native iOS view hierarchy from these tags.</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>{</span></span>
<span data-line=""><span>  type: </span><span>&#39;</span><span>x:frag</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>  props: </span><span>{</span></span>
<span data-line=""><span>    children: </span><span>[{</span></span>
<span data-line="" data-highlighted-line=""><span>      type</span><span>:</span><span> </span><span>&#39;</span><span>ios:UITextView</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>      props</span><span>:</span><span> </span><span>{</span></span>
<span data-line=""><span>        children</span><span>:</span><span> </span><span>&#39;</span><span>JSX Over The Wire</span><span>&#39;</span></span>
<span data-line=""><span>      </span><span>}</span></span>
<span data-line=""><span>    </span><span>},</span></span>
<span data-line=""><span>    </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>      type</span><span>:</span><span> </span><span>&#39;</span><span>ios:UITextView</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>      props</span><span>:</span><span> </span><span>{</span></span>
<span data-line=""><span>        children</span><span>:</span><span> </span><span>&#39;</span><span>Suppose you have an API route that returns some data as JSON</span><span>&#39;</span></span>
<span data-line=""><span>      </span><span>}</span></span>
<span data-line=""><span>    </span><span>}]</span></span>
<span data-line=""><span>  </span><span>}</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>Meanwhile, on the server, you can define your own tags that render those tags:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>class</span><span> :</span><span>ui</span><span>:</span><span>post</span><span>-</span><span>list</span><span> </span><span>extends</span><span> :x:element </span><span>{</span></span>
<span data-line=""><span>  </span><span>protected</span><span> </span><span>function</span><span> </span><span>render</span><span>():</span><span> </span><span>XHPRoot</span><span> </span><span>{</span></span>
<span data-line=""><span>    </span><span>return</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>x</span><span>:</span><span>frag</span><span>&gt;</span></span>
<span data-line=""><span>        </span><span>&lt;</span><span>ui:post-details</span></span>
<span data-line=""><span>          postId=</span><span>&#34;</span><span>jsx-over-the-wire</span><span>&#34;</span></span>
<span data-line=""><span>          truncateContent={</span><span>true</span><span>}</span></span>
<span data-line=""><span>        /&gt;</span></span>
<span data-line=""><span>        </span><span>&lt;</span><span>ui:post-details</span></span>
<span data-line=""><span>          postId=</span><span>&#34;</span><span>react-for-two-computers</span><span>&#34;</span></span>
<span data-line=""><span>          truncateContent={</span><span>true</span><span>}</span></span>
<span data-line=""><span>        /&gt;</span></span>
<span data-line=""><span>        ...</span></span>
<span data-line=""><span>      </span><span>&lt;/</span><span>x</span><span>:</span><span>frag</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>}</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>In other words, you’d have a server endpoint that returns <em>the entire data that any particular screen needs in a single roundtrip</em>. Where the “data” is the native UI.</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="php" data-theme="default"><code data-language="php" data-theme="default"><span data-line=""><span>&lt;</span><span>ui</span><span>:</span><span>post</span><span>-</span><span>list</span><span> </span><span>/&gt;</span><span> </span><span>// A screen of iOS components</span></span></code></pre></div>
<p>You might think this wouldn’t work because a native app can’t rely on a backend in the critical path. However, that’s a misunderstanding of the approach. All you need to ensure is that you <em>request more UI</em> in the same situations as <em>when you would make an API call,</em> and not more often. You’ll also want to have a fallback UI (like a spinner) available instantly <em>just like when making an API call.</em> In fact, you can even bundle the JSON for some of the initial screens directly within your app’s binary.</p>
<p>In practice, system components like <code>ios:UITextView</code> are a bit too low-level to be good primitives for this kind of format. You really want to have a good “palette” of highly interactive primitives since you want <em>some</em> interactions to “skip the server” and be entirely local. For example, you might implement an <code>ios:ColorPicker</code> primitive in the native code so that it follows your finger’s movement, but <em>persist</em> the chosen color using a call to the API that will serve you the next screen as JSON.</p>
<p>Also, if you made the primitives platform-agnostic (which Facebook did), you could use the same server codebase to assemble screens for both iOS and Android:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>&lt;</span><span>nt:flexbox</span><span> flex-direction=</span><span>&#34;</span><span>column</span><span>&#34;</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>&lt;</span><span>nt:text</span><span> font-size={</span><span>24</span><span>} font-weight={</span><span>FontWeight</span><span>::</span><span>BOLD</span><span>}&gt;</span></span>
<span data-line=""><span>    </span><span>{</span><span>$this</span><span>-&gt;</span><span>:title</span><span>}</span></span>
<span data-line=""><span>  </span><span>&lt;/</span><span>nt:text</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>&lt;</span><span>nt:text</span><span> font-size={</span><span>18</span><span>}&gt;</span></span>
<span data-line=""><span>    </span><span>{</span><span>$this</span><span>-&gt;</span><span>:content</span><span>}</span></span>
<span data-line=""><span>  </span><span>&lt;/</span><span>nt:text</span><span>&gt;</span></span>
<span data-line=""><span>&lt;/</span><span>nt:flexbox</span><span>&gt;</span></span></code></pre></div>
<p>Okay, returning an entire screen as JSON, has anyone done this before?</p>
<hr/>
<h3 id="sdui"><a target="_self" href="#sdui">SDUI</a></h3>
<p>This is not a novel idea.</p>
<p>This is not even a controversial idea.</p>
<p>You’ve heard of HTML, right? This is like HTML, but with <em>your</em> design system. Imagine an API endpoint that returns some UI as JSON. Let’s use the JSX syntax:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>app</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>/app/profile/:personId</span><span>&#39;</span><span>,</span><span> </span><span>async</span><span> </span><span>(</span><span>req</span><span>,</span><span> res</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const [</span><span>person</span><span>,</span><span> </span><span>featureFlags</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>    </span><span>findPerson</span><span>(</span><span>req</span><span>.</span><span>params</span><span>.</span><span>personId</span><span>),</span></span>
<span data-line=""><span>    </span><span>getFeatureFlags</span><span>(</span><span>req</span><span>.</span><span>user</span><span>.</span><span>id</span><span>)</span></span>
<span data-line=""><span>  </span><span>]);</span></span>
<span data-line=""> </span>
<span data-line=""><span>  </span><span>const </span><span>json</span><span> </span><span>=</span><span> </span><span>(</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>Page</span><span> title={</span><span>`</span><span>${</span><span>person</span><span>.</span><span>firstName</span><span>}</span><span>&#39;s Profile`</span><span>}&gt;</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>Header</span><span>&gt;</span></span>
<span data-line=""><span>        </span><span>&lt;</span><span>Avatar</span><span> src={</span><span>person</span><span>.</span><span>avatarUrl</span><span>} /&gt;</span></span>
<span data-line=""><span>        </span><span>{</span><span>person</span><span>.</span><span>isPremium </span><span>&amp;&amp;</span><span> </span><span>&lt;</span><span>PremiumBadge</span><span> /&gt;}</span></span>
<span data-line=""><span>      </span><span>&lt;/</span><span>Header</span><span>&gt;</span></span>
<span data-line=""> </span>
<span data-line=""><span>      </span><span>&lt;</span><span>Layout</span><span> columns={</span><span>featureFlags</span><span>.</span><span>includes</span><span>(</span><span>&#39;</span><span>TWO_COL_LAYOUT</span><span>&#39;</span><span>) ? </span><span>2</span><span> : </span><span>1</span><span>}&gt;</span></span>
<span data-line=""><span>        </span><span>&lt;</span><span>Panel</span><span> title=</span><span>&#34;</span><span>User Info</span><span>&#34;</span><span>&gt;</span></span>
<span data-line=""><span>          </span><span>&lt;</span><span>UserDetails</span><span> user={</span><span>person</span><span>} /&gt;</span></span>
<span data-line=""><span>          </span><span>{</span><span>req</span><span>.</span><span>user</span><span>.</span><span>id </span><span>===</span><span> </span><span>person</span><span>.</span><span>id </span><span>&amp;&amp;</span><span> </span><span>&lt;</span><span>EditButton</span><span> /&gt;}</span></span>
<span data-line=""><span>        </span><span>&lt;/</span><span>Panel</span><span>&gt;</span></span>
<span data-line=""> </span>
<span data-line=""><span>        </span><span>&lt;</span><span>Panel</span><span> title=</span><span>&#34;</span><span>Activity</span><span>&#34;</span><span>&gt;</span></span>
<span data-line=""><span>          </span><span>&lt;</span><span>ActivityFeed</span><span> userId={</span><span>person</span><span>.</span><span>id</span><span>} limit={</span><span>3</span><span>} /&gt;</span></span>
<span data-line=""><span>        </span><span>&lt;/</span><span>Panel</span><span>&gt;</span></span>
<span data-line=""><span>      </span><span>&lt;/</span><span>Layout</span><span>&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;/</span><span>Page</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>);</span></span>
<span data-line=""> </span>
<span data-line=""><span>  </span><span>res</span><span>.</span><span>json</span><span>(</span><span>json</span><span>);</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>But since you’re essentially coding an API endpoint, you can do anything <em>your API</em> can do—check the feature flags, run server-only logic, read from the data layer.</p>
<p>Again, this is not a new idea.</p>
<p>In fact, it’s how many of the top native apps are built. <a target="_blank" href="https://github.com/novitae/igbloks/tree/main/KNOWLEDGES">Instagram does this</a>, <a target="_blank" href="https://medium.com/airbnb-engineering/a-deep-dive-into-airbnbs-server-driven-ui-system-842244c5f5">Airbnb does this</a>, <a target="_blank" href="https://www.reddit.com/r/androiddev/comments/1046xel/comment/j35yr8c/">Uber does this</a>, <a target="_blank" href="https://www.infoq.com/news/2023/09/reddit-feed-server-driven-ui/">Reddit does this</a>, etc. These companies use in-house frameworks that implement this pattern. Many web developers are completely unaware of this pattern which is ironic because the pattern is incredibly “webby”.</p>
<p>In the native sphere, the pattern is known as “SDUI”—<em>“server driven UI”</em>. This sounds fancy but essentially it’s just JSON endpoints that return UI trees:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>// /app/profile/123</span></span>
<span data-line=""><span>{</span></span>
<span data-line=""><span>  type: </span><span>&#34;</span><span>Page</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>  props: </span><span>{</span></span>
<span data-line=""><span>    title: </span><span>&#34;</span><span>Jae&#39;s Profile</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>    children: </span><span>[{</span></span>
<span data-line=""><span>      type</span><span>:</span><span> </span><span>&#34;</span><span>Header</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>      props</span><span>:</span><span> </span><span>{</span></span>
<span data-line=""><span>        children</span><span>:</span><span> </span><span>[{</span></span>
<span data-line=""><span>          type</span><span>:</span><span> </span><span>&#34;</span><span>Avatar</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>          props</span><span>:</span><span> </span><span>{</span></span>
<span data-line=""><span>            src</span><span>:</span><span> </span><span>&#34;</span><span>https://example.com/avatar.jpg</span><span>&#34;</span></span>
<span data-line=""><span>          </span><span>}</span></span>
<span data-line=""><span>        </span><span>},</span><span> </span><span>{</span></span>
<span data-line=""><span>          type</span><span>:</span><span> </span><span>&#34;</span><span>PremiumBadge</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>          props</span><span>:</span><span> </span><span>{},</span></span>
<span data-line=""><span>        </span><span>}]</span></span>
<span data-line=""><span>      </span><span>}</span></span>
<span data-line=""><span>    </span><span>},</span><span> </span><span>{</span></span>
<span data-line=""><span>      type</span><span>:</span><span> </span><span>&#34;</span><span>Layout</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>      props</span><span>:</span><span> </span><span>{</span></span>
<span data-line=""><span>        columns</span><span>:</span><span> </span><span>2</span><span>,</span></span>
<span data-line=""><span>        children</span><span>:</span><span> </span><span>[</span></span>
<span data-line=""><span>          </span><span>// ...</span></span>
<span data-line=""><span>        </span><span>]</span></span>
<span data-line=""><span>      </span><span>}</span></span>
<span data-line=""><span>    </span><span>}]</span></span>
<span data-line=""><span>  </span><span>}</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>Then, on the native side, you have some concrete implementations of those primitives—<code>Page</code>, <code>Header</code>, <code>Avatar</code>, <code>PremiumBadge</code>, <code>Layout</code>, and so on.</p>
<p>Ultimately, this feels like <em>passing props</em> from the server to the client.</p>
<p>So if we ever find ourselves in a situation where we have a bunch of data prepared on the server, and we need to find a good way to pass pieces of that data to a bunch of functions declared on the client, a format like this might turn out to be handy.</p>
<p>Let’s keep that in mind.</p>
<hr/>
<h3 id="recap-components-as-json"><a target="_self" href="#recap-components-as-json">Recap: Components as JSON</a></h3>
<ul>
<li>From the beginning of time, making web apps involved responding to request for a specific screen with all the data needed for that screen. (HTML is data, too.)</li>
<li>From the beginning of time, people looked for ways to make the generation of that “data” dynamic, to split it into reusable logic, and to pass parameters to that logic.</li>
<li>In the early days of the web, it was common to compose HTML by string manipulation. Unfortunately, it was easy to mess up and led to many issues.</li>
<li>This led many in the web community to banish markup to templates. But at Facebook, XHP proposed another approach: markup that produces objects.</li>
<li>It turns out that making markup a first-class coding primitive naturally leads to tags “returning” other tags—instead of MVC, we got functional composition.</li>
<li>XHP evolved into Async XHP, which allowed to keep the logic for rendering some UI close to the logic for loading the data it needs. This was extremely powerful.</li>
<li>Unfortunately, producing HTML as the primary output format is a dead end for interactive applications. You can’t “refresh” HTML in-place without blowing away the state, and state is important.</li>
<li>However, nothing actually constraints us to HTML. If tags are objects, they can be sent as JSON. Many of the most successful <em>native</em> apps are built this paradigm. (And if you need HTML, you can always turn JSON <em>into</em> HTML later on.)</li>
<li>Returning a tag of client primitives as a JSON tree is a nice way to represent “passing props” to the client.</li>
</ul>
<hr/>
<h2 id="part-3-jsx-over-the-wire"><a target="_self" href="#part-3-jsx-over-the-wire">Part 3: JSX Over The Wire</a></h2>
<h3 id="what-were-building"><a target="_self" href="#what-were-building">What We’re Building</a></h3>
<p>So far, we’ve explored two separates lines of thought:</p>
<ul>
<li>Directly calling REST APIs from the client layer <a href="#rest-and-json-api">ignores the realities</a> of how user interfaces evolve. We can solve this by <a href="#api-for-viewmodels">adding a new backend layer</a> that assembles the data on the server according to what each screen <em>needs</em>. This layer <a href="#extracting-a-viewmodel">can be split into functions</a> that each specify how to load data for a particular <em>part</em> of the screen. Then these functions can be <a href="#composing-viewmodels">composed together</a>. However, we’re not sure how to actually <em>tie</em> those functions to the components whose props they are preparing.</li>
<li>We can also <a href="#html-ssi-and-cgi">start from plain HTML</a> and “server includes”. If we avoid early MVC-ification and instead explore treating markup as objects, we’ll <a href="#php-and-xhp">eventually invent</a> the concept of <a href="#async-xhp">asynchronous tags</a> that load their own data and return more tags. This approach is very powerful because it lets us build self-contained components without causing multiple client/server roundtrips for fetching a single screen. Emitting HTML <em>as the only target format</em> is a dead end, but as proven by many top native applications using this approach, <a href="#native-templates">emitting JSON</a> retains all the benefits. All you need is a <a href="#sdui">set of client-side primitives</a> that can be composed from the server.</li>
</ul>
<p>It turns out that these are two different ways to talk about the same thing. Ultimately, all we want is a system with these five properties:</p>
<h4 id="dans-async-ui-framework-checklist"><a target="_self" href="#dans-async-ui-framework-checklist">Dan’s Async UI Framework Checklist</a></h4>
<ol>
<li>Our system lets us split a user interface into rich, interactive components.</li>
<li>Components should have a <em>direct connection</em> with the logic that specifies how <em>their</em> server data is computed. If a component receives some information from the server, you should be a single Ctrl+Click or “Find All References” away from every place on the server where <em>that particular component’s</em> props are being calculated. It should be straightforward to change which data is received by which component.</li>
<li>There should be a way to make pieces of UI truly self-contained—including their server data dependencies and corresponding server logic. You should be able to nest a piece of UI inside another piece of UI without worrying what data it needs.</li>
<li>A navigation to a new screen should be possible to complete in one client/server roundtrip. Even if you have hundreds of components that each want to load some data, from the client’s perspective, a screen should arrive as a single response. In fact, we’d like our system to <em>stand in the way</em> of creating client/server waterfalls.</li>
<li>We’d like our system to fully support rich interactivity. This means that, even if some parts of it run on the server, it is <em>unacceptable</em> to require full-page refreshes on navigation or after a mutation. In fact, the system should support in-place refreshing of server data directly within an interactive tree. A component should be able to “receive new props” from the server without losing any client state.</li>
</ol>
<p>Do you know any such systems? (Try scoring the frameworks you know.)</p>
<p>If not, let’s invent one right now.</p>
<hr/>
<h3 id="viewmodels-revisited"><a target="_self" href="#viewmodels-revisited">ViewModels, Revisited</a></h3>
<p>Let’s get back to <a href="#plumbing-viewmodel-parameters">the last version</a> of <code>LikeButtonViewModel</code> from earlier:</p>
<div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>LikeButtonViewModel</span><span>(</span><span>{</span></span>
<span data-line=""><span>  postId</span><span>,</span></span>
<span data-line=""><span>  includeAvatars</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line=""><span>    </span><span>getFriendLikes</span><span>(</span><span>postId</span><span>,</span><span> </span><span>{</span><span> limit</span><span>:</span><span> includeAvatars </span><span>?</span><span> </span><span>5</span><span> </span><span>:</span><span> </span><span>2</span><span> </span><span>}),</span></span>
<span data-line=""><span>  </span><span>]);</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>    totalLikeCount</span><span>:</span><span> </span><span>post</span><span>.</span><span>totalLikeCount</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    isLikedByUser</span><span>:</span><span> </span><span>post</span><span>.</span><span>isLikedByUser</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    friendLikes</span><span>:</span><span> </span><span>friendLikes</span><span>.</span><span>likes</span><span>.</span><span>map</span><span>(</span><span>l </span><span>=&gt;</span><span> </span><span>({</span></span>
<span data-line="" data-highlighted-line=""><span>      firstName</span><span>:</span><span> </span><span>l</span><span>.</span><span>firstName</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      avatar</span><span>:</span><span> includeAvatars </span><span>?</span><span> </span><span>l</span><span>.</span><span>avatar </span><span>:</span><span> </span><span>null</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>}))</span></span>
<span data-line=""><span>  </span><span>};</span></span>
<span data-line=""><span>}</span></span></code></pre></div></div>
<p>This function is a <em>slice of the backend</em> that prepares the props for the <code>LikeButton</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>{</span></span>
<span data-line=""><span>  totalLikeCount: </span><span>8</span><span>,</span></span>
<span data-line=""><span>  isLikedByUser: </span><span>false</span><span>,</span></span>
<span data-line=""><span>  friendLikes: </span><span>[{</span></span>
<span data-line=""><span>    firstName</span><span>:</span><span> </span><span>&#39;</span><span>Alice</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>    avatar</span><span>:</span><span> </span><span>&#39;</span><span>https://example.com/alice.jpg</span><span>&#39;</span></span>
<span data-line=""><span>  </span><span>},</span><span> </span><span>{</span></span>
<span data-line=""><span>    firstName</span><span>:</span><span> </span><span>&#39;</span><span>Bob</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>    avatar</span><span>:</span><span> </span><span>&#39;</span><span>https://example.com/bob.jpg</span><span>&#39;</span></span>
<span data-line=""><span>  </span><span>}]</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>Eventually we were hoping that the <code>LikeButton</code> will receive these props:</p>
<div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>function</span><span> </span><span>LikeButton</span><span>(</span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>  totalLikeCount</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>  isLikedByUser</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>  friendLikes</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>// ...</span></span>
<span data-line=""><span>}</span></span></code></pre></div></div>
<p>However, we haven’t come up with any mechanism to connect the two sides yet. Who’s gonna pass the JSON returned by the <code>LikeButtonViewModel</code> to the <code>LikeButton</code> component? How do we tie the ViewModels to their components?</p>
<p>What if we took a page out of <a href="#sdui">SDUI</a> and expressed that by returning a <em>tag</em>:</p>
<div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>LikeButtonViewModel</span><span>(</span><span>{</span></span>
<span data-line=""><span>  postId</span><span>,</span></span>
<span data-line=""><span>  includeAvatars</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line=""><span>    </span><span>getFriendLikes</span><span>(</span><span>postId</span><span>,</span><span> </span><span>{</span><span> limit</span><span>:</span><span> includeAvatars </span><span>?</span><span> </span><span>5</span><span> </span><span>:</span><span> </span><span>2</span><span> </span><span>}),</span></span>
<span data-line=""><span>  </span><span>]);</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>(</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>&lt;</span><span>LikeButton</span></span>
<span data-line=""><span>      totalLikeCount={</span><span>post</span><span>.</span><span>totalLikeCount</span><span>}</span></span>
<span data-line=""><span>      isLikedByUser={</span><span>post</span><span>.</span><span>isLikedByUser</span><span>}</span></span>
<span data-line=""><span>      friendLikes={</span><span>friendLikes</span><span>.</span><span>likes</span><span>.</span><span>map</span><span>(</span><span>l</span><span> </span><span>=&gt;</span><span> ({</span></span>
<span data-line=""><span>        </span><span>firstName</span><span>:</span><span> </span><span>l</span><span>.</span><span>firstName</span><span>,</span></span>
<span data-line=""><span>        </span><span>avatar</span><span>:</span><span> includeAvatars </span><span>?</span><span> </span><span>l</span><span>.</span><span>avatar </span><span>:</span><span> </span><span>null</span><span>,</span></span>
<span data-line=""><span>      }))}</span></span>
<span data-line="" data-highlighted-line=""><span>    /&gt;</span></span>
<span data-line=""><span>  </span><span>);</span></span>
<span data-line=""><span>}</span></span></code></pre></div></div>
<p>As <a href="#sdui">we know</a> from earlier, we can represent this JSX as a tree of JSON. In fact, it’s almost like the original JSON, but now it specifies the receiving component:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>  type: </span><span>&#34;</span><span>LikeButton</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>  props: </span><span>{</span></span>
<span data-line=""><span>    totalLikeCount: </span><span>8</span><span>,</span></span>
<span data-line=""><span>    isLikedByUser: </span><span>false</span><span>,</span></span>
<span data-line=""><span>    friendLikes: </span><span>[{</span></span>
<span data-line=""><span>      firstName</span><span>:</span><span> </span><span>&#39;</span><span>Alice</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>      avatar</span><span>:</span><span> </span><span>&#39;</span><span>https://example.com/alice.jpg</span><span>&#39;</span></span>
<span data-line=""><span>    </span><span>},</span><span> </span><span>{</span></span>
<span data-line=""><span>      firstName</span><span>:</span><span> </span><span>&#39;</span><span>Bob</span><span>&#39;</span><span>,</span></span>
<span data-line=""><span>      avatar</span><span>:</span><span> </span><span>&#39;</span><span>https://example.com/bob.jpg</span><span>&#39;</span></span>
<span data-line=""><span>    </span><span>}]</span></span>
<span data-line=""><span>  </span><span>}</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>Then React on the client would <em>know</em> to pass these props to the <code>LikeButton</code>:</p>
<div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line="" data-highlighted-line=""><span>function</span><span> </span><span>LikeButton</span><span>(</span><span>{</span></span>
<span data-line=""><span>  totalLikeCount</span><span>,</span></span>
<span data-line=""><span>  isLikedByUser</span><span>,</span></span>
<span data-line=""><span>  friendLikes</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>// ...</span></span>
<span data-line=""><span>}</span></span></code></pre></div></div>
<p>And so we’ve finally stitched the ViewModel and its component together!</p>
<p>We’ve tied the code <em>generating</em> the props with the code <em>consuming</em> those props. Now our ViewModel and our component are a Ctrl+Click away from each other. Since JSX expressions are typechecked, we also get full typechecking for free.</p>
<p>Have a look at the complete picture:</p>
<div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>LikeButtonViewModel</span><span>(</span><span>{</span></span>
<span data-line=""><span>  postId</span><span>,</span></span>
<span data-line=""><span>  includeAvatars</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line=""><span>    </span><span>getFriendLikes</span><span>(</span><span>postId</span><span>,</span><span> </span><span>{</span><span> limit</span><span>:</span><span> includeAvatars </span><span>?</span><span> </span><span>5</span><span> </span><span>:</span><span> </span><span>2</span><span> </span><span>}),</span></span>
<span data-line=""><span>  </span><span>]);</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>(</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>&lt;</span><span>LikeButton</span></span>
<span data-line="" data-highlighted-line=""><span>      totalLikeCount={</span><span>post</span><span>.</span><span>totalLikeCount</span><span>}</span></span>
<span data-line="" data-highlighted-line=""><span>      isLikedByUser={</span><span>post</span><span>.</span><span>isLikedByUser</span><span>}</span></span>
<span data-line="" data-highlighted-line=""><span>      friendLikes={</span><span>friendLikes</span><span>.</span><span>likes</span><span>.</span><span>map</span><span>(</span><span>l</span><span> </span><span>=&gt;</span><span> ({</span></span>
<span data-line="" data-highlighted-line=""><span>        </span><span>firstName</span><span>:</span><span> </span><span>l</span><span>.</span><span>firstName</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>        </span><span>avatar</span><span>:</span><span> includeAvatars </span><span>?</span><span> </span><span>l</span><span>.</span><span>avatar </span><span>:</span><span> </span><span>null</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      }))}</span></span>
<span data-line="" data-highlighted-line=""><span>    /&gt;</span></span>
<span data-line=""><span>  </span><span>);</span></span>
<span data-line=""><span>}</span></span></code></pre></div></div>
<div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line="" data-highlighted-line=""><span>function</span><span> </span><span>LikeButton</span><span>(</span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>  totalLikeCount</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>  isLikedByUser</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>  friendLikes</span></span>
<span data-line="" data-highlighted-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>let </span><span>buttonText</span><span> </span><span>=</span><span> </span><span>&#39;</span><span>Like</span><span>&#39;</span><span>;</span></span>
<span data-line=""><span>  </span><span>if</span><span> </span><span>(</span><span>totalLikeCount </span><span>&gt;</span><span> </span><span>0</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>    </span><span>// e.g. &#34;Liked by You, Alice, and 13 others&#34;</span></span>
<span data-line=""><span>    buttonText </span><span>=</span><span> </span><span>formatLikeText</span><span>(</span><span>totalLikeCount</span><span>,</span><span> isLikedByUser</span><span>,</span><span> friendLikes</span><span>);</span></span>
<span data-line=""><span>  </span><span>}</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>(</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>button</span><span> className={</span><span>isLikedByUser</span><span> ? </span><span>&#39;</span><span>liked</span><span>&#39;</span><span> : </span><span>&#39;&#39;</span><span>}&gt;</span></span>
<span data-line=""><span>      </span><span>{</span><span>buttonText</span><span>}</span></span>
<span data-line=""><span>    </span><span>&lt;/</span><span>button</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>);</span></span>
<span data-line=""><span>}</span></span></code></pre></div></div>
<p>Our ViewModel is just like an <a href="#async-xhp">Async XHP</a> tag, passing some information to our own <code>&lt;LikeButton&gt;</code> primitive that lives on client (just like in <a href="#sdui">SDUI</a>). Together, they represent a self-contained piece of UI that knows how to load its own data.</p>
<p>Let’s do this again with another ViewModel.</p>
<hr/>
<h3 id="lets-do-this-again"><a target="_self" href="#lets-do-this-again">Let’s Do This Again</a></h3>
<p>Now let’s revisit the <code>PostDetailsViewModel</code> from <a href="#composing-viewmodels">this section</a>:</p>
<div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>PostDetailsViewModel</span><span>(</span><span>{</span></span>
<span data-line=""><span>  postId</span><span>,</span></span>
<span data-line=""><span>  truncateContent</span><span>,</span></span>
<span data-line=""><span>  includeAvatars</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>postLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line=""><span>    </span><span>LikeButtonViewModel</span><span>({</span><span> postId</span><span>,</span><span> includeAvatars </span><span>}),</span></span>
<span data-line=""><span>  </span><span>]);</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>{</span></span>
<span data-line=""><span>    postTitle</span><span>:</span><span> </span><span>post</span><span>.</span><span>title</span><span>,</span></span>
<span data-line=""><span>    postContent</span><span>:</span><span> </span><span>parseMarkdown</span><span>(</span><span>post</span><span>.</span><span>content</span><span>,</span><span> </span><span>{</span></span>
<span data-line=""><span>      maxParagraphs</span><span>:</span><span> truncateContent </span><span>?</span><span> </span><span>1</span><span> </span><span>:</span><span> </span><span>undefined</span></span>
<span data-line=""><span>    </span><span>}),</span></span>
<span data-line=""><span>    postAuthor</span><span>:</span><span> </span><span>post</span><span>.</span><span>author</span><span>,</span></span>
<span data-line=""><span>    postLikes</span></span>
<span data-line=""><span>  </span><span>};</span></span>
<span data-line=""><span>}</span></span></code></pre></div></div>
<p>We’ve never explicitly written it down, but suppose that there was a matching <code>PostDetails</code> component that can take that JSON and actually render the post:</p>
<div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>function</span><span> </span><span>PostDetails</span><span>(</span><span>{</span></span>
<span data-line=""><span>  postTitle</span><span>,</span></span>
<span data-line=""><span>  postContent</span><span>,</span></span>
<span data-line=""><span>  postAuthor</span><span>,</span></span>
<span data-line=""><span>  postLikes</span><span>,</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>// ...</span></span>
<span data-line=""><span>}</span></span></code></pre></div></div>
<p>Let’s connect them together.</p>
<p>First, let’s change <code>PostDetailsViewModel</code> to return a <code>PostDetails</code> <em>tag:</em></p>
<div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>PostDetailsViewModel</span><span>(</span><span>{</span></span>
<span data-line=""><span>  postId</span><span>,</span></span>
<span data-line=""><span>  truncateContent</span><span>,</span></span>
<span data-line=""><span>  includeAvatars</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>postLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line=""><span>    </span><span>LikeButtonViewModel</span><span>({</span><span> postId</span><span>,</span><span> includeAvatars </span><span>}),</span></span>
<span data-line=""><span>  </span><span>]);</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>(</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>&lt;</span><span>PostDetails</span></span>
<span data-line=""><span>      postTitle={</span><span>post</span><span>.</span><span>title</span><span>}</span></span>
<span data-line=""><span>      postContent={</span><span>parseMarkdown</span><span>(</span><span>post</span><span>.</span><span>content</span><span>, {</span></span>
<span data-line=""><span>        </span><span>maxParagraphs</span><span>:</span><span> truncateContent </span><span>?</span><span> </span><span>1</span><span> </span><span>:</span><span> </span><span>undefined</span></span>
<span data-line=""><span>      </span><span>})}</span></span>
<span data-line=""><span>      postAuthor={</span><span>post</span><span>.</span><span>author</span><span>}</span></span>
<span data-line=""><span>      postLikes={</span><span>postLikes</span><span>}</span></span>
<span data-line="" data-highlighted-line=""><span>    /&gt;</span></span>
<span data-line=""><span>  </span><span>);</span></span>
<span data-line=""><span>}</span></span></code></pre></div></div>
<p>Now the JSON it returns will be wrapped into a <code>PostDetails</code> JSX element:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>  type: </span><span>&#34;</span><span>PostDetails</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>  props: </span><span>{</span></span>
<span data-line=""><span>    postTitle: </span><span>&#34;</span><span>JSX Over The Wire</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>    postAuthor: </span><span>&#34;</span><span>Dan</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>    postContent: </span><span>&#34;</span><span>Suppose you have an API route that returns some data as JSON.</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>    postLikes: </span><span>{</span></span>
<span data-line=""><span>      type: </span><span>&#34;</span><span>LikeButton</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>      props: </span><span>{</span></span>
<span data-line=""><span>        totalLikeCount: </span><span>8</span><span>,</span></span>
<span data-line=""><span>        isLikedByUser: </span><span>false</span><span>,</span></span>
<span data-line=""><span>        friendLikes: </span><span>[{</span></span>
<span data-line=""><span>          firstName</span><span>:</span><span> </span><span>&#34;</span><span>Alice</span><span>&#34;</span></span>
<span data-line=""><span>        </span><span>},</span><span> </span><span>{</span></span>
<span data-line=""><span>          firstName</span><span>:</span><span> </span><span>&#34;</span><span>Bob</span><span>&#34;</span></span>
<span data-line=""><span>        </span><span>}]</span></span>
<span data-line=""><span>      </span><span>}</span></span>
<span data-line=""><span>    </span><span>}</span></span>
<span data-line=""><span>  </span><span>}</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>On the client, React will take these props and pass them to <code>PostDetails</code>:</p>
<div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>function</span><span> </span><span>PostDetails</span><span>(</span><span>{</span></span>
<span data-line=""><span>  postTitle</span><span>,</span></span>
<span data-line=""><span>  postContent</span><span>,</span></span>
<span data-line=""><span>  postAuthor</span><span>,</span></span>
<span data-line=""><span>  postLikes</span><span>,</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>(</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>article</span><span>&gt;</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>h1</span><span>&gt;{</span><span>postTitle</span><span>}&lt;/</span><span>h1</span><span>&gt;</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>div</span><span> dangerouslySetInnerHTML={{ </span><span>__html</span><span>:</span><span> postContent </span><span>}} /&gt;</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>p</span><span>&gt;</span><span>by </span><span>{</span><span>postAuthor</span><span>.</span><span>name</span><span>}&lt;/</span><span>p</span><span>&gt;</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>section</span><span>&gt;</span></span>
<span data-line=""><span>        </span><span>{</span><span>postLikes</span><span>}</span></span>
<span data-line=""><span>      </span><span>&lt;/</span><span>section</span><span>&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;/</span><span>article</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>);</span></span>
<span data-line=""><span>}</span></span></code></pre></div></div>
<p>And that connects the ViewModel with its component!</p>
<hr/>
<h3 id="composing-viewmodels-revisited"><a target="_self" href="#composing-viewmodels-revisited">Composing ViewModels, Revisited</a></h3>
<p>Notice how <code>postLikes</code> in the last example is rendered directly into UI:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>&lt;</span><span>section</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>{</span><span>postLikes</span><span>}</span></span>
<span data-line=""><span>&lt;/</span><span>section</span><span>&gt;</span></span></code></pre></div>
<p>We can do this because it’s the <code>&lt;LikeButton&gt;</code> with its props already preconfigured by <code>LikeButtonViewModel</code>. It was right here in the JSON:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>{</span></span>
<span data-line=""><span>  type: </span><span>&#34;</span><span>PostDetails</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>  props: </span><span>{</span></span>
<span data-line=""><span>    </span><span>// ...</span></span>
<span data-line=""><span>    postLikes: </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>      type: </span><span>&#34;</span><span>LikeButton</span><span>&#34;</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      props: </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>        totalLikeCount: </span><span>8</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>        </span><span>// ...</span></span>
<span data-line="" data-highlighted-line=""><span>      </span><span>}</span></span>
<span data-line=""><span>    </span><span>}</span></span>
<span data-line=""><span>  </span><span>}</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>You might recall that we obtained it by calling <code>LikeButtonViewModel</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>PostDetailsViewModel</span><span>(</span><span>{</span></span>
<span data-line=""><span>  postId</span><span>,</span></span>
<span data-line=""><span>  truncateContent</span><span>,</span></span>
<span data-line=""><span>  includeAvatars</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const [</span><span>post</span><span>,</span><span> </span><span>postLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>    </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>LikeButtonViewModel</span><span>({</span><span> postId</span><span>,</span><span> includeAvatars </span><span>}),</span></span>
<span data-line=""><span>  </span><span>]);</span></span>
<span data-line=""><span>  </span><span>// ...</span></span></code></pre></div>
<p>However, having ViewModels manually call other ViewModels inside <code>Promise.all</code> quickly gets very tedious. So we’ll adopt a new convention. Let’s assume that a ViewModel can embed <em>another</em> ViewModel by returning a JSX tag.</p>
<p>This will let us clean up the code quite a bit:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>PostDetailsViewModel</span><span>(</span><span>{</span></span>
<span data-line=""><span>  postId</span><span>,</span></span>
<span data-line=""><span>  truncateContent</span><span>,</span></span>
<span data-line=""><span>  includeAvatars</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>const </span><span>post</span><span> </span><span>=</span><span> await </span><span>getPost</span><span>(</span><span>postId</span><span>);</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>(</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>PostDetails</span></span>
<span data-line=""><span>      postTitle={</span><span>post</span><span>.</span><span>title</span><span>}</span></span>
<span data-line=""><span>      postContent={</span><span>parseMarkdown</span><span>(</span><span>post</span><span>.</span><span>content</span><span>, {</span></span>
<span data-line=""><span>        </span><span>maxParagraphs</span><span>:</span><span> truncateContent </span><span>?</span><span> </span><span>1</span><span> </span><span>:</span><span> </span><span>undefined</span></span>
<span data-line=""><span>      </span><span>})}</span></span>
<span data-line=""><span>      postAuthor={</span><span>post</span><span>.</span><span>author</span><span>}</span></span>
<span data-line=""><span>      postLikes={</span></span>
<span data-line="" data-highlighted-line=""><span>        &lt;</span><span>LikeButtonViewModel</span></span>
<span data-line="" data-highlighted-line=""><span>          postId={</span><span>postId</span><span>}</span></span>
<span data-line="" data-highlighted-line=""><span>          includeAvatars={</span><span>includeAvatars</span><span>}</span></span>
<span data-line="" data-highlighted-line=""><span>        /&gt;</span></span>
<span data-line=""><span>      }</span><span>}</span></span>
<span data-line=""><span>    /&gt;</span></span>
<span data-line=""><span>  </span><span>);</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>After this change, calling <code>PostDetailsViewModel</code> will return “unfinished” JSON:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>{</span></span>
<span data-line=""><span>  type: </span><span>&#34;</span><span>PostDetails</span><span>&#34;</span><span>,</span><span> </span><span>// ✅ This is a component on the client</span></span>
<span data-line=""><span>  props: </span><span>{</span></span>
<span data-line=""><span>    postTitle: </span><span>&#34;</span><span>JSX Over The Wire</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>    </span><span>// ...</span></span>
<span data-line="" data-highlighted-line=""><span>    postLikes: </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>      type: LikeButtonViewModel</span><span>,</span><span> </span><span>// 🟡 We haven&#39;t run this ViewModel yet</span></span>
<span data-line="" data-highlighted-line=""><span>      props: </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>        postId: </span><span>&#34;</span><span>jsx-over-the-wire</span><span>&#34;</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>        includeAvatars: </span><span>false</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      </span><span>}</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>}</span></span>
<span data-line=""><span>  </span><span>}</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>The code responsible for sending JSON to the client will see that it’s a ViewModel (so it still needs to run!), and will call <code>LikeButtonViewModel</code> to get more JSON:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>{</span></span>
<span data-line=""><span>  type: </span><span>&#34;</span><span>PostDetails</span><span>&#34;</span><span>,</span><span> </span><span>// ✅ This is a component on the client</span></span>
<span data-line=""><span>  props: </span><span>{</span></span>
<span data-line=""><span>    postTitle: </span><span>&#34;</span><span>JSX Over The Wire</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>    </span><span>// ...</span></span>
<span data-line="" data-highlighted-line=""><span>    postLikes: </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>      type: </span><span>&#34;</span><span>LikeButton</span><span>&#34;</span><span>,</span><span> </span><span>// ✅ This is a component on the client</span></span>
<span data-line="" data-highlighted-line=""><span>      props: </span><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>        totalLikeCount: </span><span>8</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>        </span><span>// ...</span></span>
<span data-line="" data-highlighted-line=""><span>      </span><span>}</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>}</span></span>
<span data-line=""><span>  </span><span>}</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>ViewModels will get recursively unfolded as they each contribute their part of the JSON. This might remind you of how <a href="#php-and-xhp">XHP tags can recursively render other XHP tags</a>. The final JSON will be turned on the client into a React component tree.</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>&lt;</span><span>PostDetails</span></span>
<span data-line=""><span>  postTitle=</span><span>&#34;</span><span>JSX Over The Wire</span><span>&#34;</span></span>
<span data-line=""><span>  </span><span>// ...</span></span>
<span data-line=""><span>&gt;</span></span>
<span data-line=""><span>  </span><span>&lt;</span><span>LikeButton</span></span>
<span data-line=""><span>    totalLikeCount={</span><span>8</span><span>}</span></span>
<span data-line=""><span>    </span><span>// ...</span></span>
<span data-line=""><span>  /&gt;</span></span>
<span data-line=""><span>&lt;/</span><span>PostDetails</span><span>&gt;</span></span></code></pre></div>
<hr/>
<h3 id="the-data-always-flows-down"><a target="_self" href="#the-data-always-flows-down">The Data Always Flows Down</a></h3>
<p>To make the JSX look slightly nicer, we can also rename <code>postLikes</code> to <code>children</code>. This will let us nest <code>LikeButtonViewModel</code> as a JSX child of <code>PostDetails</code>.</p>
<p>Here’s the entire code so far. Notice how the data flows down:</p>
<div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>PostDetailsViewModel</span><span>(</span><span>{</span></span>
<span data-line=""><span>  postId</span><span>,</span></span>
<span data-line=""><span>  truncateContent</span><span>,</span></span>
<span data-line=""><span>  includeAvatars</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const </span><span>post</span><span> </span><span>=</span><span> await </span><span>getPost</span><span>(</span><span>postId</span><span>);</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>(</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>PostDetails</span></span>
<span data-line=""><span>      postTitle={</span><span>post</span><span>.</span><span>title</span><span>}</span></span>
<span data-line=""><span>      postContent={</span><span>parseMarkdown</span><span>(</span><span>post</span><span>.</span><span>content</span><span>, {</span></span>
<span data-line=""><span>        </span><span>maxParagraphs</span><span>:</span><span> truncateContent </span><span>?</span><span> </span><span>1</span><span> </span><span>:</span><span> </span><span>undefined</span></span>
<span data-line=""><span>      </span><span>})}</span></span>
<span data-line=""><span>      postAuthor={</span><span>post</span><span>.</span><span>author</span><span>}</span></span>
<span data-line=""><span>    &gt;</span></span>
<span data-line="" data-highlighted-line=""><span>      </span><span>&lt;</span><span>LikeButtonViewModel</span></span>
<span data-line="" data-highlighted-line=""><span>        postId={</span><span>postId</span><span>}</span></span>
<span data-line="" data-highlighted-line=""><span>        includeAvatars={</span><span>includeAvatars</span><span>}</span></span>
<span data-line="" data-highlighted-line=""><span>      /&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;/</span><span>PostDetails</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>);</span></span>
<span data-line=""><span>}</span></span>
<span data-line=""> </span>
<span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>LikeButtonViewModel</span><span>(</span><span>{</span></span>
<span data-line=""><span>  postId</span><span>,</span></span>
<span data-line=""><span>  includeAvatars</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>  </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line=""><span>  </span><span>getFriendLikes</span><span>(</span><span>postId</span><span>,</span><span> </span><span>{</span><span> limit</span><span>:</span><span> includeAvatars </span><span>?</span><span> </span><span>5</span><span> </span><span>:</span><span> </span><span>2</span><span> </span><span>}),</span></span>
<span data-line=""><span>]);</span></span>
<span data-line=""><span>return</span><span> </span><span>(</span></span>
<span data-line="" data-highlighted-line=""><span>  </span><span>&lt;</span><span>LikeButton</span></span>
<span data-line="" data-highlighted-line=""><span>    totalLikeCount={</span><span>post</span><span>.</span><span>totalLikeCount</span><span>}</span></span>
<span data-line="" data-highlighted-line=""><span>    isLikedByUser={</span><span>post</span><span>.</span><span>isLikedByUser</span><span>}</span></span>
<span data-line="" data-highlighted-line=""><span>    friendLikes={</span><span>friendLikes</span><span>.</span><span>likes</span><span>.</span><span>map</span><span>(</span><span>l</span><span> </span><span>=&gt;</span><span> ({</span></span>
<span data-line="" data-highlighted-line=""><span>      </span><span>firstName</span><span>:</span><span> </span><span>l</span><span>.</span><span>firstName</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>      </span><span>avatar</span><span>:</span><span> includeAvatars </span><span>?</span><span> </span><span>l</span><span>.</span><span>avatar </span><span>:</span><span> </span><span>null</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>    }))}</span></span>
<span data-line=""><span>  /&gt;</span></span>
<span data-line=""><span>);</span></span></code></pre></div></div>
<p>All of the server logic above will execute while generating the JSON. This includes both <code>getPost</code>, <code>parseMarkdown</code>, and <code>getFriendLikes</code>. The response will contain the data <em>for the entire screen</em>, satisfying one of our <a href="#dans-async-ui-framework-checklist">key requirements</a>:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>{</span></span>
<span data-line=""><span>  type: </span><span>&#34;</span><span>PostDetails</span><span>&#34;</span><span>,</span><span> </span><span>// ✅ This is a component on the client</span></span>
<span data-line=""><span>  props: </span><span>{</span></span>
<span data-line=""><span>    postTitle: </span><span>&#34;</span><span>JSX Over The Wire</span><span>&#34;</span><span>,</span></span>
<span data-line=""><span>    </span><span>// ...</span></span>
<span data-line=""><span>    postLikes: </span><span>{</span></span>
<span data-line=""><span>      type: </span><span>&#34;</span><span>LikeButton</span><span>&#34;</span><span>,</span><span> </span><span>// ✅ This is a component on the client</span></span>
<span data-line=""><span>      props: </span><span>{</span></span>
<span data-line=""><span>        totalLikeCount: </span><span>8</span><span>,</span></span>
<span data-line=""><span>        </span><span>// ...</span></span>
<span data-line=""><span>      </span><span>}</span></span>
<span data-line=""><span>    </span><span>}</span></span>
<span data-line=""><span>  </span><span>}</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>From the client’s perspective, everything will appear precomputed:</p>
<div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>function</span><span> </span><span>PostDetails</span><span>(</span><span>{</span></span>
<span data-line=""><span>  postTitle</span><span>,</span></span>
<span data-line=""><span>  postContent</span><span>,</span></span>
<span data-line=""><span>  postAuthor</span><span>,</span></span>
<span data-line="" data-highlighted-line=""><span>  children</span><span>,</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>(</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>article</span><span>&gt;</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>h1</span><span>&gt;{</span><span>postTitle</span><span>}&lt;/</span><span>h1</span><span>&gt;</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>div</span><span> dangerouslySetInnerHTML={{ </span><span>__html</span><span>:</span><span> postContent </span><span>}} /&gt;</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>p</span><span>&gt;</span><span>by </span><span>{</span><span>postAuthor</span><span>.</span><span>name</span><span>}&lt;/</span><span>p</span><span>&gt;</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>section</span><span>&gt;</span></span>
<span data-line="" data-highlighted-line=""><span>        </span><span>{</span><span>children</span><span>}</span></span>
<span data-line=""><span>      </span><span>&lt;/</span><span>section</span><span>&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;/</span><span>article</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>);</span></span>
<span data-line=""><span>}</span></span>
<span data-line=""> </span>
<span data-line=""><span>function</span><span> </span><span>LikeButton</span><span>(</span><span>{ totalLikeCount</span><span>,</span><span> isLikedByUser</span><span>,</span><span> friendLikes }</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>// ...</span></span>
<span data-line=""><span>}</span></span></code></pre></div></div>
<p>In particular, by the time <code>PostDetails</code> runs, the <code>children</code> it receives will be the <code>&lt;LikeButton&gt;</code> tag itself with predefined props. The ViewModels configure the props for the client. <strong>This is why on the client, all the props are “already there”.</strong></p>
<p>Spend some time with the code above and make sure it sinks in.</p>
<p>Yes, this <em>is</em> weird.</p>
<p>It is also glorious.</p>
<p>What we found is a way to compose tags across client-server boundaries where the server parts can be freely wrapped in the client parts, the client parts can be freely wrapped in the server parts, and not only do they <em>just work</em>—we’re also performing the data loading for all of the server parts in <em>a single roundtrip.</em></p>
<p>In fact, this approach satisfies every point on <a href="#dans-async-ui-framework-checklist">my checklist.</a></p>
<p>Now let’s tidy it up and clean up some loose ends.</p>
<hr/>
<h3 id="a-router-viewmodel"><a target="_self" href="#a-router-viewmodel">A Router ViewModel</a></h3>
<p>As we refactor our ViewModels to use JSX (for the JSX-sceptical readers—the point here isn’t just the syntax, although the syntax is nice—but <a href="https://overreacted.io/react-as-a-ui-runtime/#lazy-evaluation">lazy evaluation</a>), we might realize that we don’t actually need separate Express routes for every screen.</p>
<p>Instead, we might want to do something like this:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>app</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>/*</span><span>&#39;</span><span>,</span><span> </span><span>async</span><span> </span><span>(</span><span>req</span><span>,</span><span> res</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const </span><span>url</span><span> </span><span>=</span><span> req</span><span>.</span><span>url</span></span>
<span data-line=""><span>  </span><span>const </span><span>json</span><span> </span><span>=</span><span> await </span><span>toJSON</span><span>(&lt;</span><span>RouterViewModel</span><span> url={</span><span>url</span><span>} /&gt;);</span><span> </span><span>// Evaluate JSX</span></span>
<span data-line=""><span>  </span><span>res</span><span>.</span><span>json</span><span>(</span><span>json</span><span>);</span></span>
<span data-line=""><span>});</span></span></code></pre></div>
<p>Then we’d have a Router ViewModel that matches screens to routes:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>function</span><span> </span><span>RouterViewModel</span><span>(</span><span>{ url }</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>let </span><span>route</span><span>;</span></span>
<span data-line=""><span>  </span><span>if</span><span> </span><span>(</span><span>matchRoute</span><span>(</span><span>url</span><span>,</span><span> </span><span>&#39;</span><span>/screen/post-details/:postId</span><span>&#39;</span><span>))</span><span> </span><span>{</span></span>
<span data-line=""><span>    </span><span>const {</span><span>postId</span><span>} </span><span>=</span><span> </span><span>parseRoute</span><span>(</span><span>url</span><span>,</span><span> </span><span>&#39;</span><span>/screen/post-details/:postId</span><span>&#39;</span><span>);</span></span>
<span data-line=""><span>    route </span><span>=</span><span> </span><span>&lt;</span><span>PostDetailsRouteViewModel</span><span> postId={</span><span>postId</span><span>} /&gt;;</span></span>
<span data-line=""><span>  </span><span>}</span><span> </span><span>else</span><span> </span><span>if</span><span> </span><span>(</span><span>matchRoute</span><span>(</span><span>url</span><span>,</span><span> </span><span>&#39;</span><span>/screen/post-list</span><span>&#39;</span><span>))</span><span> </span><span>{</span></span>
<span data-line=""><span>    route </span><span>=</span><span> </span><span>&lt;</span><span>PostDetailsRouteViewModel</span><span> /&gt;;</span></span>
<span data-line=""><span>  </span><span>}</span></span>
<span data-line=""><span>  </span><span>return</span><span> route</span><span>;</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>And then each route would also be a ViewModel:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>PostDetailsRouteViewModel</span><span>(</span><span>{ postId }</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>&lt;</span><span>PostDetailsViewModel</span><span> postId={</span><span>postId</span><span>} /&gt;</span></span>
<span data-line=""><span>}</span></span>
<span data-line=""> </span>
<span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>PostListRouteViewModel</span><span>(</span><span>{ postId }</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const </span><span>postIds</span><span> </span><span>=</span><span> await </span><span>getRecentPostIds</span><span>();</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>(</span></span>
<span data-line=""><span>    </span><span>&lt;&gt;</span></span>
<span data-line=""><span>      </span><span>{</span><span>postIds</span><span>.</span><span>map</span><span>(</span><span>postId </span><span>=&gt;</span></span>
<span data-line=""><span>        </span><span>&lt;</span><span>PostDetailsViewModel</span><span> key={</span><span>postId</span><span>} postId={</span><span>postId</span><span>} /&gt;</span></span>
<span data-line=""><span>      </span><span>)}</span></span>
<span data-line=""><span>    </span><span>&lt;/&gt;</span></span>
<span data-line=""><span>  </span><span>);</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>On the server, it’s ViewModels all the way down.</p>
<p>This might seem superfluous at this point. But moving the routing logic <em>into</em> the ViewModel world would let <code>RouterViewModel</code> wrap its output into a client-side <code>&lt;Router&gt;</code> that could re-request the JSON when you navigate to another screen.</p>
<div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>function</span><span> </span><span>RouterViewModel</span><span>(</span><span>{ url }</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>let </span><span>route</span><span>;</span></span>
<span data-line=""><span>  </span><span>if</span><span> </span><span>(</span><span>matchRoute</span><span>(</span><span>url</span><span>,</span><span> </span><span>&#39;</span><span>/screen/post-details/:postId</span><span>&#39;</span><span>))</span><span> </span><span>{</span></span>
<span data-line=""><span>    </span><span>const {</span><span>postId</span><span>} </span><span>=</span><span> </span><span>parseRoute</span><span>(</span><span>url</span><span>,</span><span> </span><span>&#39;</span><span>/screen/post-details/:postId</span><span>&#39;</span><span>);</span></span>
<span data-line=""><span>    route </span><span>=</span><span> </span><span>&lt;</span><span>PostDetailsRouteViewModel</span><span> postId={</span><span>postId</span><span>} /&gt;;</span></span>
<span data-line=""><span>  </span><span>}</span><span> </span><span>else</span><span> </span><span>if</span><span> </span><span>(</span><span>matchRoute</span><span>(</span><span>url</span><span>,</span><span> </span><span>&#39;</span><span>/screen/post-list</span><span>&#39;</span><span>))</span><span> </span><span>{</span></span>
<span data-line=""><span>    route </span><span>=</span><span> </span><span>&lt;</span><span>PostDetailsRouteViewModel</span><span> /&gt;;</span></span>
<span data-line=""><span>  </span><span>}</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>(</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>&lt;</span><span>Router</span><span>&gt;</span></span>
<span data-line=""><span>      </span><span>{</span><span>route</span><span>}</span></span>
<span data-line="" data-highlighted-line=""><span>    </span><span>&lt;/</span><span>Router</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>);</span></span>
<span data-line=""><span>}</span></span></code></pre></div></div>
<div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>function</span><span> </span><span>Router</span><span>(</span><span>{ children }</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const [</span><span>tree</span><span>,</span><span> </span><span>setTree</span><span>] </span><span>=</span><span> </span><span>useState</span><span>(</span><span>children</span><span>);</span></span>
<span data-line=""><span>  </span><span>// ... maybe add some logic here later ...</span></span>
<span data-line=""><span>  </span><span>return</span><span> tree</span><span>;</span></span>
<span data-line=""><span>}</span></span></code></pre></div></div>
<p>This could also let us—if we wanted to—implement a more granular router that can split the path into segments, prepare the ViewModels for each segment in parallel when it receives a request, and even re-request individual segments on navigation. This way, we would no longer have to re-request the entire page whenever we need to go to another screen. Of course, we wouldn’t want to implement this kind of logic <em>within</em> the app. Ideally, a framework would do this.</p>
<hr/>
<h3 id="server-and-client-components"><a target="_self" href="#server-and-client-components">Server and Client Components</a></h3>
<p>We can drop the pretense now—we’re describing React Server Components:</p>
<ul>
<li>Our “ViewModels” are Server Components.</li>
<li>Our “Components” are Client Components.</li>
</ul>
<p>There are good reasons to call both of them Components. Although in the first part of this post, Server Components <a href="#composable-bff">began their journey as ViewModels</a>, their lineage can be equally convincingly traced back to <a href="#async-xhp">Async XHP tags</a>. Since they no longer have to return JSON objects, and because in practice you’ll often import the same components from both “sides”, it makes sense to say Components. (In fact, in my incomplete example, all Client Components could be moved to the Server.)</p>
<p>In this post, we haven’t discussed the actual mechanism “connecting” the module systems of Server and Client worlds. This will be a topic for another post, but in short, when you <code>import</code> something from a module with <code>&#39;use client&#39;</code>, you don’t get the real thing—you just get a <em>reference</em> which describes <em>how to load</em> it.</p>
<div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line="" data-highlighted-line=""><span>import</span><span> </span><span>{</span><span> LikeButton </span><span>}</span><span> </span><span>from</span><span> </span><span>&#39;</span><span>./LikeButton</span><span>&#39;</span><span>;</span></span>
<span data-line=""> </span>
<span data-line="" data-highlighted-line=""><span>console</span><span>.</span><span>log</span><span>(</span><span>LikeButton</span><span>);</span></span>
<span data-line="" data-highlighted-line=""><span>// &#34;src/LikeButton.js#LikeButton&#34;</span></span>
<span data-line=""> </span>
<span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>LikeButtonViewModel</span><span>(</span><span>{</span></span>
<span data-line=""><span>  postId</span><span>,</span></span>
<span data-line=""><span>  includeAvatars</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>  </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line=""><span>  </span><span>getFriendLikes</span><span>(</span><span>postId</span><span>,</span><span> </span><span>{</span><span> limit</span><span>:</span><span> includeAvatars </span><span>?</span><span> </span><span>5</span><span> </span><span>:</span><span> </span><span>2</span><span> </span><span>}),</span></span>
<span data-line=""><span>]);</span></span>
<span data-line=""><span>return</span><span> </span><span>(</span></span>
<span data-line=""><span>  </span><span>&lt;</span><span>LikeButton</span></span>
<span data-line=""><span>    totalLikeCount={</span><span>post</span><span>.</span><span>totalLikeCount</span><span>}</span></span>
<span data-line=""><span>    isLikedByUser={</span><span>post</span><span>.</span><span>isLikedByUser</span><span>}</span></span>
<span data-line=""><span>    friendLikes={</span><span>friendLikes</span><span>.</span><span>likes</span><span>.</span><span>map</span><span>(</span><span>l</span><span> </span><span>=&gt;</span><span> ({</span></span>
<span data-line=""><span>      </span><span>firstName</span><span>:</span><span> </span><span>l</span><span>.</span><span>firstName</span><span>,</span></span>
<span data-line=""><span>      </span><span>avatar</span><span>:</span><span> includeAvatars </span><span>?</span><span> </span><span>l</span><span>.</span><span>avatar </span><span>:</span><span> </span><span>null</span><span>,</span></span>
<span data-line=""><span>    }))}</span></span>
<span data-line=""><span>  /&gt;</span></span>
<span data-line=""><span>);</span></span></code></pre></div></div>
<div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line="" data-highlighted-line=""><span>&#39;</span><span>use client</span><span>&#39;</span><span>;</span></span>
<span data-line=""> </span>
<span data-line="" data-highlighted-line=""><span>export</span><span> </span><span>function</span><span> </span><span>LikeButton</span><span>(</span><span>{</span></span>
<span data-line=""><span>  totalLikeCount</span><span>,</span></span>
<span data-line=""><span>  isLikedByUser</span><span>,</span></span>
<span data-line=""><span>  friendLikes</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>let </span><span>buttonText</span><span> </span><span>=</span><span> </span><span>&#39;</span><span>Like</span><span>&#39;</span><span>;</span></span>
<span data-line=""><span>  </span><span>if</span><span> </span><span>(</span><span>totalLikeCount </span><span>&gt;</span><span> </span><span>0</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>    </span><span>// e.g. &#34;Liked by You, Alice, and 13 others&#34;</span></span>
<span data-line=""><span>    buttonText </span><span>=</span><span> </span><span>formatLikeText</span><span>(</span><span>totalLikeCount</span><span>,</span><span> isLikedByUser</span><span>,</span><span> friendLikes</span><span>);</span></span>
<span data-line=""><span>  </span><span>}</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>(</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>button</span><span> className={</span><span>isLikedByUser</span><span> ? </span><span>&#39;</span><span>liked</span><span>&#39;</span><span> : </span><span>&#39;&#39;</span><span>}&gt;</span></span>
<span data-line=""><span>      </span><span>{</span><span>buttonText</span><span>}</span></span>
<span data-line=""><span>    </span><span>&lt;/</span><span>button</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>);</span></span>
<span data-line=""><span>}</span></span></code></pre></div></div>
<p>So the generated JSON will contain an instruction for loading the <code>LikeButton</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>{</span></span>
<span data-line="" data-highlighted-line=""><span>  type: </span><span>&#34;</span><span>src/LikeButton.js#LikeButton</span><span>&#34;</span><span>,</span><span> </span><span>// ✅ This is a Client Component</span></span>
<span data-line=""><span>  props: </span><span>{</span></span>
<span data-line=""><span>    totalLikeCount: </span><span>8</span><span>,</span></span>
<span data-line=""><span>    </span><span>// ...</span></span>
<span data-line=""><span>  </span><span>}</span></span>
<span data-line=""><span>}</span></span></code></pre></div>
<p>React will read that instruction and load it as a <code>&lt;script&gt;</code> tag (or read it from the bundler cache). The format is bundler-specific, which explains why React Server Components requires a bundler integration. (<a target="_blank" href="https://parceljs.org/recipes/rsc/">Parcel just released theirs</a> which isn’t tied to a framework, so it’s perfect if you want to play with how RSC works.)</p>
<p>It’s important that React Server Components emit JSON rather than HTML:</p>
<ul>
<li>Server tree can be refetched in-place without losing state. (React will just do its “virtual DOM” thing, i.e. apply the new props to the already existing components.)</li>
<li>You can target other platforms than web. (Here’s a <a target="_blank" href="https://www.youtube.com/watch?v=djhEgxQf3Kw">cool demo</a>.)</li>
<li>You can still turn that JSON into HTML by executing all the Client Components within it! That’s not <em>required</em> by RSC, but it is definitely doable. That’s why “Client” components may run on the “server”—to output HTML, you’d run both “sides”.</li>
</ul>
<p>To conclude this post, I’ll say the following. I know that React Server Components have not been everyone’s cup of tea. It twists your brain but I think it twists it in a good way. I’ll be posting more about why I’m excited about RSC and will try to distill some of these explanations into shorter posts. But in the meantime, I hope that this post provided some historical background on the <em>motivation</em> behind RSC, <a href="#dans-async-ui-framework-checklist">what it can do</a>, as well as how you could arrive at RSC through your own thinking.</p>
<p>(By the way, if you enjoy more philosophical and whimsical longreads, check out my <a href="https://overreacted.io/react-for-two-computers/">last post</a> which arrives at RSC from the first principles without any history.)</p>
<hr/>
<h3 id="recap-jsx-over-the-wire"><a target="_self" href="#recap-jsx-over-the-wire">Recap: JSX Over The Wire</a></h3>
<ul>
<li>React Server Components solve the <a href="#recap-json-as-components">problems outlined in the first part</a> by using <a href="#recap-components-as-json">techniques outlined in the second part</a>. In particular, they let you “componentize” the UI-specific parts of your API and ensure they evolve together with your UI.</li>
<li>This means that there is a direct connection between your components and the server code that prepares their props. You can always “Find All References” to find from where on the server the data is flowing into each of your components.</li>
<li>Because React Server Components emit JSON, they don’t “blow away” the state of the page on refetches. Your components can receive fresh props from the server.</li>
<li>React Server Components emit JSON, but that JSON can <em>also</em> be (optionally) turned to HTML for first render. It’s easy to make HTML out of JSON, but not the inverse.</li>
<li>React Server Components let you create self-contained pieces of UI that take care of preparing their own server data. However, all this preparation occurs within a single roundtrip. Although your code is modular, their execution is coalesced.</li>
<li>RSC is mindbending, I won’t lie. Sometimes you have to think inside-out. But personally, I think RSC is awesome. The tooling is still evolving but I’m excited for its future. I hope to see more technologies thoughtfully blending the boundaries.</li>
</ul>
<hr/>
<h3 id="final-code-slightly-edited"><a target="_self" href="#final-code-slightly-edited">Final Code, Slightly Edited</a></h3>
<p>While this isn’t a <em>runnable</em> application (I bet <em>you</em> could get there with <a target="_blank" href="https://nextjs.org/">Next</a> or <a target="_blank" href="https://parceljs.org/recipes/rsc/">Parcel</a>) and might contain mistakes, here’s the complete code example. I’ve done a few renames to drop the “ViewModel” terminology so it looks more idiomatic.</p>
<div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>import</span><span> </span><span>{</span><span> PostDetails</span><span>,</span><span> LikeButton </span><span>}</span><span> </span><span>from</span><span> </span><span>&#39;</span><span>./client</span><span>&#39;</span><span>;</span></span>
<span data-line=""> </span>
<span data-line=""><span>export</span><span> </span><span>function</span><span> </span><span>PostDetailsRoute</span><span>(</span><span>{ postId }</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>&lt;</span><span>Post</span><span> postId={</span><span>postId</span><span>} /&gt;</span></span>
<span data-line=""><span>}</span></span>
<span data-line=""> </span>
<span data-line=""><span>export</span><span> </span><span>async</span><span> </span><span>function</span><span> </span><span>PostListRoute</span><span>(</span><span>{ postId }</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const </span><span>postIds</span><span> </span><span>=</span><span> await </span><span>getRecentPostIds</span><span>();</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>(</span></span>
<span data-line=""><span>    </span><span>&lt;&gt;</span></span>
<span data-line=""><span>      </span><span>{</span><span>postIds</span><span>.</span><span>map</span><span>(</span><span>postId </span><span>=&gt;</span></span>
<span data-line=""><span>        </span><span>&lt;</span><span>Post</span><span> key={</span><span>postId</span><span>} postId={</span><span>postId</span><span>} /&gt;</span></span>
<span data-line=""><span>      </span><span>)}</span></span>
<span data-line=""><span>    </span><span>&lt;/&gt;</span></span>
<span data-line=""><span>  </span><span>);</span></span>
<span data-line=""><span>}</span></span>
<span data-line=""> </span>
<span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>Post</span><span>(</span><span>{</span></span>
<span data-line=""><span>  postId</span><span>,</span></span>
<span data-line=""><span>  truncateContent</span><span>,</span></span>
<span data-line=""><span>  includeAvatars</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>const </span><span>post</span><span> </span><span>=</span><span> await </span><span>getPost</span><span>(</span><span>postId</span><span>);</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>(</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>PostLayout</span></span>
<span data-line=""><span>      postTitle={</span><span>post</span><span>.</span><span>title</span><span>}</span></span>
<span data-line=""><span>      postContent={</span><span>parseMarkdown</span><span>(</span><span>post</span><span>.</span><span>content</span><span>, {</span></span>
<span data-line=""><span>        </span><span>maxParagraphs</span><span>:</span><span> truncateContent </span><span>?</span><span> </span><span>1</span><span> </span><span>:</span><span> </span><span>undefined</span></span>
<span data-line=""><span>      </span><span>})}</span></span>
<span data-line=""><span>      postAuthor={</span><span>post</span><span>.</span><span>author</span><span>}</span></span>
<span data-line=""><span>    &gt;</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>PostLikeButton</span></span>
<span data-line=""><span>        postId={</span><span>postId</span><span>}</span></span>
<span data-line=""><span>        includeAvatars={</span><span>includeAvatars</span><span>}</span></span>
<span data-line=""><span>      /&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;/</span><span>PostLayout</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>);</span></span>
<span data-line=""><span>}</span></span>
<span data-line=""> </span>
<span data-line=""><span>async</span><span> </span><span>function</span><span> </span><span>PostLikeButton</span><span>(</span><span>{</span></span>
<span data-line=""><span>  postId</span><span>,</span></span>
<span data-line=""><span>  includeAvatars</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>const [</span><span>post</span><span>,</span><span> </span><span>friendLikes</span><span>] </span><span>=</span><span> await </span><span>Promise</span><span>.</span><span>all</span><span>([</span></span>
<span data-line=""><span>  </span><span>getPost</span><span>(</span><span>postId</span><span>),</span></span>
<span data-line=""><span>  </span><span>getFriendLikes</span><span>(</span><span>postId</span><span>,</span><span> </span><span>{</span><span> limit</span><span>:</span><span> includeAvatars </span><span>?</span><span> </span><span>5</span><span> </span><span>:</span><span> </span><span>2</span><span> </span><span>}),</span></span>
<span data-line=""><span>]);</span></span>
<span data-line=""><span>return</span><span> </span><span>(</span></span>
<span data-line=""><span>  </span><span>&lt;</span><span>LikeButton</span></span>
<span data-line=""><span>    totalLikeCount={</span><span>post</span><span>.</span><span>totalLikeCount</span><span>}</span></span>
<span data-line=""><span>    isLikedByUser={</span><span>post</span><span>.</span><span>isLikedByUser</span><span>}</span></span>
<span data-line=""><span>    friendLikes={</span><span>friendLikes</span><span>.</span><span>likes</span><span>.</span><span>map</span><span>(</span><span>l</span><span> </span><span>=&gt;</span><span> ({</span></span>
<span data-line=""><span>      </span><span>firstName</span><span>:</span><span> </span><span>l</span><span>.</span><span>firstName</span><span>,</span></span>
<span data-line=""><span>      </span><span>avatar</span><span>:</span><span> includeAvatars </span><span>?</span><span> </span><span>l</span><span>.</span><span>avatar </span><span>:</span><span> </span><span>null</span><span>,</span></span>
<span data-line=""><span>    }))}</span></span>
<span data-line=""><span>  /&gt;</span></span>
<span data-line=""><span>);</span></span></code></pre></div></div>
<div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" data-language="js" data-theme="default"><code data-language="js" data-theme="default"><span data-line=""><span>&#39;</span><span>use client</span><span>&#39;</span><span>;</span></span>
<span data-line=""> </span>
<span data-line=""><span>export</span><span> </span><span>function</span><span> </span><span>PostLayout</span><span>(</span><span>{</span></span>
<span data-line=""><span>  postTitle</span><span>,</span></span>
<span data-line=""><span>  postContent</span><span>,</span></span>
<span data-line=""><span>  postAuthor</span><span>,</span></span>
<span data-line=""><span>  children</span><span>,</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>(</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>article</span><span>&gt;</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>h1</span><span>&gt;{</span><span>postTitle</span><span>}&lt;/</span><span>h1</span><span>&gt;</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>div</span><span> dangerouslySetInnerHTML={{ </span><span>__html</span><span>:</span><span> postContent </span><span>}} /&gt;</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>p</span><span>&gt;</span><span>by </span><span>{</span><span>postAuthor</span><span>.</span><span>name</span><span>}&lt;/</span><span>p</span><span>&gt;</span></span>
<span data-line=""><span>      </span><span>&lt;</span><span>section</span><span>&gt;</span></span>
<span data-line=""><span>        </span><span>{</span><span>children</span><span>}</span></span>
<span data-line=""><span>      </span><span>&lt;/</span><span>section</span><span>&gt;</span></span>
<span data-line=""><span>    </span><span>&lt;/</span><span>article</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>);</span></span>
<span data-line=""><span>}</span></span>
<span data-line=""> </span>
<span data-line=""><span>export</span><span> </span><span>function</span><span> </span><span>LikeButton</span><span>(</span><span>{</span></span>
<span data-line=""><span>  totalLikeCount</span><span>,</span></span>
<span data-line=""><span>  isLikedByUser</span><span>,</span></span>
<span data-line=""><span>  friendLikes</span></span>
<span data-line=""><span>}</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>  </span><span>let </span><span>buttonText</span><span> </span><span>=</span><span> </span><span>&#39;</span><span>Like</span><span>&#39;</span><span>;</span></span>
<span data-line=""><span>  </span><span>if</span><span> </span><span>(</span><span>totalLikeCount </span><span>&gt;</span><span> </span><span>0</span><span>)</span><span> </span><span>{</span></span>
<span data-line=""><span>    buttonText </span><span>=</span><span> </span><span>formatLikeText</span><span>(</span><span>totalLikeCount</span><span>,</span><span> isLikedByUser</span><span>,</span><span> friendLikes</span><span>);</span></span>
<span data-line=""><span>  </span><span>}</span></span>
<span data-line=""><span>  </span><span>return</span><span> </span><span>(</span></span>
<span data-line=""><span>    </span><span>&lt;</span><span>button</span><span> className={</span><span>isLikedByUser</span><span> ? </span><span>&#39;</span><span>liked</span><span>&#39;</span><span> : </span><span>&#39;&#39;</span><span>}&gt;</span></span>
<span data-line=""><span>      </span><span>{</span><span>buttonText</span><span>}</span></span>
<span data-line=""><span>    </span><span>&lt;/</span><span>button</span><span>&gt;</span></span>
<span data-line=""><span>  </span><span>);</span></span>
<span data-line=""><span>}</span></span></code></pre></div></div>
<p>Happy stitching!</p></div></div>
  </body>
</html>
