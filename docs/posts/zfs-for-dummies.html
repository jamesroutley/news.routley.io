<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ikrima.dev/dev-notes/homelab/zfs-for-dummies/">Original</a>
    <h1>ZFS for Dummies</h1>
    
    <div id="readability-page-1" class="page"><div data-md-component="main">
        <div>
          
            
              
              
            
            
              
              
            
          
          
            <div data-md-component="content">
              <article>
                
                  

  
    <a href="https://github.com/ikrima/gamedevguide/blob/master/docs/dev-notes/homelab/zfs-for-dummies.md" title="Edit this page">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"></path></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/ikrima/gamedevguide/raw/master/docs/dev-notes/homelab/zfs-for-dummies.md" title="View source of this page">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.15 8.15 0 0 1-1.23-2Z"></path></svg>
    </a>
  



<p>As mentioned on previous posts, I have spent the past few weeks dealing with a ZFS crash on my FreeNAS install. Because of that, not only was I forced to learn how to troubleshoot ZFS, but I also had to learn how to setup new volumes and come up with new backup strategies (between a few other things).</p>
<p>This was a great opportunity for me to learn more about ZFS (because I new ‘nada’ to start with). And I’m happy to share some of the knowledge that I gathered with you on this post.</p>
<p>Please keep in mind that I don’t consider myself an expert on ZFS (not even close), but I will try to make things simple and easy to understand for someone, who like me, is just getting started with ZFS.</p>
<h2 id="about-zfs">About ZFS<a href="#about-zfs" title="Permanent link">#</a></h2>
<h4 id="what-is-zfs-and-its-history">What is ZFS and It’s History<a href="#what-is-zfs-and-its-history" title="Permanent link">#</a></h4>
<p>ZFS is a local filesystem (i.e.: ext4, NTFS, exfat) and logical volume manager (i.e.: LVM on Linux) created by Sun Microsystems. ZFS was published under an open source license until Oracle bought Sun Microsystems and closed source the license. Because the source code was already in the open and ported to different OSs, eventually a project called ‘OpenZFS’ was created, and that is the core code that is used on most Unix like systems today (Linux, FreeBSD, etc.).</p>
<h3 id="zfs-components">ZFS Components<a href="#zfs-components" title="Permanent link">#</a></h3>
<p><a href="https://macwright.com/2023/_assets/homelab/zfs-for-dummies/zfs-components.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="" src="https://macwright.com/2023/_assets/homelab/zfs-for-dummies/zfs-components.png"/></a></p>
<h4 id="vdev">vdev<a href="#vdev" title="Permanent link">#</a></h4>
<p>A vdev is composed of one or more physical drives (can also be of things other than hard drive, like files). They can be combined together in mirrors or RAIDZs.</p>
<p><a href="https://macwright.com/2023/_assets/homelab/zfs-for-dummies/vdev.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="" src="https://macwright.com/2023/_assets/homelab/zfs-for-dummies/vdev.png"/></a></p>
<p>💡 <em><strong>TIP:</strong> There are 7 different types of vdevs, and some of them (like host spare, L2ARC and ZIL) are very important.</em></p>
<h4 id="pool">Pool<a href="#pool" title="Permanent link">#</a></h4>
<p>A pool is composed of one or more vdevs and they usually contain a volume or a dataset (which you create after creating the pool). You create/define your vdevs when you create a pool (with the <code>zpool</code> command which we’ll see later). This allows you to mix vdev types together to achieve other RAIDZ levels (see example below):</p>
<p><a href="https://macwright.com/2023/_assets/homelab/zfs-for-dummies/raid10.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="" src="https://macwright.com/2023/_assets/homelab/zfs-for-dummies/raid10.png"/></a></p>
<h4 id="datasets">Datasets<a href="#datasets" title="Permanent link">#</a></h4>
<p>Dataset is the filesystem part of ZFS (so far we’ve seen the LVM components). Here you can define user access, quotas, compression, snapshots, etc…</p>
<h4 id="volume">Volume<a href="#volume" title="Permanent link">#</a></h4>
<p>Volume is the brother of datasets but in a block device representation. It provides some of the features that datasets have, but not all. Volumes can be useful to run other filesystems on top of ZFS, or to export iSCSI extents.</p>
<h3 id="raidz-types">RAIDZ Types<a href="#raidz-types" title="Permanent link">#</a></h3>
<ul>
<li>Dynamic/Simple Stripe (RAID0) - Distributes data without parity. Loosing a device means loosing all data</li>
<li>MIRROR (RAID1) - Mirrored drives. Used with 2 to 4 disks (or more)</li>
<li>RAIDZ-1 (RAID5) - Distributes parity along with the data and can lose one physical drive before a raid failure. RAIDZ requires at least 3 disks</li>
<li>RAIDZ-2 (RAID6) - Distributes parity along with the data and can lose up to 2 physical drives. RAIDZ-2 requires at least 4 disks</li>
<li>RAIDZ-3 - Distributes parity along with the data and can lose up to 3 physical drives. RAIDZ-3 requires at least 4, but should be used with no less than 5 disks</li>
</ul>
<p><a href="https://macwright.com/2023/_assets/homelab/zfs-for-dummies/raidz-comparisson.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="" src="https://macwright.com/2023/_assets/homelab/zfs-for-dummies/raidz-comparisson.png"/></a></p>
<hr/>
<h2 id="commands">Commands<a href="#commands" title="Permanent link">#</a></h2>
<p>Let’s take a look at the most common commands for handling ZFS pools and filesystem. We’ll use <code>/dev/sdx</code> to refer to device names, but keep in mind that using the device UUID is preferred in order to avoid boot issues due to device name changes.</p>
<h3 id="1zfs-pool-commands">1.ZFS Pool Commands<a href="#1zfs-pool-commands" title="Permanent link">#</a></h3>
<p>These are the commands related to creating vdevs and pools. We will be looking at:</p>
<ul>
<li><code>zpool create</code> - Create a pool (and vdevs)</li>
<li><code>zpool status</code> - Displays pool status</li>
<li><code>zpool list</code> - List pool and it’s details</li>
<li><code>zpool history</code> - Shows history of commands for zpool</li>
<li><code>zpool import</code>- Imports and mounts pool</li>
<li><code>zpool export</code> - Exports and unmounts pool</li>
<li><code>zpool destroy</code> - Destroy pool and all filesystems</li>
<li><code>zpool scrub</code> - Starts scrub of pool</li>
</ul>
<h4 id="11creating-a-pool-and-vdevs">1.1.Creating a Pool (and vdevs)<a href="#11creating-a-pool-and-vdevs" title="Permanent link">#</a></h4>
<p>To create a new pool we use the <code>zpool create</code> command. We specify the pool name and the device we want to use.</p>
<p>It’s basic usage is:</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-0-1"><span data-linenos="1 "></span># zpool create [pool] [devices]
</span></code></pre></div>
<p>Now let’s look at different examples for this command.</p>
<h5 id="create-a-pool-on-a-single-disk"><strong>Create a pool on a single disk</strong><a href="#create-a-pool-on-a-single-disk" title="Permanent link">#</a></h5>
<p>The command below creates a pool on a single disk.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-1-1"><span data-linenos="1 "></span># zpool create tank /dev/sdb  
</span></code></pre></div>
<h5 id="create-a-dynamic-stripe-pool-on-3-disks"><strong>Create a dynamic stripe pool on 3 disks</strong><a href="#create-a-dynamic-stripe-pool-on-3-disks" title="Permanent link">#</a></h5>
<p>Remember that dynamic stripe is the same as RAID0 and that it has no parity.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-2-1"><span data-linenos="1 "></span># zpool create tank /dev/sdb /dev/sdc /dev/sdd
</span></code></pre></div>
<p>We can view the new pool with <code>zpool status</code></p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-3-1"><span data-linenos=" 1 "></span>root@ubuntu-vm:~# zpool status
</span><span id="__span-3-2"><span data-linenos=" 2 "></span>  pool: tank
</span><span id="__span-3-3"><span data-linenos=" 3 "></span> state: ONLINE
</span><span id="__span-3-4"><span data-linenos=" 4 "></span>  scan: none requested
</span><span id="__span-3-5"><span data-linenos=" 5 "></span>config:
</span><span id="__span-3-6"><span data-linenos=" 6 "></span>
</span><span id="__span-3-7"><span data-linenos=" 7 "></span>NAME        STATE     READ WRITE CKSUM
</span><span id="__span-3-8"><span data-linenos=" 8 "></span>tank        ONLINE       0     0     0
</span><span id="__span-3-9"><span data-linenos=" 9 "></span>  sdb       ONLINE       0     0     0
</span><span id="__span-3-10"><span data-linenos="10 "></span>  sdc       ONLINE       0     0     0
</span><span id="__span-3-11"><span data-linenos="11 "></span>  sdd       ONLINE       0     0     0
</span><span id="__span-3-12"><span data-linenos="12 "></span>
</span><span id="__span-3-13"><span data-linenos="13 "></span>errors: No known data errors
</span></code></pre></div>
<p>Note that the pool name is ‘tank’ and the vdevs are ‘sdb’, ‘sdc’ and ‘sdd’</p>
<h5 id="create-a-mirrorred-pool-on-2-disks"><strong>Create a mirrorred pool on 2 disks</strong><a href="#create-a-mirrorred-pool-on-2-disks" title="Permanent link">#</a></h5>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-4-1"><span data-linenos="1 "></span># zpool create tank mirror sdb sdc
</span></code></pre></div>
<p>Note that I can omit <code>/dev</code> and give the device name. Let’s view the result.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-5-1"><span data-linenos=" 1 "></span># zpool status
</span><span id="__span-5-2"><span data-linenos=" 2 "></span>  pool: tank
</span><span id="__span-5-3"><span data-linenos=" 3 "></span> state: ONLINE
</span><span id="__span-5-4"><span data-linenos=" 4 "></span>  scan: none requested
</span><span id="__span-5-5"><span data-linenos=" 5 "></span>config:
</span><span id="__span-5-6"><span data-linenos=" 6 "></span>
</span><span id="__span-5-7"><span data-linenos=" 7 "></span>NAME        STATE     READ WRITE CKSUM
</span><span id="__span-5-8"><span data-linenos=" 8 "></span>tank        ONLINE       0     0     0
</span><span id="__span-5-9"><span data-linenos=" 9 "></span>  mirror-0  ONLINE       0     0     0
</span><span id="__span-5-10"><span data-linenos="10 "></span>    sdb     ONLINE       0     0     0
</span><span id="__span-5-11"><span data-linenos="11 "></span>    sdc     ONLINE       0     0     0
</span><span id="__span-5-12"><span data-linenos="12 "></span>
</span><span id="__span-5-13"><span data-linenos="13 "></span>errors: No known data errors
</span></code></pre></div>
<p>Our vdev is ‘mirror-0’ and our pool is tank.</p>
<h5 id="create-a-raid-z-pool"><strong>Create a RAID-Z pool</strong><a href="#create-a-raid-z-pool" title="Permanent link">#</a></h5>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-6-1"><span data-linenos="1 "></span># zpool create tank raidz sdb sdc sdd
</span></code></pre></div>
<p>And the result indicating that my vdev is RAIDZ1.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-7-1"><span data-linenos=" 1 "></span>root@ubuntu-vm:~# zpool status
</span><span id="__span-7-2"><span data-linenos=" 2 "></span>  pool: tank
</span><span id="__span-7-3"><span data-linenos=" 3 "></span> state: ONLINE
</span><span id="__span-7-4"><span data-linenos=" 4 "></span>  scan: none requested
</span><span id="__span-7-5"><span data-linenos=" 5 "></span>config:
</span><span id="__span-7-6"><span data-linenos=" 6 "></span>
</span><span id="__span-7-7"><span data-linenos=" 7 "></span>NAME        STATE     READ WRITE CKSUM
</span><span id="__span-7-8"><span data-linenos=" 8 "></span>tank        ONLINE       0     0     0
</span><span id="__span-7-9"><span data-linenos=" 9 "></span>  raidz1-0  ONLINE       0     0     0
</span><span id="__span-7-10"><span data-linenos="10 "></span>    sdb     ONLINE       0     0     0
</span><span id="__span-7-11"><span data-linenos="11 "></span>    sdc     ONLINE       0     0     0
</span><span id="__span-7-12"><span data-linenos="12 "></span>    sdd     ONLINE       0     0     0
</span><span id="__span-7-13"><span data-linenos="13 "></span>
</span><span id="__span-7-14"><span data-linenos="14 "></span>errors: No known data errors
</span></code></pre></div>
<p>You can use the same command to create RAIDZ2,3 pools.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-8-1"><span data-linenos="1 "></span># zpool create [pool name] raidz[1,2,3] [devices]
</span></code></pre></div>
<h5 id="specifying-a-default-mount-point-for-the-pool"><strong>Specifying a default mount point for the pool</strong><a href="#specifying-a-default-mount-point-for-the-pool" title="Permanent link">#</a></h5>
<p>You can also specify the default mount point for the pool by using the <code>-m</code> flag as you create it.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-9-1"><span data-linenos="1 "></span># zpool create tank -m /mnt/tank mirror sdb sdc
</span></code></pre></div>
<p>We can see that our new pool was created and mounted at <code>/mnt/tank</code></p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-10-1"><span data-linenos="1 "></span># zfs list
</span><span id="__span-10-2"><span data-linenos="2 "></span>NAME   USED  AVAIL     REFER  MOUNTPOINT
</span><span id="__span-10-3"><span data-linenos="3 "></span>tank    99K  4.36G       24K  /mnt/tank
</span></code></pre></div>
<p>💡 <em><strong>TIP:</strong> Also read up on the <code>zpool add</code> command.</em></p>
<h4 id="12getting-pool-status">1.2.Getting Pool Status<a href="#12getting-pool-status" title="Permanent link">#</a></h4>
<p>After we create a new pool it’s automatically imported into our system. As we have seen before, we can view details of the pool with the <code>zpool status</code> command.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-11-1"><span data-linenos=" 1 "></span># zpool status tank
</span><span id="__span-11-2"><span data-linenos=" 2 "></span>  pool: tank
</span><span id="__span-11-3"><span data-linenos=" 3 "></span> state: ONLINE
</span><span id="__span-11-4"><span data-linenos=" 4 "></span>  scan: none requested
</span><span id="__span-11-5"><span data-linenos=" 5 "></span>config:
</span><span id="__span-11-6"><span data-linenos=" 6 "></span>
</span><span id="__span-11-7"><span data-linenos=" 7 "></span>NAME        STATE     READ WRITE CKSUM
</span><span id="__span-11-8"><span data-linenos=" 8 "></span>tank        ONLINE       0     0     0
</span><span id="__span-11-9"><span data-linenos=" 9 "></span>  mirror-0  ONLINE       0     0     0
</span><span id="__span-11-10"><span data-linenos="10 "></span>    sdb     ONLINE       0     0     0
</span><span id="__span-11-11"><span data-linenos="11 "></span>    sdc     ONLINE       0     0     0
</span><span id="__span-11-12"><span data-linenos="12 "></span>
</span><span id="__span-11-13"><span data-linenos="13 "></span>errors: No known data errors
</span></code></pre></div>
<p>Some of the fields we did not look before are:</p>
<ul>
<li><code>state:</code> Indicates if pool is online or not</li>
<li><code>status:</code> Additional information about the pool</li>
<li><code>action:</code> Indicates if there are any pending actions for the pool</li>
<li><code>scan:</code> If a scrub is in progress or the last scrub run status</li>
<li><code>errors:</code> Indicates if there are any problems with the pool</li>
</ul>
<p>For example:</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-12-1"><span data-linenos=" 1 "></span># zpool status tank
</span><span id="__span-12-2"><span data-linenos=" 2 "></span>  pool: tank
</span><span id="__span-12-3"><span data-linenos=" 3 "></span> state: ONLINE
</span><span id="__span-12-4"><span data-linenos=" 4 "></span>status: Some supported features are not enabled on the pool. The pool can
</span><span id="__span-12-5"><span data-linenos=" 5 "></span>        still be used, but some features are unavailable.
</span><span id="__span-12-6"><span data-linenos=" 6 "></span>action: Enable all features using &#39;zpool upgrade&#39;. Once this is done,
</span><span id="__span-12-7"><span data-linenos=" 7 "></span>        the pool may no longer be accessible by software that does not support
</span><span id="__span-12-8"><span data-linenos=" 8 "></span>        the features. See zpool-features(7) for details.
</span><span id="__span-12-9"><span data-linenos=" 9 "></span>  scan: scrub repaired 0 in 0 days 03:37:12 with 0 errors on Wed Oct 28 03:37:13 2020
</span><span id="__span-12-10"><span data-linenos="10 "></span>config:
</span><span id="__span-12-11"><span data-linenos="11 "></span>
</span><span id="__span-12-12"><span data-linenos="12 "></span>NAME        STATE     READ WRITE CKSUM
</span><span id="__span-12-13"><span data-linenos="13 "></span>tank        ONLINE       0     0     0
</span><span id="__span-12-14"><span data-linenos="14 "></span>  mirror-0  ONLINE       0     0     0
</span><span id="__span-12-15"><span data-linenos="15 "></span>    sdb     ONLINE       0     0     0
</span><span id="__span-12-16"><span data-linenos="16 "></span>    sdc     ONLINE       0     0     0
</span><span id="__span-12-17"><span data-linenos="17 "></span>
</span><span id="__span-12-18"><span data-linenos="18 "></span>errors: No known data errors
</span></code></pre></div>
<p>Another example:</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-13-1"><span data-linenos=" 1 "></span># zpool status -v tank
</span><span id="__span-13-2"><span data-linenos=" 2 "></span>  pool: tank
</span><span id="__span-13-3"><span data-linenos=" 3 "></span> state: ONLINE
</span><span id="__span-13-4"><span data-linenos=" 4 "></span>status: One or more devices has experienced an error resulting in data
</span><span id="__span-13-5"><span data-linenos=" 5 "></span>    corruption.  Applications may be affected.
</span><span id="__span-13-6"><span data-linenos=" 6 "></span>action: Restore the file in question if possible.  Otherwise restore the
</span><span id="__span-13-7"><span data-linenos=" 7 "></span>    entire pool from backup.
</span><span id="__span-13-8"><span data-linenos=" 8 "></span>   see: http://illumos.org/msg/ZFS-8000-8A
</span><span id="__span-13-9"><span data-linenos=" 9 "></span>  scan: scrub repaired 0 in 0 days 04:21:43 with 0 errors on Sun Feb 23 04:21:45 2020
</span><span id="__span-13-10"><span data-linenos="10 "></span>config:
</span><span id="__span-13-11"><span data-linenos="11 "></span>
</span><span id="__span-13-12"><span data-linenos="12 "></span>NAME        STATE     READ WRITE CKSUM
</span><span id="__span-13-13"><span data-linenos="13 "></span>tank        ONLINE       0     0     0
</span><span id="__span-13-14"><span data-linenos="14 "></span>  mirror-0  ONLINE       0     0     0
</span><span id="__span-13-15"><span data-linenos="15 "></span>    sdb     ONLINE       0     0     0
</span><span id="__span-13-16"><span data-linenos="16 "></span>    sdc     ONLINE       0     0     0
</span><span id="__span-13-17"><span data-linenos="17 "></span>
</span><span id="__span-13-18"><span data-linenos="18 "></span>errors: Permanent errors have been detected in the following files:
</span><span id="__span-13-19"><span data-linenos="19 "></span>
</span><span id="__span-13-20"><span data-linenos="20 "></span>        tank:&lt;0xdcca&gt;
</span></code></pre></div>
<h4 id="13listing-pools">1.3.Listing Pools<a href="#13listing-pools" title="Permanent link">#</a></h4>
<p>As we have seen before, we can view some details of the pool with the <code>zpool status</code> command. But there are other commands, like <code>zpool list</code> that can give us information about the pool.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-14-1"><span data-linenos="1 "></span># zpool list {pool name}
</span></code></pre></div>
<p>On the example below, we look at the details for our mirrored tank pool:</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-15-1"><span data-linenos="1 "></span># zpool list
</span><span id="__span-15-2"><span data-linenos="2 "></span>NAME   SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
</span><span id="__span-15-3"><span data-linenos="3 "></span>tank  4.50G   117K  4.50G        -         -     0%     0%  1.00x    ONLINE  -
</span></code></pre></div>
<h4 id="14show-pool-history">1.4.Show Pool History<a href="#14show-pool-history" title="Permanent link">#</a></h4>
<p>This is another useful command that displays the history of commands that were executed against a pool from it’s creation (of course only commands that make changes to the pool’s configuration).</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-16-1"><span data-linenos="1 "></span># zpool history tank
</span><span id="__span-16-2"><span data-linenos="2 "></span>History for &#39;tank&#39;:
</span><span id="__span-16-3"><span data-linenos="3 "></span>2020-11-02.15:02:53 zpool create tank -m /mnt/tank mirror sdb sdc
</span><span id="__span-16-4"><span data-linenos="4 "></span>2020-11-02.15:50:43 zpool scrub tank
</span><span id="__span-16-5"><span data-linenos="5 "></span>2020-11-02.15:53:30 zfs set compression=lz4 tank
</span><span id="__span-16-6"><span data-linenos="6 "></span>2020-11-02.15:54:03 zpool scrub tank
</span></code></pre></div>
<h4 id="15importing-pools">1.5.Importing Pools<a href="#15importing-pools" title="Permanent link">#</a></h4>
<p>Usually after creating a pool it’s set to import and mount automatically, but you may encounter scenarios where you need to manually import a pool (like when troubleshooting or after re-imaging a system).</p>
<p>Note that the import command will also mount the pool.</p>
<h5 id="lists-pools-available-to-import"><strong>Lists pools available to import</strong><a href="#lists-pools-available-to-import" title="Permanent link">#</a></h5>
<p>Running the <code>zpool import</code> command without a pool name will show you a list of pools that can be imported.</p>
<p>Example of when no pools are available to be imported.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-17-1"><span data-linenos="1 "></span>root@ubuntu-vm:~# zpool import
</span><span id="__span-17-2"><span data-linenos="2 "></span>no pools available to import
</span></code></pre></div>
<p>Here we have a pool that can be imported.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-18-1"><span data-linenos=" 1 "></span>root@ubuntu-vm:~# zpool import
</span><span id="__span-18-2"><span data-linenos=" 2 "></span>   pool: tank
</span><span id="__span-18-3"><span data-linenos=" 3 "></span>     id: 2008489828128587072
</span><span id="__span-18-4"><span data-linenos=" 4 "></span>  state: ONLINE
</span><span id="__span-18-5"><span data-linenos=" 5 "></span> action: The pool can be imported using its name or numeric identifier.
</span><span id="__span-18-6"><span data-linenos=" 6 "></span> config:
</span><span id="__span-18-7"><span data-linenos=" 7 "></span>
</span><span id="__span-18-8"><span data-linenos=" 8 "></span>tank        ONLINE
</span><span id="__span-18-9"><span data-linenos=" 9 "></span>  mirror-0  ONLINE
</span><span id="__span-18-10"><span data-linenos="10 "></span>    sdb     ONLINE
</span><span id="__span-18-11"><span data-linenos="11 "></span>    sdc     ONLINE
</span></code></pre></div>
<h5 id="importing-the-pool"><strong>Importing the pool</strong><a href="#importing-the-pool" title="Permanent link">#</a></h5>
<p>Give the command a pool name and it will be imported.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-19-1"><span data-linenos="1 "></span>root@ubuntu-vm:~# zpool import tank
</span><span id="__span-19-2"><span data-linenos="2 "></span>
</span><span id="__span-19-3"><span data-linenos="3 "></span>root@ubuntu-vm:~# zpool list
</span><span id="__span-19-4"><span data-linenos="4 "></span>NAME   SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
</span><span id="__span-19-5"><span data-linenos="5 "></span>tank  4.50G   147K  4.50G        -         -     0%     0%  1.00x    ONLINE  -
</span></code></pre></div>
<p>You can also import all available pools by using the <code>-a</code> option.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-20-1"><span data-linenos="1 "></span># zpool import -a
</span></code></pre></div>
<h5 id="importing-a-pool-with-an-alternate-root-location"><strong>Importing a Pool with an Alternate Root Location</strong><a href="#importing-a-pool-with-an-alternate-root-location" title="Permanent link">#</a></h5>
<p>Use the <code>-R</code> flag to mount the pool to an alternate root location. Note that this is not the mount path for the pool, but an alternate root folder.</p>
<p><em><code>tank</code> is by default configured to be mounted at <code>/mnt/tank</code></em></p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-21-1"><span data-linenos="1 "></span>root@ubuntu-vm:~# zpool import -R /mnt/tank2 tank
</span><span id="__span-21-2"><span data-linenos="2 "></span>
</span><span id="__span-21-3"><span data-linenos="3 "></span>root@ubuntu-vm:~# zfs list
</span><span id="__span-21-4"><span data-linenos="4 "></span>NAME   USED  AVAIL     REFER  MOUNTPOINT
</span><span id="__span-21-5"><span data-linenos="5 "></span>tank   117K  4.36G       24K  /mnt/tank2/mnt/tank
</span></code></pre></div>
<h4 id="16exporting-the-pool">1.6.Exporting the Pool<a href="#16exporting-the-pool" title="Permanent link">#</a></h4>
<p>As expected, this is the opposite of the import command. The export command attempts to unmount any mounted file systems within the pool before continuing.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-22-1"><span data-linenos="1 "></span># zpool export [pool name]
</span></code></pre></div>
<p>For example:</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-23-1"><span data-linenos="1 "></span>root@ubuntu-vm:~# zpool export tank
</span><span id="__span-23-2"><span data-linenos="2 "></span>
</span><span id="__span-23-3"><span data-linenos="3 "></span>root@ubuntu-vm:~# zpool list
</span><span id="__span-23-4"><span data-linenos="4 "></span>no pools available
</span></code></pre></div>
<p>If any of the file systems fail to unmount you can forcefully unmount them by using the <code>-f</code> option. However, if ZFS volumes exist and are in use, even with <code>-f</code> it will fail to export.</p>
<h4 id="17destroyingdeleting-pools">1.7.Destroying/Deleting Pools<a href="#17destroyingdeleting-pools" title="Permanent link">#</a></h4>
<p>We can use the <code>zfs destroy</code> command to delete pools and all it’s child datasets and/or volumes.</p>
<p>⚠️ <strong>WARNING:</strong> <em>This will delete all your data, including any snapshots your may have.</em></p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-24-1"><span data-linenos="1 "></span>root@ubuntu-vm:~# zpool destroy tank
</span><span id="__span-24-2"><span data-linenos="2 "></span>
</span><span id="__span-24-3"><span data-linenos="3 "></span>root@ubuntu-vm:~# zpool list
</span><span id="__span-24-4"><span data-linenos="4 "></span>no pools available
</span><span id="__span-24-5"><span data-linenos="5 "></span>
</span><span id="__span-24-6"><span data-linenos="6 "></span>root@ubuntu-vm:~# zpool import
</span><span id="__span-24-7"><span data-linenos="7 "></span>no pools available to import
</span></code></pre></div>
<h4 id="18scrubbing-pools">1.8.Scrubbing Pools<a href="#18scrubbing-pools" title="Permanent link">#</a></h4>
<p>ZFS scrub checks every block in a pool against its known checksum to make sure that the data is valid. If you have vdevs with parity, ZFS scrub will also repair the data using healthy data from other disks. Scrubs should run on a schedule to make sure your systems stays healthy.</p>
<h5 id="initiating-a-scrub"><strong>Initiating a scrub</strong><a href="#initiating-a-scrub" title="Permanent link">#</a></h5>
<p>Initiating a scrub of a pool is as simple as running:</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-25-1"><span data-linenos="1 "></span># zpool scrub [pool]
</span></code></pre></div>
<h5 id="checking-the-status-of-a-scrub"><strong>Checking the status of a scrub</strong><a href="#checking-the-status-of-a-scrub" title="Permanent link">#</a></h5>
<p>You can check the status of a scrub with <code>zpool status</code> and looking for messages in the ‘scan’ section.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-26-1"><span data-linenos=" 1 "></span>root@ubuntu-vm:/mnt/tank# zpool status tank
</span><span id="__span-26-2"><span data-linenos=" 2 "></span>  pool: tank
</span><span id="__span-26-3"><span data-linenos=" 3 "></span> state: ONLINE
</span><span id="__span-26-4"><span data-linenos=" 4 "></span>  scan: scrub repaired 0B in 0 days 00:00:03 with 0 errors on Tue Nov  3 16:26:23 2020
</span><span id="__span-26-5"><span data-linenos=" 5 "></span>config:
</span><span id="__span-26-6"><span data-linenos=" 6 "></span>
</span><span id="__span-26-7"><span data-linenos=" 7 "></span>NAME        STATE     READ WRITE CKSUM
</span><span id="__span-26-8"><span data-linenos=" 8 "></span>tank        ONLINE       0     0     0
</span><span id="__span-26-9"><span data-linenos=" 9 "></span>  mirror-0  ONLINE       0     0     0
</span><span id="__span-26-10"><span data-linenos="10 "></span>    sdb     ONLINE       0     0     0
</span><span id="__span-26-11"><span data-linenos="11 "></span>    sdc     ONLINE       0     0     0
</span><span id="__span-26-12"><span data-linenos="12 "></span>
</span><span id="__span-26-13"><span data-linenos="13 "></span>errors: No known data errors
</span></code></pre></div>
<h5 id="stopping-a-scrub"><strong>Stopping a scrub</strong><a href="#stopping-a-scrub" title="Permanent link">#</a></h5>
<p>Use the <code>-s</code> flag.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-27-1"><span data-linenos="1 "></span># zpool scrub -s [pool]
</span></code></pre></div>
<h3 id="2zfs-filesystem-commands">2.ZFS Filesystem Commands<a href="#2zfs-filesystem-commands" title="Permanent link">#</a></h3>
<p>Now we will look at the commands that will help us work with filesystems (datasets) and volumes. We will concentrate more on the filesystem side of things and will not cover volumes.</p>
<p>The commands we will review are:</p>
<ul>
<li><code>zfs create</code> - Creates a new volume or filesystem</li>
<li><code>zfs mount/umount</code> - Mounts the filesystem</li>
<li><code>zfs list</code> - Lists datasets and snapshots</li>
<li><code>zfs get/set</code> - Gets configuration and sets configuration for the dataset</li>
<li><code>zfs snapshot</code> - Handles snapshots</li>
<li><code>zfs diff</code> - Used to compare data between snapshot</li>
<li><code>zfs rollback</code> - Rolls back a snapshot</li>
<li><code>zfs send/recv</code> - Sends a snapshot as a stream of data</li>
<li><code>zfs destroy</code> - Deletes datasets and snapshots</li>
</ul>
<h4 id="21-creating-datasets">2.1. Creating Datasets<a href="#21-creating-datasets" title="Permanent link">#</a></h4>
<p>We can create datasets with the <code>zfs create</code> command. Here we create ‘dataset1’ as child of the ‘tank’ dataset (that was created automatically with the <code>zpool create</code> command).</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-28-1"><span data-linenos="1 "></span>root@ubuntu-vm:~# zfs create tank/dataset1
</span><span id="__span-28-2"><span data-linenos="2 "></span>
</span><span id="__span-28-3"><span data-linenos="3 "></span>root@ubuntu-vm:~# zfs list
</span><span id="__span-28-4"><span data-linenos="4 "></span>NAME            USED  AVAIL     REFER  MOUNTPOINT
</span><span id="__span-28-5"><span data-linenos="5 "></span>tank            145K  9.36G     30.6K  /tank
</span><span id="__span-28-6"><span data-linenos="6 "></span>tank/dataset1  30.6K  9.36G     30.6K  /tank/dataset1
</span></code></pre></div>
<h5 id="creating-missing-parent-datasets"><strong>Creating missing parent datasets</strong><a href="#creating-missing-parent-datasets" title="Permanent link">#</a></h5>
<p>We can also create missing parent datasets with the <code>-p</code> flag (similar to <code>mkdir -p</code>).</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-29-1"><span data-linenos=" 1 "></span>root@ubuntu-vm:~# zfs create tank/dataset1/childset1/childset2
</span><span id="__span-29-2"><span data-linenos=" 2 "></span>cannot create &#39;tank/dataset1/childset1/childset2&#39;: parent does not exist
</span><span id="__span-29-3"><span data-linenos=" 3 "></span>
</span><span id="__span-29-4"><span data-linenos=" 4 "></span>root@ubuntu-vm:~# zfs create -p tank/dataset1/childset1/childset2
</span><span id="__span-29-5"><span data-linenos=" 5 "></span>
</span><span id="__span-29-6"><span data-linenos=" 6 "></span>root@ubuntu-vm:~# zfs list
</span><span id="__span-29-7"><span data-linenos=" 7 "></span>NAME                                USED  AVAIL     REFER  MOUNTPOINT
</span><span id="__span-29-8"><span data-linenos=" 8 "></span>tank                                249K  9.36G     30.6K  /tank
</span><span id="__span-29-9"><span data-linenos=" 9 "></span>tank/dataset1                      30.6K  9.36G     30.6K  /tank/dataset1
</span><span id="__span-29-10"><span data-linenos="10 "></span>tank/dataset1/childset1            61.3K  9.36G     30.6K  /tank/dataset1/childset1
</span><span id="__span-29-11"><span data-linenos="11 "></span>tank/dataset1/childset1/childset2  30.6K  9.36G     30.6K  /tank/dataset1/childset1/childset2
</span></code></pre></div>
<h4 id="22-mounting-filesystems-datasets">2.2. Mounting Filesystems (Datasets)<a href="#22-mounting-filesystems-datasets" title="Permanent link">#</a></h4>
<p>We can use the <code>zfs mount/unmount</code> commands to view the current mount points as well as mounting/unmounting filesystems.</p>
<h5 id="viewing-current-mounted-filesystems"><strong>Viewing current mounted filesystems</strong><a href="#viewing-current-mounted-filesystems" title="Permanent link">#</a></h5>
<p>Without any arguments, <code>zfs mount</code> will display all mounted zfs filesystems and their respective mount points (without the child datasets).</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-30-1"><span data-linenos="1 "></span>root@ubuntu-vm:~# zfs mount
</span><span id="__span-30-2"><span data-linenos="2 "></span>tank                            /tank
</span></code></pre></div>
<h5 id="mounting-filesystems"><strong>Mounting filesystems</strong><a href="#mounting-filesystems" title="Permanent link">#</a></h5>
<p>Use <code>zfs mount [pool|dataset]</code> to mount filesystems. On the example below we use <code>zfs mount</code> to establish that no datasets are mounted, and then we mount the ‘tank’ dataset and confirm that is mounted with <code>zfs mount</code>.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-31-1"><span data-linenos="1 "></span>root@ubuntu-vm:~# zfs mount
</span><span id="__span-31-2"><span data-linenos="2 "></span>
</span><span id="__span-31-3"><span data-linenos="3 "></span>root@ubuntu-vm:~# zfs mount tank
</span><span id="__span-31-4"><span data-linenos="4 "></span>
</span><span id="__span-31-5"><span data-linenos="5 "></span>root@ubuntu-vm:~# zfs mount
</span><span id="__span-31-6"><span data-linenos="6 "></span>tank                            /tank
</span></code></pre></div>
<p>Use the <code>-a</code> option to mount all filesystems.</p>
<h5 id="mount-a-child-dataset"><strong>Mount a child dataset</strong><a href="#mount-a-child-dataset" title="Permanent link">#</a></h5>
<p>You can also mount a child dataset without the parent datasets. For example, here we confirm that ‘tank’ is not mounted, then we look at the available datasets, and we execute the command to mount the <code>tank/dataset2/childset2</code> dataset only.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-32-1"><span data-linenos=" 1 "></span>root@ubuntu-vm:~# zfs mount
</span><span id="__span-32-2"><span data-linenos=" 2 "></span>
</span><span id="__span-32-3"><span data-linenos=" 3 "></span>root@ubuntu-vm:~# zfs list
</span><span id="__span-32-4"><span data-linenos=" 4 "></span>NAME                                USED  AVAIL     REFER  MOUNTPOINT
</span><span id="__span-32-5"><span data-linenos=" 5 "></span>tank                                249K  9.36G     30.6K  /tank
</span><span id="__span-32-6"><span data-linenos=" 6 "></span>tank/dataset1                      30.6K  9.36G     30.6K  /tank/dataset1
</span><span id="__span-32-7"><span data-linenos=" 7 "></span>tank/dataset2                      91.9K  9.36G     30.6K  /tank/dataset2
</span><span id="__span-32-8"><span data-linenos=" 8 "></span>tank/dataset2/childset2            61.3K  9.36G     30.6K  /tank/dataset2/childset2
</span><span id="__span-32-9"><span data-linenos=" 9 "></span>tank/dataset2/childset2/childset2  30.6K  9.36G     30.6K  /tank/dataset2/childset2/childset2
</span><span id="__span-32-10"><span data-linenos="10 "></span>
</span><span id="__span-32-11"><span data-linenos="11 "></span>root@ubuntu-vm:~# zfs mount tank/dataset2/childset2
</span><span id="__span-32-12"><span data-linenos="12 "></span>
</span><span id="__span-32-13"><span data-linenos="13 "></span>root@ubuntu-vm:~# zfs mount
</span><span id="__span-32-14"><span data-linenos="14 "></span>tank/dataset2/childset2         /tank/dataset2/childset2
</span></code></pre></div>
<p>Note that this will create the required path in the OS filesystem to mount the child dataset. If you decide to mount the parent dataset later you may run into a <code>directory is not empty</code> error because of the created directories.</p>
<h5 id="unmounting-filesystems"><strong>Unmounting filesystems</strong><a href="#unmounting-filesystems" title="Permanent link">#</a></h5>
<p>Run<code>zfs unmount</code> and specify the dataset name.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-33-1"><span data-linenos="1 "></span>root@ubuntu-vm:~# zfs mount
</span><span id="__span-33-2"><span data-linenos="2 "></span>tank                            /tank
</span><span id="__span-33-3"><span data-linenos="3 "></span>
</span><span id="__span-33-4"><span data-linenos="4 "></span>root@ubuntu-vm:~# zfs unmount tank
</span><span id="__span-33-5"><span data-linenos="5 "></span>
</span><span id="__span-33-6"><span data-linenos="6 "></span>root@ubuntu-vm:~# zfs mount
</span></code></pre></div>
<h4 id="23-listing-filesystems-datasets">2.3. Listing Filesystems (Datasets)<a href="#23-listing-filesystems-datasets" title="Permanent link">#</a></h4>
<p>You can list the dataset by running <code>zfs list [dataset name]</code>.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-34-1"><span data-linenos="1 "></span>root@ubuntu-vm:~# zfs list tank
</span><span id="__span-34-2"><span data-linenos="2 "></span>NAME   USED  AVAIL     REFER  MOUNTPOINT
</span><span id="__span-34-3"><span data-linenos="3 "></span>tank   253K  9.36G     30.6K  /tank
</span></code></pre></div>
<p>And you can also specify the mount point as an argument.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-35-1"><span data-linenos="1 "></span>root@ubuntu-vm:~# zfs list /tank
</span><span id="__span-35-2"><span data-linenos="2 "></span>NAME   USED  AVAIL     REFER  MOUNTPOINT
</span><span id="__span-35-3"><span data-linenos="3 "></span>tank   253K  9.36G     30.6K  /tank
</span></code></pre></div>
<p>If run without a dataset name, <code>zfs list</code> will show all datasets in the system recursively.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-36-1"><span data-linenos="1 "></span>root@ubuntu-vm:~# zfs list
</span><span id="__span-36-2"><span data-linenos="2 "></span>NAME                                USED  AVAIL     REFER  MOUNTPOINT
</span><span id="__span-36-3"><span data-linenos="3 "></span>tank                                253K  9.36G     30.6K  /tank
</span><span id="__span-36-4"><span data-linenos="4 "></span>tank/dataset1                      30.6K  9.36G     30.6K  /tank/dataset1
</span><span id="__span-36-5"><span data-linenos="5 "></span>tank/dataset2                      91.9K  9.36G     30.6K  /tank/dataset2
</span><span id="__span-36-6"><span data-linenos="6 "></span>tank/dataset2/childset2            61.3K  9.36G     30.6K  /tank/dataset2/childset2
</span><span id="__span-36-7"><span data-linenos="7 "></span>tank/dataset2/childset2/childset2  30.6K  9.36G     30.6K  /tank/dataset2/childset2/childset2
</span></code></pre></div>
<p>💡 <em><strong>TIP:</strong> when specifying a dataset name you can also use the <code>-r</code> flag to display the dataset recursively.</em></p>
<h4 id="24-getting-and-setting-dataset-properties">2.4. Getting and Setting Dataset Properties<a href="#24-getting-and-setting-dataset-properties" title="Permanent link">#</a></h4>
<p>Properties control the behavior of filesystems, volumes, snapshots, and clones. ZFS properties can look similar to mount options.</p>
<h5 id="getting-a-list-of-all-the-properties-for-a-dataset"><strong>Getting a list of all the properties for a dataset</strong><a href="#getting-a-list-of-all-the-properties-for-a-dataset" title="Permanent link">#</a></h5>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-37-1"><span data-linenos="1 "></span># zfs get all [dataset]
</span></code></pre></div>
<h5 id="getting-the-current-value-for-a-specific-property"><strong>Getting the current value for a specific property</strong><a href="#getting-the-current-value-for-a-specific-property" title="Permanent link">#</a></h5>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-38-1"><span data-linenos="1 "></span>root@ubuntu-vm:~# zfs get compression tank
</span><span id="__span-38-2"><span data-linenos="2 "></span>NAME  PROPERTY     VALUE     SOURCE
</span><span id="__span-38-3"><span data-linenos="3 "></span>tank  compression  off       default
</span></code></pre></div>
<h5 id="setting-a-property-value"><strong>Setting a property value</strong><a href="#setting-a-property-value" title="Permanent link">#</a></h5>
<p>Use the <code>zfs set</code> command.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-39-1"><span data-linenos="1 "></span>root@ubuntu-vm:~# zfs set compression=lz4 tank
</span><span id="__span-39-2"><span data-linenos="2 "></span>
</span><span id="__span-39-3"><span data-linenos="3 "></span>root@ubuntu-vm:~# zfs get compression tank
</span><span id="__span-39-4"><span data-linenos="4 "></span>NAME  PROPERTY     VALUE     SOURCE
</span><span id="__span-39-5"><span data-linenos="5 "></span>tank  compression  lz4       local
</span></code></pre></div>
<h4 id="25-creating-snapshots">2.5. Creating Snapshots<a href="#25-creating-snapshots" title="Permanent link">#</a></h4>
<p>Snapshots allow you to save the state of a filesystem to a current point in time, without duplicating storage (files are not copied). It flags existing data as «read-only» while allowing new data to be added to the filesystem without affecting the existing data blocks that are protected by the snapshot (the whole process is a bit more complicated than this).</p>
<p>Let’s take a look at the image below as an example. You have a filesystem with existing data (Data A) and you take a snapshot (snapshot 1). Then you make some changes, add new files (Data B) and take another snapshot (snapthot 2). After that you make even more changes (Data C).</p>
<p><a href="https://macwright.com/2023/_assets/homelab/zfs-for-dummies/snapshot.1.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="" src="https://macwright.com/2023/_assets/homelab/zfs-for-dummies/snapshot.1.png"/></a></p>
<p>Snapshot 1 protects the original data (Data A), while snapshot 2 protects Data Changes (B) as well as the original data (Data A). So you can delete snapshot 1 and data (A) will still be protected.</p>
<p><a href="https://macwright.com/2023/_assets/homelab/zfs-for-dummies/snapshot.2.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="" src="https://macwright.com/2023/_assets/homelab/zfs-for-dummies/snapshot.2.png"/></a></p>
<p><em><strong>Note:</strong> The amount of data used for the snapshots is very small because we are not copying the files, but instead the filesystem top-level metadata block indicating the they belong to a snapshot.</em></p>
<p>And here are a few scenarios of what happens when you delete files and snapshots:</p>
<p><a href="https://macwright.com/2023/_assets/homelab/zfs-for-dummies/snapshot.3.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="" src="https://macwright.com/2023/_assets/homelab/zfs-for-dummies/snapshot.3.png"/></a></p>
<p>Snapshots are great for testing software development, or creating a failsafe before an upgrade. But by no means they should be considered (by itself) as a backup or DR solution.</p>
<h5 id="creating-a-snapshot"><strong>Creating a snapshot</strong><a href="#creating-a-snapshot" title="Permanent link">#</a></h5>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-40-1"><span data-linenos="1 "></span>zfs snapshot create [pool/dataset@snapshot_name]
</span></code></pre></div>
<p>For example:</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-41-1"><span data-linenos="1 "></span>root@ubuntu-vm:~# zfs snapshot tank/dataset1@snapshot1
</span><span id="__span-41-2"><span data-linenos="2 "></span>
</span><span id="__span-41-3"><span data-linenos="3 "></span>root@ubuntu-vm:~# zfs list -t snapshot
</span><span id="__span-41-4"><span data-linenos="4 "></span>NAME                   USED  AVAIL     REFER  MOUNTPOINT
</span><span id="__span-41-5"><span data-linenos="5 "></span>tank/dataset1@snapshot1  17.3K      -     3.00G  -
</span></code></pre></div>
<h5 id="creating-recursive-snapshots"><strong>Creating recursive snapshots</strong><a href="#creating-recursive-snapshots" title="Permanent link">#</a></h5>
<p>If you have multiple child datasets, you can either create one snapshot of the top-level dataset (usually the pool name), or use the <code>-r</code> flag to create snapshots recursively.</p>
<p>Snapshot of the main dataset:</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-42-1"><span data-linenos="1 "></span>root@ubuntu-vm:~# zfs snapshot tank@snapshot-master
</span><span id="__span-42-2"><span data-linenos="2 "></span>
</span><span id="__span-42-3"><span data-linenos="3 "></span>root@ubuntu-vm:~# zfs list -t snapshot
</span><span id="__span-42-4"><span data-linenos="4 "></span>NAME                   USED  AVAIL     REFER  MOUNTPOINT
</span><span id="__span-42-5"><span data-linenos="5 "></span>tank@snapshot-master     0B      -     30.6K  -
</span></code></pre></div>
<p>Recursive snapshot:</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-43-1"><span data-linenos="1 "></span>root@ubuntu-vm:~# zfs snapshot -r tank@recursive
</span><span id="__span-43-2"><span data-linenos="2 "></span>
</span><span id="__span-43-3"><span data-linenos="3 "></span>root@ubuntu-vm:~# zfs list -t snapshot
</span><span id="__span-43-4"><span data-linenos="4 "></span>NAME                      USED  AVAIL     REFER  MOUNTPOINT
</span><span id="__span-43-5"><span data-linenos="5 "></span>tank@recursive              0B      -     30.6K  -
</span><span id="__span-43-6"><span data-linenos="6 "></span>tank/dataset1@recursive     0B      -     3.00G  -
</span></code></pre></div>
<h5 id="listing-snapshots"><strong>Listing snapshots</strong><a href="#listing-snapshots" title="Permanent link">#</a></h5>
<p>Use <code>zfs list -t snapshot</code>.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-44-1"><span data-linenos="1 "></span>root@ubuntu-vm:~# zfs list -t snapshot
</span><span id="__span-44-2"><span data-linenos="2 "></span>NAME                      USED  AVAIL     REFER  MOUNTPOINT
</span><span id="__span-44-3"><span data-linenos="3 "></span>tank@recursive              0B      -     30.6K  -
</span><span id="__span-44-4"><span data-linenos="4 "></span>tank/dataset1@recursive     0B      -     3.00G  -
</span></code></pre></div>
<h4 id="26-comparing-snapshots">2.6. Comparing Snapshots<a href="#26-comparing-snapshots" title="Permanent link">#</a></h4>
<p>You can use <code>zfs diff</code> to compare snapshots.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-45-1"><span data-linenos="1 "></span># zfs diff [older snapshot] [newer snapshot]
</span></code></pre></div>
<p>For example:</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-46-1"><span data-linenos="1 "></span>root@ubuntu-vm:# zfs diff tank@initial tank@second
</span><span id="__span-46-2"><span data-linenos="2 "></span>+/mnt/tank/file-1.txt
</span><span id="__span-46-3"><span data-linenos="3 "></span>+/mnt/tank/file-2.txt
</span><span id="__span-46-4"><span data-linenos="4 "></span>+/mnt/tank/file-3.txt
</span><span id="__span-46-5"><span data-linenos="5 "></span>M/mnt/tank/
</span></code></pre></div>
<h4 id="27-restoring-a-snapshot">2.7. Restoring a Snapshot<a href="#27-restoring-a-snapshot" title="Permanent link">#</a></h4>
<p>Restore a snapshots with <code>zfs rollback</code>. Note that restoring a snapshot will delete all files that were created after the snapshot (as we saw in our example). It will also delete any newer snapshots (you will be asked to use the <code>-r</code> option to rollback and delete newer snapshots).</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-47-1"><span data-linenos="1 "></span>zfs rollback [pool/dataset@snapshot_name]
</span></code></pre></div>
<h4 id="29-sending-and-receiving-snapshots">2.9. Sending and Receiving Snapshots<a href="#29-sending-and-receiving-snapshots" title="Permanent link">#</a></h4>
<p>One of the best features of ZFS is ‘ZFS send’. It allows you send snapshots as a stream of data. This is a great way replicate a snapshot and it’s dataset to a file, another pool or even to another system via SSH. Amazing no!</p>
<p>Let’s look at the example below. We have 2 pools in our system named ‘tank’ and ‘backup’.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-48-1"><span data-linenos="1 "></span>root@ubuntu-vm:~# zpool list
</span><span id="__span-48-2"><span data-linenos="2 "></span>NAME     SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
</span><span id="__span-48-3"><span data-linenos="3 "></span>tank       9G  1.50G  7.50G        -         -     0%    16%  1.00x    ONLINE  -
</span><span id="__span-48-4"><span data-linenos="4 "></span>backup  4.50G   104K  4.50G        -         -     0%     0%  1.00x    ONLINE  -
</span></code></pre></div>
<p>In our tank pool we have a dataset for our Movies.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-49-1"><span data-linenos="1 "></span>root@ubuntu-vm:/tank/Movies# zfs list -r tank
</span><span id="__span-49-2"><span data-linenos="2 "></span>NAME          USED  AVAIL     REFER  MOUNTPOINT
</span><span id="__span-49-3"><span data-linenos="3 "></span>tank         1.50G  7.22G       24K  /tank
</span><span id="__span-49-4"><span data-linenos="4 "></span>tank/Movies  1.50G  7.22G     1.50G  /tank/Movies
</span></code></pre></div>
<p>Before we can send this data we need create a snapshot:</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-50-1"><span data-linenos="1 "></span>root@ubuntu-vm:~# zfs snapshot tank/Movies@$(date &#39;+%Y-%m-%d_%H-%M&#39;)
</span><span id="__span-50-2"><span data-linenos="2 "></span>
</span><span id="__span-50-3"><span data-linenos="3 "></span>root@ubuntu-vm:~# zfs list -t snapshot
</span><span id="__span-50-4"><span data-linenos="4 "></span>NAME                           USED  AVAIL     REFER  MOUNTPOINT
</span><span id="__span-50-5"><span data-linenos="5 "></span>tank/Movies@2020-11-03_15-29     0B      -     1.50G  -
</span></code></pre></div>
<p>And now we can send our snapshot to our backup pool with <code>zfs send/recv</code>.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-51-1"><span data-linenos="1 "></span>root@ubuntu-vm:~# zfs send tank/Movies@2020-11-03_15-29 | zfs recv backup/Movies
</span></code></pre></div>
<p>And let’s confirm that it worked.</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-52-1"><span data-linenos=" 1 "></span>root@ubuntu-vm:~# zfs list
</span><span id="__span-52-2"><span data-linenos=" 2 "></span>NAME            USED  AVAIL     REFER  MOUNTPOINT
</span><span id="__span-52-3"><span data-linenos=" 3 "></span>backup         1.50G  2.86G       24K  /backup
</span><span id="__span-52-4"><span data-linenos=" 4 "></span>backup/Movies  1.50G  2.86G     1.50G  /backup/Movies
</span><span id="__span-52-5"><span data-linenos=" 5 "></span>tank           1.50G  7.22G       24K  /tank
</span><span id="__span-52-6"><span data-linenos=" 6 "></span>tank/Movies    1.50G  7.22G     1.50G  /tank/Movies
</span><span id="__span-52-7"><span data-linenos=" 7 "></span>
</span><span id="__span-52-8"><span data-linenos=" 8 "></span>root@ubuntu-vm:~# zfs list -t snapshot
</span><span id="__span-52-9"><span data-linenos=" 9 "></span>NAME                             USED  AVAIL     REFER  MOUNTPOINT
</span><span id="__span-52-10"><span data-linenos="10 "></span>backup/Movies@2020-11-03_15-29     0B      -     1.50G  -
</span><span id="__span-52-11"><span data-linenos="11 "></span>tank/Movies@2020-11-03_15-29       0B      -     1.50G  -
</span></code></pre></div>
<p>💡 <em><strong>TIP:</strong> It’s worth to look into all the options and use cases for ZFS send. Combined with RAIDZs and snapshots, it can help you make your filesystem almost indestructible.</em></p>
<h4 id="210-destroying-filesystems-datasets-and-snapshots">2.10. Destroying Filesystems (Datasets) and Snapshots<a href="#210-destroying-filesystems-datasets-and-snapshots" title="Permanent link">#</a></h4>
<h5 id="destroying-datasets"><strong>Destroying datasets</strong><a href="#destroying-datasets" title="Permanent link">#</a></h5>
<p>To destroy a dataset, use <code>zfs destroy</code> (the <code>-r</code> flag also works here).</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-53-1"><span data-linenos="1 "></span>zfs destroy [pool/dataset]
</span></code></pre></div>
<h5 id="destroying-snapshots"><strong>Destroying snapshots</strong><a href="#destroying-snapshots" title="Permanent link">#</a></h5>
<p>To destroy a snapshot, also use the <code>zfs destroy</code> command (and the <code>-r</code> flag also works here).</p>
<div><p><span>Text Only</span></p><pre><span></span><code><span id="__span-54-1"><span data-linenos="1 "></span>zfs destroy [pool/dataset@snapshot_name]
</span></code></pre></div>
<hr/>
<h2 id="conclusion">Conclusion<a href="#conclusion" title="Permanent link">#</a></h2>
<p>While we covered a lot of different topics and commands on ZFS, in reality, we really only scratched the surface on what ZFS can do. If you want to learn more about ZFS I’ve added a few links below with some great reading.</p>
<hr/>
<p><strong>References and additional reading:</strong></p>
<ul>
<li>FreeBSD Mastery: ZFS - <a href="https://www.goodreads.com/book/show/25595471-freebsd-mastery">https://www.goodreads.com/book/show/25595471-freebsd-mastery</a></li>
<li>Ubuntu Wiki - <a href="https://wiki.ubuntu.com/ZFS">https://wiki.ubuntu.com/ZFS</a></li>
<li>Zpool Administration - <a href="https://pthree.org/2012/04/17/install-zfs-on-debian-gnulinux/">https://pthree.org/2012/04/17/install-zfs-on-debian-gnulinux/</a></li>
<li>ZFS Build - <a href="http://www.zfsbuild.com/">http://www.zfsbuild.com/</a></li>
<li>ZFS Features and Terminology - <a href="https://www.freebsd.org/doc/handbook/zfs-term.html">https://www.freebsd.org/doc/handbook/zfs-term.html</a></li>
<li>Klennet Storage Software - <a href="https://www.klennet.com/zfs-recovery/zfs-basics.aspx">https://www.klennet.com/zfs-recovery/zfs-basics.aspx</a></li>
</ul>

  <hr/>
<p><small>
    
      Last update:
      <span>2023-09-01</span>
      
        </small>
</p>


  




                
              </article>
            </div>
          
          
        </div>
        
          
        
      </div></div>
  </body>
</html>
