<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.biphelps.com/blog/The-Fastest-GIF-Does-Not-Exist">Original</a>
    <h1>The fastest GIF does not exist</h1>
    
    <div id="readability-page-1" class="page"><section id="content">
        <a href="https://www.biphelps.com/blog">
    
</a>

<section>

    

    
    <span>
        2022 - February 19th
            <span> *new</span>
    </span>
        <span>tech</span>

    <hr/>

    <div>
        <h3>What&#39;s the problem with GIFs?</h3>

<p>You&#39;re trying to create a violently-shaking GIF for comedic purposes (<a target="_blank" href="https://knowyourmeme.com/memes/vibrating-gifs">https://knowyourmeme.com/memes/vibrating-gifs</a>). The GIF editor you&#39;re using lets you set a frame duration / delay, so you set it to the lowest possible value for maximum shakage. But when you view the resulting GIF, it&#39;s playing much slower than intended, and there are definitely GIFs that play faster than this one. What&#39;s going on?</p>

<p>If you&#39;re here because you want to fix your GIF and want the quick answer, the solution is: <strong>set your frame delay to 20ms instead of 10ms</strong>. If you want to learn a bit more about GIFs, exactly why this edge case happens, and some thoughts on how to improve things, keep reading!</p>

<p>(Disclaimer: If you&#39;re from a distant utopian future where this isn&#39;t a problem any more, a few of the example GIFs in this article won&#39;t make much sense. Otherwise, my condolences, and please disregard this message.)</p>

<figure>
<img nonce="e079bcdad0d144378e82d82413268c2c" src="https://www.biphelps.com/image/blog/dog-frenzy.gif" width="80" alt="Violently shaking dog"/>
<figcaption>Me when GIFs are too slow</figcaption>
</figure>

<h3>GIF Features</h3>

<p>We won&#39;t be going into detail on how a GIF file is structured. For a great breakdown on the bytes that make up a GIF, check out <a target="_blank" href="https://www.matthewflickinger.com/lab/whatsinagif/">Matthew Flickinger&#39;s &#34;What&#39;s in a GIF&#34; project</a>.</p>

<p>In the first version of the GIF format (87a), multiple image frames (of varying size and position) would be overlaid on top of each other to create a single resulting image. Each frame could reference a different 256-colour palette, so an image could be created using more than 256 distinct colours.</p>

<p>In the current version of the GIF format (89a), transparency and animation features are available. Now before each image frame, an optional &#34;delay&#34; value can be set which determines how long that frame should be shown before moving on to the next one. Specifically, <strong>it&#39;s the number of hundredths of a second to wait before continuing to the next frame</strong>. The value can be set from 0 (no delay) to 0xffff (roughly a 10 minute delay).</p>



<h3>No Delay</h3>

<p>What would a delay value of 0 look like? <a target="_blank" href="https://www.w3.org/Graphics/GIF/spec-gif89a.txt">The spec</a> doesn&#39;t answer the question directly, but mentions two things:</p>

<ol>
<li>When decoding a GIF file, each image frame should be processed &#34;<strong>without delays</strong> other than those specified in the control information&#34;.</li>
<li>Delay values are only used &#34;if not 0&#34;.</li>
</ol>

<p>I would take this to mean that any image frames with a delay of 0 should be combined with the previous image frame data, just like how the original 87a GIF format worked. If every image frame in the GIF had a delay of 0, the result would be a static image with the combined data of all the image frames.</p>

<p>Here&#39;s a couple of examples of what GIFs would look like if the spec were followed:</p>



<p>For context, this is what the above GIFs actually render as:</p>



<p>(If you&#39;re seeing identical images here - let me know! It means there&#39;s a browser out there that is handling GIFs differently to the big browsers.)</p>

<h3>Source of the Problem</h3>

<p>The problem is, nobody supports 0 delay. That is, none of the programs that you&#39;d typically be viewing GIFs with support it (Firefox, Edge, IE, Chrome, Windows Explorer, Electron apps, Qt apps...). <strong>Anything with a delay of less than 2 (20ms) will be clamped to a higher value</strong>. By looking at the various programs&#39; source code, we can build up a picture of why.</p>

<h4>Qt (version 6.2.2)</h4>
<figure>
<img nonce="e079bcdad0d144378e82d82413268c2c" src="https://www.biphelps.com/image/blog/sourcecode-qt.png" alt="Qt source code"/>
<figcaption>Qt source code. &#34;IE and mozilla use a minimum delay of 10. With the minimum delay of 10 we are compatible to them and avoid huge loads on the app and xserver.&#34;</figcaption>
</figure>

<h4>Chromium (version 98.0.4754)</h4>
<figure>
<img nonce="e079bcdad0d144378e82d82413268c2c" src="https://www.biphelps.com/image/blog/sourcecode-chromium.png" alt="Chromium source code"/>
<figcaption>Chromium source code. &#34;Many annoying ads specify a 0 duration to make an image flash as quickly as possible. We follow Firefox&#39;s behavior and use a duration of 100 ms for any frames that specify a duration of &lt;= 10 ms.&#34;</figcaption>
</figure>

<h4>Firefox (versions 97 and ~38)</h4>
<figure>
<img nonce="e079bcdad0d144378e82d82413268c2c" src="https://www.biphelps.com/image/blog/sourcecode-firefox.png" alt="Firefox source code"/>
<figcaption>Firefox source code. &#34;Very small timeout values are problematic for two reasons: we don&#39;t want to burn energy redrawing animated images extremely fast, and broken tools generate these values when they actually want a &#34;default&#34; value, so such images won&#39;t play back right without normalization... The historical behavior of IE [is] 10 â€“ 50ms is normalized to 100ms. &gt;50ms is used unnormalized. Opera [is] 10ms is normalized to 100ms. &gt;10ms is used unnormalized.&#34;</figcaption>
</figure>
<figure>
<img nonce="e079bcdad0d144378e82d82413268c2c" src="https://www.biphelps.com/image/blog/sourcecode-firefox2.png" alt="Older Firefox source code"/>
<figcaption>Firefox source code (from an older version, with different wording). &#34;Ensure a minimal time between updates so we don&#39;t throttle the UI thread. Consider 0 == unspecified and make it fast but not too fast... It seems that there are broken tools out there that set a 0ms or 10ms timeout when they really want a &#34;default&#34; one. So munge values in that range.&#34;</figcaption>
</figure>

<h4>Internet Explorer 5</h4>
<p>Internet Explorer 5 is closed source, but could hypothetically look something like this:</p>
<figure>
<img nonce="e079bcdad0d144378e82d82413268c2c" src="https://www.biphelps.com/image/blog/sourcecode-ie.png" alt="Intenet Explorer 5 source code"/>
<figcaption>Internet Explorer 5 hypothetical source code. &#34;crude hack to cope with &#39;degenerate animations&#39; whose timing is set to some small value because of the delays imposed by Netscape&#39;s animation process... assume these small values imply Netscape encoding delay... fake [a delay value] such that GIFs that rely solely on Netscape&#39;s delay to time their animations will play&#34;</figcaption>
</figure>

<hr/>

<p>To summarise the comments above:</p>

<ul>
<li>Qt does it to match IE and Firefox behaviour (and to avoid overloading the CPU)</li>
<li>Chromium does it to match Firefox behaviour (and to counteract annoying flashy ads)</li>
<li>Firefox does it to match IE and Opera behaviour (and to support non-spec-conforming GIFs, and to avoid overloading the CPU)</li>
<li>IE 5 does it because Netscape was slow (which caused lots of people to make badly formed GIFs)</li>
</ul>

<p>One of the odd things about all these codebases: instead of e.g. clamping a value of 0 or 1 up to 2, <strong>they will instead get pushed all the way up to 10 (100ms)</strong>. So there&#39;s a sweet spot â€“ set a delay too small and you&#39;ll get a slow GIF. Set the delay juuust a bit higher and you&#39;ll get a much faster GIF.</p>



<p>If GIF decoding is incorrect where you&#39;re reading this, the above GIFs won&#39;t appear in order of speed.</p>

<!-- Scroll to the bottom for the implementation, if you're interested-->
<h3>Interactive Bit</h3>
<div>
    <p>You&#39;ll need to enable Javascript to see this section sorry! There&#39;s a slider that lets you see how changing the delay in a GIF file will affect the end results. It&#39;s pretty cool.</p>
    
</div>


<h3>Thoughts</h3>

<p>It seems the reason for pushing values like 10ms back up to 100ms originates from a requirement to emulate the slowness of Netscape. Qt and Firefox source code comments both want to reduce CPU usage but since a value of 20ms is supported, I think they should just be clamping the value to 20ms instead. Or, don&#39;t clamp the value at all! Modern browsers already render 20ms GIF frames just fine, and I&#39;m not sure the &#34;computers are too slow&#34; argument holds up 30 years later.</p>

<p>On top of that, leave the 0-delay frames alone too. Combine them with prior frame content, like the original GIF specification says. If all frames have a 0-delay, show the static image that results from combining all the frames.</p>

<p>
My use case was wanting to update two very-small-but-separate areas in a large GIF in a single frame, to reduce file size. Currently, you need to find the rectangular region that covers all changes on the screen for that frame and add that to the GIF, but if you could define multiple frames, and set all but one to a delay of 0, you could create the same effect but with less image data:
</p>

<figure>
<img nonce="e079bcdad0d144378e82d82413268c2c" src="https://www.biphelps.com/image/blog/ots-example.gif" alt="GIF with two distinct rectangular regions that could be updated in a single frame, if 0-delay frames were supported."/>
<figcaption>If one of these areas could be defined as a 0-delay frame, a more optimised GIF could be produced than with a single larger frame.</figcaption>
</figure>

<p>A downside to making any changes is that the badly formatted GIFs won&#39;t render any more. I reckon just be bold, like the release of Netscape 2.0:
</p>
<blockquote cite="https://web.archive.org/web/19990422100600/http://home.netscape.com/eng/mozilla/2.0/relnotes/windows-2.0.html">
&#34;Netscape now conforms to GIF standards: Some GIF creation utilities produce GIF images that do not conform to standards. Such images will display empty outlines in place of the image. These outlines are much larger than the actual images. The images will not be visible at all. To repair these GIF images, content providers can read the offending GIF image into a different GIF utility that conforms to the GIF89a specifications, and save the image again.&#34;
</blockquote>

<p>If Netscape was fine with breaking poorly-made GIFs, we should be too!</p>

<h3>Let&#39;s Check Out Netscape</h3>

<p>I wanted to see what it looked like when Netscape 2.0 rendered a GIF. Here&#39;s the red-square test GIF from above, as rendered (correctly!) in Netscape 2.0 on Windows 95:</p>

<figure>
<img nonce="e079bcdad0d144378e82d82413268c2c" src="https://www.biphelps.com/image/blog/netscape-test-gif.gif" alt="Netscape 2 running in Windows 95, rendering the red-square GIF from earlier with no red square artifacts visible."/>
<figcaption>No red squares visible!</figcaption>
</figure>

<p>Since we have Netscape available to us, why don&#39;t we have a look at what a 1-delay file actually looks like? Here&#39;s a GIF running at delay = 2 (20ms), for comparison. The results aren&#39;t quite as expected though. It runs very slowly, unless you&#39;re actively moving the mouse (the reason for this is discussed in this <a target="_blank" href="https://retrocomputing.stackexchange.com/q/11533">Stack Overflow page</a>):</p>

<video controls="" preload="none">
    <source src="/image/blog/netscape-fire-2.webm" type="video/webm"/>
    <p>(Embedded videos not supported)</p>
</video>

<p>And this is with a delay of 0 - put before the exciting 10ms reveal, for dramatic effect. Look at the speed! I guess the original Netscape doesn&#39;t treat an &#34;all-0-delay&#34; GIF as a single static frame, as the spec might suggest it should. Why the mouse movement isn&#39;t required to speed this case up, I have no idea:</p>

<video controls="" preload="none">
    <source src="/image/blog/netscape-fire-0.webm" type="video/webm"/>
    <p>(Embedded videos not supported)</p>
</video>

<p>And finally, the 10ms delay GIF we&#39;ve all been waiting for...</p>
<p>*drum roll*</p>

<video controls="" preload="none">
    <source src="/image/blog/netscape-fire-1-crash.webm" type="video/webm"/>
    <p>(Embedded videos not supported)</p>
</video>

<p>Huh. Slow, and then crashes. I guess this was before we had 144Hz monitors to render that many frames per second. So if even Netscape 2.0 doesn&#39;t display GIFs that fastâ€¦ does that mean a 10ms GIF has never been perceived in all of history? Netscape crashing is a bit of an ominous sign - who knows what would happen if someone tried too hard to see the fastest GIF. Maybe we shouldn&#39;t update the browsers after all ðŸ˜…</p>

<h3>Summary</h3>

<p>No-one renders GIFs to spec, but they should (IMO). For now, set a GIF delay of 2 (20ms) instead of 1 (10ms) to get the fastest-running GIF. If everyone updated their code match the spec, we get these upsides:</p>

<ul>
<li>Support more than 256 colours in a single frame of GIF animation</li>
<li>Support fast GIFs (10ms delay)</li>
<li>No confusing behaviour with small delay = slow GIF</li>
<li>Better compression for GIFs with multiple small areas updated per frame</li>
</ul>

<p>Thanks for reading!</p>
<!-- When feeling less intimidated by hacker news -->
<!--<p>If you have any comments or feedback, reach out on Hacker News: <a target="_blank" href="https://news.ycombinator.com/">Hacker News discussion</a>, or on Reddit: <a target="_blank" href="reddit.com">Reddit discussion</a>.</p>-->

<p>If you have any comments or feedback, feel free to discuss on Reddit: <a target="_blank" href="https://www.reddit.com/r/programming/comments/sx16vy/the_fastest_gif_does_not_exist/">Reddit discussion</a>.</p>

<h3>Appendices</h3>

<h4>References</h4>



<h4>Fun Extra Things</h4>
<p>I came across Netscape&#39;s &#34;About GIFs&#34; page, with a little hot air balloon lizard:</p>
<video controls="" preload="none">
    <source src="/image/blog/netscape-about-gifs-page.webm" type="video/webm"/>
    <p>(Embedded videos not supported)</p>
</video>

<p>Here&#39;s Netscape trying to render a very complicated Opus Magnum GIF:</p>
<video controls="" preload="none">
    <source src="/image/blog/netscape-opusmagnum.webm" type="video/webm"/>
    <p>(Embedded videos not supported)</p>
</video>

<p>Here&#39;s Internet Explorer 5, failing to render the red-squares test GIF correctly. This shows how early it was that programs started going against the spec:</p>

<figure>
<img nonce="e079bcdad0d144378e82d82413268c2c" loading="lazy" src="https://www.biphelps.com/image/blog/win95-ie-testgif.gif" alt="Internet Explorer 5 running in Windows 95, rendering the red-square GIF from earlier with red square artifacts visible."/>
<figcaption>Red squares visible...</figcaption>
</figure>

<p>Here&#39;s Windows XP picture viewer, failing to produce the colourful GIF at all... except for in the thumbnail view:</p>

<figure>
<img nonce="e079bcdad0d144378e82d82413268c2c" loading="lazy" src="https://www.biphelps.com/image/blog/winxp-preview.png" alt="Windows XP, almost rendering a static colourful GIF correctly. The thumbnail view of the image is correct, but the full view just reports &#39;Drawing Failed&#39;."/>
<figcaption>Drawing failed. Sort of?</figcaption>
</figure>

<p>Finally, here is Internet Explorer 5&#39;s valiant effort to render the colourful GIF:</p>

<figure>
<img nonce="e079bcdad0d144378e82d82413268c2c" loading="lazy" src="https://www.biphelps.com/image/blog/win95-ie-corrupt.png" alt="A heavily corrupted image of the colourful GIF"/>
<figcaption>Screenshot of Internet Explorer 5 attempting to render the colourful GIF (to be fair, it sorted itself out when the rendering had completed).</figcaption>
</figure>



    </div>

    
</section>

    </section></div>
  </body>
</html>
