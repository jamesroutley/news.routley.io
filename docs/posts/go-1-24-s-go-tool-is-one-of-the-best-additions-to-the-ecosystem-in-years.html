<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.jvt.me/posts/2025/01/27/go-tools-124/">Original</a>
    <h1>Go 1.24&#39;s go tool is one of the best additions to the ecosystem in years</h1>
    
    <div id="readability-page-1" class="page"><div><p>For those that aren&#39;t aware, one of the big changes in February&#39;s upcoming Go 1.24 release is the new <a href="https://tip.golang.org/doc/go1.24#tools"><code>go tool</code></a> command, and <code>tool</code> directive in the <code>go.mod</code> to manage any tools your project uses. I&#39;m <em>incredibly excited</em> about this, and in my opinion, this is one of the best changes we&#39;ve had in recent years in the ecosystem as a whole.</p><p>I&#39;ve been meaning to write this post since the first release candidate for Go 1.24 landed, but after reading John Howard&#39;s <a href="https://blog.howardjohn.info/posts/go-tools-command/">Exploring the new &#34;go tool&#34; support in Go 1.24</a> this morning, I thought I should write my thoughts up.</p><h2 id="what-is-it">What is it?</h2><p>Within your Go codebases, there&#39;s often some additional tools that you need to have installed to be able to build/test/deploy the project.</p><p>Sometimes this will a dependency that&#39;s needed for <code>go generate</code>ing, or it may be that you want to pipe your <code>go test</code> output into a JUnit-compatible format, so your CI platform can provide more useful metadata.</p><p>For each of these, you have two choices:</p><ul><li>require that the user knows how to install them, i.e. by knowing to run <code>make deps</code> or <code>just setup</code> before building anything on the project (which will then i.e. <code>go install</code> the commands)</li><li>use the <a href="https://www.jvt.me/posts/2022/06/15/go-tools-dependency-management/"><code>tools.go</code> pattern</a> to make it so you can <em>just</em> run <code>go generate</code>, and that&#39;ll call the right dependency via <code>go run</code></li></ul><p>My preference is <a href="https://www.jvt.me/posts/2022/06/15/go-tools-dependency-management/"><code>tools.go</code> pattern</a>, but there are two key problems with this approach.</p><p>Firstly, there&#39;s a performance hit of using a <code>tools.go</code>. It&#39;s something that is <em>slightly</em> noticeable, moreso if your project relies upon a lot of <code>go run</code> i.e. with lots of <code>go generate</code>s, because prior to Go 1.24, the <code>go run</code> invocations were not cached.</p><p>Secondly, it also leads to dependency tree bloat, because you have to record your dependency on i.e. <code>github.com/sqlc-dev/sqlc/cmd/sqlc</code> which then gets recorded in your <code>go.mod</code>, and then anyone using <em>your module</em> will then see that as an indirect (transitive) dependency.</p><p>This was something we <a href="https://www.jvt.me/posts/2023/10/23/oapi-codegen-v2-decrease/">worked on for <code>oapi-codegen</code>&#39;s v2 release</a> to further reduce unnecessary dependencies, and make things a bit cleaner for our consumers. This is somewhat mitigated by Go&#39;s <a href="https://go.dev/ref/mod#graph-pruning">module graph pruning</a> which won&#39;t download dependencies that aren&#39;t used, but consumers may still see the dependencies coming in as an indirect dependency, which may not be ideal (especially as it can then bloat their indirect dependencies, which then gets passed on to their consumers and so on .</p><p>Dependency tree bloat can also be further mitigated by splitting your <a href="https://www.jvt.me/posts/2024/09/30/go-tools-module/"><code>tools.go</code> into a separate module</a>, which makes it more awkward to invoke dependencies but makes sure that none of your consumers will be seeing any tool-related dependencies.</p><p>For those who know me as co-maintainer of <a href="https://github.com/oapi-codegen/oapi-codegen">oapi-codegen</a>, you&#39;ll know that the <code>tools.go</code> pattern is our <a href="https://github.com/oapi-codegen/oapi-codegen#install">explicit recommendation</a> and we believe is better than installing it as a binary, so it&#39;s probably unsurprising that I&#39;m very excited about this as an option to manage dependencies.</p><h2 id="how-does-it-work">How does it work?</h2><p>I&#39;ve started playing around with this <a href="https://gitlab.com/tanna.dev/dependency-management-data/-/commits/spike/go-tools-124">on a branch</a> of the <a href="https://dmd.tanna.dev">dependency-management-data</a> project, where I&#39;ve got a mix of different tools that need to be installed and used.</p><p>Let&#39;s take a worked example of how we&#39;d move over calls to <code>oapi-codegen</code> to the new <code>go tool</code> pattern.</p><h3 id="existing-state">Existing state</h3><p>For instance let&#39;s say that we have the following <code>tools.go</code> in its own module:</p><pre tabindex="0"><code data-lang="gomod"># tools/go.mod
module dmd.tanna.dev/tools

go 1.22.0

require (
	github.com/99designs/gqlgen v0.17.49
	github.com/oapi-codegen/oapi-codegen/v2 v2.4.1
	github.com/sqlc-dev/sqlc v1.26.0
)
</code></pre><p>We can then see that we invoke this via <code>go run</code>:</p><div><pre tabindex="0"><code data-lang="go"><span><span><span>// internal/ecosystems/generate.go
</span></span></span><span><span><span>//go:generate go run -modfile=../../tools/go.mod github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen --config=config.yaml openapi.yaml
</span></span></span></code></pre></div><h3 id="migrating">Migrating</h3><p>To start migrating over to <code>go tool</code>, we need to make sure that we&#39;ve first pulled in the new version of Go in our top-level Go module:</p><div><pre tabindex="0"><code data-lang="diff"><span><span> module dmd.tanna.dev
</span></span><span><span>
</span></span><span><span><span>-go 1.22.7
</span></span></span><span><span><span></span><span>+go 1.24
</span></span></span><span><span><span></span>
</span></span><span><span><span>-toolchain go1.23.2
</span></span></span><span><span><span></span><span>+toolchain go1.24rc2
</span></span></span></code></pre></div><p>Next, we need to pull in a <code>tool</code> dependency on <code>oapi-codegen</code>&#39;s CLI tool - notice that you need <strong>the full path</strong> to the command that&#39;s being invoked:</p><div><pre tabindex="0"><code data-lang="sh"><span><span><span># NOTE the full import path</span>
</span></span><span><span>% go get -tool github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen@v2.4.1
</span></span></code></pre></div><p>We could also do this by hand, but doing it via <code>go get</code> simplifies this a little.</p><p>From here, we&#39;ll notice that our <code>go.mod</code> has a few other changes:</p><div><pre tabindex="0"><code data-lang="diff"><span><span><span>@@ -57,12 +57,16 @@ require (
</span></span></span><span><span><span></span>        github.com/cenkalti/backoff/v4 v4.3.0 // indirect
</span></span><span><span>        github.com/cespare/xxhash/v2 v2.3.0 // indirect
</span></span><span><span>        github.com/charmbracelet/lipgloss v0.10.0 // indirect
</span></span><span><span><span>+       github.com/dprotaso/go-yit v0.0.0-20220510233725-9ba8df137936 // indirect
</span></span></span><span><span><span></span>        github.com/dustin/go-humanize v1.0.1 // indirect
</span></span><span><span>        github.com/felixge/httpsnoop v1.0.4 // indirect
</span></span><span><span><span>+       github.com/getkin/kin-openapi v0.127.0 // indirect
</span></span></span><span><span><span></span>        github.com/go-ini/ini v1.67.0 // indirect
</span></span><span><span>        github.com/go-logfmt/logfmt v0.6.0 // indirect
</span></span><span><span>        github.com/go-logr/logr v1.4.2 // indirect
</span></span><span><span>        github.com/go-logr/stdr v1.2.2 // indirect
</span></span><span><span><span>+       github.com/go-openapi/jsonpointer v0.21.0 // indirect
</span></span></span><span><span><span>+       github.com/go-openapi/swag v0.23.0 // indirect
</span></span></span><span><span><span></span>        github.com/gobwas/glob v0.2.3 // indirect
</span></span><span><span>        github.com/google/go-querystring v1.1.0 // indirect
</span></span><span><span>        github.com/gorilla/mux v1.8.1 // indirect
</span></span><span><span><span>@@ -72,16 +76,22 @@ require (
</span></span></span><span><span><span></span>        github.com/hashicorp/go-retryablehttp v0.7.5 // indirect
</span></span><span><span>        github.com/hashicorp/golang-lru/v2 v2.0.7 // indirect
</span></span><span><span>        github.com/inconshreveable/mousetrap v1.1.0 // indirect
</span></span><span><span><span>+       github.com/invopop/yaml v0.3.1 // indirect
</span></span></span><span><span><span>+       github.com/josharian/intern v1.0.0 // indirect
</span></span></span><span><span><span></span>        github.com/klauspost/compress v1.17.11 // indirect
</span></span><span><span>        github.com/lucasb-eyer/go-colorful v1.2.0 // indirect
</span></span><span><span><span>+       github.com/mailru/easyjson v0.7.7 // indirect
</span></span></span><span><span><span></span>        github.com/mattn/go-isatty v0.0.20 // indirect
</span></span><span><span>        github.com/mattn/go-runewidth v0.0.15 // indirect
</span></span><span><span>        github.com/mitchellh/mapstructure v1.5.0 // indirect
</span></span><span><span><span>+       github.com/mohae/deepcopy v0.0.0-20170929034955-c48cc78d4826 // indirect
</span></span></span><span><span><span></span>        github.com/muesli/reflow v0.3.0 // indirect
</span></span><span><span>        github.com/muesli/termenv v0.15.2 // indirect
</span></span><span><span>        github.com/munnerz/goautoneg v0.0.0-20191010083416-a7dc8b61c822 // indirect
</span></span><span><span>        github.com/ncruces/go-strftime v0.1.9 // indirect
</span></span><span><span><span>+       github.com/oapi-codegen/oapi-codegen/v2 v2.4.1 // indirect
</span></span></span><span><span><span></span>        github.com/olekukonko/tablewriter v0.0.5 // indirect
</span></span><span><span><span>+       github.com/perimeterx/marshmallow v1.1.5 // indirect
</span></span></span><span><span><span></span>        github.com/prometheus/client_golang v1.20.5 // indirect
</span></span><span><span>        github.com/prometheus/client_model v0.6.1 // indirect
</span></span><span><span>        github.com/prometheus/common v0.60.1 // indirect
</span></span><span><span><span>@@ -91,8 +101,10 @@ require (
</span></span></span><span><span><span></span>        github.com/rivo/uniseg v0.4.7 // indirect
</span></span><span><span>        github.com/sirupsen/logrus v1.9.4-0.20230606125235-dd1b4c2e81af // indirect
</span></span><span><span>        github.com/sosodev/duration v1.3.1 // indirect
</span></span><span><span><span>+       github.com/speakeasy-api/openapi-overlay v0.9.0 // indirect
</span></span></span><span><span><span></span>        github.com/spf13/pflag v1.0.5 // indirect
</span></span><span><span>        github.com/tchap/go-patricia/v2 v2.3.1 // indirect
</span></span><span><span><span>+       github.com/vmware-labs/yaml-jsonpath v0.3.2 // indirect
</span></span></span><span><span><span></span>        github.com/xeipuuv/gojsonpointer v0.0.0-20190905194746-02993c407bfb // indirect
</span></span><span><span>        github.com/xeipuuv/gojsonreference v0.0.0-20180127040603-bd5ef7bd5415 // indirect
</span></span><span><span>        github.com/yashtewari/glob-intersection v0.2.0 // indirect
</span></span><span><span><span>@@ -110,11 +122,13 @@ require (
</span></span></span><span><span><span></span>        go.opentelemetry.io/otel/metric v1.32.0 // indirect
</span></span><span><span>        go.opentelemetry.io/proto/otlp v1.3.1 // indirect
</span></span><span><span>        golang.org/x/exp v0.0.0-20231108232855-2478ac86f678 // indirect
</span></span><span><span><span>+       golang.org/x/mod v0.18.0 // indirect
</span></span></span><span><span><span></span>        golang.org/x/net v0.30.0 // indirect
</span></span><span><span>        golang.org/x/oauth2 v0.23.0 // indirect
</span></span><span><span>        golang.org/x/sys v0.27.0 // indirect
</span></span><span><span>        golang.org/x/term v0.25.0 // indirect
</span></span><span><span>        golang.org/x/time v0.5.0 // indirect
</span></span><span><span><span>+       golang.org/x/tools v0.22.0 // indirect
</span></span></span><span><span><span></span>        google.golang.org/genproto/googleapis/api v0.0.0-20241104194629-dd2ea8efbc28 // indirect
</span></span><span><span>        google.golang.org/genproto/googleapis/rpc v0.0.0-20241104194629-dd2ea8efbc28 // indirect
</span></span><span><span>        google.golang.org/grpc v1.68.0 // indirect
</span></span><span><span><span>@@ -128,3 +142,5 @@ require (
</span></span></span><span><span><span></span>        modernc.org/token v1.1.0 // indirect
</span></span><span><span>        sigs.k8s.io/yaml v1.4.0 // indirect
</span></span><span><span> )
</span></span><span><span><span>+
</span></span></span><span><span><span>+tool github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen
</span></span></span></code></pre></div><p>From here, we can see:</p><ul><li>there is a <code>tool</code> directive for <code>github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen</code></li><li>the containing Go module for the CLI, <code>github.com/oapi-codegen/oapi-codegen/v2</code>, is now an <code>indirect</code> dependency</li><li>any other required dependencies of <code>github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen</code> are now <code>indirect</code> dependencies</li></ul><p>Now we&#39;ve done this, we could run:</p><div><pre tabindex="0"><code data-lang="sh"><span><span>% go tool github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen --help
</span></span><span><span>Usage of /home/jamie/.cache/go-build/0e/0e04736601c8bbef785d372de02859bf8f39405aae9ccbf371477b0f2d8df755-d/oapi-codegen:
</span></span><span><span><span># ...</span>
</span></span></code></pre></div><p>With this tool set up, we can now modify i.e. <code>internal/ecosystems/generate.go</code> like so to use the new <code>go tool</code>:</p><div><pre tabindex="0"><code data-lang="diff"><span><span> package ecosystems
</span></span><span><span>
</span></span><span><span><span>-//go:generate go run -modfile=../../tools/go.mod github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen --config=config.yaml openapi.yaml
</span></span></span><span><span><span></span><span>+//go:generate go tool github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen --config=config.yaml openapi.yaml
</span></span></span></code></pre></div><p>Then running <code>go generate ./internal/ecosystems</code> works as it did before 🚀</p><h2 id="performance-implications">Performance implications</h2><p>A less scientific view than Howard John&#39;s article above, but we can see a slight improvement in performance:</p><div><pre tabindex="0"><code data-lang="sh"><span><span><span># first time using `go tool`, from a fresh cache directory</span>
</span></span><span><span>% <span>time</span> go generate ./internal/ecosystems
</span></span><span><span>go generate ./internal/ecosystems  55.05s user 4.57s system 531% cpu 11.220 total
</span></span><span><span><span># a subsequent call</span>
</span></span><span><span>% <span>time</span> go generate ./internal/ecosystems
</span></span><span><span>go generate ./internal/ecosystems  0.59s user 0.18s system 424% cpu 0.181 total
</span></span><span><span><span># another just to see</span>
</span></span><span><span>% <span>time</span> go generate ./internal/ecosystems
</span></span><span><span>go generate ./internal/ecosystems  0.57s user 0.25s system 404% cpu 0.202 total
</span></span></code></pre></div><p>Compare this to the previous implementation:</p><div><pre tabindex="0"><code data-lang="sh"><span><span><span># first time using `go run`, from a fresh cache directory</span>
</span></span><span><span>% <span>time</span> go generate ./internal/ecosystems
</span></span><span><span>go generate ./internal/ecosystems  50.29s user 3.67s system 536% cpu 10.063 total
</span></span><span><span><span># a subsequent call</span>
</span></span><span><span>% <span>time</span> go generate ./internal/ecosystems
</span></span><span><span>go generate ./internal/ecosystems  1.04s user 0.21s system 185% cpu 0.677 total
</span></span><span><span><span># another just to see</span>
</span></span><span><span>% <span>time</span> go generate ./internal/ecosystems
</span></span><span><span>go generate ./internal/ecosystems  1.02s user 0.26s system 191% cpu 0.669 total
</span></span></code></pre></div><p>Notice that the first call is similar in speed, but the use of <code>go tool</code>&#39;s subsequent calls are still faster.</p><p>I&#39;m a big fan of the fact that as of Go 1.24+ the <code>go run</code>s will be cached, so even if you don&#39;t move over to <code>go tool</code>, you&#39;ll get a performance boost!</p><h2 id="concerns">Concerns</h2><p>Now, there are still a few things I&#39;ve noticed while doing the migration that aren&#39;t necessarily what I expected.</p><h3 id="gomod-implications"><code>go.mod</code> implications</h3><p>Something interesting is that the usage of the <code>tool</code> dependencies being treated as an <code>indirect</code> dependency is that they&#39;re present in the dependency tree, and treated like any other <code>indirect</code> dependency.</p><p>I&#39;d also have preferred that we had just used <code>// tool</code> instead of <code>// indirect</code>, but I can see why this is likely the choice that&#39;s made - so they&#39;re treated like any other dependency - but making them less clear as only being required for tools could lead to issues with clashing dependencies, or where you upgrade an <code>indirect</code> dependency and then that breaks other things.</p><p>This means that tools such as Renovate need to be a little more involved in how to do the updates, but <a href="https://github.com/renovatebot/renovate/discussions/33867">that&#39;s all in hand</a>.</p><h2 id="gqlgen-fails-to-run-with-go-124rc2"><code>gqlgen</code> fails to run with Go 1.24rc2</h2><p>Something I&#39;ve noticed while playing around with this is that <a href="https://github.com/99designs/gqlgen/issues/3505"><code>gqlgen</code> struggles to run with Go 1.24rc2</a>, which <a href="https://github.com/golang/go/issues/71448">feels like an upstream Go issue</a>, but it looks like that may be related to the use of <code>/x/tools</code> 🤔</p><p>It may be interesting to find out what else gets affected by this - please give the RC a test!</p><h2 id="closing">Closing</h2><p>Overall, I&#39;m feeling very positive about it, and improving the way that dependencies get installed <em>if they should be built from source</em>, but there are dependencies such as <code>golangci-lint</code> which <a href="https://golangci-lint.run/welcome/install/#install-from-sources">don&#39;t recommend building from source</a> and instead using their pre-built binaries, which is fair, and is unlikely to change here.</p></div></div>
  </body>
</html>
