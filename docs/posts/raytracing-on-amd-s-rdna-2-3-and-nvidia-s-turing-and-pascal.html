<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/">Original</a>
    <h1>Raytracing on AMD’s RDNA 2/3, and Nvidia’s Turing and Pascal</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>Raytracing aims to accurately model light by following the paths of light rays and seeing what they hit. However, raytracing is quite expensive compared to say, calculating light values by taking a pixel’s distance to light sources and doing an inverse square root. You need to send off a lot of rays to get enough rays to hit each pixel. On top of that, a ray could potentially hit any object in the scene. Obviously, you don’t want to do intersection tests against every piece of geometry. That’s where a bounding volume hierarchy (BVH) comes to implement a divide-and-conquer approach to seeing what a ray hits.</p>
<p>A BVH is a tree, or a structure where each node connects to several child nodes. Your GPU starts at the node at the top of the tree, and checks whether the ray in question intersects any child nodes. If it does, it follows those child links and repeats the process until it gets to the bottom of the tree. Each child node represents a rectangular region, which is why these upper level nodes are often called box nodes. The bottom nodes, also known as leaf nodes, contain geometry primitives that are checked to determine if the ray actually hit something. These geometry primitives are triangles, so the leaf nodes are also known as triangle nodes.</p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_front.jpg?ssl=1"><img data-attachment-id="16099" data-permalink="https://chipsandcheese.com/?attachment_id=16099" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_front.jpg?fit=8280%2C5512&amp;ssl=1" data-orig-size="8280,5512" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;2&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;NIKON D850&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;1678795662&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;50&#34;,&#34;iso&#34;:&#34;72&#34;,&#34;shutter_speed&#34;:&#34;0.66666666666667&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;1&#34;}" data-image-title="6900xt_front" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_front.jpg?fit=2163%2C1440&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_front.jpg?fit=688%2C458&amp;ssl=1" decoding="async" width="688" height="458" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_front.jpg?resize=688%2C458&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_front.jpg?resize=3245%2C2160&amp;ssl=1 3245w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_front.jpg?resize=768%2C511&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_front.jpg?resize=1536%2C1023&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_front.jpg?resize=2048%2C1363&amp;ssl=1 2048w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_front.jpg?resize=1200%2C799&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_front.jpg?resize=1600%2C1065&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_front.jpg?resize=1320%2C879&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_front.jpg?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_front.jpg?resize=688%2C458&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a><figcaption>My RX 6900 XT, a RDNA 2 based AMD GPU. RDNA 2 was the first AMD graphics architecture to feature hardware raytracing acceleration</figcaption></figure></div>
<p>The concept is quite simple, but there’s a lot of different ways you can build a BVH. If you put more boxes into a box node, you can subdivide the scene more. But that means more computation (intersection tests) at each level. You can make more levels to cut down on computational costs, but then you’d make more jumps from one node to another. Here, we’re going to use developer tools from both AMD and Nvidia to take a peek at how each manufacturer has chosen to build their BVH-es.</p>
<h2>AMD RDNA 2 and RDNA 3</h2>
<p>AMD implements raytracing acceleration by adding intersection test instructions to the texture units. Instead of dealing with textures though, these instructions take a box or triangle node in a predefined format. Box nodes can represent four boxes, and triangle nodes can represent four triangles. The instruction computes intersection test results for everything in that node, and hands the results back to the shader. Then, the shader is responsible for traversing the BVH and handing the next node to the texture units. RDNA 3 additionally has specialized LDS instructions to make managing the traversal stack faster.</p>
<h3>Cyberpunk 2077</h3>
<p>Cyberpunk 2077 can make extensive use of raytracing, and is one of the best showcases of what the technology can enable. Turning on raytracing often produces an immediately noticeable difference, as reflections that the game doesn’t handle with rasterization become visible. To do raytracing, Cyberpunk 2077 uses the DirectX Raytracing (DXR) API. It defines BVH-es in two structures – a top level acceleration structures (TLAS), and a bottom level acceleration structure (BLAS). Traversing the TLAS gets you to a BLAS, which eventually gets you to the relevant geometry.</p>
<p>With a capture from inside “The Mox”, we get a TLAS that covers a massive portion of the gameplay setting. Most of Night City seems to be included, as well as the surrounding areas. The TLAS has 70,720 nodes, of which 22,404 are box nodes and 48,316 are “instance nodes” that link to BLAS instances. Traversing the TLAS leads you to 8,315 BLAS instances, which collectively represent 11,975,029 triangles. The TLAS occupies 11 MB of storage, while everything together (including the BLAS-es) occupies 795 MB.</p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_overview.jpg?ssl=1"><img data-attachment-id="16120" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/6900xt_cp2077_overview/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_overview.jpg?fit=3840%2C2120&amp;ssl=1" data-orig-size="3840,2120" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="6900xt_cp2077_overview" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_overview.jpg?fit=2560%2C1413&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_overview.jpg?fit=688%2C380&amp;ssl=1" decoding="async" width="688" height="380" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_overview.jpg?resize=688%2C380&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_overview.jpg?w=3840&amp;ssl=1 3840w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_overview.jpg?resize=768%2C424&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_overview.jpg?resize=1536%2C848&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_overview.jpg?resize=2048%2C1131&amp;ssl=1 2048w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_overview.jpg?resize=1200%2C663&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_overview.jpg?resize=1600%2C883&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_overview.jpg?resize=1320%2C729&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_overview.jpg?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_overview.jpg?resize=688%2C380&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a></figure></div>
<p>The first level of four bounding boxes divide the city into two parts, and the large unoccupied area at the bottom of the screen into two parts as well. Those areas don’t have a lot of geometry to do further subdivision on, so the TLAS only goes a couple levels deeper before you get BLAS pointers. </p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_quick_blas.jpg?ssl=1"><img data-attachment-id="16122" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/6900xt_cp2077_quick_blas/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_quick_blas.jpg?fit=3094%2C2078&amp;ssl=1" data-orig-size="3094,2078" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="6900xt_cp2077_quick_blas" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_quick_blas.jpg?fit=2144%2C1440&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_quick_blas.jpg?fit=688%2C462&amp;ssl=1" decoding="async" width="688" height="462" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_quick_blas.jpg?resize=688%2C462&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_quick_blas.jpg?w=3094&amp;ssl=1 3094w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_quick_blas.jpg?resize=768%2C516&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_quick_blas.jpg?resize=1536%2C1032&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_quick_blas.jpg?resize=2048%2C1375&amp;ssl=1 2048w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_quick_blas.jpg?resize=1200%2C806&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_quick_blas.jpg?resize=1600%2C1075&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_quick_blas.jpg?resize=1320%2C887&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_quick_blas.jpg?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_quick_blas.jpg?resize=688%2C462&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a><figcaption>One of the southern zones highlighted</figcaption></figure></div>
<p>Of course, the city is the fun part. Zooming into the depths of Night City, we see a tree represented by a BLAS. To be clear, I’m talking about a tree in the game, not a data structure. Cache and memory latency is going to be a concern here, because getting to the BLAS requires 12 pointer chasing jumps between nodes.</p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_tree_blas.jpg?ssl=1"><img data-attachment-id="16125" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/6900xt_cp2077_tree_blas/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_tree_blas.jpg?fit=3840%2C2120&amp;ssl=1" data-orig-size="3840,2120" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="6900xt_cp2077_tree_blas" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_tree_blas.jpg?fit=2560%2C1413&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_tree_blas.jpg?fit=688%2C380&amp;ssl=1" decoding="async" width="688" height="380" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_tree_blas.jpg?resize=688%2C380&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_tree_blas.jpg?w=3840&amp;ssl=1 3840w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_tree_blas.jpg?resize=768%2C424&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_tree_blas.jpg?resize=1536%2C848&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_tree_blas.jpg?resize=2048%2C1131&amp;ssl=1 2048w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_tree_blas.jpg?resize=1200%2C663&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_tree_blas.jpg?resize=1600%2C883&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_tree_blas.jpg?resize=1320%2C729&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_tree_blas.jpg?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_tree_blas.jpg?resize=688%2C380&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a><figcaption>Tree highlighted, with the area covered by the BLAS marked in a yellow box</figcaption></figure></div>
<p>Within the BLAS, taking another six jumps gets you to a triangle node, or leaf node, with four triangles. Each triangle probably represents a set of leaves on the actual tree. From the top, getting to the actual geometry takes 19 hops, including jumping from the TLAS to the BLAS.</p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_treeblas_trianglenode.jpg?ssl=1"><img data-attachment-id="16127" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/6900xt_cp2077_treeblas_trianglenode/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_treeblas_trianglenode.jpg?fit=7456%2C2124&amp;ssl=1" data-orig-size="7456,2124" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="6900xt_cp2077_treeblas_trianglenode" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_treeblas_trianglenode.jpg?fit=2560%2C729&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_treeblas_trianglenode.jpg?fit=688%2C196&amp;ssl=1" decoding="async" width="688" height="196" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_treeblas_trianglenode.jpg?resize=688%2C196&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_treeblas_trianglenode.jpg?resize=3840%2C1094&amp;ssl=1 3840w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_treeblas_trianglenode.jpg?resize=768%2C219&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_treeblas_trianglenode.jpg?resize=1536%2C438&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_treeblas_trianglenode.jpg?resize=2048%2C583&amp;ssl=1 2048w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_treeblas_trianglenode.jpg?resize=1200%2C342&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_treeblas_trianglenode.jpg?resize=1600%2C456&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_treeblas_trianglenode.jpg?resize=1320%2C376&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_treeblas_trianglenode.jpg?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/6900xt_cp2077_treeblas_trianglenode.jpg?resize=688%2C196&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a><figcaption>This particular BLAS occupies 338 KB, and represents 2,129 triangles. On average, it’s 7 levels deep, and has a maximum tree depth of 11 levels. Also, we’re traversing a tree to light up a tree. Isn’t that great?</figcaption></figure></div>
<p>AMD thus uses a rather deep BVH with a lot of subdividing. That means less demand on intersection test throughput. But cache and memory latency will have a large impact, because each jump between nodes is dependent on the intersection test results from the previous node. GPUs have high cache and memory latency compared to CPUs, so RDNA 2 will need to keep a lot of rays in flight to hide that latency.</p>
<p>We previously looked at how<a href="https://chipsandcheese.com/2023/02/19/amds-rdna-2-shooting-for-the-top/"> RDNA 2 handled raytracing at the hardware level</a>, and noted that the L2 cache played a very significant role. Looking at the raytracing structure sizes, the hitrates we saw make a lot of sense. The TLAS alone is 11 MB, so unless a lot of rays happen to go in the same direction, caches with capacities in the kilobyte range will probably have difficulty coping. </p>
<div>
<figure><img data-attachment-id="15171" data-permalink="https://chipsandcheese.com/2023/02/19/amds-rdna-2-shooting-for-the-top/rdna2_jigjig_longest_rt_call_stats/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/02/rdna2_jigjig_longest_rt_call_stats.png?fit=583%2C688&amp;ssl=1" data-orig-size="583,688" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="rdna2_jigjig_longest_rt_call_stats" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/02/rdna2_jigjig_longest_rt_call_stats.png?fit=583%2C688&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/02/rdna2_jigjig_longest_rt_call_stats.png?fit=583%2C688&amp;ssl=1" decoding="async" width="583" height="688" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/02/rdna2_jigjig_longest_rt_call_stats.png?resize=583%2C688&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/02/rdna2_jigjig_longest_rt_call_stats.png?resize=583%2C688&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/><figcaption>Hardware counters from a DispatchRays call on RDNA 2</figcaption></figure></div>
<p>Our testing also shows that the RX 6900 XT’s L2 cache has a load-to-use latency of just above 80 ns. While that’s good for a multi-megabyte GPU cache, it’s close to memory latency for CPUs. In the end, the 6900 XT was averaging 28.7 billion box tests and 3.21 billion triangle tests per second during that call, despite being underclocked to 1800 MHz. AMD says each CU can perform four box tests or one triangle test per cycle, so RT core utilization could be anywhere from 7.2% to 29% depending on whether the counters increment for every intersection test, or every node.</p>

<p>Ideally, AMD would keep more rays in flight to hide latency and increase execution unit utilization, but vector register file capacity limits occupancy to 10 waves per SIMD out of the 16 maximum. That’s one motivation behind RDNA 3 increased vector register file capacity. Checking Cyberpunk 2077 through RDNA 3’s lenses, we see occupancy increase to 12/16.</p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_cp2077_rt_call.png?ssl=1"><img data-attachment-id="16137" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/7900xtx_cp2077_rt_call/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_cp2077_rt_call.png?fit=1920%2C1040&amp;ssl=1" data-orig-size="1920,1040" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="7900xtx_cp2077_rt_call" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_cp2077_rt_call.png?fit=1920%2C1040&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_cp2077_rt_call.png?fit=688%2C373&amp;ssl=1" decoding="async" width="688" height="373" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_cp2077_rt_call.png?resize=688%2C373&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_cp2077_rt_call.png?w=1920&amp;ssl=1 1920w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_cp2077_rt_call.png?resize=768%2C416&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_cp2077_rt_call.png?resize=1536%2C832&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_cp2077_rt_call.png?resize=1200%2C650&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_cp2077_rt_call.png?resize=1600%2C867&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_cp2077_rt_call.png?resize=1320%2C715&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_cp2077_rt_call.png?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_cp2077_rt_call.png?resize=688%2C373&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a><figcaption>Profiling Cyberpunk 2077 on RDNA 3. Don’t pay too much attention to the gaps – because the 7900 XTX is faster, it’s more CPU bound.</figcaption></figure></div>
<p>Furthermore, RDNA 3 enjoys a noticeable increase in L0 and L1 hitrates. Those caches have doubled in size compared to RDNA 2, while also offering improved latency. RDNA 3 ends up averaging 45.2 billion box tests and 5.22 billion triangle tests per second in that shader. That’s quite an impressive performance uplift, though it’s hard to quantify the difference in RT core utilization because the 7900 XTX was not locked to known clocks. </p>
<h3>Hogwarts Legacy</h3>
<p>Hogwarts Legacy is a recent game release that also makes use of raytracing. Titanic has done profiling on this game using his 7900 XTX, since I don’t own the game. Both Hogwarts Legacy and Cyberpunk 2077 feature similar TLAS sizes, but Hogwarts has a much smaller memory footprint when you consider the BLAS-es.</p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/cp2077_vs_hogwarts_bvh.png?ssl=1"><img data-attachment-id="16141" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/cp2077_vs_hogwarts_bvh/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/cp2077_vs_hogwarts_bvh.png?fit=1318%2C556&amp;ssl=1" data-orig-size="1318,556" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="cp2077_vs_hogwarts_bvh" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/cp2077_vs_hogwarts_bvh.png?fit=1318%2C556&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/cp2077_vs_hogwarts_bvh.png?fit=688%2C290&amp;ssl=1" decoding="async" width="688" height="290" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/cp2077_vs_hogwarts_bvh.png?resize=688%2C290&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/cp2077_vs_hogwarts_bvh.png?w=1318&amp;ssl=1 1318w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/cp2077_vs_hogwarts_bvh.png?resize=768%2C324&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/cp2077_vs_hogwarts_bvh.png?resize=1200%2C506&amp;ssl=1 1200w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/cp2077_vs_hogwarts_bvh.png?resize=688%2C290&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a></figure></div>
<p>Just as with Cyberpunk 2077, the TLAS covers a massive amount of area. In Hogwarts Legacy, it appears to include Hogwarts Castle as well as the surrounding grounds, and some far-off mountains. The mountains don’t have a lot of complex geometry and are covered by a single box (and BLAS). Three of the four boxes at the top level cover the mountains, and one covers most of the gameplay area.</p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_overview.jpg?ssl=1"><img data-attachment-id="16144" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/7900xtx_hogwarts_overview/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_overview.jpg?fit=3840%2C2120&amp;ssl=1" data-orig-size="3840,2120" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="7900xtx_hogwarts_overview" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_overview.jpg?fit=2560%2C1413&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_overview.jpg?fit=688%2C380&amp;ssl=1" decoding="async" width="688" height="380" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_overview.jpg?resize=688%2C380&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_overview.jpg?w=3840&amp;ssl=1 3840w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_overview.jpg?resize=768%2C424&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_overview.jpg?resize=1536%2C848&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_overview.jpg?resize=2048%2C1131&amp;ssl=1 2048w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_overview.jpg?resize=1200%2C663&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_overview.jpg?resize=1600%2C883&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_overview.jpg?resize=1320%2C729&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_overview.jpg?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_overview.jpg?resize=688%2C380&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a></figure></div>
<p>Titanic took the capture from the courtyard. Zooming into that area reveals a massive amount of geometric detail, including animate objects like humans and a cat.</p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_top.jpg?ssl=1"><img data-attachment-id="16145" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/7900xtx_hogwarts_courtyard_top/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_top.jpg?fit=3840%2C2120&amp;ssl=1" data-orig-size="3840,2120" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="7900xtx_hogwarts_courtyard_top" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_top.jpg?fit=2560%2C1413&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_top.jpg?fit=688%2C380&amp;ssl=1" decoding="async" width="688" height="380" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_top.jpg?resize=688%2C380&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_top.jpg?w=3840&amp;ssl=1 3840w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_top.jpg?resize=768%2C424&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_top.jpg?resize=1536%2C848&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_top.jpg?resize=2048%2C1131&amp;ssl=1 2048w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_top.jpg?resize=1200%2C663&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_top.jpg?resize=1600%2C883&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_top.jpg?resize=1320%2C729&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_top.jpg?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_top.jpg?resize=688%2C380&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a></figure></div>
<p>As with Cyberpunk, getting down to the bottom level involves quite a few hops. A Hogwarts student looking at the fountain is 13 levels in. Again, memory latency is going to be a distinct culprit because even hitting the L1 cache on RDNA 3 will cost 35 ns. </p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_bottom.jpg?ssl=1"><img data-attachment-id="16147" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/7900xtx_hogwarts_courtyard_bottom/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_bottom.jpg?fit=3840%2C2120&amp;ssl=1" data-orig-size="3840,2120" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="7900xtx_hogwarts_courtyard_bottom" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_bottom.jpg?fit=2560%2C1413&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_bottom.jpg?fit=688%2C380&amp;ssl=1" decoding="async" width="688" height="380" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_bottom.jpg?resize=688%2C380&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_bottom.jpg?w=3840&amp;ssl=1 3840w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_bottom.jpg?resize=768%2C424&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_bottom.jpg?resize=1536%2C848&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_bottom.jpg?resize=2048%2C1131&amp;ssl=1 2048w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_bottom.jpg?resize=1200%2C663&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_bottom.jpg?resize=1600%2C883&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_bottom.jpg?resize=1320%2C729&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_bottom.jpg?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_courtyard_bottom.jpg?resize=688%2C380&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a></figure></div>
<p>Curiously, the student’s (her?) body is represented by three BLAS-es. One represents most of her body. Another covers her hair, while yet another contains her face and hands.</p>
<figure><table><tbody><tr><td>Bottom Level Acceleration Structure (BLAS)</td><td>Depth</td><td>Nodes</td></tr><tr><td>Face and Hands, 316 KB</td><td>7 average</td><td>955 box nodes</td></tr><tr><td>Hair, 169 KB</td><td>6 average</td><td>486 box nodes</td></tr><tr><td>Body, 788 KB</td><td>8 average</td><td>2359 box nodes</td></tr></tbody></table></figure>
<p>The body BLAS is the largest, and goes down to very small subdivisions like parts of a button. I hope raytracing in this game looks incredible, because it takes 10 jumps to get to that part of a button. </p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_button.jpg?ssl=1"><img data-attachment-id="16150" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/7900xtx_hogwarts_button/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_button.jpg?fit=3840%2C2120&amp;ssl=1" data-orig-size="3840,2120" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="7900xtx_hogwarts_button" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_button.jpg?fit=2560%2C1413&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_button.jpg?fit=688%2C380&amp;ssl=1" decoding="async" width="688" height="380" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_button.jpg?resize=688%2C380&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_button.jpg?w=3840&amp;ssl=1 3840w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_button.jpg?resize=768%2C424&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_button.jpg?resize=1536%2C848&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_button.jpg?resize=2048%2C1131&amp;ssl=1 2048w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_button.jpg?resize=1200%2C663&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_button.jpg?resize=1600%2C883&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_button.jpg?resize=1320%2C729&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_button.jpg?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_button.jpg?resize=688%2C380&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a><figcaption>We really care about accurately lighting that button. Right?</figcaption></figure></div>
<p>This level of detail is not universal throughout the BVH. There’s also a cat in the courtyard, 12 levels down in the TLAS. A single BLAS represents the entire cat. Compared to the human BLAS-es, the cat BLAS is much simpler and represents an order of magnitude less geometry. It occupies 73 KB, and only has 196 box nodes covering a total of 460 triangles. It ends up being 6 levels deep on average, with a maximum depth of 9 levels.</p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_cat.jpg?ssl=1"><img data-attachment-id="16155" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/7900xtx_hogwarts_cat/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_cat.jpg?fit=3840%2C2120&amp;ssl=1" data-orig-size="3840,2120" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="7900xtx_hogwarts_cat" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_cat.jpg?fit=2560%2C1413&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_cat.jpg?fit=688%2C380&amp;ssl=1" decoding="async" width="688" height="380" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_cat.jpg?resize=688%2C380&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_cat.jpg?w=3840&amp;ssl=1 3840w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_cat.jpg?resize=768%2C424&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_cat.jpg?resize=1536%2C848&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_cat.jpg?resize=2048%2C1131&amp;ssl=1 2048w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_cat.jpg?resize=1200%2C663&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_cat.jpg?resize=1600%2C883&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_cat.jpg?resize=1320%2C729&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_cat.jpg?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_cat.jpg?resize=688%2C380&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a><figcaption>Look, a cat.</figcaption></figure></div>
<p>Clearly, the developers behind Hogwarts Legacy chose to optimize performance by deciding that cats are less important than humans.</p>
<h3>Inline vs Indirect Raytracing</h3>
<p>Microsoft’s DirectX raytracing API supports raytracing via two main methods. The first is inline raytracing, where one large shader program handles both traversing the BVH and performing the appropriate lighting calculations when it sees a rays hit or miss things. The second is indirect raytracing, where separate shader programs get invoked to handle ray hits and misses. This is a simplified explanation of course, so consider checking out <a href="https://devblogs.microsoft.com/directx/dxr-1-1/">Microsoft’s explanation of the API</a> or <a href="https://developer.nvidia.com/blog/best-practices-using-nvidia-rtx-ray-tracing/">Nvidia’s suggestions on what approach to use</a>. But long story short, indirect raytracing suffers from the overhead of launching separate shader programs, while inline raytracing may suffer from a single shader program getting too big.</p>
<p>Cyberpunk 2077 uses inline raytracing, via DispatchRays&lt;Unified&gt; calls. Hogwarts Legacy, much like Unreal Engine 5’s city demo, uses indirect raytracing via ExecuteIndirect&lt;Rays&gt;&lt;Indirect&gt; calls.</p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_indirect_raytracing.png?ssl=1"><img data-attachment-id="16164" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/7900xtx_hogwarts_indirect_raytracing/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_indirect_raytracing.png?fit=1920%2C1040&amp;ssl=1" data-orig-size="1920,1040" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="7900xtx_hogwarts_indirect_raytracing" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_indirect_raytracing.png?fit=1920%2C1040&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_indirect_raytracing.png?fit=688%2C373&amp;ssl=1" decoding="async" width="688" height="373" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_indirect_raytracing.png?resize=688%2C373&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_indirect_raytracing.png?w=1920&amp;ssl=1 1920w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_indirect_raytracing.png?resize=768%2C416&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_indirect_raytracing.png?resize=1536%2C832&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_indirect_raytracing.png?resize=1200%2C650&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_indirect_raytracing.png?resize=1600%2C867&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_indirect_raytracing.png?resize=1320%2C715&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_indirect_raytracing.png?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/7900xtx_hogwarts_indirect_raytracing.png?resize=688%2C373&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a></figure></div>
<p>Indirect raytracing also gives us a pretty clear indication of raytracing costs. Ray traversal is the most expensive thing by far, but Hogwarts Legacy also spends quite some time handling hits once they’re found.</p>
<h2>Nvidia’s Turing</h2>
<p>Turing was Nvidia’s first architecture to implement hardware raytracing acceleration. With Turing’s launch, Nvidia made a significant investment both directly in raytracing acceleration, and in supporting technologies like DLSS. Since then, they’ve continued to double down on this area. It would be interesting to see whether Nvidia’s raytracing implementation has changed in their newer cards, but I don’t have an Ampere or Ada card. I happened to replace my GTX 1080 at the height of the cryptomining boom in 2021, and Ampere was ridiculously overpriced at the time. For sure RDNA 2 was overpriced too, just to a less ridiculous extent.</p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060mobile_cp2077_nsight.jpg?ssl=1"><img data-attachment-id="16174" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/2060mobile_cp2077_nsight/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060mobile_cp2077_nsight.jpg?fit=4096%2C3072&amp;ssl=1" data-orig-size="4096,3072" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;1.9&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;ASUS_AI2202&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;1679191462&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;5.53&#34;,&#34;iso&#34;:&#34;371&#34;,&#34;shutter_speed&#34;:&#34;0.025&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;1&#34;}" data-image-title="2060mobile_cp2077_nsight" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060mobile_cp2077_nsight.jpg?fit=1920%2C1440&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060mobile_cp2077_nsight.jpg?fit=688%2C516&amp;ssl=1" decoding="async" width="688" height="516" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060mobile_cp2077_nsight.jpg?resize=688%2C516&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060mobile_cp2077_nsight.jpg?resize=2880%2C2160&amp;ssl=1 2880w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060mobile_cp2077_nsight.jpg?resize=1920%2C1440&amp;ssl=1 1920w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060mobile_cp2077_nsight.jpg?resize=768%2C576&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060mobile_cp2077_nsight.jpg?resize=1536%2C1152&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060mobile_cp2077_nsight.jpg?resize=2048%2C1536&amp;ssl=1 2048w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060mobile_cp2077_nsight.jpg?resize=1200%2C900&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060mobile_cp2077_nsight.jpg?resize=800%2C600&amp;ssl=1 800w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060mobile_cp2077_nsight.jpg?resize=400%2C300&amp;ssl=1 400w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060mobile_cp2077_nsight.jpg?resize=200%2C150&amp;ssl=1 200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060mobile_cp2077_nsight.jpg?resize=1600%2C1200&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060mobile_cp2077_nsight.jpg?resize=1320%2C990&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060mobile_cp2077_nsight.jpg?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060mobile_cp2077_nsight.jpg?resize=688%2C516&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a><figcaption>Setting up Cyberpunk 2077 for a frame capture from Nsight. Note the framerate achieved by the RTX 2060 Mobile…why am I even trying to do this?</figcaption></figure></div>
<p>Nvidia did not document how the acceleration works at a low level, but we can at least examine the acceleration structures by using Nsight Graphics to take frame captures. The TLAS again covers the entire city, which isn’t a surprise because the application decides what the raytracing acceleration structures should cover. Just like AMD’s TLAS, Nvidia’s occupies about 11 MB. </p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_tlas.jpg?ssl=1"><img data-attachment-id="16168" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/2060_cp2077_mox_tlas/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_tlas.jpg?fit=1920%2C1030&amp;ssl=1" data-orig-size="1920,1030" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="2060_cp2077_mox_tlas" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_tlas.jpg?fit=1920%2C1030&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_tlas.jpg?fit=688%2C369&amp;ssl=1" decoding="async" width="688" height="369" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_tlas.jpg?resize=688%2C369&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_tlas.jpg?w=1920&amp;ssl=1 1920w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_tlas.jpg?resize=768%2C412&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_tlas.jpg?resize=1536%2C824&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_tlas.jpg?resize=1200%2C644&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_tlas.jpg?resize=1600%2C858&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_tlas.jpg?resize=1320%2C708&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_tlas.jpg?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_tlas.jpg?resize=688%2C369&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a><figcaption>Using Nsight Graphics to profile Cyberpunk 2077 on a RTX 2060 Mobile</figcaption></figure></div>
<p>However, Nvidia takes a very different approach to BVH construction. The way Nsight Graphics presents the BVH suggests it’s an extremely wide tree. Expanding the top node immediately reveals thousands of bounding boxes, each of which points to a BLAS. Each BLAS then contains anywhere from a few dozen to thousands of primitives. If Nsight’s representation corresponds to the actual raytracing structure, then Nvidia can get to the bottom of their acceleration structure in just three hops. That makes Nvidia’s implementation far less sensitive to cache and memory latency. </p>
<p>To enable this approach, Nvidia likely has more flexible hardware, or is handling a lot more work with the general purpose vector units. Unlike AMD, where nodes can only point to four children, Nvidia does not have fixed size nodes. One node can point to two triangle nodes, while another points to six. A single triangle node can contain hundreds of triangles.</p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_tlas_variable.jpg?ssl=1"><img data-attachment-id="16171" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/2060_cp2077_tlas_variable/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_tlas_variable.jpg?fit=1920%2C1030&amp;ssl=1" data-orig-size="1920,1030" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="2060_cp2077_tlas_variable" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_tlas_variable.jpg?fit=1920%2C1030&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_tlas_variable.jpg?fit=688%2C369&amp;ssl=1" decoding="async" width="688" height="369" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_tlas_variable.jpg?resize=688%2C369&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_tlas_variable.jpg?w=1920&amp;ssl=1 1920w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_tlas_variable.jpg?resize=768%2C412&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_tlas_variable.jpg?resize=1536%2C824&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_tlas_variable.jpg?resize=1200%2C644&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_tlas_variable.jpg?resize=1600%2C858&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_tlas_variable.jpg?resize=1320%2C708&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_tlas_variable.jpg?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_tlas_variable.jpg?resize=688%2C369&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a><figcaption>Note the primitive (triangle) count for each triangle node</figcaption></figure></div>
<p>However, this approach demands a lot more intersection test throughput. That’s actually a wise choice, because GPUs are designed to take advantage of tons of explicit parallelism. Unlike CPUs, latency optimizations are not critical, and that’s very visible in the memory hierarchy. L2 cache access on Nvidia generally go well over 100 ns. In the RTX 2060 Mobile’s case, L2 latency is around 120 to 143 ns, depending on whether you’re going through the TMUs. </p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/rdna2_turing_latency.png?ssl=1"><img data-attachment-id="16179" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/rdna2_turing_latency/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/rdna2_turing_latency.png?fit=1215%2C576&amp;ssl=1" data-orig-size="1215,576" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="rdna2_turing_latency" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/rdna2_turing_latency.png?fit=1215%2C576&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/rdna2_turing_latency.png?fit=688%2C326&amp;ssl=1" decoding="async" width="688" height="326" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/rdna2_turing_latency.png?resize=688%2C326&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/rdna2_turing_latency.png?w=1215&amp;ssl=1 1215w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/rdna2_turing_latency.png?resize=768%2C364&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/rdna2_turing_latency.png?resize=1200%2C569&amp;ssl=1 1200w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/rdna2_turing_latency.png?resize=688%2C326&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a></figure></div>
<p>To counter that, Nvidia has a larger first level cache. But on Turing and many other Nvidia architectures, L1 and local memory (shared memory) are carved out of the same block of SRAM. Shared memory is Nvidia’s equivalent of AMD’s LDS, and both are great places to store a BVH traversal stack. There’s a chance that Nvidia won’t be able to maximize L1 cache sizes in raytracing workloads. Zooming into the longest DispatchRays call, we can see that Nvidia does achieve decent cache hitrates.</p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_21ms_dispatchrays_cache.png?ssl=1"><img data-attachment-id="16181" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/2060_cp2077_mox_21ms_dispatchrays_cache/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_21ms_dispatchrays_cache.png?fit=657%2C313&amp;ssl=1" data-orig-size="657,313" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="2060_cp2077_mox_21ms_dispatchrays_cache" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_21ms_dispatchrays_cache.png?fit=657%2C313&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_21ms_dispatchrays_cache.png?fit=657%2C313&amp;ssl=1" decoding="async" width="657" height="313" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_21ms_dispatchrays_cache.png?resize=657%2C313&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_21ms_dispatchrays_cache.png?resize=657%2C313&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a><figcaption>Metrics from Nsight graphics for the longest DispatchRays call, which took 21 ms to execute on the poor RTX 2060 Mobile. Nsight still labels the first level cache as a “texture” cache, even though Turing can reach it without going through the TMUs for better latency</figcaption></figure></div>
<p>Turing’s L1 cache is large enough that it achieves better hitrate than AMD’s L1. That’s not surprising because Turing can still provide 24 KB of L1 capacity even when prioritizing shared memory. The 6900 XT in the example above got a cumulative L0 and L1 hitrate of 78.6%, so AMD’s mid-level L1 cache does help to even things out, but of course AMD’s L1 is technically a second level cache, and hitting it will be slower than hitting Nvidia’s first level cache. At L2, AMD has an advantage because the 6900 XT’s L2 is larger, and has lower latency. But that’s completely expected of a newer GPU with higher performance targets.</p>
<p>Turing’s basic building blocks are Streaming Multiprocessors, or SMs. They’re vaguely comparable to WGPs on AMD. However, Turing SMs are smaller than WGPs, and smaller than SMs on Pascal (the previous Nvidia generation). An RDNA 2 WGP or Pascal SM can keep 64 waves in flight, but a Turing SM can only track 32. In this DispatchRays call, Turing averaged an occupancy of 17.37 waves out of 32, or 54%. SM utilization was poor, with the execution ports active only 11.35% of the time. </p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_21ms_dispatchrays_sm.png?ssl=1"><img data-attachment-id="16183" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/2060_cp2077_mox_21ms_dispatchrays_sm/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_21ms_dispatchrays_sm.png?fit=1920%2C1030&amp;ssl=1" data-orig-size="1920,1030" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="2060_cp2077_mox_21ms_dispatchrays_sm" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_21ms_dispatchrays_sm.png?fit=1920%2C1030&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_21ms_dispatchrays_sm.png?fit=688%2C369&amp;ssl=1" decoding="async" width="688" height="369" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_21ms_dispatchrays_sm.png?resize=688%2C369&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_21ms_dispatchrays_sm.png?w=1920&amp;ssl=1 1920w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_21ms_dispatchrays_sm.png?resize=768%2C412&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_21ms_dispatchrays_sm.png?resize=1536%2C824&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_21ms_dispatchrays_sm.png?resize=1200%2C644&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_21ms_dispatchrays_sm.png?resize=1600%2C858&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_21ms_dispatchrays_sm.png?resize=1320%2C708&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_21ms_dispatchrays_sm.png?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/2060_cp2077_mox_21ms_dispatchrays_sm.png?resize=688%2C369&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a></figure></div>
<p>The biggest culprits are stalls for “short scoreboard” and “long scoreboard”. “Short scoreboard” refers to short duration, variable latency operations like shared memory access. Nvidia may be using shared memory to track BVH traversal state, so a good chunk of this is probably down to shared memory latency, which is around 15.57 ns on Turing. That’s pretty good compared to the regular caches, but still long in absolute terms.</p>
<p>“Long scoreboard” points to global memory latency. Global memory is backed by VRAM, and corresponds to what we think of as memory on a CPU. Ray traversal involves plenty of pointer chasing, so that’s not surprising. The third largest reason, “MIO throttle”, is harder to understand because it doesn’t point to a clear, single cause.</p>
<blockquote>
<p>Warp was stalled waiting for the MIO (memory input/output) instruction queue to be not full. This stall reason is high in cases of extreme utilization of the MIO pipelines, which include special math instructions, dynamic branches, as well as shared memory instructions. When caused by shared memory accesses, trying to use fewer but wider loads can reduce pipeline pressure.</p>
<cite><a href="https://docs.nvidia.com/nsight-compute/ProfilingGuide/">Nvidia’s Kernel Profiling Guide</a></cite></blockquote>
<p>An Nvidia SM probably sends a variety of longer latency operations to a MIO queue. In this case, the RTX 2060’s SMs were occasionally bottlenecked by something behind that queue. It could be shared memory, special math instructions like inverse square roots or reciprocals, or even branches.</p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/turing_mio_queue_slide_hotchips.png?ssl=1"><img data-attachment-id="16186" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/turing_mio_queue_slide_hotchips/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/turing_mio_queue_slide_hotchips.png?fit=1139%2C627&amp;ssl=1" data-orig-size="1139,627" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="turing_mio_queue_slide_hotchips" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/turing_mio_queue_slide_hotchips.png?fit=1139%2C627&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/turing_mio_queue_slide_hotchips.png?fit=688%2C379&amp;ssl=1" decoding="async" width="688" height="379" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/turing_mio_queue_slide_hotchips.png?resize=688%2C379&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/turing_mio_queue_slide_hotchips.png?w=1139&amp;ssl=1 1139w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/turing_mio_queue_slide_hotchips.png?resize=768%2C423&amp;ssl=1 768w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/turing_mio_queue_slide_hotchips.png?resize=688%2C379&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a><figcaption>Nvidia’s slide from Hot Chips presenting the Turing architecture, showing the MIO scheduler. Looks like the L1/Shared Memory split might be 32 + 64 KB, but I measured 24 KB from two separate latency tests (OpenCL texture latency, and CUDA with the prefer shared memory option set).</figcaption></figure></div>
<p>Another cause for poor SM utilization is that Turing’s SMs are just weaker in general. With Turing, Nvidia moved to statically split integer and floating point paths. For comparison, Pascal and RDNA can execute both integer and FP32 at full rate, and flexibly give execution bandwidth to whatever’s needed in the moment. In contrast, Turing will have to stall every other cycle if faced with a long sequence of FP32 instructions. To get the most out of Turing, you need a perfect mix of alternating INT32 and FP32 instructions. Maybe that didn’t happen.</p>
<h3>Changes in Ampere</h3>
<p>Looking at Turing’s struggles does help provide perspective on how Nvidia approached Ampere. First, they doubled the FP32 throughput in each SM. That should allow far better scheduler port utilization, because the SM no longer needs a perfect 1:1 ratio of INT32 to FP32 instructions to achieve peak throughput. In practice, FP32 instructions are far more common than INT32 ones, so this is a good move that should benefit a wide range of graphics applications beyond raytracing. </p>
<p>On the raytracing front, Ampere doubles the ray-triangle intersection test rate. This makes a lot of sense if Nvidia’s using a fat tree where triangle nodes can contain thousands of triangles. Such a strategy minimizes memory latency costs, but demands more intersection test throughput. Ampere’s change fits that. I have no doubt that Ampere is a far stronger architecture for both rasterization and raytracing than Turing. </p>
<p>Turing does have a rough time, but that’s really expected of a first generation raytracing implementation. No one buys the first generation of a new technology expecting anything more than a rough experience that gets rapidly outdated as technology matures. That applied to early digital cameras, early aircraft, and so on. Turing is no exception. But what’s important is that lessons learned with Turing informed major changes in Ampere, allowing Nvidia to create a very strong second generation raytracing implementation.</p>
<h2>Nvidia’s Pascal</h2>
<p>Nvidia’s Pascal architecture supports raytracing, but doesn’t have any specialized hardware to assist with raytracing. Instead, raytracing is done completely with compute shaders, using the same vector ALUs used to do traditional rasterization. I wasn’t able to profile Cyberpunk 2077 raytracing with Pascal, because the game says it’s not supported on the GTX 1080. Instead, I have some results from Nvidia’s RTX demos. I’m looking at the Star Wars demo specifically.</p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo.jpg?ssl=1"><img data-attachment-id="16196" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/pascal_starwars_rtx_demo/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo.jpg?fit=1917%2C961&amp;ssl=1" data-orig-size="1917,961" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="pascal_starwars_rtx_demo" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo.jpg?fit=1917%2C961&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo.jpg?fit=688%2C345&amp;ssl=1" decoding="async" width="688" height="345" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo.jpg?resize=688%2C345&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo.jpg?w=1917&amp;ssl=1 1917w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo.jpg?resize=768%2C385&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo.jpg?resize=1536%2C770&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo.jpg?resize=1200%2C602&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo.jpg?resize=1600%2C802&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo.jpg?resize=1320%2C662&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo.jpg?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo.jpg?resize=688%2C345&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a><figcaption>The demo shows some friendly looking people. They’re definitely friendly and just want a hug. Right?</figcaption></figure></div>
<p>Like Turing, Pascal uses a very fat BVH. You can get from the root node to a triangle node in just three hops. Nvidia didn’t develop a separate raytracing strategy for Pascal, probably because all GPU raytracing implementations solve fundamentally similar problems, regardless of whether they have dedicated hardware to assist with raytracing. Pascal doesn’t have significantly different latency memory latency characteristics than Turing. Like any other GPU, Pascal is also optimized to take advantage of explicit parallelism in order to hide latency and feed a lot of vector execution units. </p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo_tlas.jpg?ssl=1"><img data-attachment-id="16198" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/pascal_starwars_rtx_demo_tlas/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo_tlas.jpg?fit=2479%2C1303&amp;ssl=1" data-orig-size="2479,1303" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="pascal_starwars_rtx_demo_tlas" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo_tlas.jpg?fit=2479%2C1303&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo_tlas.jpg?fit=688%2C362&amp;ssl=1" decoding="async" width="688" height="362" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo_tlas.jpg?resize=688%2C362&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo_tlas.jpg?w=2479&amp;ssl=1 2479w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo_tlas.jpg?resize=768%2C404&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo_tlas.jpg?resize=1536%2C807&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo_tlas.jpg?resize=2048%2C1076&amp;ssl=1 2048w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo_tlas.jpg?resize=1200%2C631&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo_tlas.jpg?resize=1600%2C841&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo_tlas.jpg?resize=1320%2C694&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo_tlas.jpg?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_rtx_demo_tlas.jpg?resize=688%2C362&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a></figure></div>
<p>Again, we see raytracing acceleration structures cover just about everything. Unlike Cyberpunk and Hogwarts Legacy though, the total area covered is far smaller, because the demo is a lot smaller in scope. The TLAS consists of 180 instances, covering a total of 3,447,421 triangles. Because the demo is smaller in scope, Nvidia could afford to put a lot more detail into each object. The closest stormtrooper is represented by 555,698 triangles organized into 17 sub-boxes. Contrast that to Hogwarts Legacy, which represents a human with just over 8K triangles. Subdivisions on the stormtrooper go down to the visor on the helmet, the scope on the gun, and other minute details. </p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_stormtrooper_aabbs.jpg?ssl=1"><img data-attachment-id="16202" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/pascal_starwars_stormtrooper_aabbs/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_stormtrooper_aabbs.jpg?fit=2479%2C1303&amp;ssl=1" data-orig-size="2479,1303" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="pascal_starwars_stormtrooper_aabbs" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_stormtrooper_aabbs.jpg?fit=2479%2C1303&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_stormtrooper_aabbs.jpg?fit=688%2C362&amp;ssl=1" decoding="async" width="688" height="362" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_stormtrooper_aabbs.jpg?resize=688%2C362&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_stormtrooper_aabbs.jpg?w=2479&amp;ssl=1 2479w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_stormtrooper_aabbs.jpg?resize=768%2C404&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_stormtrooper_aabbs.jpg?resize=1536%2C807&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_stormtrooper_aabbs.jpg?resize=2048%2C1076&amp;ssl=1 2048w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_stormtrooper_aabbs.jpg?resize=1200%2C631&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_stormtrooper_aabbs.jpg?resize=1600%2C841&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_stormtrooper_aabbs.jpg?resize=1320%2C694&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_stormtrooper_aabbs.jpg?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_stormtrooper_aabbs.jpg?resize=688%2C362&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a></figure></div>
<p>Compared to what we see in games, the stormtrooper has been lovingly modeled with a ridiculous amount of geometry, giving it very clean, rounded looking shape. Each of the stormtrooper’s triangle nodes has anywhere from a couple hundred to tens of thousands of triangles. Some nodes have even more triangles than the entire human in Hogwarts Legacy. For example, the helmet alone accounts for 110k triangles. This level of detail may be impossible to field in an open world game, but it’s fascinating to see in a scoped-down technical demo.</p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_dispatchrays.png?ssl=1"><img data-attachment-id="16205" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/pascal_starwars_dispatchrays/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_dispatchrays.png?fit=1920%2C1040&amp;ssl=1" data-orig-size="1920,1040" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="pascal_starwars_dispatchrays" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_dispatchrays.png?fit=1920%2C1040&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_dispatchrays.png?fit=688%2C373&amp;ssl=1" decoding="async" width="688" height="373" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_dispatchrays.png?resize=688%2C373&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_dispatchrays.png?w=1920&amp;ssl=1 1920w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_dispatchrays.png?resize=768%2C416&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_dispatchrays.png?resize=1536%2C832&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_dispatchrays.png?resize=1200%2C650&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_dispatchrays.png?resize=1600%2C867&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_dispatchrays.png?resize=1320%2C715&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_dispatchrays.png?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_dispatchrays.png?resize=688%2C373&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a><figcaption>There’s more than one DispatchRays call, but the 26.72 ms one is by far the most brutal</figcaption></figure></div>
<p>Pascal struggles hard to render this technical demo, with one DispatchRays call taking a staggering 26.72 ms. Each SM tracked 13.23 waves on average out of 64 theoretical, meaning that occupancy was very poor and the architecture couldn’t keep a lot of work in flight. A lot of warps were stalled on global memory latency (long scoreboard) just as with Turing, but a few other deficiencies show up too. There’s also a lot of stalling because of “no instructions” (instruction cache misses). Pascal suffers because it has smaller instruction caches relative to Turing, and because it has to do intersection tests without special instructions.</p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/LOL_1989.jpg?ssl=1"><img data-attachment-id="16221" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/lol_1989/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/LOL_1989.jpg?fit=8280%2C5512&amp;ssl=1" data-orig-size="8280,5512" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;2&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;NIKON D850&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;1678791949&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;50&#34;,&#34;iso&#34;:&#34;72&#34;,&#34;shutter_speed&#34;:&#34;0.1&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;1&#34;}" data-image-title="LOL_1989" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/LOL_1989.jpg?fit=2163%2C1440&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/LOL_1989.jpg?fit=688%2C458&amp;ssl=1" decoding="async" width="688" height="458" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/LOL_1989.jpg?resize=688%2C458&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/LOL_1989.jpg?resize=3245%2C2160&amp;ssl=1 3245w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/LOL_1989.jpg?resize=768%2C511&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/LOL_1989.jpg?resize=1536%2C1023&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/LOL_1989.jpg?resize=2048%2C1363&amp;ssl=1 2048w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/LOL_1989.jpg?resize=1200%2C799&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/LOL_1989.jpg?resize=1600%2C1065&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/LOL_1989.jpg?resize=1320%2C879&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/LOL_1989.jpg?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/LOL_1989.jpg?resize=688%2C458&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a><figcaption>My GTX 1080, technically a Dell OEM model off eBay with a FE cooler retrofitted. Why I’m putting Pascal through this….I do not know.</figcaption></figure></div>
<p>“Wait” is the third biggest stall reason, and points to instruction execution latency. Pascal has a latency of six cycles for the most common floating point and integer instructions, while Turing and Ampere bring that down to four cycles. The term “wait” is used because Nvidia handles instruction dependencies by embedding static scheduling info that tells the SM scheduler to stall a thread for a specified number of cycles. With low occupancy and plenty of stalling, Pascal’s SMs average just 1.09 IPC. According to Nsight, the SMs achieved about 22.3% of their theoretical efficiency. While that’s better than what Turing got in Cyberpunk 2077, Turing gets by because it’s throwing a lot of weaker SMs at the problem.</p>
<p>For sure, Pascal and Turing both suffer stalls due to shared memory, and it does look like Pascal’s doing a lot of shared memory accesses during raytracing. But on Pascal, that cost is peanuts compared to regular cache and memory latency.</p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_cache.png?ssl=1"><img data-attachment-id="16210" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/pascal_starwars_cache/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_cache.png?fit=581%2C277&amp;ssl=1" data-orig-size="581,277" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="pascal_starwars_cache" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_cache.png?fit=581%2C277&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_cache.png?fit=581%2C277&amp;ssl=1" decoding="async" width="581" height="277" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_cache.png?resize=581%2C277&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_starwars_cache.png?resize=581%2C277&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a><figcaption>Cache stats for the 26.68 ms raytracing call</figcaption></figure></div>
<p>The first culprit is Pascal’s L1 texture cache. Internally, a Pascal SM is partitioned into four SM sub partitions, which are analogous to a RDNA WGP’s SIMDs. Each pair of SMSPs share a memory pipeline and 24 KB L1 texture cache. While this cache is larger than RDNA’s L0 cache, hitrate is quite poor in this workload. On a L1 miss, we go straight to the L2, because there’s no mid-level cache to cushion the impact of first level cache misses.</p>
<p>Even on a L1 hit, Pascal is at a large disadvantage because there’s no way to bypass the texture units. The Pascal architecture is a lot less optimized for latency sensitive compute, and unfortunately raytracing is an example of that.</p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_turing_latency.png?ssl=1"><img data-attachment-id="16213" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/pascal_turing_latency/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_turing_latency.png?fit=956%2C410&amp;ssl=1" data-orig-size="956,410" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="pascal_turing_latency" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_turing_latency.png?fit=956%2C410&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_turing_latency.png?fit=688%2C295&amp;ssl=1" decoding="async" width="688" height="295" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_turing_latency.png?resize=688%2C295&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_turing_latency.png?w=956&amp;ssl=1 956w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_turing_latency.png?resize=768%2C329&amp;ssl=1 768w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/pascal_turing_latency.png?resize=688%2C295&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a><figcaption>Using CUDA lets me test different L1 and shared memory splits on Turing</figcaption></figure></div>
<p>Once we get out to L2, Pascal does turn in a good performance. Pascal’s L2 has acceptable latency, and achieves good hitrates.</p>
<p>There’s also nuance to Pascal’s performance. Pascal’s SMs achieved very good throughput in the other two DispatchRays calls, where L1 hitrates were a bit higher. All of the calls pointed to the same BVH. Furthermore, Pascal achieved excellent compute utilization in the later RTReflectionFilter section.</p>
<figure><table><tbody><tr><td>Section</td><td>SM IPC</td><td>Occupancy</td><td>Cache Hitrates</td></tr><tr><td>E9076 DispatchRays, 26.68 ms</td><td>1.09</td><td>13.23 / 64</td><td>L1 Tex: 55%</td></tr><tr><td>E8551 DispatchRays, 6.01 ms</td><td>2.17</td><td>13.21 / 64</td><td>L1 Tex: 68.9%</td></tr><tr><td>E8808 DispatchRays, 3.66 ms</td><td>1.97</td><td>13.29 / 64</td><td>L1 Tex: 68.7%</td></tr><tr><td>RTReflectionFilter DrawIndexed, 5.21 ms</td><td>4.04</td><td>32.34 / 64</td><td>L1 Tex: 516%</td></tr></tbody></table><figcaption>A Pascal SM is nominally designed to sustain four instructions per cycle for the most common FP32 and INT32 operations</figcaption></figure>
<p>So Pascal is capable of ripping through workloads with powerful vector units, using its dual issue capability to make sure the schedulers can feed the primary FP32 or INT32 pipes. However, the architecture suffers from low occupancy, likely due to its limited register file capacity and lack of separate scalar registers. Cache latency and instruction cache capacity also present problems. All of these were addressed to some extent in Turing, though at the cost of losing Pascal’s 32-wide vector units and dual issue capability.</p>
<h2>Final Words</h2>
<p>Raytracing is an exciting new area of development for graphics rendering. Tracing rays promises to deliver more accurate lighting effects with less work on the developer’s part. However, optimizing raytracing workloads is difficult. AMD and Nvidia both use acceleration structures that adopt a divide-and-conquer approach, but the two manufacturers differ a lot in just how they do the dividing.</p>
<p>AMD takes a more conventional approach that wouldn’t be out of place on a CPU, and uses a rigid BVH format that allows for simpler hardware. AMD’s RT accelerators don’t have to deal with variable length nodes. However, AMD BVH makes it more vulnerable to cache and memory latency, one of a GPU’s traditional weaknesses. RDNA 3 counters this by hitting the problem from all sides. Cache latency has gone down, while capacity has gone up. Raytracing specific LDS instructions help reduce latency within the shader that’s handling ray traversal. Finally, increased vector register file capacity lets each WGP hold state for more threads, letting it keep more rays in flight to hide latency. A lot of these optimizations will help a wide range of workloads beyond raytracing. It’s hard to see what wouldn’t benefit from higher occupancy and better caching.</p>
<div>
<figure><a href="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/justice_rtx_pascal_bvh.jpg?ssl=1"><img data-attachment-id="16113" data-permalink="https://chipsandcheese.com/2023/03/22/raytracing-on-amds-rdna-2-3-and-nvidias-turing-and-pascal/justice_rtx_pascal_bvh/" data-orig-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/justice_rtx_pascal_bvh.jpg?fit=1859%2C835&amp;ssl=1" data-orig-size="1859,835" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="justice_rtx_pascal_bvh" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/justice_rtx_pascal_bvh.jpg?fit=1859%2C835&amp;ssl=1" data-large-file="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/justice_rtx_pascal_bvh.jpg?fit=688%2C309&amp;ssl=1" decoding="async" width="688" height="309" src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/justice_rtx_pascal_bvh.jpg?resize=688%2C309&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/justice_rtx_pascal_bvh.jpg?w=1859&amp;ssl=1 1859w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/justice_rtx_pascal_bvh.jpg?resize=768%2C345&amp;ssl=1 768w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/justice_rtx_pascal_bvh.jpg?resize=1536%2C690&amp;ssl=1 1536w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/justice_rtx_pascal_bvh.jpg?resize=1200%2C539&amp;ssl=1 1200w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/justice_rtx_pascal_bvh.jpg?resize=1600%2C719&amp;ssl=1 1600w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/justice_rtx_pascal_bvh.jpg?resize=1320%2C593&amp;ssl=1 1320w, https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/justice_rtx_pascal_bvh.jpg?w=1376&amp;ssl=1 1376w" data-lazy-sizes="(max-width: 688px) 100vw, 688px" data-lazy-src="https://i0.wp.com/chipsandcheese.com/wp-content/uploads/2023/03/justice_rtx_pascal_bvh.jpg?resize=688%2C309&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/></a><figcaption>BVH generated for Pascal in Nvidia’s Justice RTX demo</figcaption></figure></div>
<p>Nvidia takes a radically different approach that plays to a GPU’s advantages. By using a very wide tree, Nvidia shifts emphasis away from cache and memory latency, and toward compute throughput. With Ada, that’s where I suspect Nvidia’s approach really starts to shine. Ampere already had a staggering SM count, with RT cores that have double the triangle test throughput compared to Turing. Ada pushes things further, with an even higher SM count and triangle test throughput doubled again. There’s a lot less divide and conquer in Nvidia’s approach, but there’s a lot more parallelism available. And Nvidia is bringing tons of dedicated hardware to plow through those intersection tests.</p>
<p>But that doesn’t mean Nvidia’s weak on the caching front either. Ada has an <a href="https://chipsandcheese.com/2022/11/02/microbenchmarking-nvidias-rtx-4090/">incredible cache hierarchy</a>. I suspect Nvidia’s bringing that together with the factors above to stay roughly one generation ahead of AMD in raytracing workloads. With regards to raytracing strategy, and how exactly to implement a BVH, I don’t think there’s a fundamentally right or wrong approach. Nvidia and AMD have both made significant strides towards better raytracing performance. As raytracing gets wider adoption and more use though, we may see AMD’s designs trend towards bigger investments into raytracing. </p>
<p>If you like our articles and journalism, and you want to support us in our endeavors, then consider heading over to our <a href="https://www.patreon.com/ChipsandCheese">Patreon</a> or our <a href="https://www.paypal.com/donate/?hosted_button_id=4EMPH66SBGVSQ">PayPal</a> if you want to toss a few bucks our way. If you would like to talk with the Chips and Cheese staff and the people behind the scenes, then consider joining our <a href="https://discord.gg/TwVnRhxgY2">Discord</a>.</p>
<div>

<ul>
<li>
<p><img alt="clamchowder" src="https://secure.gravatar.com/avatar/83de286347cdfc84e1bb10146350467e?s=80&amp;d=identicon&amp;r=g" height="80" width="80" decoding="async" data-lazy-srcset="https://secure.gravatar.com/avatar/83de286347cdfc84e1bb10146350467e?s=160&amp;d=identicon&amp;r=g 2x" data-lazy-src="https://secure.gravatar.com/avatar/83de286347cdfc84e1bb10146350467e?s=80&amp;is-pending-load=1#038;d=identicon&amp;r=g" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/>
</p>

</li>
</ul>
</div>



</div></div>
  </body>
</html>
