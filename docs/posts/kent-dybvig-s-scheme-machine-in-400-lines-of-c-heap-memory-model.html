<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://gist.github.com/swatson555/8cc36d8d022d7e5cc44a5edb2c4f7d0b">Original</a>
    <h1>Show HN: Kent Dybvig&#39;s Scheme Machine in 400 Lines of C (Heap-Memory Model)</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="heap-lisp.c">
        <tbody><tr>
          <td id="file-heap-lisp-c-L1" data-line-number="1"></td>
          <td id="file-heap-lisp-c-LC1"><span>/* Heap based virtual machine described in section 3.4 of Three Implementation Models for Scheme, Dybvig</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L2" data-line-number="2"></td>
          <td id="file-heap-lisp-c-LC2"><span> */</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L3" data-line-number="3"></td>
          <td id="file-heap-lisp-c-LC3">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L4" data-line-number="4"></td>
          <td id="file-heap-lisp-c-LC4"><span>#include</span> <span>&lt;stdio.h&gt;</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L5" data-line-number="5"></td>
          <td id="file-heap-lisp-c-LC5"><span>#include</span> <span>&lt;stdlib.h&gt;</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L6" data-line-number="6"></td>
          <td id="file-heap-lisp-c-LC6"><span>#include</span> <span>&lt;string.h&gt;</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L7" data-line-number="7"></td>
          <td id="file-heap-lisp-c-LC7"><span>#include</span> <span>&lt;ctype.h&gt;</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L8" data-line-number="8"></td>
          <td id="file-heap-lisp-c-LC8"><span>#include</span> <span>&lt;assert.h&gt;</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L9" data-line-number="9"></td>
          <td id="file-heap-lisp-c-LC9">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L10" data-line-number="10"></td>
          <td id="file-heap-lisp-c-LC10"><span>char</span> <span>token</span>[<span>128</span>][<span>32</span>];</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L11" data-line-number="11"></td>
          <td id="file-heap-lisp-c-LC11">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L12" data-line-number="12"></td>
          <td id="file-heap-lisp-c-LC12"><span>int</span> <span>lexer</span>(<span>char</span><span>*</span> <span>input</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L13" data-line-number="13"></td>
          <td id="file-heap-lisp-c-LC13">  <span>int</span> <span>ii</span> <span>=</span> <span>0</span>; <span>// input index</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L14" data-line-number="14"></td>
          <td id="file-heap-lisp-c-LC14">  <span>int</span> <span>ti</span> <span>=</span> <span>0</span>; <span>// token index</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L15" data-line-number="15"></td>
          <td id="file-heap-lisp-c-LC15">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L16" data-line-number="16"></td>
          <td id="file-heap-lisp-c-LC16">  <span>while</span>(<span>input</span>[<span>ii</span>] <span>!=</span> <span>&#39;\0&#39;</span>)</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L17" data-line-number="17"></td>
          <td id="file-heap-lisp-c-LC17">    <span>switch</span>(<span>input</span>[<span>ii</span>]) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L18" data-line-number="18"></td>
          <td id="file-heap-lisp-c-LC18">    <span>// Ignore whitespace and newlines</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L19" data-line-number="19"></td>
          <td id="file-heap-lisp-c-LC19">    <span>case</span> <span>&#39; &#39;</span>:</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L20" data-line-number="20"></td>
          <td id="file-heap-lisp-c-LC20">    <span>case</span> <span>&#39;\n&#39;</span>:</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L21" data-line-number="21"></td>
          <td id="file-heap-lisp-c-LC21">      <span>++</span><span>ii</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L22" data-line-number="22"></td>
          <td id="file-heap-lisp-c-LC22">      <span>break</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L23" data-line-number="23"></td>
          <td id="file-heap-lisp-c-LC23">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L24" data-line-number="24"></td>
          <td id="file-heap-lisp-c-LC24">    <span>// Turn a left parenthesis into a token.</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L25" data-line-number="25"></td>
          <td id="file-heap-lisp-c-LC25">    <span>case</span> <span>&#39;(&#39;</span>:</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L26" data-line-number="26"></td>
          <td id="file-heap-lisp-c-LC26">      <span>token</span>[<span>ti</span>][<span>0</span>] <span>=</span> <span>&#39;(&#39;</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L27" data-line-number="27"></td>
          <td id="file-heap-lisp-c-LC27">      <span>token</span>[<span>ti</span>][<span>1</span>] <span>=</span> <span>&#39;\0&#39;</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L28" data-line-number="28"></td>
          <td id="file-heap-lisp-c-LC28">      <span>++</span><span>ii</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L29" data-line-number="29"></td>
          <td id="file-heap-lisp-c-LC29">      <span>++</span><span>ti</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L30" data-line-number="30"></td>
          <td id="file-heap-lisp-c-LC30">      <span>break</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L31" data-line-number="31"></td>
          <td id="file-heap-lisp-c-LC31">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L32" data-line-number="32"></td>
          <td id="file-heap-lisp-c-LC32">    <span>// Turn a right parenthesis into a token.</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L33" data-line-number="33"></td>
          <td id="file-heap-lisp-c-LC33">    <span>case</span> <span>&#39;)&#39;</span>:</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L34" data-line-number="34"></td>
          <td id="file-heap-lisp-c-LC34">      <span>token</span>[<span>ti</span>][<span>0</span>] <span>=</span> <span>&#39;)&#39;</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L35" data-line-number="35"></td>
          <td id="file-heap-lisp-c-LC35">      <span>token</span>[<span>ti</span>][<span>1</span>] <span>=</span> <span>&#39;\0&#39;</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L36" data-line-number="36"></td>
          <td id="file-heap-lisp-c-LC36">      <span>++</span><span>ii</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L37" data-line-number="37"></td>
          <td id="file-heap-lisp-c-LC37">      <span>++</span><span>ti</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L38" data-line-number="38"></td>
          <td id="file-heap-lisp-c-LC38">      <span>break</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L39" data-line-number="39"></td>
          <td id="file-heap-lisp-c-LC39">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L40" data-line-number="40"></td>
          <td id="file-heap-lisp-c-LC40">    <span>// Turn an apostrophe into a token.</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L41" data-line-number="41"></td>
          <td id="file-heap-lisp-c-LC41">    <span>case</span> <span>&#39;\&#39;&#39;</span>:</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L42" data-line-number="42"></td>
          <td id="file-heap-lisp-c-LC42">      <span>token</span>[<span>ti</span>][<span>0</span>] <span>=</span> <span>&#39;\&#39;&#39;</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L43" data-line-number="43"></td>
          <td id="file-heap-lisp-c-LC43">      <span>token</span>[<span>ti</span>][<span>1</span>] <span>=</span> <span>&#39;\0&#39;</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L44" data-line-number="44"></td>
          <td id="file-heap-lisp-c-LC44">      <span>++</span><span>ii</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L45" data-line-number="45"></td>
          <td id="file-heap-lisp-c-LC45">      <span>++</span><span>ti</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L46" data-line-number="46"></td>
          <td id="file-heap-lisp-c-LC46">      <span>break</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L47" data-line-number="47"></td>
          <td id="file-heap-lisp-c-LC47">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L48" data-line-number="48"></td>
          <td id="file-heap-lisp-c-LC48">    <span>// Anything else is a symbol</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L49" data-line-number="49"></td>
          <td id="file-heap-lisp-c-LC49">    <span>default</span>:</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L50" data-line-number="50"></td>
          <td id="file-heap-lisp-c-LC50">      <span>for</span>(<span>int</span> <span>i</span> <span>=</span> <span>0</span>;; <span>++</span><span>i</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L51" data-line-number="51"></td>
          <td id="file-heap-lisp-c-LC51">	<span>if</span>(<span>input</span>[<span>ii</span>] <span>!=</span> <span>&#39; &#39;</span>  <span>&amp;&amp;</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L52" data-line-number="52"></td>
          <td id="file-heap-lisp-c-LC52">	   <span>input</span>[<span>ii</span>] <span>!=</span> <span>&#39;)&#39;</span>  <span>&amp;&amp;</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L53" data-line-number="53"></td>
          <td id="file-heap-lisp-c-LC53">           <span>input</span>[<span>ii</span>] <span>!=</span> <span>&#39;(&#39;</span>  <span>&amp;&amp;</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L54" data-line-number="54"></td>
          <td id="file-heap-lisp-c-LC54">           <span>input</span>[<span>ii</span>] <span>!=</span> <span>&#39;\n&#39;</span> <span>&amp;&amp;</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L55" data-line-number="55"></td>
          <td id="file-heap-lisp-c-LC55">           <span>input</span>[<span>ii</span>] <span>!=</span> <span>&#39;\0&#39;</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L56" data-line-number="56"></td>
          <td id="file-heap-lisp-c-LC56">          <span>token</span>[<span>ti</span>][<span>i</span>] <span>=</span> <span>input</span>[<span>ii</span><span>++</span>];</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L57" data-line-number="57"></td>
          <td id="file-heap-lisp-c-LC57">        }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L58" data-line-number="58"></td>
          <td id="file-heap-lisp-c-LC58">        <span>else</span> {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L59" data-line-number="59"></td>
          <td id="file-heap-lisp-c-LC59">          <span>token</span>[<span>ti</span>][<span>i</span>] <span>=</span> <span>&#39;\0&#39;</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L60" data-line-number="60"></td>
          <td id="file-heap-lisp-c-LC60">          <span>break</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L61" data-line-number="61"></td>
          <td id="file-heap-lisp-c-LC61">        }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L62" data-line-number="62"></td>
          <td id="file-heap-lisp-c-LC62">      }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L63" data-line-number="63"></td>
          <td id="file-heap-lisp-c-LC63">      <span>++</span><span>ti</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L64" data-line-number="64"></td>
          <td id="file-heap-lisp-c-LC64">      <span>break</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L65" data-line-number="65"></td>
          <td id="file-heap-lisp-c-LC65">    }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L66" data-line-number="66"></td>
          <td id="file-heap-lisp-c-LC66">  <span>return</span> <span>ti</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L67" data-line-number="67"></td>
          <td id="file-heap-lisp-c-LC67">}</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L68" data-line-number="68"></td>
          <td id="file-heap-lisp-c-LC68">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L69" data-line-number="69"></td>
          <td id="file-heap-lisp-c-LC69"><span>int</span> <span>curtok</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L70" data-line-number="70"></td>
          <td id="file-heap-lisp-c-LC70">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L71" data-line-number="71"></td>
          <td id="file-heap-lisp-c-LC71"><span>char</span><span>*</span> <span>nexttok</span>() {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L72" data-line-number="72"></td>
          <td id="file-heap-lisp-c-LC72">  <span>return</span> <span>token</span>[<span>curtok</span><span>++</span>];</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L73" data-line-number="73"></td>
          <td id="file-heap-lisp-c-LC73">}</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L74" data-line-number="74"></td>
          <td id="file-heap-lisp-c-LC74">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L75" data-line-number="75"></td>
          <td id="file-heap-lisp-c-LC75"><span>char</span><span>*</span> <span>peektok</span>() {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L76" data-line-number="76"></td>
          <td id="file-heap-lisp-c-LC76">  <span>return</span> <span>token</span>[<span>curtok</span>];</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L77" data-line-number="77"></td>
          <td id="file-heap-lisp-c-LC77">}</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L78" data-line-number="78"></td>
          <td id="file-heap-lisp-c-LC78">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L79" data-line-number="79"></td>
          <td id="file-heap-lisp-c-LC79">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L80" data-line-number="80"></td>
          <td id="file-heap-lisp-c-LC80"><span>typedef</span> <span>struct</span> <span>Pair</span> {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L81" data-line-number="81"></td>
          <td id="file-heap-lisp-c-LC81">  <span>void</span><span>*</span> <span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L82" data-line-number="82"></td>
          <td id="file-heap-lisp-c-LC82">  <span>void</span><span>*</span> <span>cdr</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L83" data-line-number="83"></td>
          <td id="file-heap-lisp-c-LC83">} <span>Pair</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L84" data-line-number="84"></td>
          <td id="file-heap-lisp-c-LC84">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L85" data-line-number="85"></td>
          <td id="file-heap-lisp-c-LC85"><span>typedef</span> <span>struct</span> <span>Text</span> {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L86" data-line-number="86"></td>
          <td id="file-heap-lisp-c-LC86">  <span>char</span><span>*</span> <span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L87" data-line-number="87"></td>
          <td id="file-heap-lisp-c-LC87">  <span>struct</span> <span>Text</span><span>*</span> <span>cdr</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L88" data-line-number="88"></td>
          <td id="file-heap-lisp-c-LC88">} <span>Text</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L89" data-line-number="89"></td>
          <td id="file-heap-lisp-c-LC89">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L90" data-line-number="90"></td>
          <td id="file-heap-lisp-c-LC90"><span>Pair</span> <span>text</span>[<span>1280</span>];</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L91" data-line-number="91"></td>
          <td id="file-heap-lisp-c-LC91"><span>Pair</span><span>*</span> <span>textptr</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L92" data-line-number="92"></td>
          <td id="file-heap-lisp-c-LC92">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L93" data-line-number="93"></td>
          <td id="file-heap-lisp-c-LC93"><span>int</span> <span>istext</span>(<span>void</span><span>*</span> <span>x</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L94" data-line-number="94"></td>
          <td id="file-heap-lisp-c-LC94">  <span>return</span> <span>x</span> &gt;= (<span>void</span><span>*</span>)<span>&amp;</span><span>text</span> <span>&amp;&amp;</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L95" data-line-number="95"></td>
          <td id="file-heap-lisp-c-LC95">         <span>x</span> <span>&lt;</span>  (<span>void</span><span>*</span>)<span>&amp;</span><span>text</span>[<span>1280</span>];</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L96" data-line-number="96"></td>
          <td id="file-heap-lisp-c-LC96">}</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L97" data-line-number="97"></td>
          <td id="file-heap-lisp-c-LC97">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L98" data-line-number="98"></td>
          <td id="file-heap-lisp-c-LC98"><span>Pair</span><span>*</span> <span>cons</span>(<span>void</span><span>*</span> <span>x</span>, <span>void</span><span>*</span> <span>y</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L99" data-line-number="99"></td>
          <td id="file-heap-lisp-c-LC99">  <span>assert</span>(<span>istext</span>(<span>textptr</span>));</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L100" data-line-number="100"></td>
          <td id="file-heap-lisp-c-LC100">  <span>textptr</span><span>-&gt;</span><span>car</span> <span>=</span> <span>x</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L101" data-line-number="101"></td>
          <td id="file-heap-lisp-c-LC101">  <span>textptr</span><span>-&gt;</span><span>cdr</span> <span>=</span> <span>y</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L102" data-line-number="102"></td>
          <td id="file-heap-lisp-c-LC102">  <span>return</span> <span>textptr</span><span>++</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L103" data-line-number="103"></td>
          <td id="file-heap-lisp-c-LC103">}</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L104" data-line-number="104"></td>
          <td id="file-heap-lisp-c-LC104">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L105" data-line-number="105"></td>
          <td id="file-heap-lisp-c-LC105"><span>void</span><span>*</span> <span>read</span>(<span>char</span><span>*</span> <span>ln</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L106" data-line-number="106"></td>
          <td id="file-heap-lisp-c-LC106"><span>void</span><span>*</span> <span>read_exp</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L107" data-line-number="107"></td>
          <td id="file-heap-lisp-c-LC107"><span>void</span><span>*</span> <span>read_list</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L108" data-line-number="108"></td>
          <td id="file-heap-lisp-c-LC108">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L109" data-line-number="109"></td>
          <td id="file-heap-lisp-c-LC109"><span>void</span><span>*</span> <span>read</span>(<span>char</span><span>*</span> <span>ln</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L110" data-line-number="110"></td>
          <td id="file-heap-lisp-c-LC110">  <span>// Initialize the lexer and list memory.</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L111" data-line-number="111"></td>
          <td id="file-heap-lisp-c-LC111">  <span>curtok</span> <span>=</span> <span>0</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L112" data-line-number="112"></td>
          <td id="file-heap-lisp-c-LC112">  <span>textptr</span> <span>=</span> <span>text</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L113" data-line-number="113"></td>
          <td id="file-heap-lisp-c-LC113">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L114" data-line-number="114"></td>
          <td id="file-heap-lisp-c-LC114">  <span>lexer</span>(<span>ln</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L115" data-line-number="115"></td>
          <td id="file-heap-lisp-c-LC115">  <span>return</span> <span>read_exp</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L116" data-line-number="116"></td>
          <td id="file-heap-lisp-c-LC116">}</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L117" data-line-number="117"></td>
          <td id="file-heap-lisp-c-LC117">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L118" data-line-number="118"></td>
          <td id="file-heap-lisp-c-LC118"><span>void</span><span>*</span> <span>read_exp</span>() {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L119" data-line-number="119"></td>
          <td id="file-heap-lisp-c-LC119">  <span>char</span><span>*</span> <span>tok</span> <span>=</span> <span>nexttok</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L120" data-line-number="120"></td>
          <td id="file-heap-lisp-c-LC120">  <span>if</span> (<span>tok</span>[<span>0</span>] <span>==</span> <span>&#39;(&#39;</span> <span>&amp;&amp;</span> <span>peektok</span>()[<span>0</span>] <span>==</span> <span>&#39;)&#39;</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L121" data-line-number="121"></td>
          <td id="file-heap-lisp-c-LC121">    <span>nexttok</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L122" data-line-number="122"></td>
          <td id="file-heap-lisp-c-LC122">    <span>return</span> <span>NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L123" data-line-number="123"></td>
          <td id="file-heap-lisp-c-LC123">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L124" data-line-number="124"></td>
          <td id="file-heap-lisp-c-LC124">  <span>else</span> <span>if</span> (<span>tok</span>[<span>0</span>] <span>==</span> <span>&#39;\&#39;&#39;</span>)</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L125" data-line-number="125"></td>
          <td id="file-heap-lisp-c-LC125">    <span>return</span> <span>cons</span>(<span>&#34;quote&#34;</span>, <span>cons</span>(<span>read_exp</span>(), <span>NULL</span>));</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L126" data-line-number="126"></td>
          <td id="file-heap-lisp-c-LC126">  <span>else</span> <span>if</span> (<span>tok</span>[<span>0</span>] <span>==</span> <span>&#39;(&#39;</span>)</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L127" data-line-number="127"></td>
          <td id="file-heap-lisp-c-LC127">    <span>return</span> <span>read_list</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L128" data-line-number="128"></td>
          <td id="file-heap-lisp-c-LC128">  <span>else</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L129" data-line-number="129"></td>
          <td id="file-heap-lisp-c-LC129">    <span>return</span> <span>tok</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L130" data-line-number="130"></td>
          <td id="file-heap-lisp-c-LC130">}</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L131" data-line-number="131"></td>
          <td id="file-heap-lisp-c-LC131">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L132" data-line-number="132"></td>
          <td id="file-heap-lisp-c-LC132"><span>void</span><span>*</span> <span>read_list</span>() {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L133" data-line-number="133"></td>
          <td id="file-heap-lisp-c-LC133">  <span>char</span><span>*</span> <span>tok</span> <span>=</span> <span>peektok</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L134" data-line-number="134"></td>
          <td id="file-heap-lisp-c-LC134">  <span>if</span>(<span>tok</span>[<span>0</span>] <span>==</span> <span>&#39;)&#39;</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L135" data-line-number="135"></td>
          <td id="file-heap-lisp-c-LC135">    <span>nexttok</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L136" data-line-number="136"></td>
          <td id="file-heap-lisp-c-LC136">    <span>return</span> <span>NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L137" data-line-number="137"></td>
          <td id="file-heap-lisp-c-LC137">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L138" data-line-number="138"></td>
          <td id="file-heap-lisp-c-LC138">  <span>else</span> <span>if</span>(<span>tok</span>[<span>0</span>] <span>==</span> <span>&#39;.&#39;</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L139" data-line-number="139"></td>
          <td id="file-heap-lisp-c-LC139">    <span>nexttok</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L140" data-line-number="140"></td>
          <td id="file-heap-lisp-c-LC140">    <span>tok</span> <span>=</span> <span>read_exp</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L141" data-line-number="141"></td>
          <td id="file-heap-lisp-c-LC141">    <span>nexttok</span>();    </td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L142" data-line-number="142"></td>
          <td id="file-heap-lisp-c-LC142">    <span>return</span> <span>tok</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L143" data-line-number="143"></td>
          <td id="file-heap-lisp-c-LC143">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L144" data-line-number="144"></td>
          <td id="file-heap-lisp-c-LC144">  <span>else</span> {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L145" data-line-number="145"></td>
          <td id="file-heap-lisp-c-LC145">    <span>void</span><span>*</span> <span>fst</span> <span>=</span> <span>read_exp</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L146" data-line-number="146"></td>
          <td id="file-heap-lisp-c-LC146">    <span>void</span><span>*</span> <span>snd</span> <span>=</span> <span>read_list</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L147" data-line-number="147"></td>
          <td id="file-heap-lisp-c-LC147">    <span>return</span> <span>cons</span>(<span>fst</span>, <span>snd</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L148" data-line-number="148"></td>
          <td id="file-heap-lisp-c-LC148">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L149" data-line-number="149"></td>
          <td id="file-heap-lisp-c-LC149">}</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L150" data-line-number="150"></td>
          <td id="file-heap-lisp-c-LC150">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L151" data-line-number="151"></td>
          <td id="file-heap-lisp-c-LC151"><span>void</span> <span>print</span>(<span>void</span><span>*</span> <span>exp</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L152" data-line-number="152"></td>
          <td id="file-heap-lisp-c-LC152"><span>void</span> <span>print_exp</span>(<span>void</span><span>*</span> <span>exp</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L153" data-line-number="153"></td>
          <td id="file-heap-lisp-c-LC153"><span>void</span> <span>print_list</span>(<span>Pair</span><span>*</span> <span>list</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L154" data-line-number="154"></td>
          <td id="file-heap-lisp-c-LC154"><span>void</span> <span>print_cons</span>(<span>Pair</span><span>*</span> <span>pair</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L155" data-line-number="155"></td>
          <td id="file-heap-lisp-c-LC155">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L156" data-line-number="156"></td>
          <td id="file-heap-lisp-c-LC156"><span>void</span> <span>print</span>(<span>void</span><span>*</span> <span>exp</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L157" data-line-number="157"></td>
          <td id="file-heap-lisp-c-LC157">  <span>print_exp</span>(<span>exp</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L158" data-line-number="158"></td>
          <td id="file-heap-lisp-c-LC158">  <span>printf</span>(<span>&#34;\n&#34;</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L159" data-line-number="159"></td>
          <td id="file-heap-lisp-c-LC159">}</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L160" data-line-number="160"></td>
          <td id="file-heap-lisp-c-LC160">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L161" data-line-number="161"></td>
          <td id="file-heap-lisp-c-LC161"><span>void</span> <span>print_exp</span>(<span>void</span><span>*</span> <span>exp</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L162" data-line-number="162"></td>
          <td id="file-heap-lisp-c-LC162">  <span>if</span> (<span>istext</span>(<span>exp</span>)) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L163" data-line-number="163"></td>
          <td id="file-heap-lisp-c-LC163">    <span>Pair</span><span>*</span> <span>pair</span> <span>=</span> <span>exp</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L164" data-line-number="164"></td>
          <td id="file-heap-lisp-c-LC164">    <span>if</span>(!<span>istext</span>(<span>pair</span><span>-&gt;</span><span>cdr</span>) <span>&amp;&amp;</span> <span>pair</span><span>-&gt;</span><span>cdr</span> <span>!=</span> <span>NULL</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L165" data-line-number="165"></td>
          <td id="file-heap-lisp-c-LC165">      <span>printf</span>(<span>&#34;(&#34;</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L166" data-line-number="166"></td>
          <td id="file-heap-lisp-c-LC166">      <span>print_cons</span>(<span>exp</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L167" data-line-number="167"></td>
          <td id="file-heap-lisp-c-LC167">      <span>printf</span>(<span>&#34;)&#34;</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L168" data-line-number="168"></td>
          <td id="file-heap-lisp-c-LC168">    }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L169" data-line-number="169"></td>
          <td id="file-heap-lisp-c-LC169">    <span>else</span> {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L170" data-line-number="170"></td>
          <td id="file-heap-lisp-c-LC170">      <span>printf</span>(<span>&#34;(&#34;</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L171" data-line-number="171"></td>
          <td id="file-heap-lisp-c-LC171">      <span>print_list</span>(<span>exp</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L172" data-line-number="172"></td>
          <td id="file-heap-lisp-c-LC172">    }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L173" data-line-number="173"></td>
          <td id="file-heap-lisp-c-LC173">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L174" data-line-number="174"></td>
          <td id="file-heap-lisp-c-LC174">  <span>else</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L175" data-line-number="175"></td>
          <td id="file-heap-lisp-c-LC175">    <span>printf</span>(<span>&#34;%s&#34;</span>, <span>exp</span> ? (<span>char</span><span>*</span>)<span>exp</span> : <span>&#34;()&#34;</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L176" data-line-number="176"></td>
          <td id="file-heap-lisp-c-LC176">}</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L177" data-line-number="177"></td>
          <td id="file-heap-lisp-c-LC177">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L178" data-line-number="178"></td>
          <td id="file-heap-lisp-c-LC178"><span>void</span> <span>print_list</span>(<span>Pair</span><span>*</span> <span>list</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L179" data-line-number="179"></td>
          <td id="file-heap-lisp-c-LC179">  <span>if</span> (<span>list</span><span>-&gt;</span><span>cdr</span> <span>==</span> <span>NULL</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L180" data-line-number="180"></td>
          <td id="file-heap-lisp-c-LC180">    <span>print_exp</span>(<span>list</span><span>-&gt;</span><span>car</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L181" data-line-number="181"></td>
          <td id="file-heap-lisp-c-LC181">    <span>printf</span>(<span>&#34;)&#34;</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L182" data-line-number="182"></td>
          <td id="file-heap-lisp-c-LC182">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L183" data-line-number="183"></td>
          <td id="file-heap-lisp-c-LC183">  <span>else</span> {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L184" data-line-number="184"></td>
          <td id="file-heap-lisp-c-LC184">    <span>if</span>(!<span>istext</span>(<span>list</span><span>-&gt;</span><span>cdr</span>) <span>&amp;&amp;</span> <span>list</span><span>-&gt;</span><span>cdr</span> <span>!=</span> <span>NULL</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L185" data-line-number="185"></td>
          <td id="file-heap-lisp-c-LC185">      <span>print_cons</span>(<span>list</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L186" data-line-number="186"></td>
          <td id="file-heap-lisp-c-LC186">      <span>printf</span>(<span>&#34;)&#34;</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L187" data-line-number="187"></td>
          <td id="file-heap-lisp-c-LC187">    }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L188" data-line-number="188"></td>
          <td id="file-heap-lisp-c-LC188">    <span>else</span> {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L189" data-line-number="189"></td>
          <td id="file-heap-lisp-c-LC189">      <span>print_exp</span>(<span>list</span><span>-&gt;</span><span>car</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L190" data-line-number="190"></td>
          <td id="file-heap-lisp-c-LC190">      <span>printf</span>(<span>&#34; &#34;</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L191" data-line-number="191"></td>
          <td id="file-heap-lisp-c-LC191">      <span>print_list</span>(<span>list</span><span>-&gt;</span><span>cdr</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L192" data-line-number="192"></td>
          <td id="file-heap-lisp-c-LC192">    }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L193" data-line-number="193"></td>
          <td id="file-heap-lisp-c-LC193">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L194" data-line-number="194"></td>
          <td id="file-heap-lisp-c-LC194">}</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L195" data-line-number="195"></td>
          <td id="file-heap-lisp-c-LC195">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L196" data-line-number="196"></td>
          <td id="file-heap-lisp-c-LC196"><span>void</span> <span>print_cons</span>(<span>Pair</span><span>*</span> <span>pair</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L197" data-line-number="197"></td>
          <td id="file-heap-lisp-c-LC197">  <span>print_exp</span>(<span>pair</span><span>-&gt;</span><span>car</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L198" data-line-number="198"></td>
          <td id="file-heap-lisp-c-LC198">  <span>printf</span>(<span>&#34; . &#34;</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L199" data-line-number="199"></td>
          <td id="file-heap-lisp-c-LC199">  <span>print_exp</span>(<span>pair</span><span>-&gt;</span><span>cdr</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L200" data-line-number="200"></td>
          <td id="file-heap-lisp-c-LC200">}</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L201" data-line-number="201"></td>
          <td id="file-heap-lisp-c-LC201">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L202" data-line-number="202"></td>
          <td id="file-heap-lisp-c-LC202">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L203" data-line-number="203"></td>
          <td id="file-heap-lisp-c-LC203"><span>Pair</span><span>*</span> <span>compile</span>(<span>void</span><span>*</span> <span>exp</span>, <span>void</span><span>*</span> <span>next</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L204" data-line-number="204"></td>
          <td id="file-heap-lisp-c-LC204">  <span>if</span> (<span>istext</span>(<span>exp</span>)) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L205" data-line-number="205"></td>
          <td id="file-heap-lisp-c-LC205">    <span>Text</span><span>*</span> <span>p</span> <span>=</span> <span>exp</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L206" data-line-number="206"></td>
          <td id="file-heap-lisp-c-LC206">    <span>if</span> (<span>strcmp</span>(<span>p</span><span>-&gt;</span><span>car</span>, <span>&#34;quote&#34;</span>) <span>==</span> <span>0</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L207" data-line-number="207"></td>
          <td id="file-heap-lisp-c-LC207">      <span>return</span> <span>cons</span>(<span>&#34;constant&#34;</span>, <span>cons</span>(<span>p</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>, <span>cons</span>(<span>next</span>, <span>NULL</span>)));</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L208" data-line-number="208"></td>
          <td id="file-heap-lisp-c-LC208">    }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L209" data-line-number="209"></td>
          <td id="file-heap-lisp-c-LC209">    <span>else</span> <span>if</span> (<span>strcmp</span>(<span>p</span><span>-&gt;</span><span>car</span>, <span>&#34;lambda&#34;</span>) <span>==</span> <span>0</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L210" data-line-number="210"></td>
          <td id="file-heap-lisp-c-LC210">      <span>return</span> <span>cons</span>(<span>&#34;close&#34;</span>, <span>cons</span>(<span>p</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>, <span>cons</span>(<span>compile</span>(<span>p</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>, <span>cons</span>(<span>&#34;return&#34;</span>, <span>NULL</span>)), <span>cons</span>(<span>next</span>, <span>NULL</span>))));</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L211" data-line-number="211"></td>
          <td id="file-heap-lisp-c-LC211">    }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L212" data-line-number="212"></td>
          <td id="file-heap-lisp-c-LC212">    <span>else</span> <span>if</span> (<span>strcmp</span>(<span>p</span><span>-&gt;</span><span>car</span>, <span>&#34;if&#34;</span>) <span>==</span> <span>0</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L213" data-line-number="213"></td>
          <td id="file-heap-lisp-c-LC213">      <span>return</span> <span>compile</span>(<span>p</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>, <span>cons</span>(<span>&#34;test&#34;</span>, <span>cons</span>(<span>compile</span>(<span>p</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>, <span>next</span>),</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L214" data-line-number="214"></td>
          <td id="file-heap-lisp-c-LC214">                                                    <span>cons</span>(<span>compile</span>(<span>p</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>, <span>next</span>),</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L215" data-line-number="215"></td>
          <td id="file-heap-lisp-c-LC215">                                                         <span>NULL</span>))));</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L216" data-line-number="216"></td>
          <td id="file-heap-lisp-c-LC216">    }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L217" data-line-number="217"></td>
          <td id="file-heap-lisp-c-LC217">    <span>else</span> <span>if</span> (<span>strcmp</span>(<span>p</span><span>-&gt;</span><span>car</span>, <span>&#34;set!&#34;</span>) <span>==</span> <span>0</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L218" data-line-number="218"></td>
          <td id="file-heap-lisp-c-LC218">      <span>return</span> <span>compile</span>(<span>p</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>, <span>cons</span>(<span>&#34;assign&#34;</span>, <span>cons</span>(<span>p</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>, <span>cons</span>(<span>next</span>, <span>NULL</span>))));</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L219" data-line-number="219"></td>
          <td id="file-heap-lisp-c-LC219">    }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L220" data-line-number="220"></td>
          <td id="file-heap-lisp-c-LC220">    <span>else</span> <span>if</span> (<span>strcmp</span>(<span>p</span><span>-&gt;</span><span>car</span>, <span>&#34;call/cc&#34;</span>) <span>==</span> <span>0</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L221" data-line-number="221"></td>
          <td id="file-heap-lisp-c-LC221">      <span>void</span><span>*</span> <span>c</span> <span>=</span> <span>cons</span>(<span>&#34;conti&#34;</span>, <span>cons</span>(<span>cons</span>(<span>&#34;argument&#34;</span>, <span>cons</span>(<span>compile</span>(<span>p</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>, <span>cons</span>(<span>&#34;apply&#34;</span>, <span>NULL</span>)), <span>NULL</span>)), <span>NULL</span>));</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L222" data-line-number="222"></td>
          <td id="file-heap-lisp-c-LC222">      <span>Text</span><span>*</span> <span>n</span> <span>=</span> <span>next</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L223" data-line-number="223"></td>
          <td id="file-heap-lisp-c-LC223">      <span>if</span> (<span>strcmp</span>(<span>n</span><span>-&gt;</span><span>car</span>, <span>&#34;return&#34;</span>) <span>==</span> <span>0</span>)</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L224" data-line-number="224"></td>
          <td id="file-heap-lisp-c-LC224">        <span>return</span> <span>c</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L225" data-line-number="225"></td>
          <td id="file-heap-lisp-c-LC225">      <span>else</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L226" data-line-number="226"></td>
          <td id="file-heap-lisp-c-LC226">        <span>return</span> <span>cons</span>(<span>&#34;frame&#34;</span>, <span>cons</span>(<span>next</span>, <span>cons</span>(<span>c</span>, <span>NULL</span>)));</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L227" data-line-number="227"></td>
          <td id="file-heap-lisp-c-LC227">    }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L228" data-line-number="228"></td>
          <td id="file-heap-lisp-c-LC228">    <span>else</span> {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L229" data-line-number="229"></td>
          <td id="file-heap-lisp-c-LC229">      <span>Pair</span><span>*</span> <span>args</span> <span>=</span> (<span>Pair</span><span>*</span>)<span>p</span><span>-&gt;</span><span>cdr</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L230" data-line-number="230"></td>
          <td id="file-heap-lisp-c-LC230">      <span>void</span><span>*</span> <span>c</span> <span>=</span> <span>compile</span>(<span>p</span><span>-&gt;</span><span>car</span>, <span>cons</span>(<span>&#34;apply&#34;</span>, <span>NULL</span>));</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L231" data-line-number="231"></td>
          <td id="file-heap-lisp-c-LC231">      <span>while</span> (<span>args</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L232" data-line-number="232"></td>
          <td id="file-heap-lisp-c-LC232">        <span>c</span> <span>=</span> <span>compile</span>(<span>args</span><span>-&gt;</span><span>car</span>, <span>cons</span>(<span>&#34;argument&#34;</span>, <span>cons</span>(<span>c</span>, <span>NULL</span>)));</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L233" data-line-number="233"></td>
          <td id="file-heap-lisp-c-LC233">        <span>args</span> <span>=</span> <span>args</span><span>-&gt;</span><span>cdr</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L234" data-line-number="234"></td>
          <td id="file-heap-lisp-c-LC234">      }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L235" data-line-number="235"></td>
          <td id="file-heap-lisp-c-LC235">      <span>Text</span><span>*</span> <span>n</span> <span>=</span> <span>next</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L236" data-line-number="236"></td>
          <td id="file-heap-lisp-c-LC236">      <span>if</span> (<span>strcmp</span>(<span>n</span><span>-&gt;</span><span>car</span>, <span>&#34;return&#34;</span>) <span>==</span> <span>0</span>)</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L237" data-line-number="237"></td>
          <td id="file-heap-lisp-c-LC237">        <span>return</span> <span>c</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L238" data-line-number="238"></td>
          <td id="file-heap-lisp-c-LC238">      <span>else</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L239" data-line-number="239"></td>
          <td id="file-heap-lisp-c-LC239">        <span>return</span> <span>cons</span>(<span>&#34;frame&#34;</span>, <span>cons</span>(<span>next</span>, <span>cons</span>(<span>c</span>, <span>NULL</span>)));</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L240" data-line-number="240"></td>
          <td id="file-heap-lisp-c-LC240">    }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L241" data-line-number="241"></td>
          <td id="file-heap-lisp-c-LC241">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L242" data-line-number="242"></td>
          <td id="file-heap-lisp-c-LC242">  <span>else</span> <span>if</span>(<span>isdigit</span>(<span>*</span>((<span>char</span><span>*</span>)<span>exp</span>))) { <span>// a number</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L243" data-line-number="243"></td>
          <td id="file-heap-lisp-c-LC243">    <span>return</span> <span>cons</span>(<span>&#34;constant&#34;</span>, <span>cons</span>(<span>exp</span>, <span>cons</span>(<span>next</span>, <span>NULL</span>)));</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L244" data-line-number="244"></td>
          <td id="file-heap-lisp-c-LC244">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L245" data-line-number="245"></td>
          <td id="file-heap-lisp-c-LC245">  <span>else</span> <span>if</span>(<span>strcmp</span>(<span>exp</span>, <span>&#34;#t&#34;</span>) <span>==</span> <span>0</span>) { <span>// a boolean</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L246" data-line-number="246"></td>
          <td id="file-heap-lisp-c-LC246">    <span>return</span> <span>cons</span>(<span>&#34;constant&#34;</span>, <span>cons</span>(<span>exp</span>, <span>cons</span>(<span>next</span>, <span>NULL</span>)));</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L247" data-line-number="247"></td>
          <td id="file-heap-lisp-c-LC247">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L248" data-line-number="248"></td>
          <td id="file-heap-lisp-c-LC248">  <span>else</span> <span>if</span>(<span>strcmp</span>(<span>exp</span>, <span>&#34;#f&#34;</span>) <span>==</span> <span>0</span>) { <span>// a boolean</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L249" data-line-number="249"></td>
          <td id="file-heap-lisp-c-LC249">    <span>return</span> <span>cons</span>(<span>&#34;constant&#34;</span>, <span>cons</span>(<span>exp</span>, <span>cons</span>(<span>next</span>, <span>NULL</span>)));</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L250" data-line-number="250"></td>
          <td id="file-heap-lisp-c-LC250">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L251" data-line-number="251"></td>
          <td id="file-heap-lisp-c-LC251">  <span>else</span> { <span>// a symbol</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L252" data-line-number="252"></td>
          <td id="file-heap-lisp-c-LC252">    <span>return</span> <span>cons</span>(<span>&#34;refer&#34;</span>, <span>cons</span>(<span>exp</span>, <span>cons</span>(<span>next</span>, <span>NULL</span>)));</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L253" data-line-number="253"></td>
          <td id="file-heap-lisp-c-LC253">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L254" data-line-number="254"></td>
          <td id="file-heap-lisp-c-LC254">}</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L255" data-line-number="255"></td>
          <td id="file-heap-lisp-c-LC255">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L256" data-line-number="256"></td>
          <td id="file-heap-lisp-c-LC256"><span>void</span><span>*</span> <span>get</span>(<span>void</span><span>*</span> <span>env</span>, <span>char</span><span>*</span> <span>var</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L257" data-line-number="257"></td>
          <td id="file-heap-lisp-c-LC257">  <span>Pair</span><span>*</span> <span>e</span> <span>=</span> <span>env</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L258" data-line-number="258"></td>
          <td id="file-heap-lisp-c-LC258">  <span>while</span>(<span>env</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L259" data-line-number="259"></td>
          <td id="file-heap-lisp-c-LC259">    <span>Pair</span><span>*</span> <span>cur</span> <span>=</span> <span>e</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L260" data-line-number="260"></td>
          <td id="file-heap-lisp-c-LC260">    <span>Pair</span><span>*</span> <span>vars</span> <span>=</span> <span>cur</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L261" data-line-number="261"></td>
          <td id="file-heap-lisp-c-LC261">    <span>Pair</span><span>*</span> <span>vals</span> <span>=</span> <span>cur</span><span>-&gt;</span><span>cdr</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L262" data-line-number="262"></td>
          <td id="file-heap-lisp-c-LC262">    <span>while</span> (<span>vars</span> <span>&amp;&amp;</span> <span>vals</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L263" data-line-number="263"></td>
          <td id="file-heap-lisp-c-LC263">      <span>if</span> (<span>strcmp</span>(<span>vars</span><span>-&gt;</span><span>car</span>, <span>var</span>) <span>==</span> <span>0</span>)</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L264" data-line-number="264"></td>
          <td id="file-heap-lisp-c-LC264">        <span>return</span> <span>vals</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L265" data-line-number="265"></td>
          <td id="file-heap-lisp-c-LC265">      <span>vars</span> <span>=</span> <span>vars</span><span>-&gt;</span><span>cdr</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L266" data-line-number="266"></td>
          <td id="file-heap-lisp-c-LC266">      <span>vals</span> <span>=</span> <span>vals</span><span>-&gt;</span><span>cdr</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L267" data-line-number="267"></td>
          <td id="file-heap-lisp-c-LC267">    }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L268" data-line-number="268"></td>
          <td id="file-heap-lisp-c-LC268">    <span>e</span> <span>=</span> <span>e</span><span>-&gt;</span><span>cdr</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L269" data-line-number="269"></td>
          <td id="file-heap-lisp-c-LC269">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L270" data-line-number="270"></td>
          <td id="file-heap-lisp-c-LC270">  <span>fprintf</span>(<span>stderr</span>, <span>&#34;No definition in environment for %s.\n&#34;</span>, <span>var</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L271" data-line-number="271"></td>
          <td id="file-heap-lisp-c-LC271">  <span>assert</span>(<span>0</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L272" data-line-number="272"></td>
          <td id="file-heap-lisp-c-LC272">}</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L273" data-line-number="273"></td>
          <td id="file-heap-lisp-c-LC273">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L274" data-line-number="274"></td>
          <td id="file-heap-lisp-c-LC274"><span>void</span> <span>set</span>(<span>void</span><span>*</span> <span>env</span>, <span>char</span><span>*</span> <span>var</span>, <span>char</span><span>*</span> <span>val</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L275" data-line-number="275"></td>
          <td id="file-heap-lisp-c-LC275">  <span>void</span><span>*</span> <span>ref</span> <span>=</span> <span>get</span>(<span>env</span>, <span>var</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L276" data-line-number="276"></td>
          <td id="file-heap-lisp-c-LC276">  <span>ref</span> <span>=</span> <span>val</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L277" data-line-number="277"></td>
          <td id="file-heap-lisp-c-LC277">}</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L278" data-line-number="278"></td>
          <td id="file-heap-lisp-c-LC278">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L279" data-line-number="279"></td>
          <td id="file-heap-lisp-c-LC279"><span>void</span><span>*</span> <span>extend</span>(<span>void</span><span>*</span> <span>env</span>, <span>void</span><span>*</span> <span>vars</span>, <span>void</span><span>*</span> <span>vals</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L280" data-line-number="280"></td>
          <td id="file-heap-lisp-c-LC280">  <span>return</span> <span>cons</span>(<span>cons</span>(<span>vars</span>, <span>vals</span>), <span>env</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L281" data-line-number="281"></td>
          <td id="file-heap-lisp-c-LC281">}</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L282" data-line-number="282"></td>
          <td id="file-heap-lisp-c-LC282">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L283" data-line-number="283"></td>
          <td id="file-heap-lisp-c-LC283"><span>void</span><span>*</span> <span>callframe</span>(<span>void</span><span>*</span> <span>next</span>, <span>void</span><span>*</span> <span>env</span>, <span>void</span><span>*</span> <span>rib</span>, <span>void</span><span>*</span> <span>stack</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L284" data-line-number="284"></td>
          <td id="file-heap-lisp-c-LC284">  <span>return</span> <span>cons</span>(<span>next</span>, <span>cons</span>(<span>env</span>, <span>cons</span>(<span>rib</span>, <span>cons</span>(<span>stack</span>, <span>NULL</span>))));</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L285" data-line-number="285"></td>
          <td id="file-heap-lisp-c-LC285">}</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L286" data-line-number="286"></td>
          <td id="file-heap-lisp-c-LC286">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L287" data-line-number="287"></td>
          <td id="file-heap-lisp-c-LC287"><span>void</span><span>*</span> <span>closure</span>(<span>void</span><span>*</span> <span>body</span>, <span>void</span><span>*</span> <span>env</span>, <span>void</span><span>*</span> <span>vars</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L288" data-line-number="288"></td>
          <td id="file-heap-lisp-c-LC288">  <span>return</span> <span>cons</span>(<span>body</span>, <span>cons</span>(<span>env</span>, <span>cons</span>(<span>vars</span>, <span>NULL</span>)));</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L289" data-line-number="289"></td>
          <td id="file-heap-lisp-c-LC289">}</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L290" data-line-number="290"></td>
          <td id="file-heap-lisp-c-LC290">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L291" data-line-number="291"></td>
          <td id="file-heap-lisp-c-LC291"><span>void</span><span>*</span> <span>continuation</span>(<span>void</span><span>*</span> <span>stack</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L292" data-line-number="292"></td>
          <td id="file-heap-lisp-c-LC292">  <span>return</span> <span>closure</span>(<span>cons</span>(<span>&#34;nuate&#34;</span>, <span>cons</span>(<span>stack</span>, <span>cons</span>(<span>&#34;v&#34;</span>, <span>NULL</span>))), <span>NULL</span>, <span>cons</span>(<span>&#34;v&#34;</span>, <span>NULL</span>));</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L293" data-line-number="293"></td>
          <td id="file-heap-lisp-c-LC293">}</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L294" data-line-number="294"></td>
          <td id="file-heap-lisp-c-LC294">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L295" data-line-number="295"></td>
          <td id="file-heap-lisp-c-LC295">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L296" data-line-number="296"></td>
          <td id="file-heap-lisp-c-LC296"><span>void</span><span>*</span> <span>accum</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L297" data-line-number="297"></td>
          <td id="file-heap-lisp-c-LC297"><span>void</span><span>*</span> <span>next</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L298" data-line-number="298"></td>
          <td id="file-heap-lisp-c-LC298"><span>void</span><span>*</span> <span>env</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L299" data-line-number="299"></td>
          <td id="file-heap-lisp-c-LC299"><span>void</span><span>*</span> <span>rib</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L300" data-line-number="300"></td>
          <td id="file-heap-lisp-c-LC300"><span>void</span><span>*</span> <span>stack</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L301" data-line-number="301"></td>
          <td id="file-heap-lisp-c-LC301">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L302" data-line-number="302"></td>
          <td id="file-heap-lisp-c-LC302"><span>void</span> <span>virtmach</span>() {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L303" data-line-number="303"></td>
          <td id="file-heap-lisp-c-LC303">  <span>Text</span><span>*</span> <span>n</span> <span>=</span> <span>next</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L304" data-line-number="304"></td>
          <td id="file-heap-lisp-c-LC304">  <span>if</span> (<span>strcmp</span>(<span>n</span><span>-&gt;</span><span>car</span>, <span>&#34;halt&#34;</span>) <span>==</span> <span>0</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L305" data-line-number="305"></td>
          <td id="file-heap-lisp-c-LC305">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L306" data-line-number="306"></td>
          <td id="file-heap-lisp-c-LC306">  <span>else</span> <span>if</span> (<span>strcmp</span>(<span>n</span><span>-&gt;</span><span>car</span>, <span>&#34;refer&#34;</span>) <span>==</span> <span>0</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L307" data-line-number="307"></td>
          <td id="file-heap-lisp-c-LC307">    <span>accum</span> <span>=</span> <span>get</span>(<span>env</span>, <span>n</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L308" data-line-number="308"></td>
          <td id="file-heap-lisp-c-LC308">    <span>next</span> <span>=</span> <span>n</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L309" data-line-number="309"></td>
          <td id="file-heap-lisp-c-LC309">    <span>return</span> <span>virtmach</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L310" data-line-number="310"></td>
          <td id="file-heap-lisp-c-LC310">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L311" data-line-number="311"></td>
          <td id="file-heap-lisp-c-LC311">  <span>else</span> <span>if</span> (<span>strcmp</span>(<span>n</span><span>-&gt;</span><span>car</span>, <span>&#34;constant&#34;</span>) <span>==</span> <span>0</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L312" data-line-number="312"></td>
          <td id="file-heap-lisp-c-LC312">    <span>accum</span> <span>=</span> <span>n</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L313" data-line-number="313"></td>
          <td id="file-heap-lisp-c-LC313">    <span>next</span> <span>=</span> <span>n</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L314" data-line-number="314"></td>
          <td id="file-heap-lisp-c-LC314">    <span>return</span> <span>virtmach</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L315" data-line-number="315"></td>
          <td id="file-heap-lisp-c-LC315">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L316" data-line-number="316"></td>
          <td id="file-heap-lisp-c-LC316">  <span>else</span> <span>if</span> (<span>strcmp</span>(<span>n</span><span>-&gt;</span><span>car</span>, <span>&#34;close&#34;</span>) <span>==</span> <span>0</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L317" data-line-number="317"></td>
          <td id="file-heap-lisp-c-LC317">    <span>void</span><span>*</span> <span>vars</span> <span>=</span> <span>n</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L318" data-line-number="318"></td>
          <td id="file-heap-lisp-c-LC318">    <span>void</span><span>*</span> <span>body</span> <span>=</span> <span>n</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L319" data-line-number="319"></td>
          <td id="file-heap-lisp-c-LC319">    <span>void</span><span>*</span> <span>x</span> <span>=</span> <span>n</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L320" data-line-number="320"></td>
          <td id="file-heap-lisp-c-LC320">    <span>accum</span> <span>=</span> <span>closure</span>(<span>body</span>, <span>env</span>, <span>vars</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L321" data-line-number="321"></td>
          <td id="file-heap-lisp-c-LC321">    <span>next</span> <span>=</span> <span>x</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L322" data-line-number="322"></td>
          <td id="file-heap-lisp-c-LC322">    <span>return</span> <span>virtmach</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L323" data-line-number="323"></td>
          <td id="file-heap-lisp-c-LC323">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L324" data-line-number="324"></td>
          <td id="file-heap-lisp-c-LC324">  <span>else</span> <span>if</span> (<span>strcmp</span>(<span>n</span><span>-&gt;</span><span>car</span>, <span>&#34;test&#34;</span>) <span>==</span> <span>0</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L325" data-line-number="325"></td>
          <td id="file-heap-lisp-c-LC325">    <span>void</span><span>*</span> <span>consequent</span> <span>=</span> <span>n</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L326" data-line-number="326"></td>
          <td id="file-heap-lisp-c-LC326">    <span>void</span><span>*</span> <span>alternate</span> <span>=</span> <span>n</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L327" data-line-number="327"></td>
          <td id="file-heap-lisp-c-LC327">    <span>next</span> <span>=</span> <span>strcmp</span>(<span>accum</span>, <span>&#34;#f&#34;</span>) <span>==</span> <span>0</span> ? <span>alternate</span> : <span>consequent</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L328" data-line-number="328"></td>
          <td id="file-heap-lisp-c-LC328">    <span>return</span> <span>virtmach</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L329" data-line-number="329"></td>
          <td id="file-heap-lisp-c-LC329">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L330" data-line-number="330"></td>
          <td id="file-heap-lisp-c-LC330">  <span>else</span> <span>if</span> (<span>strcmp</span>(<span>n</span><span>-&gt;</span><span>car</span>, <span>&#34;assign&#34;</span>) <span>==</span> <span>0</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L331" data-line-number="331"></td>
          <td id="file-heap-lisp-c-LC331">    <span>set</span>(<span>env</span>, <span>n</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>, <span>accum</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L332" data-line-number="332"></td>
          <td id="file-heap-lisp-c-LC332">    <span>next</span> <span>=</span> <span>n</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L333" data-line-number="333"></td>
          <td id="file-heap-lisp-c-LC333">    <span>return</span> <span>virtmach</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L334" data-line-number="334"></td>
          <td id="file-heap-lisp-c-LC334">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L335" data-line-number="335"></td>
          <td id="file-heap-lisp-c-LC335">  <span>else</span> <span>if</span> (<span>strcmp</span>(<span>n</span><span>-&gt;</span><span>car</span>, <span>&#34;conti&#34;</span>) <span>==</span> <span>0</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L336" data-line-number="336"></td>
          <td id="file-heap-lisp-c-LC336">    <span>accum</span> <span>=</span> <span>continuation</span>(<span>stack</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L337" data-line-number="337"></td>
          <td id="file-heap-lisp-c-LC337">    <span>next</span> <span>=</span> <span>n</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L338" data-line-number="338"></td>
          <td id="file-heap-lisp-c-LC338">    <span>return</span> <span>virtmach</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L339" data-line-number="339"></td>
          <td id="file-heap-lisp-c-LC339">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L340" data-line-number="340"></td>
          <td id="file-heap-lisp-c-LC340">  <span>else</span> <span>if</span> (<span>strcmp</span>(<span>n</span><span>-&gt;</span><span>car</span>, <span>&#34;nuate&#34;</span>) <span>==</span> <span>0</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L341" data-line-number="341"></td>
          <td id="file-heap-lisp-c-LC341">    <span>stack</span> <span>=</span> <span>n</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L342" data-line-number="342"></td>
          <td id="file-heap-lisp-c-LC342">    <span>accum</span> <span>=</span> <span>get</span>(<span>env</span>, <span>n</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L343" data-line-number="343"></td>
          <td id="file-heap-lisp-c-LC343">    <span>next</span> <span>=</span> <span>cons</span>(<span>&#34;return&#34;</span>, <span>NULL</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L344" data-line-number="344"></td>
          <td id="file-heap-lisp-c-LC344">    <span>return</span> <span>virtmach</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L345" data-line-number="345"></td>
          <td id="file-heap-lisp-c-LC345">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L346" data-line-number="346"></td>
          <td id="file-heap-lisp-c-LC346">  <span>else</span> <span>if</span> (<span>strcmp</span>(<span>n</span><span>-&gt;</span><span>car</span>, <span>&#34;frame&#34;</span>) <span>==</span> <span>0</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L347" data-line-number="347"></td>
          <td id="file-heap-lisp-c-LC347">    <span>stack</span> <span>=</span> <span>callframe</span>(<span>n</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>, <span>env</span>, <span>rib</span>, <span>stack</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L348" data-line-number="348"></td>
          <td id="file-heap-lisp-c-LC348">    <span>rib</span> <span>=</span> <span>NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L349" data-line-number="349"></td>
          <td id="file-heap-lisp-c-LC349">    <span>next</span> <span>=</span> <span>n</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L350" data-line-number="350"></td>
          <td id="file-heap-lisp-c-LC350">    <span>return</span> <span>virtmach</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L351" data-line-number="351"></td>
          <td id="file-heap-lisp-c-LC351">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L352" data-line-number="352"></td>
          <td id="file-heap-lisp-c-LC352">  <span>else</span> <span>if</span> (<span>strcmp</span>(<span>n</span><span>-&gt;</span><span>car</span>, <span>&#34;argument&#34;</span>) <span>==</span> <span>0</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L353" data-line-number="353"></td>
          <td id="file-heap-lisp-c-LC353">    <span>rib</span> <span>=</span> <span>cons</span>(<span>accum</span>, <span>rib</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L354" data-line-number="354"></td>
          <td id="file-heap-lisp-c-LC354">    <span>next</span> <span>=</span> <span>n</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L355" data-line-number="355"></td>
          <td id="file-heap-lisp-c-LC355">    <span>return</span> <span>virtmach</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L356" data-line-number="356"></td>
          <td id="file-heap-lisp-c-LC356">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L357" data-line-number="357"></td>
          <td id="file-heap-lisp-c-LC357">  <span>else</span> <span>if</span> (<span>strcmp</span>(<span>n</span><span>-&gt;</span><span>car</span>, <span>&#34;apply&#34;</span>) <span>==</span> <span>0</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L358" data-line-number="358"></td>
          <td id="file-heap-lisp-c-LC358">    <span>Text</span><span>*</span> <span>a</span> <span>=</span> <span>accum</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L359" data-line-number="359"></td>
          <td id="file-heap-lisp-c-LC359">    <span>void</span><span>*</span> <span>body</span> <span>=</span> <span>a</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L360" data-line-number="360"></td>
          <td id="file-heap-lisp-c-LC360">    <span>void</span><span>*</span> <span>clos</span> <span>=</span> <span>a</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L361" data-line-number="361"></td>
          <td id="file-heap-lisp-c-LC361">    <span>void</span><span>*</span> <span>vars</span> <span>=</span> <span>a</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L362" data-line-number="362"></td>
          <td id="file-heap-lisp-c-LC362">    <span>env</span> <span>=</span> <span>extend</span>(<span>env</span>, <span>vars</span>, <span>rib</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L363" data-line-number="363"></td>
          <td id="file-heap-lisp-c-LC363">    <span>rib</span> <span>=</span> <span>NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L364" data-line-number="364"></td>
          <td id="file-heap-lisp-c-LC364">    <span>next</span> <span>=</span> <span>body</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L365" data-line-number="365"></td>
          <td id="file-heap-lisp-c-LC365">    <span>return</span> <span>virtmach</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L366" data-line-number="366"></td>
          <td id="file-heap-lisp-c-LC366">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L367" data-line-number="367"></td>
          <td id="file-heap-lisp-c-LC367">  <span>else</span> <span>if</span> (<span>strcmp</span>(<span>n</span><span>-&gt;</span><span>car</span>, <span>&#34;return&#34;</span>) <span>==</span> <span>0</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L368" data-line-number="368"></td>
          <td id="file-heap-lisp-c-LC368">    <span>Text</span><span>*</span> <span>s</span> <span>=</span> <span>stack</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L369" data-line-number="369"></td>
          <td id="file-heap-lisp-c-LC369">    <span>next</span> <span>=</span> <span>s</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L370" data-line-number="370"></td>
          <td id="file-heap-lisp-c-LC370">    <span>env</span> <span>=</span> <span>s</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L371" data-line-number="371"></td>
          <td id="file-heap-lisp-c-LC371">    <span>rib</span> <span>=</span> <span>s</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L372" data-line-number="372"></td>
          <td id="file-heap-lisp-c-LC372">    <span>stack</span> <span>=</span> <span>s</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>cdr</span><span>-&gt;</span><span>car</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L373" data-line-number="373"></td>
          <td id="file-heap-lisp-c-LC373">    <span>return</span> <span>virtmach</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L374" data-line-number="374"></td>
          <td id="file-heap-lisp-c-LC374">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L375" data-line-number="375"></td>
          <td id="file-heap-lisp-c-LC375">  <span>else</span> {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L376" data-line-number="376"></td>
          <td id="file-heap-lisp-c-LC376">    <span>fprintf</span>(<span>stderr</span>, <span>&#34;Unhandled operation.\n&#34;</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L377" data-line-number="377"></td>
          <td id="file-heap-lisp-c-LC377">    <span>assert</span>(<span>0</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L378" data-line-number="378"></td>
          <td id="file-heap-lisp-c-LC378">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L379" data-line-number="379"></td>
          <td id="file-heap-lisp-c-LC379">}</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L380" data-line-number="380"></td>
          <td id="file-heap-lisp-c-LC380">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L381" data-line-number="381"></td>
          <td id="file-heap-lisp-c-LC381">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L382" data-line-number="382"></td>
          <td id="file-heap-lisp-c-LC382"><span>int</span> <span>main</span>(<span>int</span> <span>argc</span>, <span>char</span><span>*</span><span>*</span> <span>argv</span>) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L383" data-line-number="383"></td>
          <td id="file-heap-lisp-c-LC383">  <span>// note! repl implies there&#39;s a top-level but there isn&#39;t...</span></td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L384" data-line-number="384"></td>
          <td id="file-heap-lisp-c-LC384">  <span>printf</span>(<span>&#34;Lisp REPL\n\n&#34;</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L385" data-line-number="385"></td>
          <td id="file-heap-lisp-c-LC385">  <span>printf</span>(<span>&#34;&gt;&gt; &#34;</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L386" data-line-number="386"></td>
          <td id="file-heap-lisp-c-LC386">
</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L387" data-line-number="387"></td>
          <td id="file-heap-lisp-c-LC387">  <span>char</span> <span>buffer</span>[<span>256</span>];</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L388" data-line-number="388"></td>
          <td id="file-heap-lisp-c-LC388">  <span>while</span> (<span>fgets</span>(<span>buffer</span>, <span>256</span>, <span>stdin</span>)) {</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L389" data-line-number="389"></td>
          <td id="file-heap-lisp-c-LC389">    <span>next</span> <span>=</span> <span>compile</span>(<span>read</span>(<span>buffer</span>), <span>cons</span>(<span>&#34;halt&#34;</span>, <span>NULL</span>));</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L390" data-line-number="390"></td>
          <td id="file-heap-lisp-c-LC390">    <span>virtmach</span>();</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L391" data-line-number="391"></td>
          <td id="file-heap-lisp-c-LC391">    <span>print</span>(<span>accum</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L392" data-line-number="392"></td>
          <td id="file-heap-lisp-c-LC392">    <span>printf</span>(<span>&#34;&gt;&gt; &#34;</span>);</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L393" data-line-number="393"></td>
          <td id="file-heap-lisp-c-LC393">  }</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L394" data-line-number="394"></td>
          <td id="file-heap-lisp-c-LC394">  <span>return</span> <span>0</span>;</td>
        </tr>
        <tr>
          <td id="file-heap-lisp-c-L395" data-line-number="395"></td>
          <td id="file-heap-lisp-c-LC395">}</td>
        </tr>
  </tbody></div></div>
  </body>
</html>
