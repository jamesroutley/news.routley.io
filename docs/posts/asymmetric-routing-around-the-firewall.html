<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://devnonsense.com/posts/asymmetric-routing-around-the-firewall/">Original</a>
    <h1>Asymmetric Routing Around the Firewall</h1>
    
    <div id="readability-page-1" class="page"><div id="content"><p>This is a follow-up to my previous post about some <a href="https://devnonsense.com/posts/tcp-connection-timeout-mystery">mysterious TCP connection timeouts</a> in the UC Berkeley wired network.</p><p>I received many thoughtful emails in response to that post, and there was an <a href="https://news.ycombinator.com/item?id=39804004">excellent discussion on Hacker News</a>. I’m very grateful to everyone who spent time helping with my ridiculous home networking issues.</p><p>Since then, I’ve learned some new information that (mostly) solves the mystery. In this post, I’ll first summarize the main theories people suggested, then tell the story of how a Bunny CDN engineer came to the rescue, and finally describe the root cause. If you just want to know the answer, please <a href="#mostly-solving-the-mystery">skip to the end</a>.</p><details open=""><summary><b>Table of contents</b></summary><nav id="TableOfContents"><ul><li><a href="#theories">Theories</a><ul><li><a href="#theory-1-mtu">Theory #1: MTU</a></li><li><a href="#theory-2-firewall-rejects-sni">Theory #2: Firewall rejects SNI</a></li><li><a href="#theory-3-misconfigured-firewall-rule-for-link-local-address-space">Theory #3: Misconfigured firewall rule for link local address space</a></li><li><a href="#theory-4-misconfigured-firewall-drops-outbound-established-connections">Theory #4: Misconfigured firewall drops outbound established connections</a></li><li><a href="#theory-5-asymmetric-routing">Theory #5: Asymmetric routing</a></li></ul></li><li><a href="#help-from-a-bunny-cdn-engineer">Help from a Bunny CDN engineer</a></li><li><a href="#mostly-solving-the-mystery">(Mostly) solving the mystery</a></li><li><a href="#conclusion">Conclusion</a></li></ul></nav></details><h2 id="theories">Theories</h2><h3 id="theory-1-mtu">Theory #1: MTU</h3><p>Many people suggested that packets might be larger than the maximum transmission unit (MTU) somewhere along the path to Bunny CDN.
However, I don’t find this theory plausible because:</p><ul><li>The packet captures show the client ACK is getting dropped. The entire Ethernet frame is only 66 bytes, with zero bytes in the TCP payload.</li><li>The same symptoms occur after setting the MTU lower on the interface (<code>ip link set dev &lt;iface&gt; mtu 1300</code>) and clamping the MSS (using iptables, as described <a href="https://tldp.org/HOWTO/Adv-Routing-HOWTO/lartc.cookbook.mtu-mss.html">here</a>)</li></ul><h3 id="theory-2-firewall-rejects-sni">Theory #2: Firewall rejects SNI</h3><p>Some people suggested that a firewall might be rejecting the server name indication (SNI) in the TLS Client Hello sent immediately after the client ACK.</p><p>I mentioned briefly in the post that I was seeing the same behavior with HTTP, not just HTTPS, but didn’t provide a packet capture. To clarify, when I say the issue
happens with HTTP, I mean <em>the exact same symptoms</em> showing a dropped client ACK. There is no HTTP redirect to the HTTPS site, because the TCP connection is never
successfully established.</p><p>Additionally, I discovered later that other Bunny CDN IPs worked correctly. For example, Bunny CDN uses IP 107.182.163.162 located in Utah, and I’m able to connect with</p><pre tabindex="0"><code>curl https://fonts.bunny.net --resolve fonts.bunny.net:443:107.182.163.16
</code></pre><p>even though this command sends the exact same SNI (fonts.bunny.net).</p><h3 id="theory-3-misconfigured-firewall-rule-for-link-local-address-space">Theory #3: Misconfigured firewall rule for link local address space</h3><p>Several people noticed that the destination IP address 169.150.221.147 is very similar to the link local address range 169.254.0.0/16 (see section 2.1 in <a href="https://www.rfc-editor.org/rfc/rfc3927#section-2.1">RFC 3927</a>).
The theory is that someone accidentally configured a firewall rule to block 169.0.0.0/8 instead of 169.254.0.0/16, inadvertently blocking the Bunny CDN IP address 169.150.221.147.</p><p>I didn’t say it in the original post, but I see the same behavior with another Bunny CDN IP 143.244.50.88, which isn’t in the 169.0.0.0/8 address space. So unfortunately this theory doesn’t quite fit either.</p><h3 id="theory-4-misconfigured-firewall-drops-outbound-established-connections">Theory #4: Misconfigured firewall drops outbound established connections</h3><p>One person <a href="https://news.ycombinator.com/item?id=39822214">reproduced the same symptoms</a> in their home network by adding a firewall rule to drop packets to 169.150.221.147. The trick was to configure the rule only <em>in the outbound direction</em> and only <em>for established connections</em>.
This causes the client ACK to be dropped, and the packet captures show exactly the same pattern of retransmitted ACKs (from the client) and SYN+ACKs (from the server).</p><p>This theory aligns really well with the symptoms I’m observing . However, it seemed unlikely someone would configure a rule to block a connection <em>after</em> it’s established, and Berkeley IT told me there were no firewall rules blocking destinations 169.150.221.147 or 143.244.50.88.</p><h3 id="theory-5-asymmetric-routing">Theory #5: Asymmetric routing</h3><p>This was the guess I made in <a href="https://devnonsense.com/posts/tcp-connection-timeout-mystery">the original post</a>, and a few people agreed with me. Someone suggested checking the IP header TTL field or using traceroute with different ports/probes.
I learned about some traceroute flags I’d never used before; for example</p><pre tabindex="0"><code>sudo traceroute 169.150.221.147 -p 443 -q 1 -T -O syn
</code></pre><p>sends a TCP probe on port 443 with the SYN flag set. Unfortunately, I didn’t find any evidence in the IP TTL field or traceroute output to prove that the timeouts were caused by asymmetric routing.</p><p>As you can probably guess from the title of this post, I was eventually able to confirm this theory, but not without some help from an engineer at Bunny CDN.</p><h2 id="help-from-a-bunny-cdn-engineer">Help from a Bunny CDN engineer</h2><p>In response to my post, an infrastructure engineer from Bunny CDN offered to investigate. I can’t express enough how grateful I am that someone at Bunny CDN spent time helping to solve this mystery!</p><p>The Bunny CDN engineer suggested testing the following IPs to narrow down the issue:</p><table><thead><tr><th>IP Address</th><th>Location</th><th>Hosting Provider</th></tr></thead><tbody><tr><td>169.150.221.147</td><td>San Jose</td><td>DataPacket</td></tr><tr><td>143.244.50.88</td><td>Los Angeles</td><td>DataPacket</td></tr><tr><td>107.182.163.162</td><td>Utah</td><td>WebNX</td></tr></tbody></table><p>The two IPs hosted by DataPacket timed out, but I could connect successfully to the IP hosted by WebNX.<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup></p><p>The engineer also offered to take a packet capture from a Bunny CDN server. I ran this script on a machine in my apartment:</p><div><pre tabindex="0"><code data-lang="bash"><span><span><span>while</span> true<span>;</span> <span>do</span>
</span></span><span><span>  curl -vvv -4 https://fonts.bunny.net <span>\
</span></span></span><span><span><span></span>    --connect-timeout <span>10</span> <span>\
</span></span></span><span><span><span></span>    --no-progress-meter -D - -o /dev/null<span>;</span>
</span></span><span><span>  sleep 10<span>;</span>
</span></span><span><span><span>done</span>
</span></span></code></pre></div><p>and he took the packet capture filtering for my public IP address. The packet captures showed:</p><ul><li>Bunny CDN receives the SYN from my IP.</li><li>Bunny CDN sends the SYN+ACK.</li><li>Bunny CDN <em>never receives the client ACK</em> and continues retransmitting the SYN+ACK</li><li>Bunny CDN <em>never receives the FIN+ACK</em> from my IP either.</li></ul><p>This confirmed that the client ACK was being dropped somewhere before reaching Bunny CDN, almost certainly within the UC Berkeley network.</p><p>Finally, the Bunny CDN engineer used <code>mtr</code> to trace the path from 169.150.221.147 back to my IP address. This turned out to be the critical clue, as described in the next section.</p><h2 id="mostly-solving-the-mystery">(Mostly) solving the mystery</h2><p>Tracing the path in the outbound direction from my IP to Bunny CDN, I noticed what looked like a firewall, “reshall-fw–ethernet1-21-682.sait-west.berkeley.edu”:</p><pre tabindex="0"><code>HOST: fedora
  1.|-- _gateway                                                 0.0%     3    1.5   2.8   1.5   5.5   2.3
  2.|-- ucv-cdf-r1--irb-525.net.berkeley.edu                     0.0%     3    2.4  26.0   2.4  60.8  30.8
  3.|-- sut-mdc-cr1--xe-1-1-11.net.berkeley.edu                  0.0%     3   20.2  12.8   5.6  20.2   7.3
  4.|-- sut-mdc-sr7--irb-204.net.berkeley.edu                    0.0%     3    4.4   7.5   4.4  12.5   4.3
  5.|-- reshall-fw--ethernet1-21-682.sait-west.berkeley.edu      0.0%     3    6.8   5.1   3.1   6.8   1.9
  6.|-- sut-mdc-sr7--irb-199.net.berkeley.edu                    0.0%     3    3.6   3.6   3.4   3.7   0.1
  7.|-- reccev-cev-cr1--et-0-0-3.net.berkeley.edu                0.0%     3    5.0   5.2   4.1   6.4   1.2
  8.|-- reccev-cev-br1--et-1-1-1.net.berkeley.edu                0.0%     3   45.5  24.6   3.7  45.5  20.9
  9.|-- emvl1-agg-01--ucb--100g.cenic.net                        0.0%     3    4.2   4.7   3.0   7.1   2.1
 10.|-- sacr2-agg-01--emvl1-agg-01--400g--01.cenic.net           0.0%     3    7.9   7.4   5.4   8.8   1.7
 11.|-- hundredge-0-0-0-24.98.core2.sacr.net.internet2.edu       0.0%     3   11.5  13.9  10.9  19.3   4.7
 12.|-- fourhundredge-0-0-0-0.4079.core2.sunn.net.internet2.edu  0.0%     3    9.0   8.8   8.3   9.0   0.4
 13.|-- fourhundredge-0-0-0-49.4079.agg2.sanj.net.internet2.edu  0.0%     3   11.3  11.2  10.8  11.4   0.3
 14.|-- 162.252.69.142                                           0.0%     3    7.5   7.6   7.5   7.7   0.1
 15.|-- be-2111-cs01.9greatoaks.ca.ibone.comcast.net             0.0%     3   10.5   9.0   8.1  10.5   1.3
 16.|-- be-2113-pe13.9greatoaks.ca.ibone.comcast.net             0.0%     3    7.1   8.6   7.1   9.9   1.4
 17.|-- 71.25.198.98                                             0.0%     3    7.0   7.3   7.0   7.6   0.3
 18.|-- vl201.sjc-eq10-dist-1.cdn77.com                          0.0%     3    7.6   8.8   7.6  10.2   1.3
 19.|-- 169-150-221-147.bunnyinfra.net                           0.0%     3    7.9   7.6   7.1   7.9   0.4
</code></pre><p>When the Bunny CDN engineer traced the path in the reverse direction (Bunny CDN back to my IP), he saw this:</p><pre tabindex="0"><code>HOST: edge-915.bunnyinfra.net                      Loss%   Snt   Last   Avg  Best  Wrst StDev
  1.|-- unn-169-150-221-156.datapacket.com            0.0%     3    0.5   0.5   0.5   0.5   0.0
  2.|-- vl202.sjc-eq10-core-2.cdn77.com               0.0%     3    0.4   0.5   0.4   0.5   0.0
  3.|-- vl250.sjc-eq10-core-1.cdn77.com               0.0%     3    0.6   0.6   0.6   0.6   0.0
  4.|-- be-111-pe13.9greatoaks.ca.ibone.comcast.net   0.0%     3    0.8   1.0   0.8   1.1   0.1
  5.|-- be-2113-cs01.9greatoaks.ca.ibone.comcast.net  0.0%     3    0.9   1.2   0.9   1.4   0.2
  6.|-- be-36311-ar01.hayward.ca.sfba.comcast.net     0.0%     3    2.3   2.3   2.3   2.3   0.0
  7.|-- be-398-rar01.pleasanton.ca.sfba.comcast.net   0.0%     3    2.7   2.8   2.7   3.0   0.1
  8.|-- be-12-sur04.pinole.ca.sfba.comcast.net        0.0%     3    3.6   3.6   3.6   3.6   0.0
  9.|-- ???                                          100.0     3    0.0   0.0   0.0   0.0   0.0
 10.|-- sut-mdc-cr1--xe-1-0-5.net.berkeley.edu        0.0%     3    6.3   5.6   5.1   6.3   0.6
 11.|-- ucv-cdf-r1--irb-525.net.berkeley.edu          0.0%     3   12.1  10.0   6.0  12.1   3.4
 12.|-- ???                                          100.0     3    0.0   0.0   0.0   0.0   0.0
</code></pre><p>Comparing the outbound and inbound paths, I noticed something strange: <strong>inbound traffic from 169.150.221.147 was bypassing the firewall!</strong></p><p><img src="https://devnonsense.com/img/berkeley-asymmetric-routing-firewall.svg" alt="Diagram showing outbound traffic traversing the firewall but inbound traffic bypasses the firewall"/></p><p>This perfectly explains the dropped client ACK and TCP connection timeouts:</p><ol><li>Outbound client SYN goes through the firewall.</li><li>Inbound server SYN+ACK is routed back to the client <em>without</em> going through the firewall.</li><li>Client sends ACK to complete the TCP handshake.</li><li>Since the firewall never saw the server SYN+ACK, it drops the client ACK.</li><li>Since the server never receives the (dropped) client ACK, the TCP handshake never completes.</li></ol><p>I don’t know which router the “???” represents, but I’m fairly certain inbound traffic isn’t supposed to skip the firewall.<sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup> This is most likely caused by a route table misconfigured somewhere in the UC Berkeley network. Unfortunately, I cannot investigate further without the cooperation of Berkeley IT.</p><h2 id="conclusion">Conclusion</h2><p>Will Berkeley IT fix the routing misconfiguration? I’ve done everything in my power to escalate this to the appropriate team, including directly emailing the Executive Director of Campus IT.<sup id="fnref:3"><a href="#fn:3" role="doc-noteref">3</a></sup> Since that email, Berkeley IT has at least stopped trying to close the ticket (good!) but assigned it low priority because I’m the only person who has reported the problem.<sup id="fnref:4"><a href="#fn:4" role="doc-noteref">4</a></sup> Later, when I realized that inbound traffic was bypassing the firewall, I notified UC Berkeley’s Information Security Office of the potential security vulnerability, but their response was somewhat lacking in urgency.<sup id="fnref:5"><a href="#fn:5" role="doc-noteref">5</a></sup> So we’ll see.</p><p>I want to again thank everyone who took the time to respond to my last post. Even though the issue hasn’t been fixed, I feel better knowing why it’s happening, and I learned a lot from all the feedback. I especially want to thank the infrastructure engineer at Bunny CDN for providing the crucial clue that solved the mystery!</p><p>Finally, a few people suggested using a VPN as a workaround, which makes a lot of sense. However, I realized there’s one workaround no one suggested, and it happens to be the one I’m actually pursuing (albeit for unrelated reasons): moving to a new home where I can manage the network myself.</p><p><strong>Update (2024-04-12):</strong> Today, Berkeley IT told me, “It appears that the Xfinity link present only on the Reshall networks has introduced a condition that has contributed to the asymmetrical routing situation,” and they’re working on fixing it. So now I can say that the mystery is <em>completely</em> solved!</p></div></div>
  </body>
</html>
