<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://emacsconf.org/2022/talks/wayland/">Original</a>
    <h1>Emacs should become a Wayland compositor</h1>
    
    <div id="readability-page-1" class="page"><div class="page">



<div id="pagebody">





<div id="content" role="main">















<p>Michael Bauer
 (IRC: permcu, <a href="mailto:perma-curious@posteo.de">perma-curious@posteo.de</a>)</p>




<p>The following image shows where the talk is in the schedule for Sat 2022-12-03. Solid lines show talks with Q&amp;A via BigBlueButton. Dashed lines show talks with Q&amp;A via IRC or Etherpad.</p>

<p>Format: 10-min talk followed by live Q&amp;A (done)</p>

<div>
<video controls="" preload="metadata" id="wayland-mainVideo" poster="https://media.emacsconf.org/2022/emacsconf-2022-wayland--emacs-should-become-a-wayland-compositor--michael-bauer--main.png">
<source src="https://media.emacsconf.org/2022/emacsconf-2022-wayland--emacs-should-become-a-wayland-compositor--michael-bauer--main.webm" type=""/>

<p><em>Your browser does not support the video tag, please download the video instead.</em></p>
</video>

</div>







<p>Since Emacs learned wayland last year, it can now become a wayland compositor.
Emacs is already a great window manager. Let us embrace this in the wayland
future, where managers become compositors.</p>

<p>In this short talk I would like to convince you that this is a good idea and get
you exciting about the possibilities. I then outline how to go about
implementing this idea.</p>

<p>Afterwards I would very much like to get a discussion started together.</p>








<p><span title="00:00:00.000" data-start="00:00:00.000" data-video="mainVideo-wayland">Hello EmacsConf and hello fellow Emacs fans.</span>
<span title="00:00:08.000" data-start="00:00:08.000" data-video="mainVideo-wayland">My name is Michael Bauer, and I&#39;m from Germany.</span>
<span title="00:00:10.920" data-start="00:00:10.920" data-video="mainVideo-wayland">I&#39;m gonna talk to you about &#34;Why and how Emacs</span>
<span title="00:00:13.440" data-start="00:00:13.440" data-video="mainVideo-wayland">should become a Wayland compositor.&#34;</span>
<span title="00:00:17.200" data-start="00:00:17.200" data-video="mainVideo-wayland">And it already kinda is a Wayland compositor.</span>
<span title="00:00:21.740" data-start="00:00:21.740" data-video="mainVideo-wayland">This talk is composed by Wayland and Emacs.</span>
<span title="00:00:25.000" data-start="00:00:25.000" data-video="mainVideo-wayland">If I&#39;m talking about a Wayland compositor</span>
<span title="00:00:26.840" data-start="00:00:26.840" data-video="mainVideo-wayland">or Emacs as Wayland compositor,</span>
<span title="00:00:29.360" data-start="00:00:29.360" data-video="mainVideo-wayland">I mean it in the sense that</span>
<span title="00:00:30.440" data-start="00:00:30.440" data-video="mainVideo-wayland">EXWM is an X window manager. I hope you know EXWM.</span>
<span title="00:00:36.000" data-start="00:00:36.000" data-video="mainVideo-wayland">So, why?</span>
<span title="00:00:41.000" data-start="00:00:41.000" data-video="mainVideo-wayland">Emacs can do Wayland now, that was a stopper</span>
<span title="00:00:44.120" data-start="00:00:44.120" data-video="mainVideo-wayland">before, and now it&#39;s solved with <code>pgtk</code> branch.</span>
<span title="00:00:49.000" data-start="00:00:49.000" data-video="mainVideo-wayland">It makes the Emacs toolbox bigger,</span>
<span title="00:00:53.240" data-start="00:00:53.240" data-video="mainVideo-wayland">which is always a good thing.</span>
<span title="00:00:55.000" data-start="00:00:55.000" data-video="mainVideo-wayland">And the cool thing about Wayland, which is not</span>
<span title="00:00:58.440" data-start="00:00:58.440" data-video="mainVideo-wayland">possible under X is, it can run standalone</span>
<span title="00:01:02.280" data-start="00:01:02.280" data-video="mainVideo-wayland">on the Linux kernel interface, or nested under X,</span>
<span title="00:01:06.840" data-start="00:01:06.840" data-video="mainVideo-wayland">or even nested under Wayland.</span>
<span title="00:01:09.000" data-start="00:01:09.000" data-video="mainVideo-wayland">The compositor features of Emacs doesn&#39;t mean</span>
<span title="00:01:13.840" data-start="00:01:13.840" data-video="mainVideo-wayland">it has to take over the whole output.</span>
<span title="00:01:16.960" data-start="00:01:16.960" data-video="mainVideo-wayland">It can use them, even if it&#39;s just like</span>
<span title="00:01:20.560" data-start="00:01:20.560" data-video="mainVideo-wayland">a normal window or normal program.</span>
<span title="00:01:23.000" data-start="00:01:23.000" data-video="mainVideo-wayland">And last reason is,</span>
<span title="00:01:25.120" data-start="00:01:25.120" data-video="mainVideo-wayland">I want to keep living inside Emacs</span>
<span title="00:01:27.240" data-start="00:01:27.240" data-video="mainVideo-wayland">and Wayland is the future, apparently.</span>
<span title="00:01:31.000" data-start="00:01:31.000" data-video="mainVideo-wayland">EXWM use case is the first use case.</span>
<span title="00:01:35.000" data-start="00:01:35.000" data-video="mainVideo-wayland">You take a Wayland surface and put it inside</span>
<span title="00:01:38.400" data-start="00:01:38.400" data-video="mainVideo-wayland">an Emacs window. You see it right below.</span>
<span title="00:01:41.520" data-start="00:01:41.520" data-video="mainVideo-wayland">The video of me is a Wayland surface,</span>
<span title="00:01:45.880" data-start="00:01:45.880" data-video="mainVideo-wayland">and it&#39;s inside an Emacs window managed by Emacs.</span>
<span title="00:01:50.000" data-start="00:01:50.000" data-video="mainVideo-wayland">Emacs does the input, and the clipboard handling,</span>
<span title="00:01:53.480" data-start="00:01:53.480" data-video="mainVideo-wayland">and can insert itself here, and do great things.</span>
<span title="00:01:59.000" data-start="00:01:59.000" data-video="mainVideo-wayland">And it&#39;s a possibility to Lispify the Linux desktop,</span>
<span title="00:02:03.200" data-start="00:02:03.200" data-video="mainVideo-wayland">as Emacs Lispifies the command line.</span>
<span title="00:02:08.000" data-start="00:02:08.000" data-video="mainVideo-wayland">The other use case is the XWidget use case.</span>
<span title="00:02:12.960" data-start="00:02:12.960" data-video="mainVideo-wayland">I don&#39;t know if you know XWidgets.</span>
<span title="00:02:17.000" data-start="00:02:17.000" data-video="mainVideo-wayland">It&#39;s embedded X windows inside Emacs.</span>
<span title="00:02:19.720" data-start="00:02:19.720" data-video="mainVideo-wayland">There&#39;s a web browser available in Emacs.</span>
<span title="00:02:24.000" data-start="00:02:24.000" data-video="mainVideo-wayland">With Wayland, you could embed anything that can</span>
<span title="00:02:27.520" data-start="00:02:27.520" data-video="mainVideo-wayland">create a Wayland surface like video, web, or 3D.</span>
<span title="00:02:32.000" data-start="00:02:32.000" data-video="mainVideo-wayland">Think OpenGL, something like</span>
<span title="00:02:34.880" data-start="00:02:34.880" data-video="mainVideo-wayland">EmacsGL would be possible.</span>
<span title="00:02:38.000" data-start="00:02:38.000" data-video="mainVideo-wayland">And we wouldn&#39;t have just images like we have so far.</span>
<span title="00:02:46.000" data-start="00:02:46.000" data-video="mainVideo-wayland">So, how to implement this Wayland compositor?</span>
<span title="00:02:50.560" data-start="00:02:50.560" data-video="mainVideo-wayland">I&#39;m going to tell you how I did it,</span>
<span title="00:02:52.560" data-start="00:02:52.560" data-video="mainVideo-wayland">or I did this demo I&#39;m showing you right now.</span>
<span title="00:02:57.000" data-start="00:02:57.000" data-video="mainVideo-wayland">First of all, how does Wayland work?</span>
<span title="00:03:00.680" data-start="00:03:00.680" data-video="mainVideo-wayland">Wayland is a protocol in XML.</span>
<span title="00:03:04.000" data-start="00:03:04.000" data-video="mainVideo-wayland">It&#39;s a server and client, and they share a set of</span>
<span title="00:03:11.120" data-start="00:03:11.120" data-video="mainVideo-wayland">objects, and the objects have methods.</span>
<span title="00:03:13.960" data-start="00:03:13.960" data-video="mainVideo-wayland">They are specified in the protocol,</span>
<span title="00:03:16.120" data-start="00:03:16.120" data-video="mainVideo-wayland">and Wayland also says how the server</span>
<span title="00:03:24.080" data-start="00:03:24.080" data-video="mainVideo-wayland">and client talk to each other.</span>
<span title="00:03:25.720" data-start="00:03:25.720" data-video="mainVideo-wayland">First blocker for Emacs becoming a Wayland</span>
<span title="00:03:33.440" data-start="00:03:33.440" data-video="mainVideo-wayland">compositor is that Emacs and Wayland both have</span>
<span title="00:03:37.000" data-start="00:03:37.000" data-video="mainVideo-wayland">their own event loop, and you can&#39;t merge them too.</span>
<span title="00:03:41.880" data-start="00:03:41.880" data-video="mainVideo-wayland">But you don&#39;t have to merge them</span>
<span title="00:03:45.800" data-start="00:03:45.800" data-video="mainVideo-wayland">because you can just make Emacs speak Wayland.</span>
<span title="00:03:48.000" data-start="00:03:48.000" data-video="mainVideo-wayland">So, Emacs becomes a Wayland client,</span>
<span title="00:03:50.040" data-start="00:03:50.040" data-video="mainVideo-wayland">and there&#39;s an extra server Emacs is talking to.</span>
<span title="00:03:53.000" data-start="00:03:53.000" data-video="mainVideo-wayland">So, we need a minimal Wayland server that does all</span>
<span title="00:03:59.160" data-start="00:03:59.160" data-video="mainVideo-wayland">the stuff Emacs can&#39;t do and do the rest in Emacs.</span>
<span title="00:04:03.000" data-start="00:04:03.000" data-video="mainVideo-wayland">---The minimal Wayland server, I did it in wlroots.</span>
<span title="00:04:07.800" data-start="00:04:07.800" data-video="mainVideo-wayland">That&#39;s the library behind Sway. I think it&#39;s</span>
<span title="00:04:13.040" data-start="00:04:13.040" data-video="mainVideo-wayland">the Wayland library to do stuff like this.</span>
<span title="00:04:20.000" data-start="00:04:20.000" data-video="mainVideo-wayland">I implemented four different things to make it work.</span>
<span title="00:04:26.000" data-start="00:04:26.000" data-video="mainVideo-wayland">It&#39;s these three letter acronyms on the left.</span>
<span title="00:04:30.680" data-start="00:04:30.680" data-video="mainVideo-wayland">It&#39;s Emacs, Wayland, and then it&#39;s a server,</span>
<span title="00:04:34.520" data-start="00:04:34.520" data-video="mainVideo-wayland">a client, a protocol, and buffers.</span>
<span title="00:04:38.000" data-start="00:04:38.000" data-video="mainVideo-wayland">The server is written in C and it&#39;s mostly tinywl.</span>
<span title="00:04:44.000" data-start="00:04:44.000" data-video="mainVideo-wayland">It&#39;s the example of wlroots,</span>
<span title="00:04:46.280" data-start="00:04:46.280" data-video="mainVideo-wayland">and it&#39;s around 1000 lines of code.</span>
<span title="00:04:52.000" data-start="00:04:52.000" data-video="mainVideo-wayland">ewc, the Wayland client in Emacs,</span>
<span title="00:04:54.960" data-start="00:04:54.960" data-video="mainVideo-wayland">is the thing I&#39;m most proud of.</span>
<span title="00:04:58.560" data-start="00:04:58.560" data-video="mainVideo-wayland">It&#39;s 300 lines of code, and it is a</span>
<span title="00:05:02.120" data-start="00:05:02.120" data-video="mainVideo-wayland">fully featured Wayland client in Emacs.</span>
<span title="00:05:08.000" data-start="00:05:08.000" data-video="mainVideo-wayland">With this, Emacs can speak Wayland,</span>
<span title="00:05:11.640" data-start="00:05:11.640" data-video="mainVideo-wayland">and then I implemented Emacs Wayland protocol.</span>
<span title="00:05:18.000" data-start="00:05:18.000" data-video="mainVideo-wayland">It more or less allows Emacs to become a Wayland</span>
<span title="00:05:21.280" data-start="00:05:21.280" data-video="mainVideo-wayland">window manager, so it&#39;s not actually the compositor.</span>
<span title="00:05:24.640" data-start="00:05:24.640" data-video="mainVideo-wayland">The compositor stays in C, but Emacs is</span>
<span title="00:05:27.680" data-start="00:05:27.680" data-video="mainVideo-wayland">now a Wayland window manager!</span>
<span title="00:05:31.000" data-start="00:05:31.000" data-video="mainVideo-wayland">And the last thing is Emacs Wayland buffers.</span>
<span title="00:05:34.520" data-start="00:05:34.520" data-video="mainVideo-wayland">It&#39;s the window manager part.</span>
<span title="00:05:35.880" data-start="00:05:35.880" data-video="mainVideo-wayland">It&#39;s around 500 lines of code,</span>
<span title="00:05:38.440" data-start="00:05:38.440" data-video="mainVideo-wayland">and it does the buffer management inside</span>
<span title="00:05:41.680" data-start="00:05:41.680" data-video="mainVideo-wayland">Emacs windows, or floating right like you see me</span>
<span title="00:05:45.680" data-start="00:05:45.680" data-video="mainVideo-wayland">now floating on the right.</span>
<span title="00:05:48.000" data-start="00:05:48.000" data-video="mainVideo-wayland">It works, but it is still buggy,</span>
<span title="00:05:51.000" data-start="00:05:51.000" data-video="mainVideo-wayland">and it is also missing input handling,</span>
<span title="00:05:54.320" data-start="00:05:54.320" data-video="mainVideo-wayland">so there&#39;s more code to come for this to work.</span>
<span title="00:06:01.000" data-start="00:06:01.000" data-video="mainVideo-wayland">Some caveats about this approach.</span>
<span title="00:06:05.000" data-start="00:06:05.000" data-video="mainVideo-wayland">wlroots is around 60 kilo LoCs (Line of Code)</span>
<span title="00:06:09.640" data-start="00:06:09.640" data-video="mainVideo-wayland">and in active development.</span>
<span title="00:06:12.000" data-start="00:06:12.000" data-video="mainVideo-wayland">They have like a slogan 60 kilo locs of code</span>
<span title="00:06:16.640" data-start="00:06:16.640" data-video="mainVideo-wayland">you had to write anyway to make a Wayland</span>
<span title="00:06:19.760" data-start="00:06:19.760" data-video="mainVideo-wayland">compositor. And no, you don&#39;t have to write it.</span>
<span title="00:06:22.520" data-start="00:06:22.520" data-video="mainVideo-wayland">But I still remember when it was like 50 kilo locs,</span>
<span title="00:06:25.840" data-start="00:06:25.840" data-video="mainVideo-wayland">and now it&#39;s 60. And it&#39;s like a moving target.</span>
<span title="00:06:29.680" data-start="00:06:29.680" data-video="mainVideo-wayland">I think it could be quite a lot of work</span>
<span title="00:06:32.480" data-start="00:06:32.480" data-video="mainVideo-wayland">to keep up with it.</span>
<span title="00:06:34.000" data-start="00:06:34.000" data-video="mainVideo-wayland">Yeah, it could be quite a bit of work.</span>
<span title="00:06:41.000" data-start="00:06:41.000" data-video="mainVideo-wayland">Some windows don&#39;t like to keep the aspect ratios.</span>
<span title="00:06:46.000" data-start="00:06:46.000" data-video="mainVideo-wayland">You tell them and you have to crop them.</span>
<span title="00:06:49.560" data-start="00:06:49.560" data-video="mainVideo-wayland">And the interface I use in wlroots for doing this,</span>
<span title="00:06:53.000" data-start="00:06:53.000" data-video="mainVideo-wayland"><code>wlr_scene</code>, can&#39;t do cropping yet,</span>
<span title="00:06:57.280" data-start="00:06:57.280" data-video="mainVideo-wayland">so this doesn&#39;t work.</span>
<span title="00:07:01.000" data-start="00:07:01.000" data-video="mainVideo-wayland">Another problem is with GTK.</span>
<span title="00:07:03.240" data-start="00:07:03.240" data-video="mainVideo-wayland">Once Wayland is enabled and it stays on.</span>
<span title="00:07:11.000" data-start="00:07:11.000" data-video="mainVideo-wayland">This doesn&#39;t make sense.</span>
<span title="00:07:12.560" data-start="00:07:12.560" data-video="mainVideo-wayland">Okay, if you kill the Wayland server,</span>
<span title="00:07:15.000" data-start="00:07:15.000" data-video="mainVideo-wayland">GTK kills Emacs, that&#39;s not a good thing.</span>
<span title="00:07:18.000" data-start="00:07:18.000" data-video="mainVideo-wayland">And it&#39;s still a bit of work and fussing needed</span>
<span title="00:07:21.000" data-start="00:07:21.000" data-video="mainVideo-wayland">to get this to work reliably.</span>
<span title="00:07:23.640" data-start="00:07:23.640" data-video="mainVideo-wayland">It&#39;s quite buggy right now.</span>
<span title="00:07:26.000" data-start="00:07:26.000" data-video="mainVideo-wayland">And that brings me to my call to action.</span>
<span title="00:07:30.000" data-start="00:07:30.000" data-video="mainVideo-wayland">I think making Emacs Wayland capable is</span>
<span title="00:07:34.440" data-start="00:07:34.440" data-video="mainVideo-wayland">a further step to make an Emacs OS.</span>
<span title="00:07:39.000" data-start="00:07:39.000" data-video="mainVideo-wayland">It gains output and input handling.</span>
<span title="00:07:41.360" data-start="00:07:41.360" data-video="mainVideo-wayland">Output handling is already there,</span>
<span title="00:07:44.120" data-start="00:07:44.120" data-video="mainVideo-wayland">input handling is still missing,</span>
<span title="00:07:45.760" data-start="00:07:45.760" data-video="mainVideo-wayland">but Emacs can manage monitors, outputs,</span>
<span title="00:07:49.720" data-start="00:07:49.720" data-video="mainVideo-wayland">different frames if it&#39;s like nested,</span>
<span title="00:07:53.040" data-start="00:07:53.040" data-video="mainVideo-wayland">And inputs, keyboards, simulation keys,</span>
<span title="00:07:57.080" data-start="00:07:57.080" data-video="mainVideo-wayland">stuff like that.</span>
<span title="00:07:58.000" data-start="00:07:58.000" data-video="mainVideo-wayland">We could use it in more ways for Emacs display, maybe.</span>
<span title="00:08:02.000" data-start="00:08:02.000" data-video="mainVideo-wayland">Wayland just manages simple pixel buffers,</span>
<span title="00:08:05.720" data-start="00:08:05.720" data-video="mainVideo-wayland">so it&#39;s a protocol for managing pixel buffers.</span>
<span title="00:08:09.000" data-start="00:08:09.000" data-video="mainVideo-wayland">And in a sense, we could go back to</span>
<span title="00:08:12.560" data-start="00:08:12.560" data-video="mainVideo-wayland">the old X ways and maybe even ditch GTK.</span>
<span title="00:08:15.560" data-start="00:08:15.560" data-video="mainVideo-wayland">I don&#39;t know, but why need it?</span>
<span title="00:08:18.000" data-start="00:08:18.000" data-video="mainVideo-wayland">We can composite without it.</span>
<span title="00:08:20.600" data-start="00:08:20.600" data-video="mainVideo-wayland">Let&#39;s make buffer menus, buffer world, buffer.</span>
<span title="00:08:27.000" data-start="00:08:27.000" data-video="mainVideo-wayland">Emacs Wayland protocol, like I did it,</span>
<span title="00:08:29.040" data-start="00:08:29.040" data-video="mainVideo-wayland">allows a very concise design, and it allows</span>
<span title="00:08:34.040" data-start="00:08:34.040" data-video="mainVideo-wayland">to improve on the EXWM code base.</span>
<span title="00:08:38.000" data-start="00:08:38.000" data-video="mainVideo-wayland">And I wrote KISS style because EXWM has</span>
<span title="00:08:41.840" data-start="00:08:41.840" data-video="mainVideo-wayland">workspace management integrated.</span>
<span title="00:08:45.000" data-start="00:08:45.000" data-video="mainVideo-wayland">I don&#39;t think that&#39;s needed, like Emacs does it.</span>
<span title="00:08:50.600" data-start="00:08:50.600" data-video="mainVideo-wayland">Why do you have to do something extra?</span>
<span title="00:08:53.640" data-start="00:08:53.640" data-video="mainVideo-wayland">So why do it?</span>
<span title="00:08:56.000" data-start="00:08:56.000" data-video="mainVideo-wayland">To finish the call to action,</span>
<span title="00:09:00.040" data-start="00:09:00.040" data-video="mainVideo-wayland">if this is the thing you want to see in Emacs,</span>
<span title="00:09:03.280" data-start="00:09:03.280" data-video="mainVideo-wayland">maybe you want to get involved, have some ideas,</span>
<span title="00:09:06.600" data-start="00:09:06.600" data-video="mainVideo-wayland">so we could discuss it.</span>
<span title="00:09:10.000" data-start="00:09:10.000" data-video="mainVideo-wayland">I&#39;m looking forward to discuss with you</span>
<span title="00:09:14.960" data-start="00:09:14.960" data-video="mainVideo-wayland">and hear your questions and ideas.</span>
<span title="00:09:21.000" data-start="00:09:21.000" data-video="mainVideo-wayland">I want to say a big thank you to the</span>
<span title="00:09:24.200" data-start="00:09:24.200" data-video="mainVideo-wayland">organizers of EmacsConf and the other speakers</span>
<span title="00:09:26.600" data-start="00:09:26.600" data-video="mainVideo-wayland">for making this event possible.</span>
<span title="00:09:29.000" data-start="00:09:29.000" data-video="mainVideo-wayland">Thank you, and see you.</span></p>

<p>Questions or comments? Please e-mail <a href="mailto:perma-curious@posteo.de?subject=Comment%20for%20EmacsConf%202022%20wayland%3A%20Emacs%20should%20become%20a%20Wayland%20compositor">perma-curious@posteo.de</a></p>











</div>







</div>



</div></div>
  </body>
</html>
