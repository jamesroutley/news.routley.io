<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/Articles/985210/">Original</a>
    <h1>FreeBSD considers Rust in the base system</h1>
    
    <div id="readability-page-1" class="page"><div>

<p>The <a href="https://www.freebsd.org/">FreeBSD Project</a> is, for the second
time this year, engaging in a long-running discussion about the
possibility of including Rust in its <a href="https://www.over-yonder.net/~fullermd/rants/bsd4linux/03">base
system</a>. The sequel to the first discussion included some work by
Alan Somers to show what it might look like to use Rust code in the
base tree. Support for Rust code does not appear much closer to being
included in FreeBSD&#39;s base system, but the conversation has been
enlightening.</p>

<h4>Base versus ports</h4>

<p>Unlike Linux, the FreeBSD operating system kernel
and user space are developed together as the base system, maintained in the <a href="https://cgit.freebsd.org/src/about/">FreeBSD source
tree</a> (often referred to as &#34;src&#34;). This means, for the
purposes of discussing using Rust as a language for the FreeBSD kernel
or other programs/utilities in the base system, the Rust toolchain
would need to be present in base as well. Currently, the languages
supported for FreeBSD&#39;s base system are assembly, C, <nobr>C++</nobr>, Lua, and
shell scripts written for <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1">sh</a>. In
the distant past, Perl was also part of the base system, but was <a href="https://lists.freebsd.org/pipermail/freebsd-announce/2002-May/000823.html">removed</a>
in 2002 prior to <a href="https://www.freebsd.org/releases/5.0R/relnotes-i386/">FreeBSD 5.0</a>.</p>

<!-- middle-ad -->

<p>FreeBSD also has a <a href="https://en.wikipedia.org/wiki/FreeBSD_Ports">ports</a>
collection for third-party software that is not maintained
as part of FreeBSD itself. This includes everything from the Apache HTTP
Server to Xwayland. Rust is <a href="https://www.freshports.org/lang/rust">already present</a> in the
ports system, as are many applications written in the Rust language. A search on <a href="https://www.freshports.org/">FreshPorts</a>, which lists new
packages in the ports collection, turns up more than 500
packages in the ports system that are written in Rust.</p>

<h4>A dream of Rust</h4>

<p>But Rust is not allowed in the base system. Somers <a href="https://lists.freebsd.org/archives/dev-commits-src-main/2024-January/021129.html">noted</a>
this fact with disappointment in a discussion about <a href="https://lists.freebsd.org/archives/dev-commits-src-main/2024-January/021099.html">a
commit</a> to fusefs tests in January. Enji Cooper <a href="https://lists.freebsd.org/archives/dev-commits-src-main/2024-January/021126.html">asked</a>
Somers why he had not used <a href="https://www.codecademy.com/resources/docs/cpp/smart-pointers">smart pointers</a> in the change, to which
Somers said &#34;<q>it&#39;s because I&#39;m not real great with
<nobr>C++</nobr></q>&#34;. He added that he had stopped trying to improve
his <nobr>C++</nobr> skills in 2016, and had focused on Rust instead:</p>

<blockquote>
Even when I wrote these tests in 2019, I strongly considered using
Rust instead of <nobr>C++</nobr>. In the end, the only thing that forced me to use
<nobr>C++</nobr> is because I wanted them to live in the base system, rather than in ports.
</blockquote>

<p>Somers said that he dreamed about the day when Rust is allowed in
the base system, and mentioned several projects he would have done
differently if it were allowed. Warner Losh <a href="https://lists.freebsd.org/archives/dev-commits-src-main/2024-January/021132.html">replied</a>
that it would require some visible success stories for the FreeBSD
community to consider inclusion in base. Rust, he said, &#34;<q>has a lot
of logistical issues since it isn&#39;t quite supported in llvm out of the
box</q>&#34;. (By default, Rust uses
<a href="https://github.com/rust-lang/llvm-project">its own fork of
LLVM</a>.) He suggested adding test cases in base that could be run by
installing Rust from ports prior to building &#34;<q>to show it&#39;s possible
and to raise awareness of rust&#39;s viability and to shake out the
inevitable growing pains that this will necessarily [cause]</q>&#34;.</p>

<p>Brooks Davis also <a href="https://lists.freebsd.org/archives/dev-commits-src-main/2024-January/021135.html">suggested</a>
bringing in Rust code that would use an external toolchain rather than
having the toolchain in base. &#34;<q>There
are a bunch of bootstrapping and reproducibility issues to consider,
but I think the fixes mostly lie outside the src tree.</q>&#34;</p>

<h4>The case for (and against) Rust</h4>

<p>On January 20, Somers <a href="https://lists.freebsd.org/archives/freebsd-hackers/2024-January/002823.html">made his case</a> to the freebsd-hackers mailing list on the costs and
benefits of including Rust code in FreeBSD&#39;s base system, which opened
the first lengthy discussion around Rust. He
summarized the cost as &#34;<q>it would double our build times</q>&#34;, but
the benefit would be that &#34;<q>some tools would become easier to write,
or even become possible</q>&#34;. Losh <a href="https://lists.freebsd.org/archives/freebsd-hackers/2024-January/002830.html">reiterated</a>
his suggestion to start with adding better tests in Rust. That would
allow the project to get an external toolchain working to learn if
Rust &#34;<q>actually fits in and if we can keep up the
infrastructure</q>&#34; or not.</p>

<p>Dimitry Andric <a href="https://lists.freebsd.org/archives/freebsd-hackers/2024-January/002825.html">wrote</a>
that it might be possible to build Rust using FreeBSD&#39;s base version
of LLVM, but he said that the discussion was going in the wrong direction. The
upstream build systems for LLVM and Rust require too many
dependencies. Trying to support such tools &#34;<q>is getting more and
more complicated all the time</q>&#34;. He wanted to know why the project
was spending time trying to build toolchain components in the base
system at all. He argued, instead, that the focus should be on
removing toolchains from the base system. &#34;<q>Let new
toolchain components for base live in ports, please.</q>&#34; In other
words, software written in Rust could live in base, but its toolchain
would stay in ports. That sentiment was shared by a number of other participants in the
discussion.</p>

<p>Alexander Leidinger <a href="https://lists.freebsd.org/archives/freebsd-hackers/2024-January/002898.html">asked</a>
what kind of impact using Rust would have on backward
compatibility. Would it be possible to compile FreeBSD release x.0 in
two years on version x.2, for example, as it is with C/<nobr>C++</nobr> code in
base? Somers <a href="https://lists.freebsd.org/archives/freebsd-hackers/2024-January/002900.html">said</a>
the short answer is yes. The longer answer, he said, was that the
Rust language has <a href="https://doc.rust-lang.org/edition-guide/editions/">editions</a>,
similar to <nobr>C++</nobr> editions, that are released every three years. Compiler
releases are capable of building the latest edition, and all previous editions:</p>

<blockquote>
So if we were to bring Rust code into the base system, we would
probably want to settle on a single edition per stable branch. Then we
would be able to compile it forever.
</blockquote>

<p>Some participants were not convinced that code written in Rust should be allowed in
base, even if its toolchain lived outside base. Cy Schubert <a href="https://lists.freebsd.org/archives/freebsd-hackers/2024-January/002882.html">complained</a>
that the language was still evolving quickly. Poul-Henning Kamp <a href="https://lists.freebsd.org/archives/freebsd-hackers/2024-January/002849.html">said</a>
that the pro-Rust argument simply boiled down to &#34;<q>&#39;all the cool
kids do it&#39;</q>&#34;. He argued that FreeBSD developers should &#34;<q>quietly
and gradually look more and more to <nobr>C++</nobr> for our &#39;advanced
needs&#39;</q>&#34;:</p>

<blockquote>
I also propose, that next time somebody advocates for importing
some &#34;all the cool kids are doing it language&#34; or other, we refuse
to even look at their proposal, until they have proven their skill
in, and dedication to, the language, by faithfully reimplementing
<a href="https://man.freebsd.org/cgi/man.cgi?query=cvsup&amp;sektion=1&amp;format=html">cvsup</a> in it, and documented how and why it is a better language for
that, than Modula-3 was.
</blockquote>

<p>Bertrand Petit <a href="https://lists.freebsd.org/archives/freebsd-hackers/2024-January/002850.html">agreed</a>
with Kamp, and said that adding Rust to base should be avoided at all
costs. However, he suggested that if using Rust needs something in
base &#34;<q>such as kernel interfaces, linking facilities, etc.</q>&#34; to
work properly in the ports system, it should be provided in base.</p>

<p>After the discussion had simmered a bit, Somers <a href="https://lists.freebsd.org/archives/freebsd-hackers/2024-January/002852.html">replied</a>
with answers to some of the questions about
Rust in base. He said that the comparisons of Rust to Perl were
missing the mark. The crucial difference is that Rust is
suitable for systems programming, while the others were not. &#34;<q>Rust
isn&#39;t quite as low-level as C, but it&#39;s in about the same position as
<nobr>C++</nobr>.</q>&#34; To Kamp&#39;s assertion that developers should just use <nobr>C++</nobr>, Somers
said that he was far more productive in Rust and his code had fewer
bugs, too. He said he had used <nobr>C++</nobr> professionally for 11 years, but
was more skilled in Rust after six months. The problem, he said, was
<nobr>C++</nobr>. &#34;<q>In general, it feels like <nobr>C++</nobr> has a cumbersome mix of
low-level and high-level features.</q>&#34;</p>

<h4>Out of the blue</h4>

<p>Ultimately, the discussion trailed off in early February without
any concrete plan of adopting Rust. The thread was re-awakened by Shawn Webb on July 31. Webb <a href="https://lists.freebsd.org/archives/freebsd-hackers/2024-July/003433.html">replied</a>
to Somers&#39; original email with the news that the Defense
Advanced Research Projects Agency (DARPA) is investigating a program
to automate <a href="https://www.darpa.mil/program/translating-all-c-to-rust">rewriting
C code to Rust</a>, called Translating All C to Rust (TRACTOR).</p>

<p>Losh <a href="https://lists.freebsd.org/archives/freebsd-hackers/2024-July/003437.html">said</a>
that he was still waiting for someone to take him up on the suggestion to
do build-system integration for Rust tests. &#34;<q>Since the Rust
advocates can&#39;t get even this basic step done for review, it&#39;s going
to be impossible to have Rust in the base.</q>&#34; Webb <a href="https://lists.freebsd.org/archives/freebsd-hackers/2024-July/003439.html">replied</a>
that he would be willing to find time in September to work on build
system integration, if Losh was willing to mentor him, which Losh
<a href="https://lists.freebsd.org/archives/freebsd-hackers/2024-August/003458.html">agreed to do</a>.</p> 

<p>Konstantin Belousov <a href="https://lists.freebsd.org/archives/freebsd-hackers/2024-August/003463.html">replied</a>
that it would be better to focus on what useful things 
could be implemented in Rust, rather than how to integrate code into
the build. That caused Kamp to <a href="https://lists.freebsd.org/archives/freebsd-hackers/2024-August/003468.html">interject</a>
with a history lesson about the failures of importing Perl into
FreeBSD&#39;s base system.</p>

<p>The choice to bring Perl into the base system, he said, was based
on arguments identical to those being made for Rust.
The project overlooked the fact that Perl was more than a
programming language, it was an ecosystem with a &#34;<q>rapidly exploding
number of Perl Modules</q>&#34;. The goals of rewriting things in Perl
went unrealized, he said, once developers realized that FreeBSD base
only offered Perl the language and not Perl the ecosystem:</p>

<blockquote>
<p>Having Perl in the tree was a net loss, and a big loss, because it
created a version gap between &#34;real Perl&#34; and &#34;freebsd Perl&#34;, a gap
which kept growing larger over time as [enthusiasm] for Perl in the
tree evaporated.</p>

<p>Adding Rust to FreeBSD will be the /exact/ same thing!</p>
</blockquote>

<p>That left two options, Kamp said. The first is a FreeBSD Rust only intended for
use in base without benefit of the Rust ecosystem, the second would be
to find a way to allow FreeBSD Rust to &#34;<q>play nice with both Rust in ports and the
Rust ecosystem outside ports</q>&#34;. He was pessimistic about the second
option being possible at all, and even if it was &#34;<q>it is almost guaranteed
to be a waste of our time and energy</q>&#34; and would revert to the
first option in a few years.</p>

<p>A third option, he said, would be to work on a distribution of
FreeBSD based on packages instead of the base/ports system it has
now. That could allow FreeBSD to have the benefit of the Rust
ecosystem, or Python, or <nobr>C++</nobr>, etc.</p>

<h4>A demo</h4>

<p>On August 4, Somers <a href="https://lists.freebsd.org/archives/freebsd-hackers/2024-August/003472.html">posted</a>
a link <a href="https://github.com/asomers/freebsd-src/tree/rust-in-base-demo">to
a repository forked</a> from the <a href="https://github.com/freebsd/freebsd-src">FreeBSD src tree</a>
with examples of new programs written from scratch, old programs
rewritten in Rust with new features, and libraries written in
Rust. Somers also noted several 
features that his demo did not include, such as kernel modules
(&#34;<q>those are too hard</q>&#34;), integrating the Rust build system with
Make, or cdylib libraries (those are Rust libraries intended to be
linked into C/<nobr>C++</nobr> programs). He invited anyone with
questions about what it would look like to include Rust in base to
examine his demo branch.</p>

<p>Kamp <a href="https://lists.freebsd.org/archives/freebsd-hackers/2024-August/003473.html">replied</a>
that Somers&#39;s demo was awesome, but asked if it was worth the effort
when compared to the idea of a package-based version of FreeBSD where Rust things
could be built without all the extra effort. That sparked a
back-and-forth about the difficulties of maintaining tests separately
from fast-moving features in the kernel. Ultimately, Kamp <a href="https://lists.freebsd.org/archives/freebsd-hackers/2024-August/003482.html">said</a> that he
understood the problem: &#34;<q>I&#39;ve been there myself with code I have
maintained for customers.</q>&#34; The problem of maintaining Rust code
separately from kernel code only impacts a few dozen
developers. &#34;<q>Adding Rust to src would inconvenience /everybody/,
every time they do a &#39;make buildworld&#39;.</q>&#34; The solution, he said, is
not to add Rust to src, but to &#34;<q>get rid of the &#39;Src is the holy ivory tower,
everything else is barbarians&#39; mentality</q>&#34; that has caused FreeBSD
trouble over the years.</p>

<h4>Into the black</h4>

<p>Once again, the discussion trailed off without any firm
resolution. No doubt the topic will come up again, perhaps later this
year if Webb and Losh dig into Rust build-system integration. Rust may
yet find its way into FreeBSD&#39;s base system, unless Kamp&#39;s vision of a
package-based FreeBSD comes to pass and makes the distinction
irrelevant.</p></div></div>
  </body>
</html>
