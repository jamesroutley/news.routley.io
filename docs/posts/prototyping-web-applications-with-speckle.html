<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mclare.blog/posts/prototyping-web-applications-with-speckle">Original</a>
    <h1>Prototyping Web Applications With Speckle</h1>
    
    <div id="readability-page-1" class="page"><div><h2 id="motivation"><a href="#motivation" aria-label="motivation permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Motivation</h2>
<p>I recently finished reading Scott Young’s book, <a href="https://www.scotthyoung.com/blog/ultralearning/" target="_blank" rel="nofollow noopener noreferrer">Ultralearning</a>, and one of the principles that I really identified with was “Directness” which promotes Project-Based Learning as a tactic for <strong>getting stuff done</strong>. Ironically, I  actually took an entire course in grad school on Project-Based Learning and <em>hated</em> it at the time. However, throughout my career, scoping and completing smaller projects (while sometimes having no knowledge of the domain beforehand) has been really what’s pushed me as a software developer.</p>
<p>I’ve been following the <a href="https://osarch.org" target="_blank" rel="nofollow noopener noreferrer">OSArch</a> group’s advocacy of <a href="https://technical.buildingsmart.org/standards/ifc/" target="_blank" rel="nofollow noopener noreferrer">IFC</a> and other open data formats as a way to buck opaque industry-standard software for quite a while (particularly with <a href="https://blenderbim.org/" target="_blank" rel="nofollow noopener noreferrer">BlenderBIM</a>). Since I started focusing on software development, I haven’t really had a need to use IFC, as I’m rarely working on an actual building project.</p>
<p>In the same vein, I haven’t had a need to really work with <a href="https://speckle.systems/" target="_blank" rel="nofollow noopener noreferrer">Speckle</a>, since I’m no longer working on projects that require a lot of coordination between disciplines (though I have been itching to try out what source control means when applied to a building model).</p>
<p>I also wanted to brush up on my life cycle assessment knowledge (which has been languishing since graduate school as well), since I had signed up a few weeks ago to attend an all day seminar on sustainability in structural engineering. I knew that the <a href="https://buildingtransparency.org/ec3" target="_blank" rel="nofollow noopener noreferrer">EC3 tool</a>  was one of the few freely available repositories for Environmental Product Declarations (EPDs), but I’d only worked with the web interface. Building a web application that would utilize all three components seemed like a good way to get an idea of the difficulty of working with both the Speckle and EC3 APIs, as well as forcing me to take a closer look at IFC, since I would take one of the prototypical building models to do so.</p>
<p>The end result of this exploration is a small React app that shows the estimated embodied carbon (Product Stage A1-A3 in <a href="https://oneclicklca.zendesk.com/hc/en-us/articles/360015064999-Life-Cycle-Stages" target="_blank" rel="nofollow noopener noreferrer">Life-Cycle Stages</a>), and allows for site updating while pulling EPDs per material for up to 50 of the closest geographically matching EPDs. It also uses <a href="https://d3js.org/" target="_blank" rel="nofollow noopener noreferrer">D3</a> to create a bar chart of the spread of embodied carbon values for each material. While you wouldn’t normally move a project around, I was curious how much these geolocated values would change, particularly since distance of materials to site can factor into other sustainability related metrics (and is something that is considered in a full life cycle assessment as stage A4).</p>
<figure><img src="https://www.nist.gov/6b3bc11ca99762fe3b57b5201780e61e/speckle_location_gif.gif"/><figcaption>Finished Toy Web App</figcaption></figure>
<blockquote>
<p><strong>NOTE:</strong> I can’t deploy this application on a publicly accessible server, because it violates ToS for the EC3 API (you have to use your own credentials for the service). To try this out for yourself you’d need to download the <a href="https://github.com/m-clare/react-ec3-speckle" target="_blank" rel="nofollow noopener noreferrer">repository</a> and run the front end and back end on different ports locally, as well as adjust the <code>.env</code> files to the right variables (using your own credentials). If you’re <a href="https://www.docker.com/" target="_blank" rel="nofollow noopener noreferrer">Docker</a> savvy, I’ve included a <a href="https://docs.docker.com/compose/" target="_blank" rel="nofollow noopener noreferrer">docker-compose</a> development file as well.</p>
</blockquote>
<h2 id="initial-steps"><a href="#initial-steps" aria-label="initial steps permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Initial Steps</h2>
<p>buildingSMART is responsible for IFC’s development as an open, international standard for built environment assets. Their <a href="https://github.com/buildingSMART" target="_blank" rel="nofollow noopener noreferrer">github</a> contains a number of sample test files, so I pulled the one for a <a href="https://github.com/buildingSMART/Sample-Test-Files/blob/master/IFC%202x3/Duplex%20Apartment/Duplex_A_20110907.ifc" target="_blank" rel="nofollow noopener noreferrer">Duplex Apartment</a> which I had seen elsewhere. (It’s also listed in the <a href="https://github.com/IfcOpenShell/IfcOpenShell#usage-examples" target="_blank" rel="nofollow noopener noreferrer">Usage examples</a> for <a href="http://ifcopenshell.org/" target="_blank" rel="nofollow noopener noreferrer">IfcOpenShell</a> which is an open-source project well worth looking into).</p>
<p>Getting the IFC file into Speckle was about as <a href="https://speckle.guide/user/ifc.html" target="_blank" rel="nofollow noopener noreferrer">easy as you can get</a>. All you need to do is create a stream, and drag and drop the IFC file onto the canvas.</p>
<p><span>
      <a href="https://www.nist.gov/static/1ce324d895bc7929926d7950e11705e1/afa26/speckle_ifc_drag_drop.png" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/1ce324d895bc7929926d7950e11705e1/ba381/speckle_ifc_drag_drop.webp 200w,
/static/1ce324d895bc7929926d7950e11705e1/7f61c/speckle_ifc_drag_drop.webp 400w,
/static/1ce324d895bc7929926d7950e11705e1/d00b9/speckle_ifc_drag_drop.webp 800w,
/static/1ce324d895bc7929926d7950e11705e1/92f8c/speckle_ifc_drag_drop.webp 1200w,
/static/1ce324d895bc7929926d7950e11705e1/c681e/speckle_ifc_drag_drop.webp 1258w" sizes="(max-width: 800px) 100vw, 800px" type="image/webp"/>
          <source srcset="/static/1ce324d895bc7929926d7950e11705e1/772e8/speckle_ifc_drag_drop.png 200w,
/static/1ce324d895bc7929926d7950e11705e1/e17e5/speckle_ifc_drag_drop.png 400w,
/static/1ce324d895bc7929926d7950e11705e1/5a190/speckle_ifc_drag_drop.png 800w,
/static/1ce324d895bc7929926d7950e11705e1/c1b63/speckle_ifc_drag_drop.png 1200w,
/static/1ce324d895bc7929926d7950e11705e1/afa26/speckle_ifc_drag_drop.png 1258w" sizes="(max-width: 800px) 100vw, 800px" type="image/png"/>
          <img src="https://www.nist.gov/static/1ce324d895bc7929926d7950e11705e1/5a190/speckle_ifc_drag_drop.png" alt="Speckle IFC Interface" title="Speckle IFC Interface" loading="lazy"/>
        </picture>
  </a>
    </span></p>
<p>Once the file is uploaded to Speckle, you should be able to view it in their 3d viewer, and even filter by ObjectType to isolate parts of the structure, like the foundations or the walls.</p>
<p><span>
      <a href="https://www.nist.gov/static/1240cd8e9905bb18fd8cd2697bf3f3ec/d5c6f/speckle_3d_viewer.png" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/1240cd8e9905bb18fd8cd2697bf3f3ec/ba381/speckle_3d_viewer.webp 200w,
/static/1240cd8e9905bb18fd8cd2697bf3f3ec/7f61c/speckle_3d_viewer.webp 400w,
/static/1240cd8e9905bb18fd8cd2697bf3f3ec/d00b9/speckle_3d_viewer.webp 800w,
/static/1240cd8e9905bb18fd8cd2697bf3f3ec/92f8c/speckle_3d_viewer.webp 1200w,
/static/1240cd8e9905bb18fd8cd2697bf3f3ec/8f19f/speckle_3d_viewer.webp 1261w" sizes="(max-width: 800px) 100vw, 800px" type="image/webp"/>
          <source srcset="/static/1240cd8e9905bb18fd8cd2697bf3f3ec/772e8/speckle_3d_viewer.png 200w,
/static/1240cd8e9905bb18fd8cd2697bf3f3ec/e17e5/speckle_3d_viewer.png 400w,
/static/1240cd8e9905bb18fd8cd2697bf3f3ec/5a190/speckle_3d_viewer.png 800w,
/static/1240cd8e9905bb18fd8cd2697bf3f3ec/c1b63/speckle_3d_viewer.png 1200w,
/static/1240cd8e9905bb18fd8cd2697bf3f3ec/d5c6f/speckle_3d_viewer.png 1261w" sizes="(max-width: 800px) 100vw, 800px" type="image/png"/>
          <img src="https://www.nist.gov/static/1240cd8e9905bb18fd8cd2697bf3f3ec/5a190/speckle_3d_viewer.png" alt="Speckle 3D Viewer" title="Speckle 3D Viewer" loading="lazy"/>
        </picture>
  </a>
    </span></p>
<p>Since I started with uploading the base IFC file, I didn’t check to see if <a href="https://standards.buildingsmart.org/IFC/RELEASE/IFC4_1/FINAL/HTML/schema/ifcquantityresource/lexical/ifcquantityvolume.htm" target="_blank" rel="nofollow noopener noreferrer">IfcQuantityVolume</a> entities were attached to the elements. Rather than wrestling with adding these properties, I took a shortcut (and took advantage) in Speckle, where I could use the <a href="https://speckle.systems/tag/grasshopper/" target="_blank" rel="nofollow noopener noreferrer">Grasshopper</a> adapter to isolate material categories based on the IFC name and attach non-dynamic properties to both indicate the material type (keeping it really simple with just “Concrete”, “Steel”, “CMU”, “Wood”, and “Brick” as options) and get the volumes of the meshes using the geometry from IFC. Ideally you would want some kind of direct mapping from the Speckle material type (or IFC material type) to the EC3 material category type, but this was outside the scope of what I was trying to do.</p>
<p><span>
      <a href="https://www.nist.gov/static/f0f24744aa246cea20dd3a0030f1ec94/de99e/speckle_GH_material_info.png" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/f0f24744aa246cea20dd3a0030f1ec94/ba381/speckle_GH_material_info.webp 200w,
/static/f0f24744aa246cea20dd3a0030f1ec94/7f61c/speckle_GH_material_info.webp 400w,
/static/f0f24744aa246cea20dd3a0030f1ec94/d00b9/speckle_GH_material_info.webp 800w,
/static/f0f24744aa246cea20dd3a0030f1ec94/92f8c/speckle_GH_material_info.webp 1200w,
/static/f0f24744aa246cea20dd3a0030f1ec94/fad48/speckle_GH_material_info.webp 1600w,
/static/f0f24744aa246cea20dd3a0030f1ec94/30d64/speckle_GH_material_info.webp 2321w" sizes="(max-width: 800px) 100vw, 800px" type="image/webp"/>
          <source srcset="/static/f0f24744aa246cea20dd3a0030f1ec94/772e8/speckle_GH_material_info.png 200w,
/static/f0f24744aa246cea20dd3a0030f1ec94/e17e5/speckle_GH_material_info.png 400w,
/static/f0f24744aa246cea20dd3a0030f1ec94/5a190/speckle_GH_material_info.png 800w,
/static/f0f24744aa246cea20dd3a0030f1ec94/c1b63/speckle_GH_material_info.png 1200w,
/static/f0f24744aa246cea20dd3a0030f1ec94/29007/speckle_GH_material_info.png 1600w,
/static/f0f24744aa246cea20dd3a0030f1ec94/de99e/speckle_GH_material_info.png 2321w" sizes="(max-width: 800px) 100vw, 800px" type="image/png"/>
          <img src="https://www.nist.gov/static/f0f24744aa246cea20dd3a0030f1ec94/5a190/speckle_GH_material_info.png" alt="Speckle Grasshopper Material Extraction" title="Speckle Grasshopper Material Extraction" loading="lazy"/>
        </picture>
  </a>
    </span></p>
<p>One of the things I discovered from doing this was that unfortunately some of the CMU meshes were not watertight, so I couldn’t get a calculated volume on them within Grasshopper (since I was just prototyping I ignored this for now). Once I’d added volume and material properties and isolated the structural type elements, I pushed them to a new “structural” <a href="https://speckle.guide/user/concepts.html#branches" target="_blank" rel="nofollow noopener noreferrer">branch</a> on Speckle.</p>
<p><span>
      <a href="https://www.nist.gov/static/6840761c495225f27b34809907ec20e7/f69a0/speckle_GH_attach_material.png" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/6840761c495225f27b34809907ec20e7/ba381/speckle_GH_attach_material.webp 200w,
/static/6840761c495225f27b34809907ec20e7/7f61c/speckle_GH_attach_material.webp 400w,
/static/6840761c495225f27b34809907ec20e7/d00b9/speckle_GH_attach_material.webp 800w,
/static/6840761c495225f27b34809907ec20e7/92f8c/speckle_GH_attach_material.webp 1200w,
/static/6840761c495225f27b34809907ec20e7/fad48/speckle_GH_attach_material.webp 1600w,
/static/6840761c495225f27b34809907ec20e7/7a3ae/speckle_GH_attach_material.webp 1783w" sizes="(max-width: 800px) 100vw, 800px" type="image/webp"/>
          <source srcset="/static/6840761c495225f27b34809907ec20e7/772e8/speckle_GH_attach_material.png 200w,
/static/6840761c495225f27b34809907ec20e7/e17e5/speckle_GH_attach_material.png 400w,
/static/6840761c495225f27b34809907ec20e7/5a190/speckle_GH_attach_material.png 800w,
/static/6840761c495225f27b34809907ec20e7/c1b63/speckle_GH_attach_material.png 1200w,
/static/6840761c495225f27b34809907ec20e7/29007/speckle_GH_attach_material.png 1600w,
/static/6840761c495225f27b34809907ec20e7/f69a0/speckle_GH_attach_material.png 1783w" sizes="(max-width: 800px) 100vw, 800px" type="image/png"/>
          <img src="https://www.nist.gov/static/6840761c495225f27b34809907ec20e7/5a190/speckle_GH_attach_material.png" alt="Speckle Grasshopper Material/Volume Property Attachment" title="Speckle Grasshopper Material/Volume Property Attachment" loading="lazy"/>
        </picture>
  </a>
    </span></p>
<h2 id="working-with-the-ec3-and-speckle-apis"><a href="#working-with-the-ec3-and-speckle-apis" aria-label="working with the ec3 and speckle apis permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Working with the EC3 and Speckle APIs</h2>
<p>Both <a href="https://speckle.guide/dev/server-graphql-api.html#graphql-api" target="_blank" rel="nofollow noopener noreferrer">Speckle</a> and <a href="https://etl-api.cqd.io/#/" target="_blank" rel="nofollow noopener noreferrer">EC3</a> have APIs that are accessible with a free account on their platform; Speckle uses GraphQL (but also supports a REST API) and EC3 has a standard REST API. As far as I can tell, you cannot access the EC3 API through the browser, so I had to host an intermediary proxy (the <a href="https://github.com/m-clare/react-ec3-speckle/tree/main/backend" target="_blank" rel="nofollow noopener noreferrer">backend</a> on github) using <a href="https://nodejs.org/en/" target="_blank" rel="nofollow noopener noreferrer">NodeJS</a>, while I was able to use <a href="https://www.apollographql.com/" target="_blank" rel="nofollow noopener noreferrer">Apollo Client</a> to directly fetch my query from Speckle. I decided to use <a href="https://redis.io/" target="_blank" rel="nofollow noopener noreferrer">Redis</a> to cache the EC3 queries to avoid hitting the endpoint too much as I did some troubleshooting (my keys were the query string passed from the React front end, consisting of the location and the materials).</p>
<h3 id="backend"><a href="#backend" aria-label="backend permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Backend</h3>
<p>On the backend with Node, I had to update the project location within EC3 to ensure that I was retrieving the 50 closest geographical material results for a given location. The EC3 endpoint for setting an address is pretty forgiving in what it will accept, and will do the best it can with a given string (I tried street addresses, cities, states, and zip codes and all seemed to work. Latitudes and longitudes were a no-go unfortunately).</p>
<h5 id="backendapijs"><a href="#backendapijs" aria-label="backendapijs permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong><code>backend/api.js</code></strong></h5>
<div data-language="javascript"><pre><code><span>const</span> <span>changeProjectLocation</span> <span>=</span> <span>async</span> <span>(</span><span>locationString</span><span>)</span> <span>=&gt;</span> <span>{</span>
  <span>const</span> headers <span>=</span> <span>await</span> <span>getHeaders</span><span>(</span><span>)</span><span>;</span>
  <span>const</span> projectInfo <span>=</span> <span>await</span> <span>getProject</span><span>(</span><span>)</span><span>;</span>
  <span>const</span> location <span>=</span> <span>decodeURI</span><span>(</span>locationString<span>)</span><span>;</span>
  <span>const</span> body <span>=</span> <span>JSON</span><span>.</span><span>stringify</span><span>(</span><span>{</span> name<span>:</span> projectInfo<span>.</span>name<span>,</span> address<span>:</span> location <span>}</span><span>)</span><span>;</span>
  <span>return</span> <span>await</span> <span>fetch</span><span>(</span>baseURL <span>+</span> <span>&#34;/projects/&#34;</span> <span>+</span> projectInfo<span>.</span>id<span>,</span> <span>{</span>
    method<span>:</span> <span>&#34;PUT&#34;</span><span>,</span>
    headers<span>:</span> headers<span>,</span>
    body<span>:</span> body<span>,</span>
  <span>}</span><span>)</span>
    <span>.</span><span>then</span><span>(</span><span>(</span><span>response</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>if</span> <span>(</span>response<span>.</span>ok<span>)</span> <span>{</span>
        <span>return</span> response<span>;</span>
      <span>}</span> <span>else</span> <span>if</span> <span>(</span>response<span>.</span>status <span>&gt;=</span> <span>400</span> <span>&amp;&amp;</span> response<span>.</span>status <span>&lt;</span> <span>600</span><span>)</span> <span>{</span>
        <span>throw</span> <span>new</span> <span>Error</span><span>(</span><span>&#34;Bad response from server&#34;</span><span>)</span><span>;</span>
      <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>typeof</span> response <span>===</span> <span>&#34;undefined&#34;</span><span>)</span> <span>{</span>
        <span>throw</span> <span>new</span> <span>Error</span><span>(</span><span>&#34;Response was undefined&#34;</span><span>)</span><span>;</span>
      <span>}</span> <span>else</span> <span>{</span>
        <span>throw</span> <span>new</span> <span>Error</span><span>(</span><span>&#34;Unknown error in fetch response.&#34;</span><span>)</span><span>;</span>
      <span>}</span>
    <span>}</span><span>)</span>
    <span>.</span><span>then</span><span>(</span><span>(</span><span>returnedResponse</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>return</span> returnedResponse<span>.</span><span>json</span><span>(</span><span>)</span><span>;</span>
    <span>}</span><span>)</span>
    <span>.</span><span>catch</span><span>(</span><span>(</span><span>error</span><span>)</span> <span>=&gt;</span> <span>{</span>
      console<span>.</span><span>log</span><span>(</span>error<span>)</span><span>;</span>
    <span>}</span><span>)</span><span>;</span>
<span>}</span><span>;</span></code></pre></div>
<p>I also decided to group all the material calls into a single endpoint, which meant figuring out how to await all of the async calls for retrieving each material category before returning the data to react with the proper data shape.</p>
<h5 id="backendserverjs"><a href="#backendserverjs" aria-label="backendserverjs permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><strong><code>backend/server.js</code></strong></h5>
<div data-language="javascript"><pre><code><span>const</span> asyncFunctions <span>=</span> dictionary<span>[</span><span>&#34;materials&#34;</span><span>]</span><span>.</span><span>map</span><span>(</span><span>(</span><span>d</span><span>)</span> <span>=&gt;</span> <span>getMaterial</span><span>(</span>d<span>,</span> distance<span>)</span><span>)</span><span>;</span>
<span>const</span> result <span>=</span> <span>await</span> Promise<span>.</span><span>all</span><span>(</span>asyncFunctions<span>)</span><span>;</span>
<span>const</span> resultObj <span>=</span> result<span>.</span><span>reduce</span><span>(</span><span>(</span><span>acc<span>,</span> curr</span><span>)</span> <span>=&gt;</span> <span>(</span><span>{</span> <span>...</span>acc<span>,</span> <span>...</span>curr <span>}</span><span>)</span><span>,</span> <span>{</span><span>}</span><span>)</span><span>;</span></code></pre></div>
<p>Rather than wrestling with user input EPD units differing from category declared units (for example, some EPDs functional units are an order of magnitude different than their overall category - 1 kg vs 1 ton, or are volumetric instead of mass based), I decided to prune any material EPDs that weren’t the standard volumetric ones. I also had to deal with the fact that the units and values stored in the EC3 database are strings, so I had to parse out the numerical values and the units for each property I wanted to return.</p>
<div data-language="javascript"><pre><code><span>const</span> <span>getMaterial</span> <span>=</span> <span>async</span> <span>(</span><span>materialName<span>,</span> distance</span><span>)</span> <span>=&gt;</span> <span>{</span>
 <span>...</span>
 <span>const</span> acceptableUnits <span>=</span> <span>{</span>
    concrete<span>:</span> <span>&#34;1 m3&#34;</span><span>,</span>
    steel<span>:</span> <span>&#34;1 t&#34;</span><span>,</span>
    wood<span>:</span> <span>&#34;1 m3&#34;</span><span>,</span>
    cmu<span>:</span> <span>&#34;1 m3&#34;</span><span>,</span>
    brick<span>:</span> <span>&#34;1 m3&#34;</span><span>,</span>
  <span>}</span>
  <span>...</span>
  <span>const</span> data <span>=</span> rawData<span>.</span><span>map</span><span>(</span><span>(</span><span>d</span><span>)</span> <span>=&gt;</span> <span>{</span>
        <span>let</span> processedData <span>=</span> <span>{</span>
          name<span>:</span> d<span>.</span>name<span>,</span>
          description<span>:</span> d<span>.</span>description<span>,</span>
          declared_unit<span>:</span> d<span>.</span>declared_unit<span>,</span>
          gwp_per_category_declared_unit<span>:</span> d<span>.</span>gwp_per_category_declared_unit<span>,</span>
          plant_or_group<span>:</span> d<span>.</span>plant_or_group<span>,</span>
        <span>}</span><span>;</span>
        <span>for</span> <span>(</span><span>const</span> property <span>of</span> propertiesWithUnits<span>)</span> <span>{</span>
          <span>if</span> <span>(</span>d<span>[</span>property<span>]</span><span>)</span> <span>{</span>
            processedData <span>=</span> <span>{</span>
              <span>...</span>processedData<span>,</span>
              <span>[</span>property<span>]</span><span>:</span> <span>{</span>
                value<span>:</span> <span>+</span>d<span>[</span>property<span>]</span><span>.</span><span>split</span><span>(</span><span>&#34; &#34;</span><span>)</span><span>[</span><span>0</span><span>]</span><span>,</span>
                unit<span>:</span> d<span>[</span>property<span>]</span><span>.</span><span>split</span><span>(</span><span>&#34; &#34;</span><span>)</span><span>[</span><span>1</span><span>]</span><span>,</span>
              <span>}</span><span>,</span>
            <span>}</span><span>;</span>
          <span>}</span>
        <span>}</span>
        <span>return</span> processedData<span>;</span>
      <span>}</span><span>)</span><span>;</span>
      <span>const</span> filteredData <span>=</span> data<span>.</span><span>filter</span><span>(</span><span>(</span><span>d</span><span>)</span> <span>=&gt;</span> d<span>.</span>declared_unit <span>===</span> acceptableUnits<span>[</span>materialName<span>]</span><span>)</span>
<span>}</span></code></pre></div>
<h3 id="frontend"><a href="#frontend" aria-label="frontend permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Frontend</h3>
<p><a href="https://reactjs.org/" target="_blank" rel="nofollow noopener noreferrer">React</a> + <a href="https://mui.com/" target="_blank" rel="nofollow noopener noreferrer">Material UI</a> + <a href="https://d3js.org/" target="_blank" rel="nofollow noopener noreferrer">D3</a> have served me well for quickly putting together web applications that look half decent. It’s easier than ever now with platforms like <a href="https://observablehq.com" target="_blank" rel="nofollow noopener noreferrer">Observable</a> allowing users to quickly prototype data visualizations based on their starter templates. I didn’t play much with Speckle’s Javascript SDK, just opting to embed their 3d viewer as an <a href="https://speckle.guide/user/web.html#embedding-the-3d-viewer" target="_blank" rel="nofollow noopener noreferrer">iFrame</a> (though it would be really cool to link some interactivity between the 3d viewer and some graphs).</p>
<p>Most of the code in <code>frontend</code> is really for styling with Material UI. I only created two components for the <a href="https://github.com/m-clare/react-ec3-speckle/blob/main/frontend/src/components/barChart/index.js" target="_blank" rel="nofollow noopener noreferrer">bar chart</a> and for the <a href="https://github.com/m-clare/react-ec3-speckle/blob/main/frontend/src/components/dataTable/index.js" target="_blank" rel="nofollow noopener noreferrer">data table</a>.</p>
<p>I just needed one API call for Speckle to retrieve the volume and material data I needed:</p>
<div data-language="javascript"><pre><code><span>const</span> <span>GET_SPECKLEOBJECTS</span> <span>=</span> gql<span><span>`</span><span>
  query {
    stream(id: &#34;6d6cbc1bdf&#34;) {
      object(id: &#34;ab1a4d9d2c58985b94648a4b105c011e&#34;) {
        children(select: [&#34;Volume&#34;, &#34;Name&#34;, &#34;Material&#34;]) {
          totalCount
          objects {
            totalChildrenCount
            data
          }
        }
      }
    }
  }
</span><span>`</span></span><span>;</span></code></pre></div>
<p>Once I summed the volumes for each component by material type from Speckle, I could just do dimensional analysis with the material data pulled from EC3 to generate the table values based on knowing the material density and the global warming potential (GWP) per kg of material. I took the average GWP “Conservative Estimate” value for the 50 (or fewer) closest materials to the site. In addition, I provided a bar chart with the raw EPD data per material that would be averaged to show if there were any outliers. One thing I learned from this exercise is that you really need to get pretty granular with your material specification in EC3, as “Wood” with a description of “Structural Wood Products used in construction” will return standard rough lumber, as well as Plyboo, which will blow up your average EPD value. In the future, it would be nice for the user to be able to click to remove irrelevant materials on the frontend (and this shouldn’t be too hard to do).</p>
<p><span>
      <a href="https://www.nist.gov/static/1e7b9c9f5d159cbd762d65f605ac002c/2d2d6/speckle_react_webapp.png" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/1e7b9c9f5d159cbd762d65f605ac002c/ba381/speckle_react_webapp.webp 200w,
/static/1e7b9c9f5d159cbd762d65f605ac002c/7f61c/speckle_react_webapp.webp 400w,
/static/1e7b9c9f5d159cbd762d65f605ac002c/d00b9/speckle_react_webapp.webp 800w,
/static/1e7b9c9f5d159cbd762d65f605ac002c/92f8c/speckle_react_webapp.webp 1200w,
/static/1e7b9c9f5d159cbd762d65f605ac002c/9fb66/speckle_react_webapp.webp 1205w" sizes="(max-width: 800px) 100vw, 800px" type="image/webp"/>
          <source srcset="/static/1e7b9c9f5d159cbd762d65f605ac002c/772e8/speckle_react_webapp.png 200w,
/static/1e7b9c9f5d159cbd762d65f605ac002c/e17e5/speckle_react_webapp.png 400w,
/static/1e7b9c9f5d159cbd762d65f605ac002c/5a190/speckle_react_webapp.png 800w,
/static/1e7b9c9f5d159cbd762d65f605ac002c/c1b63/speckle_react_webapp.png 1200w,
/static/1e7b9c9f5d159cbd762d65f605ac002c/2d2d6/speckle_react_webapp.png 1205w" sizes="(max-width: 800px) 100vw, 800px" type="image/png"/>
          <img src="https://www.nist.gov/static/1e7b9c9f5d159cbd762d65f605ac002c/5a190/speckle_react_webapp.png" alt="Redis - NodeJS - ReactJS - D3 - EC3 - Speckle 🥞" title="Redis - NodeJS - ReactJS - D3 - EC3 - Speckle 🥞" loading="lazy"/>
        </picture>
  </a>
    </span></p></div></div>
  </body>
</html>
