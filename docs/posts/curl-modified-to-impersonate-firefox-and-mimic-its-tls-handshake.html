<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/lwthiker/curl-impersonate">Original</a>
    <h1>Show HN: Curl modified to impersonate Firefox and mimic its TLS handshake</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
          <article itemprop="text"><p dir="auto">A special compilation of <a href="https://github.com/curl/curl">curl</a> that makes it impersonate Firefox. This curl binary is able to perform a TLS handshake that is identical to Firefox.</p>
<h2 dir="auto"><a id="user-content-why" aria-hidden="true" href="#why"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Why?</h2>
<p dir="auto">When you use an HTTP client with a TLS website, it first performs a TLS handshake. The first message of that handshake is called Client Hello. The Client Hello message that curl produces differs drastically from that of a real browser. Compare the following Wireshark capture. Left is a regular curl, right is Firefox.
<a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/99899249/154530138-1cba5a23-53d7-4f1a-adc4-7c087e61deb5.png"><img src="https://user-images.githubusercontent.com/99899249/154530138-1cba5a23-53d7-4f1a-adc4-7c087e61deb5.png" alt="curl-ff-before"/></a></p>
<p dir="auto">Some web services therefore use the TLS handshake to fingerprint which HTTP client is accessing them. Notably, some bot protection platforms use this to identify curl and block it. With the modified curl in this repository, the Client Hello message looks <em>exactly</em> like Firefox&#39;s. This tricks TLS fingerprinters to think that it is Firefox that is accessing them, and is able to bypass some well-known bot protections.</p>
<h2 dir="auto"><a id="user-content-how" aria-hidden="true" href="#how"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>How?</h2>
<p dir="auto">The modifications that were needed to make this work:</p>
<ul dir="auto">
<li>Compiling curl with nss, the TLS library that Firefox uses, instead of OpenSSL.</li>
<li>Modifying the way curl configures various TLS extensions and SSL options.</li>
<li>Running curl with some non-default flags, specifically <code>--http2</code>, <code>--ciphers</code>, and some <code>-H</code> headers.</li>
</ul>
<p dir="auto">The resulting curl looks, from a network perspective, identical to Firefox (Firefox 95, Windows, non-incognito mode). Compare: (left is <code>curl-impersonate</code>, right is Firefox):</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/99899249/154556768-81bb9dbe-5c3d-4a1c-a0ab-f10a3cd69d9a.png"><img src="https://user-images.githubusercontent.com/99899249/154556768-81bb9dbe-5c3d-4a1c-a0ab-f10a3cd69d9a.png" alt="curl-ff-after"/></a></p>
<p dir="auto">Read the full description in the <a href="https://lwthiker.com/reversing/2022/02/17/curl-impersonate-firefox.html" rel="nofollow">blog post</a>.</p>
<h2 dir="auto"><a id="user-content-installation" aria-hidden="true" href="#installation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Installation</h2>
<p dir="auto">This repository contains a Dockerfile that will build curl with all the necessary modifications. Build it like any Docker image:</p>
<div data-snippet-clipboard-copy-content="docker build -t curl-impersonate ."><pre><code>docker build -t curl-impersonate .
</code></pre></div>
<p dir="auto">The resulting image contains:</p>
<ul dir="auto">
<li><code>/build/out/curl-impersonate</code> - The curl binary that can impersonate Firefox. It is compiled statically against libcurl, nss, and libnghttp2 so that it won&#39;t conflict with any existing libraries on your system. You can use it from the container or copy it out. Tested to work on Ubuntu 20.04.</li>
<li><code>/build/out/curl_ff95</code> - A wrapper script that launches <code>curl-impersonate</code> with the needed headers and ciphers to impersonate Firefox 95.</li>
</ul>
<p dir="auto">Copy them from the docker image using <code>docker cp</code> or use them in a multi-stage docker build.</p>
<p dir="auto">In addition install libnss3: <code>sudo apt install libnss3</code>.  Even though nss is statically compiled into <code>curl-impersonate</code>, it is still necessary to install libnss3 because curl dynamically loads <code>libnssckbi.so</code>, a file containing Mozilla&#39;s list of trusted root certificates. Alternatively, use <code>curl -k</code> to disable certificate verification.</p>
<h2 dir="auto"><a id="user-content-usage" aria-hidden="true" href="#usage"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Usage</h2>
<p dir="auto">It is recommended to use the wrapper script <code>curl_ff95</code> that adds all the correct headers and flags. For example:</p>
<div data-snippet-clipboard-copy-content="curl_ff95 https://www.google.com"><pre><code>curl_ff95 https://www.google.com
</code></pre></div>
<p dir="auto">You can add command line flags and they will be passed on to curl. However, some flags change curl&#39;s TLS signature which may cause it to be detected.</p>
<h2 dir="auto"><a id="user-content-contents" aria-hidden="true" href="#contents"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Contents</h2>
<p dir="auto">This repository contains the following files:</p>
<ul dir="auto">
<li><a href="https://commoncog.com/lwthiker/curl-impersonate/blob/main/Dockerfile">Dockerfile</a> - Used to build <code>curl-impersonate</code> with all dependencies.</li>
<li><a href="https://commoncog.com/lwthiker/curl-impersonate/blob/main/curl_ff95">curl_ff95</a> - Wrapper script that launches <code>curl-impersonate</code> with the correct flags.</li>
<li><a href="https://commoncog.com/lwthiker/curl-impersonate/blob/main/curl-lib-nss.patch">curl-lib-nss.patch</a> - The main patch that makes curl use the same TLS extensions as Firefox.</li>
<li><a href="https://commoncog.com/lwthiker/curl-impersonate/blob/main/libnghttp2-pc.patch">libnghttp2-pc.patch</a> - Patch to make libnghttp2 compile statically.</li>
<li><a href="https://commoncog.com/lwthiker/curl-impersonate/blob/main/curl-configure.patch">curl-configure.patch</a> - Patch to make curl compile with a static libnghttp2.</li>
<li><a href="https://commoncog.com/lwthiker/curl-impersonate/blob/main/curl-static-libnss.patch">curl-static-libnss.patch</a> - Patch to make curl compile with a static libnss.</li>
</ul>
<h2 dir="auto"><a id="user-content-whats-next" aria-hidden="true" href="#whats-next"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>What&#39;s next?</h2>
<p dir="auto">This was done in a very hacky way, but I hope it could be turned into a real project. Imagine that you could run:</p>
<div data-snippet-clipboard-copy-content="curl --impersonate ff95"><pre><code>curl --impersonate ff95
</code></pre></div>
<p dir="auto">and it would behave exactly like Firefox 95. It could then be wrappped with a nice Python library.</p>
</article>
        </div></div>
  </body>
</html>
