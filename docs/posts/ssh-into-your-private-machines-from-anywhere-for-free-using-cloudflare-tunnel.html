<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://orth.uk/ssh-over-cloudflare/">Original</a>
    <h1>SSH into your private machines from anywhere, for free, using Cloudflare Tunnel</h1>
    
    <div id="readability-page-1" class="page"><div id="post-content" itemprop="articleBody"><h2 id="outcome">Outcome<a href="#outcome" title="Direct link to heading">‚Äã</a></h2><p>By the end of this post, you&#39;ll be able to run: <code>ssh $machine_name</code> from anywhere in the internet-connected planet, using SSH keys. It is free and requires no future maintainance. This guide uses <a href="https://www.cloudflare.com/en-gb/products/tunnel/" target="_blank" rel="noopener noreferrer">Cloudflare Tunnel</a>, a service by Cloudflare with a free-tier. It will filter traffic to your machines through Cloudflare&#39;s network, including authenticating you. Because of this, your machines won&#39;t directly be exposed to threat actors and &#34;1337 haxors&#34;.</p><h2 id="motivation">Motivation<a href="#motivation" title="Direct link to heading">‚Äã</a></h2><p>You might have a machine running in your local network and want to access from anywhere in the world. <strong>Alternative</strong> solutions include: </p><ul><li>configuring your router to <strong>port forward</strong> to your specific machine or setting your machine as a demilitarized zone (DMZ). <strong>Disadvantages:</strong> your home router&#39;s IP address might change, so you&#39;ll need to use the new IP address. Each port is also limited to a single machine, so you&#39;d have to choose a different port for a different machine.</li><li>Many alternatives are listed in <a href="https://github.com/anderspitman/awesome-tunneling" target="_blank" rel="noopener noreferrer">anderspitman/awesome-tunnelling</a>, including <a href="https://www.cloudflare.com/en-gb/products/tunnel/" target="_blank" rel="noopener noreferrer">Cloudflare Tunnel</a>. Many of these require configuration, and the last time I tried ngrok, I couldn&#39;t choose the domain name on the free tier.</li></ul><p>I already use Cloudflare for this website (Cloudflare Pages), web analytics, configuring DNS records, and registering my domains (with no additional fee on top of the Administrator fee, e.g. Verisign for <code>.com</code> and Nominet for <code>.uk</code>). Hey UK domain owners, Cloudflare Registrar supports <code>uk</code> and <code>co.uk</code> TLDs now üòâ.</p><p>So I used <code>cloudflared</code> to do this, but realised there was no guide written that takes me step by step, to success. There was a <a href="https://developers.cloudflare.com/cloudflare-one/tutorials/ssh" target="_blank" rel="noopener noreferrer">Cloudflare official guide</a>, but some of the steps are not necessary, confusing (e.g. limiting the &#34;application&#34; to 1 month) and missing the <code>config.yml</code> schema.</p><h2 id="pre-requisites-">Pre-requisites ü¶ë<a href="#pre-requisites-" title="Direct link to heading">‚Äã</a></h2><ul><li>A free Cloudflare account</li><li>Understand Cloudflare Tunnel, by following <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/tunnel-guide" target="_blank" rel="noopener noreferrer">Set up your first tunnel</a>. You&#39;ll end up with a website added to Cloudflare, <code>cloudflared</code> <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation" target="_blank" rel="noopener noreferrer">installed</a> and logged in on your machine, and a high level understanding of Cloudflare Tunnel. <strong>You don&#39;t have to do step 4 (create configuration file) or later.</strong></li></ul><h2 id="setup-ssh-server-on-your-target-machine-">Setup SSH server on your target machine üéØ<a href="#setup-ssh-server-on-your-target-machine-" title="Direct link to heading">‚Äã</a></h2><ul><li>Skip if you&#39;ve done this already, for example, you can already SSH into your machine.</li><li>For Ubuntu/Debian, <ul><li><strong>Install service</strong>: run <code>sudo apt install openssh-server</code></li><li><strong>Start service</strong>: run <code>sudo systemctl start ssh</code></li><li><strong>Schedule service</strong> (to start on machine start-up): <code>sudo systemctl enable ssh</code></li></ul></li><li>For other operating systems, try using search engines.</li></ul><h2 id="quick-check-setup-a-tunnel-and-ssh-">Quick check: setup a tunnel and SSH üß™<a href="#quick-check-setup-a-tunnel-and-ssh-" title="Direct link to heading">‚Äã</a></h2><ul><li>This step is just a quick check that you can SSH into the machine, before you waste time configuring stuff.</li><li>Start a cloudflare tunnel: run <code>cloudflared tunnel --hostname machine.example.com --url ssh://localhost:22</code><ul><li>Reminder: edit <code>example.com</code> to one you have added on Cloudflare, and update <code>machine</code> to whatever you prefer. <code>cloudflared</code> will create a CNAME record called <code>machine.example.com</code>.</li></ul></li><li>SSH into your machine using password based authentication: run <code>ssh <a href="https://orth.uk/cdn-cgi/l/email-protection" data-cfemail="6d181e081f030c00082d000c0e050403084308150c001d0108430e0200">[email¬†protected]</a></code><ul><li>Reminder: Update username and host.</li></ul></li></ul><h2 id="configure-the-cloudflared-service-">Configure the <code>cloudflared</code> service üßë‚Äçüíª<a href="#configure-the-cloudflared-service-" title="Direct link to heading">‚Äã</a></h2><ul><li>We want this service to be running all the time (<em>daemon</em>), not just when I run the command. Also, some of the steps in <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/run-tunnel/run-as-service" target="_blank" rel="noopener noreferrer">Cloudflare: Run as a service</a> are broken.</li><li>Create a tunnel: <code>cloudflared tunnel create $tunnel_name</code>, where <code>$tunnel_name</code> is a name you can use to reference it.</li><li>Update a DNS record: <code>cloudflared tunnel route dns $tunnel_id phanteks.orth.uk</code></li><li>Create a config file: <code>~/.cloudflare/config.yml</code>, containing:</li></ul><div><div><pre tabindex="0"><code><span><span>tunnel: $tunnel_id</span><br/></span><span><span>credentials-file: /home/$user/.cloudflared/$tunnel_id.json</span><br/></span><span><span>url: ssh://localhost:22</span><br/></span></code></pre></div></div><ul><li>Run the tunnel: `cloudflared tunnel run --url=ssh://localhost:22$  $tunnel_name</li><li>Install service: <code>sudo cloudflared --config /home/ben/.cloudflared/config.yml service install</code></li><li>Start service: run <code>sudo systemctl start cloudflared</code></li><li>Schedule service (to start on machine start-up): <code>sudo systemctl enable cloudflared</code></li></ul><h2 id="configure-ssh-client-">Configure SSH client üíª<a href="#configure-ssh-client-" title="Direct link to heading">‚Äã</a></h2><ul><li>Create a keypair. The private key is for your client and the public key should be given to anyone who wants to authenticate you (the machine you want to SSH to, <em>Phanteks</em>). My keypair is called <code>phanteks</code>(private key) and <code>phanteks.pub</code> (public key): <ul><li>Run <code>ssh-keygen</code>. Before that, preferably <code>cd ~/.ssh</code>, so that your generated keys are stored there.</li></ul></li><li>Copy over the <strong>public</strong> SSH key (<code>$KEYNAME.pub</code>): Run <code>ssh-copy-id -i ~/.ssh/KEYNAME.pub $machine_domain</code></li><li>Add the following to <code>~/.ssh/config</code>. Create the file if it doesn&#39;t exist.</li></ul><div><div><pre tabindex="0"><code><span><span></span><br/></span><span><span>Host phanteksLocal</span><br/></span><span><span>        HostName Phanteks.local</span><br/></span><span><span>        IdentityFile ~/.ssh/phanteks</span><br/></span><span><span>        User ben</span><br/></span><span><span>        Port </span><span>22</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span></span><br/></span><span><span>Host phanteks</span><br/></span><span><span>        HostName phanteks.orth.uk</span><br/></span><span><span>        IdentityFile ~/.ssh/phanteks</span><br/></span><span><span>        ProxyCommand cloudflared access </span><span>ssh</span><span> --hostname %h</span><br/></span><span><span>        User ben</span><br/></span></code></pre></div></div><h2 id="secure-ssh-server-">Secure SSH server üöî<a href="#secure-ssh-server-" title="Direct link to heading">‚Äã</a></h2><ul><li>Optional: Change the port used by SSH, since the default port is well known (22). You&#39;ll also have to update <code>~/.ssh/config</code> and <code>~/.cloudflared/config.yml</code> with this new port</li><li>Optional: Disable password authentication<ul><li>This is usually done to improve security: mitigate random password attacks, but this is already mitigated with Cloudflare Tunnels.</li><li>But in the spirit of &#34;defense in depth&#34;, we should still disable it. We should assume attackers might still come from within your local network, including successfully authenticating with Cloudflare Tunnel</li></ul></li><li>Restart the service: run <code>sudo systemctl restart ssh</code></li></ul><h2 id="usage-connect-to-machine-">Usage: connect to machine ü§û<a href="#usage-connect-to-machine-" title="Direct link to heading">‚Äã</a></h2><ul><li>Run <code>ssh phanteks</code></li></ul><h2 id="conclusion-">Conclusion üíå<a href="#conclusion-" title="Direct link to heading">‚Äã</a></h2><ul><li>Maybe there is a way to automate this so all machines I use in the future will be set up automatically. Thankfully, I am not building a server farm in home or moving homes very often, so this is a very low priority. I was just taking a quick look at Ansible yesterday.</li><li><strong>Question:</strong> do you use a different tool which require no maintenance or cost to run?</li></ul></div></div>
  </body>
</html>
