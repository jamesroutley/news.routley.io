<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://declassed.art/en/blog/2022/06/19/running-systemd-without-systemd-syslogd">Original</a>
    <h1>Running systemd without systemd-journald</h1>
    
    <div id="readability-page-1" class="page"><div> <article>  <p>June 19, 2022</p> <p><span>TLDR</span> </p><pre>patch /etc/systemd/journald.conf &lt;&lt; EOF
@@ -12,7 +12,7 @@
    # See journald.conf(5) for details.

    [Journal]
-#Storage=auto
+Storage=none
    #Compress=yes
    #Seal=yes
    #SplitMode=uid
EOF
systemctl restart systemd-journald
rm -rf /var/log/journal/*
</pre><p>But I tried to pull out this weed. I&#39;d better spent wasted time on looking for a distro without systemd. And without sysvinit. I dislike that more than systemd.</p><img src="https://declassed.art/static/blog/2022/06/19/running-systemd-without-systemd-syslogd/my-home-servers-en.jpg" alt="My home servers"/><p>Finally, I got really angry. On all my systems the top memory consumer is <code>systemd-journald</code>. On my Orange/NanoPI home servers with 2GB RAM it&#39;s not a big deal. However, it depends. Given the number of LXC containers, it really is. Things get much worse on a VPS with 512Mb RAM, where 98Mb is consumed by that shit.</p><p>Even if I restart <code>systemd-journald</code>, in few seconds it becomes among top 3 memory consumers.</p><p>I asked myself: when I needed systemd binary logs? - and I realized I never needed them. I&#39;m happy with old good text-based logs and I always install rsyslog if it is not present in the base system.</p><p>I quickly searched for an existing solution how to delete <code>systemd-journald</code> but the freshest relevant one was dated 2015 and people were unsuccessful in their attempts.</p><p>Someone said <code>systemctl</code> wouldn&#39;t print nicely looking statuses, but I even don&#39;t remember when I needed it to check status of services. Manually, I mean. Instead, I use <code>ps aux</code>, I look into <span><span>/var/log/syslog</span></span>, but I hardly can remember I ever ran <code>systemctl status</code> to admire its output.</p><p>The best solution would be changing linux distro, but that&#39;s not easy. I&#39;m quite conservative. Debian and Armbian is my choice for now and I&#39;m not ready to change it. Although Debian is getting lousy, I dislike other distros much more. Nevertheless, I keep looking for replacement. But right now, instead of devoting my time to painting, I have to urgently dive in shit.</p><p>Basically, I&#39;m not against systemd. I find its units quite convenient and the babysitter approach imho is much better than the mess with PID files. But if I need to fix something, it&#39;s much more difficult with systemd than with sysvinit.</p><p>By the way, why did they buried upstart? I was quite happy with it in old good times when Ubuntu was sane.</p><p>Back to journald, I tried to play in a LXC container first. Actually I played with a couple of my containers. Started from absolutely unnecessary one, where I simply deleted <span><span>/lib/systemd/systemd-journald</span></span> executable (this did not render the container inoperational, though), I finished in another, slightly more important container. All the notes below are based on more sane approach, without touching base system files.</p><p>Here&#39;s what I did in the first place:</p><pre>systemctl stop systemd-journald
</pre><p>It printed:</p><pre>Warning: Stopping systemd-journald.service, but it can still be activated by:
systemd-journald-dev-log.socket
systemd-journald.socket
systemd-journald-audit.socket
</pre><p>Good to know. I&#39;ll use this knowledge later on.</p><p>But now, is the system still operational? Yes, it is.</p><p>What&#39;s next? Let&#39;s try to disable it completely:</p><pre>systemctl mask systemd-journald
Created symlink /etc/systemd/system/systemd-journald.service → /dev/null.

shutdown -r now
</pre><p>My container got restarted without problems, but it took more time than usual.</p><p>Checking output from <code>ps aux</code>, I see no <code>systemd-journald</code> However, nothing goes to <span><span>/var/log/syslog</span></span> That&#39;s because of missing <span><span>/dev/log</span></span> which is needed by rsyslog.</p><p>To fix this, let&#39;s review units printed by <code>systemctl stop systemd-journald</code>. The only of them, namely <span><span>/lib/systemd/system/systemd-journald-dev-log.socket</span></span>, has interesting stuff.</p><p>Normally, if we can say so about systemd, the listening socket is located at <span><span>/run/systemd/journal/dev-log</span></span> and <span><span>/dev/log</span></span> is a symlink to it.</p><p>We don&#39;t need that, so:</p><pre>systemctl mask systemd-journald-dev-log.socket
Created symlink /etc/systemd/system/systemd-journald-dev-log.socket → /dev/null.
</pre><p>Rsyslog depends on syslog.socket unit that creates <span><span>/run/systemd/journal/syslog</span></span> socket. The reliable method to fix that is to copy <span><span>/lib/systemd/system/syslog.socket</span></span> to <span><span>/etc/systemd/system/</span></span> and change socket path (ListenDatagram option) to <span><span>/dev/log</span></span>.</p><p>Rebooted.</p><p>It works. Not like a charm, though. Remaining systemd components complain about missing journal socket. I don&#39;t think it&#39;s worth to play with my production VPS same way.</p><p>I don&#39;t want to try this on a KVM container.</p><p>I give up. Enough swimming in shit, I&#39;m awaited by more interesting things.</p><p>But for LXC this seems to work. However I wouldn&#39;t use this approach in production.</p> </article> </div></div>
  </body>
</html>
