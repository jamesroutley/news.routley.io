<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jvns.ca/blog/2023/07/10/lima--a-nice-way-to-run-linux-vms-on-mac/">Original</a>
    <h1>Lima: a nice way to run Linux VMs on Mac</h1>
    
    

<p>Hello! Here&rsquo;s a new entry in the &ldquo;cool software julia likes&rdquo; section.</p>

<p>A little while ago I started using a Mac, and one of my biggest
frustrations with it is that often I need to run Linux-specific software. For
example, the <a href="https://jvns.ca/blog/2021/09/24/new-tool--an-nginx-playground/">nginx playground</a> I
posted about the other day only works on Linux because it uses Linux namespaces (via <code>bubblewrap</code>)
to sandbox nginx. And I&rsquo;m working on another playground right now that uses bubblewrap too.</p>

<p>This post is very short, it&rsquo;s just to say that Lima seems nice and much simpler
to get started with than Vagrant.</p>

<h3 id="enter-lima">enter Lima!</h3>

<p>I was complaining about this to a friend, and they mentioned
<a href="https://lima-vm.io/">Lima</a>, which stands for <strong>Li</strong>nux on <strong>Ma</strong>c. I&rsquo;d heard
of <a href="https://github.com/abiosoft/colima">colima</a> (another way to run Linux
containers on Mac), but I hadn&rsquo;t realized that Lima also just lets you run VMs.</p>

<p>It was surprisingly simple to set up. I just had to:</p>

<ol>
<li>Install Lima (I did <code>nix-env -iA nixpkgs.lima</code> but you can also install it with <code>brew install lima</code>)</li>
<li>Run <code>limactl start default</code> to start the VM</li>
<li>Run <code>lima</code> to get a shell</li>
</ol>

<p>That&rsquo;s it! By default it mounts your home directory as read-only inside the VM</p>

<p>There&rsquo;s a config file in <code>~/.lima/default/lima.yaml</code>, but I haven&rsquo;t needed to change it yet.</p>

<h3 id="some-nice-things-about-lima">some nice things about Lima</h3>

<p>Some things I appreciate about Lima (as opposed to Vagrant which I&rsquo;ve used in the past and found kind of frustrating) are:</p>

<ol>
<li>it provides a default config</li>
<li>it automatically downloads a Ubuntu 22.04 image to use in the VM (which is what I would have probably picked anyway)</li>
<li>it mounts my entire home directory inside the VM, which I really like as a default choice (it feels very seamless)</li>
</ol>

<p>I think the paradigm of &ldquo;I have a single chaotic global Linux VM which I use
for all my projects&rdquo; might work better for me than super carefully configured
per-project VMs. Though I&rsquo;m sure that you can have carefully configured
per-project VMs with Lima too if you want, I&rsquo;m just only using the <code>default</code> VM.</p>

<h3 id="problem-1-i-don-t-know-how-to-mount-directories-read-write">problem 1: I don&rsquo;t know how to mount directories read-write</h3>

<p>I wanted to have my entire home directory mounted read-only, but have some
subdirectories (like <code>~/work/nginx-playground</code>) mounted read-write. I did some
research and here&rsquo;s what I found:</p>

<ul>
<li>a comment on <a href="https://github.com/lima-vm/lima/issues/873">this github issue</a> says that you can use <a href="https://github.com/lima-vm/lima/blob/master/docs/vmtype.md#vz">mountType: &ldquo;virtiofs&rdquo; and vmType: &ldquo;vz&rdquo;</a> to mount subdirectories of your home directory read-write</li>
<li>the Lima version packaged in nix 23.05 doesn&rsquo;t seem to support <code>vmType: vz</code> (though I could be wrong about this)</li>
</ul>

<p>Maybe I&rsquo;ll figure out how to mount directories read-write later, I&rsquo;m not too
bothered by working around it for now.</p>

<h3 id="problem-2-networking">problem 2: networking</h3>

<p>I&rsquo;m trying to set up some weird networking stuff (<a href="https://jvns.ca/blog/2022/09/06/send-network-packets-python-tun-tap/">this tun/tap setup</a>)
in Lima and while it appeared to work at first, actually the <code>tun</code> network
device seems to be unreliable in a weird way for reasons I don&rsquo;t understand.</p>

<p>Another weird Lima networking thing: here&rsquo;s what gets printed out when I ping a machine:</p>

<pre><code>$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
ping: Warning: time of day goes back (-7148662230695168869us), taking countermeasures
ping: Warning: time of day goes back (-7148662230695168680us), taking countermeasures
64 bytes from 8.8.8.8: icmp_seq=0 ttl=255 time=0.000 ms
wrong data byte #16 should be 0x10 but was 0x0
#16	0 6 0 1 6c 55 ad 64 0 0 0 0 72 95 9 0 0 0 0 0 10 11 12 13 14 15 16 17 18 19 1a 1b
#48	1c 1d 1e 1f 20 21 22 23
ping: Warning: time of day goes back (-6518721232815721329us), taking countermeasures
64 bytes from 8.8.8.8: icmp_seq=0 ttl=255 time=0.000 ms (DUP!)
wrong data byte #16 should be 0x10 but was 0x0
#16	0 6 0 2 6d 55 ad 64 0 0 0 0 2f 9d 9 0 0 0 0 0 10 11 12 13 14 15 16 17 18 19 1a 1b
#48	1c 1d 1e 1f 20 21 22 23
ping: Warning: time of day goes back (-4844789546316441458us), taking countermeasures
64 bytes from 8.8.8.8: icmp_seq=0 ttl=255 time=0.000 ms (DUP!)
wrong data byte #16 should be 0x10 but was 0x0
#16	0 6 0 3 6e 55 ad 64 0 0 0 0 69 b3 9 0 0 0 0 0 10 11 12 13 14 15 16 17 18 19 1a 1b
#48	1c 1d 1e 1f 20 21 22 23
ping: Warning: time of day goes back (-3834857329877608539us), taking countermeasures
64 bytes from 8.8.8.8: icmp_seq=0 ttl=255 time=0.000 ms (DUP!)
wrong data byte #16 should be 0x10 but was 0x0
#16	0 6 0 4 6f 55 ad 64 0 0 0 0 6c c0 9 0 0 0 0 0 10 11 12 13 14 15 16 17 18 19 1a 1b
#48	1c 1d 1e 1f 20 21 22 23
ping: Warning: time of day goes back (-2395394298978302982us), taking countermeasures
64 bytes from 8.8.8.8: icmp_seq=0 ttl=255 time=0.000 ms (DUP!)
wrong data byte #16 should be 0x10 but was 0x0
#16	0 6 0 5 70 55 ad 64 0 0 0 0 65 d3 9 0 0 0 0 0 10 11 12 13 14 15 16 17 18 19 1a 1b
#48	1c 1d 1e 1f 20 21 22 23
</code></pre>

<p>This seems to be a <a href="https://github.com/lima-vm/lima/issues/193">known issue with ICMP</a>.</p>

<h3 id="why-not-use-containers">why not use containers?</h3>

<p>I wanted a VM and not a Linux container because:</p>

<ol>
<li>the playground runs on a VM in production, not in a container, and generally
it&rsquo;s easier to develop in a similar environment to production</li>
<li>all of my playgrounds use Linux namespaces, and I don&rsquo;t know how to create a
namespace inside a container. Probably you can but I don&rsquo;t feel like
figuring it out and it seems like an unnecessary distraction.</li>
<li>on Mac you need to run containers inside a Linux VM anyway, so I&rsquo;d rather
use a VM directly and not introduce another unnecessary layer</li>
</ol>

<h3 id="orbstack-seems-nice-too">OrbStack seems nice too</h3>

<p>After I wrote this, a bunch of people commented to say that
<a href="https://orbstack.dev/">OrbStack</a> is great. I was struggling with the
networking in Lima (like I mentioned above) so I tried out OrbStack and the network does seem to be better.</p>

<p><code>ping</code> acts normally, unlike in Lima:</p>

<pre><code>$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=113 time=19.8 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=113 time=15.9 ms
64 bytes from 8.8.8.8: icmp_seq=3 ttl=113 time=23.1 ms
64 bytes from 8.8.8.8: icmp_seq=4 ttl=113 time=22.7 ms
</code></pre>

<p>The setup steps for OrbStack are:</p>

<ol>
<li>Download OrbStack from the website</li>
<li>In the GUI, create a VM</li>
<li>Run <code>orb</code></li>
<li>That&rsquo;s it</li>
</ol>

<p>So it seems equally simple to set up.</p>

<h3 id="that-s-all">that&rsquo;s all!</h3>

<p>Some other notes:</p>

<ul>
<li>It looks like Lima works on Linux too</li>
<li>a bunch of people on Mastodon also said <a href="https://github.com/abiosoft/colima">colima</a> (built on top of Lima) is a nice Docker alternative on Mac for running Linux containers</li>
</ul>

  </body>
</html>
