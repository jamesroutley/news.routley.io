<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.bitecode.dev/p/whats-up-python-django-background">Original</a>
    <h1>What&#39;s up Python? Django get background tasks, a new REPL, bye bye gunicorn</h1>
    
    <div id="readability-page-1" class="page"><div><div dir="auto"><ul><li><p><em>Built-in background tasks incoming from Django. Finally.</em></p></li><li><p><em>A wild REPL appears that doesn&#39;t require to install anything in a venv.</em></p></li><li><p><em>Uvicorn gets multiprocessing support, ditching gunicorn.</em></p></li><li><p><em>Pypi is blocking outlook.com emails. Sorry.</em></p></li></ul><p><span>Django has been in the process of modernizing during the last few years. </span><a href="https://docs.djangoproject.com/en/5.0/topics/async/" rel="">It&#39;s moving more and more parts of the framework to be compatible with asyncio</a><span>, </span><a href="https://gcollazo.com/optimal-sqlite-settings-for-django/" rel="">it&#39;s adding hooks to use modern SQLite features</a><span>, and now we got DEP (Django Enhancement Proposal, the PEP equivalent for this project) 14 </span><a href="https://github.com/django/deps/blob/main/accepted/0014-background-workers.rst" rel="">proposing to include built-in background tasks</a><span>.</span></p><p>And it&#39;s about time.</p><p>Django is typically used in multiprocessing settings, which in Python means it&#39;s hard to delegate background tasks to a pool without saturating userspace with even more processes. So at best, you could use threads, which is not ideal in the language. That&#39;s an annoying limitation of the platform, which means any serious project will eventually setup a task queue. To send emails, to batch process, to make HTTP requests to API, etc.</p><p><span>Hence the popularity of </span><a href="https://docs.celeryq.dev/en/stable/getting-started/introduction.html" rel="">celery</a><span>, </span><a href="https://dramatiq.io/" rel="">dramatiq</a><span>, </span><a href="https://python-rq.org/" rel="">rq</a><span>, </span><a href="https://huey.readthedocs.io/en/latest/" rel="">huey</a><span>, etc. I use the latter.</span></p><p>But you still have to make sure you don&#39;t lock your DB by mistake, be careful to not pass full ORM objects in params, figure out integration and how to get back task results and errors, setup task progress by yourself, make hard choices on transcience, decide if you need priority and named queues, etc.</p><p>If Django has been good at one thing in the past, it&#39;s to provide sane default for hard topics like CSRF protection, auth or database connections. So I love that they go in that direction for task queues.</p><p><span>As usual, they don&#39;t start from scratch but will integrate an existing external project that served as a proof of concept. In this case, </span><a href="https://github.com/RealOrangeOne/django-tasks" rel="">django-tasks</a><span>, which supports multiple queues, multiple backends, task priority, result storage, and immediate mode for testing. Unfortunately it also only ships a DB backend for prod at the moment, which means either you deploy a full DBMS, or you are limited to SQLite and a single worker. Given </span><a href="https://docs.djangoproject.com/en/5.0/topics/cache/#redis" rel="">redis now has official support in Django</a><span>, this will probably change. Also, if WAL and a few tweaks gets added to default SQLite, it could be used with more workers. Given the proposal initially </span><a href="https://github.com/wagtail/rfcs/pull/72" rel="">came from the wagtail community</a><span>, a bunch of really active and pragmatic devs, I&#39;m following the story with high interest.</span></p><p>So what does it look like?</p><p>You write a few settings in the typical Django fashion:</p><pre><code><code>TASKS = {
    &#34;test&#34;: {
        &#34;BACKEND&#34;: &#34;django.tasks.backends.ImmediateBackend&#34;,
        &#34;QUEUES&#34;: []
        &#34;OPTIONS&#34;: {}
    },
    &#34;default&#34;: {
        &#34;BACKEND&#34;: &#34;django.tasks.DatabaseBackend&#34;,
        &#34;QUEUES&#34;: []
        &#34;OPTIONS&#34;: {}
    }
}</code></code></pre><p>You define your task (probably in tasks.py in your app):</p><pre><code><code>from django.tasks import task


@task()
def do_something_slow(param1, param2) -&gt; int:
    ...</code></code></pre><p>And you send that to the queue from your view (Django’s name for an endpoint):</p><pre><code><code># Send the task to the default backend
result = do_a_task.enqueue(&#34;value1&#34;, param2=&#34;value2&#34;)
# Send with a specific priority or backend
result = do_a_task.using(priority=10, backend=&#34;test&#34;).enqueue()</code></code></pre><p><span>I do expect plenty of issues in the first version, though. The initial PoC is simplistic and queues are full of dragons. It doesn&#39;t have a way to cron task, and </span><a href="https://github.com/RealOrangeOne/django-tasks/discussions/8" rel="">the debate to have it on v1 is still ongoing</a><span>. I see no high-level API to fetch a task result once you lose reference to that result object, a glaring omission you can feel pain from in some other tools. How it&#39;s going to let you debug a crashed task is still not resolved. Also, no mention of transcience, retry, ACK, and all those nasty little buggers that are difficult to nail, and super context-specific.</span></p><p>Baby steps, I say.</p><p>And yes, I know, we wouldn&#39;t have this problem in Go, Erlang, Rust, Java, C#, you name it.</p><p><span>But we do. And so does Ruby, PHP and JS. </span><a href="https://laravel.com/docs/11.x/queues#connections-vs-queues" rel="">Laravel</a><span> has a solution to the problem, it&#39;s a good thing we follow. The Python ecosystem gains a lot by adopting goodies from other languages. I&#39;m still hoping we steal object deconstructing from JS.</span></p><p>Of course, I invite you to be part of the testing and the discussion, that&#39;s how it will become good. And thanks to the devs that will support this heavy project.</p><p><span>Recently I posted about about </span><a href="https://github.com/jupyterlab/jupyterlab-desktop" rel="">jupyterlab-desktop</a><span>, a stand-alone version of the excellent jupyter that solves several problems of the original tool:</span></p><ul><li><p>It doesn&#39;t need you to create a venv to be installed.</p></li><li><p>It lets you manage several venvs after the fact.</p></li><li><p>It hides the logic of running a server from you and just works.</p></li><li><p>It starts with a click on an icon and not a terminal command.</p></li></ul><p>It&#39;s a big improvement to the ergonomics of a tool that many beginners use.</p><p>But it still have a one major flaw: you need to install jupyterlab in each venv you use it with. It&#39;s a big problem because jupyter has a lot of dependencies. It pulls 645 packages! And none of that is something you want in prod, but the delta with your dev machine and your server becomes huge.</p><p><span>Today the VSCode teams announced </span><a href="https://devblogs.microsoft.com/python/python-in-visual-studio-code-june-2024-release/" rel="">a new Python REPL</a><span> that you can activate by putting </span><code>&#34;python.REPL.sendToNativeREPL&#34;: true</code><span> into your settings.json.</span></p><p>For now, it&#39;s a MVP, so it&#39;s not the easiest thing to start, you have to select a Python line and type Shift+Enter.</p><p>But it already provides:</p><ul><li><p>Venv integration.</p></li><li><p>Multi line edition.</p></li><li><p>Code coloration, completion and snippets.</p></li><li><p>Many intellisense features.</p></li></ul><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0737c18-e9c3-4450-94ca-962f93bff6dd_1387x932.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0737c18-e9c3-4450-94ca-962f93bff6dd_1387x932.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0737c18-e9c3-4450-94ca-962f93bff6dd_1387x932.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0737c18-e9c3-4450-94ca-962f93bff6dd_1387x932.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0737c18-e9c3-4450-94ca-962f93bff6dd_1387x932.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0737c18-e9c3-4450-94ca-962f93bff6dd_1387x932.png" width="1387" height="932" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/d0737c18-e9c3-4450-94ca-962f93bff6dd_1387x932.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:932,&#34;width&#34;:1387,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:44838,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0737c18-e9c3-4450-94ca-962f93bff6dd_1387x932.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0737c18-e9c3-4450-94ca-962f93bff6dd_1387x932.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0737c18-e9c3-4450-94ca-962f93bff6dd_1387x932.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0737c18-e9c3-4450-94ca-962f93bff6dd_1387x932.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>It’s way lighter than a full notebook, which for a lot of my code exploration, is a plus.</figcaption></figure></div><p>And above all: it installs NOTHING in your venv to work.</p><p>It&#39;s not a full jupyterlab substitute. Rather an ipython-qtconsole on steroid. But that&#39;s how a lot people use jupyter. You&#39;ll need a few things to make it really practical, like a button to open it, inline plot display, some shortcut to get a cell content back into the prompt... Still, it&#39;s already quite nice.</p><p><span>To run WSGI frameworks like Django and Flask, we often use </span><a href="https://gunicorn.org/" rel="">gunicorn</a><span>, a server that stands between your code and whatever big name like Nginx or Apache you choose. Because WSGI is synchronous, it spawns multiple processes to handle HTTP requests in parallel.</span></p><p><span>The equivalent of the asynchronous world, used by FastAPI and the likes, is </span><a href="https://www.uvicorn.org/" rel="">uvicorn</a><span>, which runs in a single process, using asyncio to handle parallelism.</span></p><p>If you wanted both, you have to use gunicorn to manage uvicorn, which loads your code, the whole thing being served by your reverse proxy. That&#39;s a lot of intermediaries.</p><p>And that&#39;s for prod, for dev, projects may have a separate server.</p><p><span>With version 0.30, </span><a href="https://fastapiexpert.com/blog/2024/05/28/uvicorn-0300-release/" rel="">uvicorn brings a manager supporting multiple processes</a><span>, meaning they can ditch gunicorn as a dep. I think the whole community will likely slowly, but surely, move to uvicorn for everything. Well, many not Django, since they hate external deps.</span></p><p><span>Indeed uvicorn can now spawn multiple processes, each of them handling async requests (including websockets and HTTPS), and auto-reload on file change. All that can be pretty fast, since you can </span><code>pip install uvloop</code><span> to make it use node JS event loop implementation to get a speed boost.</span></p><p>Hell, give it TLS certificate generation and it could even play the game of caddy and own the whole stack one day.</p><p>My favorite part of the release note:</p><blockquote><p>Nothing needs to be done from the users side, the changes are already in place when using the --workers parameter.</p></blockquote><p><span>I&#39;m just going to </span><a href="https://blog.pypi.org/posts/2024-06-16-prohibiting-msn-emails/" rel="">quote</a><span>, Ee Durbin the PyPI Director of Infrastructure, since I won’t say it any better:</span></p><blockquote><p>In response to ongoing mass bot account registrations, Outlook domains outlook.com and hotmail.com have been prohibited from new associations with PyPI accounts. This includes new registrations as well as adding as additional addresses. [...] In a campaign today which included over 160 projects and associated new user registrations, the accounts were registered using outlook.com and hotmail.com email addresses. Past campaigns of similar scale have had similar characteristics. This indicates to us that the Outlook email services are falling short of other major email providers in prevention of automated, bot, and bulk signups for new accounts.</p></blockquote><p>It&#39;s easy to forget that Pypi is constantly under attack and requires tremendous maintenance effort at a great cost. I make it one of my missions to regularly remind people to not take all those wonderful gifts for granted. We are living on the shoulders of FOSS generous giants.</p><p>That won&#39;t make it easier to swallow for the legitimate people with outlook.com emails, though. I know the struggle, I have a &#34;.email&#34; tld on my personal address and get rejected by services sometimes.</p><p>I trust they will revert it as soon as it&#39;s practical for them:</p><blockquote><p>We hope that this change does not need to be permanent, given our current capacity for response and tooling it is the next step that we currently have.</p></blockquote></div></div></div>
  </body>
</html>
