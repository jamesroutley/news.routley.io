<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/tenderlove/initial-v">Original</a>
    <h1>Initial V: A BMW shifter converted to a Bluetooth keyboard for use with Vim</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://github.com/tenderlove/initial-v/blob/main/images/logo.png"><img src="https://github.com/tenderlove/initial-v/raw/main/images/logo.png"/></a>
</p>

<p dir="auto">Initial V is a BMW shifter that has been converted to a Bluetooth keyboard.
In this repository, you&#39;ll find <a href="https://github.com/tenderlove/initial-v/blob/main/pcb">schematics and PCB designs</a>, <a href="https://github.com/tenderlove/initial-v/blob/main/housing">stl files</a>,
<a href="https://github.com/tenderlove/initial-v/blob/main/vim-plugin">a Vim plugin</a>, and <a href="https://github.com/tenderlove/initial-v/blob/main/client">client software</a> for turning a BMW
shifter in to a Bluetooth keyboard that can control Vim.</p>
<p dir="auto">Think of this project as a very over-engineered <a href="https://github.com/alevchuk/vim-clutch">Vim clutch</a>.</p>
<p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://github.com/tenderlove/initial-v/blob/main/images/P3010002.jpeg"><img alt="Handle Front View" src="https://github.com/tenderlove/initial-v/raw/main/images/P3010002.jpeg" width="200"/></a> <a target="_blank" rel="noopener noreferrer" href="https://github.com/tenderlove/initial-v/blob/main/images/P3010003.jpeg"><img alt="Handle Side View" src="https://github.com/tenderlove/initial-v/raw/main/images/P3010003.jpeg" width="200"/></a>
</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-what-does-it-do" aria-hidden="true" href="#what-does-it-do"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>What does it do?</h2>
<p dir="auto">Initial V is a Bluetooth Keyboard specialized for controlling Vim.
The key presses sent depend on Vim&#39;s state.
The table below describes the key presses for each handle position according to the state of the editor:</p>
<table>
<thead>
<tr>
<th></th>
<th>Park</th>
<th>Up</th>
<th>Down</th>
<th>Double Up</th>
<th>Double Down</th>
<th>Move Left</th>
<th>Left Up</th>
<th>Left Down</th>
<th>Move Right (back to center)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Normal Mode (Drive)</td>
<td><code>:w</code> on a modified buffer, <code>:wq</code> on unmodified buffer</td>
<td>Up key</td>
<td>Down key</td>
<td><code>i</code></td>
<td><code>o</code></td>
<td><code>CTRL-V</code></td>
<td>Up Key</td>
<td>Down key</td>
<td><code>ESC</code></td>
</tr>
<tr>
<td>Insert Mode (Neutral)</td>
<td><code>ESC</code></td>
<td>Up key</td>
<td>Down key</td>
<td>Page Up</td>
<td>Page Down</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p dir="auto">&#34;Drive&#34; on the handle means &#34;Normal Mode&#34; in Vim.  &#34;Neutral&#34; on the handle means &#34;Insert Mode&#34; in Vim.
It&#39;s not possible to move the handle to the left when the handle is in Neutral mode, so there are no key combinations.
I&#39;m not sure what mode in Vim would map to Reverse on the handle, so there&#39;s no way to transition to Reverse at the moment.</p>
<p dir="auto">Saving a buffer in Normal mode will put the handle in to the &#34;Park&#34; position.
The Park position behaves the same way as Drive (Normal mode in Vim) except that if you hit Park again, it will exit Vim.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-hardware-design" aria-hidden="true" href="#hardware-design"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Hardware Design</h2>
<p dir="auto">The BMW handle communicates via <a href="https://en.wikipedia.org/wiki/CAN_bus" rel="nofollow">CAN bus</a>.
The PCB uses an ESP-MINI-1 chip with Bluetooth capabilities, and an <a href="https://www.digikey.com/en/products/detail/texas-instruments/sn65hvd230d/1574496" rel="nofollow">SN65HVD230D</a> for CAN bus communication.
The handle runs on 12v, so I used a <a href="https://www.digikey.com/en/products/detail/monolithic-power-systems-inc/MPM3610GQV-Z/5292909" rel="nofollow">MPM3610GQV buck converter</a> to step the voltage down to 3.3v for the ESP.</p>
<p dir="auto">I must give a huge thanks to <a href="https://aus.social/@projectgus" rel="nofollow">@projectgus</a> for <a href="https://www.projectgus.com/2022/06/bmw-f-series-gear-selector-part-one-failures/" rel="nofollow">decoding the CAN bus data</a>.
This project would not be possible without their hard work.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-software-design" aria-hidden="true" href="#software-design"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Software Design</h2>
<p dir="auto">The handle appears as a Bluetooth keyboard to the operating system, but it in order to change the handle state we require a way to communicate data back to the handle.
I used HID data APIs to send bytes back to the handle, requesting the handle to change state.
There is a client written in Zig <a href="https://github.com/tenderlove/initial-v/blob/main/client">here</a>, and also a Ruby client <a href="https://github.com/tenderlove/initial-v/blob/main/firmware/ctrl.rb">here</a>.
Finally, I wrote a <a href="https://github.com/tenderlove/initial-v/blob/main/vim-plugin">Vim plugin</a> that sends commands to the handle whenever Vim changes modes.
This means that the handle will maintain state along with Vim&#39;s state even if the user changes state via keyboard (like hitting <code>i</code> on their keyboard, etc).</p>
<p dir="auto">The general flow is (from Normal mode):</p>
<ol dir="auto">
<li>Double shift the handle up to send <code>i</code></li>
<li>Vim goes in to insert mode which triggers the Inivial V Vim plugin</li>
<li>The Vim plugin requests the handle change state</li>
<li>The handle changes state</li>
</ol>
<h2 tabindex="-1" dir="auto"><a id="user-content-end" aria-hidden="true" href="#end"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>End</h2>
<p dir="auto">I had a ton of fun building this project.  I will update each directory with a README for more detailed build instructions.  I&#39;m also going to make a promotional video as well, but I felt I needed to fill out the README since the project is public at this point anyway!!</p>
</article>
          </div></div>
  </body>
</html>
