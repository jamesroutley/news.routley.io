<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://alexanderameye.github.io/notes/stylized-water-shader/">Original</a>
    <h1>Stylized Water Shader</h1>
    
    <div id="readability-page-1" class="page"><div>
    <div>
        
        <p><b>31</b> minute read</p>
        <h2 id="introduction" tabindex="-1"><a href="#introduction" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> Introduction</h2>
<p>In this tutorial I will explain step-by-step how to create a beautiful stylized water shader in Unity using Shader Graph. The goal is not to create a physically accurate result, but rather to achieve a <mark>real-time, controllable and good-looking</mark> stylized water shader.</p>
<video poster="reflections.png" preload="auto" width="100%" title="Stylized water shader." loop="" autoplay="" playsinline="" muted="true">
<source src="stylized-water-for-urp.webm" type="video/webm"/>
</video>
<h2 id="1.-initial-set-up" tabindex="-1"><a href="#1.-initial-set-up" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> 1. Initial set up</h2>
<blockquote>
<p>‚ö†Ô∏è This tutorial has been made with <em><strong>Unity 2022.2.6f1</strong></em> and <em><strong>Universal RP 14.0.6</strong></em>.</p>
</blockquote>
<p>Before starting this tutorial, there are a few things that need to be set up.</p>
<h3 id="render-settings" tabindex="-1"><a href="#render-settings" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> Render settings</h3>
<p>Make sure to enable the <strong>depth and opaque textures</strong> in the URP pipeline asset.</p>
<figure><picture><source type="image/webp" srcset="1/renderer-settings.png-400w.webp 400w, 1/renderer-settings.png-800w.webp 800w, 1/renderer-settings.png-956w.webp 956w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="1/renderer-settings.png-400w.jpeg 400w, 1/renderer-settings.png-800w.jpeg 800w, 1/renderer-settings.png-956w.jpeg 956w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="URP renderer settings." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/1/renderer-settings.png-400w.jpeg" width="956" height="320"/></picture><figcaption>URP renderer settings.</figcaption></figure>
<h3 id="shader-and-material" tabindex="-1"><a href="#shader-and-material" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> Shader and material</h3>
<p>Create a new <strong>Unlit</strong> Shader Graph shader. The shader material should be set the <strong>Unlit</strong> and the surface type to <strong>Opaque</strong>.</p>
<figure><picture><source type="image/webp" srcset="1/shader-settings.png-400w.webp 400w, 1/shader-settings.png-600w.webp 600w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="1/shader-settings.png-400w.jpeg 400w, 1/shader-settings.png-600w.jpeg 600w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Shader settings." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/1/shader-settings.png-400w.jpeg" width="600" height="1004"/></picture><figcaption>Shader settings.</figcaption></figure>
<p>You can then create a material that uses this shader.</p>
<figure><picture><source type="image/webp" srcset="1/created-material.png-400w.webp 400w, 1/created-material.png-702w.webp 702w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="1/created-material.png-400w.jpeg 400w, 1/created-material.png-702w.jpeg 702w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Stylized water material." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/1/created-material.png-400w.jpeg" width="702" height="158"/></picture><figcaption>Stylized water material.</figcaption></figure>
<p>Select this material and in the Advanced Options, change the Render Queue to be <strong>Transparent</strong>.</p>
<figure><picture><source type="image/webp" srcset="1/material-settings.png-400w.webp 400w, 1/material-settings.png-800w.webp 800w, 1/material-settings.png-1040w.webp 1040w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="1/material-settings.png-400w.jpeg 400w, 1/material-settings.png-800w.jpeg 800w, 1/material-settings.png-1040w.jpeg 1040w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Material settings." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/1/material-settings.png-400w.jpeg" width="1040" height="220"/></picture><figcaption>Material settings.</figcaption></figure>
<h3 id="scene" tabindex="-1"><a href="#scene" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> Scene</h3>
<p>For the scene, I am using <strong>The Illustrated Nature</strong> by <strong>Artkovski</strong> but you can use any scene you want.</p>

<p>In the scene, I created a plane and assigned it the material that we created before.</p>
<figure><picture><source type="image/webp" srcset="1/start.png-400w.webp 400w, 1/start.png-800w.webp 800w, 1/start.png-1200w.webp 1200w, 1/start.png-1266w.webp 1266w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="1/start.png-400w.jpeg 400w, 1/start.png-800w.jpeg 800w, 1/start.png-1200w.jpeg 1200w, 1/start.png-1266w.jpeg 1266w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Start scene." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/1/start.png-400w.jpeg" width="1266" height="734"/></picture><figcaption>Start scene.</figcaption></figure>
<p>Now let&#39;s get started!</p>
<blockquote>
<p>üí° During this tutorial, newly added nodes will be marked in green so you can easily follow along to create the shader yourself from the ground up.</p>
</blockquote>
<h2 id="2.-figuring-out-the-depth-of-the-water" tabindex="-1"><a href="#2.-figuring-out-the-depth-of-the-water" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> 2. Figuring out the depth of the water</h2>
<p>The single most important step in creating our water shader is <mark>figuring out the depth of the water</mark>. We will use the depth value it to drive many other effects of our water such as color, opacity, refraction and foam.</p>
<h3 id="camera-relative-depth" tabindex="-1"><a href="#camera-relative-depth" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> Camera-relative depth</h3>
<p>Most water shader tutorials use some variation of the following node setup to calculate a depth fade value that goes from shallow (1, white) to deep (0, black).</p>
<figure><picture><source type="image/webp" srcset="2/camera-relative-depth-fade.png-400w.webp 400w, 2/camera-relative-depth-fade.png-800w.webp 800w, 2/camera-relative-depth-fade.png-1200w.webp 1200w, 2/camera-relative-depth-fade.png-2018w.webp 2018w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="2/camera-relative-depth-fade.png-400w.jpeg 400w, 2/camera-relative-depth-fade.png-800w.jpeg 800w, 2/camera-relative-depth-fade.png-1200w.jpeg 1200w, 2/camera-relative-depth-fade.png-2018w.jpeg 2018w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Camera-relative depth fade." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/2/camera-relative-depth-fade.png-400w.jpeg" width="2018" height="532"/></picture><figcaption>Camera-relative depth fade.</figcaption></figure>
<p>In this node setup, the <strong>Scene Depth (Eye)</strong> node returns the distance (in world space units, meters) between the camera and the objects below the water. You can imagine it by tracing an imaginary ray from the camera towards the water that stops when it first hits an object <mark>under the water surface</mark>. The distance of this ray is what is returned by the node.</p>
<figure><picture><source type="image/webp" srcset="2/water-depth.png-400w.webp 400w, 2/water-depth.png-800w.webp 800w, 2/water-depth.png-1200w.webp 1200w, 2/water-depth.png-1318w.webp 1318w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="2/water-depth.png-400w.jpeg 400w, 2/water-depth.png-800w.jpeg 800w, 2/water-depth.png-1200w.jpeg 1200w, 2/water-depth.png-1318w.jpeg 1318w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Scene depth and screen position." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/2/water-depth.png-400w.jpeg" width="1318" height="642"/></picture><figcaption>Scene depth - screen position = water depth.</figcaption></figure>
<p>What we actually care about is not the distance between the camera and the objects under the water, but <mark>the distance between the surface of the water and the objects under the water</mark>. For this, we can use the alpha component of the <strong>Screen Position (Raw)</strong> node which gives us the distance between the camera and the water surface. We can then <strong>Subtract</strong> the 2 distances to get the desired distance which represents the <strong>Water Depth</strong>. This is visualized in the diagram above.</p>
<figure><picture><source type="image/webp" srcset="2/subtract-depths.png-400w.webp 400w, 2/subtract-depths.png-800w.webp 800w, 2/subtract-depths.png-1122w.webp 1122w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="2/subtract-depths.png-400w.jpeg 400w, 2/subtract-depths.png-800w.jpeg 800w, 2/subtract-depths.png-1122w.jpeg 1122w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Depth subtraction." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/2/subtract-depths.png-400w.jpeg" width="1122" height="586"/></picture><figcaption>Depth subtraction.</figcaption></figure>
<p>Finally we <strong>Divide</strong> by a depth range/distance control parameter, <strong>Saturate</strong> the output (clamp between 0 and 1) and then perform a <strong>One Minus</strong> operation to get a white value near the shore and a black value in the deep parts of the water.</p>
<figure><picture><source type="image/webp" srcset="2/process-depths.png-400w.webp 400w, 2/process-depths.png-800w.webp 800w, 2/process-depths.png-1200w.webp 1200w, 2/process-depths.png-1552w.webp 1552w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="2/process-depths.png-400w.jpeg 400w, 2/process-depths.png-800w.jpeg 800w, 2/process-depths.png-1200w.jpeg 1200w, 2/process-depths.png-1552w.jpeg 1552w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Depth division." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/2/process-depths.png-400w.jpeg" width="1552" height="388"/></picture><figcaption>Depth division.</figcaption></figure>
<p>It is very important to note that this calculated depth value is <mark>not the vertical depth of the water</mark>. If you were looking at the water and shooting an invisible ray from your eye towards a point of the water, the distance that the ray would travel between hitting the surface of the water and hitting the ground below the water surface is the distance that you get here from these nodes. This means that when looking at the same point on the water surface, <mark>the returned depth value depends on how shallow the angle is under which you are looking at the water surface</mark>.</p>
<p>This effect/artifact can be seen in the video below when moving around the camera. You can especially see it on the rocks where the same spots on the water get either a black or a white color based on on shallow the viewing angle is.</p>
<video poster="reflections.png" preload="auto" width="100%" title="Rendering realtime caustics." loop="" autoplay="" playsinline="" muted="true">
<source src="2/camera-relative-depth.mp4" type="video/mp4"/>
</video>
<h3 id="world-space-depth" tabindex="-1"><a href="#world-space-depth" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> World-space depth</h3>
<p>Personally I am not a fan of how the depth effect looks using the previous method. The perceived depth values change when moving around your camera and I would rather have a constant depth value that is independent of camera position.</p>
<blockquote>
<p>üí° This is just a personal preference and you can keep using the camera-relative depth calculation if you like.</p>
</blockquote>
<p>To &#39;fix&#39; this camera-relative depth, I have figured out an alternative way to calculate the depth which happens in world space.</p>
<figure><picture><source type="image/webp" srcset="2/world-space-depth-fade.png-400w.webp 400w, 2/world-space-depth-fade.png-800w.webp 800w, 2/world-space-depth-fade.png-1200w.webp 1200w, 2/world-space-depth-fade.png-1998w.webp 1998w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="2/world-space-depth-fade.png-400w.jpeg 400w, 2/world-space-depth-fade.png-800w.jpeg 800w, 2/world-space-depth-fade.png-1200w.jpeg 1200w, 2/world-space-depth-fade.png-1998w.jpeg 1998w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="World-space depth fade." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/2/world-space-depth-fade.png-400w.jpeg" width="1998" height="618"/></picture><figcaption>World-space depth fade.</figcaption></figure>
<p>This node setup gives you the depth of the water as if you would put a measuring tape vertically into the water and measure the distance from the surface of the water to the seabed. When moving the camera around, the calculated depth values do not change in appearance.</p>
<video poster="reflections.png" preload="auto" width="100%" title="Rendering realtime caustics." loop="" autoplay="" playsinline="" muted="true">
<source src="2/world-space-depth.mp4" type="video/mp4"/>
</video>
<h3 id="depth-fade-subgraph" tabindex="-1"><a href="#depth-fade-subgraph" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> Depth Fade subgraph</h3>
<p>It is a good idea to put all of the nodes we just created into a <strong>Depth Fade</strong> subgraph. This will make our main graph more clean and organized.</p>
<figure><picture><source type="image/webp" srcset="2/depth-fade-subgraph.png-400w.webp 400w, 2/depth-fade-subgraph.png-800w.webp 800w, 2/depth-fade-subgraph.png-1200w.webp 1200w, 2/depth-fade-subgraph.png-1278w.webp 1278w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="2/depth-fade-subgraph.png-400w.jpeg 400w, 2/depth-fade-subgraph.png-800w.jpeg 800w, 2/depth-fade-subgraph.png-1200w.jpeg 1200w, 2/depth-fade-subgraph.png-1278w.jpeg 1278w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Depth fade subgraph." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/2/depth-fade-subgraph.png-400w.jpeg" width="1278" height="396"/></picture><figcaption>Depth fade subgraph.</figcaption></figure>
<h2 id="3.-colors-and-opacity" tabindex="-1"><a href="#3.-colors-and-opacity" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> 3. Colors and opacity</h2>
<p>In this section we will add color to our water surface using the depth values we just calculated.</p>
<h3 id="shallow-and-deep" tabindex="-1"><a href="#shallow-and-deep" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> Shallow and deep</h3>
<p>Now that we know the depth of our water, we can use it to drive the colors and transparency of our water. We can simply use the output of our <strong>Depth Fade</strong> subgraph (which is a value between 0 and 1) to <strong>Lerp</strong> between a shallow water color and a deep water color.</p>
<figure><picture><source type="image/webp" srcset="3/shallow-deep-lerp.png-400w.webp 400w, 3/shallow-deep-lerp.png-800w.webp 800w, 3/shallow-deep-lerp.png-1200w.webp 1200w, 3/shallow-deep-lerp.png-1306w.webp 1306w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="3/shallow-deep-lerp.png-400w.jpeg 400w, 3/shallow-deep-lerp.png-800w.jpeg 800w, 3/shallow-deep-lerp.png-1200w.jpeg 1200w, 3/shallow-deep-lerp.png-1306w.jpeg 1306w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Shallow and deep water colors." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/3/shallow-deep-lerp.png-400w.jpeg" width="1306" height="398"/></picture><figcaption>Shallow and deep water colors.</figcaption></figure>
<p>Lerping between a shallow and a deep water color already gives us a nice effect for our water.</p>
<video poster="reflections.png" preload="auto" width="100%" title="Rendering realtime caustics." loop="" autoplay="" playsinline="" muted="true">
<source src="3/shallow-deep-color.mp4" type="video/mp4"/>
</video>
<details>
<summary>Going the extra mile: HSV lerping</summary>
<div>
<p>As explained by Alan Zucconi in <a href="https://www.alanzucconi.com/2016/01/06/colour-interpolation/" target="_blank" rel="noopener noreferrer">this great article about colour interpolation</a>, we can improve the appearance of the color of our water by lerping in HSV space instead of RGB space. To do this in Shader Graph, a custom function node can be used that converts our RGB colors to HSV, lerps in HSV space and then converts them back to RGB.</p>
<pre><code><span>half3</span> <span>RGBToHSV</span><span>(</span><span>half3</span> In<span>)</span></code></pre>
<p>The custom function node then fits in like this with the rest of our nodes.</p>
<figure><picture><source type="image/webp" srcset="3/hsv-lerp.png-400w.webp 400w, 3/hsv-lerp.png-800w.webp 800w, 3/hsv-lerp.png-1200w.webp 1200w, 3/hsv-lerp.png-1888w.webp 1888w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="3/hsv-lerp.png-400w.jpeg 400w, 3/hsv-lerp.png-800w.jpeg 800w, 3/hsv-lerp.png-1200w.jpeg 1200w, 3/hsv-lerp.png-1888w.jpeg 1888w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="HSV color lerping." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/3/hsv-lerp.png-400w.jpeg" width="1888" height="380"/></picture><figcaption>HSV color lerping.</figcaption></figure>
<p>When looking at the water, the intermediate colors between shallow and deep will appear more vibrant.</p>
</div>
</details>
<details>
<summary>Going the extra mile: Posterize</summary>
<div>
<p>A cool and easy effect to add is posterization. We simply add the <strong>Posterize</strong> node and add a property to control the number of steps.</p>
<figure><picture><source type="image/webp" srcset="3/posterize.png-400w.webp 400w, 3/posterize.png-800w.webp 800w, 3/posterize.png-1200w.webp 1200w, 3/posterize.png-1884w.webp 1884w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="3/posterize.png-400w.jpeg 400w, 3/posterize.png-800w.jpeg 800w, 3/posterize.png-1200w.jpeg 1200w, 3/posterize.png-1884w.jpeg 1884w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Color posterization." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/3/posterize.png-400w.jpeg" width="1884" height="676"/></picture><figcaption>Color posterization.</figcaption></figure>
<p>A good example of where such a posterization technique was used is in the game <a href="https://ashorthike.com/" target="_blank" rel="noopener noreferrer">A Short Hike</a>. In the image below you can see the different color bands which are a result of the posterization.</p>
<figure><picture><source type="image/webp" srcset="3/a-short-hike.png-400w.webp 400w, 3/a-short-hike.png-800w.webp 800w, 3/a-short-hike.png-1200w.webp 1200w, 3/a-short-hike.png-2548w.webp 2548w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="3/a-short-hike.png-400w.jpeg 400w, 3/a-short-hike.png-800w.jpeg 800w, 3/a-short-hike.png-1200w.jpeg 1200w, 3/a-short-hike.png-2548w.jpeg 2548w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="A Short Hike water." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/3/a-short-hike.png-400w.jpeg" width="2548" height="1440"/></picture><figcaption>A Short Hike water.</figcaption></figure>
</div>
</details>
<details>
<summary>Bonus tip: Use a gradient</summary>
<div>
<p>If you want even more control over the colors of your water, you can make use of a <mark>gradient texture</mark> to drive the color. In the example below I have a gradient that I turn into a 256x1 texture that I then sample using the [0,1] depth value. The step to convert from a gradient to a texture is needed because Shader Graph does not support gradient properties.</p>
<figure><picture><source type="image/webp" srcset="3/gradient.png-400w.webp 400w, 3/gradient.png-476w.webp 476w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="3/gradient.png-400w.jpeg 400w, 3/gradient.png-476w.jpeg 476w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Gradient coloring." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/3/gradient.png-400w.jpeg" width="476" height="190"/></picture><figcaption>Gradient coloring.</figcaption></figure>
<p>This setup allows you to do both hard and soft transitions of colors.</p>
<p>Below is the code I used to convert from a gradient to a texture.</p>
<pre><code><span>using</span> <span>UnityEngine</span><span>;</span></code></pre>
</div>
</details>
<h3 id="horizon-color" tabindex="-1"><a href="#horizon-color" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> Horizon color</h3>
<p>Next, we will add a color to the parts of the water at the horizon. For this, we will use a <strong>Fresnel Effect</strong> node with a horizon color and horizon distance parameter. We will use the the output of the <strong>Depth Color</strong> from the previous section and lerp between that and the <strong>Horizon Color</strong>.</p>
<figure><picture><source type="image/webp" srcset="3/horizon-color-lerp.png-400w.webp 400w, 3/horizon-color-lerp.png-800w.webp 800w, 3/horizon-color-lerp.png-1200w.webp 1200w, 3/horizon-color-lerp.png-1234w.webp 1234w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="3/horizon-color-lerp.png-400w.jpeg 400w, 3/horizon-color-lerp.png-800w.jpeg 800w, 3/horizon-color-lerp.png-1200w.jpeg 1200w, 3/horizon-color-lerp.png-1234w.jpeg 1234w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Horizon color." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/3/horizon-color-lerp.png-400w.jpeg" width="1234" height="996"/></picture><figcaption>Horizon color.</figcaption></figure>
<p>When you look at the water at a very sharp angle, the horizon color will show up in the distance.</p>
<video poster="reflections.png" preload="auto" width="100%" title="Rendering realtime caustics." loop="" autoplay="" playsinline="" muted="true">
<source src="3/horizon-color.mp4" type="video/mp4"/>
</video>
<h3 id="underwater-color" tabindex="-1"><a href="#underwater-color" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> Underwater color</h3>
<p>Right now we are directly setting the color of the water but because we do this, the colors of the objects beneath the water get kind lost. To fix this, we will take the underwater color into account when shading the surface of the water.</p>
<figure><picture><source type="image/webp" srcset="3/underwater-color.png-400w.webp 400w, 3/underwater-color.png-800w.webp 800w, 3/underwater-color.png-1200w.webp 1200w, 3/underwater-color.png-1604w.webp 1604w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="3/underwater-color.png-400w.jpeg 400w, 3/underwater-color.png-800w.jpeg 800w, 3/underwater-color.png-1200w.jpeg 1200w, 3/underwater-color.png-1604w.jpeg 1604w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Underwater color." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/3/underwater-color.png-400w.jpeg" width="1604" height="680"/></picture><figcaption>Underwater color.</figcaption></figure>
<p>We sample the <strong>Scene Color</strong> node which returns the color of the geometry below the water surface. Then where we set the other colors to be transparent, we will use the underwater color instead. This is done using the <strong>One Minus</strong> node. Finally we add the colors we already had to the underwater color to get the final color.</p>
<p>By changing the alpha components of the shallow and deep water colors, we can control how much the underwater color is added.</p>
<video poster="reflections.png" preload="auto" width="100%" title="Rendering realtime caustics." loop="" autoplay="" playsinline="" muted="true">
<source src="3/underwater-color.mp4" type="video/mp4"/>
</video>
<h2 id="4.-refraction" tabindex="-1"><a href="#4.-refraction" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> 4. Refraction</h2>
<p>Let&#39;s add a cool effect, refraction!</p>
<h3 id="refracted-uvs" tabindex="-1"><a href="#refracted-uvs" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> Refracted UVs</h3>
<p>Many nodes that we have already used like the <strong>Scene Color</strong> and <strong>Scene Depth</strong> nodes have a <strong>UV</strong> input parameter that we left to the default up until now. We will start by adding a UV parameter to the <strong>Depth Fade</strong> subgraph and connect it up to the <strong>Scene Depth</strong> node inside of the subgraph.</p>
<figure><picture><source type="image/webp" srcset="4/scene-depth-uv.png-400w.webp 400w, 4/scene-depth-uv.png-704w.webp 704w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="4/scene-depth-uv.png-400w.jpeg 400w, 4/scene-depth-uv.png-704w.jpeg 704w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Scene depth UVs." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/4/scene-depth-uv.png-400w.jpeg" width="704" height="618"/></picture><figcaption>Scene depth UVs.</figcaption></figure>
<p>Now that we can control the UVs which the <strong>Depth Fade</strong> subgraph uses, we can distort those UVs to add a refraction effect. Let&#39;s use the following node setup to create refracted UVs.</p>
<figure><picture><source type="image/webp" srcset="4/refract-uv.png-400w.webp 400w, 4/refract-uv.png-800w.webp 800w, 4/refract-uv.png-1200w.webp 1200w, 4/refract-uv.png-2030w.webp 2030w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="4/refract-uv.png-400w.jpeg 400w, 4/refract-uv.png-800w.jpeg 800w, 4/refract-uv.png-1200w.jpeg 1200w, 4/refract-uv.png-2030w.jpeg 2030w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Refracted UVs." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/4/refract-uv.png-400w.jpeg" width="2030" height="502"/></picture><figcaption>Refracted UVs</figcaption></figure>
<p>In the node setup above, we tile and move some <strong>Gradient Noise</strong> that we then <strong>Remap</strong> to a [-1,1] range, <strong>Multiply</strong> with a refraction strength parameter and then add to the <strong>Screen Position (default)</strong> (which are the regular, undistorted UVs).</p>
<p>It is a good idea to put these nodes in their own <strong>Refracted UV</strong> subgraph to make the graph clean and organized. We can then use this refracted UVs and connect them to the UV input of the <strong>Depth Fade</strong> subgraph as well as the UV input of the <strong>Scene Color</strong> node that we used for the underwater color.</p>
<p>Now we get a nice refraction effect!</p>
<video poster="reflections.png" preload="auto" width="100%" title="Rendering realtime caustics." loop="" autoplay="" playsinline="" muted="true">
<source src="4/basic-refraction.mp4" type="video/mp4"/>
</video>
<details>
<summary>Going the extra mile: Fixing refraction artifacts</summary>
<div>
<p>As you might have seen in the previous clip, the refraction we have right now is flawed. When an object sticks out of the water you&#39;ll see that the refraction effect is present in places where it should not be.</p>
<figure><picture><source type="image/webp" srcset="4/refraction-artifacts.png-400w.webp 400w, 4/refraction-artifacts.png-800w.webp 800w, 4/refraction-artifacts.png-1200w.webp 1200w, 4/refraction-artifacts.png-1266w.webp 1266w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="4/refraction-artifacts.png-400w.jpeg 400w, 4/refraction-artifacts.png-800w.jpeg 800w, 4/refraction-artifacts.png-1200w.jpeg 1200w, 4/refraction-artifacts.png-1266w.jpeg 1266w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Refraction artifacts." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/4/refraction-artifacts.png-400w.jpeg" width="1266" height="734"/></picture><figcaption>Refraction artifacts.</figcaption></figure>
<p>One way to solve this is to perform a depth check to see if we should use the distorted or the undistorted UVS. The <strong>Scene Position</strong> subgraph is a subgraph I created that contains the nodes to calculate the world space scene position that was shown in the first section about calculating the world space depth.</p>
<figure><picture><source type="image/webp" srcset="4/artifact-fix.png-400w.webp 400w, 4/artifact-fix.png-800w.webp 800w, 4/artifact-fix.png-1200w.webp 1200w, 4/artifact-fix.png-1356w.webp 1356w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="4/artifact-fix.png-400w.jpeg 400w, 4/artifact-fix.png-800w.jpeg 800w, 4/artifact-fix.png-1200w.jpeg 1200w, 4/artifact-fix.png-1356w.jpeg 1356w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Fixing refraction artifacts." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/4/artifact-fix.png-400w.jpeg" width="1356" height="592"/></picture><figcaption>Fixing refraction artifacts.</figcaption></figure>
<p>With this fix implemented, the effect looks much better and only shows up where you can actually see the object inside of the water.</p>
<figure><picture><source type="image/webp" srcset="4/fixed-refraction.png-400w.webp 400w, 4/fixed-refraction.png-800w.webp 800w, 4/fixed-refraction.png-1200w.webp 1200w, 4/fixed-refraction.png-1266w.webp 1266w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="4/fixed-refraction.png-400w.jpeg 400w, 4/fixed-refraction.png-800w.jpeg 800w, 4/fixed-refraction.png-1200w.jpeg 1200w, 4/fixed-refraction.png-1266w.jpeg 1266w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Fixed refraction." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/4/fixed-refraction.png-400w.jpeg" width="1266" height="734"/></picture><figcaption>Fixed refraction.</figcaption></figure>
</div>
</details>
<h2 id="5.-foam" tabindex="-1"><a href="#5.-foam" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> 5. Foam</h2>
<p>The next step is to add foam to the water.</p>
<h3 id="surface-foam" tabindex="-1"><a href="#surface-foam" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> Surface foam</h3>
<p>We will start by adding foam that gets drawn on top of the water surface.</p>
<h4>Panning UVs</h4>
<p>We will add surface foam to the shader step by step. We will start by setting up the UVs that we will use to sample a surface foam texture. Let&#39;s create a subgraph called <strong>Panning UVs</strong> and add the following nodes.</p>
<figure><picture><source type="image/webp" srcset="5/panning-uv.png-400w.webp 400w, 5/panning-uv.png-800w.webp 800w, 5/panning-uv.png-1200w.webp 1200w, 5/panning-uv.png-1960w.webp 1960w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="5/panning-uv.png-400w.jpeg 400w, 5/panning-uv.png-800w.jpeg 800w, 5/panning-uv.png-1200w.jpeg 1200w, 5/panning-uv.png-1960w.jpeg 1960w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Panning UVs." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/5/panning-uv.png-400w.jpeg" width="1960" height="452"/></picture><figcaption>Panning UVs.</figcaption></figure>
<p>This subgraph takes in UVs and then adds movement to them as well as some <strong>Tiling</strong> and an <strong>Offset</strong>.</p>
<video poster="reflections.png" preload="auto" width="100%" title="Rendering realtime caustics." loop="" autoplay="" playsinline="" muted="true">
<source src="5/panning-uvs.mp4" type="video/mp4"/>
</video>
<p>The nodes on the left are used to convert the direction parameter which is a value between 0 and 1 into a direction vector for the UV movement. You could as well have just a vector input parameter and set the direction yourself, but this approach allows you to work with a <mark>single direction slider between 0 and 1 and control the full 360¬∞ range of movement</mark>. For performance reasons, you could leave this out and just directly set the direction.</p>
<h4>Distorted UVs</h4>
<p>Next, we will take the panning UVs and distort them using some sine functions. For this, we will use a <strong>Custom Function</strong> node because it would be a hassle to recreate the math in nodes.</p>
<figure><picture><source type="image/webp" srcset="5/distorted-uv.png-400w.webp 400w, 5/distorted-uv.png-800w.webp 800w, 5/distorted-uv.png-898w.webp 898w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="5/distorted-uv.png-400w.jpeg 400w, 5/distorted-uv.png-800w.jpeg 800w, 5/distorted-uv.png-898w.jpeg 898w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Distorted UVs." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/5/distorted-uv.png-400w.jpeg" width="898" height="464"/></picture><figcaption>Distorted UVs.</figcaption></figure>
<p>We take the output of the <strong>Panning UV</strong> subgraph and plug it into a <strong>Custom Function</strong> node. For the custom function, we use the following code.</p>
<pre><code><span>void</span> <span>DistortUV_float</span><span>(</span><span>float2</span> UV<span>,</span> <span>float</span> Amount<span>,</span> <span>out</span> <span>float2</span> Out<span>)</span></code></pre>
<p>This code adds a distortion to the UVs using sine functions to make the foam a bit more interesting when moving around. It looks like this.</p>
<video poster="reflections.png" preload="auto" width="100%" title="Rendering realtime caustics." loop="" autoplay="" playsinline="" muted="true">
<source src="5/distorted-uvs.mp4" type="video/mp4"/>
</video>
<h4>Sampling the foam texture</h4>
<p>Now that we have moving and distorted UVs, we can use them to sample a foam texture and add it to the surface of our water.</p>
<figure><picture><source type="image/webp" srcset="5/sample-foam-texture.png-400w.webp 400w, 5/sample-foam-texture.png-800w.webp 800w, 5/sample-foam-texture.png-1200w.webp 1200w, 5/sample-foam-texture.png-1218w.webp 1218w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="5/sample-foam-texture.png-400w.jpeg 400w, 5/sample-foam-texture.png-800w.jpeg 800w, 5/sample-foam-texture.png-1200w.jpeg 1200w, 5/sample-foam-texture.png-1218w.jpeg 1218w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Sampling the foam texture." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/5/sample-foam-texture.png-400w.jpeg" width="1218" height="352"/></picture><figcaption>Sampling the foam texture.</figcaption></figure>
<p>We simply use a <strong>Sample Texture 2D</strong> node to sample the foam texture and then use a <strong>Step</strong> node to add a cutoff. Lastly we multiply by a foam color property.</p>
<blockquote>
<p>üí° You could also use a <strong>Smoothstep</strong> node here to potentially get a smoother sampling of the foam texture.</p>
</blockquote>
<p>We could simply add the surface foam to the water color using the <strong>Add</strong> node however I believe we can do a bit better by blending it using an <strong>Overlay</strong> subgraph that we can create. This subgraph contains the following nodes.</p>
<figure><picture><source type="image/webp" srcset="5/overlay.png-400w.webp 400w, 5/overlay.png-800w.webp 800w, 5/overlay.png-1200w.webp 1200w, 5/overlay.png-1426w.webp 1426w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="5/overlay.png-400w.jpeg 400w, 5/overlay.png-800w.jpeg 800w, 5/overlay.png-1200w.jpeg 1200w, 5/overlay.png-1426w.jpeg 1426w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Adding the foam." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/5/overlay.png-400w.jpeg" width="1426" height="524"/></picture><figcaption>Adding the foam.</figcaption></figure>
<p>We can then use this <strong>Overlay</strong> subgraph to blend between the water color we already had (Base) and the output of the surface foam nodes (Overlay).</p>
<figure><picture><source type="image/webp" srcset="5/blend.png-400w.webp 400w, 5/blend.png-800w.webp 800w, 5/blend.png-1200w.webp 1200w, 5/blend.png-1346w.webp 1346w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="5/blend.png-400w.jpeg 400w, 5/blend.png-800w.jpeg 800w, 5/blend.png-1200w.jpeg 1200w, 5/blend.png-1346w.jpeg 1346w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Blending the foam." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/5/blend.png-400w.jpeg" width="1346" height="788"/></picture><figcaption>Blending the foam.</figcaption></figure>
<p>Using this, the surface foam can get blended more nicely with the water by taking into account the base color of the water underneath the foam. It is subtle, but quite nice.</p>
<video poster="reflections.png" preload="auto" width="100%" title="Rendering realtime caustics." loop="" autoplay="" playsinline="" muted="true">
<source src="5/blend-foam.mp4" type="video/mp4"/>
</video>
<h3 id="intersection-foam" tabindex="-1"><a href="#intersection-foam" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> Intersection foam</h3>
<p>Next we will add foam that gets drawn at the edges of an object where it intersects the water surface.</p>
<h4>Intersection foam mask</h4>
<p>We will start by creating a mask that will define where the intersection foam should show up. For this, we will be using the <strong>Depth Fade</strong> subgraph we created before.</p>
<figure><picture><source type="image/webp" srcset="5/intersection-mask.png-400w.webp 400w, 5/intersection-mask.png-800w.webp 800w, 5/intersection-mask.png-1200w.webp 1200w, 5/intersection-mask.png-1600w.webp 1600w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="5/intersection-mask.png-400w.jpeg 400w, 5/intersection-mask.png-800w.jpeg 800w, 5/intersection-mask.png-1200w.jpeg 1200w, 5/intersection-mask.png-1600w.jpeg 1600w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Intersection foam mask." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/5/intersection-mask.png-400w.jpeg" width="1600" height="384"/></picture><figcaption>Intersection foam mask.</figcaption></figure>
<p>We use the <strong>Depth Fade</strong> subgraph to create a depth-based mask and use the <strong>Intersection Foam Fade</strong> parameter to control the hardness of the mask. When just showing this intersection mask, it looks like this.</p>
<video poster="reflections.png" preload="auto" width="100%" title="Rendering realtime caustics." loop="" autoplay="" playsinline="" muted="true">
<source src="5/intersection-mask.mp4" type="video/mp4"/>
</video>
<h4>Sampling the intersection foam</h4>
<p>For the intersection foam, the setup is similar to the surface foam. Again we use the <strong>Panning UV</strong> subgraph and use those UVs to sample an <strong>Intersection Foam Texture</strong>. We use an <strong>Intersection Foam Cutoff</strong> parameter to control where we cut off the foam texture using a <strong>Step</strong> node. We multiply this <strong>Intersection Foam Cutoff</strong> parameter by the output of the <strong>Depth Fade</strong> subgraph that we used in the nodes for the depth-based mask. The reasoning is that we want the foam to be fully formed near the edges of the object, but disintegrate as it goes further away from the shore.</p>
<figure><picture><source type="image/webp" srcset="5/intersection-foam.png-400w.webp 400w, 5/intersection-foam.png-800w.webp 800w, 5/intersection-foam.png-1200w.webp 1200w, 5/intersection-foam.png-2058w.webp 2058w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="5/intersection-foam.png-400w.jpeg 400w, 5/intersection-foam.png-800w.jpeg 800w, 5/intersection-foam.png-1200w.jpeg 1200w, 5/intersection-foam.png-2058w.jpeg 2058w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Intersection foam." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/5/intersection-foam.png-400w.jpeg" width="2058" height="490"/></picture><figcaption>Intersection foam.</figcaption></figure>
<p>The other nodes are used to set the color of the intersection foam. We also <mark>multiply the alpha (transparency) of the intersection foam by the output of the nodes of the intersection foam mask that we created before</mark>. This makes sure that the intersection foam only shows up where we want it to (inside of the mask).</p>
<p>The sampled intersection foam texture could for example look like this.</p>
<figure><picture><source type="image/webp" srcset="5/intersection-foam-texture.png-270w.webp 270w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Intersection foam texture." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/5/intersection-foam-texture.png-270w.jpeg" width="270" height="270"/></picture><figcaption>Intersection foam texture.</figcaption></figure>
<h4>Adding the intersection foam</h4>
<p>Just like for the surface foam, we use the <em><strong>Overlay</strong></em> subgraph we created to nicely blend the intersection foam with the rest of the colors.</p>
<figure><picture><source type="image/webp" srcset="5/intersection-foam-blend.png-400w.webp 400w, 5/intersection-foam-blend.png-800w.webp 800w, 5/intersection-foam-blend.png-1200w.webp 1200w, 5/intersection-foam-blend.png-1416w.webp 1416w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="5/intersection-foam-blend.png-400w.jpeg 400w, 5/intersection-foam-blend.png-800w.jpeg 800w, 5/intersection-foam-blend.png-1200w.jpeg 1200w, 5/intersection-foam-blend.png-1416w.jpeg 1416w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Intersection foam blending." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/5/intersection-foam-blend.png-400w.jpeg" width="1416" height="326"/></picture><figcaption>Intersection foam blending.</figcaption></figure>
<p>Now we have added a nice intersection foam effect to the water!</p>
<video poster="reflections.png" preload="auto" width="100%" title="Rendering realtime caustics." loop="" autoplay="" playsinline="" muted="true">
<source src="5/intersection-foam.mp4" type="video/mp4"/>
</video>
<h2 id="6.-lighting" tabindex="-1"><a href="#6.-lighting" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> 6. Lighting</h2>
<p>An important feature of the water shader is how lighting interacts with it. We will go for a stylized look instead of a physically accurate one.</p>
<h3 id="surface-normals" tabindex="-1"><a href="#surface-normals" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> Surface normals</h3>
<p>First, we will generate surface normals for the water by sampling a <strong>Normals Texture</strong>. We will use a common trick which is to sample the texture twice using slightly different sampling properties. We then combine these 2 samples by using the <strong>Normal Blend</strong> node.</p>
<figure><picture><source type="image/webp" srcset="6/surface-normals.png-400w.webp 400w, 6/surface-normals.png-800w.webp 800w, 6/surface-normals.png-1200w.webp 1200w, 6/surface-normals.png-2038w.webp 2038w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="6/surface-normals.png-400w.jpeg 400w, 6/surface-normals.png-800w.jpeg 800w, 6/surface-normals.png-1200w.jpeg 1200w, 6/surface-normals.png-2038w.jpeg 2038w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Surface normals." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/6/surface-normals.png-400w.jpeg" width="2038" height="1312"/></picture><figcaption>Surface normals.</figcaption></figure>
<p>Notice that we only use a single value for the <strong>Normals Scale</strong> and <strong>Normals Speed</strong>. We just slightly modify them before sampling the <strong>Normals Texture</strong> for a second time. Again, we use the <strong>Panning UV</strong> subgraph we created earlier to move the normals textures.</p>
<p>I have put the nodes from the screenshot above in a subgraph called <strong>Blended Normals</strong>. We can then use the output of these normals and apply a strength to them using the <strong>Normal Strength</strong> node. Finally we transform them to world space using the <strong>Transform</strong> node.</p>
<figure><picture><source type="image/webp" srcset="6/blended-normals.png-400w.webp 400w, 6/blended-normals.png-800w.webp 800w, 6/blended-normals.png-1200w.webp 1200w, 6/blended-normals.png-1876w.webp 1876w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="6/blended-normals.png-400w.jpeg 400w, 6/blended-normals.png-800w.jpeg 800w, 6/blended-normals.png-1200w.jpeg 1200w, 6/blended-normals.png-1876w.jpeg 1876w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Blended normals." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/6/blended-normals.png-400w.jpeg" width="1876" height="380"/></picture><figcaption>Blended normals</figcaption></figure>
<p>We now have moving normals for our water that we can use where we can adjust the speed, scale and strength.</p>
<video poster="reflections.png" preload="auto" width="100%" title="Rendering realtime caustics." loop="" autoplay="" playsinline="" muted="true">
<source src="6/moving-normals.mp4" type="video/mp4"/>
</video>
<h3 id="lighting-calculations" tabindex="-1"><a href="#lighting-calculations" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> Lighting calculations</h3>
<p>Next, we will use the normals we just created to generate <mark>lighting effects</mark>. Again, we will two <strong>Custom Function</strong> nodes. Our custom function nodes take in a normal vector, position and view direction (all in world space). The nodes then output a <strong>Specular</strong> lighting term. For the normals, we use the output of our world-space transformed normals from earlier. For the position and view direction, we can use the <strong>Position</strong> and <strong>View Direction</strong> nodes respectively (both in world space). We have one custom function node for <mark>Main Lighting</mark> and another one for <mark>Additional Lights</mark>. This will make it possible for our light to react to the main light as well as additional point lights.</p>
<figure><picture><source type="image/webp" srcset="6/lighting.png-400w.webp 400w, 6/lighting.png-800w.webp 800w, 6/lighting.png-1188w.webp 1188w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="6/lighting.png-400w.jpeg 400w, 6/lighting.png-800w.jpeg 800w, 6/lighting.png-1188w.jpeg 1188w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Lighting." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/6/lighting.png-400w.jpeg" width="1188" height="930"/></picture><figcaption>Lighting.</figcaption></figure>
<p>We can put all of the code for the lighting in one file. The code looks like this.</p>
<pre><code><span>float</span> <span>LightingSpecular</span><span>(</span><span>float3</span> L<span>,</span> <span>float3</span> N<span>,</span> <span>float3</span> V<span>,</span> <span>float</span> smoothness<span>)</span></code></pre>
<p>We can then combine the <strong>Main Lighting</strong> and <strong>Additional Lighting</strong> by first running the main lighting through a <strong>Step</strong> node to get hard lighting and we then multiply by a <strong>Specular Color</strong></p>
<figure><picture><source type="image/webp" srcset="6/combine-lighting.png-400w.webp 400w, 6/combine-lighting.png-800w.webp 800w, 6/combine-lighting.png-1200w.webp 1200w, 6/combine-lighting.png-1934w.webp 1934w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="6/combine-lighting.png-400w.jpeg 400w, 6/combine-lighting.png-800w.jpeg 800w, 6/combine-lighting.png-1200w.jpeg 1200w, 6/combine-lighting.png-1934w.jpeg 1934w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Combined lighting." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/6/combine-lighting.png-400w.jpeg" width="1934" height="704"/></picture><figcaption>Combined lighting.</figcaption></figure>
<p>Finally we can quite literally <strong>Add</strong> the lighting to the current output of the graph.</p>
<figure><picture><source type="image/webp" srcset="6/add-lighting.png-400w.webp 400w, 6/add-lighting.png-644w.webp 644w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="6/add-lighting.png-400w.jpeg 400w, 6/add-lighting.png-644w.jpeg 644w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Adding lighting." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/6/add-lighting.png-400w.jpeg" width="644" height="312"/></picture><figcaption>Adding lighting.</figcaption></figure>
<p>We now have pretty complex lighting effects for our water, allowing us to switch between smooth/rough water surfaces, hard/soft lighting, support for the main light and support for additional point lights.</p>
<video poster="reflections.png" preload="auto" width="100%" title="Rendering realtime caustics." loop="" autoplay="" playsinline="" muted="true">
<source src="6/lighting.mp4" type="video/mp4"/>
</video>
<details>
<summary>Bonus tip: Using surface normals to influence refraction</summary>
<div>
<p>Instead of using gradient noise to generate the refraction like we did before, it might be a better idea to use the surface normals to influence the strength of the refraction. This looks better visually. For this, you will have to transform the generated normals from <strong>Tangent</strong> space to <strong>View</strong> space, then <strong>Multiply</strong> by a <strong>Refraction Strength</strong> parameter and then add the result to the <strong>Screen Position</strong> to generate the refracted UVs.</p>
<figure><picture><source type="image/webp" srcset="6/normals-refraction.png-400w.webp 400w, 6/normals-refraction.png-800w.webp 800w, 6/normals-refraction.png-1200w.webp 1200w, 6/normals-refraction.png-1510w.webp 1510w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="6/normals-refraction.png-400w.jpeg 400w, 6/normals-refraction.png-800w.jpeg 800w, 6/normals-refraction.png-1200w.jpeg 1200w, 6/normals-refraction.png-1510w.jpeg 1510w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Refraction using normals." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/6/normals-refraction.png-400w.jpeg" width="1510" height="1134"/></picture><figcaption>Refraction using normals.</figcaption></figure>
</div>
</details>
<h2 id="7.-waves" tabindex="-1"><a href="#7.-waves" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> 7. Waves</h2>
<p>A big part of the look of our water shader is now complete so let&#39;s add some movement.</p>
<h3 id="vertex-displacement" tabindex="-1"><a href="#vertex-displacement" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> Vertex displacement</h3>
<p>We will be adding wave movement by <mark>displacing the vertices of the water plane in the vertex shader</mark>. For this to work nicely, you need to make sure that your water plane has a high enough vertex density so that there are enough vertices to displace.</p>
<p>The nodes below show a very basic example of vertex displacement. We take the original world position of the vertex and add an offset (0,0,0 in this case). We then convert from <strong>World Space</strong> to <strong>Object space</strong> and link it up with the vertex position slot.</p>
<figure><picture><source type="image/webp" srcset="7/vertex-displacement.png-400w.webp 400w, 7/vertex-displacement.png-800w.webp 800w, 7/vertex-displacement.png-1200w.webp 1200w, 7/vertex-displacement.png-1776w.webp 1776w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="7/vertex-displacement.png-400w.jpeg 400w, 7/vertex-displacement.png-800w.jpeg 800w, 7/vertex-displacement.png-1200w.jpeg 1200w, 7/vertex-displacement.png-1776w.jpeg 1776w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Vertex displacement." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/7/vertex-displacement.png-400w.jpeg" width="1776" height="538"/></picture><figcaption>Vertex displacement.</figcaption></figure>
<h3 id="gerstner-waves" tabindex="-1"><a href="#gerstner-waves" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> Gerstner waves</h3>
<p>There are many levels of simulating wave displacement. You could start by adding <mark>simple sine waves</mark> or go all in and create a <a href="https://www.keithlantz.net/2011/11/ocean-simulation-part-two-using-the-fast-fourier-transform/" target="_blank" rel="noopener noreferrer">FFT wave simulation</a>. We will use something between the two in terms of graphical fidelity: <mark>Gerstner Waves</mark>. There are many good tutorials about Gerstner Waves. I will just explain how I use them in my shader. If you want more information, I recommend <a href="https://catlikecoding.com/unity/tutorials/flow/waves/" target="_blank" rel="noopener noreferrer">this tutorial about waves by Catlike Coding</a>.</p>
<p>Because the code for the waves is math-heavy, we again use a <strong>Custom Function</strong> node and add the output as an offset to the world position like we did in the previous section.</p>
<figure><picture><source type="image/webp" srcset="7/gerstner-waves.png-400w.webp 400w, 7/gerstner-waves.png-800w.webp 800w, 7/gerstner-waves.png-1200w.webp 1200w, 7/gerstner-waves.png-1566w.webp 1566w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="7/gerstner-waves.png-400w.jpeg 400w, 7/gerstner-waves.png-800w.jpeg 800w, 7/gerstner-waves.png-1200w.jpeg 1200w, 7/gerstner-waves.png-1566w.jpeg 1566w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Gerstner waves." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/7/gerstner-waves.png-400w.jpeg" width="1566" height="548"/></picture><figcaption>Gerstner waves.</figcaption></figure>
<p>The following code generates 4 waves in total and then adds them together.</p>
<pre><code><span>float3</span> <span>GerstnerWave</span><span>(</span><span>float3</span> position<span>,</span> <span>float</span> steepness<span>,</span> <span>float</span> wavelength<span>,</span> <span>float</span> speed<span>,</span> <span>float</span> direction<span>,</span> <span>inout</span> <span>float3</span> tangent<span>,</span> <span>inout</span> <span>float3</span> binormal<span>)</span></code></pre>
<p>The custom function takes in values for the <strong>Steepness</strong>, <strong>Wavelength</strong> and <strong>Speed</strong> of the waves as well as 4 <strong>Direction</strong> values between [0,1] which can each control an individual wave. The normal vector is calculated as well.</p>
<blockquote>
<p>üí° Feel free to add even more waves, but I think 4 waves is already a nice starting point.</p>
</blockquote>
<p>Our waves look simple, but it is already quite nice.</p>
<video poster="reflections.png" preload="auto" width="100%" title="Rendering realtime caustics." loop="" autoplay="" playsinline="" muted="true">
<source src="7/waves.mp4" type="video/mp4"/>
</video>
<details>
<summary>Bonus tip: Using wave height to drive color</summary>
<p>An additional thing you can do is use the Y component of the <strong>Offset</strong> output of the <strong>Gerstner Waves</strong> custom function node to influence the colors of the water. This way you can give the tops of the waves a slightly different color.</p>
</details>
<h2 id="8.-buoyancy" tabindex="-1"><a href="#8.-buoyancy" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> 8. Buoyancy</h2>
<p>Buoyancy is a big and complicated topic if you want to achieve a realistic simulation. However, I wanted to share how you can go about adding basic buoyancy to your water.</p>
<h3 id="simulation-on-the-cpu" tabindex="-1"><a href="#simulation-on-the-cpu" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> Simulation on the CPU</h3>
<p>Currently we are simulating the waves on the GPU through the vertex shader of our water. To create a buoyancy simulation, we will recreate the wave movement on the CPU in a C# script. This way we can use this CPU simulation to create buoyancy effects for floating objects. The setup looks pretty similar to what we already did in our shader. We create a function <mark>GetWaveDisplacement</mark> which takes in a position and some wave parameters, It then returns an offset which is generated by adding 4 waves together. I added the script below. The goal is to have the exact same thing as we did in the vertex shader, but then running on the CPU.</p>
<details>
<summary>Script: GerstnerWaveDisplacement.cs</summary>

</details>
<h3 id="buoyancy-script" tabindex="-1"><a href="#buoyancy-script" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> Buoyancy script</h3>
<p>Next, we want to use the CPU simulation of the waves we did to actually make an object float on the water surface. For this I will use an approach that works using <mark>buoyancy effectors</mark>. These are points on an object where the wave offset is sampled and an appropriate force is added to the object. An object can have multiple effectors positioned around the surface of the object.</p>
<p>In my scene, I just have these effectors as empty gameobjects as children of the object that I want to simulate buoyancy for.</p>
<figure><picture><source type="image/webp" srcset="8/effector-children.png-280w.webp 280w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Effectors as children." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/8/effector-children.png-280w.jpeg" width="280" height="174"/></picture><figcaption>Effectors as children.</figcaption></figure>
<p>We can then create a script called <strong>BuoyantObject</strong> which will take in a reference to these effectors and apply force to them.</p>
<figure><picture><source type="image/webp" srcset="8/effectors-script.png-400w.webp 400w, 8/effectors-script.png-688w.webp 688w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="8/effectors-script.png-400w.jpeg 400w, 8/effectors-script.png-688w.jpeg 688w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Effectors." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/8/effectors-script.png-400w.jpeg" width="688" height="328"/></picture><figcaption>Effectors.</figcaption></figure>
<details>
<summary>Script: BuoyantObject.cs</summary>
<div>
<pre><code><span>[</span><span><span>RequireComponent</span><span><span>(</span><span>typeof</span><span>(</span><span>Rigidbody</span><span>)</span><span>)</span></span></span><span>]</span></code></pre>
</div>
</details>
<p>What&#39;s important for the <strong>BuoyantObject</strong> script is that the wave parameters should match the ones that you use in your water shader. In my own projects I usually make it so the <strong>BuoyantObject</strong> script holds a reference to the water and then just reads out those properties instead having to set them manually.</p>
<figure><picture><source type="image/webp" srcset="8/wave-properties.png-400w.webp 400w, 8/wave-properties.png-688w.webp 688w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="8/wave-properties.png-400w.jpeg 400w, 8/wave-properties.png-688w.jpeg 688w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Wave properties." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/8/wave-properties.png-400w.jpeg" width="688" height="440"/></picture><figcaption>Wave properties.</figcaption></figure>
<p>This gives us some simple but nice buoyancy!</p>
<video poster="reflections.png" preload="auto" width="100%" title="Rendering realtime caustics." loop="" autoplay="" playsinline="" muted="true">
<source src="8/buoyancy.mp4" type="video/mp4"/>
</video>
<h3 id="caustics" tabindex="-1"><a href="#caustics" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> Caustics</h3>
<p>Caustics are a really nice effect that you can add to your water. If you have enjoyed this tutorial so far, you can check out my caustics asset which can be added to any water shader and has several nice features. Here is a video showing the effect.</p>
<video poster="reflections.png" preload="auto" width="100%" title="Rendering realtime caustics." loop="" autoplay="" playsinline="" muted="true">
<source src="9/caustics.webm" type="video/webm"/>
</video>
<p>Support would be greatly appreciated! ‚ù§Ô∏è</p>

<details>
<summary>Bonus tip: Reflections</summary>
<div>
<p>Planar reflections can be added by using <a href="https://gist.github.com/alexanderameye/1fdb224bcf26a488bbeec109396b73b9" target="_blank" rel="noopener noreferrer">the following script</a> (use at your own risk, has not been tested in a while üòÖ). Essentially it renders everything upside down to a texture called <strong>_PlanarReflectionTexture</strong>. You can then sample this texture in your shader using the following nodes.</p>
<figure><picture><source type="image/webp" srcset="planar-reflections.png-400w.webp 400w, planar-reflections.png-800w.webp 800w, planar-reflections.png-1200w.webp 1200w, planar-reflections.png-1526w.webp 1526w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="planar-reflections.png-400w.jpeg 400w, planar-reflections.png-800w.jpeg 800w, planar-reflections.png-1200w.jpeg 1200w, planar-reflections.png-1526w.jpeg 1526w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Planar reflections." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/planar-reflections.png-400w.jpeg" width="1526" height="688"/></picture><figcaption>Planar reflections.</figcaption></figure>
</div>
</details>
<details>
<summary>Bonus tip: World space UVs</summary>
<div>
<p>Instead of using regular UVs for things like sampling your textures, you can make use of world space UVs. This will enable you to use <mark>water tiles</mark> that you place next to each other, and then all of the effects will line up nicely!</p>
<figure><picture><source type="image/webp" srcset="world-space-uvs.png-400w.webp 400w, world-space-uvs.png-800w.webp 800w, world-space-uvs.png-1200w.webp 1200w, world-space-uvs.png-1814w.webp 1814w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="world-space-uvs.png-400w.jpeg 400w, world-space-uvs.png-800w.jpeg 800w, world-space-uvs.png-1200w.jpeg 1200w, world-space-uvs.png-1814w.jpeg 1814w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="World space UVs." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/world-space-uvs.png-400w.jpeg" width="1814" height="886"/></picture><figcaption>World space UVs.</figcaption></figure>
</div>
</details>
<details>
<summary>Bonus tip: Fog</summary>
<div>
<p>Support for fog can be easily added like this.</p>
<figure><picture><source type="image/webp" srcset="fog.png-400w.webp 400w, fog.png-800w.webp 800w, fog.png-1200w.webp 1200w, fog.png-1540w.webp 1540w" sizes="(min-width: 30em) 50vw, 100vw"/><source type="image/jpeg" srcset="fog.png-400w.jpeg 400w, fog.png-800w.jpeg 800w, fog.png-1200w.jpeg 1200w, fog.png-1540w.jpeg 1540w" sizes="(min-width: 30em) 50vw, 100vw"/><img alt="Fog." loading="lazy" decoding="async" src="https://alexanderameye.github.io/notes/stylized-water-shader/fog.png-400w.jpeg" width="1540" height="1202"/></picture><figcaption>Fog.</figcaption></figure>
</div>
</details>
<details>
<summary>Bonus tip: Water trails</summary>

</details>
<h2 id="conclusion" tabindex="-1"><a href="#conclusion" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> Conclusion</h2>
<p>I hope you liked this tutorial. Please let me know what you think <a href="https://twitter.com/alexanderameye" target="_blank" rel="noopener noreferrer">over on Twitter!</a></p>
<p>You can get the shader files here.</p>
<p><a href="https://alexanderameye.github.io/downloads/packages/stylized-water.unitypackage" download="" rel="nofollow">stylized-water.unitypackage</a></p>
<h2 id="additional-resources" tabindex="-1"><a href="#additional-resources" target="_blank" rel="noopener noreferrer">
                  <span>Jump to heading</span>
                  <span aria-hidden="true">#</span>
                </a> Additional resources</h2>
<p><a href="https://www.alanzucconi.com/2019/09/13/believable-caustics-reflections/" target="_blank" rel="noopener noreferrer">https://www.alanzucconi.com/2019/09/13/believable-caustics-reflections/</a></p>
<p><a href="https://www.patreon.com/posts/making-water-24192529" target="_blank" rel="noopener noreferrer">https://www.patreon.com/posts/making-water-24192529</a></p>
<p><a href="https://catlikecoding.com/unity/tutorials/flow/waves/" target="_blank" rel="noopener noreferrer">https://catlikecoding.com/unity/tutorials/flow/waves/</a></p>

        <!--<blockquote><p>See any issues or have any comments about this note? Please <a href="/about">let me know about it</a>.</p></blockquote>-->
        <p><time>March 2023</time>
        </p>
    </div>
    
</div></div>
  </body>
</html>
