<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/tilyupo/qustar">Original</a>
    <h1>Show HN: Node.js ORM to query SQL database through an array-like API</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto"><a href="https://www.npmjs.com/package/qustar" rel="nofollow"><img src="https://camo.githubusercontent.com/5097a5d94ee547c787deb9f2affd3eec867de8a0afcdb81030ecd359d1165b5a/68747470733a2f2f696d672e736869656c64732e696f2f6e706d2f762f7175737461722e737667" alt="npm version" data-canonical-src="https://img.shields.io/npm/v/qustar.svg"/></a>
<a href="https://github.com/tilyupo/qustar/blob/main/LICENSE"><img src="https://camo.githubusercontent.com/bb4e5c0036a6a8cdbc59b38d44f09ad8f6dc722751dad34d3df5bf0ac61913c1/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f6c6963656e73652d4d49542d626c7565" alt="MIT license" data-canonical-src="https://img.shields.io/badge/license-MIT-blue"/></a></p>
<p dir="auto">Query SQL database through an array-like API.</p>

<p dir="auto">âœ… Expressive AND high-level query builder</p>

<p dir="auto">To start using qustar with PostgreSQL (the list of all supported data sources is <a href="#supported-database-drivers">available below</a>) run the following command:</p>
<div dir="auto" data-snippet-clipboard-copy-content="npm install qustar qustar-pg pg"><pre>npm install qustar qustar-pg pg</pre></div>
<p dir="auto">Here an example usage of qustar:</p>
<div dir="auto" data-snippet-clipboard-copy-content="import {PgConnector} from &#39;qustar-pg&#39;;
import {Q} from &#39;qustar&#39;;

// specify a schema
const users = Q.table({
  name: &#39;users&#39;,
  schema: {
    // generated is not required during insert
    id: Q.i32().generated(), // 32 bit integer
    firstName: Q.string(), // any text
    lastName: Q.string(),
    age: Q.i32().null(), // nullable integer
  },
});

// compose a query
const query = users
  .orderByDesc(user =&gt; user.createdAt)
  // map will be translated into 100% SQL, as every other operation
  .map(user =&gt; ({
    name: user.firstName.concat(&#39; &#39;, user.lastName),
    age: user.age,
  }))
  .limit(3);

// connect to your database
const connector = new PgConnector(&#39;postgresql://qustar:passwd@localhost:5432&#39;);

// run the query
console.log(&#39;users:&#39;, await query.fetch(connector));"><pre><span>import</span> <span>{</span><span>PgConnector</span><span>}</span> <span>from</span> <span>&#39;qustar-pg&#39;</span><span>;</span>
<span>import</span> <span>{</span><span>Q</span><span>}</span> <span>from</span> <span>&#39;qustar&#39;</span><span>;</span>

<span>// specify a schema</span>
<span>const</span> <span>users</span> <span>=</span> <span>Q</span><span>.</span><span>table</span><span>(</span><span>{</span>
  <span>name</span>: <span>&#39;users&#39;</span><span>,</span>
  <span>schema</span>: <span>{</span>
    <span>// generated is not required during insert</span>
    <span>id</span>: <span>Q</span><span>.</span><span>i32</span><span>(</span><span>)</span><span>.</span><span>generated</span><span>(</span><span>)</span><span>,</span> <span>// 32 bit integer</span>
    <span>firstName</span>: <span>Q</span><span>.</span><span>string</span><span>(</span><span>)</span><span>,</span> <span>// any text</span>
    <span>lastName</span>: <span>Q</span><span>.</span><span>string</span><span>(</span><span>)</span><span>,</span>
    <span>age</span>: <span>Q</span><span>.</span><span>i32</span><span>(</span><span>)</span><span>.</span><span>null</span><span>(</span><span>)</span><span>,</span> <span>// nullable integer</span>
  <span>}</span><span>,</span>
<span>}</span><span>)</span><span>;</span>

<span>// compose a query</span>
<span>const</span> <span>query</span> <span>=</span> <span>users</span>
  <span>.</span><span>orderByDesc</span><span>(</span><span>user</span> <span>=&gt;</span> <span>user</span><span>.</span><span>createdAt</span><span>)</span>
  <span>// map will be translated into 100% SQL, as every other operation</span>
  <span>.</span><span>map</span><span>(</span><span>user</span> <span>=&gt;</span> <span>(</span><span>{</span>
    <span>name</span>: <span>user</span><span>.</span><span>firstName</span><span>.</span><span>concat</span><span>(</span><span>&#39; &#39;</span><span>,</span> <span>user</span><span>.</span><span>lastName</span><span>)</span><span>,</span>
    <span>age</span>: <span>user</span><span>.</span><span>age</span><span>,</span>
  <span>}</span><span>)</span><span>)</span>
  <span>.</span><span>limit</span><span>(</span><span>3</span><span>)</span><span>;</span>

<span>// connect to your database</span>
<span>const</span> <span>connector</span> <span>=</span> <span>new</span> <span>PgConnector</span><span>(</span><span>&#39;postgresql://qustar:passwd@localhost:5432&#39;</span><span>)</span><span>;</span>

<span>// run the query</span>
<span>console</span><span>.</span><span>log</span><span>(</span><span>&#39;users:&#39;</span><span>,</span> <span>await</span> <span>query</span><span>.</span><span>fetch</span><span>(</span><span>connector</span><span>)</span><span>)</span><span>;</span></pre></div>
<p dir="auto">Output:</p>
<div dir="auto" data-snippet-clipboard-copy-content="{ age: 54, name: &#39;Linus Torvalds&#39; }
{ age: 29, name: &#39;Clark Kent&#39; }
{ age: 18, name: &#39;John Smith&#39; }"><pre><span>{</span> <span>age</span>: <span>54</span><span>,</span> <span>name</span>: <span>&#39;Linus Torvalds&#39;</span> <span>}</span>
<span>{</span> <span>age</span>: <span>29</span><span>,</span> <span>name</span>: <span>&#39;Clark Kent&#39;</span> <span>}</span>
<span>{</span> <span>age</span>: <span>18</span><span>,</span> <span>name</span>: <span>&#39;John Smith&#39;</span> <span>}</span></pre></div>
<p dir="auto">The query above will be translated to:</p>
<div dir="auto" data-snippet-clipboard-copy-content="SELECT
  &#34;s1&#34;.&#34;age&#34;,
  concat(&#34;s1&#34;.&#34;firstName&#34;, &#39; &#39;, &#34;s1&#34;.&#34;lastName&#34;) AS &#34;name&#34;
FROM
  users AS &#34;s1&#34;
ORDER BY
  (&#34;s1&#34;.&#34;createdAt&#34;) DESC
LIMIT
  3"><pre><span>SELECT</span>
  <span><span>&#34;</span>s1<span>&#34;</span></span>.<span><span>&#34;</span>age<span>&#34;</span></span>,
  concat(<span><span>&#34;</span>s1<span>&#34;</span></span>.<span><span>&#34;</span>firstName<span>&#34;</span></span>, <span><span>&#39;</span> <span>&#39;</span></span>, <span><span>&#34;</span>s1<span>&#34;</span></span>.<span><span>&#34;</span>lastName<span>&#34;</span></span>) <span>AS</span> <span><span>&#34;</span>name<span>&#34;</span></span>
<span>FROM</span>
  users <span>AS</span> <span><span>&#34;</span>s1<span>&#34;</span></span>
<span>ORDER BY</span>
  (<span><span>&#34;</span>s1<span>&#34;</span></span>.<span><span>&#34;</span>createdAt<span>&#34;</span></span>) <span>DESC</span>
<span>LIMIT</span>
  <span>3</span></pre></div>
<p dir="auto">Insert/update/delete:</p>
<div dir="auto" data-snippet-clipboard-copy-content="// insert
await users.insert({firstName: &#39;New&#39;, lastName: &#39;User&#39;}).execute(connector);

// update
await users
  .filter(user =&gt; user.id.eq(42))
  .update(user =&gt; ({age: user.age.add(1)}))
  .execute(connector);

// delete
await users.delete(user =&gt; user.id.eq(42)).execute(connector);"><pre><span>// insert</span>
<span>await</span> <span>users</span><span>.</span><span>insert</span><span>(</span><span>{</span><span>firstName</span>: <span>&#39;New&#39;</span><span>,</span> <span>lastName</span>: <span>&#39;User&#39;</span><span>}</span><span>)</span><span>.</span><span>execute</span><span>(</span><span>connector</span><span>)</span><span>;</span>

<span>// update</span>
<span>await</span> <span>users</span>
  <span>.</span><span>filter</span><span>(</span><span>user</span> <span>=&gt;</span> <span>user</span><span>.</span><span>id</span><span>.</span><span>eq</span><span>(</span><span>42</span><span>)</span><span>)</span>
  <span>.</span><span>update</span><span>(</span><span>user</span> <span>=&gt;</span> <span>(</span><span>{</span><span>age</span>: <span>user</span><span>.</span><span>age</span><span>.</span><span>add</span><span>(</span><span>1</span><span>)</span><span>}</span><span>)</span><span>)</span>
  <span>.</span><span>execute</span><span>(</span><span>connector</span><span>)</span><span>;</span>

<span>// delete</span>
<span>await</span> <span>users</span><span>.</span><span>delete</span><span>(</span><span>user</span> <span>=&gt;</span> <span>user</span><span>.</span><span>id</span><span>.</span><span>eq</span><span>(</span><span>42</span><span>)</span><span>)</span><span>.</span><span>execute</span><span>(</span><span>connector</span><span>)</span><span>;</span></pre></div>
<div dir="auto"><h2 tabindex="-1" dir="auto">Supported database drivers</h2><a id="user-content-supported-database-drivers" aria-label="Permalink: Supported database drivers" href="#supported-database-drivers"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">To execute query against a database you need a <em>connector</em>. There are many ready to use connectors that wrap existing NodeJS drivers:</p>
<ul dir="auto">
<li>PostgreSQL
<ul dir="auto">
<li><a href="https://www.npmjs.com/package/qustar-pg" rel="nofollow">qustar-pg</a></li>
</ul>
</li>
<li>SQLite
<ul dir="auto">
<li><a href="https://www.npmjs.com/package/qustar-better-sqlite3" rel="nofollow">qustar-better-sqlite3</a> (recommended)</li>
<li><a href="https://www.npmjs.com/package/qustar-sqlite3" rel="nofollow">qustar-sqlite3</a></li>
</ul>
</li>
<li>MySQL
<ul dir="auto">
<li><a href="https://www.npmjs.com/package/qustar-mysql2" rel="nofollow">qustar-mysql2</a></li>
</ul>
</li>
<li>MariaDB
<ul dir="auto">
<li><a href="https://www.npmjs.com/package/qustar-mysql2" rel="nofollow">qustar-mysql2</a></li>
</ul>
</li>
</ul>
<p dir="auto">If you implemented your own connector, let me know and I will add it to the list above!</p>

<p dir="auto">Any query starts from a table or a <a href="#raw-sql">raw sql</a>. We will talk more about raw queries later, for now the basic usage looks like this:</p>
<div dir="auto" data-snippet-clipboard-copy-content="import {Q} from &#39;qustar&#39;;

const users = Q.table({
  name: &#39;users&#39;,
  schema: {
    id: Q.i32(),
    age: Q.i32().null(),
    // ...
  },
});"><pre><span>import</span> <span>{</span><span>Q</span><span>}</span> <span>from</span> <span>&#39;qustar&#39;</span><span>;</span>

<span>const</span> <span>users</span> <span>=</span> <span>Q</span><span>.</span><span>table</span><span>(</span><span>{</span>
  <span>name</span>: <span>&#39;users&#39;</span><span>,</span>
  <span>schema</span>: <span>{</span>
    <span>id</span>: <span>Q</span><span>.</span><span>i32</span><span>(</span><span>)</span><span>,</span>
    <span>age</span>: <span>Q</span><span>.</span><span>i32</span><span>(</span><span>)</span><span>.</span><span>null</span><span>(</span><span>)</span><span>,</span>
    <span>// ...</span>
  <span>}</span><span>,</span>
<span>}</span><span>)</span><span>;</span></pre></div>
<p dir="auto">In qustar you compose a query by calling query methods like <code>.filter</code> or <code>.map</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="const young = users.filter(user =&gt; user.age.lt(18));
const youngIds = young.map(user =&gt; user.id);

// or

const ids = users.filter(user =&gt; user.age.lt(18)).map(user =&gt; user.id);"><pre><span>const</span> <span>young</span> <span>=</span> <span>users</span><span>.</span><span>filter</span><span>(</span><span>user</span> <span>=&gt;</span> <span>user</span><span>.</span><span>age</span><span>.</span><span>lt</span><span>(</span><span>18</span><span>)</span><span>)</span><span>;</span>
<span>const</span> <span>youngIds</span> <span>=</span> <span>young</span><span>.</span><span>map</span><span>(</span><span>user</span> <span>=&gt;</span> <span>user</span><span>.</span><span>id</span><span>)</span><span>;</span>

<span>// or</span>

<span>const</span> <span>ids</span> <span>=</span> <span>users</span><span>.</span><span>filter</span><span>(</span><span>user</span> <span>=&gt;</span> <span>user</span><span>.</span><span>age</span><span>.</span><span>lt</span><span>(</span><span>18</span><span>)</span><span>)</span><span>.</span><span>map</span><span>(</span><span>user</span> <span>=&gt;</span> <span>user</span><span>.</span><span>id</span><span>)</span><span>;</span></pre></div>
<p dir="auto">Queries are immutable, so you can reuse them safely.</p>
<p dir="auto">For methods like <code>.filter</code> or <code>.map</code> you pass a callback which returns an <em>expression</em>. Expression represents a condition or operation you wish to do. Expressions are build using methods like <code>.add</code> or <code>.eq</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="// for arrays you would write: users.filter(x =&gt; x.age + 1 === x.height - 5)
const a = users.filter(user =&gt; user.age.add(1).eq(user.height.sub(5)));

// you can also use Q.eq to achieve the same
import {Q} from &#39;qustar&#39;;

const b = users.map(user =&gt; Q.eq(user.age.add(1), user.height.sub(5));"><pre><span>// for arrays you would write: users.filter(x =&gt; x.age + 1 === x.height - 5)</span>
<span>const</span> <span>a</span> <span>=</span> <span>users</span><span>.</span><span>filter</span><span>(</span><span>user</span> <span>=&gt;</span> <span>user</span><span>.</span><span>age</span><span>.</span><span>add</span><span>(</span><span>1</span><span>)</span><span>.</span><span>eq</span><span>(</span><span>user</span><span>.</span><span>height</span><span>.</span><span>sub</span><span>(</span><span>5</span><span>)</span><span>)</span><span>)</span><span>;</span>

<span>// you can also use Q.eq to achieve the same</span>
<span>import</span> <span>{</span><span>Q</span><span>}</span> <span>from</span> <span>&#39;qustar&#39;</span><span>;</span>

<span>const</span> <span>b</span> <span>=</span> <span>users</span><span>.</span><span>map</span><span>(</span><span>user</span> <span>=&gt;</span> <span>Q</span><span>.</span><span>eq</span><span>(</span><span>user</span><span>.</span><span>age</span><span>.</span><span>add</span><span>(</span><span>1</span><span>)</span><span>,</span> <span>user</span><span>.</span><span>height</span><span>.</span><span>sub</span><span>(</span><span>5</span><span>)</span><span>)</span><span>;</span></pre></div>
<p dir="auto">We can&#39;t use native operators like <code>+</code> or <code>===</code> because JavaScript doesn&#39;t support operator overloading. You can find full list of supported expression operations <a href="#expressions">here</a>.</p>
<p dir="auto">Now lets talk about queries and expressions.</p>


<div dir="auto" data-snippet-clipboard-copy-content="const adults = users
  // users with age &gt;= 18
  .filter(user =&gt; /* any expression */ user.age.gte(18));"><pre><span>const</span> <span>adults</span> <span>=</span> <span>users</span>
  <span>// users with age &gt;= 18</span>
  <span>.</span><span>filter</span><span>(</span><span>user</span> <span>=&gt;</span> <span>/* any expression */</span> <span>user</span><span>.</span><span>age</span><span>.</span><span>gte</span><span>(</span><span>18</span><span>)</span><span>)</span><span>;</span></pre></div>

<div dir="auto" data-snippet-clipboard-copy-content="const userIds = users.map(user =&gt; user.id);

const user = users
  // you can map to an object
  .map(user =&gt; ({id: user.id, name: user.name}));

const userInfo = users
  // you can map to nested objects
  .map(user =&gt; ({
    id: user.id,
    info: {
      adult: user.age.gte(18),
      nameLength: user.name.length(),
    },
  }));"><pre><span>const</span> <span>userIds</span> <span>=</span> <span>users</span><span>.</span><span>map</span><span>(</span><span>user</span> <span>=&gt;</span> <span>user</span><span>.</span><span>id</span><span>)</span><span>;</span>

<span>const</span> <span>user</span> <span>=</span> <span>users</span>
  <span>// you can map to an object</span>
  <span>.</span><span>map</span><span>(</span><span>user</span> <span>=&gt;</span> <span>(</span><span>{</span><span>id</span>: <span>user</span><span>.</span><span>id</span><span>,</span> <span>name</span>: <span>user</span><span>.</span><span>name</span><span>}</span><span>)</span><span>)</span><span>;</span>

<span>const</span> <span>userInfo</span> <span>=</span> <span>users</span>
  <span>// you can map to nested objects</span>
  <span>.</span><span>map</span><span>(</span><span>user</span> <span>=&gt;</span> <span>(</span><span>{</span>
    <span>id</span>: <span>user</span><span>.</span><span>id</span><span>,</span>
    <span>info</span>: <span>{</span>
      <span>adult</span>: <span>user</span><span>.</span><span>age</span><span>.</span><span>gte</span><span>(</span><span>18</span><span>)</span><span>,</span>
      <span>nameLength</span>: <span>user</span><span>.</span><span>name</span><span>.</span><span>length</span><span>(</span><span>)</span><span>,</span>
    <span>}</span><span>,</span>
  <span>}</span><span>)</span><span>)</span><span>;</span></pre></div>
<div dir="auto"><h4 tabindex="-1" dir="auto">.orderByDesc(selector), .orderByAsc(selector)</h4><a id="user-content-orderbydescselector-orderbyascselector" aria-label="Permalink: .orderByDesc(selector), .orderByAsc(selector)" href="#orderbydescselector-orderbyascselector"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div dir="auto" data-snippet-clipboard-copy-content="const users = users
  // order by age in ascending order
  .orderByAsc(user =&gt; user.age)
  // then order by name in descending order
  .thenByDesc(user =&gt; user.name);"><pre><span>const</span> <span>users</span> <span>=</span> <span>users</span>
  <span>// order by age in ascending order</span>
  <span>.</span><span>orderByAsc</span><span>(</span><span>user</span> <span>=&gt;</span> <span>user</span><span>.</span><span>age</span><span>)</span>
  <span>// then order by name in descending order</span>
  <span>.</span><span>thenByDesc</span><span>(</span><span>user</span> <span>=&gt;</span> <span>user</span><span>.</span><span>name</span><span>)</span><span>;</span></pre></div>
<div dir="auto"><h4 tabindex="-1" dir="auto">.drop(count), Query.limit(count)</h4><a id="user-content-dropcount-querylimitcount" aria-label="Permalink: .drop(count), Query.limit(count)" href="#dropcount-querylimitcount"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div dir="auto" data-snippet-clipboard-copy-content="const users = users
  .orderByAsc(user =&gt; user.id)
  // skip first ten users
  .drop(10)
  // then take only five
  .limit(5);"><pre><span>const</span> <span>users</span> <span>=</span> <span>users</span>
  <span>.</span><span>orderByAsc</span><span>(</span><span>user</span> <span>=&gt;</span> <span>user</span><span>.</span><span>id</span><span>)</span>
  <span>// skip first ten users</span>
  <span>.</span><span>drop</span><span>(</span><span>10</span><span>)</span>
  <span>// then take only five</span>
  <span>.</span><span>limit</span><span>(</span><span>5</span><span>)</span><span>;</span></pre></div>

<p dir="auto">You can also use <code>.slice</code> method to achieve the same:</p>
<div dir="auto" data-snippet-clipboard-copy-content="const users = users
  // start = 10, end = 15
  .slice(10, 15);"><pre><span>const</span> <span>users</span> <span>=</span> <span>users</span>
  <span>// start = 10, end = 15</span>
  <span>.</span><span>slice</span><span>(</span><span>10</span><span>,</span> <span>15</span><span>)</span><span>;</span></pre></div>
<div dir="auto"><h4 tabindex="-1" dir="auto">.{inner,left,right}Join(options)</h4><a id="user-content-innerleftrightjoinoptions" aria-label="Permalink: .{inner,left,right}Join(options)" href="#innerleftrightjoinoptions"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Qustar supports <code>.innerJoin</code>, <code>.leftJoin</code>, <code>.rightJoin</code> and <code>.fullJoin</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="const bobPosts = posts
  .innerJoin({
    right: users,
    condition: (post, user) =&gt; post.authorId.eq(user.id),
    select: (post, author) =&gt; ({
      text: post.text,
      author: author.name,
    }),
  })
  .filter(({author}) =&gt; author.like(&#39;bob%&#39;));"><pre><span>const</span> <span>bobPosts</span> <span>=</span> <span>posts</span>
  <span>.</span><span>innerJoin</span><span>(</span><span>{</span>
    <span>right</span>: <span>users</span><span>,</span>
    <span>condition</span>: <span>(</span><span>post</span><span>,</span> <span>user</span><span>)</span> <span>=&gt;</span> <span>post</span><span>.</span><span>authorId</span><span>.</span><span>eq</span><span>(</span><span>user</span><span>.</span><span>id</span><span>)</span><span>,</span>
    <span>select</span>: <span>(</span><span>post</span><span>,</span> <span>author</span><span>)</span> <span>=&gt;</span> <span>(</span><span>{</span>
      <span>text</span>: <span>post</span><span>.</span><span>text</span><span>,</span>
      <span>author</span>: <span>author</span><span>.</span><span>name</span><span>,</span>
    <span>}</span><span>)</span><span>,</span>
  <span>}</span><span>)</span>
  <span>.</span><span>filter</span><span>(</span><span>(</span><span>{</span>author<span>}</span><span>)</span> <span>=&gt;</span> <span>author</span><span>.</span><span>like</span><span>(</span><span>&#39;bob%&#39;</span><span>)</span><span>)</span><span>;</span></pre></div>

<p dir="auto">You can select distinct rows using <code>.unique</code> method:</p>
<div dir="auto" data-snippet-clipboard-copy-content="const names = users.map(user =&gt; user.name).unique();"><pre><span>const</span> <span>names</span> <span>=</span> <span>users</span><span>.</span><span>map</span><span>(</span><span>user</span> <span>=&gt;</span> <span>user</span><span>.</span><span>name</span><span>)</span><span>.</span><span>unique</span><span>(</span><span>)</span><span>;</span></pre></div>

<div dir="auto" data-snippet-clipboard-copy-content="const stats = users.groupBy({
  by: user =&gt; user.age,
  select: user =&gt; ({
    age: user.age,
    count: Expr.count(1),
    averageTax: user.salary.mul(user.taxRate).mean(),
  }),
});"><pre><span>const</span> <span>stats</span> <span>=</span> <span>users</span><span>.</span><span>groupBy</span><span>(</span><span>{</span>
  <span>by</span>: <span>user</span> <span>=&gt;</span> <span>user</span><span>.</span><span>age</span><span>,</span>
  <span>select</span>: <span>user</span> <span>=&gt;</span> <span>(</span><span>{</span>
    <span>age</span>: <span>user</span><span>.</span><span>age</span><span>,</span>
    <span>count</span>: <span>Expr</span><span>.</span><span>count</span><span>(</span><span>1</span><span>)</span><span>,</span>
    <span>averageTax</span>: <span>user</span><span>.</span><span>salary</span><span>.</span><span>mul</span><span>(</span><span>user</span><span>.</span><span>taxRate</span><span>)</span><span>.</span><span>mean</span><span>(</span><span>)</span><span>,</span>
  <span>}</span><span>)</span><span>,</span>
<span>}</span><span>)</span><span>;</span></pre></div>

<div dir="auto" data-snippet-clipboard-copy-content="const studentNames = students.map(student =&gt; student.name);
const teacherNames = teachers.map(teacher =&gt; teacher.name);

const uniqueNames = studentNames.union(teacherNames);"><pre><span>const</span> <span>studentNames</span> <span>=</span> <span>students</span><span>.</span><span>map</span><span>(</span><span>student</span> <span>=&gt;</span> <span>student</span><span>.</span><span>name</span><span>)</span><span>;</span>
<span>const</span> <span>teacherNames</span> <span>=</span> <span>teachers</span><span>.</span><span>map</span><span>(</span><span>teacher</span> <span>=&gt;</span> <span>teacher</span><span>.</span><span>name</span><span>)</span><span>;</span>

<span>const</span> <span>uniqueNames</span> <span>=</span> <span>studentNames</span><span>.</span><span>union</span><span>(</span><span>teacherNames</span><span>)</span><span>;</span></pre></div>

<div dir="auto" data-snippet-clipboard-copy-content="const studentNames = students.map(student =&gt; student.name);
const teacherNames = teachers.map(teacher =&gt; teacher.name);

const peopleCount = studentNames.unionAll(teacherNames).count();"><pre><span>const</span> <span>studentNames</span> <span>=</span> <span>students</span><span>.</span><span>map</span><span>(</span><span>student</span> <span>=&gt;</span> <span>student</span><span>.</span><span>name</span><span>)</span><span>;</span>
<span>const</span> <span>teacherNames</span> <span>=</span> <span>teachers</span><span>.</span><span>map</span><span>(</span><span>teacher</span> <span>=&gt;</span> <span>teacher</span><span>.</span><span>name</span><span>)</span><span>;</span>

<span>const</span> <span>peopleCount</span> <span>=</span> <span>studentNames</span><span>.</span><span>unionAll</span><span>(</span><span>teacherNames</span><span>)</span><span>.</span><span>count</span><span>(</span><span>)</span><span>;</span></pre></div>

<div dir="auto" data-snippet-clipboard-copy-content="const studentNames = students.map(student =&gt; student.name);
const teacherNames = teachers.map(teacher =&gt; teacher.name);

// concat preserves original ordering
const allNames = studentNames.concat(teacherNames);"><pre><span>const</span> <span>studentNames</span> <span>=</span> <span>students</span><span>.</span><span>map</span><span>(</span><span>student</span> <span>=&gt;</span> <span>student</span><span>.</span><span>name</span><span>)</span><span>;</span>
<span>const</span> <span>teacherNames</span> <span>=</span> <span>teachers</span><span>.</span><span>map</span><span>(</span><span>teacher</span> <span>=&gt;</span> <span>teacher</span><span>.</span><span>name</span><span>)</span><span>;</span>

<span>// concat preserves original ordering</span>
<span>const</span> <span>allNames</span> <span>=</span> <span>studentNames</span><span>.</span><span>concat</span><span>(</span><span>teacherNames</span><span>)</span><span>;</span></pre></div>

<div dir="auto" data-snippet-clipboard-copy-content="const studentNames = students.map(student =&gt; student.name);
const teacherNames = teachers.map(teacher =&gt; teacher.name);

const studentAndTeacherNames = studentNames.intersect(teacherNames);"><pre><span>const</span> <span>studentNames</span> <span>=</span> <span>students</span><span>.</span><span>map</span><span>(</span><span>student</span> <span>=&gt;</span> <span>student</span><span>.</span><span>name</span><span>)</span><span>;</span>
<span>const</span> <span>teacherNames</span> <span>=</span> <span>teachers</span><span>.</span><span>map</span><span>(</span><span>teacher</span> <span>=&gt;</span> <span>teacher</span><span>.</span><span>name</span><span>)</span><span>;</span>

<span>const</span> <span>studentAndTeacherNames</span> <span>=</span> <span>studentNames</span><span>.</span><span>intersect</span><span>(</span><span>teacherNames</span><span>)</span><span>;</span></pre></div>

<div dir="auto" data-snippet-clipboard-copy-content="const studentNames = students.map(student =&gt; student.name);
const teacherNames = teachers.map(teacher =&gt; teacher.name);

const studentOnlyNames = studentNames.except(teacherNames);"><pre><span>const</span> <span>studentNames</span> <span>=</span> <span>students</span><span>.</span><span>map</span><span>(</span><span>student</span> <span>=&gt;</span> <span>student</span><span>.</span><span>name</span><span>)</span><span>;</span>
<span>const</span> <span>teacherNames</span> <span>=</span> <span>teachers</span><span>.</span><span>map</span><span>(</span><span>teacher</span> <span>=&gt;</span> <span>teacher</span><span>.</span><span>name</span><span>)</span><span>;</span>

<span>const</span> <span>studentOnlyNames</span> <span>=</span> <span>studentNames</span><span>.</span><span>except</span><span>(</span><span>teacherNames</span><span>)</span><span>;</span></pre></div>

<div dir="auto" data-snippet-clipboard-copy-content="const postsWithAuthor = users.flatMap(user =&gt;
  posts
    .filter(post =&gt; post.authorId.eq(user.id))
    .map(post =&gt; ({text: post.text, author: user.name}))
);"><pre><span>const</span> <span>postsWithAuthor</span> <span>=</span> <span>users</span><span>.</span><span>flatMap</span><span>(</span><span>user</span> <span>=&gt;</span>
  <span>posts</span>
    <span>.</span><span>filter</span><span>(</span><span>post</span> <span>=&gt;</span> <span>post</span><span>.</span><span>authorId</span><span>.</span><span>eq</span><span>(</span><span>user</span><span>.</span><span>id</span><span>)</span><span>)</span>
    <span>.</span><span>map</span><span>(</span><span>post</span> <span>=&gt;</span> <span>(</span><span>{</span><span>text</span>: <span>post</span><span>.</span><span>text</span><span>,</span> <span>author</span>: <span>user</span><span>.</span><span>name</span><span>}</span><span>)</span><span>)</span>
<span>)</span><span>;</span></pre></div>

<div dir="auto" data-snippet-clipboard-copy-content="const userExists = users.map(user =&gt; user.id).includes(42);"><pre><span>const</span> <span>userExists</span> <span>=</span> <span>users</span><span>.</span><span>map</span><span>(</span><span>user</span> <span>=&gt;</span> <span>user</span><span>.</span><span>id</span><span>)</span><span>.</span><span>includes</span><span>(</span><span>42</span><span>)</span><span>;</span></pre></div>

<p dir="auto">The list of supported column types:</p>
<ul dir="auto">
<li><strong>boolean</strong>: true or false</li>
<li><strong>i8</strong>: 8 bit integer</li>
<li><strong>i16</strong>: 16 bit integer</li>
<li><strong>i32</strong>: 32 bit integer</li>
<li><strong>i64</strong>: 64 bit integer</li>
<li><strong>f32</strong>: 32 bit floating point number</li>
<li><strong>f64</strong>: 64 bit floating point number</li>
<li><strong>string</strong>: variable length string</li>
</ul>

<p dir="auto">You can use raw SQL like so:</p>
<div dir="auto" data-snippet-clipboard-copy-content="import {Q, sql} from &#39;qustar&#39;;

const users = Q.rawQuery({
  sql: sql`SELECT * from users`,
  // we must specify schema so qustar knows how to compose a query
  schema: {
    id: Q.i32(),
    age: Q.i32().null(),
  },
})
  .filter(user =&gt; user.age.lte(25))
  .map(user =&gt; user.id);"><pre><span>import</span> <span>{</span><span>Q</span><span>,</span> <span>sql</span><span>}</span> <span>from</span> <span>&#39;qustar&#39;</span><span>;</span>

<span>const</span> <span>users</span> <span>=</span> <span>Q</span><span>.</span><span>rawQuery</span><span>(</span><span>{</span>
  <span>sql</span>: <span>sql</span><span>`SELECT * from users`</span><span>,</span>
  <span>// we must specify schema so qustar knows how to compose a query</span>
  <span>schema</span>: <span>{</span>
    <span>id</span>: <span>Q</span><span>.</span><span>i32</span><span>(</span><span>)</span><span>,</span>
    <span>age</span>: <span>Q</span><span>.</span><span>i32</span><span>(</span><span>)</span><span>.</span><span>null</span><span>(</span><span>)</span><span>,</span>
  <span>}</span><span>,</span>
<span>}</span><span>)</span>
  <span>.</span><span>filter</span><span>(</span><span>user</span> <span>=&gt;</span> <span>user</span><span>.</span><span>age</span><span>.</span><span>lte</span><span>(</span><span>25</span><span>)</span><span>)</span>
  <span>.</span><span>map</span><span>(</span><span>user</span> <span>=&gt;</span> <span>user</span><span>.</span><span>id</span><span>)</span><span>;</span></pre></div>
<p dir="auto">You can also use aliases in a nested query like so:</p>
<div dir="auto" data-snippet-clipboard-copy-content="const postIds = users.flatMap(user =&gt;
  Q.rawQuery({
    sql: sql`
      SELECT
        id
      FROM
        posts p
      WHERE p.authorId = ${user.id}&#39;
    })`,
    schema: {
      id: Q.i32(),
    },
  });
);"><pre><span>const</span> <span>postIds</span> <span>=</span> <span>users</span><span>.</span><span>flatMap</span><span>(</span><span>user</span> <span>=&gt;</span>
  <span>Q</span><span>.</span><span>rawQuery</span><span>(</span><span>{</span>
    <span>sql</span>: <span>sql</span><span>`</span>
<span>      SELECT</span>
<span>        id</span>
<span>      FROM</span>
<span>        posts p</span>
<span>      WHERE p.authorId = <span><span>${</span><span>user</span><span>.</span><span>id</span><span>}</span></span>&#39;</span>
<span>    })`</span><span>,</span>
    <span>schema</span>: <span>{</span>
      <span>id</span>: <span>Q</span><span>.</span><span>i32</span><span>(</span><span>)</span><span>,</span>
    <span>}</span><span>,</span>
  <span>}</span><span>)</span><span>;</span>
<span>)</span><span>;</span></pre></div>
<p dir="auto">You can use <code>Q.rawExpr</code> for raw SQL in a part of an operation:</p>
<div dir="auto" data-snippet-clipboard-copy-content="const halfIds = users.map(user =&gt; ({
  halfId: Q.rawExpr({sql: sql`CAST(${user.id} as REAL) / 2`, schema: Q.f32()}),
  name: user.name,
}));"><pre><span>const</span> <span>halfIds</span> <span>=</span> <span>users</span><span>.</span><span>map</span><span>(</span><span>user</span> <span>=&gt;</span> <span>(</span><span>{</span>
  <span>halfId</span>: <span>Q</span><span>.</span><span>rawExpr</span><span>(</span><span>{</span><span>sql</span>: <span>sql</span><span>`CAST(<span><span>${</span><span>user</span><span>.</span><span>id</span><span>}</span></span> as REAL) / 2`</span><span>,</span> <span>schema</span>: <span>Q</span><span>.</span><span>f32</span><span>(</span><span>)</span><span>}</span><span>)</span><span>,</span>
  <span>name</span>: <span>user</span><span>.</span><span>name</span><span>,</span>
<span>}</span><span>)</span><span>)</span><span>;</span></pre></div>
<p dir="auto">The query above will be translated to:</p>
<div dir="auto" data-snippet-clipboard-copy-content="SELECT
  &#34;s1&#34;.&#34;name&#34;,
  (CAST((&#34;s1&#34;.&#34;id&#34;) as REAL) / 2) AS &#34;halfId&#34;
FROM
  users AS &#34;s1&#34;"><pre><span>SELECT</span>
  <span><span>&#34;</span>s1<span>&#34;</span></span>.<span><span>&#34;</span>name<span>&#34;</span></span>,
  (CAST((<span><span>&#34;</span>s1<span>&#34;</span></span>.<span><span>&#34;</span>id<span>&#34;</span></span>) <span>as</span> <span>REAL</span>) <span>/</span> <span>2</span>) <span>AS</span> <span><span>&#34;</span>halfId<span>&#34;</span></span>
<span>FROM</span>
  users <span>AS</span> <span><span>&#34;</span>s1<span>&#34;</span></span></pre></div>

<p dir="auto">MIT License, see <code>LICENSE</code>.</p>
</article></div></div>
  </body>
</html>
