<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.instructables.com/Ultimate-Mosquito-Swatter-Mod-for-Gamer-Add-Kill-C/">Original</a>
    <h1>Mosquito swatter gamer mod with kill counter, sound and rechargeable battery</h1>
    
    <div id="readability-page-1" class="page"><div><div><section id="intro" data-stepid="SMYM23CL3EGCYTF"><h2>Introduction: Ultimate Mosquito Swatter Mod for Gamer: Add Kill Counter, Sound, Rechargeable Battery.</h2><div><p>Where I live, from spring to autumn we have to compete for territory against tiger mosquito.</p><p>Local stores offer a impressive list of anti mosquito devices, candles, including sophisticated traps sold a few hundred euros, I even found one sold 2000€ - this give you an idea of how desperate people are to get rid of those invaders.</p><p>One of my favorite weapon to fight against mosquito is this cheap electric swatter, but to make this fight even more rewarding I thought I should upgrade my weapon.</p><p>In this instructable, I will show and explain how to hack an electric swatter to :</p><ul><li><strong>add electronic to detect kills.</strong></li><li><strong>add a 4 digit counter.</strong></li><li><strong>make it usb rechargeable.</strong></li><li><strong>add sound for a better experience.</strong></li></ul><p>My thought was that when an insect hits the wire mesh of the swatter and the electric arc occurs, there must be some electric variation on the swatter circuit. If I could find a place in the circuit that is readable by an arduino or <a href="https://en.wikipedia.org/wiki/ATtiny_microcontroller_comparison_chart" rel="nofollow noopener">attiny</a> (that is between 0 and 5 volts) it would then be easy to count and display a score and to play some sound.</p><p>We can easily add sound/music capabilities to an attiny with a <a href="https://wiki.dfrobot.com/DFPlayer_Mini_SKU_DFR0299" rel="nofollow noopener">dfplayer</a> module</p><p>Score would be displayed with a 4 digits 7 segment display which as an onboard tm1637 which allows to drive the display with only two wires (two IO pins of the attiny)</p><p>Because those electronic modules run at 5V and the swatter are usually running from 2 x 1.5 v batteries, I also upgraded the power part of the swatter with a usb rechargeable battery.</p><p>In other words, the upgrade is made with off-the-shelf electronic modules that are easily found, it is simple electronic, the only &#34;complexity&#34; is in the signal computation, but this is handled by the attiny through programming.</p><p>In this instructable I assume you have some knowledge of ardiuno and how it is programmed, if not you can find good <a href="https://docs.arduino.cc/tutorials/uno-rev3/" rel="nofollow noopener">tutorials on arduino site</a> or <a href="https://www.instructables.com/circuits/arduino/projects/">explore arduino project on instructables.com</a></p><p>One more thing before starting, safety: electric swatter use high voltage (hundred of volts on the mesh when button is pressed) even if current is very low, be carrefull not to touch it or its internal circuit when battery is connected.</p><p>The Sticker says <strong>Caution keep away from children</strong> (and yourself)</p></div></section><section id="stepsupplies" data-stepid=""><h2>Supplies</h2><div><p>For this Ultimate Mosquito Swatter Mod for Gamer you will need :</p><ul><li>an electric mosquito swatter (there are several type of swatter circuit, this instructable and the program I suggest is adapted to one type of swatter, check the step &#39;Open the swatter&#39; to verify your swatter matches what I use)</li><li>digispark pro (convenient board with attiny, easily found online)</li><li>dfplayer (easily found online)</li><li>resistors: 1Ω, 1kΩ</li><li>8 Ω speakers</li><li>sd card (a small capacity should be enough to hold a few sound files)</li><li>li-ion rechargeable battery : <a href="https://www.instructables.com/Salvaging-Rechargeables-for-Projects/">salvage battery</a></li><li>battery charger, <a href="https://www.ebay.com/itm/174654839451?hash=item28aa3d5a9b:g:-zQAAOSwZylgOQPN" rel="nofollow noopener">something like this one</a></li><li>potentiometer (I used a 1MΩ, it is not very important but a high value will limit current consumption through the potentiometer)</li><li><a href="https://www.banggood.com/TM1637-4-Bits-Digital-LED-Display-Module-7-Segment-0_36-Inch-RED-Anode-Tube-Four-Serial-Driver-Board-p-1561696.html?cur_warehouse=CN" rel="nofollow noopener">Four digits LED display with tm1637</a> (make sure it is a 4 digit display + the TM1637 and not a 4 digit display only)</li><li>capacitor : 470 µF</li><li>on/off toggle switch</li><li>push button</li><li>wires (reuse old phone or ethernet cables)</li></ul><p>For the tooling part, you will need a soldering iron, a hot glue gun and a 3D printer (or some creativity to modify the swatter handle...)</p></div></section><section id="step1" data-stepid="S0ZO4KPL3EGCYTG"><h2>Step 1: How an Electric Swatter Works, How Can We Upgrade It?</h2><div><p>Well, if you do not care about the way it work and just want your Ultimate Mosquito Swatter for Gamer, you can skip this step...</p><p>Resources explaining how an electric swatter works can be found on internet. (ie <a href="https://www.homemade-circuits.com/mosquito-swatter-bat-circuit/" rel="nofollow noopener">https://www.homemade-circuits.com/mosquito-swatter-bat-circuit/</a>)</p><p>So it is oscillating circuit and a circuit to boost voltage up to hundreds of volts connected to the racket wire mesh.</p><p>Unfortunately, I could not find much to hook a attiny here (high voltage side is not directly usable due to the 5 volt limit of the attiny).</p><p>To work around this, my second thought was to measure current consumption. When an arc occurs on the net and the mosquito is fried, there must be some energy consumption that should be readable by an attiny.</p><p>The best way to measure this energy is to measure current consumption, and the easiest way to measure current is to measure voltage across a resistor, which an attiny can do.</p><p><strong>So the only trick to count mosquitos is to insert a small resistor between the battery and the swatter circuit and monitor voltage across this resistor.</strong></p><p>Beside that, I used already made electronic modules (one for each function : the sound, the display, the charger etc) so its is a fairly simple electronic project. </p></div></section><section id="step2" data-stepid="S34TPOVL3EGD4RD"><h2>Step 2: Plan for the Circuit </h2><div><p>The main components added are </p><ul><li>   attiny (digispark pro) </li><li>   dfplayer</li><li>   USB charger and the battery</li><li>   display</li><li>   reset button</li><li>   on/off switch</li><li>   potentiometer for volume adjustment</li><li>   two resistors and a capacitor</li></ul><p>We need to lay them out so they can fit in the handle, digispark and dfplayer can be kept close from each other, allow the right wire length for this other component based on where they will be located in the final mod (ie the usb charger has a usb port onboard that will need to be accessible for recharge)</p><p>see images and photos</p></div></section><section id="step3" data-stepid="SQYWPFEL3HBDDGF"><h2>Step 3: Open the Swatter</h2><div><p>Remove the battery and open the swatter (it should be only a few screws).</p><p><strong>It allows you to see how much room you have to place the add-on components but also check if your swatter matches what I use in this instructable...</strong></p><p><strong>The major difference to care about it the &#34;location&#34; of the push botton of the swatter. On mine, it is located between the + of the battery and the swatter circuit. If this is the case you are good to go (see photo).</strong></p><p><strong>On some swatter, this push button is located between the ground (-) and the circuit. In this case my modification and code will not work. I am pretty sure I can make it work with such swatter but it will need some adjustment on the hardware and software side. I will update this intructable once I have worked on this second type of swatter.</strong></p></div></section><section id="step4" data-stepid="SZ526B9L3EGD4RH"><h2>Step 4: Modify the Swatter</h2><div><p>In this step we :</p><p>- make some room for the battery in the compartment that was design for two AAA battery (and reuse the battery connector for the rechargeable battery)</p></div></section><section id="step5" data-stepid="SM2XKNKL3X1351Y"><h2>Step 5: Build the Circuit, Solder All Components</h2><div><p>Now that we know what is connected where, we can proceed with the soldering.</p><p>Layout all components based on their final location in order to estimate the various wires lenght.</p><p>In the previous step, for clarity purpose I did not draw the ground and VCC (5V) wires, but all ground need to be interconnected, all VCC need to be interconnected.</p><p>For VCC, the digispark has 3 pin labeled 5V, they are linked together and can be used to redispatch to other components. Do not use the VIN of the digispark (VIN is a voltage input that need to be above 6V, we do not use that but rather the 5V ouptut from the battery charger).</p><p>I suggest to start with the digispark :</p><ul><li>solder the digispark to the dfplayer.</li><li>the digispark to the display, push button and potentiometer.</li><li>use heat-shrink tubing to avoid contact and short cuts (like for the resistor between the digispark and the dfplayer).</li></ul><p>Then, proceed with the swatter circuit, battery chager, on/off switch:</p><ul><li>battery - to charger battery - input</li><li>battery + to charger battery + input</li><li>1 ohm resistor on the swatter circuit (+)</li><li>the capacitor on (+) and (-) of the swatter circuit, watch the capacitor polarity !</li><li>pin A12 of digispark to the push button (the push button has two connectors, one connected to the battery +, A12 goes to the other one)</li><li>use heat-shrink tubing to avoid contact and short cuts (on the capacitor, on the resistor, etc )</li></ul><p>See pictures for the progression...</p></div></section><section id="step6" data-stepid="SN5OSFDL3X1351Z"><h2>Step 6: Isolate the Display From the Swatter Circuit</h2><div><p>During my firsts tests I had display issues...the display would turn off or go crazy when a mosquito hit the mesh of the swatter.</p><p>I suspect it was due to electronic disturbance generated by the high voltage variation impacting the display circuit and connections.</p><p>The fix is simple, some tape on the circuit, aluminum foil (electromagnetic shield) and tape again.</p><p>Of course, do not place the aluminum foil directly on the circuit or it will create shortcuts...</p></div></section><section id="step7" data-stepid="SMCRFLNL3EGD4RE"><h2>Step 7: Load Sound on SD Card</h2><div><p>Sound played by the dfplayer are stored on an SD card.</p><p>I kept it simple, formated the card and copy my selected sounds</p><p>this is</p><ul><li>a sound played at power on (&#34;get ready to the next fight&#34;)</li><li>a &#34;monster killed&#34; sound</li><li>a &#34;level up&#34; sound</li><li>some sound files played randomly when a kill is detected.</li></ul><p>Once on the card dfplayer will play sounds based on a &#34;track number&#34;.</p><p>I could not find a clear description of the link between the dfplayer track number and the files on the SD card. </p><p>Based on observation, I suspect files are not sorted based on their name but rather with their inode number on the card (which can be seen with &#34;ls -id&#34; on linux)</p><pre spellcheck="false">ls -id * | more
647 1_Monster_kill.mp3
648 2_mixkit-final-level-bonus-2061.wav
649 3_get_ready_to_the_newt_fight.mp3
650 mixkit-arcade-retro-scoring-counter-273.wav
651 mixkit-arcade-video-game-bonus-2044.wav
652 mixkit-arcade-video-game-scoring-presentation-274.wav
653 mixkit-game-bonus-reached-2065.wav
654 mixkit-game-experience-level-increased-2062.wav
655 mixkit-winning-an-extra-bonus-2060.wav
</pre><p>I think that if you start from a freshly formated card, the sequence of track number / inode will be the order of the copy of the sound files (ie first file copied on the card will have tranck number 1)</p><p>In my suggested code, the file/track selection is done with setTrack :</p><pre spellcheck="false"> // 0 is random betwen tracks 4 to 9
 // 1 is monster kill = track 1 (listed by inode on card (ls -id))
 // 2 is level up
 // 3 is power on
 if (sound_type==0)  setTrack(int(random(4,9))); //SD card contains 9 files
 if (sound_type==1)  setTrack(1); // monster kill
 if (sound_type==2)  setTrack(2); //level up
 if (sound_type==3)  setTrack(3); //power on
</pre><p>So you could modify that part to have a match between the action (sound_type) and the track played.</p></div></section><section id="step8" data-stepid="S4S1C41L471L8RB"><h2>Step 8: Print a New Handle</h2><div><p>In case you are modifying the same swatter as used here, you could directly print my handle design.</p><p>If not you will have to design your own...</p><p>However some swatter have quite big handles with almost nothing in it, it might be possible to fit the add on circuit in without printing anything. You still need to find a place for the display and speaker.</p></div></section><section id="step9" data-stepid="SBWGGAEL471L8RC"><h2>Step 9: Assemble Everything</h2><div><p>I used a hot glue gun to secure the parts in their final location.</p><p>The speaker is also glued directly on the swatter.</p></div></section><section id="step10" data-stepid="SEDT4OBL3EGD4RF"><h2>Step 10: Where Is the Mosquito ? Math and Stats to the Rescue</h2><div><p>Once again, if you do not care about the way it works and just want your Ultimate Mosquito Swatter for Gamer, you can skip this step...and maybe come back later.</p><p>Once all components are soldered together if you load a simple program on the attiny that only do a analogRead(A12) and look at the raw data... it is a bit disappointing, raw data looks very noisy and you cannot tell where/when on the graph a mosquito (or something else, I did not wait for mosquitos to hit my racket to debug the code :) ) hit the mesh of the racket (see figure 1).</p><p>Averaging if a good way to cleanup part of the noise, and my idea was to compare the last average to a &#34;long term&#34; average, but well it was a bit disappointing too (see figure 2).</p><p>Next step is to read and learn what smarter people do...<a href="https://www.iese.fraunhofer.de/blog/change-point-detection/" rel="nofollow noopener">https://www.iese.fraunhofer.de/blog/change-point-detection/</a></p><p>This looks exactly what I am looking for, the calculation of the standard deviation of my signal should allow me the detect those kills (see the animation &#34;Animation of change point detection via sliding window &#34; on the link above).</p><p>Applied to our setup it give the following results (figure 3). In my program I calculate the square of the standard deviation, we can see it reaches very high values when I push or release the racket button (this is expected, the signal goes from 0V to close to 5V), but once those phases are excluded, I can monitor this standard deviation and assume that if it goes to some high values, we have a disturbance in the circuit which must be a mosquito kill (figure 4) !</p><p>Now that we know how to find a kill, the rest is easy (play a sound, increase score).</p><p>To be honest and more accurate, some more things were added :</p><p>- a 470 uF capacitor (which by it self provide some more noise filtering and serve as some sort of power bank when high current is needed)</p><p>- we have a two level averaging mechanism (you will see in the code that I measure 5 times in a raw the voltage on pin A12, average it and then store this averaged value for the sliding window of the standard deviation calculation) </p></div></section><section id="step11" data-stepid="S0ILI3XL3EGD4RG"><h2>Step 11: Load Program on the Digispark Pro</h2><div><p>This is pretty straighforward, the attiny can be programmed using the arduino IDE</p><p>instructions : <a href="http://This is pretty straighforward, the attiny can be programmed using the arduino IDE  instructions : http://digistump.com/wiki/digispark/tutorials/connectingpro" rel="nofollow noopener">http://digistump.com/wiki/digispark/tutorials/connectingpro</a></p><p>Some explanations on the code I am suggesting:</p><p>in the setup() funtion, we initialize the serial communication needed for the dfplayer, read the potentionmeter value to adjust the volume (it is read only once at setup time to avoid using cycles for this, which means the swatter woud need to be power off /on to take into account a volume adjustment).</p><p>Samething for the counter reset, I you want to reset score to zero, you need to push the reset button, power on the swatter and wait for the display to show &#34;0&#34;.</p><p>It then read the score stored in EEPROM.</p><p>It sets Brightness of the display (otherwise it remains off).</p><p>In the loop() function we basically process the average of the swatter power process_average() and the square of the standard deviation which tells us if we have a kill or not (process_std_dev() )</p></div></section><section id="step12" data-stepid="SAQLKOSL3X13520"><h2>Step 12: Update the Digispark Micronucleus (optionnal)</h2><div><p>The digispark micronucleus is the piece of code in charge of &#34;starting&#34; the digispark.</p><p>It checks if we are trying to upload a new program and if not start the program already loaded.</p><p>The problem is that it waits for 6 seconds for this check, which is fairly long when your are waiting for your swatter to be ready for a hunt...</p><p>Thanksfully there are some variants of the micronucleus with a different checking mechanism. If you update your micronucleus following those instructions (use the &#34;recommended&#34; config), the swatter will be ready after one or two seconds only.</p><p>Instructions : <a href="https://github.com/ArminJo/micronucleus-firmware" rel="nofollow noopener">https://github.com/ArminJo/micronucleus-firmware</a></p><p>Reload your program after updating the micronucleus firmware.</p></div></section><section id="step13" data-stepid="S8GMEMUL41BH5CW"><h2>Step 13: Troubleshooting...</h2><div><p>Hopefully you will not have to read this but...some tips just in case...</p><ol><li>not much work...check wire and solder</li><li>if the swatter restarts by itself (you hear the starting sound but have not switched on/off), recharge the battery</li><li>the swatter shutoff by itself after about 30 seconds.</li><li>some USB charger circuit have an automatic standby mode (that was the case for mine which is using chip IP5306) and will go in standy mode if less than some amount (45mA for the IP5306) of current is consumed.</li><li>the first workaround possible is to press the swatter button on a regular basis...like every 20sec. this would maintain the power up</li><li>the board (with IP5306) has a &#34;key&#34; feature allowing to power on or off. it is labeled &#34;K&#34; on the board. Solder this to pin 10 of the digispark. the watchdog() function on the code I suggested will keep the power up.</li><li>if the swatter is really bad at detecting or wrongly detect...well you may have to do some code adjustment...</li></ol><p>I spent hours tuning this device and its code. The major difficulty is to monitor what is going on...</p><p>If you want to use the USB port to display some variables, you have to modify the code in order to use the DigiCDC library and remove the SoftSerial (which is used for the 4 digit display). But more over when doing so, you get power from the USB port and not the battery charger port and this makes a big difference...The quality of VCC impacts a lot our calculated average and standard deviation...</p><p>In other words any tuning performed while connected on the USB will probably not work when running from battery...</p><p>One way to get some little information is to use the display itself (ie display the last standard deviation when the reset button is pressed)</p><p>Knowing that, you can try to adjust the following values in the code which impact (a lot) our detections:</p><p>the number of samples taken for a single read :</p><pre spellcheck="false">int samples=10;
</pre><p>The size of the average sliding window :</p><pre spellcheck="false">int nbr_slot=15;
int value[16];  // array of (nbr_slot + 1)
</pre><p>The standard deviation thresholds :</p><pre spellcheck="false">int threshold=110;
int monster_threshold=250;
</pre></div></section><section id="step14" data-stepid="S6PUICPL48GMJOK"><h2>Step 14: Improve the Swatter, Share Your Improvements</h2><p>Things could be done differently of course, If you improve the swatter, find simpler way to do it, design a handle for other models...share your work...</p></section><div><div data-contestid="VG9BS0JL150AWN9"><p><img data-src="https://content.instructables.com/ORIG/FD2/TIMD/L2AG20B1/FD2TIMDL2AG20B1.jpg?auto=webp&amp;crop=1240%2C600&amp;frame=1&amp;width=320" src="https://www.instructables.com/assets/img/pixel.png" alt="Electronics Contest"/></p><p>This is an entry in the </p></div></div><section id="imadeits"><h2>
        
            Be the First to Share
        
    </h2></section><section><h2>Recommendations</h2></section></div></div></div>
  </body>
</html>
