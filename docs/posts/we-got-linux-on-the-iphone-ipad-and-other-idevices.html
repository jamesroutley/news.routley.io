<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://konradybcio.pl/linuxona7/">Original</a>
    <h1>We got Linux on the iPhone, iPad and other idevices</h1>
    
    <div id="readability-page-1" class="page"><div id="content"><h2 id="introduction">Introduction</h2><p>The story starts back in 2020 with Corellium releasing Project Sandcastle. I was amazed at the sheer thought of running Linux on an iDevice, especially considering their state-of-the-art SoCs, which keep consistently outperforming the competitors&#39; offerings (or.. plainly trashing them, as was the case with M1!). Some time around that I got an old, used iPhone 5S for very cheap to play around with, so the only natural consequence of this would be that I try and get Linux running on it.</p><h2 id="stage-1-how-where-when-what">Stage 1: how where when what</h2><p>I looked at their <a href="https://github.com/corellium/linux-sandcastle/commit/86f078d26cd74c146949e25f503782587045fc31#diff-6e7b5a639763ba3303ae7df949402a6ffc00a898ba7a01e6a32313b58b804102" target="_blank" rel="noopener noreffer">Linux code drop</a>, but many things didn’t make sense at first.. Why are the addresses so high up (the MMIO peripherals start at 0x200000000, so they go above 32bit)? Why did they introduce so many changes in asm files and <a href="https://github.com/corellium/linux-sandcastle/commit/86f078d26cd74c146949e25f503782587045fc31#diff-e6a2c22131201190616a0c55be0211d5671605b0f266e1a0342a5981b57d7fabR1008" target="_blank" rel="noopener noreffer">what is this magic sequence</a>!?!?</p><p>I tried a couple of things, such as trying to load the kernel as-is with a quick-and-dirty device tree, but got practically nothing out of it. So I put the phone in the drawer and forgot about it for some time.</p><h2 id="stage-2-m1-and-asahi">Stage 2: M1 and Asahi</h2><p>Some time after @marcan announced in late 2020 that he would lead the efforts to get Linux running on the newly-announced M1 machines, I thought about the 5S again. As M1 support got closer, more and more things in the Corellium port made sense. The register space on Apple SoCs is just a design decision and it’s fully okay for it to be so high up. Actually, when you read into the ADT (Apple Device Trees) of iDevices, you can notice <a href="https://github.com/SoMainline/adt_collection/blob/master/a7/n53.adt#L472-L473" target="_blank" rel="noopener noreffer">that it is even described there</a>… The changes to IRQ code were a result of Apple using FIQs, or “fast interrupts”, but after some of the values were altered in a couple of commits, they behaved just like normal interrupts, as far as Linux is concerned. M1 also mandated some more changes, such as making Linux handle some not-exactly-standard EL2-related weirdness gracefully, but these were of no concern to the 5S, as the A7 SoC does not even implement it (in full compliance with the spec, as it is not mandatory).</p><figure><a href="https://konradybcio.pl/images/iphonefb.jpg" title="Writing to the framebuffer from Linux" data-thumbnail="/images/iphonefb.jpg" data-sub-html="&lt;h2&gt;Writing to the framebuffer from Linux&lt;/h2&gt;&lt;p&gt;Writing to the framebuffer from Linux&lt;/p&gt;"><img src="https://konradybcio.pl/svg/loading.min.svg" data-src="/images/iphonefb.jpg" data-srcset="/images/iphonefb.jpg, /images/iphonefb.jpg 1.5x, /images/iphonefb.jpg 2x" data-sizes="auto" alt="/images/iphonefb.jpg"/></a><figcaption>Writing to the framebuffer from Linux</figcaption></figure><p>Now with some more reference, I tried mimicking what marcan did on his streams, such as implementing a write-to-framebuffer macro in the Linux .S code, that allows for very early debugging (once we’re in pongoOS, the framebuffer is already initialized and it is not shut down when booting something with pongo). Turns out, I was actually in Linux! Success! Or so I thought, because no matter what I tried, I could not get any further than <code>enable_mmu</code>. I pinpointed the exact line, which made the phone die, which turned out to be the one that actually tells the MMU to enable itself. I tried a couple of monkey-brain ideas, such as dumping the <a href="https://developer.arm.com/documentation/100442/0200/register-descriptions/aarch32-system-registers/sctlr--system-control-register?lang=en" target="_blank" rel="noopener noreffer">SCTLR_EL1</a> and <a href="https://developer.arm.com/documentation/100442/0200/register-descriptions/aarch64-system-registers/ttbr0-el1--translation-table-base-register-0--el1?lang=en" target="_blank" rel="noopener noreffer">TTBR0_EL1</a>/<a href="https://developer.arm.com/documentation/100442/0200/register-descriptions/aarch64-system-registers/ttbr1-el1--translation-table-base-register-1--el1?lang=en" target="_blank" rel="noopener noreffer">TTBR1_EL1</a> values from both iBoot and pongoOS, but that changed precisely nothing (as I later found out, it couldn’t have..).</p><p>So, after a couple more tries, I got tired and benched the iPhone again.</p><h2 id="stage-3-cyclone-is-oh-so-broken">Stage 3: Cyclone is oh-so-broken</h2><p>The creation of Apple Cyclone, the armv8 core in the A7 SoC, started long before the armv8-a spec was finalized (armv8-a was announced in Oct 2011, Cortex-A53 was announced in Oct 2012, iPhone 5S with A7 was announced in Sept 2013, but core design, especially with a brand new architecture takes a LOT longer than 2 years, or so I’ve heard..) (Apple supposedly co-created the armv8 spec, but I don’t have a citation for that) and it was the first SoC featuring armv8 cores on the consumer market. This of course could not have ended smoothly. I got word that I need to look into “tunables” that would make the chip behave sanely. I then connected the dots, marcan also needed them on the M1 (he refered to them as <code>Chicken bits</code>, but that’s the same thing). Diving into the <a href="https://github.com/apple/darwin-xnu/" target="_blank" rel="noopener noreffer">XNU source</a>, I quickly noticed that there was a define for each core generation supported, so a quick grep for <code>APPLECYCLONE</code> told me all I needed to know.</p><p>I tried replicating Corellium’s way of doing it, by interjecting the kernel boot process, setting the tunables and then continuing like nothing ever happened, but that give me.. results that were no different than before! Stuck on <code>enable_mmu</code> again, arghh…</p><p>I could not really think of what was wrong back then, so - it’s a common theme now.. - I put the 5S back into the drawer yet again.</p><p><em>NOTE:</em> I compiled a list of A7’s (and consequently A8/A8X’s) quirks <a href="https://github.com/konradybcio/A7" target="_blank" rel="noopener noreffer">here</a></p><p><em>NOTE2:</em> I made a tool (an arguably dirty one at that) to decode supported features from standard armv8 architectural registers, the example values tell you what features are supported on A7 (and show you how it deviates from expected values in some cases): <a href="https://github.com/konradybcio/disarm" target="_blank" rel="noopener noreffer">konradybcio/disarm</a></p><h2 id="stage-4-lets-hack-on-pongoos">Stage 4: Let’s hack on pongoOS!</h2><p>One day I picked up this piece of ewas… amazing engineering again and decided that it’s time to try some more random things. First thing I did, I moved the tunable setting into pongoOS, so as to make sure they are actually set before Linux starts execution. That did not change anything, but in meantime I decided that it’d be nice to keep it in there, as adding random SoC-specific vendor-register writes to the main common init code of Linux/arm64 was not exactly the prettiest solution.</p><p>I tried doing a couple more things around enabling MMU that I don’t even quite remember now, but to no avail.</p><p>While I only have blurry recollections of what I did in this stage, I recall that I often came back to it and put the device back into the drawer again and again.</p><h2 id="stage-5-lets-get-quackin">Stage 5: Let’s get quackin&#39;</h2><p>Turns out I was not the only one trying to get pretty penguins on an iDevice. A fellow from a meme-posting channel, who owned an iPad Air 2 (based on the A8X SoC - as far as the bugs and most drivers are concerned - A8/A8X and A7 are identical) wanted to join in on the ‘fun’.</p><p>I shared what I learned and to no surprise, the things I tried did not work for him either.</p><p>What he did have though, is the lack of 1-year-or-so of discouragement, so he started with a fresh mind. His device was also getting stuck at <code>enable_mmu</code>. After many - also not exactly interesting or successful attempts - he was back in square one. One day he even went as far as hacking on the EL3 secure monitor and getting an OS-independent write-to-framebuffer function with a simple oneliner (<code>smc #0</code> - aka “hey secure monitor, knock knock”). It was certainly fun to watch the modern solutions to modern problems that were created as part of this. Quite recently, he got so tired of not having any humane way of debugging, that he made a barcode print function - he could read the value of a register and print in to the display, in a way such that any barcode-scanning application would decode it - very nice (but ultimately not very useful, but still really nice)!</p><h2 id="stage-6-wait-what-if">Stage 6: WAIT, WHAT IF</h2><p>Not so long after, I decided to have a more educated and less monkeybrain look at the pongoOS code.. it <em>had</em> to be ok, as the iPhone 7 booted Project Sandcastle’s Linux no problem.. I took a deep dive into the land of eye-spaghetti and dead code (pongoOS is great, checkra1n team, but you know, clang-format exists) and then noticed…</p><p>..<code>bootr</code> (<em>boots a raw image</em>) and <code>bootl</code> (<em>boots a Linux image</em>) actually DO behave differently!</p><p>Moreover, the Linux boot path sets a different entry point (aka the address where Linux is loaded, and consequently where the processor will look for instructions to execute)!</p><p>I looked at this precise line of code:</p><div><div><table><tbody><tr><td><pre><code><span>1
</span></code></pre></td><td><pre><code data-lang="fallback">gEntryPoint = (void *)(0x800080000);
</code></pre></td></tr></tbody></table></div></div><p>and was like… waaaaait, isn’t that a bit too low?</p><p>..of course it must have been.. I didn’t have the iPhone with me, so I told quack about this and he came up with <code>0x803000000</code>:</p><div><div><table><tbody><tr><td><pre><code><span>1
</span><span>2
</span></code></pre></td><td><pre><code data-lang="fallback">-    gEntryPoint = (void *)(0x800080000);
+    gEntryPoint = (void *)(0x803000000);
</code></pre></td></tr></tbody></table></div></div><p>and wouldn’t you know it..</p><p>WE GOT LINUX!</p><figure><a href="https://konradybcio.pl/images/ipadlinux.jpg" title="Linux on the iPad! Finally!" data-thumbnail="/images/ipadlinux.jpg" data-sub-html="&lt;h2&gt;Linux on the iPad! Finally!&lt;/h2&gt;&lt;p&gt;Linux on the iPad! Finally!&lt;/p&gt;"><img src="https://konradybcio.pl/svg/loading.min.svg" data-src="/images/ipadlinux.jpg" data-srcset="/images/ipadlinux.jpg, /images/ipadlinux.jpg 1.5x, /images/ipadlinux.jpg 2x" data-sizes="auto" alt="/images/ipadlinux.jpg"/></a><figcaption>Linux on the iPad! Finally!</figcaption></figure><p>Now it was just a matter of what I like the most, hacking on Linux</p><h2 id="stage-7-linux-time">Stage 7: Linux time!</h2><p>I hacked on the AIC driver to add support for A7-A8X, as well as A9-A11 SoCs and created device trees for A7-A8X devices, including quite a sizable number of peripherals already supported (with many more to come soon, hopefully). The tree is available on <a href="https://github.com/konradybcio/linux-apple" target="_blank" rel="noopener noreffer">konradybcio/linux-apple</a> and is supposed to be used with <a href="https://github.com/konradybcio/pongoOS" target="_blank" rel="noopener noreffer">my fork of pongoOS</a>.</p><p>The patches will be sent upstream for review soon, and hopefully merged into the mainline Linux.</p><p>If you want to boot Linux on your A7-A8X device, you should:</p><ul><li>get <a href="https://github.com/konradybcio/pongoOS" target="_blank" rel="noopener noreffer">pongoOS from my fork</a> (NOTE: unfortunately you can only checkm8 A7 devices on macOS currently)</li><li>get <a href="https://github.com/konradybcio/linux-apple" target="_blank" rel="noopener noreffer">my fork of Linux</a></li><li>get Corellium’s <a href="https://github.com/corellium/linux-sandcastle/blob/sandcastle-5.4/dtbpack.sh" target="_blank" rel="noopener noreffer">dtbpack script</a> and alter the DTBPATH to <code>arch/arm64/boot/dts/apple/socname-devicename.dtb</code> (you can ls the directory to check for available files)</li></ul><div><div><table><tbody><tr><td><pre><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span></code></pre></td><td><pre><code data-lang="fallback"># Build pongoOS
make -j$(nproc) # yes, it&#39;s that simple

# Load custom pongoOS with checkra1n
macOS: /Applications/checkra1n.app/Contents/MacOS/checkra1n -v -V -p -c -k /path/to/pongoOS/build/Pongo.bin

Linux: ./checkra1n -v -V -p -c -k /path/to/pongoOS/build/Pongo.bin

# Build Image.lzma and Flattened Device Trees (this assumes you adjusted your defconfig)
arm64:make -j$(nproc) Image.lzma dtbs
!arm64: make ARCH=arm64 CROSS_COMPILE=your-cross-compiler- -j$(nproc) Image.lzma dtbs

# Create a dtbpack
cd /path/to/linux-apple
/path/to/dtbpack.sh

# Load Linux to the device and boot it!
python3 /path/to/pongoOS/scripts/load_linux.py -k /path/to/linux-apple/arch/arm64/boot/Image.lzma -d /path/to/linux-apple/dtbpack [-r /path/to/some/ramdisk]

mandatory step: open twitter.com and brag about Linux on Apple, because internet
</code></pre></td></tr></tbody></table></div></div><h2 id="stage-8-can-i-help">Stage 8: Can I help?</h2><p>Yes, you can! If you have an iDevice, it would be really appreciated if you could dump the ADT from it (there are instructions in the README file), as Apple fills in some important fields (such as reserved memory) dynamically, so we can’t get that info from the un-filled ones present in IPSWs. You can find the repo here: <a href="https://github.com/SoMainline/adt_collection" target="_blank" rel="noopener noreffer">SoMainline/adt_collection</a>.</p><p>If you want to buy me a cup of tea, I have a <a href="https://konradybcio.pl/donate" target="_blank" rel="noopener noreffer">page where you can find ways to support me</a> (mostly crypto addresses, sorry!).</p><p>If you want to support <a href="https://twitter.com/quaack723" target="_blank" rel="noopener noreffer">quack</a> or other Linux projects, contact them directly for ways to support them.</p></div></div>
  </body>
</html>
