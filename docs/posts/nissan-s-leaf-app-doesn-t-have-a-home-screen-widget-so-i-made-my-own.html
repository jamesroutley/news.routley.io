<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://kevintechnology.com/posts/leaf-widget/">Original</a>
    <h1>Show HN: Nissan&#39;s Leaf app doesn&#39;t have a home screen widget so I made my own</h1>
    
    <div id="readability-page-1" class="page"><div><h2>Nissan‚Äôs App<span><a href="#nissans-app" aria-label="Anchor">#</a></span></h2><p>Nissan‚Äôs official <a href="https://apps.apple.com/us/app/nissanconnect-ev-services/id407814405" target="_blank">NissanConnect¬Æ EV &amp; Services iPhone app</a>:</p><blockquote><p>lets you manage the unique features of your LEAF like charging the battery, adjusting climate controls and checking the battery status, all from your mobile device</p></blockquote><p>Here is a screenshot of what it looks like for my car:</p><p><picture><source srcset="/posts/leaf-widget/iphone_app_hu02aa61ae1d9de35cbe238d2676170cb9_55766_295x639_resize_q75_h2_box.webp" type="image/webp"/><img src="https://kevintechnology.com/posts/leaf-widget/iphone_app.33b3eb1b00b2fb91e7339751cb7fead2.jpg" alt="Screenshot of Nissan LEAF iPhone app showing vehicle information" loading="lazy" height="639" width="295"/></picture></p><p>The app is‚Ä¶fine. Here is one representative review from the <a href="https://apps.apple.com/us/app/nissanconnect-ev-services/id407814405?see-all=reviews" target="_blank">Apple App Store</a>:</p><p><picture><source srcset="/posts/leaf-widget/review_hubeffdf57ec7c17671af28cc042015401_140363_1122x474_resize_q75_h2_box_3.webp" type="image/webp"/><img src="https://kevintechnology.com/posts/leaf-widget/review.3c39cd2839da9e51e8e7edb1d11fc4d6.png" alt="On 10/11/2023 SugimotoKoitsu reviewed the app: ‚ÄúSlow communication with the car: This app is pretty limited in what it does, the most useful to me being setting the cabin temperature in winter and checking charging status at work so I don‚Äôt hog one of the only two level 2 chargers at work all day. I like to take my 2023 Leaf SV+ off the charger as it nears 100%. But the app is very slow to update the status of the battery. I guess Nissan is polling the car through its cellular connection or a satellite connection, because I can‚Äôt log the car into the WiFi network at work. So maybe those methods are time consuming but it takes about five minutes to update the battery status, which is very annoying. It seems like there‚Äôs room for improvement in efficiency.‚Äù" loading="lazy" height="474" width="1122"/></picture></p><p>My main issue with the app is that it lacks a home screen widget I could use to quickly check my car‚Äôs battery status, unlike apps for other electric car brands like <a href="https://riviantrackr.com/news/rivian-release-mobile-app-2-8-0-update/" target="_blank">Rivian</a>, <a href="https://9to5mac.com/2024/11/12/fordpass-control-center-home-screen-widget/" target="_blank">Ford</a>, and <a href="https://apps.apple.com/us/app/lucid-motors/id1579793272" target="_blank">Lucid</a>.</p><h2>Third-Party Apps<span><a href="#third-party-apps" aria-label="Anchor">#</a></span></h2><p>Meanwhile, others have developed their own Nissan LEAF apps with a custom user interface and additional features (some with a home screen widget!):</p><ul><li><a href="https://mynissanleaf.com/threads/leaf-manager-alternative-carwings-app-for-android.11476/#post-264808" target="_blank">LEAF Manager by Gyathaar</a></li><li><a href="https://www.speakev.com/threads/beta-testers-wanted.12259/" target="_blank">EVA: Leaf by Rob Winters</a></li><li><a href="https://wkjeldsen.dk/myleaf/" target="_blank">My Leaf by Tobias Westergaard Kjeldsen</a></li></ul><p>Unfortunately, I understand that none of these apps are still available to use where I live in North America. üòû</p><p>The developer of ‚ÄúMy Leaf‚Äù <a href="https://tobis.dk/blog/the-farce-of-nissanconnect-north-america/" target="_blank">shared his frustration in a blog post</a>, explaining how Nissan‚Äôs deliberate changes to their North American API forced him to discontinue support for users in the region:</p><blockquote><p>I simply won‚Äôt support it any longer because of Nissan of North America‚Äôs persistant work on blocking third party clients. I continued to try and support the API during the last 12 months. Playing cat and mouse with Nissan. I simply don‚Äôt have the time and honestly the drive to continue when I know Nissan are consistently trying to break third party clients on purpose. It‚Äôs a sad and foolishness reality indeed.</p></blockquote><h2>Project Goals<span><a href="#project-goals" aria-label="Anchor">#</a></span></h2><p>Nevertheless, I decided to take on the challenge of developing an iPhone home screen widget that could show me the battery charge status of my Nissan LEAF car.</p><p>I added one more constraint to the project: no spending money. I believe Nissan‚Äôs app should already provide a home screen widget, so it didn‚Äôt seem fair to have to spend any money on this project. However, using tools/devices I already had access to was fair game.</p><p>Notably, that ruled out using something like <a href="https://sidecar.clutch.engineering/" target="_blank">Sidecar</a> which appears to provide a home screen widget. I think it looks very slick, but it requires the purchase of a wireless <a href="https://en.wikipedia.org/wiki/On-board_diagnostics" target="_blank">On-board Diagnostics (OBD)</a> scanner plus a $6.99 USD/month subscription. üòì</p><p>It also ruled out using the popular <a href="https://apps.apple.com/us/app/leafspy-pro/id967376861" target="_blank">LeafSpyPro app</a> which similarly requires the purchase of a wireless OBD scanner and costs $19.99 USD. To my knowledge, it doesn‚Äôt provide a home screen widget itself, but I think you could probably develop one using its data syncing feature.</p><h2>Results<span><a href="#results" aria-label="Anchor">#</a></span></h2><p>I am happy to report I was successful and spent no money! Here is a screenshot of the widget:</p><p><picture><source srcset="/posts/leaf-widget/widget_hu02aa61ae1d9de35cbe238d2676170cb9_26955_249x250_resize_q75_h2_box.webp" type="image/webp"/><img src="https://kevintechnology.com/posts/leaf-widget/widget.ee53de28b5fba496dd2445d7a29ee726.jpg" alt="Screenshot of Nissan LEAF widget on phone home screen displaying battery state of charge, available range, plugged-in status, cabin temperature range, estimated charge time, and date/time last refreshed" loading="lazy" height="250" width="249"/></picture></p><p>And if you tap the widget, it opens the NissanConnect app. You‚Äôll notice in the following video that there are a few extra non-ideal screen transitions (more on that below), but hey, you get what you pay for!</p><video controls="" preload="auto" width="50%" loop="" playsinline="">
<source src="/posts/leaf-widget/tap_widget.mp4" type="video/mp4"/><span>Your browser doesn&#39;t support embedded videos, but don&#39;t worry, you can <a href="https://kevintechnology.com/posts/leaf-widget/tap_widget.mp4">download it</a> and watch it with your favorite video player!</span></video><h2>How it Works<span><a href="#how-it-works" aria-label="Anchor">#</a></span></h2><p>To reduce the risk of any API-breaking changes, I‚Äôm just using the official NissanConnect app without any modifications:</p><ol><li>I created a GitHub repo containing a GitHub Action that:<ul><li>uses <a href="https://github.com/EFForg/apkeep" target="_blank"><code>apkeep</code></a> to download the NissanConnect app</li><li>uses <a href="https://appium.io/" target="_blank">Appium</a> to:<ul><li>install and launch the app on an Android device connected to the host via the Android Debugger (ADB)</li><li>automate tapping through the app‚Äôs screen to sign into the app using provided account credentials</li><li>scrape and output the text of the vehicle‚Äôs status after it refreshes
<a id="github-f4d12b676fe663c52327ee72818560aa" target="_blank" href="https://github.com/kevincon/nissan-connect-scraper"><div><div><p>kevincon/nissan-connect-scraper</p></div><p id="github-f4d12b676fe663c52327ee72818560aa-description">GitHub Action that scrapes the NissanConnect¬Æ Android app for info about a Nissan LEAF vehicle.</p></div></a></li></ul></li></ul></li><li>I created a separate GitHub repo containing a GitHub Actions workflow scheduled to run a job multiple times throughout the day that:<ul><li>uses <a href="https://tailscale.com/" target="_blank">Tailscale</a> to ephemerally connect the job‚Äôs GitHub runner host to a <a href="https://tailscale.com/kb/1136/tailnet" target="_blank">tailnet</a> on which there is already connected a <a href="https://en.wikipedia.org/wiki/Raspberry_Pi_4" target="_blank">Raspberry Pi 4B</a> with 2 GB RAM (sitting on my desk at home) that is running <a href="https://konstakang.com/devices/rpi4/AOSP15/" target="_blank">Android 15</a> with ADB turned on</li><li>connects to the Raspberry Pi via ADB</li><li>runs the GitHub Action from (1) using my Nissan account credentials stored in <a href="https://docs.github.com/en/actions/security-for-github-actions/security-guides/using-secrets-in-github-actions" target="_blank">GitHub Actions secrets</a></li><li>formats the scraped vehicle data and sends it in an email to <a href="https://ifttt.com/" target="_blank">IFTTT</a>
<a id="github-9bd3a31169b1be037950bc6e95acb758" target="_blank" href="https://github.com/kevincon/nissan-leaf-widget-updater"><div><div><p>kevincon/nissan-leaf-widget-updater</p></div><p id="github-9bd3a31169b1be037950bc6e95acb758-description">GitHub Actions workflow that runs on a schedule to update a widget on my phone with information about my Nissan LEAF.</p></div></a></li></ul></li><li>I created an Apple Shortcut on my iPhone named <code>OpenNissanConnect</code> that opens the NissanConnect app: <a href="https://www.icloud.com/shortcuts/fd139fa01719483a89fcbde391435ff7" target="_blank">https://www.icloud.com/shortcuts/fd139fa01719483a89fcbde391435ff7</a>
<picture><source srcset="/posts/leaf-widget/apple_shortcut_hu02aa61ae1d9de35cbe238d2676170cb9_120958_1178x717_resize_q75_h2_box.webp" type="image/webp"/><img src="https://kevintechnology.com/posts/leaf-widget/apple_shortcut.0700865d3f6127e7aa6d941879c3d0fb.jpg" alt="Apple shortcut configuration showing that it opens the NissanConnect EV &amp; Services app and then stops and outputs nothing&#34;" loading="lazy" height="717" width="1178"/></picture></li><li>I created a free IFTTT applet that triggers on the email sent by the workflow from (2) and displays the body of the email within a <a href="https://help.ifttt.com/hc/en-us/articles/115010361688-How-do-I-manage-or-add-new-widgets-on-my-device" target="_blank">‚ÄúNotification Widget‚Äù</a> on my iPhone‚Äôs home screen
<picture><source srcset="/posts/leaf-widget/ifttt_steps_hu385b88504cffe4ceca3bb8aec228cbc8_65368_1138x754_resize_q75_h2_box_3.webp" type="image/webp"/><img src="https://kevintechnology.com/posts/leaf-widget/ifttt_steps.fb839f138bfe4e6309c648765e617907.png" alt="IFTTT configuration showing the ‚ÄúIf‚Äù condition is ‚ÄúSend IFTTT an email tagged‚Äù and the ‚ÄúThen‚Äù action is ‚ÄúSend a rich notification to the IFTTT mobile widget‚Äù" loading="lazy" height="754" width="1138"/></picture></li></ol><p><picture><source srcset="/posts/leaf-widget/ifttt_email_config_hu010179562c2768a9dedd95755de8ab13_109284_944x1160_resize_q75_h2_box_3.webp" type="image/webp"/><img src="https://kevintechnology.com/posts/leaf-widget/ifttt_email_config.7ff94c9e5a7089ce89c395cb9d9260e4.png" alt="IFTTT configuration for the ‚ÄúThen‚Äù action, the Message is set to the Body of the email received, the title is set to ‚ÄúNissan LEAF¬Æ üçÉ‚Äù, and the Link URL is set to a TinyURL (described below). The optional Image URL field is left blank." loading="lazy" height="1160" width="944"/>
</picture>The <code>Link URL</code> field contains a <a href="https://tinyurl.com/" target="_blank">TinyURL</a> that redirects to <code>shortcuts://run-shortcut?name=OpenNissanConnect</code> which uses the <a href="https://support.apple.com/guide/shortcuts/run-a-shortcut-from-a-url-apd624386f42/ios" target="_blank">Shortcuts URL scheme</a> to run the Apple Shortcut from (3). I did this because IFTTT seems to check that the <code>Link URL</code> you provide actually resolves to a valid web URL; otherwise, the IFTTT website just opens and displays an error when you tap on the widget.</p><p>The NissanConnect app developers could definitely make changes that would break how this widget works, but those changes would by definition probably negatively affect regular human users too which I hope they would want to avoid.</p><h2>Future Work<span><a href="#future-work" aria-label="Anchor">#</a></span></h2><p>My original plan was to <a href="https://github.com/ReactiveCircus/android-emulator-runner" target="_blank">run an Android emulator on the GitHub Actions runner in the cloud</a> so I wouldn‚Äôt need to maintain my own Android device, and that <em>almost</em> works (in fact, it does work on my M3 Apple Silicon macOS laptop using an <code>arm</code> Android emulator), but it seems like the NissanConnect app (or maybe the server it connects to) may detect when <code>x86_64</code> Android is being used and then refuse to sign in. Or at least, I always saw the following error when I tried both in the cloud and on an old <code>x86_64</code> laptop I had:</p><p><picture><source srcset="/posts/leaf-widget/unauthorized_hu427daf76cdb694d7cbb4bae00ccd751d_85662_362651fbcfba6d2631859724bbf27163.webp" type="image/webp"/><img src="https://kevintechnology.com/posts/leaf-widget/unauthorized_hu427daf76cdb694d7cbb4bae00ccd751d_85662_400x0_resize_box_3.602121f903180517fe8c7266aa71c3c5.png" alt="Screenshot of Nissan Connect app sign in window with ‚Äú&lt; html &gt; &lt; head &gt; &lt; title &gt; Error&lt;/title &gt; &lt;/ head &gt; &lt; body &gt; Unauthorized&lt;/body&gt; &lt;/ html &gt;‚Äù error pop-up" loading="lazy" height="535" width="400"/></picture></p><p>And unfortunately, at the time of writing, I understand:</p><ol><li>a cloud VM environment must support nested virtualization in order to run an Android emulator with hardware acceleration</li><li>the only macOS <code>arm</code> runners GitHub provides are M1 and <a href="https://github.com/github/roadmap/issues/985" target="_blank">M2</a> machines, but <a href="https://developer.apple.com/documentation/virtualization/vzgenericplatformconfiguration/isnestedvirtualizationsupported#:~:text=Nested%20virtualization%20is%20available%20for%20Mac%20with%20the%20M3%20chip%2C%20and%20later." target="_blank">nested virtualization is only available on M3 and later</a></li><li>the only other <code>arm</code> runner GitHub supports is a <a href="https://github.blog/changelog/2025-01-16-linux-arm64-hosted-runners-now-available-for-free-in-public-repositories-public-preview/" target="_blank">Linux <code>arm64</code> runner</a> whose <a href="https://github.com/orgs/community/discussions/19197#discussioncomment-12012161" target="_blank">hardware does not support nested virtualization</a></li></ol><p>Luckily, the NissanConnect app has a ‚Äúdemo mode‚Äù that does not require signing into an account to use, so I was able to run an Android emulator in the cloud as part of <a href="https://github.com/kevincon/nissan-connect-scraper/blob/main/.github/workflows/prci.yml" target="_blank">the automated continuous integration testing for the GitHub Action</a>.</p><p>Maybe <a href="https://github.com/TryQuiet/quiet/issues/1879#issuecomment-2318276431" target="_blank">if GitHub Actions adds support for M3 Apple Silicon runners</a> in the future, then I might be able to switch to running all of this in the cloud for free‚Ä¶ ü§û</p><p>‚Ä¶or I might trade in my Nissan LEAF and get a different electric car with a better app experience before that happens. üòÖ</p></div></div>
  </body>
</html>
