<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://til.simonwillison.net/duckdb/remote-parquet">Original</a>
    <h1>Summing columns in remote Parquet files using DuckDB</h1>
    
    <div id="readability-page-1" class="page"><section>



<p><a href="https://huggingface.co/datasets/vivym/midjourney-messages" rel="nofollow">vivym/midjourney-messages</a> on Hugging Face is a large (~8GB) dataset consisting of 55,082,563 Midjourney images - each one with the prompt and a URL to the image hosted on Discord.</p>
<p>TLDR: Each record links to a Discord CDN URL, and the total size of all of those images is 148.07 TB - so Midjourney has cost Discord a LOT of money in CDN costs!</p>
<p>Read on for the details of how I figured this out.</p>
<p>Each of the records looks like this (converted to JSON):</p>
<div><pre>{
  <span>&#34;id&#34;</span>: <span><span>&#34;</span>1144508197969854484<span>&#34;</span></span>,
  <span>&#34;channel_id&#34;</span>: <span><span>&#34;</span>989268300473192561<span>&#34;</span></span>,
  <span>&#34;content&#34;</span>: <span><span>&#34;</span>**adult Goku in Dragonball Z, walking on a beach, in a Akira Toriyama anime style** - Image #1 &lt;@1016225582566101084&gt;<span>&#34;</span></span>,
  <span>&#34;timestamp&#34;</span>: <span><span>&#34;</span>2023-08-25T05:46:58.330000+00:00<span>&#34;</span></span>,
  <span>&#34;image_id&#34;</span>: <span><span>&#34;</span>1144508197693046875<span>&#34;</span></span>,
  <span>&#34;height&#34;</span>: <span>1024</span>,
  <span>&#34;width&#34;</span>: <span>1024</span>,
  <span>&#34;url&#34;</span>: <span><span>&#34;</span>https://cdn.discordapp.com/attachments/989268300473192561/1144508197693046875/anaxagore54_adult_Goku_in_Dragonball_Z_walking_on_a_beach_in_a__987e6fd5-64a1-43f6-83dd-c58d2eb42948.png<span>&#34;</span></span>,
  <span>&#34;size&#34;</span>: <span>1689284</span>
}</pre></div>
<p>The records are hosted on Hugging Face as Parquet files - 56 of them, each around 160MB. Here&#39;s <a href="https://huggingface.co/datasets/vivym/midjourney-messages/tree/main/data" rel="nofollow">the full list</a> - they&#39;re hosted in Git LFS, but Hugging Face also offers an HTTP download link.</p>
<p>I wanted to total up the <code>size</code> column there to see how space on Discord&#39;s CDN is taken up by these Midjourney images. But I didn&#39;t want to download all 8GB of data just to run that query.</p>
<p>DuckDB can query remotely hosted Parquet files and use HTTP Range header tricks to retrieve just the subset of data needed to answer a query. It should be able to sum up the <code>size</code> column without downloading the whole dataset.</p>
<p>The URL to each Parquet file looks like this (this actually redirects to a final URL, but DuckDB seems to be able to follow those redirects transparently):</p>
<pre><code>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000000.parquet
</code></pre>
<h2><a id="user-content-querying-a-single-file" aria-hidden="true" tabindex="-1" href="#querying-a-single-file"><span aria-hidden="true"></span></a>Querying a single file</h2>
<p>Here&#39;s a DuckDB query that calculates the sum of that <code>size</code> column without retrieving the entire file:</p>
<div><pre><span>SELECT</span> <span>SUM</span>(size) <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000000.parquet<span>&#39;</span></span>;</pre></div>
<p>Running that in the <code>duckdb</code> CLI tool gives me this result:</p>
<pre><code>┌───────────────┐
│   sum(size)   │
│    int128     │
├───────────────┤
│ 3456458790156 │
└───────────────┘
</code></pre>
<p>That&#39;s 3.14TB, just for the first file.</p>
<h2><a id="user-content-tracking-network-usage-with-nettop" aria-hidden="true" tabindex="-1" href="#tracking-network-usage-with-nettop"><span aria-hidden="true"></span></a>Tracking network usage with nettop</h2>
<p>How many bytes of data did that retrieve? We can find out on macOS using the <code>nettop</code> command.</p>
<p>First we need the PID of our <code>duckdb</code> process:</p>
<pre><code>ps aux | grep duckdb
simon            19992   0.0  0.0 408644352   1520 s114  S+    2:30PM   0:00.00 grep duckdb
simon            19985   0.0  0.0 408527616   4752 s118  S+    2:30PM   0:00.01 duckdb
</code></pre>
<p>Now we can run the following, before we execute that SQL query:</p>

<p>Then I ran the SQL query, and saw this in the output from <code>nettop</code>:</p>
<pre><code>5331 KiB
</code></pre>
<p>So DuckDB retrieved 5.3MB of data (from a file that was 159MB) to answer that query.</p>
<h2><a id="user-content-using-union-all" aria-hidden="true" tabindex="-1" href="#using-union-all"><span aria-hidden="true"></span></a>Using UNION ALL</h2>
<p>How about the total across all 56 files? I generated this <code>UNION ALL</code> query to answer that question:</p>
<div><pre><span>SELECT</span> <span>SUM</span>(size_total)
<span>FROM</span> (
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000000.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000001.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000002.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000003.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000004.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000005.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000006.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000007.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000008.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000009.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000010.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000011.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000012.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000013.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000014.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000015.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000016.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000017.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000018.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000019.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000020.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000021.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000022.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000023.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000024.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000025.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000026.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000027.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000028.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000029.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000030.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000031.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000032.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000033.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000034.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000035.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000036.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000037.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000038.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000039.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000040.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000041.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000042.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000043.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000044.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000045.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000046.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000047.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000048.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000049.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000050.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000051.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000052.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000053.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000054.parquet<span>&#39;</span></span> <span>UNION ALL</span>
    <span>SELECT</span> <span>SUM</span>(size) <span>as</span> size_total <span>FROM</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000055.parquet<span>&#39;</span></span>
);</pre></div>
<h2><a id="user-content-using-read_parquet" aria-hidden="true" tabindex="-1" href="#using-read_parquet"><span aria-hidden="true"></span></a>Using read_parquet()</h2>
<p><strong>Update:</strong> Alex Monahan <a href="https://twitter.com/__AlexMonahan__/status/1724605446689108459" rel="nofollow">tipped me off</a> to a more concise alternative for the same query:</p>
<div><pre><span>SELECT</span> <span>SUM</span>(size)
<span>FROM</span> read_parquet([
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000000.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000001.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000002.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000003.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000004.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000005.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000006.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000007.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000008.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000009.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000010.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000011.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000012.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000013.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000014.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000015.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000016.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000017.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000018.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000019.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000020.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000021.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000022.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000023.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000024.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000025.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000026.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000027.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000028.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000029.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000030.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000031.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000032.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000033.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000034.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000035.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000036.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000037.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000038.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000039.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000040.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000041.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000042.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000043.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000044.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000045.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000046.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000047.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000048.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000049.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000050.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000051.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000052.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000053.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000054.parquet<span>&#39;</span></span>,
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000055.parquet<span>&#39;</span></span>
]);</pre></div>
<p>This version displays a useful progress bar while the query is executing:</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://github.com/simonw/til/assets/9599/59dbc802-5fb7-4638-8248-9079a796811f"><img src="https://github.com/simonw/til/assets/9599/59dbc802-5fb7-4638-8248-9079a796811f" alt="The results of the query with a progress bar at 100%"/></a></p>
<h2><a id="user-content-using-list_transform" aria-hidden="true" tabindex="-1" href="#using-list_transform"><span aria-hidden="true"></span></a>Using list_transform()</h2>
<p><a href="https://twitter.com/adityawarmanfw/status/1724775939048182158" rel="nofollow">@adityawarmanfw shared</a> this much more elegant solution:</p>
<div><pre><span>SELECT</span>
    <span>SUM</span>(size) <span>AS</span> size
<span>FROM</span> read_parquet(
    list_transform(
        generate_series(<span>0</span>, <span>55</span>),
        n <span>-</span><span>&gt;</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/<span>&#39;</span></span> <span>||</span>
            format(<span><span>&#39;</span>{:06d}<span>&#39;</span></span>, n) <span>||</span> <span><span>&#39;</span>.parquet<span>&#39;</span></span>
    )
);</pre></div>
<p>This is using a <a href="https://duckdb.org/docs/sql/functions/nested.html#lambda-functions" rel="nofollow">DuckDB lambda function</a> - really neat!</p>
<p>To measure them, I ran a query in a fresh DuckDB instance with <code>nettop</code> watching the network traffic. Here&#39;s what that looked like while it was running:</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://github.com/simonw/til/assets/9599/6e7f1e07-4d76-43d7-a2b7-81daba8c99ca"><img src="https://github.com/simonw/til/assets/9599/6e7f1e07-4d76-43d7-a2b7-81daba8c99ca" alt="Animated GIF of nettop showing different connections being made and how much bandwidth is used for each one"/></a></p>
<p>The total data transferred was 287 MiB - still a lot of data, but a big saving on 8GB.</p>
<p>That&#39;s also around what I&#39;d expect for 56 files, given that a single file fetched 5.3MB earlier and 5.3 * 56 = 296.8.</p>
<h2><a id="user-content-the-end-result" aria-hidden="true" tabindex="-1" href="#the-end-result"><span aria-hidden="true"></span></a>The end result</h2>
<p>The result it gave me was:</p>
<pre><code>┌─────────────────┐
│ sum(size_total) │
│     int128      │
├─────────────────┤
│ 162800469938172 │
└─────────────────┘
</code></pre>
<p>That&#39;s 162800469938172 bytes - or 148.07 TB of CDN space used by Midjourney images!</p>
<p>(I got ChatGPT to build me a tool for converting bytes to KB/MB/GB/TB: <a href="https://til.simonwillison.net/tools/byte-size-converter" rel="nofollow">Byte Size Converter</a>.)</p>
<h2><a id="user-content-ctes-and-views-work-too" aria-hidden="true" tabindex="-1" href="#ctes-and-views-work-too"><span aria-hidden="true"></span></a>CTEs and views work too</h2>
<p>You can run this query using a CTE to make it nicer to read:</p>
<div><pre>with midjourney_messages <span>as</span> (
    <span>select</span>
        <span>*</span>
    <span>from</span> read_parquet(
        list_transform(
            generate_series(<span>0</span>, <span>2</span>),
            n <span>-</span><span>&gt;</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/<span>&#39;</span></span> <span>||</span>
                format(<span><span>&#39;</span>{:06d}<span>&#39;</span></span>, n) <span>||</span> <span><span>&#39;</span>.parquet<span>&#39;</span></span>
        )
    )
)
<span>select</span> <span>sum</span>(size) <span>as</span> size <span>from</span> midjourney_messages;</pre></div>
<p>(I used <code>generate_series(0, 2)</code> here instead of <code>(0, 55)</code> to speed up these subsequent experiments.)</p>
<p>Or you can define a view, which lets you refer to <code>midjourney_messages</code> in multiple queries. This is a bad idea though, as each time you execute the query against the view it will download the data again:</p>
<div><pre><span>create</span> <span>view</span> <span>midjourney_messages</span> <span>as</span>
<span>select</span> <span>*</span> <span>from</span> read_parquet(
    list_transform(
        generate_series(<span>0</span>, <span>2</span>),
        n <span>-</span><span>&gt;</span> <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/<span>&#39;</span></span> <span>||</span>
            format(<span><span>&#39;</span>{:06d}<span>&#39;</span></span>, n) <span>||</span> <span><span>&#39;</span>.parquet<span>&#39;</span></span>
    )
);</pre></div>
<p>Running <code>create view</code> here transferred 37 KiB according to <code>nettop</code> - presumably from loading metadata in order to be able to answer <code>describe</code> queries like this one:</p>
<div><pre>describe midjourney_messages;</pre></div>
<p>Output:</p>
<pre lang="wide"><code>┌─────────────┬─────────────┬─────────┬─────────┬─────────┬───────┐
│ column_name │ column_type │  null   │   key   │ default │ extra │
│   varchar   │   varchar   │ varchar │ varchar │ varchar │ int32 │
├─────────────┼─────────────┼─────────┼─────────┼─────────┼───────┤
│ id          │ VARCHAR     │ YES     │         │         │       │
│ channel_id  │ VARCHAR     │ YES     │         │         │       │
│ content     │ VARCHAR     │ YES     │         │         │       │
│ timestamp   │ VARCHAR     │ YES     │         │         │       │
│ image_id    │ VARCHAR     │ YES     │         │         │       │
│ height      │ BIGINT      │ YES     │         │         │       │
│ width       │ BIGINT      │ YES     │         │         │       │
│ url         │ VARCHAR     │ YES     │         │         │       │
│ size        │ BIGINT      │ YES     │         │         │       │
└─────────────┴─────────────┴─────────┴─────────┴─────────┴───────┘
</code></pre>
<p><code>nettop</code> confirmed that each time I ran this query:</p>
<div><pre><span>select</span> <span>count</span>(<span>*</span>) <span>from</span> midjourney_messages;</pre></div>
<p>Approximately 114 KiB of data was fetched.</p>
<h2><a id="user-content-parquet_metadata" aria-hidden="true" tabindex="-1" href="#parquet_metadata"><span aria-hidden="true"></span></a>parquet_metadata()</h2>
<p>chrisjc <a href="https://news.ycombinator.com/item?id=38271082#38298799" rel="nofollow">tipped me off</a> about the <code>parquet_metadata()</code> function, which can be used like this:</p>
<div><pre><span>select</span> <span>*</span> <span>from</span> parquet_metadata(
    <span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/000000.parquet<span>&#39;</span></span>
);</pre></div>
<p>That returns the following, after fetching 37 KiB:</p>
<pre lang="wide"><code>┌──────────────────────┬──────────────┬────────────────────┬───┬──────────────────┬──────────────────────┬──────────────────────┐
│      file_name       │ row_group_id │ row_group_num_rows │ … │ data_page_offset │ total_compressed_s…  │ total_uncompressed…  │
│       varchar        │    int64     │       int64        │   │      int64       │        int64         │        int64         │
├──────────────────────┼──────────────┼────────────────────┼───┼──────────────────┼──────────────────────┼──────────────────────┤
│ https://huggingfac…  │            0 │            1000000 │ … │           601280 │             13133418 │             23093988 │
│ https://huggingfac…  │            0 │            1000000 │ … │         13133571 │                  116 │                  112 │
│ https://huggingfac…  │            0 │            1000000 │ … │         13396455 │             46191873 │            208657682 │
│ https://huggingfac…  │            0 │            1000000 │ … │         59593218 │              9046231 │             36052113 │
│ https://huggingfac…  │            0 │            1000000 │ … │         68973087 │             13118570 │             23093988 │
│ https://huggingfac…  │            0 │            1000000 │ … │         81491806 │               498549 │               915584 │
│ https://huggingfac…  │            0 │            1000000 │ … │         81990515 │               496767 │               916607 │
│ https://huggingfac…  │            0 │            1000000 │ … │         82909448 │             71430496 │            180090922 │
│ https://huggingfac…  │            0 │            1000000 │ … │        154593238 │              5392260 │              8286381 │
├──────────────────────┴──────────────┴────────────────────┴───┴──────────────────┴──────────────────────┴──────────────────────┤
│ 9 rows                                                                                                   23 columns (6 shown) │
└───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<p>Since some of the columns here were truncated in the middle, I typed <code>.columns</code> to switch modes and ran the query again:</p>
<pre lang="wide"><code>┌──────────────────────┬─────────┬──────────────────────┬───┬──────────────────────┬──────────────────────┬──────────────────────┐
│        Column        │  Type   │        Row 1         │ … │        Row 7         │        Row 8         │        Row 9         │
├──────────────────────┼─────────┼──────────────────────┼───┼──────────────────────┼──────────────────────┼──────────────────────┤
│ file_name            │ varchar │  https://huggingfac… │ … │  https://huggingfac… │  https://huggingfac… │  https://huggingfac… │
│ row_group_id         │ int64   │                    0 │ … │                    0 │                    0 │                    0 │
│ row_group_num_rows   │ int64   │              1000000 │ … │              1000000 │              1000000 │              1000000 │
│ row_group_num_colu…  │ int64   │                    9 │ … │                    9 │                    9 │                    9 │
│ row_group_bytes      │ int64   │            481107377 │ … │            481107377 │            481107377 │            481107377 │
│ column_id            │ int64   │                    0 │ … │                    6 │                    7 │                    8 │
│ file_offset          │ int64   │             13133422 │ … │             82486423 │            153917026 │            159309733 │
│ num_values           │ int64   │              1000000 │ … │              1000000 │              1000000 │              1000000 │
│ path_in_schema       │ varchar │                   id │ … │                width │                  url │                 size │
│ type                 │ varchar │           BYTE_ARRAY │ … │                INT64 │           BYTE_ARRAY │                INT64 │
│ stats_min            │ varchar │                      │ … │                  256 │                      │                  312 │
│ stats_max            │ varchar │                      │ … │                 9408 │                      │             17937790 │
│ stats_null_count     │ int64   │                    0 │ … │                    0 │                    0 │                    0 │
│ stats_distinct_count │ int64   │                      │ … │                      │                      │                      │
│ stats_min_value      │ varchar │  1089054097631629352 │ … │                  256 │  https://cdn.discor… │                  312 │
│ stats_max_value      │ varchar │  1144508197969854484 │ … │                 9408 │  https://cdn.discor… │             17937790 │
│ compression          │ varchar │               SNAPPY │ … │               SNAPPY │               SNAPPY │               SNAPPY │
│ encodings            │ varchar │  PLAIN, RLE, RLE_DI… │ … │  PLAIN, RLE, RLE_DI… │  PLAIN, RLE, RLE_DI… │  PLAIN, RLE, RLE_DI… │
│ index_page_offset    │ int64   │                      │ … │                      │                      │                      │
│ dictionary_page_of…  │ int64   │                    4 │ … │             81989656 │             82486530 │            153917473 │
│ data_page_offset     │ int64   │               601280 │ … │             81990515 │             82909448 │            154593238 │
│ total_compressed_s…  │ int64   │             13133418 │ … │               496767 │             71430496 │              5392260 │
│ total_uncompressed…  │ int64   │             23093988 │ … │               916607 │            180090922 │              8286381 │
├──────────────────────┴─────────┴──────────────────────┴───┴──────────────────────┴──────────────────────┴──────────────────────┤
│ 9 rows  (4 shown)                                                                                                   23 columns │
└────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<p>Typing <code>.rows</code> switches the mode back to the default again.</p>
<h2><a id="user-content-the-same-trick-in-clickhouse" aria-hidden="true" tabindex="-1" href="#the-same-trick-in-clickhouse"><span aria-hidden="true"></span></a>The same trick in ClickHouse</h2>
<p>richraposa <a href="https://news.ycombinator.com/item?id=38271082#38271190" rel="nofollow">on Hacker News</a> pointed out that <a href="https://www.clickhouse.com/" rel="nofollow">ClickHouse</a> can do the same HTTP Range header trick:</p>
<div><pre><span>SELECT</span> <span>sum</span>(size)
    <span>FROM</span> url(<span><span>&#39;</span>https://huggingface.co/datasets/vivym/midjourney-messages/resolve/main/data/0000{01..55}.parquet<span>&#39;</span></span>)</pre></div>
<p>Output:</p>
<pre><code>┌───────sum(size)─┐
│ 159344011148016 │
└─────────────────┘

1 row in set. Elapsed: 11.615 sec. Processed 54.08 million rows, 8.50 GB (4.66 million rows/s., 731.83 MB/s.)
Peak memory usage: 458.88 KiB.
</code></pre>
<p>This transfers around 290 MiB,  effectively the same as DuckDB.</p>




  
  


<p>Created 2023-11-14T14:43:17-08:00, updated 2023-11-17T02:04:14-08:00 · <a href="https://github.com/simonw/til/commits/main/duckdb/remote-parquet.md">History</a> · <a href="https://github.com/simonw/til/blob/main/duckdb/remote-parquet.md">Edit</a></p>



</section></div>
  </body>
</html>
