<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/nickbild/tflite_c64">Original</a>
    <h1>TensorFlow Lite for Commodore 64</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">Run inferences using TensorFlow Lite for Microcontrollers on a Commodore 64.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://raw.githubusercontent.com/nickbild/tflite_c64/main/media/screen1_lg.jpg"><img src="https://raw.githubusercontent.com/nickbild/tflite_c64/main/media/screen1_lg.jpg" alt=""/></a></p>
<p dir="auto">This project is in no way associated with, or endorsed by, Google Inc.  TensorFlow, the TensorFlow logo and any related marks are trademarks of Google Inc.</p>
<h2 dir="auto"><a id="user-content-how-it-works" aria-hidden="true" href="#how-it-works"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>How It Works</h2>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://raw.githubusercontent.com/nickbild/tflite_c64/main/media/tflite-c64-overview.jpg"><img src="https://raw.githubusercontent.com/nickbild/tflite_c64/main/media/tflite-c64-overview.jpg" alt=""/></a></p>
<p dir="auto">TensorFlow Lite for Microcontrollers is an open-source machine learning framework in which a TensorFlow model is built and trained on a host computer.  That model is then reduced in size and computational complexity by an exporter that converts it to the TensorFlow Lite format.  For the tiniest of compute platforms — microcontrollers — that model is then converted to a C array containing the model structure and any trained parameters, like weights and biases.  On the microcontroller, an interpreter parses the C array to extract operations and data to run inferences against new input data.</p>
<p dir="auto">Given that TF Lite for Microcontrollers runs on some heavily resource-constrained devices, I got to wondering whether or not I could run inferences against these models on a Commodore 64.</p>
<p dir="auto">To do this, I chose not to use an interpreter.  The TF Lite Micro team explains why they did in <a href="https://arxiv.org/pdf/2010.08678.pdf" rel="nofollow">their paper</a> (i.e. portability, maintainability).  And that was a good choice for the project to be sure, but I&#39;m dealing with nearly 40 year old hardware, so I cannot afford the overhead of an interpreter.  Instead, I <a href="https://github.com/nickbild/tflite_c64/tree/main/tflite-micro">modified the TF Lite Micro source code</a> so that when running an interpreter on the host computer, it will emit all of the important details about the model, e.g.: operations to perform, filter values, biases, etc.  Additionally, I analyzed the source code for all operations involved with running the model so that I could reproduce the functionality.</p>
<p dir="auto">I then parsed that output with a <a href="https://github.com/nickbild/tflite_c64/blob/main/parse_output_c64.py">Python script</a> to turn it into C64-compatible BASIC (this could be updated to produce 6502 assembly code, but for this proof of concept, BASIC was actually fast enough).</p>
<p dir="auto">To test things out, I built TensorFlow&#39;s <a href="https://github.com/tensorflow/tflite-micro/tree/main/tensorflow/lite/micro/examples/hello_world">Hello World</a> example that builds and trains a small, 3 layer neural network that learns to approximate the sine function.  After running it on the host computer and emitting the model info, I used my parser to create <a href="https://github.com/nickbild/tflite_c64/blob/main/neural_net.bas">this BASIC code</a> that can be used to run arbitrary inferences against the neural network on a Commodore 64.  Each inference takes a few seconds to run on a physical C64 computer.</p>
<p dir="auto">Since the code running on the C64 is the same thing logically as what runs on the host computer (or microcontroller), it performs equally well in all environments.  There is no accuracy reduction from running on the C64.</p>
<h2 dir="auto"><a id="user-content-media" aria-hidden="true" href="#media"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Media</h2>
<p dir="auto"><a href="https://www.youtube.com/watch?v=D3Ii4mchgnA" rel="nofollow">YouTube Demonstration</a></p>
<p dir="auto">Should I be concerned about what my C64 is reading lately?</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://raw.githubusercontent.com/nickbild/tflite_c64/main/media/c64_book_sm.jpg"><img src="https://raw.githubusercontent.com/nickbild/tflite_c64/main/media/c64_book_sm.jpg" alt=""/></a></p>
<p dir="auto">Running a neural network trained to approximate the sine function on a Commodore 64:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://raw.githubusercontent.com/nickbild/tflite_c64/main/media/screen2_lg.jpg"><img src="https://raw.githubusercontent.com/nickbild/tflite_c64/main/media/screen2_lg.jpg" alt=""/></a></p>
<p dir="auto">A short sample of the generated C64 BASIC code (<a href="https://github.com/nickbild/tflite_c64/blob/main/neural_net.bas">full listing here</a>):</p>
<div data-snippet-clipboard-copy-content="10 dim l1(16)
20 dim l2(16)
30 input &#34;enter a number:&#34;; a%
40 a% = int((a% / 0.024574 - 128)+0.5)
50 acc = ((117 + 0) * (a% + 128)) + 6
60 if acc&gt;0 then acc=(acc*1169513172 + 2^30) / 2^31
70 if acc&lt;=0 then acc=(acc*1169513172 + (1-2^30)) / 2^31
80 acc = (int((acc)+0.5) / 2^6) + -128
90 acc = int((acc)+0.5)
100 if acc &lt; -128 then acc = -128
110 if acc &gt; 127 then acc = 127
120 l1(1) = acc
130 acc = ((28 + 0) * (a% + 128)) + 2935
140 if acc&gt;0 then acc=(acc*1169513172 + 2^30) / 2^31
150 if acc&lt;=0 then acc=(acc*1169513172 + (1-2^30)) / 2^31
160 acc = (int((acc)+0.5) / 2^6) + -128
170 acc = int((acc)+0.5)
180 if acc &lt; -128 then acc = -128
190 if acc &gt; 127 then acc = 127"><pre><code>10 dim l1(16)
20 dim l2(16)
30 input &#34;enter a number:&#34;; a%
40 a% = int((a% / 0.024574 - 128)+0.5)
50 acc = ((117 + 0) * (a% + 128)) + 6
60 if acc&gt;0 then acc=(acc*1169513172 + 2^30) / 2^31
70 if acc&lt;=0 then acc=(acc*1169513172 + (1-2^30)) / 2^31
80 acc = (int((acc)+0.5) / 2^6) + -128
90 acc = int((acc)+0.5)
100 if acc &lt; -128 then acc = -128
110 if acc &gt; 127 then acc = 127
120 l1(1) = acc
130 acc = ((28 + 0) * (a% + 128)) + 2935
140 if acc&gt;0 then acc=(acc*1169513172 + 2^30) / 2^31
150 if acc&lt;=0 then acc=(acc*1169513172 + (1-2^30)) / 2^31
160 acc = (int((acc)+0.5) / 2^6) + -128
170 acc = int((acc)+0.5)
180 if acc &lt; -128 then acc = -128
190 if acc &gt; 127 then acc = 127
</code></pre></div>
<h2 dir="auto"><a id="user-content-bill-of-materials" aria-hidden="true" href="#bill-of-materials"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Bill of Materials</h2>
<ul dir="auto">
<li>1 x Commodore 64 computer</li>
</ul>
<h2 dir="auto"><a id="user-content-about-the-author" aria-hidden="true" href="#about-the-author"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>About the Author</h2>
<p dir="auto"><a href="https://nickbild79.firebaseapp.com/#!/" rel="nofollow">Nick A. Bild, MS</a></p>
</article>
          </div></div>
  </body>
</html>
