<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mobeigi.com/blog/security/malware/the-curious-case-of-queencreek/">Original</a>
    <h1>The Curious Case of QUEENCREEK</h1>
    
    <div id="readability-page-1" class="page"><div>
<div>
<p>A lot of software on our machines (whether it be home desktops or enterprise servers) is designed to run automatically without manual triggers.</p>
<p>Great examples include:</p>
<ul>
<li>Vital system and user services like networking or time synchronisation during system boot-up.</li>
<li>Anti-virus or other security solutions starting quickly after boot-up.</li>
<li>Update checkers for critical software running every few hours.</li>
</ul>
<p>Unfortunately, software that runs automatically makes malware salivate uncontrollably.</p>

<p>On my Windows machine, I sometimes explore executables that are set to automatically run using Microsoft’s <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/autoruns" rel="nofollow">Sysinternals Autoruns</a>. Autoruns is a nifty tool that will show you all the registry entries, services, and tasks that are configured to trigger automatically.</p>
<p>During my inspection I managed to do some cleaning. I removed <strong>BaiduYunDetect </strong>from starting automatically. I use this app when I am downloading various files from the Baidu Cloud (often malware samples). Don’t worry it hasn’t mined any crypto on my system…yet. I disabled <strong>MicrosoftEdgeAutoLaunch</strong> since last time I used a Microsoft browser it was warning me about <a href="https://www.reddit.com/r/ProgrammerHumor/comments/37mih9/security_alert_you_are_about_to_view_pages_over_a/" rel="nofollow">viewing websites over a secure connection</a>. I also deleted some other entries that pointed to binaries that no longer existed due to uninstallations.</p>
<p>Autoruns makes it easy for you to spot potentially suspicious entries. If the binary being executed is not digitally signed by an authority that is trusted on your system, Autoruns highlights it with a red background (almost as if to shame it for merely existing).</p>

<p>However, it’s important to note there is nothing suspicious about these two red entries. <a href="https://ueli.app/" rel="nofollow">Ueli</a> and <a href="https://www.pushbullet.com/" rel="nofollow">Pushbullet</a> are two well-known and trusted projects. They just likely haven’t pursued digital verification by a trusted authority due to the associated costs. However, you can be almost certain that any malware that shows up here will not be digitally signed and verified.</p>

<p>All was going well, I was demolishing Autoruns entries like a system admin on their last day.</p>
<p>Until…I ran into QUEENCREEK.</p>
<p><img decoding="async" src="https://mobeigi.com/blog/uploads/QUEENCREEK-autoruns-entry.png" alt="QUEENCREEK Autoruns Entry" width="1292" height="45" srcset="https://mobeigi.com/blog/uploads/QUEENCREEK-autoruns-entry.png 1292w, https://mobeigi.com/blog/uploads/QUEENCREEK-autoruns-entry-300x10.png 300w, https://mobeigi.com/blog/uploads/QUEENCREEK-autoruns-entry-1024x36.png 1024w, https://mobeigi.com/blog/uploads/QUEENCREEK-autoruns-entry-768x27.png 768w, https://mobeigi.com/blog/uploads/QUEENCREEK-autoruns-entry-900x31.png 900w" sizes="(max-width: 1292px) 100vw, 1292px"/></p>
<p>Perhaps the biggest fear in this endeavour is finding an application that you do not recognise. You have to decide if it’s malicious or not and how it got there. That is not always trivial. But hang on, this is a <strong>Verified</strong> digitally signed binary. I propose we distribute it far and wide and run it as Administrator on our main database host.</p>
<p>Not so fast!</p>
<p>Malware developers know that both humans and anti virus software inspect Autoruns entries. Therefore, they use various techniques to hide their intent. One of the most common techniques is to use a trusted application in the Autoruns entry that then triggers their malicious executable. In this case, we see an entry for 

<span id="crayon-66c2d351d707e603029109"><span>Wscript.exe</span></span> which is a legitimate binary by Microsoft that is used to execute other scripts (typically VBScript and Javascript). Therefore, it is no surprise to discover it is digitally signed and verified.</p>
<p>The entry is a Task Scheduler entry, so we can open it there to view its associated <strong>actions</strong>.</p>
<p><img decoding="async" src="https://mobeigi.com/blog/uploads/QUEENCREEK-task-scheduler-entry.png" alt="QUEENCREEK Task Scheduler Entry" width="1008" height="219" srcset="https://mobeigi.com/blog/uploads/QUEENCREEK-task-scheduler-entry.png 1008w, https://mobeigi.com/blog/uploads/QUEENCREEK-task-scheduler-entry-300x65.png 300w, https://mobeigi.com/blog/uploads/QUEENCREEK-task-scheduler-entry-768x167.png 768w, https://mobeigi.com/blog/uploads/QUEENCREEK-task-scheduler-entry-900x196.png 900w" sizes="(max-width: 1008px) 100vw, 1008px"/></p>
<p>The plot thickens! We see this task is scheduled to trigger at logon, indefinitely.</p>
<p>The only action for the task is to use 

<span id="crayon-66c2d351d7084750331576"><span>WScript</span></span> to trigger 

<span id="crayon-66c2d351d7086087310365"><span>task.vbs</span></span> in batch mode with no logo (meaning no output is shown) :</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->


<div id="crayon-66c2d351d7087266367889" data-settings=" minimize scroll-mouseover">

<div>
<table>
<tbody><tr>
<td data-settings="show">

</td>
<td><div><p><span>&#34;C:\WINDOWS\System32\Wscript.exe&#34;</span><span> </span>//<span>B</span><span> </span>//<span>NoLogo</span><span> </span><span>&#34;C:\Program Files\Intel\SUR\QUEENCREEK\x64\task.vbs&#34;</span></p></div></td>
</tr>
</tbody></table>
</div>
</div>
<!-- [Format Time: 0.0007 seconds] -->
<p>In other words, 

<span id="crayon-66c2d351d7088794078278"><span>task.vbs</span></span> is silently triggered.</p>
<p>The observant amongst us will notice this seems to be located in a directory belonging to Intel (

<span id="crayon-66c2d351d7089102788729"><span>C:\Program Files\Intel</span></span>). It is another common malware detection circumvention technique to store malicious binaries in trusted directories often belonging to trusted applications. This could work out well for the malware in the case that directory is excluded from real time scanning or security solutions think the malware belongs with its cohabitant binaries.</p>
<p>Next, we explore the contents of 

<span id="crayon-66c2d351d708b918583325"><span>task.vbs</span></span> :</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->


<div id="crayon-66c2d351d708c867334934" data-settings=" minimize scroll-mouseover">

<div>
<table>
<tbody><tr>
<td data-settings="show">

</td>
<td><div><p><span>Set</span><span> </span><span>objShell</span><span> </span>=<span> </span><span>CreateObject</span><span>(</span><span>&#34;WScript.Shell&#34;</span><span>)</span><span> </span></p><p><span>objShell</span><span>.</span><span>Run</span><span>(</span><span>&#34;C:\WINDOWS\System32\cmd.exe /c &#34;</span><span>&#34;C:\Program Files\Intel\SUR\QUEENCREEK\x64\task.bat&#34;</span><span>&#34;&#34;</span><span>)</span><span>,</span><span> </span><span>0</span><span> </span></p><p><span>Set</span><span> </span><span>objShell</span><span> </span>=<span> </span><span>Nothing</span><span> </span></p></div></td>
</tr>
</tbody></table>
</div>
</div>
<!-- [Format Time: 0.0004 seconds] -->
<p>Now this is what I would call a completely useless script. All this script does is invoke 

<span id="crayon-66c2d351d708d500389644"><span>WScript</span></span> again to invoke 

<span id="crayon-66c2d351d708e547885684"><span>cmd</span></span> and run a new file 

<span id="crayon-66c2d351d708f303077578"><span>task.bat</span></span>. This is another technique often used by malware in which it will pursue random or pointless execution (even if it’s just sleeping or looping to burn CPU cycles) to try and throw off anti-virus software.</p>
<p>Alas, we move on to the infamous 

<span id="crayon-66c2d351d7090785821277"><span>task.bat</span></span> where surely the mystery is solved:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->


<div id="crayon-66c2d351d7091941210820" data-settings=" minimize scroll-mouseover">

<div>
<table>
<tbody><tr>
<td data-settings="show">

</td>
<td><div><p><span>&#34;C:\Program Files\Intel\SUR\QUEENCREEK\x64\task.exe&#34;</span></p></div></td>
</tr>
</tbody></table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>Womp womp. This batch file does nothing but call a 

<span id="crayon-66c2d351d7092960099851"><span>task.exe</span></span>.</p>
<p>Finally, we arrive at the end of our little story.</p>
<p>We analyse our 

<span id="crayon-66c2d351d7093056997403"><span>task.exe</span></span> executable and notice that…it’s digitally signed by Intel Corporation:</p>
<p><img loading="lazy" decoding="async" src="https://mobeigi.com/blog/uploads/QUEEENCREEK-task-exe-digital-signature.png" alt="QUEEENCREEK task exe digital signature" width="540" height="671" srcset="https://mobeigi.com/blog/uploads/QUEEENCREEK-task-exe-digital-signature.png 540w, https://mobeigi.com/blog/uploads/QUEEENCREEK-task-exe-digital-signature-241x300.png 241w" sizes="(max-width: 540px) 100vw, 540px"/></p>
<p>At this point, I do some research online to discover that this is not a malicious binary at all.</p>

<p>An Intel engineer must have read the project name as <strong>QUEENCRACK</strong> and confused their nightly black hat activities with their day job.</p>
<p>Using 

<span id="crayon-66c2d351d7094126357804"><span>WScript</span></span> in a Task Scheduler entry to invoke a 

<span id="crayon-66c2d351d7095512664924"><span>VBS</span></span> which invokes 

<span id="crayon-66c2d351d7096422450123"><span>WScript</span></span> to invoke 

<span id="crayon-66c2d351d7097251204704"><span>cmd</span></span> to invoke a 

<span id="crayon-66c2d351d7098251519745"><span>Batch</span></span> file which finally invokes an executable is madness. It mimics several techniques commonly used by actual malware. Furthermore, it opens the door for malware to “join the party” and replicate this exact setup but with a malicious payload. This ends up confusing end users and anti-virus engine heuristics. It’s also not a surprise these files are scanned regularly on Virus Total (<a href="https://www.virustotal.com/gui/file/04a1e7de2b15c744101c064a276a20a1ee1febcbafe1f87112840f14e9706f48/details" rel="nofollow">task.vbs</a>, <a href="https://www.virustotal.com/gui/file/e5583c6ceee07043bd10b978815f5608dcaad1d0e9619670d80357f07eaa6f5b/details" rel="nofollow">task.bat</a>, <a href="https://www.virustotal.com/gui/file/5c6c61de91323d8bb5027333b75e9ebfca4e42c5141fd440daed5011943c2545/details" rel="nofollow">task.exe</a>).</p>
</div>

</div></div>
  </body>
</html>
