<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mljar.com/blog/automated-reports-python/">Original</a>
    <h1>Automated PDF Reports with Python Notebooks</h1>
    
    <div id="readability-page-1" class="page"><div>

		
		
		<p><img src="https://notebook.wesleyac.com/blog/automated-reports-python/banner.jpg" alt="Automated Reports Python banner"/> Python is a great tool for automation, almost magical. In this article I will show you how to build automated reporting system with Python. The system will create a daily PDF report and send it via email. I will use Python notebook (with <a href="https://jupyter.org/"><code>Jupyter Notebook</code></a>) and <a href="https://github.com/mljar/mercury"><code>Mercury</code></a> framework for PDF generation, scheduling and email sending.</p>

<p>The tasks that our automated reporting system will do:</p>
<ul>
  <li>fetch stock market data, display news, price chart and analysis,</li>
  <li>execute every day from Monday to Friday at 9:00 AM,</li>
  <li>convert executed notebook to PDF and send in the email attachment.</li>
</ul>

<p>The notebook automations are created with an open-source <a href="https://github.com/mljar/mercury"><code>Mercury</code></a> framework. They are achieved with <strong>4 lines of code</strong>! The reporting system can be run locally. However, I will deploy it to the cloud (Heroku) in this artcile. The web application is available online at <a href="https://automated-pdf-reports.herokuapp.com">automated-pdf-reports.herokuapp.com</a>. All code is on the GitHub at <a href="https://github.com/pplonski/automated-pdf-reports-python">github.com/pplonski/automated-pdf-reports-python</a>. The demo of the reporting web application is below:</p>

<p><img src="https://github.com/pplonski/automated-pdf-reports-python/raw/main/media/report-to-pdf.gif" alt="Automated PDF Reports in Python"/></p>

<p>Email with PDF report in the attachment (it was send automatically):</p>

<p><img src="https://notebook.wesleyac.com/blog/automated-reports-python/email-with-pdf-report.png" alt="Email with PDF Report"/></p>

<p>I hope that this article will help you to build your own automated reporting system in Python. In case any questions please contact me with the following <a href="https://forms.gle/EjqYi3ttEkZkuKy46">form</a>. ðŸ˜Š</p>

<h2 id="setup-local-environment">Setup local environment</h2>

<p>Letâ€™s start with creating a GitHub project (please create a new repository on the <a href="https://github.com">GitHub</a> website). All my code is on <a href="https://github.com/pplonski/automated-pdf-reports-python">github.com/pplonski/automated-pdf-reports-python</a>. The first step is to clone the project:</p>

<div><div><pre><code>git clone git@github.com:pplonski/automated-pdf-reports-python.git
</code></pre></div></div>

<p>The next step is to create a <code>requirements.txt</code> file with Python packages that we will use:</p>

<div><div><pre><code>mljar-mercury
yfinance
mplfinance
</code></pre></div></div>

<p>We will need the <code>requirements.txt</code> when deploying the notebook to the cloud. (Donâ€™t worry, it will be easy). The next step is to create a virtual environment:</p>

<div><div><pre><code># create virtual environment
virtualenv reportenv

# activate the env
source reportenv/bin/activate

# install packages
pip install -r requirements.txt
</code></pre></div></div>

<p>The <code>reportenv</code> is the name of the virtual environment. The last step is to set our new virtual environment as Jupyter kernel, so we can use it in the Jupyter Notebook when creating a new notebook.</p>

<div><div><pre><code>python -m ipykernel install --user --name reportenv
</code></pre></div></div>

<h2 id="python-notebook">Python notebook</h2>

<p>The environment is ready. We can start work on Python notebook. The notebook will fetch the latest stock data with <a href="https://github.com/ranaroussi/yfinance"><code>yfinance</code></a> package. It is using Yahoo Finance API. Next, the notebook will display list of recent news, plot a finance chart with <a href="https://github.com/matplotlib/mplfinance"><code>mplfinance</code></a> and display analysis.</p>

<p>Letâ€™s start a Jupyter Notebook and create a new notebook <code>report.ipynb</code>. Please remember to select the <code>reportenv</code> kernel.</p>

<div><div><pre><code># start jupyter notebook
jupyter notebook
</code></pre></div></div>

<p>As usual, the first step is to import all required packages (I wish I could automatize this one day):</p>

<div><div><pre><code><span>import</span> <span>yfinance</span> <span>as</span> <span>yf</span>
<span>import</span> <span>mplfinance</span> <span>as</span> <span>mpf</span>
<span>from</span> <span>IPython.display</span> <span>import</span> <span>Markdown</span> <span>as</span> <span>md</span>
<span>from</span> <span>datetime</span> <span>import</span> <span>datetime</span>
</code></pre></div></div>

<p>The data presented in the notebook will be controlled with two variables:</p>

<div><div><pre><code><span>ticker</span> <span>=</span> <span>&#34;TSLA&#34;</span>
<span>period</span> <span>=</span> <span>&#34;3mo&#34;</span>
</code></pre></div></div>

<p>We will use <code>ticker</code> variable to select the stock. The <code>period</code> is a variable that controls the history length. It will be directly used in the <code>yfinance</code> package.</p>

<p>Letâ€™s start with a good header. It will show <code>ticker</code> and a current day. Displaying header will be a little tricky. I will contrcut a string with header and use <code>IPython.display.Markdown</code> to display it as a Markdown.</p>

<div><div><pre><code><span>md</span><span>(</span><span>f</span><span>&#34;# {ticker} Report {datetime.now().strftime(&#39;</span><span>%</span><span>m-</span><span>%</span><span>d-</span><span>%</span><span>Y&#39;)}&#34;</span><span>)</span>
</code></pre></div></div>

<p>Please notice that the cell is still a <strong>code</strong> type and Iâ€™m using <code>#</code> for making a header - Markdown syntax inside a string.</p>

<p><img src="https://notebook.wesleyac.com/blog/automated-reports-python/display-header-markdown.png" alt="Display header as markdown"/></p>

<p>Fetching the stock data is done in two lines of Python code:</p>

<div><div><pre><code><span>d</span> <span>=</span> <span>yf</span><span>.</span><span>Ticker</span><span>(</span><span>ticker</span><span>)</span>
<span>history</span> <span>=</span> <span>d</span><span>.</span><span>history</span><span>(</span><span>period</span><span>=</span><span>period</span><span>)</span>
</code></pre></div></div>

<p>Isnâ€™t it amazing? Recent news are in JSON format and are availble as <code>news</code> member variable. Letâ€™s construct the string with list of news:</p>

<div><div><pre><code><span>content</span> <span>=</span> <span>&#34;&#34;</span>
<span>for</span> <span>n</span> <span>in</span> <span>d</span><span>.</span><span>news</span><span>:</span>
    <span>content</span> <span>+=</span> <span>f</span><span>&#34;&#34;&#34; - [{n[&#34;title&#34;]}]({n[&#34;link&#34;]}) by {n[&#34;publisher&#34;]}</span><span>\n</span><span>&#34;&#34;&#34;</span>
</code></pre></div></div>

<p>Displaying string as Markdown in the Jupyter Notebook:</p>



<p><img src="https://notebook.wesleyac.com/blog/automated-reports-python/display-news-markdown.png" alt="Display news list as markdown"/></p>

<p>Letâ€™s plot some data. Creating a financial chart with <code>mplfinance</code> is super easy:</p>

<div><div><pre><code><span>mpf</span><span>.</span><span>plot</span><span>(</span><span>history</span><span>,</span> <span>type</span><span>=</span><span>&#39;candle&#39;</span><span>,</span> <span>mav</span><span>=</span><span>(</span><span>7</span><span>),</span><span>figratio</span><span>=</span><span>(</span><span>18</span><span>,</span><span>10</span><span>))</span>
</code></pre></div></div>

<p><img src="https://notebook.wesleyac.com/blog/automated-reports-python/display-chart.png" alt="Display financial chart with mplfinance"/></p>

<p>The <code>yfinance</code> provides analysis and financial details for stocks. They can be easily accessed as Pandas DataFrames.</p>



<p><img src="https://notebook.wesleyac.com/blog/automated-reports-python/display-analysis.png" alt="Display analysis DataFrame"/></p>



<p><img src="https://notebook.wesleyac.com/blog/automated-reports-python/display-financials.png" alt="Display financials DataFrame"/></p>

<p>OK, the notebook with financial report is ready. It should look like in the image below:</p>

<p><img src="https://notebook.wesleyac.com/blog/automated-reports-python/notebook.png" alt="Notebook with financial report"/></p>

<p>All code is created, bad news is that we canâ€™t share the report in the current shape. The code should be hidden and the notebook should be converted to PDF (Portable Document Format) so it can be open on any operating system. Good news is that it can be easily done with <a href="https://notebook.wesleyac.com/mercury"><code>Mercury</code></a> framework.</p>



<p>Letâ€™s use the <a href="https://notebook.wesleyac.com/mercury"><code>Mercury</code></a> framework to make our notebook shareable:</p>

<ul>
  <li>make it interactive with <code>ticker</code> and <code>period</code> as select widgets,</li>
  <li>hide code to not scare non-technical shareholders,</li>
  <li>easily convert to PDF format,</li>
  <li>schedule a daily execution with email notifiction and PDF report in the attachment.</li>
</ul>

<p>The above features can be achieved by adding a <strong>RAW</strong> cell at the beginning of the notebook with the YAML configuration:</p>

<div><div><pre><code><span>---</span>
<span>title</span><span>:</span> <span>Financial report</span>
<span>description</span><span>:</span> <span>Stock financial report</span>
<span>schedule</span><span>:</span> <span>&#39;</span><span>0</span><span> </span><span>9</span><span> </span><span>*</span><span> </span><span>*</span><span> </span><span>1-5&#39;</span>
<span>notify</span><span>:</span>
    <span>on_success</span><span>:</span> <span>contact@mljar.com</span>
    <span>attachment</span><span>:</span> <span>pdf</span>
<span>show-code</span><span>:</span> <span>False</span>
<span>params</span><span>:</span>
    <span>ticker</span><span>:</span>
        <span>input</span><span>:</span> <span>select</span>
        <span>label</span><span>:</span> <span>Select a ticker</span>
        <span>value</span><span>:</span> <span>TSLA</span>
        <span>choices</span><span>:</span> <span>[</span><span>TSLA</span><span>,</span> <span>TWTR</span><span>,</span> <span>MSFT</span><span>,</span> <span>SNOW</span><span>,</span> <span>PLTR</span><span>,</span> <span>NFLX</span><span>]</span>
    <span>period</span><span>:</span>
        <span>input</span><span>:</span> <span>select</span>
        <span>label</span><span>:</span> <span>Select period</span>
        <span>value</span><span>:</span> <span>3mo</span>
        <span>choices</span><span>:</span> <span>[</span><span>1mo</span><span>,</span> <span>2mo</span><span>,</span> <span>3mo</span><span>,</span> <span>6mo</span><span>,</span> <span>12mo</span><span>,</span> <span>24mo</span><span>]</span>
<span>---</span>
</code></pre></div></div>

<p>The YAML contains:</p>
<ul>
  <li><code>title</code> and <code>description</code> of the report,</li>
  <li><code>schedule</code> parameter controls the time interval at which the notebook will be executed, it is set with crontab string,</li>
  <li><code>notify</code> parameter defines the list of email addresses that will receive notification after successful notebook execution, the <code>attachment</code> defines the format of the report,</li>
  <li><code>show-code</code> hides the code in the notebook,</li>
  <li><code>params</code> addes two select widgets that are directly connected to variables <code>ticker</code> and <code>period</code>. You can check more widget types in the Mercuryâ€™s <a href="https://mercury-docs.readthedocs.io/en/latest/widgets/">documentation</a>.</li>
</ul>

<p>The notebook with YAML header should look like in the image below:</p>

<p><img src="https://notebook.wesleyac.com/blog/automated-reports-python/notebook-with-yaml.png" alt="Notebook with YAML header for Mercury"/></p>

<p>To check how it is working locally you can run:</p>



<p>It will start a local server. Please open the web browser with address <a href="http://127.0.0.1:8000"><code>127.0.0.1:8000</code></a>, you should see the <code>Mercury</code> web service running. You can tweak widgets values and execute the notebook with new parameters with <code>Run</code> button:</p>

<p><img src="https://github.com/pplonski/automated-pdf-reports-python/raw/main/media/interactive-report.gif" alt="Notebook as web application"/></p>

<h2 id="deployment">Deployment</h2>

<p>We will deploy the <code>Mercury</code> in the cloud server to run it automatically on daily basis. I will use Heroku for demo purposes. You can check guides for deployment in other clouds in the <a href="https://mercury-docs.readthedocs.io/en/latest/deploy/deployment/">documentation</a>. Iâ€™m using Heroku CLI tool.</p>

<p>Letâ€™s create a new Heroku app:</p>

<div><div><pre><code>heroku create automated-pdf-reports
</code></pre></div></div>

<p>The next step is to add <code>Procfile</code> that configures how Heroku execute our code:</p>

<div><div><pre><code>web: mercury run 0.0.0.0:$PORT
</code></pre></div></div>

<p>We need to push all files to the GitHub repository:</p>

<div><div><pre><code>git add report.ipynb
git add requirements.txt
git add Procfile
git commit -am &#34;add notebook&#34;
git push
</code></pre></div></div>

<p>Deployment to the cloud is done with one command:</p>



<p>Please wait a while and you should see <code>Mercury</code> web application running. My app is running at <a href="https://automated-pdf-reports.herokuapp.com">automated-pdf-reports.herokuapp.com</a>.</p>

<p>We need do configure email settings to enable notifications sending. Additionally, we will set a <code>TIME_ZONE</code> to set email notification in my timezone. We need to define following environment variables:</p>

<div><div><pre><code>EMAIL_HOST
EMAIL_HOST_PASSWORD
EMAIL_HOST_USER
EMAIL_PORT
DEFAULT_FROM_EMAIL
TIME_ZONE
</code></pre></div></div>

<p>The example values can be:</p>

<div><div><pre><code>EMAIL_HOST=smtp.gmail.com
EMAIL_HOST_PASSWORD=app-password
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_PORT=587
DEFAULT_FROM_EMAIL=your-email@gmail.com
TIME_ZONE=Europe/Warsaw
</code></pre></div></div>

<p>Iâ€™m setting the environment variables in the <code>Settings</code> tab in the Heroku dashboard, below is the screenshot:</p>

<p><img src="https://notebook.wesleyac.com/blog/automated-reports-python/heroku-config-vars.png" alt="Set config variables in Heroku to enable email sending"/></p>

<p>Exporting notebook to PDF requires a Puppeteer buildpack:</p>

<div><div><pre><code>https://github.com/jontewks/puppeteer-heroku-buildpack
</code></pre></div></div>

<p>Please add it in the Heroku dashboard (it should be available below config vars):</p>

<p><img src="https://notebook.wesleyac.com/blog/automated-reports-python/heroku-buildpack.png" alt="Add puppeteer buildpack to enable notebook export to PDF"/></p>

<p>OK, we will need to deploy the app again to see the changes. This can be done by updating a notebook. In my case I will add a <code>welcome.md</code> message to the <code>Mercury</code> web application. It will be a custom message availabe in the home view. You can read more about welcome message in the <a href="https://mercury-docs.readthedocs.io/en/latest/welcome/">documentation</a>.</p>

<p>Deployment of updated app can be done with:</p>



<p>Thatâ€™s all! ðŸ˜Š Now letâ€™s wait for automatic PDF reports. They will be delivered to the email address in the attachement.</p>

<p><img src="https://notebook.wesleyac.com/blog/automated-reports-python/email-with-pdf-report.png" alt="Email with PDF Report"/></p>

<h2 id="summary">Summary</h2>

<p>The Jupyter Notebook gives a WYSIWYG editor for report building. The <a href="https://notebook.wesleyac.com/mercury"><code>Mercury</code></a> framework makes additional work of making interactive widgets, code hidding, scheduling, exporting to PDF, sending email notifications. Both tools makes a perfect combination for creating automatic reporting systems.</p>

<ul>
  <li>Python code used in the article is available at <a href="https://github.com/pplonski/automated-pdf-reports-python">github.com/pplonski/automated-pdf-reports-python</a></li>
  <li>Web application for with scheduled notebook and email notifications with PDF notebooks is available online on <a href="https://automated-pdf-reports.herokuapp.com/">automated-pdf-reports.herokuapp.com</a></li>
</ul>

<p>If you have any questions or need help please subscribe to the newsletter below. In the form, you can leave feedback, comment, or question. We do our best to respond quickly :)</p>

		
		


		<div>
			<h3>Articles you might find interesing</h3>
			
				
		

				


				



		</div>



		
		<hr/>
		<div>
			<h3>ðŸ’Œ Join our newsletter ðŸ’Œ</h3>
			
			<p>
						Subscribe to our newsletter to receive product updates
					</p>
		
			
		</div>
		
		<!-- <hr />

		<div style="padding-bottom: 20px;">
			<div class="container flex blog-mljar-connect ">
			</div>
			<div style="text-align: center; padding: 20px">
				<div class="dark-button " style="display: inline; padding: 8px">
					<a href="https://www.linkedin.com/in/piotr-plonski-mljar/" target="_blank">
						 
						Connect with Piotr
					</a>
				</div>

				<div class="dark-button " style="display: inline; padding: 8px">
					<a href="https://www.linkedin.com/in/aleksandra-p%C5%82o%C5%84ska-42047432/" target="_blank">
						 
						Connect with Ola
					</a>
				</div>

				
			</div>
		</div> -->

		<hr/>
		<div>
			<section>
				

				<a href="https://github.com/mljar/mercury" target="_blank">
					
					<img src="https://notebook.wesleyac.com/images/mercury/mercury_banner_down.png"/> 
				</a>
				<div>
					<h3>Share your Python Notebooks with others</h3>
					</div>

			</section>
		</div>

		


		<!-- <hr />
		<div style="box-shadow: 12px black;">
			<section>
				<div style="text-align: center;">
					<h3>Check our open-source AutoML framework for tabular data!</h3>
					<br />
					<div class="dark-button " style="padding-bottom: 60px;">
						<a href="https://github.com/mljar/mljar-supervised" target="_blank">Check on GitHub!</a>
					</div>
				</div>

				<a href="https://github.com/mljar/mljar-supervised" target="_blank">
					<div class="container flex blog-mljar-section ">
					</div>
				</a>

			</section>
		</div> -->


	</div></div>
  </body>
</html>
