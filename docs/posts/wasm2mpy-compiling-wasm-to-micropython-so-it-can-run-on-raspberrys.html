<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/vshymanskyy/wasm2mpy">Original</a>
    <h1>Wasm2Mpy: Compiling WASM to MicroPython so it can run on Raspberrys</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto"><a href="https://github.com/vshymanskyy/StandWithUkraine/blob/main/docs/README.md"><img src="https://raw.githubusercontent.com/vshymanskyy/StandWithUkraine/main/badges/StandWithUkraine.svg" alt="StandWithUkraine"/></a>
<a href="https://github.com/vshymanskyy/wasm2mpy/actions"><img src="https://camo.githubusercontent.com/6a6da405649549c1ac48af3e74b0fd27f0459df346957d6d1427e2b847a86d66/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f616374696f6e732f776f726b666c6f772f7374617475732f767368796d616e736b79792f7761736d326d70792f6275696c642e796d6c3f6272616e63683d6d61696e267374796c653d666c61742d737175617265266c6f676f3d676974687562266c6162656c3d6275696c64" alt="Build status" data-canonical-src="https://img.shields.io/github/actions/workflow/status/vshymanskyy/wasm2mpy/build.yml?branch=main&amp;style=flat-square&amp;logo=github&amp;label=build"/></a>
<a href="https://github.com/vshymanskyy/wasm2mpy"><img src="https://camo.githubusercontent.com/cd0bfc1f47fd7a02efde25ce2186a8fdf66484289931c5528cc3f728cd6006be/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f6c6963656e73652d4d49542d626c75653f7374796c653d666c61742d737175617265" alt="GitHub license" data-canonical-src="https://img.shields.io/badge/license-MIT-blue?style=flat-square"/></a>
<a href="https://quicknote.io/da0a7d50-bb49-11ec-936a-6d7fd5a2de08" rel="nofollow"><img src="https://camo.githubusercontent.com/bd0bb0d5954efe05e3a6097318ec99620925824b11bbac227377dae8ad6d1f8c/68747470733a2f2f696d672e736869656c64732e696f2f7374617469632f76313f6c6162656c3d737570706f7274266d6573736167653d25453225394425413426636f6c6f723d253233666538653836" alt="Support vshymanskyy" data-canonical-src="https://img.shields.io/static/v1?label=support&amp;message=%E2%9D%A4&amp;color=%23fe8e86"/></a></p>
<p dir="auto">Compile <code>WebAssembly</code> binary into a <code>MicroPython</code> module and load it dynamically on ESP32, Raspberry Pi Pico, STM32, nRF52 etc.</p>

<markdown-accessiblity-table><table>
<thead>
<tr>
<th>App \ Target</th>
<th>x86/x64</th>
<th>armv6m</th>
<th>armv7m/+s/+d</th>
<th>esp8266<sup><a href="#user-content-fn-2-117f17d078895e44f4b04a180162b4eb" id="user-content-fnref-2-117f17d078895e44f4b04a180162b4eb" data-footnote-ref="" aria-describedby="footnote-label">1</a></sup></th>
<th>esp32</th>
<th>rv32imc</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸš€ TypeScript<sup><a href="#user-content-fn-1-117f17d078895e44f4b04a180162b4eb" id="user-content-fnref-1-117f17d078895e44f4b04a180162b4eb" data-footnote-ref="" aria-describedby="footnote-label">2</a></sup></td>
<td>âœ…âœ…</td>
<td>âœ…</td>
<td>âœ…âœ…âœ…</td>
<td><g-emoji alias="warning">âš ï¸</g-emoji><sup><a href="#user-content-fn-4-117f17d078895e44f4b04a180162b4eb" id="user-content-fnref-4-117f17d078895e44f4b04a180162b4eb" data-footnote-ref="" aria-describedby="footnote-label">3</a></sup></td>
<td>âœ…</td>
<td>ğŸš§</td>
</tr>
<tr>
<td>ğŸ¤© C++</td>
<td>âœ…âœ…</td>
<td>âœ…</td>
<td>âœ…âœ…âœ…</td>
<td>ğŸŸ¡</td>
<td>âœ…</td>
<td>ğŸš§</td>
</tr>
<tr>
<td>ğŸ¦€ Rust</td>
<td>âœ…âœ…</td>
<td>âœ…</td>
<td>ğŸŸ¡ğŸŸ¡âœ…</td>
<td><g-emoji alias="warning">âš ï¸</g-emoji><sup><a href="#user-content-fn-4-117f17d078895e44f4b04a180162b4eb" id="user-content-fnref-4-2-117f17d078895e44f4b04a180162b4eb" data-footnote-ref="" aria-describedby="footnote-label">3</a></sup></td>
<td>âœ…</td>
<td>ğŸš§</td>
</tr>
<tr>
<td>ğŸ¤– TinyGo</td>
<td>âœ…âœ…</td>
<td>âœ…</td>
<td>ğŸŸ¡ğŸŸ¡âœ…</td>
<td><g-emoji alias="warning">âš ï¸</g-emoji><sup><a href="#user-content-fn-4-117f17d078895e44f4b04a180162b4eb" id="user-content-fnref-4-3-117f17d078895e44f4b04a180162b4eb" data-footnote-ref="" aria-describedby="footnote-label">3</a></sup></td>
<td>âœ…</td>
<td>ğŸš§</td>
</tr>
<tr>
<td>âš¡ Zig</td>
<td>âœ…âœ…</td>
<td>âœ…</td>
<td>âœ…âœ…âœ…</td>
<td><g-emoji alias="warning">âš ï¸</g-emoji><sup><a href="#user-content-fn-4-117f17d078895e44f4b04a180162b4eb" id="user-content-fnref-4-4-117f17d078895e44f4b04a180162b4eb" data-footnote-ref="" aria-describedby="footnote-label">3</a></sup></td>
<td>âœ…</td>
<td>ğŸš§</td>
</tr>
<tr>
<td>âœ¨ Virgil</td>
<td>âœ…âœ…</td>
<td>âœ…</td>
<td>âœ…âœ…âœ…</td>
<td>ğŸŸ¡</td>
<td>âœ…</td>
<td>ğŸš§</td>
</tr>
<tr>
<td>âš™ WAT</td>
<td>âœ…âœ…</td>
<td>âœ…</td>
<td>âœ…âœ…âœ…</td>
<td>ğŸŸ¡</td>
<td>âœ…</td>
<td>ğŸš§</td>
</tr>
<tr>
<td>ğŸ‡¨ Coremark</td>
<td>âœ…âœ…</td>
<td>ğŸš§</td>
<td>âœ…âœ…âœ…</td>
<td>ğŸŸ¡</td>
<td>âœ…</td>
<td>ğŸš§</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto">âœ… builds and runs OK</p>

<ul dir="auto">
<li><strong>STM32F405</strong> 168MHz: <code>233.918</code></li>
<li><strong>ESP32</strong> 240MHz: <code>228.363</code></li>
<li><strong>ESP32-S3</strong> 240MHz: <code>271.573</code></li>
<li><strong>iMXRT1062</strong> 600MHz: <code>1911.437</code></li>
<li><strong>i5-8250U</strong> 1.6GHz: <code>18696.248</code></li>
</ul>

<div dir="auto"><p dir="auto"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</p><p dir="auto"><strong>This is a Proof-of-Concept, not optimized or ready for actual use.</strong></p>
</div>
<p dir="auto">You&#39;ll need:</p>
<ul dir="auto">
<li>Python 3
<ul dir="auto">
<li><code>pip install --upgrade pyelftools ar</code></li>
</ul>
</li>
<li><code>wasm2c</code> from <a href="https://github.com/WebAssembly/wabt/releases/tag/1.0.36">WABT</a></li>
<li>Latest <a href="https://github.com/micropython/micropython">MicroPython</a> source code</li>
<li>Target architecture toolchain</li>
</ul>
<p dir="auto">Set up the environment and build the <code>.mpy</code> module from <code>.wasm</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="export MPY_DIR=/path/to/micropython
export PATH=/opt/wabt/bin:$PATH
export PATH=/opt/xtensa-lx106-elf/bin:$PATH
export PATH=/opt/xtensa-esp32-elf/bin:$PATH
pip install -U pyelftools
make ARCH=xtensawin APP=zig   # x86, x64, armv6m, armv7m, armv7emsp, armv7emdp, xtensa, xtensawin"><pre><span>export</span> MPY_DIR=/path/to/micropython
<span>export</span> PATH=/opt/wabt/bin:<span>$PATH</span>
<span>export</span> PATH=/opt/xtensa-lx106-elf/bin:<span>$PATH</span>
<span>export</span> PATH=/opt/xtensa-esp32-elf/bin:<span>$PATH</span>
pip install -U pyelftools
make ARCH=xtensawin APP=zig   <span><span>#</span> x86, x64, armv6m, armv7m, armv7emsp, armv7emdp, xtensa, xtensawin</span></pre></div>
<p dir="auto">Output:</p>
<div data-snippet-clipboard-copy-content="W2C test/zig.wasm
GEN build/zig.config.h
CC runtime/runtime.c
CC runtime/wasm-rt-mem-impl.c
CC runtime/wasm-rt-impl.c
CC .wasm/wasm.c
LINK build/runtime/runtime.o
arch:         EM_XTENSA
text size:    3524
rodata size:  850
bss size:     144
GOT entries:  57
GEN zig.mpy"><pre lang="log"><code>W2C test/zig.wasm
GEN build/zig.config.h
CC runtime/runtime.c
CC runtime/wasm-rt-mem-impl.c
CC runtime/wasm-rt-impl.c
CC .wasm/wasm.c
LINK build/runtime/runtime.o
arch:         EM_XTENSA
text size:    3524
rodata size:  850
bss size:     144
GOT entries:  57
GEN zig.mpy
</code></pre></div>

<div dir="auto" data-snippet-clipboard-copy-content="mpremote cp zig.mpy :lib/
mpremote exec &#34;import zig; zig.setup()&#34;
âš¡ Zig is running!"><pre>mpremote cp zig.mpy :lib/
mpremote <span>exec</span> <span><span>&#34;</span>import zig; zig.setup()<span>&#34;</span></span>
âš¡ Zig is running<span>!</span></pre></div>
<div dir="auto"><h2 tabindex="-1" dir="auto">Run any exported function</h2><a id="user-content-run-any-exported-function" aria-label="Permalink: Run any exported function" href="#run-any-exported-function"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div dir="auto"><p dir="auto"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p><p dir="auto">This requires adding some glue code to the runtime.</p>
</div>
<p dir="auto">For example, <code>test/simple.wasm</code> just adds 2 numbers:</p>
<div dir="auto" data-snippet-clipboard-copy-content="(module
    (func (export &#34;add&#34;) (param i32 i32) (result i32)
        (i32.add (local.get 0) (local.get 1))
    )
)"><pre>(<span>module</span>
    (<span>func</span> (<span>export</span> <span><span>&#34;</span>add<span>&#34;</span></span>) (<span>param</span> <span>i32</span> <span>i32</span>) (<span>result</span> <span>i32</span>)
        (<span>i32.add</span> (<span>local.get</span> <span>0</span>) (<span>local.get</span> <span>1</span>))
    )
)</pre></div>
<div data-snippet-clipboard-copy-content="MicroPython v1.24.0-preview.224.g6c3dc0c0b on 2024-08-22; Raspberry Pi Pico W with RP2040
Type &#34;help()&#34; for more information.
&gt;&gt;&gt; import simple
&gt;&gt;&gt; simple.add(3, 4)
7
&gt;&gt;&gt; simple.add(10, 6)
16"><pre lang="log"><code>MicroPython v1.24.0-preview.224.g6c3dc0c0b on 2024-08-22; Raspberry Pi Pico W with RP2040
Type &#34;help()&#34; for more information.
&gt;&gt;&gt; import simple
&gt;&gt;&gt; simple.add(3, 4)
7
&gt;&gt;&gt; simple.add(10, 6)
16
</code></pre></div>
<div dir="auto"><h2 tabindex="-1" dir="auto">Access WASM module memory</h2><a id="user-content-access-wasm-module-memory" aria-label="Permalink: Access WASM module memory" href="#access-wasm-module-memory"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div dir="auto" data-snippet-clipboard-copy-content="&gt;&gt;&gt; import cpp
&gt;&gt;&gt; cpp.setup()
ğŸ¤© C++ is running!
&gt;&gt;&gt; cpp._memory[4096:4096+32]
bytearray(b&#39; Blink\x00\xf0\x9f\xa4\xa9 C++ is running!\x00\n\x00\x00\x00&#39;)
&gt;&gt;&gt; new_data = b&#34;Hello C++ world&#34;
&gt;&gt;&gt; cpp._memory[4096+12:4096+12+len(new_data)] = new_data
&gt;&gt;&gt; cpp.setup()
ğŸ¤© Hello C++ world"><pre><span>&gt;&gt;</span><span>&gt;</span> <span>import</span> <span>cpp</span>
<span>&gt;&gt;</span><span>&gt;</span> <span>cpp</span>.<span>setup</span>()
ğŸ¤© <span>C</span><span>+</span><span>+</span> <span>is</span> <span>running</span>!
<span>&gt;&gt;</span><span>&gt;</span> <span>cpp</span>.<span>_memory</span>[<span>4096</span>:<span>4096</span><span>+</span><span>32</span>]
<span>bytearray</span>(<span>b&#39; Blink<span>\x00</span><span>\xf0</span><span>\x9f</span><span>\xa4</span><span>\xa9</span> C++ is running!<span>\x00</span><span>\n</span><span>\x00</span><span>\x00</span><span>\x00</span>&#39;</span>)
<span>&gt;&gt;</span><span>&gt;</span> <span>new_data</span> <span>=</span> <span>b&#34;Hello C++ world&#34;</span>
<span>&gt;&gt;</span><span>&gt;</span> <span>cpp</span>.<span>_memory</span>[<span>4096</span><span>+</span><span>12</span>:<span>4096</span><span>+</span><span>12</span><span>+</span><span>len</span>(<span>new_data</span>)] <span>=</span> <span>new_data</span>
<span>&gt;&gt;</span><span>&gt;</span> <span>cpp</span>.<span>setup</span>()
ğŸ¤© <span>Hello</span> <span>C</span><span>+</span><span>+</span> <span>world</span></pre></div>

<p dir="auto">The idea is very similar to <a href="https://github.com/wasm3/embedded-wasm-apps">embedded-wasm-apps</a>:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/wasm3/embedded-wasm-apps/blob/main/docs/how-it-works.png?raw=1"><img src="https://github.com/wasm3/embedded-wasm-apps/raw/main/docs/how-it-works.png?raw=1" alt="image"/></a></p>

<ul>
<li> Support exports
<ul>
<li> Auto-generate exports bindings</li>
</ul>
</li>
<li> Support imports</li>
<li> Support memory</li>
<li> <a href="https://github.com/micropython/micropython/pull/15838" data-hovercard-type="pull_request" data-hovercard-url="/micropython/micropython/pull/15838/hovercard">Support <code>.a</code> inputs for <code>mpy_ld</code></a></li>
<li> <a href="https://github.com/micropython/micropython/pull/8381#issuecomment-2363022985" data-hovercard-type="pull_request" data-hovercard-url="/micropython/micropython/pull/8381/hovercard">XIP for native modules</a></li>
<li> TBD: Support globals</li>
<li> Add RISC-V support: <a data-error-text="Failed to load title" data-id="2449275303" data-permission-text="Title is private" data-url="https://github.com/micropython/micropython/issues/15603" data-hovercard-type="pull_request" data-hovercard-url="/micropython/micropython/pull/15603/hovercard" href="https://github.com/micropython/micropython/pull/15603">micropython/micropython#15603</a></li>
<li> Optimize codegen
<ul>
<li> Use <code>u32</code> instead of <code>u64</code> for mem addresses</li>
<li> Use a directly addressable <code>.bss</code> section as memory (skip indirection)</li>
</ul>
</li>
<li> Implement <a href="https://github.com/WebAssembly/custom-page-sizes/blob/main/proposals/custom-page-sizes/Overview.md">WASM Custom Page Sizes</a></li>
<li> Implement WASM Exceptions</li>
<li> Implement <a href="https://github.com/WebAssembly/stack-switching/blob/main/proposals/stack-switching/Explainer.md">WASM Stack Switching</a></li>
</ul>

<ul dir="auto">
<li><a href="https://github.com/orgs/micropython/discussions/15702">Discussion</a> on <code>wasm2mpy</code></li>
<li><a href="https://github.com/WebAssembly/wabt/blob/main/wasm2c/README.md">wasm2c</a>, <a href="https://github.com/turbolent/w2c2">w2c2</a></li>
<li>MicroPython <a href="https://docs.micropython.org/en/latest/develop/natmod.html" rel="nofollow">Native Modules</a></li>
<li><a href="https://github.com/micropython/micropython/issues/15270#issuecomment-2280942885" data-hovercard-type="issue" data-hovercard-url="/micropython/micropython/issues/15270/hovercard">Feasibility of WASM for MicroPython</a></li>
</ul>
<section data-footnotes="">
<ol dir="auto">
<li id="user-content-fn-2-117f17d078895e44f4b04a180162b4eb">
<p dir="auto"><code>esp8266</code> requires the use of <a href="https://github.com/micropython/micropython/issues/14430#issuecomment-2332648018"><code>esp.set_native_code_location</code></a>, and setting <code>WASM_PAGE_SIZE</code> to <code>8192</code> (or need to wait for <a href="https://github.com/WebAssembly/custom-page-sizes/blob/main/proposals/custom-page-sizes/Overview.md"><code>WASM Custom Page Sizes</code></a>) <a href="#user-content-fnref-2-117f17d078895e44f4b04a180162b4eb" data-footnote-backref="" aria-label="Back to reference 1">â†©</a></p>
</li>
<li id="user-content-fn-1-117f17d078895e44f4b04a180162b4eb">
<p dir="auto"><a href="https://www.assemblyscript.org">AssemblyScript</a> <a href="#user-content-fnref-1-117f17d078895e44f4b04a180162b4eb" data-footnote-backref="" aria-label="Back to reference 2">â†©</a></p>
</li>
<li id="user-content-fn-4-117f17d078895e44f4b04a180162b4eb">
<p dir="auto">not enough memory to run, need to wait for <a href="https://github.com/WebAssembly/custom-page-sizes/blob/main/proposals/custom-page-sizes/Overview.md"><code>WASM Custom Page Sizes</code></a> <a href="#user-content-fnref-4-117f17d078895e44f4b04a180162b4eb" data-footnote-backref="" aria-label="Back to reference 3">â†©</a> <a href="#user-content-fnref-4-2-117f17d078895e44f4b04a180162b4eb" data-footnote-backref="" aria-label="Back to reference 3-2">â†©<sup>2</sup></a> <a href="#user-content-fnref-4-3-117f17d078895e44f4b04a180162b4eb" data-footnote-backref="" aria-label="Back to reference 3-3">â†©<sup>3</sup></a> <a href="#user-content-fnref-4-4-117f17d078895e44f4b04a180162b4eb" data-footnote-backref="" aria-label="Back to reference 3-4">â†©<sup>4</sup></a></p>
</li>
</ol>
</section>
</article></div></div>
  </body>
</html>
