<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tukaani.org/xz-backdoor/review.html">Original</a>
    <h1>XZ Utils Review Notes</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>Trivial commits like updates to THANKS or typo fixes in comments
aren’t mentioned here.</p>
<p>The months refer to commit date, not author date.</p>
<div>
<h3 id="_2023_08">2023-08</h3>

<p>OK.</p>
<hr/>

<p>OK.</p>
<hr/>

<p>OK.</p>
<hr/>

<p>This was pondered for a while and determined that
<em>in practice</em> the only problem was an assertion failure
(but assertions rarely are enabled for production code).
A proper fix was good to do still.</p>
<hr/>

<p>The diff might appear misleading.
The intent is to move the comment but
diff shows it as a move of the <code>lzma_index_end</code> call.</p>
</div>
<div>
<h3 id="_2023_09">2023-09</h3>

<p>OK.</p>
<hr/>

<p>OK.</p>
<hr/>
<p>From</p>
<p>These are OK, including getopt.m4 which was simplified a lot.
xz doesn’t need support for all corner cases of getopt_long so
checking for those corner cases isn’t needed either.</p>
<p>The GNU getopt_long isn’t used on GNU/Linux, *BSDs, Solaris, or MinGW-w64.</p>
<hr/>
<p>From</p>
<p>This was an overdue change.
It’s also done properly (I verified it back then as well).
It missed one change around in <code>CLOCK_MONOTONIC</code> but
that turned out to be mildly convenient as it
avoided a simple merge conflict with <a href="https://github.com/tukaani-project/xz/commit/1c1a8c3ee4dad0064dbe63b8dbc4ac4bc679f419">Build: Check for clock_gettime() even if not using POSIX threads.</a>.</p>
<p>To verify these commits, the following can be helpful:</p>
<div>
<div>
<pre>git diff ce162db07f03^..9fb5de41f2fb \
    | sed &#34;/^-/{s/\`/&#39;/g;s/^-/+/}&#34; \
    | grep ^+ | sort | uniq -u</pre>
</div>
</div>
</div>
<div>
<h3 id="_2023_10">2023-10</h3>

<p>It matches the file in Gnulib.</p>
<hr/>


<p>The final version is fine.</p>
<hr/>


<p>This attribute is obviously scary but it is unfortunately required
with the x86 SIMD code.
The code makes aligned 16-byte reads which may read up to 15
bytes before the beginning or past the end of the buffer
if the buffer is misaligned.
The unneeded bytes are then ignored.
It cannot cross page boundaries and thus cannot cause access violations.</p>
<p>The correctness is easy to review because memory is read only in a few places.
If you do this, I suggest looking at the latest code in the master branch
as that is the code that is actually in use now.</p>
<hr/>

<p>OK.</p>
<hr/>

<p>OK.</p>
<hr/>

<p>OK.</p>
</div>
<div>
<h3 id="_2023_11">2023-11</h3>

<p>OK.</p>
<hr/>
<p>From</p>
<p>In <code>v5.4</code> these were squashed into these commits:</p>
<p>It’s simplest to review this as a whole.
It was a a bit hilarious series of commits in the master branch
as I had spotted a regression that was introduced in
<a href="https://github.com/tukaani-project/xz/commit/cc5aa9ab138beeecaee5a1e81197591893ee9ca0">xz: Refactor duplicated check for custom suffix when using --format=raw</a>.
We discussed it and gave ideas about the fix and
then it turned out to be a bit wrong and needing another fix until
he thought it’s better to finish it another day.
Then the test script was added as well.</p>
<hr/>

<p>These are good although I clarified a comment in the next commit.
It fixed a very old bug in Windows build of xz.</p>
<hr/>

<p>Ifunc detection was causing issues with musl.
This seems fine but ifunc support was removed in
<a href="https://github.com/tukaani-project/xz/commit/689ae2427342a2ea1206eb5ca08301baf410e7e0">liblzma: Remove ifunc support.</a> so this
doesn’t matter anymore anyway.</p>
<hr/>

<p>It really is just space change, no dots.</p>
<hr/>
</div>
<div>
<h3 id="_2023_12">2023-12</h3>
<p>From</p>
<p>These are from <a href="https://github.com/tukaani-project/xz/pull/73">PR #73</a>
and have been merged correctly with cleanups to commit messages and
white space usage.</p>
<hr/>

<p>OK. Needed one minor comment fix.</p>
<hr/>

<p>OK.</p>
<hr/>

<p>The URL is correct.</p>
<hr/>

<p>OK. <code>options</code> definitely must not be <code>NULL</code>,
and in practice it never is because
it would be a bug in the application too.</p>
<hr/>

<p>OK, just like the commit message says.</p>
<hr/>


<p>The bug isn’t as serious as the commit message makes it sound
as no one has a reason to call <code>lzma_filters_update</code> on a LZMA1 encoder,
a function that is very rarely used anyway.</p>
<hr/>

<p>The order of the macros in the <code>#if</code> directive is different from
src/xz/sandbox.h but the directive is correct still.</p>
<p>The Capsicum code is slightly simpler and stricter than in xz
because xzdec needs to do less.
Silently running without sandbox when kernel support is missing (<code>ENOSYS</code>)
is an intentional feature:
without this, on such kernels xz wouldn’t run at all.</p>
<hr/>

<p>OK.</p>
<hr/>

<p>This moves code around and edits it a little.
Comparing the moved sections shows it’s fine including the small edits.
No suspicious typos (like mispelling <code>SANDBOX_COMPILE_DEFINITION</code>)
are apparent.</p>
<hr/>
</div>
<div>
<h3 id="_2024_01">2024-01</h3>

<p>The <code>riscv.c</code> file in this commit was almost solely written by me and
matched the file I had outside of the Git tree.
Jia had some minor work on it like adding macros to avoid repeated code
and a few comment improvements.
Those I reviewed and edited further.</p>
<p>The rest of the commit was by Jia.
Those changes are good.</p>
<hr/>

<p>OK.</p>
<hr/>

<p>This is the first commit preparing for the backdoor.</p>
<hr/>

<p>It’s very similar to the ARM64 code below the new code.</p>
<hr/>

<p>I did author these.</p>
<hr/>

<p>This is fine although now that the backdoor has been removed,
this commit alone doesn’t do anything.
But I left it there so that it’s ready <em>if</em> proper files along with
a generator program are added.</p>
<hr/>

<p>I had mentioned the dictionary size and that gave a good excuse
to update something in the backdoor code.</p>
<hr/>

<p>OK.</p>
<hr/>
<p>From</p>
<p>There is some churn in these commits so it’s simplest to review only
the final outcome.</p>


<hr/>
</div>
<div>
<h3 id="_2024_02">2024-02</h3>

<p>OK.</p>
<hr/>

<p>OK.</p>
<hr/>

<p>These are good and were created at my request.
They are big but it’s hard to split them into smaller pieces.
The original versions of these are from 2023-04-24.
I made small edits but it was agreed that I would commit these in his name.</p>
<p>Since these commits are complex, it’s understandable if they look scary.
The new code does input buffer bounds checking only once per loop iteration,
checking that there is at least 21 bytes available.
At first this may look insufficient because, in the worst case,
<code>rc_normalize</code> may be executed up to 48 times (22 bit model + 26 direct)
per loop iteration.
Each <code>rc_normalize</code> macro will read one input byte if needed.
However, the condition to read a new byte cannot be true everytime.
This has been verified both with math and experimentally.
Comments in the code about this could be improved.</p>
<p>The small edits I made included fixing an off-by-one error with
the loop condition.
The commit originally had 20 but I changed it to 21 because
the final normalization after the end of payload marker (EOPM) was
included in the non-resumable path.
The next commit by me (<a href="https://github.com/tukaani-project/xz/commit/e0c0ee475c0800c08291ae45e0d66aa00d5ce604">liblzma: LZMA decoder improvements.</a>)
made the non-resumable variant jump to the safe code (<code>goto eopm</code>)
instead and thus 21 was changed to 20.</p>
<p>XZ Embedded has had somewhat comparable code with the per-loop 20-byte check
since the beginning (2009) and it’s been in the Linux kernel since 2010.</p>
<p>As most of the core compression code in XZ Utils,
the original idea for this detail comes from LZMA SDK.
It’s just fairly different-looking code.</p>
<hr/>

<p>Modified build-to-host.m4 had the backdoor trigger.
Ignoring the file here is correct because it is added
among several other .m4 files
when running <code>./autogen.sh</code> or <code>autoreconf -fi</code>.</p>
<hr/>

<p>OK.</p>
<hr/>

<p>This is correct.</p>
<hr/>

<p>I didn’t like the extra macro that had been added solely for this test.
The last commit does more than reverting a single commit but the change is OK.</p>
<hr/>

<p>This test assumes that the encoder output doesn’t change, that is,
the test will will fail if the encoder is modified too much.
If the encoder is modified, updating the test to match isn’t much extra to do.</p>
<hr/>

<p>Backdoor files.</p>
<p>Note that tests/test_files.sh uses globs to pick the files.
So just adding files means that a decompression test will be done with them.</p>
<hr/>

<p>We discussed this and I agreed to it.
This way man page translations didn’t need to go via translators
in the last days of the release rush to fix a typo in the English source text.</p>
<hr/>

<p>The symbol name was supposed to be <code>XZ_5.6</code> not <code>XZ_5.6.0</code>.
It makes no difference in practice as it is merely a string.</p>
<hr/>

<p>OK.
He liked to run codespell while I didn’t.</p>
<hr/>

<p>He fixed it because I noticed it.
Clearly the test file had been written some time ago already.</p>
<hr/>

<p>OK.</p>
<hr/>


<hr/>

<p>The need to add this fix had been discussed.</p>
<hr/>

<p>This was discussed in length with multiple people.
The commit matches what was decided.</p>
<hr/>
</div>
<div>
<h3 id="_2024_03">2024-03</h3>

<p>This is <a href="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=114115#c12">a real bug</a>
but the bug number in the commit message lacks one digit.</p>
<hr/>

<p>It’s one of the backdoor commits.</p>
<hr/>

<p>More backdoor commits.</p>
<hr/>

<p>This is a continuation for <a href="https://github.com/tukaani-project/xz/commit/eee579fff50099ba163c12305e81a4bd42b7dd53">xz: Add missing RISC-V on the filter list in the man page</a>.
Almost always it’s not good to touch
the translations without upstream approval.
In this case I felt mixed as I wondered
if the date translations would be correct
but didn’t want to stop it so that the translation could be in the 5.6.1
release that was going to be made the same day.</p>
<p>When translations are sent to the translators,
they will remake these changes anyway (they only pick
the original English text from the tarball).</p>
<hr/>

<p>I got the impression that a lot of speculation happened around this commit.</p>
<p>I had asked Jia to simplify the GitHub PR and Issue templates already,
and simplifying <code>SECURITY.md</code> seemed reasonable too.
People reporting such bugs don’t need detailed handholding.</p>
<p>I felt 21–30 days would be appropriate but Jia wanted to keep 90.
With backdoor like “bugs”,
fast full disclosure is the only correct way though.</p>
</div>
</div></div>
  </body>
</html>
