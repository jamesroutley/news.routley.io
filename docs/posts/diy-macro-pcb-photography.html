<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://niemczuk.tech/2024/02/11/detailed-macrophotography-of-PCBs">Original</a>
    <h1>DIY Macro PCB Photography</h1>
    
    <div id="readability-page-1" class="page"><div>
    <p>I had to create scans of a small flex PCB to capture more details than a flat scanner could give me.
Of course, this task turned out harder than I imagined.
I already had a good camera, but I was lacking a good macro lens.
Buying one turned out to be hard because the highest magnification ratios on most macro lenses are 1:1.
The better ones are, of course, pricier.</p>


<p>After browsing some extreme macrophotography forums, I discovered that some people use microscope objectives with their cameras.</p>

<div>
    <figure>
        <img src="https://niemczuk.tech/2024/02/11/thorninger-setup.jpg" alt="Image of an infinite microscope lens mounted on a camera setup" width="100%"/>
        <figcaption>An infinite microscope (silver element on the left) lens mounted on a camera. Source: <a href="https://thorninger.com/eng/extrememacro2.html">Thorninger.com</a></figcaption>
    </figure>
</div>



<p>Those microscope objectives are divided into two groups: infinity-corrected and non-infinity-corrected.
What does this mean?
The non-infinity-corrected objective focuses the captured image on a plane some distance after the objective.
The infinity-corrected objective collimates the captured light into a parallel beam.
The second type is useful if you need to Fourier transform the image by transparency masks or do other fancy scientific image transformations.
Filtering light is easier if you work with a parallel beam.
To use this type of objective in macrophotography, you need an additional lens to focus the parallel beam to an image on the sensor plane.</p>

<p>The first type of microscope objective can be used directly with your interchangeable lens camera.
The only thing you need is an extension tube, which can be 3D printed in an hour.
I found a great <a href="https://www.thingiverse.com/thing:5130912">Thingiverse repository</a> that contains extension tubes for microscopic objectives with various camera mounts.
Together with the cheapest 4X non-infinity-corrected, achromatic microscope objective gives decent results.</p>




<p>And now the hardest part.
I spent a few days taking pictures of different PCBs to stitch them into a bigger picture.
Messing up this step will lead to more errors later.
My advice is to fix your camera at a distance at which your object is in focus and then move your object in a specific way.
Scan your object in a linear way, incrementing only one dimension (X or Y) at a time, as illustrated in the image below.
Your next picture should overlap with your previous one by 30% - 50%.
If you are using a full-frame camera, try to use it in crop mode or just make smaller movements.
This way, you will be using only the sharpest and least distorted image of your microscope lens.
<strong>And remember, good and uniform lighting is everything.</strong></p>

<p><img src="https://niemczuk.tech/2024/02/11/scan-pattern.svg" alt="Scan pattern of your camera" width="60%"/></p>


<p>You can use JPEGs straight out of the camera, but I like to process my RAW files in <a href="https://www.darktable.org/">darktable</a>.
It can be useful to set the correct exposure and contrast at this stage because, after stitching, changing those parameters can further enhance seams on the final image.
<em>Whatever you do, do not reduce noise or add noise in highlight correction because this will reduce the alignment coefficients in Hugin.</em>
I usually further crop the images to remove portions with the biggest distortions.
You can export the images in JPEG with 98% quality to reduce file size.
I noticed that usually, the cheap microscope lens is the limiting factor, and you don’t need high pixel quality/density.</p>

<figure>
    <img src="https://niemczuk.tech/2024/02/11/darktable-stack.png" alt="Example darktable stack that I&#39;m using" width="30%"/>
    <figcaption>Example darktable stack that I&#39;m using</figcaption>
</figure>


<p><a href="https://hugin.sourceforge.io/">Hugin</a> is an image software toolbox that can be used for various image manipulation and correction.
Such elasticity comes at a cost of complexity.</p>

<p>The first thing that you have to do to start stitching microscope images after running <em>Hugin - Panorama Stitcher</em> is to change the interface to expert by clicking <code>Interface-&gt;Expert</code>.
Next, in <code>File-&gt;Preferences</code> under the <code>Control Point Detector</code> tab, click <code>New</code> and add once again <em>Hugin’s CPFind</em> but with <code>--linearmatch --linearmatchlen=2 -o %o %s</code> as arguments. The value in the field <code>Program:</code> should be copied from the <em>Hugin’s CPFind</em> entry because it depends on where you have Hugin installed.
This option will match images to their neighbors, instead of matching every image with every image, drastically reducing computing time for large image sets and improving accuracy.</p>

<p>Then the workflow is as follows:</p>

<ol>
  <li>Add images by clicking <code>Add images...</code>.</li>
  <li>Select all images from the scan.</li>
  <li>Set <code>Lens type: Normal (rectilinear)</code>.</li>
  <li>Set <code>HFOV (v)</code> to <code>10 degrees</code>.</li>
  <li>Set <code>Focal length multiplier</code> to <code>1</code>.</li>
  <li>Choose your created <code>Hugin CPFind</code> with <em>linearmatch</em> arguments script from the <code>Feature Matching Settings:</code> list and click <code>Create control points</code>.</li>
  <li>Choose <code>Custom parameters</code> from <code>Optimize, Geometric:</code> list.</li>
  <li>Change the view to the <code>Optimiser</code> tab.</li>
  <li>Right-click on <code>Yaw (y)</code> and click <code>Unselect all</code>. Do this for other columns as well.</li>
  <li>Right-click on <code>X (TrX)</code> and click <code>Select all</code>. Do this also for <code>Y (TrY)</code> and <code>Roll (r)</code> (check roll only if images got flipped by your camera or you rotated your object).</li>
  <li>
    <p>Click on <code>Optimize now!</code>. If you see a result similar to that below, you are good. If the values are all zeros or in the order of thousands, you should capture your images once again. But this time put more effort into that. ;P</p>

    <div><div><pre><code>Optimiser run finished.
Results:
 average control point distance: 0.209935
 standard deviation: 1.102026
 maximum: 54.850377
    
Apply the changes?
</code></pre></div>    </div>
  </li>
  <li>Click on <code>Preview panorama (OpenGL)</code> - ninth button on the top bar with the <em>GL</em> letters.</li>
  <li>See if your images are semi-aligned and create a continuous image. They can be a little misplaced. Again, if the images are not visible or are not aligned, you should start over and take better images. It will be faster than trying to align your images by hand. <img src="https://niemczuk.tech/2024/02/11/hugin-gl-1.png" alt="Example of the first image alignment" width="80%"/></li>
  <li>Now return to the previous Hugin window and open the <code>Control Points</code> tab.</li>
  <li>Select the first image on the left window and on the right window.</li>
  <li>Using arrows between the image name lists, change images and pause on those that have long vertical or horizontal elements.</li>
  <li>By left-clicking on the left image, select the beginning of the horizontal or vertical element. And then on the right image, click on the end of that element. <strong>Uncheck <code>auto fine-tune</code> if the points jump around.</strong> Repeat this step for as many images as you like. <img src="https://niemczuk.tech/2024/02/11/hugin-straight-points.png" alt="Example of a marked straight line" width="100%"/> <img src="https://niemczuk.tech/2024/02/11/hugin-straight-points-2.png" alt="Example of a marked straight line" width="100%"/></li>
  <li>Click <code>Optimize now!</code> in the <code>Optimiser</code> tab again.</li>
  <li>Switch your view to <code>Fast Panorama preview</code> again.</li>
  <li>Click on <code>Move/Drag</code> tab.</li>
  <li>Move your PCB to the center of the view or click the <code>Centre</code> button on the top left.</li>
  <li>Switch the tab to <code>Projection</code>.</li>
  <li>Choose <code>Rectilinear</code> from the top list.</li>
  <li>Click on the <code>Fit</code> button on the top left.</li>
  <li>Choose <code>Mosaic plane</code> in the <code>Mode:</code> list. If you get a prompt with <code>Should the Tpy and Tpp parameters reset to zero?</code>, click <code>Yes</code>.</li>
  <li>Return to the Hugin main window to the <code>Photos</code> tab.</li>
  <li>Choose <code>Hugin&#39;s CPFind (prealigned)</code> in the <code>Feature Matching Settings:</code> list.</li>
  <li>Click <code>Create control points</code>.</li>
  <li>Return to the <code>Optimiser</code> tab and click <code>Optimize now!</code>.</li>
  <li>Repeat steps 19-25.</li>
  <li>Click on <code>Show control points</code> - eleventh button from the top left.</li>
  <li>Click on the <code>Distance</code> column and sort your points in descending distance order.</li>
  <li>Remove the top ones. You can do it automatically, but it is better to inspect them one by one and do it by hand. If you have <code>Fast Panorama preview</code> open, the selected points will show up in that window. Do not remove your horizontal or vertical line points.</li>
  <li>Click <code>Optimize now!</code> again.</li>
  <li>See in <code>Fast Panorama preview</code> if your image didn’t blow up. If yes, congratulations, you can capture your images again or add more control points by hand and try from step 18.</li>
  <li>If everything looks good, go into the <code>Optimiser</code> tab and right-clicking on columns <code>Z (TrZ)</code>, <code>Hfov (v)</code>, and <code>Select all</code>. Select the <code>Roll (r)</code> column also if you didn’t do it earlier.</li>
  <li>Click <code>Optimize now!</code>.</li>
  <li>The worst step. Return to previous steps and experiment if you are not satisfied with the results.</li>
  <li>In <code>Fast Panorama preview</code>, in the <code>Crop</code> tab, crop your image using the white bars visible on the image. <img src="https://niemczuk.tech/2024/02/11/hugin-crop.png" alt="Example of a marked straight line" width="100%"/></li>
  <li>Finally, go to the <code>Stitcher</code> tab in the main Hugin window and click on <code>Calculate Optimal Size</code>. The size of the output image will depend on the resolution of the input images, the object size, crop, and optimized field of view.</li>
  <li>Select the first three checkboxes in the <code>Panorama Outputs</code> section and choose the desired output file format.</li>
  <li>Click on <code>Stitch!</code> button on the right bottom.</li>
</ol>

<p>Three image files should be created. Review them and choose the best one. If you are not satisfied with your result, take better photos or fiddle around with control points in Hugin.</p>

<p><img src="https://niemczuk.tech/2024/02/11/hugin-output.jpg" alt="Example of a stitched image" width="100%"/></p>

<p>If you stumble on any errors during image stitching, it will probably be an image duplication or the images are not a part of the same set/object.
And if the output image has some blurs or shifts (like the one in the image above), try adding more control points between similar images in the <code>Control Points</code> tab in Hugin’s main window.</p>


<ul>
  <li>[1] <a href="https://thorninger.com/eng/extrememacro2.html">https://thorninger.com/eng/extrememacro2.html</a></li>
  <li>[2] <a href="https://patdavid.net/2013/01/focus-stacking-macro-photos-enfuse">https://patdavid.net/2013/01/focus-stacking-macro-photos-enfuse</a></li>
  <li>[3] <a href="https://derekdvleung.wixsite.com/main/post/stitching-microscope-images-using-hugin">https://derekdvleung.wixsite.com/main/post/stitching-microscope-images-using-hugin</a></li>
</ul>

  </div></div>
  </body>
</html>
