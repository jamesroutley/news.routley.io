<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://picovoice.ai/blog/offline-voice-assistant-on-an-stm32-microcontroller/">Original</a>
    <h1>Offline Voice Assistant on a Microcontroller with 192KB RAM</h1>
    
    <div id="readability-page-1" class="page"><div><p><b>December 12, 2022<!-- --> <!-- -->Â· <!-- -->3<!-- --> min read</b></p><p><span>Engineering</span><span>Product</span><span>Wake Word</span><span>Speech-to-Intent</span></p></div><div><div><p>Microcontrollers (MCUs) are still very attractive when cost and power consumption are top requirements. Recently, there has been lots of activity from Amazon and Google to put Alexa and Google Assistant on Microcontrollers. Semiconductor companies celebrated this move in hopes of gaining volume. Alas, the goal was limited to offloading the wake word detection on the MCU and then using connectivity (BLE, WiFi, or LoRa) to perform the heavy lifting in the cloud. The approach defeats the purpose, as API-based pricing makes the low cost of MCU irrelevant. Also, connectivity draws more power than computing! Nonetheless, Amazon and Google reportedly are <a href="https://9to5google.com/2022/06/13/google-assistant-voice-apps/" target="_blank" rel="noopener noreferrer">curtailing their support for third parties</a> and leaving everyone, including silicon companies, hot and dry!</p><p>Here is where Picovoice kicks in! Picovoice offers the <a href="https://picovoice.ai/platform/porcupine/">Porcupine Wake Word</a> and <a href="https://picovoice.ai/platform/rhino/">Rhino Speech-to-Intent</a> engines. Together they can match what a voice assistant like Alexa can do for a device like a smart thermostat. With them, you can understand complex phrases like:</p><div><div aria-hidden="true" role="figure"><pre><code><p><span>Hey Thermostat, set the temperature to 25 degrees in the bedroom.</span></p></code></pre></div></div><p>Oddly enough, commands like these were the majority of active use cases for Alexa based on <a href="https://arstechnica.com/gadgets/2022/11/amazon-alexa-is-a-colossal-failure-on-pace-to-lose-10-billion-this-year/" target="_blank" rel="noopener noreferrer">Amazon&#39;s report</a>. People don&#39;t want to banter with their voice assistants! They want to get things done. Picovoice can deliver this experience on-device and offline with higher accuracy while respecting privacy. Below you learn how.</p><div><p>For this tutorial, we use the <a href="https://www.st.com/en/evaluation-tools/stm32f4discovery.html" target="_blank" rel="noopener noreferrer">STM32F407 discovery board</a>. We picked it because it is on the low end of what is available to showcase how efficient Picovoice voice AI is. Also, it only costs you $20. </p></div><h2 id="run-the-demo">Run the demo</h2><p>You will need <a href="https://www.st.com/en/evaluation-tools/stm32f4discovery.html" target="_blank" rel="noopener noreferrer">the dev board</a> and <a href="https://www.st.com/en/development-tools/stm32cubeide.html" target="_blank" rel="noopener noreferrer">STM32CubeIDE</a> installed.</p><ol><li>Clone the Picovoice repository.</li></ol><div><div aria-hidden="true" role="figure"><pre><code><p><span>git clone --recurse-submodules \</span></p><p><span>https://github.com/Picovoice/picovoice.git</span></p></code></pre></div></div><ol start="2"><li><p>Open the project under <code>/demo/mcu/stm32f407/</code> using STM32CubeIDE.</p></li><li><p>You need to download the audio middleware. For licensing purposes, we can not have it on GitHub. You can download it from <a href="https://www.st.com/en/embedded-software/stm32cubef4.html" target="_blank" rel="noopener noreferrer">here</a>. Once downloaded, unzip it. Find the <code>Middlewares</code> folder and replace the empty <code>Middlewares</code> folder in the project with that.</p></li><li><p>Sign up for <a href="https://console.picovoice.ai/" target="_blank" rel="noopener noreferrer">Picovoice Console</a>, go to dashboard, and copy your <code>AccessKey</code>.</p></li></ol><p><span>
<span></span>
<img alt="AccessKey" title="AccessKey" src="https://picovoice.ai/static/5a8c0fa9ce635ba4cadd86b5edd95c45/cdb7c/access_key.png" srcset="/static/5a8c0fa9ce635ba4cadd86b5edd95c45/f9b6b/access_key.png 180w,/static/5a8c0fa9ce635ba4cadd86b5edd95c45/6e159/access_key.png 360w,/static/5a8c0fa9ce635ba4cadd86b5edd95c45/cdb7c/access_key.png 630w" sizes="(max-width: 630px) 100vw, 630px" loading="lazy" decoding="async"/>
</span></p><ol start="5"><li>In <code>main.c</code>, insert your <code>AccessKey</code> string in the line:</li></ol><div><div aria-hidden="true" role="figure"><pre><code><p><span>static</span><span> </span><span>const</span><span> </span><span>char</span><span>*</span><span> ACCESS_KEY </span><span>=</span><span> </span><span>.</span><span>.</span><span>.</span></p></code></pre></div></div><ol start="6"><li><p>Build and load the project into your board. The demo uses Serial Wire Viewer (SWV) to return log messages. Assure this works, and you can monitor it.</p></li><li><p>Say:</p></li></ol><div><div aria-hidden="true" role="figure"><pre><code><p><span>Picovoice, turn on the light in the living room</span></p></code></pre></div></div><p>You should see the following in the debug console:</p><div><div aria-hidden="true" role="figure"><pre><code><p><span>UID:  2c 00 55 00 13 51 37 34 34 37 33 32</span></p><p><span>[wake word]</span></p><p><span>{</span></p><p><span>    is_understood : &#39;true&#39;,</span></p><p><span>    intent : &#39;changeLightState&#39;,</span></p><p><span>    slots : {</span></p><p><span>        &#39;state&#39; : &#39;on&#39;,</span></p><p><span>        &#39;location&#39; : &#39;living room&#39;,</span></p><p><span>    }</span></p><p><span>}</span></p></code></pre></div></div><p>The <code>UUID</code> is the unique identifier of the ST MCU on the board. We will need it for training custom models. The rest shows that the firmware understood the wake phrase <code>Picovoice</code> using the Porcupine Wake Word engine, and the follow-on voice command <code>turn on the light in the living room</code> using Rhino Speech-to-Intent engine.</p><h2 id="train-custom-wake-word">Train Custom Wake Word</h2><ol><li>Sign up for <a href="https://console.picovoice.ai/" target="_blank" rel="noopener noreferrer">Picovoice Console</a>.</li><li>Go to the <code>Porcupine Page</code></li><li>Select English as the language for your model</li><li>Type in the phrase you want to build the model for. I choose <code>Hey Four O Seven</code> as an example.</li><li>Optionally, you can try it within the browser</li><li>Once you are happy, click on the train button.</li></ol><p><span>
<span></span>
<img alt="Train wake word using Picovoice Console - Phase A" title="Train wake word using Picovoice Console - Phase A" src="https://picovoice.ai/static/ed1c3ac7a52d9d1da1b76b50e5619071/a1ba1/console_wake_word_phase_a.png" srcset="/static/ed1c3ac7a52d9d1da1b76b50e5619071/5b7ec/console_wake_word_phase_a.png 180w,/static/ed1c3ac7a52d9d1da1b76b50e5619071/5657d/console_wake_word_phase_a.png 360w,/static/ed1c3ac7a52d9d1da1b76b50e5619071/a1ba1/console_wake_word_phase_a.png 444w" sizes="(max-width: 444px) 100vw, 444px" loading="lazy" decoding="async"/>
</span></p><ol start="7"><li>Pick <code>Arm Cortex-M</code> as the platform</li><li>Select <code>STM32</code> as your board type.</li><li>Enter the <code>UUID</code> for your board.</li><li>Click on the Download button. You should have a <code>.zip</code> file in your download folder now.</li></ol><p><span>
<span></span>
<img alt="Train wake word using Picovoice Console - Phase B" title="Train wake word using Picovoice Console - Phase B" src="https://picovoice.ai/static/7537b243676a1f7817b1f02d48bbe4c4/5f207/console_wake_word_phase_b.png" srcset="/static/7537b243676a1f7817b1f02d48bbe4c4/59da8/console_wake_word_phase_b.png 179w,/static/7537b243676a1f7817b1f02d48bbe4c4/81ea4/console_wake_word_phase_b.png 360w,/static/7537b243676a1f7817b1f02d48bbe4c4/5f207/console_wake_word_phase_b.png 518w" sizes="(max-width: 518px) 100vw, 518px" loading="lazy" decoding="async"/>
</span></p><ol start="11"><li>Unzip it. Open the file <code>pv_porcupine_params.h</code> with a text editor. The <code>KEYWORD_ARRAY[]</code> contains your newly-trained model!</li></ol><p><span>
<span></span>
<img alt="Keyword Array Content" title="Keyword Array Content" src="https://picovoice.ai/static/75f5804c7d928b8ef6328834a6ebec77/4a02d/keyword_array.png" srcset="/static/75f5804c7d928b8ef6328834a6ebec77/c2286/keyword_array.png 180w,/static/75f5804c7d928b8ef6328834a6ebec77/32367/keyword_array.png 360w,/static/75f5804c7d928b8ef6328834a6ebec77/4a02d/keyword_array.png 720w,/static/75f5804c7d928b8ef6328834a6ebec77/d6264/keyword_array.png 1080w,/static/75f5804c7d928b8ef6328834a6ebec77/e8976/keyword_array.png 1143w" sizes="(max-width: 720px) 100vw, 720px" loading="lazy" decoding="async"/>
</span></p><ol start="12"><li><p>Copy the content of this array into the <code>KEYWORD_ARRAY[]</code> variable inside <code>Inc/pv_params.h</code>.</p></li><li><p>Build the project and load it on the board. Now you can say:</p></li></ol><div><div aria-hidden="true" role="figure"><pre><code><p><span>Hey 407, turn on the light in the living room.</span></p></code></pre></div></div><h2 id="train-custom-follow-on-voice-commands">Train Custom Follow-on Voice Commands</h2><p>Let&#39;s make a voice-enabled coffee maker!</p><ol><li>On Picovoice Console, go to the <code>Rhino Page</code>.</li><li>Click on <code>New Context</code></li><li>Give the context a name of your choice, select English as the language, and choose <code>Coffee maker</code> as a template.</li><li>Click on <code>Create Context</code>.</li><li>Once in the Rhino context editor, click the Download button. Follow the steps similar to the custom wake word to download the model.</li><li>Unzip the downloaded model. Find the header file and copy the content of <code>CONTEXT_ARRAY[]</code> into the <code>CONTEXT_ARRAY[]</code> variable inside <code>Inc/pv_params.h</code>.</li><li>Build the project and load it on the board. Now you can say:</li></ol><div><div aria-hidden="true" role="figure"><pre><code><p><span>Hey 407, make me a large coffee.</span></p></code></pre></div></div><p>You should see the following in the debug console:</p><div><div aria-hidden="true" role="figure"><pre><code><p><span>[wake word]</span></p><p><span>{</span></p><p><span>    is_understood : &#39;true&#39;,</span></p><p><span>    intent : &#39;orderBeverage&#39;,</span></p><p><span>    slots : {</span></p><p><span>        &#39;size&#39; : &#39;large&#39;,</span></p><p><span>        &#39;beverage&#39; : &#39;coffee&#39;,</span></p><p><span>    }</span></p><p><span>}</span></p></code></pre></div></div><h2 id="non-english-models">Non-English models?</h2><p>The demo project supports German, French, and Spanish as well. Picovoice also supports many other languages. For commercial inquiries, contact sales to get access.</p><h2 id="additional-hw-support">Additional HW Support</h2><p>We support ten Arm Cortex-M microcontrollers (boards). These are selected based on popularity and cover a variety of computing and memory resources.</p><p>Adding support for a new microcontroller is expensive and entails ongoing costs. We have the following ruleset in our engagement:</p><ul><li><strong>Customers:</strong> Please engage with the Picovoice sales team. If the opportunity is a fit, we will support your HW.</li><li><strong>Researchers and Hobbyists:</strong> Open a GitHub issue on the Picovoice repository. We can consider it if the traction of the GitHub issue is significant.</li><li><strong>Semiconductor Companies:</strong> If you have a customer, we will engage with them independently and are happy to support your HW as part of that engagement.</li></ul></div></div></div>
  </body>
</html>
