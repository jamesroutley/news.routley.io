<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://gist.github.com/antirez/6ca04dd191bdb82aad9fb241013e88a8">Original</a>
    <h1>The first version of Redis, written in Tcl (2009)</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="Tcl" data-tagsearch-path="lmdb.tcl">
        <tbody><tr>
          <td id="file-lmdb-tcl-L1" data-line-number="1"></td>
          <td id="file-lmdb-tcl-LC1"><span><span>#</span> LVDB - LLOOGG Memory DB</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L2" data-line-number="2"></td>
          <td id="file-lmdb-tcl-LC2"><span><span>#</span> Copyriht (C) 2009 Salvatore Sanfilippo &lt;antirez@gmail.com&gt;</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L3" data-line-number="3"></td>
          <td id="file-lmdb-tcl-LC3"><span><span>#</span> All Rights Reserved</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L4" data-line-number="4"></td>
          <td id="file-lmdb-tcl-LC4">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L5" data-line-number="5"></td>
          <td id="file-lmdb-tcl-LC5"><span><span>#</span> TODO</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L6" data-line-number="6"></td>
          <td id="file-lmdb-tcl-LC6"><span><span>#</span> - cron with cleanup of timedout clients, automatic dump</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L7" data-line-number="7"></td>
          <td id="file-lmdb-tcl-LC7"><span><span>#</span> - the dump should use array startsearch to write it line by line</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L8" data-line-number="8"></td>
          <td id="file-lmdb-tcl-LC8"><span><span>#</span>   and may just use gets to read element by element and load the whole state.</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L9" data-line-number="9"></td>
          <td id="file-lmdb-tcl-LC9"><span><span>#</span> - &#39;help&#39;,&#39;stopserver&#39;,&#39;saveandstopserver&#39;,&#39;save&#39;,&#39;load&#39;,&#39;reset&#39;,&#39;keys&#39; commands.</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L10" data-line-number="10"></td>
          <td id="file-lmdb-tcl-LC10"><span><span>#</span> - ttl with milliseconds resolution &#39;ttl a 1000&#39;. Check ttl in dump!</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L11" data-line-number="11"></td>
          <td id="file-lmdb-tcl-LC11"><span><span>#</span> - cluster. Act as master, send write ops to all servers, get from one at random. Auto-serialization.</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L12" data-line-number="12"></td>
          <td id="file-lmdb-tcl-LC12"><span><span>#</span> - &#39;hold&#39; and &#39;continue&#39; command, for sync in cluster mode</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L13" data-line-number="13"></td>
          <td id="file-lmdb-tcl-LC13"><span><span>#</span> - auto-sync, consider lazy copy or log of operations to re-read at start</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L14" data-line-number="14"></td>
          <td id="file-lmdb-tcl-LC14"><span><span>#</span> - client timeout</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L15" data-line-number="15"></td>
          <td id="file-lmdb-tcl-LC15"><span><span>#</span> - save dump in temp file.[clock ticks] than rename it</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L16" data-line-number="16"></td>
          <td id="file-lmdb-tcl-LC16">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L17" data-line-number="17"></td>
          <td id="file-lmdb-tcl-LC17"><span>package</span> require Tclx ;<span><span>#</span> For [fork]</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L18" data-line-number="18"></td>
          <td id="file-lmdb-tcl-LC18">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L19" data-line-number="19"></td>
          <td id="file-lmdb-tcl-LC19"><span>array</span> set ::clients {}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L20" data-line-number="20"></td>
          <td id="file-lmdb-tcl-LC20"><span>array</span> set ::state {}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L21" data-line-number="21"></td>
          <td id="file-lmdb-tcl-LC21"><span>array</span> set ::readlen {}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L22" data-line-number="22"></td>
          <td id="file-lmdb-tcl-LC22"><span>array</span> set ::readbuf {}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L23" data-line-number="23"></td>
          <td id="file-lmdb-tcl-LC23"><span>array</span> set ::db {}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L24" data-line-number="24"></td>
          <td id="file-lmdb-tcl-LC24"><span>array</span> set ::ttl {}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L25" data-line-number="25"></td>
          <td id="file-lmdb-tcl-LC25"><span>set</span> ::dirty 0</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L26" data-line-number="26"></td>
          <td id="file-lmdb-tcl-LC26"><span>set</span> ::lastsaved 0</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L27" data-line-number="27"></td>
          <td id="file-lmdb-tcl-LC27"><span>set</span> ::listensocket {}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L28" data-line-number="28"></td>
          <td id="file-lmdb-tcl-LC28">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L29" data-line-number="29"></td>
          <td id="file-lmdb-tcl-LC29">signal -restart block SIGCHLD</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L30" data-line-number="30"></td>
          <td id="file-lmdb-tcl-LC30">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L31" data-line-number="31"></td>
          <td id="file-lmdb-tcl-LC31"><span><span>#</span> the K combinator is using for Tcl object refcount hacking</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L32" data-line-number="32"></td>
          <td id="file-lmdb-tcl-LC32"><span><span>#</span> in order to avoid useless object copy.</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L33" data-line-number="33"></td>
          <td id="file-lmdb-tcl-LC33"><span>proc</span> <span>K</span> {x y} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L34" data-line-number="34"></td>
          <td id="file-lmdb-tcl-LC34">    <span>set</span> x</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L35" data-line-number="35"></td>
          <td id="file-lmdb-tcl-LC35">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L36" data-line-number="36"></td>
          <td id="file-lmdb-tcl-LC36">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L37" data-line-number="37"></td>
          <td id="file-lmdb-tcl-LC37"><span>proc</span> <span>headappend</span> {var e} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L38" data-line-number="38"></td>
          <td id="file-lmdb-tcl-LC38">    <span>upvar</span> 1 <span>$var</span> l</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L39" data-line-number="39"></td>
          <td id="file-lmdb-tcl-LC39">    <span>set</span> l [<span>lreplace</span> [K <span>$l</span> [<span>set</span> l {}]] -1 -1 <span>$e</span>]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L40" data-line-number="40"></td>
          <td id="file-lmdb-tcl-LC40">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L41" data-line-number="41"></td>
          <td id="file-lmdb-tcl-LC41">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L42" data-line-number="42"></td>
          <td id="file-lmdb-tcl-LC42"><span>proc</span> <span>log</span> msg {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L43" data-line-number="43"></td>
          <td id="file-lmdb-tcl-LC43">    <span>puts</span> stderr <span><span>&#34;</span><span><span>[</span><span>clock</span> format [<span>clock</span> seconds<span>]</span></span>]<span>\]</span> <span>$msg</span> <span>&#34;</span></span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L44" data-line-number="44"></td>
          <td id="file-lmdb-tcl-LC44">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L45" data-line-number="45"></td>
          <td id="file-lmdb-tcl-LC45">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L46" data-line-number="46"></td>
          <td id="file-lmdb-tcl-LC46"><span>proc</span> <span>warning</span> msg {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L47" data-line-number="47"></td>
          <td id="file-lmdb-tcl-LC47">    log <span><span>&#34;</span>*** WARNING: <span>$msg</span><span>&#34;</span></span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L48" data-line-number="48"></td>
          <td id="file-lmdb-tcl-LC48">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L49" data-line-number="49"></td>
          <td id="file-lmdb-tcl-LC49">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L50" data-line-number="50"></td>
          <td id="file-lmdb-tcl-LC50"><span>proc</span> <span>writemsg</span> {fd msg} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L51" data-line-number="51"></td>
          <td id="file-lmdb-tcl-LC51">    <span>puts</span> -nonewline <span>$fd</span> <span>$msg</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L52" data-line-number="52"></td>
          <td id="file-lmdb-tcl-LC52">    <span>puts</span> -nonewline <span>$fd</span> <span><span>&#34;</span><span>\r\n</span><span>&#34;</span></span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L53" data-line-number="53"></td>
          <td id="file-lmdb-tcl-LC53">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L54" data-line-number="54"></td>
          <td id="file-lmdb-tcl-LC54">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L55" data-line-number="55"></td>
          <td id="file-lmdb-tcl-LC55"><span>proc</span> <span>resetclient</span> {fd} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L56" data-line-number="56"></td>
          <td id="file-lmdb-tcl-LC56">    <span>set</span> ::clients(<span>$fd</span>) [<span>clock</span> seconds]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L57" data-line-number="57"></td>
          <td id="file-lmdb-tcl-LC57">    <span>set</span> ::state(<span>$fd</span>) {}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L58" data-line-number="58"></td>
          <td id="file-lmdb-tcl-LC58">    <span>set</span> ::readlen(<span>$fd</span>) 0</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L59" data-line-number="59"></td>
          <td id="file-lmdb-tcl-LC59">    <span>set</span> ::readbuf(<span>$fd</span>) {}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L60" data-line-number="60"></td>
          <td id="file-lmdb-tcl-LC60">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L61" data-line-number="61"></td>
          <td id="file-lmdb-tcl-LC61">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L62" data-line-number="62"></td>
          <td id="file-lmdb-tcl-LC62"><span>proc</span> <span>accept</span> {fd addr port} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L63" data-line-number="63"></td>
          <td id="file-lmdb-tcl-LC63">    resetclient <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L64" data-line-number="64"></td>
          <td id="file-lmdb-tcl-LC64">    <span>fconfigure</span> <span>$fd</span> -blocking 0 -translation binary -encoding binary</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L65" data-line-number="65"></td>
          <td id="file-lmdb-tcl-LC65">    <span>fileevent</span> <span>$fd</span> readable [<span>list</span> readrequest <span>$fd</span>]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L66" data-line-number="66"></td>
          <td id="file-lmdb-tcl-LC66">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L67" data-line-number="67"></td>
          <td id="file-lmdb-tcl-LC67">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L68" data-line-number="68"></td>
          <td id="file-lmdb-tcl-LC68"><span>proc</span> <span>readrequest</span> fd {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L69" data-line-number="69"></td>
          <td id="file-lmdb-tcl-LC69">    <span>if</span> [<span>eof</span> <span>$fd</span>] {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L70" data-line-number="70"></td>
          <td id="file-lmdb-tcl-LC70">        closeclient <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L71" data-line-number="71"></td>
          <td id="file-lmdb-tcl-LC71">        <span>return</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L72" data-line-number="72"></td>
          <td id="file-lmdb-tcl-LC72">    }</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L73" data-line-number="73"></td>
          <td id="file-lmdb-tcl-LC73">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L74" data-line-number="74"></td>
          <td id="file-lmdb-tcl-LC74">    <span><span>#</span> Handle bulk read</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L75" data-line-number="75"></td>
          <td id="file-lmdb-tcl-LC75">    <span>if</span> {<span>$::state($fd)</span> ne {}} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L76" data-line-number="76"></td>
          <td id="file-lmdb-tcl-LC76">        <span>set</span> buf [<span>read</span> <span>$fd</span> [<span>expr</span> {<span>$::readlen($fd)</span>-[<span>string</span> length <span>$::readbuf($fd)</span>]}]]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L77" data-line-number="77"></td>
          <td id="file-lmdb-tcl-LC77">        <span>append</span> ::readbuf(<span>$fd</span>) <span>$buf</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L78" data-line-number="78"></td>
          <td id="file-lmdb-tcl-LC78">        <span>if</span> {[<span>string</span> length <span>$::readbuf($fd)</span>] &gt;= <span>$::readlen($fd)</span>} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L79" data-line-number="79"></td>
          <td id="file-lmdb-tcl-LC79">            <span>set</span> ::readbuf(<span>$fd</span>) [<span>string</span> range <span>$::readbuf($fd)</span> 0 end-2]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L80" data-line-number="80"></td>
          <td id="file-lmdb-tcl-LC80">            <span>lappend</span> ::state(<span>$fd</span>) <span>$::readbuf($fd)</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L81" data-line-number="81"></td>
          <td id="file-lmdb-tcl-LC81">            cmd_[<span>lindex</span> <span>$::state($fd)</span> 0] <span>$fd</span> <span>$::state($fd)</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L82" data-line-number="82"></td>
          <td id="file-lmdb-tcl-LC82">        }</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L83" data-line-number="83"></td>
          <td id="file-lmdb-tcl-LC83">        <span>return</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L84" data-line-number="84"></td>
          <td id="file-lmdb-tcl-LC84">    }</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L85" data-line-number="85"></td>
          <td id="file-lmdb-tcl-LC85">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L86" data-line-number="86"></td>
          <td id="file-lmdb-tcl-LC86">    <span><span>#</span> Handle first line request</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L87" data-line-number="87"></td>
          <td id="file-lmdb-tcl-LC87">    <span>set</span> req [<span>string</span> trim [<span>gets</span> <span>$fd</span>] <span><span>&#34;</span><span>\r\n</span> <span>&#34;</span></span>]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L88" data-line-number="88"></td>
          <td id="file-lmdb-tcl-LC88">    <span>if</span> {<span>$req</span> eq {}} return</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L89" data-line-number="89"></td>
          <td id="file-lmdb-tcl-LC89">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L90" data-line-number="90"></td>
          <td id="file-lmdb-tcl-LC90">    <span><span>#</span> Process command</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L91" data-line-number="91"></td>
          <td id="file-lmdb-tcl-LC91">    <span>set</span> args [<span>split</span> <span>$req</span>]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L92" data-line-number="92"></td>
          <td id="file-lmdb-tcl-LC92">    <span>set</span> cmd [<span>string</span> tolower [<span>lindex</span> <span>$args</span> 0]]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L93" data-line-number="93"></td>
          <td id="file-lmdb-tcl-LC93">    <span>foreach</span> ct <span>$::cmdtable</span> {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L94" data-line-number="94"></td>
          <td id="file-lmdb-tcl-LC94">        <span>if</span> {<span>$cmd</span> eq [<span>lindex</span> <span>$ct</span> 0] &amp;&amp; [<span>llength</span> <span>$args</span>] == [<span>lindex</span> <span>$ct</span> 1]} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L95" data-line-number="95"></td>
          <td id="file-lmdb-tcl-LC95">            <span>if</span> {[<span>lindex</span> <span>$ct</span> 2] eq {inline}} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L96" data-line-number="96"></td>
          <td id="file-lmdb-tcl-LC96">                cmd_<span>$cmd</span> <span>$fd</span> <span>$args</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L97" data-line-number="97"></td>
          <td id="file-lmdb-tcl-LC97">            } <span>else</span> {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L98" data-line-number="98"></td>
          <td id="file-lmdb-tcl-LC98">                <span>set</span> readlen [<span>lindex</span> <span>$args</span> end]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L99" data-line-number="99"></td>
          <td id="file-lmdb-tcl-LC99">                <span>if</span> {<span>$readlen</span> &lt; 0 || <span>$readlen</span> &gt; 1024*1024} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L100" data-line-number="100"></td>
          <td id="file-lmdb-tcl-LC100">                    writemsg <span>$fd</span> <span><span>&#34;</span>protocol error: invalid bulk read length<span>&#34;</span></span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L101" data-line-number="101"></td>
          <td id="file-lmdb-tcl-LC101">                    closeclient <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L102" data-line-number="102"></td>
          <td id="file-lmdb-tcl-LC102">                    <span>return</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L103" data-line-number="103"></td>
          <td id="file-lmdb-tcl-LC103">                }</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L104" data-line-number="104"></td>
          <td id="file-lmdb-tcl-LC104">                bulkread <span>$fd</span> [<span>lrange</span> <span>$args</span> 0 end-1] <span>$readlen</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L105" data-line-number="105"></td>
          <td id="file-lmdb-tcl-LC105">            }</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L106" data-line-number="106"></td>
          <td id="file-lmdb-tcl-LC106">            <span>return</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L107" data-line-number="107"></td>
          <td id="file-lmdb-tcl-LC107">        }</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L108" data-line-number="108"></td>
          <td id="file-lmdb-tcl-LC108">    }</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L109" data-line-number="109"></td>
          <td id="file-lmdb-tcl-LC109">    writemsg <span>$fd</span> <span><span>&#34;</span>protocol error: invalid command &#39;<span>$cmd</span>&#39;<span>&#34;</span></span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L110" data-line-number="110"></td>
          <td id="file-lmdb-tcl-LC110">    closeclient <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L111" data-line-number="111"></td>
          <td id="file-lmdb-tcl-LC111">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L112" data-line-number="112"></td>
          <td id="file-lmdb-tcl-LC112">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L113" data-line-number="113"></td>
          <td id="file-lmdb-tcl-LC113"><span>proc</span> <span>bulkread</span> {fd argv len} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L114" data-line-number="114"></td>
          <td id="file-lmdb-tcl-LC114">    <span>set</span> ::state(<span>$fd</span>) <span>$argv</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L115" data-line-number="115"></td>
          <td id="file-lmdb-tcl-LC115">    <span>set</span> ::readlen(<span>$fd</span>) [<span>expr</span> {<span>$len</span>+2}]  ;<span><span>#</span> Add two bytes for CRLF</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L116" data-line-number="116"></td>
          <td id="file-lmdb-tcl-LC116">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L117" data-line-number="117"></td>
          <td id="file-lmdb-tcl-LC117">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L118" data-line-number="118"></td>
          <td id="file-lmdb-tcl-LC118"><span>proc</span> <span>closeclient</span> fd {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L119" data-line-number="119"></td>
          <td id="file-lmdb-tcl-LC119">    <span>unset</span> ::clients(<span>$fd</span>)</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L120" data-line-number="120"></td>
          <td id="file-lmdb-tcl-LC120">    <span>unset</span> ::state(<span>$fd</span>)</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L121" data-line-number="121"></td>
          <td id="file-lmdb-tcl-LC121">    <span>unset</span> ::readlen(<span>$fd</span>)</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L122" data-line-number="122"></td>
          <td id="file-lmdb-tcl-LC122">    <span>unset</span> ::readbuf(<span>$fd</span>)</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L123" data-line-number="123"></td>
          <td id="file-lmdb-tcl-LC123">    <span>close</span> <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L124" data-line-number="124"></td>
          <td id="file-lmdb-tcl-LC124">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L125" data-line-number="125"></td>
          <td id="file-lmdb-tcl-LC125">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L126" data-line-number="126"></td>
          <td id="file-lmdb-tcl-LC126"><span>proc</span> <span>cron</span> {} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L127" data-line-number="127"></td>
          <td id="file-lmdb-tcl-LC127">    <span><span>#</span> Todo timeout clients timeout</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L128" data-line-number="128"></td>
          <td id="file-lmdb-tcl-LC128">    <span>puts</span> <span><span>&#34;</span>lmdb: <span><span>[</span><span>array</span> size ::db<span>]</span></span> keys, <span><span>[</span><span>array</span> size ::clients<span>]</span></span> clients, dirty: <span>$::dirty</span>, lastsaved: <span>$::lastsaved</span><span>&#34;</span></span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L129" data-line-number="129"></td>
          <td id="file-lmdb-tcl-LC129">    <span>after</span> 1000 cron</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L130" data-line-number="130"></td>
          <td id="file-lmdb-tcl-LC130">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L131" data-line-number="131"></td>
          <td id="file-lmdb-tcl-LC131">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L132" data-line-number="132"></td>
          <td id="file-lmdb-tcl-LC132"><span>set</span> ::cmdtable {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L133" data-line-number="133"></td>
          <td id="file-lmdb-tcl-LC133">    {ping 1 inline}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L134" data-line-number="134"></td>
          <td id="file-lmdb-tcl-LC134">    {quit 1 inline}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L135" data-line-number="135"></td>
          <td id="file-lmdb-tcl-LC135">    {<span>set</span> 3 bulk}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L136" data-line-number="136"></td>
          <td id="file-lmdb-tcl-LC136">    {get 2 inline}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L137" data-line-number="137"></td>
          <td id="file-lmdb-tcl-LC137">    {exists 2 inline}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L138" data-line-number="138"></td>
          <td id="file-lmdb-tcl-LC138">    {delete 2 inline}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L139" data-line-number="139"></td>
          <td id="file-lmdb-tcl-LC139">    {<span>incr</span> 2 inline}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L140" data-line-number="140"></td>
          <td id="file-lmdb-tcl-LC140">    {decr 2 inline}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L141" data-line-number="141"></td>
          <td id="file-lmdb-tcl-LC141">    {lpush 3 bulk}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L142" data-line-number="142"></td>
          <td id="file-lmdb-tcl-LC142">    {rpush 3 bulk}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L143" data-line-number="143"></td>
          <td id="file-lmdb-tcl-LC143">    {save 1 inline}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L144" data-line-number="144"></td>
          <td id="file-lmdb-tcl-LC144">    {bgsave 1 inline}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L145" data-line-number="145"></td>
          <td id="file-lmdb-tcl-LC145">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L146" data-line-number="146"></td>
          <td id="file-lmdb-tcl-LC146">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L147" data-line-number="147"></td>
          <td id="file-lmdb-tcl-LC147"><span>proc</span> <span>okreset</span> {fd {msg OK}} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L148" data-line-number="148"></td>
          <td id="file-lmdb-tcl-LC148">    writemsg <span>$fd</span> <span>$msg</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L149" data-line-number="149"></td>
          <td id="file-lmdb-tcl-LC149">    <span>flush</span> <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L150" data-line-number="150"></td>
          <td id="file-lmdb-tcl-LC150">    resetclient <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L151" data-line-number="151"></td>
          <td id="file-lmdb-tcl-LC151">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L152" data-line-number="152"></td>
          <td id="file-lmdb-tcl-LC152">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L153" data-line-number="153"></td>
          <td id="file-lmdb-tcl-LC153"><span>proc</span> <span>cmd_ping</span> {fd argv} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L154" data-line-number="154"></td>
          <td id="file-lmdb-tcl-LC154">    writemsg <span>$fd</span> <span><span>&#34;</span>PONG<span>&#34;</span></span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L155" data-line-number="155"></td>
          <td id="file-lmdb-tcl-LC155">    <span>flush</span> <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L156" data-line-number="156"></td>
          <td id="file-lmdb-tcl-LC156">    resetclient <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L157" data-line-number="157"></td>
          <td id="file-lmdb-tcl-LC157">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L158" data-line-number="158"></td>
          <td id="file-lmdb-tcl-LC158">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L159" data-line-number="159"></td>
          <td id="file-lmdb-tcl-LC159"><span>proc</span> <span>cmd_quit</span> {fd argv} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L160" data-line-number="160"></td>
          <td id="file-lmdb-tcl-LC160">    okreset <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L161" data-line-number="161"></td>
          <td id="file-lmdb-tcl-LC161">    closeclient <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L162" data-line-number="162"></td>
          <td id="file-lmdb-tcl-LC162">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L163" data-line-number="163"></td>
          <td id="file-lmdb-tcl-LC163">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L164" data-line-number="164"></td>
          <td id="file-lmdb-tcl-LC164"><span>proc</span> <span>cmd_set</span> {fd argv} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L165" data-line-number="165"></td>
          <td id="file-lmdb-tcl-LC165">    <span>set</span> ::db([<span>lindex</span> <span>$argv</span> 1]) [<span>lindex</span> <span>$argv</span> 2]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L166" data-line-number="166"></td>
          <td id="file-lmdb-tcl-LC166">    <span>incr</span> ::dirty</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L167" data-line-number="167"></td>
          <td id="file-lmdb-tcl-LC167">    okreset <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L168" data-line-number="168"></td>
          <td id="file-lmdb-tcl-LC168">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L169" data-line-number="169"></td>
          <td id="file-lmdb-tcl-LC169">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L170" data-line-number="170"></td>
          <td id="file-lmdb-tcl-LC170"><span>proc</span> <span>cmd_get</span> {fd argv} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L171" data-line-number="171"></td>
          <td id="file-lmdb-tcl-LC171">    <span>if</span> {[<span>info</span> exists ::db([<span>lindex</span> <span>$argv</span> 1])]} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L172" data-line-number="172"></td>
          <td id="file-lmdb-tcl-LC172">        <span>set</span> val <span>$::db([lindex $argv 1])</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L173" data-line-number="173"></td>
          <td id="file-lmdb-tcl-LC173">    } <span>else</span> {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L174" data-line-number="174"></td>
          <td id="file-lmdb-tcl-LC174">        <span>set</span> val {}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L175" data-line-number="175"></td>
          <td id="file-lmdb-tcl-LC175">    }</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L176" data-line-number="176"></td>
          <td id="file-lmdb-tcl-LC176">    writemsg <span>$fd</span> [<span>string</span> length <span>$val</span>]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L177" data-line-number="177"></td>
          <td id="file-lmdb-tcl-LC177">    writemsg <span>$fd</span> <span>$val</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L178" data-line-number="178"></td>
          <td id="file-lmdb-tcl-LC178">    <span>flush</span> <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L179" data-line-number="179"></td>
          <td id="file-lmdb-tcl-LC179">    resetclient <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L180" data-line-number="180"></td>
          <td id="file-lmdb-tcl-LC180">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L181" data-line-number="181"></td>
          <td id="file-lmdb-tcl-LC181">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L182" data-line-number="182"></td>
          <td id="file-lmdb-tcl-LC182"><span>proc</span> <span>cmd_exists</span> {fd argv} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L183" data-line-number="183"></td>
          <td id="file-lmdb-tcl-LC183">    <span>if</span> {[<span>info</span> exists ::db([<span>lindex</span> <span>$argv</span> 1])]} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L184" data-line-number="184"></td>
          <td id="file-lmdb-tcl-LC184">        <span>set</span> res 1</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L185" data-line-number="185"></td>
          <td id="file-lmdb-tcl-LC185">    } <span>else</span> {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L186" data-line-number="186"></td>
          <td id="file-lmdb-tcl-LC186">        <span>set</span> res 0</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L187" data-line-number="187"></td>
          <td id="file-lmdb-tcl-LC187">    }</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L188" data-line-number="188"></td>
          <td id="file-lmdb-tcl-LC188">    writemsg <span>$fd</span> <span>$res</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L189" data-line-number="189"></td>
          <td id="file-lmdb-tcl-LC189">    <span>flush</span> <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L190" data-line-number="190"></td>
          <td id="file-lmdb-tcl-LC190">    resetclient <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L191" data-line-number="191"></td>
          <td id="file-lmdb-tcl-LC191">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L192" data-line-number="192"></td>
          <td id="file-lmdb-tcl-LC192">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L193" data-line-number="193"></td>
          <td id="file-lmdb-tcl-LC193"><span>proc</span> <span>cmd_delete</span> {fd argv} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L194" data-line-number="194"></td>
          <td id="file-lmdb-tcl-LC194">    <span>unset</span> -nocomplain -- ::db([<span>lindex</span> <span>$argv</span> 1])</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L195" data-line-number="195"></td>
          <td id="file-lmdb-tcl-LC195">    <span>incr</span> ::dirty</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L196" data-line-number="196"></td>
          <td id="file-lmdb-tcl-LC196">    writemsg <span>$fd</span> <span><span>&#34;</span>OK<span>&#34;</span></span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L197" data-line-number="197"></td>
          <td id="file-lmdb-tcl-LC197">    <span>flush</span> <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L198" data-line-number="198"></td>
          <td id="file-lmdb-tcl-LC198">    resetclient <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L199" data-line-number="199"></td>
          <td id="file-lmdb-tcl-LC199">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L200" data-line-number="200"></td>
          <td id="file-lmdb-tcl-LC200">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L201" data-line-number="201"></td>
          <td id="file-lmdb-tcl-LC201"><span>proc</span> <span>cmd_incr</span> {fd argv} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L202" data-line-number="202"></td>
          <td id="file-lmdb-tcl-LC202">    cmd_incrdecr <span>$fd</span> <span>$argv</span> 1</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L203" data-line-number="203"></td>
          <td id="file-lmdb-tcl-LC203">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L204" data-line-number="204"></td>
          <td id="file-lmdb-tcl-LC204">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L205" data-line-number="205"></td>
          <td id="file-lmdb-tcl-LC205"><span>proc</span> <span>cmd_decr</span> {fd argv} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L206" data-line-number="206"></td>
          <td id="file-lmdb-tcl-LC206">    cmd_incrdecr <span>$fd</span> <span>$argv</span> -1</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L207" data-line-number="207"></td>
          <td id="file-lmdb-tcl-LC207">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L208" data-line-number="208"></td>
          <td id="file-lmdb-tcl-LC208">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L209" data-line-number="209"></td>
          <td id="file-lmdb-tcl-LC209"><span>proc</span> <span>cmd_incrdecr</span> {fd argv n} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L210" data-line-number="210"></td>
          <td id="file-lmdb-tcl-LC210">    <span>if</span> {[<span>catch</span> {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L211" data-line-number="211"></td>
          <td id="file-lmdb-tcl-LC211">        <span>incr</span> ::db([<span>lindex</span> <span>$argv</span> 1]) <span>$n</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L212" data-line-number="212"></td>
          <td id="file-lmdb-tcl-LC212">    }]} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L213" data-line-number="213"></td>
          <td id="file-lmdb-tcl-LC213">        <span>set</span> ::db([<span>lindex</span> <span>$argv</span> 1]) <span>$n</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L214" data-line-number="214"></td>
          <td id="file-lmdb-tcl-LC214">    }</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L215" data-line-number="215"></td>
          <td id="file-lmdb-tcl-LC215">    <span>incr</span> ::dirty</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L216" data-line-number="216"></td>
          <td id="file-lmdb-tcl-LC216">    writemsg <span>$fd</span> <span>$::db([lindex $argv 1])</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L217" data-line-number="217"></td>
          <td id="file-lmdb-tcl-LC217">    <span>flush</span> <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L218" data-line-number="218"></td>
          <td id="file-lmdb-tcl-LC218">    resetclient <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L219" data-line-number="219"></td>
          <td id="file-lmdb-tcl-LC219">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L220" data-line-number="220"></td>
          <td id="file-lmdb-tcl-LC220">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L221" data-line-number="221"></td>
          <td id="file-lmdb-tcl-LC221"><span>proc</span> <span>cmd_lpush</span> {fd argv} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L222" data-line-number="222"></td>
          <td id="file-lmdb-tcl-LC222">    cmd_push <span>$fd</span> <span>$argv</span> -1</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L223" data-line-number="223"></td>
          <td id="file-lmdb-tcl-LC223">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L224" data-line-number="224"></td>
          <td id="file-lmdb-tcl-LC224">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L225" data-line-number="225"></td>
          <td id="file-lmdb-tcl-LC225"><span>proc</span> <span>cmd_rpush</span> {fd argv} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L226" data-line-number="226"></td>
          <td id="file-lmdb-tcl-LC226">    cmd_push <span>$fd</span> <span>$argv</span> 1</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L227" data-line-number="227"></td>
          <td id="file-lmdb-tcl-LC227">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L228" data-line-number="228"></td>
          <td id="file-lmdb-tcl-LC228">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L229" data-line-number="229"></td>
          <td id="file-lmdb-tcl-LC229"><span>proc</span> <span>cmd_push</span> {fd argv dir} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L230" data-line-number="230"></td>
          <td id="file-lmdb-tcl-LC230">    <span>if</span> {[<span>catch</span> {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L231" data-line-number="231"></td>
          <td id="file-lmdb-tcl-LC231">        <span>llength</span> <span>$::db([lindex $argv 1])</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L232" data-line-number="232"></td>
          <td id="file-lmdb-tcl-LC232">    }]} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L233" data-line-number="233"></td>
          <td id="file-lmdb-tcl-LC233">        <span>if</span> {![<span>info</span> exists ::db([<span>lindex</span> <span>$argv</span> 1])]} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L234" data-line-number="234"></td>
          <td id="file-lmdb-tcl-LC234">            <span>set</span> ::db([<span>lindex</span> <span>$argv</span> 1]) {}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L235" data-line-number="235"></td>
          <td id="file-lmdb-tcl-LC235">        } <span>else</span> {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L236" data-line-number="236"></td>
          <td id="file-lmdb-tcl-LC236">            <span>set</span> ::db([<span>lindex</span> <span>$argv</span> 1]) [<span>split</span> <span>$::db([lindex $argv 1])</span>]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L237" data-line-number="237"></td>
          <td id="file-lmdb-tcl-LC237">        }</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L238" data-line-number="238"></td>
          <td id="file-lmdb-tcl-LC238">    }</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L239" data-line-number="239"></td>
          <td id="file-lmdb-tcl-LC239">    <span>if</span> {<span>$dir</span> == 1} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L240" data-line-number="240"></td>
          <td id="file-lmdb-tcl-LC240">        <span>lappend</span> ::db([<span>lindex</span> <span>$argv</span> 1]) [<span>lindex</span> <span>$argv</span> 2]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L241" data-line-number="241"></td>
          <td id="file-lmdb-tcl-LC241">    } <span>else</span> {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L242" data-line-number="242"></td>
          <td id="file-lmdb-tcl-LC242">        headappend ::db([<span>lindex</span> <span>$argv</span> 1]) [<span>lindex</span> <span>$argv</span> 2]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L243" data-line-number="243"></td>
          <td id="file-lmdb-tcl-LC243">    }</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L244" data-line-number="244"></td>
          <td id="file-lmdb-tcl-LC244">    <span>incr</span> ::dirty</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L245" data-line-number="245"></td>
          <td id="file-lmdb-tcl-LC245">    okreset <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L246" data-line-number="246"></td>
          <td id="file-lmdb-tcl-LC246">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L247" data-line-number="247"></td>
          <td id="file-lmdb-tcl-LC247">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L248" data-line-number="248"></td>
          <td id="file-lmdb-tcl-LC248"><span>proc</span> <span>savedb</span> {} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L249" data-line-number="249"></td>
          <td id="file-lmdb-tcl-LC249">    <span>set</span> err [<span>catch</span> {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L250" data-line-number="250"></td>
          <td id="file-lmdb-tcl-LC250">        <span>set</span> fp [<span>open</span> <span><span>&#34;</span>saved.lmdb<span>&#34;</span></span> w]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L251" data-line-number="251"></td>
          <td id="file-lmdb-tcl-LC251">        <span>fconfigure</span> <span>$fp</span> -encoding binary -translation binary</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L252" data-line-number="252"></td>
          <td id="file-lmdb-tcl-LC252">        <span>set</span> search [<span>array</span> startsearch ::db]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L253" data-line-number="253"></td>
          <td id="file-lmdb-tcl-LC253">        <span>set</span> elements [<span>array</span> size ::db]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L254" data-line-number="254"></td>
          <td id="file-lmdb-tcl-LC254">        <span>for</span> {<span>set</span> i 0} {<span>$i</span> &lt; <span>$elements</span>} {<span>incr</span> i} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L255" data-line-number="255"></td>
          <td id="file-lmdb-tcl-LC255">            <span>set</span> key [<span>array</span> nextelement ::db <span>$search</span>]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L256" data-line-number="256"></td>
          <td id="file-lmdb-tcl-LC256">            <span>set</span> val <span>$::db($key)</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L257" data-line-number="257"></td>
          <td id="file-lmdb-tcl-LC257">            <span>puts</span> <span>$fp</span> <span><span>&#34;</span><span><span>[</span><span>string</span> length <span>$key</span><span>]</span></span> <span><span>[</span><span>string</span> length <span>$val</span><span>]</span></span><span>&#34;</span></span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L258" data-line-number="258"></td>
          <td id="file-lmdb-tcl-LC258">            <span>puts</span> -nonewline <span>$fp</span> <span>$key</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L259" data-line-number="259"></td>
          <td id="file-lmdb-tcl-LC259">            <span>puts</span> -nonewline <span>$fp</span> <span>$val</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L260" data-line-number="260"></td>
          <td id="file-lmdb-tcl-LC260">        }</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L261" data-line-number="261"></td>
          <td id="file-lmdb-tcl-LC261">        <span>close</span> <span>$fp</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L262" data-line-number="262"></td>
          <td id="file-lmdb-tcl-LC262">        <span>set</span> ::dirty 0</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L263" data-line-number="263"></td>
          <td id="file-lmdb-tcl-LC263">        <span>set</span> ::lastsaved [<span>clock</span> seconds]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L264" data-line-number="264"></td>
          <td id="file-lmdb-tcl-LC264">    } errmsg]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L265" data-line-number="265"></td>
          <td id="file-lmdb-tcl-LC265">    <span>if</span> {<span>$err</span>} {<span>return</span> <span>$errmsg</span>}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L266" data-line-number="266"></td>
          <td id="file-lmdb-tcl-LC266">    <span>return</span> {}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L267" data-line-number="267"></td>
          <td id="file-lmdb-tcl-LC267">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L268" data-line-number="268"></td>
          <td id="file-lmdb-tcl-LC268">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L269" data-line-number="269"></td>
          <td id="file-lmdb-tcl-LC269"><span>proc</span> <span>backgroundsave</span> {} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L270" data-line-number="270"></td>
          <td id="file-lmdb-tcl-LC270">    <span>unset</span> -nocomplain ::dbcopy</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L271" data-line-number="271"></td>
          <td id="file-lmdb-tcl-LC271">    <span>array</span> set ::dbcopy [<span>array</span> get ::db]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L272" data-line-number="272"></td>
          <td id="file-lmdb-tcl-LC272">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L273" data-line-number="273"></td>
          <td id="file-lmdb-tcl-LC273">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L274" data-line-number="274"></td>
          <td id="file-lmdb-tcl-LC274"><span>proc</span> <span>cmd_bgsave</span> {fd argv} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L275" data-line-number="275"></td>
          <td id="file-lmdb-tcl-LC275">    backgroundsave</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L276" data-line-number="276"></td>
          <td id="file-lmdb-tcl-LC276">    okreset <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L277" data-line-number="277"></td>
          <td id="file-lmdb-tcl-LC277">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L278" data-line-number="278"></td>
          <td id="file-lmdb-tcl-LC278">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L279" data-line-number="279"></td>
          <td id="file-lmdb-tcl-LC279"><span>proc</span> <span>cmd_save</span> {fd argv} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L280" data-line-number="280"></td>
          <td id="file-lmdb-tcl-LC280">    <span>set</span> errmsg [savedb]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L281" data-line-number="281"></td>
          <td id="file-lmdb-tcl-LC281">    <span>if</span> {<span>$errmsg</span> ne {}} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L282" data-line-number="282"></td>
          <td id="file-lmdb-tcl-LC282">        okreset <span>$fd</span> <span><span>&#34;</span>ER<span>&#34;</span></span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L283" data-line-number="283"></td>
          <td id="file-lmdb-tcl-LC283">        warning <span><span>&#34;</span>Error trying to save: <span>$errmsg</span><span>&#34;</span></span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L284" data-line-number="284"></td>
          <td id="file-lmdb-tcl-LC284">    } <span>else</span> {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L285" data-line-number="285"></td>
          <td id="file-lmdb-tcl-LC285">        okreset <span>$fd</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L286" data-line-number="286"></td>
          <td id="file-lmdb-tcl-LC286">        log <span><span>&#34;</span>State saved<span>&#34;</span></span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L287" data-line-number="287"></td>
          <td id="file-lmdb-tcl-LC287">    }</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L288" data-line-number="288"></td>
          <td id="file-lmdb-tcl-LC288">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L289" data-line-number="289"></td>
          <td id="file-lmdb-tcl-LC289">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L290" data-line-number="290"></td>
          <td id="file-lmdb-tcl-LC290"><span>proc</span> <span>loaddb</span> {} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L291" data-line-number="291"></td>
          <td id="file-lmdb-tcl-LC291">    <span>set</span> err [<span>catch</span> {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L292" data-line-number="292"></td>
          <td id="file-lmdb-tcl-LC292">        <span>set</span> fp [<span>open</span> <span><span>&#34;</span>saved.lmdb<span>&#34;</span></span>]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L293" data-line-number="293"></td>
          <td id="file-lmdb-tcl-LC293">        <span>fconfigure</span> <span>$fp</span> -encoding binary -translation binary</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L294" data-line-number="294"></td>
          <td id="file-lmdb-tcl-LC294">        <span>set</span> count 0</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L295" data-line-number="295"></td>
          <td id="file-lmdb-tcl-LC295">        <span>while</span> {[<span>gets</span> <span>$fp</span> len] != -1} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L296" data-line-number="296"></td>
          <td id="file-lmdb-tcl-LC296">            <span>set</span> key [<span>read</span> <span>$fp</span> [<span>lindex</span> <span>$len</span> 0]]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L297" data-line-number="297"></td>
          <td id="file-lmdb-tcl-LC297">            <span>set</span> val [<span>read</span> <span>$fp</span> [<span>lindex</span> <span>$len</span> 1]]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L298" data-line-number="298"></td>
          <td id="file-lmdb-tcl-LC298">            <span>set</span> ::db(<span>$key</span>) <span>$val</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L299" data-line-number="299"></td>
          <td id="file-lmdb-tcl-LC299">            <span>incr</span> count</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L300" data-line-number="300"></td>
          <td id="file-lmdb-tcl-LC300">        }</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L301" data-line-number="301"></td>
          <td id="file-lmdb-tcl-LC301">        log <span><span>&#34;</span><span>$count</span> keys loaded<span>&#34;</span></span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L302" data-line-number="302"></td>
          <td id="file-lmdb-tcl-LC302">        <span>close</span> <span>$fp</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L303" data-line-number="303"></td>
          <td id="file-lmdb-tcl-LC303">    } errmsg]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L304" data-line-number="304"></td>
          <td id="file-lmdb-tcl-LC304">    <span>if</span> {<span>$err</span>} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L305" data-line-number="305"></td>
          <td id="file-lmdb-tcl-LC305">        warning <span><span>&#34;</span>Loading DB from file: <span>$errmsg</span><span>&#34;</span></span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L306" data-line-number="306"></td>
          <td id="file-lmdb-tcl-LC306">    }</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L307" data-line-number="307"></td>
          <td id="file-lmdb-tcl-LC307">    <span>return</span> <span>$err</span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L308" data-line-number="308"></td>
          <td id="file-lmdb-tcl-LC308">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L309" data-line-number="309"></td>
          <td id="file-lmdb-tcl-LC309">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L310" data-line-number="310"></td>
          <td id="file-lmdb-tcl-LC310"><span>proc</span> <span>main</span> {} {</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L311" data-line-number="311"></td>
          <td id="file-lmdb-tcl-LC311">    log <span><span>&#34;</span>Server started<span>&#34;</span></span></td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L312" data-line-number="312"></td>
          <td id="file-lmdb-tcl-LC312">    <span>if</span> {[<span>file</span> exists saved.lmdb]} loaddb</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L313" data-line-number="313"></td>
          <td id="file-lmdb-tcl-LC313">    <span>set</span> ::dirty 0</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L314" data-line-number="314"></td>
          <td id="file-lmdb-tcl-LC314">    <span>set</span> ::listensocket [<span>socket</span> -server accept 6379]</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L315" data-line-number="315"></td>
          <td id="file-lmdb-tcl-LC315">    cron</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L316" data-line-number="316"></td>
          <td id="file-lmdb-tcl-LC316">}</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L317" data-line-number="317"></td>
          <td id="file-lmdb-tcl-LC317">
</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L318" data-line-number="318"></td>
          <td id="file-lmdb-tcl-LC318">main</td>
        </tr>
        <tr>
          <td id="file-lmdb-tcl-L319" data-line-number="319"></td>
          <td id="file-lmdb-tcl-LC319"><span>vwait</span> forever</td>
        </tr>
  </tbody></div></div>
  </body>
</html>
