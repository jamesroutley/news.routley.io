<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/openairplay/airplay2-receiver">Original</a>
    <h1>Open AirPlay 2 Receiver</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">Somewhat comprehensive python implementation of AP2 receiver using <strong>some
multi-room</strong> features. For now it implements:</p>
<ul dir="auto">
<li>HomeKit transient pairing (SRP/Curve25519/ChaCha20-Poly1305) - bit flag 48</li>
<li>HomeKit non-transient pairing</li>
<li>Some refinements for HomeKit interaction (e.g. managed/active flags)</li>
<li>Persist device name and some HomeKit properties across restarts (just use the -m flag again to set the device name anew)</li>
<li>FairPlay (v3) authentication and decryption of AES keys - the first and only Python implementation. Credit to @systemcrash for implementation.</li>
<li>Receiving of both REALTIME and BUFFERED Airplay2 audio streams</li>
<li>Airplay2 Service publication</li>
<li>Decoding of all Airplay2 supported CODECs: ALAC, AAC, OPUS, PCM.
Ref: <a href="https://emanuelecozzi.net/docs/airplay2/audio/" rel="nofollow">here</a> and
<a href="https://emanuelecozzi.net/docs/airplay2/rtsp/#setup" rel="nofollow">here</a></li>
<li>Output latency compensation for sync with other Airplay receivers</li>
<li>ANNOUNCE and RSA AES for unbuffered streaming from iTunes/Windows</li>
<li>Spotify (via AirPlay2) and other live media streams with AES keys.</li>
<li>RTCP</li>
<li>RFC2198 RTP Redundancy handling (basic); enable bit flag 61</li>
<li>streamConnections; enable bit flag 59</li>
</ul>
<p dir="auto">For now it does not implement:</p>
<ul dir="auto">
<li>FairPlay v2</li>
<li>Accurate audio sync (with help of PTP and/or NTP)</li>
</ul>
<p dir="auto">It may never implement:</p>
<ul dir="auto">
<li>MFi Authentication (requires MFi hardware module)</li>
</ul>
<p dir="auto"><strong>This code is experimental, yet fully functional. It can act as a real receiver but does not implement all airplay protocols and related pairing/authentication methods.</strong></p>
<p dir="auto">Next steps:</p>
<ul dir="auto">
<li>PTP (Precision Time Protocol)</li>
<li>Remove all os specific code (Soft Volume management)</li>
<li>Sender (branch-sender) - Implementation</li>
<li>Raspbian package</li>
<li>DACP/(+MRP?) Support</li>
<li>FairPlay v2 Support</li>
</ul>
<hr/>
<h2 dir="auto"><a id="user-content-multiple-connections" href="#multiple-connections" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Multiple Connections</h2>
<p dir="auto">Since multithreading is now enabled, this allows multiple concurrent connections. There are no safeguards
built to prevent you playing multiple streams. Python multiprocessing makes this &#34;DJ&#34; mode a
possibility but makes stream management and session management (global state data) nigh impossible. So
threading is the right approach in the receiver.</p>
<p dir="auto">HomeKit and other AP senders can now connect concurrently to the receiver and perform operations. This
opens the path to Remote Control functionality.</p>
<h2 dir="auto"><a id="user-content-mdnszeroconf" href="#mdnszeroconf" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>mDNS/ZeroConf</h2>
<p dir="auto">If you encounter strange errors like NonUniqueNameException, or Address already in use,
and you run on macOS, you may have noticed that macOS and this app both try to send updates.
<a href="https://github.com/jstasiak/python-zeroconf/issues/967#issuecomment-949110570" data-hovercard-type="issue" data-hovercard-url="/jstasiak/python-zeroconf/issues/967/hovercard">Here is a possible workaround</a>.</p>
<h2 dir="auto"><a id="user-content-raspberry-pi-4" href="#raspberry-pi-4" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Raspberry Pi 4</h2>
<p dir="auto">Install docker and then build the image:</p>
<div data-snippet-clipboard-copy-content="docker build -f docker/Dockerfile -t ap2-receiver ."><pre>docker build -f docker/Dockerfile -t ap2-receiver <span>.</span></pre></div>
<p dir="auto">To run the receiver:</p>
<div data-snippet-clipboard-copy-content="docker run -it --rm --device /dev/snd --net host --volume `pwd`/pairings/:/airplay2/pairings/ ap2-receiver"><pre>docker run -it --rm --device /dev/snd --net host --volume <span><span>`</span>pwd<span>`</span></span>/pairings/:/airplay2/pairings/ ap2-receiver</pre></div>
<p dir="auto">Default network device is wlan0, you can change this with AP2IFACE env variable:</p>
<div data-snippet-clipboard-copy-content="docker run -it --rm --device /dev/snd --env AP2IFACE=eth0 --net host ap2-receiver"><pre>docker run -it --rm --device /dev/snd --env AP2IFACE=eth0 --net host ap2-receiver</pre></div>
<h2 dir="auto"><a id="user-content-docker-compose" href="#docker-compose" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Docker Compose</h2>
<p dir="auto">Example Docker Compose</p>
<div data-snippet-clipboard-copy-content="docker-compose -f docker/docker-compose.yaml up"><pre>docker-compose -f docker/docker-compose.yaml up</pre></div>
<h2 dir="auto"><a id="user-content-debian" href="#debian" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Debian</h2>
<div data-snippet-clipboard-copy-content="sudo apt install -y libavformat-dev libavcodec-dev libavdevice-dev libavutil-dev libswscale-dev libswresample-dev libavfilter-dev portaudio19-dev python3 python3-pip python3-pyaudio build-essential pkg-config git alsa-utils
git clone https://github.com/openairplay/airplay2-receiver.git
cd airplay2-receiver/
pip3 install virtualenv
virtualenv airplay2-receiver
cd airplay2-receiver/
pip3 install -r requirements.txt
pip3 install pyaudio"><pre>sudo apt install -y libavformat-dev libavcodec-dev libavdevice-dev libavutil-dev libswscale-dev libswresample-dev libavfilter-dev portaudio19-dev python3 python3-pip python3-pyaudio build-essential pkg-config git alsa-utils
git clone https://github.com/openairplay/airplay2-receiver.git
<span>cd</span> airplay2-receiver/
pip3 install virtualenv
virtualenv airplay2-receiver
<span>cd</span> airplay2-receiver/
pip3 install -r requirements.txt
pip3 install pyaudio</pre></div>
<h2 dir="auto"><a id="user-content-macos-catalina" href="#macos-catalina" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>macOS Catalina</h2>
<p dir="auto">To run the receiver please use Python 3 and do the following:</p>
<ul dir="auto">
<li>Run the following commands</li>
</ul>
<div data-snippet-clipboard-copy-content="brew install python3
brew install portaudio
virtualenv -p /usr/local/bin/python3 proto
source proto/bin/activate
pip install -r requirements.txt
pip install --global-option=build_ext --global-option=&#34;-I/usr/local/Cellar/portaudio/19.6.0/include&#34; --global-option=&#34;-L/usr/local/Cellar/portaudio/19.6.0/lib&#34; pyaudio


python ap2-receiver.py -m myap2 --netiface=en0"><pre>brew install python3
brew install portaudio
virtualenv -p /usr/local/bin/python3 proto
<span>source</span> proto/bin/activate
pip install -r requirements.txt
pip install --global-option=build_ext --global-option=<span><span>&#34;</span>-I/usr/local/Cellar/portaudio/19.6.0/include<span>&#34;</span></span> --global-option=<span><span>&#34;</span>-L/usr/local/Cellar/portaudio/19.6.0/lib<span>&#34;</span></span> pyaudio


python ap2-receiver.py -m myap2 --netiface=en0</pre></div>
<h2 dir="auto"><a id="user-content-windows" href="#windows" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Windows</h2>
<p dir="auto">To run the receiver please use Python 3 and do the following:</p>
<ul dir="auto">
<li>Run the following commands</li>
</ul>
<div data-snippet-clipboard-copy-content="cd [WHERE_YOU_CLONED_AIRPLAY2_RECEIVER]
virtualenv ap2env
.\ap2env\Scripts\activate
pip install -r requirements.txt
pip install pipwin pycaw
pipwin install pyaudio

python ap2-receiver.py -m myap2 -n [YOUR_INTERFACE_GUID] (looks like this for instance {02681AC0-AD52-4E15-9BD6-8C6A08C4F836} )"><pre><span>cd</span> [WHERE_YOU_CLONED_AIRPLAY2_RECEIVER]
virtualenv ap2env
.<span>\a</span>p2env<span>\S</span>cripts<span>\a</span>ctivate
pip install -r requirements.txt
pip install pipwin pycaw
pipwin install pyaudio

python ap2-receiver.py -m myap2 -n [YOUR_INTERFACE_GUID] (looks like this <span>for</span> instance {02681AC0-AD52-4E15-9BD6-8C6A08C4F836} )</pre></div>
<ul dir="auto">
<li>the AirPlay 2 receiver is announced as <strong>myap2</strong>.</li>
</ul>
<hr/>
<p dir="auto">Tested on Python 3.7.5 / macOS 10.15.2 with iPhone X 13.3 and Raspberry Pi 4</p>
<h3 dir="auto"><a id="user-content-protocol-notes" href="#protocol-notes" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Protocol notes</h3>
<p dir="auto"><a href="https://emanuelecozzi.net/docs/airplay2" rel="nofollow">https://emanuelecozzi.net/docs/airplay2</a></p>
</article>
          </div></div>
  </body>
</html>
