<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/cakehonolulu/pciem">Original</a>
    <h1>Linux kernel framework for PCIe device emulation, in userspace</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text"><p><a target="_blank" rel="noopener noreferrer" href="https://github.com/cakehonolulu/pciem/blob/main/resources/icon.png"><img src="https://github.com/cakehonolulu/pciem/raw/main/resources/icon.png"/></a>
</p>
<p>
  A Linux kernel framework for synthetic PCIe device emulation entirely in userspace.
</p>


<p dir="auto">PCIem is a framework that creates virtual PCIe devices in the Linux kernel by leveraging a few novel techniques to populate synthetic cards as legitimate PCI devices to the host OS.</p>
<p dir="auto">To brief what PCIem is: a framework for developing and testing PCIe device drivers without requiring actual hardware.</p>

<div data-snippet-clipboard-copy-content="┌──────────────────────────────────────────┐                                   ┌──────────────────────────────────────────────────┐
│                                          │                                   │                                                  │
│ ┌─────────►Host Linux Kernel             │                                   │                  Linux Userspace                 │
│ │                                        │                                   │                                                  │
│ │                                        │                                   │                                                  │
│ │    ┌────────────────────────────┐      │                                   │    ┌────────────────────────────────────────┐    │
│ │    │      PCIem Framework       ◄──────┼────────────►/dev/pciem◄───────────┼────►          Userspace PCI shim            │    │
│ │    │                            │      │                                   │    │                                        │    │
│ │    │ - PCI Config Space         │      │                                   │    │ - Emulates PCIe device logic           │    │
│ │    │                            │      │                                   │    │                                        │    │
│ │    │ - BAR Mappings             │      │                                   │    └────────────────────────────────────────┘    │
│ │    │                            │      │                                   │                                                  │
│ │◄───┤ - INT/MSI/MSI-X Interrupts │      │                                   │                                                  │
│ │    │                            │      │                                   └──────────────────────────────────────────────────┘
│ │    │ - DMA (With/without IOMMU) │      │                                                         Userspace                     
│ │    │                            │      │                                                                                       
│ │    │ - P2P DMA                  │      │                                                                                       
│ │    │                            │      │                                                                                       
│ │    └────────────────────────────┘      │                                                                                       
│ │                                        │                                                                                       
│ │                                        │                                                                                       
│ │    PCIe driver is unaware of PCIem     │                                                                                       
│ │                                        │                                                                                       
│ │                                        │                                                                                       
│ │ ┌──────────────────────────────────┐   │                                                                                       
│ │ │          Real PCIe Driver        │   │                                                                                       
│ │ │                                  │   │                                                                                       
│ └─┤ - Untouched logic from production│   │                                                                                       
│   │                                  │   │                                                                                       
│   └──────────────────────────────────┘   │                                                                                       
│                                          │                                                                                       
└──────────────────────────────────────────┘                                                                                       
               Kernel Space                                                                                                        "><pre><code>┌──────────────────────────────────────────┐                                   ┌──────────────────────────────────────────────────┐
│                                          │                                   │                                                  │
│ ┌─────────►Host Linux Kernel             │                                   │                  Linux Userspace                 │
│ │                                        │                                   │                                                  │
│ │                                        │                                   │                                                  │
│ │    ┌────────────────────────────┐      │                                   │    ┌────────────────────────────────────────┐    │
│ │    │      PCIem Framework       ◄──────┼────────────►/dev/pciem◄───────────┼────►          Userspace PCI shim            │    │
│ │    │                            │      │                                   │    │                                        │    │
│ │    │ - PCI Config Space         │      │                                   │    │ - Emulates PCIe device logic           │    │
│ │    │                            │      │                                   │    │                                        │    │
│ │    │ - BAR Mappings             │      │                                   │    └────────────────────────────────────────┘    │
│ │    │                            │      │                                   │                                                  │
│ │◄───┤ - INT/MSI/MSI-X Interrupts │      │                                   │                                                  │
│ │    │                            │      │                                   └──────────────────────────────────────────────────┘
│ │    │ - DMA (With/without IOMMU) │      │                                                         Userspace                     
│ │    │                            │      │                                                                                       
│ │    │ - P2P DMA                  │      │                                                                                       
│ │    │                            │      │                                                                                       
│ │    └────────────────────────────┘      │                                                                                       
│ │                                        │                                                                                       
│ │                                        │                                                                                       
│ │    PCIe driver is unaware of PCIem     │                                                                                       
│ │                                        │                                                                                       
│ │                                        │                                                                                       
│ │ ┌──────────────────────────────────┐   │                                                                                       
│ │ │          Real PCIe Driver        │   │                                                                                       
│ │ │                                  │   │                                                                                       
│ └─┤ - Untouched logic from production│   │                                                                                       
│   │                                  │   │                                                                                       
│   └──────────────────────────────────┘   │                                                                                       
│                                          │                                                                                       
└──────────────────────────────────────────┘                                                                                       
               Kernel Space                                                                                                        
</code></pre></div>

<ul dir="auto">
<li><strong>BAR Support</strong>: Register and manage BARs programmatically</li>
<li><strong>Watchpoints</strong>: Event-driven architecture using CPU watchpoints for access detection</li>
<li><strong>Legacy IRQ/MSI/MSI-X Support</strong>: Full interrupt support with dynamic triggering</li>
<li><strong>PCI Capability Framework</strong>: Modular PCI capabilities system (Linked-list underneath)</li>
<li><strong>DMA System</strong>: IOMMU-aware DMA operations with atomic memory operations support</li>
<li><strong>P2P DMA</strong>: Peer-to-peer DMA between devices with whitelist-based access control</li>
<li><strong>Userspace-defined</strong>: Implement your PCIe prototypes anywhere</li>
</ul>


<p dir="auto">The card is programmed entirely in QEMU, who does all the userspace initialization and command handling from the real driver running in the host. Can run software-rendered DOOM (Submits finished frames with DMA to the card which QEMU displays) and also simple OpenGL 1.X games (On the screenshots, tyr-glquake and xash3d; thanks to a custom OpenGL state machine implemented entirely in QEMU that software-renders the command lists and updates the internal state accordingly).</p>
<p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://private-user-images.githubusercontent.com/30508313/527038927-16f64475-ee51-4f79-ae17-b06363f0b12a.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3Njg5MzQ1MTQsIm5iZiI6MTc2ODkzNDIxNCwicGF0aCI6Ii8zMDUwODMxMy81MjcwMzg5MjctMTZmNjQ0NzUtZWU1MS00Zjc5LWFlMTctYjA2MzYzZjBiMTJhLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNjAxMjAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjYwMTIwVDE4MzY1NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTM3ZjE3MTdhNGJiNGIwMDFhYWZmMjUzNGFlMWNjMmQwYzFhNWEyNmQ5YWJhNTk3ZTY2OTI2NTFlNTljZGI3NmYmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.ASCxYorxVGJcqEGrvmnD01s2fwWxn_zKHCHRO-Jnlr4"><img width="1903" height="1029" alt="imagen" src="https://private-user-images.githubusercontent.com/30508313/527038927-16f64475-ee51-4f79-ae17-b06363f0b12a.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3Njg5MzQ1MTQsIm5iZiI6MTc2ODkzNDIxNCwicGF0aCI6Ii8zMDUwODMxMy81MjcwMzg5MjctMTZmNjQ0NzUtZWU1MS00Zjc5LWFlMTctYjA2MzYzZjBiMTJhLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNjAxMjAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjYwMTIwVDE4MzY1NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTM3ZjE3MTdhNGJiNGIwMDFhYWZmMjUzNGFlMWNjMmQwYzFhNWEyNmQ5YWJhNTk3ZTY2OTI2NTFlNTljZGI3NmYmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.ASCxYorxVGJcqEGrvmnD01s2fwWxn_zKHCHRO-Jnlr4"/></a>
</p>
<p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://private-user-images.githubusercontent.com/30508313/527040643-4ad00e14-83e5-4e1f-b374-fbaa92def4e3.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3Njg5MzQ1MTQsIm5iZiI6MTc2ODkzNDIxNCwicGF0aCI6Ii8zMDUwODMxMy81MjcwNDA2NDMtNGFkMDBlMTQtODNlNS00ZTFmLWIzNzQtZmJhYTkyZGVmNGUzLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNjAxMjAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjYwMTIwVDE4MzY1NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWE0MDcyNmU1NDIyMTcwNzQzMWViMDMxMTlhYmY0ODU0MjhmYThjY2U4MzVhZTBhMjZjODEwMTBiNGFmYTI0MGEmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.xxugM0KQ-Ulf07G9zhsBVtfpRBS9bjDHaattiV_ZBU8"><img width="1757" height="893" alt="imagen" src="https://private-user-images.githubusercontent.com/30508313/527040643-4ad00e14-83e5-4e1f-b374-fbaa92def4e3.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3Njg5MzQ1MTQsIm5iZiI6MTc2ODkzNDIxNCwicGF0aCI6Ii8zMDUwODMxMy81MjcwNDA2NDMtNGFkMDBlMTQtODNlNS00ZTFmLWIzNzQtZmJhYTkyZGVmNGUzLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNjAxMjAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjYwMTIwVDE4MzY1NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWE0MDcyNmU1NDIyMTcwNzQzMWViMDMxMTlhYmY0ODU0MjhmYThjY2U4MzVhZTBhMjZjODEwMTBiNGFmYTI0MGEmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.xxugM0KQ-Ulf07G9zhsBVtfpRBS9bjDHaattiV_ZBU8"/></a>
</p>
<p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://private-user-images.githubusercontent.com/30508313/527041073-d21a7d84-f857-4790-bdc6-7bf2714e9eda.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3Njg5MzQ1MTQsIm5iZiI6MTc2ODkzNDIxNCwicGF0aCI6Ii8zMDUwODMxMy81MjcwNDEwNzMtZDIxYTdkODQtZjg1Ny00NzkwLWJkYzYtN2JmMjcxNGU5ZWRhLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNjAxMjAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjYwMTIwVDE4MzY1NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTlhYWZhNDY5MDA2NWZhODMzZThlMzVhNzM2ZGIzZDdlMjJjNTY4MzNhNDhhNGQ5OWFlNDIwYjIwNWU4ZjdiZjYmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.-QLV3e8JxRdV41Z0IG0eVjNqsoHD7NkFYaSjwI9PoEw"><img width="1227" height="846" alt="imagen" src="https://private-user-images.githubusercontent.com/30508313/527041073-d21a7d84-f857-4790-bdc6-7bf2714e9eda.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3Njg5MzQ1MTQsIm5iZiI6MTc2ODkzNDIxNCwicGF0aCI6Ii8zMDUwODMxMy81MjcwNDEwNzMtZDIxYTdkODQtZjg1Ny00NzkwLWJkYzYtN2JmMjcxNGU5ZWRhLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNjAxMjAlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjYwMTIwVDE4MzY1NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTlhYWZhNDY5MDA2NWZhODMzZThlMzVhNzM2ZGIzZDdlMjJjNTY4MzNhNDhhNGQ5OWFlNDIwYjIwNWU4ZjdiZjYmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.-QLV3e8JxRdV41Z0IG0eVjNqsoHD7NkFYaSjwI9PoEw"/></a>
</p>

<p dir="auto">Dual MIT/GPLv2 (pciem_framework.c and protopciem_driver.c)</p>
<p dir="auto">MIT (Rest)</p>

<ul dir="auto">
<li>Blog post: <a href="https://cakehonolulu.github.io/introducing-pciem/" rel="nofollow">https://cakehonolulu.github.io/introducing-pciem/</a></li>
<li>Documentation: <a href="https://cakehonolulu.github.io/docs/pciem/" rel="nofollow">https://cakehonolulu.github.io/docs/pciem/</a></li>
<li>PCI Express specification: <a href="https://pcisig.com/specifications" rel="nofollow">https://pcisig.com/specifications</a></li>
</ul>
</article></div></div>
  </body>
</html>
