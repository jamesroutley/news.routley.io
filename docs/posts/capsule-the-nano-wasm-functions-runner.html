<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/bots-garden/capsule">Original</a>
    <h1>Capsule: the nano (WASM) functions runner</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/bots-garden/capsule/blob/main/logos/capsule-logo-readme.png"><img src="https://github.com/bots-garden/capsule/raw/main/logos/capsule-logo-readme.png" alt="capsule-logo.png" width="10%" height="10%"/></a></p>

<blockquote>
<ul dir="auto">
<li><g-emoji alias="raised_hand_with_fingers_splayed" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f590.png">üñê</g-emoji> I&#39;m learning Go</li>
<li>Issues: <a href="https://github.com/bots-garden/capsule/issues">https://github.com/bots-garden/capsule/issues</a></li>
<li>Last release: <code>v0.2.6 üêù [Bee]</code></li>
<li>Dev release: <code>v0.2.7 ü¶ö [peacock][dev]</code> <em><g-emoji alias="construction" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a7.png">üöß</g-emoji> in progress</em></li>
</ul>
</blockquote>
<h2 dir="auto"><a id="user-content-whats-new" aria-hidden="true" href="#whats-new"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>What&#39;s new</h2>
<ul dir="auto">
<li><code>v0.2.6</code>: Wazero: updates to <code>1.0.0-pre.2</code> by <a href="https://github.com/codefromthecrypt">@codefromthecrypt</a> + a logo</li>
<li><code>v0.2.5</code>: Add MQTT support by <a href="https://github.com/py4mac">@py4mac</a> with <code>MqttPublish</code> &amp; <code>MqttPublish</code></li>
<li><code>v0.2.4</code>: Add 2 wasm helper functions <code>flatjson.StrToMap</code> and <code>flatjson.MapToStr</code></li>
<li><code>v0.2.3</code>: NATS support, 2 new functions: <code>NatsReply</code> and <code>NatsConnectRequest</code></li>
<li><code>v0.2.2</code>: like <code>0.2.1</code> with fixed modules dependencies, and tag name start with a <code>v</code></li>
<li><code>0.2.1</code>: NATS support (1st stage) <code>OnNatsMessage</code>, <code>NatsPublish</code>, <code>NatsConnectPublish</code>, <code>NatsConnectPublish</code>, <code>NatsGetSubject</code>, <code>NatsGetServer</code></li>
<li><code>0.2.0</code>: <code>OnLoad</code> &amp; <code>OnExit</code> functions + Memory cache host functions (<code>MemorySet</code>, <code>MemoryGet</code>, <code>MemoryKeys</code>)</li>
<li><code>0.1.9</code>: Add <code>Request</code> and <code>Response</code> types (for the Handle function)</li>
<li><code>0.1.8</code>: Redis host functions: add the KEYS command (<code>RedisKeys(pattern string)</code>)</li>
</ul>
<h2 dir="auto"><a id="user-content-what-is-capsule" aria-hidden="true" href="#what-is-capsule"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>What is <strong>Capsule</strong>?</h2>
<p dir="auto"><strong>Capsule</strong> is a WebAssembly function launcher(runner). It means that, with <strong>Capsule</strong> you can:</p>
<ul dir="auto">
<li>From your terminal, execute a function of a wasm module (the <strong>&#34;CLI mode&#34;</strong>)</li>
<li>Serving a function of a wasm module through http (the <strong>&#34;HTTP mode&#34;</strong>)</li>
<li>Serving a function of a wasm module through NATS (the <strong>&#34;NATS mode&#34;</strong>), in this case <strong>Capsule</strong> is used as a NATS subscriber and can reply on a subject(topic)</li>
<li>Serving a function of a wasm module through MQTT (the <strong>&#34;MQTT mode&#34;</strong>), in this case <strong>Capsule</strong> is used as a MQTT subscriber and can reply on a subject(topic)</li>
</ul>
<blockquote>
<p dir="auto"><g-emoji alias="raised_hand_with_fingers_splayed" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f590.png">üñê</g-emoji> <strong>The functions are developed with GoLang and compiled to wasm with TinyGo</strong></p>
</blockquote>
<p dir="auto"><g-emoji alias="package" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4e6.png">üì¶</g-emoji> Before executing or running a function, you need to download the last release of <strong>Capsule</strong>: <a href="https://github.com/bots-garden/capsule/releases/tag/v0.2.6">https://github.com/bots-garden/capsule/releases/tag/v0.2.6</a> (<code>v0.2.6 üêù [Bee]</code>)</p>
<blockquote>
<ul dir="auto">
<li><strong>Capsule</strong> is developed with GoLang and thanks to the <g-emoji alias="purple_heart" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f49c.png">üíú</g-emoji> <strong><a href="https://github.com/tetratelabs/wazero">Wazero</a></strong> project</li>
<li>The wasm modules are developed in GoLang and compiled with TinyGo (with the WASI specification)</li>
</ul>
</blockquote>
<p dir="auto"><g-emoji alias="wave" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f44b.png">üëã</g-emoji> You will find some <strong>running examples</strong> with these projects:</p>
<ul dir="auto">
<li><a href="https://github.com/bots-garden/capsule-launcher-demo">https://github.com/bots-garden/capsule-launcher-demo</a></li>
<li><a href="https://github.com/bots-garden/capsule-hello-universe">https://github.com/bots-garden/capsule-hello-universe</a></li>
</ul>
<blockquote>
<p dir="auto">Old samples to be updated:</p>
<ul dir="auto">
<li><a href="https://github.com/bots-garden/capsule-samples">https://github.com/bots-garden/capsule-samples</a></li>
<li><a href="https://github.com/bots-garden/capsule-on-fly-dot-io">https://github.com/bots-garden/capsule-on-fly-dot-io</a></li>
</ul>
</blockquote>
<h2 dir="auto"><a id="user-content-first-cli-function" aria-hidden="true" href="#first-cli-function"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>First CLI function</h2>
<p dir="auto">Create a <code>go.mod</code> file: (<code>go mod init cli-say-hello</code>)</p>
<div data-snippet-clipboard-copy-content="module cli-say-hello

go 1.18"><pre><code>module cli-say-hello

go 1.18
</code></pre></div>
<p dir="auto">Install the Capsule dependencies:</p>
<div dir="auto" data-snippet-clipboard-copy-content="go get github.com/bots-garden/capsule/capsulemodule/hostfunctions"><pre>go get github.com/bots-garden/capsule/capsulemodule/hostfunctions</pre></div>
<p dir="auto">Create a <code>hello.go</code> file:</p>
<div dir="auto" data-snippet-clipboard-copy-content="package main

import hf &#34;github.com/bots-garden/capsule/capsulemodule/hostfunctions&#34;

// main is required.
func main() {
	hf.SetHandle(Handle)
}

func Handle(params []string) (string, error) {
	var err error
	for _, param := range params {
		hf.Log(&#34;- parameter is: &#34; + param)
	}

    ret := &#34;The first parameter is: &#34; + params[0]

    return ret, err // err = nil
}"><pre><span>package</span> main

<span>import</span> hf <span>&#34;github.com/bots-garden/capsule/capsulemodule/hostfunctions&#34;</span>

<span>// main is required.</span>
<span>func</span> <span>main</span>() {
	<span>hf</span>.<span>SetHandle</span>(<span>Handle</span>)
}

<span>func</span> <span>Handle</span>(<span>params</span> []<span>string</span>) (<span>string</span>, <span>error</span>) {
	<span>var</span> <span>err</span> <span>error</span>
	<span>for</span> <span>_</span>, <span>param</span> <span>:=</span> <span>range</span> <span>params</span> {
		<span>hf</span>.<span>Log</span>(<span>&#34;- parameter is: &#34;</span> <span>+</span> <span>param</span>)
	}

    <span>ret</span> <span>:=</span> <span>&#34;The first parameter is: &#34;</span> <span>+</span> <span>params</span>[<span>0</span>]

    <span>return</span> <span>ret</span>, <span>err</span> <span>// err = nil</span>
}</pre></div>
<blockquote>
<ul dir="auto">
<li><code>hf.SetHandle(Handle)</code> defines the called wasm function</li>
<li><code>hf.Log(string)</code> prints a value</li>
</ul>
</blockquote>
<p dir="auto">Build the wasm module:</p>
<div dir="auto" data-snippet-clipboard-copy-content="tinygo build -o hello.wasm -scheduler=none --no-debug -target wasi ./hello.go"><pre>tinygo build -o hello.wasm -scheduler=none --no-debug -target wasi ./hello.go</pre></div>
<p dir="auto">Execute the <code>Handle</code> function:</p>
<div dir="auto" data-snippet-clipboard-copy-content="./capsule \
   -wasm=./hello.wasm \
   -mode=cli \
   &#34;üëã hello world üåçüéÉ&#34; 1234 &#34;Bob Morane&#34;"><pre>./capsule \
   -wasm=./hello.wasm \
   -mode=cli \
   <span><span>&#34;</span>üëã hello world üåçüéÉ<span>&#34;</span></span> 1234 <span><span>&#34;</span>Bob Morane<span>&#34;</span></span></pre></div>
<blockquote>
<ul dir="auto">
<li><code>-wasm</code> flag: the path to the wasm file</li>
<li><code>-mode</code> execution mode</li>
</ul>
</blockquote>
<p dir="auto"><em>output:</em></p>
<div dir="auto" data-snippet-clipboard-copy-content="- parameter is: üëã hello world üåçüéÉ
- parameter is: 1234
- parameter is: Bob Morane
The first parameter is: üëã hello world üåçüéÉ"><pre>- parameter is: üëã hello world üåçüéÉ
- parameter is: 1234
- parameter is: Bob Morane
The first parameter is: üëã hello world üåçüéÉ</pre></div>
<h2 dir="auto"><a id="user-content-first-http-function" aria-hidden="true" href="#first-http-function"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>First HTTP function</h2>
<p dir="auto">Create a <code>go.mod</code> file: (<code>go mod init http-say-hello</code>)</p>
<div data-snippet-clipboard-copy-content="module http-say-hello

go 1.18"><pre><code>module http-say-hello

go 1.18
</code></pre></div>
<p dir="auto">To serve the function through http, you need to change the signature of the <code>Handle</code> function:</p>
<div dir="auto" data-snippet-clipboard-copy-content="package main

import hf &#34;github.com/bots-garden/capsule/capsulemodule/hostfunctions&#34;

// main is required.
func main() {
	hf.SetHandleHttp(Handle)
}

func Handle(request hf.Request) (response hf.Response, errResp error) {
    hf.Log(&#34;üìù Body: &#34; + request.Body)

	// Read the request headers
    hf.Log(&#34;Content-Type: &#34; + request.Headers[&#34;Content-Type&#34;])
    hf.Log(&#34;Content-Length: &#34; + request.Headers[&#34;Content-Length&#34;])
    hf.Log(&#34;User-Agent: &#34; + request.Headers[&#34;User-Agent&#34;])

	// Read the MESSAGE environment variable
	envMessage, err := hf.GetEnv(&#34;MESSAGE&#34;)
	if err != nil {
		hf.Log(&#34;üò° &#34; + err.Error())
	} else {
		hf.Log(&#34;Environment variable: &#34; + envMessage)
	}

	// Set the response content type and add a message header
	headersResp := map[string]string{
		&#34;Content-Type&#34;: &#34;application/json; charset=utf-8&#34;,
		&#34;Message&#34;:      &#34;üëã hello world üåç&#34;,
	}

	jsonResponse := `{&#34;message&#34;: &#34;hey people!&#34;}`

	return hf.Response{Body: jsonResponse, Headers: headersResp}, err
}"><pre><span>package</span> main

<span>import</span> hf <span>&#34;github.com/bots-garden/capsule/capsulemodule/hostfunctions&#34;</span>

<span>// main is required.</span>
<span>func</span> <span>main</span>() {
	<span>hf</span>.<span>SetHandleHttp</span>(<span>Handle</span>)
}

<span>func</span> <span>Handle</span>(<span>request</span> hf.<span>Request</span>) (<span>response</span> hf.<span>Response</span>, <span>errResp</span> <span>error</span>) {
    <span>hf</span>.<span>Log</span>(<span>&#34;üìù Body: &#34;</span> <span>+</span> <span>request</span>.<span>Body</span>)

	<span>// Read the request headers</span>
    <span>hf</span>.<span>Log</span>(<span>&#34;Content-Type: &#34;</span> <span>+</span> <span>request</span>.<span>Headers</span>[<span>&#34;Content-Type&#34;</span>])
    <span>hf</span>.<span>Log</span>(<span>&#34;Content-Length: &#34;</span> <span>+</span> <span>request</span>.<span>Headers</span>[<span>&#34;Content-Length&#34;</span>])
    <span>hf</span>.<span>Log</span>(<span>&#34;User-Agent: &#34;</span> <span>+</span> <span>request</span>.<span>Headers</span>[<span>&#34;User-Agent&#34;</span>])

	<span>// Read the MESSAGE environment variable</span>
	<span>envMessage</span>, <span>err</span> <span>:=</span> <span>hf</span>.<span>GetEnv</span>(<span>&#34;MESSAGE&#34;</span>)
	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
		<span>hf</span>.<span>Log</span>(<span>&#34;üò° &#34;</span> <span>+</span> <span>err</span>.<span>Error</span>())
	} <span>else</span> {
		<span>hf</span>.<span>Log</span>(<span>&#34;Environment variable: &#34;</span> <span>+</span> <span>envMessage</span>)
	}

	<span>// Set the response content type and add a message header</span>
	<span>headersResp</span> <span>:=</span> <span>map</span>[<span>string</span>]<span>string</span>{
		<span>&#34;Content-Type&#34;</span>: <span>&#34;application/json; charset=utf-8&#34;</span>,
		<span>&#34;Message&#34;</span>:      <span>&#34;üëã hello world üåç&#34;</span>,
	}

	<span>jsonResponse</span> <span>:=</span> <span>`{&#34;message&#34;: &#34;hey people!&#34;}`</span>

	<span>return</span> hf.<span>Response</span>{<span>Body</span>: <span>jsonResponse</span>, <span>Headers</span>: <span>headersResp</span>}, <span>err</span>
}</pre></div>
<blockquote>
<ul dir="auto">
<li><code>hf.SetHandleHttp(Handle)</code> defines the called wasm function</li>
<li><code>hf.Log(string)</code> prints a value</li>
<li><code>hf.GetEnv(&#34;MESSAGE&#34;)</code> get the value of the <code>MESSAGE</code> environment variable</li>
</ul>
</blockquote>
<p dir="auto">Build the wasm module:</p>
<div dir="auto" data-snippet-clipboard-copy-content="tinygo build -o hello.wasm -scheduler=none --no-debug -target wasi ./hello.go"><pre>tinygo build -o hello.wasm -scheduler=none --no-debug -target wasi ./hello.go</pre></div>
<p dir="auto">Serve the <code>Handle</code> function:</p>
<div dir="auto" data-snippet-clipboard-copy-content="export MESSAGE=&#34;üñê good morning üòÑ&#34;
./capsule \
   -wasm=./hello.wasm \
   -mode=http \
   -httpPort=8080"><pre><span>export</span> MESSAGE=<span><span>&#34;</span>üñê good morning üòÑ<span>&#34;</span></span>
./capsule \
   -wasm=./hello.wasm \
   -mode=http \
   -httpPort=8080</pre></div>
<p dir="auto">Call the <code>Handle</code> function:</p>
<div dir="auto" data-snippet-clipboard-copy-content="curl -v -X POST \
  http://localhost:8080 \
  -H &#39;content-type: application/json; charset=utf-8&#39; \
  -d &#39;{&#34;message&#34;: &#34;TinyGo üíö wasm&#34;}&#39;"><pre>curl -v -X POST \
  http://localhost:8080 \
  -H <span><span>&#39;</span>content-type: application/json; charset=utf-8<span>&#39;</span></span> \
  -d <span><span>&#39;</span>{&#34;message&#34;: &#34;TinyGo üíö wasm&#34;}<span>&#39;</span></span></pre></div>
<p dir="auto"><em>request output:</em></p>
<div dir="auto" data-snippet-clipboard-copy-content="&gt; POST / HTTP/1.1
&gt; Host: localhost:8080
&gt; User-Agent: curl/7.79.1
&gt; Accept: */*
&gt; content-type: application/json; charset=utf-8
&gt; Content-Length: 31
&gt;
* Mark bundle as not supporting multiuse
&lt; HTTP/1.1 200 OK
&lt; Content-Type: application/json; charset=utf-8
&lt; Message: üëã hello world üåç
&lt; Date: Sat, 30 Jul 2022 19:17:28 GMT
&lt; Content-Length: 26
&lt;
{&#34;message&#34;:&#34;hey people!&#34;}"><pre><span>&gt;</span> POST / HTTP/1.1
<span>&gt;</span> Host: localhost:8080
<span>&gt;</span> User-Agent: curl/7.79.1
<span>&gt;</span> Accept: <span>*</span>/<span>*</span>
<span>&gt;</span> content-type: application/json<span>;</span> charset=utf-8
<span>&gt;</span> Content-Length: 31
<span>&gt;</span>
<span>*</span> Mark bundle as not supporting multiuse
<span>&lt;</span> HTTP/1.1 200 OK
<span>&lt;</span> Content-Type: application/json<span>;</span> charset=utf-8
<span>&lt;</span> Message: üëã hello world üåç
<span>&lt;</span> Date: Sat, 30 Jul 2022 19:17:28 GMT
<span>&lt;</span> Content-Length: 26
<span>&lt;</span>
{<span><span>&#34;</span>message<span>&#34;</span></span>:<span><span>&#34;</span>hey people!<span>&#34;</span></span>}</pre></div>
<p dir="auto"><em>log server output:</em></p>
<div dir="auto" data-snippet-clipboard-copy-content="üìù body: {&#34;message&#34;:&#34;TinyGo üíö wasm&#34;}
Content-Type: application/json; charset=utf-8
Content-Length: 31
User-Agent: curl/7.79.1
Environment variable: üñê good morning üòÑ"><pre>üìù body: {<span><span>&#34;</span>message<span>&#34;</span></span>:<span><span>&#34;</span>TinyGo üíö wasm<span>&#34;</span></span>}
Content-Type: application/json<span>;</span> charset=utf-8
Content-Length: 31
User-Agent: curl/7.79.1
Environment variable: üñê good morning üòÑ</pre></div>
<h3 dir="auto"><a id="user-content-onload-function" aria-hidden="true" href="#onload-function"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>OnLoad function</h3>
<p dir="auto">If you add an <code>OnLoad</code> exported function to the module, it will be executed at the start of the HTTP launcher (capsule).</p>
<blockquote>
<p dir="auto"><em>the <code>main</code> function will be executed too</em></p>
</blockquote>
<div dir="auto" data-snippet-clipboard-copy-content="//export OnLoad
func OnLoad() {
	hf.Log(&#34;üëã from the OnLoad function&#34;)
}"><pre><span>//export OnLoad</span>
<span>func</span> <span>OnLoad</span>() {
	<span>hf</span>.<span>Log</span>(<span>&#34;üëã from the OnLoad function&#34;</span>)
}</pre></div>
<blockquote>
<p dir="auto">It can be useful to register your wasm service to a backend (Redis, CouchBase, ...)</p>
</blockquote>
<h3 dir="auto"><a id="user-content-onexit-function" aria-hidden="true" href="#onexit-function"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>OnExit function</h3>
<p dir="auto">If you add an <code>OnExit</code> exported function to the module, it will be executed when you stop the HTTP launcher (capsule).</p>
<blockquote>
<p dir="auto"><em>the <code>main</code> function will be executed too</em></p>
</blockquote>
<div dir="auto" data-snippet-clipboard-copy-content="//export OnExit
func OnExit() {
	hf.Log(&#34;üëã from the OnExit function&#34;)
}"><pre><span>//export OnExit</span>
<span>func</span> <span>OnExit</span>() {
	<span>hf</span>.<span>Log</span>(<span>&#34;üëã from the OnExit function&#34;</span>)
}</pre></div>
<blockquote>
<p dir="auto">It can be useful to unregister your wasm service from a backend (Redis, CouchBase, ...)</p>
</blockquote>
<h3 dir="auto"><a id="user-content-getexiterror-and-getexitcode-function" aria-hidden="true" href="#getexiterror-and-getexitcode-function"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>GetExitError and GetExitCode function</h3>
<blockquote>
<p dir="auto"><g-emoji alias="raised_hand_with_fingers_splayed" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f590.png">üñê</g-emoji><g-emoji alias="construction" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a7.png">üöß</g-emoji> it&#39;s a work in progress (it&#39;s not implemented entirely)</p>
</blockquote>
<div dir="auto" data-snippet-clipboard-copy-content="//export OnExit
func OnExit() {
	hf.Log(&#34;üëãü§ó have a nice day&#34;)
	hf.Log(&#34;Exit Error: &#34; + hf.GetExitError())
	hf.Log(&#34;Exit Code: &#34; + hf.GetExitCode())
}"><pre><span>//export OnExit</span>
<span>func</span> <span>OnExit</span>() {
	<span>hf</span>.<span>Log</span>(<span>&#34;üëãü§ó have a nice day&#34;</span>)
	<span>hf</span>.<span>Log</span>(<span>&#34;Exit Error: &#34;</span> <span>+</span> <span>hf</span>.<span>GetExitError</span>())
	<span>hf</span>.<span>Log</span>(<span>&#34;Exit Code: &#34;</span> <span>+</span> <span>hf</span>.<span>GetExitCode</span>())
}</pre></div>
<h2 dir="auto"><a id="user-content-remote-loading-of-the-wasm-module" aria-hidden="true" href="#remote-loading-of-the-wasm-module"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Remote loading of the wasm module</h2>
<p dir="auto">You can download the wasm module from a remote location before executing it:</p>
<p dir="auto">For example, provide the wasm file with an HTTP server, run this command at the root of your project:</p>
<div dir="auto" data-snippet-clipboard-copy-content="python3 -m http.server 9090"><pre>python3 -m http.server 9090</pre></div>
<blockquote>
<p dir="auto">Now you can download the wasm file with this url: <a href="http://localhost:9090/hello.wasm" rel="nofollow">http://localhost:9090/hello.wasm</a></p>
</blockquote>
<p dir="auto">Serve the <code>Handle</code> function:</p>
<div dir="auto" data-snippet-clipboard-copy-content="export MESSAGE=&#34;üñê good morning üòÑ&#34;
./capsule \
   -url=http://localhost:9090/hello.wasm \
   -wasm=./tmp/hello.wasm \
   -mode=http \
   -httpPort=8080"><pre><span>export</span> MESSAGE=<span><span>&#34;</span>üñê good morning üòÑ<span>&#34;</span></span>
./capsule \
   -url=http://localhost:9090/hello.wasm \
   -wasm=./tmp/hello.wasm \
   -mode=http \
   -httpPort=8080</pre></div>
<blockquote>
<ul dir="auto">
<li><code>-url</code> flag: the download url</li>
<li><code>-wasm</code> flag: the path where to save the wasm file</li>
</ul>
</blockquote>
<h2 dir="auto"><a id="user-content-get-request" aria-hidden="true" href="#get-request"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>GET Request</h2>
<p dir="auto"><strong>Capsule</strong> accept the <code>GET</code> requests, so you can serve, for example, HTML:</p>
<div dir="auto" data-snippet-clipboard-copy-content="package main

import hf &#34;github.com/bots-garden/capsule/capsulemodule/hostfunctions&#34;

// main is required.
func main() {
	hf.SetHandleHttp(Handle)
}

func Handle(request hf.Request) (response hf.Response, errResp error) {
	html := `
    &lt;html&gt;
        &lt;head&gt;
            &lt;title&gt;Wasm is fantastic üòç&lt;/title&gt;
        &lt;/head&gt;

        &lt;body&gt;
            &lt;h1&gt;üëã Hello World üåç&lt;/h1&gt;
            &lt;h2&gt;Served with üíú with Capsule üíä&lt;/h2&gt;
        &lt;/body&gt;

    &lt;/html&gt;
    `

	headersResp := map[string]string{
		&#34;Content-Type&#34;: &#34;text/html; charset=utf-8&#34;,
	}

	return hf.Response{Body: html, Headers: headersResp}, nil
}"><pre><span>package</span> main

<span>import</span> hf <span>&#34;github.com/bots-garden/capsule/capsulemodule/hostfunctions&#34;</span>

<span>// main is required.</span>
<span>func</span> <span>main</span>() {
	<span>hf</span>.<span>SetHandleHttp</span>(<span>Handle</span>)
}

<span>func</span> <span>Handle</span>(<span>request</span> hf.<span>Request</span>) (<span>response</span> hf.<span>Response</span>, <span>errResp</span> <span>error</span>) {
	<span>html</span> <span>:=</span> <span>`</span>
<span>    &lt;html&gt;</span>
<span>        &lt;head&gt;</span>
<span>            &lt;title&gt;Wasm is fantastic üòç&lt;/title&gt;</span>
<span>        &lt;/head&gt;</span>
<span></span>
<span>        &lt;body&gt;</span>
<span>            &lt;h1&gt;üëã Hello World üåç&lt;/h1&gt;</span>
<span>            &lt;h2&gt;Served with üíú with Capsule üíä&lt;/h2&gt;</span>
<span>        &lt;/body&gt;</span>
<span></span>
<span>    &lt;/html&gt;</span>
<span>    `</span>

	<span>headersResp</span> <span>:=</span> <span>map</span>[<span>string</span>]<span>string</span>{
		<span>&#34;Content-Type&#34;</span>: <span>&#34;text/html; charset=utf-8&#34;</span>,
	}

	<span>return</span> hf.<span>Response</span>{<span>Body</span>: <span>html</span>, <span>Headers</span>: <span>headersResp</span>}, <span>nil</span>
}</pre></div>
<p dir="auto">Build the wasm module:</p>
<div dir="auto" data-snippet-clipboard-copy-content="tinygo build -o hello.wasm -scheduler=none --no-debug -target wasi ./hello.go"><pre>tinygo build -o hello.wasm -scheduler=none --no-debug -target wasi ./hello.go</pre></div>
<p dir="auto">Serve the <code>Handle</code> &#34;function page&#34;:</p>
<div dir="auto" data-snippet-clipboard-copy-content="./capsule \
   -wasm=./hello.wasm \
   -mode=http \
   -httpPort=8080"><pre>./capsule \
   -wasm=./hello.wasm \
   -mode=http \
   -httpPort=8080</pre></div>
<p dir="auto">Now, you can open <a href="http://localhost:8080" rel="nofollow">http://localhost:8080</a> with your browser or run a curl request:</p>
<div dir="auto" data-snippet-clipboard-copy-content="curl http://localhost:8080"><pre>curl http://localhost:8080</pre></div>
<h2 dir="auto"><a id="user-content-first-nats-function" aria-hidden="true" href="#first-nats-function"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>First Nats function</h2>
<blockquote>
<p dir="auto"><g-emoji alias="raised_hand_with_fingers_splayed" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f590.png">üñê</g-emoji><g-emoji alias="construction" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a7.png">üöß</g-emoji> The NAT integration with <strong>Capsule</strong> is a work in progress and the functions are subject to change</p>
</blockquote>
<p dir="auto">NATS is an open-source messaging system.</p>
<blockquote>
<ul dir="auto">
<li>About NATS: <a href="https://nats.io/" rel="nofollow">https://nats.io/</a> and <a href="https://docs.nats.io/" rel="nofollow">https://docs.nats.io/</a></li>
<li>Nats Overview: <a href="https://docs.nats.io/nats-concepts/overview" rel="nofollow">https://docs.nats.io/nats-concepts/overview</a></li>
</ul>
</blockquote>
<h3 dir="auto"><a id="user-content-requirements" aria-hidden="true" href="#requirements"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Requirements</h3>
<h4 dir="auto"><a id="user-content-nats-server" aria-hidden="true" href="#nats-server"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>NATS Server</h4>
<p dir="auto">You need to install and run a NATS server: <a href="https://docs.nats.io/running-a-nats-service/introduction/installation" rel="nofollow">https://docs.nats.io/running-a-nats-service/introduction/installation</a>.
Otherwise, I created a Virtual Machine for this; If you have installed <a href="https://multipass.run/" rel="nofollow">Multipass</a>, go to the <code>./nats/vm-nats</code> directory of this project. I created some scripts for my experiments:</p>
<ul dir="auto">
<li><code>create-vm.sh</code> <em>create the multipass VM, the settings of the VM are stored in the <code>vm.nats.config</code></em></li>
<li><code>01-install-nats-server.sh</code> <em>install the NATS server inside the VM</em></li>
<li><code>02-start-nats-server.sh</code> <em>start the NATS server</em></li>
<li><code>03-stop-nats-server.sh</code> <em>stop the NATS server</em></li>
<li><code>stop-vm.sh</code> <em>stop the VM</em></li>
<li><code>start-vm.sh</code> <em>start the VM</em></li>
<li><code>destroy-vm.sh</code> <em>delete the VM</em></li>
<li><code>shell-vm.sh</code> <em>SSH connect to the VM</em></li>
</ul>
<h4 dir="auto"><a id="user-content-nats-client" aria-hidden="true" href="#nats-client"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>NATS Client</h4>
<p dir="auto">You need a NATS client to publish messages. You can find sample of Go and Node.js NATS clients in the <code>./nats/clients</code>.</p>
<h3 dir="auto"><a id="user-content-run-capsule-as-a-nats-subscriber" aria-hidden="true" href="#run-capsule-as-a-nats-subscriber"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Run <strong>Capsule</strong> as a NATS subscriber:</h3>
<div dir="auto" data-snippet-clipboard-copy-content="capsule \
   -wasm=../wasm_modules/capsule-nats-subscriber/hello.wasm \
   -mode=nats \
   -natssrv=nats.devsecops.fun:4222 \
   -subject=ping"><pre>capsule \
   -wasm=../wasm_modules/capsule-nats-subscriber/hello.wasm \
   -mode=nats \
   -natssrv=nats.devsecops.fun:4222 \
   -subject=ping</pre></div>
<blockquote>
<ul dir="auto">
<li>use the &#34;NATS mode&#34;: <code>-mode=nats</code></li>
<li>define the NATS subject: <code>-subject=&lt;subject_name&gt;</code></li>
<li>define the address of the NATS server: <code>-natssrv=&lt;nats_server:port&gt;</code></li>
</ul>
</blockquote>
<h3 dir="auto"><a id="user-content-nats-function" aria-hidden="true" href="#nats-function"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>NATS function</h3>
<p dir="auto">A <strong>Capsule</strong> NATS function is a subscription to a subject. <strong>Capsule</strong> is listening on a subject(like a MQTT topic) and execute a function every time a message is posted on the subject:</p>
<div dir="auto" data-snippet-clipboard-copy-content="package main

import (
	hf &#34;github.com/bots-garden/capsule/capsulemodule/hostfunctions&#34;
)

func main() {
	hf.OnNatsMessage(Handle) // define the triggered function when a message &#34;arrives&#34; on the subject/topic
}

// at every message on the subject channel, the `Handle` function is executed
func Handle(params []string) {
	// send a message to another subject
	_, err := hf.NatsPublish(&#34;notify&#34;, &#34;it&#39;s a wasm module here&#34;)

	if err != nil {
		hf.Log(&#34;üò° ouch something bad is happening&#34;)
		hf.Log(err.Error())
	}
}"><pre><span>package</span> main

<span>import</span> (
	hf <span>&#34;github.com/bots-garden/capsule/capsulemodule/hostfunctions&#34;</span>
)

<span>func</span> <span>main</span>() {
	<span>hf</span>.<span>OnNatsMessage</span>(<span>Handle</span>) <span>// define the triggered function when a message &#34;arrives&#34; on the subject/topic</span>
}

<span>// at every message on the subject channel, the `Handle` function is executed</span>
<span>func</span> <span>Handle</span>(<span>params</span> []<span>string</span>) {
	<span>// send a message to another subject</span>
	<span>_</span>, <span>err</span> <span>:=</span> <span>hf</span>.<span>NatsPublish</span>(<span>&#34;notify&#34;</span>, <span>&#34;it&#39;s a wasm module here&#34;</span>)

	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
		<span>hf</span>.<span>Log</span>(<span>&#34;üò° ouch something bad is happening&#34;</span>)
		<span>hf</span>.<span>Log</span>(<span>err</span>.<span>Error</span>())
	}
}</pre></div>
<h3 dir="auto"><a id="user-content-capsule-nats-publisher" aria-hidden="true" href="#capsule-nats-publisher"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Capsule NATS publisher</h3>
<blockquote>
<p dir="auto">Publish NATS messages from capsule</p>
</blockquote>
<p dir="auto">You can use a <strong>WASM Capsule module</strong> to publish NATS messages, even if <strong>Capsule</strong> is not started in &#34;nats&#34; mode, for example from a <strong>WASM CLI Capsule module</strong>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="package main

import (
    &#34;errors&#34;
    hf &#34;github.com/bots-garden/capsule/capsulemodule/hostfunctions&#34;
    &#34;strings&#34;
)

func main() {
    hf.SetHandle(Handle)
}

func Handle(params []string) (string, error) {
    var errs []string

    // a new connection is created at every call/publish
    _, err1stMsg := hf.NatsConnectPublish(&#34;nats.devsecops.fun:4222&#34;, &#34;ping&#34;, &#34;üñê Hello from WASM with Nats üíú&#34;)
    _, err2ndMsg := hf.NatsConnectPublish(&#34;nats.devsecops.fun:4222&#34;, &#34;notify&#34;, &#34;üëã Hello World üåç&#34;)

    if err1stMsg != nil {
        errs = append(errs, err1stMsg.Error())
    }
    if err2ndMsg != nil {
        errs = append(errs, err2ndMsg.Error())
    }

    return &#34;NATS Rocks!&#34;, errors.New(strings.Join(errs, &#34;|&#34;))
}"><pre><span>package</span> main

<span>import</span> (
    <span>&#34;errors&#34;</span>
    hf <span>&#34;github.com/bots-garden/capsule/capsulemodule/hostfunctions&#34;</span>
    <span>&#34;strings&#34;</span>
)

<span>func</span> <span>main</span>() {
    <span>hf</span>.<span>SetHandle</span>(<span>Handle</span>)
}

<span>func</span> <span>Handle</span>(<span>params</span> []<span>string</span>) (<span>string</span>, <span>error</span>) {
    <span>var</span> <span>errs</span> []<span>string</span>

    <span>// a new connection is created at every call/publish</span>
    <span>_</span>, <span>err1stMsg</span> <span>:=</span> <span>hf</span>.<span>NatsConnectPublish</span>(<span>&#34;nats.devsecops.fun:4222&#34;</span>, <span>&#34;ping&#34;</span>, <span>&#34;üñê Hello from WASM with Nats üíú&#34;</span>)
    <span>_</span>, <span>err2ndMsg</span> <span>:=</span> <span>hf</span>.<span>NatsConnectPublish</span>(<span>&#34;nats.devsecops.fun:4222&#34;</span>, <span>&#34;notify&#34;</span>, <span>&#34;üëã Hello World üåç&#34;</span>)

    <span>if</span> <span>err1stMsg</span> <span>!=</span> <span>nil</span> {
        <span>errs</span> <span>=</span> <span>append</span>(<span>errs</span>, <span>err1stMsg</span>.<span>Error</span>())
    }
    <span>if</span> <span>err2ndMsg</span> <span>!=</span> <span>nil</span> {
        <span>errs</span> <span>=</span> <span>append</span>(<span>errs</span>, <span>err2ndMsg</span>.<span>Error</span>())
    }

    <span>return</span> <span>&#34;NATS Rocks!&#34;</span>, <span>errors</span>.<span>New</span>(<span>strings</span>.<span>Join</span>(<span>errs</span>, <span>&#34;|&#34;</span>))
}</pre></div>
<blockquote>
<p dir="auto">In this use case, you need to define the NATS server and create a connection</p>
</blockquote>
<h3 dir="auto"><a id="user-content-request-and-reply" aria-hidden="true" href="#request-and-reply"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Request and Reply</h3>
<p dir="auto">A NATS &#34;publisher&#34; can make a request to a NATS &#34;subscriber&#34; and wait for an answer</p>
<div dir="auto" data-snippet-clipboard-copy-content="package main

import (
	&#34;errors&#34;
	hf &#34;github.com/bots-garden/capsule/capsulemodule/hostfunctions&#34;
	&#34;strings&#34;
)

func main() {
	hf.SetHandle(Handle)
}

func Handle(params []string) (string, error) {

	// Publish and wait for an answer; 1 is the timeout in seconds
	res, err := hf.NatsConnectRequest(&#34;nats.devsecops.fun:4222&#34;, &#34;notify&#34;, &#34;üëã Hello World üåç&#34;, 1)

	if err != nil {
		hf.Log(&#34;üî¥&#34; + err.Error())
	} else {
        // Display the answer
		hf.Log(&#34;üîµ&#34; + res)
	}

	return &#34;NATS Rocks!&#34;, err
}"><pre><span>package</span> main

<span>import</span> (
	<span>&#34;errors&#34;</span>
	hf <span>&#34;github.com/bots-garden/capsule/capsulemodule/hostfunctions&#34;</span>
	<span>&#34;strings&#34;</span>
)

<span>func</span> <span>main</span>() {
	<span>hf</span>.<span>SetHandle</span>(<span>Handle</span>)
}

<span>func</span> <span>Handle</span>(<span>params</span> []<span>string</span>) (<span>string</span>, <span>error</span>) {

	<span>// Publish and wait for an answer; 1 is the timeout in seconds</span>
	<span>res</span>, <span>err</span> <span>:=</span> <span>hf</span>.<span>NatsConnectRequest</span>(<span>&#34;nats.devsecops.fun:4222&#34;</span>, <span>&#34;notify&#34;</span>, <span>&#34;üëã Hello World üåç&#34;</span>, <span>1</span>)

	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
		<span>hf</span>.<span>Log</span>(<span>&#34;üî¥&#34;</span> <span>+</span> <span>err</span>.<span>Error</span>())
	} <span>else</span> {
        <span>// Display the answer</span>
		<span>hf</span>.<span>Log</span>(<span>&#34;üîµ&#34;</span> <span>+</span> <span>res</span>)
	}

	<span>return</span> <span>&#34;NATS Rocks!&#34;</span>, <span>err</span>
}</pre></div>
<p dir="auto">A NATS &#34;subscriber&#34; can reply to a request received on its subject</p>
<div dir="auto" data-snippet-clipboard-copy-content="package main

import (
	hf &#34;github.com/bots-garden/capsule/capsulemodule/hostfunctions&#34;
)

func main() {
	hf.OnNatsMessage(Handle)
}

func Handle(params []string) {

	hf.Log(&#34;Message on subject: &#34; + hf.NatsGetSubject() + &#34;, üéâ message: &#34; + params[0])

	// reply to the message on the current subject; 10 is the timeout in seconds
	_, _ = hf.NatsReply(&#34;Hey! What&#39;s up&#34;, 10)

}"><pre><span>package</span> main

<span>import</span> (
	hf <span>&#34;github.com/bots-garden/capsule/capsulemodule/hostfunctions&#34;</span>
)

<span>func</span> <span>main</span>() {
	<span>hf</span>.<span>OnNatsMessage</span>(<span>Handle</span>)
}

<span>func</span> <span>Handle</span>(<span>params</span> []<span>string</span>) {

	<span>hf</span>.<span>Log</span>(<span>&#34;Message on subject: &#34;</span> <span>+</span> <span>hf</span>.<span>NatsGetSubject</span>() <span>+</span> <span>&#34;, üéâ message: &#34;</span> <span>+</span> <span>params</span>[<span>0</span>])

	<span>// reply to the message on the current subject; 10 is the timeout in seconds</span>
	<span>_</span>, <span>_</span> <span>=</span> <span>hf</span>.<span>NatsReply</span>(<span>&#34;Hey! What&#39;s up&#34;</span>, <span>10</span>)

}</pre></div>
<h2 dir="auto"><a id="user-content-first-mqtt-function" aria-hidden="true" href="#first-mqtt-function"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>First MQTT function</h2>
<blockquote>
<p dir="auto"><g-emoji alias="raised_hand_with_fingers_splayed" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f590.png">üñê</g-emoji><g-emoji alias="construction" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a7.png">üöß</g-emoji> The MQTT integration with <strong>Capsule</strong> is a work in progress and the functions are subject to change</p>
</blockquote>
<p dir="auto">MQTT is a standard for IOT message.</p>
<blockquote>
<ul dir="auto">
<li>About MQTT: <a href="https://mqtt.org/" rel="nofollow">https://mqtt.org/</a></li>
</ul>
</blockquote>
<h3 dir="auto"><a id="user-content-requirements-1" aria-hidden="true" href="#requirements-1"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Requirements</h3>
<h4 dir="auto"><a id="user-content-mqtt-server" aria-hidden="true" href="#mqtt-server"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>MQTT Server</h4>
<p dir="auto">You need to install and run a MQTT server. To do so, go to the <code>./mqtt</code> directory of this project and run the docker-compose file</p>
<h3 dir="auto"><a id="user-content-run-capsule-as-a-mqtt-subscriber" aria-hidden="true" href="#run-capsule-as-a-mqtt-subscriber"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Run <strong>Capsule</strong> as a MQTT subscriber:</h3>
<div dir="auto" data-snippet-clipboard-copy-content="capsule \
   -wasm=../wasm_modules/capsule-mqtt-subscriber/hello.wasm \
   -mode=mqtt \
   -mqttsrv=127.0.0.1:1883 \
   -topic=topic/sensor0 \
   -clientId=sensor"><pre>capsule \
   -wasm=../wasm_modules/capsule-mqtt-subscriber/hello.wasm \
   -mode=mqtt \
   -mqttsrv=127.0.0.1:1883 \
   -topic=topic/sensor0 \
   -clientId=sensor</pre></div>
<blockquote>
<ul dir="auto">
<li>use the &#34;MQTT mode&#34;: <code>-mode=mqtt</code></li>
<li>define the MQTT topic: <code>-topic=&lt;topic_name&gt;</code></li>
<li>define the MQTT clientId: <code>-clientId=&lt;clientId&gt;</code></li>
<li>define the address of the MQTT server: <code>-mqttsrv=&lt;mqtt_server:port&gt;</code></li>
</ul>
</blockquote>
<h3 dir="auto"><a id="user-content-mqtt-function" aria-hidden="true" href="#mqtt-function"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>MQTT function</h3>
<p dir="auto">A <strong>Capsule</strong> MQTT function is a subscription to a subject. <strong>Capsule</strong> is listening on a topic and execute a function every time a message is posted on the subject:</p>
<div dir="auto" data-snippet-clipboard-copy-content="package main

import (
	hf &#34;github.com/bots-garden/capsule/capsulemodule/hostfunctions&#34;
)

func main() {
	hf.OnMqttMessage(Handle) // define the triggered function when a message &#34;arrives&#34; on the topic
}

// at every message on the subject channel, the `Handle` function is executed
func Handle(params []string) {
	// send a message to another subject
	_, err := hf.MqttPublish(&#34;topic/reply&#34;, &#34;it&#39;s a wasm module here&#34;)

	if err != nil {
		hf.Log(&#34;üò° ouch something bad is happening&#34;)
		hf.Log(err.Error())
	}
}"><pre><span>package</span> main

<span>import</span> (
	hf <span>&#34;github.com/bots-garden/capsule/capsulemodule/hostfunctions&#34;</span>
)

<span>func</span> <span>main</span>() {
	<span>hf</span>.<span>OnMqttMessage</span>(<span>Handle</span>) <span>// define the triggered function when a message &#34;arrives&#34; on the topic</span>
}

<span>// at every message on the subject channel, the `Handle` function is executed</span>
<span>func</span> <span>Handle</span>(<span>params</span> []<span>string</span>) {
	<span>// send a message to another subject</span>
	<span>_</span>, <span>err</span> <span>:=</span> <span>hf</span>.<span>MqttPublish</span>(<span>&#34;topic/reply&#34;</span>, <span>&#34;it&#39;s a wasm module here&#34;</span>)

	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
		<span>hf</span>.<span>Log</span>(<span>&#34;üò° ouch something bad is happening&#34;</span>)
		<span>hf</span>.<span>Log</span>(<span>err</span>.<span>Error</span>())
	}
}</pre></div>
<h3 dir="auto"><a id="user-content-capsule-mqtt-publisher" aria-hidden="true" href="#capsule-mqtt-publisher"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Capsule MQTT publisher</h3>
<blockquote>
<p dir="auto">Publish MQTT messages from capsule</p>
</blockquote>
<p dir="auto">You can use a <strong>WASM Capsule module</strong> to MQTT messages, even if <strong>Capsule</strong> is not started in &#34;mqtt&#34; mode, for example from a <strong>WASM CLI Capsule module</strong>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="package main

import (
    &#34;errors&#34;
    hf &#34;github.com/bots-garden/capsule/capsulemodule/hostfunctions&#34;
    &#34;strings&#34;
)

func main() {
    hf.SetHandle(Handle)
}

func Handle(params []string) (string, error) {
    var errs []string

    // a new connection is created at every call/publish
	_, err1stMsg := hf.MqttConnectPublish(&#34;127.0.0.1:1883&#34;, &#34;sensor&#34;, &#34;topic/sensor1&#34;, &#34;üñê Hello from WASM with MQTT üíú&#34;)
	_, err2ndMsg := hf.MqttConnectPublish(&#34;127.0.0.1:1883&#34;, &#34;sensor&#34;, &#34;topic/sensor2&#34;, &#34;üëã Hello World üåç&#34;)

    if err1stMsg != nil {
        errs = append(errs, err1stMsg.Error())
    }
    if err2ndMsg != nil {
        errs = append(errs, err2ndMsg.Error())
    }

    return &#34;MQTT Rocks!&#34;, errors.New(strings.Join(errs, &#34;|&#34;))
}"><pre><span>package</span> main

<span>import</span> (
    <span>&#34;errors&#34;</span>
    hf <span>&#34;github.com/bots-garden/capsule/capsulemodule/hostfunctions&#34;</span>
    <span>&#34;strings&#34;</span>
)

<span>func</span> <span>main</span>() {
    <span>hf</span>.<span>SetHandle</span>(<span>Handle</span>)
}

<span>func</span> <span>Handle</span>(<span>params</span> []<span>string</span>) (<span>string</span>, <span>error</span>) {
    <span>var</span> <span>errs</span> []<span>string</span>

    <span>// a new connection is created at every call/publish</span>
	<span>_</span>, <span>err1stMsg</span> <span>:=</span> <span>hf</span>.<span>MqttConnectPublish</span>(<span>&#34;127.0.0.1:1883&#34;</span>, <span>&#34;sensor&#34;</span>, <span>&#34;topic/sensor1&#34;</span>, <span>&#34;üñê Hello from WASM with MQTT üíú&#34;</span>)
	<span>_</span>, <span>err2ndMsg</span> <span>:=</span> <span>hf</span>.<span>MqttConnectPublish</span>(<span>&#34;127.0.0.1:1883&#34;</span>, <span>&#34;sensor&#34;</span>, <span>&#34;topic/sensor2&#34;</span>, <span>&#34;üëã Hello World üåç&#34;</span>)

    <span>if</span> <span>err1stMsg</span> <span>!=</span> <span>nil</span> {
        <span>errs</span> <span>=</span> <span>append</span>(<span>errs</span>, <span>err1stMsg</span>.<span>Error</span>())
    }
    <span>if</span> <span>err2ndMsg</span> <span>!=</span> <span>nil</span> {
        <span>errs</span> <span>=</span> <span>append</span>(<span>errs</span>, <span>err2ndMsg</span>.<span>Error</span>())
    }

    <span>return</span> <span>&#34;MQTT Rocks!&#34;</span>, <span>errors</span>.<span>New</span>(<span>strings</span>.<span>Join</span>(<span>errs</span>, <span>&#34;|&#34;</span>))
}</pre></div>
<blockquote>
<p dir="auto">In this use case, you need to define the MQTT server and create a connection</p>
</blockquote>
<h2 dir="auto"><a id="user-content-host-functions" aria-hidden="true" href="#host-functions"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Host functions</h2>
<p dir="auto"><strong>Capsule</strong> offers some capabilities to the wasm modules by providing some &#34;host functions&#34;:</p>
<h3 dir="auto"><a id="user-content-print-a-message" aria-hidden="true" href="#print-a-message"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Print a message</h3>
<div dir="auto" data-snippet-clipboard-copy-content="hf.Log(&#34;üëã Hello World üåç&#34;)"><pre><span>hf</span>.<span>Log</span>(<span>&#34;üëã Hello World üåç&#34;</span>)</pre></div>
<h3 dir="auto"><a id="user-content-read-and-write-files" aria-hidden="true" href="#read-and-write-files"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Read and Write files</h3>
<div dir="auto" data-snippet-clipboard-copy-content="txt, err := hf.ReadFile(&#34;about.txt&#34;)
if err != nil {
    hf.Log(err.Error())
}
hf.Log(txt)

newFile, err := hf.WriteFile(&#34;hello.txt&#34;, &#34;üëã HELLO WORLD üåç&#34;)
if err != nil {
    hf.Log(err.Error())
}
hf.Log(newFile)"><pre><span>txt</span>, <span>err</span> <span>:=</span> <span>hf</span>.<span>ReadFile</span>(<span>&#34;about.txt&#34;</span>)
<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
    <span>hf</span>.<span>Log</span>(<span>err</span>.<span>Error</span>())
}
<span>hf</span>.<span>Log</span>(<span>txt</span>)

<span>newFile</span>, <span>err</span> <span>:=</span> <span>hf</span>.<span>WriteFile</span>(<span>&#34;hello.txt&#34;</span>, <span>&#34;üëã HELLO WORLD üåç&#34;</span>)
<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
    <span>hf</span>.<span>Log</span>(<span>err</span>.<span>Error</span>())
}
<span>hf</span>.<span>Log</span>(<span>newFile</span>)</pre></div>
<h3 dir="auto"><a id="user-content-read-value-of-the-environment-variables" aria-hidden="true" href="#read-value-of-the-environment-variables"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Read value of the environment variables</h3>
<div dir="auto" data-snippet-clipboard-copy-content="message, err := hf.GetEnv(&#34;MESSAGE&#34;)
if err != nil {
    hf.Log(err.Error())
} else {
    hf.Log(&#34;MESSAGE=&#34; + message)
}"><pre><span>message</span>, <span>err</span> <span>:=</span> <span>hf</span>.<span>GetEnv</span>(<span>&#34;MESSAGE&#34;</span>)
<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
    <span>hf</span>.<span>Log</span>(<span>err</span>.<span>Error</span>())
} <span>else</span> {
    <span>hf</span>.<span>Log</span>(<span>&#34;MESSAGE=&#34;</span> <span>+</span> <span>message</span>)
}</pre></div>
<h3 dir="auto"><a id="user-content-make-http-requests" aria-hidden="true" href="#make-http-requests"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Make HTTP requests</h3>
<p dir="auto"><em><code>GET</code></em></p>
<div dir="auto" data-snippet-clipboard-copy-content="ret, err := hf.Http(&#34;https://httpbin.org/get&#34;, &#34;GET&#34;, headers, &#34;&#34;)
if err != nil {
    hf.Log(&#34;üò° error:&#34; + err.Error())
} else {
    hf.Log(&#34;üìùresult: &#34; + ret)
}"><pre><span>ret</span>, <span>err</span> <span>:=</span> <span>hf</span>.<span>Http</span>(<span>&#34;https://httpbin.org/get&#34;</span>, <span>&#34;GET&#34;</span>, <span>headers</span>, <span>&#34;&#34;</span>)
<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
    <span>hf</span>.<span>Log</span>(<span>&#34;üò° error:&#34;</span> <span>+</span> <span>err</span>.<span>Error</span>())
} <span>else</span> {
    <span>hf</span>.<span>Log</span>(<span>&#34;üìùresult: &#34;</span> <span>+</span> <span>ret</span>)
}</pre></div>
<p dir="auto"><em><code>POST</code></em></p>
<div dir="auto" data-snippet-clipboard-copy-content="headers := map[string]string{&#34;Accept&#34;: &#34;application/json&#34;, &#34;Content-Type&#34;: &#34;text/html; charset=UTF-8&#34;}

ret, err := hf.Http(&#34;https://httpbin.org/post&#34;, &#34;POST&#34;, headers, &#34;üëã hello world üåç&#34;)
if err != nil {
    hf.Log(&#34;üò° error:&#34; + err.Error())
} else {
    hf.Log(&#34;üìùresult: &#34; + ret)
}"><pre><span>headers</span> <span>:=</span> <span>map</span>[<span>string</span>]<span>string</span>{<span>&#34;Accept&#34;</span>: <span>&#34;application/json&#34;</span>, <span>&#34;Content-Type&#34;</span>: <span>&#34;text/html; charset=UTF-8&#34;</span>}

<span>ret</span>, <span>err</span> <span>:=</span> <span>hf</span>.<span>Http</span>(<span>&#34;https://httpbin.org/post&#34;</span>, <span>&#34;POST&#34;</span>, <span>headers</span>, <span>&#34;üëã hello world üåç&#34;</span>)
<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
    <span>hf</span>.<span>Log</span>(<span>&#34;üò° error:&#34;</span> <span>+</span> <span>err</span>.<span>Error</span>())
} <span>else</span> {
    <span>hf</span>.<span>Log</span>(<span>&#34;üìùresult: &#34;</span> <span>+</span> <span>ret</span>)
}</pre></div>
<h3 dir="auto"><a id="user-content-use-memory-cache" aria-hidden="true" href="#use-memory-cache"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Use memory cache</h3>
<p dir="auto"><em><code>MemorySet</code></em></p>
<div dir="auto" data-snippet-clipboard-copy-content="_, err := hf.MemorySet(&#34;message&#34;, &#34;üöÄ hello is started&#34;)"><pre><span>_</span>, <span>err</span> <span>:=</span> <span>hf</span>.<span>MemorySet</span>(<span>&#34;message&#34;</span>, <span>&#34;üöÄ hello is started&#34;</span>)</pre></div>
<p dir="auto"><em><code>MemoryGet</code></em></p>
<div dir="auto" data-snippet-clipboard-copy-content="value, err := hf.MemoryGet(&#34;message&#34;)"><pre><span>value</span>, <span>err</span> <span>:=</span> <span>hf</span>.<span>MemoryGet</span>(<span>&#34;message&#34;</span>)</pre></div>
<p dir="auto"><em><code>MemoryKeys</code></em></p>
<div dir="auto" data-snippet-clipboard-copy-content="keys, err := hf.MemoryKeys()
// it will return an array of strings
if err != nil {
  hf.Log(err.Error())
}

for key, value := range keys {
  hf.Log(key+&#34;:&#34;+value)
}"><pre><span>keys</span>, <span>err</span> <span>:=</span> <span>hf</span>.<span>MemoryKeys</span>()
<span>// it will return an array of strings</span>
<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
  <span>hf</span>.<span>Log</span>(<span>err</span>.<span>Error</span>())
}

<span>for</span> <span>key</span>, <span>value</span> <span>:=</span> <span>range</span> <span>keys</span> {
  <span>hf</span>.<span>Log</span>(<span>key</span><span>+</span><span>&#34;:&#34;</span><span>+</span><span>value</span>)
}</pre></div>
<h3 dir="auto"><a id="user-content-make-redis-queries" aria-hidden="true" href="#make-redis-queries"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Make Redis queries</h3>
<blockquote>
<p dir="auto"><g-emoji alias="construction" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a7.png">üöß</g-emoji> this is a work in progress</p>
</blockquote>
<p dir="auto">You need to run <strong>Capsule</strong> with these two environment variables:</p>
<div dir="auto" data-snippet-clipboard-copy-content="REDIS_ADDR=&#34;localhost:6379&#34;
REDIS_PWD=&#34;&#34;"><pre>REDIS_ADDR=<span><span>&#34;</span>localhost:6379<span>&#34;</span></span>
REDIS_PWD=<span><span>&#34;</span><span>&#34;</span></span></pre></div>
<p dir="auto"><em><code>SET</code></em></p>
<div dir="auto" data-snippet-clipboard-copy-content="// add a key, value
res, err := hf.RedisSet(&#34;greetings&#34;, &#34;Hello World&#34;)
if err != nil {
    hf.Log(err.Error())
} else {
    hf.Log(&#34;Value: &#34; + res)
}"><pre><span>// add a key, value</span>
<span>res</span>, <span>err</span> <span>:=</span> <span>hf</span>.<span>RedisSet</span>(<span>&#34;greetings&#34;</span>, <span>&#34;Hello World&#34;</span>)
<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
    <span>hf</span>.<span>Log</span>(<span>err</span>.<span>Error</span>())
} <span>else</span> {
    <span>hf</span>.<span>Log</span>(<span>&#34;Value: &#34;</span> <span>+</span> <span>res</span>)
}</pre></div>
<p dir="auto"><em><code>GET</code></em></p>
<div dir="auto" data-snippet-clipboard-copy-content="// read the value
res, err := hf.RedisGet(&#34;greetings&#34;)
if err != nil {
    hf.Log(err.Error())
} else {
    hf.Log(&#34;Value: &#34; + res)
}"><pre><span>// read the value</span>
<span>res</span>, <span>err</span> <span>:=</span> <span>hf</span>.<span>RedisGet</span>(<span>&#34;greetings&#34;</span>)
<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
    <span>hf</span>.<span>Log</span>(<span>err</span>.<span>Error</span>())
} <span>else</span> {
    <span>hf</span>.<span>Log</span>(<span>&#34;Value: &#34;</span> <span>+</span> <span>res</span>)
}</pre></div>
<p dir="auto"><em><code>KEYS</code></em></p>
<div dir="auto" data-snippet-clipboard-copy-content="legion, err := hf.RedisKeys(&#34;bob*&#34;)
if err != nil {
    hf.Log(err.Error())
}

for _, bob := range legion {
    hf.Log(bob)
}"><pre><span>legion</span>, <span>err</span> <span>:=</span> <span>hf</span>.<span>RedisKeys</span>(<span>&#34;bob*&#34;</span>)
<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
    <span>hf</span>.<span>Log</span>(<span>err</span>.<span>Error</span>())
}

<span>for</span> <span>_</span>, <span>bob</span> <span>:=</span> <span>range</span> <span>legion</span> {
    <span>hf</span>.<span>Log</span>(<span>bob</span>)
}</pre></div>
<h3 dir="auto"><a id="user-content-make-couchbase-n1ql-query" aria-hidden="true" href="#make-couchbase-n1ql-query"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Make CouchBase N1QL Query</h3>
<p dir="auto">You need to run <strong>Capsule</strong> with these four environment variables:</p>
<div dir="auto" data-snippet-clipboard-copy-content="COUCHBASE_CLUSTER=&#34;couchbase://localhost&#34;
COUCHBASE_USER=&#34;admin&#34;
COUCHBASE_PWD=&#34;ilovepandas&#34;
COUCHBASE_BUCKET=&#34;wasm-data&#34;"><pre>COUCHBASE_CLUSTER=<span><span>&#34;</span>couchbase://localhost<span>&#34;</span></span>
COUCHBASE_USER=<span><span>&#34;</span>admin<span>&#34;</span></span>
COUCHBASE_PWD=<span><span>&#34;</span>ilovepandas<span>&#34;</span></span>
COUCHBASE_BUCKET=<span><span>&#34;</span>wasm-data<span>&#34;</span></span></pre></div>
<div dir="auto" data-snippet-clipboard-copy-content="bucketName, _ := hf.GetEnv(&#34;COUCHBASE_BUCKET&#34;)
query := &#34;SELECT * FROM `&#34; + bucketName + &#34;`.data.docs&#34;

jsonStringArray, err := hf.CouchBaseQuery(query)"><pre><span>bucketName</span>, <span>_</span> <span>:=</span> <span>hf</span>.<span>GetEnv</span>(<span>&#34;COUCHBASE_BUCKET&#34;</span>)
<span>query</span> <span>:=</span> <span>&#34;SELECT * FROM `&#34;</span> <span>+</span> <span>bucketName</span> <span>+</span> <span>&#34;`.data.docs&#34;</span>

<span>jsonStringArray</span>, <span>err</span> <span>:=</span> <span>hf</span>.<span>CouchBaseQuery</span>(<span>query</span>)</pre></div>
<h3 dir="auto"><a id="user-content-nats" aria-hidden="true" href="#nats"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Nats</h3>
<p dir="auto"><em><code>NatsPublish(subject string, message string)</code></em>: publish a message on a subject</p>
<div dir="auto" data-snippet-clipboard-copy-content="_, err := hf.NatsPublish(&#34;notify&#34;, &#34;it&#39;s a wasm module here&#34;)"><pre><span>_</span>, <span>err</span> <span>:=</span> <span>hf</span>.<span>NatsPublish</span>(<span>&#34;notify&#34;</span>, <span>&#34;it&#39;s a wasm module here&#34;</span>)</pre></div>
<blockquote>
<p dir="auto">You must use the <code>&#34;nats&#34;</code> mode of <strong>Capsule</strong> as the NATS connection is defined at the start of <strong>Capsule</strong> and shared with the WASM module:</p>
<div dir="auto" data-snippet-clipboard-copy-content="capsule \
-wasm=../wasm_modules/capsule-nats-subscriber/hello.wasm \
-mode=nats \
-natssrv=nats.devsecops.fun:4222 \
-subject=ping"><pre>capsule \
-wasm=../wasm_modules/capsule-nats-subscriber/hello.wasm \
-mode=nats \
-natssrv=nats.devsecops.fun:4222 \
-subject=ping</pre></div>
</blockquote>
<p dir="auto"><em><code>NatsReply(message string, timeout uint32)</code></em>: publish a message on the current subject and wait for an answer</p>
<div dir="auto" data-snippet-clipboard-copy-content="_, err := hf.NatsReply(&#34;it&#39;s a wasm module here&#34;, 10)"><pre><span>_</span>, <span>err</span> <span>:=</span> <span>hf</span>.<span>NatsReply</span>(<span>&#34;it&#39;s a wasm module here&#34;</span>, <span>10</span>)</pre></div>
<blockquote>
<p dir="auto">You must use the <code>&#34;nats&#34;</code> mode of <strong>Capsule</strong> as the NATS connection and the subscription are defined at the start of <strong>Capsule</strong> and shared with the WASM module.</p>
</blockquote>
<p dir="auto"><em><code>NatsGetSubject()</code></em>: get the subject listened by the <strong>Capsule</strong> launcher</p>
<div dir="auto" data-snippet-clipboard-copy-content="hf.Log(&#34;üëÇListening on: &#34; + hf.NatsGetSubject())"><pre><span>hf</span>.<span>Log</span>(<span>&#34;üëÇListening on: &#34;</span> <span>+</span> <span>hf</span>.<span>NatsGetSubject</span>())</pre></div>
<p dir="auto"><em><code>NatsGetServer()</code></em>: get the connected NATS server</p>
<div dir="auto" data-snippet-clipboard-copy-content="hf.Log(&#34;üëã NATS server: &#34; + hf.NatsGetServer())"><pre><span>hf</span>.<span>Log</span>(<span>&#34;üëã NATS server: &#34;</span> <span>+</span> <span>hf</span>.<span>NatsGetServer</span>())</pre></div>
<p dir="auto"><em><code>NatsConnectPublish(server string, subject string, message string)</code></em>: connect to a NATS server and send a message on a subject</p>
<div dir="auto" data-snippet-clipboard-copy-content="_, err := hf.NatsConnectPublish(&#34;nats.devsecops.fun:4222&#34;, &#34;ping&#34;, &#34;üñê Hello from WASM with Nats üíú&#34;)"><pre><span>_</span>, <span>err</span> <span>:=</span> <span>hf</span>.<span>NatsConnectPublish</span>(<span>&#34;nats.devsecops.fun:4222&#34;</span>, <span>&#34;ping&#34;</span>, <span>&#34;üñê Hello from WASM with Nats üíú&#34;</span>)</pre></div>
<blockquote>
<p dir="auto">You can use this function with all the running modes of <strong>Capsule</strong></p>
</blockquote>
<p dir="auto"><em><code>NatsConnectPublish(server string, subject string, message string, timeout uint32)</code></em>: connect to a NATS server and send a message on a subject</p>
<div dir="auto" data-snippet-clipboard-copy-content="answer, err := hf.NatsConnectRequest(&#34;nats.devsecops.fun:4222&#34;, &#34;notify&#34;, &#34;üëã Hello World üåç&#34;, 1)"><pre><span>answer</span>, <span>err</span> <span>:=</span> <span>hf</span>.<span>NatsConnectRequest</span>(<span>&#34;nats.devsecops.fun:4222&#34;</span>, <span>&#34;notify&#34;</span>, <span>&#34;üëã Hello World üåç&#34;</span>, <span>1</span>)</pre></div>
<blockquote>
<p dir="auto">You can use this function with all the running modes of <strong>Capsule</strong></p>
</blockquote>
<h3 dir="auto"><a id="user-content-error-management" aria-hidden="true" href="#error-management"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Error Management</h3>
<blockquote>
<p dir="auto"><g-emoji alias="raised_hand_with_fingers_splayed" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f590.png">üñê</g-emoji><g-emoji alias="raised_hand_with_fingers_splayed" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f590.png">üñê</g-emoji><g-emoji alias="raised_hand_with_fingers_splayed" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f590.png">üñê</g-emoji> <g-emoji alias="construction" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a7.png">üöß</g-emoji> it&#39;s a work in progress (it&#39;s not implemented entirely)</p>
</blockquote>
<p dir="auto"><em><code>GetExitError()</code> &amp; <code>GetExitCode</code></em>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="//export OnExit
func OnExit() {
	hf.Log(&#34;üëãü§ó have a nice day&#34;)
	hf.Log(&#34;Exit Error: &#34; + hf.GetExitError())
	hf.Log(&#34;Exit Code: &#34; + hf.GetExitCode())
}"><pre><span>//export OnExit</span>
<span>func</span> <span>OnExit</span>() {
	<span>hf</span>.<span>Log</span>(<span>&#34;üëãü§ó have a nice day&#34;</span>)
	<span>hf</span>.<span>Log</span>(<span>&#34;Exit Error: &#34;</span> <span>+</span> <span>hf</span>.<span>GetExitError</span>())
	<span>hf</span>.<span>Log</span>(<span>&#34;Exit Code: &#34;</span> <span>+</span> <span>hf</span>.<span>GetExitCode</span>())
}</pre></div>
<h2 dir="auto"><a id="user-content-helpers-for-the-wasm-modules" aria-hidden="true" href="#helpers-for-the-wasm-modules"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Helpers (for the wasm modules)</h2>
<p dir="auto">Handling Json with TinyGo is not straight forward (but not impossible).
If your use case is very simple (a Json string without nested object or array) you can use:</p>
<ul dir="auto">
<li><code>flatjson.StrToMap(flatJsonStr string) map[string]interface{}</code>: get a flat json string (no nested obj) and return a map</li>
<li><code>flatjson.MapToStr(jsonMap map[string]interface{}) string</code>: get a flat json map and return a json string</li>
</ul>
<p dir="auto"><em>Example:</em></p>
<div dir="auto" data-snippet-clipboard-copy-content="package main

import (
    &#34;github.com/bots-garden/capsule/capsulemodule/flatjson&#34;
    hf &#34;github.com/bots-garden/capsule/capsulemodule/hostfunctions&#34;
    &#34;strconv&#34;
)

func main() {
    hf.SetHandleHttp(Handle)
}

func Handle(request hf.Request) (response hf.Response, errResp error) {

    jsonMap := flatjson.StrToMap(request.Body)

    author := jsonMap[&#34;author&#34;].(string)
    age := jsonMap[&#34;age&#34;].(int)
    weight := jsonMap[&#34;weight&#34;].(float64)
    isHuman := jsonMap[&#34;human&#34;].(bool)
    message := jsonMap[&#34;message&#34;].(string)

    hf.Log(&#34;üëã &#34; + message + &#34; by &#34; + author + &#34; üòÑ&#34;)
    hf.Log(&#34;üëã age: &#34; + strconv.Itoa(age))
    hf.Log(&#34;üëã weight: &#34; + strconv.FormatFloat(weight, &#39;f&#39;, 6, 64))

    if isHuman {
        hf.Log(&#34;I&#39;m not a ü§ñ&#34;)
    }

    headersResp := map[string]string{
        &#34;Content-Type&#34;: &#34;application/json; charset=utf-8&#34;,
    }

    responseMap := map[string]interface{}{
        &#34;message&#34;: &#34;üëã hey! What&#39;s up?&#34;,
        &#34;author&#34;:  &#34;Bob&#34;,
    }

    return hf.Response{Body: flatjson.MapToStr(responseMap), Headers: headersResp}, nil
}"><pre><span>package</span> main

<span>import</span> (
    <span>&#34;github.com/bots-garden/capsule/capsulemodule/flatjson&#34;</span>
    hf <span>&#34;github.com/bots-garden/capsule/capsulemodule/hostfunctions&#34;</span>
    <span>&#34;strconv&#34;</span>
)

<span>func</span> <span>main</span>() {
    <span>hf</span>.<span>SetHandleHttp</span>(<span>Handle</span>)
}

<span>func</span> <span>Handle</span>(<span>request</span> hf.<span>Request</span>) (<span>response</span> hf.<span>Response</span>, <span>errResp</span> <span>error</span>) {

    <span>jsonMap</span> <span>:=</span> <span>flatjson</span>.<span>StrToMap</span>(<span>request</span>.<span>Body</span>)

    <span>author</span> <span>:=</span> <span>jsonMap</span>[<span>&#34;author&#34;</span>].(<span>string</span>)
    <span>age</span> <span>:=</span> <span>jsonMap</span>[<span>&#34;age&#34;</span>].(<span>int</span>)
    <span>weight</span> <span>:=</span> <span>jsonMap</span>[<span>&#34;weight&#34;</span>].(<span>float64</span>)
    <span>isHuman</span> <span>:=</span> <span>jsonMap</span>[<span>&#34;human&#34;</span>].(<span>bool</span>)
    <span>message</span> <span>:=</span> <span>jsonMap</span>[<span>&#34;message&#34;</span>].(<span>string</span>)

    <span>hf</span>.<span>Log</span>(<span>&#34;üëã &#34;</span> <span>+</span> <span>message</span> <span>+</span> <span>&#34; by &#34;</span> <span>+</span> <span>author</span> <span>+</span> <span>&#34; üòÑ&#34;</span>)
    <span>hf</span>.<span>Log</span>(<span>&#34;üëã age: &#34;</span> <span>+</span> <span>strconv</span>.<span>Itoa</span>(<span>age</span>))
    <span>hf</span>.<span>Log</span>(<span>&#34;üëã weight: &#34;</span> <span>+</span> <span>strconv</span>.<span>FormatFloat</span>(<span>weight</span>, <span>&#39;f&#39;</span>, <span>6</span>, <span>64</span>))

    <span>if</span> <span>isHuman</span> {
        <span>hf</span>.<span>Log</span>(<span>&#34;I&#39;m not a ü§ñ&#34;</span>)
    }

    <span>headersResp</span> <span>:=</span> <span>map</span>[<span>string</span>]<span>string</span>{
        <span>&#34;Content-Type&#34;</span>: <span>&#34;application/json; charset=utf-8&#34;</span>,
    }

    <span>responseMap</span> <span>:=</span> <span>map</span>[<span>string</span>]<span>interface</span>{}{
        <span>&#34;message&#34;</span>: <span>&#34;üëã hey! What&#39;s up?&#34;</span>,
        <span>&#34;author&#34;</span>:  <span>&#34;Bob&#34;</span>,
    }

    <span>return</span> hf.<span>Response</span>{<span>Body</span>: <span>flatjson</span>.<span>MapToStr</span>(<span>responseMap</span>), <span>Headers</span>: <span>headersResp</span>}, <span>nil</span>
}</pre></div>
<p dir="auto"><em>Call the function:</em></p>
<div dir="auto" data-snippet-clipboard-copy-content="curl -v -X POST \
  http://localhost:7070 \
  -H &#39;content-type: application/json; charset=utf-8&#39; \
  -d &#39;{&#34;message&#34;: &#34;TinyGo üíöüíú wasm&#34;, &#34;author&#34;: &#34;@k33g&#34;, &#34;text&#34;:&#34;this is a text&#34;, &#34;age&#34;:42, &#34;human&#34;: true, &#34;weight&#34;: 100.5}&#39;"><pre>curl -v -X POST \
  http://localhost:7070 \
  -H <span><span>&#39;</span>content-type: application/json; charset=utf-8<span>&#39;</span></span> \
  -d <span><span>&#39;</span>{&#34;message&#34;: &#34;TinyGo üíöüíú wasm&#34;, &#34;author&#34;: &#34;@k33g&#34;, &#34;text&#34;:&#34;this is a text&#34;, &#34;age&#34;:42, &#34;human&#34;: true, &#34;weight&#34;: 100.5}<span>&#39;</span></span></pre></div>
<h2 dir="auto"><a id="user-content-capsule-faas-experimental" aria-hidden="true" href="#capsule-faas-experimental"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Capsule FaaS (experimental)</h2>
<p dir="auto">There are four additional components to use <strong>capsule</strong> (the wasm module launcher/executor) in <strong>FaaS</strong> mode:</p>
<ul dir="auto">
<li><code>capsule-reverse-proxy</code>: a reverse-proxy to simplify the functions (wasm modules) access</li>
<li><code>capsule-registry</code>: a wasm module registry (<g-emoji alias="construction" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a7.png">üöß</g-emoji> support of <a href="https://wapm.io/" rel="nofollow">https://wapm.io/</a> in progress)</li>
<li><code>capsule-worker</code>: a server to start the functions (wasm modules) remotely</li>
<li><code>capsule-ctl</code> (short name: <code>caps</code>): a CLI to facilitate the interaction with the worker</li>
</ul>
<p dir="auto">See documents files in <code>./docs</code> (<g-emoji alias="construction" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a7.png">üöß</g-emoji> this is a work in progress)</p>
<p dir="auto"><g-emoji alias="wave" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f44b.png">üëã</g-emoji> You will find some <strong>running examples</strong> with this project:</p>
<ul dir="auto">
<li><a href="https://github.com/bots-garden/capsule-faas-demo">https://github.com/bots-garden/capsule-faas-demo</a></li>
</ul>
<blockquote>
<ul dir="auto">
<li>You can use the capsule registry independently of FaaS mode, only to provide wasm modules to the capsule launcher</li>
<li>You can use the capsule reverse-proxy independently of FaaS mode, only to get only one access URL</li>
</ul>
</blockquote>
</article>
          </div></div>
  </body>
</html>
