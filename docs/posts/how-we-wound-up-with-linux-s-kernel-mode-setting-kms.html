<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/KernelModesettingBackground">Original</a>
    <h1>How we wound up with Linux&#39;s kernel mode setting (&#39;KMS&#39;)</h1>
    
    <div id="readability-page-1" class="page"><div><h2>How we wound up with Linux&#39;s kernel mode setting (&#39;KMS&#39;)</h2>

	<p><small>June  9, 2022</small></p>
</div><div><p>Once upon a time, not quite back when dinosaurs roamed the earth,
computer displays were <a href="https://en.wikipedia.org/wiki/Cathode-ray_tube">CRTs</a> and fundamentally
operated by scanning an electron beam or beams back and forth over
the screen. Usually the computer sent the CRT an analog stream
of either monochrome or red, green, and blue intensity signals, and
the CRT did all the work of scanning the electron beam(s) across
the display. Initially, computer CRTs tended to work only at a
single frequency of these signals, the <a href="https://en.wikipedia.org/wiki/Horizontal_scan_rate">horizontal</a> and <a href="https://en.wikipedia.org/wiki/Vertical_scan_rate">vertical
scan rates</a>. As
the PC revolution got under way, good CRTs became <a href="https://en.wikipedia.org/wiki/Multisync_monitor">multisync</a>, which meant that
they were able to work at a variety of scan rates. This was especially
important to cope with the wide variety of resolutions and scan
rates that were used by and supported by various PC graphics systems.</p>

<p>In the PC world, <a href="https://en.wikipedia.org/wiki/Video_Electronics_Standards_Association">VESA</a>
wound up defining <a href="https://wiki.osdev.org/VESA_Video_Modes#Don.27t_Assume_The_Monitor_Supports_A_Video_Mode">some very basic modes that all VESA compatible
monitors had to support</a>,
as part of <a href="https://wiki.osdev.org/VESA_Video_Modes">VESA BIOS extensions</a>
(<a href="https://en.wikipedia.org/wiki/VESA_BIOS_Extensions">also</a>). Both
the graphics hardware in your PC and the CRT you had probably
supported better modes with more resolution, but to use them you
had to know card-specific information and generally you had to know
what timings to use. Enter <a href="https://en.wikipedia.org/wiki/XFree86_Modeline">XFree86 modelines</a>, which were a
general way of saying what scan frequencies you wanted to use.
These modelines are where &#39;mode setting&#39; gets its name from.</p>

<p>In the older days of Linux, the kernel didn&#39;t know very much about
graphics (at least on PCs). Instead, setting up and handling graphics
hardware was the domain of the X server; the kernel gave it access
to PCI (or <a href="https://en.wikipedia.org/wiki/Accelerated_Graphics_Port">AGP</a>)
resources, and the X server directly stored values and read things
out. Part of what the X server did was set the graphics mode (ie,
the modeline resolution, depth, and scan frequencies), initially
from explicit modelines and then over time from <a href="https://en.wikipedia.org/wiki/EDID">EDID</a> information and other things
you didn&#39;t have to configure (<a href="https://utcc.utoronto.ca/~cks/space/blog/linux/DDCImportance">which was great</a>).
This was <em>user space mode setting</em>. There were a variety of reasons
to do this at the time (<a href="https://utcc.utoronto.ca/~cks/space/blog/linux/XServerAndVTs">cf</a>) but it had various
drawbacks, including requiring the X server to have significant
privileges (<a href="https://fedoraproject.org/wiki/Changes/XorgWithoutRootRights">cf Fedora removing them</a>).</p>

<p>(This is the era in which <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/XServerAndVTs">the X server had to switch out of its
high resolution mode before you could switch to a text console</a>.)</p>

<p>Over time, PC graphics cards became capable of doing more and more
things that really had to be handled in the kernel. They might do
DMA, generate interrupts, require extensive involvement with kernel
level things, and so on. As a result the kernel developed increasingly
complex (and large) drivers for GPUs, and those drivers became
capable of more and more things (cf <a href="https://en.wikipedia.org/wiki/Direct_Rendering_Manager">the kernel DRM system</a>). One of
the things that moved from the X server to the drivers for many
drivers was this job of setting the graphics mode, creating <em>kernel
mode setting</em>. Once the kernel could set the graphics mode and get
<a href="https://en.wikipedia.org/wiki/EDID">EDID</a> information from the connected displays, it started doing
so during boot, picking the best resolution out of the ones available.</p>

<p>Setting the &#39;correct&#39; mode for your monitor is now more important
than it used to be, because we&#39;ve switched over from CRTs to LCDs.
LCDs are fundamentally fixed resolution (and colour depth) displays,
unlike CRTs (more or less), so if you actually want to read crisp
things on your LCD, you want to drive it at its native resolution.
Linux&#39;s kernel mode setting makes this happen as early as possible
and in as many situations as possible, not just when the X server
is running.</p>

<p>Traditionally, the Linux text console on PCs really did pretty much
use <a href="https://en.wikipedia.org/wiki/VGA-compatible_text_mode">VGA text mode</a> (<a href="https://en.wikipedia.org/wiki/Text_mode#PC_common_text_modes">also</a>).
In the modern KMS world, the &#39;text console&#39; is actually a <a href="https://www.kernel.org/doc/html/latest/fb/fbcon.html">framebuffer
console</a> that
draws text through graphics operations as part of <a href="https://dri.freedesktop.org/wiki/DRM/">the DRM system</a>. It&#39;s possible that some
sort of framebuffer console is still used today even if KMS has
been specifically turned off, although I&#39;m not sure.</p>

<p>(See also wikipedia&#39;s <a href="https://en.wikipedia.org/wiki/Mode_setting">Mode setting</a>, which also covers
other Unixes.)</p>

<p>PS: As of Fedora 36, <a href="https://blog.dowhile0.org/2022/04/22/fedora-36-a-brave-new-drm-kms-only-world/">Fedora only has DRM/KMS in its kernel</a>.
See also <a href="https://lore.kernel.org/dri-devel/20210430105840.30515-1-tzimmermann@suse.de/">the announcement of the new simpledrm driver</a>,
which has some discussion of how the PC &#39;firmware&#39; (EFI or BIOS) sets up
the initial graphics environment.</p>
</div></div>
  </body>
</html>
