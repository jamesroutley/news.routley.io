<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.highcaffeinecontent.com/blog/20220325-Intel-Virtualization-and-Apple-Silicon">Original</a>
    <h1>Intel Virtualization and Apple Silicon</h1>
    
    <div id="readability-page-1" class="page"><div><p>The transition to Apple Silicon brought about many exciting things, but one of the capabilities left behind was access to the world of Intel-based virtual machines. <code>X86_64</code> just isn&#39;t a trivial architecture to emulate, and it may never be feasible to do so on Apple Silicon at a useful speed as the operating systems you wish to run gain more and more complexity and become more and more demanding.</p>
<p>You have plenty of great options for emulation, <a href="https://mac.getutm.app">like UTM</a>, but the performance penalty is significant, and that rules out many use-cases.</p>
<p>I have always used virtual machines as my window into the past. I started emulating Windows 95 via Connectix&#39; Virtual PC a lifetime ago, and in my teenage years explored the exciting years of then-lost alternative operating systems, like BeOS, OS/2, NEXTSTEP, as well as keeping vaguely up to date with Microsoft&#39;s doomed &#39;Longhorn&#39; experiments. Apple&#39;s transition to Intel in 2006 opened up whole new opportunities, and spawned VMware Fusion and Parallels for Mac. VMware in particular provided a great, Mac-like experience that really resonated with me, and I&#39;ve used the app ever since.</p>
<p>But say you are somebody who has used VMware Fusion on their Mac for a while — you might have a library of virtual machines you need to preserve for various work or productivity-related tasks, like a Windows 7 install with Microsoft Office, or Visual Studio. Or you&#39;re a Mac developer who needs to be able to run an older verson of macOS to test the backwards-compatibility of their apps. Now, you&#39;ve just bought a brand new Apple-Silicon-based Mac, and there is just simply no way to run your VMs any more. VMware no longer boots anything under Rosetta, and the VMware Fusion Apple Silicon preview only supports virtualizing Linux as Microsoft&#39;s licensing story for Windows on ARM does not include the Mac.</p>
<p><img src="https://hccdata.s3.amazonaws.com/blog/20220325_no_vm_for_you.jpg" alt="https://hccdata.s3.amazonaws.com/blog/20220325_no_vm_for_you.jpg" loading="lazy"/></p>
<hr/>
<p><strong>There is, however, another way.</strong></p>
<hr/>
<p>VMware have an enterprise-level operating system called ESXi, which is a <em>bare metal hypervisor</em>. What does that mean in practice? If you have a spare PC and Ethernet, you can install ESXi as its OS, configure it over the network through a web browser, and have it become the dedicated engine that runs your VMware virtual machines. With <strong>VMware Fusion Pro</strong>, you can connect to that ESXi machine via its IP address, and then be able to run/manage your virtual machines mostly the same as when you could run them locally. VMware Fusion Pro is not free, though if you&#39;ve been keeping up to date over the years an upgrade license is about $100. ESXi itself <a href="https://kb.vmware.com/s/article/2107518">offers a free license for home use</a>. To be clear: you can run and control your VMs entirely from ESXi&#39;s free web UI, if you don&#39;t want to pay for Fusion Pro, and/or use the built-in Screen Sharing or Remote Desktop features of your guest OSes instead.</p>
<p>Not all features of VMware are supported in this manner. You can&#39;t use the &#39;Unity&#39; mode to interleave your Mac and Windows apps, or use the quick launcher menu, for example, and there are quirks like getting black thumbnails for suspended VMs. I found VMware Fusion also tabs windows, which is annoying (<a href="https://twitter.com/stroughtonsmith/status/1506387489732403200?s=21">fix</a>). It&#39;s also kinda frustrating that all the VMs on ESXi are provided as a flat list, with no way to group them or put them in folders — but that&#39;s a first-world problem for people with a ton of VMs, not your average user.</p>
<p>What you <strong>do</strong> get, though, is near-native performance, without taking up any of the resources of the Mac you&#39;re working on. Most of the same configuration and management UIs are available, but for those that aren&#39;t there is always the browser-based management interface to your ESXi box, which has tons of advanced settings beyond anything VMware usually exposes. You can boot, shut down, suspend, add, delete VMs remotely. You can drag and drop your existing VMs to the server. You can even stream local disc images from VMware Fusion to the VM on the server. Really, the only tell that it&#39;s coming over the network at all is a little bit of h264 compression when things are in motion.</p>
<p><img src="https://hccdata.s3.amazonaws.com/blog/20220325_win11_on_m1.jpg" alt="https://hccdata.s3.amazonaws.com/blog/20220325_win11_on_m1.jpg" loading="lazy"/></p>
<p>One advantage very specific to the low-level way ESXi works, because there&#39;s no underlying operating system to get in the way, is the ability to &#39;pass through&#39; real hardware to the virtual machine — say a specific network card, or a USB hub. Or most importantly for macOS: a GPU. If all you want to do is run Windows or Linux, no need to read on — life is easy.</p>
<hr/>
<p><strong>Things get technical below.</strong></p>
<hr/>
<h3>Preamble</h3>
<p>From what I gather ESXi has multiple web management interfaces: the free one, and the expensive VSphere/vCenter Server. Trying to figure this stuff out from the VMware website as a home user is near-impossible: it&#39;s completely obtuse, enterprise-focused, and there&#39;s no ELI5 option. Almost everybody writing about this topic is using the non-free UI, because they are virtualization professionals. I am not; I have used the basic, free UI for everything — so while the pre-existing guides all still apply, the location and wording of the options is slightly different. Use them to inform you, but be prepared to learn as you go. I had to piece together a whole lot of disparate blog and reddit posts to get this set up the way I want, and now that I have I just want to record it all here for posterity (and so I don&#39;t have to keep it in my own head, either; <a href="https://twitter.com/stroughtonsmith/status/1505919279526522881?s=21">🧵 Twitter thread</a>). Once you&#39;ve done everything once, the rest is trivial.</p>
<h3>Virtualizing macOS</h3>
<p>ESXi has the same ability to run macOS VMs that VMware Fusion has, with an important caveat: this only works out of the box if you have ESXi running on a <em>Supported</em> Mac, like the 2018 Mac mini, or a pre-2019 Mac Pro (both of which are still available from Apple.com for the time being). If you have a spare Mac mini, great!</p>
<p>I, however, decided to base my ESXi server on an Intel NUC, a little PC barely much bigger than a Raspberry Pi. Specifically a tenth-generation NUC10i5FNHN in my case; I chose a tenth-generation NUC because from what I read, GPU passthrough wasn&#39;t fully working on the NUC11 (yet?), and there is precious little information to go on out there to try and figure out if that situation has changed. All of its hardware seems to be fully supported in the latest versin of ESXi, including onboard networking. You can also buy a whole lot of NUCs for the price of a Mac mini, and they all have upgradable NVMe, RAM, and a 2.5&#34; SATA drive slot, which are huge advantages over most Macs.</p>
<p>While this is not a tutorial, I wanted to link to the sources I used in putting together my setup. In particular, <a href="https://vmscrub.com/installing-macos-12-monterey-on-vmware-esxi-7-update-3/">this guide</a> runs through almost everything I needed to get macOS running — use it as a starting point, then come back, because I go beyond below.</p>
<p>There are a couple of elements to running macOS in ESXi on non-Apple hardware:</p>
<ul>
<li>Turning off Secure Boot on your ESXi PC to enable the running of scripts and modification of the OS</li>
<li>Patching ESXi using <a href="https://github.com/shanyungyang/esxi-unlocker">esxi-unlocker</a></li>
<li>Creating an ISO from any given macOS installer</li>
<li>Creating the macOS virtual machine</li>
<li>Providing <a href="https://www.reddit.com/r/hackintosh/comments/k5n3jm/igpu_passthrough_to_mac_vm_on_esxi/gr1ini7/?utm_source=reddit&amp;utm_medium=web2x&amp;context=3">some extra properties</a> (like a real Mac&#39;s serial number) to enable the Mac App Store, iMessage, etc</li>
<li>Installing and setting up macOS</li>
</ul>
<p>Apple helpfully provides an entire library of legacy versions of macOS as free downloads — <a href="https://support.apple.com/en-us/HT211683">How to get old versions of macOS</a>. However, except for macOS 11 which has Apple Silicon support, most of them will need to be downloaded on a supported Intel Mac. From those downloads, you will create the ISOs as per the linked guide — they can&#39;t be booted as-is.</p>
<hr/>
<p><img src="https://hccdata.s3.amazonaws.com/blog/20220325_high_sierra.jpg" alt="https://hccdata.s3.amazonaws.com/blog/20220325_high_sierra.jpg" loading="lazy"/></p>
<hr/>
<h3>Passthrough Graphics for macOS VMs</h3>
<p>Additionally, if you&#39;ve ever used a recent macOS in a virtual machine, you will be keenly aware at how badly it performs without graphics acceleration. If you have a supported Mac running ESXi, like a Mac mini, this part is easy; check out <a href="https://williamlam.com/2020/06/passthrough-of-integrated-gpu-igpu-for-apple-mac-mini-2018.html">this guide</a>. But in short:</p>
<ul>
<li>Ensure networking is set up in your VM</li>
<li>Enable Screen Sharing (because you will no longer be able to interact with this VM via VMware Fusion when the graphics card takes over the display)</li>
<li>Turn on passthru for your graphics chip using the ESXi web UI</li>
<li>Add a &#39;PCI device&#39; to your VM, with the ESXi web UI, and point it at your passthru graphics chip</li>
<li>You should use the <a href="https://www.insanelymac.com/forum/files/file/987-vmware-tools-for-os-x-macos-darwiniso-and-darwinpre15iso/">VMware Tools</a> to <a href="https://williamlam.com/2015/10/heads-up-workaround-for-changing-mac-os-x-vm-display-resolution-in-vsphere-fusion.html">set specific resolutions</a> for the VM, if you want Retina/HiDPI.</li>
</ul>
<p>If you&#39;re on a Mac mini, you might be done here; simply wait for your virtual machine to show up in the Network list on your own Mac, then connect to it via Screen Sharing like you might any other machine.</p>
<p>Guides mention some extra passthrough options through the VSphere interface that I can&#39;t find in the free UI, but from what I&#39;ve gathered almost everything is available through the ESXi shell if not exposed in the web interface. Again, you will find bits and pieces of this documented in <a href="https://www.yellow-bricks.com/2020/01/22/installing-the-nvidia-software-on-an-esxi-host-and-configuring-for-vgpu-usage/">random helpful blog posts</a>.</p>
<p>I can&#39;t remember if this was important, but I set it and forgot about it:
<code>esxcli graphics host set --default-type SharedPassthru</code></p>
<p>Note also this command from the guide linked earlier, which stops ESXi from automatically claiming the GPU/display for itself at startup:
<code>esxcli system settings kernel set -s vga -v FALSE</code></p>
<hr/>
<p><img src="https://hccdata.s3.amazonaws.com/blog/20220325_esxi_passthrough.jpg" alt="https://hccdata.s3.amazonaws.com/blog/20220325_esxi_passthrough.jpg" loading="lazy"/></p>
<hr/>
<h3>Unsupported GPUs</h3>
<p>The GPU in the NUC10 I&#39;m using isn&#39;t natively recognized by macOS, so, after <em>a lot</em> of experimentation, I opted to put together a secondary disk with the Clover bootloader that injects a series of kexts (<a href="https://github.com/RehabMan/OS-X-Fake-PCI-ID">FakePCIID</a>) that spoof the device ID such that macOS will light it up. I had to add the NUC10&#39;s graphics chip&#39;s device-id into the Info.plist in the couple of kexts, and modify the Clover config.plist with the right vendor and framebuffer IDs. The Clover config also specifically spoofs a 2018 Mac mini model ID. <em>Almost all the Hackintosh-specific guides I found told me to use OpenCore instead of Clover, and Lilu/WhateverGreen, but I had precisely zero success with this in ESXi and wasted a day along those lines of exploration.</em></p>
<p>If that sounds way over your head, <strong>don&#39;t worry</strong>: this disk image, now I&#39;ve made one, is pretty much standalone, in that I can copy it into new Mac VMs and boot from it and accelerated graphics will &#39;just work&#39;. It doesn&#39;t otherwise screw with macOS or require any weird modifications, and shouldn&#39;t get in the way of software updates.</p>
<p>Ready-made disk: <a href="https://hccdownloads.s3.amazonaws.com/Clover-ESXi-NUC10-PassthroughGPU-BootMe.zip">💽 Clover-ESXi-NUC10-PassthroughGPU-BootMe.zip </a> (67MB)</p>
<ul>
<li>Attach ready-made Clover disk as hard drive 2 to the VM</li>
<li>&#39;Power On To Firmware&#39; in VMware, Enter Setup, and change the boot order to boot from drive 2 first</li>
<li>Boot!</li>
<li>[Optional] <a href="https://discussions.apple.com/docs/DOC-7942">Edit fstab</a> inside the macOS VM to prevent the &#39;msdos&#39; Clover disk from mounting at boot. Out of sight, out of mind.</li>
</ul>
<p>If your ESXi PC has PCIe slots, or an eGPU enclosure attached over Thunderbolt, you could just as easily find a fully-Mac-compatible GPU to dedicate to your VM, or even one for each… (down this road lies madness). There are some <a href="https://twitter.com/qwertyoruiopz/status/1406408694590578693">undocumented ESXi options</a> that might help.</p>
<hr/>
<p><img src="https://hccdata.s3.amazonaws.com/blog/20220325_catalina_gpu.jpg" alt="https://hccdata.s3.amazonaws.com/blog/20220325_catalina_gpu.jpg" loading="lazy"/></p>
<hr/>
<h3>Virtualizing Mac OS X 10.4 &#34;Tiger&#34;–10.6 &#34;Snow Leopard&#34;</h3>
<p>&#34;Lion&#34; 10.7 was the first client verson of Mac OS X that was officially supported in VMware, without any hacks. Mac OS X Server 10.5 and 10.6 were supported, but not the consumer releases. As a result, there are <a href="https://www.downtowndougbrown.com/2017/10/virtualizing-mac-os-x-10-4-with-vmware/">some additional steps</a> to follow to get older versions to boot. In summary:</p>
<ul>
<li>Add the extra properties to your VM config as above</li>
<li><a href="https://github.com/jtergogit/unlocker207/tree/master/firmware">Find</a> and copy <code>efi32-srvr.rom</code> and <code>efi64-srvr.rom</code> into your VM&#39;s container with ESXi&#39;s Datastore browser</li>
<li>For Tiger, use the efi32 variant as per the steps linked above. For Leopard and Snow Leopard, use &#39;efi64&#39; in place of &#39;efi32&#39;.</li>
</ul>
<p>As an aside: if you have an older Apple Developer account, your <a href="https://developer.apple.com/download/all/">&#39;More Downloads&#39;</a> archive may still have Universal Intel/PowerPC disk images available for 10.4.7 Server, 10.5.0 (9A581), and 10.6.0 (10A432), if you don&#39;t really want to trust random ISOs from the internet. Once set up, Mac VMs should have no issues installing OS updates, so you can patch them up to latest.</p>
<hr/>
<p><img src="https://hccdata.s3.amazonaws.com/blog/20220325_mac_os_xes.jpg" alt="https://hccdata.s3.amazonaws.com/blog/20220325_mac_os_xes.jpg" loading="lazy"/></p>
<hr/>
<h3>Conclusion</h3>
<p>Moving my VMware Fusion collection to ESXi and getting it set up <em>just right</em> has been a marathon, but I&#39;m so glad I did it. Not only does this bring my VMs with me into an Apple Silicon world, but it also opens up new opportunities like running fully-graphics-accelerated versions of macOS for testing my apps. The NUC is small enough to squirrel away somewhere, but powerful enough to run virtually any Intel-based OS I want. In fact, since there is now a preliminary version of ESXi for ARM (which can run on Raspberry Pi 4, no less), you could even expose ARM-based operating systems, Linux or Windows-on-ARM, to an Intel-based Mac, and have them listed alongside the rest of your VMs in VMware Fusion Pro.</p>
<p>At least now I can comfortably work on Apple Silicon without losing my VMware library. </p>
<p>✌️</p><hr/></div></div>
  </body>
</html>
