<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://hoten.cc/blog/porting-zelda-classic-to-the-web/">Original</a>
    <h1>Porting Zelda Classic to the web</h1>
    
    <div id="readability-page-1" class="page"><div>
    <article>
   
  <time datetime="2022-04-29T00:00:00.000Z">April 29, 2022</time> 
  

<div>
  <p><img src="https://commoncog.com/images/zc/Mitchfork.png" alt=""/>
  <span>Mitchfork&#39;s winning screenshot from the <a href="https://www.purezc.net/forums/index.php?showtopic=77409" target="_blank">2021 Screenshot of the Year contest</a></span>
</p></div>
<!-- Excerpt Start -->
<p>I ported Zelda Classic (a game engine based on the original Zelda) to the web. You can play it <a href="https://hoten.cc/zc/play/" target="_blank" rel="noopener noreferrer">here</a>‚Äìgrab a gamepad if you have one!</p>
<p>It&#39;s a PWA, so you can also install it.</p>
<!-- Excerpt End -->
<p>I&#39;ve written some <a href="#zelda-classic">background information</a> on Zelda Classic, and chronicled <a href="#porting-zelda-classic-to-the-web">the technical process</a> of porting a large C++ codebase to the web using WebAssembly.</p>
<blockquote>
<p>Follow <a href="https://twitter.com/zelda_classic" target="_blank" rel="noopener noreferrer">Zelda Classic on Twitter</a>!</p>
</blockquote>
<nav><ol><li><a href="#zelda-classic">Zelda Classic</a><ol><li><a href="#on-the-web">On the Web</a></li></ol></li><li><a href="#porting-zelda-classic-to-the-web">Porting Zelda Classic to the Web</a><ol><li><a href="#getting-it-working">Getting it working</a><ol><li><a href="#emscripten">Emscripten</a></li><li><a href="#starting-off">Starting off</a></li><li><a href="#learning-cmake-allegro-and-emscripten">Learning CMake, Allegro, and Emscripten</a></li><li><a href="#allegro-legacy">Allegro Legacy</a></li><li><a href="#starting-to-build-zelda-classic-with-emscripten">Starting to build Zelda Classic with Emscripten</a></li><li><a href="#let-there-be-threads">Let there be threads</a></li><li><a href="#of-mutexes-and-deadlocks">Of mutexes and deadlocks</a></li></ol></li><li><a href="#getting-it-fully-functional">Getting it fully functional</a><ol><li><a href="#playing-midi-with-timidity">Playing MIDI with Timidity</a></li><li><a href="#music-working-but-no-sfx">Music working, but no SFX?</a></li><li><a href="#build-script-hacking">Build script hacking</a></li></ol></li><li><a href="#making-it-awesome">Making it awesome</a><ol><li><a href="#quest-list">Quest List</a></li><li><a href="#mp3s-and-oggs-and-retro-music">MP3s, and OGGs and retro music</a></li><li><a href="#persisting-data">Persisting data</a></li><li><a href="#gamepads">Gamepads</a></li><li><a href="#mobile-support">Mobile support</a></li><li><a href="#pwa">PWA</a></li></ol></li><li><a href="#takeaways">Takeaways</a></li></ol></li></ol></nav>
<a href="https://hoten.cc/zc/create/?quest=classic/1st.qst&amp;map=0&amp;screen=119" target="_blank">
  <p><img src="https://commoncog.com/images/zc/editor.png" alt="ZQuest editor opened to the starting screen of the original Zelda"/>
    <span>ZQuest, the Zelda Classic quest editor</span>
  </p>
</a>
<p><a href="https://www.zeldaclassic.com/" target="_blank" rel="noopener noreferrer">Zelda Classic</a> is a 20+ year old game engine originally made to recreate and modify the original Legend of Zelda. The engine grew to support far more features than what was necessary to create the original game, and today there are <a href="https://www.purezc.net/index.php?page=quests&amp;sort=rating" target="_blank" rel="noopener noreferrer">over 600</a> custom games - the community calls them quests.</p>
<p>Many are spiritual successors to the original, perhaps with improved graphics, but very recognizable as a Zelda game. They range in complexity, quality and length. Fair warning, some are just awful, so be discerning and use the rating to guide you.</p>
<p>If you are a fan of the original 2D Zelda games, I believe you&#39;ll find many Zelda Classic quests to be well worth your time. Some are 20+ hour games with expansive overworlds and engaging, unique dungeons. The engine today supports scripting, and many have used that to push it to the limits: it&#39;s almost impossible to believe that some quests implemented character classes, online networking, or achievements in an engine meant to create the original Zelda.</p>
<p>However, the most recent version of Zelda Classic only supports Windows... until now!</p>
<h2 id="on-the-web" tabindex="-1">On the Web</h2>
<p>I spent the last two months (roughly ~150 hours) porting Zelda Classic to run in a web browser.</p>
<p>There&#39;s a lot of quests to choose from, but here&#39;s just a small sampling! Click any of these to jump into the quest:</p>

<div>
<a href="https://hoten.cc/zc/play/?quest=bs3.1/NewBS+3.1+-+1st+Quest.qst" target="_blank">
  <p><img src="https://hoten.cc/quest-maker/play/zc_quests/bs3.1/image1.png" alt="" width="100%"/>
    <span>BS Zelda 1st Quest</span>
  </p>
</a>
<a href="https://hoten.cc/zc/play/?quest=373/Quest.qst" target="_blank">
  <p><img src="https://commoncog.com/images/zc/hookshot-title.png" alt="" width="100%"/>
    <span>Link&#39;s Quest for the Hookshot 2</span>
  </p>
</a>
<a href="https://hoten.cc/zc/play/?quest=139/HeroOfDreams.qst" target="_blank">
  <p><img src="https://commoncog.com/images/zc/hod.gif" alt="" width="100%"/>
    <span>Hero of Dreams</span>
  </p>
</a>
<a href="https://hoten.cc/zc/play/?quest=731/GoGollab_1_FunnyEdition.qst" target="_blank">
  <p><img src="https://commoncog.com/images/zc/gollab.png" alt="" width="100%"/>
    <span>Go Gollab: The Conflictions of Morality</span>
  </p>
</a>
<a href="https://hoten.cc/zc/play/?quest=751/LoL+New+Legacy.qst" target="_blank">
  <p><img src="https://commoncog.com/images/zc/new-legacy.png" alt="" width="100%"/>
    <span>Legend of Link: The New Legacy</span>
  </p>
</a>
<a href="https://hoten.cc/zc/play/?quest=152/cashaunt2.qst" target="_blank">
  <p><img src="https://hoten.cc/quest-maker/play/zc_quests/152/image0.gif" alt="" width="100%"/>
    <span>Castle Haunt II</span>
  </p>
</a>
</div>
<p>I hope my efforts result in Zelda Classic reaching a larger audience. It&#39;s been challenging work, far outside my comfort zone of web development, and I&#39;ve learned a lot about WebAssembly, CMake and multithreading. Along the way, I discovered bugs across multiple projects and did due diligence in fixing (or just reporting) them when I could, and even proposed a <a href="https://github.com/whatwg/html/issues/7838" target="_blank">change to the HTML spec</a>.</p>

<p>The rest of this article is an overview of the technical process of porting Zelda Classic to the web.</p>
<blockquote>
<p>If you&#39;re interested in the minutia, I&#39;ve made <a href="https://docs.google.com/document/d/1tOI1k9nSWDxmHXoW-yy4fk3_7AbS6vCk3UUG2iCwS_g" target="_blank" rel="noopener noreferrer">my daily notes</a> available. This was the first time I kept notes like this, and I found the process improved my working memory significantly... and it definitely helped me write this article.</p>
</blockquote>
<h2 id="getting-it-working" tabindex="-1">Getting it working</h2>
<h3 id="emscripten" tabindex="-1">Emscripten</h3>
<p><a href="https://emscripten.org/" target="_blank" rel="noopener noreferrer">Emscripten</a> is a compiler toolchain for building C/C++ to WebAssembly. The very TL;DR of how it works is that it uses <code>clang</code> to transform the resultant LLVM bytecode to Wasm. It&#39;s not enough to just compile code to Wasm‚ÄìEmscripten also provides Unix runtime capabilities by implementing them with JavaScript/Web APIs (ex: implementations for most syscalls; an in-memory or IndexedDB-backed filesystem; pthreads support via Web Workers). Because many C/C++ projects are built with Make and CMake, Emscripten also provides tooling for interoping with those tools: <code>emmake</code> and <code>emcmake</code>. For the most part, if a C/C++ program is portable, it can be built with Emscripten and run in a browser, although you&#39;ll like have to make changes to <a href="https://emscripten.org/docs/porting/emscripten-runtime-environment.html#emscripten-runtime-environment" target="_blank" rel="noopener noreferrer">accommodate the browser main loop</a>.</p>
<blockquote>
<p>If you are developing a Wasm application, the Chrome DevTools DWARF extension is essential. See <a href="https://developer.chrome.com/blog/wasm-debugging-2020/" target="_blank" rel="noopener noreferrer">this article</a> for how to use it. When it works, it&#39;s excellent. You may need to drop any optimization for best results. Even with no optimization pass, I often ran into cases where some frames of the call stacktrace were obviously wrong, so I sometimes had to resort to printf-style debugging.</p>
</blockquote>
<h3 id="starting-off" tabindex="-1">Starting off</h3>
<p>Zelda Classic is written in C++ and uses Allegro, a low-level cross platform library for window management, drawing to the screen, playing sounds, etc. Well, it actually uses Allegro 4, released circa 2007. Allegro 4 does not readily compile with Emscripten, but Allegro 5 does. The two versions are vastly different but fortunately there is an adapter library called Allegro Legacy which allows an Allegro 4 application to be built using Allegro 5.</p>
<p>So that&#39;s the first hurdle‚ÄìZelda Classic needs to be ported to Allegro 5, and its CMakeLists.txt needs to be modified to build allegro from source.</p>
<blockquote>
<p>Allegro 5 is able to support building with Emscripten because it can use <a href="https://github.com/libsdl-org/SDL" target="_blank" rel="noopener noreferrer">SDL</a> as its backend, which Emscripten supports well.</p>
</blockquote>
<p>Before working on any of that directly, I needed to address my lack of knowledge of CMake and Allegro.</p>
<h3 id="learning-cmake-allegro-and-emscripten" tabindex="-1">Learning CMake, Allegro, and Emscripten</h3>
<p>Allegro claims to support Emscripten, but I wanted to confirm it for myself. Luckily they provided some <a href="https://github.com/liballeg/allegro5/blob/master/README_sdl.txt#L30" target="_blank" rel="noopener noreferrer">instructions</a> on how to build with Emscripten. My first PRs were to Allegro to improve this documentation.</p>
<blockquote>
<p>I wasted a few hours here because of an <a href="https://github.com/liballeg/allegro5/pull/1319" target="_blank" rel="noopener noreferrer">unfortunate difference</a> between bash and zsh.</p>
</blockquote>
<p>Next I found an interesting example program showcasing palette swapping‚Äìencoding a bitmap as indices into an arbitrary set of colors, which can be swapped out at runtime. But, it didn&#39;t work when built with Emscripten. To get a little practice with Allegro, I worked on improving this example.</p>
<p>The fragment shader:</p>
<pre><code><span>uniform</span> <span>sampler2D</span> al_tex<span>;</span></code></pre>
<p>Allegro passes a bitmap&#39;s texture to the shader as <code>al_tex</code>, and in this program that bitmap is just a bunch of numbers 0-255. Attached to the shader as an input is a palette of colors <code>pal</code>, and at runtime the program swaps out the palette, changing the colors rendered by the shader. There were two things wrong here that results in this shader not working in WebGL:</p>
<ol>
<li>It lacks a precision declaration. In WebGL, this is not optional. Very simple fix‚Äìjust add <code>precision mediump float;</code></li>
<li>It uses a non-constant expression to index an array. WebGL does not support that, so the entire shader needed to be redesigned. This was more involved, so I&#39;ll just link to the <a href="https://github.com/liballeg/allegro5/pull/1318" target="_blank" rel="noopener noreferrer">PR</a></li>
</ol>
<p>The resulting program is hosted <a href="https://tedious-porter.surge.sh/ex_palette.html" target="_blank" rel="noopener noreferrer">here</a>.</p>
<blockquote>
<p>It turned out that none of this knowledge of how to do palette swapping in Allegro 5 would be necessary for upgrading Zelda Classic&#39;s Allegro, although
initially I thought it might. Still, it was a nice introduction to the library.</p>
</blockquote>
<p>Next I wanted to write a simple <code>CMakeLists.txt</code> that I could wrap my head around, one that builds Allegro from source and also supports building with Emscripten.</p>
<blockquote>
<p>Emscripten supports building projects configured with CMake via <a href="https://github.com/Emscripten-core/Emscripten/blob/main/emcmake.py" target="_blank" rel="noopener noreferrer"><code>emcmake</code></a>, which is a small program that configures an Emscripten CMake <a href="https://github.com/Emscripten-core/Emscripten/blob/main/cmake/Modules/Platform/Emscripten.cmake" target="_blank" rel="noopener noreferrer">toolchain</a>. Essentially, running <code>emcmake cmake &lt;path/to/source&gt;</code> configures the build to use <code>emcc</code> as the compiler.</p>
</blockquote>
<p>I spent some time reading many tutorials on CMake, going through real-world <code>CMakeLists.txt</code> and trying to understand it all line-by-line. The CMake <a href="https://cmake.org/cmake/help/latest/" target="_blank" rel="noopener noreferrer">documentation</a> was excellent during this process. Eventually, I ended up with this:</p>
<p><a href="https://github.com/connorjclark/allegro-project/blob/main/CMakeLists.txt" target="_blank" rel="noopener noreferrer"><code>https://github.com/connorjclark/allegro-project/blob/main/CMakeLists.txt</code></a></p>
<pre><code><span>cmake_minimum_required</span><span>(</span><span>VERSION</span> <span>3.5</span><span>)</span></code></pre>
<blockquote>
<p>This could have been simpler, but Allegro&#39;s <code>CMakeLists.txt</code> requires a <a href="https://github.com/liballeg/allegro5/issues/1328" target="_blank" rel="noopener noreferrer">few modifications</a> for it to be easily consumed as a dependency.</p>
</blockquote>
<p>Initally I tried using CMake&#39;s <a href="https://cmake.org/cmake/help/latest/module/ExternalProject.html" target="_blank" rel="noopener noreferrer"><code>ExternalProject</code></a> instead of <a href="https://cmake.org/cmake/help/latest/module/FetchContent.html" target="_blank" rel="noopener noreferrer"><code>FetchContent</code></a>, but the former was problematic with Emscripten because it runs <code>cmake</code> under the hood, and it seemed like it was not aware of the toolchain that <code>emcmake</code> provides. I don&#39;t know why I couldn&#39;t get it to work, but I know <code>FetchContent</code> is the newer of the two and I had better luck with it.</p>
<h3 id="allegro-legacy" tabindex="-1">Allegro Legacy</h3>
<p>Allegro 4 and 5 can be considered entirely different libraries:</p>
<ul>
<li>literally every API was rewritten, and not in a 1:1 way</li>
<li>A4 uses polling for events while A5 uses event queues / loops</li>
<li>A4 only supports software rendering, and directly supports palettes (which ZC makes heavy use of); while A5 supports shaders / GPU-accelerated rendering (but dropped palette manipulation)</li>
<li>And most importantly for my concerns, only A5 can be compiled with Emscripten (trivially, because of its SDL support)</li>
</ul>
<p>Replacing calls to A4&#39;s API with A5 essentially means a rewrite, and given the size of Zelda Classic that was not an option. Fortunately, this is where <a href="https://github.com/NewCreature/Allegro-Legacy" target="_blank" rel="noopener noreferrer">Allegro Legacy</a> steps in.</p>
<p>To support multiple platforms, Allegro abstracts anything OS-specific to a &#34;system driver&#34;. There is one for each supported platform that implements low-level operations like filesystem access, window management, etc. Allegro Legacy bridges the gap between A4 and A5 by creating a system driver <em>that uses A5</em> to implement A4&#39;s system interfaces. In other words, Allegro Legacy is just A4 with A5 as its driver. All the files in <a href="https://github.com/NewCreature/Allegro-Legacy/tree/master/src" target="_blank" rel="noopener noreferrer"><code>src</code></a> are just A4 (with a few modifications), except for the <code>a5</code> folder which provides the A5 implementation.</p>
<p>This is the entire architecture of running Zelda Classic in a browser:</p>
<p><img src="https://commoncog.com/images/zc/ascii-arch.png" alt="ASCII diagram of Zelda Classic running on the web"/>
  <span>üê¢ I&#39;ve fixed/worked-around bugs in every layer of this.</span>
</p>
<p>I used my newly wrangled working knowledge of CMake to configure Zelda Classic&#39;s <code>CMakeLists.txt</code> to build Allegro 5 &amp; Allegro Legacy from source. Allegro Legacy was very nearly a drop-in replacement. I struggled initially with an &#34;unresolved symbol&#34; linker error, for a function I was certain was being included in the compilation, but this turned out to be a simple <a href="https://github.com/NewCreature/Allegro-Legacy/pull/23" target="_blank" rel="noopener noreferrer">oversight</a> in a header file. Not really being a C/C++ guy this took me <em>way</em> too long to debug!</p>
<p>Once things actually linked and compilation was successful, Allegro Legacy <em>just worked</em>, although I fixed some minor bugs related to <a href="https://github.com/NewCreature/Allegro-Legacy/pull/21" target="_blank" rel="noopener noreferrer">sticky mouse input</a> and <a href="https://github.com/NewCreature/Allegro-Legacy/pull/24" target="_blank" rel="noopener noreferrer">file paths</a>.</p>
<blockquote>
<p>I sent a <a href="https://github.com/ArmageddonGames/ZeldaClassic/pull/774" target="_blank" rel="noopener noreferrer">PR for upgrading to Allegro 5</a> to the Zelda Classic repro, but I expect it will remain unmerged until a future major release.</p>
</blockquote>
<h3 id="starting-to-build-zelda-classic-with-emscripten" tabindex="-1">Starting to build Zelda Classic with Emscripten</h3>
<p>Even though Zelda Classic was now on A5 and building it from source, there were still a few pre-built libraries being used for music. I didn&#39;t want to deal with this yet, so to start I stubbed out the music layer with dummy functions so everything would still link with Emscripten.</p>
<p><code>zcmusic_fake.cpp</code></p>
<pre><code><span><span>#</span><span>include</span> <span>&lt;stddef.h&gt;</span></span></code></pre>
<p>Zelda Classic reads various configuration files from disk, including data files containing large things like MIDIs. Emscripten can package such data alongside Wasm deployments via the <a href="https://emscripten.org/docs/porting/files/packaging_files.html" target="_blank" rel="noopener noreferrer"><code>--preload-data</code></a> flag. These files can be pretty large (<code>zc.data</code> is ~9 MB), so a long-term caching strategy is best: <code>--use-preload-cache</code> is a nice Emscripten feature that will cache this file in IndexedDB. However, the key it uses is unique to every build, so any deployment invalidates the cache of all users. That&#39;s no good, but there&#39;s a quick hack to make the hash content-based instead:</p>
<pre><code><span># See https://github.com/emscripten-core/emscripten/issues/11952</span></code></pre>
<blockquote>
<p>I also sent a <a href="https://github.com/emscripten-core/emscripten/pull/16807" target="_blank" rel="noopener noreferrer">PR to Emscripten</a> to fix the above</p>
</blockquote>
<h3 id="let-there-be-threads" tabindex="-1">Let there be threads</h3>
<p>As soon as I got Zelda Classic building with Emscripten and running in a browser, I&#39;m faced with a page that does nothing but busy-hangs the main thread. Pausing in DevTools shows the problem:</p>
<pre><code><span>static</span> BITMAP <span>*</span> <span>a5_display_init</span><span>(</span><span>int</span> w<span>,</span> <span>int</span> h<span>,</span> <span>int</span> vw<span>,</span> <span>int</span> vh<span>,</span> <span>int</span> color_depth<span>)</span></code></pre>
<blockquote>
<p>The busy-wait while loop pattern is problematic because it spins the CPU and wastes cycles. However, in this case it&#39;s actually pretty OK because the initialization code is expected to finish quickly. In general, a <a href="https://www.ibm.com/docs/en/aix/7.1?topic=programming-using-condition-variables" target="_blank" rel="noopener noreferrer">condition variable</a> is preferred to allow the thread to sleep until the state it cares about changes.</p>
</blockquote>
<p>Emscripten can build multithreaded applications that work on the web by using Web Workers and <code>SharedArrayBuffer</code>, but by default it will not build with thread support, so everything happens on the main thread.</p>
<blockquote>
<p>For a deep dive on threads in Wasm, read <a href="https://web.dev/webassembly-threads/" target="_blank" rel="noopener noreferrer">this</a></p>
</blockquote>
<blockquote>
<p><code>SharedArrayBuffer</code> requires special response headers to be set, even for localhost. The simplest way to do this is to use Paul Irish&#39;s <a href="https://github.com/paulirish/statikk" target="_blank" rel="noopener noreferrer"><code>stattik</code></a>: just run <code>npx statikk --port 8000 --coi</code></p>
</blockquote>
<p>In the above case, a thread is created which is expected to instantly set <code>_a5_display_creation_done</code>, but due to the lack of threads that never happens so the main thread is left hanging forever.</p>
<p>Clearly, I needed to enable <a href="https://emscripten.org/docs/porting/pthreads.html" target="_blank" rel="noopener noreferrer"><code>pthread</code></a> support.</p>
<p>I figured it&#39;d be best to also enable <code>PROXY_TO_PTHREAD</code>, which moves the main application thread into a pthread AKA web worker (instead of the main browser thread), but that was a dead-end due to <a href="https://github.com/emscripten-core/emscripten/issues/16492" target="_blank" rel="noopener noreferrer">various</a> <a href="https://github.com/libsdl-org/SDL/issues/5260" target="_blank" rel="noopener noreferrer">unexpected</a> issues with SDL which means it does not support this setting.</p>
<blockquote>
<p>I got <a href="https://github.com/emscripten-core/emscripten/issues/6009#issuecomment-1096131889" target="_blank" rel="noopener noreferrer">close</a> to getting <code>PROXY_TO_PTHREAD</code> to work, but not close enough.</p>
</blockquote>
<p>In lieu of this, I had to add <code>rest(0)</code> to many places where Zelda Classic busy waits on the main application thread, otherwise Emscripten&#39;s <a href="https://web.dev/asyncify/" target="_blank" rel="noopener noreferrer"><code>ASYNCIFY</code></a> feature has no opportunity to yield the main thread back to the browser, resulting in the page hanging. For example, this code is problematic to run on the main thread:</p>
<pre><code><span>do</span></code></pre>
<p>because mouse input can only be registered when the main browser thread is in control. Hence, a <code>rest(0)</code> fixes the hang by yielding back to the browser via <code>ASYNCIFY</code>:</p>
<pre><code><span>do</span></code></pre>
<h3 id="of-mutexes-and-deadlocks" tabindex="-1">Of mutexes and deadlocks</h3>
<p>The most difficult problem I ran into during this entire project was debugging a deadlock. It took a few days of getting nowhere, logging when a lock was acquired/released and by what thread (big waste of time!)</p>
<p>Eventually I realized I should stop trying to debug the large mess of a program in front of me and try to build up a reproduction of the issue from scratch.</p>
<p>SDL provides an interface for mutexes that, on Unix, uses <code>pthread</code>. Apparently, some platforms do not support recursive mutexes - that is, allowing a thread to lock the same mutex multiple times, only releasing the lock when it matches with an equal number of unlocks. To support platforms without this functionality, SDL fakes it.</p>
<p><a href="https://github.com/libsdl-org/SDL/blob/c36bd78474c962119db2f5161be6b0d4f07d535e/src/thread/pthread/SDL_sysmutex.c#L91" target="_blank" rel="noopener noreferrer"><code>SDL_sysmutex.c</code></a></p>
<pre><code><span>/* Lock the mutex */</span></code></pre>
<p>Once I realized that the deadlock did not happen when condition variables were not used, I was able to create a small reproduction that resulted in a deadlock via Emscripten
but not when building for Mac. I reported the <a href="https://github.com/libsdl-org/SDL/issues/5428" target="_blank" rel="noopener noreferrer">bug</a> to SDL, and even proposed a <a href="https://github.com/libsdl-org/SDL/pull/5479" target="_blank" rel="noopener noreferrer">patch</a> to improve the fake recursive mutex code,
(at least, it fixed my deadlock) but it turns out that mixing condtion variables and recursive mutexes is a <a href="https://pubs.opengroup.org/onlinepubs/9699919799/functions/pthread_mutexattr_settype.html#:~:text=It%20is%20advised%20that%20an%20application%20should%20not%20use" target="_blank" rel="noopener noreferrer">very bad idea</a>, and in general is <a href="https://github.com/libsdl-org/SDL/pull/5479#issuecomment-1090221325" target="_blank" rel="noopener noreferrer">impossible</a> to get right.</p>
<p>Eventually I realized it was odd that Emscripten doesn&#39;t support recursive mutexes. And sure enough, after writing a quick sample program, I determined <a href="https://github.com/libsdl-org/SDL/pull/5479#issuecomment-1089790046" target="_blank" rel="noopener noreferrer">it actually does support them</a>. Turns out the problem was in SDL&#39;s header configuration for Emscripten <a href="https://github.com/libsdl-org/SDL/pull/5496" target="_blank" rel="noopener noreferrer">not specifiying</a> that recursive mutexes are supported.</p>
<h2 id="getting-it-fully-functional" tabindex="-1">Getting it fully functional</h2>
<h3 id="playing-midi-with-timidity" tabindex="-1">Playing MIDI with Timidity</h3>
<p>Zelda Classic <code>.qst</code> files contain MIDIs, but browsers can&#39;t directly play MIDI files. In order to synthesize audio from a MIDI file you need:</p>
<ul>
<li>a sound sample database</li>
<li>code to interpret the various MIDI commands, such as turning notes on and off</li>
</ul>
<p>Emscripten supports various audio formats with <a href="https://emscripten.org/docs/getting_started/FAQ.html#what-are-my-options-for-audio-playback" target="_blank" rel="noopener noreferrer"><code>SDL_mixer</code></a>, configured via <a href="https://emsettings.surma.technology/#SDL2_MIXER_FORMATS" target="_blank" rel="noopener noreferrer"><code>SDL2_MIXER_FORMATS</code></a>. However, there was no support for MIDI. Luckily <code>SDL_mixer</code> already supports MIDI playback (it uses <a href="https://github.com/SDL-mirror/SDL_mixer/tree/master/src/codecs/timidity#readme" target="_blank" rel="noopener noreferrer">Timidity</a>). It was <a href="https://github.com/emscripten-core/emscripten/pull/16556" target="_blank" rel="noopener noreferrer">straightfoward to configure the Emscripten port system</a> to include Timidity support when requested.</p>
<p>As for the sound samples, I just grabbed some free ones called <a href="https://www.npmjs.com/package/freepats" target="_blank" rel="noopener noreferrer">freepats</a>. Initially I added them to the Wasm preload datafile, but it&#39;s actually pretty large at 30+ MB so a better solution is to load the individual samples from the network as requested. I knew of a Timidity <a href="https://github.com/feross/timidity" target="_blank" rel="noopener noreferrer">fork</a> that did just that, so I studied how it worked there. When a MIDI file loads, that fork checks all the instruments a song will use and <a href="https://github.com/feross/timidity/commit/d1790eef24ff3b4067c536e45aa88c0863ad9676#diff-6ff6417493baaa56336d5c73f273ea180db9c16c2f4a37adf4f5abc380ffc6ccR207" target="_blank" rel="noopener noreferrer">logs which ones are missing</a>. Then the JS code checks that log, fetches the missing ones, and reloads the data. I basically did the same, but all within Timidity/<code>EM_JS</code>.</p>
<p>These fetches freeze the game (but not the browser main thread!) until they complete, which isn&#39;t too bad when starting a quest but can be especially jarring when reaching a new area that plays a song with new MIDI instruments. To make this a bit more bearable, I wrote a <a href="https://gist.github.com/connorjclark/6afb9fb588331a23a2d8fa57cfefe8f5" target="_blank" rel="noopener noreferrer"><code>fetchWithProgress</code></a> function to display a progress bar in the page header.</p>
<blockquote>
<p>While freepats is nice (free, small, and good quality), it is <a href="https://freepats.zenvoid.org/SoundSets/general-midi.html#FreePatsGM" target="_blank" rel="noopener noreferrer">missing many instruments</a>. I found some <a href="https://www.doomworld.com/idgames/music/dgguspat" target="_blank" rel="noopener noreferrer">90s-era GUS sound files</a> on a DOOM modding site to fill the gaps. There&#39;s a comment on that page suggesting the PPL160 is even better quality, so I <a href="https://github.com/chocolate-doom/chocolate-doom/issues/878" target="_blank" rel="noopener noreferrer">located</a> those too. I&#39;m not too happy with the result of <a href="https://github.com/connorjclark/ZeldaClassic/blob/wasm-web/timidity/make-cfg.js" target="_blank" rel="noopener noreferrer">meshing</a> these various instruments together. I&#39;m sure this could be improved, but at least no MIDI files will have missing instruments.</p>
</blockquote>
<h3 id="music-working-but-no-sfx" tabindex="-1">Music working, but no SFX?</h3>
<p>Zelda Classic uses different output channels for music and SFX, which is pretty common in games. Especially because you may wish to sample the two at different rates, which means they can&#39;t use the same output channel. Music is typically sampled at a higher rate for quality purposes, which takes more processing time but that&#39;s OK because it is ok to buffer‚Äìlatency isn&#39;t such a big deal, unless you&#39;re syncing music to video or something. SFX is typically sampled at a lower rate, because there is more urgency to play a sound effect in reaction to gameplay.</p>
<p>With MIDI support included, music was now playing on the title screen, but no SFX was playing. I compiled the Allegro sound example <a href="https://allegro5.org/examples/examples/ex_saw.html" target="_blank" rel="noopener noreferrer"><code>ex_saw</code></a>, which I knew already worked with Emscripten because the hosted example Wasm worked. However, building locally nothing would play, so I had another bug in Allegro to fix.</p>
<p>I added some printf&#39;ing to <code>SDL_SetError</code> and noticed that when Allegro called <code>SDL_Init(SDL_INIT_EVERYTHING)</code>, it would error with <code>&#34;SDL not built with haptic support&#34;</code> ... and then SDL would proceed to tear everything down! SDL failed to setup the haptic subsystem because it does not provide an Emscripten implementation for it. And since Allegro initialized SDL by requesting everything, SDL could not comply. That doesn&#39;t explain why it was working before but isn&#39;t today‚Äìto explain that, I <code>git blame</code>&#39;d the <code>SDL_Init</code> function and saw that a change was made recently to shutdown everything if any subsystem errors. Mystery solved, and I sent a <a href="https://github.com/liballeg/allegro5/pull/1322" target="_blank" rel="noopener noreferrer">PR</a> to Allegro to fix it.</p>
<pre><code>diff --git a/src/sdl/sdl_system.c b/src/sdl/sdl_system.c</code></pre>
<blockquote>
<p>The Web does have a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Vibration_API" target="_blank" rel="noopener noreferrer">Vibration API</a> (for vibrating a mobile device), and experimental support for <a href="https://developer.mozilla.org/en-US/docs/Web/API/GamepadHapticActuator" target="_blank" rel="noopener noreferrer">Gamepad haptic feedback</a>, so it&#39;s certainly possible for SDL to support.</p>
</blockquote>
<p>Now the <code>ex_saw</code> example worked when built locally, but SFX still didn&#39;t play in Zelda Classic. After some more printf&#39;ing, I noticed that SDL was failing to open a second audio channel for SFX. Weird... I opened up SDL&#39;s <a href="https://github.com/libsdl-org/SDL/blob/55a4e1d336db0dd0af70bf22df8ec3ae0b38644a/src/audio/emscripten/SDL_emscriptenaudio.c#L347" target="_blank" rel="noopener noreferrer">audio implementation for Emscripten</a>, and a variable named <code>OnlyHasDefaultOutputDevice</code> grabbed my attention:</p>
<pre><code><span>static</span> SDL_bool</code></pre>
<p>Thinking &#34;no way this will work&#34;, I set that to <code>SDL_FALSE</code> and ... it worked! I reported this as a bug <a href="https://github.com/libsdl-org/SDL/issues/5485" target="_blank" rel="noopener noreferrer">here</a>. It&#39;s not so obvious that this is the proper way to fix this, so this won&#39;t be actually resolved in SDL for a bit. Which leads me to the next topic...</p>
<h3 id="build-script-hacking" tabindex="-1">Build script hacking</h3>
<p>When you fix a bug in a dependency, there is typically a waiting period before a new version of that dependency can be used normally. This is not a problem because there are other ways to use a non-official version of a dependency:</p>
<ul>
<li>package managers can be configured to point to a specific fork or commit</li>
<li>you could vendor the dependency, making it part of your project&#39;s source control</li>
<li>you could maintain a set of diff patches to apply on top of the official release</li>
</ul>
<blockquote>
<p>Playwright has <a href="https://github.com/microsoft/playwright/tree/main/browser_patches" target="_blank" rel="noopener noreferrer">nice infrastructure</a> for building browsers with custom patches that wouldn&#39;t be (pick one: appropriate, quick, or easy) to merge upstream. Brave <a href="https://github.com/brave/brave-core/tree/master/patches" target="_blank" rel="noopener noreferrer">does something similar</a>.</p>
</blockquote>
<p>Then there&#39;s the lazy way: At first, I reached for the expediency of <code>sed</code> commands. I&#39;d find a bug in a dependency, figure out how to use <code>sed</code> to fix it locally, plop it into my build script, and make a note to upstream the bug fix some time later.</p>
<pre><code><span># Temporary workarounds until various things are fixed upstream.</span></code></pre>
<p>And those are just the changes to SDL. I had more for Allegro...</p>
<p>Keeping it simple early helped keep things moving, but once the changes became larger than tweaking a line or two this process became unfeasible. Eventually I setup a simple system: a pretty straightforward application of <code>git diff</code> and <code>patch</code>. There&#39;s some annoying cache clearing that needs to be done in order for patches to Emscripten&#39;s ports to take effect, but it wasn&#39;t too bad. Here&#39;s the entirety of it:</p>
<pre><code><span>#!/bin/bash</span></code></pre>
<h2 id="making-it-awesome" tabindex="-1">Making it awesome</h2>
<h3 id="quest-list" tabindex="-1">Quest List</h3>
<p>Up until now only the built-in original Zelda was playable. Now that I had sound working, I wanted to be able to play custom quests. From my previous work on Quest Maker, I had scraped 600+ quests and their metadata from PureZC.com. Quests are just single <code>.qst</code> files, and I needed a way to get Zelda Classic their data. Adding them to the <code>--preload-data</code> is not an option, because in total they are about 2 GB! No, each file needs to be loaded only upon request.</p>
<blockquote>
<p><a href="https://hoten.cc/quest-maker/play/" target="_blank" rel="noopener noreferrer">Quest Maker</a> was my attempt at remaking Zelda Classic. Eventually I realized it would take 20 years to recreate a 20 year-old game engine, so I gave up.</p>
</blockquote>
<p>When creating a new save file, you can select the quest file to use from a file selector dialog. In order to support that on the web, I needed to populate an empty file for every quest file so that the user could at least select it from this dialog. To do that, I used a metadata file of the <a href="https://hoten.cc/quest-maker/play/quest-manifest.json" target="_blank" rel="noopener noreferrer">entire quest corpus</a> to seed the filesystem with empty files.</p>
<pre><code><span>// This function is called early on in main() setup.</span></code></pre>
<p><img src="https://commoncog.com/images/zc/filepicker.png" alt=""/>
  <span>The in-game file selector dialog. Quests are stored in their own folders such as: <code>_quests/1/OcarinaOfPower.qst</code>, requiring knowledge of where the quest you want is and multiple clicks to navigate to it</span>
</p>
<p>Just before Zelda Classic actually opens a file, <code>em_fetch_file_</code> is called and the data will be fetched and written to the filesystem.</p>
<pre><code><span>EM_ASYNC_JS</span><span>(</span><span>void</span><span>,</span> em_fetch_file_<span>,</span> <span>(</span><span>const</span> char <span>*</span>path<span>)</span><span>,</span> <span>{</span></code></pre>
<p>There are also a few quests that come with external music files (mp3, ogg). They can be added to this &#34;lazy&#34; filesystem too:</p>
<pre><code><span>for</span> <span>(</span><span>const</span> extraResourceUrl <span>of</span> quest<span>.</span>extraResources <span>||</span> <span>[</span><span>]</span><span>)</span> <span>{</span></code></pre>
<p>But this file selector dialog is <em>really awkward</em> to use. Let&#39;s leverage one of the web&#39;s superpowers here: the URL. I created a &#34;Quest List&#34; directory that presents a <code>Play!</code> link:</p>
<p><a href="https://hoten.cc/zc/play/?quest=731/GoGollab_1_FunnyEdition.qst" target="_blank" rel="noopener noreferrer">https://hoten.cc/zc/play/?quest=731/GoGollab_1_FunnyEdition.qst</a></p>
<p>and in Zelda Classic I grabbed that query parameter and hacked away at the title screen code to either 1) start a new save file with the quest or 2) load an existing save file of that quest. This makes it simpler than ever to jump into a Zelda Classic quest.</p>
<p>Zelda Classic&#39;s editor has a testing feature that allows a quest editor to jump into the game at the current screen they are editing. Natively, that&#39;s done with command line arguments, but to do the same for the web we have our friend the URL. Click this URL and you&#39;ll find yourself at the end of the game!</p>
<p><a href="https://hoten.cc/zc/play/?quest=bs3.1/NewBS+3.1+-+1st+Quest.qst&amp;dmap=9&amp;screen=58" target="_blank" rel="noopener noreferrer">https://hoten.cc/zc/play/?quest=bs3.1/NewBS+3.1+-+1st+Quest.qst&amp;dmap=9&amp;screen=58</a></p>
<p>You can also get a deep link to open a specific screen in the editor:</p>
<p><a href="https://hoten.cc/zc/create/?quest=bs3.1/NewBS+3.1+-+1st+Quest.qst&amp;map=0&amp;screen=55" target="_blank" rel="noopener noreferrer">https://hoten.cc/zc/create/?quest=bs3.1/NewBS+3.1+-+1st+Quest.qst&amp;map=0&amp;screen=55</a></p>
<h3 id="mp3s-and-oggs-and-retro-music" tabindex="-1">MP3s, and OGGs and retro music</h3>
<p>OK, so remember when I did all the fake <code>zcmusic</code> stuff, just to get things building and punt the prebuilt sound library stuff? Well, eventually I realized that SDL_mixer supports OGG and MP3 so it should be straight-forward to implement <code>zcmusic</code> using SDL_mixer. SDL_mixer and Emscripten have the know-how to synthesize these various audio formats, so I don&#39;t need to work out how to compile these audio libraries myself.</p>
<p>I should mention, Zelda Classic has two separate code paths for music: one is for MIDI, which I&#39;ve already discussed, and the other is <code>&#34;zcmusic&#34;</code> which is just a wrapper around various audio libraries to support OGG, MP3, and various retro video-game specific formats:</p>
<ul>
<li>gbs (GameBoy Sound)</li>
<li>nsf (NES Sound Format)</li>
<li>spc (SNES Sound)</li>
<li>vgm (<a href="https://en.wikipedia.org/wiki/VGM_(file_format)" target="_blank" rel="noopener noreferrer">Video Game Music</a>, a grab-bag of multiple game systems)</li>
</ul>
<p>So Emscripten + SDL_mixer handles everything but these retro formats. For that, Zelda Classic uses the <a href="https://bitbucket.org/mpyne/game-music-emu/src/master/" target="_blank" rel="noopener noreferrer">Game Music Emulator</a> (GME) library. Luckily I found a fork of SDL_mixer called <a href="https://github.com/WohlSoft/SDL-Mixer-X" target="_blank" rel="noopener noreferrer">SDL_mixer X</a> which integrates GME into SDL. It was pretty straightforward to grab that and merge the changes into the port that Emscriten uses. I also needed to add GME to Emscripten&#39;s port system, which was pretty <a href="https://gist.github.com/connorjclark/b9e0986c518d0193031c71181c8e2fd3" target="_blank" rel="noopener noreferrer">straightforward</a>.</p>
<blockquote>
<p>I sent SDL_mixer a <a href="https://github.com/libsdl-org/SDL_mixer/pull/378" target="_blank" rel="noopener noreferrer">PR</a> for adding GME. If that gets merged, I&#39;ll also add a <code>gme</code> option to Emscripten. But for now, I&#39;m just fine with my patching workflow.</p>
</blockquote>
<p>As for <code>zcmusic</code>, I just had to implement the small API surface using SDL_mixer directly. The native version of the library brings in format-specific audio handling libraries, so it&#39;s actually much simpler now because SDL_mixer handles all that format-specific logic.</p>
<h3 id="persisting-data" tabindex="-1">Persisting data</h3>
<p>By default, all data written to Emscripten&#39;s filesystem is only held in memory, and is lost when refreshing the page. Emscripten provides a simple interface to <a href="https://emscripten.org/docs/api_reference/Filesystem-API.html#filesystem-api-idbfs" target="_blank" rel="noopener noreferrer">mount a folder backed by IndexedDB</a>, which solves the problem of persistence, but many other issues still exist:</p>
<ol>
<li>Players of Zelda Classic have existing save files they may want to transfer into the browser</li>
<li>Players will want access to these files (either to make backups or share them), but browsers don&#39;t expose IndexedDB to non-technical users</li>
<li>Browsers avoid clearing data in IndexedDB if <code>navigator.storage.persist()</code> is called, but still: losing data such as save files (and especially a quest author&#39;s <code>.qst</code> file) is catastrophic, and I don&#39;t trust anything to live inside a browser forever</li>
</ol>
<p>Using the real filesystem would avoid all these issues. Luckily, there&#39;s been a lot of progress on this front in the last year: The <a href="https://web.dev/file-system-access/" target="_blank" rel="noopener noreferrer">Filesystem Access API</a> provides a way to prompt a user to share a folder with a page, even allowing the page to write back to it. Given <code>window.showDirectoryPicker()</code>, the browser opens a folder dialog prompt and the user&#39;s selection is given as a <code>FileSystemDirectoryHandle</code>.</p>
<blockquote>
<p>The only annoyance is that permission doesn&#39;t persist across multiple sessions, and even opening the permission prompt is (understandably) gated behind user interaction, so every subsequent visit I must show the user a permission flow. At the very least, the <code>FileSystemDirectoryHandle</code> can be cached in IndexedDB so the user doesn&#39;t need to specify which folder to use every time.</p>
</blockquote>
<p>Unfortunately only Chromium browsers have implemented <code>window.showDirectoryPicker()</code>; Firefox has no plans to implement, and Safari currently only supports a <a href="https://webkit.org/blog/12257/the-file-system-access-api-with-origin-private-file-system/" target="_blank" rel="noopener noreferrer">limited part of the API</a> called Origin Private Filesystem, which is not backed by real files on disk.</p>
<blockquote>
<p><a href="https://wicg.github.io/file-system-access/#sandboxed-filesystem" target="_blank" rel="noopener noreferrer">The Origin Private Filesystem</a> provides an origin-unique directory handle via <code>navigator.storage.getDirectory()</code>. The spec defines this folder to not necessarily map to real files on disk, so this is not viable for Zelda Classic</p>
</blockquote>
<p>Emscripten did not provide an interface for mounting a <code>FileSystemDirectoryHandle</code> to its own filesystem, so I wrote one myself. The existing IndexedDB interface is very similar to what I needed, and handles the logic of syncing deltas both ways rather nicely, so I based my interface on that. This seems like it&#39;d be really useful to others, so I sent a <a href="https://github.com/emscripten-core/emscripten/pull/16804" target="_blank" rel="noopener noreferrer">patch to Emscripten</a>.</p>
<p>While I&#39;m happy I can provide an ideal persistence story in Chromium, I still had to do something for other browsers. IndexedDB + <code>navigator.storage.persist()</code> isn&#39;t the worst thing in the world, but I needed to solve issues 1 and 2 above. To that end, a user can:</p>
<ol>
<li>download any individual file backed by IndexedDB</li>
<li>perform a one-way upload of a file or an entire folder into the browser (<a href="https://web.dev/browser-fs-access/" target="_blank" rel="noopener noreferrer"><code>browser-fs-access</code></a> helped here)</li>
</ol>
<h3 id="gamepads" tabindex="-1">Gamepads</h3>
<p>Zelda Classic is certainly playable with the keyboard, but it also supports gamepads. And so does the web and Emscripten! I was hopeful that things would &#34;just work&#34; here. I bought myself a nice Xbox controller to test things out and... nada. I noticed that the gamepad would only connect if I actively twiddled with its inputs while the page loaded. The bug could have been anywhere: Emscripten, my controller, SDL, Allegro, Allegro Legacy... so the first task was to narrow down a repro.</p>
<p>I wrote a quick <a href="https://gist.github.com/connorjclark/0b7268acd6bfa324c4db38dde7928110" target="_blank" rel="noopener noreferrer">SDL program</a> that prints when a joystick connects and disconnects. I compiled with Emscripten, loaded the page and it worked. So that just left Allegro/Allegro Legacy as the culprits. I did notice a difference between running when compiled for Mac vs for the web: On Mac, SDL detects a joystick immediately, but in the browser detection only happens after the first input on the controller. This is by design‚Äìthe purpose is to <a href="https://developer.mozilla.org/en-US/docs/Web/API/Gamepad_API/Using_the_Gamepad_API#:~:text=In%20Firefox%2C%20gamepads-,are%20only%20exposed,-to%20a%20page" target="_blank" rel="noopener noreferrer">avoid a potential vector for fingerprinting</a>.</p>
<p>So that was a big clue‚ÄìAllegro works only when twiddling the input at start up because it must be mishandling joysticks that are connected post-initialization. Pulling up <a href="https://github.com/liballeg/allegro5/blob/668a0a35afd4132dfeb86325d8f3e3c10628b529/src/sdl/sdl_joystick.c" target="_blank" rel="noopener noreferrer">Allegro&#39;s SDL interface for joysticks</a>, a variable <code>count</code> jumps out:</p>
<pre><code><span>void</span> <span>_al_sdl_joystick_event</span><span>(</span>SDL_Event <span>*</span>e<span>)</span></code></pre>
<p>For some unknown reason... all joystick events are ignored if there are no currently connected joysticks. The expectation in Allegro programs is to call  <code>al_reconfigure_joysticks</code> (which would call <code>sdl_init_joystick</code> again) when a joystick is added or removed to recreate the internal data structures, but a program never gets a chance to do so because Allegro&#39;s SDL joystick driver never forwards <code>SDL_JOYDEVICEADDED</code> events when no joysticks are present. <a href="https://github.com/liballeg/allegro5/pull/1326" target="_blank" rel="noopener noreferrer">The fix</a> was straightforward: remove that unnecessary <code>count</code> guard, and fix a use-after-free bug from very unexpected behavior (to me, a web developer) of <a href="https://en.cppreference.com/w/c/memory/calloc" target="_blank" rel="noopener noreferrer"><code>calloc</code></a> when <code>0</code> is given as input.</p>
<blockquote>
<p>I found an unfortunate bug in Firefox where my Xbox controller is <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1763931" target="_blank" rel="noopener noreferrer">improperly mapped</a>.</p>
</blockquote>
<p>After all that, connecting a gamepad was working. The default joystick button mappings happened to be OK too, but I wanted to improve the existing Zelda Classic settings menu for configuring the gamepad controls: currently it gave no indication of what button an action is mapped to, only providing a button number (not a name). I found that Allegro does support a joystick button name api, so I used it but that didn&#39;t help so much:</p>
<p><img src="https://commoncog.com/images/zc/buttons.png" alt=""/>
  <span>button button button button, button button, button ü¶¨</span>
</p>
<p>The problem was that Allegro&#39;s SDL joystick interface didn&#39;t know about SDL&#39;s API for getting a button name. <a href="https://github.com/liballeg/allegro5/pull/1327" target="_blank" rel="noopener noreferrer">The fix</a> was simple:</p>
<pre><code>diff --git a/src/sdl/sdl_joystick.c b/src/sdl/sdl_joystick.c</code></pre>
<blockquote>
<p>I was curious how SDL could determine what the button names are, given that the Gamepad Web API has nothing for &#34;give me the name of this button&#34;. Turns out, SDL uses the gamepad&#39;s device id (which the Web API does expose) to map known gamepads to a &#34;standard&#34; button layout. One such database can be found <a href="https://github.com/gabomdq/SDL_GameControllerDB/blob/master/gamecontrollerdb.txt" target="_blank" rel="noopener noreferrer">here</a> (but I think SDL ships with a much smaller set). These configurations are meant for standardizing rando gamepads to a sensible layout (such that the &#34;right-side bottom button&#34; has the same value to SDL independent of the gamepad hardware), but it also doubles as a button name store.</p>
</blockquote>
<h3 id="mobile-support" tabindex="-1">Mobile support</h3>
<p><img src="https://commoncog.com/images/zc/mobile.png" alt="" width="50%"/>
  <span>Very basic touch controls</span>
</p>
<p>I thought it&#39;d be cool to support mobile, but I didn&#39;t want to spend a lot of time on making touch controls feel good so the end result is a pretty subpar. The most tedious part was getting the browser <code>touch</code> events to work just-right. Actually fowarding them as events to Allegro was just a matter of exposing a C function to JavaScript that emitted a fake Allegro user event:</p>
<pre><code><span>bool</span> has_init_fake_key_events <span>=</span> <span>false</span><span>;</span></code></pre>
<p>Luckily Gamepads work just fine on mobile devices. Here&#39;s me playing with a wireless Xbox controller on my phone:</p>
<p><img src="https://commoncog.com/images/zc/gamepad.jpg" alt="" width="50%"/>
  <span>ü•îüì∑ (had to use my webcam)</span>
</p>
<h3 id="pwa" tabindex="-1">PWA</h3>
<p>I used the following <a href="https://developers.google.com/web/tools/workbox" target="_blank" rel="noopener noreferrer">Workbox</a> config to generate a service worker:</p>
<pre><code>module<span>.</span>exports <span>=</span> <span>{</span></code></pre>
<p>This gets me offline support, although notably there is no precaching: I chose to avoid precaching because there&#39;s ~6GB of quest data which is fetched only when needed, so the user will need to load a particular quest while online at least once for it to work offline. So I didn&#39;t see the point in precaching any part of the webapp.</p>
<p>With a service worker, and a <a href="https://hoten.cc/zc/manifest.json" target="_blank" rel="noopener noreferrer">manifest.json</a>, the webapp can be installed as a PWA. I listen for the <code>beforeinstallprompt</code> event to display my own install prompt:</p>
<pre><code><span>const</span> installEl <span>=</span> document<span>.</span><span>createElement</span><span>(</span><span>&#39;button&#39;</span><span>)</span><span>;</span></code></pre>
<p>In Chrome, when a PWA is installed the view transitions to the fullscreen, standalone version of the app. Unfortunately on Android, when installed there is no such transition, which makes for an awkward flow (the user can choose to close the browser tab and hunt down the newly installed app, or they can continue in the current browser tab and on subsequent visits use the app entry).</p>
<blockquote>
<p>Chrome 102 just landed, which introduces <a href="https://blog.chromium.org/2022/04/chrome-102-window-controls-overlay-host.html#:~:text=File%20Handlers%20Web%20App%20Manifest%20Member" target="_blank" rel="noopener noreferrer"><code>file_handlers</code></a>. Definitely something I&#39;ll eventually add to handle opening <code>.qst</code> files from the OS!</p>
</blockquote>
<h2 id="takeaways" tabindex="-1">Takeaways</h2>
<ul>
<li>As soon as you run into what seems like an intractable bug, stop trying to debug it from the context of your application and try to make a minimial reproduction. It will become easier to reason about the problem, and if the bug belongs to a dependency you will have a ready-made repro to provide in bug report.</li>
<li>File bug reports and upstream bug fixes when possible! But also, have <em>some way</em> to tweak your dependencies, be it with hard forks or a patching system. You can&#39;t allow a bug in a dependency that you know how to resolve stall progress.</li>
<li>Break down problems with unknown solutions. For example, my first attempt at porting Zelda Classic was over a year ago, and that failed miserably because I jumped right into the end task of &#34;actually port it&#34;, without first taking the time to really learn the tools involved, which resulted in me spinning my wheels. This time around, I avoided that by making my first task to fully understand how to port the simplest Allegro program.</li>
</ul>

</article>

  </div></div>
  </body>
</html>
