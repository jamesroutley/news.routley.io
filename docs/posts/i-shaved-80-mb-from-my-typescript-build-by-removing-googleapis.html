<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://effectivetypescript.com/2022/07/30/treemap-for-source-files/">Original</a>
    <h1>I shaved 80 MB from my TypeScript build by removing googleapis</h1>
    
    <div id="readability-page-1" class="page"><div>
            <p>What would you be most excited to see in the next set of TypeScript <a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/typescript/announcing-typescript-4-7/" onclick="return trackOutboundLink(&#39;whats typescript compiling use a treemap to find out&#39;, &#39;https://devblogs.microsoft.com/typescript/announcing-typescript-4-7/&#39;, event);">release notes</a>? Perhaps a fancy new language feature that makes generic types <a href="https://effectivetypescript.com/2020/11/05/template-literal-types/">more powerful</a>? A new way to do <a href="https://effectivetypescript.com/2020/12/04/gentips-1-curry/">type inference</a>? Or maybe a <a target="_blank" rel="noopener" href="https://github.com/microsoft/TypeScript/issues/29988" onclick="return trackOutboundLink(&#39;whats typescript compiling use a treemap to find out&#39;, &#39;https://github.com/microsoft/TypeScript/issues/29988&#39;, event);">new refactor</a> in the language service?</p>
<p>Now would you rather have that shiny new feature, or would you rather have TypeScript build your code 20% faster? In terms of your daily happiness and productivity, the speedup will almost certainly be the bigger win.</p>
<p>TypeScript performance is an important and sometimes frustrating part of the developer experience. Projects tend to start small and fast, but as they grow, type checking (<code>tsc</code>) and editor interactions (<code>tsserver</code>) get slower and TypeScript becomes less of a joy to use.</p>
<p>How can you make TypeScript run faster? Microsoft has a <a target="_blank" rel="noopener" href="https://github.com/microsoft/TypeScript/wiki/Performance" onclick="return trackOutboundLink(&#39;whats typescript compiling use a treemap to find out&#39;, &#39;https://github.com/microsoft/TypeScript/wiki/Performance&#39;, event);">guide</a> to TypeScript performance, and that&#39;s a great place to start. This post will talk about one particularly easy and effective way to debug performance issues: looking at what TypeScript is compiling using a treemap visualization.</p>
<p>Before we get started, let&#39;s be clear what we mean by performance. This is <em>not</em> the runtime performance of your code. For the most part, TypeScript is compiled to JavaScript by stripping out all the type annotations. So it cannot affect the runtime performance of your code. (If you see claims that TS affects runtime performance, for example this <a target="_blank" rel="noopener" href="https://hackaday.com/2021/11/18/c-is-the-greenest-programming-language/" onclick="return trackOutboundLink(&#39;whats typescript compiling use a treemap to find out&#39;, &#39;https://hackaday.com/2021/11/18/c-is-the-greenest-programming-language/&#39;, event);">notoriously shoddy</a> paper, be very skeptical!) When I say &#34;performance&#34;, I mean compiler performance and language service performance: How long does it take <code>tsc</code> to compile your code and report type errors? And how long does it take after you edit a source file for errors to appear and disapper in your editor? These affect developer experience (DX) directly, but not user experience (UX).</p>
<p>One of the best ways to be fast is to do less stuff. In the case of TypeScript, that means compiling fewer lines of code.</p>
<p>The <code>tsc</code> command has a handy <code>--listFiles</code> option that will show you exactly what it&#39;s looking at when it compiles your code:</p>
<figure><div><pre><code>$ tsc --listFiles</code></pre></div></figure>

<p>If TypeScript has gotten sluggish on your project, then you should look at this list! There might be source files that surprise you.</p>
<p>For a large project, this list can include thousands of source files, so you&#39;ll want some way to visualize it. My preferred approach is a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Treemapping" onclick="return trackOutboundLink(&#39;whats typescript compiling use a treemap to find out&#39;, &#39;https://en.wikipedia.org/wiki/Treemapping&#39;, event);">treemap</a>, which you can quickly generate using the <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/webtreemap-cli" onclick="return trackOutboundLink(&#39;whats typescript compiling use a treemap to find out&#39;, &#39;https://www.npmjs.com/package/webtreemap-cli&#39;, event);">webtreemap-cli</a> package. Since <code>tsc</code> will spend more time on a large file than a small file, we&#39;ll want to visualize the number of bytes in each file being compiled.</p>
<p>Here&#39;s the magic incantation (see <a target="_blank" rel="noopener" href="https://unix.stackexchange.com/a/22227/139786" onclick="return trackOutboundLink(&#39;whats typescript compiling use a treemap to find out&#39;, &#39;https://unix.stackexchange.com/a/22227/139786&#39;, event);">here</a> for the &#34;stat&#34; syntax):</p>
<pre><code># macOS / BSD
tsc --noEmit --listFiles | xargs stat -f &#34;%z %N&#34; | npx webtreemap-cli

# Linux:
tsc --noEmit --listFiles | xargs stat -c &#34;%s %n&#34; | npx webtreemap-cli</code></pre><p>For my project, here&#39;s what that looks like:</p>
<p><img src="https://effectivetypescript.com/images/googleapis-treemap.png" alt="Treemap visualization showing googleapis contribution 80MB of source"/></p><p>First off: that&#39;s a <em>lot</em> of code! Over 111 megabytes. With that much source to churn through, it&#39;s no wonder TypeScript has gotten sluggish.</p>
<p>Second: my project is mostly <code>googleapis</code>? That&#39;s surprising. We do use the Google Cloud Storage API and the Google Sheets API, but that&#39;s it. And yet <code>tsc</code> reports that it&#39;s pulling in 80+ MB of Google APIs, including multiple versions of APIs that I never use (e.g. compute alpha, beta, v1).</p>
<p>This is exactly the sort of insight that treemaps are good at producing! Before I saw that visualization, I hadn&#39;t thought much about my project&#39;s usage of <code>googleapis</code>. Now I can&#39;t think about anything else!</p>
<p>The root issue here is that Google distributes all 300+ of its APIs as a single npm package. This has been a <a target="_blank" rel="noopener" href="https://github.com/googleapis/google-api-nodejs-client/issues/806" onclick="return trackOutboundLink(&#39;whats typescript compiling use a treemap to find out&#39;, &#39;https://github.com/googleapis/google-api-nodejs-client/issues/806&#39;, event);">long-standing issue</a> with Google&#39;s Node.js APIs. Fortunately for us, the issue was <a target="_blank" rel="noopener" href="https://github.com/googleapis/google-api-nodejs-client/pull/2557" onclick="return trackOutboundLink(&#39;whats typescript compiling use a treemap to find out&#39;, &#39;https://github.com/googleapis/google-api-nodejs-client/pull/2557&#39;, event);">recently fixed</a>! Google now publishes individual packages for each API. Instead of depending on all of <code>googleapis</code>, you can now depend on just <code>@googleapis/sheets</code>.</p>
<p>After this change, the treemap for my project looks substantially different:</p>
<p><img src="https://effectivetypescript.com/images/treemap-after.png" alt="Treemap showing many fewer googleapis"/></p><p>The most important change is the top-line number: there&#39;s 80MB (70%) less source code for <code>tsc</code> to churn through. It&#39;s interesting to note that many of the large blocks that remain (<code>@octokit</code>, <code>csstype</code>, <code>firestore</code>) have the same problem as <code>googleapis</code>, if less egregiously so: they ship a single giant source file containing every API you could ever depend on.</p>
<p>Now for the big question… did this make my build faster? At least in this case, the answer is a clear &#34;yes&#34;. I ran:</p>
<pre><code>time tsc --noEmit --incremental=false</code></pre><p>five times before and after my change. The average time went from 35.7s → 28.9s, a 20% speedup. Not bad! And while it&#39;s harder to measure language service (<code>tsserver</code>) performance, one hopes that this change will help there, too. It&#39;s notable that the 20% speedup doesn&#39;t match the 70% reduction in source code. Just reading all those unused type declarations doesn&#39;t take as much time as type checking the code that is used. Still, this is a nice win.</p>
<p>Try running the magic command to visualize your TypeScript code as a treemap. You might be surprised what&#39;s making it into your build!</p>
<pre><code>tsc --noEmit --listFiles | xargs stat -f &#34;%z %N&#34; | npx webtreemap-cli</code></pre><p>In a future post, we&#39;ll look at strategies for reducing how much code you have to import, both as a library author and a consumer.</p>

          </div></div>
  </body>
</html>
