<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://aigarius.com/blog/2022/10/16/ryzen-7000-amdgpu/">Original</a>
    <h1>Ryzen 7000 amdgpu boot hang</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody text">
    <div>
<p>So you decided to build a brand new system using all the latest and coolest tech, so you buy a Ryzen 7000 series
Zen 4 CPU, like the Ryzen 7700X that I picked, with a new mother board and DDR5 memory and all that jazz. But for
now, you don&#39;t yet have a fitting GPU for that system (as the new ones will only come out in November), so you are
booting a Debian system using the new build-in video card of the new CPUs (Zen 4 generation has a simple AMD GPU
build-in into every CPU now - great stuff for debugging and mostly-headless systems) and you get ... nothing on 
the screen. Hmm. You boot into the rescue mode and the kernel message stop after:</p>
<pre><span>Oct</span> <span>16</span> <span>13</span>:<span>31</span>:<span>25</span> <span>home</span> <span>kernel</span>: [    <span>4</span>.<span>128328</span>] <span>amdgpu</span>: <span>Ignoring</span> <span>ACPI</span> <span>CRAT</span> <span>on</span> <span>non</span><span>-</span><span>APU</span> <span>system</span>
<span>Oct</span> <span>16</span> <span>13</span>:<span>31</span>:<span>25</span> <span>home</span> <span>kernel</span>: [    <span>4</span>.<span>128329</span>] <span>amdgpu</span>: <span>Virtual</span> <span>CRAT</span> <span>table</span> <span>created</span> <span>for</span> <span>CPU</span>
<span>Oct</span> <span>16</span> <span>13</span>:<span>31</span>:<span>25</span> <span>home</span> <span>kernel</span>: [    <span>4</span>.<span>128332</span>] <span>amdgpu</span>: <span>Topology</span>: <span>Add</span> <span>CPU</span> <span>node</span>
</pre>
<p>That looks bad, right?</p>
<p>Well, if you either ssh into the machine or reboot with <code>module_blacklist=amdgpu</code> in the kernel command line you will 
find in <code>/var/log/kern.log.1</code> those messages and also the following messages that will clarify the situation a bit:</p>
<pre><span>Oct</span><span> </span><span>16</span><span> </span><span>13</span><span>:</span><span>31</span><span>:</span><span>25</span><span> </span><span>home</span><span> </span><span>kernel</span><span>:</span><span> </span><span>[</span><span>    4.129352</span><span>]</span><span> </span><span>amdgpu</span><span> </span><span>0000</span><span>:</span><span>10</span><span>:</span><span>00.0</span><span>:</span><span> </span><span>firmware</span><span>:</span><span> </span><span>failed</span><span> </span><span>to</span><span> </span><span>load</span><span> </span><span>amdgpu</span><span>/</span><span>psp_13_0_5_toc</span><span>.</span><span>bin</span><span> </span><span>(</span><span>-</span><span>2</span><span>)</span><span></span>
<span>Oct</span><span> </span><span>16</span><span> </span><span>13</span><span>:</span><span>31</span><span>:</span><span>25</span><span> </span><span>home</span><span> </span><span>kernel</span><span>:</span><span> </span><span>[</span><span>    4.129354</span><span>]</span><span> </span><span>firmware_class</span><span>:</span><span> </span><span>See</span><span> </span><span>https</span><span>:</span><span>//</span><span>wiki</span><span>.</span><span>debian</span><span>.</span><span>org</span><span>/</span><span>Firmware</span><span> </span><span>for</span><span> </span><span>information</span><span> </span><span>about</span><span> </span><span>missing</span><span> </span><span>firmware</span><span></span>
<span>Oct</span><span> </span><span>16</span><span> </span><span>13</span><span>:</span><span>31</span><span>:</span><span>25</span><span> </span><span>home</span><span> </span><span>kernel</span><span>:</span><span> </span><span>[</span><span>    4.129358</span><span>]</span><span> </span><span>amdgpu</span><span> </span><span>0000</span><span>:</span><span>10</span><span>:</span><span>00.0</span><span>:</span><span> </span><span>firmware</span><span>:</span><span> </span><span>failed</span><span> </span><span>to</span><span> </span><span>load</span><span> </span><span>amdgpu</span><span>/</span><span>psp_13_0_5_toc</span><span>.</span><span>bin</span><span> </span><span>(</span><span>-</span><span>2</span><span>)</span><span></span>
<span>Oct</span><span> </span><span>16</span><span> </span><span>13</span><span>:</span><span>31</span><span>:</span><span>25</span><span> </span><span>home</span><span> </span><span>kernel</span><span>:</span><span> </span><span>[</span><span>    4.129359</span><span>]</span><span> </span><span>amdgpu</span><span> </span><span>0000</span><span>:</span><span>10</span><span>:</span><span>00.0</span><span>:</span><span> </span><span>Direct</span><span> </span><span>firmware</span><span> </span><span>load</span><span> </span><span>for</span><span> </span><span>amdgpu</span><span>/</span><span>psp_13_0_5_toc</span><span>.</span><span>bin</span><span> </span><span>failed</span><span> </span><span>with</span><span> </span><span>error</span><span> </span><span>-</span><span>2</span><span></span>
<span>Oct</span><span> </span><span>16</span><span> </span><span>13</span><span>:</span><span>31</span><span>:</span><span>25</span><span> </span><span>home</span><span> </span><span>kernel</span><span>:</span><span> </span><span>[</span><span>    4.129360</span><span>]</span><span> </span><span>amdgpu</span><span> </span><span>0000</span><span>:</span><span>10</span><span>:</span><span>00.0</span><span>:</span><span> </span><span>amdgpu</span><span>:</span><span> </span><span>fail</span><span> </span><span>to</span><span> </span><span>request</span><span>/</span><span>validate</span><span> </span><span>toc</span><span> </span><span>microcode</span><span></span>
<span>Oct</span><span> </span><span>16</span><span> </span><span>13</span><span>:</span><span>31</span><span>:</span><span>25</span><span> </span><span>home</span><span> </span><span>kernel</span><span>:</span><span> </span><span>[</span><span>    4.129361</span><span>]</span><span> </span><span>[</span><span>drm:psp_sw_init [amdgpu</span><span>]</span><span>]</span><span> </span><span>*</span><span>ERROR</span><span>*</span><span> </span><span>Failed</span><span> </span><span>to</span><span> </span><span>load</span><span> </span><span>psp</span><span> </span><span>firmware</span><span>!</span><span></span>
<span>Oct</span><span> </span><span>16</span><span> </span><span>13</span><span>:</span><span>31</span><span>:</span><span>25</span><span> </span><span>home</span><span> </span><span>kernel</span><span>:</span><span> </span><span>[</span><span>    4.129432</span><span>]</span><span> </span><span>[</span><span>drm:amdgpu_device_init.cold [amdgpu</span><span>]</span><span>]</span><span> </span><span>*</span><span>ERROR</span><span>*</span><span> </span><span>sw_init</span><span> </span><span>of</span><span> </span><span>IP</span><span> </span><span>block</span><span> </span><span>&lt;</span><span>psp</span><span>&gt;</span><span> </span><span>failed</span><span> </span><span>-</span><span>2</span><span></span>
<span>Oct</span><span> </span><span>16</span><span> </span><span>13</span><span>:</span><span>31</span><span>:</span><span>25</span><span> </span><span>home</span><span> </span><span>kernel</span><span>:</span><span> </span><span>[</span><span>    4.129525</span><span>]</span><span> </span><span>amdgpu</span><span> </span><span>0000</span><span>:</span><span>10</span><span>:</span><span>00.0</span><span>:</span><span> </span><span>amdgpu</span><span>:</span><span> </span><span>amdgpu_device_ip_init</span><span> </span><span>failed</span><span></span>
<span>Oct</span><span> </span><span>16</span><span> </span><span>13</span><span>:</span><span>31</span><span>:</span><span>25</span><span> </span><span>home</span><span> </span><span>kernel</span><span>:</span><span> </span><span>[</span><span>    4.129526</span><span>]</span><span> </span><span>amdgpu</span><span> </span><span>0000</span><span>:</span><span>10</span><span>:</span><span>00.0</span><span>:</span><span> </span><span>amdgpu</span><span>:</span><span> </span><span>Fatal</span><span> </span><span>error</span><span> </span><span>during</span><span> </span><span>GPU</span><span> </span><span>init</span><span></span>
<span>Oct</span><span> </span><span>16</span><span> </span><span>13</span><span>:</span><span>31</span><span>:</span><span>25</span><span> </span><span>home</span><span> </span><span>kernel</span><span>:</span><span> </span><span>[</span><span>    4.129527</span><span>]</span><span> </span><span>amdgpu</span><span> </span><span>0000</span><span>:</span><span>10</span><span>:</span><span>00.0</span><span>:</span><span> </span><span>amdgpu</span><span>:</span><span> </span><span>amdgpu</span><span>:</span><span> </span><span>finishing</span><span> </span><span>device</span><span>.</span><span></span>
<span>Oct</span><span> </span><span>16</span><span> </span><span>13</span><span>:</span><span>31</span><span>:</span><span>25</span><span> </span><span>home</span><span> </span><span>kernel</span><span>:</span><span> </span><span>[</span><span>    4.129633</span><span>]</span><span> </span><span>amdgpu</span><span>:</span><span> </span><span>probe</span><span> </span><span>of</span><span> </span><span>0000</span><span>:</span><span>10</span><span>:</span><span>00.0</span><span> </span><span>failed</span><span> </span><span>with</span><span> </span><span>error</span><span> </span><span>-</span><span>2</span><span></span>
</pre>
<p>So what you need is to get a new set of <a href="https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git">Linux Kernel Firmware blobs</a> and upack that in <code>/lib/firmware</code>. 
The tarball from 2022-10-12 worked well for me.</p>
<p>After that you also need to re-create the initramfs with <code>update-initramfs -k all -c</code> to include the new firmware. 
Having kernel version 5.18 or newer is also required for stable Zen 4 support. It might be that a fresh Mesa version
is also of importance, but as I am running sid on this machine I can only say that Mesa 22.2.1 that is in sid works fine.</p>
</div>
    </div></div>
  </body>
</html>
