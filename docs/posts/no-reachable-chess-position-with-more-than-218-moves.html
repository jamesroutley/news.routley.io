<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lichess.org/@/Tobs40/blog/there-is-no-reachable-chess-position-with-more-than-218-moves/a5xdxeqs">Original</a>
    <h1>No reachable chess position with more than 218 moves</h1>
    
    <div id="readability-page-1" class="page"><p>Created by the author using GIMP and freely available images.</p><p><strong>Stop searching, we had it right for 60 years.</strong></p><div><p>Ever since <a href="https://de.wikipedia.org/wiki/Nenad_Petrovi%C4%87">Nenad Petrović</a>, grandmaster of chess composition, published his 218 move composition in 1964, people have tried to come up with a better one. I joined the hunt in May 2024 and, being a computer scientist, I decided to settle this question once and for all, using computers. You can give it a try yourself. Try to find a position with more moves than the one below.</p>
<p><strong>Spoiler</strong>: You won&#39;t.</p>
<p><img src="https://image.lichess1.org/display?h=0&amp;op=resize&amp;path=tobs40:ublogBody:RmcRmpJOEzQR:rIwLr8BO.png&amp;w=800&amp;sig=003f79dea9024998ea4db46c4c764ae26cec4efb" alt="image.png"/></p>
<p>...but how can we know for sure?</p>
<p>By checking all <a href="https://github.com/tromp/ChessPositionRanking">~4.8x10^44</a> reachable chess positions?</p>
<p>That&#39;s half a billion billion billion billion billion and it&#39;s enough to scare even the mightiest of supercomputers. In fact, cracking AES-128 encryption would be easier.</p>
<p>Fortunately, we can use the power of Math!</p>
<p>Follow me along and perhaps you can compute yourself a world record afterwards :)</p>
<h2><a href="#using-the-power-of-math" id="using-the-power-of-math"></a>Using the power of Math</h2>
<p><img src="https://image.lichess1.org/display?h=0&amp;op=resize&amp;path=tobs40:ublogBody:AZJCGj9etF4L:wQdEg0Vn.png&amp;w=800&amp;sig=05a7ba2531a44db54a10d356bdf45846175b6f5f" alt="image.png"/></p>
<p>We&#39;re gonna tackle this problem from the white side, i.e., it is White to move. Except for rare exceptions regarding the reachability of positions, this is equivalent.</p>
<p>Since proving that a position is reachable is complicated, we&#39;re gonna search through all ways of placing pieces on the board and filter out the non-reachable ones later on, if needed.</p>
<p>Obviously, 99.9% of the positions suck at having lots of moves, they are not even close to 218. We just need a way to skip them and pray that there exists enough electricity to check the rest.</p>
<p>Let&#39;s begin with a couple <strong>of</strong> useful observations.</p>
<h4><a href="#useless-pieces" id="useless-pieces"></a>Useless pieces</h4>
<p>A black piece does not improve the number of moves, most of the time. Its existence only benefits the number of moves if it increases White&#39;s number of moves, i.e., at least one of the following is true:</p>
<ul>
<li>It can be taken by a white pawn, giving said pawn more moves</li>
<li>It protects the black king from check, making an otherwise illegal position with lots of moves legal</li>
<li>It frees a white piece from being pinned to the white king, thus giving it more moves</li>
</ul>
<p>Otherwise, it is useless, at best, and thus can be removed.</p>
<p><img src="https://image.lichess1.org/display?h=0&amp;op=resize&amp;path=tobs40:ublogBody:WasmQmLOrBL6:ULIsaqYx.png&amp;w=800&amp;sig=4156d91f382695716b3739afbac196155f423aad" alt="image.png"/></p>
<h4><a href="#too-powerful-pieces" id="too-powerful-pieces"></a>Too powerful pieces</h4>
<p>Next, we observe that, if piece counts permit, we can always replace a black piece, with the exception of the black king, with a strictly less powerful one. That is, a piece that has a subset of the moves of the original piece. For example, a queen with a pawn/bishop/rook or a bishop with a pawn. Except if a pawn is on the seventh rank, since in that case, each of its moves <strong>to the promotion square</strong> counts as 4 separata moves. The only way for Black&#39;s moves to affect White&#39;s number of moves is by pinning White&#39;s pieces or preventing the white king from stepping on a certain square. Both of these things can&#39;t get worse if the black piece has less moves than before.</p>
<h4><a href="#too-weak-pieces" id="too-weak-pieces"></a>Too weak pieces?</h4>
<p>The other way around, it is not so easy, however. You&#39;d think that you can just replace white rooks and white bishops with white queens if counts permit, but the problem is this: How do you ensure that you cannot capture the black king, making the position illegal? Maybe the optimal solution has a rook instead of a queen to avoid just that?</p>
<p>Well, you might say &#34;Let&#39;s just place a black piece in between then&#34;.</p>
<p><img src="https://image.lichess1.org/display?h=0&amp;op=resize&amp;path=tobs40:ublogBody:siS3rUkB5pwZ:DCkdccwl.png&amp;w=800&amp;sig=0976813b03991d42ecf4a80d300aaf2bc111cb02" alt="Untitled.png"/></p>
<p>And you would be wrong unless you can tell me why you haven&#39;t just blocked some other white piece and thus reduced the number of moves in total. Or what your plan is, if there is no space to put something in between. You just made the position illegal, duh!</p>
<h4><a href="#no-checks-thank-you" id="no-checks-thank-you"></a>No checks, thank you</h4>
<p>Finally, we can get rid of checks. If the black king is in check, it means that the position is illegal, since it is White&#39;s turn to move and they could just capture the black king. Not okay! So that can&#39;t be it. On the other hand, if the white king is in check, then the number of White&#39;s moves is severely restricted and we can easily prove that we cannot reach 218 moves. There are three ways to get out of check:</p>
<ul>
<li>Move the king</li>
<li>Capture the attacker</li>
<li>Block the attack</li>
</ul>
<p>Moving the king gives 8 moves at best. Since any square can be reached by at most 16 pieces at the same time (8 knights and 8 other pieces straight or diagonally), capturing gives 16 moves at best. We can have at most 6 squares to block an attack, so that&#39;s an additional 6 x 16 = 96 moves. So at best 8+16+96 = 120 moves, far less than 218, and thus we do not need to consider positions in which either king is in check.</p>
<p>So is this it Tobi? Can we now call NASA and ask for their supercomputer?</p>
<p>Nope, it&#39;s still absolutely hopeless, there are waaaaay too many positions left.</p>
<h2><a href="#introducing-chess-with-cheating-partial-pieces-and-moves" id="introducing-chess-with-cheating-partial-pieces-and-moves"></a>Introducing Chess with Cheating: Partial Pieces and Moves</h2>
<p><img src="https://image.lichess1.org/display?h=0&amp;op=resize&amp;path=tobs40:ublogBody:mZvNWBPGH05p:UggWM1vO.png&amp;w=800&amp;sig=07c189e3deb15f59cf05794ae1041d3aa89ac872" alt="image.png"/></p>
<p>While searching through all possible piece configurations, we would ideally like to have some provably correct way of telling whether we can still reach 218 moves, so we can stop trying and save ourselves an astronomically large amount of work. The better the method is, the more work we save. But it also needs to be fast, since we need to run it millions and billions of times.</p>
<p>A common technique in optimization is to allow fractional decisions. Instead of a piece being either on e4 or not, it can be 27.3% there and 72.7% not there. This enables us to just &#34;swim&#34; through the solution space towards the optimal solution instead of trying all combinations. The drawback is that we usually end up with a way too good solution with most decisions being fractional. But if that doesn&#39;t get us beyond 218 moves, we know we can stop trying.</p>
<p>Obviously, these kinds of algorithms are already implemented in state-of-the-art solvers like Gurobi, so all we need to do is model our problem to its likings (as a so-called integer programming problem), tell it to maximize the number of moves and pray. Finally, after ~55 000 seconds, it crashed.</p>
<h4><a href="#checking-more-positions-to-make-things-less-slow" id="checking-more-positions-to-make-things-less-slow"></a>Checking more positions to make things less slow</h4>
<p>To reduce the size of the model, I bent some chess rules, simplifying the search space:</p>
<ul>
<li>I allowed castling if king and rook were on the right squares, not requiring anything else</li>
<li>I stopped caring about pieces moving despite being pinned</li>
<li>I stopped caring whether the white king is in check or walks into check</li>
<li>I allowed white pawns to always capture when standing on the fifth rank so I&#39;d not have to check en passant.</li>
</ul>
<p>All of these things are unlikely to happen in 218+ move positions and after a solution has been found, I can still check and discard it if it has less moves than it claims to have.</p>
<p>I started again and this time, memory wasn&#39;t a problem, but the progress was awfully slow with ~29 days remaining. The world could not wait this long and neither could I. I pressed cancel.</p>
<h4><a href="#preventing-white-magic" id="preventing-white-magic"></a>Preventing white magic</h4>
<p><img src="https://image.lichess1.org/display?h=0&amp;op=resize&amp;path=tobs40:ublogBody:iShBvrU9VQCw:ArUe8Px1.png&amp;w=800&amp;sig=c35b91d1fcfcf2956ddf3aa013c8b34a03026e49" alt="image.png"/></p>
<p>Our current way of cheating is too different from reality, causing the solver to have to search through way too many board configurations. In our case, the optimal solution to the easy problem flooded the center with half queens and half knights sharing the same squares, having half pieces move through other half pieces with half moves. Gurobi thinks that the above position has 305 moves in total, which is far away from 218 and a bad upper bound.</p>
<p>In order to cut off this crazy solution, I added a &#34;redundant&#34; constraint, saying that at most one piece in total can move from one direction onto a particular square. Which got us a new hallucination...</p>
<p><img src="https://image.lichess1.org/display?h=0&amp;op=resize&amp;path=tobs40:ublogBody:OmGeWp49e01E:kNej345t.png&amp;w=800&amp;sig=ac767d5042739c64da4dd768503de05253fb3043" alt="image.png"/></p>
<p>Now we have 271 2/3 moves, which is much better. It&#39;s a bit like having to try all passwords with 53 characters vs. all passwords with 87 characters, the latter being many magnitudes harder.</p>
<p>Wait a minute, White can&#39;t have 4 kings.</p>
<p>White does not have four kings. White has 3 times 24.6% kings and one 26.2% king. Also, the queen on g3 barely exists, it&#39;s 0.8% but apparently it somehow contributes to the total sum of moves :)</p>
<p>With this improved model, I tried again and after ~23 000 seconds, Gurobi solved it to optimality!</p>
<h2><a href="#results" id="results"></a>Results</h2>
<p>Sadly, instead of finding me a fancy position with 219 moves and making my name immortal, Gurobi gave me the following 12 representative positions (of 40,000 in total) with 218 moves each:</p>
<p><img src="https://image.lichess1.org/display?h=0&amp;op=resize&amp;path=tobs40:ublogBody:M7Cw0smh4jQ9:DNPmvada.png&amp;w=800&amp;sig=95ebffed9f88146a5632c919b55f27654667793c" alt="image.png"/></p>
<p>All 12 positions seem trivially reachable. I only constructed a proof game for one of the positions, since that is sufficient for proving our claim. If you don&#39;t believe that this is possible, keep in mind that White&#39;s last or second last move might have been a capture. Or click on the link :)</p>
<p>Sadly not a world record, but at least we now know for certain that 218 is the limit.</p>
<p>And you smart chess move 3.7 bit compression people and chess engine developers, you can finally stop worrying. 256 moves will be enough. You&#39;re welcome :-)</p>
<p>Except if you allow non-reachable positions, in which case you might want to read on :P</p>
<h2><a href="#other-stuff-solved-along-the-way" id="other-stuff-solved-along-the-way"></a>Other stuff solved along the way</h2>
<p>I also confirmed the optimality of the 144 move record without promotions. Since Gurobi did not find any position with more than 144 moves, that means that there also is no reachable position with more than 144 moves. Hence, 144 moves is the best we can do and &#34;Jenő Bán&#34;, a chess composer from Hungary, found one in 1960 already:</p>
<p><img src="https://image.lichess1.org/display?h=0&amp;op=resize&amp;path=tobs40:ublogBody:pa72BRyqBqjr:OdXsn3pg.png&amp;w=800&amp;sig=e3af55f6ed060b75e69e4abe96137a36227315c" alt="image.png"/></p>
<p>Also, I confirmed the optimality of the following illegal position, which has 288 moves for White.</p>
<p><img src="https://image.lichess1.org/display?h=0&amp;op=resize&amp;path=tobs40:ublogBody:2lRWfWA2zNcC:vfeNowSo.png&amp;w=800&amp;sig=db69bc7ef724e8eb3bca5581f6e7ba980eebcb13" alt="image.png"/></p>
<p>Now have a guess at what the best non-reachable legal position looks like ;)</p>
<p><img src="https://image.lichess1.org/display?h=0&amp;op=resize&amp;path=tobs40:ublogBody:D3fh622moE3N:zMvHxcKQ.png&amp;w=800&amp;sig=9509e500782247e9ce8499588941f25c6f268c95" alt="image.png"/></p>
<h2><a href="#future-plans" id="future-plans"></a>Future plans</h2>
<p>My code snippet is freely available at <a href="https://github.com/Tobs40/chess218">Github</a>. If you manage to do something cool based on it, please let the world know :)</p>
<p>Fun problems enthusiasts could try to tackle next using similar techniques:</p>
<ul>
<li>Most captures</li>
<li>Most stalemates</li>
<li>Most checks</li>
<li>Most checkmates</li>
<li>Most mates in two</li>
<li>...</li>
<li>Most ... under &lt;condition&gt;</li>
</ul>
<p>Some of these might be hard, extremely hard or practically impossible to solve with current technology. I don&#39;t think that integer linear programming is a suitable approach for all of them, one likely has to develop a custom algorithm for computing good upper bounds, based on creative mathematical insights.</p>
<p>Good luck to those who dare to try solving one of these ^^</p>
<p><img src="https://image.lichess1.org/display?fmt=png&amp;h=0&amp;op=resize&amp;path=ublogBody:Bfk358pYOCZw:nElJr2rj.png&amp;w=800&amp;sig=873b091c67b8b8ad17652c34b9640b24e0e5d777" alt="image.png"/></p>
<h2><a href="#faq-based-on-questions-on-lichess-and-hackernews" id="faq-based-on-questions-on-lichess-and-hackernews"></a>FAQ (based on questions on Lichess and HackerNews)</h2>
<p><strong>A chess game can be longer than 218 move, duh</strong></p>
<p><strong>I don&#39;t get what you are doing, this is magic to me, can you explain it simply?</strong></p>
<p>Each letter represents a decision, such as, whether there is a queen on h5 or not, whether the piece on h5 can move to g3 or not, ...</p>
<p>The magic oracle thing is a bit heavier to explain, for that I&#39;d recommend reading the article slowly and asking ChatGPT etc. interactively :)</p>
<p><strong>Can I look at your code?</strong></p>
<h2><a href="#feedback-hall-of-fame" id="feedback-hall-of-fame"></a>Feedback Hall of Fame</h2>
<p><a href="https://lichess.org/@/tromp1234">@tromp1234</a>: For pointing to a better estimate for the number of legal chess positions and pointing out that my source is off by around one magnitude.</p>
</div></div>
  </body>
</html>
