<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://neon.tech/blog/http-vs-websockets-for-postgres-queries-at-the-edge">Original</a>
    <h1>HTTP vs. WebSockets: Which one is the fastest for Postgres queries at the Edge</h1>
    
    <div id="readability-page-1" class="page"><div>
<p><img alt="Post image" fetchpriority="high" width="1024" height="576" decoding="async" data-nimg="1" sizes="(max-width: 767px) 100vw" srcset="/_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-17.png&amp;w=640&amp;q=85 640w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-17.png&amp;w=750&amp;q=85 750w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-17.png&amp;w=828&amp;q=85 828w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-17.png&amp;w=1080&amp;q=85 1080w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-17.png&amp;w=1200&amp;q=85 1200w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-17.png&amp;w=1920&amp;q=85 1920w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-17.png&amp;w=2048&amp;q=85 2048w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-17.png&amp;w=3840&amp;q=85 3840w" src="https://neon.tech/_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-17.png&amp;w=3840&amp;q=85"/></p><p>Faster is always better, especially when executing SQL queries. </p>



<p>We recently introduced SQL-over-HTTP to our driver, which previously only supported WebSockets. Why did we do that? And which approach is faster?</p>



<p><img alt="Post image" loading="lazy" width="841" height="444" decoding="async" data-nimg="1" sizes="(max-width: 767px) 100vw" srcset="/_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-23.png&amp;w=640&amp;q=85 640w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-23.png&amp;w=750&amp;q=85 750w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-23.png&amp;w=828&amp;q=85 828w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-23.png&amp;w=1080&amp;q=85 1080w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-23.png&amp;w=1200&amp;q=85 1200w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-23.png&amp;w=1920&amp;q=85 1920w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-23.png&amp;w=2048&amp;q=85 2048w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-23.png&amp;w=3840&amp;q=85 3840w" src="https://neon.tech/_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-23.png&amp;w=3840&amp;q=85"/></p><h2>Our journey developing the WebSockets serverless driver</h2>



<p>We first developed the Neon driver to help developers query their Postgres databases closer to their end-users. The basic premise is simple: Our driver connects from the Edge Function to our proxy over a WebSocket, telling the proxy which database host and port it wants to reach.</p>



<p><img alt="Post image" loading="lazy" width="975" height="512" decoding="async" data-nimg="1" sizes="(max-width: 767px) 100vw" srcset="/_next/image?url=https%3A%2F%2Flh3.googleusercontent.com%2FqmDpWfgMXmVnoc8Fw21auem6n-U8p5EUxTSOHnEYwEr3x4BVaK8LMgDhuf5yIdbWjD7PWnxmzaO54mdWqeu7C5tGbxNtxGi2sxwRuxqXhkc2bPRrI3IYloANedot3a7UPk55lGMt8uEtqtXww9aaZj8&amp;w=640&amp;q=85 640w, /_next/image?url=https%3A%2F%2Flh3.googleusercontent.com%2FqmDpWfgMXmVnoc8Fw21auem6n-U8p5EUxTSOHnEYwEr3x4BVaK8LMgDhuf5yIdbWjD7PWnxmzaO54mdWqeu7C5tGbxNtxGi2sxwRuxqXhkc2bPRrI3IYloANedot3a7UPk55lGMt8uEtqtXww9aaZj8&amp;w=750&amp;q=85 750w, /_next/image?url=https%3A%2F%2Flh3.googleusercontent.com%2FqmDpWfgMXmVnoc8Fw21auem6n-U8p5EUxTSOHnEYwEr3x4BVaK8LMgDhuf5yIdbWjD7PWnxmzaO54mdWqeu7C5tGbxNtxGi2sxwRuxqXhkc2bPRrI3IYloANedot3a7UPk55lGMt8uEtqtXww9aaZj8&amp;w=828&amp;q=85 828w, /_next/image?url=https%3A%2F%2Flh3.googleusercontent.com%2FqmDpWfgMXmVnoc8Fw21auem6n-U8p5EUxTSOHnEYwEr3x4BVaK8LMgDhuf5yIdbWjD7PWnxmzaO54mdWqeu7C5tGbxNtxGi2sxwRuxqXhkc2bPRrI3IYloANedot3a7UPk55lGMt8uEtqtXww9aaZj8&amp;w=1080&amp;q=85 1080w, /_next/image?url=https%3A%2F%2Flh3.googleusercontent.com%2FqmDpWfgMXmVnoc8Fw21auem6n-U8p5EUxTSOHnEYwEr3x4BVaK8LMgDhuf5yIdbWjD7PWnxmzaO54mdWqeu7C5tGbxNtxGi2sxwRuxqXhkc2bPRrI3IYloANedot3a7UPk55lGMt8uEtqtXww9aaZj8&amp;w=1200&amp;q=85 1200w, /_next/image?url=https%3A%2F%2Flh3.googleusercontent.com%2FqmDpWfgMXmVnoc8Fw21auem6n-U8p5EUxTSOHnEYwEr3x4BVaK8LMgDhuf5yIdbWjD7PWnxmzaO54mdWqeu7C5tGbxNtxGi2sxwRuxqXhkc2bPRrI3IYloANedot3a7UPk55lGMt8uEtqtXww9aaZj8&amp;w=1920&amp;q=85 1920w, /_next/image?url=https%3A%2F%2Flh3.googleusercontent.com%2FqmDpWfgMXmVnoc8Fw21auem6n-U8p5EUxTSOHnEYwEr3x4BVaK8LMgDhuf5yIdbWjD7PWnxmzaO54mdWqeu7C5tGbxNtxGi2sxwRuxqXhkc2bPRrI3IYloANedot3a7UPk55lGMt8uEtqtXww9aaZj8&amp;w=2048&amp;q=85 2048w, /_next/image?url=https%3A%2F%2Flh3.googleusercontent.com%2FqmDpWfgMXmVnoc8Fw21auem6n-U8p5EUxTSOHnEYwEr3x4BVaK8LMgDhuf5yIdbWjD7PWnxmzaO54mdWqeu7C5tGbxNtxGi2sxwRuxqXhkc2bPRrI3IYloANedot3a7UPk55lGMt8uEtqtXww9aaZj8&amp;w=3840&amp;q=85 3840w" src="https://neon.tech/_next/image?url=https%3A%2F%2Flh3.googleusercontent.com%2FqmDpWfgMXmVnoc8Fw21auem6n-U8p5EUxTSOHnEYwEr3x4BVaK8LMgDhuf5yIdbWjD7PWnxmzaO54mdWqeu7C5tGbxNtxGi2sxwRuxqXhkc2bPRrI3IYloANedot3a7UPk55lGMt8uEtqtXww9aaZj8&amp;w=3840&amp;q=85"/></p><p>The key advantage of this approach is you get a real, ordinary Postgres connection via a familiar, ordinary Postgres driver. </p>



<p>However, the main challenge with WebSockets is minimizing network round-trips since state persistence is typically lacking between requests in Edge environments. After several significant optimizations to the WebSockets driver, we successfully <a href="http://Daniel Price   5 minutes ago maybe add a link to the blog post to this sentence:  After several significant optimizations to the WebSockets driver, we successfully reduced the number of round-trips from nine to four&#34; https://neon.tech/blog/quicker-serverless-postgres">reduced the number of round-trips from nine to four</a>. </p>



<p>We ran some tests with the WebSockets driver from Edge Functions, and the query latency distribution shows there are two distinct query groups:</p>



<ul>
<li>Connection + first query group (on the right)</li>



<li>Second query on-wards (on the left)</li>
</ul>



<p><img alt="Post image" loading="lazy" width="838" height="442" decoding="async" data-nimg="1" sizes="(max-width: 767px) 100vw" srcset="/_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-24.png&amp;w=640&amp;q=85 640w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-24.png&amp;w=750&amp;q=85 750w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-24.png&amp;w=828&amp;q=85 828w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-24.png&amp;w=1080&amp;q=85 1080w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-24.png&amp;w=1200&amp;q=85 1200w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-24.png&amp;w=1920&amp;q=85 1920w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-24.png&amp;w=2048&amp;q=85 2048w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-24.png&amp;w=3840&amp;q=85 3840w" src="https://neon.tech/_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-24.png&amp;w=3840&amp;q=85"/></p><p>We experimented with 1, 2, 5, and 10 iterations. Iterations represent the number of queries executed in each Edge Function, and the result from the chart is clear: latencies for second queries and above with WebSockets are fast (~5ms), but single-shot queries … not so much (~37ms).</p>



<h2>Experimenting with HTTP</h2>



<p>We experimented with different protocols and compared our WebSocket driver latencies to those of SQL-over-HTTP via fetch. Why HTTP, you ask? The short answer is: to reduce latencies.</p>



<p>The advantage WebSocket has over SQL-over-HTTP drivers is Postgres compatibility. HTTP does not support sessions, transactions, or Postgres features such as <code>NOTIFY</code> and the <code>COPY</code> protocol, but it works well for simple, one-shot queries.</p>



<p>But in a race, what matters is how quickly you get to the finish line rather than the type of tires your ride has.</p>



<p>So we put HTTP and WebSocket drivers to the test and ran experiments on Vercel Edge and Serverless environments in the Washington (iad1) region and a Neon database in N. Virginia region (us-east-1). We ran the experiment in Serverless environments to use the results as our baseline.</p>



<p>Serverless and Edge functions are serverless computing models, but they operate at different points in the network. Serverless functions, like AWS Lambda or Vercel Serverless Functions, run in the cloud and abstract away the server infrastructure. On the other hand, Edge functions are a type of serverless function that runs at the edge of the network as close to the end user as possible.</p>



<h2>HTTP vs. WebSockets performance</h2>



<p>The chart below represents the latency distribution for the HTTP driver. This test consisted of running Edge Functions executing 1,2, 5, and 10 queries (iterations) to the database each, similar to the experiment described above for WebSocket latencies. </p>



<p><img alt="Post image" loading="lazy" width="838" height="442" decoding="async" data-nimg="1" sizes="(max-width: 767px) 100vw" srcset="/_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-26.png&amp;w=640&amp;q=85 640w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-26.png&amp;w=750&amp;q=85 750w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-26.png&amp;w=828&amp;q=85 828w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-26.png&amp;w=1080&amp;q=85 1080w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-26.png&amp;w=1200&amp;q=85 1200w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-26.png&amp;w=1920&amp;q=85 1920w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-26.png&amp;w=2048&amp;q=85 2048w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-26.png&amp;w=3840&amp;q=85 3840w" src="https://neon.tech/_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-26.png&amp;w=3840&amp;q=85"/></p><p>The first thing that caught our attention is that the distribution for SQL-over-HTTP queries is bi-modal.</p>



<p>We can see<em> two peaks</em> in the one-iteration query distribution line in blue. This shows that certain queries are ~5ms faster than others. We can observe this behavior in Edge Runtimes and not in Serverless (see chart below), which leads us to conclude that Edge Runtime’s scheduler prioritizes cached HTTP connections.</p>



<p><img alt="Post image" loading="lazy" width="836" height="441" decoding="async" data-nimg="1" sizes="(max-width: 767px) 100vw" srcset="/_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-27.png&amp;w=640&amp;q=85 640w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-27.png&amp;w=750&amp;q=85 750w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-27.png&amp;w=828&amp;q=85 828w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-27.png&amp;w=1080&amp;q=85 1080w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-27.png&amp;w=1200&amp;q=85 1200w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-27.png&amp;w=1920&amp;q=85 1920w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-27.png&amp;w=2048&amp;q=85 2048w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-27.png&amp;w=3840&amp;q=85 3840w" src="https://neon.tech/_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-27.png&amp;w=3840&amp;q=85"/></p><p>While SQL-over-HTTP outperforms WebSockets in one-iteration Edge Functions, queries over WebSockets are <em>much</em> faster once the connection is established with the database.</p>



<p><img alt="Post image" loading="lazy" width="839" height="443" decoding="async" data-nimg="1" sizes="(max-width: 767px) 100vw" srcset="/_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-25.png&amp;w=640&amp;q=85 640w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-25.png&amp;w=750&amp;q=85 750w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-25.png&amp;w=828&amp;q=85 828w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-25.png&amp;w=1080&amp;q=85 1080w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-25.png&amp;w=1200&amp;q=85 1200w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-25.png&amp;w=1920&amp;q=85 1920w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-25.png&amp;w=2048&amp;q=85 2048w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-25.png&amp;w=3840&amp;q=85 3840w" src="https://neon.tech/_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-25.png&amp;w=3840&amp;q=85"/></p><p>There you have it! </p>



<p>The WebSocket driver beats SQL-over-HTTP … but only after the connection is established and the protocol upgraded.</p>



<p>However, the HTTP driver outperforms the WebSockets one for single-shot queries. </p>



<p>Can we somehow have the best of both worlds? To get to sub-10ms queries using HTTP, we added support for connection caching to our proxy.</p>



<h2>Connection cache for SQL-over-HTTP queries</h2>



<p>Neon is serverless Postgres and decouples compute and storage. When getting a request, Neon’s proxy looks for the right compute node to execute the query.</p>



<p>In this case, connection caching helps the proxy find the right compute node almost 10ms faster. </p>



<p>The chart below shows query latency distribution before and after using connection caching.</p>



<p><img alt="Post image" loading="lazy" width="838" height="442" decoding="async" data-nimg="1" sizes="(max-width: 767px) 100vw" srcset="/_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-28.png&amp;w=640&amp;q=85 640w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-28.png&amp;w=750&amp;q=85 750w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-28.png&amp;w=828&amp;q=85 828w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-28.png&amp;w=1080&amp;q=85 1080w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-28.png&amp;w=1200&amp;q=85 1200w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-28.png&amp;w=1920&amp;q=85 1920w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-28.png&amp;w=2048&amp;q=85 2048w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-28.png&amp;w=3840&amp;q=85 3840w" src="https://neon.tech/_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-28.png&amp;w=3840&amp;q=85"/></p><p>Connection caching is experimental and opt-in only. You can try it by setting fetchConnectionCache to true in the neonConfig object.</p>


<div><pre><code><span>import</span><span> </span><span>{</span><span> neon</span><span>,</span><span> neonConfig </span><span>}</span><span> </span><span>from</span><span> </span><span>&#39;@neondatabase/serverless&#39;</span><span>;</span><span>
</span>
<span></span><span>export</span><span> </span><span>const</span><span> config </span><span>=</span><span> </span><span>{</span><span> </span><span>runtime</span><span>:</span><span> </span><span>&#39;edge&#39;</span><span> </span><span>}</span><span>;</span><span>
</span>
<span>neonConfig</span><span>.</span><span>fetchConnectionCache</span><span> </span><span>=</span><span> </span><span>true</span><span>;</span><span> 
</span>
<span></span><span>export</span><span> </span><span>default</span><span> </span><span>async</span><span> </span><span>(</span><span>req</span><span>:</span><span> </span><span>Request</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span>
</span><span>  </span><span>const</span><span> id </span><span>=</span><span> </span><span>12</span><span>;</span><span>
</span><span>  </span><span>const</span><span> sql </span><span>=</span><span> </span><span>neon</span><span>(</span><span>process</span><span>.</span><span>env</span><span>.</span><span>DATABASE_URL</span><span>!</span><span>)</span><span>;</span><span>
</span><span>  </span><span>const</span><span> oneAtom </span><span>=</span><span> </span><span>await</span><span> </span><span>sql</span><span>(</span><span>&#34;SELECT * FROM atoms WHERE id=$1&#34;</span><span>)</span><span>,</span><span> </span><span>[</span><span>id</span><span>]</span><span>)</span><span>;</span><span>
</span><span>  </span><span>return</span><span> </span><span>new</span><span> </span><span>Response</span><span>(</span><span>JSON</span><span>.</span><span>stringify</span><span>(</span><span>{</span><span> oneAtom </span><span>}</span><span>)</span><span>)</span><span>;</span><span>
</span><span></span><span>}</span></code></pre></div>


<h2>Conclusion</h2>



<p>So, which one is the fastest? SQL-over-HTTP or the WebSockets driver?</p>



<p>As often, the answer is … it depends!</p>



<p>With <code>@neondatabase/serverless</code> driver, you get both in a single package to accommodate your use case. Do you run single-shot queries? In this case, you might want to consider using HTTP. </p>



<p>Do you execute multiple queries in a single connection? Then WebSockets can bring latencies down to 4ms once the connection is established.</p>



<p>Another interesting finding, however, is that the runtime matters as much as the protocol. </p>



<p>The Edge network is far larger than the Serverless one, making it geographically closer to the end user. However, with connection cache, HTTP queries executed in Serverless environments show <em>even</em> lower latencies than the ones executed in Edge runtimes.</p>



<p><img alt="Post image" loading="lazy" width="840" height="443" decoding="async" data-nimg="1" sizes="(max-width: 767px) 100vw" srcset="/_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-30.png&amp;w=640&amp;q=85 640w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-30.png&amp;w=750&amp;q=85 750w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-30.png&amp;w=828&amp;q=85 828w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-30.png&amp;w=1080&amp;q=85 1080w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-30.png&amp;w=1200&amp;q=85 1200w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-30.png&amp;w=1920&amp;q=85 1920w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-30.png&amp;w=2048&amp;q=85 2048w, /_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-30.png&amp;w=3840&amp;q=85 3840w" src="https://neon.tech/_next/image?url=https%3A%2F%2Fneon-hwp.dreamhosters.com%2Fwp-content%2Fuploads%2F2023%2F07%2Fimage-30.png&amp;w=3840&amp;q=85"/></p><p>Therefore, developers who strive for lower latency queries using serverless runtimes should consider the following:</p>



<ul>
<li><strong>Query type</strong>: Do you execute single-shot queries? Or run multiple queries for each function?</li>



<li><strong>Regions</strong>: Where are your users located? Are they in one region or scattered across multiple geographies? Where is your database located?</li>



<li><strong>API</strong>: Do you use Node.js specific functions? </li>
</ul>



<p>We invite you to <a href="https://console.neon.tech/">try Neon</a> and explore the driver’s benefits to your applications. We welcome your feedback and insights as we evolve our product to serve your needs better.</p>
</div></div>
  </body>
</html>
