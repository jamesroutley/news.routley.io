<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://labs.watchtowr.com/we-spent-20-to-achieve-rce-and-accidentally-became-the-admins-of-mobi/">Original</a>
    <h1>We spent $20 to achieve RCE and accidentally became the admins of .mobi</h1>
    
    <div id="readability-page-1" class="page"><div>
            <p>Welcome back to another watchTowr Labs blog. Brace yourselves, this is one of our most astounding discoveries.</p><h3 id="summary">Summary</h3><p>What started out as a bit of fun between colleagues while avoiding the Vegas heat and $20 bottles of water in our Black Hat hotel rooms - has now seemingly become a major incident.</p><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image.png" alt="" loading="lazy" width="700" height="700" srcset="https://labs.watchtowr.com/content/images/size/w600/2024/09/image.png 600w, https://labs.watchtowr.com/content/images/2024/09/image.png 700w"/></figure><p>We recently performed research that started off &#34;well-intentioned&#34; (or as well-intentioned as we ever are) -  to make vulnerabilities in WHOIS clients and how they parse responses from WHOIS servers exploitable in the real world (i.e. without needing to MITM etc). </p><p>Our view was that as a legacy WHOIS server domain, it was likely only used by old WHOIS tools (such as phpWHOIS, which conveniently has an Remote Code Execution (RCE) CVE from 2015 for the parsing of WHOIS server responses – thus fitting our aim quite nicely). </p><ul><li>Various mail servers for .GOV and .MIL entities using this WHOIS server to presumably query for domains they are receiving email from,</li><li>Various cyber security tools and companies still using this WHOIS server as authoritative (VirusTotal, URLSCAN, Group-IB as examples)</li></ul><p>However, significant concern appeared on 1st September 2024 when we realised that numerous Certificate Authorities responsible for issuing TLS/SSL certificates for domains like &#39;google.mobi&#39; and &#39;microsoft.mobi&#39;, via the &#39;Domain Email Validation&#39; mechanism for verifying ownership of a domain, were using our WHOIS server to determine the owners of a domain and where verification details should be sent.</p><p>We PoC&#39;d this with GlobalSign and were able to demonstrate that for &#39;microsoft.mobi&#39;, GlobalSign would parse responses provided by our WHOIS server and present &#39;whois@watchtowr.com&#39; as an authoritative email address. </p><p>Effectively, we had inadvertently undermined the CA process for the entire .mobi TLD.</p><p>As is common knowledge, this is an incredibly important process that underscores the security and integrity of communications that a significant amount of the Internet relies upon. This process has been targeted numerous times before by well-resourced nation-states:</p><ul><li><a href="https://www.wired.com/2011/03/comodo-compromise/?ref=labs.watchtowr.com" rel="noopener noreferrer"><u>Hack Obtains 9 Bogus Certificates for Prominent Websites; Traced to Iran</u></a></li><li><a href="https://arstechnica.com/information-technology/2022/11/state-sponsored-hackers-in-china-compromise-certificate-authority/?ref=labs.watchtowr.com" rel="noopener noreferrer"><u>State-sponsored hackers in China compromise certificate authority</u></a></li></ul><p>While this has been interesting to document and research, we are a little exasperated. Something-something-hopefully-an-LLM-will-solve-all-of-these-problems-something-something.</p><p>As always, we remind everyone - if we could do this, anyone can. </p><p>Onto the full story...</p><h3 id="setting-the-scene">Setting The Scene</h3><p>We&#39;re sure you’re familiar with the old adage, ‘it never rains but it pours’. That was definitely the case here, where we set out with the intention of just getting some RCE’s to fling around, and ended up watching the foundation of secure Internet communication crumble before our eyes.</p><p>Before we get ahead of ourselves, though, let’s start at the beginning, in which we decided to take a quick look at a WHOIS client. The protocol being some 50+ years old, we expected WHOIS clients to be constructed with the same brand of string as an enterprise-grade SSL VPN appliance, and so we took a naive shot and served up some A’s.</p><pre><code># python3 -c &#34;printf( &#39;Domain Name: &#39; + &#39;A&#39; * 3000)&#34; | nc -w1 -l whois
</code></pre><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-1.png" alt="" loading="lazy" width="2000" height="1624" srcset="https://labs.watchtowr.com/content/images/size/w600/2024/09/image-1.png 600w, https://labs.watchtowr.com/content/images/size/w1000/2024/09/image-1.png 1000w, https://labs.watchtowr.com/content/images/size/w1600/2024/09/image-1.png 1600w, https://labs.watchtowr.com/content/images/2024/09/image-1.png 2000w" sizes="(min-width: 720px) 720px"/></figure><p>Haha, we were right. Funny.</p><p>This, at first glance, looks like an easily-exploitable crash. We were keen to find more bugs, and keenly started examining some other client implementations - but we were soon interrupted by some vocal <s>killjoys</s> naysayers.</p><p>They were quick to remind us that, to get to this state in our lab environment, we’d impersonated a WHOIS server, redirecting traffic from the usual server to our test server via <code>iptables</code>.</p><p>How realistic was this attack scenario, the naysayers asked?</p><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-30.png" alt="" loading="lazy" width="487" height="157"/></figure><p>We tried to silence the <s>killjoy&#39;s</s> naysayers and convince them our attack was plausible - we could find a registrar that allows us to set a Referral WHOIS value, or buy an IP range and control the range ourselves - but they suggested we spend more time doing, and less time playing academia.</p><p>The reality was that in order for an attacker to carry out an attack against a WHOIS client, they’d need one of the following:</p><ul><li>A Man-In-The-Middle (MiTM) attack, which requires the ability to hijack WHOIS traffic at the network layer - out of reach for all but the most advanced of APTs,</li><li>Access to the WHOIS servers themselves, which is plausible but unlikely, or</li><li>A WHOIS referral to a server they control.</li></ul><p>These are effectively the preconditions of a nation-state or someone who is very comfortable compromising global TLD WHOIS servers in pursuit of exploiting clients.</p><p>You would, at this point, be forgiven for thinking that this class of attack - controlling WHOIS server responses to exploit parsing implementations within WHOIS clients - isn’t a tangible threat in the real world.</p><p>We were left unsatisfied. We had located some shoddy code, but declaring it out of reach sounded like something you might bill a day rate for.</p><p>Perhaps there was another avenue for attack?</p><h3 id="collateral-damage-in-pursuit-of-rce">Collateral Damage In Pursuit Of RCE</h3><p>The key to turning this theoretical RCE into a tangible reality is rooted in the tangled mess of the WHOIS system.</p><p>One of the biggest ‘kludges’ in the WHOIS system is the means of locating the authoritative WHOIS server for a given TLD in the first place.</p><p>Each TLD (the bit at the end of the domain), you see, has a separate WHOIS server, and there’s no real standard to locating them - the only ‘real’ method being examining a textual list published by IANA. This list denotes the hostname of a server for each TLD, which is where WHOIS queries should be directed.</p><p>As you can imagine, maintainers of WHOIS tooling are reluctant to scrape such a textual list at runtime, and so it has become the norm to simply hardcode server addresses, populating them at development time by referring to IANA’s list manually. Since the WHOIS server addresses change so infrequently, this is usually an acceptable solution.</p><p>However, it falls down in an ungraceful manner when server addresses change. With a little bit of legwork, we found that the WHOIS server for a particular TLD - <code>.mobi</code> - had been changed some years ago from the old domain <a href="http://whois.dotmobiregistry.net/?ref=labs.watchtowr.com"><code>whois.dotmobiregistry.net</code></a> to a new server, at <code>whois.nic.mobi</code>.</p><p>Of course though, because the Internet is joined together by literal string and hopes/wishes at this stage, somebody had neglected to renew the old domain at <code>dotmobiregistry.net</code> meaning it was up for grabs by anyone with $20 and an ill-advised sense of exploration.</p><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-3.png" alt="" loading="lazy" width="2000" height="2000" srcset="https://labs.watchtowr.com/content/images/size/w600/2024/09/image-3.png 600w, https://labs.watchtowr.com/content/images/size/w1000/2024/09/image-3.png 1000w, https://labs.watchtowr.com/content/images/size/w1600/2024/09/image-3.png 1600w, https://labs.watchtowr.com/content/images/2024/09/image-3.png 2000w" sizes="(min-width: 720px) 720px"/></figure><p>We registered the domain, working on the theory that, while most client tooling would be updated to use <code>whois.nic.mobi</code>, most of the Internet population is still surprised when their 2011 SAP deployment gets popped, and thus WHOIS applications in production had a fairly decent chance of still referencing <code>whois.dotmobiregistry.net</code>.</p><p>Of course, this being the Internet, we got a little more than we bargained for.</p><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-4.png" alt="" loading="lazy" width="2000" height="260" srcset="https://labs.watchtowr.com/content/images/size/w600/2024/09/image-4.png 600w, https://labs.watchtowr.com/content/images/size/w1000/2024/09/image-4.png 1000w, https://labs.watchtowr.com/content/images/size/w1600/2024/09/image-4.png 1600w, https://labs.watchtowr.com/content/images/2024/09/image-4.png 2000w" sizes="(min-width: 720px) 720px"/></figure><h3 id="so-what-its-old">So What? It&#39;s Old</h3><p>We soon realized the threat model for this attack had just changed.</p><p>Now that we control a WHOIS server, we were in the position to ‘respond’ to traffic sent by anyone who hadn’t updated their client to use the new address (auto updates are bad, turn them off).</p><p>No longer do we require a Man-In-The-Middle attack, or some exotic WHOIS referral, to exploit a WHOIS client vulnerability - all we need to do is wait for queries to come in, and theoretically respond with whatever we want.</p><p>The pre-requisites for real-world exploitation now sat within what we deemed ‘rough reality’.</p><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-5.png" alt="" loading="lazy" width="2000" height="1125" srcset="https://labs.watchtowr.com/content/images/size/w600/2024/09/image-5.png 600w, https://labs.watchtowr.com/content/images/size/w1000/2024/09/image-5.png 1000w, https://labs.watchtowr.com/content/images/size/w1600/2024/09/image-5.png 1600w, https://labs.watchtowr.com/content/images/2024/09/image-5.png 2000w" sizes="(min-width: 720px) 720px"/></figure><p>Things were beginning to escalate.</p><p>We had set out to find some simple bugs in WHOIS client tooling, file for some CVEs, get them fixed.. but then we realised that once again we’d probably chewed off more than we intended and things were about to become worse - <em>much</em> worse.</p><h3 id="never-update-auto-updates-and-change-are-bad">Never Update, Auto-Updates And Change Are Bad</h3><p>Unfortunately, there is a lot of Internet infrastructure which depends on the antiquated WHOIS protocol.</p><p>Starting off slow, we’re now in a position to attack the <a href="https://www.google.com/search?q=whois+website&amp;ref=labs.watchtowr.com">many websites</a> that run a WHOIS client and echo the results back to the user, injecting XSS or PHP <code>eval</code> payloads. Ethical (and legal) concerns prevent us from doing so, however - and we did not spend $20 to get an XSS.</p><p>Of course, our original goal was to find and exploit some 0day in WHOIS clients, or some other system that embeds a WHOIS client (such as a spam filter), similar to the trivial memory corruption we found earlier.</p><p>Our biggest hurdle here - as alluded to above - was the simplicity of the WHOIS protocol itself, which is a simple text-based TCP data stream. With so little complexity, there seemed very little room for developers to make errors.</p><p>Ha.</p><h3 id="prior-art">Prior Art</h3><p>To fully understand and look to leverage our new capability and adjusted threat model, we decided to examine the area’s ‘prior art’ in exploitation, looking at historic attacks on WHOIS clients.</p><p>We were somewhat surprised that a search for <a href="https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=whois&amp;ref=labs.watchtowr.com">relevant CVE data</a> yielded relatively few results, which we attributed to the area being under-researched - the search return 26 CVE records.</p><p><strong>Once we discount the irrelevant results, we are left with only three bugs that are triggered by malformed WHOIS responses.</strong></p><p>This small number - three bugs since 1999 - makes it obvious to us that very little research has been done - likely due to the perception that any real-world exploitation comes with difficult prerequisites, such as control of a TLD WHOIS server.</p><p>But, there have been some interesting cases - just to give you a taste of where this is going.</p><h3 id="phpwhois-cve-2015-5243">phpWHOIS (CVE-2015-5243)</h3><p>The first bug that our retrospective found was <a href="https://github.com/advisories/GHSA-c95f-27gx-6vq9?ref=labs.watchtowr.com">CVE-2015-5243</a>. This is a monster of a bug, in which the prolific phpWhois library simply <em>executes</em> data obtained from the WHOIS server via the PHP ‘eval’ function, allowing instant RCE from any malicious WHOIS server.</p><p>The vulnerable code snippet:</p><pre><code>foreach ($items as $match =&gt; $field) {
    $pos = strpos($val, $match);

    if ($pos !== false) {
        if ($field != &#39;&#39;) {
            $var = &#39;$r&#39; . getvarname($field);
            $itm = trim(substr($val, $pos + strlen($match)));

            if ($itm != &#39;&#39;)
                eval($var . &#39;=&#34;&#39; . str_replace(&#39;&#34;&#39;, &#39;\\\\&#34;&#39;, $itm) . &#39;&#34;;&#39;);
        }

        if (!$scanall)
            break;
    }
}
</code></pre><p>What’s going on here?</p><p>The important item is the juicy <code>eval</code> statement in the middle of the snippet, which is fed data returned from the WHOIS server.</p><p>While it attempts to escape this data before it evaluates it, it does so imperfectly, only replacing <code>&#34;</code> with the escaped form, <code>\\\\&#34;</code> . Because of this, we can sneak in our own PHP code, which is then executed for us.</p><p><a href="https://blog.nettitude.com/uk/cve-2015-5243-phpwhois-remote-code-execution?ref=labs.watchtowr.com">Netitude’s blogpost</a> lays out all the details, and even provides us with exploitation code - <code>”;phpinfo();//</code> - is enough to spawn a <code>phpinfo</code> page.</p><p>We tried this out on an application that uses <code>phpWhois</code>, purely to demonstrate, and it worked swimmingly:</p><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-6.png" alt="" loading="lazy" width="2000" height="1108" srcset="https://labs.watchtowr.com/content/images/size/w600/2024/09/image-6.png 600w, https://labs.watchtowr.com/content/images/size/w1000/2024/09/image-6.png 1000w, https://labs.watchtowr.com/content/images/size/w1600/2024/09/image-6.png 1600w, https://labs.watchtowr.com/content/images/2024/09/image-6.png 2000w" sizes="(min-width: 720px) 720px"/></figure><p><a href="https://labs.watchtowr.com/content/images/2024/08/image-5.png">https://labs.watchtowr.com/content/images/2024/08/image-5.png</a></p><p>Clearly this is a powerful bug - the best part being that phpWhois hardcodes our newly found <code>whois.dotmobiregistry.net</code> in vulnerable versions (it&#39;s old, but at a cursory glance no-one appears to have ever updated phpWhois).</p><p>What other historic artefacts could we find, though?</p><h3 id="fail2ban-cve-2021-32749">Fail2Ban (CVE-2021-32749)</h3><p>As we continued to examine historic client-side bugs, we came across <a href="https://github.com/fail2ban/fail2ban/security/advisories/GHSA-m985-3f3v-cwmm?ref=labs.watchtowr.com">CVE-2021-32749</a>. This one is again a pretty nasty bug, this time in the ever-popular <code>fail2ban</code> package. It’s a command injection vulnerability, a vulnerability class keenly sought by attackers due to its power and ease of exploitation.</p><p>As you may know, if you have administered a <code>fail2ban</code> server, the purpose of <code>fail2ban</code> is to monitor failed login attempts, and prevent bruteforce or password-guessing attacks by blocking hosts which repeatedly fail to log in.</p><p>Being the polished package it is, it also includes the ability to email an administrator when an IP address is banned, and - very helpfully - when it does so, it will enrich the email with information about who owns the banned IP address.</p><p>This information is gleaned from - yeah, you guessed it! - our friend WHOIS.</p><p>Unfortunately, for some time, the output of the WHOIS client wasn’t correctly sanitized before being passed to the <code>mail</code> tool, and so a command injection bug was possible.</p><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-7.png" alt="" loading="lazy" width="2000" height="491" srcset="https://labs.watchtowr.com/content/images/size/w600/2024/09/image-7.png 600w, https://labs.watchtowr.com/content/images/size/w1000/2024/09/image-7.png 1000w, https://labs.watchtowr.com/content/images/size/w1600/2024/09/image-7.png 1600w, https://labs.watchtowr.com/content/images/2024/09/image-7.png 2000w" sizes="(min-width: 720px) 720px"/></figure><p>Fortunately - or unfortunately, if you’re an attacker - because <code>fail2ban</code> runs a WHOIS query on the <em>IP address</em> rather than, for example, a <em>domain name specified in the PTR record of an IP address</em> of blocked hosts - this attack is not within reach still based on our newly found capability.</p><p>For those that control a WHOIS server that is queried for IP addresses, though, exploitation is simple - simply attempt to unsuccessfully authenticate to a server via SSH a few times to trigger a ban, and once <code>fail2ban</code> queries the WHOIS server for information on your IP address - serve a payload wrapped in backticks.</p><h3 id="reality-check">Reality check</h3><p>So, the burning question on our minds - can we actually exploit these bugs, <em>right now</em>?</p><p>Well, at this stage, our view was fairly pessimistic in terms of achieving real-world impact. We saw the following pre-requisites:</p><ul><li>The WHOIS client must be querying an old authoritative .MOBI WHOIS server and thus by definition, has not been working for <em>quite a while</em></li><li>To achieve client-side code execution (i.e. compromise) via a WHOIS client vuln - the only public option available to us was disclosed in 2015 and appears to have been rectified in 2018 - likely due to the perceived lack of real-world exploitation mechanisms.</li></ul><p>Meh. Our gut feeling remained that most of the Internet and those in the sane world would logically be querying the new .mobi authoritative WHOIS server <code>whois.nic.mobi</code>, rather than the decommissioned <a href="http://dotmobiregistry.net/?ref=labs.watchtowr.com"><code>dotmobiregistry.net</code></a> (which we now controlled).</p><p>“Surely no large organisations would still reference the old domain”, we thought to ourselves.</p><h3 id="kill-whois-with-fire">Kill WHOIS With Fire</h3><p>Without skipping a beat and really not considering the consequences, we set up a WHOIS server beneath our new domain at <code>whois.dotmobiregistry.net</code>, and logged incoming requests. We specifically focused on two things:</p><ul><li>Source IPs (so we can perhaps begin to work out who exactly was querying an outdated server), and,</li><li>The queried domain (because again, this may give off some clues).</li></ul><p>We threw together the <a href="https://github.com/fritz0705/lglass?ref=labs.watchtowr.com">lglass</a> server to respond to WHOIS requests that found their way to our WHOIS server, and returned:</p><ul><li>ASCII art (we were relatively refrained here, but it was a priority)</li><li>Fake WHOIS details indicating watchTowr as the owner for every queried entity.</li></ul><p>As this was our private server, we included a request for queries to cease (after all, they were unauthorised).</p><p>A quick test directly to our new WHOIS server showed that all was working as expected, with the following response provided for a query about <code>google.mobi</code>:</p><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-8.png" alt="" loading="lazy" width="2000" height="2532" srcset="https://labs.watchtowr.com/content/images/size/w600/2024/09/image-8.png 600w, https://labs.watchtowr.com/content/images/size/w1000/2024/09/image-8.png 1000w, https://labs.watchtowr.com/content/images/size/w1600/2024/09/image-8.png 1600w, https://labs.watchtowr.com/content/images/2024/09/image-8.png 2000w" sizes="(min-width: 720px) 720px"/></figure><p>Nice.</p><h3 id="uh%E2%80%A6">Uh…..</h3><p>Well, it’s 2024 - absolutely no one has the ability to exercise patience, including ourselves.</p><p>So, we began just looking around the Internet for obvious locations that could be sending queries our way. Surely, we thought - <em>surely! -</em> the broken clients using an outdated server address wouldn’t be in anything major, that we use every day?</p><ul><li>A significant number of domain registrars and WHOIS-function websites<ul><li><a href="http://domain.com/?ref=labs.watchtowr.com">domain.com</a></li><li><a href="http://godaddy.com/?ref=labs.watchtowr.com">godaddy.com</a></li><li><a href="http://who.is/?ref=labs.watchtowr.com">who.is</a></li><li><a href="http://whois.ru/?ref=labs.watchtowr.com">whois.ru</a></li><li><a href="https://smallseo.tools/?ref=labs.watchtowr.com" rel="noreferrer">smallseo.tools</a></li><li><a href="http://seocheki.net/?ref=labs.watchtowr.com">seocheki.net</a></li><li><a href="http://centralops.net/?ref=labs.watchtowr.com">centralops.net</a></li><li><a href="http://name.com/?ref=labs.watchtowr.com">name.com</a></li><li><a href="http://webchart.org/?ref=labs.watchtowr.com">webchart.org</a></li></ul></li></ul><p>etc (you get the idea)</p><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-10.png" alt="" loading="lazy" width="2000" height="1947" srcset="https://labs.watchtowr.com/content/images/size/w600/2024/09/image-10.png 600w, https://labs.watchtowr.com/content/images/size/w1000/2024/09/image-10.png 1000w, https://labs.watchtowr.com/content/images/size/w1600/2024/09/image-10.png 1600w, https://labs.watchtowr.com/content/images/2024/09/image-10.png 2000w" sizes="(min-width: 720px) 720px"/></figure><p>A screenshot of each WHOIS tool would become repetitive, but you get the idea.</p><ul><li><a href="http://urlscan.io/?ref=labs.watchtowr.com">urlscan.io</a> - “<em>A sandbox for the web”</em> - used our WHOIS server for .mobi, too. You can see the results by browsing to a page representing any .mobi domain (<a href="https://urlscan.io/domain/bbc.mobi?ref=labs.watchtowr.com" rel="noreferrer">like this one</a>).</li></ul><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-24.png" alt="" loading="lazy" width="1643" height="1328" srcset="https://labs.watchtowr.com/content/images/size/w600/2024/09/image-24.png 600w, https://labs.watchtowr.com/content/images/size/w1000/2024/09/image-24.png 1000w, https://labs.watchtowr.com/content/images/size/w1600/2024/09/image-24.png 1600w, https://labs.watchtowr.com/content/images/2024/09/image-24.png 1643w" sizes="(min-width: 720px) 720px"/></figure><ul><li><a href="https://www.virustotal.com/gui/domain/google.mobi/details?ref=labs.watchtowr.com">VirusTotal</a>, the popular malware-analysis site, was querying us! A tool dedicated to the analysis of hostile code seemed like an opportunity for enjoyment.</li></ul><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-25.png" alt="" loading="lazy" width="1463" height="1375" srcset="https://labs.watchtowr.com/content/images/size/w600/2024/09/image-25.png 600w, https://labs.watchtowr.com/content/images/size/w1000/2024/09/image-25.png 1000w, https://labs.watchtowr.com/content/images/2024/09/image-25.png 1463w" sizes="(min-width: 720px) 720px"/></figure><p>Sadly, VirusTotal doesn&#39;t render our ASCII art properly, but as you can see - VirusTotal is querying our makeshift WHOIS server for this global .TLD and presenting back the results. We were also pleased to see that VirusTotal updated their records of who owns <code>bbc.mobi</code>:</p><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-26.png" alt="" loading="lazy" width="774" height="667" srcset="https://labs.watchtowr.com/content/images/size/w600/2024/09/image-26.png 600w, https://labs.watchtowr.com/content/images/2024/09/image-26.png 774w" sizes="(min-width: 720px) 720px"/></figure><p>For anyone that has ever worked in offensive security, you occasionally get a sinking feeling where you realize something may be a little larger than expected, and you begin to wonder.. “what have we broken?”.</p><blockquote>(Editors note: Technically, this should be ‘what <em>was</em> broken’, because people were querying our WHOIS server without authorisation and we’re very upset - get off our lawn!).</blockquote><p>Well, with our WHOIS server clearly working - we figured we’d come back in a few days and see if anything at all reached out to us - giving us us a good excuse to stare at a separate PSIRT response indicating a 2 year lead time to resolve a vulnerability.</p><p>Being insatiable and generally finding it hard to focus on anything longer than a TikTok video of a dog in a hat, we took a look to see how many unique IPs had queried our new WHOIS server after a few hours:</p><pre><code>$ sqlite3 whois-log-copy.db &#34;select source from queries&#34;|sort|uniq|wc -l
76085</code></pre><p>Uh. Yes, that’s correct - this is 76,000+ unique source IP addresses that have sent queries to our WHOIS server in just a couple of hours.</p><p>We were somewhat dismayed when, after leaving our server running for around two days, the poor little SQLite DB containing the logs ballooned to some 1.3 million queries! Clearly, we’d stumbled into something more major than we’d anticipated.</p><p>We threw the list of IPs at ZDNS and just sat back, as a relatively feeble way of doing attribution:</p><pre><code>$ cat whois-src.txt|./zdns PTR &gt; ptr.txt</code></pre><p>Anyway, the results were curious.</p><pre><code>$ grep gov ptr.txt |{magic}|sort|uniq
.gov-east-1.compute.amazonaws.com.&#34;
.gov.ar.&#34;
.gov.bd.&#34;
.gov.br.&#34;
.gov.il.&#34;
.gov.in.&#34;
.gov.ph.&#34;
.gov&#34;</code></pre><p>Great. We’d inadvertently <em>done a thing</em>.</p><p>Some other highlights of source hosts (not exhaustive, but just to give you some idea of just how bad this trash fire appeared to be):</p><ul><li>Mail servers! Lots and lots of mail servers.</li><li>Leading on from that thought, what other <strong>.gov</strong> apparatus have we been queried by? </li></ul><p>Neat.</p><ul><li>Militaries (.mil)<ul><li>Swedish Armed Forces, for example</li></ul></li><li>Universities (.edu)<ul><li>All of them</li></ul></li><li>We even saw cyber security companies - <strong>hey Group-IB, Detectify!</strong> - query our WHOIS server (presumably doing <em>threat intel things</em> for .mobi domains<em>).</em><ul><li>We saw Censys query us for ‘<a href="http://google.com/?ref=labs.watchtowr.com">google.com</a>’ and wondered if we’d get an APT number and a threat intel report shout-out if we’d been actively delivering payloads. Maybe we did? Check your boxen. (We didn&#39;t. Or did we?)</li></ul></li></ul><p>We’re still trying to determine what software solutions are in play here/configured to query this WHOIS server for .mobi - let us know if you have any ideas.</p><p>Those who are nefariously minded likely realised what we saw as well - with .gov and other mail servers querying us each time they received an email from a .mobi domain - we could begin to passively determine who may be in communication. </p><p>This is not ideal. How do we fix this? Well, hold that thought - <strong>IT GETS WORSE.</strong></p><h3 id="tales-of-tls">Tales of TLS</h3><p>TLS/SSL. Everyone knows it - it’s that friendly little padlock icon in the address bar that assures you that your connection is secure. It’s powered by the concept of <em>certificates -</em> sometimes used for HTTPS, sometimes used for signing your malware.</p><p>For example, say you’re the owner of <a href="http://watchtowr.mobi/?ref=labs.watchtowr.com"><code>watchTowr.mobi</code></a>. You want to secure communications to your web server by speaking TLS/SSL , so you go off to your favourite Certificate Authority and request a certificate (let’s also pretend you haven’t heard of LetsEncrypt).</p><p>The Certificate Authority will verify that you own the domain in question - <code>watchTowr.mobi</code> - and will then sign a private certificate, attesting to your identity as the owner of that domain. This is then used by the browser to ensure your communications are secure.</p><p>Speaking of LetsEncrypt, this thread is interesting - <a href="https://community.letsencrypt.org/t/why-doesnt-lets-encrypt-use-whois-information-for-domain-validation/46287?ref=labs.watchtowr.com">https://community.letsencrypt.org/t/why-doesnt-lets-encrypt-use-whois-information-for-domain-validation/46287</a>). In this thread, forum posters detail why LetsEncrypt doesn’t validate domains via WHOIS.<strong> Seems paranoid.</strong></p><p>Anyway, what does this have to do with WHOIS, and what does it have to do with us?!</p><p>Well, it turns out that a number of TLS/SSL authorities will verify ownership of a domain by parsing WHOIS data for your domain - say <code>watchTowr.mobi</code>- and pulling out email addresses defined as the ‘administrative contact’.</p><p>The process is to then send that email address a verification link - once clicked, the Certificate Authority is convinced that you control the domain that you are requesting a TLS/SSL cert for and they will happily mint you a certificate.</p><p>For example:</p><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-13.png" alt="" loading="lazy" width="2000" height="410" srcset="https://labs.watchtowr.com/content/images/size/w600/2024/09/image-13.png 600w, https://labs.watchtowr.com/content/images/size/w1000/2024/09/image-13.png 1000w, https://labs.watchtowr.com/content/images/size/w1600/2024/09/image-13.png 1600w, https://labs.watchtowr.com/content/images/2024/09/image-13.png 2000w" sizes="(min-width: 720px) 720px"/></figure><p>Perhaps you can see where we’re going with this? <em>sobs</em></p><p>If a TLS/SSL certificate authority is using our WHOIS server for <code>.mobi</code> domains, we can likely provide our own email address for this “Email Domain Control Validation” method.</p><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-29.png" alt="" loading="lazy" width="390" height="489"/></figure><p>Uh-oh. Is this a fringe feature supported only by two-bit, poor-quality certificate authorities? </p><p>No! Here’s a sample of large TLS/SSL Certificate Authorities/resellers that support WHOIS-based ownership verification:</p><ul><li>Trustico</li><li>Comodo</li><li>SSLS</li><li>GoGetSSL</li><li>GlobalSign</li><li>DigiSign</li><li>Sectigo</li></ul><p>Going through the normal order flow, we began cautiously - by generating a CSR (Certificate Signing Request) for the fictitious domain <code>watchTowr.mobi</code> - the logic being that as long as our WHOIS server was queried, whether or not the domain was real was irrelevant because we respond positively to absolutely every request including domains that don’t actually exist.</p><pre><code># sudo openssl req -new -key custom.key -out csr.pem
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [AU]:SG
State or Province Name (full name) [Some-State]:Singapore
Locality Name (eg, city) []:Singapore
Organization Name (eg, company) [Internet Widgits Pty Ltd]:watchTowr 
Organizational Unit Name (eg, section) []:
Common Name (e.g. server FQDN or YOUR name) []:watchtowr.mobi
Email Address []:

Please enter the following &#39;extra&#39; attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:</code></pre><p>We’re not going to walk through each provider - for the purposes of illustration, we’ll use GoGetSSL.</p><p>Once we upload our <a href="http://watchtowr.mobi/?ref=labs.watchtowr.com"><code>watchTowr.mobi</code></a> CSR to GoGetSSL, it is parsed, and we continue. The indication of these placeholder email addresses indicates that WHOIS was <em>not</em> successful - instead of the email address that our WHOIS server is configured to respond with (<code>whois@watchtowr.com</code>), we’re presented with only <code>@watchtowr.mobi</code> domains.</p><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-15.png" alt="" loading="lazy" width="2000" height="791" srcset="https://labs.watchtowr.com/content/images/size/w600/2024/09/image-15.png 600w, https://labs.watchtowr.com/content/images/size/w1000/2024/09/image-15.png 1000w, https://labs.watchtowr.com/content/images/size/w1600/2024/09/image-15.png 1600w, https://labs.watchtowr.com/content/images/2024/09/image-15.png 2000w" sizes="(min-width: 720px) 720px"/></figure><p>That’s something of a relief.</p><p>The Certificate Authority has correctly determined that the domain <a href="http://watchtowr.mobi/?ref=labs.watchtowr.com"><code>watchTowr.mobi</code></a> does not exist and thus if WHOIS is working as expected, no email addresses will be returned. We concluded that our newly set up WHOIS server was not being queried by the provider.</p><p>At least the world isn’t ending. Right? (spoiler: <em>it actually was</em>)</p><p>We carried on trying a few other providers until a thought occurred.</p><p>The WHOIS protocol is extremely simple. Essentially it is a string blob returned in various formats depending on the TLD serving it. Each provider implements parsing in their own way. Perhaps, before we write off our theory, we should make sure this verification mechanism is actually working as it is supposed to.</p><p>So, we began again - choosing <code>microsoft.mobi</code> as a <code>.mobi</code> domain that appeared to follow a fairly typical WHOIS format (when using the current <code>.mobi</code> WHOIS server).</p><p>The screenshot below shows that the legitimate WHOIS record for <code>microsoft.mobi</code> was correctly parsed at Entrust, as the only email addresses available for validation were at the <a href="http://microsoft.com/?ref=labs.watchtowr.com"><code>microsoft.com</code></a> domain:</p><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-16.png" alt="" loading="lazy" width="2000" height="1788" srcset="https://labs.watchtowr.com/content/images/size/w600/2024/09/image-16.png 600w, https://labs.watchtowr.com/content/images/size/w1000/2024/09/image-16.png 1000w, https://labs.watchtowr.com/content/images/size/w1600/2024/09/image-16.png 1600w, https://labs.watchtowr.com/content/images/2024/09/image-16.png 2000w" sizes="(min-width: 720px) 720px"/></figure><p>While the WHOIS record for <code>watchTowr.mobi</code> was not being parsed at all (indicating that Entrust was using the correct WHOIS server, and not ours):</p><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-17.png" alt="" loading="lazy" width="2000" height="1691" srcset="https://labs.watchtowr.com/content/images/size/w600/2024/09/image-17.png 600w, https://labs.watchtowr.com/content/images/size/w1000/2024/09/image-17.png 1000w, https://labs.watchtowr.com/content/images/size/w1600/2024/09/image-17.png 1600w, https://labs.watchtowr.com/content/images/2024/09/image-17.png 2000w" sizes="(min-width: 720px) 720px"/></figure><p>Looks good you think?</p><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-18.png" alt="" loading="lazy" width="2000" height="1000" srcset="https://labs.watchtowr.com/content/images/size/w600/2024/09/image-18.png 600w, https://labs.watchtowr.com/content/images/size/w1000/2024/09/image-18.png 1000w, https://labs.watchtowr.com/content/images/size/w1600/2024/09/image-18.png 1600w, https://labs.watchtowr.com/content/images/2024/09/image-18.png 2000w" sizes="(min-width: 720px) 720px"/></figure><p>WRONG.</p><p>We skipped and hopped over to the next provider, GlobalSign. GlobalSign reported that they were unable to parse the WHOIS record of <code>microsoft.mobi</code>:</p><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-19.png" alt="" loading="lazy" width="2000" height="1753" srcset="https://labs.watchtowr.com/content/images/size/w600/2024/09/image-19.png 600w, https://labs.watchtowr.com/content/images/size/w1000/2024/09/image-19.png 1000w, https://labs.watchtowr.com/content/images/size/w1600/2024/09/image-19.png 1600w, https://labs.watchtowr.com/content/images/2024/09/image-19.png 2000w" sizes="(min-width: 720px) 720px"/></figure><p>At this point, something clicked in our minds. Perhaps GlobalSign WAS querying our new WHOIS server - but the string returned by our WHOIS server was incompatible with GlobalSign’s parsing?</p><p>We copied the <code>microsoft.mobi</code> output from the legitimate WHOIS server, made it our own, and loaded it into our own WHOIS server - updated to look like the following:</p><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-20.png" alt="" loading="lazy" width="2000" height="2461" srcset="https://labs.watchtowr.com/content/images/size/w600/2024/09/image-20.png 600w, https://labs.watchtowr.com/content/images/size/w1000/2024/09/image-20.png 1000w, https://labs.watchtowr.com/content/images/size/w1600/2024/09/image-20.png 1600w, https://labs.watchtowr.com/content/images/2024/09/image-20.png 2000w" sizes="(min-width: 720px) 720px"/></figure><p>Holding our breath, we then re-triggered GlobalSign with a CSR for <code>microsoft.mobi</code>…</p><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-21.png" alt="" loading="lazy" width="2000" height="1687" srcset="https://labs.watchtowr.com/content/images/size/w600/2024/09/image-21.png 600w, https://labs.watchtowr.com/content/images/size/w1000/2024/09/image-21.png 1000w, https://labs.watchtowr.com/content/images/size/w1600/2024/09/image-21.png 1600w, https://labs.watchtowr.com/content/images/2024/09/image-21.png 2000w" sizes="(min-width: 720px) 720px"/></figure><blockquote><strong>We want to be explicitly clear that we stopped at this point and did not issue any rogue TLS/SSL certificates to ourselves. This would undoubtedly create an incident, and require significant amounts of work by many parties to revoke and roll back this action.</strong></blockquote><p>Success!</p><p>The GlobalSign TLS/SSL certificate WHOIS domain verification system had queried our WHOIS server, parsed <code>whois@watchTowr.com</code> from the result, and presented it as a valid email address to send a verification email to, allowing us to complete verification and obtain a valid TLS/SSL certificate.</p><p>This is then blindingly simple:</p><ul><li>Set up a rogue WHOIS server on our previously authoritative hostname, responding with our own email address as an ‘administrative contact’</li><li>Attempt to purchase a TLS/SSL certificate for a <code>.mobi</code> domain we want to target (say, <code>microsoft.mobi</code>)</li><li>A Certificate Authority will then perform a WHOIS lookup, and email <em>us</em> instead of the real domain owners [theory]</li><li>We click the link, and.. [theory]</li><li>… receive an TLS/SSL cert for the target domain! [theory]</li></ul><p>Now that we have the ability to issue a TLS/SSL cert for a .mobi domain, we can, in theory, do all sorts of horrible things - ranging from intercepting traffic to impersonating the target server. It’s game over for all sorts of threat models at this point.</p><p>While we are sure some may say we didn’t ‘prove’ we could obtain the certificate, we feel this would’ve been a step too far — so whatever.</p><h3 id="one-last-thing">One Last Thing</h3><p>Please stop emailing us..</p><figure><img src="https://labs.watchtowr.com/content/images/2024/09/image-31.png" alt="" loading="lazy" width="580" height="231"/></figure><h3 id="here-we-go-again">Here We Go Again..</h3><p>We hope you’ve enjoyed (and/or been terrified by) today’s post, in which we took control of a chunk of the Internet’s infrastructure, opened up a big slab of juicy attack surface, and found a neat way of undermining TLS/SSL - the fundamental protocol that allows for secure communication on the web.</p><p>We want to thank the UK&#39;s <a href="https://www.ncsc.gov.uk/?ref=labs.watchtowr.com" rel="noreferrer">NCSC</a> and the <a href="https://www.shadowserver.org/?ref=labs.watchtowr.com" rel="noreferrer">ShadowServer</a> Foundation for rapidly working with us ahead of the release of this research to ensure that the &#39;dotmobiregistry.net&#39; domain is suitably handled going forwards, and that a process is put in place to notify affected parties.</p><p>The dotmobiregistry.net domain, and whois.dotmobiregisry.net hostname, has been pointed to sinkhole systems provided by ShadowServer that now proxy the legitimate WHOIS response for .mobi domains.</p><p>We released this blog post to initially share our process around making the unexploitable exploitable and highlight the state of legacy infrastructure and increasing problems associated with abandoned domains - but inadvertently, we have shone a spotlight on the continuing trivial loopholes in one of the Internet’s most vital encryption processes and structures - TLS/SSL Certificate Authorities. Our research has demonstrated that trust placed in this process by governments and authorities worldwide should be considered misplaced at this stage, in our opinion.</p><p>We continue to hold concern around the basic reality - we found this on a whim in a hotel room while escaping the Vegas heat surrounding Black Hat, while well-resourced and focused nation-states look for loopholes like this every day. In our opinion, we are not likely to be the last to find inexcusable flaws in such a crucial process. </p><p>Although subverting the CA verification process was by far the most devastating of impacts that we uncovered, it was by no means the limit of the opportunity available to us as we also found everything from memory corruptions to command injections. Our ‘honeypot’ WHOIS server gave us some interesting statistics, revealing just how serious the issue is, and a large amount of Internet infrastructure continues to query us instead of the legitimate WHOIS servers.</p><p>We do not intend to call out any specific organization or maintainer here - the prevalence of this issue and the statistics on hand show that this is not a pure-negligence or competence related issue - but a fundamental flaw in how these processes work together.</p><p>It’s worth noting that all the above attacks that we were able to orchestrate given our takeover are also possible by any entity that is able to carry out MITM attacks - such as entities that control or can influence transit backbones. It would be very easy for an attacker with such access to fake WHOIS data for any domain, and thus obtain valid TLS/SSL certificates. Of course, there has been an insurmountable level of effort by major players to add transparency to this process over the years, and thus, &#39;pulling off&#39; a heist of this scale has its operational hurdles.</p><p>At <a href="https://www.watchtowr.com/?ref=labs.watchtowr.com">watchTowr</a>, we passionately believe that continuous security testing is the future and that rapid reaction to emerging threats single-handedly prevents inevitable breaches.</p><p>With the watchTowr Platform, we deliver this capability to our clients every single day - it is our job to understand how emerging threats, vulnerabilities, and TTPs could impact their organizations, with precision.</p><p>If you&#39;d like to learn more about the<strong> </strong><a href="https://www.watchtowr.com/?ref=labs.watchtowr.com"><strong>watchTowr Platform</strong></a><strong>, our Attack Surface Management and Continuous Automated Red Teaming solution,</strong> please get in touch.</p>
        </div></div>
  </body>
</html>
