<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.troyhunt.com/sending-spammers-to-password-purgatory-with-microsoft-power-automate-and-cloudflare-workers-kv/">Original</a>
    <h1>Sending spammers to password purgatory</h1>
    
    <div id="readability-page-1" class="page"><section>
<p>How best to punish spammers? I give this topic a lot of thought because I spend a lot of time sifting through the endless rubbish they send me. And that&#39;s when it dawned on me: the punishment should fit the crime - <em>robbing me of my time</em> - which means that I, in turn, need to rob them of their time. With the smallest possible overhead on <em>my</em> time, of course. So, earlier this year <a href="https://www.troyhunt.com/building-password-purgatory-with-cloudflare-pages-and-workers/">I created Password Purgatory</a> with the singular goal of putting spammers through the hellscape that is attempting to satisfy really nasty password complexity criteria. And I mean <em>really </em>nasty criteria, like much worse than you&#39;ve ever seen before. I opened-sourced it, took a bunch of PRs, built out the API to present increasingly inane password complexity criteria then left it at that. Until now because finally, it&#39;s live, working and devilishly beautiful ðŸ˜ˆ</p><h3 id="step-1-receive-spam">Step 1: Receive Spam</h3><p>This is the easy bit - I didn&#39;t have to do anything for this step! But let me put it into context and give you a real world sample:</p><figure><img src="https://www.troyhunt.com/content/images/2022/08/image-11.png" alt="" loading="lazy" width="633" height="468" srcset="https://www.troyhunt.com/content/images/size/w600/2022/08/image-11.png 600w, https://www.troyhunt.com/content/images/2022/08/image-11.png 633w"/></figure><p>Ugh. Nasty stuff, off to hell for them it is, and it all begins with filing the spam into a special folder called &#34;Send Spammer to Password Purgatory&#34;:</p><figure><img src="https://www.troyhunt.com/content/images/2022/08/image-4.png" alt="" loading="lazy" width="430" height="370"/></figure><p>That&#39;s the extent of work involved on a spam-by-spam basis, but let&#39;s peal back the covers and look at what happens next.</p><h3 id="step-2-trigger-a-microsoft-power-automate-flow">Step 2: Trigger a Microsoft Power Automate Flow</h3><p><a href="https://flow.microsoft.com/">Microsoft Power Automate</a> (previously &#34;Microsoft Flow&#34;) is a really neat way of triggering a series of actions based on an event, and there&#39;s a whole lot of connectors built in to make life super easy. Easy on us as the devs, that is, less easy on the spammers because here&#39;s what happens as soon as I file an email in the aforementioned folder:</p><figure><img src="https://www.troyhunt.com/content/images/2022/07/image.png" alt="" loading="lazy" width="600" height="143" srcset="https://www.troyhunt.com/content/images/2022/07/image.png 600w"/></figure><p>Using the built in connector to my Microsoft 365 email account, the presence of a new email in that folder triggers a brand new instance of a flow. Following, I&#39;ve added the &#34;HTTP&#34; connector which enables me to make an outbound request:</p><figure><img src="https://www.troyhunt.com/content/images/2022/07/image-1.png" alt="" loading="lazy" width="600" height="461" srcset="https://www.troyhunt.com/content/images/2022/07/image-1.png 600w"/></figure><p>All this request does is makes a POST to an API on Password Purgatory called &#34;create-hell&#34;. It passes an API key because I don&#39;t want just anyone making these requests as it will create data that will persist at Cloudflare. Speaking of which, let&#39;s look at what happens over there.</p><h3 id="step-3-call-a-cloudflare-worker-and-create-a-record-in-kv">Step 3: Call a Cloudflare Worker and Create a Record in KV</h3><p>Let&#39;s start with some history: Back in the not too distant past, Cloudflare wasn&#39;t a host and instead would just reverse proxy requests through to origin services and do cool stuff with them along the way. This made <a href="https://httpsiseasy.com/">adding HTTPS to any website easy</a> (and free), added heaps of really neat WAF functionality and empowered us to do cool things with caching. But this was all <em>in-transit</em> coolness whilst the app logic, data and vast bulk of the codebase sat at that origin site. <a href="https://www.troyhunt.com/serverless-to-the-max-doing-big-things-for-small-dollars-with-cloudflare-workers-and-azure-functions/">Cloudflare Workers</a> started to change that and suddenly we had code <em>on the edge</em> running in hundreds of nodes around the world, nice and close to our visitors. Did that start to make Cloudflare a &#34;host&#34;? Hmm... but the data itself was still on the origin service (transient caching aside). Fast forward to now and there are <em>multiple</em> options to store data on Cloudflare&#39;s edges including their (presently beta) <a href="https://www.cloudflare.com/products/r2/">R2 service</a>, <a href="https://blog.cloudflare.com/introducing-workers-durable-objects/">Durable Objects</a>, the (forthcoming) <a href="https://blog.cloudflare.com/introducing-d1/">D1 SQL database</a> and of most importance to this blogpost, <a href="https://www.cloudflare.com/products/workers-kv/">Workers KV</a>. Does this make them a host if you can now build entire apps within their environment? Maybe so, but let&#39;s skip the titles for now and focus on the code.</p><p>All the code I&#39;m going to refer to here is open source and available in <a href="https://github.com/troyhunt/password-purgatory-logger">the public Password Purgatory Logger Github repo</a>. Very early on in the index.js file that does all the work, you&#39;ll see a function called &#34;createHell&#34; which is called when the flow step above runs. That code creates a GUID then stores it in KV after which I can easily view it in the Cloudflare dashboard:</p><figure><img src="https://www.troyhunt.com/content/images/2022/08/image-8.png" alt="" loading="lazy" width="783" height="80" srcset="https://www.troyhunt.com/content/images/size/w600/2022/08/image-8.png 600w, https://www.troyhunt.com/content/images/2022/08/image-8.png 783w" sizes="(min-width: 720px) 720px"/></figure><p>There&#39;s no value yet, just a key and it&#39;s returned via a JSON response in a property called &#34;kvKey&#34;. To read that back in the flow, I need a &#34;Parse JSON&#34; step with a schema I generated from a sample:</p><figure><img src="https://www.troyhunt.com/content/images/2022/07/image-2.png" alt="" loading="lazy" width="600" height="421" srcset="https://www.troyhunt.com/content/images/2022/07/image-2.png 600w"/></figure><p>At this point I now have a unique ID in persistent storage and it&#39;s available in the flow, which means it&#39;s time to send the spammer an email.</p><h3 id="step-4-invite-the-spammer-to-hell">Step 4: Invite the Spammer to Hell</h3><p>Because it would be rude not to respond, I&#39;d like to send the spammer back an email and invite them to my <em>very </em>special registration form. To do this, I&#39;ve grabbed the &#34;Reply to email&#34; connector and fed the kvKey through to a hyperlink:</p><figure><img src="https://www.troyhunt.com/content/images/2022/08/image-1.png" alt="" loading="lazy" width="600" height="680" srcset="https://www.troyhunt.com/content/images/2022/08/image-1.png 600w"/></figure><p>It&#39;s an HTML email with the key hidden within the hyperlink tag so it doesn&#39;t look overtly weird. Using this connector means that when the email sends, it looks precisely like I&#39;ve lovingly crafted it myself:</p><figure><img src="https://www.troyhunt.com/content/images/2022/08/image-12.png" alt="" loading="lazy" width="600" height="556" srcset="https://www.troyhunt.com/content/images/2022/08/image-12.png 600w"/></figure><p>With the entire flow now executed, we can view the history of each step and see how the data moves between them:</p><figure><img src="https://www.troyhunt.com/content/images/2022/08/flow.png" alt="" loading="lazy" width="677" height="2635" srcset="https://www.troyhunt.com/content/images/size/w600/2022/08/flow.png 600w, https://www.troyhunt.com/content/images/2022/08/flow.png 677w"/></figure><p>Now, we play the waiting game ðŸ˜Š</p><h3 id="step-5-log-spammer-pain">Step 5: Log Spammer Pain</h3><p>Wasting spammer time in and of itself is good. Causing them pain by having them attempt to pass increasingly obtuse password complexity criteria is better. But the best thing - <em>the piÃ¨ce de rÃ©sistance</em> - is to log that pain and share it publicly for our collective entertainment ðŸ¤£</p><p>So, by following the link the spammer ends up <a href="https://www.troyhunt.com/partnerships/?kvKey=f63c7e81-b27b-4328-a707-5f0cd50de632">here</a> (you&#39;re welcome to follow that link and have a play with it):</p><figure><img src="https://www.troyhunt.com/content/images/2022/08/Photo-4-8-2022--06-23-05.jpg" alt="" loading="lazy" width="1200" height="1002" srcset="https://www.troyhunt.com/content/images/size/w600/2022/08/Photo-4-8-2022--06-23-05.jpg 600w, https://www.troyhunt.com/content/images/size/w1000/2022/08/Photo-4-8-2022--06-23-05.jpg 1000w, https://www.troyhunt.com/content/images/2022/08/Photo-4-8-2022--06-23-05.jpg 1200w" sizes="(min-width: 720px) 720px"/></figure><p>The kvKey is passed via the query string and the page invites the spammer to begin the process of becoming a partner. All they need to leave is an email address... and a password. That page then embeds 2 scripts from the Password Purgatory website, both of which you can find in <a href="https://github.com/troyhunt/password-purgatory">the open source and public Github repository I created in the original blog post</a>. Each attempt at creating an account sends off <em>the password only</em> to the original Password Purgatory API I created months ago, after which it responds with the next set of criteria. But each attempt also sends off both the criteria that was presented (none on the first go, then something increasingly bizarre on each subsequent go), the password they tried to use to satisfy the criteria <em>and</em> the kvKey so it can all be tied together. What that means is that the Cloudflare Workers KV entry created earlier gradually builds up as follows:</p><figure><img src="https://www.troyhunt.com/content/images/2022/08/image-6.png" alt="" loading="lazy" width="1242" height="150" srcset="https://www.troyhunt.com/content/images/size/w600/2022/08/image-6.png 600w, https://www.troyhunt.com/content/images/size/w1000/2022/08/image-6.png 1000w, https://www.troyhunt.com/content/images/2022/08/image-6.png 1242w" sizes="(min-width: 720px) 720px"/></figure><p>There are a couple of little conditions built into the code:</p><ol><li>If a kvKey is passed in the log request that doesn&#39;t actually exist on Cloudflare, HTTP 404 is returned. This is to ensure randos out there don&#39;t attempt to submit junk logs into KV.</li><li>Once the first password is logged, there&#39;s a 15 minute window within which any further passwords can be logged. The reason is twofold: firstly, I don&#39;t want to share the spammers attempts publicly until I&#39;m confident no more passwords can be logged just in case they add PII or something else inappropriate. Secondly, once they know the value of the kvKey a non-spammer could start submitting logs (for example, when I tweet it later on or share it via this blog post).</li></ol><p>That&#39;s everything needed to lure the spammer in and record their pain, now for the really fun bit ðŸ˜Š</p><h3 id="step-6-enjoy-revelling-in-spammer-pain">Step 6: Enjoy Revelling in Spammer Pain</h3><p>The very first time the spammer&#39;s password attempt is logged, the Cloudflare Worker sends me an email to let me know I have a new spammer hooked (<a href="https://blog.mailchannels.com/mailchannels-enables-free-email-sending-for-cloudflare-workers-customers">this capability using MailChannels only launched this year</a>):</p><figure><img src="https://www.troyhunt.com/content/images/2022/08/image-10.png" alt="" loading="lazy" width="646" height="230" srcset="https://www.troyhunt.com/content/images/size/w600/2022/08/image-10.png 600w, https://www.troyhunt.com/content/images/2022/08/image-10.png 646w"/></figure><p>It was so exciting getting this email yesterday, I swear it&#39;s the same sensation as literally getting a fish on your line! That link is one I can share to put the spammer&#39;s pain on display for the world to see. This is achieved with another Cloudflare Workers route that simply pulls out the logs for the given kvKey <a href="https://passwordpurgatory.com/get-hell?kvKey=f63c7e81-b27b-4328-a707-5f0cd50de632">and formats it neatly in an HTML response</a>:</p><figure><img src="https://www.troyhunt.com/content/images/2022/08/Photo-4-8-2022--06-28-49.jpg" alt="" loading="lazy" width="1200" height="1226" srcset="https://www.troyhunt.com/content/images/size/w600/2022/08/Photo-4-8-2022--06-28-49.jpg 600w, https://www.troyhunt.com/content/images/size/w1000/2022/08/Photo-4-8-2022--06-28-49.jpg 1000w, https://www.troyhunt.com/content/images/2022/08/Photo-4-8-2022--06-28-49.jpg 1200w" sizes="(min-width: 720px) 720px"/></figure><p>Ah, satisfaction ðŸ˜Š I listed the amount of time the spammer burned with a goal to further refining the complexity criteria in the future to attempt to keep them &#34;hooked&#34; for longer. Is the requirement for a US post code in the password a bit to geographically specific, for example? Time will tell and I wholeheartedly welcome PRs to that effect in <a href="https://github.com/troyhunt/password-purgatory-api">the original Password Purgatory API repo</a>.</p><p>Oh - and just to ensure traction and exposure are maximised, there&#39;s a neatly formatted Twitter card that includes the last criteria and password used, you know, the ones that finally broke the spammer&#39;s spirit and caused them to give up:</p><blockquote><p lang="en" dir="ltr">Spammer burned a total of 80 seconds in Password Purgatory ðŸ˜ˆ <a href="https://twitter.com/hashtag/PasswordPurgatory?src=hash&amp;ref_src=twsrc%5Etfw">#PasswordPurgatory</a> <a href="https://t.co/VwSCHNZ2AW">https://t.co/VwSCHNZ2AW</a></p>â€” Troy Hunt (@troyhunt) <a href="https://twitter.com/troyhunt/status/1554937322784772096?ref_src=twsrc%5Etfw">August 3, 2022</a></blockquote> <h3 id="summary">Summary</h3><p>Clearly, I&#39;ve taken a great deal of pleasure in messing with spammers and I hope you do too. I&#39;ve gotta be honest - I&#39;ve never been so excited to go through my junk mail! But I also thoroughly enjoyed putting this together with Power Automate and Workers KV, I think it&#39;s super cool that you can pull an app together like this with a combination of browser-based config plus code and storage that runs directly in hundreds of globally distributed edge nodes around the world. I hope the spammers appreciate just how elegant this all is ðŸ¤£</p>
<section>
<a href="https://www.troyhunt.com/tag/cloudflare/">Cloudflare</a>
</section>
</section><div>
<section>
<a href="https://twitter.com/share?text=Troy%20Hunt%3A%20Sending%20Spammers%20to%20Password%20Purgatory%20with%20Microsoft%20Power%20Automate%20and%20Cloudflare%20Workers%20KV&amp;url=https://www.troyhunt.com/sending-spammers-to-password-purgatory-with-microsoft-power-automate-and-cloudflare-workers-kv/"><i></i> Tweet</a>
<a href="https://www.facebook.com/sharer/sharer.php?u=https://www.troyhunt.com/sending-spammers-to-password-purgatory-with-microsoft-power-automate-and-cloudflare-workers-kv/"><i></i> Post</a>
<a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://www.troyhunt.com/sending-spammers-to-password-purgatory-with-microsoft-power-automate-and-cloudflare-workers-kv/"><i></i> Update</a>
<a href="mailto:?subject=Troy%20Hunt%3A%20Sending%20Spammers%20to%20Password%20Purgatory%20with%20Microsoft%20Power%20Automate%20and%20Cloudflare%20Workers%20KV&amp;body=https://www.troyhunt.com/sending-spammers-to-password-purgatory-with-microsoft-power-automate-and-cloudflare-workers-kv/"><i></i> Email</a>
<a href="https://feeds.feedburner.com/TroyHunt"> RSS</a>
</section>
<section>

<div>
<h5 itemprop="author" itemscope="" itemtype="http://schema.org/Person">Troy Hunt</h5>
<p>Hi, I&#39;m Troy Hunt, I write this blog, create courses for Pluralsight and am a Microsoft Regional Director and MVP who travels the world speaking at events and training technology professionals <a href="https://www.troyhunt.com/about"></a></p>
</div>
</section>




</div></div>
  </body>
</html>
