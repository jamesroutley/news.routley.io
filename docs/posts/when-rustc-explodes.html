<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://fasterthanli.me/articles/when-rustc-explodes">Original</a>
    <h1>When rustc explodes</h1>
    
    <div id="readability-page-1" class="page"><div>
  

  
    
      
    
  

  <p>One could say I have a bit of an obsession with build times.</p>
<p>I believe having a &#34;tight feedback loop&#34; is <em>extremely</em> valuable: when I work
on a large codebase, I want to be able to make small incremental changes and
check very often that things are going as expected.</p>
<p>Especially if I&#39;m working on a project that needs to move quickly: say, the
product for an early-stage startup, or a side-project for which I only ever get
to do 1-hour work bursts at most.</p>
<p>There&#39;s a lot about engineering that we need to endure: a lot of problems have
inherent complexity. Coordination across humans is hard, and it&#39;s lossy. It&#39;s
really tricky to strike the right balance between &#34;not enough testing&#34; and
&#34;<a href="https://en.wikipedia.org/wiki/Ossification">ossifying</a> the codebase&#34; (making it harder to change its
structure later).</p>
<p>But there&#39;s things we <em>don&#39;t</em> need to suffer. And one of them is &#34;watching the
compiler go brrrr&#34; for excessive amounts of time.</p>

                        <h2>
                            <a id="previously-on-this-here-site" href="#previously-on-this-here-site">
                                Previously, on this here site
                            </a>
                        </h2>
                        
<p>Of course, everyone has their own definition of &#34;excessive&#34;. I&#39;ve been in
multiple discussions where I&#39;ve argued Rust compile times aren&#39;t <em>that</em> bad, and
then they&#39;ll tell me &#34;okay but some projects at work take over 2 hours to
compile&#34;, to which my response is &#34;oh wow no that&#39;s bonkers actually, <em>how the
heck did y&#39;all do that</em>?&#34;</p>
<p>And that&#39;s what makes it so hard to discuss these kind of things online: <em>you</em>
may have it good. It might work great for you. But someone else might be having
a really poor time with it, for quite some time now, and they&#39;ve just resigned
themselves that &#34;that&#39;s how it is I guess&#34;.</p>
<p>It&#39;s often proprietary codebases, too, so short of being hired, there&#39;s few
opportunities for someone to come in, look at the absolute state of their CI
pipelines and go &#34;damn, you really live like this?&#34;.</p>
<p>So I wrote <a href="https://jvns.ca/articles/why-is-my-rust-build-so-slow">Why is my Rust build so
slow</a>, in which we reviewed things like:</p>
<ul>
<li>What cargo actually does (it invokes <code>rustc</code>, takes care of conditional
compilation, caching, downloading dependencies, and a thousand other things)</li>
<li>How much time is being spent compiling each crate? What kind of dependencies
are there, and what concurrency do we achieve? (with <code>--timings</code>, stable <a href="https://doc.rust-lang.org/cargo/reference/unstable.html#timings">as of Rust 1.60</a>)</li>
<li>Using a faster linker, like LLVM lld, or <a href="https://github.com/rui314/mold">mold</a>.</li>
<li>The cost of debug information (<code>debug = true</code> or <code>debug = 2</code>, vs <code>debug = 1</code> or <code>debug = 0</code>).</li>
<li>Incremental compilation (<code>incremental = true</code> in <code>Cargo.toml</code>), enabled by default for debug
builds except those few times where it was broken and thus disabled in stable Rust</li>
<li>The cost of LTO (link-time optimization), and its different flavors: off, thin, &#34;fat&#34;.</li>
<li>rustc self-profiling with <code>-Z self-profile</code>, and the various <a href="https://github.com/rust-lang/measureme">measureme</a> tools: <code>summarize</code>, <code>flamegraph</code>, and <code>crox</code></li>
<li>Looking at <code>crox</code> output with <code>chrome://tracing</code> or <a href="https://ui.perfetto.dev/">Perfetto</a></li>
</ul>
<p>Finally, we found that there was a workaround we could use with the <code>warp</code>
crate, that made our compile times go down significantly. Splitting crates into
smaller crates was also interesting for increased concurrency.</p>
<p>There&#39;s a bunch of other articles that have been written about this topic around
the interwebs, but ultimately most of them fall short: what do you do when
you&#39;ve done all of that, but you still suspect you&#39;re hitting a pathological case
in rustc that makes your build much slower than it ought to be?</p>
<p>What then?</p>
<p>Well, I hit one of these just recently, so, let&#39;s look into it.</p>

                        <h2>
                            <a id="the-offending-code" href="#the-offending-code">
                                The offending code
                            </a>
                        </h2>
                        
<p>Originally, I hit this performance bug with some
<a href="https://lib.rs/crates/tower">tower</a> code. It&#39;s a crate used by
<a href="https://lib.rs/crates/hyper">hyper</a>, itself used by higher-level crates like
<a href="https://lib.rs/crates/warp">warp</a> and <a href="https://lib.rs/crates/axum">axum</a>, so
it&#39;s no coincidence that folks have had build time troubles with all of these.</p>
<p>The crux of the problem is &#34;gee grandma, what big types you have there&#34;,
because... essentially, tower is a couple of important traits.</p>
<p>Here&#39;s one:</p>
<div><p>Rust code</p><pre data-lang="rust"><i>pub</i> <i>trait</i> <i>Service</i><i>&lt;</i><i>Request</i><i>&gt;</i> {
    <i>type</i> <i>Response</i><i>;</i>
    <i>type</i> <i>Error</i><i>;</i>
    <i>type</i> <i>Future</i>: <i>Future</i><i>&lt;</i><i>Output</i> = <i>Result</i><i>&lt;</i>Self<i>::</i><i>Response</i>, Self<i>::</i><i>Error</i><i>&gt;</i><i>&gt;</i><i>;</i>

    <i>fn</i> <i>poll_ready</i><i>(</i><i>&amp;</i><i>mut</i> <i>self</i>, <i>cx</i>: <i>&amp;</i><i>mut</i> <i>Context</i><i>&lt;</i><i>&#39;</i><i>_</i><i>&gt;</i><i>)</i> -&gt; <i>Poll</i><i>&lt;</i><i>Result</i><i>&lt;</i><i>(</i><i>)</i>, Self<i>::</i><i>Error</i><i>&gt;</i><i>&gt;</i><i>;</i>
    <i>fn</i> <i>call</i><i>(</i><i>&amp;</i><i>mut</i> <i>self</i>, <i>req</i>: <i>Request</i><i>)</i> -&gt; Self<i>::</i><i>Future</i><i>;</i>
}
</pre></div>
<p>And the basic idea is &#34;oh shit we don&#39;t have async trait methods&#34; (hence the
<code>Future</code> associated type) but also &#34;backpressure is love, backpressure is life&#34;,
by way of the <code>poll_ready</code> method.</p>
<p>What happens is you hand <code>hyper</code> a <code>Service&lt;Request&gt;</code>, and for each new HTTP
request it first calls <code>poll_ready</code> until it returns <code>Poll::Ready</code>. It doesn&#39;t
do that in a loop: it knows when to try again because in <code>poll_ready</code>, if we
weren&#39;t ready, we registered ourselves with the
<a href="https://doc.rust-lang.org/stable/std/task/struct.Waker.html">Waker</a> that&#39;s 
hidden in the <code>Context</code>, so we know when... a socket is ready to be written to /
read from, or a timer has elapsed, or some semaphore has more permits
available... and that&#39;s how async Rust works, more or less!</p>
<div>

<p>Wow, most concise explanation yet!</p>
</div>
<p>Yes, and completely opaque to anyone who doesn&#39;t already know how it works. But
that doesn&#39;t matter much for this article. Once <code>poll_ready</code> has returned
<code>Poll::Ready</code>, then <code>call</code> can be called, and it returns a <code>Future</code>, which is
spawned as a background task, and then the request can be handled asynchronously.</p>
<p>Because we don&#39;t have &#34;async trait methods&#34;, ie. the trait can&#39;t just be this:</p>
<div><p>Rust code</p><pre data-lang="rust"><i>pub</i> <i>trait</i> <i>Service</i><i>&lt;</i><i>Request</i><i>&gt;</i> {
    <i>type</i> <i>Response</i><i>;</i>
    <i>type</i> <i>Error</i><i>;</i>

    async <i>fn</i> <i>poll_ready</i><i>(</i><i>&amp;</i><i>self</i><i>)</i> -&gt; <i>Result</i><i>&lt;</i><i>(</i><i>)</i>, Self<i>::</i><i>Error</i><i>&gt;</i><i>;</i>
    async <i>fn</i> <i>call</i><i>(</i><i>&amp;</i><i>self</i>, <i>req</i>: <i>Request</i><i>)</i> -&gt; <i>Result</i><i>&lt;</i>Self<i>::</i><i>Response</i>, Self<i>::</i><i>Error</i><i>&gt;</i><i>;</i>
}
</pre></div>
<p>...we have this <code>Future</code> associated type:</p>
<div><p>Rust code</p><pre data-lang="rust">    <i>type</i> <i>Future</i>: <i>Future</i><i>&lt;</i><i>Output</i> = <i>Result</i><i>&lt;</i>Self<i>::</i><i>Response</i>, Self<i>::</i><i>Error</i><i>&gt;</i><i>&gt;</i><i>;</i>
</pre></div>
<p>And most of the time, that&#39;s gonna end up being a boxed future, especially if
you&#39;re using async blocks.</p>
<p>So, often, your service ends up looking something like this:</p>
<div><p>Rust code</p><pre data-lang="rust"><i>use</i> hyper<i>::</i>{Body, Request, Response}<i>;</i>
<i>use</i> std<i>::</i>{
    convert<i>::</i>Infallible,
    future<i>::</i>Future,
    pin<i>::</i>Pin,
    task<i>::</i>{Context, Poll},
    time<i>::</i>Duration,
}<i>;</i>
<i>use</i> tokio<i>::</i>time<i>::</i>sleep<i>;</i>
<i>use</i> tower<i>::</i>Service<i>;</i>

<i>struct</i> <i>MyService</i><i>;</i>

<i>impl</i> <i>Service</i><i>&lt;</i><i>Request</i><i>&lt;</i><i>Body</i><i>&gt;</i><i>&gt;</i> <i>for</i> <i>MyService</i> {
    <i>type</i> <i>Response</i> = <i>Response</i><i>&lt;</i><i>Body</i><i>&gt;</i><i>;</i>
    <i>type</i> <i>Error</i> = <i>Infallible</i><i>;</i>
    <i>type</i> <i>Future</i> = <i>Pin</i><i>&lt;</i><i>Box</i><i>&lt;</i><i>dyn</i> <i>Future</i><i>&lt;</i><i>Output</i> = <i>Result</i><i>&lt;</i>Self<i>::</i><i>Response</i>, Self<i>::</i><i>Error</i><i>&gt;</i><i>&gt;</i><i>&gt;</i><i>&gt;</i><i>;</i>

    <i>fn</i> <i>poll_ready</i><i>(</i><i>&amp;</i><i>mut</i> <i>self</i>, <i>_cx</i>: <i>&amp;</i><i>mut</i> <i>Context</i><i>&lt;</i><i>&#39;</i><i>_</i><i>&gt;</i><i>)</i> -&gt; <i>Poll</i><i>&lt;</i><i>Result</i><i>&lt;</i><i>(</i><i>)</i>, Self<i>::</i><i>Error</i><i>&gt;</i><i>&gt;</i> {
        <i>// we don&#39;t apply any backpressure here, so always ready</i>
        <i>Poll</i><i>::</i>Ready<i>(</i>Ok<i>(</i><i>(</i><i>)</i><i>)</i><i>)</i>
    }

    <i>fn</i> <i>call</i><i>(</i><i>&amp;</i><i>mut</i> <i>self</i>, <i>req</i>: <i>Request</i><i>&lt;</i><i>Body</i><i>&gt;</i><i>)</i> -&gt; Self<i>::</i><i>Future</i> {
        <i>Box</i><i>::</i><i>pin</i><i>(</i>async <i>move</i> {
            <i>// imagine we&#39;re fetching data from an API instead</i>
            <i>sleep</i><i>(</i><i>Duration</i><i>::</i><i>from_millis</i><i>(</i><i>250</i><i>)</i><i>)</i><i>.</i>await<i>;</i>

            <i>let</i> body = <i>format</i><i>!</i><i>(</i><i>&#34;you&#39;ve requested {:?}&#34;</i>, req.uri<i>(</i><i>)</i><i>)</i><i>;</i>
            <i>let</i> res = <i>Response</i><i>::</i><i>builder</i><i>(</i><i>)</i><i>.</i><i>body</i><i>(</i><i>Body</i><i>::</i><i>from</i><i>(</i>body<i>)</i><i>)</i><i>.</i><i>unwrap</i><i>(</i><i>)</i><i>;</i>
            Ok<i>(</i>res<i>)</i>
        }<i>)</i>
    }
}
</pre></div>
<p>And, ridiculous verbosity aside, the nice thing about this is that you can
compose those services. So we might take that &#34;sleeping for 250ms&#34; functionality
and move it into another service, like so:</p>
<div><p>Rust code</p><pre data-lang="rust"><i>use</i> hyper<i>::</i>{Body, Request, Response}<i>;</i>
<i>use</i> std<i>::</i>{
    convert<i>::</i>Infallible,
    future<i>::</i>Future,
    pin<i>::</i>Pin,
    task<i>::</i>{Context, Poll},
    time<i>::</i>Duration,
}<i>;</i>
<i>use</i> tokio<i>::</i>time<i>::</i>sleep<i>;</i>
<i>use</i> tower<i>::</i>Service<i>;</i>

<i>struct</i> <i>SleepService</i><i>&lt;</i><i>S</i><i>&gt;</i> {
    <i>inner</i>: <i>S</i>,
}

<i>impl</i><i>&lt;</i><i>S</i>, <i>Req</i><i>&gt;</i> <i>Service</i><i>&lt;</i><i>Req</i><i>&gt;</i> <i>for</i> <i>SleepService</i><i>&lt;</i><i>S</i><i>&gt;</i>
<i>where</i>
    <i>S</i>: <i>Service</i><i>&lt;</i><i>Req</i><i>&gt;</i>,
    &lt;<i>S</i> <i>as</i> <i>Service</i><i>&lt;</i><i>Req</i><i>&gt;</i>&gt;<i>::</i><i>Future</i>: <i>&#39;</i><i>static</i>,
{
    <i>type</i> <i>Response</i> = S<i>::</i><i>Response</i><i>;</i>
    <i>type</i> <i>Error</i> = S<i>::</i><i>Error</i><i>;</i>
    <i>type</i> <i>Future</i> = <i>Pin</i><i>&lt;</i><i>Box</i><i>&lt;</i><i>dyn</i> <i>Future</i><i>&lt;</i><i>Output</i> = <i>Result</i><i>&lt;</i>Self<i>::</i><i>Response</i>, Self<i>::</i><i>Error</i><i>&gt;</i><i>&gt;</i><i>&gt;</i><i>&gt;</i><i>;</i>

    <i>fn</i> <i>poll_ready</i><i>(</i><i>&amp;</i><i>mut</i> <i>self</i>, <i>cx</i>: <i>&amp;</i><i>mut</i> <i>Context</i><i>&lt;</i><i>&#39;</i><i>_</i><i>&gt;</i><i>)</i> -&gt; <i>Poll</i><i>&lt;</i><i>Result</i><i>&lt;</i><i>(</i><i>)</i>, Self<i>::</i><i>Error</i><i>&gt;</i><i>&gt;</i> {
        <i>self</i><i>.</i><i>inner</i><i>.</i><i>poll_ready</i><i>(</i>cx<i>)</i>
    }

    <i>fn</i> <i>call</i><i>(</i><i>&amp;</i><i>mut</i> <i>self</i>, <i>req</i>: <i>Req</i><i>)</i> -&gt; Self<i>::</i><i>Future</i> {
        <i>let</i> fut = <i>self</i><i>.</i><i>inner</i><i>.</i><i>call</i><i>(</i>req<i>)</i><i>;</i>

        <i>Box</i><i>::</i><i>pin</i><i>(</i>async <i>move</i> {
            <i>// imagine we&#39;re fetching data from an API instead</i>
            <i>sleep</i><i>(</i><i>Duration</i><i>::</i><i>from_millis</i><i>(</i><i>250</i><i>)</i><i>)</i><i>.</i>await<i>;</i>

            fut<i>.</i>await
        }<i>)</i>
    }
}

<i>struct</i> <i>MyService</i><i>;</i>

<i>impl</i> <i>Service</i><i>&lt;</i><i>Request</i><i>&lt;</i><i>Body</i><i>&gt;</i><i>&gt;</i> <i>for</i> <i>MyService</i> {
    <i>type</i> <i>Response</i> = <i>Response</i><i>&lt;</i><i>Body</i><i>&gt;</i><i>;</i>
    <i>type</i> <i>Error</i> = <i>Infallible</i><i>;</i>
    <i>// this future is no longer boxed! it&#39;s a future that immediately completes.</i>
    <i>type</i> <i>Future</i> = std<i>::</i>future<i>::</i><i>Ready</i><i>&lt;</i><i>Result</i><i>&lt;</i>Self<i>::</i><i>Response</i>, Self<i>::</i><i>Error</i><i>&gt;</i><i>&gt;</i><i>;</i>

    <i>fn</i> <i>poll_ready</i><i>(</i><i>&amp;</i><i>mut</i> <i>self</i>, <i>_cx</i>: <i>&amp;</i><i>mut</i> <i>Context</i><i>&lt;</i><i>&#39;</i><i>_</i><i>&gt;</i><i>)</i> -&gt; <i>Poll</i><i>&lt;</i><i>Result</i><i>&lt;</i><i>(</i><i>)</i>, Self<i>::</i><i>Error</i><i>&gt;</i><i>&gt;</i> {
        <i>Poll</i><i>::</i>Ready<i>(</i>Ok<i>(</i><i>(</i><i>)</i><i>)</i><i>)</i>
    }

    <i>fn</i> <i>call</i><i>(</i><i>&amp;</i><i>mut</i> <i>self</i>, <i>req</i>: <i>Request</i><i>&lt;</i><i>Body</i><i>&gt;</i><i>)</i> -&gt; Self<i>::</i><i>Future</i> {
        <i>let</i> body = <i>format</i><i>!</i><i>(</i><i>&#34;you&#39;ve requested {:?}&#34;</i>, req.uri<i>(</i><i>)</i><i>)</i><i>;</i>
        <i>let</i> res = <i>Response</i><i>::</i><i>builder</i><i>(</i><i>)</i><i>.</i><i>body</i><i>(</i><i>Body</i><i>::</i><i>from</i><i>(</i>body<i>)</i><i>)</i><i>.</i><i>unwrap</i><i>(</i><i>)</i><i>;</i>
        std<i>::</i>future<i>::</i><i>ready</i><i>(</i>Ok<i>(</i>res<i>)</i><i>)</i>
    }
}
</pre></div>
<p>And that&#39;s neat because now you can separate concerns cleanly across multiple
services: some will rate-limit, some will retry, some will handle errors, etc.</p>
<p>And the end result is that the service you hand to <code>hyper</code> isn&#39;t merely
<code>MyService</code>, it&#39;s something like:</p>
<div><p>Rust code</p><pre data-lang="rust"><i>type</i> <i>ServiceStack</i> = <i>Trace</i><i>&lt;</i>
  <i>WebSocketUpgrade</i><i>&lt;</i>
    <i>UpstreamTimings</i><i>&lt;</i>
      <i>CompressResponse</i><i>&lt;</i>
        <i>PrepareRequest</i><i>&lt;</i>
          <i>HandleErrors</i><i>&lt;</i>
            <i>HttpsRedirect</i><i>&lt;</i>
              <i>Balancer</i><i>&lt;</i>
                <i>Retry</i><i>&lt;</i>
                  <i>MyService</i>
                <i>&gt;</i>
              <i>&gt;</i>
            <i>&gt;</i>
          <i>&gt;</i>
        <i>&gt;</i>
      <i>&gt;</i>
    <i>&gt;</i>
  <i>&gt;</i>
<i>&gt;</i><i>;</i>
</pre></div>
<p>Thankfully, <code>tower</code> provides <em>another</em> type, <code>Layer</code>, which turns the former
into something like:</p>
<div><p>Rust code</p><pre data-lang="rust"><i>let</i> service = <i>ServiceBuilder</i><i>::</i><i>new</i><i>(</i><i>)</i>
  <i>.</i><i>layer</i><i>(</i>TraceLayer<i>)</i>
  <i>.</i><i>layer</i><i>(</i>WebSocketUpgradeLayer<i>)</i>
  <i>.</i><i>layer</i><i>(</i>UpstreamTimingsLayer<i>)</i>
  <i>.</i><i>layer</i><i>(</i>CompressResponseLayer<i>)</i>
  <i>.</i><i>layer</i><i>(</i>PrepareRequestLayer<i>)</i>
  <i>.</i><i>layer</i><i>(</i>HandleErrorsLayer<i>)</i>
  <i>.</i><i>layer</i><i>(</i>HttpsRedirectLayer<i>)</i>
  <i>.</i><i>layer</i><i>(</i>BalancerLayer<i>)</i>
  <i>.</i><i>layer</i><i>(</i>RetryLayer<i>)</i>
  <i>.</i><i>service</i><i>(</i>MyService<i>)</i><i>;</i>
</pre></div>
<p>Which is nicer to read, if you can remember that it goes <code>outer -&gt; inner</code>. But
it still builds the same gigantic type.</p>
<p>One downside is that the type errors you get with these can be <em>gnarly</em>.
Learning to address those is a bit of a special skill I&#39;ve acquired, and I&#39;m not
sure it should be a prerequisite.</p>
<p>And another downside is that these large types tend to hit corner cases in rustc
(the rust compiler) that are... slow. Really slow. Exponentially slower as you
add more layers to your service stack in fact.</p>
<p>And I think we&#39;ve had quite enough of <code>tower</code> for one article, so I&#39;m going to
move on to the small repro case that <a href="https://github.com/eddyb">eddyb</a> made from
my already-small repro case.</p>

                        <h2>
                            <a id="the-repro-case" href="#the-repro-case">
                                The repro case
                            </a>
                        </h2>
                        
<p>Stolen directly from <a href="https://github.com/rust-lang/rust/issues/99188">rust issue
99188</a>, here it is:</p>
<div><p>Rust code</p><pre data-lang="rust"><i>trait</i> <i>Trait</i><i>&lt;</i><i>&#39;</i><i>a</i><i>&gt;</i> {
    <i>type</i> <i>A</i><i>;</i>
    <i>type</i> <i>B</i><i>;</i>
    <i>type</i> <i>C</i><i>;</i>
    <i>type</i> <i>D</i><i>;</i>

    <i>fn</i> <i>method</i><i>(</i><i>)</i> {}
}

<i>impl</i><i>&lt;</i><i>T</i><i>&gt;</i> <i>Trait</i><i>&lt;</i><i>&#39;</i><i>_</i><i>&gt;</i> <i>for</i> <i>&amp;</i><i>&#39;</i><i>_</i> <i>T</i>
<i>where</i>
    <i>for</i><i>&lt;</i><i>&#39;</i><i>x</i><i>&gt;</i> <i>T</i>: <i>Trait</i><i>&lt;</i><i>&#39;</i><i>x</i>, <i>A</i> = <i>(</i><i>)</i>, <i>B</i> = <i>(</i><i>)</i>, <i>C</i> = <i>(</i><i>)</i>, <i>D</i> = <i>(</i><i>)</i><i>&gt;</i>,
{
    <i>type</i> <i>A</i> = <i>(</i><i>)</i><i>;</i>
    <i>type</i> <i>B</i> = <i>(</i><i>)</i><i>;</i>
    <i>type</i> <i>C</i> = <i>(</i><i>)</i><i>;</i>
    <i>type</i> <i>D</i> = <i>(</i><i>)</i><i>;</i>
}

<i>impl</i> <i>Trait</i><i>&lt;</i><i>&#39;</i><i>_</i><i>&gt;</i> <i>for</i> <i>(</i><i>)</i> {
    <i>type</i> <i>A</i> = <i>(</i><i>)</i><i>;</i>
    <i>type</i> <i>B</i> = <i>(</i><i>)</i><i>;</i>
    <i>type</i> <i>C</i> = <i>(</i><i>)</i><i>;</i>
    <i>type</i> <i>D</i> = <i>(</i><i>)</i><i>;</i>
}

<i>pub</i> <i>fn</i> <i>main</i><i>(</i><i>)</i> {
    <i>#<i>[</i>cfg<i>(</i>depth = <i>&#34;7&#34;</i><i>)</i><i>]</i></i>
    &lt;<i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>(</i><i>)</i> <i>as</i> <i>Trait</i>&gt;<i>::</i><i>method</i><i>(</i><i>)</i><i>;</i>
    <i>#<i>[</i>cfg<i>(</i>depth = <i>&#34;8&#34;</i><i>)</i><i>]</i></i>
    &lt;<i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>(</i><i>)</i> <i>as</i> <i>Trait</i>&gt;<i>::</i><i>method</i><i>(</i><i>)</i><i>;</i>
    <i>#<i>[</i>cfg<i>(</i>depth = <i>&#34;9&#34;</i><i>)</i><i>]</i></i>
    &lt;<i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>(</i><i>)</i> <i>as</i> <i>Trait</i>&gt;<i>::</i><i>method</i><i>(</i><i>)</i><i>;</i>
    <i>#<i>[</i>cfg<i>(</i>depth = <i>&#34;10&#34;</i><i>)</i><i>]</i></i>
    &lt;<i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>(</i><i>)</i> <i>as</i> <i>Trait</i>&gt;<i>::</i><i>method</i><i>(</i><i>)</i><i>;</i>
}
</pre></div>
<p>What&#39;s neat about having a self-contained repro case like that (no dependencies,
single file) is that we can call <code>rustc</code> directly instead of calling <code>cargo</code>.</p>
<p>So first, let&#39;s check that we have pathological behavior thanks to those neat
<code>cfg</code> attributes there. We&#39;ll pass <code>--emit=metadata</code> to rustc so that it doesn&#39;t
do full codegen with LLVM. I <em>think</em> this is close to <code>cargo check</code>? Unsure.</p>
<div><p>Shell session</p><pre data-lang="shell">$ command time -f &#39;took %Us&#39; rustc src/main.rs --emit=metadata --cfg &#39;depth = &#34;7&#34;&#39;
took 0.17s
$ command time -f &#39;took %Us&#39; rustc src/main.rs --emit=metadata --cfg &#39;depth = &#34;8&#34;&#39;
took 0.76s
$ command time -f &#39;took %Us&#39; rustc src/main.rs --emit=metadata --cfg &#39;depth = &#34;9&#34;&#39;
took 3.38s
$ command time -f &#39;took %Us&#39; rustc src/main.rs --emit=metadata --cfg &#39;depth = &#34;10&#34;&#39;
took 15.53s
</pre></div>
<p>We&#39;re doing this on stable at the time of this writing, btw:</p>
<div><p>Shell session</p><pre data-lang="shell">$ rustc --version
rustc 1.62.0 (a8314ef7d 2022-06-27)
</pre></div>
<p>So yeah, every time you add one level of nesting, it gets 4x slower. So compile
time is <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext> </mtext><msup><mn>4</mn><mi>x</mi></msup></mrow><annotation encoding="application/x-tex">,4^x</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span></span><span><span>4</span><span><span><span><span><span><span></span><span><span>x</span></span></span></span></span></span></span></span></span></span></span> , where <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span>x</span></span></span></span> is the level of nesting — that&#39;s exponential growth
(the bad kind).</p>
<p>But why? Where is it spending time? <em>What is going on?</em></p>
<p>Let&#39;s find out.</p>
<p>But before we do, to keep things manageable, let&#39;s add more <code>cfg</code>s with smaller
values, like so:</p>
<div><p>Rust code</p><pre data-lang="rust"><i>pub</i> <i>fn</i> <i>main</i><i>(</i><i>)</i> {
    <i>#<i>[</i>cfg<i>(</i>depth = <i>&#34;1&#34;</i><i>)</i><i>]</i></i>
    &lt;<i>&amp;</i><i>(</i><i>)</i> <i>as</i> <i>Trait</i>&gt;<i>::</i><i>method</i><i>(</i><i>)</i><i>;</i>
    <i>#<i>[</i>cfg<i>(</i>depth = <i>&#34;2&#34;</i><i>)</i><i>]</i></i>
    &lt;<i>&amp;</i><i>&amp;</i><i>(</i><i>)</i> <i>as</i> <i>Trait</i>&gt;<i>::</i><i>method</i><i>(</i><i>)</i><i>;</i>
    <i>#<i>[</i>cfg<i>(</i>depth = <i>&#34;3&#34;</i><i>)</i><i>]</i></i>
    &lt;<i>&amp;</i><i>&amp;</i><i>&amp;</i><i>(</i><i>)</i> <i>as</i> <i>Trait</i>&gt;<i>::</i><i>method</i><i>(</i><i>)</i><i>;</i>
    <i>#<i>[</i>cfg<i>(</i>depth = <i>&#34;4&#34;</i><i>)</i><i>]</i></i>
    &lt;<i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>(</i><i>)</i> <i>as</i> <i>Trait</i>&gt;<i>::</i><i>method</i><i>(</i><i>)</i><i>;</i>
    <i>#<i>[</i>cfg<i>(</i>depth = <i>&#34;5&#34;</i><i>)</i><i>]</i></i>
    &lt;<i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>(</i><i>)</i> <i>as</i> <i>Trait</i>&gt;<i>::</i><i>method</i><i>(</i><i>)</i><i>;</i>
    <i>#<i>[</i>cfg<i>(</i>depth = <i>&#34;6&#34;</i><i>)</i><i>]</i></i>
    &lt;<i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>(</i><i>)</i> <i>as</i> <i>Trait</i>&gt;<i>::</i><i>method</i><i>(</i><i>)</i><i>;</i>
    <i>#<i>[</i>cfg<i>(</i>depth = <i>&#34;7&#34;</i><i>)</i><i>]</i></i>
    &lt;<i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>(</i><i>)</i> <i>as</i> <i>Trait</i>&gt;<i>::</i><i>method</i><i>(</i><i>)</i><i>;</i>
    <i>#<i>[</i>cfg<i>(</i>depth = <i>&#34;8&#34;</i><i>)</i><i>]</i></i>
    &lt;<i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>(</i><i>)</i> <i>as</i> <i>Trait</i>&gt;<i>::</i><i>method</i><i>(</i><i>)</i><i>;</i>
    <i>#<i>[</i>cfg<i>(</i>depth = <i>&#34;9&#34;</i><i>)</i><i>]</i></i>
    &lt;<i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>(</i><i>)</i> <i>as</i> <i>Trait</i>&gt;<i>::</i><i>method</i><i>(</i><i>)</i><i>;</i>
    <i>#<i>[</i>cfg<i>(</i>depth = <i>&#34;10&#34;</i><i>)</i><i>]</i></i>
    &lt;<i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>&amp;</i><i>(</i><i>)</i> <i>as</i> <i>Trait</i>&gt;<i>::</i><i>method</i><i>(</i><i>)</i><i>;</i>
}
</pre></div>
<p>Because as you&#39;ll see, things can get verbose <em>fast</em>.</p>

                        <h2>
                            <a id="tracing-with-rustc-log" href="#tracing-with-rustc-log">
                                Tracing with <code>RUSTC_LOG</code>
                            </a>
                        </h2>
                        
<p>As of... some time ago, I don&#39;t remember, <code>rustc</code> is using the
<a href="https://lib.rs/crates/tracing">tracing</a> crate, along with
<a href="https://lib.rs/crates/tracing-tree">tracing-tree</a>, which means it&#39;s very easy
for us to turn on some debug logging.</p>
<p>I was excited about this because I generally love <code>tracing</code>, as I&#39;ve <a href="https://jvns.ca/articles/i-won-free-load-testing">said
before</a>, and seeing it used in a compiler
caused me great joy.</p>
<p>rustc logging is set up so that you can set <code>RUSTC_LOG</code> to any values accepted
by <a href="https://docs.rs/tracing-subscriber/latest/tracing_subscriber/struct.EnvFilter.html">EnvFilter</a>.</p>
<p>So, let&#39;s set it to <code>info</code> and see what we get:</p>
<div><p>Shell session</p><pre data-lang="shell">$ RUSTC_LOG=info rustc src/main.rs --emit=metadata --cfg &#39;depth = &#34;1&#34;&#39;
 INFO rustc_metadata::creader resolving crate `std`
 INFO rustc_metadata::creader falling back to a load
 INFO rustc_metadata::locator lib candidate: /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libstd-7ca39ac42651c3df.so
 INFO rustc_metadata::locator lib candidate: /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libstd_detect-a61cdd33cfa8394f.rlib
 INFO rustc_metadata::locator lib candidate: /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libstd-7ca39ac42651c3df.rlib
 INFO rustc_metadata::locator rlib reading metadata from: /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libstd_detect-a61cdd33cfa8394f.rlib
 INFO rustc_metadata::locator Rejecting via crate name
</pre></div>
<p>Okay, so rustc knows about crates! Interesting. Let&#39;s skip ahead, there&#39;s a ton of those.</p>
<div><p>Shell session</p><pre data-lang="shell">INFO rustc_metadata::creader resolved crates:
  name: std
  cnum: 1
  hash: 514c814935f60577
  reqd: Explicit
   rlib: /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libstd-7ca39ac42651c3df.rlib
  name: core
  cnum: 2
  hash: 40880dfc3076f43e
  reqd: Explicit
   rlib: /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcore-83735dd4dae9b02c.rlib
</pre></div>
<p>Neat, it found a bunch of crates (19 in total, not shown here).</p>
<div><p>Shell session</p><pre data-lang="shell">  INFO rustc_interface::passes 0 parse sess buffered_lints
┐rustc_typeck::check::wfcheck::check_trait 
├─┐rustc_trait_selection::traits::project::normalize_with_depth_to depth=0, value=[Binder(TraitPredicate(&lt;Self as Trait&lt;&#39;a&gt;&gt;, polarity:Positive), [])]
</pre></div>
<p>Okay, now it started doing type checking! (You can tell from the crate name:
<code>rustc_typeck</code> — rustc too is split across a bunch of crates).</p>
<p>Much later, we see:</p>
<div><p>Shell session</p><pre data-lang="shell">┐rustc_trait_selection::traits::project::normalize_with_depth_to depth=1, value=Binder(ProjectionPredicate(ProjectionTy { substs: [_, ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b057]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:5 ~ main[b057]::Trait::A) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b057]::{impl#0}::&#39;x), &#39;x))])
┘
┐rustc_trait_selection::traits::project::normalize_with_depth_to depth=1, value=Binder(ProjectionPredicate(ProjectionTy { substs: [_, ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b057]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:6 ~ main[b057]::Trait::B) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b057]::{impl#0}::&#39;x), &#39;x))])
┘
┐rustc_trait_selection::traits::project::normalize_with_depth_to depth=1, value=Binder(ProjectionPredicate(ProjectionTy { substs: [_, ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b057]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:7 ~ main[b057]::Trait::C) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b057]::{impl#0}::&#39;x), &#39;x))])
┘
┐rustc_trait_selection::traits::project::normalize_with_depth_to depth=1, value=Binder(ProjectionPredicate(ProjectionTy { substs: [_, ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b057]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:8 ~ main[b057]::Trait::D) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b057]::{impl#0}::&#39;x), &#39;x))])
</pre></div>
<p>Ah! That seems related to our code.</p>
<p>Let&#39;s reformat one of these manually:</p>
<div><pre data-lang="">Binder(
  ProjectionPredicate(
    ProjectionTy {
      substs: [
        _,
        ReLateBound(
          DebruijnIndex(0),
          BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b057]::{impl#0}::&#39;x), &#39;x) }
        )
      ],
      item_def_id: DefId(0:5 ~ main[b057]::Trait::A)
    },
    Ty(())
  ),
  [
    Region(BrNamed(DefId(0:12 ~ main[b057]::{impl#0}::&#39;x), &#39;x))
  ]
)
</pre></div>
<p>Looking through rustc&#39;s source code a bit, we find:</p>
<blockquote>
<p>Binder is a binder for higher-ranked lifetimes or types. It is part of the
compiler&#39;s representation for things like <code>for&lt;&#39;a&gt; Fn(&amp;&#39;a isize)</code>
(which would be represented by the type <code>PolyTraitRef == Binder&lt;&#39;tcx, TraitRef&gt;</code>). Note that when we instantiate,
erase, or otherwise &#34;discharge&#34; these bound vars, we change the
type from <code>Binder&lt;&#39;tcx, T&gt;</code> to just <code>T</code> (see
e.g., <code>liberate_late_bound_regions</code>).</p>
</blockquote>
<p>That seems to correspond to this constraint in our code:</p>
<div><p>Rust code</p><pre data-lang="rust">where
    <i>for</i>&lt;<i>&#39;</i><i>x</i>&gt; T: <i>Trait</i><i>&lt;</i><i>&#39;</i><i>x</i>, <i>A</i> = <i>(</i><i>)</i>, <i>B</i> = <i>(</i><i>)</i>, <i>C</i> = <i>(</i><i>)</i>, <i>D</i> = <i>(</i><i>)</i><i>&gt;</i>,
</pre></div>
<p>In there we have a <code>ProjectionPredicate</code>:</p>
<blockquote>
<p>This kind of predicate has no <em>direct</em> correspondent in the
syntax, but it roughly corresponds to the syntactic forms:</p>
<ol>
<li><code>T: TraitRef&lt;..., Item = Type&gt;</code></li>
<li><code>&lt;T as TraitRef&lt;...&gt;&gt;::Item == Type</code> (NYI)</li>
</ol>
<p>In particular, form #1 is &#34;desugared&#34; to the combination of a
normal trait predicate (<code>T: TraitRef&lt;...&gt;</code>) and one of these
predicates. Form #2 is a broader form in that it also permits
equality between arbitrary types. Processing an instance of
Form #2 eventually yields one of these <code>ProjectionPredicate</code>
instances to normalize the LHS.</p>
</blockquote>
<p>My read here is that this:</p>
<div><p>Rust code</p><pre data-lang="rust">where
    <i>for</i>&lt;<i>&#39;</i><i>x</i>&gt; T: <i>Trait</i><i>&lt;</i><i>&#39;</i><i>x</i>, <i>A</i> = <i>(</i><i>)</i>, <i>B</i> = <i>(</i><i>)</i>, <i>C</i> = <i>(</i><i>)</i>, <i>D</i> = <i>(</i><i>)</i><i>&gt;</i>,
</pre></div>
<p>Gets translated into this (which is not valid syntax):</p>
<div><p>Rust code</p><pre data-lang="rust">where
    <i>for</i>&lt;<i>&#39;</i><i>x</i>&gt; T: <i>Trait</i><i>&lt;</i><i>&#39;</i><i>x</i><i>&gt;</i>,
    <i>for</i>&lt;<i>&#39;</i><i>x</i>&gt; &lt;<i>T</i> <i>as</i> <i>Trait</i><i>&lt;</i><i>&#39;</i><i>x</i><i>&gt;</i>&gt;<i>::</i><i>A</i> = <i>(</i><i>)</i>,
    <i>for</i>&lt;<i>&#39;</i><i>x</i>&gt; &lt;<i>T</i> <i>as</i> <i>Trait</i><i>&lt;</i><i>&#39;</i><i>x</i><i>&gt;</i>&gt;<i>::</i><i>B</i> = <i>(</i><i>)</i>,
    <i>for</i>&lt;<i>&#39;</i><i>x</i>&gt; &lt;<i>T</i> <i>as</i> <i>Trait</i><i>&lt;</i><i>&#39;</i><i>x</i><i>&gt;</i>&gt;<i>::</i><i>C</i> = <i>(</i><i>)</i>,
    <i>for</i>&lt;<i>&#39;</i><i>x</i>&gt; &lt;<i>T</i> <i>as</i> <i>Trait</i><i>&lt;</i><i>&#39;</i><i>x</i><i>&gt;</i>&gt;<i>::</i><i>D</i> = <i>(</i><i>)</i>,
</pre></div>
<p>If you try it you&#39;ll run into &#34;equality constraints are not yet supported in
<code>where</code> clauses&#34;, with a link to <a href="https://github.com/rust-lang/rust/issues/20041">this
issue</a>.</p>
<p>But that seems to be what the compiler desugars it to, according to the comment.
And so, we&#39;re looking at something like <code>for&lt;&#39;x&gt; &lt;T as Trait&lt;&#39;x&gt;&gt;::A = ()</code>.</p>
<p>Still in that logging output, we see a mention of <a href="https://en.wikipedia.org/wiki/De_Bruijn_index">De Bruijn
indices</a>, named after Nicolaas
Govert de Bruijn, and is just a convenient way to &#34;represent terms of lambda
calculus without naming the bound variables&#34;. Here it&#39;s used to represent
lifetimes.</p>
<p>That&#39;s as much as I can divine from this, but one thing&#39;s for sure: these log
lines are related to typechecking our code.</p>
<p>Finally, we get a nice summary of... the distribution of type features for types
in the interner? It&#39;s not &#34;time spent&#34;, but it&#39;s fun to look at:</p>
<div><pre data-lang=""> INFO rustc_interface::passes Pre-codegen
Ty interner             total           ty lt ct all
    Adt               :      0  0.0%,  0.0%   0.0%  0.0%  0.0%
    Array             :      0  0.0%,  0.0%   0.0%  0.0%  0.0%
    Slice             :      0  0.0%,  0.0%   0.0%  0.0%  0.0%
    RawPtr            :      0  0.0%,  0.0%   0.0%  0.0%  0.0%
    Ref               :     15 25.4%,  5.1%  15.3%  0.0%  0.0%
    FnDef             :      9 15.3%,  0.0%   8.5%  0.0%  0.0%
    FnPtr             :      1  1.7%,  0.0%   0.0%  0.0%  0.0%
    Placeholder       :      0  0.0%,  0.0%   0.0%  0.0%  0.0%
    Generator         :      0  0.0%,  0.0%   0.0%  0.0%  0.0%
    GeneratorWitness  :      0  0.0%,  0.0%   0.0%  0.0%  0.0%
    Dynamic           :      0  0.0%,  0.0%   0.0%  0.0%  0.0%
    Closure           :      0  0.0%,  0.0%   0.0%  0.0%  0.0%
    Tuple             :      1  1.7%,  0.0%   0.0%  0.0%  0.0%
    Bound             :      0  0.0%,  0.0%   0.0%  0.0%  0.0%
    Param             :      2  3.4%,  0.0%   0.0%  0.0%  0.0%
    Infer             :      3  5.1%,  3.4%   0.0%  0.0%  0.0%
    Projection        :     28 47.5%,  0.0%  13.6%  0.0%  0.0%
    Opaque            :      0  0.0%,  0.0%   0.0%  0.0%  0.0%
    Foreign           :      0  0.0%,  0.0%   0.0%  0.0%  0.0%
                  total     59         8.5%  37.3%  0.0%  0.0%
InternalSubsts interner: #95
Region interner: #54
Const Allocation interner: #0
Layout interner: #0
</pre></div>
<p>And... there&#39;s 47.5% in <code>Projection</code>, which I think refers to those <code>&lt;T as Trait&gt;::AssocType = Stuff</code> constraints.</p>
<p>And now I&#39;m really curious how these evolve when we add more nesting, so, let&#39;s
filter log output so we only have stuff from <code>rustc_interface::passes</code> and do
text processing:</p>
<div><p>Shell session</p><pre data-lang="shell">for i in $(seq 1 9); do echo &#34;============ Level ${i} ============&#34;; RUSTC_LOG=rustc_interface::passes=info rustc src/main.rs --emit=metadata --cfg &#34;depth = \&#34;${i}\&#34;&#34; 2&gt;&amp;1 | grep &#34;Post-codegen&#34; -A 100 | grep -E &#34;Ref|FnDef|Infer|Projection&#34;; done
============ Level 1 ============
    Ref               :     15 25.4%,  5.1%  15.3%  0.0%  0.0%
    FnDef             :      9 15.3%,  0.0%   8.5%  0.0%  0.0%
    Infer             :      3  5.1%,  3.4%   0.0%  0.0%  0.0%
    Projection        :     28 47.5%,  0.0%  13.6%  0.0%  0.0%
============ Level 2 ============
    Ref               :     37 43.5%, 21.2%  31.8%  0.0%  0.0%
    FnDef             :      8  9.4%,  0.0%   4.7%  0.0%  0.0%
    Infer             :      8  9.4%,  8.2%   0.0%  0.0%  0.0%
    Projection        :     28 32.9%,  0.0%   9.4%  0.0%  0.0%
============ Level 3 ============
    Ref               :     65 54.6%, 29.4%  42.9%  0.0%  0.0%
    FnDef             :      9  7.6%,  0.0%   4.2%  0.0%  0.0%
    Infer             :     13 10.9%, 10.1%   0.0%  0.0%  0.0%
    Projection        :     28 23.5%,  0.0%   6.7%  0.0%  0.0%
============ Level 4 ============
    Ref               :    113 62.4%, 40.9%  52.5%  0.0%  0.0%
    FnDef             :      9  5.0%,  0.0%   2.8%  0.0%  0.0%
    Infer             :     27 14.9%, 14.4%   0.0%  0.0%  0.0%
    Projection        :     28 15.5%,  0.0%   4.4%  0.0%  0.0%
============ Level 5 ============
    Ref               :    231 60.9%, 48.3%  55.1%  0.0%  0.0%
    FnDef             :      9  2.4%,  0.0%   1.3%  0.0%  0.0%
    Infer             :    107 28.2%, 28.0%   0.0%  0.0%  0.0%
    Projection        :     28  7.4%,  0.0%   2.1%  0.0%  0.0%
============ Level 6 ============
    Ref               :    652 58.2%, 53.1%  55.9%  0.0%  0.0%
    FnDef             :      9  0.8%,  0.0%   0.4%  0.0%  0.0%
    Infer             :    427 38.1%, 38.0%   0.0%  0.0%  0.0%
    Projection        :     28  2.5%,  0.0%   0.7%  0.0%  0.0%
============ Level 7 ============
    Ref               :   2248 56.3%, 54.6%  55.5%  0.0%  0.0%
    FnDef             :      9  0.2%,  0.0%   0.1%  0.0%  0.0%
    Infer             :   1707 42.7%, 42.7%   0.0%  0.0%  0.0%
    Projection        :     28  0.7%,  0.0%   0.2%  0.0%  0.0%
============ Level 8 ============
    Ref               :   8616 55.6%, 55.2%  55.4%  0.0%  0.0%
    FnDef             :      9  0.1%,  0.0%   0.0%  0.0%  0.0%
    Infer             :   6827 44.1%, 44.1%   0.0%  0.0%  0.0%
    Projection        :     28  0.2%,  0.0%   0.1%  0.0%  0.0%
============ Level 9 ============
    Ref               :  33976 55.4%, 55.3%  55.3%  0.0%  0.0%
    FnDef             :      9  0.0%,  0.0%   0.0%  0.0%  0.0%
    Infer             :  27307 44.5%, 44.5%   0.0%  0.0%  0.0%
    Projection        :     28  0.0%,  0.0%   0.0%  0.0%  0.0%
</pre></div>
<p>Ah! It looks like <code>Infer</code> is EXPloding. And so is <code>Ref</code>, but I&#39;m not exactly
sure why.</p>
<div>

<p>Wait, why are we doing this again? Doesn&#39;t rustc have self-profiling? That seems
like it could be useful there.</p>
</div>
<p>You know what, that&#39;s a good point, let&#39;s try that.</p>

                        <h2>
                            <a id="self-profiling-with-z-self-profile" href="#self-profiling-with-z-self-profile">
                                Self-profiling with <code>-Z self-profile</code>
                            </a>
                        </h2>
                        
<p>We&#39;ll choose nesting level 8, because it takes a handful of seconds on my
machine so it&#39;s probably long enough to measure stuff, yet short enough that
it doesn&#39;t get <em>really</em> annoying.</p>
<p>So, we&#39;ve learned this in <a href="https://jvns.ca/articles/why-is-my-rust-build-so-slow">a previous
article</a>, let&#39;s get moving. As before,
and because we&#39;re still on stable at this point, we&#39;ll use the <code>RUSTC_BOOTSTRAP</code>
environment variable to unlock nightly features, which is something you
shouldn&#39;t normally do:</p>
<div><p>Shell session</p><pre data-lang="shell">$ RUSTC_BOOTSTRAP=1 rustc src/main.rs --emit=metadata --cfg &#39;depth = &#34;8&#34;&#39; -Z self-profile
(no output)
# this takes the most recent `*.mm_profdata` file
$ summarize summarize $(ls -t *profdata | head -1) | head
+------------------------------------------------+-----------+-----------------+----------+------------+
| Item                                           | Self time | % of total time | Time     | Item count |
+------------------------------------------------+-----------+-----------------+----------+------------+
| evaluate_obligation                            | 738.19ms  | 98.892          | 738.21ms | 51         |
+------------------------------------------------+-----------+-----------------+----------+------------+
| expand_crate                                   | 2.32ms    | 0.311           | 2.71ms   | 1          |
+------------------------------------------------+-----------+-----------------+----------+------------+
| free_global_ctxt                               | 892.96µs  | 0.120           | 892.96µs | 1          |
+------------------------------------------------+-----------+-----------------+----------+------------+
| codegen_fulfill_obligation                     | 556.41µs  | 0.075           | 738.71ms | 1          |
thread &#39;main&#39; panicked at &#39;Cannot print table to standard output : Broken pipe (os error 32)&#39;, /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/prettytable-rs-0.8.0/src/lib.rs:194:23
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</pre></div>
<p>Alright! We have a candidate there for sure.</p>
<p>Here it is in flamegraph form:</p>
<div><p>Shell session</p><pre data-lang="shell">$ flamegraph $(ls -t *profdata | head -1)
# using the `sfz` crate as a static file server to visualize the SVG in a browser
$ sfz
Files served on http://127.0.0.1:5000
</pre></div>
            <picture>
                <source type="image/avif" srcset="/content/articles/when-rustc-explodes/assets/flamegraph1.a8b421ba2650fb11.avif"/>
                <source type="image/webp" srcset="/content/articles/when-rustc-explodes/assets/flamegraph1.5ce3d0673fe4df1c.webp"/>
                <img loading="lazy" src="https://jvns.ca/content/articles/when-rustc-explodes/assets/flamegraph1.840403c860367272.jpg" title="A flamegraph, showing that almost all time is spent in: all, rustc, analysis, MIR_borrow_checking, mir_borrowck, mir_promoted, mir_const, unsafety_check_result, mir_built, resolve_instance, codegen_fulfill_obligation, and evaluate_obligation" alt="A flamegraph, showing that almost all time is spent in: all, rustc, analysis, MIR_borrow_checking, mir_borrowck, mir_promoted, mir_const, unsafety_check_result, mir_built, resolve_instance, codegen_fulfill_obligation, and evaluate_obligation"/>
            </picture>
            
<p>And in <code>chrome://tracing</code> form, which has a bunch of useful temporal information
the flamegraph lacks:</p>
<div><p>Shell session</p><pre data-lang="shell">$ crox $(ls -t *profdata | tail -1)
# this generated a `chrome_profiler.json` file
</pre></div>
            <picture>
                <source type="image/avif" srcset="/content/articles/when-rustc-explodes/assets/chrome-tracing-lotsa-evaluate-obligation.f5bb4dfde6236643.avif"/>
                <source type="image/webp" srcset="/content/articles/when-rustc-explodes/assets/chrome-tracing-lotsa-evaluate-obligation.c70f8f28e6f8f001.webp"/>
                <img loading="lazy" src="https://jvns.ca/content/articles/when-rustc-explodes/assets/chrome-tracing-lotsa-evaluate-obligation.1d0288370e070eca.jpg" title="A screenshot of chrome://tracing in the Google Chrome browser, showing the same thing the flamegraph showed, but upside-down. Also we now see that there&#39;s several evaluate_obligation calls" alt="A screenshot of chrome://tracing in the Google Chrome browser, showing the same thing the flamegraph showed, but upside-down. Also we now see that there&#39;s several evaluate_obligation calls"/>
            </picture>
            
<p>Here for example, we see that <code>evaluate_obligation</code> is actually done multiple
times: the first one takes the longest, the next couple ones are a little bit
quicker, and the last few are quicker still.</p>
<p>But which &#34;obligations&#34; is it evaluating? We don&#39;t know, because we haven&#39;t
recorded arguments. Which we can do with another flag, <code>-Z self-profile-events</code>:</p>
<div><p>Shell session</p><pre data-lang="shell">$ RUSTC_BOOTSTRAP=1 rustc src/main.rs --emit=metadata --cfg &#39;depth = &#34;8&#34;&#39; -Z self-profile -Z self-profile-events=default,args
</pre></div>
<p>The summary looks mostly the same:</p>
<div><p>Shell session</p><pre data-lang="shell">$ summarize summarize $(ls -t *profdata | head -1) | head
+-------------------------------------------------+-----------+-----------------+----------+------------+
| Item                                            | Self time | % of total time | Time     | Item count |
+-------------------------------------------------+-----------+-----------------+----------+------------+
| evaluate_obligation                             | 774.03ms  | 98.623          | 774.06ms | 51         |
+-------------------------------------------------+-----------+-----------------+----------+------------+
| expand_crate                                    | 2.32ms    | 0.295           | 2.71ms   | 1          |
+-------------------------------------------------+-----------+-----------------+----------+------------+
| metadata_decode_entry_module_children           | 1.98ms    | 0.253           | 1.98ms   | 298        |
+-------------------------------------------------+-----------+-----------------+----------+------------+
| codegen_fulfill_obligation                      | 737.23µs  | 0.094           | 774.74ms | 1          |
thread &#39;main&#39; panicked at &#39;Cannot print table to standard output : Broken pipe (os error 32)&#39;, /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/prettytable-rs-0.8.0/src/lib.rs:194:23
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</pre></div>
<p>Let&#39;s look at the chrome tracing profile directly:</p>

            <picture>
                <source type="image/avif" srcset="/content/articles/when-rustc-explodes/assets/chrome-tracing-with-args.e8d7c706f7fec4c0.avif"/>
                <source type="image/webp" srcset="/content/articles/when-rustc-explodes/assets/chrome-tracing-with-args.5705f1559b2c4bd5.webp"/>
                <img loading="lazy" src="https://jvns.ca/content/articles/when-rustc-explodes/assets/chrome-tracing-with-args.00cfb199466b75f2.jpg" title="The same chrome tracing profile, but this time there&#39;s an arg0 that shows which obligation it&#39;s checking" alt="The same chrome tracing profile, but this time there&#39;s an arg0 that shows which obligation it&#39;s checking"/>
            </picture>
            
<p>This time, we can see which obligation is being checked, and the first one is
(manually formatted for your convenience):</p>
<div><pre data-lang="">Canonical {
  max_universe: U0,
  variables: [],
  value: ParamEnvAnd {
    param_env: ParamEnv {
      caller_bounds: [],
      reveal: UserFacing,
      constness: NotConst
    },
    value: Binder(
      ProjectionPredicate(
        ProjectionTy {
          substs: [
            &amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;(),
            ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b057]::{impl#0}::&#39;x), &#39;x) })
          ],
          item_def_id: DefId(0:5 ~ main[b057]::Trait::A)
        },
        Ty(())
      ),
      [Region(BrNamed(DefId(0:12 ~ main[b057]::{impl#0}::&#39;x), &#39;x))]
    )
  }
}
</pre></div><div>

<p>There&#39;s not really a good reason for that <code>#[derive(Debug)]</code>-style output being
in there btw. There&#39;s machinery in place in rustc to format these nicely, like
<code>for&lt;&#39;x&gt; Predicate&lt;&#39;x&gt;</code> but apparently it&#39;s not hooked all the way through.</p>
<p>Now that I think about it, that would be a neat first contribution... wink wink.</p>
</div>
<div>

<p>Did you just say &#34;wink wink&#34; out loud?</p>
</div>
<div>

<p>You&#39;re not the boss of me.</p>
</div>
<p>The next three are the same, except the <code>item_def_id</code> is for <code>Trait::B</code>,
<code>Trait::C</code> and <code>Trait::D</code> respectively. The next one doesn&#39;t have a projection,
it&#39;s simply the <code>for&lt;&#39;x&gt; T: Trait&lt;&#39;x&gt;</code> obligation.</p>
<p>And then the other ones are similar, but for the inner levels: seven <code>&amp;</code> instead
of eight, and so on until we reach the bottom, where we check <code>for&lt;&#39;x&gt; &amp;() Trait&lt;&#39;x&gt;</code>.</p>
<p>Which... is interesting. You&#39;d think that... once rustc has proven that <code>for&lt;&#39;x&gt; &amp;() Trait&lt;&#39;x&gt;</code>,
it can re-use that result to prove that <code>for&lt;&#39;x&gt; &amp;&amp;(): Trait&lt;&#39;x&gt;</code>, using that <code>impl</code>:</p>
<div><p>Rust code</p><pre data-lang="rust"><i>impl</i><i>&lt;</i><i>T</i><i>&gt;</i> <i>Trait</i><i>&lt;</i><i>&#39;</i><i>_</i><i>&gt;</i> <i>for</i> <i>&amp;</i><i>&#39;</i><i>_</i> <i>T</i>
<i>where</i>
    <i>for</i><i>&lt;</i><i>&#39;</i><i>x</i><i>&gt;</i> <i>T</i>: <i>Trait</i><i>&lt;</i><i>&#39;</i><i>x</i>, <i>A</i> = <i>(</i><i>)</i>, <i>B</i> = <i>(</i><i>)</i>, <i>C</i> = <i>(</i><i>)</i>, <i>D</i> = <i>(</i><i>)</i><i>&gt;</i>,
</pre></div>
<p>And then it can re-use that to prove <code>for&lt;&#39;x&gt; &amp;&amp;&amp;(): Trait&lt;&#39;x&gt;</code>, and so on until
<code>for&lt;&#39;x&gt; &amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;(): Trait&lt;&#39;x&gt;</code>.</p>
<p>And in fact, it can! If we remove the projections, ie. we make that bound just
this:</p>
<div><p>Rust code</p><pre data-lang="rust"><i>impl</i><i>&lt;</i><i>T</i><i>&gt;</i> <i>Trait</i><i>&lt;</i><i>&#39;</i><i>_</i><i>&gt;</i> <i>for</i> <i>&amp;</i><i>&#39;</i><i>_</i> <i>T</i>
<i>where</i>
    <i>for</i><i>&lt;</i><i>&#39;</i><i>x</i><i>&gt;</i> <i>T</i>: <i>Trait</i><i>&lt;</i><i>&#39;</i><i>x</i><i>&gt;</i>,
</pre></div>
<p>Then it completes instantly:</p>
<div><p>Shell session</p><pre data-lang="shell">$ command time -f &#34;took %Us&#34; env RUSTC_BOOTSTRAP=1 rustc src/main.rs --emit=metadata --cfg &#39;depth = &#34;8&#34;&#39; -Z self-profile -Z self-profile-events=default,args
took 0.04s
</pre></div>
<p>And at that point, most of the time is spent in.. <code>expand_crate</code> (macro stuff?)
and <code>metadata_decode_entry_module_children</code> (reading rlib files?):</p>
<div><p>Shell session</p><pre data-lang="shell">$ summarize summarize $(ls -t *profdata | head -1) | head
+-------------------------------------------------+-----------+-----------------+----------+------------+
| Item                                            | Self time | % of total time | Time     | Item count |
+-------------------------------------------------+-----------+-----------------+----------+------------+
| expand_crate                                    | 2.34ms    | 25.009          | 2.74ms   | 1          |
+-------------------------------------------------+-----------+-----------------+----------+------------+
| metadata_decode_entry_module_children           | 2.27ms    | 24.295          | 2.27ms   | 298        |
+-------------------------------------------------+-----------+-----------------+----------+------------+
| self_profile_alloc_query_strings                | 449.57µs  | 4.815           | 3.14ms   | 1          |
+-------------------------------------------------+-----------+-----------------+----------+------------+
| &lt;unknown&gt;                                       | 424.47µs  | 4.546           | 5.03ms   | 320        |
thread &#39;main&#39; panicked at &#39;Cannot print table to standard output : Broken pipe (os error 32)&#39;, /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/prettytable-rs-0.8.0/src/lib.rs:194:23
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</pre></div>
<p>So something is definitely up, and we should look further.</p>
<div>

<p>I&#39;m sorry, amos, if I could have one second of your time. Are you seriously
suggesting folks who write Rust casually have a moral obligation to do all of
this?</p>
</div>
<p>Oh! Oh no, absolutely not. It&#39;s just... if you <em>want to</em>, then you definitely
can, and it&#39;s a bit under-documented right now, so I wanted to share my notes on
<em>how</em>, so that the next time it happens, I can refer to those instead of
furiously spamming everyone. And if others do that too maybe we can get to the
bottom of these faster, that&#39;s all.</p>
<div>

<p>Ah, so you&#39;re saying <em>not</em> to do this?</p>
</div>
<p>I&#39;m saying do whatever you want. I&#39;ll show you how, and then you can decide what
you want to do with that knowledge.</p>
<div>

<p>I see I see. So you&#39;re going to want to keep this accessible still, right?
It&#39;s not that bad so far, but I could see going a little too far w-</p>
</div>
<p>So, as you can imagine, at some point, we&#39;re gonna want to compile our own copy
of rustc.</p>
<div>

<p>...what was I <em>just</em> saying.</p>
</div>
<p>No no, listen, hear me out. It&#39;s not as bad as you think. I was afraid too, once!</p>
<p>But it turns out there&#39;s a a <a href="https://rustc-dev-guide.rust-lang.org/">very nice guide to rustc
development</a> available and it&#39;s easy to follow.</p>
<div>

<p>Okay but what possible reason could you have for doing this? Are we going to fix
the bug in that article?</p>
</div>
<p>Oh no, not at all. But we&#39;re going to learn more about it.</p>
<p>See, the release build of the stable Rust compiler may have nightly features
hidden behind <code>RUSTC_BOOTSTRAP=1</code>, but there&#39;s things it doesn&#39;t have.</p>
<p>Let&#39;s take tracing: say we want more detail than <code>info</code>: maybe we want <code>debug</code>
spans and events. If we try it on stable, we get this:</p>
<div><p>Shell session</p><pre data-lang="shell">$ RUSTC_LOG=debug rustc src/main.rs --emit=metadata --cfg &#39;depth = &#34;1&#34;&#39;
warning: some trace filter directives would enable traces that are disabled statically
 | `debug` would enable the DEBUG level for all targets
 = note: the static max level is `info`
 = help: to enable DEBUG logging, remove the `max_level_info` feature
(cut)
</pre></div><div>

<p>Oh, it.. wait, <code>tracing</code> lets you strip certain levels statically? Like, at
build time?</p>
</div>
<p><a href="https://docs.rs/tracing/latest/tracing/level_filters/index.html">Yes it does!</a>.
So the debug spans and events we&#39;re looking for are not even in the stable rust
binary.</p>

                        <h2>
                            <a id="profiling-with-perf" href="#profiling-with-perf">
                                Profiling with <code>perf</code>
                            </a>
                        </h2>
                        
<p>Here&#39;s another thing. Say we record the execution of <code>rustc</code> with the <a href="https://brendangregg.com/perf.html">perf
profiler</a>:</p>
<div><p>Shell session</p><pre data-lang="shell">$ perf record rustc src/main.rs --emit=metadata --cfg &#39;depth = &#34;8&#34;&#39;
[ perf record: Woken up 1 times to write data ]
[ perf record: Captured and wrote 0.048 MB perf.data (850 samples) ]
</pre></div><div>

<p>You have to set up a bunch of procfs variables to be able to do <code>perf record</code>
unprivileged, because the kernel is (rightfully) paranoid about <code>perf_events</code>
and kernel symbol tables by default on distributions like Ubuntu.</p>
<p>This is not covered here, because as you try it, <code>perf</code> walks you through fixing
it.</p>
</div>
<p>And then we report:</p>
<div><p>Shell session</p><pre data-lang="shell">$ perf report --stdio
(cut)
     7.26%  rustc    librustc_driver-a7bf53640eed303a.so  [.] &lt;rustc_infer::infer::InferCtxt&gt;::rollback_to
     5.54%  rustc    librustc_driver-a7bf53640eed303a.so  [.] &lt;rustc_middle::ty::context::TyCtxt&gt;::intern_substs
     4.31%  rustc    librustc_driver-a7bf53640eed303a.so  [.] &lt;rustc_infer::infer::region_constraints::RegionConstraintCollector&gt;::make_eqregion
     4.18%  rustc    librustc_driver-a7bf53640eed303a.so  [.] &lt;rustc_middle::ty::context::TyCtxt&gt;::mk_region
     3.57%  rustc    librustc_driver-a7bf53640eed303a.so  [.] &lt;rustc_infer::infer::region_constraints::leak_check::LeakCheck&gt;::assign_placeholder_values
     3.57%  rustc    rustc                                [.] free
     2.83%  rustc    librustc_driver-a7bf53640eed303a.so  [.] _RNvNtNtCs81r3Jv5jMWm_21rustc_trait_selection6traits7project29opt_normalize_projection_type.llvm.158142954743480087
     2.71%  rustc    librustc_driver-a7bf53640eed303a.so  [.] &lt;alloc::rc::Rc&lt;rustc_middle::traits::ObligationCauseCode&gt; as core::ops::drop::Drop&gt;::drop
     2.71%  rustc    rustc                                [.] malloc
     2.58%  rustc    librustc_driver-a7bf53640eed303a.so  [.] &lt;rustc_middle::ty::context::CtxtInterners&gt;::intern_predicate
     1.72%  rustc    librustc_driver-a7bf53640eed303a.so  [.] &lt;rustc_data_structures::graph::scc::SccsConstruction&lt;rustc_data_structures::graph::vec_graph::VecGraph&lt;rustc_infer::infer::region_constraints::leak_check::LeakCheckNode&gt;, rustc_infer::infer::region_constraints::leak_check::LeakCheckScc&gt;&gt;::inspect_node
     1.48%  rustc    librustc_driver-a7bf53640eed303a.so  [.] &lt;rustc_trait_selection::traits::select::SelectionContext&gt;::rematch_impl
     1.48%  rustc    librustc_driver-a7bf53640eed303a.so  [.] &lt;rustc_trait_selection::traits::select::SelectionContext&gt;::vtable_impl
     1.35%  rustc    librustc_driver-a7bf53640eed303a.so  [.] &lt;rustc_middle::ty::sty::Region as core::ops::deref::Deref&gt;::deref
     1.35%  rustc    librustc_driver-a7bf53640eed303a.so  [.] &lt;rustc_middle::ty::subst::SubstFolder as rustc_middle::ty::fold::TypeFolder&gt;::fold_ty
     1.23%  rustc    [kernel.kallsyms]                    [k] do_user_addr_fault
</pre></div>
<p>Well... because we don&#39;t have debug info, we don&#39;t see what we should be seeing,
which is...</p>
<div>

<p>Uhh you didn&#39;t even tell <code>perf</code> to record call stacks?</p>
</div>
<p>Ah right! Let&#39;s try that again:</p>
<div><p>Shell session</p><pre data-lang="shell"># note: `-g` is the more confusing equivalent to `--call-graph fp`. we use
# the longer form to avoid any misunderstandings about what `-g` truly does.
# here we&#39;re using &#34;frame pointers&#34; to gather stack traces when we sample.
$ perf record --call-graph fp rustc src/main.rs --emit=metadata --cfg &#39;depth = &#34;8&#34;&#39;
[ perf record: Woken up 1 times to write data ]
[ perf record: Captured and wrote 0.112 MB perf.data (1306 samples) ]

$ perf report --stdio
(cut)
     8.77%     0.00%  rustc    [unknown]                            [.] 0000000000000000
            |
            ---0
               |          
               |--0.79%--&lt;rustc_infer::infer::InferCtxt&gt;::commit_if_ok::&lt;(), (), rustc_trait_selection::traits::project::assemble_candidates_from_impls::{closure#0}&gt;
               |          
               |--0.67%--pthread_mutex_trylock@GLIBC_2.2.5
               |          
               |--0.56%--_RNvNtNtCs81r3Jv5jMWm_21rustc_trait_selection6traits7project29opt_normalize_projection_type.llvm.158142954743480087
               |          
               |--0.56%--free
               |          
               |--0.56%--0x7fd7407eb520
               |          
                --0.56%--0x40000
                          &lt;rustc_infer::infer::region_constraints::RegionConstraintCollector&gt;::make_eqregion

     6.64%     6.64%  rustc    librustc_driver-a7bf53640eed303a.so  [.] &lt;rustc_infer::infer::InferCtxt&gt;::rollback_to
            |
            ---&lt;rustc_infer::infer::InferCtxt&gt;::rollback_to

     6.19%     6.19%  rustc    librustc_driver-a7bf53640eed303a.so  [.] &lt;rustc_middle::ty::context::TyCtxt&gt;::intern_substs
            |          
             --5.51%--&lt;rustc_middle::ty::context::TyCtxt&gt;::intern_substs
</pre></div>
<p>There. That looks wrong.</p>
<div>

<p>Sure, but you&#39;re using frame pointers here. What about <code>--call-graph dwarf</code>?</p>
</div>
<p>Sure, let&#39;s try that:</p>
<div><p>Shell session</p><pre data-lang="shell">$ perf record --call-graph dwarf rustc src/main.rs --emit=metadata --cfg &#39;depth = &#34;8&#34;&#39;
[ perf record: Woken up 31 times to write data ]
[ perf record: Captured and wrote 7.733 MB perf.data (955 samples) ]
</pre></div>
<p>(As usual, using <code>dwarf</code> makes for a much larger <code>perf.data</code> file since perf
just takes a snapshot of the stack and deals with symbolication later)</p>
<p>Running <code>perf report --stdio</code> gives us a <em>bunch</em> of these:</p>
<div><p>Shell session</p><pre data-lang="shell">addr2line: DWARF error: invalid or unhandled FORM value: 0x23
addr2line: DWARF error: invalid or unhandled FORM value: 0x23
(this repeats for a long while)
</pre></div>
<p>And then:</p>
<div><p>Shell session</p><pre data-lang="shell">    98.53%     0.00%  rustc    [unknown]                            [k] 0xffffffffffffffff
            |
            ---0xffffffffffffffff
               |          
               |--43.14%--&lt;rustc_trait_selection::traits::select::SelectionContext&gt;::evaluate_predicate_recursively
               |          |          
               |          |--32.77%--&lt;rustc_trait_selection::traits::select::SelectionContext&gt;::evaluate_predicates_recursively::&lt;alloc::vec::Vec&lt;rustc_infer::traits::Obligation&lt;rustc_middle::ty::Predicate&gt;&gt;&gt;
               |          |          &lt;rustc_trait_selection::traits::select::SelectionContext&gt;::evaluate_predicate_recursively
               |          |          |          
               |          |          |--17.07%--&lt;rustc_trait_selection::traits::select::SelectionContext&gt;::evaluate_predicates_recursively::&lt;alloc::vec::Vec&lt;rustc_infer::traits::Obligation&lt;rustc_middle::ty::Predicate&gt;&gt;&gt;
               |          |          |          &lt;rustc_trait_selection::traits::select::SelectionContext&gt;::evaluate_predicate_recursively
               |          |          |          |          
               |          |          |          |--15.71%--&lt;rustc_trait_selection::traits::select::SelectionContext&gt;::evaluate_predicates_recursively::&lt;alloc::vec::Vec&lt;rustc_infer::traits::Obligation&lt;rustc_middle::ty::Predicate&gt;&gt;&gt;
               |          |          |          |          &lt;rustc_trait_selection::traits::select::SelectionContext&gt;::evaluate_predicate_recursively
               |          |          |          |          |          
               |          |          |          |          |--11.94%--&lt;rustc_trait_selection::traits::select::SelectionContext&gt;::evaluate_predicates_recursively::&lt;alloc::vec::Vec&lt;rustc_infer::traits::Obligation&lt;rustc_middle::ty::Predicate&gt;&gt;&gt;
               |          |          |          |          |          &lt;rustc_trait_selection::traits::select::SelectionContext&gt;::evaluate_predicate_recursively
               |          |          |          |          |          |          
               |          |          |          |          |          |--6.18%--rustc_trait_selection::traits::project::poly_project_and_unify_type
               |          |          |          |          |          |          rustc_trait_selection::traits::project::project_and_unify_type
               |          |          |          |          |          |          _RNvNtNtCs81r3Jv5jMWm_21rustc_trait_selection6traits7project29opt_normalize_projection_type.llvm.158142954743480087
               |          |          |          |          |          |          |          
               |          |          |          |          |          |          |--2.20%--&lt;rustc_infer::infer::InferCtxt&gt;::commit_if_ok::&lt;(), (), rustc_trait_selection::traits::project::assemble_candidates_from_impls::{closure#0}&gt;
               |          |          |          |          |          |          |          
               |          |          |          |          |          |          |--1.57%--&lt;rustc_infer::traits::project::ProjectionCache&gt;::try_start
               |          |          |          |          |          |          |          |          
               |          |          |          |          |          |          |          |--0.73%--__memcpy_avx_unaligned_erms (inlined)
               |          |          |          |          |          |          |          |          
               |          |          |          |          |          |          |           --0.52%--_RINvMs5_NtCskqCQpbzSEkT_9hashbrown3rawINtB6_8RawTableTNtNtNtCs7lUMoIymc80_11rustc_infer6traits7project18ProjectionCacheKeyNtBS_20ProjectionCacheEntryEE14reserve_rehashNCINvNtB8_3map11make_hasherBQ_BQ_B1W_INtNtCs8R1TIarAOKy_4core4hash18BuildHasherDefaultNtCs5jvd1lB4BAC_10rustc_hash8FxHasherEE0EBW_.llvm.5086343079582176625
               |          |          |          |          |          |          |          
               |          |          |          |          |          |          |--0.63%--&lt;rustc_middle::ty::sty::ProjectionTy&gt;::trait_ref
               |          |          |          |          |          |          |          
               |          |          |          |          |          |           --0.63%--&lt;alloc::vec::drain_filter::DrainFilter&lt;rustc_infer::traits::Obligation&lt;rustc_middle::ty::Predicate&gt;, rustc_trait_selection::traits::project::opt_normalize_projection_type::{closure#0}&gt; as core::ops::drop::Drop&gt;::drop
               |          |          |          |          |          |          
               |          |          |          |          |           --5.76%--&lt;rustc_trait_selection::traits::select::SelectionContext&gt;::evaluate_predicates_recursively::&lt;alloc::vec::Vec&lt;rustc_infer::traits::Obligation&lt;rustc_middle::ty::Predicate&gt;&gt;&gt;
               |          |          |          |          |                     &lt;rustc_trait_selection::traits::select::SelectionContext&gt;::evaluate_predicate_recursively
               |          |          |          |          |                     |          
               |          |          |          |          |                      --5.65%--&lt;rustc_trait_selection::traits::select::SelectionContext&gt;::evaluate_predicates_recursively::&lt;alloc::vec::Vec&lt;rustc_infer::traits::Obligation&lt;rustc_middle::ty::Predicate&gt;&gt;&gt;
               |          |          |          |          |                                &lt;rustc_trait_selection::traits::select::SelectionContext&gt;::evaluate_predicate_recursively
               |          |          |          |          |                                |          
               |          |          |          |          |                                |--4.29%--rustc_trait_selection::traits::project::poly_project_and_unify_type
               |          |          |          |          |                                |          |          
               |          |          |          |          |                                |          |--2.93%--&lt;&amp;rustc_middle::ty::list::List&lt;rustc_middle::ty::subst::GenericArg&gt; as rustc_middle::ty::fold::TypeFoldable&gt;::try_fold_with::&lt;rustc_middle::ty::fold::BoundVarReplacer&gt;
               |          |          |          |          |                                |          |          |          
               |          |          |          |          |                                |          |          |--2.41%--&lt;rustc_middle::ty::fold::BoundVarReplacer as rustc_middle::ty::fold::TypeFolder&gt;::fold_region
               |          |          |          |          |                                |          |          |          |          
               |          |          |          |          |                                |          |          |           --2.30%--_RNCINvMs5_NtNtCs3KapO9mZVGx_12rustc_middle2ty4foldNtNtBa_7context6TyCtxt18replace_bound_varsNtBa_14TraitPredicateNCINvMs_NtNtCs7lUMoIymc80_11rustc_i
nfer5infer13higher_rankedNtB1X_9InferCtxt36replace_bound_vars_with_placeholdersB1s_E0NCB1P_s_0NCB1P_s0_0E0Cs81r3Jv5jMWm_21rustc_trait_selection.llvm.15196016308777180469 (inlined)
               |          |          |          |          |                                |          |          |                     |          
               |          |          |          |          |                                |          |          |                      --1.78%--&lt;rustc_middle::ty::context::TyCtxt&gt;::mk_region
               |          |          |          |          |                                |          |          |          
               |          |          |          |          |                                |          |           --0.52%--&lt;rustc_middle::ty::context::TyCtxt&gt;::intern_substs
(cut)
</pre></div>
<p>Oh, actually that looks okay?</p>
<p>Let&#39;s try making flamegraph with <a href="https://lib.rs/crates/inferno">inferno</a>:</p>
<div><p>Shell session</p><pre data-lang="shell">$ perf script | inferno-collapse-perf | inferno-flamegraph &gt; rustc.svg
(lots and lots of DWARF errors)
</pre></div>
            <picture>
                <source type="image/avif" srcset="/content/articles/when-rustc-explodes/assets/flamegraph2.eebf819eb701c7ef.avif"/>
                <source type="image/webp" srcset="/content/articles/when-rustc-explodes/assets/flamegraph2.476e42703bf150db.webp"/>
                <img loading="lazy" src="https://jvns.ca/content/articles/when-rustc-explodes/assets/flamegraph2.54b180eb7d3ad169.jpg" title="another flamegraph, showing various internal rustc functions" alt="another flamegraph, showing various internal rustc functions"/>
            </picture>
            
<p>Yeah huh, this is not as bad as I thought actually.</p>
<p>I have a feeling the DWARF errors are caused by the lack of support for newer
DWARF features in Ubuntu 22.04.</p>
<div>

<p>Mhh maybe if you tell <code>perf</code> to use another <code>addr2line</code> implementation? The one
from LLVM maybe?</p>
</div>
<p>Yeah yeah, I&#39;ve see the <a href="https://lore.kernel.org/lkml/1350899172-16965-4-git-send-email-irina.tirdea@gmail.com/">perf patch for
that</a>
too, but: it doesn&#39;t seem to be accepted by <code>perf script</code> on Ubuntu 22.04, and also
<code>llvm-addr2line</code> (a wrapper over <code>llvm-symbolize</code>) is straight up not provided by
LLVM 14 packages from <a href="https://apt.llvm.org/">their own repository</a>. So uh, yeah.</p>
<p>And the other issue is: if you look closer at the flamegraph above, you&#39;ll see that
it goes: <code>all</code>, <code>rustc</code>, and then <code>[unknown]</code>. A bunch of the call stack is missing!</p>
<p>That&#39;s because perf only captures 8KB of the stack by default. You can bump that
up to 65528 bytes with <code>--call-graph dwarf,65528</code> (yes that&#39;s the actual upper
limit), but that makes <code>perf.data</code> even larger, and <code>perf report</code> / <code>perf script</code> even slower.</p>
<p><strong>Update</strong>: as it turns out, <code>llvm-addr2line</code> <em>is</em> provided by the packages in
LLVM&#39;s APT repository, it&#39;s just named <code>llvm-addr2line-14</code> for me. Still no
<code>--addr2line=</code> flag in <code>perf</code> for me though, so with a quick wrapper in
<code>/tmp/addr2line-wrapper/addr2line</code></p>
<div><p>Bash</p><pre data-lang="bash"><i>#!/bin/bash -eu</i>
<i>llvm-addr2line-14</i> <i>&#34;<i>$</i>@&#34;</i>
</pre></div><div>

<p>This trick works (almost) anytime you want to trick a program into executing
another program instead of what&#39;s naturally in your <code>$PATH</code>.</p>
</div>
<p>Let&#39;s try using the <a href="https://profiler.firefox.com">Firefox profiler</a> to
visualize our profile this time, by <a href="https://profiler.firefox.com/docs/#/./guide-perf-profiling">following the
instructions</a> carefully:</p>
<div><p>Shell session</p><pre data-lang="shell">$ perf record --call-graph dwarf rustc src/main.rs --emit=metadata --cfg &#39;depth = &#34;8&#34;&#39; 
$ chmod +x /tmp/addr2line-wrapper/addr2line
$ PATH=/tmp/addr2line-wrapper:$PATH perf script -F +pid &gt; test.perf
</pre></div>
<p>Then we just drag it onto the web app, and... there!</p>

            <picture>
                <source type="image/avif" srcset="/content/articles/when-rustc-explodes/assets/firefox-profiler.be3a0c2b6b1d4e0c.avif"/>
                <source type="image/webp" srcset="/content/articles/when-rustc-explodes/assets/firefox-profiler.495bb18ce2c3fffe.webp"/>
                <img loading="lazy" src="https://jvns.ca/content/articles/when-rustc-explodes/assets/firefox-profiler.af66366ea91d32fc.jpg" title="a screenshot of the Firefox profiler" alt="a screenshot of the Firefox profiler"/>
            </picture>
            
<p>One <em>extremely</em> neat thing about Firefox profiler is you can share your profile
online. Here&#39;s <a href="https://share.firefox.dev/3RJBP8j">the profile above</a>, have a
look!</p>

                        <h2>
                            <a id="profiling-with-not-perf-nperf" href="#profiling-with-not-perf-nperf">
                                Profiling with <code>not-perf</code> (<code>nperf</code>)
                            </a>
                        </h2>
                        
<p>Even though <code>perf</code> is super versatile, as far as CPU sampling profilers go, I prefer
something a little more modern, like <a href="https://github.com/koute/not-perf">not-perf</a>.</p>
<p>It produces smaller profiles, does symbolication on the fly (I stole this term
from Sentry, it just means &#34;turning addresses into symbols&#34;, what <code>addr2line</code>
does), and has built-in flamegraph and chrome-tracing generation facilities.</p>
<p>It&#39;s not published on crates.io as far as I can tell, so you&#39;ll want to clone it
locally and run <code>cargo install --path ./cli</code> or something, and then you can do this
in one terminal session:</p>
<div><p>Shell session</p><pre data-lang="shell">$ nperf record --process rustc --wait
</pre></div>
<p>And this in another:</p>
<div><p>Shell session</p><pre data-lang="shell">$ rustc src/main.rs --emit=metadata --cfg &#39;depth = &#34;8&#34;&#39;
</pre></div>
<p>Our nperf session completes nicely:</p>
<div><p>Shell session</p><pre data-lang="shell">$ nperf record --process rustc --wait
[2022-07-13T11:38:35Z INFO  nperf_core::ps] Waiting for process named &#39;rustc&#39;...
[2022-07-13T11:38:44Z INFO  nperf_core::ps] Process &#39;rustc&#39; found with PID 1438757!
[2022-07-13T11:38:44Z INFO  nperf_core::profiler] Opening &#34;20220713_113844_1438757_rustc.nperf&#34; for writing...
[2022-07-13T11:38:44Z INFO  nperf_core::cmd_record] Opening perf events for process with PID 1438757...
[2022-07-13T11:38:44Z INFO  nperf_core::profiler] Finished output file initialization
[2022-07-13T11:38:44Z INFO  nperf_core::cmd_record] Enabling perf events...
[2022-07-13T11:38:44Z INFO  nperf_core::cmd_record] Running...
[2022-07-13T11:38:45Z INFO  nperf_core::profiler] Collected 457 samples in total!
</pre></div>
<p>And now we can generate a flamegraph from it:</p>
<div><p>Shell session</p><pre data-lang="shell">$ nperf flamegraph $(ls -t *.nperf | head -1) -o rustc.svg
[2022-07-13T11:39:34Z WARN  nperf_core::data_reader] Missing external debug symbols for &#39;/usr/lib/x86_64-linux-gnu/libm.so.6&#39;: &#39;a8c28af0bfefefcf69ba73f7d4582d82e01f71.debug&#39;
[2022-07-13T11:39:34Z WARN  nperf_core::data_reader] Missing external debug symbols for &#39;/home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/libLLVM-14-rust-1.62.0-stable.so&#39;: &#39;crti.o&#39;
[2022-07-13T11:39:34Z WARN  nperf_core::data_reader] Missing external debug symbols for &#39;/usr/lib/x86_64-linux-gnu/libc.so.6&#39;: &#39;c3cb85f9e55046776471fed05ec441581d1969.debug&#39;
[2022-07-13T11:39:34Z WARN  nperf_core::data_reader] Missing external debug symbols for &#39;/usr/lib/x86_64-linux-gnu/libz.so.1.2.11&#39;: &#39;2e9768303892af62d212ec9357a7f1a0824a91.debug&#39;
[2022-07-13T11:39:34Z WARN  nperf_core::data_reader] Missing external debug symbols for &#39;/usr/lib/x86_64-linux-gnu/librt.so.1&#39;: &#39;0915c138c86b44167c7f53256fc375332fbe47.debug&#39;
[2022-07-13T11:39:34Z WARN  nperf_core::data_reader] Missing external debug symbols for &#39;/usr/lib/x86_64-linux-gnu/libgcc_s.so.1&#39;: &#39;3e9a70a55a0249b33d01e903049a7657f5c0ae.debug&#39;
[2022-07-13T11:39:34Z WARN  nperf_core::data_reader] Missing external debug symbols for &#39;/usr/lib/x86_64-linux-gnu/libdl.so.2&#39;: &#39;63bd5ea2a58dd8b60ee92a5081f753391db642.debug&#39;
[2022-07-13T11:39:34Z WARN  nperf_core::data_reader] Missing external debug symbols for &#39;/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2&#39;: &#39;1b0b998999c397062e1016f0c95dc0e8820117.debug&#39;
</pre></div>
<p>(As usual, Ubuntu&#39;s awful track record with debug symbols means we&#39;re missing info
for a bunch of system libraries, and good luck finding those!)</p>

            <picture>
                <source type="image/avif" srcset="/content/articles/when-rustc-explodes/assets/flamegraph-nperf.ac9d60236df1848d.avif"/>
                <source type="image/webp" srcset="/content/articles/when-rustc-explodes/assets/flamegraph-nperf.ec43a10e33d878d4.webp"/>
                <img loading="lazy" src="https://jvns.ca/content/articles/when-rustc-explodes/assets/flamegraph-nperf.bf712b0304cff39c.jpg" title="A flamegraph generated with nperf. It&#39;s much deeper, we have full callstacks here" alt="A flamegraph generated with nperf. It&#39;s much deeper, we have full callstacks here"/>
            </picture>
            
<p>This time our callstacks are complete, so we can see the whole thing. At this
point we already have a good candidate, but I&#39;m going to keep showing tools
because I can.</p>
<p>nperf can also generate a <code>chrome_profiler.json</code> file that we can load with
<code>chrome://tracing</code>:</p>
<div><p>Shell session</p><pre data-lang="shell">$ nperf trace-events $(ls -t *.nperf | head -1) -o chrome_profiler.json 
(cut: missing symbols warnings)
[2022-07-13T11:43:48Z INFO  nperf_core::cmd_trace_events] Profiling data frequency: 900
[2022-07-13T11:43:48Z INFO  nperf_core::cmd_trace_events] Trace period for frame collapsing: 1140us
</pre></div>
<p>Unfortunately, it&#39;s a little buggy at the moment and the generated JSON has an
empty record in first position, like so:</p>
<div><p>json</p><pre data-lang="json">[,{&#34;name&#34;: &#34;0x0000000000000000&#34;,&#34;ph&#34;: &#34;B&#34;,&#34;ts&#34;: 102138637276.717,&#34;pid&#34;: 1438757,&#34;tid&#34;: 1438757}
</pre></div>
<p>We can just remove that extra comma and be on our merry way.</p>

            <picture>
                <source type="image/avif" srcset="/content/articles/when-rustc-explodes/assets/chrome-tracing-hard-to-see.6734e1cd2ab753ce.avif"/>
                <source type="image/webp" srcset="/content/articles/when-rustc-explodes/assets/chrome-tracing-hard-to-see.1f3739776ded809e.webp"/>
                <img loading="lazy" src="https://jvns.ca/content/articles/when-rustc-explodes/assets/chrome-tracing-hard-to-see.d2ee0fd78adb662b.jpg" title="A chrome tracing profile, full of colors but really hard to read unless we zoom in" alt="A chrome tracing profile, full of colors but really hard to read unless we zoom in"/>
            </picture>
            
<p>This isn&#39;t very readable unless we zoom in a little:</p>

            <picture>
                <source type="image/avif" srcset="/content/articles/when-rustc-explodes/assets/chrome-tracing-zoomed-in.6bca3b0ad90b5c02.avif"/>
                <source type="image/webp" srcset="/content/articles/when-rustc-explodes/assets/chrome-tracing-zoomed-in.d46c4166de8b92fc.webp"/>
                <img loading="lazy" src="https://jvns.ca/content/articles/when-rustc-explodes/assets/chrome-tracing-zoomed-in.67b3a66c9d8081b3.jpg" title="the same profile, zoomed in. We can see resolve_instance calls inner_resolve_instance, codegen_fulfill_obligation, try_execute_query, codegen_fulfill_obligation, a closure, select_all_or_error, process_obligations, process_changed_obligations, predicate_must_hold_considering_regions, evaluate_obligation a couple times, evaluate_root_obligation, then several layers of evaluate_predicate_recursively, which end up in poly_project_and_unify_type, opt_normalize_projection_type, commit_if_ok, select, and in another leaf, there&#39;s confirm_candidate, rematch_impl, and make_eqregion" alt="the same profile, zoomed in. We can see resolve_instance calls inner_resolve_instance, codegen_fulfill_obligation, try_execute_query, codegen_fulfill_obligation, a closure, select_all_or_error, process_obligations, process_changed_obligations, predicate_must_hold_considering_regions, evaluate_obligation a couple times, evaluate_root_obligation, then several layers of evaluate_predicate_recursively, which end up in poly_project_and_unify_type, opt_normalize_projection_type, commit_if_ok, select, and in another leaf, there&#39;s confirm_candidate, rematch_impl, and make_eqregion"/>
            </picture>
            
<p>If we load our profile in another tool, like
<a href="https://www.speedscope.app/">Speedscope</a>, we can get another visualization:</p>

            <picture>
                <source type="image/avif" srcset="/content/articles/when-rustc-explodes/assets/speedscope.baa126ada307bacc.avif"/>
                <source type="image/webp" srcset="/content/articles/when-rustc-explodes/assets/speedscope.5d08bd1a2730d1e4.webp"/>
                <img loading="lazy" src="https://jvns.ca/content/articles/when-rustc-explodes/assets/speedscope.89b916aa07cf3c0e.jpg" title="speedscope screenshot, focused on a bunch of evaluate_predicate_recursively calls." alt="speedscope screenshot, focused on a bunch of evaluate_predicate_recursively calls."/>
            </picture>
            
<p>Even though we&#39;re in &#34;time order&#34; mode, we can see that the stack goes deep,
<em>very</em> deep. Good thing rustc uses the <a href="https://lib.rs/crates/stacker">stacker</a>
crate internally.</p>

                        <h2>
                            <a id="profiling-with-callgrind" href="#profiling-with-callgrind">
                                Profiling with callgrind
                            </a>
                        </h2>
                        
<p>I wanted to try out another profiling tool: valgrind&#39;s own &#34;callgrind&#34;.</p>
<div>

<p><a href="https://valgrind.org/">valgrind</a> is &#34;an instrumentation framework for building
dynamic analysis tools&#34;. It doesn&#39;t <em>just</em> detect memory corruption, memory
leaks or cache misses, it also comes with a profiler.</p>
</div>
<p>But I couldn&#39;t. Apparently rustup shims include DWARF5 debug information, which
Valgrind doesn&#39;t properly support yet:</p>
<div><p>Rust code</p><pre data-lang="rust">$ valgrind --quiet --trace-children=yes --tool=callgrind rustc src/main<i>.</i><i>rs</i> --emit=metadata -v
### unhandled dwarf2 abbrev form code <i>0x25</i>
### unhandled dwarf2 abbrev form code <i>0x25</i>
### unhandled dwarf2 abbrev form code <i>0x25</i>
### unhandled dwarf2 abbrev form code <i>0x23</i>
==<i>1479608</i>== Valgrind: debuginfo reader: ensure_valid failed:
==<i>1479608</i>== Valgrind:   during call to ML_<i>(</i>img_get<i>)</i>
==<i>1479608</i>== Valgrind:   request <i>for</i> range <i>[</i><i>3693702622</i>, +<i>4</i><i>)</i> exceeds
==<i>1479608</i>== Valgrind:   valid image size of <i>15825920</i> <i>for</i> image:
==<i>1479608</i>== Valgrind:   <i>&#34;/home/amos/.cargo/bin/rustc&#34;</i>
==<i>1479608</i>== 
==<i>1479608</i>== Valgrind: debuginfo reader: Possibly corrupted debuginfo file<i>.</i>
==<i>1479608</i>== Valgrind: I can<i>&#39;</i>t recover<i>.</i>  <i>Giving</i> up<i>.</i>  <i>Sorry</i><i>.</i>
==<i>1479608</i>== 
</pre></div>
<p>Here&#39;s the <a href="https://bugs.kde.org/show_bug.cgi?id=452758">upstream valgrind issue</a>.</p>
<p>Stripping those, or using the &#34;actual&#34; rustc executable didn&#39;t get me much
further, even with a custom build of rustc. It seems something goes wrong with
LLVM at some point:</p>
<div><p>Rust code</p><pre data-lang="rust">$ valgrind --quiet --trace-children=yes --tool=callgrind /home/amos/<i>.</i><i>rustup</i>/toolchains/stage1/bin/rustc src/main<i>.</i><i>rs</i> --emit=metadata -v
rustc -Cllvm-args=<i>&#34;...&#34;</i> with: Unknown command line argument <i>&#39;</i>-generate-arange-section<i>&#39;</i><i>.</i>  <i>Try</i>: <i>&#39;</i>rustc -Cllvm-args=<i>&#34;...&#34;</i> with --help<i>&#39;</i>
rustc -Cllvm-args=<i>&#34;...&#34;</i> with: Did you mean <i>&#39;</i>--W=enerate-arange-section<i>&#39;</i>?
rustc -Cllvm-args=<i>&#34;...&#34;</i> with: Unknown command line argument <i>&#39;</i>-mergefunc-use-aliases<i>&#39;</i><i>.</i>  <i>Try</i>: <i>&#39;</i>rustc -Cllvm-args=<i>&#34;...&#34;</i> with --help<i>&#39;</i>
rustc -Cllvm-args=<i>&#34;...&#34;</i> with: Did you mean <i>&#39;</i>--W=ergefunc-use-aliases<i>&#39;</i>?<i></i>
</pre></div>
<p>And manually adding unstable rustc flags just to get it to stop passing those
flags to LLVM didn&#39;t fix whatever the problem is. It just failed later:</p>
<div><p>Rust code</p><pre data-lang="rust">$ valgrind --quiet --trace-children=yes --tool=callgrind /home/amos/<i>.</i><i>rustup</i>/toolchains/stage1/bin/rustc src/main<i>.</i><i>rs</i> --emit=metadata -v -Z no-generate-arange-section -Z merge-functions=disabled
LLVM ERROR: Expected token before separator <i>in</i> datalayout string
</pre></div>
<p>I did make sure that rustc was loading its own copy of LLVM:</p>
<div><p>Rust code</p><pre data-lang="rust">$ valgrind --quiet --trace-children=yes --tool=callgrind env LD_DEBUG=files /home/amos/<i>.</i><i>rustup</i>/toolchains/stage1/bin/rustc src/main<i>.</i><i>rs</i> --emit=metadata -v <i>2</i>&gt;<i>&amp;</i><i>1</i> | grep -i llvm
   <i>1481228</i>:     file=libLLVM-<i>14</i>-rust-<i>1.64</i><i>.</i><i>0</i>-nightly<i>.</i><i>so</i> <i>[</i><i>0</i><i>]</i><i>;</i>  needed by /home/amos/work/rust/build/x86_64-unknown-linux-gnu/stage1/bin/../lib/librustc_driver-dc663798d2165e22<i>.</i><i>so</i> <i>[</i><i>0</i><i>]</i>
   <i>1481228</i>:     file=libLLVM-<i>14</i>-rust-<i>1.64</i><i>.</i><i>0</i>-nightly<i>.</i><i>so</i> <i>[</i><i>0</i><i>]</i><i>;</i>  generating link map
   <i>1481228</i>:     file=librt<i>.</i><i>so</i><i>.</i><i>1</i> <i>[</i><i>0</i><i>]</i><i>;</i>  needed by /home/amos/work/rust/build/x86_64-unknown-linux-gnu/stage1/bin/../lib/../lib/libLLVM-<i>14</i>-rust-<i>1.64</i><i>.</i><i>0</i>-nightly<i>.</i><i>so</i> <i>[</i><i>0</i><i>]</i>
   <i>1481228</i>:     file=libdl<i>.</i><i>so</i><i>.</i><i>2</i> <i>[</i><i>0</i><i>]</i><i>;</i>  needed by /home/amos/work/rust/build/x86_64-unknown-linux-gnu/stage1/bin/../lib/../lib/libLLVM-<i>14</i>-rust-<i>1.64</i><i>.</i><i>0</i>-nightly<i>.</i><i>so</i> <i>[</i><i>0</i><i>]</i>
   <i>1481228</i>:     file=libpthread<i>.</i><i>so</i><i>.</i><i>0</i> <i>[</i><i>0</i><i>]</i><i>;</i>  needed by /home/amos/work/rust/build/x86_64-unknown-linux-gnu/stage1/bin/../lib/../lib/libLLVM-<i>14</i>-rust-<i>1.64</i><i>.</i><i>0</i>-nightly<i>.</i><i>so</i> <i>[</i><i>0</i><i>]</i>
   <i>1481228</i>:     file=libz<i>.</i><i>so</i><i>.</i><i>1</i> <i>[</i><i>0</i><i>]</i><i>;</i>  needed by /home/amos/work/rust/build/x86_64-unknown-linux-gnu/stage1/bin/../lib/../lib/libLLVM-<i>14</i>-rust-<i>1.64</i><i>.</i><i>0</i>-nightly<i>.</i><i>so</i> <i>[</i><i>0</i><i>]</i>
   <i>1481228</i>:     calling init: /home/amos/work/rust/build/x86_64-unknown-linux-gnu/stage1/bin/../lib/../lib/libLLVM-<i>14</i>-rust-<i>1.64</i><i>.</i><i>0</i>-nightly<i>.</i><i>so</i>
rustc -Cllvm-args=<i>&#34;...&#34;</i> with: Unknown command line argument <i>&#39;</i>-generate-arange-section<i>&#39;</i><i>.</i>  <i>Try</i>: <i>&#39;</i>rustc -Cllvm-args=<i>&#34;...&#34;</i> with --help<i>&#39;</i>
rustc -Cllvm-args=<i>&#34;...&#34;</i> with: Did you mean <i>&#39;</i>--W=enerate-arange-section<i>&#39;</i>?
rustc -Cllvm-args=<i>&#34;...&#34;</i> with: Unknown command line argument <i>&#39;</i>-mergefunc-use-aliases<i>&#39;</i><i>.</i>  <i>Try</i>: <i>&#39;</i>rustc -Cllvm-args=<i>&#34;...&#34;</i> with --help<i>&#39;</i>
rustc -Cllvm-args=<i>&#34;...&#34;</i> with: Did you mean <i>&#39;</i>--W=ergefunc-use-aliases<i>&#39;</i>?
   <i>1481228</i>:     calling fini: /home/amos/work/rust/build/x86_64-unknown-linux-gnu/stage1/bin/../lib/../lib/libLLVM-<i>14</i>-rust-<i>1.64</i><i>.</i><i>0</i>-nightly<i>.</i><i>so</i> <i>[</i><i>0</i><i>]</i><i></i>
</pre></div>
<p>So I have no idea what&#39;s going on here.</p>
<p>Next!</p>

                        <h2>
                            <a id="self-profiling-deeper-with-jq" href="#self-profiling-deeper-with-jq">
                                Self-profiling deeper with <code>jq</code>
                            </a>
                        </h2>
                        
<p>So we&#39;ve seen two ways to generate flamegraphs and chrome-tracing profiles.</p>
<p>One through rustc self-profiling (<code>-Z self-profile</code>), and one through profilers
like <code>perf</code>, <code>nperf</code>, or, whenever I can figure out how to fix it, <code>valgrind</code>.</p>
<p>The problem with CPU profilers is that we don&#39;t know what arguments are being
passed to those functions. We noticed we were spending a lot of time in
<code>evaluate_predicate_recursively</code>, but we don&#39;t know <em>what</em> predicate is being
evaluated recursively.</p>
<p>And the problem with self-profiling (and tracing) is that... it depends on how
much code has been instrumented.</p>
<p>That&#39;s where building our own rustc comes in. I <a href="https://rustc-dev-guide.rust-lang.org/">followed the dev
guide</a> and reached a point where I
could build my own version of the compiler with a single command!</p>
<p>Here&#39;s a &#34;hot&#34; build: that&#39;s me changing code in a single <code>rustc</code> crate, not a
full, from-scratch build. It&#39;s not even a <code>stage2</code> build, just <code>stage1</code>:</p>
<div><p>Shell session</p><pre data-lang="shell">$ ./x.py build library
Building rustbuild
   Compiling lzma-sys v0.1.17
   Compiling xz2 v0.1.6
   Compiling bootstrap v0.0.0 (/home/amos/work/rust/src/bootstrap)
    Finished dev [unoptimized] target(s) in 5.16s
Building stage0 std artifacts (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu)
    Finished release [optimized] target(s) in 0.16s
Copying stage0 std from stage0 (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu / x86_64-unknown-linux-gnu)
Building stage0 compiler artifacts (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu)
   Compiling rustc_llvm v0.0.0 (/home/amos/work/rust/compiler/rustc_llvm)
   Compiling rustc_log v0.0.0 (/home/amos/work/rust/compiler/rustc_log)
   Compiling rustc_trait_selection v0.0.0 (/home/amos/work/rust/compiler/rustc_trait_selection)
   Compiling rustc_lint v0.0.0 (/home/amos/work/rust/compiler/rustc_lint)
   Compiling rustc_ty_utils v0.0.0 (/home/amos/work/rust/compiler/rustc_ty_utils)
   Compiling rustc_const_eval v0.0.0 (/home/amos/work/rust/compiler/rustc_const_eval)
   Compiling rustc_traits v0.0.0 (/home/amos/work/rust/compiler/rustc_traits)
   Compiling rustc_mir_build v0.0.0 (/home/amos/work/rust/compiler/rustc_mir_build)
   Compiling rustc_typeck v0.0.0 (/home/amos/work/rust/compiler/rustc_typeck)
   Compiling rustc_plugin_impl v0.0.0 (/home/amos/work/rust/compiler/rustc_plugin_impl)
   Compiling rustc_mir_transform v0.0.0 (/home/amos/work/rust/compiler/rustc_mir_transform)
   Compiling rustc_borrowck v0.0.0 (/home/amos/work/rust/compiler/rustc_borrowck)
   Compiling rustc_privacy v0.0.0 (/home/amos/work/rust/compiler/rustc_privacy)
   Compiling rustc_codegen_llvm v0.0.0 (/home/amos/work/rust/compiler/rustc_codegen_llvm)
   Compiling rustc_interface v0.0.0 (/home/amos/work/rust/compiler/rustc_interface)
   Compiling rustc_driver v0.0.0 (/home/amos/work/rust/compiler/rustc_driver)
   Compiling rustc_smir v0.0.0 (/home/amos/work/rust/compiler/rustc_smir)
   Compiling rustc-main v0.0.0 (/home/amos/work/rust/compiler/rustc)
    Finished release [optimized + debuginfo] target(s) in 33.73s
Copying stage0 rustc from stage0 (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu / x86_64-unknown-linux-gnu)
Assembling stage1 compiler (x86_64-unknown-linux-gnu)
Building stage1 std artifacts (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu)
   Compiling compiler_builtins v0.1.73
   Compiling core v0.0.0 (/home/amos/work/rust/library/core)
   Compiling libc v0.2.126
   Compiling cc v1.0.69
   Compiling memchr v2.4.1
   Compiling std v0.0.0 (/home/amos/work/rust/library/std)
   Compiling unwind v0.0.0 (/home/amos/work/rust/library/unwind)
   Compiling rustc-std-workspace-core v1.99.0 (/home/amos/work/rust/library/rustc-std-workspace-core)
   Compiling alloc v0.0.0 (/home/amos/work/rust/library/alloc)
   Compiling cfg-if v0.1.10
   Compiling adler v0.2.3
   Compiling rustc-demangle v0.1.21
   Compiling rustc-std-workspace-alloc v1.99.0 (/home/amos/work/rust/library/rustc-std-workspace-alloc)
   Compiling panic_unwind v0.0.0 (/home/amos/work/rust/library/panic_unwind)
   Compiling panic_abort v0.0.0 (/home/amos/work/rust/library/panic_abort)
   Compiling gimli v0.25.0
   Compiling miniz_oxide v0.4.0
   Compiling hashbrown v0.12.0
   Compiling std_detect v0.1.5 (/home/amos/work/rust/library/stdarch/crates/std_detect)
   Compiling object v0.26.2
   Compiling addr2line v0.16.0
   Compiling rustc-std-workspace-std v1.99.0 (/home/amos/work/rust/library/rustc-std-workspace-std)
   Compiling proc_macro v0.0.0 (/home/amos/work/rust/library/proc_macro)
   Compiling unicode-width v0.1.8
   Compiling getopts v0.2.21
   Compiling test v0.0.0 (/home/amos/work/rust/library/test)
    Finished release [optimized] target(s) in 41.80s
Copying stage1 std from stage1 (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu / x86_64-unknown-linux-gnu)
Build completed successfully in 0:01:21
</pre></div>
<p>It &#34;only&#34; took 1 minutes and 20 seconds. Scare quotes because that&#39;s not quite
the &#34;tight feedback loop&#34; I&#39;m dreaming of, but also, going into rustc
development, I expected much, much worse. (But also, big CPU on this machine,
etc. I&#39;m not sure how much it actually helps since there&#39;s a bunch of discrete
steps).</p>
<p>Oh, also, by following <em>more</em> instructions in the dev guide, that build is
available through rustup as the &#34;stage1&#34; toolchain.</p>
<p>Compare stable, and my build:</p>
<div><p>Shell session</p><pre data-lang="shell">$ rustc --version
rustc 1.62.0 (a8314ef7d 2022-06-27)
$ rustc +stage1 --version
rustc 1.64.0-dev
</pre></div>
<p>Anyway, if we do a quick search in rustc&#39;s code, we find this function:</p>
<div><p>Rust code</p><pre data-lang="rust"><i>//  in `rust/compiler/rustc_trait_selection/traits/select/mod.rs`</i>

    <i>fn</i> <i>evaluate_predicate_recursively</i><i>&lt;</i><i>&#39;</i><i>o</i><i>&gt;</i><i>(</i>
        <i>&amp;</i><i>mut</i> <i>self</i>,
        <i>previous_stack</i>: <i>TraitObligationStackList</i><i>&lt;</i><i>&#39;</i><i>o</i>, <i>&#39;</i><i>tcx</i><i>&gt;</i>,
        <i>obligation</i>: <i>PredicateObligation</i><i>&lt;</i><i>&#39;</i><i>tcx</i><i>&gt;</i>,
    <i>)</i> -&gt; <i>Result</i><i>&lt;</i><i>EvaluationResult</i>, <i>OverflowError</i><i>&gt;</i> {
        <i>// (cut)</i>
    }
</pre></div>
<p>And, well, we can just tell the self-profiler to record this activity, with an
argument:</p>
<div><p>Rust code</p><pre data-lang="rust"><i>//  in `rust/compiler/rustc_trait_selection/traits/select/mod.rs`</i>

    <i>fn</i> <i>evaluate_predicate_recursively</i><i>&lt;</i><i>&#39;</i><i>o</i><i>&gt;</i><i>(</i>
        <i>&amp;</i><i>mut</i> <i>self</i>,
        <i>previous_stack</i>: <i>TraitObligationStackList</i><i>&lt;</i><i>&#39;</i><i>o</i>, <i>&#39;</i><i>tcx</i><i>&gt;</i>,
        <i>obligation</i>: <i>PredicateObligation</i><i>&lt;</i><i>&#39;</i><i>tcx</i><i>&gt;</i>,
    <i>)</i> -&gt; <i>Result</i><i>&lt;</i><i>EvaluationResult</i>, <i>OverflowError</i><i>&gt;</i> {
        <i>let</i> _prof_timer = <i>self</i><i>.</i><i>infcx</i><i>.</i><i>tcx</i><i>.</i><i>prof</i><i>.</i><i>generic_activity_with_arg_recorder</i><i>(</i>
            <i>&#34;evaluate_predicate_recursively&#34;</i>,
            |recorder| {
                recorder<i>.</i><i>record_arg</i><i>(</i><i>format</i><i>!</i><i>(</i><i>&#34;{:?}&#34;</i>, obligation<i>)</i><i>)</i><i>;</i>
            },
        <i>)</i><i>;</i>

        <i>// (cut)</i>
    }
</pre></div>
<p>Now we rebuild with <code>./x.py build library</code>... and run it again with <code>-Z self-profile</code>, making sure to record arguments:</p>
<div><p>Shell session</p><pre data-lang="shell">$ rustc +stage1 src/main.rs --emit=metadata --cfg &#39;depth = &#34;7&#34;&#39; -Z self-profile -Z self-profile-events=default,args
</pre></div>
<p>And instead of opening that up in <code>chrome://tracing</code>, we can do some digging
ourselves with the generated JSON:</p>
<div><p>Shell session</p><pre data-lang="shell">$ crox $(ls -t *profdata | tail -1)
$ jq -r &#39;.[] | select(.name == &#34;evaluate_predicate_recursively&#34;) | .args.arg0&#39; chrome_profiler.json | sed -E &#39;s/depth=[0-9]+/depth=?/&#39; | sort -n | uniq -c | sort -n
      1 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;&amp;&amp;&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:5 ~ main[b0d6]::Trait::A) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
      1 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;&amp;&amp;&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:6 ~ main[b0d6]::Trait::B) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
      1 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;&amp;&amp;&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:7 ~ main[b0d6]::Trait::C) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
      1 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;&amp;&amp;&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:8 ~ main[b0d6]::Trait::D) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
      1 Obligation(predicate=Binder(TraitPredicate(&lt;&amp;&amp;&amp;&amp;&amp;&amp;() as std::marker::Sized&gt;, polarity:Positive), []), depth=?)
      1 Obligation(predicate=Binder(TraitPredicate(&lt;() as std::process::Termination&gt;, polarity:Positive), []), depth=?)
      1 Obligation(predicate=Binder(TraitPredicate(&lt;&amp;&amp;&amp;&amp;&amp;&amp;() as Trait&lt;&#39;x&gt;&gt;, polarity:Positive), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
      6 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;&amp;&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:5 ~ main[b0d6]::Trait::A) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
      6 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;&amp;&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:6 ~ main[b0d6]::Trait::B) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
      6 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;&amp;&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:7 ~ main[b0d6]::Trait::C) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
      6 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;&amp;&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:8 ~ main[b0d6]::Trait::D) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
      6 Obligation(predicate=Binder(TraitPredicate(&lt;&amp;&amp;&amp;&amp;&amp;() as std::marker::Sized&gt;, polarity:Positive), []), depth=?)
      6 Obligation(predicate=Binder(TraitPredicate(&lt;&amp;&amp;&amp;&amp;&amp;() as Trait&lt;&#39;x&gt;&gt;, polarity:Positive), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
     26 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:5 ~ main[b0d6]::Trait::A) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
     26 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:6 ~ main[b0d6]::Trait::B) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
     26 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:7 ~ main[b0d6]::Trait::C) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
     26 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:8 ~ main[b0d6]::Trait::D) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
     26 Obligation(predicate=Binder(TraitPredicate(&lt;&amp;&amp;&amp;&amp;() as std::marker::Sized&gt;, polarity:Positive), []), depth=?)
     26 Obligation(predicate=Binder(TraitPredicate(&lt;&amp;&amp;&amp;&amp;() as Trait&lt;&#39;x&gt;&gt;, polarity:Positive), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
    106 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:5 ~ main[b0d6]::Trait::A) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
    106 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:6 ~ main[b0d6]::Trait::B) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
    106 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:7 ~ main[b0d6]::Trait::C) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
    106 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:8 ~ main[b0d6]::Trait::D) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
    106 Obligation(predicate=Binder(TraitPredicate(&lt;&amp;&amp;&amp;() as std::marker::Sized&gt;, polarity:Positive), []), depth=?)
    106 Obligation(predicate=Binder(TraitPredicate(&lt;&amp;&amp;&amp;() as Trait&lt;&#39;x&gt;&gt;, polarity:Positive), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
    426 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:5 ~ main[b0d6]::Trait::A) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
    426 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:6 ~ main[b0d6]::Trait::B) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
    426 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:7 ~ main[b0d6]::Trait::C) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
    426 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:8 ~ main[b0d6]::Trait::D) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
    426 Obligation(predicate=Binder(TraitPredicate(&lt;&amp;&amp;() as std::marker::Sized&gt;, polarity:Positive), []), depth=?)
    426 Obligation(predicate=Binder(TraitPredicate(&lt;&amp;&amp;() as Trait&lt;&#39;x&gt;&gt;, polarity:Positive), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
   1706 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:5 ~ main[b0d6]::Trait::A) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
   1706 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:6 ~ main[b0d6]::Trait::B) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
   1706 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:7 ~ main[b0d6]::Trait::C) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
   1706 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:8 ~ main[b0d6]::Trait::D) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
   1706 Obligation(predicate=Binder(TraitPredicate(&lt;&amp;() as std::marker::Sized&gt;, polarity:Positive), []), depth=?)
   1706 Obligation(predicate=Binder(TraitPredicate(&lt;&amp;() as Trait&lt;&#39;x&gt;&gt;, polarity:Positive), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
   6826 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:5 ~ main[b0d6]::Trait::A) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
   6826 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:6 ~ main[b0d6]::Trait::B) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
   6826 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:7 ~ main[b0d6]::Trait::C) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
   6826 Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:8 ~ main[b0d6]::Trait::D) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
   6826 Obligation(predicate=Binder(TraitPredicate(&lt;() as Trait&lt;&#39;x&gt;&gt;, polarity:Positive), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=?)
   6828 Obligation(predicate=Binder(TraitPredicate(&lt;() as std::marker::Sized&gt;, polarity:Positive), []), depth=?)
</pre></div>
<p>And I don&#39;t know how you feel about it but... this is <em>such</em> a cool
visualization of the problem. We can see that the top-level obligations (on
<code>&amp;&amp;&amp;&amp;&amp;&amp;()</code>) are only evaluated once, the next level are evaluated 6 times (1 for
<code>Trait</code>, 4 associated types, and 1 for the implicit <code>Sized</code> trait).</p>
<div>

<p>Yeah yeah that&#39;s cool and all but... don&#39;t we have <code>debug</code>-level traces now that
we have our own rustc build?</p>
</div>
<p>Oh! Yes we do!</p>

                        <h2>
                            <a id="tracing-deeper-with-debug-spans" href="#tracing-deeper-with-debug-spans">
                                Tracing deeper with debug spans
                            </a>
                        </h2>
                        
<p>The problem with just exporting <code>RUSTC_LOG=debug</code> is that we&#39;re gonna get a
<em>lot</em> of spans. Even with <code>depth = &#34;1&#34;</code>:</p>
<div><p>Shell session</p><pre data-lang="shell">$ RUSTC_LOG=&#34;debug&#34; rustc +stage1 src/main.rs --emit=metadata --cfg &#39;depth = &#34;1&#34;&#39; 2&gt;&amp;1 | wc -l
6864
</pre></div>
<p>But we already know which span we want!</p>
<p>In fact, I didn&#39;t show you, I willingly withheld that information from you, but
<code>evaluate_predicate_recursively</code> is actually already instrumented!</p>
<div><p>Rust code</p><pre data-lang="rust">    <i>#<i>[</i>instrument<i>(</i>
        level = <i>&#34;debug&#34;</i>,
        skip<i>(</i><i>self</i>, previous_stack<i>)</i>,
        fields<i>(</i>previous_stack = ?previous_stack<i>.</i>head<i>(</i><i>)</i><i>)</i>
    <i>)</i><i>]</i></i>
    <i>fn</i> <i>evaluate_predicate_recursively</i><i>&lt;</i><i>&#39;</i><i>o</i><i>&gt;</i><i>(</i>
        <i>&amp;</i><i>mut</i> <i>self</i>,
        <i>previous_stack</i>: <i>TraitObligationStackList</i><i>&lt;</i><i>&#39;</i><i>o</i>, <i>&#39;</i><i>tcx</i><i>&gt;</i>,
        <i>obligation</i>: <i>PredicateObligation</i><i>&lt;</i><i>&#39;</i><i>tcx</i><i>&gt;</i>,
    <i>)</i> -&gt; <i>Result</i><i>&lt;</i><i>EvaluationResult</i>, <i>OverflowError</i><i>&gt;</i> {
        <i>// (cut)</i>
    }
</pre></div>
<p>So instead of using the self-profiling facilities, we can just use tracing.</p>
<p>Like so:</p>
<div><p>Shell session</p><pre data-lang="shell">$ RUSTC_LOG=&#34;rustc_trait_selection::traits::select[evaluate_predicate_recursively]=debug&#34; rustc +stage1 src/main.rs --emit=metadata --cfg &#39;depth = &#34;1&#34;&#39;
┐rustc_trait_selection::traits::select::evaluate_predicate_recursively obligation=Obligation(predicate=Binder(TraitPredicate(&lt;() as std::marker::Sized&gt;, polarity:Positive), []), depth=0), previous_stack=None
├─┐rustc_trait_selection::traits::select::evaluate_trait_predicate_recursively obligation=Obligation(predicate=Binder(TraitPredicate(&lt;() as std::marker::Sized&gt;, polarity:Positive), []), depth=0)
(cut)
├─┘
├─0ms DEBUG rustc_trait_selection::traits::select finished: Ok(EvaluatedToOk) from Obligation(predicate=Binder(TraitPredicate(&lt;() as std::process::Termination&gt;, polarity:Positive), []), depth=0)
┘
</pre></div>
<p>But even with just that, we have 1427 lines to go through. And that&#39;s just at
depth 1.  At depth 2 we have 7559 lines, depth 3 gives us 38313 lines... we
<em>are</em> looking into an exponential problem after all.</p>
<p>Wouldn&#39;t it be convenient if there was a way to visualize all that from the
comfort of a web browser?</p>
<p>Say... what if folks working on backend web services had all agreed on a
standard, years in the making, to send over spans and events and stuff?</p>
<div>

<p>Oh. Oh no. Amos what are you doi-</p>
</div>
<p>Enter <a href="https://opentelemetry.io">OpenTelemetry</a>, a &#34;collection of tools, APIs,
and SDKs. Use it to instrument, generate, collect, and export telemetry data
(metrics, logs, and traces) to help you analyze your software’s performance and
behavior&#34;.</p>
<p>That seems perfect. And what do you know, there&#39;s a
<a href="https://lib.rs/crates/tracing-opentelemetry">tracing-opentelemetry</a> adapter!</p>
<p>Now all we need is something self-hosted to receive those traces and... I guess
<a href="https://www.jaegertracing.io/">jaeger</a> could do.</p>
<p>Let&#39;s look at how rustc sets up logging:</p>
<div><p>Rust code</p><pre data-lang="rust"><i>// in `rust/compiler/rustc_log/src/lib.rs`</i>

<i>// (most functions and imports cut)</i>

<i>/// In contrast to `init_rustc_env_logger` this allows you to choose an env var</i>
<i>/// other than `RUSTC_LOG`.</i>
<i>pub</i> <i>fn</i> <i>init_env_logger</i><i>(</i><i>env</i>: <i>&amp;</i><i>str</i><i>)</i> -&gt; <i>Result</i><i>&lt;</i><i>(</i><i>)</i>, <i>Error</i><i>&gt;</i> {
    <i>let</i> filter = <i>match</i> env<i>::</i><i>var</i><i>(</i>env<i>)</i> {
        Ok<i>(</i>env<i>)</i> =&gt; <i>EnvFilter</i><i>::</i><i>new</i><i>(</i>env<i>)</i>,
        _ =&gt; <i>EnvFilter</i><i>::</i><i>default</i><i>(</i><i>)</i><i>.</i><i>add_directive</i><i>(</i><i>Directive</i><i>::</i><i>from</i><i>(</i><i>LevelFilter</i><i>::</i>WARN<i>)</i><i>)</i>,
    }<i>;</i>

    <i>let</i> color_logs = <i>match</i> env<i>::</i><i>var</i><i>(</i><i>String</i><i>::</i><i>from</i><i>(</i>env<i>)</i> + <i>&#34;_COLOR&#34;</i><i>)</i> {
        Ok<i>(</i>value<i>)</i> =&gt; <i>match</i> value<i>.</i><i>as_ref</i><i>(</i><i>)</i> {
            <i>&#34;always&#34;</i> =&gt; <i>true</i>,
            <i>&#34;never&#34;</i> =&gt; <i>false</i>,
            <i>&#34;auto&#34;</i> =&gt; <i>stderr_isatty</i><i>(</i><i>)</i>,
            _ =&gt; <i>return</i> Err<i>(</i><i>Error</i><i>::</i>InvalidColorValue<i>(</i>value<i>)</i><i>)</i>,
        },
        Err<i>(</i><i>VarError</i><i>::</i>NotPresent<i>)</i> =&gt; <i>stderr_isatty</i><i>(</i><i>)</i>,
        Err<i>(</i><i>VarError</i><i>::</i>NotUnicode<i>(</i>_value<i>)</i><i>)</i> =&gt; <i>return</i> Err<i>(</i><i>Error</i><i>::</i>NonUnicodeColorValue<i>)</i>,
    }<i>;</i>

    <i>let</i> verbose_entry_exit = <i>match</i> env<i>::</i><i>var_os</i><i>(</i><i>String</i><i>::</i><i>from</i><i>(</i>env<i>)</i> + <i>&#34;_ENTRY_EXIT&#34;</i><i>)</i> {
        None =&gt; <i>false</i>,
        Some<i>(</i>v<i>)</i> =&gt; <i>&amp;</i>v != <i>&#34;0&#34;</i>,
    }<i>;</i>

    <i>let</i> layer = tracing_tree<i>::</i><i>HierarchicalLayer</i><i>::</i><i>default</i><i>(</i><i>)</i>
        <i>.</i><i>with_writer</i><i>(</i>io<i>::</i>stderr<i>)</i>
        <i>.</i><i>with_indent_lines</i><i>(</i><i>true</i><i>)</i>
        <i>.</i><i>with_ansi</i><i>(</i>color_logs<i>)</i>
        <i>.</i><i>with_targets</i><i>(</i><i>true</i><i>)</i>
        <i>.</i><i>with_verbose_exit</i><i>(</i>verbose_entry_exit<i>)</i>
        <i>.</i><i>with_verbose_entry</i><i>(</i>verbose_entry_exit<i>)</i>
        <i>.</i><i>with_indent_amount</i><i>(</i><i>2</i><i>)</i><i>;</i>
    <i>#<i>[</i>cfg<i>(</i>parallel_compiler<i>)</i><i>]</i></i>
    <i>let</i> layer = layer<i>.</i><i>with_thread_ids</i><i>(</i><i>true</i><i>)</i><i>.</i><i>with_thread_names</i><i>(</i><i>true</i><i>)</i><i>;</i>

    <i>let</i> subscriber = tracing_subscriber<i>::</i><i>Registry</i><i>::</i><i>default</i><i>(</i><i>)</i><i>.</i><i>with</i><i>(</i>filter<i>)</i><i>.</i><i>with</i><i>(</i>layer<i>)</i><i>;</i>
    tracing<i>::</i>subscriber<i>::</i><i>set_global_default</i><i>(</i>subscriber<i>)</i><i>.</i><i>unwrap</i><i>(</i><i>)</i><i>;</i>

    Ok<i>(</i><i>(</i><i>)</i><i>)</i>
}
</pre></div>
<p>Alright, seem straight-forward enough. So now we just-</p>
<div>

<p>Amos there is no way this works. Are you going to pull tokio in there too?
Async rustc? Is that the sort of chaos you&#39;re after?</p>
</div>
<p>Well, maybe, let&#39;s find out. So first we pull in the dependencies we need:</p>
<div><p>TOML markup</p><pre data-lang="toml"><i># in `rust/compiler/rustc_log/Cargo.toml`</i>

<i>[</i><i>dependencies</i><i>]</i>
<i>atty</i> <i>=</i> <i>&#34;0.2&#34;</i>
<i>tracing</i> <i>=</i> <i>&#34;0.1.28&#34;</i>
<i>tracing-subscriber</i> <i>=</i> <i>{</i> <i>version</i> <i>=</i> <i>&#34;0.3.3&#34;</i><i>,</i> <i>default-features</i> <i>=</i> <i>false</i><i>,</i> <i>features</i> <i>=</i> <i>[</i><i>&#34;fmt&#34;</i><i>,</i> <i>&#34;env-filter&#34;</i><i>,</i> <i>&#34;smallvec&#34;</i><i>,</i> <i>&#34;parking_lot&#34;</i><i>,</i> <i>&#34;ansi&#34;</i><i>]</i> <i>}</i>
<i>tracing-tree</i> <i>=</i> <i>&#34;0.2.0&#34;</i>
<i># 👇 new</i>
<i>tracing-opentelemetry</i> <i>=</i> <i>{</i> <i>version</i> <i>=</i> <i>&#34;0.17.4&#34;</i> <i>}</i>
<i>opentelemetry-jaeger</i> <i>=</i> <i>{</i> <i>version</i> <i>=</i> <i>&#34;0.16.0&#34;</i><i>,</i> <i>features</i> <i>=</i> <i>[</i>
	<i>&#34;reqwest_blocking_collector_client&#34;</i><i>,</i>
<i>]</i> <i>}</i>
</pre></div>
<p>And then we send our traces to jaeger instead if the <code>RUSTC_JAEGER</code> environment
variable is set:</p>
<div><p>Rust code</p><pre data-lang="rust"><i>// in `rust/compiler/rustc_log/src/lib.rs`</i>

<i>pub</i> <i>fn</i> <i>init_env_logger</i><i>(</i><i>env</i>: <i>&amp;</i><i>str</i><i>)</i> -&gt; <i>Result</i><i>&lt;</i><i>(</i><i>)</i>, <i>Error</i><i>&gt;</i> {
    <i>let</i> filter = <i>match</i> env<i>::</i><i>var</i><i>(</i>env<i>)</i> {
        Ok<i>(</i>env<i>)</i> =&gt; <i>EnvFilter</i><i>::</i><i>new</i><i>(</i>env<i>)</i>,
        _ =&gt; <i>EnvFilter</i><i>::</i><i>default</i><i>(</i><i>)</i><i>.</i><i>add_directive</i><i>(</i><i>Directive</i><i>::</i><i>from</i><i>(</i><i>LevelFilter</i><i>::</i>WARN<i>)</i><i>)</i>,
    }<i>;</i>

    <i>if</i> env<i>::</i><i>var</i><i>(</i><i>&#34;RUSTC_JAEGER&#34;</i><i>)</i><i>.</i><i>is_ok</i><i>(</i><i>)</i> {
        <i>let</i> tracer = opentelemetry_jaeger<i>::</i><i>new_pipeline</i><i>(</i><i>)</i>
            <i>.</i><i>with_service_name</i><i>(</i><i>&#34;rustc&#34;</i><i>)</i>
            <i>.</i><i>with_collector_endpoint</i><i>(</i><i>&#34;http://localhost:14268/api/traces&#34;</i><i>)</i>
            <i>.</i><i>install_simple</i><i>(</i><i>)</i><i>.</i><i>unwrap</i><i>(</i><i>)</i><i>;</i>

        <i>let</i> telemetry = tracing_opentelemetry<i>::</i><i>layer</i><i>(</i><i>)</i><i>.</i><i>with_tracer</i><i>(</i>tracer<i>)</i><i>;</i>

        <i>let</i> subscriber = tracing_subscriber<i>::</i><i>Registry</i><i>::</i><i>default</i><i>(</i><i>)</i><i>.</i><i>with</i><i>(</i>filter<i>)</i><i>.</i><i>with</i><i>(</i>telemetry<i>)</i><i>;</i>
        tracing<i>::</i>subscriber<i>::</i><i>set_global_default</i><i>(</i>subscriber<i>)</i><i>.</i><i>unwrap</i><i>(</i><i>)</i><i>;</i>
    } <i>else</i> {
        <i>let</i> color_logs = <i>match</i> env<i>::</i><i>var</i><i>(</i><i>String</i><i>::</i><i>from</i><i>(</i>env<i>)</i> + <i>&#34;_COLOR&#34;</i><i>)</i> {
            Ok<i>(</i>value<i>)</i> =&gt; <i>match</i> value<i>.</i><i>as_ref</i><i>(</i><i>)</i> {
                <i>&#34;always&#34;</i> =&gt; <i>true</i>,
                <i>&#34;never&#34;</i> =&gt; <i>false</i>,
                <i>&#34;auto&#34;</i> =&gt; <i>stderr_isatty</i><i>(</i><i>)</i>,
                _ =&gt; <i>return</i> Err<i>(</i><i>Error</i><i>::</i>InvalidColorValue<i>(</i>value<i>)</i><i>)</i>,
            },
            Err<i>(</i><i>VarError</i><i>::</i>NotPresent<i>)</i> =&gt; <i>stderr_isatty</i><i>(</i><i>)</i>,
            Err<i>(</i><i>VarError</i><i>::</i>NotUnicode<i>(</i>_value<i>)</i><i>)</i> =&gt; <i>return</i> Err<i>(</i><i>Error</i><i>::</i>NonUnicodeColorValue<i>)</i>,
        }<i>;</i>

        <i>let</i> verbose_entry_exit = <i>match</i> env<i>::</i><i>var_os</i><i>(</i><i>String</i><i>::</i><i>from</i><i>(</i>env<i>)</i> + <i>&#34;_ENTRY_EXIT&#34;</i><i>)</i> {
            None =&gt; <i>false</i>,
            Some<i>(</i>v<i>)</i> =&gt; <i>&amp;</i>v != <i>&#34;0&#34;</i>,
        }<i>;</i>

        <i>let</i> layer = tracing_tree<i>::</i><i>HierarchicalLayer</i><i>::</i><i>default</i><i>(</i><i>)</i>
            <i>.</i><i>with_writer</i><i>(</i>io<i>::</i>stderr<i>)</i>
            <i>.</i><i>with_indent_lines</i><i>(</i><i>true</i><i>)</i>
            <i>.</i><i>with_ansi</i><i>(</i>color_logs<i>)</i>
            <i>.</i><i>with_targets</i><i>(</i><i>true</i><i>)</i>
            <i>.</i><i>with_verbose_exit</i><i>(</i>verbose_entry_exit<i>)</i>
            <i>.</i><i>with_verbose_entry</i><i>(</i>verbose_entry_exit<i>)</i>
            <i>.</i><i>with_indent_amount</i><i>(</i><i>2</i><i>)</i><i>;</i>
        <i>#<i>[</i>cfg<i>(</i>parallel_compiler<i>)</i><i>]</i></i>
        <i>let</i> layer = layer<i>.</i><i>with_thread_ids</i><i>(</i><i>true</i><i>)</i><i>.</i><i>with_thread_names</i><i>(</i><i>true</i><i>)</i><i>;</i>

        <i>let</i> subscriber = tracing_subscriber<i>::</i><i>Registry</i><i>::</i><i>default</i><i>(</i><i>)</i><i>.</i><i>with</i><i>(</i>filter<i>)</i><i>.</i><i>with</i><i>(</i>layer<i>)</i><i>;</i>
        tracing<i>::</i>subscriber<i>::</i><i>set_global_default</i><i>(</i>subscriber<i>)</i><i>.</i><i>unwrap</i><i>(</i><i>)</i><i>;</i>
    }

    Ok<i>(</i><i>(</i><i>)</i><i>)</i>
}
</pre></div>
<p>Now we can run jaeger&#39;s &#34;all-in-one&#34; docker image in a terminal session somewhere...</p>
<div><p>Shell session</p><pre data-lang="shell">$ docker kill jaeger ; docker rm jaeger; docker run -d --name jaeger -e SPAN_STORAGE_TYPE=badger -e COLLECTOR_ZIPKIN_HOST_PORT=:9411 -e COLLECTOR_OTLP_ENABLED=true -p 6831:6831/udp -p 6832:6832/udp -p 5778:5778 -p 16686:16686 -p 4317:4317 -p 4318:4318 -p 14250:14250 -p 14268:14268 -p 14269:14269 -p 9411:9411 jaegertracing/all-in-one:1.36
c69025488ee2384bda5263f10954eb0830d0f41e045dad5b76da5143e6d2e948
</pre></div>
<p>It&#39;s now running in the background, and the web UI is available at <a href="http://localhost:16686/">http://localhost:16686/</a>.</p>
<p>Time to send some traces to it!</p>
<div><p>Shell session</p><pre data-lang="shell">$ RUSTC_JAEGER=1 RUSTC_LOG=&#34;rustc_trait_selection::traits::select[evaluate_predicate_recursively]=debug&#34; rustc +stage1 src/main.rs --emit=metadata --cfg &#39;depth = &#34;4&#34;&#39;
</pre></div>
<p>By picking &#34;rustc&#34; from the service dropdown and hitting search, we can see a
few traces:</p>

            <picture>
                <source type="image/avif" srcset="/content/articles/when-rustc-explodes/assets/jaeger-overview.9e4e5484373f79bb.avif"/>
                <source type="image/webp" srcset="/content/articles/when-rustc-explodes/assets/jaeger-overview.9d1e70bc6368654e.webp"/>
                <img loading="lazy" src="https://jvns.ca/content/articles/when-rustc-explodes/assets/jaeger-overview.dc6aa2a68f082d62.jpg" title="Jaeger screenshot: home screen. There&#39;s a latency graph showing an operation taking 200ms. Operation names are something like poly_project_and_unify_type, evaluate_predicate_recursively, etc." alt="Jaeger screenshot: home screen. There&#39;s a latency graph showing an operation taking 200ms. Operation names are something like poly_project_and_unify_type, evaluate_predicate_recursively, etc."/>
            </picture>
            
<p>See that dot taking 200ms in the latency graph? Let&#39;s click on that... and then
collapse a few spans... and voila:</p>

            <picture>
                <source type="image/avif" srcset="/content/articles/when-rustc-explodes/assets/jaeger-recursively.c6294bef6956c346.avif"/>
                <source type="image/webp" srcset="/content/articles/when-rustc-explodes/assets/jaeger-recursively.65593de24a418601.webp"/>
                <img loading="lazy" src="https://jvns.ca/content/articles/when-rustc-explodes/assets/jaeger-recursively.05f82fcd86281fe3.jpg" title="A detailed view of an evaluate_predicate_recursively span taking 201.61ms" alt="A detailed view of an evaluate_predicate_recursively span taking 201.61ms"/>
            </picture>
            
<p>So! There&#39;s 4076 total spans, a depth of 25, and we can see exactly what
happens, when, and because of what.</p>
<p>We can expand or collapse individual spans, along with their &#34;tags&#34; (which
tracing calls attributes, if I recall correctly). Among them, the arguments to
our instrumented functions!</p>
<p>So for example the top-level predicate is about what we&#39;d expect:</p>

            <picture>
                <source type="image/avif" srcset="/content/articles/when-rustc-explodes/assets/jaeger-obligation.afc379e3346cdd5d.avif"/>
                <source type="image/webp" srcset="/content/articles/when-rustc-explodes/assets/jaeger-obligation.c38ee7ec8ea08729.webp"/>
                <img loading="lazy" src="https://jvns.ca/content/articles/when-rustc-explodes/assets/jaeger-obligation.02fdd8027b45c117.jpg" title="The top-level span is now expanded, showing tags like busy_ns, code.filepath, code.lineno, code.namespace, idle_ns, internal.span.format, obligation, otel.library.name, otel.library.version, previous_stack, thread.id and thread.name" alt="The top-level span is now expanded, showing tags like busy_ns, code.filepath, code.lineno, code.namespace, idle_ns, internal.span.format, obligation, otel.library.name, otel.library.version, previous_stack, thread.id and thread.name"/>
            </picture>
            
<p>Here is it manually formatted again:</p>
<div><pre data-lang="">Obligation(
  predicate=Binder(
    ProjectionPredicate(
      ProjectionTy {
        substs: [&amp;&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })],
        item_def_id: DefId(0:5 ~ main[b0d6]::Trait::A)
      },
      Ty(())
    ),
    [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]
  ),
  depth=0
)
</pre></div>
<p>Then we move onto <code>poly_project_and_unify_type</code>, which is relatively quick, and
then <code>evaluate_predicates_recursively</code> (predicates plural), with these:</p>
<div><pre data-lang="">[
  Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:5 ~ main[b0d6]::Trait::A) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=2),
  Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:6 ~ main[b0d6]::Trait::B) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=2),
  Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:7 ~ main[b0d6]::Trait::C) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=2),
  Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:8 ~ main[b0d6]::Trait::D) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=2),
  Obligation(predicate=Binder(TraitPredicate(&lt;&amp;&amp;() as std::marker::Sized&gt;, polarity:Positive), []), depth=2), Obligation(predicate=Binder(TraitPredicate(&lt;&amp;&amp;() as Trait&lt;&#39;x&gt;&gt;, polarity:Positive), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=2)
]
</pre></div>
<p>If we keep digging, we find another set of <code>poly_project_etc</code> and
<code>evaluate_predicate_recursively</code>, with:</p>
<div><pre data-lang="">Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:5 ~ main[b0d6]::Trait::A) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=2)
</pre></div>
<p>Then another, with:</p>
<div><pre data-lang="">Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [&amp;(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:5 ~ main[b0d6]::Trait::A) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=4)
</pre></div>
<p>Then another, with:</p>
<div><pre data-lang="">Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [(), ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x) })], item_def_id: DefId(0:5 ~ main[b0d6]::Trait::A) }, Ty(())), [Region(BrNamed(DefId(0:12 ~ main[b0d6]::{impl#0}::&#39;x), &#39;x))]), depth=6)
</pre></div>
<p>(Notice the number of <code>&amp;</code> decreases, and the <code>depth</code> increases).</p>
<p>And that one is trivially evaluated with no further nesting.</p>
<p>Exploring the rest of the graph shows much of the same. To evaluate any
constraint of the form <code>for&lt;&#39;x&gt; &lt;&amp;&amp;() as Trait&lt;&#39;x&gt;&gt;::A = ()</code>, we must first
evaluate all of these:</p>
<ul>
<li><code>for&lt;&#39;x&gt; &amp;(): Trait&lt;&#39;x&gt;</code></li>
<li><code>for&lt;&#39;x&gt; &lt;&amp;() as Trait&lt;&#39;x&gt;&gt;::A = ()</code></li>
<li><code>for&lt;&#39;x&gt; &lt;&amp;() as Trait&lt;&#39;x&gt;&gt;::B = ()</code></li>
<li><code>for&lt;&#39;x&gt; &lt;&amp;() as Trait&lt;&#39;x&gt;&gt;::C = ()</code></li>
<li><code>for&lt;&#39;x&gt; &lt;&amp;() as Trait&lt;&#39;x&gt;&gt;::D = ()</code></li>
<li><code>for&lt;&#39;x&gt; &amp;(): Sized</code></li>
</ul>
<p>And for the first 5 of these, we must evaluate all of these for <em>every deeper
level</em>. And somewhere therein lies the bug: the result of those &#34;inner&#34;
evaluations should be cached and we should never recurse that often, but we do.</p>

                        <h2>
                            <a id="what-now" href="#what-now">
                                What now?
                            </a>
                        </h2>
                        
<p>Well, now I&#39;ve run out of knowledge! I&#39;m monitoring <a href="https://github.com/rust-lang/rust/issues/99188">rust issue
99188</a> with interest, and might
keep digging to see if I can somehow figure out why these aren&#39;t getting cached.</p>
<p>Maybe this little exploration will help solve the actual issue, maybe not! Maybe
it&#39;ll give someone a taste for diving into rustc internals.</p>
<p>Anyway, that&#39;s all I got for you today. As always, thanks for watching, and
don&#39;t forget to like comment and sub-</p>

<p>Yes I do.</p>

</div><div>
  
    
    
      

  


  







<div>
    <h2>Latest video</h2>









<div>
    
        
        
        
            
        

        

        
        

        
        
        
        
        
            
        
        
         
        
            
        
        
        <div>
            <a href="https://jvns.ca/videos/getting-good-at-snes">
                
                    
                    <div>
                        <picture>
                            <source type="image/avif" srcset="https://tube.fasterthanli.me/covers/joy/cover.avif"/>
                            <source type="image/webp" srcset="https://tube.fasterthanli.me/covers/joy/cover.webp"/>
                            <img alt="video cover image" src="https://tube.fasterthanli.me/covers/joy/cover.jpg"/>
                        </picture>
                    </div>
                

                <span>
                    
                        
                        Getting good at SNES games through DLL injection
                    
                </span>
            </a>
            <div>
                <div>
                    <div>
                        <p>Apr 25, 2022</p>
                        
                            
                                
                                    <p>
                                        19 minute watch
                                    </p>
                                
                            
                        

                        
                            
                            
                        

                        
                        
                        
                            
                        
                        

                        
                        
                    </div>
                </div>

                <div>
                    
                        
                            
                            <p>Are you ever confronted with a problem and then think to yourself &#34;wait a minute,
I know how to code?&#34; — that&#39;s exactly what happened there.</p>
                        
                    
                </div>

                
                    <p><a href="https://jvns.ca/videos/getting-good-at-snes">
                        <span>
                            
                                Watch now
                            
                        </span>
                    </a>
                
            </p></div>
        </div>
    
</div>


    <p>You can watch more videos <a href="https://jvns.ca/videos">over there</a></p>
</div> <!-- Latest video -->

  
</div></div>
  </body>
</html>
