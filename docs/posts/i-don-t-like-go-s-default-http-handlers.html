<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://preslav.me/2022/08/09/i-dont-like-golang-default-http-handlers/">Original</a>
    <h1>I Don‚Äôt Like Go‚Äôs Default HTTP Handlers</h1>
    
    <div id="readability-page-1" class="page"><article><header><ol><li><a href="https://preslav.me/">Preslav Rachev</a><span>/</span></li><li><a href="https://preslav.me/posts/">My Writings</a><span>/</span></li><li><a href="https://preslav.me/2022/08/09/i-dont-like-golang-default-http-handlers/">I Don‚Äôt Like Go‚Äôs Default HTTP Handlers</a><span>/</span></li></ol></header><section><div><p>Explicit &gt; Implicit</p><p><em><strong>Disclaimer:</strong> This is my personal opinion. You don‚Äôt have to agree or disagree with it. I‚Äôd be happy if you learned something from my rant in the end.</em></p><p>All Go programmers learn early on what the shape of the standard HTTP handler function looks like:</p><div><pre tabindex="0"><code data-lang="go"><span><span><span>func</span> <span>hello</span><span>(</span><span>w</span> <span>http</span><span>.</span><span>ResponseWriter</span><span>,</span> <span>r</span> <span>*</span><span>http</span><span>.</span><span>Request</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>w</span><span>.</span><span>Write</span><span>([]</span><span>byte</span><span>(</span><span>&#34;Hello, World!&#34;</span><span>))</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>It is simple and easy to remember. At the same time, it is low-level enough not to limit or obscure the developer in any possible way‚Äîtypical Go.</p><h2 id="the-problem">The Problem <span><a href="#the-problem" aria-label="Anchor">#</a></span></h2><p>Let‚Äôs build a slightly more complex example where the flow has to go through a couple of potentially error-prone operations before returning to the client.</p><div><pre tabindex="0"><code data-lang="go"><span><span><span>func</span> <span>aMoreAdvancedHandler</span><span>(</span><span>w</span> <span>http</span><span>.</span><span>ResponseWriter</span><span>,</span> <span>r</span> <span>*</span><span>http</span><span>.</span><span>Request</span><span>)</span> <span>{</span>
</span></span><span><span>	<span>resOne</span><span>,</span> <span>err</span> <span>:=</span> <span>potentiallyDangerousOpOne</span><span>()</span>
</span></span><span><span>	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>		<span>http</span><span>.</span><span>Error</span><span>(</span><span>w</span><span>,</span> <span>err</span><span>.</span><span>Error</span><span>(),</span> <span>http</span><span>.</span><span>StatusInternalServerError</span><span>)</span>
</span></span><span><span>		<span>return</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span>
</span></span><span><span>	<span>resTwo</span><span>,</span> <span>err</span> <span>:=</span> <span>potentiallyDangerousOpTwo</span><span>(</span><span>resOne</span><span>)</span>
</span></span><span><span>	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>		<span>http</span><span>.</span><span>Error</span><span>(</span><span>w</span><span>,</span> <span>err</span><span>.</span><span>Error</span><span>(),</span> <span>http</span><span>.</span><span>StatusInternalServerError</span><span>)</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span>
</span></span><span><span>	<span>resThree</span><span>,</span> <span>err</span> <span>:=</span> <span>potentiallyDangerousOpThree</span><span>(</span><span>resTwo</span><span>)</span>
</span></span><span><span>	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>		<span>http</span><span>.</span><span>Error</span><span>(</span><span>w</span><span>,</span> <span>err</span><span>.</span><span>Error</span><span>(),</span> <span>http</span><span>.</span><span>StatusInternalServerError</span><span>)</span>
</span></span><span><span>		<span>return</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span>
</span></span><span><span>	<span>w</span><span>.</span><span>Write</span><span>([]</span><span>byte</span><span>(</span><span>&#34;Success: &#34;</span> <span>+</span> <span>resThree</span><span>))</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>And here comes the big problem in my view. You aren‚Äôt actually returning anything. Regardless of the outcome, you simply write it to the response writer. This can lead to unnoticeable and difficult to trace bugs like in the example above:</p><div><pre tabindex="0"><code data-lang="go"><span><span><span>resTwo</span><span>,</span> <span>err</span> <span>:=</span> <span>potentiallyDangerousOpTwo</span><span>(</span><span>resOne</span><span>)</span>
</span></span><span><span><span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>	<span>http</span><span>.</span><span>Error</span><span>(</span><span>w</span><span>,</span> <span>err</span><span>.</span><span>Error</span><span>(),</span> <span>http</span><span>.</span><span>StatusInternalServerError</span><span>)</span>
</span></span><span><span>	<span>// Did we forget to return here?
</span></span></span><span><span><span></span><span>}</span>
</span></span></code></pre></div><p>While we acknowledged the error, we didn‚Äôt return it immediately after it. By definition, we aren‚Äôt forced to, so the compiler wouldn‚Äôt complain either. It might lead to a situation in which, despite the error, we still tell the client that everything went alright‚Äîeither that or some other form of inconsistent behavior.</p><p>The missing empty return is sometimes referred to as a ‚Äúnaked‚Äù return. It appears in all C- Style langu¬≠ages, so it is not a problem with Go‚Äôs syntax, but it is hard for me to justify using naked returns. Whenever I can, I will make the junction always return a value, or if it is high enough in the stack (e. g. main), cause it to exit the entire application instead.</p><p>Unfortunately, this isn‚Äôt how everyone else thinks, which is why I am raising this point. Numerous HTTP frameworks for Go exist, but one of the most popular ones - <a href="https://gin-gonic.com/">Gin</a> seems to be following the same style.</p><div><pre tabindex="0"><code data-lang="go"><span><span><span>func</span> <span>(</span><span>h</span> <span>*</span><span>Handlers</span><span>)</span> <span>getAlbumGin</span><span>(</span><span>c</span> <span>gin</span><span>.</span><span>Context</span><span>)</span> <span>{</span>
</span></span><span><span>	<span>id</span><span>,</span> <span>ok</span> <span>:=</span> <span>c</span><span>.</span><span>Params</span><span>.</span><span>Get</span><span>(</span><span>&#34;id&#34;</span><span>)</span>
</span></span><span><span>
</span></span><span><span>	<span>if</span> <span>!</span><span>ok</span> <span>{</span>
</span></span><span><span>		<span>c</span><span>.</span><span>Error</span><span>(</span><span>fmt</span><span>.</span><span>Errorf</span><span>(</span><span>&#34;get album: missing id&#34;</span><span>))</span>
</span></span><span><span>		<span>return</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span>
</span></span><span><span>	<span>album</span><span>,</span> <span>err</span> <span>:=</span> <span>h</span><span>.</span><span>db</span><span>.</span><span>FetchAlbum</span><span>(</span><span>id</span><span>)</span>
</span></span><span><span>	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>		<span>c</span><span>.</span><span>Error</span><span>(</span><span>fmt</span><span>.</span><span>Errorf</span><span>(</span><span>&#34;fetch album with id %s: %w&#34;</span><span>,</span> <span>id</span><span>,</span> <span>err</span><span>))</span>
</span></span><span><span>		<span>// Same thing here. Oh, man ü§¶‚Äç‚ôÇÔ∏è
</span></span></span><span><span><span></span>	<span>}</span>
</span></span><span><span>
</span></span><span><span>	<span>cover</span><span>,</span> <span>err</span> <span>:=</span> <span>h</span><span>.</span><span>db</span><span>.</span><span>FetchAlbumCover</span><span>(</span><span>id</span><span>)</span>
</span></span><span><span>	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>		<span>c</span><span>.</span><span>Error</span><span>(</span><span>fmt</span><span>.</span><span>Errorf</span><span>(</span><span>&#34;fetch cover for album with id %s: %w&#34;</span><span>,</span> <span>id</span><span>,</span> <span>err</span><span>))</span>
</span></span><span><span>		<span>return</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span>
</span></span><span><span>	<span>c</span><span>.</span><span>JSON</span><span>(</span><span>http</span><span>.</span><span>StatusOK</span><span>,</span> <span>gin</span><span>.</span><span>H</span><span>{</span><span>&#34;album&#34;</span><span>:</span> <span>album</span><span>,</span> <span>&#34;cover&#34;</span><span>:</span> <span>cover</span><span>})</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div></div></section><p>Have something to say? Join the discussion:</p></article></div>
  </body>
</html>
