<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://cnx.srht.site/blog/butter/index.html">Original</a>
    <h1>NixOS on Btrfs&#43;tmpfs</h1>
    
    <div id="readability-page-1" class="page"><div>  <p>In 2018, dad bought me a new laptop to replace the good ole Compaq nx7010 whose screen unfortunately got infected by some sort of microbe and dieded shortly afterwards. The new one, whilst having a considerably worse build quality (like all other late-2010s ones when compared to mid-2000s models), had a dozen times as much storage: a 250 GB M.2 SSD and a 500 GB SATA HDD.</p> <p>My data hoarding habit has grown exponentially ever since. Initially, I used to back up the data from the SSD to the HDD but after a few years, I ran out of space and decided to get some more storage. Instead of buying a portable hard disk like a normal person would, I went for an SATA SSD, as it was rather difficult to find a 7200 rpm 2.5-inch<sup id="fnref:metric"><a href="#fndef:metric">[1]</a></sup> HDD in the market at the time.</p> <p>I then asked my father for a spare SATA-to-USB case (he switched to using a dock a while ago, and like other dads, nothing is ever thrown away) and prepared to swap the drives. As cloning the data would have been too easy, I decided to <em>spice things up</em> by reinstalling the OS. Back then I was dual-booting Debian and NixOS, but the former had hardly been ever booted for months so it was time to let it go:</p> <p><img src="https://cnx.srht.site/assets/let-it-go.png" alt="Elsa rolling on the floor crying"/></p> <p>In addition, I wanted to hop on the new and shinny<sup id="fnref:new"><a href="#fndef:new">[2]</a></sup> train of Btrfs. It has compression, snapshots and subvolumes, what&#39;s not to love? Let&#39;s replace something I&#39;d been using for nearly a decade with a file system I had absolutely zero experience with, what could possibly go wrong, right?</p>  <h2 id="reinstallation"><a href="#reinstallation">Reinstallation</a></h2> <p>I was going to reinstall NixOS with an ephemeral root, which had been covered to death in the following brilliant resources:</p> <ul> <li><p><a href="https://grahamc.com/blog/erase-your-darlings">Erase your darlings: immutable infrastructure for mutable systems</a></p> </li><li><p><a href="https://elis.nu/blog/2020/05/nixos-tmpfs-as-root">NixOS ❄: tmpfs as root</a></p> </li><li><p><a href="https://github.com/nix-community/impermanence">Nix community&#39;s impermanence modules</a></p> </li><li><p><a href="https://christine.website/blog/paranoid-nixos-2021-07-18">Paranoid NixOS Setup</a></p> </li></ul> <p>The only twist here is that I was using Btrfs instead of ZFS or ext4 like in other guides. This choice would influence how to back up in the later section.</p> <h3 id="preparation"><a href="#preparation">Preparation</a></h3> <p>First of all, I temporarily copied data to the SATA SSD from the M.2, including <a href="https://git.sr.ht/~cnx/dotfiles/tree/master/item/nix">my Nix configurations</a>. Using either <code>cp</code> or <code>rsync</code> didn&#39;t seem to have any effect on the performance, and in the mean time I also went ahead and grabbed a <a href="https://channels.nixos.org/nixos-unstable">NixOS unstable live image</a> and <code>dd</code>&#39;ed it to a flash drive. As I&#39;m tracking unstable, installing from the same version would allowed me to skip switching the channel and a lot of downloading.</p> <h3 id="partitioning"><a href="#partitioning">Partitioning</a></h3> <p>After booting up the live image, I opened up a root shell with <code>sudo -i</code>. As expected, <code>fdisk</code> reports the M.2 SSD as <code>/dev/nvme0n1</code>. Paranoid as always, I decided to give the EFI system partition a whole gibibyte, swap eight to match memory<sup id="fnref:memory"><a href="#fndef:memory">[3]</a></sup> and the rest as a single chonky Btrfs partition:</p> <pre><code>parted /dev/nvme0n1 -- mklabel gpt
parted /dev/nvme0n1 -- mkpart ESP fat32 1MiB 1GiB
parted /dev/nvme0n1 -- <span>set</span> 1 boot on
mkfs.vfat /dev/nvme0n1p1

parted /dev/nvme0n1 -- mkpart Swap linux-swap 1GiB 9GiB
mkswap -L Swap /dev/nvme0n1p2
swapon /dev/nvme0n1p2

parted /dev/nvme0n1 -- mkpart primary 9GiB 100%
mkfs.btrfs -L Butter /dev/nvme0n1p3</code></pre> <p>As I typed this, I realized that I should have set up encryption for the last partition so I would probably need to reinstall in the near future to fix this mistake. Anyway, with the target system&#39;s root mounted as tmpfs, I would need to persist <code>/nix</code> (obviously), <code>/etc</code> (mostly for authentication and other secret stuff not included in <code>configuration.nix</code> that I was too lazy to opt in individually), <code>/var/log</code>, <code>/root</code> and <code>/home</code>:</p> <pre><code>mount /dev/nvme0n1p3 /mnt
btrfs subvolume create /mnt/nix
btrfs subvolume create /mnt/etc
btrfs subvolume create /mnt/log
btrfs subvolume create /mnt/root
btrfs subvolume create /mnt/home
umount /mnt</code></pre> <p>Most subvolumes can be mounted with <code>noatime</code>, except for <code>/home</code> where I frequently need to sort files by modification time. All of them should have forced compression though:</p> <pre><code>mount -t tmpfs -o mode=755 none /mnt
<span>mkdir</span> -p /mnt/{boot,nix,etc,var/log,root,home}
mount /dev/nvme0n1p1 /mnt/boot
mount -o subvol=nix,compress-force=zstd,noatime /dev/nvme0n1p3 /mnt/nix
mount -o subvol=etc,compress-force=zstd,noatime /dev/nvme0n1p3 /mnt/etc
mount -o subvol=<span>log</span>,compress-force=zstd,noatime /dev/nvme0n1p3 /mnt/var/log
mount -o subvol=root,compress-force=zstd,noatime /dev/nvme0n1p3 /mnt/root
mount -o subvol=home,compress-force=zstd /dev/nvme0n1p3 /mnt/home</code></pre> <h3 id="configuration"><a href="#configuration">Configuration</a></h3> <p>With everything mounted, <code>nixos-generate-config --root /mnt</code> could be run to generate a basic configuration. But wait, didn&#39;t I say something about my dot files? That&#39;s correct, but it&#39;s not easy to handcraft the <code>hardware-configuration.nix</code>. After making sure all are mounted with the right options and <code>services.fstrim.enable</code> is <code>true</code>, I copied other configuration files to <code>/etc/nixos</code> and finished this step.</p> <h3 id="installation"><a href="#installation">Installation</a></h3> <p>NixOS installation is as simple as running <code>nixos-install</code>. But my job was not done after setting the root password and rebooting into the new system. It was working, but not functional. There was nothing meaningful for me to do on it, so I had to log in (as root), <code>passwd</code>&#39;ed the user and copied the home folder back from the temporary drive.</p> <p>After freeing the new SATA SSD, I also filled it with butter. Yes, all the way, no GPT, no MBR, just Btrfs, whose subvolumes were used in place of partitions:</p> <pre><code>mkfs.btrfs -f -L Fly /dev/sdb
<span>mkdir</span> -p /mnt
mount /dev/sdb /mnt
btrfs subvolume create /mnt/movies</code></pre> <p>At that time the only disposable data I had were my movies collection. The HDD also contained other data but they were rebalanced at <code>/home</code> (on the M.2). After swapping the SATA SSD inside the laptop, I logged in as the normal user and get the exact same environment before the reinstallation.</p> <h3 id="profits"><a href="#profits">Profits</a></h3> <p>Thanks to subvolumes and compression, the free spaces were no longer fragmented and I think I gained like 100 GB (not counting the old Debian&#39;s root). Backup would also be less painful with Btrfs snapshots (instead of plain <code>rsync</code> like I used to) as shown as follows.</p> <h2 id="backup"><a href="#backup">Backup</a></h2> <p>With all data migrated, the HDD could be used for backing up. First, some legacy data I no longer access were moved there, then I started to back up my <code>/home</code> partition:</p> <h3 id="initialization"><a href="#initialization">Initialization</a></h3> <p>Having learned my lesson, I did not forget to set up <a href="https://gitlab.com/cryptsetup/cryptsetup">LUKS</a> this time:</p> <pre><code>cryptsetup luksFormat /dev/sdb
cryptsetup luksOpen /dev/sdb backup</code></pre> <p>To make use of snapshots, the backup drive gotta be Btrfs as well. The compression level was turned up to 14 this time (default was 3):</p> <pre><code>mkfs.btrfs -L Backup /dev/mapper/backup
<span>mkdir</span> /backup
mount -o noatime,compress-force=zstd:14 /dev/mapper/backup /backup</code></pre> <p>Following <a href="https://btrfs.wiki.kernel.org/index.php/Incremental_Backup">Btrfs Wiki</a>, I made the first <code>/home</code> snapshot and sent it to the backup drive:</p> <pre><code>btrfs subvolume create /backup/home
today=$(<span>date</span> --iso-8601)
btrfs subvolume snapshot -r /home /home/<span>$today</span>
<span>sync</span>
btrfs send /home/<span>$today</span> | btrfs receive /backup/home
<span>sync</span></code></pre> <h3 id="repetition"><a href="#repetition">Repetition</a></h3> <p>For next backups, I also mounted the drive and created a snapshot:</p> <pre><code>cryptsetup luksOpen /dev/sdb backup
<span>mkdir</span> -p /backup
mount -o noatime,compress-force=zstd:14 /dev/mapper/backup /backup
today=$(<span>date</span> --iso-8601)
btrfs subvolume snapshot -r /home /home/<span>$today</span>
<span>sync</span></code></pre> <p>Say the latest snapshot was on the <code>$previous</code> day, I only needed to send the difference between the old and new backup. Afterwards, it is safe to delete the local <code>$previous</code> snapshot to save some space.</p> <pre><code>btrfs send -p /home/<span>$previous</span> /home/<span>$today</span> | btrfs receive /backup/home
btrfs subvolume delete /home/<span>$previous</span>
<span>sync</span></code></pre> <p>Finally, unmount the drive and close the LUKS volume:</p> <pre><code>umount /backup
cryptsetup luksClose backup</code></pre> <p>Is this more complicated than good ole <code>rsync</code>? Yes. Is it safer? Also yes, thanks to copy-on-write. Would I bother using one of the tools suggested in the wiki? Probably not, I&#39;ve already documented everything in this article in case I forget anything.</p> <table id="fndef:metric"> <tbody><tr> <td><a href="#fnref:metric">[1]</a> </td><td>63.5 mm for those outside of the land of guns and burgers </td></tr></tbody></table><table id="fndef:new"> <tbody><tr> <td><a href="#fnref:new">[2]</a> </td><td>OK, maybe not new, but certainly shinny </td></tr></tbody></table><table id="fndef:memory"> <tbody><tr> <td><a href="#fnref:memory">[3]</a> </td><td>Slightly larger since some of the memory is dedicated to graphics </td></tr></tbody></table> <p><small><strong>Tags:</strong> <a href="https://cnx.srht.site/tag/backup">backup</a> <a href="https://cnx.srht.site/tag/btrfs">btrfs</a> <a href="https://cnx.srht.site/tag/fun">fun</a> <a href="https://cnx.srht.site/tag/nixos">nixos</a> <a href="https://cnx.srht.site/tag/recipe">recipe</a></small> <small>—<a href="mailto:~cnx/site@lists.sr.ht?In-Reply-To=%3Cblog/butter@cnx%3E&amp;Subject=Re: NixOS on Btrfs+tmpfs" title="Reply via email">Nguyễn Gia Phong</a>, 2021-11-14</small></p></div></div>
  </body>
</html>
