<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://wcedmisten.fyi/post/how-to-query-osm/">Original</a>
    <h1>Open source tools to query OpenStreetMap</h1>
    
    <div id="readability-page-1" class="page"><div>
<!-- --><p>OpenStreetMap (OSM) is one of my favorite datasets because it
has anything and everything. If it could conceivably exist on a map, it probably
exists in OpenStreetMap. Whether it&#39;s military bases, lakes, hedges, or power lines,
it can all be mapped in OSM.</p>
<!-- --><p>But the scope of this data can be daunting. The entire planet file
takes up a whopping 1,931 GB uncompressed.<!-- --><sup><a href="#user-content-fn-planet-osm" id="user-content-fnref-planet-osm" data-footnote-ref="true" aria-describedby="footnote-label">1</a></sup>
As such, using this data can require a lot of RAM and a lot of time.<!-- --></p>
<!-- --><p>Luckily, there are many open source tools freely available to
help make sense of this large dataset.
In my experience creating projects with OSM, I&#39;ve used many of these tools
to create interesting visualizations and to answer questions about the world we live in.</p>
<!-- --><h2 id="1-overpass-turbo"><a href="#1-overpass-turbo">1. Overpass Turbo</a></h2>
<!-- --><p><a href="https://overpass-turbo.eu/">Overpass Turbo</a> is a &#34;web based filtering tool
for OpenStreetMap&#34;.
The tool provides a frontend for the Overpass API,
which uses a procedural query language to analyze OSM data.<!-- --></p>
<!-- --><p>As an example, here is a query to find all the hotels in the given area.</p>
<!-- --><pre><code><span>[out:json]</span><span>[timeout:25]</span>;
<!-- -->
nwr<!-- --><span>[<!-- --><span>&#34;tourism&#34;</span>=<!-- --><span>&#34;hotel&#34;</span>]<!-- --></span>({{bbox}});
<!-- -->
out geom;
<!-- --></code></pre>
<!-- --><p>The first line is saying we want the output formatted as JSON,
and we&#39;ll wait up to 25 seconds for a result before timing out.</p>
<!-- --><p>The second line is to search for all nodes, ways, and relations (nwr)
that have the tag tourism=hotel inside the current bounds of the map.</p>
<!-- --><p>The last line just prints the results.</p>
<!-- --><p>To me, the procedural syntax can be a bit hard to read
compared to a declarative language like SQL,
so I usually rely on assistance for more complex queries.</p>
<!-- --><p>The Overpass Turbo has a wizard that allows you to construct simple queries
from natural text.
ChatGPT is also decent at writing them.</p>
<!-- --><p><em>&#34;Write an overpass query to find all Italian restaurants in Virginia&#34;</em></p>
<!-- --><pre><code><span>[out:json]</span>;
area<!-- --><span>[<!-- --><span>&#34;ISO3166-2&#34;</span>=<!-- --><span>&#34;US-VA&#34;</span>]<!-- --></span>-&gt;<!-- --><span>.searchArea</span>;
(
  node<!-- --><span>[<!-- --><span>&#34;amenity&#34;</span>=<!-- --><span>&#34;restaurant&#34;</span>]<!-- --></span><span>[<!-- --><span>&#34;cuisine&#34;</span>=<!-- --><span>&#34;italian&#34;</span>]<!-- --></span>(area<!-- --><span>.searchArea</span>);
  way<!-- --><span>[<!-- --><span>&#34;amenity&#34;</span>=<!-- --><span>&#34;restaurant&#34;</span>]<!-- --></span><span>[<!-- --><span>&#34;cuisine&#34;</span>=<!-- --><span>&#34;italian&#34;</span>]<!-- --></span>(area<!-- --><span>.searchArea</span>);
  relation<!-- --><span>[<!-- --><span>&#34;amenity&#34;</span>=<!-- --><span>&#34;restaurant&#34;</span>]<!-- --></span><span>[<!-- --><span>&#34;cuisine&#34;</span>=<!-- --><span>&#34;italian&#34;</span>]<!-- --></span>(area<!-- --><span>.searchArea</span>);
);
out center;
<!-- --></code></pre>
<!-- --><p>This query<!-- --><sup><a href="#user-content-fn-osm-italian-query" id="user-content-fnref-osm-italian-query" data-footnote-ref="true" aria-describedby="footnote-label">2</a></sup> produces the following map of 291 results after about 10 seconds.<!-- --></p>
<!-- --><p><img src="https://wcedmisten.fyi/how-to-query-osm/italian-restaurants.png" alt="A screenshot of a map showing all Italian restaurants in Virginia"/></p>
<!-- --><h3 id="pros"><a href="#pros">Pros</a></h3>
<!-- --><ul>
<!-- --><li>Doesn&#39;t require any local tools and can be accessed from the browser</li>
<!-- --><li>Allows for easy exporting in various formats</li>
<!-- --><li>Wizard or ChatGPT allows constructing queries in natural language</li>
<!-- --></ul>
<!-- --><h3 id="cons"><a href="#cons">Cons</a></h3>
<!-- --><ul>
<!-- --><li>Query language is hard to write and harder to read (in my opinion)</li>
<!-- --><li>Rate limits - since the service is provided to the public for free,
it has limitations on the size and duration of each request.<!-- -->
<!-- --><ul>
<!-- --><li>Queries that take longer than 180 seconds will be canceled</li>
<!-- --><li>Queries that use more than 512 MiB of RAM will be canceled</li>
<!-- --><li>Just for context, this means we can find all Italian restaurants in Virginia,
but not in the whole US</li>
<!-- --></ul>
<!-- --></li>
<!-- --></ul>
<!-- --><h2 id="2-osm2pgsql--postgis"><a href="#2-osm2pgsql--postgis">2. osm2pgsql + PostGIS</a></h2>
<!-- --><p><a href="https://osm2pgsql.org/">osm2pgsql</a> is a command line tool that&#39;s used to
load openstreetmap data into a PostGIS<!-- --><sup><a href="#user-content-fn-postgis" id="user-content-fnref-postgis" data-footnote-ref="true" aria-describedby="footnote-label">3</a></sup> database.
Since PostGIS provides an index for geospatial data, this tool
is useful for loading data that needs to be queried multiple times.<!-- --></p>
<!-- --><p>PostGIS is a powerful geospatial extension for PostgreSQL, which lets
you make complicated geospatial queries like &#34;which hotels exist in
this state&#34; or &#34;sort these bus stops by distance to my house&#34;.</p>
<!-- --><h3 id="setup"><a href="#setup">Setup</a></h3>
<!-- --><p>I always forget how to set this up from scratch, so I made a
<!-- --><a href="https://github.com/wcedmisten/osm2pgsql-docker">github repo</a>
that manages most of it for me.<!-- --></p>
<!-- --><p>You can clone the repo or just copy the 3 files into a local directory.</p>
<!-- --><p>Just run</p>
<!-- --><pre><code>docker compose up
</code></pre>
<!-- --><p>To start up a PostGIS instance.</p>
<!-- --><p>To get started with this tool, you can download an extract of
OpenStreetMap from <!-- --><a href="https://download.geofabrik.de/">Geofabrik</a>.<!-- --></p>
<!-- --><h3 id="downloading-the-data"><a href="#downloading-the-data">Downloading the data</a></h3>
<!-- --><p>OpenStreetMap is available in many different data formats, but the most compressed
version is the osm.pbf format, which uses Google&#39;s protobuf library<!-- --><sup><a href="#user-content-fn-osm-pbf" id="user-content-fnref-osm-pbf" data-footnote-ref="true" aria-describedby="footnote-label">4</a></sup>.<!-- --></p>
<!-- --><p>I use one of two options to download the data:</p>
<!-- --><h4 id="you-wouldnt-download-a-planet"><a href="#you-wouldnt-download-a-planet">You Wouldn&#39;t Download A Planet</a></h4>
<!-- --><p>OpenStreetMap provides an official <!-- --><a href="https://planet.openstreetmap.org/pbf/">link to download</a>
the entire &#34;planet&#34; file.
This file contains everything mapped across the entire globe.
As you might expect, this means it&#39;s pretty big - 76 GB at a minimum.<!-- --></p>
<!-- --><p>I recommend the official torrent file because it&#39;s faster than
downloading it straight from the server.</p>
<!-- --><p>Using this file is necessary for a global project, but if you can reduce the scope
of your project, it&#39;s faster to use a subset of this data.
For example, only the data in your country.</p>
<!-- --><p>This brings us to...</p>
<!-- -->
<!-- --><p>Geofabrik is a German company that generously provides downloads for
geographic extracts of the planet file.
This means you can get a file that only has the data for
your continent, country, or even just your state.</p>
<!-- --><p>These extracts can be found <!-- --><a href="https://download.geofabrik.de/">here</a>.
You can click on the &#34;Sub Region&#34; name to get more specific extracts.
E.g. clicking on &#34;North America&#34; from this page takes you to a list of
country extracts.
Clicking on &#34;United States of America&#34; takes you
to a list of states.<!-- --></p>
<!-- --><h3 id="importing-the-data"><a href="#importing-the-data">Importing the data</a></h3>
<!-- --><p>Install the <!-- --><code>osm2pgsql</code> tool locally with <!-- --><code>apt-get install osm2pgsql</code> on linux.
Instructions for other operating systems can be found
<!-- --><a href="https://osm2pgsql.org/doc/install.html">here</a>.<!-- --></p>
<!-- --><p>Once it is installed, you can run this command to import the data into
the PostGIS instance we just spun up.</p>
<!-- --><p>Replace the very last argument with the path to your osm.pbf file.</p>
<!-- --><pre><code>PGPASSWORD=password osm2pgsql <!-- --><span>--create</span> <!-- --><span>--verbose</span> \
-U postgres -H localhost -S osm2pgsql<!-- --><span>.style</span> \ 
~/Downloads/virginia-latest<!-- --><span>.osm</span><span>.pbf</span>
<!-- --></code></pre>
<!-- --><p>Importing the data will take longer for larger files, which is why
using an extract file is recommended.</p>
<!-- --><p>For the Virginia extract, this took about 1 minute.
For North America, it takes many hours, and for the entire planet,
it would take at least a day<!-- --><sup><a href="#user-content-fn-planet-benchmarks" id="user-content-fnref-planet-benchmarks" data-footnote-ref="true" aria-describedby="footnote-label">5</a></sup>.<!-- --></p>
<!-- --><h3 id="querying-the-data"><a href="#querying-the-data">Querying the data</a></h3>
<!-- --><p>You can connect to the PostgreSQL instance with:</p>
<!-- --><pre><code>psql postgresql:<!-- --><span>//p</span>ostgres:password@localhost:<!-- --><span>5432</span>
<!-- --></code></pre>
<!-- --><p>The important tables in this DB are:</p>
<!-- --><pre><code>postgres=<!-- --><span># \dt</span>
                   List of relations
  Schema  |           Name           | Type  |  Owner   
----------+--------------------------+-------+----------
 <!-- --><span>public</span>   | planet_osm_line          | table | postgres
 <!-- --><span>public</span>   | planet_osm_point         | table | postgres
 <!-- --><span>public</span>   | planet_osm_polygon       | table | postgres
<!-- --></code></pre>
<!-- --><p>Note that these are named <!-- --><code>planet_</code> regardless of the extract you use.<!-- --></p>
<!-- --><p>These 3 tables represent the data in different forms.</p>
<!-- --><p><code>planet_osm_point</code> includes point features that have a single coordinate.
E.g. a restaurant might be tagged as a single location.<!-- --></p>
<!-- --><p><code>planet_osm_line</code> represents linear features, such as a road.<!-- --></p>
<!-- --><p><code>planet_osm_polygon</code> contains polygon features, such as a rectangular building.<!-- --></p>
<!-- --><p>For example, if we wanted to find the 10 closest restaurants to a location,
we could use this query.</p>
<!-- --><pre><code><span>SELECT</span> name,    
  way <!-- --><span>&lt;</span><span>-</span><span>&gt;</span> ST_Transform(ST_GeomFromText(<!-- --><span>&#39;POINT(-80.885767 36.687606)&#39;</span>,<!-- --><span>4326</span>),<!-- --><span>3857</span>) <!-- --><span>AS</span> dist
<!-- --><span>FROM</span>
  planet_osm_point
<!-- --><span>WHERE</span> amenity<!-- --><span>=</span><span>&#39;restaurant&#39;</span>
<!-- --><span>ORDER</span> <!-- --><span>BY</span>
  dist
LIMIT <!-- --><span>10</span>;
<!-- --></code></pre>
<!-- --><pre><code>              name              |        dist        
--------------------------------+--------------------
 Bamboo Garden                  |  <!-- --><span>313.9426901179711</span>
 Kyoto                          |  <!-- --><span>457.7719195565756</span>
 El Rio Grande                  |  <!-- --><span>522.2405953055143</span>
 Applebee<!-- -->
 Curo<!-- -->
 RJ<!-- -->
 Tlaquepaque Mexican Restaurant | <!-- --><span>1116.4914574194884</span>
 Porky<!-- -->
 County Line Cafe               | <!-- --><span>1660.6244485206985</span>
 Pizza Hut                      | <!-- --><span>1792.4252730858987</span>
(<!-- --><span>10</span> rows)
<!-- --></code></pre>
<!-- --><p>Thanks to the geospatial indexing PostGIS provides, this query returns
in under 0.567 ms.</p>
<!-- --><p>Restaurants might plausibly be represented as a polygon as well,
because sometimes mappers use the building outline for that tag,
so we could modify the query to use <!-- --><code>planet_osm_polygon</code> and the
centroid of the way.<!-- --></p>
<!-- --><pre><code>postgres<!-- --><span>=</span># <!-- --><span>SELECT</span> name,    
  ST_Centroid(way) <!-- --><span>&lt;</span><span>-</span><span>&gt;</span> ST_Transform(
    ST_GeomFromText(<!-- --><span>&#39;POINT(-80.885767 36.687606)&#39;</span>,<!-- --><span>4326</span>),
    <!-- --><span>3857</span>
  ) <!-- --><span>AS</span> dist
<!-- --><span>FROM</span>
  planet_osm_polygon
<!-- --><span>WHERE</span> amenity<!-- --><span>=</span><span>&#39;restaurant&#39;</span> <!-- --><span>ORDER</span> <!-- --><span>BY</span>
  dist
LIMIT <!-- --><span>10</span>;
<!-- --></code></pre>
<!-- --><pre><code>          name          |        dist        
------------------------+--------------------
 Valley Diner           | <!-- --><span>31747.918873591883</span>
 Shoney<!-- --><span>&#39;s</span>               | <!-- --><span>40739.071336328416</span>
 Waffle House           |  <!-- --><span>40871.59098932903</span>
 Bob Evans              | <!-- --><span>40977.497308169375</span>
 Cracker Barrel         |  <!-- --><span>41119.80651892602</span>
 Applebee<!-- --><span>&#39;s</span>             | <!-- --><span>41590.716594290105</span>
 Ruby Tuesday           |  <!-- --><span>44297.93733469305</span>
 Dining Hall            | <!-- --><span>45714.815139316204</span>
 Joey<!-- --><span>&#39;s</span> Country Kitchen |  <!-- --><span>51971.85464808888</span>
 Pizza Plus             | <!-- --><span>52375.136364474296</span>
(<!-- --><span>10</span> rows)
<!-- --></code></pre>
<!-- --><p>It&#39;s less likely that restaurants are represented like this, but it
doesn&#39;t hurt to consider this edge case when dealing with OSM data.</p>
<!-- --><h3 id="styling-on-osm2pgsql"><a href="#styling-on-osm2pgsql">styling on osm2pgsql</a></h3>
<!-- --><p>You might have wondered what the <!-- --><code>osm2pgsql.style</code> file inside my repo does.
This is called the &#34;style&#34; file, and it&#39;s used to control which
OSM tags get imported into PostGIS.<!-- --></p>
<!-- --><p>Unfortunately, if you want to query for a tag that&#39;s not already
in this file, you&#39;ll need to go back and re-import the data.</p>
<!-- --><p>For this reason, I recommend developing your code with a small extract first
and then going back to import your larger dataset.</p>
<!-- --><p>Let&#39;s say we want to find all the Italian restaurants in Virginia again.
Well, we can&#39;t yet, because the default osm2pgsql.style file doesn&#39;t contain
the <!-- --><code>cuisine</code> tag, so it didn&#39;t get imported.<!-- --></p>
<!-- --><p>We can add this with:</p>
<!-- --><pre><code><span>echo</span> <!-- --><span>&#34;node,way cuisine text polygon&#34;</span> &gt;&gt; osm2pgsql.style
<!-- --></code></pre>
<!-- --><p>Then re-run the import</p>
<!-- --><pre><code>PGPASSWORD=password osm2pgsql <!-- --><span>--create</span> <!-- --><span>--verbose</span> -U postgres -H localhost -S osm2pgsql<!-- --><span>.style</span> ~/Downloads/virginia-latest<!-- --><span>.osm</span><span>.pbf</span>
<!-- --></code></pre>
<!-- --><p>Now we can run:</p>
<!-- --><pre><code>SELECT name, osm_id
FROM planet_osm_point
WHERE <!-- --><span>amenity</span>=<!-- --><span>&#39;restaurant&#39;</span> AND cuisine=<!-- --><span>&#39;italian&#39;</span>
<!-- --></code></pre>
<!-- --><p>Which takes 44 ms for 195 rows.</p>
<!-- --><p>And the same query for polygons:</p>
<!-- --><pre><code>SELECT name, osm_id
FROM planet_osm_polygon
WHERE <!-- --><span>amenity</span>=<!-- --><span>&#39;restaurant&#39;</span> AND cuisine=<!-- --><span>&#39;italian&#39;</span>
<!-- --></code></pre>
<!-- --><p>Which takes 274 ms for 97 rows.</p>
<!-- --><h3 id="pros-1"><a href="#pros-1">Pros</a></h3>
<!-- --><ul>
<!-- --><li>Very fast geospatial queries after initial data import</li>
<!-- --><li>Allows you to use SQL</li>
<!-- --><li>Uses PostgreSQL / PostGIS, which are very well supported tools</li>
<!-- --></ul>
<!-- --><h3 id="cons-1"><a href="#cons-1">Cons</a></h3>
<!-- --><ul>
<!-- --><li>Requires an initial import which can take anywhere from minutes to days</li>
<!-- --><li>Requires knowing the tags you will want to query in advance of the import</li>
<!-- --></ul>
<!-- --><h2 id="3-duckdb"><a href="#3-duckdb">3. DuckDB</a></h2>
<!-- --><p>DuckDB is a column-oriented relational database that was first released in 2019.
Installation instructions can be found <!-- --><a href="https://duckdb.org/docs/installation/index">here</a>.<!-- --></p>
<!-- --><p>One of the coolest parts of this DB is the experimental <!-- --><code>ST_ReadOsm()</code> function.
Unlike osm2pgsql, which requires loading the entire compressed file into
a separate database, <!-- --><code>ST_ReadOsm()</code> allows you to query the compressed file directly.<!-- --></p>
<!-- --><p>Run the duckdb executable from wherever you installed it.</p>
<!-- --><pre><code>~/Downloads/duckdb 
v1.<!-- --><span>0.0</span> <!-- --><span>1</span>f98600c2c
Enter <!-- --><span>&#34;.help&#34;</span> <!-- --><span>for</span> usage hints.
Connected <!-- --><span>to</span> a transient <!-- --><span>in</span>-memory database.
Use <!-- --><span>&#34;.open FILENAME&#34;</span> <!-- --><span>to</span> reopen <!-- --><span>on</span> a persistent database.
<!-- --></code></pre>
<!-- --><p>Then add the spatial extension into DuckDB:</p>
<!-- --><pre><code>INSTALL spatial<!-- -->
LOAD spatial<!-- -->
<!-- --></code></pre>
<!-- --><p>Finally, you can query your osm.pbf file directly:</p>
<!-- --><pre><code>D SELECT <!-- --><span>COUNT</span>(*) FROM <!-- --><span>st_readOSM</span>(&#39;/home/wcedmisten/Downloads/virginia-latest.osm.pbf&#39;) WHERE tags<!-- --><span>[<!-- --><span>&#39;amenity&#39;</span>]<!-- --></span> = <!-- --><span>[<!-- --><span>&#39;restaurant&#39;</span>]<!-- --></span> AND tags<!-- --><span>[<!-- --><span>&#39;cuisine&#39;</span>]<!-- --></span> = <!-- --><span>[<!-- --><span>&#39;italian&#39;</span>]<!-- --></span>;
┌──────────────┐
│ <!-- --><span>count_star</span>() │
│    int64     │
├──────────────┤
│          <!-- --><span>292</span> │
└──────────────┘
<!-- --></code></pre>
<!-- --><p>This query took 663 ms on my machine.</p>
<!-- --><p>The really impressive part was how this performs on larger datasets.
On the 15 GB north-america-latest.osm.pbf file, I could query for all Italian restaurants
in just 24 seconds.</p>
<!-- --><pre><code>SELECT <!-- --><span>COUNT</span>(*) FROM <!-- --><span>st_readOSM</span>(&#39;/home/wcedmisten/Downloads/north-america-latest.osm.pbf&#39;) WHERE tags<!-- --><span>[<!-- --><span>&#39;amenity&#39;</span>]<!-- --></span> = <!-- --><span>[<!-- --><span>&#39;restaurant&#39;</span>]<!-- --></span> AND tags<!-- --><span>[<!-- --><span>&#39;cuisine&#39;</span>]<!-- --></span> = <!-- --><span>[<!-- --><span>&#39;italian&#39;</span>]<!-- --></span>;
<!-- --><span>100%</span> ▕████████████████████████████████████████████████████████████▏ 
┌──────────────┐
│ <!-- --><span>count_star</span>() │
│    int64     │
├──────────────┤
│         <!-- --><span>8068</span> │
└──────────────┘
<!-- --></code></pre>
<!-- --><p>This wouldn&#39;t be great on its own, but it does avoid having to load
the 15 GB dataset into PostgreSQL, which would take multiple hours on my computer.</p>
<!-- --><h3 id="caveats"><a href="#caveats">Caveats</a></h3>
<!-- --><p>One issue with this function is that it saves time by not constructing geometries
during the query.
This means that some of the queries you can do relating to geometries are
limited or require convoluted workarounds.</p>
<!-- --><p>It should also be noted that this extension is still experimental.</p>
<!-- --><p>I recently filed an open issue<!-- --><sup><a href="#user-content-fn-duckdb-issue" id="user-content-fnref-duckdb-issue" data-footnote-ref="true" aria-describedby="footnote-label">6</a></sup> because many results were missing when
querying all restaurants from the planet file.
However, the performance of this extension is quite promising,
because it affords a lot of flexibility compared to the
osm2pgsql approach.
There&#39;s no need to re-import data if you realize you want to query an extra tag.<!-- --></p>
<!-- --><h3 id="pros-2"><a href="#pros-2">Pros</a></h3>
<!-- --><ul>
<!-- --><li>High performance, can query large OSM extracts pretty fast without upfront indexing</li>
<!-- --></ul>
<!-- --><h3 id="cons-2"><a href="#cons-2">Cons</a></h3>
<!-- --><ul>
<!-- --><li>Doesn&#39;t construct geometries automatically, which limits some queries</li>
<!-- --><li>Still experimental</li>
<!-- --></ul>
<!-- --><h2 id="4-qlever"><a href="#4-qlever">4. QLever</a></h2>
<!-- --><p>I discovered this tool while researching this post.</p>
<!-- --><p><a href="https://qlever.cs.uni-freiburg.de/">QLever</a>
is a tool that allows querying an RDF representation of OpenStreetMap
using a query language called SPARQL.
This basically means OSM was converted into a knowledge graph,
and we can query it to find data that matches the specifications of our query.<!-- --></p>
<!-- --><p>For example, this <!-- --><a href="https://qlever.cs.uni-freiburg.de/osm-planet/guZA8v">query</a>
is used to find all the Italian restaurants in Virginia.<!-- --></p>
<!-- --><pre><code><span>PREFIX</span> <!-- --><span>geo:</span> &lt;<!-- --><span>http:</span>/<!-- --><span>/www.opengis.net/ont</span><span>/geosparql#&gt;
PREFIX osmkey: &lt;https:/</span><span>/www.openstreetmap.org/wiki</span><span>/Key:&gt;
PREFIX ogc: &lt;http:/</span><span>/www.opengis.net/rdf</span>
<!-- --><span>PREFIX</span> <!-- --><span>osmrel:</span> &lt;<!-- --><span>https:</span>/<!-- --><span>/www.openstreetmap.org/relation</span><span>/&gt;
SELECT ?osm_id ?hasgeometry WHERE {
  osmrel:224042 ogc:sfContains ?osm_id .
  ?osm_id geo:hasGeometry/geo</span><span>:asWKT</span> <!-- --><span>?h</span>asgeometry .
  <!-- --><span>?o</span>sm_id <!-- --><span>osmkey:</span>amenity <!-- --><span>&#34;restaurant&#34;</span> . <!-- --><span>?o</span>sm_id <!-- --><span>osmkey:</span>cuisine <!-- --><span>&#34;italian&#34;</span> .
}
<!-- --></code></pre>
<!-- --><p>The real meat of the query is below the line ending in <!-- --><code>WHERE {</code></p>
<!-- --><pre><code><span>osmrel:224042 ogc:sfContains ?osm_id .</span>
<!-- --></code></pre>
<!-- --><p>Searches for features within relation 224042, which is the state of
Virginia<!-- --><sup><a href="#user-content-fn-virginia-relation" id="user-content-fnref-virginia-relation" data-footnote-ref="true" aria-describedby="footnote-label">7</a></sup></p>
<!-- --><pre><code><span>?o</span>sm_id <!-- --><span>geo:</span>hasGeometry/<!-- --><span>geo:</span>asWKT <!-- --><span>?h</span>asgeometry .
<!-- --></code></pre>
<!-- --><p>Returns the geometry of the result, bound to the variable <!-- --><code>?hasgeometry</code></p>
<!-- --><pre><code><span>?o</span>sm_id <!-- --><span>osmkey:</span>amenity <!-- --><span>&#34;restaurant&#34;</span> . <!-- --><span>?o</span>sm_id <!-- --><span>osmkey:</span>cuisine <!-- --><span>&#34;italian&#34;</span> .
<!-- --></code></pre>
<!-- --><p>Searches for features with the tags <!-- --><code>amenity=restaurant</code> and <!-- --><code>cuisine=italian</code></p>
<!-- --><p>This query takes 3 ms of server computation time
(plus a bit more to send it to our client).</p>
<!-- --><p>This tool can join queries against wikipedia and wikidata,
allowing for some unique use cases.</p>
<!-- --><h3 id="pros-3"><a href="#pros-3">Pros</a></h3>
<!-- --><ul>
<!-- --><li>Browser based interface, don&#39;t need to worry about local installation</li>
<!-- --><li>Allows easily joining on other data sources like Wikipedia</li>
<!-- --></ul>
<!-- --><h3 id="cons-3"><a href="#cons-3">Cons</a></h3>
<!-- --><ul>
<!-- --><li>SPARQL query language is common for RDF data, but still fairly niche overall</li>
<!-- --><li>OSM data lags by about 2 weeks</li>
<!-- --></ul>
<!-- --><h2 id="5-nominatim"><a href="#5-nominatim">5. Nominatim</a></h2>
<!-- --><p><a href="https://nominatim.org/">Nominatim</a> is the official geocoder for openstreetmap.org.
Geocoders are a more specific type of querying tool that look up a
location (coordinates) based on an address or other textual information.
E.g. &#34;101 Main St. Richmond VA&#34; -&gt;  (37.5432629,-77.4461068)<!-- --></p>
<!-- --><p>Often times you might need one if your dataset doesn&#39;t have coordinates,
and only addresses.</p>
<!-- --><p>Another use would be for allowing a user to look up their own location
for context on a map.</p>
<!-- --><p>Nominatim provides a public API to do this, but it has rather strict
limitations on how it can be used.
For example, it cannot be requested more than once/second.</p>
<!-- --><p>Since it&#39;s open source, it can also be self-hosted, but
it has fairly hefty hardware requirements.
They recommend 128 GB of RAM for the whole planet.<!-- --><sup><a href="#user-content-fn-nominatim-planet" id="user-content-fnref-nominatim-planet" data-footnote-ref="true" aria-describedby="footnote-label">8</a></sup></p>
<!-- --><p>Nominatim is also more limited when a full address is not provided, or the
address contains typos.</p>
<!-- --><p>Lastly, if the address is not in OSM to begin with, its location cannot
be found by Nominatim.</p>
<!-- --><h3 id="pros-4"><a href="#pros-4">Pros</a></h3>
<!-- --><ul>
<!-- --><li>Established geocoder software</li>
<!-- --><li>Provides a way to map an address to a location</li>
<!-- --></ul>
<!-- --><h3 id="cons-4"><a href="#cons-4">Cons</a></h3>
<!-- --><ul>
<!-- --><li>Limited usage for public API</li>
<!-- --><li>Requires powerful hardware to self-host</li>
<!-- --></ul>
<!-- --><h2 id="6-pelias"><a href="#6-pelias">6. Pelias</a></h2>
<!-- --><p><a href="https://pelias.io/">Pelias</a> is a newer geocoder service that was created in 2014 and
open sourced in 2017.<!-- --></p>
<!-- --><p>The service uses elasticsearch on the backend to provide a more robust
geocoder service. It also pulls from supplementary sources for address data,
like OpenAddresses.<!-- --><sup><a href="#user-content-fn-open-addresses" id="user-content-fnref-open-addresses" data-footnote-ref="true" aria-describedby="footnote-label">9</a></sup>
This improves the odds of finding a match from your query, since OSM
doesn&#39;t have every address.<!-- --></p>
<!-- --><p>For self-hosting the planet, only 16 GB of RAM are needed according to
the official docs.<!-- --><sup><a href="#user-content-fn-pelias-hardware" id="user-content-fnref-pelias-hardware" data-footnote-ref="true" aria-describedby="footnote-label">10</a></sup></p>
<!-- --><p>The pelias docker repo contains a convenience script for setting up
the service using data from Portland, Oregon.
It took around 10 minutes to download and prepare the data.
Once this is running you can query it locally with:</p>
<!-- --><pre><code>curl http://localhost:4000/v1/search?text=1911+Main+St
</code></pre>
<!-- --><h3 id="pros-5"><a href="#pros-5">Pros</a></h3>
<!-- --><ul>
<!-- --><li>More robust geocoding capabilities compared to Nominatim</li>
<!-- --><li>Docker image makes setup quick and convenient</li>
<!-- --></ul>
<!-- --><h3 id="cons-5"><a href="#cons-5">Cons</a></h3>
<!-- --><ul>
<!-- --><li>No public API at all, but there is a free trial</li>
<!-- --><li>Self-hosting requires managing an Elasticsearch instance yourself, which may be complex</li>
<!-- --></ul>
<!-- --><h2 id="getting-started"><a href="#getting-started">Getting Started</a></h2>
<!-- --><p>Working with OSM can seem daunting at first, but I hope this explanation will
help you take the first steps to answering new questions and building cool stuff!</p>
<!-- --><p>In addition to many wonderful tools, the OpenStreetMap community is incredibly helpful
to newcomers.
I recommend reaching out to the OSM
<!-- --><a href="https://discord.gg/openstreetmap">Discord</a>,
<!-- --><a href="https://slack.openstreetmap.us/">Slack</a>,
or the <!-- --><a href="https://community.openstreetmap.org/">official forum</a> if you need help.<!-- --></p>
<!-- --><h3 id="acknowledgements"><a href="#acknowledgements">Acknowledgements</a></h3>
<!-- --><p>Special thanks to everyone in the OSM community who helped me research this article!
Especially to <!-- --><a href="http://notes.1ec5.org/">Minh Nguyễn</a>
who has helped me numerous times over the years.<!-- --></p>
<!-- -->
<!-- --></div></div>
  </body>
</html>
