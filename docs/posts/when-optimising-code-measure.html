<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.solipsys.co.uk/new/WhenOptimisingCodeMeasure.html?xa15hn">Original</a>
    <h1>When Optimising Code, Measure</h1>
    
    <div id="readability-page-1" class="page"><div><table><tbody><tr><td>
<center>

<a title="Subscribe to my feed" rel="alternate" href="https://www.solipsys.co.uk/rss.xml">
   <img src="https://www.feedburner.com/fb/images/pub/feed-icon32x32.png" alt=""/>Subscribe!</a>
</center>

<hr/>

My latest posts can be
found here:
<ul>
  <li><a href="https://www.solipsys.co.uk/new/ColinsBlog.html?WhenOptimisingCodeMeasure">Colins Blog</a>
</li></ul>
<hr/>

Previous blog posts:
<ul>
  <li><a href="https://www.solipsys.co.uk/new/ADogCalledMixture.html?WhenOptimisingCodeMeasure">A Dog Called Mixture</a>

  </li><li><a href="https://www.solipsys.co.uk/new/AnotherPayPalScam.html?WhenOptimisingCodeMeasure">Another Pay Pal Scam</a>

  </li><li><a href="https://www.solipsys.co.uk/new/WhyTopPostingHasWon.html?WhenOptimisingCodeMeasure">Why Top Posting Has Won</a>

  </li><li><a href="https://www.solipsys.co.uk/new/UnexpectedInteractionOfFeatures.html?WhenOptimisingCodeMeasure">Unexpected Interaction Of Features</a>

  </li><li><a href="https://www.solipsys.co.uk/new/ArchimedesHatBoxTheorem.html?WhenOptimisingCodeMeasure">Archimedes Hat Box Theorem</a>

  </li><li><a href="https://www.solipsys.co.uk/new/ConsideringASphere.html?WhenOptimisingCodeMeasure">Considering A Sphere</a>

  </li><li><a href="https://www.solipsys.co.uk/new/ToLinkOrNotToLink.html?WhenOptimisingCodeMeasure">To Link Or Not To Link</a>

  </li><li><a href="https://www.solipsys.co.uk/new/GenericAdviceForWritingAThesis.html?WhenOptimisingCodeMeasure">Generic Advice For Writing A Thesis</a>

  </li><li><a href="https://www.solipsys.co.uk/new/JustTeachMyChildTheMaths.html?WhenOptimisingCodeMeasure">Just Teach My Child The Maths</a>

  </li><li><a href="https://www.solipsys.co.uk/new/NotASpectatorSport.html?WhenOptimisingCodeMeasure">Not A Spectator Sport</a>

  </li><li><a href="https://www.solipsys.co.uk/new/LeftTruncatablePrime.html?WhenOptimisingCodeMeasure">Left Truncatable Prime</a>

  </li><li><a href="https://www.solipsys.co.uk/new/TheDoctorAndTheLawyer.html?WhenOptimisingCodeMeasure">The Doctor And The Lawyer</a>

  </li><li><a href="https://www.solipsys.co.uk/new/FourPointsTwoDistancesProof.html?WhenOptimisingCodeMeasure">Four Points Two Distances Proof</a>

  </li><li><a href="https://www.solipsys.co.uk/new/MeetingRonGraham.html?WhenOptimisingCodeMeasure">Meeting Ron Graham</a>

  </li><li><a href="https://www.solipsys.co.uk/new/NapkinRingVersusSphericalCap.html?WhenOptimisingCodeMeasure">Napkin Ring Versus Spherical Cap</a>

  </li><li><a href="https://www.solipsys.co.uk/new/TheFourPointsPuzzle.html?WhenOptimisingCodeMeasure">The Four Points Puzzle</a>

  </li><li><a href="https://www.solipsys.co.uk/new/RadiusOfTheEarthPartTwo.html?WhenOptimisingCodeMeasure">Radius Of The Earth Part Two</a>

  </li><li><a href="https://www.solipsys.co.uk/new/GrepTimingAnomaly.html?WhenOptimisingCodeMeasure">Grep Timing Anomaly</a>

  </li><li><a href="https://www.solipsys.co.uk/new/TheRadiusOfTheEarth.html?WhenOptimisingCodeMeasure">The Radius Of The Earth</a>

  </li><li><a href="https://www.solipsys.co.uk/new/ThisWorksToCureMyHiccoughs.html?WhenOptimisingCodeMeasure">This Works To Cure My Hiccoughs</a>

  </li><li><a href="https://www.solipsys.co.uk/new/PerhapsWeSavedOne.html?WhenOptimisingCodeMeasure">Perhaps We Saved One</a>

  </li><li><a href="https://www.solipsys.co.uk/new/ThinkingAboutMastodon.html?WhenOptimisingCodeMeasure">Thinking About Mastodon</a>

  </li><li><a href="https://www.solipsys.co.uk/new/DisappearingTrainsOnVirgin.html?WhenOptimisingCodeMeasure">Disappearing Trains On Virgin</a>

  </li><li><a href="https://www.solipsys.co.uk/new/TheIndependenceGame.html?WhenOptimisingCodeMeasure">The Independence Game</a>

  </li><li><a href="https://www.solipsys.co.uk/new/OneOfMyFavouritePuzzles.html?WhenOptimisingCodeMeasure">One Of My Favourite Puzzles</a>

  </li><li><a href="https://www.solipsys.co.uk/new/ThinkingAboutRecursion.html?WhenOptimisingCodeMeasure">Thinking About Recursion</a>

  </li><li><a href="https://www.solipsys.co.uk/new/MemorisingTheTube.html?WhenOptimisingCodeMeasure">Memorising The Tube</a>

  </li><li><a href="https://www.solipsys.co.uk/new/SpikeySpheres.html?WhenOptimisingCodeMeasure">Spikey Spheres</a>

  </li><li><a href="https://www.solipsys.co.uk/new/SurprisinglyQuick.html?WhenOptimisingCodeMeasure">Surprisingly Quick</a>

  </li><li><a href="https://www.solipsys.co.uk/new/AnUnexpectedFraction.html?WhenOptimisingCodeMeasure">An Unexpected Fraction</a>

  </li><li><a href="https://www.solipsys.co.uk/new/YouHaveToAdmireTheirOptimism.html?WhenOptimisingCodeMeasure">You Have To Admire Their Optimism</a>

  </li><li><a href="https://www.solipsys.co.uk/new/RepresentativesMatter.html?WhenOptimisingCodeMeasure">Representatives Matter</a>

  </li><li><a href="https://www.solipsys.co.uk/new/PythagorasByIncircle.html?WhenOptimisingCodeMeasure">Pythagoras By Incircle</a>

  </li><li><a href="https://www.solipsys.co.uk/new/APuzzleAboutPuzzles.html?WhenOptimisingCodeMeasure">A Puzzle About Puzzles</a>

  </li><li><a href="https://www.solipsys.co.uk/new/HowNotToDoTwitter.html?WhenOptimisingCodeMeasure">How Not To Do Twitter</a>

  </li><li><a href="https://www.solipsys.co.uk/new/Calculating52FactorialByHand.html?WhenOptimisingCodeMeasure">Calculating 52 Factorial By Hand</a>

  </li><li><a href="https://www.solipsys.co.uk/new/SmallThingsMightNotBeSoSmall.html?WhenOptimisingCodeMeasure">Small Things Might Not Be So Small</a>

  </li><li><a href="https://www.solipsys.co.uk/new/NotIfYouHurry.html?WhenOptimisingCodeMeasure">Not If You Hurry</a>

  </li><li><a href="https://www.solipsys.co.uk/new/FactoringViaGraphThreeColouring.html?WhenOptimisingCodeMeasure">Factoring Via Graph Three Colouring</a>

  </li><li><a href="https://www.solipsys.co.uk/new/AnotherProofOfTheDoodleTheorem.html?WhenOptimisingCodeMeasure">Another Proof Of The Doodle Theorem</a>

  </li><li><a href="https://www.solipsys.co.uk/new/WhenObviousIsNotObvious.html?WhenOptimisingCodeMeasure">When Obvious Is Not Obvious</a>

  </li><li><a href="https://www.solipsys.co.uk/new/GraphThreeColouring.html?WhenOptimisingCodeMeasure">Graph Three Colouring</a>

  </li><li><a href="https://www.solipsys.co.uk/new/TheDoodleTheorem.html?WhenOptimisingCodeMeasure">The Doodle Theorem</a>

  </li><li><a href="https://www.solipsys.co.uk/new/BeCarefulWhatYouSay.html?WhenOptimisingCodeMeasure">Be Careful What You Say</a>

  </li><li><a href="https://www.solipsys.co.uk/new/TheMutilatedChessboardRevisited.html?WhenOptimisingCodeMeasure">The Mutilated Chessboard Revisited</a>

  </li><li><a href="https://www.solipsys.co.uk/new/AMirrorCopied.html?WhenOptimisingCodeMeasure">A Mirror Copied</a>

  </li><li><a href="https://www.solipsys.co.uk/new/TheOtherOtherRopeAroundTheEarth.html?WhenOptimisingCodeMeasure">The Other Other Rope Around The Earth</a>

  </li><li><a href="https://www.solipsys.co.uk/new/PhotocopyAMirror.html?WhenOptimisingCodeMeasure">Photocopy A Mirror</a>

  </li><li><a href="https://www.solipsys.co.uk/new/ThePointOfTheBanachTarskiTheorem.html?WhenOptimisingCodeMeasure">The Point Of The Banach Tarski Theorem</a>

  </li><li><a href="https://www.solipsys.co.uk/new/SieveOfEratosthenesInPython.html?WhenOptimisingCodeMeasure">Sieve Of Eratosthenes In Python</a>

  </li><li><a href="https://www.solipsys.co.uk/new/FastPerrinTest.html?WhenOptimisingCodeMeasure">Fast Perrin Test</a>

  </li><li><a href="https://www.solipsys.co.uk/new/RussianPeasantMultiplication.html?WhenOptimisingCodeMeasure">Russian Peasant Multiplication</a>

  </li><li><a href="https://www.solipsys.co.uk/new/FindingPerrinPseudoPrimes_Part2.html?WhenOptimisingCodeMeasure">FindingPerrinPseudoPrimes Part2</a>

  </li><li><a href="https://www.solipsys.co.uk/new/FindingPerrinPseudoPrimes_Part1.html?WhenOptimisingCodeMeasure">FindingPerrinPseudoPrimes Part1</a>

  </li><li><a href="https://www.solipsys.co.uk/new/TheUnwiseUpdate.html?WhenOptimisingCodeMeasure">The Unwise Update</a>

  </li><li><a href="https://www.solipsys.co.uk/new/MilesPerGallon.html?WhenOptimisingCodeMeasure">Miles Per Gallon</a>

  </li><li><a href="https://www.solipsys.co.uk/new/TrackingAnItemOnHackerNews.html?WhenOptimisingCodeMeasure">Tracking An Item On Hacker News</a>

  </li><li><a href="https://www.solipsys.co.uk/new/HackerNewsUserAges.html?WhenOptimisingCodeMeasure">Hacker News User Ages</a>

  </li><li><a href="https://www.solipsys.co.uk/new/PokingTheDustyCorners.html?WhenOptimisingCodeMeasure">Poking The Dusty Corners</a>

  </li><li><a href="https://www.solipsys.co.uk/new/ThereIsNoTimeForThis.html?WhenOptimisingCodeMeasure">There Is No Time For This</a>

  </li><li><a href="https://www.solipsys.co.uk/new/PublicallySharingLinks.html?WhenOptimisingCodeMeasure">Publically Sharing Links</a>

  </li><li><a href="https://www.solipsys.co.uk/new/LearningTimesTables.html?WhenOptimisingCodeMeasure">Learning Times Tables</a>

  </li><li><a href="https://www.solipsys.co.uk/new/GracefulDegradation.html?WhenOptimisingCodeMeasure">Graceful Degradation</a>

  </li><li><a href="https://www.solipsys.co.uk/new/DiagrammingMathsTopics.html?WhenOptimisingCodeMeasure">Diagramming Maths Topics</a>

  </li><li><a href="https://www.solipsys.co.uk/new/OnTheRack.html?WhenOptimisingCodeMeasure">On The Rack</a>

  </li><li><a href="https://www.solipsys.co.uk/new/SquareRootByLongDivision.html?WhenOptimisingCodeMeasure">Square Root By Long Division</a>

  </li><li><a href="https://www.solipsys.co.uk/new/BeyondTheBoundary.html?WhenOptimisingCodeMeasure">Beyond The Boundary</a>

  </li><li><a href="https://www.solipsys.co.uk/new/FillInTheGaps.html?WhenOptimisingCodeMeasure">Fill In The Gaps</a>

  </li><li><a href="https://www.solipsys.co.uk/new/SoftwareChecklist.html?WhenOptimisingCodeMeasure">Software Checklist</a>

  </li><li><a href="https://www.solipsys.co.uk/new/NASASpaceCrews.html?WhenOptimisingCodeMeasure">NASA Space Crews</a>

  </li><li><a href="https://www.solipsys.co.uk/new/TheBirthdayParadox.html?WhenOptimisingCodeMeasure">The Birthday Paradox</a>

  </li><li><a href="https://www.solipsys.co.uk/new/TheTrapeziumConundrum.html?WhenOptimisingCodeMeasure">The Trapezium Conundrum</a>

  </li><li><a href="https://www.solipsys.co.uk/new/RevisitingTheAnt.html?WhenOptimisingCodeMeasure">Revisiting The Ant</a>

  </li><li><a href="https://www.solipsys.co.uk/new/TheAntAndTheRubberBand.html?WhenOptimisingCodeMeasure">The Ant And The Rubber Band</a>

  </li><li><a href="https://www.solipsys.co.uk/new/IrrationalsExist.html?WhenOptimisingCodeMeasure">Irrationals Exist</a>

  </li><li><a href="https://www.solipsys.co.uk/new/MultipleChoiceProbabilityPuzzle.html?WhenOptimisingCodeMeasure">Multiple Choice Probability Puzzle</a>

  </li><li><a href="https://www.solipsys.co.uk/new/RandomEratosthenes.html?WhenOptimisingCodeMeasure">Random Eratosthenes</a>

  </li><li><a href="https://www.solipsys.co.uk/new/WrappingUpSquareDissection.html?WhenOptimisingCodeMeasure">Wrapping Up Square Dissection</a>

  </li><li><a href="https://www.solipsys.co.uk/new/DissectingASquarePart2.html?WhenOptimisingCodeMeasure">Dissecting A Square Part 2</a>

  </li><li><a href="https://www.solipsys.co.uk/new/DissectingACircle.html?WhenOptimisingCodeMeasure">Dissecting A Circle</a>

  </li><li><a href="https://www.solipsys.co.uk/new/DissectingASquare.html?WhenOptimisingCodeMeasure">Dissecting A Square</a>

  </li><li><a href="https://www.solipsys.co.uk/new/AnOddityInTennis.html?WhenOptimisingCodeMeasure">An Oddity In Tennis</a>

  </li><li><a href="https://www.solipsys.co.uk/new/DecisionTreeForTennis.html?WhenOptimisingCodeMeasure">Decision Tree For Tennis</a>

  </li><li><a href="https://www.solipsys.co.uk/new/DecisionTreesInGames.html?WhenOptimisingCodeMeasure">Decision Trees In Games</a>

  </li><li><a href="https://www.solipsys.co.uk/new/AMatterOfConvention.html?WhenOptimisingCodeMeasure">A Matter Of Convention</a>

  </li><li><a href="https://www.solipsys.co.uk/new/DoYouNourishOrTarnish.html?WhenOptimisingCodeMeasure">Do You Nourish Or Tarnish</a>

  </li><li><a href="https://www.solipsys.co.uk/new/BinarySearchReconsidered.html?WhenOptimisingCodeMeasure">Binary Search Reconsidered</a>

  </li><li><a href="https://www.solipsys.co.uk/new/TwoEqualsFour.html?WhenOptimisingCodeMeasure">Two Equals Four</a>

  </li><li><a href="https://www.solipsys.co.uk/new/TheLostPropertyOffice.html?WhenOptimisingCodeMeasure">The Lost Property Office</a>

  </li><li><a href="https://www.solipsys.co.uk/new/TheForgivingUserInterface.html?WhenOptimisingCodeMeasure">The Forgiving User Interface</a>

  </li><li><a href="https://www.solipsys.co.uk/new/SettingUpRSS.html?WhenOptimisingCodeMeasure">Setting Up RSS</a>

  </li><li><a href="https://www.solipsys.co.uk/new/WithdrawingFromHackerNews.html?WhenOptimisingCodeMeasure">Withdrawing From Hacker News</a>
</li></ul>
<hr/>

Additionally, some earlier writings:
<ul>
  <li><a href="https://www.solipsys.co.uk/new/RandomWritings.html?WhenOptimisingCodeMeasure">Random Writings.</a>

  </li><li><a href="https://www.solipsys.co.uk/new/ColinsBlog2010.html?WhenOptimisingCodeMeasure">Colins Blog 2010</a>

  </li><li><a href="https://www.solipsys.co.uk/new/ColinsBlog2009.html?WhenOptimisingCodeMeasure">Colins Blog 2009</a>

  </li><li><a href="https://www.solipsys.co.uk/new/ColinsBlog2008.html?WhenOptimisingCodeMeasure">Colins Blog 2008</a>

  </li><li><a href="https://www.solipsys.co.uk/new/ColinsBlog2007.html?WhenOptimisingCodeMeasure">Colins Blog 2007</a>

  </li><li><a href="https://www.solipsys.co.uk/new/ColinsBlogBefore2007.html?WhenOptimisingCodeMeasure">Colins Blog Before 2007</a>
</li></ul>
</td><td>
<a name="toc_name000"></a>
<h2>When optimising code, never guess, always measure.</h2>
<p>
 
This is a truism that lots of people quote, but it can be hard to
remember, especially in the heat of battle (as it were). Rather
fortunately it came to mind just when needed, as I found something
completely unexpected.
</p><p>
I was writing a simple implementation of the Fermat difference of
squares method of factoring. This involves writing the number to
be factored as - you guessed it - the difference of two squares.
If $n=a^2-b^2$ then $n=(a-b)(a+b)$ and we have a factorisation
(provided we don&#39;t have $a-b=1$).
</p><hr/>

<h3>Version 0</h3>
<center><table><tbody><tr><td>
So the obvious thing to do is to take the square root of $n$, round
it up to get a candidate for $a$, then look at $a^2-n$. If that&#39;s
a square then we&#39;re done.
</td><td>
<pre> 
def factor_fermat0(n):

    a = square_root_ceil(n)
    while True:

        d = a*a-n

        b = square_root_ceil(d)

        if b**2 == d:
            return a-b, a+b

        a += 1
</pre>
</td></tr></tbody></table></center>
<hr/>

<a name="toc_name002"></a>
<h3>Version 1</h3>
<center><table><tbody><tr><td>
We can improve on this. We can increase $a$ until we have $a^2-b^2&gt;n$,
and then increase $b$ until $a^2-b^2&lt;n$. If $n$ is odd then we&#39;ll get
equality at some point, so we just continue until that happens, and
we&#39;re done.
</td><td>
<pre> 
def factor_fermat1( n ):
    a = square_root_ceil(n)
    b = square_root_ceil(a**2-n)

    while a**2-b**2 != n:
        while a**2-b**2 &lt; n: a += 1
        while a**2-b**2 &gt; n: b += 1

    return a-b, a+b
</pre>
</td></tr></tbody></table></center>
<hr/>

<a name="toc_name003"></a>
<h3>Version 2</h3>
<center><table><tbody><tr><td>
Now we notice that we are repeatedly computing the squares of $a$
and $b$, so we create variables to hold the squares and update them
by remembering that $(x+1)^2=x^2+2x+1$.
</td><td>
<pre> 
def factor_fermat2( n ):
    a = square_root_ceil(n)
    a2 = a**2
    b = square_root_ceil(a**2-n)
    b2 = b**2
    while a2-b2 != n:
        while a2-b2 &lt; n: a2, a = a2+a+a+1, a+1
        while a2-b2 &gt; n: b2, b = b2+b+b+1, b+1

    return a-b, a+b
</pre>
</td></tr></tbody></table></center>
<hr/>

<a name="toc_name004"></a>
<h3>Version 3</h3>
<center><table><tbody><tr><td>
We can improve that slightly further by having $c=2a+1$ and $d=2b+1$,
and the code now becomes:
</td><td>
<pre> 
def factor_fermat3( n ):
    a = square_root_ceil(n)
    a2 = a**2
    c = 2*a+1
    b = square_root_ceil(a**2-n)
    b2 = b**2
    d = 2*b+1
    while a2-b2 != n:
        while a2-b2 &lt; n: a2, c = a2+c, c+2
        while a2-b2 &gt; n: b2, d = b2+d, d+2

    return (c-d)/2, (c+d)/2-1
</pre>
</td></tr></tbody></table></center>
<hr/>

<h2>Let&#39;s see how we&#39;re doing</h2>
<p>
These improvements all seem obvious and straight-forward, and we can
check by doing some timing tests. The times, and indeed, the <i>ratios</i>
of times, will vary according to the number being factored, so we can
do two different numbers and see what the trend is. If you choose to
analyse the algorithm then you&#39;ll see what&#39;s going on. However, we
factored two different numbers:
</p><center>

<center><table><tbody><tr><td>
4736906887651 = </td><td>
<table>
<tbody><tr><td>Routine </td><td> <center>
 0 </center>
 </td><td> <center>
 1 </center>
 </td><td> <center>
 2 </center>
 </td><td> <center>
 3 </center>
</td></tr>

<tr><td>Run 0 </td><td> 9.223 </td><td> 0.409 </td><td> 0.258 </td><td> 0.188</td></tr>

<tr><td>Run 1 </td><td> 9.138 </td><td> 0.408 </td><td> 0.258 </td><td> 0.188</td></tr>

<tr><td>Run 2 </td><td> 9.146 </td><td> 0.407 </td><td> 0.262 </td><td> 0.194</td></tr>

<tr><td>Run 3 </td><td> 9.149 </td><td> 0.416 </td><td> 0.258 </td><td> 0.188</td></tr>

<tr><td>Run 4 </td><td> 9.228 </td><td> 0.408 </td><td> 0.272 </td><td> 0.189</td></tr>

<tr><td>Run 5 </td><td> 9.187 </td><td> 0.407 </td><td> 0.258 </td><td> 0.188</td></tr>

<tr><td>Run 6 </td><td> 9.154 </td><td> 0.421 </td><td> 0.259 </td><td> 0.188</td></tr>

<tr><td>Run 7 </td><td> 9.157 </td><td> 0.407 </td><td> 0.259 </td><td> 0.189</td></tr>

</tbody></table></td></tr></tbody></table></center>
</center>

<center>

<center><table><tbody><tr><td>
47368008965429 = </td><td>
<table>
<tbody><tr><td>Routine </td><td> <center>
 0 </center>
 </td><td> <center>
 1 </center>
 </td><td> <center>
 2 </center>
 </td><td> <center>
 3 </center>
</td></tr>

<tr><td>Run 0 </td><td> 34.922 </td><td> 1.230 </td><td> 0.774 </td><td> 0.564</td></tr>

<tr><td>Run 1 </td><td> 34.276 </td><td> 1.214 </td><td> 0.775 </td><td> 0.562</td></tr>

<tr><td>Run 2 </td><td> 34.191 </td><td> 1.215 </td><td> 0.777 </td><td> 0.564</td></tr>

<tr><td>Run 3 </td><td> 34.198 </td><td> 1.214 </td><td> 0.776 </td><td> 0.564</td></tr>

<tr><td>Run 4 </td><td> 34.182 </td><td> 1.230 </td><td> 0.776 </td><td> 0.563</td></tr>

<tr><td>Run 5 </td><td> 34.226 </td><td> 1.244 </td><td> 0.775 </td><td> 0.563</td></tr>

<tr><td>Run 6 </td><td> 34.144 </td><td> 1.235 </td><td> 0.773 </td><td> 0.564</td></tr>

<tr><td>Run 7 </td><td> 34.104 </td><td> 1.233 </td><td> 0.775 </td><td> 0.565</td></tr>

</tbody></table></td></tr></tbody></table></center>
</center>

<p>
We can see that the first routine is rubbish, but that&#39;s no surprise,
as it&#39;s computing a square root every time through the loop. For the
others we can see a clear improvement as we make those optimisations.
It did surprise me just how big the improvement was from #2 to #3,
but it was nice to see.
</p><hr/>

<a name="toc_name006"></a>
<h3>Version 4</h3>
<center><table><tbody><tr><td>
Then I made a small change to the code layout ready for another shot
at an optimisation. Pretty uncontroversial - I ran the timing tests
again to make sure there was no difference, using a larger number,
and not bothering to use the reference &#34;version 0&#34; since that was so
slow.
</td><td>
<div>

<pre> 
def factor_fermat4( n ):
    a = square_root_ceil(n)
    a2 = a**2
    c = 2*a+1
    b = square_root_ceil(a**2-n)
    b2 = b**2
    d = 2*b+1
    while a2-b2 != n:
        while a2-b2 &lt; n:
            a2 += c
            c += 2
        while a2-b2 &gt; n:
            b2 += d
            d += 2

    return (c-d)/2, (c+d)/2-1
</pre>
</div> 
</td></tr></tbody></table></center>
<center>

<center><table><tbody><tr><td>
47368008965429 = </td><td>
<table>
<tbody><tr><td>Routine </td><td> <center>
 1 </center>
 </td><td> <center>
 2 </center>
 </td><td> <center>
 3 </center>
 </td><td> <center>
 4 </center>
</td></tr>

<tr><td>Run 0 </td><td> 1.225 </td><td> 0.774 </td><td> 0.562 </td><td> 0.622</td></tr>

<tr><td>Run 1 </td><td> 1.223 </td><td> 0.772 </td><td> 0.562 </td><td> 0.624</td></tr>

<tr><td>Run 2 </td><td> 1.238 </td><td> 0.776 </td><td> 0.567 </td><td> 0.625</td></tr>

<tr><td>Run 3 </td><td> 1.233 </td><td> 0.777 </td><td> 0.566 </td><td> 0.626</td></tr>

<tr><td>Run 4 </td><td> 1.229 </td><td> 0.769 </td><td> 0.563 </td><td> 0.624</td></tr>

<tr><td>Run 5 </td><td> 1.231 </td><td> 0.773 </td><td> 0.562 </td><td> 0.624</td></tr>

<tr><td>Run 6 </td><td> 1.225 </td><td> 0.771 </td><td> 0.563 </td><td> 0.625</td></tr>

<tr><td>Run 7 </td><td> 1.219 </td><td> 0.771 </td><td> 0.563 </td><td> 0.622</td></tr>

</tbody></table></td></tr></tbody></table></center>
</center>

<p>
Wait - what? It&#39;s slower? How can that be? I&#39;d&#39;ve thought it would
compile to exactly the same bytecode, and so execute in pretty much the
same time.
</p><p>
Just to be sure I ran it on a bigger number.
</p><center>

<center><table><tbody><tr><td>
4736791755876611 = </td><td>
<table>
<tbody><tr><td>Routine </td><td> <center>
 1 </center>
 </td><td> <center>
 2 </center>
 </td><td> <center>
 3 </center>
 </td><td> <center>
 4 </center>
</td></tr>

<tr><td>Run 0 </td><td> 12.388 </td><td> 7.775 </td><td> 5.672 </td><td> 6.245</td></tr>

<tr><td>Run 1 </td><td> 12.215 </td><td> 7.767 </td><td> 5.660 </td><td> 6.256</td></tr>

<tr><td>Run 2 </td><td> 12.295 </td><td> 7.910 </td><td> 5.674 </td><td> 6.301</td></tr>

<tr><td>Run 3 </td><td> 12.196 </td><td> 7.749 </td><td> 5.645 </td><td> 6.247</td></tr>

<tr><td>Run 4 </td><td> 12.221 </td><td> 7.731 </td><td> 5.646 </td><td> 6.294</td></tr>

<tr><td>Run 5 </td><td> 12.227 </td><td> 7.750 </td><td> 5.638 </td><td> 6.232</td></tr>

<tr><td>Run 6 </td><td> 12.226 </td><td> 7.798 </td><td> 5.691 </td><td> 6.250</td></tr>

<tr><td>Run 7 </td><td> 12.164 </td><td> 7.753 </td><td> 5.646 </td><td> 6.264</td></tr>

</tbody></table></td></tr></tbody></table></center>
</center>

<p>
There is no doubt:
</p><center>
   </center>

<p>
That caught me by surprise, but it really does go to show:
</p><center>
   </center>

<p>
My guess is that in the first case the two evaluations and assignments
can happen in parallel, and so may happen on different cores, whereas
in the second case they must happen in serial, but that&#39;s just a guess.
Maybe someone reading this knows for sure.
</p><p>
Let me know.
</p><p>
I&#39;ve got more changes to make, but one thing is for sure - I&#39;ll be
measuring the improvements as I go to make sure they really do make
things better.
</p><hr/>

<h2>References:</h2>
<ul>
  <li><a href="https://en.wikipedia.org/wiki/Fermat%27s_factorization_method">https://en.wikipedia.org/wiki/Fermat%27s_factorization_method</a>
</li></ul>
<hr/>

<h2>Comments</h2>
<p>
The following comment was sent, but I don&#39;t know if the person is happy
to be mentioned by name - if it&#39;s you, please let me know. However, they
said this (paraphrased):
</p><p>
<div>

Using the standard python interpreter the GIL would prevent
<pre> 
a2, c = a2+c, c+2
</pre>
from executing in parallel.
<p>
Another big optimization would be to replace a**2 with a*a. Multiplication
is much faster than power functions &lt; 4. It is possible the interpreter
does this automatically, but I don&#39;t think so.
</p></div> 
</p><p>
And to whomever it was - thank you for the response.
</p><hr/>

<center>

<hr/>

<center></center>
<hr/>

<h2>Send us a comment ...</h2>
<form action="https://www.solipsys.co.uk/cgi-bin/FormMail.pl" method="post">






<center><table><tbody><tr><td>
You can send us a message here. It doesn&#39;t get published,
it just sends us an email, and is an easy way to ask any
questions, or make any comments, without having to send a
separate email. So just fill in the boxes and then:
</td><td>
</td><td>
If you include an email address then I&#39;ll be able to respond,
and conversely, if you don&#39;t, I won&#39;t! Likewise, if you give
me explicit permission to add your comments here then I might
choose to do so, and if you don&#39;t, I won&#39;t!
<p>
So if you reply, please include your preferences, otherwise
I&#39;ll read you email, nod sagely, and file it away.
</p></td></tr></tbody></table></center>
<p>
<table>
  <tbody><tr>
    <td>Your name </td> <td>:</td>
    <td>  </td>
  </tr><tr>
    <td>Email </td> <td>:</td>
    <td>  </td>
    </tr>
  <tr>
    <td>Message </td> <td>:</td>
    <td>  </td>
    </tr>
  </tbody></table>
</p><center>
  <SPAN size="+4">
    
    </SPAN>
  </center>
</form>
</center></td></tr></tbody></table></div></div>
  </body>
</html>
