<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.ndepend.com/net-9-0-linq-performance-improvements/">Original</a>
    <h1>Net 9.0 LINQ Performance Improvements</h1>
    
    <div id="readability-page-1" class="page"><article id="post-6272">
	
	<!-- .entry-header -->

	<div>
		<p><span>October 17, 2024</span> <span> </span> <span>5 minutes read </span></p><p><a href="https://blog.ndepend.com/wp-content/uploads/Alternate-Lookup-for-Dictionary-and-HashSet-in-.NET-9-1.png"><img fetchpriority="high" decoding="async" src="https://blog.ndepend.com/wp-content/uploads/Alternate-Lookup-for-Dictionary-and-HashSet-in-.NET-9-1.png" alt=".NET 9.0 LINQ Performance Improvements" width="1230" height="722" srcset="https://blog.ndepend.com/wp-content/uploads/Alternate-Lookup-for-Dictionary-and-HashSet-in-.NET-9-1.png 1230w, https://blog.ndepend.com/wp-content/uploads/Alternate-Lookup-for-Dictionary-and-HashSet-in-.NET-9-1-300x176.png 300w, https://blog.ndepend.com/wp-content/uploads/Alternate-Lookup-for-Dictionary-and-HashSet-in-.NET-9-1-1024x601.png 1024w, https://blog.ndepend.com/wp-content/uploads/Alternate-Lookup-for-Dictionary-and-HashSet-in-.NET-9-1-768x451.png 768w" sizes="(max-width: 1230px) 100vw, 1230px"/></a> NET 9.0 brings significant improvements to LINQ performance, with some scenarios showing remarkable gains. Let’s take a closer look at what’s driving these enhancements. The lessons learned will be relevant to your code.</p>

<h2><span id="Iterating_with_Span_when_Possible"></span>Iterating with Span&lt;T&gt; when Possible<span></span></h2>
<p>Let’s start by running this benchmark on .NET 8 versus .NET 9.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-67124f6522f22762917268" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p></div>
				</td>
						<td><div><p><span>using </span><span>BenchmarkDotNet</span><span>.</span><span>Configs</span><span>;</span></p><p><span>using </span><span>BenchmarkDotNet</span><span>.</span><span>Running</span><span>;</span></p><p><span>using </span><span>BenchmarkDotNet</span><span>.</span><span>Attributes</span><span>;</span></p><p><span>using </span><span>BenchmarkDotNet</span><span>.</span><span>Jobs</span><span>;</span></p><p><span>BenchmarkRunner</span><span>.</span><span>Run</span><span>&lt;</span><span>Benchmarks</span><span>&gt;</span><span>(</span><span>)</span><span>;</span></p><p><span>[</span><span>MemoryDiagnoser</span><span>]</span></p><p><span>[</span><span>HideColumns</span><span>(</span><span>&#34;StdDev&#34;</span><span>,</span><span> </span><span>&#34;Median&#34;</span><span>,</span><span> </span><span>&#34;Job&#34;</span><span>,</span><span> </span><span>&#34;RatioSD&#34;</span><span>,</span><span> </span><span>&#34;Error&#34;</span><span>,</span><span> </span><span>&#34;Gen0&#34;</span><span>,</span><span> </span><span>&#34;Alloc Ratio&#34;</span><span>)</span><span>]</span></p><p><span>[</span><span>SimpleJob</span><span>(</span><span>RuntimeMoniker</span><span>.</span><span>Net80</span><span>,</span><span> </span><span>baseline</span><span>:</span><span> </span><span>true</span><span>)</span><span>]</span></p><p><span>[</span><span>SimpleJob</span><span>(</span><span>RuntimeMoniker</span><span>.</span><span>Net90</span><span>)</span><span>]</span></p><p><span>public</span><span> </span><span>class</span><span> </span><span>Benchmarks</span><span> </span><span>{</span></p><p><span>   </span><span>private</span><span> </span><span>IEnumerable</span><span>&lt;</span><span>int</span><span>&gt;</span><span> </span><span>_array</span><span> </span>=<span> </span><span>Enumerable</span><span>.</span><span>Range</span><span>(</span><span>1</span><span>,</span><span> </span><span>10_000</span><span>)</span><span>.</span><span>ToArray</span><span>(</span><span>)</span><span>;</span></p><p><span>   </span><span>[</span><span>Benchmark</span><span>]</span><span> </span><span>public</span><span> </span><span>int</span><span> </span><span>Count</span><span>(</span><span>)</span><span> </span>=<span>&gt;</span><span> </span><span>_array</span><span>.</span><span>Count</span><span>(</span><span>i</span><span> </span>=<span>&gt;</span><span> </span><span>i</span><span> </span><span>&gt;</span><span> </span><span>0</span><span>)</span><span>;</span></p><p><span>   </span><span>[</span><span>Benchmark</span><span>]</span><span> </span><span>public</span><span> </span><span>bool</span><span> </span><span>All</span><span>(</span><span>)</span><span> </span>=<span>&gt;</span><span> </span><span>_array</span><span>.</span><span>All</span><span>(</span><span>i</span><span> </span>=<span>&gt;</span><span> </span><span>i</span><span> </span><span>&gt;</span><span> </span><span>500</span><span>)</span><span>;</span></p><p><span>   </span><span>[</span><span>Benchmark</span><span>]</span><span> </span><span>public</span><span> </span><span>bool</span><span> </span><span>Any</span><span>(</span><span>)</span><span> </span>=<span>&gt;</span><span> </span><span>_array</span><span>.</span><span>Any</span><span>(</span><span>i</span><span> </span>=<span>&gt;</span><span> </span><span>i</span><span> </span>==<span> </span><span>9_999</span><span>)</span><span>;</span></p><p><span>   </span><span>[</span><span>Benchmark</span><span>]</span><span> </span><span>public</span><span> </span><span>int</span><span> </span><span>First</span><span>(</span><span>)</span><span> </span>=<span>&gt;</span><span> </span><span>_array</span><span>.</span><span>First</span><span>(</span><span>i</span><span> </span>=<span>&gt;</span><span> </span><span>i</span><span> </span><span>&gt;</span><span> </span><span>9_000</span><span>)</span><span>;</span></p><p><span>   </span><span>[</span><span>Benchmark</span><span>]</span><span> </span><span>public</span><span> </span><span>int</span><span> </span><span>Single</span><span>(</span><span>)</span><span> </span>=<span>&gt;</span><span> </span><span>_array</span><span>.</span><span>Single</span><span>(</span><span>i</span><span> </span>=<span>&gt;</span><span> </span><span>i</span><span> </span>==<span> </span><span>9_999</span><span>)</span><span>;</span></p><p><span>   </span><span>[</span><span>Benchmark</span><span>]</span><span> </span><span>public</span><span> </span><span>int</span><span> </span><span>Last</span><span>(</span><span>)</span><span> </span>=<span>&gt;</span><span> </span><span>_array</span><span>.</span><span>Last</span><span>(</span><span>i</span><span> </span>=<span>&gt;</span><span> </span><span>i</span><span> </span><span>&gt;</span><span> </span><span>0</span><span>)</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0017 seconds] -->


<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-67124f6522f27054400802" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>&lt;</span><span>Project </span><span>Sdk</span>=<span>&#34;Microsoft.NET.Sdk&#34;</span><span>&gt;</span></p><p><span>  </span><span>&lt;</span><span>PropertyGroup</span><span>&gt;</span></p><p><span>    </span><span>&lt;</span><span>OutputType</span><span>&gt;</span><span>Exe</span><span>&lt;</span>/<span>OutputType</span><span>&gt;</span></p><p><span>    </span><span>&lt;</span><span>TargetFrameworks</span><span>&gt;</span><span>net8</span><span>.</span><span>0</span><span>;</span><span>net9</span><span>.</span><span>0</span><span>&lt;</span>/<span>TargetFrameworks</span><span>&gt;</span></p><p><span>    </span><span>&lt;</span><span>ImplicitUsings</span><span>&gt;</span><span>enable</span><span>&lt;</span>/<span>ImplicitUsings</span><span>&gt;</span></p><p><span>    </span><span>&lt;</span><span>Nullable</span><span>&gt;</span><span>enable</span><span>&lt;</span>/<span>Nullable</span><span>&gt;</span></p><p><span>  </span><span>&lt;</span>/<span>PropertyGroup</span><span>&gt;</span></p><p><span>  </span><span>&lt;</span><span>ItemGroup</span><span>&gt;</span></p><p><span>    </span><span>&lt;</span><span>PackageReference </span><span>Include</span>=<span>&#34;BenchmarkDotNet&#34;</span><span> </span><span>Version</span>=<span>&#34;0.14.0&#34;</span><span> </span>/<span>&gt;</span></p><p><span>  </span><span>&lt;</span>/<span>ItemGroup</span><span>&gt;</span></p><p><span>&lt;</span>/<span>Project</span><span>&gt;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>Here are the results, which clearly speak for themselves.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-67124f6522f29360496698" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p></div>
				</td>
						<td><div><p><span>|</span><span> </span><span>Method</span><span>     </span><span>|</span><span> </span><span>Runtime</span><span>  </span><span>|</span><span> </span><span>Mean</span><span>          </span><span>|</span><span> </span><span>Ratio</span><span> </span><span>|</span><span> </span><span>Allocated</span><span> </span><span>|</span></p><p><span>|</span>-----------<span> </span><span>|</span>---------<span> </span><span>|</span>--------------<span>:</span><span>|</span>------<span>:</span><span>|</span>----------<span>:</span><span>|</span></p><p><span>|</span><span> </span><span>LinqCount</span><span>  </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>8.0</span><span> </span><span>|</span><span> </span><span>16</span><span>,</span><span>198.490</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>1.00</span><span> </span><span>|</span><span>      </span><span>32</span><span> </span><span>B</span><span> </span><span>|</span></p><p><span>|</span><span> </span><span>LinqCount</span><span>  </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>9.0</span><span> </span><span>|</span><span>  </span><span>3</span><span>,</span><span>043.563</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>0.19</span><span> </span><span>|</span><span>         </span>-<span> </span><span>|</span></p><p><span>|</span><span>            </span><span>|</span><span>          </span><span>|</span><span>               </span><span>|</span><span>       </span><span>|</span><span>           </span><span>|</span></p><p><span>|</span><span> </span><span>LinqAll</span><span>    </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>8.0</span><span> </span><span>|</span><span>     </span><span>10.588</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>1.00</span><span> </span><span>|</span><span>      </span><span>32</span><span> </span><span>B</span><span> </span><span>|</span></p><p><span>|</span><span> </span><span>LinqAll</span><span>    </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>9.0</span><span> </span><span>|</span><span>      </span><span>2.562</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>0.24</span><span> </span><span>|</span><span>         </span>-<span> </span><span>|</span></p><p><span>|</span><span>            </span><span>|</span><span>          </span><span>|</span><span>               </span><span>|</span><span>       </span><span>|</span><span>           </span><span>|</span></p><p><span>|</span><span> </span><span>LinqAny</span><span>    </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>8.0</span><span> </span><span>|</span><span> </span><span>17</span><span>,</span><span>096.735</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>1.00</span><span> </span><span>|</span><span>      </span><span>32</span><span> </span><span>B</span><span> </span><span>|</span></p><p><span>|</span><span> </span><span>LinqAny</span><span>    </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>9.0</span><span> </span><span>|</span><span>  </span><span>2</span><span>,</span><span>483.927</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>0.15</span><span> </span><span>|</span><span>         </span>-<span> </span><span>|</span></p><p><span>|</span><span>            </span><span>|</span><span>          </span><span>|</span><span>               </span><span>|</span><span>       </span><span>|</span><span>           </span><span>|</span></p><p><span>|</span><span> </span><span>LinqFirst</span><span>  </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>8.0</span><span> </span><span>|</span><span> </span><span>15</span><span>,</span><span>289.747</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>1.00</span><span> </span><span>|</span><span>      </span><span>32</span><span> </span><span>B</span><span> </span><span>|</span></p><p><span>|</span><span> </span><span>LinqFirst</span><span>  </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>9.0</span><span> </span><span>|</span><span>  </span><span>2</span><span>,</span><span>243.341</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>0.15</span><span> </span><span>|</span><span>         </span>-<span> </span><span>|</span></p><p><span>|</span><span>            </span><span>|</span><span>          </span><span>|</span><span>               </span><span>|</span><span>       </span><span>|</span><span>           </span><span>|</span></p><p><span>|</span><span> </span><span>LinqSingle</span><span> </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>8.0</span><span> </span><span>|</span><span> </span><span>21</span><span>,</span><span>684.114</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>1.00</span><span> </span><span>|</span><span>      </span><span>32</span><span> </span><span>B</span><span> </span><span>|</span></p><p><span>|</span><span> </span><span>LinqSingle</span><span> </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>9.0</span><span> </span><span>|</span><span>  </span><span>4</span><span>,</span><span>884.329</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>0.23</span><span> </span><span>|</span><span>         </span>-<span> </span><span>|</span></p><p><span>|</span><span>            </span><span>|</span><span>          </span><span>|</span><span>               </span><span>|</span><span>       </span><span>|</span><span>           </span><span>|</span></p><p><span>|</span><span> </span><span>LinqLast</span><span>   </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>8.0</span><span> </span><span>|</span><span>     </span><span>15.967</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>1.00</span><span> </span><span>|</span><span>         </span>-<span> </span><span>|</span></p><p><span>|</span><span> </span><span>LinqLast</span><span>   </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>9.0</span><span> </span><span>|</span><span>      </span><span>6.918</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>0.43</span><span> </span><span>|</span><span>         </span>-<span> </span><span>|</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->

<h3><span id="The_TryGetSpan_Method"></span>The TryGetSpan() Method<span></span></h3>
<p>In the post <a href="https://blog.ndepend.com/c-array-and-list-fastest-loop" target="_blank" rel="noopener">C# Array and List Fastest Loop</a>, we demonstrated that using a <code>Span&lt;T&gt;</code> for iterating over an array is faster than regular <code>for</code> and <code>foreach</code> loops. In the benchmark above, the performance enhancement is primarily due to the use of the method <code><a href="https://github.com/dotnet/runtime/blob/main/src/libraries/System.Linq/src/System/Linq/Enumerable.cs#L40" target="_blank" rel="noopener">TryGetSpan()</a></code>. If the enumerable being iterated is an array or list, the method <code>TryGetSpan()</code> returns a <code>ReadOnlySpan&lt;T&gt;</code> for faster iteration. Here is the code extracted from <code>TryGetSpan()</code> to test if the <code>source</code> to enumerate is an array or a list, and then to obtain the span from the array or the list.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-67124f6522f2a289099695" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>   </span><span>if</span><span> </span><span>(</span><span>source</span><span>.</span><span>GetType</span><span>(</span><span>)</span><span> </span>==<span> </span><span>typeof</span><span>(</span><span>TSource</span><span>[</span><span>]</span><span>)</span><span>)</span><span> </span><span>{</span></p><p><span>     </span><span>span</span><span> </span>=<span> </span><span>Unsafe</span><span>.</span><span>As</span><span>&lt;</span><span>TSource</span><span>[</span><span>]</span><span>&gt;</span><span>(</span><span>source</span><span>)</span><span>;</span></p><p><span>   </span><span>}</span><span> </span><span>else</span><span> </span><span>if</span><span> </span><span>(</span><span>source</span><span>.</span><span>GetType</span><span>(</span><span>)</span><span> </span>==<span> </span><span>typeof</span><span>(</span><span>List</span><span>&lt;</span><span>TSource</span><span>&gt;</span><span>)</span><span>)</span><span>{</span></p><p><span>     </span><span>span</span><span> </span>=<span> </span><span>CollectionsMarshal</span><span>.</span><span>AsSpan</span><span>(</span><span>Unsafe</span><span>.</span><span>As</span><span>&lt;</span><span>List</span><span>&lt;</span><span>TSource</span><span>&gt;</span><span>&gt;</span><span>(</span><span>source</span><span>)</span><span>)</span><span>;</span></p><p><span>   </span><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>To me, this code does not look optimized.</p>
<ul>
<li><code>source.GetType()</code> is called twice!</li>
<li>Why not try to cast <code>source</code> to <code>TSource[]</code> or <code>List&lt;TSource&gt;</code> only once and then test the nullity of the obtained reference and use it?</li>
</ul>
<p>This code was written by Stephen Toub and his team, who are THE .NET performance experts. They have a deep understanding of the C# compiler and JIT compiler optimizations, so it’s clear that this approach is the optimal one. The good news is that you can reuse this code in your own performance-critical code. And there is a lesson: In today’s highly optimized .NET stack, micro-optimizations in code are not obvious at all. Therefore, the advice to avoid premature optimization has never been more relevant.</p>
<p>One final note: <code>List&lt;TSource&gt;</code> internally references an array. When the list’s capacity needs to grow or shrink, a new array is created and then referenced. The call to <code>CollectionsMarshal.AsSpan(Unsafe.As&lt;List&lt;TSource&gt;&gt;(source))</code> retrieves a <code>Span&lt;TSource&gt;</code> from this internal array. Do you see the risk? If the list’s capacity changes somehow, the array obtained through this method might become invalid.</p>
<p>Definitely, the class <code>System.Runtime.CompilerServices.Unsafe</code> is well-named.</p>
<h3><span id="TryGetSpan_Callers"></span>TryGetSpan() Callers<span></span></h3>
<p>Now, let’s examine which methods call <code>TryGetSpan()</code>. Using NDepend, we scanned the assembly located at <code>C:\Program Files\dotnet\shared\Microsoft.NETCore.App\9.0.0-rc.1.24431.7\System.Linq.dll</code>. From the <code>TryGetSpan()</code> method, <a href="https://www.ndepend.com/docs/cqlinq-features#Querying-the-Code-Architecture" target="_blank" rel="noopener">we generated a code query</a> to identify both direct and indirect callers. We then exported the 56 matched methods to the <a href="https://www.ndepend.com/docs/visual-studio-dependency-graph" target="_blank" rel="noopener">dependency graph</a>. This analysis reveals that many standard <code>Enumerable</code> methods attempt to iterate over a span when the collection is an array or a list.</p>
<p>However, since holding the internal array of a list obtained via <code>CollectionsMarshal.AsSpan()</code> is not a safe option (as mentioned earlier), certain <code>Enumerable</code> operations that defer iteration (like when using the <code>yield</code> C# keyword) cannot rely on this optimization.</p>
<p><a href="https://blog.ndepend.com/wp-content/uploads/Call-Graph-To-TryGetSpan.png"><img decoding="async" src="https://blog.ndepend.com/wp-content/uploads/Call-Graph-To-TryGetSpan.png" alt="Call Graph To TryGetSpan" width="1143" height="899" srcset="https://blog.ndepend.com/wp-content/uploads/Call-Graph-To-TryGetSpan.png 1143w, https://blog.ndepend.com/wp-content/uploads/Call-Graph-To-TryGetSpan-300x236.png 300w, https://blog.ndepend.com/wp-content/uploads/Call-Graph-To-TryGetSpan-1024x805.png 1024w, https://blog.ndepend.com/wp-content/uploads/Call-Graph-To-TryGetSpan-768x604.png 768w" sizes="(max-width: 1143px) 100vw, 1143px"/></a></p>
<h2><span id="Specialized_Iterators"></span>Specialized Iterators<span></span></h2>
<p>Now let’s run the following benchmark found into this PR: <a href="https://github.com/dotnet/runtime/pull/98969" target="_blank" rel="noopener">Consolidate LINQ’s internal IIListProvider/IPartition into base Iterator class</a></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-67124f6522f32199072912" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p></div>
				</td>
						<td><div><p><span>using </span><span>Perfolizer</span><span>.</span><span>Horology</span><span>;</span></p><p><span>using </span><span>BenchmarkDotNet</span><span>.</span><span>Configs</span><span>;</span></p><p><span>using </span><span>BenchmarkDotNet</span><span>.</span><span>Running</span><span>;</span></p><p><span>using </span><span>BenchmarkDotNet</span><span>.</span><span>Attributes</span><span>;</span></p><p><span>using </span><span>BenchmarkDotNet</span><span>.</span><span>Jobs</span><span>;</span></p><p><span>BenchmarkRunner</span><span>.</span><span>Run</span><span>&lt;</span><span>Benchmarks</span><span>&gt;</span><span>(</span><span>)</span><span>;</span></p><p><span>[</span><span>MemoryDiagnoser</span><span>]</span></p><p><span>[</span><span>HideColumns</span><span>(</span><span>&#34;StdDev&#34;</span><span>,</span><span> </span><span>&#34;Median&#34;</span><span>,</span><span> </span><span>&#34;Job&#34;</span><span>,</span><span> </span><span>&#34;RatioSD&#34;</span><span>,</span><span> </span><span>&#34;Error&#34;</span><span>,</span><span> </span><span>&#34;Gen0&#34;</span><span>,</span><span> </span><span>&#34;Alloc Ratio&#34;</span><span>)</span><span>]</span></p><p><span>[</span><span>SimpleJob</span><span>(</span><span>RuntimeMoniker</span><span>.</span><span>Net80</span><span>,</span><span> </span><span>baseline</span><span>:</span><span> </span><span>true</span><span>)</span><span>]</span></p><p><span>[</span><span>SimpleJob</span><span>(</span><span>RuntimeMoniker</span><span>.</span><span>Net90</span><span>)</span><span>]</span></p><p><span>public</span><span> </span><span>class</span><span> </span><span>Benchmarks</span><span> </span><span>{</span></p><p><span>   </span><span>private</span><span> </span><span>IEnumerable</span><span>&lt;</span><span>int</span><span>&gt;</span><span> </span><span>_arrayDistinct</span><span> </span>=<span> </span><span>Enumerable</span><span>.</span><span>Range</span><span>(</span><span>0</span><span>,</span><span> </span><span>1000</span><span>)</span><span>.</span><span>ToArray</span><span>(</span><span>)</span><span>.</span><span>Distinct</span><span>(</span><span>)</span><span>;</span></p><p><span>   </span><span>private</span><span> </span><span>IEnumerable</span><span>&lt;</span><span>int</span><span>&gt;</span><span> </span><span>_appendSelect</span><span> </span>=<span> </span><span>Enumerable</span><span>.</span><span>Range</span><span>(</span><span>0</span><span>,</span><span> </span><span>1000</span><span>)</span><span>.</span><span>ToArray</span><span>(</span><span>)</span><span>.</span><span>Append</span><span>(</span><span>42</span><span>)</span><span>.</span><span>Select</span><span>(</span><span>i</span><span> </span>=<span>&gt;</span><span> </span><span>i</span><span> </span>*<span> </span><span>2</span><span>)</span><span>;</span></p><p><span>   </span><span>private</span><span> </span><span>IEnumerable</span><span>&lt;</span><span>int</span><span>&gt;</span><span> </span><span>_rangeReverse</span><span> </span>=<span> </span><span>Enumerable</span><span>.</span><span>Range</span><span>(</span><span>0</span><span>,</span><span> </span><span>1000</span><span>)</span><span>.</span><span>Reverse</span><span>(</span><span>)</span><span>;</span></p><p><span>   </span><span>private</span><span> </span><span>IEnumerable</span><span>&lt;</span><span>int</span><span>&gt;</span><span> </span><span>_listDefaultIfEmptySelect</span><span> </span>=<span> </span><span>Enumerable</span><span>.</span><span>Range</span><span>(</span><span>0</span><span>,</span><span> </span><span>1000</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>.</span><span>DefaultIfEmpty</span><span>(</span><span>)</span><span>.</span><span>Select</span><span>(</span><span>i</span><span> </span>=<span>&gt;</span><span> </span><span>i</span><span> </span>*<span> </span><span>2</span><span>)</span><span>;</span></p><p><span>   </span><span>private</span><span> </span><span>IEnumerable</span><span>&lt;</span><span>int</span><span>&gt;</span><span> </span><span>_listSkipTake</span><span> </span>=<span> </span><span>Enumerable</span><span>.</span><span>Range</span><span>(</span><span>0</span><span>,</span><span> </span><span>1000</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>.</span><span>Skip</span><span>(</span><span>500</span><span>)</span><span>.</span><span>Take</span><span>(</span><span>100</span><span>)</span><span>;</span></p><p><span>   </span><span>private</span><span> </span><span>IEnumerable</span><span>&lt;</span><span>int</span><span>&gt;</span><span> </span><span>_rangeUnion</span><span> </span>=<span> </span><span>Enumerable</span><span>.</span><span>Range</span><span>(</span><span>0</span><span>,</span><span> </span><span>1000</span><span>)</span><span>.</span><span>Union</span><span>(</span><span>Enumerable</span><span>.</span><span>Range</span><span>(</span><span>500</span><span>,</span><span> </span><span>1000</span><span>)</span><span>)</span><span>;</span></p><p><span>   </span><span>private</span><span> </span><span>IEnumerable</span><span>&lt;</span><span>int</span><span>&gt;</span><span> </span><span>_selectWhereSelect</span><span> </span>=<span> </span><span>Enumerable</span><span>.</span><span>Range</span><span>(</span><span>0</span><span>,</span><span> </span><span>1000</span><span>)</span><span>.</span><span>Select</span><span>(</span><span>i</span><span> </span>=<span>&gt;</span><span> </span><span>i</span><span> </span>*<span> </span><span>2</span><span>)</span><span>.</span><span>Where</span><span>(</span><span>i</span><span> </span>=<span>&gt;</span><span> </span><span>i</span><span> </span><span>%</span><span> </span><span>2</span><span> </span>==<span> </span><span>0</span><span>)</span><span>.</span><span>Select</span><span>(</span><span>i</span><span> </span>=<span>&gt;</span><span> </span><span>i</span><span> </span>*<span> </span><span>2</span><span>)</span><span>;</span></p><p><span>   </span><span>[</span><span>Benchmark</span><span>]</span><span> </span><span>public</span><span> </span><span>int</span><span> </span><span>DistinctFirst</span><span>(</span><span>)</span><span> </span>=<span>&gt;</span><span> </span><span>_arrayDistinct</span><span>.</span><span>First</span><span>(</span><span>)</span><span>;</span></p><p><span>   </span><span>[</span><span>Benchmark</span><span>]</span><span> </span><span>public</span><span> </span><span>int</span><span> </span><span>AppendSelectLast</span><span>(</span><span>)</span><span> </span>=<span>&gt;</span><span> </span><span>_appendSelect</span><span>.</span><span>Last</span><span>(</span><span>)</span><span>;</span></p><p><span>   </span><span>[</span><span>Benchmark</span><span>]</span><span> </span><span>public</span><span> </span><span>int</span><span> </span><span>RangeReverseCount</span><span>(</span><span>)</span><span> </span>=<span>&gt;</span><span> </span><span>_rangeReverse</span><span>.</span><span>Count</span><span>(</span><span>)</span><span>;</span></p><p><span>   </span><span>[</span><span>Benchmark</span><span>]</span><span> </span><span>public</span><span> </span><span>int</span><span> </span><span>DefaultIfEmptySelectElementAt</span><span>(</span><span>)</span><span> </span>=<span>&gt;</span><span> </span><span>_listDefaultIfEmptySelect</span><span>.</span><span>ElementAt</span><span>(</span><span>999</span><span>)</span><span>;</span></p><p><span>   </span><span>[</span><span>Benchmark</span><span>]</span><span> </span><span>public</span><span> </span><span>int</span><span> </span><span>ListSkipTakeElementAt</span><span>(</span><span>)</span><span> </span>=<span>&gt;</span><span> </span><span>_listSkipTake</span><span>.</span><span>ElementAt</span><span>(</span><span>99</span><span>)</span><span>;</span></p><p><span>   </span><span>[</span><span>Benchmark</span><span>]</span><span> </span><span>public</span><span> </span><span>int</span><span> </span><span>RangeUnionFirst</span><span>(</span><span>)</span><span> </span>=<span>&gt;</span><span> </span><span>_rangeUnion</span><span>.</span><span>First</span><span>(</span><span>)</span><span>;</span></p><p><span>   </span><span>[</span><span>Benchmark</span><span>]</span><span> </span><span>public</span><span> </span><span>int</span><span> </span><span>SelectWhereSelectSum</span><span>(</span><span>)</span><span> </span>=<span>&gt;</span><span> </span><span>_selectWhereSelect</span><span>.</span><span>Sum</span><span>(</span><span>)</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->
<p>The performance improvements are even more remarkable! What caused this?</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-67124f6522f37358715221" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p></div>
				</td>
						<td><div><p><span>|</span><span> </span><span>Method</span><span>                        </span><span>|</span><span> </span><span>Runtime</span><span>  </span><span>|</span><span> </span><span>Mean</span><span>         </span><span>|</span><span> </span><span>Ratio</span><span> </span><span>|</span><span> </span><span>Allocated</span><span> </span><span>|</span></p><p><span>|</span>------------------------------<span> </span><span>|</span>---------<span> </span><span>|</span>-------------<span>:</span><span>|</span>------<span>:</span><span>|</span>----------<span>:</span><span>|</span></p><p><span>|</span><span> </span><span>DistinctFirst</span><span>                 </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>8.0</span><span> </span><span>|</span><span>    </span><span>65.318</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>1.00</span><span> </span><span>|</span><span>     </span><span>328</span><span> </span><span>B</span><span> </span><span>|</span></p><p><span>|</span><span> </span><span>DistinctFirst</span><span>                 </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>9.0</span><span> </span><span>|</span><span>    </span><span>11.192</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>0.17</span><span> </span><span>|</span><span>         </span>-<span> </span><span>|</span></p><p><span>|</span><span>                               </span><span>|</span><span>          </span><span>|</span><span>              </span><span>|</span><span>       </span><span>|</span><span>           </span><span>|</span></p><p><span>|</span><span> </span><span>AppendSelectLast</span><span>              </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>8.0</span><span> </span><span>|</span><span> </span><span>4</span><span>,</span><span>122.007</span><span> </span><span>ns</span><span> </span><span>|</span><span> </span><span>1.000</span><span> </span><span>|</span><span>     </span><span>144</span><span> </span><span>B</span><span> </span><span>|</span></p><p><span>|</span><span> </span><span>AppendSelectLast</span><span>              </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>9.0</span><span> </span><span>|</span><span>     </span><span>2.661</span><span> </span><span>ns</span><span> </span><span>|</span><span> </span><span>0.001</span><span> </span><span>|</span><span>         </span>-<span> </span><span>|</span></p><p><span>|</span><span>                               </span><span>|</span><span>          </span><span>|</span><span>              </span><span>|</span><span>       </span><span>|</span><span>           </span><span>|</span></p><p><span>|</span><span> </span><span>RangeReverseCount</span><span>             </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>8.0</span><span> </span><span>|</span><span>    </span><span>11.024</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>1.00</span><span> </span><span>|</span><span>         </span>-<span> </span><span>|</span></p><p><span>|</span><span> </span><span>RangeReverseCount</span><span>             </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>9.0</span><span> </span><span>|</span><span>     </span><span>6.134</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>0.56</span><span> </span><span>|</span><span>         </span>-<span> </span><span>|</span></p><p><span>|</span><span>                               </span><span>|</span><span>          </span><span>|</span><span>              </span><span>|</span><span>       </span><span>|</span><span>           </span><span>|</span></p><p><span>|</span><span> </span><span>DefaultIfEmptySelectElementAt</span><span> </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>8.0</span><span> </span><span>|</span><span> </span><span>4</span><span>,</span><span>090.818</span><span> </span><span>ns</span><span> </span><span>|</span><span> </span><span>1.000</span><span> </span><span>|</span><span>     </span><span>144</span><span> </span><span>B</span><span> </span><span>|</span></p><p><span>|</span><span> </span><span>DefaultIfEmptySelectElementAt</span><span> </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>9.0</span><span> </span><span>|</span><span>     </span><span>5.724</span><span> </span><span>ns</span><span> </span><span>|</span><span> </span><span>0.001</span><span> </span><span>|</span><span>         </span>-<span> </span><span>|</span></p><p><span>|</span><span>                               </span><span>|</span><span>          </span><span>|</span><span>              </span><span>|</span><span>       </span><span>|</span><span>           </span><span>|</span></p><p><span>|</span><span> </span><span>ListSkipTakeElementAt</span><span>         </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>8.0</span><span> </span><span>|</span><span>     </span><span>6.268</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>1.00</span><span> </span><span>|</span><span>         </span>-<span> </span><span>|</span></p><p><span>|</span><span> </span><span>ListSkipTakeElementAt</span><span>         </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>9.0</span><span> </span><span>|</span><span>     </span><span>2.916</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>0.47</span><span> </span><span>|</span><span>         </span>-<span> </span><span>|</span></p><p><span>|</span><span>                               </span><span>|</span><span>          </span><span>|</span><span>              </span><span>|</span><span>       </span><span>|</span><span>           </span><span>|</span></p><p><span>|</span><span> </span><span>RangeUnionFirst</span><span>               </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>8.0</span><span> </span><span>|</span><span>    </span><span>66.309</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>1.00</span><span> </span><span>|</span><span>     </span><span>344</span><span> </span><span>B</span><span> </span><span>|</span></p><p><span>|</span><span> </span><span>RangeUnionFirst</span><span>               </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>9.0</span><span> </span><span>|</span><span>     </span><span>6.193</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>0.09</span><span> </span><span>|</span><span>         </span>-<span> </span><span>|</span></p><p><span>|</span><span>                               </span><span>|</span><span>          </span><span>|</span><span>              </span><span>|</span><span>       </span><span>|</span><span>           </span><span>|</span></p><p><span>|</span><span> </span><span>SelectWhereSelectSum</span><span>          </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>8.0</span><span> </span><span>|</span><span> </span><span>3</span><span>,</span><span>959.622</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>1.00</span><span> </span><span>|</span><span>     </span><span>112</span><span> </span><span>B</span><span> </span><span>|</span></p><p><span>|</span><span> </span><span>SelectWhereSelectSum</span><span>          </span><span>|</span><span> </span><span>.</span><span>NET</span><span> </span><span>9.0</span><span> </span><span>|</span><span> </span><span>4</span><span>,</span><span>460.008</span><span> </span><span>ns</span><span> </span><span>|</span><span>  </span><span>1.13</span><span> </span><span>|</span><span>     </span><span>112</span><span> </span><span>B</span><span> </span><span>|</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->

<h3><span id="The_Astute"></span>The Astute<span></span></h3>
<p>In summary, the .NET performance team designed the code to recognize common LINQ call chains. When such a chain is detected, some special iterators are created to handle the workflow more efficiently. Some more optimizations can happen when the chain ends up with methods like <code>Count()</code>, <code>First()</code>, <code>Last()</code>, <code>ElementAt()</code> or <code>Sum()</code>. For instance, <code>OrderBy(criteria).First()</code> can be optimized to execute as <code>Min(criteria)</code>.</p>
<h3><span id="The_implementation_Iterator_and_its_Derived_Class"></span>The implementation: Iterator&lt;T&gt; and its Derived Class<span></span></h3>
<p>Let’s have a look at the abstract base class <a href="https://github.com/dotnet/runtime/blob/main/src/libraries/System.Linq/src/System/Linq/Iterator.SpeedOpt.cs" target="_blank" rel="noopener"><code>Iterator&lt;T&gt;</code></a> and its 40 derivatives. They are all nested in the class <code>Enumerable</code>.</p>
<p><code>Iterator&lt;T&gt;</code> is an abstract class but its methods are virtual. Hence its derivatives only override the required methods.</p>
<p><a href="https://blog.ndepend.com/wp-content/uploads/Iterators-Methods.png"><img decoding="async" src="https://blog.ndepend.com/wp-content/uploads/Iterators-Methods.png" alt="Iterators Methods" width="485" height="582" srcset="https://blog.ndepend.com/wp-content/uploads/Iterators-Methods.png 485w, https://blog.ndepend.com/wp-content/uploads/Iterators-Methods-250x300.png 250w" sizes="(max-width: 485px) 100vw, 485px"/></a></p>
<p>Here are the derivatives classes listed and exported to the graph:</p>
<p><a href="https://blog.ndepend.com/wp-content/uploads/Iterators-Derived-2.png"><img loading="lazy" decoding="async" src="https://blog.ndepend.com/wp-content/uploads/Iterators-Derived-2.png" alt="Iterators Derived" width="1486" height="894" srcset="https://blog.ndepend.com/wp-content/uploads/Iterators-Derived-2.png 1486w, https://blog.ndepend.com/wp-content/uploads/Iterators-Derived-2-300x180.png 300w, https://blog.ndepend.com/wp-content/uploads/Iterators-Derived-2-1024x616.png 1024w, https://blog.ndepend.com/wp-content/uploads/Iterators-Derived-2-768x462.png 768w" sizes="(max-width: 1486px) 100vw, 1486px"/></a></p>
<h3><span id="Case_Study_ListWhereSelectIterator"></span>Case Study: ListWhereSelectIterator&lt;TSource, TResult&gt;<span></span></h3>
<p>Let’s focus on the iterator <a href="https://github.com/dotnet/runtime/blob/main/src/libraries/System.Linq/src/System/Linq/Where.cs#L303" target="_blank" rel="noopener"><code>ListWhereSelectIterator&lt;TSource, TResult&gt;</code></a>.</p>

<!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-67124f6522f39159396614" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>public</span><span> </span><span>override </span><span>IEnumerable</span><span>&lt;</span><span>TResult</span><span>&gt;</span><span> </span><span>Select</span><span>&lt;</span><span>TResult</span><span>&gt;</span><span>(</span><span>Func</span><span>&lt;</span><span>TSource</span><span>,</span><span> </span><span>TResult</span><span>&gt;</span><span> </span><span>selector</span><span>)</span><span> </span>=<span>&gt;</span></p><p><span>    </span><span>new</span><span> </span><span>ListWhereSelectIterator</span><span>&lt;</span><span>TSource</span><span>,</span><span> </span><span>TResult</span><span>&gt;</span><span>(</span><span>_source</span><span>,</span><span> </span><span>_predicate</span><span>,</span><span> </span><span>selector</span><span>)</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p><code>ListWhereIterator&lt;TSource, TResult&gt;</code> <a href="https://github.com/dotnet/runtime/blob/main/src/libraries/System.Linq/src/System/Linq/Where.cs#L41" target="_blank" rel="noopener">is instantiated within the <code>Enumerable.Where()</code></a> method using the following code:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-67124f6522f3c242467875" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>if</span><span> </span><span>(</span><span>source </span><span>is</span><span> </span><span>List</span><span>&lt;</span><span>TSource</span><span>&gt;</span><span> </span><span>list</span><span>)</span><span>{</span></p><p><span>  </span><span>return</span><span> </span><span>new</span><span> </span><span>ListWhereIterator</span><span>&lt;</span><span>TSource</span><span>&gt;</span><span>(</span><span>list</span><span>,</span><span> </span><span>predicate</span><span>)</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>The <code>ListWhereSelectIterator&lt;TSource, TResult&gt;</code> doesn’t override methods like <code>TryGetFirst()</code> or <code>TryGetLast()</code>, so how does it improve performance? The key optimization is that it acts as a single iterator for the supercommon <code>Where(...).Select(...)</code> chain on a list, which would typically require two separate iterators. By consolidating both operations into one, it inherently improves efficiency. You can see it in <a href="https://github.com/dotnet/runtime/blob/main/src/libraries/System.Linq/src/System/Linq/Where.cs#L323" target="_blank" rel="noopener">its implementation of </a><code>MoveNext()</code> where both delegates <code>_predicate</code> and <code>_selector</code> are invoked:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-67124f6522f3d877907597" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>while</span><span> </span><span>(</span><span>_enumerator</span><span>.</span><span>MoveNext</span><span>(</span><span>)</span><span>)</span><span> </span><span>{</span></p><p><span>   </span><span>TSource </span><span>item</span><span> </span>=<span> </span><span>_enumerator</span><span>.</span><span>Current</span><span>;</span></p><p><span>   </span><span>if</span><span> </span><span>(</span><span>_predicate</span><span>(</span><span>item</span><span>)</span><span>)</span><span> </span><span>{</span></p><p><span>      </span><span>_current</span><span> </span>=<span> </span><span>_selector</span><span>(</span><span>item</span><span>)</span><span>;</span></p><p><span>      </span><span>return</span><span> </span><span>true</span><span>;</span></p><p><span>   </span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->

<h3><span id="Case_Study_IListSkipTakeIterator"></span>Case Study: IListSkipTakeIterator&lt;TSource&gt;<span></span></h3>
<p>Here is the implementation of <code>MoveNext()</code> in the <code>IListSkipTakeIterator&lt;TSource&gt;</code> class:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-67124f6522f40135409288" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>public</span><span> </span><span>override </span><span>bool</span><span> </span><span>MoveNext</span><span>(</span><span>)</span><span> </span><span>{</span></p><p><span>   </span><span>// _state - 1 represents the zero-based index into the list.</span></p><p><span>   </span><span>// Having a separate field for the index would be more readable. However, we save it</span></p><p><span>   </span><span>// into _state with a bias to minimize field size of the iterator.</span></p><p><span>   </span><span>int</span><span> </span><span>index</span><span> </span>=<span> </span><span>_state</span><span> </span>-<span> </span><span>1</span><span>;</span></p><p><span>   </span><span>if</span><span> </span><span>(</span><span>(</span><span>uint</span><span>)</span><span>index</span><span> </span><span>&lt;</span>=<span> </span><span>(</span><span>uint</span><span>)</span><span>(</span><span>_maxIndexInclusive</span><span> </span>-<span> </span><span>_minIndexInclusive</span><span>)</span><span> </span><span>&amp;&amp; index &lt; _source.Count - _minIndexInclusive) {</span></p><p><span>      _current = _source[_minIndexInclusive + index];</span></p><p><span>      </span>++<span>_state</span><span>;</span></p><p><span>      </span><span>return</span><span> </span><span>true</span><span>;</span></p><p><span>   </span><span>}</span></p><p><span>   </span><span>Dispose</span><span>(</span><span>)</span><span>;</span></p><p><span>   </span><span>return</span><span> </span><span>false</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->


<h2><span id="Conclusion"></span>Conclusion<span></span></h2>
<p>With .NET 9, LINQ becomes faster in several common scenarios. As with every new version of .NET, you simply need to migrate and recompile to take advantage of these improvements. Additionally, LINQ has been optimized in other ways: SIMD is utilized whenever possible, such as when summing a sequence of integers. Moreover, enumerating empty sequences incurs lower costs due to early detection.</p>

<p>One final note: the web is increasingly inundated with AI-generated crap content. Search engines struggles to differentiate between valuable, handcrafted content and inferior material. If you appreciate this article and others like it that are thoughtfully created, please consider sharing it.</p>


	</div><!-- .entry-content -->

	
	<!-- .entry-footer -->

</article></div>
  </body>
</html>
