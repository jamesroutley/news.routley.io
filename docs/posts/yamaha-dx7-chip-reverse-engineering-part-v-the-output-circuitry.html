<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.righto.com/2022/02/yamaha-dx7-chip-reverse-engineering.html">Original</a>
    <h1>Yamaha DX7 chip reverse-engineering, part V: the output circuitry</h1>
    
    <div id="readability-page-1" class="page"><div id="post-body-6666922922231680126" itemprop="description articleBody">


<p>The Yamaha DX7 digital synthesizer (1983) was the classic synthesizer in 1980s pop music.
It uses a technique called FM synthesis to
produce complex, harmonically-rich sounds.
In this blog post, I look inside its custom sound chip and explain how the chip&#39;s output circuitry works.
You might expect it&#39;s just a digital output fed into a digital-to-analog converter, but there&#39;s much more to it than just that.</p>
<p><a href="https://static.righto.com/images/dx7-output/die-labeled.jpg"><img alt="Die photo of the YM21280 chip with the main functional blocks labeled. Click this photo (or any other) for a larger version." height="522" src="https://static.righto.com/images/dx7-output/die-labeled-w600.jpg" title="Die photo of the YM21280 chip with the main functional blocks labeled. Click this photo (or any other) for a larger version." width="600"/></a></p><p>Die photo of the YM21280 chip with the main functional blocks labeled. Click this photo (or any other) for a larger version.</p>
<p>The composite die photo above shows the DX7&#39;s OPS sound synthesis chip under the microscope, revealing its complex silicon circuitry.
Unlike modern chips, this chip has just one layer of metal, visible as the whitish lines on top. 
Around the edges are the 64 bond wires attached to pads; these connect the silicon die to the chip&#39;s 64 pins.
The three blocks in red are the focus of this post.
The output buffers hold the 16-bit digital values for the 16 notes.
The output is controlled by a counter and PLA (Programmable Logic Array).
The synthesizer&#39;s digital-to-analog conversion uses a sample-and-hold circuit, controlled by the &#34;S/H ctrl&#34; block.</p>
<p>I&#39;ve discussed the chip&#39;s other functional blocks in earlier posts<span id="fnref:previous"><a href="#fn:previous">1</a></span>, so I&#39;ll just give a brief summary here.
Each of the 96 oscillators has a phase accumulator used to generate the frequency.
The oscillators are combined using the operator computation circuitry in the middle of the chip, under the control of the algorithm ROM.
The signal synthesis uses sine and exponential functions, implemented with lookup tables in ROMs.</p>
<p><a href="https://static.righto.com/images/dx7-output/dx7-angled.jpg"><img alt="The Yamaha DX7 synthesizer with its 61-key keyboard and digital controls. Photo by rockheim (CC BY-NC-SA 2.0)." height="268" src="https://static.righto.com/images/dx7-output/dx7-angled-w400.jpg" title="The Yamaha DX7 synthesizer with its 61-key keyboard and digital controls. Photo by rockheim (CC BY-NC-SA 2.0)." width="400"/></a></p><p>The Yamaha DX7 synthesizer with its 61-key keyboard and digital controls. Photo by <a href="https://www.flickr.com/photos/27485954@N07/4944859978">rockheim</a> (<a href="https://creativecommons.org/licenses/by-nc-sa/2.0/">CC BY-NC-SA 2.0</a>).</p>
<h2>The synthesizer&#39;s output circuitry</h2>
<p>Before I dive into the details of the chip, I&#39;ll explain the synthesizer&#39;s output circuit.
The heart of the synthesizer is the OPS (Operator S) sound chip that digitally generates the notes.
It provides digital values to the digital-to-analog converter (D/A). The resulting analog signal goes through a low-pass filter (LPF).
The volume is controlled by a foot pedal and the synthesizer&#39;s volume control.
Finally, the signal is amplified for the line and headphone outputs.</p>
<p><a href="https://static.righto.com/images/dx7-output/output-diagram.png"><img alt="Block diagram of the output circuit. Based on the DX7/9 Service Manual." height="282" src="https://static.righto.com/images/dx7-output/output-diagram-w600.png" title="Block diagram of the output circuit. Based on the DX7/9 Service Manual." width="600"/></a></p>
<p>The digital-to-analog conversion is more complex than you might expect.
The process starts with the digital-to-analog converter (DAC) chip<span id="fnref:dac"><a href="#fn:dac">2</a></span>
that takes a 12-bit digital value from the sound chip and converts it to an analog value
in the range 0 to 15 volts.<span id="fnref:centered"><a href="#fn:centered">3</a></span>
The multiplexer allows the overall synthesizer volume to be controlled by MIDI, but with just 8 levels.</p>
<p><a href="https://static.righto.com/images/dx7-output/dac-schematic.png"><img alt="Schematic of the volume control and DAC circuit. Based on the DX7 schematics." height="250" src="https://static.righto.com/images/dx7-output/dac-schematic-w600.png" title="Schematic of the volume control and DAC circuit. Based on the DX7 schematics." width="600"/></a></p><p>Schematic of the volume control and DAC circuit. Based on the DX7 <a href="https://archive.org/details/DX7SCHEMATICS/page/n2/mode/1up">schematics</a>.</p>
<p>The DAC provides 12 bits of resolution, but an additional circuit (below) provides approximately two more bits.
This scaler circuit divides the analog signal by 1, 2, 4, or 8, using a resistor network and IC switch.
The scaler is controlled by the sound chip through the scale factor signals SF0-SF3.
The scaler adds more dynamic range to the digital value; the result is similar to a floating-point value with a sign bit, 11-bit mantissa, and two-bit exponent.<span id="fnref:scaler"><a href="#fn:scaler">4</a></span></p>
<p><a href="https://static.righto.com/images/dx7-output/attenuator.png"><img alt="The scaler divides the voltage by 1, 2, 4, or 8. Based on the DX7 schematics." height="207" src="https://static.righto.com/images/dx7-output/attenuator-w250.png" title="The scaler divides the voltage by 1, 2, 4, or 8. Based on the DX7 schematics." width="250"/></a></p><p>The scaler divides the voltage by 1, 2, 4, or 8. Based on the DX7 <a href="https://archive.org/details/DX7SCHEMATICS/page/n2/mode/1up">schematics</a>.</p>
<p>Next, the signal goes to a sample-and-hold circuit that samples the analog voltage at a point in time and holds it in a capacitor,
kind of like an analog memory. An op-amp buffers the capacitor&#39;s voltage so it can be &#34;read&#34; without draining the capacitor.
There are two hold circuits, used in alternation, so the last two samples are stored and summed
to form the circuit&#39;s output.<span id="fnref:sample"><a href="#fn:sample">5</a></span>
The SH1 and SH2 control signals load the analog value into a capacitor, using IC52 as a switch.
Finally, the output from the sample-and-hold circuit is filtered,<span id="fnref:filter"><a href="#fn:filter">6</a></span> the volume is adjusted,<span id="fnref:volume"><a href="#fn:volume">7</a></span> and the signal is amplified for the output (circuitry not shown).</p>
<p><a href="https://static.righto.com/images/dx7-output/sample-hold.png"><img alt="The sample-and-hold circuit. IC52 looks complicated because it uses pairs of switches in parallel. Based on the DX7 schematics." height="273" src="https://static.righto.com/images/dx7-output/sample-hold-w500.png" title="The sample-and-hold circuit. IC52 looks complicated because it uses pairs of switches in parallel. Based on the DX7 schematics." width="500"/></a></p><p>The sample-and-hold circuit. IC52 looks complicated because it uses pairs of switches in parallel. Based on the DX7 <a href="https://archive.org/details/DX7SCHEMATICS/page/n5/mode/2up">schematics</a>.</p>
<p>To summarize, the sound chip interacts with the output circuitry in three ways.
The 12-bit digital value (DA1-DA12) is most important as it specifies the output value for each voice.
The scale factor signals (SF0-SF3) are also a key contributor to the signal.
The sound chip also provides the sample-and-hold control signals (SH1 and SH2).</p>
<h2>Time-division multiplexing</h2>
<p>The DX7 has 16 voices, so it can play 16 notes at once.
Each note is produced by an &#34;algorithm&#34; that combines 6 oscillators in a particular way, so there are 96 oscillators in total.
An oscillator can modulate the frequency of another oscillator to generate complex sounds with FM synthesis.</p>
<p>The chip performs all its processing sequentially, one oscillator at a time, rather than computing the notes in parallel.
Internally, the chip has one &#34;operator&#34; calculation circuit to combine oscillators.
As shown below, the chip starts by processing operator 6 for note 1, then operator 6 for note 2, and so forth through note 16.
Then it processes operator 5 for notes 1 through 16.
Finally it processes operator 1 for notes 1 through 16, generating the output sound values.
It takes a bit over 20 µs to compute all 16 notes in a complete processing cycle.</p>
<p><a href="https://static.righto.com/images/dx7-output/timing.jpg"><img alt="Timing diagram of sound production. This time interval corresponds to 49.096 kHz. From the DX7/9 Service Manual." height="81" src="https://static.righto.com/images/dx7-output/timing-w400.jpg" title="Timing diagram of sound production. This time interval corresponds to 49.096 kHz. From the DX7/9 Service Manual." width="400"/></a></p><p>Timing diagram of sound production. This time interval corresponds to 49.096 kHz. From the <a href="https://archive.org/details/synthmanual-yamaha-dx-7-and-dx-9-service-manual/page/n11/mode/1up">DX7/9 Service Manual</a>.</p>
<p>You might expect the chip to combine the 16 notes into a single digital output.
However, 
the sound chip outputs the 16 notes sequentially,
using a technique called time-division multiplexing.
Each time interval (~20µs) is divided into 16 intervals and one note is output from the chip per interval.
(Note that these intervals don&#39;t line up with the intervals in the diagram above.)
Thus, digital values are output at 786 kilohertz, 16 times the underlying frequency, and the DAC chip converts them to analog at this rate.</p>
<p>As an example, consider two notes that are sine waves with different frequencies.
The digital output would look like the image below.
You might think that this signal is unusable since it jumps around wildly from point to point.</p>
<p><a href="https://static.righto.com/images/dx7-output/waveform-mux.png"><img alt="Output data with two multiplexed sine waves. (Theoretical, not actual DX7 data.)" height="219" src="https://static.righto.com/images/dx7-output/waveform-mux-w500.png" title="Output data with two multiplexed sine waves. (Theoretical, not actual DX7 data.)" width="500"/></a></p><p>Output data with two multiplexed sine waves. (Theoretical, not actual DX7 data.)</p>
<p>However, applying a low-pass filter smooths out the waveform (essentially summing nearby points). 
The result is the waveform below, which shows the sum of the two sine waves.<span id="fnref:aliasing"><a href="#fn:aliasing">8</a></span>
The point is that time-division multiplexing data may look strange, but the analog circuitry&#39;s filtering creates
a &#34;normal&#34; waveform.</p>
<p><a href="https://static.righto.com/images/dx7-output/waveform-filtered.png"><img alt="Output data after filtering with a 16 kHz low-pass filter." height="243" src="https://static.righto.com/images/dx7-output/waveform-filtered-w500.png" title="Output data after filtering with a 16 kHz low-pass filter." width="500"/></a></p><p>Output data after filtering with a 16 kHz low-pass filter.</p>
<h2>Output buffer</h2>
<p>Inside the chip, the output buffer stores values for the 16 notes as they are generated, and outputs them in sequence.
Rather than RAM, the chip uses shift registers for storage.
The shift registers are arranged in a loop of 16 stages, one stage for each note.
On each clock cycle, the values in the shift register move to the next stage.
The output value is fed back into the shift register&#39;s input so the value is retained.
Alternatively, a new value can be stored in the shift register.
Shift registers provided an efficient way to store data, but they cannot be accessed arbitrarily;
instead, data must be processed as it becomes available.</p>
<p>The schematic below shows how one stage of the shift register is implemented.
The chip uses a two-phase clock.
In the first phase, clock ϕ1 goes high, turning on the first transistor.
The input signal goes through the inverter, through the transistor, and the voltage is stored in the capacitor (kind of like DRAM).
In the second phase, clock ϕ2 goes high, turning on the second transistor.
The value stored in the capacitor goes through the second inverter, through the second transistor, and to the output, where it enters the next shift register stage.</p>
<p><a href="https://static.righto.com/images/dx7-output/shift-register-schematic.jpg"><img alt="Schematic of one stage of the shift register." height="131" src="https://static.righto.com/images/dx7-output/shift-register-schematic-w500.jpg" title="Schematic of one stage of the shift register." width="500"/></a></p><p>Schematic of one stage of the shift register.</p>
<p>The die photo below shows the output buffer, with the 16 shift-register loops arranged in columns.
These hold the 16-bit sound values (four scale factor bits and 16 data bits.)
Each shift register is 16 stages long to hold the 16 notes.
In the next sections, I&#39;ll discuss the bit shifters, the logic, and the output latches.</p>
<p><a href="https://static.righto.com/images/dx7-output/buffer.jpg"><img alt="Closeup of the die, showing the output buffer circuitry." height="410" src="https://static.righto.com/images/dx7-output/buffer-w600.jpg" title="Closeup of the die, showing the output buffer circuitry." width="600"/></a></p><p>Closeup of the die, showing the output buffer circuitry.</p>
<h2>The scale factor: pseudo floating point</h2>
<p>The DX7 uses a 12-bit digital-to-analog converter chip, but the scaling circuit (discussed earlier) will scale the voltage by 1, 2, 4, or 8, which adds more resolution.
This isn&#39;t quite equivalent to 14-bit resolution; it&#39;s more like a floating-point number with a sign, 11-bit mantissa, and 2-bit exponent.
This provides more resolution for low signals and reduces signal noise.</p>
<p>Inside the chip, scaling is implemented with a shifter that shifts the data bits by 0 to 3 bit positions.
(This is unrelated to the shift registers that hold data.)
The shifter (below) is implemented as eleven chevron-shaped logic gates; each gate selects one of four potential bits for each mantissa position.</p>
<p><a href="https://static.righto.com/images/dx7-output/shifter.jpg"><img alt="A data sample is shifted 0 to 4 bits by this shifter circuit." height="93" src="https://static.righto.com/images/dx7-output/shifter-w600.jpg" title="A data sample is shifted 0 to 4 bits by this shifter circuit." width="600"/></a></p><p>A data sample is shifted 0 to 4 bits by this shifter circuit.</p>
<p>The operator circuitry generates data as 15 bits (2&#39;s complement, so one of the bits provides the sign).
The output from the chip is 12 bits, so three bits must be discarded. 
Normally these are the low-order bits, but by using the shifter, high-order zero bits can be discarded instead, and the external scaler counteracts this.
The result is more bits of precision in the output.</p>
<p>The shifter is controlled by the logic circuitry to the left of the buffer, which controls the amount of shift based on the
number of leading zeros. (For a negative number, leading 1&#39;s.)
With 5 leading zeros, the number is shifted left by 3 positions.
With 4 leading zeros, the number is shifted by 2 positions.
With 3 leading zeros, the number is shifted by 1 position.
With 2 or fewer leading zeros, the number is unshifted.</p>
<p>Note that the circuit leaves two leading zeros when it shifts, so it&#39;s &#34;wasting&#34; two potential bits of precision.
I assume this is because the scaler won&#39;t be perfectly linear (due to the resistor imperfections<span id="fnref:tolerance"><a href="#fn:tolerance">9</a></span>), so you want to avoid switching
scale levels for large signals (which don&#39;t really need the extra bits).<span id="fnref:timing"><a href="#fn:timing">10</a></span></p>
<h2>The output latches</h2>
<p>As mentioned earlier, the 16 notes are output individually, spaced across the interval.
This timing doesn&#39;t line up with the timing of the output buffer, which shifts to a new note every clock cycle.
To fix the timing, two 16-bit latches sit between the output buffer and the output pins.
While one latch outputs the current note, the other latch grabs the next note as it is shifted out of the shift register.
At the appropriate time, the latches swap roles; the second latch outputs the note while the first latch waits for the next note.</p>
<p>The timing for the latches is fairly tricky to make sure the note data is loaded into the right latch at the right time.
These latches are controlled by the chip&#39;s master counter, which is the subject of the next section.</p>
<p>To summarize, the sound chip runs at 4.7 MHz. Data values are produced at this rate (but intermittently) and stored
into the output buffer. The output latches provide data values to the DAC chip at 786 kHz for an overall audio rate of 49096 kHz.</p>
<h2>Keeping track of 96 clock cycles: the chip&#39;s counter and timing PLA</h2>
<p>One complete cycle of the sound chip takes 96 clock cycles: processing all 16 notes through the 6 operators that form an algorithm.
Because data can only be accessed when it exits a shift register, everything must be timed so the right data is available at the right time.
A critical part of the chip is the counter that keeps track of the current note number and operator number to keep everything
synchronized.</p>
<p>On the right of the die photo below is the counter, consisting of seven toggle flip flops: four to count the note number (0-15) and three to count the algorithm number (0-5).
On the left is the PLA that defines what happens for particular time slices.
(A Programmable Logic Array (PLA) is similar to a ROM, but implements arbitrary logic.)
The PLA has 39 columns, each one implementing an AND gate triggered by a particular counter output, corresponding to a particular operator and note.
Below the PLA is some logic; mostly buffers with a few gates. </p>
<p><a href="https://static.righto.com/images/dx7-output/counter.jpg"><img alt="The chip&#39;s main counter, along with the control PLA." height="458" src="https://static.righto.com/images/dx7-output/counter-w500.jpg" title="The chip&#39;s main counter, along with the control PLA." width="500"/></a></p><p>The chip&#39;s main counter, along with the control PLA.</p>
<p>Of the PLA&#39;s 39 columns,
the 32 columns on the left control the data output latches,<span id="fnref:outputs"><a href="#fn:outputs">11</a></span>
two columns control loading data values into the output buffer,
one generates the chip&#39;s sync output signal,
three reset the operator count,
and the last increments the operator count.<span id="fnref:pla"><a href="#fn:pla">12</a></span></p>
<h2>Sample-and-hold</h2>
<p>The chip outputs two signals to control the sample-and-hold circuitry, SH1 and SH2. These signals are activated in alternation
to take an analog sample of each digital output.</p>
<p><a href="https://static.righto.com/images/dx7-output/missing-pins.jpg"><img alt="The sound chip on the DX7 schematic has three missing pins, indicated in red." height="455" src="https://static.righto.com/images/dx7-output/missing-pins-w200.jpg" title="The sound chip on the DX7 schematic has three missing pins, indicated in red." width="200"/></a></p><p>The sound chip on the DX7 schematic has three missing pins, indicated in red.</p>
<p>The sound chip has three unused pins next to the SH1 and SH2 pins; the DX7 schematic doesn&#39;t show pins 6-8. I traced the chip&#39;s internal circuitry and found that these pins, in conjunction with the sample-and-hold pins,
count out the 16 samples.
It appears that the chip is designed to sample-and-hold all 16 notes individually, so the synthesizer could have had separate outputs for all 16 notes.<span id="fnref:verify"><a href="#fn:verify">13</a></span></p>
<p>Moreover, the chip has data buffers to hold separate algorithm algorithms for the 16 notes. This would let the chip drive 16 independent voices, each with a separate algorithm.
My conclusion is that the sound chip supports much more flexibility than is used in the DX7 synthesizer.</p>
<h2>Conclusion</h2>
<p>The DX7 generates sounds digitally and then converts the digital values to the analog output.
This process turns out to be more complicated than one would expect, with circuitry inside the chip interacting with synthesizer circuitry to scale and adjust
the signal.
My hope is that my analysis of this process will help DX7 emulators to achieve more accuracy.
Looking at the chip&#39;s internal circuitry reveals the floating-point format of the output data as well as the function of
the three unused pins.
<!--
The main contribution of this blog post is to explain the floating-point data output format from the chip.
I've also uncovered an explanation for the chip's three unused pins.
--></p>
<p>I plan to continue investigating the DX7&#39;s circuitry,
so follow me on Twitter <a href="https://twitter.com/kenshirriff">@kenshirriff</a> for updates. I also have an <a href="https://www.righto.com/feeds/posts/default">RSS feed</a>.
Thanks to Jacques Mattheij and Anthony Richardson for providing the chip and discussion.<span id="fnref:refs"><a href="#fn:refs">14</a></span></p>
<h2>Notes and references</h2>


</div></div>
  </body>
</html>
