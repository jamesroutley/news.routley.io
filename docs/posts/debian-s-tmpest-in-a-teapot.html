<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/SubscriberLink/975565/bcce68a68d82d63a/">Original</a>
    <h1>Debian&#39;s /tmpest in a teapot</h1>
    
    <div id="readability-page-1" class="page"><div>
<!-- $Id: slink-trial,v 1.1 2005-11-04 21:27:01 corbet Exp $ -->
<center>
<table>
<tbody><tr><td>
<h3>Welcome to LWN.net</h3>
<p>
The following subscription-only content has been made available to you 
by an LWN subscriber.  Thousands of subscribers depend on LWN for the 
best news from the Linux and free software communities.  If you enjoy this 
article, please consider accepting the trial offer on the right.  Thank you
for visiting LWN.net!
</p></td><td>
<div>
<h3>Free trial subscription</h3>
           <p>
           Try LWN for free for 1 month: no payment
           or credit card required.  <a href="https://lwn.net/Promo/slink-trial2-3/claim">Activate
           your trial subscription now</a> and see why thousands of
           readers subscribe to LWN.net.
           
</p></div>
</td>
</tr>

</tbody></table>
</center>
<div><p>
           By <b>Joe Brockmeier</b></p></div>
<p>Debian had a major <a href="https://lwn.net/Articles/499410/">discussion</a>
about mounting <tt>/tmp</tt> as a RAM-based tmpfs in 2012 but inertia
won out in the end. Debian systems have continued to
store temporary files on disk by default. Until now. A mere 
12 years later, the project will be switching to a RAM-based <tt>/tmp</tt> in the Debian
13 (&#34;Trixie&#34;) release. Additionally, starting with Trixie, the
default will be to periodically clean up temporary files automatically in
<tt><nobr>/tmp</nobr></tt> and <tt><nobr>/var/tmp</nobr></tt>. Naturally, it involved a lengthy discussion first.</p>

<h4>Join the party</h4>

<p>By now, using tmpfs for the <tt>/tmp</tt>
directory is a road well-traveled. Many Linux distributions have already switched to mounting
<tt>/tmp</tt> as a tmpfs. Arch Linux, Fedora, openSUSE
Tumbleweed, and many others have all made the switch. Red Hat Enterprise Linux (RHEL) and its
clones, as well as SUSE Linux Enterprise Server (SLES) and openSUSE Leap, still default to <tt>/tmp</tt> on
disk. Ubuntu, following Debian, also continues to have a disk-based
<tt>/tmp</tt> rather than using tmpfs.</p>

<p>The knobs to control how <tt>/tmp</tt> is mounted, and the handling
of temporary files, <a href="https://systemd.io/TEMPORARY_DIRECTORIES/">are part of
systemd</a>. (On systems where systemd is used, of course.) The
upstream defaults for systemd are to mount <tt>/tmp</tt> as a tmpfs
and delete files that have not been read or changed after ten days in
<tt>/tmp</tt> and 30 days for those stored in <tt>/var/tmp</tt>.
Debian Developer and systemd contributor Luca Boccassi recently
decided it was time to revisit the topic of <tt>/tmp</tt> as a tmpfs,
and start deleting temporary files in <tt>/tmp</tt> and
<tt>/var/tmp</tt>.</p>

<p>On May 6 Boccassi
<a href="https://lwn.net/ml/debian-devel/ebee234c6f72eb7dfe55809821c038491bfea542.camel@debian.org/">resurrected</a> a discussion from Debian&#39;s bug
tracker that started in 2020 and that had trailed off in July 2022 without resolution. The bug
was submitted by Eric Desrochers, who <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=966621#5">complained</a> that
Debian&#39;s systemd implementation did not clean <tt>/var/tmp</tt> by
default. Michael Biebl <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=966621#10">wrote</a>
that this was a deliberate choice to match Debian&#39;s pre-systemd
behavior. After a long period of inactivity, Biebl <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=966621#35">suggested</a>
in October 2021 (and <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=966621#40">again</a> in July 2022) that Desrochers raise the topic on the Debian devel
mailing list. That never happened.</p>

<p>In reviving the topic, Boccassi declared that it was time to bring Debian&#39;s defaults in
line with upstream and other Linux distributions by making
<tt>/tmp</tt> a tmpfs, and cleaning up <tt>/tmp</tt> and <tt>/var/tmp</tt> on a
timer. He planned to apply those changes in the next systemd upload to
Debian unstable within a week, with instructions in the <tt>NEWS</tt> file on
how to override the changes for any users who wanted to keep the
current behavior. That, in turn, sparked quite a discussion.</p>

<h4>The case for and against</h4>

<p>Biebl <a href="https://lwn.net/ml/debian-devel/abb5af73-7b68-4880-b0fc-622112bf4403@debian.org/">worried</a>
about the effect of cleaning up temporary files by default. Currently,
he said, Debian only cleans <tt>/tmp</tt> on boot (which is
unnecessary if <tt>/tmp</tt> is a RAM-based tmpfs) and to never clean
up files in <tt>/var/tmp</tt>. Boccassi <a href="https://lwn.net/ml/debian-devel/CAMw=ZnQuCfngAWSrZrJCXxru61EVtfsOMjw-5fFHrPQ11U4L9Q@mail.gmail.com/">answered</a>:
&#34;<q>Defaults are defaults, they are trivially and fully overridable
where needed if needed.</q>&#34; Biebl <a href="https://lwn.net/ml/debian-devel/4b514ecf-d6b1-4208-9be3-ffa3f988da32@debian.org/">replied</a>
that there is value in aligning defaults across Linux distributions,
but argued that Debian has &#34;<q>a larger scope</q>&#34; than a desktop
distribution like Fedora. He suggested that it was necessary to &#34;<q>gather feedback from all affected parties 
to make an informed decision</q>&#34;. Boccassi <a href="https://lwn.net/ml/debian-devel/CAMw=ZnRzXjern5wD60Gb+uUmxyTk_duK8jGNND16EA3xpDPVNw@mail.gmail.com/">responded</a>
that it was impossible to have defaults that would make everyone
happy, and he was not looking for hypothetical arguments or
philosophical discussions, he wanted facts: &#34;<q>what would
break where, and how to fix it?</q>&#34;</p>

<p>Sam Hartman <a href="https://lwn.net/ml/debian-devel/tsla5l1d1kh.fsf@suchdamage.org/">noted</a>
that <tt>ssh-agent</tt> created its socket under <tt>/tmp</tt>, but it would be
better if it respected the <tt>$XDG_RUNTIME_DIR</tt> setting and
created its socket under <tt>/run/user</tt>. Boccassi
<a href="https://lwn.net/ml/debian-devel/CAMw=ZnQ9TedkhqkAv-+SYV9+_rRwnxc8H7y=mUS1DgY2oV7wkw@mail.gmail.com/">agreed</a>
and said that he had <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1070725">filed a bug</a> for <tt>ssh-agent</tt>. Richard Lewis
<a href="https://lwn.net/ml/debian-devel/86seyuk41q.fsf@simplex.rtf.org.uk/">pointed
out</a> that tmux stores its sockets in <tt>/tmp/tmux-$UID</tt>, and
deleting those files might mean users could not reattach to a tmux
session that had been idle a long time. Boccassi <a href="https://lwn.net/ml/debian-devel/CAMw=ZnSYrqwd5s6u1fhT1dx+W2E1Ti3Y84eWAKs9iKZN_O5=OA@mail.gmail.com/">suggested</a>
that using <a href="https://manpages.debian.org/testing/manpages-dev/flock.2.en.html"><tt>flock()</tt></a>
would be the right solution to stop the deletion, and <a href="https://lwn.net/ml/debian-devel/CAMw=ZnRT3OeZwZ6M=X_fLdWo5Saf6Xgn04UnS_9yywCbfjhGfg@mail.gmail.com/">said</a>
he had <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1070724">filed a bug</a> on that as well.</p>

<p>Lewis <a href="https://lwn.net/ml/debian-devel/86ikzpjq8k.fsf@simplex.rtf.org.uk/">questioned</a>
whether files downloaded with <tt>apt source</tt> might be
considered &#34;old&#34; when they were extracted under <tt>/tmp</tt> and
immediately flagged to be deleted. Russ Allbery <a href="https://lwn.net/ml/debian-devel/87cypxfgi9.fsf@hope.eyrie.org/">said</a>
that <tt>systemd-tmpfiles</tt> would respect the access timestamp (atime)
and changed timestamp (ctime), not just the modified timestamp
(mtime), &#34;<q>so I think this would only be a problem on file systems that didn&#39;t support
those attributes</q>&#34;. Allbery said he believed tmpfs supports all three.</p>

<p>Some users store information in <tt>/var/tmp</tt> for long-running
jobs, because they want it preserved without being backed up, <a href="https://lwn.net/ml/debian-devel/CANa01B+C2Z6o=QEv33Ovd8pDM4+MqmCZ2L4T2g4nNY4Gj13-dg@mail.gmail.com/">said</a>
Barak A. Pearlmutter. Boccassi <a href="https://lwn.net/ml/debian-devel/CAMw=ZnT_bYrBRm7j3iU5sN=dtzvHcf0vaRH=Xxc7xEVjQ=txWA@mail.gmail.com/">dismissed</a>
that, saying that those users &#34;<q>assuming they actually exist</q>&#34;,
can customize the system defaults according to their needs.</p>

<p>Those users do exist, <a href="https://lwn.net/ml/debian-devel/D14DPA7WSVOK.2LV6HCA1DS4F5@debian.org/">wrote</a>
Jonathan Dowland, &#34;<q>[I&#39;ve] been one of them, I&#39;ve worked with many of
them, it&#39;s an incredibly common pattern in academic
computing</q>&#34;. Making a change to how these files are handled,
&#34;<q>should be a very carefully explored decision</q>&#34;. He also
asked for arguments in favor of the change, and to hold off the change
to allow the discussion to continue.</p>

<p>Hartman <a href="https://lwn.net/ml/debian-devel/tsla5l11xl6.fsf@suchdamage.org/">wished</a>
that it was possible to specify that directories under
<tt>/var/tmp</tt> should be deleted entirely or left alone. Boccassi
said that was a reasonable enhancement request, and that it had
already been <a href="https://lwn.net/ml/debian-devel/CAMw=ZnRbG9EJgu1VDYCwxDYAtmwDj+UrxgxiXkxWgyqOY8UZtw@mail.gmail.com/">filed
upstream</a> for systemd.</p>

<p>Allbery eventually <a href="https://lwn.net/ml/debian-devel/87h6f9hev0.fsf@hope.eyrie.org/">admitted
surprise</a> at the number of people who reported using
<tt>/var/tmp</tt> &#34;<q>for things that are clearly not temporary
files in the traditional UNIX sense</q>&#34;. Periodically deleting files
in <tt>/var/tmp</tt>, he said, has been common UNIX practice for at
least 30 years:</p>

<blockquote>
Whatever we do with /var/tmp retention, I beg people to stop using
/var/tmp for data you&#39;re keeping for longer than a few days and care about
losing.  That&#39;s not what it&#39;s for, and you *will* be bitten by this
someday, somewhere, because even with existing Debian configuration many
people run tmpreaper or similar programs.  If you are running a
long-running task that produces data that you care about, make a directory
for it to use, whether in your home directory, /opt, /srv, whatever.
</blockquote>

<p>Hakan Bayındır <a href="https://lwn.net/ml/debian-devel/812a6293-c157-484e-9fc0-002692ad733a@bayindir.org/">said</a>
that he did not use <tt>/var/tmp</tt>, but applications that
other people use do. He cited a high-end scientific application that was
not under his or other users&#39; control. Allbery argued that this
was &#34;<q>not a good design decision</q>&#34; but conceded that may not be
helpful if a user or admin does not have control over the
application&#39;s design. However, he said, it was &#34;<q>playing with fire</q>&#34;
to use <tt>/var/tmp</tt> that way &#34;<q>and it&#39;s
going to result in someone getting their data deleted at some point,
regardless of what Debian does</q>&#34;.</p>

<p>Lewis <a href="https://lwn.net/ml/debian-devel/86h6f9jop1.fsf@simplex.rtf.org.uk/">said</a>
he still did not understand the rationale for the change. Was there,
he asked, &#34;<q>perhaps something more compelling than &#39;other
distributions and upstream already do this&#39;?</q>&#34; That sounded like
the original rationale, <a href="https://lwn.net/ml/debian-devel/878r0lffbs.fsf@hope.eyrie.org/">Allbery
said</a>, but he added that moving <tt>/tmp</tt> to tmpfs should make
applications run faster, and reaping files under <tt>/var/tmp</tt>
could help to avoid filling up a partition. Allowing the partition to
fill up, he noted, could
cause bounced mail, unstable services, and other problems. It may not
be a problem for desktop systems, which tend to have enough disk space
not to be affected, but for virtual machines that have <tt>/var/tmp</tt>
contained within a small root partition, it is still a concern.</p>

<h4>Rolling out changes</h4>

<p>In the end, none of the arguments for maintaining Debian&#39;s status
quo managed to persuade Boccassi to stay his hand. On May 28, Boccassi <a href="https://lwn.net/ml/debian-devel/CAMw=ZnTPEbA7uZ4Cg2sx7PBZS2_Z_8-ZD7UDqoVWq6UasAcUxA@mail.gmail.com/">announced</a>
the changes that he had made and uploaded to unstable. As expected, <tt>/tmp</tt> will become a
tmpfs by default, for both new and existing installations. New
installs will use the systemd default behavior. The
<tt>openssh</tt> and <tt>tmux</tt> packages, he said, had been fixed
to provide exceptions to retain their temporary files. A description has been added
to the Debian installer to inform users that <tt>/tmp</tt> is a tmpfs
by default, and the changes have been noted in the <tt>NEWS</tt>
file. He also offered
to review and merge any changes to the Debian installer that would let
users customize those options during installation.
Users who want <tt>/tmp</tt> to remain on disk can override the
upstream default with <tt>systemctl mask tmp.mount</tt>. To
stop periodic cleanups of <tt>/tmp</tt> and <tt>/var/tmp</tt> users
can run <tt>touch /etc/tmpfiles.d/tmp.conf</tt>.</p>

<p>None of the changes, it should be noted, will affect Debian
versions prior to Trixie. Users of Debian stable and oldstable will
only encounter these changes on upgrade.</p>

<p>As noted, many distributions have already made these changes
without catastrophe. Debian, and its users, should be able to adapt to
the new defaults or override them if they are unsuitable for the
workloads to be run. At worst, it promises to be a temporary
inconvenience.</p></div></div>
  </body>
</html>
