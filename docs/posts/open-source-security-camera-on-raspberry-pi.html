<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/TzuHuanTai/RaspberryPi_WebRTC">Original</a>
    <h1>Open Source security camera on Raspberry Pi</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto"><a href="https://opensource.org/licenses/Apache-2.0" rel="nofollow"><img src="https://camo.githubusercontent.com/5ce2e21e84680df1ab24807babebc3417d27d66e0826a350eb04ab57f4c8f3e5/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4c6963656e73652d4170616368655f322e302d626c75652e737667" alt="License" data-canonical-src="https://img.shields.io/badge/License-Apache_2.0-blue.svg"/></a></p>
<p dir="auto">
    <a target="_blank" rel="noopener noreferrer" href="https://github.com/TzuHuanTai/RaspberryPi_WebRTC/blob/main/doc/pi_4b_latency_demo.gif"><img src="https://github.com/TzuHuanTai/RaspberryPi_WebRTC/raw/main/doc/pi_4b_latency_demo.gif" alt="Pi 4b latency demo" data-animated-image=""/></a>
</p>
<p dir="auto">Turn your Raspberry Pi into a low-latency home security camera using the v4l2 DMA hardware encoder and WebRTC. [<a href="https://www.youtube.com/watch?v=JZ5bcSAsXog" rel="nofollow">demo video</a>]</p>
<ul dir="auto">
<li>
<p dir="auto">It&#39;s designed as a pure P2P-based camera that allows video playback and download without needing a media server.</p>
</li>
<li>
<p dir="auto">Support <a href="http://doc/pi_4b_users_demo" rel="nofollow">multiple users</a> to watch the live stream simultaneously.</p>
</li>
<li>
<p dir="auto">Raspberry Pi 5 or other SBCs do not support v4l2 hardware encoding, please run this project in software encoding mode.</p>
</li>
</ul>

<ul dir="auto">
<li>Download the latest binary file from <a href="https://github.com/TzuHuanTai/RaspberryPi_WebRTC/releases">Releases</a>.</li>
<li>Install the <a href="https://github.com/TzuHuanTai/Pi-Camera">Pi Camera</a> app and follow the instructions.</li>
</ul>

<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/732f12de436ff19c33c655c48653e49c09c2b6529f943ada36acc3ed8bce44a5/68747470733a2f2f6173736574732e72617370626572727970692e636f6d2f7374617469632f35313033356563346332663866363330623364323663333265393063393366312f32623864372f7a65726f322d6865726f2e77656270"><img src="https://camo.githubusercontent.com/732f12de436ff19c33c655c48653e49c09c2b6529f943ada36acc3ed8bce44a5/68747470733a2f2f6173736574732e72617370626572727970692e636f6d2f7374617469632f35313033356563346332663866363330623364323663333265393063393366312f32623864372f7a65726f322d6865726f2e77656270" height="96" data-canonical-src="https://assets.raspberrypi.com/static/51035ec4c2f8f630b3d26c32e90c93f1/2b8d7/zero2-hero.webp"/></a></p>
<ul dir="auto">
<li>Raspberry Pi (<a href="https://www.raspberrypi.com/products/raspberry-pi-zero-2-w/" rel="nofollow">Zero 2W</a> or better).</li>
<li>CSI Camera Module.</li>
<li>At least 4GB micro sd card.</li>
<li>A USB disk and a Micro-USB Male to USB-A Female adaptor.</li>
</ul>

<ol dir="auto">
<li>
<p dir="auto">Use the <a href="https://www.raspberrypi.com/software/" rel="nofollow">Raspberry Pi Imager</a> to write the Lite OS (Bookworm 64-bit) to the micro SD card.</p>
</li>
<li>
<p dir="auto">Install essential libs</p>
<div dir="auto" data-snippet-clipboard-copy-content="sudo apt install libmosquitto1 pulseaudio libavformat59 libswscale6"><pre>sudo apt install libmosquitto1 pulseaudio libavformat59 libswscale6</pre></div>
</li>
<li>
<p dir="auto">Enable Raspberry Pi Hardware by adding below in <code>/boot/firmware/config.txt</code></p>
<div data-snippet-clipboard-copy-content="camera_auto_detect=0
start_x=1
gpu_mem=16"><pre lang="text"><code>camera_auto_detect=0
start_x=1
gpu_mem=16
</code></pre></div>
<p dir="auto">Set <code>camera_auto_detect=0</code> in order to read camera by v4l2.</p>
</li>
<li>
<p dir="auto">Mount USB disk <a href="https://wiki.gentoo.org/wiki/AutoFS" rel="nofollow">[ref]</a></p>
<ul dir="auto">
<li>Skip this step if you don&#39;t want to record videos. Don&#39;t set the <code>record_path</code> flag while running.</li>
<li>When the disk drive is detected, it will automatically mount to <code>/mnt/ext_disk</code>.</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="sudo apt-get install autofs
echo &#39;/- /etc/auto.usb --timeout=5&#39; | sudo tee -a /etc/auto.master &gt; /dev/null
echo &#39;/mnt/ext_disk -fstype=auto,nofail,nodev,nosuid,noatime,umask=000 :/dev/sda1&#39; | sudo tee -a /etc/auto.usb &gt; /dev/null
sudo systemctl restart autofs"><pre>sudo apt-get install autofs
<span>echo</span> <span><span>&#39;</span>/- /etc/auto.usb --timeout=5<span>&#39;</span></span> <span>|</span> sudo tee -a /etc/auto.master <span>&gt;</span> /dev/null
<span>echo</span> <span><span>&#39;</span>/mnt/ext_disk -fstype=auto,nofail,nodev,nosuid,noatime,umask=000 :/dev/sda1<span>&#39;</span></span> <span>|</span> sudo tee -a /etc/auto.usb <span>&gt;</span> /dev/null
sudo systemctl restart autofs</pre></div>
</li>
</ol>

<p dir="auto">MQTT is currently the only signaling mechanism used, so ensure that your MQTT server is ready before starting the application. If the application is only intended for use within a local area network (LAN), the MQTT server (such as <a href="https://github.com/eclipse/mosquitto">Mosquitto</a>) can be installed on the same Pi. However, if remote access is required, it is recommended to use a cloud-based MQTT server. Free plans include, but are not limited to, <a href="https://www.hivemq.com" rel="nofollow">HiveMQ</a> and <a href="https://www.emqx.com/en" rel="nofollow">EXMQ</a>. Because If you choose to self-host and need to access the signaling server remotely via mobile data, you may need to set up DDNS and port forwarding if your ISP provides a dynamic IP.</p>

<ul dir="auto">
<li>
<p dir="auto">Running the binary file <code>pi_webrtc</code> with the <code>-h</code> flag will display all available options.</p>
</li>
<li>
<p dir="auto">To start the application, use your settings and apply them to the following example command below. The SDP/ICE data will be transferred under the MQTT topic specified by your <code>uid</code> setting.</p>
<div dir="auto" data-snippet-clipboard-copy-content="# run the PulseAudio service if it is not started.
pulseaudio --start

# run main program with your settings
/path/to/pi_webrtc --device=/dev/video0 --fps=30 --width=1280 --height=960 --v4l2_format=h264 --hw_accel --mqtt_host=example.s1.eu.hivemq.cloud --mqtt_port=8883 --mqtt_username=hakunamatata --mqtt_password=Wonderful --uid=home-pi-zero2w --record_path=/mnt/ext_disk/video/"><pre><span><span>#</span> run the PulseAudio service if it is not started.</span>
pulseaudio --start

<span><span>#</span> run main program with your settings</span>
/path/to/pi_webrtc --device=/dev/video0 --fps=30 --width=1280 --height=960 --v4l2_format=h264 --hw_accel --mqtt_host=example.s1.eu.hivemq.cloud --mqtt_port=8883 --mqtt_username=hakunamatata --mqtt_password=Wonderful --uid=home-pi-zero2w --record_path=/mnt/ext_disk/video/</pre></div>
<p dir="auto"><strong>Hint 1:</strong> Since the Pi 5 does not support hardware encoding, please remove the <code>--hw_accel</code> flag and set <code>--v4l2_format</code> to <code>mjpeg</code>. Video encoding will be handled by <a href="https://github.com/cisco/openh264">OpenH264</a>.</p>
<p dir="auto"><strong>Hint 2:</strong> I noticed that when I set <code>1920x1080</code>, the hardware decoder firmware changes it to <code>1920x1088</code>, but the isp/encoder does not adjust in the 6.6.31 kernel. This leads to memory being out of range. However, if I set <code>1920x1088</code>, all works fine.</p>
</li>
</ul>

<div dir="auto"><h4 tabindex="-1" dir="auto">1. Run <code>pulseaudio</code> as system-wide daemon <a href="https://www.freedesktop.org/wiki/Software/PulseAudio/Documentation/User/SystemWide/" rel="nofollow">[ref]</a>:</h4><a id="user-content-1-run-pulseaudio-as-system-wide-daemon-ref" aria-label="Permalink: 1. Run pulseaudio as system-wide daemon [ref]:" href="#1-run-pulseaudio-as-system-wide-daemon-ref"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>create a file <code>/etc/systemd/system/pulseaudio.service</code>
<div dir="auto" data-snippet-clipboard-copy-content="[Unit]
Description= Pulseaudio Daemon
After=rtkit-daemon.service systemd-udevd.service dbus.service

[Service]
Type=simple
ExecStart=/usr/bin/pulseaudio --system --disallow-exit --disallow-module-loading
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target"><pre><span>[Unit]</span>
<span>Description</span>= Pulseaudio Daemon
<span>After</span>=rtkit-daemon.service systemd-udevd.service dbus.service

<span>[Service]</span>
<span>Type</span>=simple
<span>ExecStart</span>=/usr/bin/pulseaudio --system --disallow-exit --disallow-module-loading
<span>Restart</span>=always
<span>RestartSec</span>=10

<span>[Install]</span>
<span>WantedBy</span>=multi-user.target</pre></div>
</li>
<li>Run the cmd to add a <code>autospawn = no</code> in the client conf
<div dir="auto" data-snippet-clipboard-copy-content="echo &#39;autospawn = no&#39; | sudo tee -a /etc/pulse/client.conf &gt; /dev/null"><pre><span>echo</span> <span><span>&#39;</span>autospawn = no<span>&#39;</span></span> <span>|</span> sudo tee -a /etc/pulse/client.conf <span>&gt;</span> /dev/null</pre></div>
</li>
<li>Add root to pulse group
<div dir="auto" data-snippet-clipboard-copy-content="sudo adduser root pulse-access"><pre>sudo adduser root pulse-access</pre></div>
</li>
<li>Enable and Start the Service
<div dir="auto" data-snippet-clipboard-copy-content="sudo systemctl daemon-reload
sudo systemctl enable pulseaudio.service
sudo systemctl start pulseaudio.service"><pre>sudo systemctl daemon-reload
sudo systemctl <span>enable</span> pulseaudio.service
sudo systemctl start pulseaudio.service</pre></div>
</li>
</ul>
<div dir="auto"><h4 tabindex="-1" dir="auto">2. In order to run <code>pi_webrtc</code> and ensure it starts automatically on reboot:</h4><a id="user-content-2-in-order-to-run-pi_webrtc-and-ensure-it-starts-automatically-on-reboot" aria-label="Permalink: 2. In order to run pi_webrtc and ensure it starts automatically on reboot:" href="#2-in-order-to-run-pi_webrtc-and-ensure-it-starts-automatically-on-reboot"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>Create a service file <code>/etc/systemd/system/pi-webrtc.service</code> with the following content:
<div dir="auto" data-snippet-clipboard-copy-content="[Unit]
Description= The p2p camera via webrtc.
After=systemd-networkd.service

[Service]
Type=simple
WorkingDirectory=/path/to
ExecStart=/path/to/pi_webrtc --device=/dev/video0 --fps=30 --width=1280 --height=960 --v4l2_format=h264 --hw_accel --mqtt_host=example.s1.eu.hivemq.cloud --mqtt_port=8883 --mqtt_username=hakunamatata --mqtt_password=wonderful --record_path=/mnt/ext_disk/video/
Restart=always
RestartSec=10
  
[Install]
WantedBy=multi-user.target"><pre><span>[Unit]</span>
<span>Description</span>= The p2p camera via webrtc.
<span>After</span>=systemd-networkd.service

<span>[Service]</span>
<span>Type</span>=simple
<span>WorkingDirectory</span>=/path/to
<span>ExecStart</span>=/path/to/pi_webrtc --<span>device</span>=/dev/video0 --<span>fps</span>=30 --<span>width</span>=1280 --<span>height</span>=960 --<span>v4l2_format</span>=h264 --hw_accel --<span>mqtt_host</span>=example.s1.eu.hivemq.cloud --<span>mqtt_port</span>=8883 --<span>mqtt_username</span>=hakunamatata --<span>mqtt_password</span>=wonderful --<span>record_path</span>=/mnt/ext_disk/video/
<span>Restart</span>=always
<span>RestartSec</span>=10
  
<span>[Install]</span>
<span>WantedBy</span>=multi-user.target</pre></div>
</li>
<li>Enable and Start the Service
<div dir="auto" data-snippet-clipboard-copy-content="sudo systemctl daemon-reload
sudo systemctl enable pi-webrtc.service
sudo systemctl start pi-webrtc.service"><pre>sudo systemctl daemon-reload
sudo systemctl <span>enable</span> pi-webrtc.service
sudo systemctl start pi-webrtc.service</pre></div>
</li>
</ul>

<p dir="auto">To enable two-way communication, a microphone and speaker need to be added to the Pi.</p>

<p dir="auto">Please see this <a href="https://learn.adafruit.com/adafruit-i2s-mems-microphone-breakout/raspberry-pi-wiring-test" rel="nofollow">link</a> for instructions on wiring and testing your Pi.</p>

<p dir="auto">You can use the <a href="https://learn.adafruit.com/adafruit-max98357-i2s-class-d-mono-amp/raspberry-pi-wiring" rel="nofollow">link</a> for instructions on setting up a speaker on your Pi.</p>

<p dir="auto">This project is licensed under the Apache License, Version 2.0. See the <a href="https://github.com/TzuHuanTai/RaspberryPi_WebRTC/blob/main/LICENSE">LICENSE</a> file for details.</p>
<div data-snippet-clipboard-copy-content="Copyright 2022 Tzu Huan Tai (Author)

Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License."><pre><code>Copyright 2022 Tzu Huan Tai (Author)

Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
</code></pre></div>
</article></div></div>
  </body>
</html>
