<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lemire.me/blog/2024/01/21/c23-a-slightly-better-c/">Original</a>
    <h1>C23: A Slightly Better C</h1>
    
    <div id="readability-page-1" class="page"><article id="post-21097">

<div>
<p>One of the established and most popular programming languages is the C programming language. It is relatively easy to learn, and highly practical.</p>
<p>Maybe surprisingly, the C programming language keeps evolving, slowly and carefully. If you have GCC 23 or LLVM (Clang) 16, you already have a compiler with some of the features from the latest standard (C23).</p>
<pre><span>// Only include stdio.h if it exists</span>
<span>#</span><span>if</span><span> __has_include </span><span>(</span><span>&lt;</span><span>stdio</span><span>.</span><span>h</span><span>&gt;</span><span>)</span>
<span>  #</span><span>include </span><span>&lt;</span><span>stdio.h</span><span>&gt;</span>
<span>#</span><span>endif</span>
<span>
#</span><span>include </span><span>&lt;</span><span>stdlib.h</span><span>&gt;</span>
<span>
[</span><span>[</span>deprecated<span>]</span><span>]</span>
<span>void</span> f<span>(</span><span>)</span> <span>{</span><span>}</span>
<span>
[</span><span>[</span>nodiscard<span>]</span><span>]</span>
<span>int</span> g<span>(</span><span>int</span> x<span>)</span> <span>{</span>
<span>  return</span> x <span>+</span> <span>1</span><span>;</span>
<span>}
</span>
int main() <span>{</span>
  f<span>(</span><span>)</span><span>;</span> <span>// compile-time warning: &#39;f&#39; is deprecated</span>
  g<span>(</span><span>1</span><span>)</span><span>;</span> <span>// compile-time warning</span>
  auto x <span>=</span> <span>0</span><span>b</span><span>1111</span><span>;</span>
  typeof<span>(</span>x<span>)</span> y <span>=</span> <span>1</span><span>&#39;000&#39;</span><span>000</span><span>;</span> <span>// type of y is the same as x</span>
  printf<span>(</span><span>&#34;%d</span><span>\n</span><span>&#34;</span><span>,</span> x<span>)</span><span>;</span> <span>// prints 15</span>
  printf<span>(</span><span>&#34;%d</span><span>\n</span><span>&#34;</span><span>,</span> y<span>)</span><span>;</span> <span>// prints 1000000</span>
  constexpr <span>int</span> N <span>=</span> <span>10</span><span>;</span>
<span>  // compile-time asserts using static_assert</span>
  static_assert <span>(</span>N <span>=</span><span>=</span> <span>10</span><span>,</span> <span>&#34;N must be 10&#34;</span><span>)</span><span>;</span>
  bool a<span>[</span>N<span>]</span><span>;</span> <span>// array of N booleans</span>
<span>  for</span> <span>(</span><span>int</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> N<span>;</span> <span>+</span><span>+</span>i<span>)</span> <span>{</span>
    a<span>[</span>i<span>]</span> <span>=</span> <span>true</span><span>;</span>
<span>  }</span>
  printf<span>(</span><span>&#34;%d</span><span>\n</span><span>&#34;</span><span>,</span> a<span>[</span><span>0</span><span>]</span><span>)</span><span>;</span> <span>// prints 1</span>
<span>}</span>

</pre>
<ol>
<li>The first part of the code contains some preprocessor directives, which are instructions for the compiler to process the source code before compiling it. The <tt>#if</tt> directive checks a condition at compile time and includes the following code only if the condition is true. The <tt>__has_include</tt> macro is a feature of C++17 adopted by C23 that checks if a header file exists and can be included. In this instance, it is not useful because we know that <tt>stdio.h</tt> is present, but in other instances, this can prove useful to determine what headers are available.</li>
<li>The next part of the code defines two functions with attributes, which are annotations that provide additional information to the compiler about the behavior or usage of a function, variable, type, etc.
<ul>
<li>The [[deprecated]] attribute is a feature of C++14 adopted by C23 that marks a function as obsolete and discourages its use. The compiler will issue a warning if the function is called or referenced.</li>
<li>The [[nodiscard]] attribute is a feature of C++17 adopted by C23 that indicates that the return value of a function should not be ignored or discarded. The compiler will issue a warning if the function is called from a discarded-value expression.</li>
</ul>
<p>In this case, the function f is deprecated and does nothing, while the function g returns the input value plus one and should not be ignored. The first two lines of the main function call the functions f and g and trigger the warnings.</p></li>
<li>The third line of the main function declares a variable x with the auto keyword, which is a feature of C++11 that lets the compiler deduce the type of the variable from its initializer. In this case, the initializer is a binary literal, which is a feature of C++14 and adopted by C23 that allows writing integer constants in binary notation using the prefix 0b. The value of x is 0b1111, which is equivalent to 15 in decimal.</li>
<li>The fourth line declares another variable y with the typeof operator that returns the type of an expression. In this case, the expression is x, so the type of y is the same as the type of x. The initializer of y is a digit separator, which is a feature of C++14 adopted by C23 that allows inserting single quotes between digits in numeric literals to improve readability. The value of y is 1’000’000, which is equivalent to 1000000 in decimal.</li>
<li>The seventh line declares a constant variable N with the constexpr keyword, which is a feature of C++11 adopted by C23 that indicates that the value of the variable can be evaluated at compile time. The value of N is 10. Previously, one would often use a macro to define a compile-time constant (e.g., <tt>#define N 10</tt>).</li>
<li>The eighth line uses the static_assert keyword, which is a feature of C++11 adopted by C23 that performs a compile-time assertion check. The keyword takes a boolean expression and an optional string message as arguments. If the expression is false, the compiler will emit an error and stop the compilation, displaying the message. If the expression is true, the compiler will do nothing. In this case, the expression is N == 10, which is true, so the compilation continues.</li>
<li>The ninth line declares an array of N booleans named a. An array is a collection of elements of the same type that are stored in contiguous memory locations. The size of the array must be a constant expression, which is why N is declared with constexpr. We also use the keywords true and false which become standard in C23.</li>
</ol>
<p>There are many more features in C23, but it will take some time for compilers and system librairies to catch up.</p>
<p>My thoughts so far:</p>
<ul>
<li>The introduction of consexpr in C will probably help reduce the dependency on macros, which is a good idea generally. Macros work well in C, but when a bug is introduced, it can be difficult get meaningful error messages. It does not happen too often, but in large code bases, it can be a problem.</li>
<li>I personally rarely use auto and typeof in other languages, so I don’t expect to use them very much in C. In some specific cases, it can greatly simply one’s code, however. It is likely going to help reduce the reliance on macros.</li>
<li>The idea behind static_assert is great. You run a check that has no impact on the performance of the software, and may even help it. It is cheap and it can catch nasty bugs. It is not new to C, but adopting the C++ syntax is a good idea.</li>
<li>The <tt>__has_include</tt> feature can simplify supporting diverse compilers. It is good idea.</li>
</ul>
</div>
<div>

<p><img alt="" src="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=112&amp;d=mm&amp;r=g 2x" height="56" width="56" decoding="async"/> </p>

</div>

</article></div>
  </body>
</html>
