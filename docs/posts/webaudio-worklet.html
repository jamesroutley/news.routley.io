<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://glitch.at.goth.cafe/webaudio-worklet/">Original</a>
    <h1>WebAudio Worklet</h1>
    
    <div id="readability-page-1" class="page"><div><p>This was going to be part of a longer blog thats coming soon, but I decided to write a separate blog for this topic since it is important and I plan to use it in other projects in the future. If you are reading from a future blog, hello from the past!</p><h2 id="summary">Summary</h2><p>While the WebAudio API provides a variety of built-in nodes for common audio tasks (like gain control, filtering, and panning), there are cases where developers might need custom audio processing that isn’t covered by the built-in nodes.</p><p><code>AudioWorkletNode</code> is a part of the WebAudio API that is designed to facilitate custom audio processing in web applications. It bridges the main thread (where your usual JavaScript code runs) with the audio processing thread (where the actual sound manipulation happens).</p><p>The system consists of two main parts:</p><ul><li>The <code>AudioWorkletNode</code> which resides on the main JavaScript thread.</li><li>The <code>AudioWorkletProcessor</code> which runs on the audio processing thread.</li></ul><p>The <code>AudioWorkletNode</code> and its associated <code>AudioWorkletProcessor</code> can communicate with each other. This allows parameters to be passed from the main thread to the audio processing thread and for any kind of custom messaging to be sent between them. It can also use a port type system like with WebWorkers.</p><p>The <code>AudioWorkletNode</code> is perfect for developing custom audio effects, synthesizers, audio visualizers, and more. Anytime you need to step outside the bounds of the standard WebAudio nodes, <code>AudioWorkletNode</code> gives you a good place to do so with optimal performance.</p><h2 id="examples">Examples</h2><h3 id="custom-audioworkletprocessor-example">Custom AudioWorkletProcessor Example</h3><p>You can customize audio processing by extending the <code>AudioWorkletProcessor</code> class. To effectively communicate with this processor, you’d typically use an <code>AudioWorkletNode</code> on the main thread. Below is a simplified example of how to implement this, with documentation in line.</p><h4 id="defining-the-audioworkletprocessor">Defining the AudioWorkletProcessor:</h4><div><pre tabindex="0"><code data-lang="javascript"><span><span><span>// my-processor.js
</span></span></span><span><span><span></span><span>class</span> <span>MyProcessor</span> <span>extends</span> <span>AudioWorkletProcessor</span> {
</span></span><span><span>  <span>static</span> <span>get</span> <span>parameterDescriptors</span>() {
</span></span><span><span>    <span>return</span> [
</span></span><span><span>      {
</span></span><span><span>        <span>name</span><span>:</span> <span>&#39;param1&#39;</span>,
</span></span><span><span>        <span>defaultValue</span><span>:</span> <span>0.5</span>, 
</span></span><span><span>        <span>minValue</span><span>:</span> <span>0</span>,
</span></span><span><span>        <span>maxValue</span><span>:</span> <span>1</span>
</span></span><span><span>      },
</span></span><span><span>      {
</span></span><span><span>        <span>name</span><span>:</span> <span>&#39;param2&#39;</span>,
</span></span><span><span>        <span>defaultValue</span><span>:</span> <span>1000</span>,
</span></span><span><span>        <span>minValue</span><span>:</span> <span>20</span>,
</span></span><span><span>        <span>maxValue</span><span>:</span> <span>20000</span>
</span></span><span><span>      },
</span></span><span><span>      {
</span></span><span><span>        <span>name</span><span>:</span> <span>&#39;param3&#39;</span>,
</span></span><span><span>        <span>defaultValue</span><span>:</span> <span>true</span>, 
</span></span><span><span>        <span>minValue</span><span>:</span> <span>0</span>,
</span></span><span><span>        <span>maxValue</span><span>:</span> <span>1</span>
</span></span><span><span>      }
</span></span><span><span>    ];
</span></span><span><span>  }
</span></span><span><span>
</span></span><span><span>  <span>process</span>(<span>inputs</span>, <span>outputs</span>, <span>parameters</span>) {
</span></span><span><span>
</span></span><span><span>    <span>// Accessing the current value of params
</span></span></span><span><span><span></span>    <span>const</span> <span>param1Value</span> <span>=</span> <span>parameters</span>.<span>param1</span>[<span>0</span>]; 
</span></span><span><span>    <span>const</span> <span>param2Value</span> <span>=</span> <span>parameters</span>.<span>param2</span>[<span>0</span>];
</span></span><span><span>    <span>const</span> <span>param3Value</span> <span>=</span> <span>parameters</span>.<span>param3</span>[<span>0</span>]; 
</span></span><span><span>
</span></span><span><span>    <span>// For the sake of this demonstration, we won&#39;t apply these parameters to the example
</span></span></span><span><span><span></span>
</span></span><span><span>    <span>// No-Op: Just pass the input directly to the output
</span></span></span><span><span><span></span>    <span>for</span> (<span>let</span> <span>channel</span> <span>=</span> <span>0</span>; <span>channel</span> <span>&lt;</span> <span>inputs</span>[<span>0</span>].<span>length</span>; <span>++</span><span>channel</span>) {
</span></span><span><span>      <span>// The inputs and outputs are arrays of multi-channel audio. For instance:
</span></span></span><span><span><span></span>      <span>// inputs[0] accesses the first input (a stereo input would have 2 channels: left and right).
</span></span></span><span><span><span></span>      <span>// inputs[0][0] accesses the first channel (left) of the first input.
</span></span></span><span><span><span></span>      <span>// inputs[0][0][i] accesses the ith sample of the first channel of the first input.
</span></span></span><span><span><span></span>      <span>outputs</span>[<span>0</span>][<span>channel</span>].<span>set</span>(<span>inputs</span>[<span>0</span>][<span>channel</span>]);
</span></span><span><span>    }
</span></span><span><span>    
</span></span><span><span>    <span>return</span> <span>true</span>;
</span></span><span><span>  }
</span></span><span><span>}
</span></span><span><span>
</span></span><span><span><span>registerProcessor</span>(<span>&#39;my-processor&#39;</span>, <span>MyProcessor</span>);
</span></span></code></pre></div><h4 id="loading-and-using-the-audioworkletprocessor">Loading and Using the AudioWorkletProcessor:</h4><div><pre tabindex="0"><code data-lang="javascript"><span><span><span>// On the main thread:
</span></span></span><span><span><span></span><span>const</span> <span>audioContext</span> <span>=</span> <span>new</span> <span>AudioContext</span>();
</span></span><span><span><span>await</span> <span>audioContext</span>.<span>audioWorklet</span>.<span>addModule</span>(<span>&#39;path/to/my-processor.js&#39;</span>);
</span></span><span><span>
</span></span><span><span><span>const</span> <span>myNode</span> <span>=</span> <span>new</span> <span>AudioWorkletNode</span>(<span>audioContext</span>, <span>&#39;my-processor&#39;</span>);
</span></span><span><span>
</span></span><span><span><span>// Set parameter values
</span></span></span><span><span><span></span><span>myNode</span>.<span>parameters</span>.<span>get</span>(<span>&#39;param1&#39;</span>).<span>setValueAtTime</span>(<span>0.75</span>, <span>audioContext</span>.<span>currentTime</span>); <span>// Set param to 0.75 immediately
</span></span></span><span><span><span></span><span>myNode</span>.<span>parameters</span>.<span>get</span>(<span>&#39;param2&#39;</span>).<span>setValueAtTime</span>(<span>440</span>, <span>audioContext</span>.<span>currentTime</span>);   
</span></span><span><span><span>myNode</span>.<span>parameters</span>.<span>get</span>(<span>&#39;param3&#39;</span>).<span>setValueAtTime</span>(<span>0</span>, <span>audioContext</span>.<span>currentTime</span> <span>+</span> <span>2</span>); <span>// set param after 2 seconds
</span></span></span></code></pre></div><p>In the above code, there are also examples of custom parameters you’ve defined for your processor. The parameter passing system provides a mechanism to send data from the main thread to the audio processing thread. The <code>setValueAtTime</code> function allows for precise scheduling of parameter changes, you can also schedule parameter changes in the future and they will be applied at the appropriate time! I have not tried to schedule parameter changes in the past, I’m guessing that is cursed in some way ⛧.</p><h3 id="chaining-audioworkletprocessors">Chaining AudioWorkletProcessors:</h3><p>You can also chain <code>AudioWorkletProcessors</code>! When chaining <code>AudioWorkletProcessors</code>, the output of one processor becomes the input to the next in the chain. Think of this like a conveyor belt in a factory: a product (or in this case, audio data) moves from one station to the next, getting modified at each step along the way.</p><p>Here’s an illustrative example in code.</p><h4 id="example-processors">Example processors</h4><div><pre tabindex="0"><code data-lang="javascript"><span><span><span>// step1-processor.js
</span></span></span><span><span><span></span><span>class</span> <span>Step1Processor</span> <span>extends</span> <span>AudioWorkletProcessor</span> {
</span></span><span><span>  <span>process</span>(<span>inputs</span>, <span>outputs</span>) {
</span></span><span><span>    <span>const</span> <span>input</span> <span>=</span> <span>inputs</span>[<span>0</span>];
</span></span><span><span>    <span>const</span> <span>output</span> <span>=</span> <span>outputs</span>[<span>0</span>];
</span></span><span><span>    <span>for</span> (<span>let</span> <span>channel</span> <span>=</span> <span>0</span>; <span>channel</span> <span>&lt;</span> <span>input</span>.<span>length</span>; <span>++</span><span>channel</span>) {
</span></span><span><span>      <span>for</span> (<span>let</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>input</span>[<span>channel</span>].<span>length</span>; <span>++</span><span>i</span>) {
</span></span><span><span>        <span>// Double the amplitude in Step 1
</span></span></span><span><span><span></span>        <span>output</span>[<span>channel</span>][<span>i</span>] <span>=</span> <span>input</span>[<span>channel</span>][<span>i</span>] <span>*</span> <span>2</span>;
</span></span><span><span>      }
</span></span><span><span>    }
</span></span><span><span>    <span>return</span> <span>true</span>;
</span></span><span><span>  }
</span></span><span><span>}
</span></span><span><span><span>registerProcessor</span>(<span>&#39;step1-processor&#39;</span>, <span>Step1Processor</span>);
</span></span><span><span>
</span></span><span><span><span>// step2-processor.js
</span></span></span><span><span><span></span><span>class</span> <span>Step2Processor</span> <span>extends</span> <span>AudioWorkletProcessor</span> {
</span></span><span><span>  <span>process</span>(<span>inputs</span>, <span>outputs</span>) {
</span></span><span><span>    <span>const</span> <span>input</span> <span>=</span> <span>inputs</span>[<span>0</span>];
</span></span><span><span>    <span>const</span> <span>output</span> <span>=</span> <span>outputs</span>[<span>0</span>];
</span></span><span><span>    <span>for</span> (<span>let</span> <span>channel</span> <span>=</span> <span>0</span>; <span>channel</span> <span>&lt;</span> <span>input</span>.<span>length</span>; <span>++</span><span>channel</span>) {
</span></span><span><span>      <span>for</span> (<span>let</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>input</span>[<span>channel</span>].<span>length</span>; <span>++</span><span>i</span>) {
</span></span><span><span>        <span>// Invert the phase in Step 2
</span></span></span><span><span><span></span>        <span>output</span>[<span>channel</span>][<span>i</span>] <span>=</span> <span>-</span><span>input</span>[<span>channel</span>][<span>i</span>];
</span></span><span><span>      }
</span></span><span><span>    }
</span></span><span><span>    <span>return</span> <span>true</span>;
</span></span><span><span>  }
</span></span><span><span>}
</span></span><span><span><span>registerProcessor</span>(<span>&#39;step2-processor&#39;</span>, <span>Step2Processor</span>);
</span></span><span><span>
</span></span><span><span><span>// step3-processor.js
</span></span></span><span><span><span></span><span>class</span> <span>Step3Processor</span> <span>extends</span> <span>AudioWorkletProcessor</span> {
</span></span><span><span>  <span>process</span>(<span>inputs</span>, <span>outputs</span>) {
</span></span><span><span>    <span>const</span> <span>input</span> <span>=</span> <span>inputs</span>[<span>0</span>];
</span></span><span><span>    <span>const</span> <span>output</span> <span>=</span> <span>outputs</span>[<span>0</span>];
</span></span><span><span>    <span>for</span> (<span>let</span> <span>channel</span> <span>=</span> <span>0</span>; <span>channel</span> <span>&lt;</span> <span>input</span>.<span>length</span>; <span>++</span><span>channel</span>) {
</span></span><span><span>      <span>for</span> (<span>let</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>input</span>[<span>channel</span>].<span>length</span>; <span>++</span><span>i</span>) {
</span></span><span><span>        <span>// Simply pass the audio data in Step 3
</span></span></span><span><span><span></span>        <span>output</span>[<span>channel</span>][<span>i</span>] <span>=</span> <span>input</span>[<span>channel</span>][<span>i</span>];
</span></span><span><span>      }
</span></span><span><span>    }
</span></span><span><span>    <span>return</span> <span>true</span>;
</span></span><span><span>  }
</span></span><span><span>}
</span></span><span><span><span>registerProcessor</span>(<span>&#39;step3-processor&#39;</span>, <span>Step3Processor</span>);
</span></span></code></pre></div><h4 id="example-chaining-code-in-main-thread">Example chaining code in main thread</h4><div><pre tabindex="0"><code data-lang="javascript"><span><span><span>async</span> <span>function</span> <span>setupAudio</span>() {
</span></span><span><span>  <span>const</span> <span>audioContext</span> <span>=</span> <span>new</span> <span>AudioContext</span>();
</span></span><span><span>
</span></span><span><span>  <span>// Load the processors
</span></span></span><span><span><span></span>  <span>await</span> <span>audioContext</span>.<span>audioWorklet</span>.<span>addModule</span>(<span>&#39;path/to/step1-processor.js&#39;</span>);
</span></span><span><span>  <span>await</span> <span>audioContext</span>.<span>audioWorklet</span>.<span>addModule</span>(<span>&#39;path/to/step2-processor.js&#39;</span>);
</span></span><span><span>  <span>await</span> <span>audioContext</span>.<span>audioWorklet</span>.<span>addModule</span>(<span>&#39;path/to/step3-processor.js&#39;</span>);
</span></span><span><span>
</span></span><span><span>  <span>// Create the nodes
</span></span></span><span><span><span></span>  <span>const</span> <span>step1Node</span> <span>=</span> <span>new</span> <span>AudioWorkletNode</span>(<span>audioContext</span>, <span>&#39;step1-processor&#39;</span>);
</span></span><span><span>  <span>const</span> <span>step2Node</span> <span>=</span> <span>new</span> <span>AudioWorkletNode</span>(<span>audioContext</span>, <span>&#39;step2-processor&#39;</span>);
</span></span><span><span>  <span>const</span> <span>step3Node</span> <span>=</span> <span>new</span> <span>AudioWorkletNode</span>(<span>audioContext</span>, <span>&#39;step3-processor&#39;</span>);
</span></span><span><span>
</span></span><span><span>  <span>// Chain the nodes: Source -&gt; Step 1 -&gt; Step 2 -&gt; Step 3 -&gt; Destination
</span></span></span><span><span><span></span>  <span>const</span> <span>source</span> <span>=</span> <span>audioContext</span>.<span>createBufferSource</span>();
</span></span><span><span>  <span>source</span>.<span>connect</span>(<span>step1Node</span>)
</span></span><span><span>        .<span>connect</span>(<span>step2Node</span>)
</span></span><span><span>        .<span>connect</span>(<span>step3Node</span>)
</span></span><span><span>        .<span>connect</span>(<span>audioContext</span>.<span>destination</span>);
</span></span><span><span>
</span></span><span><span>  <span>source</span>.<span>start</span>();
</span></span><span><span>}
</span></span><span><span><span>setupAudio</span>();
</span></span></code></pre></div><h3 id="sending-data-from-audioworkletprocessor-to-main-thread-example">Sending Data From AudioWorkletProcessor To Main Thread Example</h3><p>Sending data between an AudioWorkletProcessor (which runs on the audio rendering thread) and the main thread is achieved using the <code>MessagePort</code> interface.</p><div><pre tabindex="0"><code data-lang="javascript"><span><span><span>class</span> <span>MyProcessor</span> <span>extends</span> <span>AudioWorkletProcessor</span> {
</span></span><span><span>
</span></span><span><span>  <span>sendToMainThread</span>(<span>data</span>) {
</span></span><span><span>    <span>this</span>.<span>port</span>.<span>postMessage</span>(<span>data</span>);
</span></span><span><span>  }
</span></span><span><span>  
</span></span><span><span>  <span>process</span>(<span>inputs</span>, <span>outputs</span>, <span>parameters</span>) {
</span></span><span><span>    <span>// Example: Sending data to main thread
</span></span></span><span><span><span></span>    <span>this</span>.<span>sendToMainThread</span>({ <span>message</span><span>:</span> <span>&#34;Hello from processor!&#34;</span> });
</span></span><span><span>    
</span></span><span><span>    <span>return</span> <span>true</span>;
</span></span><span><span>  }
</span></span><span><span>}
</span></span><span><span>
</span></span><span><span><span>registerProcessor</span>(<span>&#39;my-processor&#39;</span>, <span>MyProcessor</span>);
</span></span></code></pre></div><p>On the main thread, after you create an instance of the <code>AudioWorkletNode`` that corresponds to the </code>AudioWorkletProcessor``, you can set up an event listener to receive messages from the processor:</p><div><pre tabindex="0"><code data-lang="javascript"><span><span><span>// On the main thread:
</span></span></span><span><span><span></span><span>const</span> <span>audioContext</span> <span>=</span> <span>new</span> <span>AudioContext</span>();
</span></span><span><span><span>await</span> <span>audioContext</span>.<span>audioWorklet</span>.<span>addModule</span>(<span>&#39;path/to/my-processor.js&#39;</span>);
</span></span><span><span>
</span></span><span><span><span>const</span> <span>myNode</span> <span>=</span> <span>new</span> <span>AudioWorkletNode</span>(<span>audioContext</span>, <span>&#39;my-processor&#39;</span>);
</span></span><span><span>
</span></span><span><span><span>// Set up an event listener to receive messages from the processor
</span></span></span><span><span><span></span><span>myNode</span>.<span>port</span>.<span>onmessage</span> <span>=</span> (<span>event</span>) =&gt; {
</span></span><span><span>  <span>console</span>.<span>log</span>(<span>&#34;Received from processor:&#34;</span>, <span>event</span>.<span>data</span>);
</span></span><span><span>};
</span></span></code></pre></div><p>⚠️ Performance Warning ⚠️ Be cautious about sending messages from the process method, especially if they’re sent frequently! It’s usually best to send messages from the process method in response to specific conditions or events rather than on a regular, ongoing basis.</p><h2 id="final-thoughts">Final Thoughts</h2><p>And thats it, hopefully this helps you get started with <code>AudioWorkletNode</code> and <code>AudioWorkletProcessor</code> if you find this blog without context!. I’ll be referencing back to this blog in future blogs where I use <code>AudioWorkletNode</code> and <code>AudioWorkletProcessor</code> in my projects!</p><p>&lt;3</p></div></div>
  </body>
</html>
