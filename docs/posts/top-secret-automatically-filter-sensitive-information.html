<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://thoughtbot.com/blog/top-secret">Original</a>
    <h1>Top Secret: Automatically filter sensitive information</h1>
    
    <div id="readability-page-1" class="page"><div>
      <p>We’ve written about how to <a href="https://thoughtbot.com/blog/parameter-filtering#filter-sensitive-information-from-external-network-requests">prevent logging sensitive information when making
network requests</a>, but that approach only works if you’re dealing with
parameters.</p>

<p>What happens when you’re dealing with free text? Filtering the entire string may
not be an option if an external API needs to process the value. Think chatbots or LLMs.</p>

<p>You could use a regex to filter sensitive information (such as credit card
numbers or emails), but that won’t capture everything, since not all sensitive
information can be captured with a regex.</p>

<p>Fortunately, <a href="https://en.wikipedia.org/wiki/Named-entity_recognition">named-entity recognition</a> (NER) can be used to identify and
classify real-world objects, such as a person, or location. Tools like <a href="https://github.com/ankane/mitie-ruby">MITIE
Ruby</a> make interfacing with NER models trivial.</p>

<p>By using a combination of regex patterns and NER entities, <a href="https://github.com/thoughtbot/top_secret">Top Secret</a>
effectively filters sensitive information from free text—here are some
real-world examples.</p>

<p>If you want to see <a href="https://github.com/thoughtbot/top_secret">Top Secret</a> in action, you might enjoy this <a href="https://www.youtube.com/live/m2UIpTaIZ8o?si=EzEkWHlNQJORVgSG&amp;t=120">live
stream</a>. Otherwise, see the examples below.</p>
<h2 id="working-with-llms">
  <a href="#working-with-llms">
    Working with LLMs
  </a>
</h2>

<p>It’s not uncommon to send user data to chatbots. Since the data might be
free-form, we should be diligent about filtering it using the approach mentioned
above.</p>

<p>However, it’s likely we’ll want to “restore” the filtered values when returning
a response from the chatbot. <a href="https://github.com/thoughtbot/top_secret">Top Secret</a> returns a <a href="https://github.com/thoughtbot/top_secret?tab=readme-ov-file#usage">mapping</a> that would
allow for this.</p>

<p>You’d likely want to provide <a href="https://platform.openai.com/docs/guides/text#message-roles-and-instruction-following">instructions</a> in the request.</p>
<div><pre><code><span>instructions</span> <span>=</span> <span>&lt;&lt;~</span><span>TEXT</span><span>
  I&#39;m going to send filtered information to you in the form of free text.
  If you need to refer to the filtered information in a response, just reference it by the filter.
</span><span>TEXT</span>
</code></pre></div>
<p>The exchange might look something like this.</p>

<ol>
<li><p>Caller sends filtered text</p>
<div><pre><code><span>result</span> <span>=</span> <span>TopSecret</span><span>::</span><span>Text</span><span>.</span><span>filter</span><span>(</span><span>&#34;Ralph lives in Boston.&#34;</span><span>)</span>

<span># Send this to the API</span>
<span>result</span><span>.</span><span>output</span> <span># =&gt; [PERSON_1] lives in [LOCATION_1].</span>

<span># Save the mapping to &#34;restore&#34; response</span>
<span>mapping</span> <span>=</span> <span>result</span><span>.</span><span>mapping</span> <span># =&gt; { PERSON_1: &#34;Ralph&#34;, LOCATION_1: &#34;Boston&#34; }</span>
</code></pre></div></li>
<li><p>API responds with filter</p>
<div><pre><code>&#34;Hi [PERSON_1]! How is the weather in [LOCATION_1] today?&#34;
</code></pre></div></li>
<li><p>Caller can “restore” from the mapping</p>
<div><pre><code><span>response</span> <span>=</span> <span>&#34;Hi [PERSON_1]! How is the weather in [LOCATION_1] today?&#34;</span>

<span># Restore the response from the mapping</span>
<span>result</span> <span>=</span> <span>TopSecret</span><span>::</span><span>FilteredText</span><span>.</span><span>restore</span><span>(</span><span>response</span><span>,</span> <span>mapping: </span><span>mapping</span><span>)</span>

<span>result</span><span>.</span><span>output</span>
<span># =&gt; Hi Ralph! How is the weather in Boston today?</span>
</code></pre></div></li>
</ol>
<h3 id="filtering-conversation-history">
  <a href="#filtering-conversation-history">
    Filtering conversation history
  </a>
</h3>

<p>When working with <a href="https://platform.openai.com/docs/guides/conversation-state">conversation state</a> you should filter <strong>every</strong> message
before including it in the request. This ensures no sensitive data slips through
from previous messages. Here’s what that might look like.</p>
<div><pre><code><span>require</span> <span>&#34;openai&#34;</span>
<span>require</span> <span>&#34;top_secret&#34;</span>

<span>openai</span> <span>=</span> <span>OpenAI</span><span>::</span><span>Client</span><span>.</span><span>new</span><span>(</span>
  <span>api_key: </span><span>Rails</span><span>.</span><span>application</span><span>.</span><span>credentials</span><span>.</span><span>openai</span><span>.</span><span>api_key!</span>
<span>)</span>

<span>original_messages</span> <span>=</span> <span>[</span>
  <span>&#34;Ralph lives in Boston.&#34;</span><span>,</span>
  <span>&#34;You can reach them at ralph@thoughtbot.com or 877-976-2687&#34;</span>
<span>]</span>

<span># Filter all messages</span>
<span>result</span> <span>=</span> <span>TopSecret</span><span>::</span><span>Text</span><span>.</span><span>filter_all</span><span>(</span><span>original_messages</span><span>)</span>
<span>filtered_messages</span> <span>=</span> <span>result</span><span>.</span><span>items</span><span>.</span><span>map</span><span>(</span><span>&amp;</span><span>:output</span><span>)</span>

<span>user_messages</span> <span>=</span> <span>filtered_messages</span><span>.</span><span>map</span> <span>{</span> <span>{</span><span>role: </span><span>&#34;user&#34;</span><span>,</span> <span>content: </span><span>it</span><span>}</span> <span>}</span>

<span># Instruct LLM how to handle filtered messages</span>
<span>instructions</span> <span>=</span> <span>&lt;&lt;~</span><span>TEXT</span><span>
  I&#39;m going to send filtered information to you in the form of free text.
  If you need to refer to the filtered information in a response, just reference it by the filter.
</span><span>TEXT</span>

<span>messages</span> <span>=</span> <span>[</span>
  <span>{</span><span>role: </span><span>&#34;system&#34;</span><span>,</span> <span>content: </span><span>instructions</span><span>},</span>
  <span>*</span><span>user_messages</span>
<span>]</span>

<span>chat_completion</span> <span>=</span> <span>openai</span><span>.</span><span>chat</span><span>.</span><span>completions</span><span>.</span><span>create</span><span>(</span><span>messages</span><span>:,</span> <span>model: :&#34;gpt-5&#34;</span><span>)</span>
<span>response</span> <span>=</span> <span>chat_completion</span><span>.</span><span>choices</span><span>.</span><span>last</span><span>.</span><span>message</span><span>.</span><span>content</span>

<span># Restore the response from the mapping</span>
<span>mapping</span> <span>=</span> <span>result</span><span>.</span><span>mapping</span>
<span>restored_response</span> <span>=</span> <span>TopSecret</span><span>::</span><span>FilteredText</span><span>.</span><span>restore</span><span>(</span><span>response</span><span>,</span> <span>mapping</span><span>:).</span><span>output</span>

<span>puts</span><span>(</span><span>restored_response</span><span>)</span>
</code></pre></div><h2 id="prevent-storing-sensitive-information-with-validations">
  <a href="#prevent-storing-sensitive-information-with-validations">
    Prevent storing sensitive information with validations
  </a>
</h2>

<p>Top Secret can also be used as a validation tool to prevent storing sensitive
information in your database.</p>
<div><pre><code><span>class</span> <span>Message</span> <span>&lt;</span> <span>ApplicationRecord</span>
  <span>validate</span> <span>:content_cannot_contain_sensitive_information</span>

  <span>private</span>

  <span>def</span> <span>content_cannot_contain_sensitive_information</span>
    <span>result</span> <span>=</span> <span>TopSecret</span><span>::</span><span>Text</span><span>.</span><span>filter</span><span>(</span><span>content</span><span>)</span>
    <span>return</span> <span>if</span> <span>result</span><span>.</span><span>mapping</span><span>.</span><span>empty?</span>

    <span>errors</span><span>.</span><span>add</span><span>(</span><span>:content</span><span>,</span> <span>&#34;contains the following sensitive information </span><span>#{</span><span>result</span><span>.</span><span>mapping</span><span>.</span><span>values</span><span>.</span><span>to_sentence</span><span>}</span><span>&#34;</span><span>)</span>
  <span>end</span>
<span>end</span>
</code></pre></div>
<p>If the validation is too strict, you can <a href="https://github.com/thoughtbot/top_secret#overriding-the-default-filters">override</a> or <a href="https://github.com/thoughtbot/top_secret#disabling-a-default-filter">disable</a> any of
the filters as needed.</p>
<div><pre><code><span>--- a/app/models/message.rb
</span><span>+++ b/app/models/message.rb
</span><span>@@ -4,7 +4,7 @@</span> class Message &lt; ApplicationRecord
   private
<span>
</span>   def content_cannot_contain_sensitive_information
<span>-    result = TopSecret::Text.filter(content)
</span><span>+    result = TopSecret::Text.filter(content, people_filter: nil, location_filter: nil)
</span>     return if result.mapping.empty?
<span>
</span>     errors.add(:content, &#34;contains the following sensitive information #{result.mapping.values.to_sentence}&#34;)
</code></pre></div><h2 id="wrapping-up">
  <a href="#wrapping-up">
    Wrapping up
  </a>
</h2>

<p>It’s our responsibility to protect user data. This is more important than ever
given the rise in popularity of chatbots and LLMs. Tools like <a href="https://github.com/thoughtbot/top_secret">Top Secret</a> aim to
reduce this burden.</p>



    </div></div>
  </body>
</html>
