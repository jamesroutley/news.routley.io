<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/unix/ExecAndShebangHistory">Original</a>
    <h1>Unix didn&#39;t used to support &#39;#!&#39;, a brief history</h1>
    
    <div id="readability-page-1" class="page"><div><h2>How Unix didn&#39;t used to support &#39;#!&#39;, a brief history</h2>

	<p><small>July 13, 2022</small></p>
</div><div><p>When I wrote about <a href="https://utcc.utoronto.ca/~cks/space/blog/unix/EmptyFileWhyTrue">why an empty executable file is true in Unix</a>, I mentioned that it&#39;s traditional Unix behavior
that shell scripts without a &#39;#!&#39; line are passed directly to the
Bourne shell. The short version of why this behavior exists is that
before a certain point, Unix didn&#39;t understand &#39;#!&#39; lines at all.</p>

<p>In V7 (and versions before it), the exec*() family of system
calls only worked on actual binary executables. In order to make
shell scripts more or less work, the shell (and I think perhaps
some other programs) reacted to an <code>ENOEXEC</code> error by assuming
the executable was actually a shell script. In the traditional
Unix manner, the shell didn&#39;t do any sort of safety check to see
if the file actually had ASCII text in it; if execve() returned
<code>ENOEXEC</code>, that was good enough for it (you can see this in the
execs() function in <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=V7/usr/src/cmd/sh/service.c">sh/service.c</a>).</p>

<p>(The V7 shell was actually reasonably clever about how it handled this
case. Rather than exec&#39;ing itself again, it longjmp()&#39;d back to the
start of main() in the same process.)</p>

<p>Before I started my research for writing this entry, I would have
said that kernel support for &#39;#!&#39; was added in 4.2 BSD. That&#39;s
certainly where it first appeared and where it became well known,
but according to <a href="https://en.wikipedia.org/wiki/Shebang_(Unix)#History">the history section of Wikipedia&#39;s page on #!</a>, it was first
introduced by Dennis Ritchie in 1980, after V7, although it might
have been suggested to him by someone else. It didn&#39;t become known
through later releases of Research Unix because those were never
very widely spread, <a href="https://utcc.utoronto.ca/~cks/space/blog/unix/V7WhyItMattersSoMuch">unlike V7</a>.</p>

<p>(This suggests that at least some of <a href="https://utcc.utoronto.ca/~cks/space/blog/unix/BourneCommentHistory">my somewhat apocryphal history
of comments in the Bourne shell</a> is wrong. I&#39;d
guess that &#39;#&#39; was added as a comment character to the Bourne shell
at some point after V7, since otherwise a shell script that started
with &#39;#!/bin/sh&#39; would produce an error from the Bourne shell.)</p>

<p>Unix owes a lot to <a href="https://en.wikipedia.org/wiki/Dennis_Ritchie">Dennis Ritchie</a> as it is, but I&#39;m
still pleased and glad to learn that we owe a bit more to him than
I thought (as well as to whoever suggested the idea to him). Plus,
finding this out is a nice reminder to myself that the history of
Unix can be more interesting than what I remember from the folklore
I&#39;ve absorbed over time.</p>
</div></div>
  </body>
</html>
