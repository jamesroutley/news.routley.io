<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.aleksic.dev/using-ansible-and-nomad-for-a-homelab-part-1">Original</a>
    <h1>Using Ansible and Nomad for a homelab (part 1)</h1>
    
    <div id="readability-page-1" class="page"><div id="post-content-wrapper"><h2 id="heading-part-1-of-2">Part 1 of 2</h2>
<p>This article will be split into 2: </p>
<ol>
<li>one about the motivation for the migration away from Chef and how I did it using Ansible;</li>
<li>another one about Nomad, hopefully soon.</li>
</ol>
<h2 id="heading-what">What?</h2>
<p>I have a small cluster of computers which I have been maintaining over the last 10 years. I&#39;ve learned an amazing amount of Linux operations thanks to those first Raspberry Pi&#39;s but most of all the biggest learning asset I acquired was understanding of the <em>pain</em> of making stuff work <em>manually</em>.</p>
<p>Back then I decided to use Chef as my Config Management (I remember I considered Puppet as well). Don&#39;t get me wrong, Ruby is still alive and well (I wouldn&#39;t say it&#39;s exactly thriving but there are for sure millions of Ruby programmers) - but my engineering career path took me more into direction Java as the main language (with short but interesting excursions into Go and Rust) and Python for <em>everything else</em>.</p>
<p>So, the writings on the wall were there for a long time:  </p>
<ul>
<li>my Chef cookbooks had to be vendored and manually maintained, </li>
<li>weird Ruby concoctions had to be used more and more often because I hated maintaining the chef-repo,</li>
<li>it got harder and harder to match the target Chef version with the available system Ruby version (rvm helped there with unnatural life extension), </li>
<li>I simply didn&#39;t have time to maintain my personal deployment framework BADUC.</li>
</ul>
<blockquote>
<p>It stood for &#34;Bastion/Drone/Usher/Consul&#34; where distributes consul locks were used with node agents and ingress token-driven service triggered deployment.  BTW, don&#39;t do this. Don&#39;t waste time doing something like that, unless you have an abundant amount of free time. It was a major mistake on my side, albeit a nice learning experience. I deleted it all with a laugh on my face - I spent many hours on maintaining it, knowing it will be thrown at some moment in time anyway. Just use off-the-shelf platforms like Nomad or K8s.</p>
</blockquote>
<p>I waited for a long time, but finally, I did it: the last remnants of Chef code and setup have been removed and the cluster has moved to Ansible foundation. It took me around 2 months (a couple of hours per week, as much as family life can provide, I guess).</p>
<p>Cluster is hybrid in every sense (unusual for companies but quite a normal thing for home labs):</p>
<ul>
<li>part is in the cloud and part on my premises (basement and office);</li>
<li>there are ARM servers (arm5, aarch64, arm7) and there are the &#34;normal&#34; x64 machines</li>
<li>some software is set up using Ansible, but mostly I try to target Nomad for new services</li>
<li>some services are deployed from Github Actions and some from within the network using self-hosted Drone. </li>
</ul>
<h2 id="heading-the-path">The path</h2>
<p>Here is my attempt in explaining what I figured out to be the path:</p>
<ul>
<li>figure out reasonable Linux OS distribution</li>
<li>define foundational aspects and deploy them using Ansible</li>
<li>everything else should work as Nomad job(s).</li>
</ul>
<h2 id="heading-linux-distribution">Linux distribution</h2>
<p>There is not a lot of thinking here - if you wish to mix arm servers with x64... you just have to go with Debian (or its derivatives, like Ubuntu). </p>
<p>I know you can set up Ansible to work with any distribution, but for a home lab... it just makes no sense to do it: just expect <code>apt</code>, <code>systemd</code>, and the friends are all there.</p>
<p>This also drastically relaxed Ansible role expectations: my roles are mostly trivial because of this decision.</p>
<h2 id="heading-foundations">Foundations</h2>
<p>I considered the following things as the most inner ring (or the <em>castle foundations</em> if you like metaphors) of the setup:</p>
<ul>
<li>ability to access the SSH port via the default user provided by the distribution using Ansible</li>
<li>run Ansible roles</li>
<li><strong>seal</strong> the system (no public SSH ever again).</li>
</ul>
<p>Your cloud provider or your ISP might provide you with direct public IP access which is nice. But it makes <em>no sense for a home lab</em> anymore in 2022 with Cloudflare tunnel, Twingate,  Tailscale, etc. </p>
<p>My cloud nodes are currently in the Oracle cloud because of their generous &#34;always free&#34; offering. But, that&#39;s just me being a cheap ass.</p>
<h3 id="heading-standard-roles">Standard roles</h3>
<p>How to prepare a node for the seal? What are the needed steps to make it happen? For me, the minimum list of the things that must be present on any node in the home lab cluster are:</p>
<ul>
<li>add the new system user for Ansible, </li>
<li>checkout dotfiles from internal Git (this step <em>might fail</em> so it&#39;s important to allow for it in case the git server itself is part of the cluster)</li>
<li>add some &#34;default&#34; packages, (from <code>ncdu</code> to <code>tcpdump</code>, everyone has their favorites here I guess);</li>
<li>change some system files, like <code>motd</code> messages just to mark the territory and point out which node you are connected to after SSH login or <code>sshd</code> config to block password login and all the other system configurations;</li>
<li>start <strong>Tailscale</strong> agent and join my tailnet using auto-join feature;</li>
<li>add <strong>promtail</strong> to push logs (Loki will be used as the centralized logging service);</li>
<li>use <strong>collectd</strong> for metric publishing (InfluxDB will be used for the metrics);</li>
<li>start <strong>Consul</strong> agent;</li>
<li>start <strong>Nomad</strong> agent.</li>
</ul>
<p>The actions listed above must be done on all the servers as Ansible roles and only if they are applied can a server be declared as the &#34;homelab cluster member node&#34;.</p>
<h3 id="heading-monitoring">Monitoring</h3>
<p>You might ask yourself why would I consider monitoring foundational.</p>
<p>Well, for me as a backend engineer, observability is a paramount concern when building systems. You don&#39;t <em>guess</em> what the system is doing, you observe it.</p>
<p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1645870045384/ucEidfnkl.png?auto=compress,format&amp;format=webp" alt="CleanShot 2022-02-26 at 11.07.08@2x.png"/></p>
<p>Logging seems like a first thing to look at, for sure, but I find metrics way more interesting for a home lab. You get to see the usage and problems first-hand, like for example situations where a node is over-committed and some swap is needed or when network partitioning shows itself, and so on.</p>
<p>I was focused on lightweight processes and figured out that the smallest footprint comes from Go-driven apps, so I prefer the Grafana stack (Tempo, Loki, Grafana itself), with InfluxDB for metric storage using a 30 days retention period. I&#39;m quite happy and would suggest this stack to everyone.</p>
<p>These Go services are deployed using Nomad, but the agents themselves are for me foundational layer since they should be available and running <em>even when collector services are down</em>. But of course, if you want to throw money at the problem you can avoid collectd/promtail and the monitoring collector services by using their managed offering or just go for Datadog - that&#39;s an amazing monitoring suite.</p>
<p><strong>Collectd</strong> is something I chose simply because it can be installed on <em>any machine</em>, even my old arm5 Debian. And InfluxDB has support out of the box without any need for additional converters or transformers. Easy on those Raspberry Pi or low-cost cloud node CPUs.</p>
<h3 id="heading-tailscale">Tailscale</h3>
<p>The magic here is Tailscale - after the nodes join the tailnet all of them can talk to each other, regardless of their physical location of NAT or whatever you in front of them.</p>
<p>Nothing comes into the nodes unless it&#39;s via the Tailscale network.</p>
<p>If nodes talk to each other, it&#39;s via Tailscale.</p>
<p>If there are ingress, publicly open ports, they are quite limited and only on specially marked and isolated nodes. But SSH or other administration ports are never left open for the public.</p>
<p>Thank you Tailscale for such an amazing product!</p>
<blockquote>
<p>From the <a target="_blank" href="https://news.ycombinator.com/item?id=30490116">HackerNews geeks</a> I&#39;ve learned about &#34;Headscale&#34; that is an OSS implementation of the Tailscale server (the only thing which is closed-source in Tailscale setup). I will surely check it out at some point but for now... Tailscale has generous enough free offering that is more than enough for me. For now ðŸ˜€</p>
</blockquote>
<h2 id="heading-consulnomad">Consul/Nomad</h2>
<p>I guess you might as why not K8s, right? Well, I know K8s enough, have been using it with one of my previous employers, and am OK with it. But, I wanted something simple for my home lab. Nomad was just a clear winner because of its simplicity, a no-brainer. But, more about how I use it in the next post.</p>
<p>Introducing Nomad demands a Consul cluster up and running, with the agents deployed across the servers.</p>
<p>I knew Consul for a long period and I consider it a nice building block for distributed computing: </p>
<ul>
<li>consistent quorum-driven Key/Value storage;</li>
<li>service discovery;</li>
<li>Connect service mesh (still not using it, yet).</li>
</ul>
<h2 id="heading-non-foundational-ansible-services">Non-foundational Ansible services</h2>
<p>Some services simply could not be migrated efficiently to Nomad jobs and then they were pushed into a &#34;foundational&#34; setup.</p>
<p>I could choose to force them into Nomad, but I decided to cut my losses here - instead of targeting purity, I decided to have something running and come back later to rethink the approach if the services themselves and/or Nomad further evolve to allow me to fix the problems that blocked me from declaring these workloads as Nomad jobs.</p>
<h3 id="heading-gitea">Gitea</h3>
<p>This is a popular small-scale self-hosted Git server.</p>
<p>There were too many things that ended up being weird when I tried to put it into a Nomad job:</p>
<ul>
<li>creators blocking the idea of the job turning as a <code>root</code> user (even leaving messages in the source code for the smart asses) which is <em>such a pain</em> if you have to use <code>exec</code> / <code>raw_exec</code> Nomad drivers</li>
<li>git hooks auto-created by gitea hardcode the physical location of the binary 
(there is an admin action to update the location, but that was just a bit ridiculous and the last drop in the glass full of problems so I just gave up) </li>
</ul>
<h3 id="heading-postgresql">PostgreSQL</h3>
<p>I prefer running the system packaged version for that platform, although in theory, I should be able to just run a Docker container. PostgreSQL is a database that is suitable for wide number of use cases, from Raspberry Pis to huge RAM-rich sharded cloud clusters. </p>
<h3 id="heading-public-ingress-reverse-proxy">Public ingress reverse proxy</h3>
<p>This will be replaced by an official nomad/Consul gateway envoy proxy at some moment, but for now, I simply had to timebox things in the cluster to non-Connect setup.</p>
<p>I chose Caddy proxy instead of Nginx with which I have more operational experience since it handled HTTPS certificate maintenance without any scripts by me.</p>
<h2 id="heading-to-be-continued">To be continued...</h2>
<p>In the next installment: some Nomad remarks and personal experiences, including both the good and the bad parts!</p>
</div></div>
  </body>
</html>
