<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://nosferalatu.com/./DerivativesLogarithmsTransforms.html">Original</a>
    <h1>Derivatives and Logarithms of 3D Transforms</h1>
    
    <div id="readability-page-1" class="page"><div>
    <div>
        <div>
    <section id="content">
        <article>
            
            <div>
                
                <p>Given a transform <span>\(T\)</span> and a point x, we can find the transformed point with <span>\(T * x\)</span>. But what if we want to smoothly interpolate <span>\(T\)</span> so it moves <span>\(x\)</span> along the path from its initial position to its position transformed by <span>\(T\)</span>? </p>
<p>What we want to find is the point <span>\(x\)</span> at time <span>\(t\)</span>:</p>
<p><span>\(x(t) = T(t) * x(0)\)</span></p>
<p>where <span>\(x(0)\)</span> is the point’s initial position, and <span>\(T(t)\)</span> is the transform at time <span>\(t\)</span>. Since we have only a single transform <span>\(T\)</span>, we need to find a way to interpolate it over time.</p>
<p>One way to accomplish this is to raise <span>\(T\)</span> to the power of <span>\(t\)</span>, which can be done using the exponential and logarithm of the transform. Interestingly, the logarithm of a transform can also be used to easily find the velocity of a point <span>\(x\)</span> in space: the velocity vector (also called the tangent vector) is just <span>\(log(T) * x\)</span>. This blog post shows the relationship between the logarithm and velocity.</p>
<h3>Example</h3>
<p>Check out this interactive example to see how the vector field changes as you manipulate the gizmo to translate and rotate the transform. The vector field represents the velocity vector at each point in space during the transformation.</p>
<p>As you move the gizmo, you’ll notice a white curve that traces the path from the origin to the gizmo’s transform. Along this curve, you’ll see the interpolated transform as it travels from the origin to the gizmo. As you can see, the interpolation follows the flow of the velocity vector field. The applet’s code is using the exponential and logarithm of the transform to compute the curve, interpolated transform, and vector field.</p>














<p>The source code for the applet can be found <a href="https://nosferalatu.com/js/DerivativeAndLogarithmOfTransforms_example.js">here</a>, which includes an implementation of closed-form log() and exp() for rigid body transforms.</p>
<p>Next, I’ll describe how to compute the interpolated transform and the velocity vector field you see in this example.</p>
<h3>What’s <span>\(T(t)\)</span>?</h3>
<p>We have <span>\(T\)</span>, but not <span>\(T(t)\)</span>, which changes with time. Assuming that multiplying two transforms represents the composition of those transforms, we can find <span>\(T(t)\)</span> by saying</p>
<p><span>\(T(0) = I\)</span> (the identity transform)</p>
<p><span>\(T(1) = T\)</span></p>
<p><span>\(T(2) = T * T\)</span></p>
<p><span>\(T(3) = T * T * T\)</span></p>
<p>More generally, we can find <span>\(T\)</span> at any time by saying</p>
<p><span>\(T(t) = T^t\)</span>.</p>
<p>The above trick is from a blog post by Fabian Giesen <a href="https://fgiesen.wordpress.com/2012/08/24/quaternion-differentiation/">here</a> but works for any transform that uses multiplication for composition.</p>
<p>Now that we know <span>\(T(t) = T^t\)</span>, the original equation can be rearranged to</p>
<p><span>\(x(t) = T^t * x(0)\)</span>.</p>
<h3>What’s <span>\(T^t\)</span>?</h3>
<p>To compute <span>\(T^t\)</span>, we need to use the matrix exponential and matrix logarithm.</p>
<p>Let’s start with two facts about a matrix X:</p>
<p><span>\(e^{log(X)} = X\)</span> and</p>
<p><span>\(log(X^y) = log(X) * y\)</span>.</p>
<p>Put together, we can say that</p>
<p><span>\(T^t = e^{log(T^t)} = e^{log(T)*t}\)</span></p>
<p>which we can plug into the earlier equation, giving us</p>
<p><span>\(x(t) = e^{log(T) * t} * x(0)\)</span>.</p>
<p>This says that to find the point x at time t, find the transform at time t using <span>\(e^{log(T) * t}\)</span>, and use that to transform the point at its initial position (at time 0).</p>
<h3 id="WhatsTheDerivative">What’s the derivative?</h3>
<p>In calculus, we learned that</p>
<p><span>\(\dfrac{d}{dt}e^{a t} = a e^{a t}\)</span></p>
<p>which holds true for matrices as well:</p>
<p><span>\(\dfrac{d}{dt}e^{A t} = A e^{A t}\)</span></p>
<p>This relationship is explained in more detail in the section <a href="#DerivativeOfMatrixExponential">the derivative of the matrix exponential</a>.</p>
<p>We can use this property to find the derivative of our earlier equation <span>\(x(t) = e^{log(T)t} x(0)\)</span> with respect to t:</p>
<p><span>\(\dfrac{d}{dt}x(t) = log(T) e^{log(T) t} x(0)\)</span>.</p>
<p>This equation states that to find the first derivative (the velocity vector, also called the tangent vector) of the point at time t, you first transform the point’s initial position <span>\(x(0)\)</span> with the interpolated transform <span>\(e^{log(T)t}\)</span> and then multiply it by the logarithm of the transform <span>\(log(T)\)</span>. This expression follows the right-to-left convention of column vectors, so you would start with the initial position <span>\(x(0)\)</span>, then apply the interpolated transform <span>\(e^{log(T)t}\)</span>, and finally multiply by the logarithm <span>\(log(T)\)</span>.</p>
<p><span>\(e^{log(T) t}\)</span> acts as an operator that maps points from their initial position to their new position at time t. The matrix exponential can be thought of as like integration. At time 0, <span>\(e^{log(T) t}\)</span> is the identity matrix (<span>\(e^0=I\)</span> for matrix exponentials), and at time 1.0, <span>\(e^{log(T) t}\)</span> is equal to the original transform matrix T (<span>\(e^{log(T)}=T\)</span>).</p>
<h3>What’s this all mean?</h3>
<p>If we take the equation at the end of “What’s <span>\(T^t\)</span>?”</p>
<p><span>\(x(t) = e^{log(T) t} x(0)\)</span></p>
<p>and substitute that into the equation at the end of “What’s the derivative?”</p>
<p><span>\(\dfrac{d}{dt}x(t) = log(T) e^{log(T) t} x(0)\)</span>,</p>
<p>then we have:</p>
<p><span>\(\dfrac{d}{dt}x(t) = log(T) x(t)\)</span>.</p>
<p>This relates the derivative of a moving point to the logarithm of the transformation moving that point.</p>
<p>One way to think of <span>\(log(T)\)</span> is as a vector field of tangent vectors for the transformation. In other words, it’s the field of first derivatives. This vector field is independent of time and shows the velocity for every point in space.</p>
<p>That equation is saying that if you transform any point in space by the logarithm of the transform, you will get the first derivative at that point. The first derivative is the velocity, so <span>\(log(T)\)</span> defines the velocity field (the field of tangent vectors at every point in space). </p>
<p>As a point moves through space by the transform, it forms a curve. The tangent vector at time t is tangent to the point’s position on the curve at time t.</p>
<p>You can think of the logarithm of a matrix as the velocity field of the action performed by that matrix. The velocity field visualized in the interactive example above is this field.</p>
<p>A more informal way of looking at this is to say</p>
<p><span>\(velocity = log(transform) * position\)</span></p>
<p>meaning, to understand how a point will move in time, look at the vector field of the log of the transform as a velocity field. As the point flows along that velocity field, it moves in time.</p>
<h3>What’s the differential equation?</h3>
<p>We can also reformulate all of this as a differential equation. Earlier, we had</p>
<p><span>\(\dfrac{d}{dt} x(t) = log(T) x(t)\)</span></p>
<p>which is a differential equation. Because <span>\(log(T)\)</span> is a matrix, it is more specifically a matrix differential equation.</p>
<p>Scalar ordinary differential equations of the form</p>
<p><span>\(y&#39;(t)=ay(t)\)</span></p>
<p>have the general solution</p>
<p><span>\(y(t)=e^{at}y(0)\)</span>.</p>
<p>Similarly, matrix differential equations of the form</p>
<p><span>\(x&#39;(t)=Ax(t)\)</span></p>
<p>have the general solution</p>
<p><span>\(x(t)=e^{At}x(0)\)</span>.</p>
<p>Therefore, given our equation from earlier</p>
<p><span>\(\dfrac{d}{dt} x(t) = log(T) x(t)\)</span></p>
<p>we have the solution</p>
<p><span>\(x(t) = e^{log(T) t} x(0)\)</span>.</p>
<p>This is the same as our original equation, but we started with a differential equation and found a solution. To prove this solution is correct, just take the derivative of it, which is what we did earlier in the <a href="#WhatsTheDerivative">What’s the derivative?</a> section.</p>
<h3>The exponential map and logarithm map</h3>
<p>The exponential map is defined as the infinite series</p>
<p>$$e^{A t} = I + A t + \frac{1}{2}(A t)^2 + \frac{1}{3!}(A t)^3 + ... = \sum_{i=0}^{\infty} \frac{(At)^i}{i!}$$</p>
<p>and can be used to find the exponential of real numbers, complex numbers, quaternions, matrices, and more. For example, when square matrices are plugged in to the series, the result is called the <a href="https://en.wikipedia.org/wiki/Matrix_exponential">matrix exponential</a>.</p>
<p>Similarly, the logarithm is defined as the infinite series</p>
<p>$$log(A) = \sum_{i=1}^{\infty} (-1)^{i+1} \frac{(A - I)^i}{i}$$</p>
<p>If you want to know more, search for the exponential map and logarithm map. You’ll find that these are important concepts in Lie group theory. The exponential map and logarithm map are inverses of each other. In Lie theory, the exponential map maps a tangent vector at a point p to a point on the manifold. The logarithm map does the opposite, mapping a point on the manifold back to the tangent vector at p.</p>
<p>When reading about Lie groups, you’ll come across many different kinds of groups. There are only a few groups that are related to transforms, though. <strong><span>SO</span>(3)</strong> is a 3D rotation matrix, <strong><span>SU</span>(2)</strong> is a quaternion, <strong><span>SE</span>(3)</strong> is a 3D rigid body transform (rotation and translation), <strong><span>SIM</span>(3)</strong> is rotation, translation, and (positive) uniform scale, and <strong><span>GL</span>(n)</strong> is an nxn matrix.</p>
<p>There are several options for how to practically compute the exponential and logarithm map for a matrix or other object:</p>
<p>1) Use a math library like Eigen or Armadillo. These have functions to compute the matrix exponential and matrix logarithm.</p>
<p>2) The library Sophus has code for a closed form exp/log for the groups <span>SO</span>(3), <span>SE</span>(3), and <span>SIM</span>(3). Beware that it clamps its quaternions to a 3D rotation angle in -<span>\(\pi\)</span> … +<span>\(\pi\)</span> though.</p>
<p>3) There is an excellent <span>PDF</span> at the web site of Ethan Eade <a href="https://ethaneade.com/lie.pdf">here</a> which contains the closed form equations for the groups <span>SO</span>(3), <span>SE</span>(3), and <span>SIM</span>(3).</p>
<p>4) Compute the matrix exponential and logarithm by using the infinite series definitions above, and truncating after some number of terms. In my experience, this is not robust when working with floating point numbers, as you quickly start to deal with very small and very large numbers, depending on your input matrix.</p>
<p>5) Compute the exponential with numerical integration. Given a starting point <span>\(x\)</span>, integrating it for time t is the same thing as the exponential. There are many ways to compute numerical integration, from Euler to Runge-Kutta to adaptive methods.</p>
<h3>Pitfalls</h3>
<p>There are a few issues that you should be aware of.</p>
<h4>Pitfall #1</h4>
<p>The logarithm of a rotation matrix will return a 3D rotation angle in -<span>\(\pi\)</span> … +<span>\(\pi\)</span>. More technically, there are an infinite number of logarithms for a matrix, each corresponding to a rotation angle that is  2<span>\(\pi\)</span> greater than the previous one. Generally matrix logarithm code will return the principal logarithm, which is the logarithm in -<span>\(\pi\)</span> … +<span>\(\pi\)</span>. This can lead to discontinuities when interpolating transforms with rotations in them, such rotations from human joints (you can move your head from looking over your left shoulder to over your right shoulder and rotate a little more than 180 degrees).</p>
<p>On the other hand, the logarithm of a quaternion returns a 3D rotation angle in the larger range of -2<span>\(\pi\)</span> … +2<span>\(\pi\)</span>, which makes quaternions nicer to work with.</p>
<h4>Pitfall #2</h4>
<p>When working with logarithms, be aware that that the property</p>
<p><span>\(log(AB) = log(A) + log(B)\)</span></p>
<p>is <em>only</em> true when A and B commute, which is not the case for most transforms. Real numbers always commute, though, so the property does apply to them. It’s tempting to apply the property to transforms, but it’s important to remember it only applies when A and B commute.</p>
<h4>Pitfall #3</h4>
<p>Related to pitfall #2, you might want to interpolate two transforms A and B with</p>
<p><span>\(interpolate(A, B, t) = e^{(1-t)*log(A) + t*log(B)}\)</span></p>
<p>But be careful: this only works if A and B commute, which is not usually the case for transforms. Otherwise, this interpolation is neither shortest path nor constant speed.</p>
<p>Instead, interpolate the relative (also called delta) transform from A to B, like this:</p>
<p><span>\(interpolate(A, B, t) = e^{log(B A^{-1}) t} A\)</span></p>
<p>However, this method only works for interpolating between two transforms and not for blending more than two transforms.</p>
<h3>Visualizing a matrix as a vector field</h3>
<p>If you are wondering how you can visualize a matrix as a vector field, an eloquent explanation is in 3Blue1Brown’s video about matrix exponentiation. This part about matrices as vector fields explains that very well:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/O85OWBJ2ayo?start=1331" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<h3 id="DerivativeOfMatrixExponential">The derivative of the matrix exponential</h3>
<p>Earlier we used the property <span>\(\dfrac{d}{dt}e^{A t} = A e^{A t}\)</span>. It’s not obvious why this property is true, but it’s an important part of unlocking all of this.</p>
<p>A good reference for this derivation is in the textbook Modern Robotics. <a href="http://hades.mech.northwestern.edu/index.php/Modern_Robotics">A free copy of that book can be found here</a>. See equation (3.43) in that book.</p>
<p>The matrix exponential is defined as</p>
<p><span>\(e^{A t} = I + A t + \frac{1}{2}(A t)^2 + \frac{1}{3!}(A t)^3 + ...\)</span></p>
<p>What then is <span>\(\dfrac{d}{dt}e^{A t}\)</span>? If we take the derivative of each term of the matrix exponential’s expanded definition, we have</p>
<p><span>\(\dfrac{d}{dt}e^{A t} = 0 + A + A^2 t + \frac{1}{2} A^3 t^2 + ...\)</span></p>
<p>Pull out A, and then we have</p>
<p><span>\(\dfrac{d}{dt}e^{A t} = A*(I + A t + \frac{1}{2} (A t)^2 + ...) = A e^{A t}\)</span>.</p>
<p>It’s worth noting that the matrix <span>\(A\)</span> can go on the left or right, and it always holds true that</p>
<p><span>\(Ae^{A t} = e^{A t}A\)</span></p>
<p>for any square matrix, as stated in equation (3.44) in Modern Robotics.</p>
<h3>Comments</h3>
<p>Leave comments on this post with Github Issues <a href="https://github.com/nosferalatu/nosferalatu.github.io/issues/1">here</a>.</p>

            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        
    </div>
</div></div>
  </body>
</html>
