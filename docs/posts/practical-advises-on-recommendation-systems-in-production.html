<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://arkid.substack.com/p/recommendation-systems-not-so-discussed">Original</a>
    <h1>Practical advises on recommendation systems in production</h1>
    
    <div id="readability-page-1" class="page"><p>Recommendation systems have been around for a long time. Also, a massive amount of literature has been written around Recommendation systems. So, in this edition of my newsletter, I thought I would cover some of the not-so-spoken areas of recommendation systems. I would not cover any algorithms but just some of the patterns that I have observed while working on the same or by talking with people who have worked on large scale recommendation systems.</p><div><li><p><em><strong>Framing the recommendation problem </strong></em> - A lot of companies can be carried away by the hype around recommendation systems at various companies. Everyone wants to do their recommendation system like <a href="https://gibsonbiddle.medium.com/a-brief-history-of-netflix-personalization-1f2debf010a1" rel="nofollow ugc noopener">Netflix</a>, Youtube, Spotify, Airbnb, Pinterest, Amazon etc. However, there is very little thought given to what the company is trying to accomplish using their recommendation system. </p><p><em>Is the company trying to solve for discovery, or for engagement, or for something else</em>? If this is not thought through, the team which is trying to solve for the use case is left with very vague problem statements and hence can go around in circles trying to solve for an unknown problem. If Netflix, shows certain sections with recommended movies, while Spotify tries to create playlists which a person will like, your company might be trying to accomplish something entirely different. Framing the recommendation usecase can help the team come up with the right metrics and reward function. </p></li><li><p><em><strong>Baselines</strong></em>  - Heuristic Baselines are a great starting point in multiple ways. A heuristic baseline can be something as simple as showing the most popular items. Completely random baseline is too un-informed and might not give you great information about the learning capabilities of the algorithm.  Running a logistic regression might be too informed a baseline and can become a long drawn process. Heuristic baselines can be status quo too - By status quo, I mean - If you want to show top 3 items in ranked order through your recommendations, what were you showing as top 3 items on you app before any recommendations kicked in. Recency/Frequency based baselines are commonly used too. Baselines help the team understand what the model is learning at the top of what is already there. They also help you check all the basic pipelines and contracts which are anyway needed for the recommendations to work. In addition to all this, informed baselines can be your soft landing spot in case you recommendation pipelines/systems are failing in the future. Keep a mechanism ready to send all the traffic to this informed baseline.</p></li><li><p><em><strong>Metrics,Reward Functions</strong></em> - As discussed in the first point, framing your problem statement is very important . The next most important things is framing your metrics and reward functions. While, it might seem obvious, this is extremely hard. Offline metrics of ML algorithms don’t match up or correlate with you online metrics when the system is put in front of the consumer. Getting them in sync requires lots of thinking through. It also needs you to run a lot of experiments, simulations and  log online/offline metrics together to understand the patterns.  Online metrics are often times delayed in nature making them further hard to correlate with offline metrics. <em><strong>Relevance is not equal to Revenue or Retention</strong></em>. It can be a non-linear combination of multiple metrics.  Lot of experimentation, simulation, analysis will be required to create reward functions which correlate with your metric of interest. </p><p>Evaluation of recommendation system is a much talked about area. Eugene Yan recently came out <a href="https://eugeneyan.com/writing/counterfactual-evaluation/" rel="nofollow ugc noopener">with an important blog post </a>which talks about recommendation systems as an interventional system, which is very close to what most ML teams start thinking about as their recommendation systems become mature. As mentioned in my <a href="https://arkid.substack.com/p/increasing-rate-of-experimentation?s=w" rel="nofollow ugc noopener">previous newsletters</a>, logging all offline and online metrics in one place is a great way to go about metrics. This is an extremely involved area and the team needs to spend lots of time on this. <a href="https://ai.googleblog.com/2019/11/recsim-configurable-simulation-platform.html" rel="nofollow ugc noopener">Simulations</a> and counterfactual evaluations are another involved area to look at. If you thought, getting to such metrics was the hard part, you are extremely wrong. <em><strong>Getting business stakeholders aligned on such metrics is 10X harder than actually creating such metrics.</strong></em></p></li><li><p><em><strong>Slow and Fast moving metrics</strong></em> - This is an extension to the previous point but deserves a section of its own. Some of the business metrics can be very slow. Finding fast moving proxies for such metrics is extremely important or else the rate at which you can innovate will be very slow. Additionally, there are metrics which are extremely sensitive and others which are not. Finding a sensitive metric which is somewhat causal of your slower moving metric of interest is a big win. Having an initial baseline of all the metrics can very useful in eyeballing the performance of your recommendation systems.</p></li><li><p><em><strong>Lower number of items, simpler algorithms</strong></em> - Not every company has millions of SKU’s like Amazon, Spotify, Netflix, Google etc. In case you have a limited number of items,  the thumb rule is that - <em><strong>Simpler algorithms will often beat complicated algorithms</strong></em>. </p><p>The informed baseline will be really hard to beat. Multi Armed Bandit based explore-exploit methods will almost take you the distance. In my own workflow, I would like to have a <a href="http://rishabhmehrotra.com/papers/kdd2020_multiobjective_music.pdf" rel="nofollow ugc noopener">MAB as the first model </a>after the informed baseline is in place, no matter what. In case, you have smaller number of items in the 100’s, Multi armed bandits will be extremely competitive. </p></li><li><p><em><strong>Realtime Inferencing and On device compute</strong></em> - Do you need real-time inferencing or are you okay with batch inferencing? Also, how much additional upside does the real time inferencing give to you? <em><strong>In case, your best model is a lightweight  model or a lightweight user level model or you have few items (in 100’s), you might want to push the computation of the model to the device.</strong></em> This will not only save you huge infrastructure costs, it will also help latencies. There are a few companies which are working on - On device compute or Federated Learning. These companies might help you get there fast. Almost, all companies work on near real time inferencing through async processes to make their pipeliness and inferencing a lot more resilient.</p></li><li><p><em><strong>RecsysOps is real hard</strong></em> - </p><div><figure><a target="_blank" rel="nofollow" href="https://cdn.substack.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe6da7c73-d6b3-4986-ad81-ab8738a702e6_1800x942.png"><picture><source type="image/webp" srcset="https://cdn.substack.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe6da7c73-d6b3-4986-ad81-ab8738a702e6_1800x942.png 424w, https://cdn.substack.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe6da7c73-d6b3-4986-ad81-ab8738a702e6_1800x942.png 848w, https://cdn.substack.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe6da7c73-d6b3-4986-ad81-ab8738a702e6_1800x942.png 1272w, https://cdn.substack.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe6da7c73-d6b3-4986-ad81-ab8738a702e6_1800x942.png 1456w" sizes="100vw"/><img src="https://cdn.substack.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe6da7c73-d6b3-4986-ad81-ab8738a702e6_1800x942.png" width="1456" height="762" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/e6da7c73-d6b3-4986-ad81-ab8738a702e6_1800x942.png&#34;,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:762,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:null,&#34;alt&#34;:&#34;RecSys 2021 – Program – RecSys&#34;,&#34;title&#34;:null,&#34;type&#34;:null,&#34;href&#34;:null}" alt="RecSys 2021 – Program – RecSys" title="RecSys 2021 – Program – RecSys" srcset="https://cdn.substack.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe6da7c73-d6b3-4986-ad81-ab8738a702e6_1800x942.png 424w, https://cdn.substack.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe6da7c73-d6b3-4986-ad81-ab8738a702e6_1800x942.png 848w, https://cdn.substack.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe6da7c73-d6b3-4986-ad81-ab8738a702e6_1800x942.png 1272w, https://cdn.substack.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe6da7c73-d6b3-4986-ad81-ab8738a702e6_1800x942.png 1456w" sizes="100vw"/></picture></a></figure></div><h6>                                            Source - https://recsys.acm.org/recsys21/program/</h6><p>While there has been a lot of talk about how <a href="https://twitter.com/tristanzajonc/status/1458561127319625731?s=20" rel="nofollow ugc noopener">MLOps is hard</a>, <a href="https://dl.acm.org/doi/10.1145/3460231.3474620" rel="nofollow ugc noopener">RecsysOps</a> is a different breed altogether. If you have 10-100’s of millions of users and 10’s of thousands or millions of items, recsysops is a nightmare. In an ideal recsysops system, you will need the best of all things good MLOps sytems provide an more. Some of the most important things I would look at while creating a RecsysOps system would be -</p><ol><li><p><a href="https://www.tecton.ai/blog/what-is-a-feature-store/" rel="nofollow ugc noopener">Feature Stores</a> with lots of cache </p></li><li><p>Metric Beds with visualization layers</p></li><li><p>Prediction Service templates which can be quickly clones for any model - This is another underlooked point. The two major ways in which large scale prediction service is written are - 1. <em><strong>Write the predictions as a values with the user id as a key. 2. Write all the features (user,item etc) into the feature store. A dot product or some other cheap operation can be done on the top of such features as part of the prediction service.</strong></em> </p><p>Compute heavy models requires lots of hardwork to optimize as a prediction service. ONNX runtimes are used very often for prediction services as models grow in complexity.  Whether you use the 1st option or the 2nd option is a tradeoff between how many items are there on the prediction (how much of cache will it take up) vs how much latency is the real time prediction taking up. Recommendation systems almost always work in async. The worst thing that can happen in case of an async system will be stale recommendations. Okay, that was an exaggeration - Worse can happen! Chip Huyen <a href="https://huyenchip.com/2022/01/02/real-time-machine-learning-challenges-and-solutions.html" rel="nofollow ugc noopener">wrote a very good blog </a>about real time machine learning at the start of the year which talks about the architechtures being used at various companies.</p></li><li><p>System health check metrics which can be visualized alongside the metric bed visualization</p></li><li><p>Distributed Training and distributed inferencing support. Distributed ML systems are hard enough. Add slow moving business metrics into the mix and you have the complete recipe for nightmare.</p></li><li><p><a href="https://towardsdatascience.com/ml-design-pattern-4-keyed-predictions-a8de67d9c0f4" rel="nofollow ugc noopener">Keyed predictions</a> is a design pattern you might want to look for.</p></li><li><p>DAG management systems such as airflow is a pre-requisite</p></li><li><p>Lots of other moving parts. The architecture which for a long time was <a href="https://medium.com/nvidia-merlin/recommender-systems-not-just-recommender-models-485c161c755e" rel="nofollow ugc noopener">considered two tower is very well illustrated here</a>.</p></li></ol></li><li><p><em><strong>Data Distribution Shifts</strong></em> - In a fast moving company, data drifts happen. If you are a content company, new content and new kind of content is never more than a week away.</p><div><figure><a target="_blank" rel="nofollow" href="https://cdn.substack.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb0c34a8a-d869-47ff-884c-cff9a25093ac_1102x498.png"><picture><source type="image/webp" srcset="https://cdn.substack.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb0c34a8a-d869-47ff-884c-cff9a25093ac_1102x498.png 424w, https://cdn.substack.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb0c34a8a-d869-47ff-884c-cff9a25093ac_1102x498.png 848w, https://cdn.substack.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb0c34a8a-d869-47ff-884c-cff9a25093ac_1102x498.png 1272w, https://cdn.substack.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb0c34a8a-d869-47ff-884c-cff9a25093ac_1102x498.png 1456w" sizes="100vw"/><img src="https://cdn.substack.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb0c34a8a-d869-47ff-884c-cff9a25093ac_1102x498.png" width="1102" height="498" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/b0c34a8a-d869-47ff-884c-cff9a25093ac_1102x498.png&#34;,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:498,&#34;width&#34;:1102,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:null,&#34;alt&#34;:&#34;&#34;,&#34;title&#34;:null,&#34;type&#34;:null,&#34;href&#34;:null}" alt="" title="" srcset="https://cdn.substack.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb0c34a8a-d869-47ff-884c-cff9a25093ac_1102x498.png 424w, https://cdn.substack.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb0c34a8a-d869-47ff-884c-cff9a25093ac_1102x498.png 848w, https://cdn.substack.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb0c34a8a-d869-47ff-884c-cff9a25093ac_1102x498.png 1272w, https://cdn.substack.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb0c34a8a-d869-47ff-884c-cff9a25093ac_1102x498.png 1456w" sizes="100vw"/></picture></a></figure></div><h6>                       Source - https://towardsdatascience.com/understanding-dataset-shift-f2a5a262a766 </h6><p>The best of models find it very hard to generalize on data which has shifted in distribution. There is<a href="https://cloud.google.com/blog/topics/developers-practitioners/event-triggered-detection-data-drift-ml-workflows" rel="nofollow ugc noopener"> almost no full proof tool</a> for detecting data distribution drifts but basics such as checking the distributions of  the feature space, checking the distribution of predictions etc must be automated. Triggering alerts on the basis of such drifts is a good idea</p></li><li><p><em><strong>Residual effects and Novelty effects</strong></em> - Other than the mention about residual and novelty effects in <a href="https://www.amazon.in/Trustworthy-Online-Controlled-Experiments-Practical-ebook/dp/B0845Y3DJV/ref=sr_1_1?keywords=ronny+kohavi&amp;qid=1651577350&amp;sprefix=ronny+ko%2Caps%2C835&amp;sr=8-1" rel="nofollow ugc noopener">experimentation books</a>, not too many people are paying attention to the residual and novelty effects of recommendation systems. While Novelty effect can subside by doing an experiment over an extended period of time, residual effects are hard to detect and to deal with. Residual effects tend to play a very large role in the performance of recommendation systems. <a href="https://engineering.atspotify.com/2020/11/spotifys-new-experimentation-platform-part-2/" rel="nofollow ugc noopener">Rehashing your users in novel ways</a> to overcome such effects has been an ongoing area of research at multiple companies.</p></li><li><p><em><strong>Request Response Logs to create training data</strong></em> - Evaluating the performance of your current system and retraining the models at optimal frequency are important areas. While, building the contract between the backend sytems and the Recommendation systems, logging and parsing request response is good way to create training data for future retraining of your models. Even if you create a few new features, you will need to backfill only a limited number of features. This is a much understated area. Everyone is probably doing it but in case anyone is missing it, please make a note.</p></li><li><p><em><strong>Matrix Factorization techniques, Word2vec kind of techniques</strong></em> - If you can apply Matrix factorization in a meaningful way, it will almost always work.  In case of fresh items coming up, companies have been known to roll it out to a few consumers just to capture interaction data, <a href="https://tinuiti.com/blog/paid-social/tiktok-algorithm/" rel="nofollow ugc noopener">so that they can roll it out to other consumers in a more personalized way</a>. There is a tradeoff between freshness of items vs how personalized they are. Which are the few users who should get those fresh items and give us the most important signals is an active area of interest for me.</p><p>Additionally, I have talked with multiple companies which claim to create item vectors basis the sequence in which items are consumed by their consumers. For example, for an ecommerce company, if the <a href="https://hackernoon.com/embeddings-at-e-commerce-me10q30tl" rel="nofollow ugc noopener">sequence of consumption</a> of items is A→B→C→D, they try to predict C basis inputs A,B,D. <a href="http://mccormickml.com/2016/04/19/word2vec-tutorial-the-skip-gram-model/" rel="nofollow ugc noopener">This is very similar to how wordvectors are trained.</a> This way, they get embedding for every item. The two techniques mentioned here have been go to techniques which have worked for multiple companies and deserve a trial.</p></li><li><p><em><strong>Explore and Exploit Dilemma</strong></em> - Explore and exploit is a well known dilemma. At the beginning of a user’s lifetime on your application, you might try to explore her interest more but as you get more signals about the user, you start exploiting their interests. Even when you have enough signals about a user,you keep some part of your recommendation as exploration content so that you can keep track of a user’s changing interest pattern.  This is basic. However, there is a lot of formulation to be done on the exploration problem for cold and sparse users. How can you explore faster? Is <a href="https://towardsdatascience.com/the-upper-confidence-bound-ucb-bandit-algorithm-c05c2bf4c13f" rel="nofollow ugc noopener">UCB</a> the fastest way to explore user interest?  </p><p>Reward functions can be a combination of “actual reward” such as click or transaction and how much signal a user gave while doing an interaction. In such a reward formulation, all kinds of models can be tried to learn user signals faster.</p></li><li><p><em><strong>Silent Failures can be extremely costly</strong></em> - Machine learning systems, and recommendation systems in general, can fail silently. Examples can be - The input data can have missing value or the input data can have a data drift, the outputs can be coming with more than expected latency, the recommendation systems might be going to fallback models, some kind of instrumentation change might not have been accounted for, etc.  In general, multiple teams such as the Applied Scientists, ML Platform Engineers, Data Analysts, Backend and Frontend engineers are all involved in pulling off a large scale recommendation system and hence in the absence of a very good monitoring, debugging and alerting system, recommendation systems can fail for minutes, hours or days. If you consumer experience (revenue or churn) is related to the recommendation system in the right way, you might lose out on few percentage points of your revenue without you even knowing it. </p></li></div><p>I hope you find my newsletters useful. Please subscribe to my newsletters to keep me motivated about writing.</p></div>
  </body>
</html>
