<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://smallstep.com/blog/home-network-eap-tls-wifi/">Original</a>
    <h1>You shouldn&#39;t run NSA-grade Wi-Fi at home. Here&#39;s how to do it</h1>
    
    <div id="readability-page-1" class="page"><article><time datetime="{updatedAt}">Updated on: <!-- -->January 5, 2024</time><div><div><p><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%27256%27%20height=%27256%27/%3e"/></span><img alt="Carl-Tashian.jpg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic"/></span></p><p><span>Carl<!-- --> <!-- -->Tashian</span></p></div><a href="https://twitter.com/smallsteplabs">Follow Smallstep<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a></div><p>If you want a home network that aligns with the US National Security Agency (NSA) criteria for protecting classified and top secret information, then read on fellow traveler, because that’s where we’re headed in this post!</p>
<p>However, if you want a home network that’s simple to configure, easy for your guests to borrow, hassle-free, and that all of your Smart Home gadgets can connect to, then you should close this tab now, because the most secure Wi-Fi mode available today—WPA3 Enterprise 192-bit mode—is not for you.</p>
<p>Still, it can be fun to try these things. And amazingly, deploying NSA-grade Wi-Fi is possible at home. It’s supported by a lot of modern Wi-Fi access points. It’s supported by <a href="https://learn.microsoft.com/en-us/windows-server/networking/technologies/extensible-authentication-protocol/network-access?tabs=eap-tls%2Cserveruserprompt-eap-tls%2Ceap-sim#wpa3-enterprise-192-bit-mode" target="_blank" rel="nofollow noopener noreferrer">Windows 10, Windows 11</a>, <a href="https://support.apple.com/guide/security/secure-access-to-wireless-networks-sec8a67fa93d/web" target="_blank" rel="nofollow noopener noreferrer">macOS, iOS, tvOS, iPads, Apple Watches</a>, and <a href="https://networkmanager.dev/blog/networkmanager-1-30/" target="_blank" rel="nofollow noopener noreferrer">Linux</a> as well.</p>
<p>This tutorial will cover iOS/iPadOS and macOS clients, and we will use a Unifi Dream Machine as our Access Point. You can follow this entire tutorial using “plain” WPA3 Enterprise <em>without</em> 192-bit mode, and you&#39;ll still have the most secure Wi-Fi network on the block. The only risk is that you may feel unprepared when the Secretary of Defense swings by for a casual co-working sesh in your living room.</p>
<h3 id="all-the-reasons-you-should-not-do-this-at-home">All the reasons you should not do this at home<a href="#all-the-reasons-you-should-not-do-this-at-home"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<p>WPA3 Enterprise is not a good fit for a home network. Typically, a large organization running WPA3 Enterprise will have many users and devices, and they will use Mobile Device Management (MDM). With an MDM provider like Jamf or Intune, it&#39;s possible to <a href="https://www.youtube.com/watch?v=KSL_Ke7HcpU" target="_blank" rel="nofollow noopener noreferrer">configure and deploy certificate-based Wi-FI on a network in a few minutes</a>. But on a home network, with no MDM provider, you&#39;ll need another mechanism for getting certificates to your devices. Oh, did I mention that you <em>need</em> certificates? There is no username or password option with WPA3 Enterprise 192-bit mode. It requires certificate-based authentication.</p>
<p>For this tutorial, we&#39;re going to use a manual process. But by doing it this way, we can illuminate a bit more of what&#39;s going on under the hood.</p>
<p>The two most common security modes for home Wi-Fi networks are WPA2-PSK and the newer WPA3-Personal. Both use a pre-shared password for authentication that strikes a friendly balance between usability and security.  NSA-grade Wi-Fi is different:</p>
<ul>
<li>As mentioned earlier, you need certificates. When friends come over, instead of just saying, “The password is MeleKalikimaka”, you will have to issue a precious Wi-Fi certificate for them and transfer it onto their device. A device which, by the way, does not yet have a Wi-Fi connection!</li>
<li>Because you need certificates, your Smart Home devices won’t support WPA3 Enterprise. Home printers won’t support it. A lot of things won&#39;t support it. In fact, it’s a miracle that some consumer-grade routers and access points support it at all.</li>
<li>Finally, Enterprise Wi-Fi is complex to operate. It requires more than just an access point. At minimum, you also need an external authentication server and, in our case, a Certificate Authority. (For this tutorial, we&#39;ll take care of these components for you.)</li>
</ul>
<p>In short, most people should not run WPA3 Enterprise at home.
And if you’re still reading this, you’re not most people.</p>

<p>For this project, you will need:</p>
<ul>
<li>A Wi-Fi access point that supports WPA2 Enterprise or WPA3 Enterprise security.</li>
<li>A client device you can test with.</li>
<li>A Smallstep account for certificates and authentication. We have a free tier for homelabs, so <a href="https://smallstep.com/signup" target="_blank" rel="nofollow noopener noreferrer">sign up right here</a> to get started.</li>
<li>Optionally, a USB stick or other means of getting files to a target device with no network access—we’ll use AirDrop in this tutorial.</li>
</ul>

<p>As you know, most home Wi-Fi uses a single shared password. With Enterprise Wi-Fi, however, there’s a dozen or so authentication protocols designed to fit different scenarios. These are all flavors of the Extensible Authentication Protocol (EAP) [<a href="https://datatracker.ietf.org/doc/html/rfc3748" target="_blank" rel="nofollow noopener noreferrer">RFC 3748</a>], and they allow network authentication to be delegated by the AP to an external server and identity provider. While the wireless security modes (eg. WPA2 Personal or WPA3 Enterprise) define the algorithms and security parameters for the entire Wi-Fi connection, the EAP method defines how a device will authenticate to the network.</p>
<p>Since we love certificates and TLS here at Smallstep, in this post we will zero in on the certificate-authenticated EAP method, called EAP-TLS [<a href="https://datatracker.ietf.org/doc/html/rfc5216" target="_blank" rel="nofollow noopener noreferrer">RFC 5216</a>]. EAP-TLS is the only EAP that requires mutual certificate authentication. This makes it, in our humble opinion, the most secure EAP out there. It offers some very nice security properties:</p>
<ul>
<li>No shared secret for accessing the network</li>
<li>No usernames or passwords, either</li>
<li>Instead, every device or user needs a device certificate and private key issued by an internal CA</li>
<li>Certificates can be issued manually, but are more often issued via Mobile Device Management (MDM), making network authentication and device identity transparent to the user of the device</li>
<li>Certificates are validated by an external RADIUS authentication server [<a href="https://datatracker.ietf.org/doc/html/rfc2865" target="_blank" rel="nofollow noopener noreferrer">RFC 2865</a>]—not by the access point itself.</li>
<li>The private key can be strongly protected from theft</li>
<li>Certificates expire—passwords don’t!</li>
</ul>
<p>And, beyond being a fun weekend project, EAP-TLS could have <em>some</em> use at home. If you have a crafty teenager named Mallory who knows how to spoof MAC addresses to circumvent parental controls, you could try EAP-TLS. Once you have established the basic EAP-TLS setup described below, you could extend your configuration to cover your wired Ethernet ports, using IEEE <a href="https://en.wikipedia.org/wiki/IEEE_802.1X" target="_blank" rel="nofollow noopener noreferrer">802.1X</a> features. This is what hospitals are required to do to lock down their networks for HIPAA compliance, so it would offer plenty of protection against a malicious TikTok-obsesseed threat actor. The setup details for 802.1X wired network protection are, however, beyond the scope of this post.</p>

<p>Here’s a simplified diagram of an Apple laptop getting a client certificate and joining an EAP-TLS authenticated network. With EAP-TLS, the RADIUS server must complete a mutual TLS handshake with the device before giving the thumbs up to the access point:</p>
<p><img src="https://smallstep.imgix.net/graphics/Authenticating_to_an_EAP-TLS_network.png?auto=format&amp;fit=max&amp;q=50" alt="Authenticating to an EAP-TLS network.png"/></p>

<p>Smallstep will be your Certificate Authority and it will issue certificates for your devices. It uses a two-tiered private PKI, with a Root CA and an Intermediate CA.</p>
<h3 id="the-radius-server">The RADIUS Server<a href="#the-radius-server"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<p>Smallstep will host a RADIUS server for you too, so you don’t have to worry about setting that up or configuring it. All you&#39;ll do is configure your Access Point to use it.</p>
<p>For context, though, here’s what the RADIUS server is configured to do:</p>
<ul>
<li>Require EAP-TLS, which is the only EAP type compatible with NSA-grade Wi-Fi</li>
<li>Use a valid server certificate from a CA that the device will trust</li>
<li>When a new device connects, authenticate its client certificate via a TLS handshake that is proxied through the AP. Certificates will be issued by your Smallstep Accounts Authority. To accept clients certificates, the RADIUS server needs to be configured to trust the root and intermediate of your Smallstep Accounts Authority (Smallstep will take care of this for you, too)</li>
</ul>
<h2 id="1-create-your-ca-and-radius-server">1. Create your CA and RADIUS server<a href="#1-create-your-ca-and-radius-server"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h2>
<p>Smallstep issues the certificates you&#39;ll need for clients to access the network, and we host a RADIUS server for network authentication. The RADIUS server authenticate devices joining the network, and reports back to your Access Point whether they are to be accepted or rejected.</p>
<p>Let’s create a Smallstep Wi-Fi Account and RADIUS server:</p>
<ol>
<li>
<p>First, create a Device Collection. <a href="https://smallstep.com/app" target="_blank" rel="nofollow noopener noreferrer">Sign into Smallstep</a>, go to the <strong>Mobile Devices</strong> tab, and choose <strong>+ Add Collection</strong>. Select <strong>Any macOS, iPadOS, or iOS device</strong> as the platform, and give your device collection a name.</p>
</li>
<li>
<p>Add your test device(s) to the device collection. Use the serial number of the device as the Device Identifier when you create it.  You can find the serial number for your device under <code>Settings &gt; General &gt; About</code> , or in <code>About This Mac</code>. Make sure you click &#34;Register Device&#34;.</p>
</li>
<li>
<p>Create a “Wi-Fi” account in your new Smallstep Device Collection</p>
<p>You’ll need to supply the Wi-Fi SSID you’ll use for WPA3 Enterprise and your public-facing (WAN) IP address, so our RADIUS server can identify requests from your network.</p>
</li>
<li>
<p>When you’re finished, you’ll see your RADIUS server details. Use these when you configure your Access Point.</p>
</li>
</ol>
<h2 id="2-configure-your-access-point">2. Configure your Access Point<a href="#2-configure-your-access-point"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h2>
<p>Once you have created your Smallstep Wi-Fi Account, there’s really only three or four bits of configuration needed your Access Point. You’ll probably want to create a separate test network for this project. Each AP is will have a slightly different configuration UI, but these are the network settings that will matter no matter what AP you’re using:</p>
<ul>
<li>Security Protocol: WPA-3 Enterprise</li>
<li>RADIUS server information (provided by Smallstep)
<ul>
<li>RADIUS server IP</li>
<li>RADIUS server port</li>
<li>RADIUS server shared secret</li>
</ul>
</li>
<li>High Security 192-bit Mode: On</li>
</ul>
<p>All we’re doing here is delegating WPA3 Enterprise Wi-Fi authentication to your Smallstep account.</p>
<h3 id="example-configuring-a-unifi-access-point">Example: Configuring a UniFi Access Point<a href="#example-configuring-a-unifi-access-point"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<p>In the Unifi Network app, first create a RADIUS Profile:</p>
<ol>
<li>Go to <strong>Settings</strong> → <strong>Profiles</strong> → <strong>RADIUS</strong> → <strong>Create New</strong></li>
<li>Give the profile a name</li>
<li>Under Authentication servers, add the RADIUS server IP address, port, and shared secret you received from Smallstep</li>
<li>Choose <strong>Save</strong></li>
</ol>
<p>Next, create a Wi-Fi network that you’ll use for testing:</p>
<ol>
<li>Go to <strong>Settings</strong> → <strong>WiFi</strong> → <strong>Create New</strong></li>
<li>Give your network an SSID</li>
<li>Under <strong>Advanced Configuration</strong>, choose <strong>Manual</strong></li>
<li>Go to <strong>Security</strong>
<ol>
<li>For <strong>Security Protocol</strong>, select WPA-3 Enterprise</li>
<li>For <strong>RADIUS Profile,</strong> select the RADIUS profile you created above</li>
<li>Turn on <strong>High Security 192-bit mode</strong></li>
</ol>
</li>
<li>Go back and choose <strong>Save</strong></li>
</ol>
<p>🚨 <strong>Not all APs support multiple SSIDs.</strong> If yours only supports a single SSID, and you can’t create a test network, it’s hard to do this project without any Wi-Fi interruptions. At a minimum, you will probably want to connect your device over Ethernet to your AP/router before you proceed to ensure you have uninterrupted access to the internet.</p>
<p>Great! You now have a test network. Let’s test it!</p>
<h2 id="3-connect-a-device">3. Connect a device<a href="#3-connect-a-device"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h2>
<p>Let’s get your test device configured. This is the most complex and annoying part of the process, but I&#39;ve tried to simplify it. We need to do the following:</p>
<ul>
<li><strong>Root distribution</strong>: Each device needs the CA that issued the RADIUS server’s certificate installed and marked as trusted.</li>
<li><strong>Enrollment</strong>: Each device needs a valid device certificate from a CA that the RADIUS server trusts. For this project, the device will generate its own private key and get a certificate which is bound to that key and signed by your Smallstep CA.</li>
<li><strong>Wi-Fi configuration</strong>: While not critical, it helps to pre-configure the WPA3 Enterprise network as a known network configuration on the device. This way, the device can immediately connect with a single tap.</li>
<li>Finally, there’s <strong>renewal.</strong> The certificate we’ll issue will expire in about 90 days. We need to renew it somehow, <em>before</em> the device loses access to the network. We’ll cover renewal a bit later.</li>
</ul>
<h3 id="enrollment-on-iosipados-using-airdrop">Enrollment on iOS/iPadOS, using AirDrop<a href="#enrollment-on-iosipados-using-airdrop"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<p>In a typical enterprise Wi-Fi deployment, all of the enrollment issues are resolved with an mobile device management (MDM) server. The MDM server pushes configuration profiles down to the device. Configuration profiles configure the device’s settings and, for things like Wi-Fi networks, get certificates from a CA.</p>
<p>But running an MDM server for a home network is a hassle. Instead, today we will do MDM <em>without</em> an MDM server. Also known as a manual enrollment or user enrollment.</p>
<p>Smallstep will generate an Apple configuration profile (a <code>.mobileconfig</code> file) for each of your devices, and you can just AirDrop this file over to the device and install it. This is perfect for testing, or if you only have a few devices and don’t need an MDM server. If you can&#39;t use AirDrop, email also works.</p>
<p>Ordinarily, we&#39;d install the root certificate via the <code>.mobileconfig</code>. Unfortunately for us, Apple prevents automatic root certificate installation except via MDM. So we&#39;ll need to install our Accounts Root CA separately.</p>
<p>Download and install your Accounts Root CA certificate:</p>
<ol>
<li>First, go to your Apple device collection in the Smallstep UI</li>
<li>Navigate to the Wi-Fi account you created earlier</li>
<li>Scroll to &#34;Authority Settings&#34; and download your Root Certificate</li>
<li>AirDrop the root certificate to your test device, and <a href="https://support.apple.com/guide/profile-manager/distribute-profiles-manually-pmdbd71ebc9/mac" target="_blank" rel="nofollow noopener noreferrer">install it there</a> by opening Settings → Profile Downloaded.</li>
</ol>
<p>Once you’ve installed the root certificate, there’s one more step: with manual enrollment, Apple requires you to <a href="https://support.apple.com/en-us/102390" target="_blank" rel="nofollow noopener noreferrer">explicitly enable Full Trust</a> for the Smallstep Accounts Root CA. This is not true for a full MDM enrollment, but we need to do it:</p>
<ol>
<li>Go to Settings → General → About → Certificate Trust Settings</li>
<li>Toggle the switch on the Smallstep Accounts CA to enable Full Trust</li>
</ol>
<p>Your Smallstep Accounts Root CA is now trusted.</p>
<p>Now, download and install your <code>.mobileconfig</code> file:</p>
<ol>
<li>Return to your Apple device collection in the Smallstep UI</li>
<li>Click &#34;Devices&#34;, find your test device, click &#34;view device&#34;, and navigate to the &#34;Accounts&#34; tab on the device profile</li>
<li>Now, click the &#34;Configuration Profile&#34; link on the Wifi account to download the <code>.mobileconfig</code>, but don&#39;t install it</li>
<li>AirDrop the <code>.mobileconfig</code> to your test device, and <a href="https://support.apple.com/guide/profile-manager/distribute-profiles-manually-pmdbd71ebc9/mac" target="_blank" rel="nofollow noopener noreferrer">install it there</a> by opening Settings → Profile Downloaded.</li>
</ol>
<p>Once you’ve installed the profile, we once again need to manually tweak trust settings. This time to explicitly enable Full Trust for the Smallstep RADIUS server’s root CA. Again, this is not true for a full MDM enrollment.</p>
<ol>
<li>Go to Settings → General → About → Certificate Trust Settings</li>
<li>Toggle the switch on the Smallstep RADIUS Root CA to enable Full Trust</li>
</ol>
<p>The Smallstep RADIUS Root CA is now trusted.</p>
<p><strong>Join the network</strong></p>
<p>The device is now enrolled, and you’re ready to join the network.</p>
<ol>
<li>Open Settings → Wi-Fi</li>
<li>Choose your WPA-3 Enterprise network SSID</li>
</ol>
<p>If everything is configured correctly, your test device will join the network!</p>
<h3 id="enrollment-on-macos">Enrollment on macOS<a href="#enrollment-on-macos"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<p>This is very similar to iOS enrollment.</p>
<p>To install the Smallstep Accounts Root CA, follow the download instructions for iOS then open the downloaded file to install it in your System Keychain. Again, manually installed root certificates aren&#39;t trusted by default, so you&#39;ll need to open Keychain Access and adjust the trust settings for the certificate to &#34;Always Trusted&#34; (<a href="https://support.apple.com/guide/keychain-access/change-the-trust-settings-of-a-certificate-kyca11871/mac" target="_blank" rel="nofollow noopener noreferrer">full instructions here</a>).</p>
<ol>
<li>Open Keychain Access</li>
<li>In the System keychain, find the Smallstep Accounts Root CA Certificate, and double-click on it</li>
<li>Open the Trust section</li>
<li>In the “When using this certificate” dropdown, select “Always Trust.”</li>
<li>The CA certificate is now trusted for Wi-Fi RADIUS server connections</li>
</ol>
<p>To get a <code>.mobileconfig</code> file:</p>
<ol>
<li>First, go to your Apple Device Collection in the Smallstep UI</li>
<li>Click Devices and add macOS device, using the device serial number as the “device identifier” in Smallstep</li>
<li>Once it’s created, click &#34;view device&#34; and navigate to Accounts</li>
<li>Choose “download configuration profile” for your macOS device</li>
<li>Download the <code>.mobileconfig</code> and open it</li>
<li>Open System Settings → Privacy &amp; Security → Profiles</li>
<li>Under “Downloaded”, double-click the profile you just added</li>
<li>Choose “Install…”, and choose Install again.</li>
</ol>
<p>Once you’ve installed the profile, there’s one more step: return to Keychain Access and explicitly &#34;Always Trust&#34; the Smallstep RADIUS Root CA certificate as we did with the Smallstep Accounts Root CA above.</p>
<p><strong>Join the network</strong></p>
<p>Choose your WPA3 Enterprise SSID from the Wi-Fi menu. If everything is configured correctly, your test device will join the network!</p>
<h3 id="it-worked-now-what">It worked! Now what?<a href="#it-worked-now-what"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<p>Now you can repeat the process for other devices. Add the device to your Device Collection on Smallstep, download a profile for it, and AirDrop the profile to the device.</p>
<h3 id="what-about-renewal">What About Renewal?<a href="#what-about-renewal"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<p>You need to renew every device’s client certificate. By default, these certificates will have a 90 day validity period. For an MDM-without-MDM setup, you’ll need to renew them manually every 45-60 days. To do this, AirDrop the same <code>.mobileconfig</code> file that you originally downloaded to the device, and install it. The device will get a new certificate for itself from your Smallstep CA.</p>
<h3 id="enrollment-for-houseguests">Enrollment for houseguests<a href="#enrollment-for-houseguests"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<p>Houseguests with Apple devices don’t need full root distribution. They can just trust the RADIUS server’s certificate the first time they connect to wifi. (Side note: In enterprise networks, this is not okay, because without real server validation, an attacker can create an “evil twin” network with the same SSID and run a RADIUS server that captures credentials from devices attempting to connect.)</p>
<p>A houseguest’s device serial number doesn’t need to be registered with Smallstep, and they don’t need certificate renewal either. We just need to send them a single client certificate and they can join the network manually.</p>
<p>Let’s get a client certificate for your Wi-Fi network onto their device:</p>
<ol>
<li>
<p>In the Certificate Manager → Authorities tab, go to your Accounts authority and use the UI to create a certificate for your houseguest. Give it a validity period that matches the duration of your guest’s stay.</p>
</li>
<li>
<p>Download the <code>.crt</code> and <code>.key</code> files. From here you’ll need to make a <code>.p12</code> bundle for your device. Pop open a Terminal and run the following, using the files you just downloaded as inputs:</p>
<pre><code>openssl pkcs12 -export -legacy -inkey wifi.key -in wifi.crt -out wifi.p12
</code></pre>
<p>When asked for a password, <em>don’t leave it blank</em>. iOS/iPadOS won’t accept an empty password. This is a temporary password, so you can use something simple.</p>
</li>
<li>
<p>Great, now AirDrop or otherwise transfer <code>wifi.p12</code> over to your device.</p>
</li>
<li>
<p>Accept the AirDrop, then go to Settings → Profile Downloaded</p>
</li>
<li>
<p>Tap Install, type your passcode, and tap Install again. It will say that the profile is not signed. That’s totally fine. Tap install a third time, then enter the password you created earlier. Tap Done.</p>
</li>
</ol>
<p>Now the device can join the network, but since there’s no wifi configuration payload on their device, they will have to supply the certificate manually when they connect to your Wi-Fi:</p>
<ol>
<li>Select the network SSID</li>
<li>Under the Mode menu, select EAP-TLS</li>
<li>Go back, and under the Identity menu, select the client certificate</li>
<li>Tap Join</li>
</ol>
<hr/>
<h3 id="footnote-how-mobileconfig-files-work">Footnote: How <code>.mobileconfig</code> files work<a href="#footnote-how-mobileconfig-files-work"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<p>So, how does the <code>.mobileconfig</code> file work under the hood? Well, Apple’s configuration profiles are grouped by “payloads” that configure certain parts of the device. For our wifi setup, each profile has three payloads:</p>
<ul>
<li>
<p><strong>Certificate</strong>: This payload is for installing a CA certificate PEM file on the device. In our case, we’re installing the CA that issued our RADIUS server’s certificate.</p>
</li>
<li>
<p><strong>ACME Certificate</strong>: The ACME Certificate payload uses the ACME protocol (this is the same protocol Let’s Encrypt uses, just in a different context) to get a Wi-Fi client certificate from your Smallstep Accounts CA.</p>
<p>The ACME Certificate flow uses Apple’s new Managed Device Attestation feature—and the new ACME <code>device-attest-01</code> challenge type—to get a certificate without any credentials stored in the payload. The basic idea is:</p>
<ul>
<li>The device goes to Apple and gets an Attestation Certificate that includes some identifying information, like its serial number. Note that this certificate uses a private key that is not exportable, offering a third party strong assurances that it is, indeed, talking to the device identified by the attestation certificate.</li>
<li>The device uses the Attestation Certificate and private key to request a Wi-Fi certificate from the Smallstep CA. Smallstep will only issue certificates to devices with serial numbers shown in your Apple Device Collection.</li>
</ul>
</li>
<li>
<p><strong>Wi-Fi</strong>: This configures the network itself, so you can connect with a single tap.</p>
</li>
</ul>
<h3 id="footnote-why-is-nsa-grade-wi-fi-called-192-bit-mode">Footnote: Why is NSA-grade Wi-Fi called &#34;192-bit mode&#34;?<a href="#footnote-why-is-nsa-grade-wi-fi-called-192-bit-mode"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a></h3>
<p>Like many things in the dark art of PKI, this is not at all obvious at first, because none of the cryptographic parameters for this mode mention 192 bits of anything:</p>
<ul>
<li>Certificates must be ECC using elliptic curve secp384r1</li>
<li>Protocol must be TLSV1.2, all others are disabled (in practice, TLS 1.3 seems to work, it just isn’t officially NSA-grade wifi)</li>
<li>Cipher algorithm must be AES-256</li>
<li>Key exchange algorithm must be ECDH</li>
<li>Digital signature algorithm must be ECDSA</li>
<li>Hashing algorithm must be SHA384</li>
<li>Cipher suites allowed for NSA Suite B 192 bit are
<ul>
<li><code>TLS_ECDHE_ECDSA_W_AES_256_CBC_SHA384</code></li>
<li><code>TLS_ECDHE_ECDSA_W_AES_256_GCM_SHA384</code></li>
</ul>
</li>
</ul>
<p>All of this, as Microsoft puts it, will “<a href="https://learn.microsoft.com/en-us/windows-server/networking/technologies/extensible-authentication-protocol/network-access?tabs=eap-tls%2Cserveruserprompt-eap-tls%2Ceap-sim#wpa3-enterprise-192-bit-mode" target="_blank" rel="nofollow noopener noreferrer">provide a minimum of 192 bits of security</a>.” Where “security” means “the amount of effort it would take to gain access.” I’m not sure if that is linear or exponential effort, but I will leave that question alone for now, otherwise this post will never see the light of day.</p>
<p>So, here’s what I think is going on: <a href="https://en.wikipedia.org/wiki/Key_size" target="_blank" rel="nofollow noopener noreferrer">According to Wikipedia</a>, most cryptographic algorithms are designed to have a level of security equal to their key size. But elliptic curve algorithms are different. They have an effective security of roughly half of the key size. So, “192-bits of security” requires at least a 384 bit key size. And, as you can see above, 192-bit mode wifi uses secp384r1, a 384-bit prime field <a href="https://en.wikipedia.org/wiki/Weierstrass_elliptic_function" target="_blank" rel="nofollow noopener noreferrer">Weierstrass elliptic curve</a>.</p>
<hr/>
<p>How did this project go? Did you deploy EAP-TLS on your home network? If so, <a href="https://go.smallstep.com/2023-holiday-project-home#completed-project-form" target="_blank" rel="nofollow noopener noreferrer">tell us your Smallstep team name, and we’ll send some swag your way</a>! We’d love to hear from you.</p>
<p>And if you’re running into issues with this setup, feel free to <a href="https://u.step.sm/discord" target="_blank" rel="nofollow noopener noreferrer">jump in to our Discord community</a>.</p><div><p>Carl Tashian (<a href="https://tashian.com">Website</a>, <a href="https://www.linkedin.com/in/tashian/">LinkedIn</a>) is an engineer, writer, exec coach, and startup all-rounder. He&#39;s currently an Offroad Engineer at Smallstep. He co-founded and built the engineering team at Trove, and he wrote the code that opens your Zipcar. He lives in San Francisco with his wife Siobhan and he loves to play the modular synthesizer 🎛️🎚️</p></div></article></div>
  </body>
</html>
