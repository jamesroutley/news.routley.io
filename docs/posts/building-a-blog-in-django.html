<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://til.simonwillison.net/django/building-a-blog-in-django">Original</a>
    <h1>Building a Blog in Django</h1>
    
    <div id="readability-page-1" class="page">
<nav>
    <p><a href="https://til.simonwillison.net/">Simon Willison’s TILs</a></p>
</nav>
<section>



<p>We launched the <a href="https://www.datasette.cloud/blog/" rel="nofollow">Datasette Cloud blog</a> today. The Datasette Cloud site itself is a Django app - it uses Django and PostgreSQL to manage accounts, teams and soon billing and payments, then launches dedicated containers running Datasette for each customer.</p>
<p>It&#39;s been a while since I&#39;ve built a new blog implementation in Django! I decided to make notes for the next time.</p>
<h2><a id="user-content-features" aria-hidden="true" href="#features"><span aria-hidden="true"></span></a>Features</h2>
<p>Here are the features I consider to be essential for a blog in 2023 (though they haven&#39;t changed much in over a decade):</p>
<ul>
<li>Blog posts have a title, summary, body and publication date. Optional: author information, tags</li>
<li>Posts can be live or draft</li>
<li>The blog index page shows the most recent entries</li>
<li>Older entries are available via some kind of archive mechanism</li>
<li>The blog has an Atom feed</li>
<li>Entries have social media card metadata, to enhance links to them on Mastodon and Twitter</li>
<li>Markdown is a nice-to-have for editing the posts</li>
</ul>
<h2><a id="user-content-the-models" aria-hidden="true" href="#the-models"><span aria-hidden="true"></span></a>The models</h2>
<p>Here&#39;s the Django model for the blog (I generated the first version of this with ChatGPT, then iterated on it):</p>
<div><pre><span>from</span> <span>django</span>.<span>db</span> <span>import</span> <span>models</span>
<span>from</span> <span>django</span>.<span>contrib</span>.<span>auth</span>.<span>models</span> <span>import</span> <span>User</span>
<span>from</span> <span>django</span>.<span>utils</span> <span>import</span> <span>timezone</span>
<span>from</span> <span>django</span>.<span>utils</span>.<span>html</span> <span>import</span> <span>strip_tags</span>
<span>import</span> <span>markdown</span>
<span>from</span> <span>django</span>.<span>utils</span>.<span>html</span> <span>import</span> <span>mark_safe</span>


<span>class</span> <span>Tag</span>(<span>models</span>.<span>Model</span>):
    <span>name</span> <span>=</span> <span>models</span>.<span>CharField</span>(<span>max_length</span><span>=</span><span>50</span>)
    <span>slug</span> <span>=</span> <span>models</span>.<span>SlugField</span>()

    <span>def</span> <span>__str__</span>(<span>self</span>):
        <span>return</span> <span>self</span>.<span>name</span>


<span>class</span> <span>Entry</span>(<span>models</span>.<span>Model</span>):
    <span>title</span> <span>=</span> <span>models</span>.<span>CharField</span>(<span>max_length</span><span>=</span><span>200</span>)
    <span>created</span> <span>=</span> <span>models</span>.<span>DateTimeField</span>(<span>default</span><span>=</span><span>timezone</span>.<span>now</span>)
    <span>slug</span> <span>=</span> <span>models</span>.<span>SlugField</span>()
    <span>summary</span> <span>=</span> <span>models</span>.<span>TextField</span>()
    <span>body</span> <span>=</span> <span>models</span>.<span>TextField</span>()
    <span>card_image</span> <span>=</span> <span>models</span>.<span>URLField</span>(
        <span>blank</span><span>=</span><span>True</span>, <span>null</span><span>=</span><span>True</span>, <span>help_text</span><span>=</span><span>&#34;URL to image for social media cards&#34;</span>
    )
    <span>authors</span> <span>=</span> <span>models</span>.<span>ManyToManyField</span>(<span>User</span>, <span>through</span><span>=</span><span>&#34;Authorship&#34;</span>)
    <span>tags</span> <span>=</span> <span>models</span>.<span>ManyToManyField</span>(<span>Tag</span>, <span>blank</span><span>=</span><span>True</span>)

    <span>is_draft</span> <span>=</span> <span>models</span>.<span>BooleanField</span>(
        <span>default</span><span>=</span><span>False</span>,
        <span>help_text</span><span>=</span><span>&#34;Draft entries do not show in index pages but can be visited directly if you know the URL&#34;</span>,
    )

    <span>class</span> <span>Meta</span>:
        <span>verbose_name_plural</span> <span>=</span> <span>&#34;entries&#34;</span>

    <span>@<span>property</span></span>
    <span>def</span> <span>summary_rendered</span>(<span>self</span>):
        <span>return</span> <span>mark_safe</span>(<span>markdown</span>.<span>markdown</span>(<span>self</span>.<span>summary</span>, <span>output_format</span><span>=</span><span>&#34;html5&#34;</span>))

    <span>@<span>property</span></span>
    <span>def</span> <span>summary_text</span>(<span>self</span>):
        <span>return</span> <span>strip_tags</span>(<span>markdown</span>.<span>markdown</span>(<span>self</span>.<span>summary</span>, <span>output_format</span><span>=</span><span>&#34;html5&#34;</span>))

    <span>@<span>property</span></span>
    <span>def</span> <span>body_rendered</span>(<span>self</span>):
        <span>return</span> <span>mark_safe</span>(<span>markdown</span>.<span>markdown</span>(<span>self</span>.<span>body</span>, <span>output_format</span><span>=</span><span>&#34;html5&#34;</span>))

    <span>def</span> <span>get_absolute_url</span>(<span>self</span>):
        <span>return</span> <span>&#34;/blog/%d/%s/&#34;</span> <span>%</span> (<span>self</span>.<span>created</span>.<span>year</span>, <span>self</span>.<span>slug</span>)

    <span>def</span> <span>__str__</span>(<span>self</span>):
        <span>return</span> <span>self</span>.<span>title</span>


<span>class</span> <span>Authorship</span>(<span>models</span>.<span>Model</span>):
    <span>user</span> <span>=</span> <span>models</span>.<span>ForeignKey</span>(<span>User</span>, <span>on_delete</span><span>=</span><span>models</span>.<span>CASCADE</span>)
    <span>entry</span> <span>=</span> <span>models</span>.<span>ForeignKey</span>(<span>Entry</span>, <span>on_delete</span><span>=</span><span>models</span>.<span>CASCADE</span>)
    <span>order</span> <span>=</span> <span>models</span>.<span>PositiveIntegerField</span>(<span>default</span><span>=</span><span>0</span>)

    <span>class</span> <span>Meta</span>:
        <span>ordering</span> <span>=</span> [<span>&#34;order&#34;</span>]</pre></div>
<p>It&#39;s pretty self-explanatory. The most interesting features are the <code>is_draft</code> flag and the way it provides <code>.summary_rendered</code> and <code>.body_rendered</code> properties that return Markdown rendered as HTML.</p>
<p>The URL format for this blog is <code>/blog/2023/welcome/</code> - in my experience name-spacing posts by year makes the most sense, since even the most active blogs usually only have a few posts every month.</p>
<h2><a id="user-content-the-views" aria-hidden="true" href="#the-views"><span aria-hidden="true"></span></a>The views</h2>
<p>Here are the view functions defined the <code>views.py</code> module for my <code>blog/</code> application:</p>
<div><pre><span>from</span> <span>django</span>.<span>contrib</span>.<span>syndication</span>.<span>views</span> <span>import</span> <span>Feed</span>
<span>from</span> <span>django</span>.<span>shortcuts</span> <span>import</span> <span>render</span>, <span>get_object_or_404</span>
<span>from</span> <span>django</span>.<span>utils</span>.<span>feedgenerator</span> <span>import</span> <span>Atom1Feed</span>
<span>from</span> .<span>models</span> <span>import</span> <span>Entry</span>, <span>Tag</span>

<span>ENTRIES_ON_HOMEPAGE</span> <span>=</span> <span>5</span>


<span>def</span> <span>index</span>(<span>request</span>):
    <span>entries</span> <span>=</span> <span>list</span>(
        <span>Entry</span>.<span>objects</span>.<span>filter</span>(<span>is_draft</span><span>=</span><span>False</span>).<span>order_by</span>(<span>&#34;-created&#34;</span>)[
            : <span>ENTRIES_ON_HOMEPAGE</span> <span>+</span> <span>1</span>
        ]
    )
    <span>has_more</span> <span>=</span> <span>False</span>
    <span>if</span> <span>len</span>(<span>entries</span>) <span>&gt;</span> <span>ENTRIES_ON_HOMEPAGE</span>:
        <span>has_more</span> <span>=</span> <span>True</span>
        <span>entries</span> <span>=</span> <span>entries</span>[:<span>ENTRIES_ON_HOMEPAGE</span>]
    <span>return</span> <span>render</span>(
        <span>request</span>, <span>&#34;blog/index.html&#34;</span>, {<span>&#34;entries&#34;</span>: <span>entries</span>, <span>&#34;has_more&#34;</span>: <span>has_more</span>}
    )


<span>def</span> <span>entry</span>(<span>request</span>, <span>year</span>, <span>slug</span>):
    <span>entry</span> <span>=</span> <span>get_object_or_404</span>(<span>Entry</span>, <span>created__year</span><span>=</span><span>year</span>, <span>slug</span><span>=</span><span>slug</span>)
    <span>return</span> <span>render</span>(
        <span>request</span>,
        <span>&#34;blog/entry.html&#34;</span>,
        {<span>&#34;entry&#34;</span>: <span>entry</span>},
    )


<span>def</span> <span>year</span>(<span>request</span>, <span>year</span>):
    <span>entries</span> <span>=</span> <span>Entry</span>.<span>objects</span>.<span>filter</span>(<span>created__year</span><span>=</span><span>year</span>, <span>is_draft</span><span>=</span><span>False</span>).<span>order_by</span>(
        <span>&#34;-created&#34;</span>
    )
    <span>return</span> <span>render</span>(<span>request</span>, <span>&#34;blog/year.html&#34;</span>, {<span>&#34;entries&#34;</span>: <span>entries</span>, <span>&#34;year&#34;</span>: <span>year</span>})


<span>def</span> <span>archive</span>(<span>request</span>):
    <span>entries</span> <span>=</span> <span>Entry</span>.<span>objects</span>.<span>filter</span>(<span>is_draft</span><span>=</span><span>False</span>).<span>order_by</span>(<span>&#34;-created&#34;</span>)
    <span>return</span> <span>render</span>(<span>request</span>, <span>&#34;blog/archive.html&#34;</span>, {<span>&#34;entries&#34;</span>: <span>entries</span>})


<span>def</span> <span>tag</span>(<span>request</span>, <span>slug</span>):
    <span>tag</span> <span>=</span> <span>Tag</span>.<span>objects</span>.<span>get</span>(<span>slug</span><span>=</span><span>slug</span>)
    <span>entries</span> <span>=</span> <span>tag</span>.<span>entry_set</span>.<span>filter</span>(<span>is_draft</span><span>=</span><span>False</span>).<span>order_by</span>(<span>&#34;-created&#34;</span>)
    <span>return</span> <span>render</span>(<span>request</span>, <span>&#34;blog/tag.html&#34;</span>, {<span>&#34;tag&#34;</span>: <span>tag</span>, <span>&#34;entries&#34;</span>: <span>entries</span>})</pre></div>
<h2><a id="user-content-the-atom-feed" aria-hidden="true" href="#the-atom-feed"><span aria-hidden="true"></span></a>The Atom feed</h2>
<p>The most interesting part of the <code>views.py</code> file is this bit - defining the Atom feed:</p>
<div><pre><span>class</span> <span>BlogFeed</span>(<span>Feed</span>):
    <span>title</span> <span>=</span> <span>&#34;Datasette Cloud&#34;</span>
    <span>link</span> <span>=</span> <span>&#34;/blog/&#34;</span>
    <span>feed_type</span> <span>=</span> <span>Atom1Feed</span>

    <span>def</span> <span>items</span>(<span>self</span>):
        <span>return</span> <span>Entry</span>.<span>objects</span>.<span>filter</span>(<span>is_draft</span><span>=</span><span>False</span>).<span>order_by</span>(<span>&#34;-created&#34;</span>)[:<span>5</span>]

    <span>def</span> <span>item_title</span>(<span>self</span>, <span>item</span>):
        <span>return</span> <span>item</span>.<span>title</span>

    <span>def</span> <span>item_description</span>(<span>self</span>, <span>item</span>):
        <span>return</span> <span>item</span>.<span>summary_rendered</span> <span>+</span> <span>&#34;<span>\n</span>&#34;</span> <span>+</span> <span>item</span>.<span>body_rendered</span>

    <span>def</span> <span>item_link</span>(<span>self</span>, <span>item</span>):
        <span>return</span> <span>&#34;/blog/%d/%s/&#34;</span> <span>%</span> (<span>item</span>.<span>created</span>.<span>year</span>, <span>item</span>.<span>slug</span>)

    <span>def</span> <span>item_author_name</span>(<span>self</span>, <span>item</span>):
        <span>return</span> (
            <span>&#34;, &#34;</span>.<span>join</span>([<span>a</span>.<span>get_full_name</span>() <span>or</span> <span>str</span>(<span>a</span>) <span>for</span> <span>a</span> <span>in</span> <span>item</span>.<span>authors</span>.<span>all</span>()]) <span>or</span> <span>None</span>
        )

    <span>def</span> <span>get_feed</span>(<span>self</span>, <span>obj</span>, <span>request</span>):
        <span>feedgen</span> <span>=</span> <span>super</span>().<span>get_feed</span>(<span>obj</span>, <span>request</span>)
        <span>feedgen</span>.<span>content_type</span> <span>=</span> <span>&#34;application/xml; charset=utf-8&#34;</span>
        <span>return</span> <span>feedgen</span></pre></div>
<p>This is using the <a href="https://docs.djangoproject.com/en/4.2/ref/contrib/syndication/" rel="nofollow">Django syndication feed framework</a>. The resulting Atom feed can be found here:</p>
<p><a href="https://www.datasette.cloud/blog/feed/" rel="nofollow">https://www.datasette.cloud/blog/feed/</a></p>
<p>There&#39;s one extra trick here: I&#39;m over-riding the default <code>content-type</code> header and setting it to <code>&#34;application/xml; charset=utf-8</code>.</p>
<p>Django defaults to using <code>application/atom+xml; charset=utf-8</code> which is correct... but causes most browsers to trigger a download rather than rendering the XML in the browser directly.</p>
<p>I like to be able to click on a feed link and see the XML before I paste the URL into my feed reader software, so I prefer to use <code>application/xml</code> instead.</p>
<h2><a id="user-content-social-media-cards" aria-hidden="true" href="#social-media-cards"><span aria-hidden="true"></span></a>Social media cards</h2>
<p>It&#39;s easy to forget these, but they&#39;re really important - with the right markup links to posts shared on Mastodon, Twitter, LinkedIn and Facebook will look MUCH better.</p>
<p>Here&#39;s a snipet from my <code>entry.html</code> template:</p>
<div><pre><span>{%</span> <span>block</span> <span>extra_head</span> <span>%}</span>
<span>{%</span> <span>if</span> <span>entry</span>.<span>card_image</span> <span>%}</span>
&lt;<span>meta</span> <span>name</span>=<span><span>&#34;</span>twitter:card<span>&#34;</span></span> <span>content</span>=<span><span>&#34;</span>summary_large_image<span>&#34;</span></span>&gt;
&lt;<span>meta</span> <span>name</span>=<span><span>&#34;</span>twitter:image<span>&#34;</span></span> <span>content</span>=<span><span>&#34;</span>{{ entry.card_image }}<span>&#34;</span></span>&gt;
<span>{%</span> <span>else</span> <span>%}</span>
&lt;<span>meta</span> <span>name</span>=<span><span>&#34;</span>twitter:card<span>&#34;</span></span> <span>content</span>=<span><span>&#34;</span>summary<span>&#34;</span></span>&gt;
<span>{%</span> <span>endif</span> <span>%}</span>
&lt;<span>meta</span> <span>name</span>=<span><span>&#34;</span>twitter:creator<span>&#34;</span></span> <span>content</span>=<span><span>&#34;</span>@datasetteproj<span>&#34;</span></span>&gt;
&lt;<span>meta</span> <span>property</span>=<span><span>&#34;</span>og:url<span>&#34;</span></span> <span>content</span>=<span><span>&#34;</span>https://www.datasette.cloud{{ request.path }}<span>&#34;</span></span>&gt;
&lt;<span>meta</span> <span>property</span>=<span><span>&#34;</span>og:title<span>&#34;</span></span> <span>content</span>=<span><span>&#34;</span>{{ entry.title }} - Datasette Cloud<span>&#34;</span></span>&gt;
<span>{%</span> <span>if</span> <span>entry</span>.<span>card_image</span> <span>%}</span>&lt;<span>meta</span> <span>property</span>=<span><span>&#34;</span>og:image<span>&#34;</span></span> <span>content</span>=<span><span>&#34;</span>{{ entry.card_image }}<span>&#34;</span></span>&gt;<span>{%</span> <span>endif</span> <span>%}</span>
&lt;<span>meta</span> <span>property</span>=<span><span>&#34;</span>og:type<span>&#34;</span></span> <span>content</span>=<span><span>&#34;</span>article<span>&#34;</span></span>&gt;
&lt;<span>meta</span> <span>property</span>=<span><span>&#34;</span>og:description<span>&#34;</span></span> <span>content</span>=<span><span>&#34;</span>{{ entry.summary_text }}<span>&#34;</span></span>&gt;
<span>{%</span> <span>if</span> <span>entry</span>.<span>is_draft</span> <span>%}</span>
&lt;<span>meta</span> <span>name</span>=<span><span>&#34;</span>robots<span>&#34;</span></span> <span>content</span>=<span><span>&#34;</span>noindex<span>&#34;</span></span>&gt;
<span>{%</span> <span>endif</span> <span>%}</span>
<span>{%</span> <span>endblock</span> <span>%}</span></pre></div>
<p>There&#39;s one other detail in there: if an entry is a draft entry I serve <code>&lt;meta name=&#34;robots&#34; content=&#34;noindex&#34;&gt;</code> to prevent it from being accidentally indexed by search engines.</p>
<h2><a id="user-content-url-configuration" aria-hidden="true" href="#url-configuration"><span aria-hidden="true"></span></a>URL configuration</h2>
<p>Here&#39;s the URL configuration from <code>urls.py</code>:</p>
<div><pre>    <span># Blog</span>
    <span>path</span>(<span>&#34;blog/&#34;</span>, <span>blog_views</span>.<span>index</span>),
    <span>path</span>(<span>&#34;blog/&lt;int:year&gt;/&lt;slug:slug&gt;/&#34;</span>, <span>blog_views</span>.<span>entry</span>),
    <span>path</span>(<span>&#34;blog/archive/&#34;</span>, <span>blog_views</span>.<span>archive</span>),
    <span>path</span>(<span>&#34;blog/&lt;int:year&gt;/&#34;</span>, <span>blog_views</span>.<span>year</span>),
    <span>path</span>(<span>&#34;blog/tag/&lt;slug:slug&gt;/&#34;</span>, <span>blog_views</span>.<span>tag</span>),
    <span>path</span>(<span>&#34;blog/feed/&#34;</span>, <span>blog_views</span>.<span>BlogFeed</span>()),</pre></div>
<h2><a id="user-content-tests" aria-hidden="true" href="#tests"><span aria-hidden="true"></span></a>Tests</h2>
<p>I added a quick suite of tests, mainly to check that <code>is_draft</code> was working correctly but also to ensure the Atom feed works.</p>
<p>Testing the feed was particularly important because it&#39;s at the highest risk of accidentally breaking without me noticing it - errors that affect the HTML of the blog are much more obvious.</p>
<div><pre><span>import</span> <span>pytest</span>
<span>from</span> <span>datetime</span> <span>import</span> <span>datetime</span>
<span>from</span> <span>django</span>.<span>contrib</span>.<span>auth</span>.<span>models</span> <span>import</span> <span>User</span>
<span>from</span> <span>django</span>.<span>utils</span> <span>import</span> <span>timezone</span>
<span>from</span> <span>blog</span>.<span>models</span> <span>import</span> <span>Entry</span>, <span>Tag</span>
<span>from</span> <span>xml</span>.<span>etree</span> <span>import</span> <span>ElementTree</span> <span>as</span> <span>ET</span>


<span>@<span>pytest</span>.<span>fixture</span></span>
<span>def</span> <span>client</span>():
    <span>from</span> <span>django</span>.<span>test</span> <span>import</span> <span>Client</span>

    <span>return</span> <span>Client</span>()


<span>@<span>pytest</span>.<span>fixture</span></span>
<span>def</span> <span>five_entries</span>():
    <span>author</span> <span>=</span> <span>User</span>.<span>objects</span>.<span>create_user</span>(<span>username</span><span>=</span><span>&#34;author&#34;</span>)
    <span>all</span> <span>=</span> <span>Tag</span>.<span>objects</span>.<span>get_or_create</span>(<span>name</span><span>=</span><span>&#34;All&#34;</span>, <span>slug</span><span>=</span><span>&#34;all&#34;</span>)[<span>0</span>]
    <span>entries</span> <span>=</span> []
    <span>for</span> <span>i</span> <span>in</span> <span>range</span>(<span>5</span>):
        <span>i</span> <span>+=</span> <span>1</span>
        <span>entry</span> <span>=</span> <span>Entry</span>.<span>objects</span>.<span>create</span>(
            <span>title</span><span>=</span><span>f&#34;Test Entry <span><span>{</span><span>i</span><span>}</span></span>&#34;</span>,
            <span>slug</span><span>=</span><span>f&#34;test-entry-<span><span>{</span><span>i</span><span>}</span></span>&#34;</span>,
            <span>created</span><span>=</span><span>timezone</span>.<span>make_aware</span>(<span>datetime</span>(<span>2023</span>, <span>5</span>, <span>i</span>), <span>timezone</span>.<span>utc</span>),
            <span>summary</span><span>=</span><span>f&#34;This is test entry <span><span>{</span><span>i</span><span>}</span></span>&#34;</span>,
            <span>body</span><span>=</span><span>f&#34;This is the body of test entry <span><span>{</span><span>i</span><span>}</span></span>.&#34;</span>,
            <span>is_draft</span><span>=</span><span>i</span> <span>==</span> <span>1</span>,
        )
        <span>entry</span>.<span>authors</span>.<span>add</span>(<span>author</span>)
        <span>entry</span>.<span>tags</span>.<span>add</span>(<span>all</span>)
        <span>entries</span>.<span>append</span>(<span>entry</span>)

    <span>return</span> <span>entries</span>


<span>@<span>pytest</span>.<span>mark</span>.<span>django_db</span></span>
<span>def</span> <span>test_index_page</span>(<span>client</span>, <span>five_entries</span>):
    <span>response</span> <span>=</span> <span>client</span>.<span>get</span>(<span>&#34;/blog/&#34;</span>)
    <span>html</span> <span>=</span> <span>response</span>.<span>content</span>.<span>decode</span>(<span>&#34;utf-8&#34;</span>)

    <span># Should have five entries without a more link</span>
    <span>for</span> <span>i</span> <span>in</span> <span>range</span>(<span>5</span>):
        <span>i</span> <span>+=</span> <span>1</span>
        <span>if</span> <span>i</span> <span>==</span> <span>1</span>:
            <span># It&#39;s the draft one</span>
            <span>assert</span> <span>f&#34;Test Entry <span><span>{</span><span>i</span><span>}</span></span>&#34;</span> <span>not</span> <span>in</span> <span>html</span>
            <span>assert</span> <span>f&#34;This is test entry <span><span>{</span><span>i</span><span>}</span></span>&#34;</span> <span>not</span> <span>in</span> <span>html</span>
        <span>else</span>:
            <span>assert</span> <span>f&#34;Test Entry <span><span>{</span><span>i</span><span>}</span></span>&#34;</span> <span>in</span> <span>html</span>
            <span>assert</span> <span>f&#34;This is test entry <span><span>{</span><span>i</span><span>}</span></span>&#34;</span> <span>in</span> <span>html</span>
    <span>assert</span> <span>&#34;Older entries&#34;</span> <span>not</span> <span>in</span> <span>html</span>

    <span># Add two more entries to get a more link</span>
    <span>Entry</span>.<span>objects</span>.<span>create</span>(
        <span>title</span><span>=</span><span>&#34;Test Entry 6&#34;</span>, <span>slug</span><span>=</span><span>&#34;test-entry-6&#34;</span>, <span>summary</span><span>=</span><span>&#34;.&#34;</span>, <span>body</span><span>=</span><span>&#34;.&#34;</span>
    )
    <span>Entry</span>.<span>objects</span>.<span>create</span>(
        <span>title</span><span>=</span><span>&#34;Test Entry 7&#34;</span>, <span>slug</span><span>=</span><span>&#34;test-entry-7&#34;</span>, <span>summary</span><span>=</span><span>&#34;.&#34;</span>, <span>body</span><span>=</span><span>&#34;.&#34;</span>
    )
    <span>response2</span> <span>=</span> <span>client</span>.<span>get</span>(<span>&#34;/blog/&#34;</span>)
    <span>html2</span> <span>=</span> <span>response2</span>.<span>content</span>.<span>decode</span>(<span>&#34;utf-8&#34;</span>)
    <span>assert</span> <span>&#34;Older entries&#34;</span> <span>in</span> <span>html2</span>


<span>@<span>pytest</span>.<span>mark</span>.<span>django_db</span></span>
<span>def</span> <span>test_entry_page</span>(<span>client</span>, <span>five_entries</span>):
    <span># Test a draft and a not-draft one</span>
    <span>draft_entry</span> <span>=</span> <span>five_entries</span>[<span>0</span>]
    <span>not_draft_entry</span> <span>=</span> <span>five_entries</span>[<span>1</span>]
    <span>for</span> <span>entry</span>, <span>should_be_draft</span> <span>in</span> (
        (<span>draft_entry</span>, <span>True</span>),
        (<span>not_draft_entry</span>, <span>False</span>),
    ):
        <span>response</span> <span>=</span> <span>client</span>.<span>get</span>(<span>f&#34;/blog/<span><span>{</span><span>entry</span>.<span>created</span>.<span>year</span><span>}</span></span>/<span><span>{</span><span>entry</span>.<span>slug</span><span>}</span></span>/&#34;</span>)
        <span>html</span> <span>=</span> <span>response</span>.<span>content</span>.<span>decode</span>(<span>&#34;utf-8&#34;</span>)

        <span># Check that each entry&#39;s title and body are present on their respective page</span>
        <span>assert</span> <span>entry</span>.<span>title</span> <span>in</span> <span>html</span>
        <span>assert</span> <span>entry</span>.<span>body</span> <span>in</span> <span>html</span>

        <span>if</span> <span>should_be_draft</span>:
            <span>assert</span> <span>&#34;(draft)&#34;</span> <span>in</span> <span>html</span>
            <span>assert</span> <span>&#39;&lt;meta name=&#34;robots&#34; content=&#34;noindex&#34;&gt;&#39;</span> <span>in</span> <span>html</span>
        <span>else</span>:
            <span>assert</span> <span>&#34;(draft)&#34;</span> <span>not</span> <span>in</span> <span>html</span>
            <span>assert</span> <span>&#39;&lt;meta name=&#34;robots&#34; content=&#34;noindex&#34;&gt;&#39;</span> <span>not</span> <span>in</span> <span>html</span>


<span>@<span>pytest</span>.<span>mark</span>.<span>django_db</span></span>
<span>@<span>pytest</span>.<span>mark</span>.<span>parametrize</span>(</span>
<span>    <span>&#34;path&#34;</span>, (<span>&#34;/blog/&#34;</span>, <span>&#34;/blog/archive/&#34;</span>, <span>&#34;/blog/2023/&#34;</span>, <span>&#34;/blog/tag/all/&#34;</span>)</span>
<span>)</span>
<span>def</span> <span>test_draft_entry_not_visible</span>(<span>client</span>, <span>five_entries</span>, <span>path</span>):
    <span>draft_entry</span> <span>=</span> <span>five_entries</span>[<span>0</span>]
    <span>assert</span> <span>draft_entry</span>.<span>title</span> <span>==</span> <span>&#34;Test Entry 1&#34;</span>
    <span># It should not be on any of the pages</span>
    <span>response</span> <span>=</span> <span>client</span>.<span>get</span>(<span>path</span>)
    <span>html</span> <span>=</span> <span>response</span>.<span>content</span>.<span>decode</span>(<span>&#34;utf-8&#34;</span>)
    <span>assert</span> <span>draft_entry</span>.<span>title</span> <span>not</span> <span>in</span> <span>html</span>


<span>@<span>pytest</span>.<span>mark</span>.<span>django_db</span></span>
<span>def</span> <span>test_atom_feed</span>(<span>client</span>, <span>five_entries</span>):
    <span>response</span> <span>=</span> <span>client</span>.<span>get</span>(<span>&#34;/blog/feed/&#34;</span>)
    <span>assert</span> <span>response</span>.<span>status_code</span> <span>==</span> <span>200</span>
    <span>assert</span> <span>response</span>[<span>&#34;Content-Type&#34;</span>] <span>==</span> <span>&#34;application/xml; charset=utf-8&#34;</span>
    <span>xml</span> <span>=</span> <span>response</span>.<span>content</span>.<span>decode</span>(<span>&#34;utf-8&#34;</span>)
    <span>et</span> <span>=</span> <span>ET</span>.<span>fromstring</span>(<span>xml</span>)
    <span>assert</span> <span>&#34;&lt;title&gt;Datasette Cloud&lt;/title&gt;&#34;</span> <span>in</span> <span>xml</span>
    <span>expected_entries</span> <span>=</span> [<span>e</span> <span>for</span> <span>e</span> <span>in</span> <span>five_entries</span> <span>if</span> <span>not</span> <span>e</span>.<span>is_draft</span>]
    <span>assert</span> <span>len</span>(<span>expected_entries</span>) <span>==</span> <span>4</span>
    <span>expected_entries</span>.<span>sort</span>(<span>key</span><span>=</span><span>lambda</span> <span>e</span>: <span>e</span>.<span>created</span>, <span>reverse</span><span>=</span><span>True</span>)
    <span># Should have the non-draft entries</span>
    <span>entries</span> <span>=</span> <span>et</span>.<span>findall</span>(<span>&#34;{http://www.w3.org/2005/Atom}entry&#34;</span>)
    <span>assert</span> <span>len</span>(<span>entries</span>) <span>==</span> <span>4</span>
    <span>for</span> <span>xml_entry</span>, <span>entry</span> <span>in</span> <span>zip</span>(<span>entries</span>, <span>expected_entries</span>):
        <span>assert</span> <span>xml_entry</span>.<span>find</span>(<span>&#34;{http://www.w3.org/2005/Atom}title&#34;</span>).<span>text</span> <span>==</span> <span>entry</span>.<span>title</span>
        <span>assert</span> (
            <span>xml_entry</span>.<span>find</span>(<span>&#34;{http://www.w3.org/2005/Atom}link&#34;</span>).<span>attrib</span>[<span>&#34;href&#34;</span>]
            <span>==</span> <span>f&#34;http://testserver/blog/<span><span>{</span><span>entry</span>.<span>created</span>.<span>year</span><span>}</span></span>/<span><span>{</span><span>entry</span>.<span>slug</span><span>}</span></span>/&#34;</span>
        )
        <span>assert</span> (
            <span>xml_entry</span>.<span>find</span>(
                <span>&#34;{http://www.w3.org/2005/Atom}author/{http://www.w3.org/2005/Atom}name&#34;</span>
            ).<span>text</span>
            <span>==</span> <span>&#34;author&#34;</span>
        )</pre></div>
<h2><a id="user-content-the-finished-blog" aria-hidden="true" href="#the-finished-blog"><span aria-hidden="true"></span></a>The finished blog</h2>
<p>Check it out at <a href="https://www.datasette.cloud/blog/" rel="nofollow">https://www.datasette.cloud/blog/</a></p>
<p>Consider the code snippets in this TIL licensed under <a href="https://opensource.org/license/apache-2-0/" rel="nofollow">Apache License, Version 2.0</a>.</p>




  <h3>Related</h3>
  


<p>Created 2023-08-15T09:58:48-07:00 · <a href="https://github.com/simonw/til/blob/main/django/building-a-blog-in-django.md">Edit</a></p>



</section>

</div>
  </body>
</html>
