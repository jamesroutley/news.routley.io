<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://highertier.com/we-fixed-f-string-typos-in-69-of-the-most-popular-python-repos-in-only-one-day-heres-how/">Original</a>
    <h1>We fixed f-string bugs in 69 of the most popular Python repos in only 1 day</h1>
    
    <div id="readability-page-1" class="page"><div id="content">

	<section id="primary">
		<main id="main" role="main">

			
<article id="post-74" class="page">

	

	<div>
		
<figure><a href="https://highertierdotcom.files.wordpress.com/2022/04/probablymeantfstring.png"><img data-attachment-id="81" data-permalink="https://highertier.com/probablymeantfstring/" data-orig-file="https://highertierdotcom.files.wordpress.com/2022/04/probablymeantfstring.png" data-orig-size="869,383" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="probablymeantfstring" data-image-description="" data-image-caption="" data-medium-file="https://highertierdotcom.files.wordpress.com/2022/04/probablymeantfstring.png?w=300" data-large-file="https://highertierdotcom.files.wordpress.com/2022/04/probablymeantfstring.png?w=782" src="https://highertierdotcom.files.wordpress.com/2022/04/probablymeantfstring.png?w=869" alt="" srcset="https://highertierdotcom.files.wordpress.com/2022/04/probablymeantfstring.png 869w, https://highertierdotcom.files.wordpress.com/2022/04/probablymeantfstring.png?w=150 150w, https://highertierdotcom.files.wordpress.com/2022/04/probablymeantfstring.png?w=300 300w, https://highertierdotcom.files.wordpress.com/2022/04/probablymeantfstring.png?w=768 768w" sizes="(max-width: 869px) 100vw, 869px"/></a></figure>



<h3>tl;dr</h3>



<p>We found that 10% of the 666 most popular Python open source GitHub repositories had the following f-string typo bugs:</p>



<ul><li><code>f</code> prefix was missing:<code>&#34;hello {name}&#34;</code>instead of <code>f&#34;hello {name}&#34;</code> .</li><li><code>f</code> prefix was written <em>inside</em> the string: <code>&#34;fhello {name}&#34;</code>instead of <code>f&#34;hello {name}&#34;</code> . We even saw an example of <code>&#34;hello f{name}&#34;</code> .</li><li>Concatenated strings used the <code>f</code> prefix on only the first string: <code>f&#34;hello {name}&#34; + &#34;do you like {food}?&#34;</code> instead of <code>f&#34;hello {name}&#34; + f&#34;do you like {food}?</code>“.</li></ul>



<p>We fixed the problems we found in 69 of the most popular open source Python repositories — repositories you probably know and might even use. At the bottom of this page is a list of the GitHub pull requests we created but for the sake of summary some were Tensorflow, Celery, Ansible, DALI, Salt, Matplotlib, Numpy, Plotly, Pandas, Black, readthedocs.org, Scipy, PyTorch, rich, and some repositories from Microsoft, Robinhood, Mozilla, and AWS.</p>



<h3>What is f-string interpolation?</h3>



<p><em>Literal String Interpolation</em> aka f<em>-strings</em> (because of the leading character preceding the string literal) were introduced by <a href="https://docs.python.org/3/whatsnew/3.6.html#whatsnew36-pep498" rel="noreferrer noopener" target="_blank">PEP 498</a>. String interpolation is meant to be simpler with f-strings. “<em>meant” is </em>foreshadowing.</p>



<p>Prefix a string with the letter “ f ” and it’s now an f-string:</p>



<figure><div>
<div id="gist115945242">
    <div translate="no">
      <div>
        <div>
  <div id="file-f_string_example-py">
    
    <div itemprop="text">

        
<div>

  <template>
  <div data-view-component="true">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
  
    <p><span>
      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span></p>
</div></template>
<template>
  <span aria-label="This line has hidden Unicode characters" data-view-component="true">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
</span></template>

  
</div>


    </div>

  </div>
</div>

      </div>
      
    </div>
</div>

</div></figure>



<h3>The mistakes/bugs/issues</h3>



<p>We checked 666 most popular Python open source repositories on GitHub and found 10% of them had three types of f-string bugs, all of which broke the formatting leading to the value of the interpolated variable not being included in the string when evaluated at runtime.</p>



<p><strong>Mistake 1: Missing f prefix</strong></p>



<p>This was the most common case we found, and occurred mostly during logging and raising exceptions. This makes sense because logging and exception raising is a common use case for printing variable values into string messages. Take this example from <a href="https://github.com/pymc-devs/pymc/blob/d322f75c0b23b27c4d08e00d5e53762e0a6d7743/pymc/data.py#L464" rel="noreferrer noopener" target="_blank">pymc</a>:</p>



<figure><div>
<div id="gist115945230">
    <div translate="no">
      <div>
        <div>
  <div id="file-missing_f_string_pymc-py">
    
    <div itemprop="text">

        
<div>

  <template>
  <div data-view-component="true">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
  
    <p><span>
      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span></p>
</div></template>
<template>
  <span aria-label="This line has hidden Unicode characters" data-view-component="true">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
</span></template>

  
</div>


    </div>

  </div>
</div>

      </div>
      
    </div>
</div>

</div></figure>



<p>Some developer debugging that TypeError is not going to have a great time as they will not immediately know what b equals due to the missing <code>f</code> prefix.</p>



<p><strong>Mistake 2: accidentally including f <em>inside</em> the string</strong></p>



<p>This is probably the hardest for a code reviewer to spot because if we give the code a cursory look before quickly typing “LGTM!” we can see there is an <code>f</code> at the start of the string. Take this example from <a href="https://github.com/QuantConnect/Lean/blob/fc008fe906f9f3ae1b5a2e2b431ecf8739bd34f4/Algorithm.Python/Alphas/GasAndCrudeOilEnergyCorrelationAlpha.py#L155" rel="noreferrer noopener" target="_blank">Lean</a>, would you spot it the f in the wrong place?</p>



<figure><div>
<div id="gist115945213">
    <div translate="no">
      <div>
        <div>
  <div id="file-missing_f_string_lean-py">
    
    <div itemprop="text">

        
<div>

  <template>
  <div data-view-component="true">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
  
    <p><span>
      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span></p>
</div></template>
<template>
  <span aria-label="This line has hidden Unicode characters" data-view-component="true">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
</span></template>

  
</div>


    </div>

  </div>
</div>

      </div>
      
    </div>
</div>

</div></figure>



<p>Or this problem in <a href="https://github.com/keras-team/keras/blob/aea9728313bcaa8262774699c21976288171b209/keras/saving/utils_v1/signature_def_utils.py#L61" rel="noreferrer noopener" target="_blank">Keras</a>?</p>



<figure><div>
<div id="gist115945194">
    <div translate="no">
      <div>
        <div>
  <div id="file-missing_f_string_keras-py">
    
    <div itemprop="text">

        
<div>

  <template>
  <div data-view-component="true">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
  
    <p><span>
      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span></p>
</div></template>
<template>
  <span aria-label="This line has hidden Unicode characters" data-view-component="true">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
</span></template>

  
</div>


    </div>

  </div>
</div>

      </div>
      
    </div>
</div>

</div></figure>



<p>Or this one from <a href="https://github.com/buildbot/buildbot/blob/25e4a5d12acebb90b5bf557c17ae8b5457a60199/master/buildbot/process/measured_service.py#L28" rel="noreferrer noopener" target="_blank">Buildbot</a></p>



<figure><div>
<div id="gist115945186">
    <div translate="no">
      <div>
        <div>
  <div id="file-missing_f_string_buildbot-py">
    
    <div itemprop="text">

        
<div>

  <template>
  <div data-view-component="true">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
  
    <p><span>
      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span></p>
</div></template>
<template>
  <span aria-label="This line has hidden Unicode characters" data-view-component="true">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
</span></template>

  
</div>


    </div>

  </div>
</div>

      </div>
      
    </div>
</div>

</div></figure>



<p>Many developers would not notice this during code review because this is a type of error humans are bad at spotting. Humans often see what they expect to see, not what is really there. That’s what makes static analysis checkers so important, especially <a href="https://github.com/marketplace/django-doctor/" rel="noreferrer noopener" target="_blank">ones that can also suggest the fix</a> like so:</p>



<figure><img src="https://highertierdotcom.files.wordpress.com/2022/04/475bf-1bn9s3djqadtxzyo7vorapq.png" alt=""/></figure>



<p>This highlights that for manual processes like code review to detect 100% of bugs 100% of the time then 100% of humans must perform 100% perfectly during code review 100% of the time. See the cognitive dissonance? We do code review because we expect human error when writing the code, but then expect no human error when reviewing the code. This dissonance results in bugs being committed.</p>



<p><strong>Mistake 3: f-string concatenation</strong></p>



<p>During concatenation only the first string is prefixed with <code>f</code> . In this example from <a href="https://github.com/tensorflow/tensorflow/blob/0b3652d2b01df6ece32cf4be1909eaa0043106a8/tensorflow/python/ops/critical_section_ops.py#L196" rel="noreferrer noopener" target="_blank">Tensorflow</a> the second string in the concatenation is missing the f prefix:</p>



<figure><div>
<div id="gist115945177">
    <div translate="no">
      <div>
        <div>
  <div id="file-missing_f_string_concatenation-py">
    
    <div itemprop="text">

        
<div>

  <template>
  <div data-view-component="true">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
  
    <p><span>
      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span></p>
</div></template>
<template>
  <span aria-label="This line has hidden Unicode characters" data-view-component="true">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
</span></template>

  
</div>


    </div>

  </div>
</div>

      </div>
      
    </div>
</div>

</div></figure>



<p>This type of f-string bug is perhaps the most interesting because a pattern emerges when we look at all of the example of this issue:</p>



<ol><li>The first string in the concatenation is correctly prefixed with <code>f</code> .</li><li>The second string is not prefixed with <code>f</code>.</li></ol>



<p>We may be looking too deep into this but it seems like many developers think when string concatenation occurs it’s enough to declare the first string as an f-string and the other strings are turned into f-strings by osmosis. It doesn’t. We’re not suggesting this is the case for all developers that accidentally did this error, but interesting nonetheless.</p>



<h3><strong>The impact of f-string bugs</strong></h3>



<p>Based on the 666 repositories we checked, broken string interpolation due to typos most commonly occurs during logging, exception raising, and during unit testing. This therefore impacts confidence in the proper functioning of the code, and also impacts developer efficiencies when debugging.</p>



<p><strong>f-string mistakes during logging</strong></p>



<p>Bad string interpolation during logging means the information the code author intended to express will not actually be available to the developer trying to debug the code. For example see this code taken from <a href="https://github.com/celery/celery/blob/969e36a8d6823dff88fce2669cfcb59de7275a3d/celery/backends/dynamodb.py#L131" rel="noreferrer noopener" target="_blank">Celery</a>:</p>



<figure><div>
<div id="gist115945158">
    <div translate="no">
      <div>
        <div>
  <div id="file-missing_f_string_celery-py">
    
    <div itemprop="text">

        
<div>

  <template>
  <div data-view-component="true">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
  
    <p><span>
      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span></p>
</div></template>
<template>
  <span aria-label="This line has hidden Unicode characters" data-view-component="true">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
</span></template>

  
</div>


    </div>

  </div>
</div>

      </div>
      
    </div>
</div>

</div></figure>



<p>The developer will look in the logs and see <code>got &#34;{ttl}&#34;</code> and not see the value of <code>ttl</code>. It’s ironic that a developer will read the logs to debug something, only find another unrelated f-string bug that hinders them from fixing the original bug they were investigating.</p>



<p>Note also that Python docs suggest <a href="https://docs.python.org/3/howto/logging.html#optimization" rel="noreferrer noopener" target="_blank">not using string formatting during logger calls</a>. Instead use the logger’s build-in-mechanism to benefit lazy string interpolation for runtime optimisation.</p>



<p><strong>f-string mistakes during exception raising</strong></p>



<p>The impact is similar to the impact of bad f-string declaration during logging: it will reduce the effectiveness of a developer during debugging. Take for example this exception handling code from <a rel="noreferrer noopener" href="https://github.com/microsoft/CNTK/blob/e9396480025b9ca457d26b6f33dd07c474c6aa04/bindings/python/cntk/internal/sanitize.py#L633" target="_blank">Microsoft CNTK</a>:</p>



<figure><div>
<div id="gist115945141">
    <div translate="no">
      <div>
        <div>
  <div id="file-missing_f_string_cntk-py">
    
    <div itemprop="text">

        
<div>

  <template>
  <div data-view-component="true">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
  
    <p><span>
      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span></p>
</div></template>
<template>
  <span aria-label="This line has hidden Unicode characters" data-view-component="true">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
</span></template>

  
</div>


    </div>

  </div>
</div>

      </div>
      
    </div>
</div>

</div></figure>



<p>Or this example from <a rel="noreferrer noopener" href="https://github.com/NVIDIA/DALI/blob/c181a233f007190b264e77c7713e55dd38337787/docs/examples/use_cases/tensorflow/efficientdet/dataset/create_tfrecord_indexes.py#L46" target="_blank">Tensorflow</a>:</p>



<figure><div>
<div id="gist115945124">
    <div translate="no">
      <div>
        <div>
  <div id="file-missing_f_string_tensorflow-py">
    
    <div itemprop="text">

        
<div>

  <template>
  <div data-view-component="true">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
  
    <p><span>
      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span></p>
</div></template>
<template>
  <span aria-label="This line has hidden Unicode characters" data-view-component="true">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
</span></template>

  
</div>


    </div>

  </div>
</div>

      </div>
      
    </div>
</div>

</div></figure>



<p>Both of those should be f strings but are missing the <code>f</code> prefix.</p>



<p>The good news is crash reporting tools such as <a href="https://sentry.io/" rel="noreferrer noopener" target="_blank">Sentry</a> or <a href="https://firebase.google.com/docs/crashlytics/" rel="noreferrer noopener" target="_blank">Crashlyrics</a> should show the variable value during the crash. Still makes debugging harder though, and not all projects use such tools.</p>



<p><strong>f-string mistakes during unit testing</strong></p>



<p>Tests give confidence that our code behaves how we want. However, sometimes it’s the tests themselves that don’t always behave how we want. Perhaps due to typos. In fact perhaps due to f-string typos. Take for example this test found in <a href="https://github.com/home-assistant/core/blob/70e125850c595b70215d099ddbeac022204e140e/tests/components/nest/test_media_source.py#L878" rel="noreferrer noopener" target="_blank">Home Assistant</a>:</p>



<figure><div>
<div id="gist115945108">
    <div translate="no">
      <div>
        <div>
  <div id="file-missing_f_string_test-py">
    
    <div itemprop="text">

        
<div>

  <template>
  <div data-view-component="true">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
  
    <p><span>
      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span></p>
</div></template>
<template>
  <span aria-label="This line has hidden Unicode characters" data-view-component="true">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
</span></template>

  
</div>


    </div>

  </div>
</div>

      </div>
      
    </div>
</div>

</div></figure>



<p>The test expects a 404 to be returned due to “invalid-event-id” being used in the URL but actually the cause of the 404 is for another reason: because the <code>device.id</code> value was not interpolated into the string due to a missing the <code>f</code> prefix. The test is not really testing what the developer intended to test.</p>



<p>There is some poor developer out there maintaining the this part of the codebases that is relying on this test and using it as a quality gate to give them the confidence they have not broken the product but the test is not really working. It’s this kind of thing that can harm a night’s sleep! <em>It ain’t what you don’t know that gets you into trouble. It’s what you know for sure that just ain’t so</em>.</p>



<h3><strong>Detecting the bugs</strong></h3>



<p>Code Review Doctor is a static analysis tool that detects common mistakes and offers the fix. When adding new checkers we stress test them by analysing open source code, and then check the results to minimise false positives.</p>



<p>To test our new “this probably should be an f string” checker we generated a list of the most popular Python repositories on GitHub by using <a href="https://docs.github.com/en/rest/search#search-topics" rel="noreferrer noopener" target="_blank">GitHub’s topic search API</a>. We ran the following code (some code is skipped for simplicity):</p>



<figure><div>
<div id="gist115945093">
    <div translate="no">
      <div>
        <div>
  <div id="file-most_popular_python_repos-py">
    
    <div itemprop="text">

        
<div>

  <template>
  <div data-view-component="true">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
  
    <p><span>
      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span></p>
</div></template>
<template>
  <span aria-label="This line has hidden Unicode characters" data-view-component="true">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
</span></template>

  
</div>


    </div>

  </div>
</div>

      </div>
      
    </div>
</div>

</div></figure>



<p>As you can see, GitHub uses the <a href="https://datatracker.ietf.org/doc/html/rfc5988" rel="noreferrer noopener" target="_blank">Link header</a> for pagination.</p>



<p><a href="https://gist.github.com/code-review-doctor/169dab24d2dfd18883519f9843d6220a" rel="noreferrer noopener" target="_blank">Here’s the gist</a> of the list of GitHub repository clone URLs that was generated.</p>



<p>Once we got the list of most popular Python repositories we ran them through our distributed static analysis checkers on <a href="https://aws.amazon.com/lambda/" rel="noreferrer noopener" target="_blank">AWS lambda</a>. This serverless approach allows us to simultaneously test hundreds of repositories with perhaps millions of lines of code without having to worry about scalability of our back-end infrastructure, and we do not require our developers to have beefy development machines, and our servers don’t go down or experience performance degradation during peak load.</p>



<h3>Minimising false positives</h3>



<p>False positives are annoying for developers, so we attempt to minimise false positives. We were able to do this by writing a “version 1” of the checker and running it against a small cohort of open source repositories and check for false positives, then iterate by fixing the false positives and each time increase the number of repositories in the cohort. Eventually we get to “version n” and were happy the false positives are at an acceptable rate. Version 1 was very simple:</p>



<pre>GIVEN a string does not have an f prefix</pre>



<p>This very naive approach allowed us to run the checkers and see what cases we did not consider. There were a lot of them! Here are some false positives we found:</p>



<ul><li>The string is later used in an <a href="https://docs.python.org/3/library/stdtypes.html#str.format" rel="noreferrer noopener" target="_blank">str.format(…)</a> call or <a href="https://docs.python.org/3/library/stdtypes.html#str.format_map" rel="noreferrer noopener" target="_blank">str.format_map(…)</a></li><li>The string is used in a logger call. Python logger uses it’s own mechanism for string interpolation: the developer can pass in arbitrary keyword arguments that the logger will later interpolate:<code>logger.debug(&#34;the value of {name} is {value}. a={a}.&#34;, name=name, value=value, a=a)&#34;</code></li><li>The string is used in <a href="https://behave.readthedocs.io/en/stable/tutorial.html" rel="noreferrer noopener" target="_blank">behave style test</a> <code>@when(&#39;{user} accesses {url}.&#39;)</code></li><li>The “interpolation” is actually this common pattern for inserting a value into a template <code>some_string_template.replace(&#39;{name}&#39;, name)</code> .</li></ul>



<p>The false positive that was most difficult to solve was <em>the string later being using with str.format(…) or str.format_map(…)</em> because there is no guarantee that the str.format(…) call occurs in the same scope that the string was defined in: the string may be returned by function to be later used with str.format(…). Our technology <em>currently </em>does not have the capability to follow variables around every scope and know how it’s used. This will be an interesting problem to solve.</p>



<p>With these false positives in mind, our BDD-style spec ends up like:</p>



<pre>GIVEN a string does not have an f prefix</pre>



<p>That is vast simplification: there are many other ways a string can “look” like it should be an f-string but actually is not.</p>



<h3>Reaction from the community</h3>



<p>It was interesting to write the f-string checker, it was interesting to detect how common the problem was (10% is a lot higher than we expected!), and it was interesting to auto-create GitHub pull requests to fix the issues we found.</p>



<p>It was also interesting to see the reaction from open source developers to unsolicited pull requests from what looks like a bot (really a bot found the problem and made the PR, but really a human developer at Code Review Doctor did triage the issue before the PR was raised). After creating 69 pull requests the reaction ranged from:</p>



<ul><li>Annoyance that a bot with no context on their codebase was raising pull requests. A few accepted the bugs were simple enough for a bot to fix and merged the pull request, but a few closed the pull requests and issues without fixing. Fair enough. Open source developers are busy people and are not being paid to interact with what they think it just a bot. We’re not entitled to their limited time.</li><li>Neutral silence. They just merged the PR.</li><li>Gratitude. “thanks” or “good bot”.</li></ul>



<p>For science you can see the reactions <a href="https://github.com/issues?q=is%3Aissue+author%3Acode-review-doctor+archived%3Afalse+is%3Aclosed" rel="noreferrer noopener" target="_blank">here</a>.</p>



<h3><strong>Protecting your codebase</strong></h3>



<p>You use <a href="https://github.com/marketplace/django-doctor" rel="noreferrer noopener" target="_blank">our GitHub integration</a> so fixes for problems like these are suggested right inside your PR; or <a href="https://codereview.doctor/" rel="noreferrer noopener" target="_blank">scan your entire codebase for free</a> online; or maybe <a href="https://twitter.com/CodeReviewDr" rel="noreferrer noopener" target="_blank">follow us on Twitter</a>.</p>



<p>As promised at the start of the article here’s a list of pull requests we created:</p>



<figure><div>
<div id="gist115917317">
    <div translate="no">
      <div>
        

      </div>
      
    </div>
</div>

</div></figure>
			
			
				</div><!-- .entry-content -->

	</article><!-- #post-74 -->

		</main><!-- #main -->
	</section><!-- #primary -->


	</div></div>
  </body>
</html>
