<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://guix.gnu.org/en/blog/2024/the-shepherd-1.0.0-released/">Original</a>
    <h1>The Shepherd 1.0.0 released</h1>
    
    <div id="readability-page-1" class="page"><div><article class="page" lang="en"><h2>The Shepherd 1.0.0 released!</h2><p lang="en">Ludovic Courtès — December 12, 2024</p><p>Finally, twenty-one years after its
<a href="https://lists.gnu.org/archive/html/guile-user/2003-04/msg00007.html">inception</a>
(twenty-one!), the Shepherd leaves <a href="https://0ver.org/">ZeroVer</a>
territory to enter a glorious 1.0 era.  This 1.0.0 release is published
today because we think Shepherd has become a solid tool, meeting user
experience standards one has come to expect since systemd changed the
game of free init systems and service managers alike.  It’s also a major
milestone for <a href="https://guix.gnu.org">Guix</a>, which has been relying on
the Shepherd from a time when doing so counted as <em>dogfooding</em>.</p><p>To celebrate this release, the amazing Luis Felipe López Acevedo
designed a new logo,
<a href="https://git.savannah.gnu.org/cgit/shepherd/graphics.git">available</a>
under CC-BY-SA, and the project got <a href="https://gnu.org/software/shepherd">a proper web
site</a>!</p><p><img src="https://guix.gnu.org/static/blog/img/shepherd-logo.svg" alt="Logo of the Shepherd."/></p><p>Let’s first look at what the Shepherd actually <em>is</em> and what it can
do for you.</p><p>The Shepherd is a minimalist but featureful service manager and as such,
it <em>herds services</em>: it keeps track of services, their state and their
dependencies, and it can start, stop, and restart them when needed.
It’s a simple job; doing it right and providing users with insight and
control over services is a different story.</p><p>The Shepherd consists of two commands: <code>shepherd</code> is the daemon that
manages services, and <code>herd</code> is the command that lets you interact with
it to inspect and control the status of services.  The <code>shepherd</code>
command can run as the first process (PID 1) and serve as the “init
system”, as is the case on <a href="https://guix.gnu.org/manual/devel/en/html_node/Getting-Started-with-the-System.html">Guix
System</a>;
or it can manage services for unprivileged users, as is the case with
<a href="https://guix.gnu.org/manual/devel/en/html_node/Home-Configuration.html">Guix
Home</a>.
For example, running <code>herd status ntpd</code> as root allows me to know what
the Network Time Protocol (NTP) daemon is up to:</p><pre><code>$ sudo herd status ntpd
● Status of ntpd:
  It is running since Fri 06 Dec 2024 02:08:08 PM CET (2 days ago).
  Main PID: 11359
  Command: /gnu/store/s4ra0g0ym1q1wh5jrqs60092x1nrb8h9-ntp-4.2.8p18/bin/ntpd -n -c /gnu/store/7ac2i2c6dp2f9006llg3m5vkrna7pjbf-ntpd.conf -u ntpd -g
  It is enabled.
  Provides: ntpd
  Requires: user-processes networking
  Custom action: configuration
  Will be respawned.
  Log file: /var/log/ntpd.log

Recent messages (use &#39;-n&#39; to view more or less):
  2024-12-08 18:35:54  8 Dec 18:35:54 ntpd[11359]: Listen normally on 25 tun0 128.93.179.24:123
  2024-12-08 18:35:54  8 Dec 18:35:54 ntpd[11359]: Listen normally on 26 tun0 [fe80::e6b7:4575:77ef:eaf4%12]:123
  2024-12-08 18:35:54  8 Dec 18:35:54 ntpd[11359]: new interface(s) found: waking up resolver
  2024-12-08 18:46:38  8 Dec 18:46:38 ntpd[11359]: Deleting 25 tun0, [128.93.179.24]:123, stats: received=0, sent=0, dropped=0, active_time=644 secs
  2024-12-08 18:46:38  8 Dec 18:46:38 ntpd[11359]: Deleting 26 tun0, [fe80::e6b7:4575:77ef:eaf4%12]:123, stats: received=0, sent=0, dropped=0, active_time=644 secs</code></pre><p>It’s running, and it’s logging messages: the latest ones are shown here
and I can open <code>/var/log/ntpd.log</code> to view more.  Running <code>herd stop ntpd</code> would terminate the <code>ntpd</code> process, and there’s also a <code>start</code> and
a <code>restart</code> action.</p><p>Services can also have <em>custom actions</em>; in the example above, we see
there’s a <code>configuration</code> action.  As it turns out, that action is a
handy way to get the file name of the <code>ntpd</code> configuration file:</p><pre><code>$ head -2 $(sudo herd configuration ntpd)
driftfile /var/run/ntpd/ntp.drift
pool 2.guix.pool.ntp.org iburst</code></pre><p>Of course a typical system runs quite a few services, many of which
depend on one another.  The <code>herd graph</code> command returns a
representation of that <em>service dependency graph</em> that can be piped to
<code>dot</code> or <code>xdot</code> to visualize it; here’s what I get on my laptop:</p><p><img src="https://guix.gnu.org/static/blog/img/service-graph.svg" alt="Example of a service dependency graph."/></p><p>It’s quite a big graph (you can zoom in for details!) but we can learn a
few things from it.  Each node in the graph is a service; rectangles are
for “regular” services (typically daemons like <code>ntpd</code>), round nodes
correspond to <em>one-shot services</em> (services that perform one action and
immediately stop), and diamonds are for <em>timed services</em> (services that
execute code periodically).</p><p>A unique feature of the Shepherd is that you configure and extend it in
its own implementation language: in <a href="https://www.gnu.org/software/guile">Guile
Scheme</a>.  That does <em>not</em> mean you
need to be an expert in that programming language to get started.
Instead, we try to make sure anyone can start simple for their
configuration file and gradually get to learn more if and when they feel
the need for it.  With this approach, we <em>keep the user in the loop</em>,
<a href="https://www.wingolog.org/archives/2011/10/19/the-user-in-the-loop">as Andy Wingo put
it</a>.</p><p>A Shepherd configuration file is a Scheme snippet that goes like this:</p><pre><code><span>(</span><span>register-services</span>
  <span>(</span><span>list</span> <span>(</span><span>service</span> <span>&#39;</span><span>(</span><span>ntpd</span><span>)</span> <span>…</span><span>)</span>
        <span>…</span><span>)</span><span>)</span>

<span>(</span><span>start-in-the-background</span> <span>&#39;</span><span>(</span><span>ntpd</span> <span>…</span><span>)</span><span>)</span></code></pre><p>Here we define <code>ntpd</code> and get it started as soon as <code>shepherd</code> has read
the configuration file.  The ellipses can be filled in with more
services.</p><p>As an example, our <code>ntpd</code> service is defined like this:</p><pre><code><span>(</span><span>service</span>
  <span>&#39;</span><span>(</span><span>ntpd</span><span>)</span>
  <span>#:documentation</span> <span>&#34;Run the Network Time Protocol (NTP) daemon.&#34;</span>
  <span>#:requirement</span> <span>&#39;</span><span>(</span><span>user-processes</span> <span>networking</span><span>)</span>
  <span>#:start</span> <span>(</span><span>make-forkexec-constructor</span>
           <span>(</span><span>list</span> <span>&#34;…/bin/ntpd&#34;</span>
                 <span>&#34;-n&#34;</span> <span>&#34;-c&#34;</span> <span>&#34;/…/…-ntpd.conf&#34;</span> <span>&#34;-u&#34;</span> <span>&#34;ntpd&#34;</span> <span>&#34;-g&#34;</span><span>)</span>
           <span>#:log-file</span> <span>&#34;/var/log/ntpd.log&#34;</span><span>)</span>
  <span>#:stop</span> <span>(</span><span>make-kill-destructor</span><span>)</span>
  <span>#:respawn?</span> <span>#t</span><span>)</span></code></pre><p>The important parts here are <code>#:start</code> bit, which says how to start the
service, and <code>#:stop</code>, which says how to stop it.  In this case we’re
just spawning the <code>ntpd</code> program but other startup mechanisms are
supported by default: inetd, socket activation <em>à la</em> systemd, and
timers.  Check out the manual for
<a href="https://www.gnu.org/software/shepherd/manual/html_node/Service-Examples.html">examples</a>
and a
<a href="https://www.gnu.org/software/shepherd/manual/html_node/Defining-Services.html">reference</a>.</p><p>There’s no limit to what <code>#:start</code> and <code>#:stop</code> can do.  In Guix System
you’ll find services that <a href="https://guix.gnu.org/en/blog/2017/running-system-services-in-containers/">run daemons in
containers</a>,
that mount/unmount file systems (as can be guessed from the graph
above), that set up/tear down a static networking configuration, and a
variety of other things.  The
<a href="https://github.com/BIMSBbioinfo/swineherd">Swineherd</a> project goes as
far as extending the Shepherd to turn it into a tool to manage system
containers—similar to what the Docker daemon does.</p><p>Note that when writing service definitions for Guix System and Guix
Home, you’re targeting a <a href="https://guix.gnu.org/manual/devel/en/html_node/Shepherd-Services.html">thin
layer</a>
above the Shepherd programming interface.  As is customary in Guix, this
is <em>multi-stage programming</em>: G-expressions specified in the <code>start</code> and
<code>stop</code> fields are staged and make it into the resulting Shepherd
configuration file.</p><p>For those of you who were already using the Shepherd, here are the
highlights compared to the 0.10.x series:</p><ul><li>Support for <a href="https://www.gnu.org/software/shepherd/manual/html_node/Timers.html"><em>timed
services</em></a>
has been added: these services spawn a command or run Scheme code
periodically according to a predefined calendar.</li><li><code>herd status SERVICE</code> now shows high-level information about
services (main PID, command, addresses it is listening to, etc.)
instead of its mere “running value”.  It also shows recently-logged
messages.</li><li>To make it easier to discover functionality, that command also
displays <em>custom actions</em> applicable to the service, if any.  It
also lets you know if a replacement is pending, in which case you
can restart the service to upgrade it.</li><li><code>herd status root</code> is no longer synonymous with <code>herd status</code>;
instead it shows information about the <code>shepherd</code> process itself.</li><li>On Linux, <code>reboot --kexec</code> lets you reboot straight into a new Linux
kernel previously loaded with <a href="https://linux.die.net/man/8/kexec"><code>kexec --load</code></a>.</li></ul><p>The service collection has grown:</p><ul><li><p>The new <a href="https://www.gnu.org/software/shepherd/manual/html_node/Log-Rotation-Service.html">log rotation
service</a>
is responsible for periodically rotating log files, compressing
them, and eventually deleting them.  It’s very much like similar log
rotation tools from the 80’s since <code>shepherd</code> logs to plain text
files like in the good ol’ days.</p><p>There’s a couple of be benefits that come from its integration into
the Shepherd.  First, it already knows all the files that services
log to, so no additional configuration is needed to teach it about
these files.  Second, log rotation is <em>race free</em>: no single line of
log can be lost in the process.</p></li><li><p>The new <a href="https://www.gnu.org/software/shepherd/manual/html_node/System-Log-Service.html">system log
service</a>
what’s traditionally devoted to a separate <code>syslogd</code> program.  The
advantage of having it in <code>shepherd</code> is that it can start logging
earlier and integrates nicely with the rest of the system.</p></li><li><p>The <a href="https://www.gnu.org/software/shepherd/manual/html_node/Timer-Service.html">timer
service</a>
provides functionality similar to the venerable <code>at</code> command,
allowing you to run a command at a particular time:</p></li></ul><pre><code>herd schedule timer at 07:00 -- mpg123 alarm.mp3</code></pre><ul><li>The <a href="https://www.gnu.org/software/shepherd/manual/html_node/Transient-Service-Maker.html">transient service
maker</a>
lets you run a command in the background as a transient service (it
is similar in spirit to the <code>systemd-run</code> command):</li></ul><pre><code>herd spawn transient -d $PWD -- make -j4</code></pre><ul><li>The GOOPS interface that was deprecated in 0.10.x <a href="https://www.gnu.org/software/shepherd/manual/html_node/Legacy-GOOPS-Interface.html">is now
gone</a>.</li></ul><p>As always, the <a href="https://git.savannah.gnu.org/cgit/shepherd.git/tree/NEWS?id=dd911ac772989a7630b9f4d58f8b747cbc1c33fe"><code>NEWS</code>
file</a>
has additional details.</p><p>In the coming weeks, we will most likely gradually move service
definitions in Guix from
<a href="https://guix.gnu.org/manual/devel/en/html_node/Scheduled-Job-Execution.html#index-mcron_002dservice_002dtype">mcron</a>
to timed services and similarly replace
<a href="https://guix.gnu.org/manual/devel/en/html_node/Log-Rotation.html#index-rottlog_002dservice_002dtype">Rottlog</a>
and
<a href="https://guix.gnu.org/manual/devel/en/html_node/Base-Services.html#index-syslog_002dservice_002dtype"><code>syslogd</code></a>.
This should be an improvement for Guix users and system administrators!</p><p>I did mention that the Shepherd is minimalist, and it really is: 7.4K
lines of Scheme, excluding tests, according to SLOCCount.  This is in
large part thanks to the use of a high-level memory-safe language and
due to the fact that it’s extensible—peripheral features can live
outside the Shepherd.</p><p>Significant benefits also come from the concurrency framework: the
<em>concurrent sequential processes</em> (CSP) model and
<a href="https://github.com/wingo/fibers">Fibers</a>.  Internally, the state of
each service <a href="https://www.gnu.org/software/shepherd/manual/html_node/Service-Internals.html">is encapsulated in a
fiber</a>.
Accessing a service’s state amounts to sending a message to its fiber.
This way to structure code is itself very much inspired by the <em>actor
model</em>.  This results in simpler code (no dreaded event loop, no
callback hell) and better separation of concern.</p><p>Using a high-level framework like Fibers does come with its challenges.
For example, we had the case of a <a href="https://github.com/wingo/fibers/issues/109">memory leak in Fibers under certain
conditions</a>, and we
certainly don’t want that in PID 1.  But the challenge really lies in
squashing those low-level bugs so that the foundation is solid.  The
Shepherd itself is free from such low-level issues; its logic is easy to
reason about and that alone is immensely helpful, it allows us to extend
the code without fear, and it avoids concurrency bugs that plague
programs written in the more common event-loop-with-callbacks style.</p><p>In fact, thanks to all this, the Shepherd is probably the <em>coolest init
system</em> to hack on.  It even comes with a
<a href="https://www.gnu.org/software/shepherd/manual/html_node/REPL-Service.html">REPL</a>
for live hacking!</p><p>There’s a number of down-to-earth improvements that can be made in the
Shepherd, such as adding support for dynamically-reconfigurable services
(being able to restart a service but with different options),
integration with control groups (“cgroups”) on Linux, proper integration
for software suspend, etc.</p><p>In the longer run, we envision an exciting journey towards a
<a href="https://spritely.institute/news/spritely-nlnet-grants-december-2023.html">distributed and capability-style
Shepherd</a>.
<a href="https://spritely.institute/goblins/">Spritely Goblins</a> provides the
foundation for this; using it looks like a natural continuation of the
design work of the Shepherd: Goblins is an actor model framework!
Juliana Sims has been working on adapting the Shepherd to Goblins
and we’re eager to see what comes out of it in the coming year.  Stay
tuned!</p><p>In the meantime, we hope you enjoy the Shepherd 1.0 as much as we
enjoyed making it.  Four people contributed code that led to this
release, but there are <a href="https://www.gnu.org/software/shepherd/contribute">other ways to
help</a>: through
graphics and web design, translation, documentation, and more.  Join us!</p><blockquote><p><em>Originally published on the <a href="https://www.gnu.org/software/shepherd/news/2024/12/the-shepherd-1.0.0-released/">Shepherd web
site</a>.</em></p></blockquote><p>Unless otherwise stated, blog posts on this site are
copyrighted by their respective authors and published under the terms of
the <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC-BY-SA 4.0</a> license and those of the <a href="https://www.gnu.org/licenses/fdl-1.3.html">GNU Free Documentation License</a> (version 1.3 or later, with no Invariant Sections, no
Front-Cover Texts, and no Back-Cover Texts).</p></article></div></div>
  </body>
</html>
