<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://rkiselenko.dev/blog/development-on-mac-with-utm/development-on-mac-with-lima/">Original</a>
    <h1>Development on Apple Silicon with UTM</h1>
    
    <div id="readability-page-1" class="page"><div id="skip">
			


<ul>
	<li><time datetime="2025-04-17">17 April 2025</time></li>
	<li><a href="https://rkiselenko.dev/tags/vm/">vm</a>, </li>
	<li><a href="https://rkiselenko.dev/tags/utm/">utm</a>, </li>
	<li><a href="https://rkiselenko.dev/tags/arm/">arm</a>, </li>
	<li><a href="https://rkiselenko.dev/tags/macbook/">macbook</a>, </li>
	<li><a href="https://rkiselenko.dev/tags/apple-silicon/">apple silicon</a></li>
</ul>

<p>&#34;UTM is an app for running other operating systems on your iPhone or iPad. It is not for running iOS on other systems. This allows you, among other things, to run Windows or Linux on your iOS device at a usable speed.&#34; – UTM Website
</p>
<p><picture><source type="image/gif" srcset="/img/_LgTXEGM9x-900.gif 900w"/><source type="image/avif" srcset="/img/_LgTXEGM9x-900.avif 900w"/><source type="image/webp" srcset="/img/_LgTXEGM9x-900.webp 900w"/><img alt="" loading="lazy" decoding="async" src="https://rkiselenko.dev/img/_LgTXEGM9x-900.jpeg" width="900" height="660"/></picture></p>
<p>In this article, I&#39;ll show you how to use <a href="https://getutm.app/">UTM VMs</a> virtual machines to create Linux development environments on Apple Silicon.</p>
<p>This approach builds on the technique I described in <a href="https://rkiselenko.dev/blog/development-on-mac-with-lima">here</a>.</p>
<h3 id="dependencies" tabindex="-1">Dependencies <a href="#dependencies">#</a></h3>
<p>First, install UTM using Homebrew: <code>brew install --cask utm</code>.</p>
<p>Then, install <code>brew install cdrtools</code>, which provides <code>mkisofs</code>. We&#39;ll use that tool to create an <code>init.iso</code> - our seed script for initializing the VM.</p>
<p>We need a bunch of tools and images.</p>
<ul>
<li>
<p>Fedora Cloud images <a href="https://mirror.bahnhof.net/pub/fedora/linux/releases/">mirror.bahnhof.net</a>.</p>
<ol>
<li><code>aarch64</code>
<a href="https://mirror.bahnhof.net/pub/fedora/linux/releases/42/Cloud/aarch64/images/Fedora-Cloud-Base-Generic-42-1.1.aarch64.qcow2">Fedora-Cloud-Base-Generic-42-1.1.aarch64.qcow2</a></li>
<li><code>x86_64</code> <a href="https://mirror.bahnhof.net/pub/fedora/linux/releases/42/Cloud/x86_64/images/Fedora-Cloud-Base-Generic-42-1.1.x86_64.qcow2">Fedora-Cloud-Base-Generic-42-1.1.x86_64.qcow2</a></li>
</ol>
</li>
<li>
<p>Ubuntu Cloud images <a href="https://cdimage.ubuntu.com/ubuntu-server/daily-preinstalled/current">cdimage.ubuntu.com</a>.</p>
<ol>
<li><code>aarch64</code> <a href="https://cdimage.ubuntu.com/ubuntu-server/daily-preinstalled/current/plucky-preinstalled-server-arm64.img.xz">plucky-preinstalled-server-arm64.img.xz</a></li>
<li><code>x86_64</code> <a href="https://cdimage.ubuntu.com/ubuntu-server/daily-preinstalled/current/plucky-preinstalled-server-amd64.img.xz">plucky-preinstalled-server-amd64.img.xz</a></li>
</ol>
</li>
</ul>
<h3 id="cloud-init" tabindex="-1">Cloud-Init <a href="#cloud-init">#</a></h3>
<p>We’ll use <a href="https://cloudinit.readthedocs.io/en/latest/index.html">cloud-init</a> scripts to bootstrap the VM with the tools and settings needed for development - things like <code>git</code>, <code>jq</code>, <code>go</code>, <code>docker</code>, and more. We&#39;ll also use it to provision an SSH key for easy access.</p>
<p><b>user-data </b></p>
<pre tabindex="0"><code>

<span>system_info</span><span>:</span>
   <span>default_user</span><span>:</span>
     <span>name</span><span>:</span> fedora

<span>users</span><span>:</span>
  <span>-</span> <span>name</span><span>:</span> fedora
    <span>sudo</span><span>:</span> <span>[</span><span>&#39;ALL=(ALL) NOPASSWD:ALL&#39;</span><span>]</span>
    <span>groups</span><span>:</span> users<span>,</span> admin<span>,</span> docker
    <span>shell</span><span>:</span> /bin/bash

<span>ssh_authorized_keys</span><span>:</span>
   <span>-</span> ssh<span>-</span>rsa AAAAB3Nza<span>...</span>

<span>groups</span><span>:</span>
  <span>-</span> docker

<span>packages</span><span>:</span>
  <span>-</span> curl
  <span>-</span> wget
  <span>-</span> git
  <span>-</span> jq
  <span>-</span> gcc
  <span>-</span> clang

<span>chpasswd</span><span>:</span>
  <span>list</span><span>:</span> <span>|</span><span>
    fedora:password</span>
  <span>expire</span><span>:</span> <span>False</span>

<span>resize_rootfs</span><span>:</span> <span>True</span>

<span>write_files</span><span>:</span>
  <span>-</span> <span>path</span><span>:</span> /etc/sysctl.d/enabled_ipv4_forwarding.conf
    <span>content</span><span>:</span> <span>|</span><span>
      net.ipv4.conf.all.forwarding=1</span>
  <span>-</span> <span>path</span><span>:</span> /opt/go.sh
    <span>owner</span><span>:</span> fedora<span>:</span>fedora
    <span>permissions</span><span>:</span> <span>&#39;0700&#39;</span>
    <span>content</span><span>:</span> <span>|</span><span>
      #!/usr/bin/env bash
      set -ex
      wget https://go.dev/dl/go1.24.1.linux-amd64.tar.gz -O go.tar.gz
      sudo tar -C /usr/local -xzvf go.tar.gz
      rm -rf go
      echo &#39;export GOROOT=/usr/local/go&#39; &gt;&gt; /home/fedora/.bashrc
      echo &#39;export GOPATH=$HOME/.go&#39; &gt;&gt; /home/fedora/.bashrc
      echo &#39;export PATH=$GOPATH/bin:$GOROOT/bin:$PATH&#39; &gt;&gt; /home/fedora/.bashrc</span>
<span>runcmd</span><span>:</span>
  <span>-</span> <span>[</span>dnf<span>,</span> config<span>-</span>manager<span>,</span> addrepo<span>,</span> <span>-</span><span>-</span>from<span>-</span>repofile=&#34;https<span>:</span>//download.docker.com/linux/fedora/docker<span>-</span>ce.repo&#34;<span>]</span>
  <span>-</span> <span>[</span>dnf<span>,</span> install<span>,</span> docker<span>-</span>ce<span>,</span> docker<span>-</span>ce<span>-</span>cli<span>,</span> containerd.io<span>]</span>
  <span>-</span> <span>[</span>systemctl<span>,</span> enable<span>,</span> <span>-</span><span>-</span>now<span>,</span> docker<span>]</span>
  <span>-</span> /opt/go.sh</code></pre>
<p>Generate <code>init.iso</code> (<code>mkisofs</code> is a part of <code>cdrtools</code>):</p>
<pre tabindex="0"><code><span>touch</span> meta-data 
<span>mkisofs</span> <span>-output</span> init.iso <span>-volid</span> cidata <span>-joliet</span> <span>-rock</span> <span>{</span>user-data,meta-data<span>}</span></code></pre>
<h3 id="create-vm" tabindex="-1">Create VM <a href="#create-vm">#</a></h3>
<p>Create VM, chose Emulate:</p>
<p><picture><source type="image/gif" srcset="/img/33dhKW_moC-900.gif 900w"/><source type="image/avif" srcset="/img/33dhKW_moC-900.avif 900w"/><source type="image/webp" srcset="/img/33dhKW_moC-900.webp 900w"/><img alt="" loading="lazy" decoding="async" src="https://rkiselenko.dev/img/33dhKW_moC-900.jpeg" width="900" height="652"/></picture></p>
<p>Chose Other:</p>
<p><picture><source type="image/gif" srcset="/img/eRe6E24zN4-900.gif 900w"/><source type="image/avif" srcset="/img/eRe6E24zN4-900.avif 900w"/><source type="image/webp" srcset="/img/eRe6E24zN4-900.webp 900w"/><img alt="" loading="lazy" decoding="async" src="https://rkiselenko.dev/img/eRe6E24zN4-900.jpeg" width="900" height="648"/></picture></p>
<p>No changes in Hardware:</p>
<p><picture><source type="image/gif" srcset="/img/x-GhIz-RzX-900.gif 900w"/><source type="image/avif" srcset="/img/x-GhIz-RzX-900.avif 900w"/><source type="image/webp" srcset="/img/x-GhIz-RzX-900.webp 900w"/><img alt="" loading="lazy" decoding="async" src="https://rkiselenko.dev/img/x-GhIz-RzX-900.jpeg" width="900" height="649"/></picture></p>
<p>Use <code>8GB</code> disk, we dont need it and will remove it later.</p>
<p>In Summary name the VM and check <code>Open VM Settings</code>:</p>
<p><picture><source type="image/gif" srcset="/img/XyFnZeSbG_-900.gif 900w"/><source type="image/avif" srcset="/img/XyFnZeSbG_-900.avif 900w"/><source type="image/webp" srcset="/img/XyFnZeSbG_-900.webp 900w"/><img alt="" loading="lazy" decoding="async" src="https://rkiselenko.dev/img/XyFnZeSbG_-900.jpeg" width="900" height="651"/></picture></p>
<p>Uncheck <code>UEFI Boot</code>:</p>
<p><picture><source type="image/gif" srcset="/img/XC6rVytqkq-900.gif 900w"/><source type="image/avif" srcset="/img/XC6rVytqkq-900.avif 900w"/><source type="image/webp" srcset="/img/XC6rVytqkq-900.webp 900w"/><img alt="" loading="lazy" decoding="async" src="https://rkiselenko.dev/img/XC6rVytqkq-900.jpeg" width="900" height="648"/></picture></p>
<p>Remove <code>Display</code>, <code>Sound</code> with rigth mouse click, and add <code>Serial</code> -&gt; <code>Built-In</code>:</p>
<p><picture><source type="image/gif" srcset="/img/YPTDgqEhFk-900.gif 900w"/><source type="image/avif" srcset="/img/YPTDgqEhFk-900.avif 900w"/><source type="image/webp" srcset="/img/YPTDgqEhFk-900.webp 900w"/><img alt="" loading="lazy" decoding="async" src="https://rkiselenko.dev/img/YPTDgqEhFk-900.jpeg" width="900" height="648"/></picture></p>
<p>Remove created <code>Drive</code>, and add new one <code>VirtiO</code>,
<code>Import</code> the <a href="https://rkiselenko.dev/blog/development-on-mac-with-utm/development-on-mac-with-lima/#dependencies">Fedora-Cloud-Base-Generic-42-1.1.x86_64.qcow2</a></p>
<p><picture><source type="image/gif" srcset="/img/mLLwXLEswf-490.gif 490w"/><source type="image/avif" srcset="/img/mLLwXLEswf-490.avif 490w"/><source type="image/webp" srcset="/img/mLLwXLEswf-490.webp 490w"/><img alt="" loading="lazy" decoding="async" src="https://rkiselenko.dev/img/mLLwXLEswf-490.jpeg" width="490" height="316"/></picture></p>
<p><picture><source type="image/gif" srcset="/img/7r6y5QrvrR-900.gif 900w"/><source type="image/avif" srcset="/img/7r6y5QrvrR-900.avif 900w"/><source type="image/webp" srcset="/img/7r6y5QrvrR-900.webp 900w"/><img alt="" loading="lazy" decoding="async" src="https://rkiselenko.dev/img/7r6y5QrvrR-900.jpeg" width="900" height="653"/></picture></p>
<p>Create another one <code>Drive</code> -&gt; <code>VirtiO</code>,
import the <a href="https://rkiselenko.dev/blog/development-on-mac-with-utm/development-on-mac-with-lima/#dependencies-for-vm">init.iso</a></p>
<p><picture><source type="image/gif" srcset="/img/4JspUqD-is-900.gif 900w"/><source type="image/avif" srcset="/img/4JspUqD-is-900.avif 900w"/><source type="image/webp" srcset="/img/4JspUqD-is-900.webp 900w"/><img alt="" loading="lazy" decoding="async" src="https://rkiselenko.dev/img/4JspUqD-is-900.jpeg" width="900" height="653"/></picture></p>
<p>Run VM, if everything goes right you&#39;ll see boot terminal, like on the image below:</p>
<p><picture><source type="image/gif" srcset="/img/NRbwvJX1q_-900.gif 900w"/><source type="image/avif" srcset="/img/NRbwvJX1q_-900.avif 900w"/><source type="image/webp" srcset="/img/NRbwvJX1q_-900.webp 900w"/><img alt="" loading="lazy" decoding="async" src="https://rkiselenko.dev/img/NRbwvJX1q_-900.jpeg" width="900" height="721"/></picture></p>
<p>Wait until the login screen appears. The default username is fedora and the password is password, as defined in our cloud-init script.</p>
<p>Give it a moment after logging in <a href="https://rkiselenko.dev/blog/development-on-mac-with-utm/development-on-mac-with-lima/#cloud-init">cloud-init script.</a> will need some time to finish setting everything up.</p>
<p><picture><source type="image/gif" srcset="/img/B_-08aAIMK-900.gif 900w"/><source type="image/avif" srcset="/img/B_-08aAIMK-900.avif 900w"/><source type="image/webp" srcset="/img/B_-08aAIMK-900.webp 900w"/><img alt="" loading="lazy" decoding="async" src="https://rkiselenko.dev/img/B_-08aAIMK-900.jpeg" width="900" height="661"/></picture></p>
<p>After the VM has finished initializing, power it off and remove the init.iso drive—it only needs to run during the first boot.</p>
<p>You can check the output of the cloud-init scripts with <code>sudo cat /var/log/cloud-init-output.log</code></p>
<p>Tip:</p>
<p>To create a VM for Apple Silicon (aarch64), follow these steps:</p>
<ul>
<li>Choose <code>Virtualize</code>, since Apple Silicon is ARM-based.</li>
<li>Use <code>arm64</code> cloud images.</li>
<li>For Ubuntu, the process is almost the same - except you don’t need to disable UEFI boot.</li>
<li>Don’t forget to extract the <code>*.img.xz</code> file before using it.</li>
</ul>
<p>Happy coding!</p>

<ul><li>Previous: <a href="https://rkiselenko.dev/blog/crio-in-kind/">Use CRI-O Container Runtime with KIND</a></li>
</ul>

		</div></div>
  </body>
</html>
