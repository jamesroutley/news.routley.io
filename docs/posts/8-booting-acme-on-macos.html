<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.jacobvosmaer.nl/0008-booting-acme/">Original</a>
    <h1>8. Booting Acme on macOS</h1>
    
    <div id="readability-page-1" class="page"><div>


<blockquote>
  <p>2020-09-13</p>
</blockquote>

<p>Starting up Acme, the text editor I use, is non-trivial. It relies on
two supporting processes (<code>fontsrv</code> and <code>plumber</code>) and it doesn&#39;t work
well if you run more than one instance.</p>

<p>Besides this process management, it is also desirable to modify
environment variables, because Acme is also my terminal emulator, and
it is a &#34;dumb&#34; one meaning it needs special settings.</p>

<p>The idea of &#34;run only one instance&#34; sounds like a job for macOS
launchd but I have come to not like that. I now just use a script that
does an old fashioned double fork.</p>

<h2>bin/acme</h2>

<pre>#!/usr/bin/env ruby

Dir.chdir(ENV[&#39;HOME&#39;])

# Send SIGTERM to all running plan9port server processes
system(*%w[pkill 9pserve])

log = [&#39;Library/Logs/acme.log&#39;, &#39;a&#39;]

# Prevent colorization settings leaking into Acme
%w[
  CLICOLOR
  GREP_OPTIONS
].each { |k| ENV.delete(k) }

{
  &#39;PAGER&#39; =&gt; &#39;9 nobs&#39;,
  &#39;BROWSER&#39; =&gt; &#39;Google Chrome&#39;,
  &#39;MAILER&#39; =&gt; &#39;browser&#39;,
  &#39;EDITOR&#39; =&gt; &#39;9 E&#39;,
  &#39;GIT_EDITOR&#39; =&gt; &#39;9 E&#39;,
  &#39;TERM&#39; =&gt; &#39;dumb&#39;,
  &#39;SHELL&#39; =&gt; &#39;/Users/jacobvosmaer/bin/rc-wrap&#39;,
}.each { |k, v| ENV[k] = v }

fork do
  Process.setsid
  $stdin.reopen(&#39;/dev/null&#39;)

  [
    %w[9 plumber],
    %w[9 fontsrv],
    %w[9 acme -l acme.dump],
  ].each { |cmd| spawn(*cmd, err: log, out: log) }
end
</pre>

<p>The <code>pkill</code> command at the top of the script takes care of the &#34;only
one Acme process&#34; requirement in a very crude way, by terminating all
plan9port server processes. It is a common problem to terminate <code>acme</code>
itself but not its helpers, and sometimes that is bad. Now by running
<code>bin/acme</code> I get a clean slate on all its processes.</p>

<h2>bin/rc-wrap</h2>

<p>You may have noticed the <code>SHELL=rc-wrap</code> bit. This is what <code>rc-wrap</code> does:</p>

<pre>#!/bin/sh
exec rc -l &#34;$@&#34;
</pre>

<p>What is going on here is that I want all my shells inside plan9port to
be <code>rc -l</code>, not <code>rc</code>. For whatever reason <code>SHELL=rc -l</code> is not allowed
so I made this wrapper executable that adds the <code>-l</code> argument but
avoids the space in SHELL.</p>

<p>What <code>rc -l</code> does is to enable loading its startup file <code>$HOME/lib/profile</code>. I like this because it lets me define
<code>rc</code> functions as shortcuts for when I work in Acme&#39;s terminal.</p>

<h2>rc functions</h2>

<p>I use <code>rc</code> functions instead of plain scripts so that I can neatly
&#34;shadow&#34; commands that work fine in regular terminal but not-fine in
Acme. Mostly stuff with colorization, such as:</p>

<pre>fn rspec { u bundle exec rspec --no-color $* }
</pre>

<p><code>u</code> is a plan9port helper that removes plan9port from the PATH, making
the non-plan9port <code>ls</code>, <code>sed</code>, <code>kill</code>, <code>grep</code> etc available.</p>

<p>The advantage of having this <code>rspec</code> shell function is that it is
specific to plan9port and when I run <code>rspec</code> in a normal terminal I
still get normal <code>rspec</code>.</p>
<p>Tags:
<a href="https://blog.jacobvosmaer.nl/acme.html">acme</a>
</p><p>Revisions:<table>
<tbody><tr><td>2023-12-07</td><td></td><td>Add atom.xml</td></tr>
<tr><td>2023-11-28</td><td></td><td>Add some dates</td></tr>
<tr><td>2023-11-28</td><td></td><td>Add tag system</td></tr>
<tr><td>2020-09-13</td><td></td><td>Add 0008-booting-acme</td></tr>
</tbody></table><a href="https://blog.jacobvosmaer.nl/">Back</a></p>

</div></div>
  </body>
</html>
