<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.lenny.ninja/zrepl-on-rsync-net.html">Original</a>
    <h1>Zrepl on Rsync.net</h1>
    
    <div id="readability-page-1" class="page"><div>
    <div>
      
      
      <p>A while ago I got a testing account on <a href="https://rsync.net">rsync.net</a> to try out the experience of using it with <a href="https://zrepl.github.io/">zrepl</a>. The experience I has been quite wonderful, and I want to share what I learned with you.</p>

<h2>What is zrepl?</h2>

<p>If you use zfs on your NAS, you inevitably think about doing an offsite backup for your data. For this you might use off the shelf tools like <a href="https://www.duplicati.com/">Duplicati</a> or <a href="https://borgbackup.readthedocs.io">borg</a>. As a zfs user you might also be aware of the option to use the <code>zfs send</code> command to send a byte for byte copy of a zfs snapshot to another system running zfs. Writing some shell scripts around this and using it as a backup has <a href="https://utcc.utoronto.ca/~cks/space/blog/solaris/ZFSSendNotABackup">numerous drawbacks</a> however.</p>

<p>This is where zrepl comes in, it’s a “one-stop, integrated solution for ZFS replication”. It runs as a daemon on your local nas and your remote system making sure the replication of your datasets proceeds reliably (for example by recovering from network outages) and transparently (by exposing various tools for monitoring).</p>

<p>It it also manages the creation and cleanup of periodic snapshots of your datasets. You could for example keep 24 hourly snapshots on your local nas to quickly recover deleted files while on the other hand keeping 6 monthly snapshots on your remote in case you need to recover something older.</p>

<p>Zrepl is an awesome tool if you want your data to be in two places at the same time while using many native zfs features.</p>

<h2>What is <a href="https://rsync.net">rsync.net</a>?</h2>

<p>Rsync.net is basically a cloud storage provider without all the fuss. Originally they would just provide you a vm to <code>rsync</code> your files to (hence the name) and make sure they stay there. You can also use various other tools to send them your data like <code>sftp</code>, <code>borg</code>, <code>rclone</code>, <code>git-annex</code> or just good old <code>scp</code>.</p>

<p>The happy coincidence is that their system is based on zfs, just like ours. You even get full access to your own zpool if you sign up for a zfs-send enabled account <a href="https://rsync.net/products/zfs.html">here</a>.  You can simply treat your rsync.net vm as a remote zpool under your control.</p>

<h2>Setting up zrepl on rsync.net</h2>

<p>As it turns out all this allows us to run zrepl on our remote vm, the rest of this post is about how to set that up. I will skip the setup on your local nas as that is nicely explained by the <a href="https://zrepl.github.io/installation.html">zrepl docs</a>.</p>

<p>When you sign up for your account you will get a user, password and a host to ssh into. You then want to do basic setup steps like adding a ssh key for your user, but I will skip this part as they have <a href="https://www.rsync.net/resources/howto/ssh_keys.html">their own guides</a> on how to get started with that. The vms are running on FreeBSD, so some things are a little different. (At least they were for me as a Linux user)</p>

<p>To install zrepl simply run <code>pkg add zrepl</code>.</p>

<p>The next step is making sure that our local NAS’ zrepl daemon can access the rsync.net vm. Zrepl has various <a href="https://zrepl.github.io/configuration/transports.html">transports</a> to make that work. For this guide we will use the simple <code>ssh+stdinserver</code> transport (be aware that this has some throughput limitations however). You should generate a fresh ssh keypair for that on your local machine, putting the private key somewhere your local zrepl daemon can access it. The public counterpart goes into the familiar <code>.ssh/authorized_keys</code> file in addition to some preamble that restrict incoming connections using that key to running zrepl.</p>

<pre><code>command=&#34;zrepl stdinserver client1&#34;,restrict ssh-ed25519 AAAAC3N...
</code></pre>

<p>Simply replace the <code>ssh-ed25519 AAAAC3N...</code> here with the public key you generated.</p>

<p>The next step is to configure zrepl by editing the config file at <code>/usr/local/etc/zrepl/zrepl.yml</code>, however we will go into detail on that in the next section.</p>

<p>To enable the zrepl service on your remote simple create the file <code>/etc/rc.conf.d/zrepl</code> and add a line containing <code>zrepl_enable=&#34;YES&#34;</code> to it. Then start zrepl by running <code>service zrepl start</code>.</p>

<h2>Simple zrepl config</h2>

<p>I’ll pride you with a very simple zrepl config for your local nas and remote here. Be sure to read the <a href="https://zrepl.github.io/configuration.html">zrepl docs</a> to tune it for your use case.</p>

<p>Local: <code>/etc/zrepl/zrepl.yml</code></p>

<pre><code>global:
  logging:
  - format: human
    level: warn
    type: syslog
jobs:
- connect:
    host: &lt;your rsync.net vm name&gt;.rsync.net
    identity_file: &lt;path to the private key you crated&gt;
    port: 22
    type: ssh+stdinserver
    user: root
  filesystems:
    &lt;datasets you want to replicate&gt;: true
    pruning:
    keep_receiver:
    - grid: 1x1h(keep=all) | 24x1h | 30x1d | 6x30d
      regex: ^zrepl_
      type: grid
    keep_sender:
    - type: not_replicated
    - count: 10
      type: last_n
  snapshotting:
    interval: 10m
    prefix: zrepl_
    type: periodic
  type: push
</code></pre>

<p>Remote: <code>/usr/local/etc/zrepl/zrepl.yml</code></p>

<pre><code>global:
  logging:
    - type: &#34;stdout&#34;
      level:  &#34;error&#34;
      format: &#34;human&#34;
    - type: &#34;syslog&#34;
      level:  &#34;info&#34;
      format: &#34;logfmt&#34;

jobs:
- name: sink
  type: sink
  serve:
    type: stdinserver
    client_identities:
    - &#34;client1&#34;
  root_fs: &#34;data1&#34;
</code></pre>

<p>This will make zrepl push snapshots to your rsync.net vm with some snapshotting and pruning. Specifically it takes a snapshot every 10 minutes on your local nas, but only keeps the 10 most recent ones around. Your remote will keep 1 snapshot of each of the last 24h, 1 snapshots for each of the last 30 days and 1 snapshot for each of the last 6 months.</p>

<h2>Conclusion</h2>

<p>Using zrepl on rsync.net provides us with a fairly straight forward way to replicate our zpool off site, with the added benefit not having to convert our data into other backup formats (such as borg) while keeping most of their benefits. It’s a unique offering that I have not seen anywhere else and hopefully fits your use case as well as it does mine.</p>

<p>Disclaimer: I’m continueing to receive a discounted access to rsync.net.</p>

    </div>
  </div></div>
  </body>
</html>
