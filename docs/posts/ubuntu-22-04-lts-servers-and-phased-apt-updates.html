<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/Ubuntu2204ServerPhasedUpdates">Original</a>
    <h1>Ubuntu 22.04 LTS servers and phased apt updates</h1>
    
    <div id="readability-page-1" class="page"><div><h2>Ubuntu 22.04 LTS servers and phased apt updates</h2>

	<p><small>January 13, 2023</small></p>
</div><div><p>I was working on getting one of our 22.04 LTS servers up to date,
even for packages we normally hold, when <a href="https://mastodon.social/@cks/109677500664167117">I hit a mystery and
posted about it on the Fediverse</a>:</p>

<blockquote><p>Why does apt on this 22.04 Ubuntu machine want to hold back a bunch of
package updates even with &#39;--with-new-pkgs --ignore-hold&#39;? Who knows,
it won&#39;t tell me why it doesn&#39;t like any or all of:</p>

<p>open-vm-tools openssh-client openssh-server openssh-sftp-server
osinfo-db python3-software-properties software-properties-common</p>

<p>(Apt is not my favorite package manager for many reasons, this among
them.)</p>
</blockquote>

<p><a href="https://masto.ai/@snk/109677544506984321">Steve suggested that it was Ubuntu&#39;s &#34;Phased Update&#34; system</a>, which is what it turned
out to be. This set me off to do some investigations, and it turns
out that phased (apt) updates explain some other anomalies we&#39;ve
seen with package updates on our Ubuntu 22.04 machines.</p>

<p>The basic idea of phased updates is explained in <a href="https://wiki.ubuntu.com/StableReleaseUpdates#Phasing">the &#34;Phasing&#34;
section of Ubuntu&#39;s page on Stable Release Updates (SRUs)</a>; it&#39;s a
progressive rollout of the package to more and more of the system
base. Ubuntu introduced phased updates in 2013 (<a href="https://lwn.net/Articles/563966/">cf</a>) but initially they weren&#39;t
directly supported by apt, only by the desktop upgrade programs.
<a href="https://discourse.ubuntu.com/t/phased-updates-in-apt-in-21-04/20345">Ubuntu 21.04 added apt support for phased updates</a> and
Ubuntu 22.04 LTS is thus the first LTS version to subject servers
to phased updates. More explanations of phased updates are in <a href="https://askubuntu.com/a/1431941">this
askubuntu answer</a>, which includes
one way to work around them.</p>

<p>(Note that as far as I know and have seen, security updates are not
released as phased updates; if it&#39;s a security update, everyone
gets it right away. Phased updates are only used for regular,
non-security updates.)</p>

<p>Unfortunately apt (or apt-get) won&#39;t tell you if an update is being
held back because of phasing. This user-hostile apt issue is tracked
in <a href="https://bugs.launchpad.net/ubuntu/+source/apt/+bug/1988819">Ubuntu bug #1988819</a> and
you should add yourself as someone it affects if this is relevant
to you. Ubuntu has a web page on <a href="https://people.canonical.com/~ubuntu-archive/phased-updates.html">what updates are currently in
phased release</a>,
although packages are removed from this page once they reach 100%.
Having reached 100%, such a package is no longer a phased update,
which will become relevant soon. If you can&#39;t see a reason for a
package to be held back, it&#39;s probably a phased update but you can
check <a href="https://people.canonical.com/~ubuntu-archive/phased-updates.html">the page</a>
to be sure.</p>

<p>(As covered in <a href="https://wiki.ubuntu.com/StableReleaseUpdates#Phasing">the &#34;Phasing&#34; section</a>, packages
normally move forward through the phased rollout every six hours,
so you can have a package held back on some server in the morning
and then be not-held in the afternoon. This is great fun for
troubleshooting why a given server didn&#39;t get a particular update.)</p>

<p>Your place in a phased update is randomized across both different
servers and different packages. If you have a fleet of servers,
they will get each phased update at different times, and the order
won&#39;t be consistent from package to package. This explains an anomaly
we&#39;ve been seeing in our package updates for some time, where
different 22.04 servers would get updates at different times without
any consistent pattern.</p>

<p>The phased update related apt settings available and some of the
technical details are mostly explained in <a href="https://askubuntu.com/a/1246984">this askubuntu answer</a>. If you want to opt out of phased
updates entirely, you have two options; you can have your servers
install all phased updates right away (basically putting you at the
0% start line), or you can skip all phased updates and only install
such packages when they reach 100% and stop being considered phased
updates at all. Unfortunately, as of 22.04 there&#39;s no explicit
option to set your servers to have a particular order within all
updates (so that you can have, for example, a &#39;canary&#39; server that
always installs updates at 0% or 10%, ahead of the rest of the
fleet).</p>

<p>For any given package update, machines are randomized based on the
contents of <a href="https://www.freedesktop.org/software/systemd/man/machine-id.html"><code>/etc/machine-id</code></a>, which
can be overridden for apt by setting <code>APT::Machine-ID</code> to a 32 hex
digit value of your choice (the current version of apt appears to
only use the machine ID for phased updates).  If you set this to
the same value across your fleet, your fleet will update in sync
(although not at a predictable point in the phase process); you can
also set subsets of your fleet to different shared values so that
the groups will update at different times.  The assignment of a
particular machine to a point in the phased rollout is done through
a relatively straightforward approach; the package name, version,
and machine ID are all combined into a seed for a random number
generator, and then the random number generator is used to produce
a 0 to 100 value, which is your position in the phased rollout. The
inclusion of the package name and version means that a given machine
ID will be at different positions in the phased update for different
packages. All of this turns out to be officially documented in the
&#34;Phased Updates&#34; section of <a href="https://manpages.ubuntu.com/manpages/jammy/man5/apt_preferences.5.html">apt_preferences(5)</a>,
although not in much detail.</p>

<p>(There is a somewhat different mechanism for desktop updates, covered
in <a href="https://askubuntu.com/a/1246984">the previously mentioned askubuntu answer</a>.)</p>

<p>As far as I can see from looking at <a href="https://salsa.debian.org/apt-team/apt">the current apt source code</a>, apt doesn&#39;t log anything
at any verbosity if it holds a package back because the package is
a phased update and your machine doesn&#39;t qualify for it yet. The
fact that a package was a phased update the last time apt looked
may possibly be recorded in /var/log/apt/eipp.log.xz, but documentation
on this file is sparse.</p>

<p>Now that I&#39;ve looked at all of this and read about <code>APT::Machine-ID</code>,
we&#39;ll probably set it to a single value across all of our fleet
because we find different machines getting updates at different
times to be confusing and annoying (and it potentially complicates
troubleshooting problems that are reported to us, since we normally
assume that all 22.04 machines have the same version of things like
OpenSSH). If we could directly control the position within a phased
rollout we&#39;d probably set up some canary machines, but since we
can&#39;t I don&#39;t think there&#39;s a strong reason to have more than one
machine-id group of machines.</p>

<p>(We could set some very important machines to only get updates when
packages reach 100% and stop being phased updates, but Ubuntu has
a good record of not blowing things up with eg OpenSSH updates.)</p>
</div></div>
  </body>
</html>
