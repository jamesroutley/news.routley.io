<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.undeadly.org/cgi?action=article;sid=20230417074903">Original</a>
    <h1>OpenBSD: Malloc leak detection available in -current</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>Contributed by
<a href="http://bsdly.blogspot.com/">Peter N. M. Hansteen</a>
on <time datetime="2023-04-17T07:18:03Z">2023-04-17</time>
from the freeing the chunks dept.</p>
<p><a href="https://www.openbsd.org/">OpenBSD</a> -current just grew a new tool for developers working on OpenBSD to detect unsafe behaviors in their code. OpenBSD lets you more easily track memory allocations and whether allocations are properly freed after use.
</p><p>
In a message to <code>tech@</code>, Otto Moerbeek (<code>otto@</code>) <a href="https://marc.info/?l=openbsd-tech&amp;m=168171382927798&amp;w=2">announced</a> the new functionality:
</p><blockquote><pre>Subject:    malloc leak detection available in -current
From:       Otto Moerbeek &lt;otto () drijf ! net&gt;
Date:       2023-04-17 6:43:19

Hi,

OpenBSD current now has built-in malloc leak detection.

Make sure you run current and have debug symbols (OpenBSD base
libraries have debug symbols, compile your own program with -g).
</pre></blockquote>
<blockquote><pre>To record the leak report:
$ MALLOC_OPTIONS=D ktrace -tu a.out

To view the leak report:
$ kdump -u malloc

Example output:

******** Start dump a.out *******
M=8 I=1 F=0 U=0 J=1 R=0 X=0 C=0 cache=64 G=0
Leak report:
                 f     sum      #    avg
               0x0 1088864   9722    112 addr2line -e &#39;?&#39; 0x0
       0xf4b73093c   31136    278    112 addr2line -e a.out 0x1093c

******** End dump a.out *******

$ addr2line -e a.out 0x1093c
/home/otto/x.c:6

Some additional info:

The null &#34;f&#34; values (call sites) are due to the sampling nature of
small allocations. Recording all call sites of all potential leaks
introduces too much overhead.

Note that aggresssive optimizations might confuse the line numbers
reported.

For -static programs, compile with -nopie to make addr2line work.

In some cases will want to use the packaged version of addr2line
(gaddr2line, in the binutils package) as the base addr2line does not
grok all debug info formats.

	-Otto

</pre></blockquote>
<p>
This represents one important step in the ongoing work of making OpenBSD the better environment for developing secure, well behaved code.

</p></div></div>
  </body>
</html>
