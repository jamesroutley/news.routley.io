<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.valcanbuild.tech/handling-corporate-firewalls/">Original</a>
    <h1>How I learned about corporate firewalls</h1>
    
    <div id="readability-page-1" class="page"><div>
				<p>This is story about how I learned to be a little bit less naive about the web and how it works. But it&#39;s also a story of user experience and what we owe our users in terms of error handling - even when it&#39;s not us that cause the problem. </p><h2 id="it-all-started-with-a-support-email">It all started with a support email</h2><p>A while ago I received an email from a customer of my website, <a href="https://www.thankbox.com">Thankbox</a>, with the following:</p><figure><img src="https://www.valcanbuild.tech/content/images/2022/10/image.png" alt="" loading="lazy" width="990" height="442" srcset="https://www.valcanbuild.tech/content/images/size/w600/2022/10/image.png 600w, https://www.valcanbuild.tech/content/images/2022/10/image.png 990w" sizes="(min-width: 720px) 720px"/><figcaption>Slightly edited to maintain user privacy</figcaption></figure><p>&#34;Probably another case of someone not filling in the payment form right.&#34; I thought. I was just about to respond with my generic saved answer but then I looked at the email again. </p><p>Did they say they <strong>can</strong> <strong>click</strong> on the &#34;Pay and Send&#34; button? And nothing happens?</p><h3 id="the-payment-form-isnt-working-right">The payment form isn&#39;t working right</h3><p>As a bit of context - my product, Thankbox, is an online group card service. People use it to set up a card for someone&#39;s occasion (e.g. their birthday) and collect messages. Then once they&#39;re ready to send it they get a simple form where they put their payment information and recipient email:</p><figure><img src="https://www.valcanbuild.tech/content/images/2022/10/image-1.png" alt="" loading="lazy" width="788" height="994" srcset="https://www.valcanbuild.tech/content/images/size/w600/2022/10/image-1.png 600w, https://www.valcanbuild.tech/content/images/2022/10/image-1.png 788w" sizes="(min-width: 720px) 720px"/><figcaption>The Thankbox Pay &amp; Send form</figcaption></figure><p>I want to point your attention towards the <strong>disabled </strong>Pay &amp; Send button there. It&#39;s disabled because the Stripe payment info isn&#39;t filled out. This is the typical customer support I was used to dealing with - someone forgetting to enter their postal code, for example. </p><figure><img src="https://www.valcanbuild.tech/content/images/2022/10/image-2.png" alt="" loading="lazy" width="787" height="365" srcset="https://www.valcanbuild.tech/content/images/size/w600/2022/10/image-2.png 600w, https://www.valcanbuild.tech/content/images/2022/10/image-2.png 787w" sizes="(min-width: 720px) 720px"/><figcaption>When the payment details are filled the button is enabled</figcaption></figure><p>But this user was saying that they could click on the button and nothing happened when they did. &#34;This shouldn&#39;t happen&#34; I thought (as any good engineer who doesn&#39;t know what&#39;s happening would). </p><p>This is what should happen when you click the &#34;Pay &amp; send&#34; button:</p><ol><li>The Thankbox recipient details (email and schedule time) are updated.</li><li>A request is made to Stripe to process the payment and handle any verification.</li><li>Once the payment is processed a confirmation message is shown and the user is navigated to another page.</li></ol><p>Any error scenario that could happen along that path should surface an error on the form. I try to be meticulous about error scenarios and testing when it comes to payment code. I knew that Stripe errors would surface correctly after Step 2 and so would my own server errors.</p><p>So I replied to the user and asked for a screenshot to confirm that they were indeed seeing what they said they were.</p><p>I received a reply a few hours later and what the user was saying was true - it showed the full form filled out with the payment button enabled.</p><h3 id="the-payment-form-isnt-sending-information-what-how">The payment form isn&#39;t sending information... What, how?</h3><p>I had a look at my Stripe dashboard to find more information about the payment the user was trying to make. Sure enough it showed as incomplete.</p><figure><img src="https://www.valcanbuild.tech/content/images/2022/10/image-3.png" alt="" loading="lazy" width="812" height="204" srcset="https://www.valcanbuild.tech/content/images/size/w600/2022/10/image-3.png 600w, https://www.valcanbuild.tech/content/images/2022/10/image-3.png 812w" sizes="(min-width: 720px) 720px"/></figure><p>Ok, at least I&#39;ve not charged and not delivered. I also looked at my database and saw the user&#39;s updates weren&#39;t coming.</p><p>Now I asked myself the question -<strong> &#34;How?&#34; </strong>How is it that these requests aren&#39;t even coming through?</p><h3 id="error-logging-to-the-rescue">Error logging to the rescue</h3><p>I had already dove into my error logs a couple of times trying to figure out what was going on with this but I didn&#39;t find much. That, I realized, was because I had really only put error logs around things I was expecting and assuming. Like the fact that I&#39;d always be getting a JSON response back from request to my own server for example.</p><p>So I decided to put in a more generic handler to catch all errors and report them to my error logger.</p><pre><code>catch (error) {
    if (hasOwn(error, &#39;response&#39;)) {
        this.errors = error.response?.data?.errors || {}
        this.reportError(error.response?.data)
    } else {
        // New Logic here
        this.reportError(error)
    }
}</code></pre><p>I then asked the user to try again and observed the logs. What I saw confused my innocent frontend soul:</p><figure><img src="https://www.valcanbuild.tech/content/images/2022/10/image-4.png" alt="" loading="lazy" width="2000" height="180" srcset="https://www.valcanbuild.tech/content/images/size/w600/2022/10/image-4.png 600w, https://www.valcanbuild.tech/content/images/size/w1000/2022/10/image-4.png 1000w, https://www.valcanbuild.tech/content/images/size/w1600/2022/10/image-4.png 1600w, https://www.valcanbuild.tech/content/images/2022/10/image-4.png 2268w" sizes="(min-width: 720px) 720px"/><figcaption>The logged error</figcaption></figure><p>Why was I getting a 403 HTML response back? </p><h2 id="the-relevationthe-post-request-is-getting-firewalled">The relevation - the POST request is getting firewalled</h2><p>I copied the HTML into a file, ran it and saw the following:</p><figure><img src="https://www.valcanbuild.tech/content/images/2022/10/CleanShot-2022-10-03-at-15.47.42.png" alt="" loading="lazy" width="1069" height="515" srcset="https://www.valcanbuild.tech/content/images/size/w600/2022/10/CleanShot-2022-10-03-at-15.47.42.png 600w, https://www.valcanbuild.tech/content/images/size/w1000/2022/10/CleanShot-2022-10-03-at-15.47.42.png 1000w, https://www.valcanbuild.tech/content/images/2022/10/CleanShot-2022-10-03-at-15.47.42.png 1069w" sizes="(min-width: 720px) 720px"/></figure><p>Aha, so an overzealous IT network decided to block the request before it even reached my server. It helpfully spits out this HTML response in return but, of course, my frontend code was expecting a JSON response. I had no idea I was ever going to get anything different.</p><p>Now that I knew what was happening I could at least try to handle it.</p><p>I quickly emailed the user back and let them know that their IT system was blocking the payment from coming through. I advised them to try on their home network or their mobile data and to also kindly ask their IT department if they wouldn&#39;t mind whitelisting my website.</p><p>But I also had to handle all future such errors.</p><h3 id="the-solutionjust-show-users-these-errors-duh">The solution - just show users these errors, duh</h3><p>If these errors are coming back from IT firewalls then I should just show them to my users. Â That way they can at least know that <strong>my website isn&#39;t broken</strong>, which is what everyone who had the issue up until this point must have been thinking. </p><p>I wrote up a little Axios interceptor that checks for 403 or 503 responses (I noticed firewalls using both) that contain HTML and then I stored that inside the axios response itself.</p><pre><code>// Possibly a corporate network blocking a request and returning an HTML error page that we should display
if ((statusCode === 403 || statusCode === 503) &amp;&amp; response?.headers[&#39;content-type&#39;]?.includes(&#39;text/html&#39;)) {
    response[&#39;html-403&#39;] = response?.data
}</code></pre><p>Then, anywhere in my code where I needed to handle the possibility of this error I just added some code to check for the existence of <code>html-403</code> and show it in a new window for the user to see - that&#39;s what <code>showHtmlPage</code> does. Here is the example of how I handle it on the send page:</p><pre><code>catch (error) {
    const htmlForbiddenBody = error.response?.[&#39;html-403&#39;]
    if (htmlForbiddenBody) {
        showHtmlPage(htmlForbiddenBody)
        showAlert({
            message: &#39;Could not send Thankbox due to an external error.&#39;,
            level: &#39;error&#39;,
        })
    }
}</code></pre><h3 id="this-is-a-lot-more-common-than-you-think">This is a lot more common than you think</h3><p>Ever since adding this I&#39;ve not had another customer support email show up. I have noticed, however, that it&#39;s actually way more common than I thought. Because I now surface these types of errors as a separate type in my error logger I can see how common they are.</p><p><strong>Around 10 of these happen every week</strong>. Most often it&#39;s users on locked down government or corporate networks. Occasionally it&#39;s universities, too. I&#39;m now comfortable knowing that these users aren&#39;t getting a weird error where nothing happens on their page, but instead get to go annoy at their IT department.</p>
			</div></div>
  </body>
</html>
