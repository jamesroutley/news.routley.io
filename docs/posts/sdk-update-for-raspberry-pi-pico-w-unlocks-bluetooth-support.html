<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/raspberrypi/pico-sdk/releases/tag/1.5.0">Original</a>
    <h1>SDK update for Raspberry Pi Pico W unlocks Bluetooth support</h1>
    
    <div id="readability-page-1" class="page"><div data-pjax="true" data-test-selector="body-content" data-view-component="true"><p>This release contains new libraries and functionality, along with numerous bug fixes and documentation improvements.</p>
<p>Highlights are listed below, or you can see the full list of individual commits <a href="https://github.com/raspberrypi/pico-sdk/pulls?q=is%3Apr+milestone%3A1.5.0+is%3Amerged">here</a>, and the full list of resolved issues <a href="https://github.com/raspberrypi/pico-sdk/issues?q=is%3Aissue+milestone%3A1.5.0+is%3Aclosed">here</a>.</p>
<p>Note, these release notes are long and may appear truncated in the &#34;Releases&#34; tab; you can see the full version <a href="https://github.com/raspberrypi/pico-sdk/releases/tag/1.5.0">here</a>.</p>
<h3>New Board Support</h3>
<p>The following boards have been added and may be specified via <code>PICO_BOARD</code>:</p>
<ul>
<li><code>nullbits_bit_c_pro</code></li>
<li><code>waveshare_rp2040_lcd_1.28</code></li>
<li><code>waveshare_rp2040_one</code></li>
</ul>
<h3>Library Changes/Improvements</h3>
<h4>hardware_clocks</h4>
<ul>
<li><code>clock_gpio_init()</code> now takes a <code>float</code> for the clock divider value, rather than an <code>int</code>.</li>
<li>Added <code>clock_gpio_init_int_frac()</code> function to allow initialization of integer and fractional part of the clock divider value, without using <code>float</code>.</li>
<li>Added <code>--ref-min</code> option to <code>vocalc.py</code> to override the minimum reference frequency allowed.</li>
<li><code>vocalc.py</code> now additionally considers reference frequency dividers greater than 1.</li>
</ul>
<h4>hardware_divider</h4>
<ul>
<li>Improved the performance of <code>hw_divider_</code> functions.</li>
</ul>
<h4>hardware_dma</h4>
<ul>
<li>Added <code>dma_sniffer_set_output_invert_enabled()</code> and <code>dma_sniffer_set_output_reverse_enabled()</code> functions to configure the DMA sniffer.</li>
<li>Added <code>dma_sniffer_set_data_accumulator()</code> and <code>dma_sniffer_get_data_accumulator()</code> functions to access the DMA sniffer accumulator.</li>
</ul>
<h4>hardware_i2c</h4>
<ul>
<li>Added <code>i2c_get_instance()</code> function for consistency with other <code>hardware_</code> libraries.</li>
<li>Added <code>i2c_read_byte_raw()</code>, <code>i2c_write_byte_raw()</code> functions to directly read and write the I2C data register for an I2C instance.</li>
</ul>
<h4>hardware_timer</h4>
<ul>
<li>Added <code>hardware_alarm_claim_unused()</code> function to claim an unused hardware timer.</li>
</ul>
<h4>pico_cyw43_arch</h4>
<ul>
<li>Added <code>cyw43_arch_wifi_connect_bssid_</code> variants of <code>cyw43_arch_wifi_connect_</code> functions to allow connection to a specific access point.</li>
<li>Blocking <code>cyw43_arch_wifi_connect_</code> functions now continue trying to connect rather than failing immediately if the network is not found.</li>
<li><code>cyw43_arch_wifi_connect_</code> functions now return consistent return codes (<code>PICO_OK</code>, or <code>PICO_ERROR_XXX</code>).</li>
<li>The <code>pico_cyw43_arch</code> library has been completely rewritten on top of the new <code>pico_async_context</code> library that generically abstracts the different types of asynchronous operation (<code>poll</code>, <code>threadsafe_background</code> and <code>freertos</code>) previously handled in a bespoke fashion by <code>pico_cyw43_arch</code>. Many edge case bugs have been fixed as a result of this. Note that this change should be entirely backwards compatible from the user point of view.</li>
<li><code>cyw43_arch_init()</code> and <code>cyw43_arch_deinit()</code> functions are now very thin layers which handle <code>async_context</code> life-cycles, along with adding support for the <code>cyw43_driver</code>, <code>pico_lwip</code> etc. to that <code>async_context</code>. Currently, these mechanisms remain the preferred documented way to initialize Pico W networking, however you are free to do similar initialization/de-initialization yourself.</li>
<li>Added <code>cyw43_arch_set_async_context()</code> function to specify a custom <code>async_context</code> prior to calling <code>cyw43_arch_init*()</code></li>
<li>Added <code>cyw43_arch_async_context()</code> function to get the <code>async_context</code> used by the CYW43 architecture support.</li>
<li>Added <code>cyw43_arch_init_default_async_context()</code> function to return the <code>async_context</code> that <code>cyw43_arch_init*()</code> would initialize if one has not been set by the user.</li>
<li>Added <code>cyw43_arch_wait_for_work_until()</code> function to block until there is networking work to be done. This is most useful for <code>poll</code> style applications that have no other work to do and wish to sleep until <code>cyw43_arch_poll()</code> needs to be called again.</li>
</ul>
<h4>pico_cyw43_driver</h4>
<ul>
<li>The functionality has been clarified into 3 separate libraries:
<ul>
<li><code>cyw43_driver</code> - the raw cyw43_driver code.</li>
<li><code>cyw43_driver_picow</code> - additional support for communication with the Wi-Fi chip over SPI on Pico W.</li>
<li><code>pico_cyw43_driver</code> - integration of the cyw43_driver with the <code>pico-sdk</code> via <code>async_context</code></li>
</ul>
</li>
<li>Added <code>CYW43_WIFI_NVRAM_INCLUDE_FILE</code> define to allow user to override the NVRAM file.</li>
</ul>
<h4>pico_divider</h4>
<ul>
<li>Improved the performance of 64-bit divider functions.</li>
</ul>
<h4>pico_platform</h4>
<ul>
<li>Add <code>panic_compact()</code> function that discards the message to save space in non-debug (<code>NEBUG</code> defined) builds.</li>
</ul>
<h4>pico_runtime</h4>
<ul>
<li>Added proper implementation of certain missing <code>newlib</code> system APIs: <code>_gettimeofday()</code>, <code>_times()</code>, <code>_isatty()</code>, <code>_getpid()</code>.</li>
<li>The above changes enable certain additional C/C++ library functionality such as <code>gettimeofday()</code>, <code>times()</code> and <code>std::chrono</code>.</li>
<li>Added <code>settimeofday()</code> implementation such that <code>gettimeofday()</code> can be meaningfully used.</li>
<li>Added default (return <code>-1</code>) implementations of the remaining <code>newlib</code> system APIs: <code>_open()</code>, <code>_close()</code>, <code>_lseek()</code>, <code>_fstat()</code>, <code>_isatty()</code>, <code>_kill()</code>, to prevent warnings on GCC 12.</li>
<li>Made all <code>newlib</code> system API implementations <em>weak</em> so the user can override them.</li>
</ul>
<h4>pico_stdio</h4>
<ul>
<li><code>pico_stdio</code> allows for outputting from within an IRQ handler that creates the potential for deadlocks (especially with <code>pico_stdio_usb</code>), and the intention is to <em>not</em> deadlock but instead discard output in any cases where a deadlock would otherwise occur. The code has been revamped to avoid more deadlock cases, and a new define <code>PICO_STDIO_DEADLOCK_TIMEOUT_MS</code> has been added to catch remaining cases that might be caused by user level locking.</li>
<li>Added <code>stdio_set_chars_available_callback()</code> function to set a callback to be called when input is available. See also the new <code>PICO_STDIO_USB_SUPPORT_CHARS_AVAILABLE_CALLBACK</code> and <code>PICO_STDIO_UART_SUPPORT_CHARS_AVAILABLE_CALLBACK</code> defines which both default to <code>1</code> and control the availability of this new feature for USB and UART stdio respectively (at the cost of a little more code).</li>
<li>Improved performance of <code>stdio_semihosting</code>.</li>
<li>Give the user more control over the USB descriptors of <code>stdio_usb</code> via <code>USBD_VID</code>, <code>USBD_PID</code>, <code>USBD_PRODUCT</code>, <code>PICO_STDIO_USB_CONNECTION_WITHOUT_DTR</code> and <code>PICO_STDIO_USB_DEVICE_SELF_POWERED</code></li>
</ul>
<h4>pico_sync</h4>
<ul>
<li>Added <code>critical_section_is_initialized()</code> function to test if a critical section has been initialized.</li>
<li>Added <code>mutex_try_enter_block_until()</code> function to wait only up to a certain time to acquire a mutex.</li>
</ul>
<h4>pico_time</h4>
<ul>
<li>Added <code>from_us_since_boot()</code> function to convert a <code>uint64_t</code> timestamp to an <code>absolute_time_t</code>.</li>
<li>Added <code>absolute_time_min()</code> function to return the earlier of two <code>absolute_time_t</code> values.</li>
<li>Added <code>alarm_pool_create_with_unused_hardware_alarm()</code> function to create an alarm pool using a hardware alarm number claimed using <code>hardware_alarm_claim()</code>.</li>
<li>Added <code>alarm_pool_core_num()</code> function to determine what core an alarm pool runs on.</li>
<li>Added <code>alarm_pool_add_alarm_at_force_in_context()</code> function to add an alarm, and have it always run in the IRQ context even if the target time is in the past, or during the call. This may be simpler in some cases than dealing with the <code>fire_if_past</code> parameters to existing functions, and avoids some callbacks happening from non IRQ context.</li>
</ul>
<h4>pico_lwip</h4>
<ul>
<li>Added <code>pico_lwip_mqtt</code> library to expose the MQTT app functionality in lwIP.</li>
<li>Added <code>pico_lwip_mdns</code> library to expose the MDNS app functionality in lwIP.</li>
<li>Added <code>pico_lwip_freertos</code> library for <code>NO_SYS=0</code> with FreeRTOS as a complement to <code>pico_lwip_nosys</code> for <code>NO_SYS=1</code>.</li>
</ul>
<h4>TinyUSB</h4>
<ul>
<li>TinyUSB has upgraded from 0.12.0 to 0.15.0. See TinyUSB release notes <a href="https://github.com/hathach/tinyusb/releases">here</a> for details.</li>
<li>Particularly <em>host</em> support should be massively improved.</li>
<li>Defaulted new <code>PICO_RP2040_USB_DEVICE_UFRAME_FIX</code> variable to <code>1</code> as a workaround for errata RP2040-E15.This sets the default value for TinyUSB&#39;s <code>dcd_rp2040</code> driver&#39;s <code>TUD_OPT_RP2040_USB_DEVICE_UFRAME_FIX</code> flag. This fix is required for correctness, but comes at the cost of some performance, so applications that won&#39;t ever be plugged into a Pi 4 or Pi 400 can optionally disable this by setting the value to <code>0</code>.</li>
</ul>
<h3>New Libraries</h3>
<h4>pico_async_context</h4>
<ul>
<li>Provides support for asynchronous events (timers/IRQ notifications) to be handled in a safe context without concurrent execution (as required by many asynchronous 3rd party libraries).</li>
<li>Provides implementations matching those previously implemented in <code>pico_cyw43_arch</code>:
<ul>
<li><code>poll</code> - Not thread-safe; the user must call <code>async_context_poll()</code> periodically from their main loop, but can call <code>async_context_wait_for_work_until()</code> to block until work is required.</li>
<li><code>threadsafe_background</code> - No polling is required; instead asynchronous work is performed in a low priority IRQ. Locking is provided such that IRQ/non-IRQ or multiple cores can interact safely.</li>
<li><code>freertos</code> - Asynchronous work is performed in a separate FreeRTOS task.</li>
</ul>
</li>
<li><code>async_context</code> guarantees all callbacks happen on a single core.</li>
<li><code>async_context</code> supports multiple instances for providing independent context which can execute concurrently with respect to each other.</li>
</ul>
<h4>pico_i2c_slave</h4>
<ul>
<li>A (slightly modified) pico_i2c_slave library from <a href="https://github.com/vmilea/pico_i2c_slave">https://github.com/vmilea/pico_i2c_slave</a></li>
<li>Adds a callback style event API for handling I2C slave requests.</li>
</ul>
<h4>pico_mbedtls</h4>
<ul>
<li>Added <code>pico_mbedtls</code> library to provide MBed TLS support. You can depend on both <code>pico_lwip_mbedtls</code> and <code>pico_mbedtls</code> to use MBed TLS and lwIP together. See the <a href="https://github.com/raspberrypi/pico-examples/tree/master/pico_w/wifi/tls_client.c">tls_client</a> example in <code>pico-examples</code> for more details.</li>
</ul>
<h4>pico_rand</h4>
<ul>
<li>Implements a new Random Number Generator API.</li>
<li><code>pico_rand</code> generates random numbers at runtime utilizing a number of possible entropy, and uses those sources to modify the state of a 128-bit &#39;Pseudo Random Number Generator&#39; implemented in software.</li>
<li>Adds <code>get_rand_32()</code>, <code>get_rand_64()</code> and <code>get_rand_128()</code> functions to return largely unpredictable random numbers (which should be different on each board/run for example).</li>
</ul>
<h4>Miscellaneous</h4>
<ul>
<li>Added a new header <code>hardware/structs/nvic.h</code> with a struct for the Arm Cortex M0+ NVIC available via the <code>nvic_hw</code> pointer.</li>
<li>Added new <code>PICO_CXX_DISABLE_ALLOCATION_OVERRIDES</code> which can be set to <code>1</code> if you do not want <code>pico_standard_link</code> to include non-exceptional overrides of <code>std::new</code>, <code>std::new[]</code>, <code>std::delete</code> and <code>std::delete[]</code> when exceptions are disabled.</li>
<li><code>elf2uf2</code> now correctly uses <code>LMA</code> instead of <code>VMA</code> of the entry point to determine binary type (flash/RAM). This is required to support some exotic binaries correctly.</li>
</ul>
<h3>Build</h3>
<ul>
<li>The build will now check for a functional compiler via the standard <code>CMake</code> mechanism.</li>
<li>The build will pick up pre-installed <code>elf2uf2</code> and <code>pioasm</code> if found via an installed <code>pico-sdk-tools</code> <code>CMake</code> package. If it can do so, then no native compiler is required for the build!</li>
<li>It is now possible to switch the board type <code>PICO_BOARD</code> in an existing <code>CMake</code> build directory.</li>
<li><code>ARCHIVE_OUTPUT_DIRECTORY</code> is now respected in build for <code>UF2</code> output files.</li>
<li>Spaces are now supported in the path to the <code>pico-sdk</code></li>
<li>All libraries <code>xxx</code> in the <code>pico-sdk</code> now support a <code>xxx_headers</code> variant that just pulls in the libraries&#39;  headers. These <code>xxx_headers</code> libraries correctly mirror the dependencies of the <code>xxx</code> libraries, so you can use <code>xxx_headers</code> instead of <code>xxx</code> as your dependency if you do not want to pull in any implementation files (perhaps if you are making a <code>STATIC</code> library). Actually the &#34;all&#34; is not quite true, non code libraries such as <code>pico_standard_link</code> and <code>pico_cxx_options</code> are an exception.</li>
</ul>
<h3>Bluetooth Support for Pico W (BETA)</h3>
<p>The support is currently available as a beta. More details will be forthcoming with the actual release.</p>
<p>Key changes:</p>
<ul>
<li>The Bluetooth API is provided by <a href="https://github.com/bluekitchen/btstack">BTstack</a>.</li>
<li>The following new libraries are provided that expose core BTstack functionality:
<ul>
<li><code>pico_btstack_ble</code> - Adds Bluetooth Low Energy (LE) support.</li>
<li><code>pico_btstack_classic</code> - Adds Bluetooth Classic support.</li>
<li><code>pico_btstack_sbc_encoder</code> - Adds Bluetooth Sub Band Coding (SBC) encoder support.</li>
<li><code>pico_btstack_sbc_decoder</code> - Adds Bluetooth Sub Band Coding (SBC) decoder support.</li>
<li><code>pico_btstack_bnep_lwip</code> - Adds Bluetooth Network Encapsulation Protocol (BNEP) support using LwIP.</li>
<li><code>pico_btstack_bnep_lwip_sys_freertos</code> - Adds Bluetooth Network Encapsulation Protocol (BNEP) support using LwIP with FreeRTOS for <code>NO_SYS=0</code>.</li>
</ul>
</li>
<li>The following integration libraries are also provided:
<ul>
<li><code>pico_btstack_run_loop_async_context</code> - provides a common <code>async_context</code> backed implementation of a BTstack <em>&#34;run loop&#34;</em> that can be used for all BTstack use with the <code>pico-sdk</code>.</li>
<li><code>pico_btsack_flash_bank</code> - provides a sample implementation for storing required Bluetooth state in flash.</li>
<li><code>pico_btstack_cyw43</code> - integrates BTstack with the CYW43 driver.</li>
</ul>
</li>
<li>Added <code>CMake</code> function <code>pico_btstack_make_gatt_header</code> that can be used to run the BTstack <code>compile_gatt</code> tool to make a GATT header file from a BTstack <code>GATT</code> file.</li>
<li>Updated <code>pico_cyw43_driver</code> and <code>cyw43_driver</code> to support HCI communication for Bluetooth.</li>
<li>Updated <code>cyw43_driver_picow</code> to support Pico W specific HCI communication for Bluetooth over SPI.</li>
<li>Updated <code>cyw43_arch_init()</code> and <code>cyw43_arch_deinit()</code> to additionally handle Bluetooth support if <code>CYW43_ENABLE_BLUETOOTH</code> is <code>1</code> (as it will be automatically if you depend on <code>pico_btstack_cyw43</code>).</li>
</ul>
<h3>Authors</h3>
<p>Thanks to the following for their contributions:</p>
<p>alastairpatrick,</p></div></div>
  </body>
</html>
