<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://louwrentius.com/my-71-tib-zfs-nas-after-10-years-and-zero-drive-failures.html">Original</a>
    <h1>My 71 TiB ZFS NAS After 10 Years and Zero Drive Failures</h1>
    
    <div id="readability-page-1" class="page"><div>
              <p>My <a href="https://louwrentius.com/71-tib-diy-nas-based-on-zfs-on-linux.html">4U 71 TiB ZFS NAS</a> built with twenty-four 4 TB drives is over 10 years old and still going strong.</p>
<p><img alt="my nas" src="https://louwrentius.com/static/images/zfsnas01.jpg"/></p>
<p>Although now on its second motherboard and power supply, the system has yet to experience a single drive failure (knock on wood).</p>
<p>Zero drive failures in ten years, how is that possible?</p>
<h2>Let&#39;s talk about the drives first</h2>
<p>The 4 TB HGST drives have roughly 6000 hours on them after ten years. You might think something&#39;s off and you&#39;d be right. That&#39;s only about 250 days worth of runtime. And therein lies the secret of drive longevity (I think):</p>
<p><strong>Turn the server off when you&#39;re not using it.</strong></p>
<hr/>
<p>According to people on <a href="https://news.ycombinator.com/item?id=41536088">Hacker News</a> I have my bearings wrong. The chance of having zero drive failures over 10 years for 24 drives is much higher than I thought it was. So this good result may not be related to turning my NAS off and keeping it off most off the time.</p>
<hr/>
<p>My NAS is turned off by default. I only turn it on (remotely) when I need to use it. I use a script to turn the IoT power bar on and once the BMC (Baseboard Management Controller) is done booting, I use <a href="https://en.wikipedia.org/wiki/Intelligent_Platform_Management_Interface">IPMI</a> to turn on the NAS itself. But I could have used <a href="https://en.wikipedia.org/wiki/Wake-on-LAN">Wake-on-Lan</a> too as an alternative.</p>
<p>Once I&#39;m done using the server, I run a small script that turns the server off, wait a few seconds and then turn the wall socket off. </p>
<p>It wasn&#39;t enough for me to just turn off the server, but leave the motherboard, and thus the BMC powered, because that&#39;s just a constant 7 watts (about two Raspberry Pis at idle) being wasted (24/7).</p>
<p>This process works for me because I run other services on low-power devices such as Raspberry Pi4s or servers that use <em>much less power</em> when idling than my &#39;big&#39; NAS. </p>
<p>This proces reduces my energy bill considerably (primary motivation) and also seems great for hard drive longevity.</p>
<p>Although zero drive failures to date is awesome, N=24 is not very representative and I could just be very lucky. Yet, it was the same story with the <a href="https://louwrentius.com/20-disk-18-tb-raid-6-storage-based-on-debian-linux.html">predecessor of this NAS</a>, a machine with 20 drives (1 TB Samsung Spinpoint F1s (remember those?)) and I also had zero drive failures during its operational lifespan (~5 years).</p>
<h2>The motherboard (died once)</h2>
<p>Although the drives are still ok, I had to replace the motherboard a few years ago. The failure mode of the motherboard was interesting: it was impossible to get into the BIOS and it would occasionally fail to boot. I tried the obvious like removing the CMOS battery and such but to no avail.</p>
<p>Fortunately, the [motherboard]<sup id="fnref:same"><a href="#fn:same">1</a></sup> was still available on Ebay for a decent price so that ended up not being a big deal. </p>
<h2>ZFS</h2>
<p>ZFS worked fine for all these years. I&#39;ve switched operating systems over the years and I never had an issue importing the pool back into the new OS install.
If I would build a new storage server, I would definitely use ZFS again.</p>
<p>I run a zpool scrub on the drives a few times a year<sup id="fnref:longduration"><a href="#fn:longduration">2</a></sup>. The scrub has <em>never found a single checksum error</em>. I must have run so many scrubs, more than a <em>petabyte</em> of data must have been read from the drives (all drives combined) and ZFS didn&#39;t have to kick in.</p>
<p>I&#39;m not surprised by this result at all. Drives tend to fail most often in two modes:</p>
<ol>
<li>Total failure, drive isn&#39;t even detected</li>
<li>Bad sectors (read or write failures)</li>
</ol>
<p>There is a third failure mode, but it&#39;s extremely rare: <strong>silent data corruption</strong>. Silent data corruption is &#39;silent&#39; because a disk isn&#39;t aware it delivered corrupted data. Or the SATA connection didn&#39;t detect any checksum errors. </p>
<p>However, due to all the low-level checksumming, this risk is extremely small. It&#39;s a real risk, don&#39;t get me wrong, but it&#39;s a small risk. To me, it&#39;s a risk you mostly care about at scale, in datacenters<sup id="fnref:enterprise"><a href="#fn:enterprise">4</a></sup> but for residential usage, it&#39;s totally reasonable to accept the risk<sup id="fnref:risk"><a href="#fn:risk">3</a></sup>. </p>
<p>But ZFS is not that difficult to learn and if you are well-versed in Linux or FreeBSD, it&#39;s absolutely worth checking out. Just <a href="https://louwrentius.com/the-hidden-cost-of-using-zfs-for-your-home-nas.html">remember</a>!</p>
<p><img alt="inside" src="https://louwrentius.com/static/images/nano/topview.jpg"/></p>
<h2>Sound levels (It&#39;s Oh So Quiet)</h2>
<p>This NAS is <em>very</em> quiet for a NAS (<a href="https://youtu.be/LS3cfl-7n-4">video with audio</a>). </p>
<p>But to get there, I had to do some work.</p>
<p>The chassis contains three sturdy 12V fans that cool the 24 drive cages. These fans are extremely loud if they run at their default speed. But because they are so beefy, they are fairly quiet when they run at idle RPM, yet they still provide enough airflow, most of the time. But running at idle speeds was not enough as the drives would heat up eventually, especially when they are being read from / written to.</p>
<p>Fortunately, the particular Supermicro motherboard I bought at the time allows all fan headers to be controlled through Linux. So I decided to create a <a href="https://github.com/louwrentius/storagefancontrol">script</a> that sets the fan speed according to the temperature of the hottest drive in the chassis.</p>
<p>I actually visited a math-related subreddit and asked for an algorithm that would best fit my need to create a silent setup and also keep the drives cool.
Somebody recommended to use a &#34;<a href="https://en.wikipedia.org/wiki/Proportional–integral–derivative_controller">PID controller</a>&#34;, which I knew nothing about. So I wrote some Python, stole some example Python PID controller code, and tweaked the parameters to find a balance between sound and cooling performance.</p>
<p>The script has worked very well over the years and kept the drives at 40C or below. PID controllers are awesome and I feel it should be used in much more equipment that controls fans, temperature, and so on, instead of &#39;dumb&#39; on/of behaviour or less &#39;dumb&#39; lookup tables.</p>
<h2>Networking</h2>
<p>I started out with quad-port gigabit network controllers and I used <a href="https://louwrentius.com/achieving-450-mbs-network-file-transfers-using-linux-bonding.html">network bonding</a> to get around 450 MB/s network transfer speeds between various systems. This setup required a ton of UTP cables so eventually I got bored with that and I bought some cheap <a href="https://louwrentius.com/using-infiniband-for-cheap-and-fast-point-to-point-networking.html">Infiniband</a> cards and that worked fine, I could reach around 700 MB/s between systems. As I decided to move away from Ubuntu and back to Debian, I faced a problem: the Infiniband cards didn&#39;t work anymore and I could not figure out how to fix it. So I decided to buy some second-hand 10Gbit Ethernet cards and those work totally fine to this day.</p>
<h2>The dead power supply</h2>
<p>When you turn this system on, all drives spin up at once (no staggered spinup) and that draws around 600W for a few seconds. I remember that the power supply was rated for 750W and the 12 volt rail would have been able to deliver enough power, but it would sometimes cut out at boot nonetheless.</p>
<h2>UPS (or lack thereof)</h2>
<p>For many years, I used a beefy UPS with the system, to protect against power failure, just to be able to shutdown cleanly during an outage. This worked fine, but I noticed that the UPS used another 10+ watts on top of the usage of the server and I decided it had to go.</p>
<p>Losing the system due to power shenanigans is a risk I accept.</p>
<h2>Backups (or a lack thereof)</h2>
<p>My most important data is backed up trice. But a lot of data stored on this server isn&#39;t important enough for me to backup. I rely on replacement hardware and ZFS protecting against data loss due to drive failure.</p>
<p>And if that&#39;s not enough, I&#39;m out of luck. I&#39;ve accepted that risk for 10 years. Maybe one day my luck will run out, but until then, I enjoy what I have.</p>
<h2>Future storage plans (or lack thereof)</h2>
<p>To be frank, I don&#39;t have any. I built this server back in the day because I didn&#39;t want to shuffle data around due to storage space constraints and I still have ample space left.</p>
<p>I have a spare motherboard, CPU, Memory and a spare HBA card so I&#39;m quite likely able to revive the system if something breaks.</p>
<p>As hard drive sizes have increased tremendously, I may eventually move away from the 24-drive bay chassis into a smaller form-factor. It&#39;s possible to create the same amount of redundant storage space with only 6-8 hard drives with RAIDZ2 (RAID 6) redundancy. Yet, storage is always expensive. </p>
<p>But another likely scenario is that in the coming years this system eventually dies and I decide not to replace it at all, and my storage hobby will come to an end.</p>

            </div></div>
  </body>
</html>
