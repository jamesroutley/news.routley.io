<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.os2museum.com/wp/learn-something-old-every-day-part-ix-aha-154xb-and-aspi4dos-sys/">Original</a>
    <h1>Learn Something Old Every Day, Part IX: Aha-154xB and ASPI4DOS.SYS</h1>
    
    <div id="readability-page-1" class="page"><div>
						
<p>The other day I had a pressing “need” to examine the behavior of Adaptec 154x and compatible SCSI HBAs and their DOS drivers. I found the hard way that the AHA-154xB does not work with Adaptec’s last DOS drivers from circa 1999. That includes the drivers <a href="https://storage.microsemi.com/en-us/speed/scsi/dos/dosdrvr_exe.php">still available for download</a> (ASPI4DOS.SYS version 3.36), as well as the driver shipped with OEM versions of Windows 98SE (ASPI4DOS.SYS version 3.36S).</p>



<p>The error message is far from enlightening; effectively the driver acts as if there were no HBA at all.</p>


<div>
<figure><a href="https://www.os2museum.com/wp/wp-content/uploads/2023/08/aha1540b-aspi4dos-fail.png"><img decoding="async" fetchpriority="high" width="640" height="356" src="https://www.os2museum.com/wp/wp-content/uploads/2023/08/aha1540b-aspi4dos-fail-640x356.png" alt="" srcset="http://www.os2museum.com/wp/wp-content/uploads/2023/08/aha1540b-aspi4dos-fail-640x356.png 640w, http://www.os2museum.com/wp/wp-content/uploads/2023/08/aha1540b-aspi4dos-fail-300x167.png 300w, http://www.os2museum.com/wp/wp-content/uploads/2023/08/aha1540b-aspi4dos-fail.png 720w" sizes="(max-width: 640px) 100vw, 640px"/></a><figcaption>ASPI4DOS.SYS 3.36 and AHA-154xB don’t like each other</figcaption></figure></div>


<p>Quite unsurprisingly, this problem has <a href="https://www.vogons.org/viewtopic.php?t=48877">been</a> <a href="https://modelrail.otenko.com/retro/ibm-ps-55-z-replacing-the-guts">noticed</a> <a href="https://forum.classic-computing.de/forum/index.php?thread/23941-ms-dos-mit-platte-1gb-am-aha-1542b/">before</a>. It has been also observed that ASPI4DOS.SYS version 3.35 works fine, as do older versions. But why is the 3.36 driver really not working with AHA-154xB?</p>



<p>First of all, it’s not because the AHA-154xB is not supposed to be supported. The README.TXT file in the latest driver package clearly lists Adaptec AHA-1540B/1542B as supported, together with the newer ‘C’, ‘CF’, and ‘CP’ variants. It’s obvious that Adaptec didn’t actually test the driver on an AHA-154xB board… which is not hugely surprising since the 3.36 driver is from December 1998, and the ‘B’ variant was obsoleted by the much more modern ‘C’ in February 1993. Six or so years later, Adaptec probably barely had any of the ‘B’ variants left.</p>



<p>Note that the even older AHA-1540A/1542A and the original AHA-1540 (with no suffix) are not listed as supported. Those models were probably never very widespread and were replaced in 1990 with a cheaper, more capable ‘B’ variant, which did sell in significant quantities.</p>



<p>The reason for the ASPI4DOS.SYS failure is quite interesting. The AHA-154x interface was relatively simple and well designed for the time (circa 1987), became more or less an industry standard, and therefore became the target of cloning (notably by BusLogic). In their own drivers, Adaptec wanted to distinguish its own boards from clones.</p>



<p>Both Adaptec and BusLogic drivers used the I/O port at offset 3 from the I/O base (e.g. port 333h for a HBA configured at I/O base 330h) as part of their clone detection logic. This register was not documented by either Adaptec and BusLogic, and therefore many drivers shipped with operating systems didn’t use it, but Adaptec’s and BusLogic’s own drivers did.</p>



<p>On the Adaptec AHA-154xB (and presumably older variants as well), the register actually does not exist. Reads always return FFh and writing has no effect. On the BusLogic HBAs, the register is always present, is writable by the host (but normally never written), and the high bit is set if the HBA is configured to support disks larger than 1 GB.</p>



<p>On the AHA-154xC, Adaptec changed the behavior and made the register return ASCII letters ‘ADAP’ in a round-robin fashion.</p>



<p>Needless to say, ASPI4DOS.SYS version 3.36 checks for this behavior. It does not assume a known initial state, and therefore expects that reading the register four times might return ‘ADAP’, but also ‘DAPA’ or ‘APAD’ or ‘PADA’. To work around the ambiguity, the driver reads the register four times, adds the values together, and checks if the sum equals 16h. If not, it declares the HBA ‘not an Adaptec’ and ignores it. And that is the bug—the check will fail on an AHA-1540B.</p>



<p>No known driver shipped with an OS reads the ‘ADAP’ signature. But for example Adaptec’s DOS-based SCSIFMT.EXE utility version 1.33 uses the signature to distinguish between the AHA-154xC and earlier variants.</p>



<p>ASPI4DOS.SYS version 3.36 incorrectly insists that the ‘ADAP’ signature must be present and therefore fails to work with AHA-154xB adapters. It is pretty clear why Adaptec didn’t catch the bug (the ‘B’ variant was rather old at the time), although it’s much less clear why the driver logic was changed in the first place.</p>



<p>It should not be difficult to patch out the ‘ADAP’ signature check from ASPI4DOS.SYS, but for an AHA-154xB one might as well use ASPI4DOS.SYS <a href="ftp://ftp.brain.it/public/Driver/Adaptec/Dos%20DRV%20scompattati/dosdrvr.exe">version 3.35</a> or earlier and forget that version 3.36 ever existed.</p>
											</div></div>
  </body>
</html>
