<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/rprinz08/hBPF">Original</a>
    <h1>HBPF â€“ eBPF in Hardware</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/rprinz08/hBPF/blob/main/doc/images/hbpf-logo-l.png"><img src="https://github.com/rprinz08/hBPF/raw/main/doc/images/hbpf-logo-l.png" alt=""/></a></p>
<p dir="auto">An <a href="https://ebpf.io/" rel="nofollow">extended Berkley Packet Filter (eBPF)</a>
CPU written entirely in <a href="https://www.python.org/" rel="nofollow">Python3</a>
for PC and FPGA.</p>
<h2 dir="auto"><a id="user-content-history" aria-hidden="true" href="#history"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>History</h2>
<p dir="auto">Back in 1992 the original <a href="http://www.tcpdump.org/papers/bpf-usenix93.pdf" rel="nofollow">Berkeley Packet Filter (BPF)</a>
was designed
for capturing and filtering network packets that matched
specific rules. Filters are implemented as programs to be run
on a register-based virtual RISC machine providing a small
number of instructions inside the Linux Kernel.</p>
<p dir="auto">Soon it became clear that extending the Kernel by
user-supplied programs proves to be useful. But the design of
the virtual machine e.g instruction set (ISA) or register
width (32-bit vs. 64-bit) couldn&#39;t keep up with the demands.</p>
<p dir="auto">At some point <a href="https://lwn.net/Articles/599755/" rel="nofollow">in 2014</a>,
work to extend the existing BPF virtual machine started to
make it useful in other parts of the Linux Kernel. More,
wider registers, additional instructions and a JIT eventually
resulted in <a href="https://ebpf.io/" rel="nofollow">extended BPF</a>. The original
and now obsolete BPF version has been retroactively renamed
to <strong>classic BPF (cBPF)</strong>. Nowadays, the Linux Kernel runs
eBPF only and loaded cBPF bytecode is transparently
translated into eBPF before execution.</p>
<p dir="auto">The <em>hPBF</em> project now implements most of eBPF features in
hardware (FPGA).</p>
<h2 dir="auto"><a id="user-content-goals" aria-hidden="true" href="#goals"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Goals</h2>
<p dir="auto">This project was started beginning of 2021 as an experiment
of how fast and how far you can get, with using alternate
hardware description languages (compared to the classic &#39;V&#39;
languages VHDL and Verilog), most of the time open-source
tools (compared to expensive, commercial toolchains) and
cheap development boards (e.g <a href="https://reference.digilentinc.com/reference/programmable-logic/arty-s7/start" rel="nofollow">Arty-S7</a>).</p>
<p dir="auto">It is not meant to compete with multi-core accelerator cards
like <a href="https://www.xilinx.com/products/boards-and-kits/alveo.html" rel="nofollow">Xilinx Alveo</a>, instead its used to gain
insights and perform experiments.</p>
<h2 dir="auto"><a id="user-content-current-state" aria-hidden="true" href="#current-state"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Current State</h2>
<ul dir="auto">
<li>
<p dir="auto">All unit-tests pass</p>
</li>
<li>
<p dir="auto">Can process binaries created with assembler or C (LLVM) without any changes</p>
</li>
<li>
<p dir="auto">Partially optimized</p>
<ul dir="auto">
<li>This is a constant work in progress ...</li>
<li>Statistic information per test case is collected as described <a href="https://github.com/rprinz08/hBPF/blob/main/doc/statistics.md">here</a>.</li>
<li>Clock cycles per op-code are <a href="https://github.com/rprinz08/hBPF/blob/main/doc/opcodes.md">available here</a>.</li>
</ul>
<p dir="auto">Many op-codes require 1 clock cycle, jumps (conditional and unconditional) require 2 clock cycles and math op-codes like <code>mod</code> or <code>div</code> require the most clock cycles to complete.</p>
</li>
<li>
<p dir="auto">no stack</p>
</li>
</ul>
<p dir="auto">Additional infos can be found in the <a href="https://www.min.at/hbpf" rel="nofollow">Blog</a>.</p>
<p dir="auto">Tested with:</p>
<p dir="auto">Migen Git commit: 9a0be7a4210ff96043412539eb5388659b81831d</p>
<p dir="auto">LiteX Git commit: 85d6cb4b8df98730bd83b412dff6108df188bbb4</p>
<p dir="auto">LiteETH Git commit: 7acb2a8c1c1abda63496d422d093dc6bbfe135a8</p>
<p dir="auto"><em>Note: Ensure that you build hBPF with above Git commits of LiteX/Migen dependencies.</em></p>
<h2 dir="auto"><a id="user-content-installation" aria-hidden="true" href="#installation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Installation</h2>
<p dir="auto">The following instructions gets you going, assuming no
requirements are installed on your system. If some of the
required components are already available then skip the
corresponding steps or packages.</p>
<div data-snippet-clipboard-copy-content="# Install system dependencies (assuming Debian based distro)
$ sudo apt install git curl clang python3-pip make xxd libpcap0.8-dev openocd
# If you prefer &#39;hexdump&#39; over of &#39;xxd&#39;...
$ sudo apt install bsdmainutils"><pre><span><span>#</span> Install system dependencies (assuming Debian based distro)</span>
$ sudo apt install git curl clang python3-pip make xxd libpcap0.8-dev openocd
<span><span>#</span> If you prefer &#39;hexdump&#39; over of &#39;xxd&#39;...</span>
$ sudo apt install bsdmainutils</pre></div>
<div data-snippet-clipboard-copy-content="# For ubpf which uses python2
$ sudo apt install python-pip
$ pip install --user -r tools/ubpf/requirements.txt"><pre><span><span>#</span> For ubpf which uses python2</span>
$ sudo apt install python-pip
$ pip install --user -r tools/ubpf/requirements.txt</pre></div>
<div data-snippet-clipboard-copy-content="# Python3 dependencies
$ pip3 install --user colour_runner
$ pip3 install --user git+https://github.com/javawizard/parcon"><pre><span><span>#</span> Python3 dependencies</span>
$ pip3 install --user colour_runner
$ pip3 install --user git+https://github.com/javawizard/parcon</pre></div>
<div data-snippet-clipboard-copy-content="# Install rust - needed to compile tools
# See additional infos at:
# https://www.rust-lang.org/tools/install
$ curl --proto &#39;=https&#39; --tlsv1.2 -sSf https://sh.rustup.rs | sh
$ source $HOME/.cargo/env"><pre><span><span>#</span> Install rust - needed to compile tools</span>
<span><span>#</span> See additional infos at:</span>
<span><span>#</span> https://www.rust-lang.org/tools/install</span>
$ curl --proto <span><span>&#39;</span>=https<span>&#39;</span></span> --tlsv1.2 -sSf https://sh.rustup.rs <span>|</span> sh
$ <span>source</span> <span>$HOME</span>/.cargo/env</pre></div>
<div data-snippet-clipboard-copy-content="# Create project root folder (e.g. projects)
$ mkdir -p projects
$ cd projects"><pre><span><span>#</span> Create project root folder (e.g. projects)</span>
$ mkdir -p projects
$ <span>cd</span> projects</pre></div>
<div data-snippet-clipboard-copy-content="# Install Litex
# See additional infos at:
# https://github.com/enjoy-digital/litex
$ mkdir litex
$ cd litex
$ curl -o litex_setup.py https://raw.githubusercontent.com/enjoy-digital/litex/master/litex_setup.py
$ chmod +x litex_setup.py
$ ./litex_setup.py init install --user"><pre><span><span>#</span> Install Litex</span>
<span><span>#</span> See additional infos at:</span>
<span><span>#</span> https://github.com/enjoy-digital/litex</span>
$ mkdir litex
$ <span>cd</span> litex
$ curl -o litex_setup.py https://raw.githubusercontent.com/enjoy-digital/litex/master/litex_setup.py
$ chmod +x litex_setup.py
$ ./litex_setup.py init install --user</pre></div>
<div data-snippet-clipboard-copy-content="# Install hBPF
$ cd ..
$ git clone https://github.com/rprinz08/hBPF.git
$ cd hbpf
$ git submodule init
$ git submodule update"><pre><span><span>#</span> Install hBPF</span>
$ <span>cd</span> ..
$ git clone https://github.com/rprinz08/hBPF.git
$ <span>cd</span> hbpf
$ git submodule init
$ git submodule update</pre></div>
<div data-snippet-clipboard-copy-content="# Compile Tools
$ cd tools/rust-cbpf
$ cargo build
$ cd ../wishbone-utils/wishbone-tool
$ cargo build"><pre><span><span>#</span> Compile Tools</span>
$ <span>cd</span> tools/rust-cbpf
$ cargo build
$ <span>cd</span> ../wishbone-utils/wishbone-tool
$ cargo build</pre></div>
<div data-snippet-clipboard-copy-content="# run Tests in tests folder
$ cd ../../../tests

# Test CPU emulator:
# This completes fast
$ ./test_vm.py

# Test FPGA simulation:
# This takes time ......
$ ./test_fpga_sim.py

# Test hardware:
# This needs an FPGA board ....
# (ensure that you change the configuration at the top of this
# file to match your target hardware)
$ ./test_fpga_hw.py"><pre><span><span>#</span> run Tests in tests folder</span>
$ <span>cd</span> ../../../tests

<span><span>#</span> Test CPU emulator:</span>
<span><span>#</span> This completes fast</span>
$ ./test_vm.py

<span><span>#</span> Test FPGA simulation:</span>
<span><span>#</span> This takes time ......</span>
$ ./test_fpga_sim.py

<span><span>#</span> Test hardware:</span>
<span><span>#</span> This needs an FPGA board ....</span>
<span><span>#</span> (ensure that you change the configuration at the top of this</span>
<span><span>#</span> file to match your target hardware)</span>
$ ./test_fpga_hw.py</pre></div>
<p dir="auto">For working with hardware you need in addition to the above,
a toolchain which supports your board/target.
This project includes two boards/targets from
Xilinx so to build the FPGA bitstreams yourself
you have to install <a href="https://www.xilinx.com/products/design-tools/vivado.html" rel="nofollow">Xilinx Vivado</a>.</p>
<p dir="auto"><em>Note: Prebuilt bitstreams for included targets are provided.</em></p>
<h2 dir="auto"><a id="user-content-overview" aria-hidden="true" href="#overview"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Overview</h2>
<p dir="auto">The main purpose of implementing an eBPF CPU in hardware is
the same as that of the original cBPF: processing network
packets.</p>
<p dir="auto">By attaching a hBPF CPU directly to a network PHY/MAC a form
of a <a href="https://blog.mellanox.com/2018/08/defining-smartnic/" rel="nofollow">smart NIC</a> could be created. Such a NIC is capable
to perform tasks on packets offloaded by the host CPU for
performance reasons.</p>
<p dir="auto">But a hBPF CPU has most necessary features so it can even be
used standalone as a simple microcontroller.</p>
<p dir="auto">The following picture shows an overview of how hBPF can be
used.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/rprinz08/hBPF/blob/main/doc/images/hbpf-overview.png"><img src="https://github.com/rprinz08/hBPF/raw/main/doc/images/hbpf-overview.png" alt="hBPF overview"/></a></p>
<p dir="auto">hBPF is implemented using the <a href="https://github.com/enjoy-digital/litex">LiteX</a>
SoC builder framework. LiteX itself is based on <a href="https://github.com/m-labs/migen">Migen</a>, a toolbox to create FPGA designs in Python3.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/rprinz08/hBPF/blob/main/doc/images/cpu.png"><img src="https://github.com/rprinz08/hBPF/raw/main/doc/images/cpu.png" alt="hBPF CPU"/></a></p>
<p dir="auto">The hBPF CPU has access to separated program- and data-memory
(<a href="https://en.wikipedia.org/wiki/Harvard_architecture" rel="nofollow">Harvard architecture</a>).
Data-memory (8-Bit) holds network
packets (defaults to 2048 bytes) which are processed based on the
instructions in program memory (64-Bit, defaults to 1024 bytes).</p>
<p dir="auto">At the moment the <code>/reset</code> signals goes HIGH,
the CPU starts processing instructions read
from program memory.
When processing the <code>exit</code> instruction, the <code>halt</code>
signal goes high and the CPU stops processing
instructions. Whenever an error occurs (e.g
division by 0, invalid instruction etc.) the
<code>error</code> signal is set HIGH and the CPU stops
processing instructions setting signal <code>halt</code>
HIGH as well.</p>
<p dir="auto">Registers R1 - R5 are not cleared on reset and can be used
as input arguments to a program, register R0 is used to
return something. The same mechanism is also used when
calling FPGA extensions by using <a href="https://github.com/rprinz08/hBPF/blob/main/doc/call_handler.md">call-handlers</a>.</p>
<p dir="auto">When CPU starts, internal <code>ticks</code> register is
cleared and incremented every clock tick until CPU
halts which can be used to measure execution speed.</p>
<p dir="auto">The <strong>math.divider</strong> submodule contains decimal divider and
the <strong>math.shifter</strong> a left/right shifter including arithmetic
shifts.</p>
<p dir="auto">The project includes the following components:</p>
<h3 dir="auto"><a id="user-content-emulator" aria-hidden="true" href="#emulator"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Emulator</h3>
<p dir="auto">To get a better understanding of how eBPF works an emulator
was developed in Python3. It implements a complete eBPF CPU
in Python and was a playground to try out concepts and
experiment with opcodes. The emulator code itself is not used
in the FPGA implementations.</p>
<h3 dir="auto"><a id="user-content-simulator" aria-hidden="true" href="#simulator"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Simulator</h3>
<p dir="auto">The FPGA implementation of hBPF was done using LiteX and Migen
tools. The same Python3 code which later is converted
to Verilog can be tested with the simulation capabilities
from LiteX.</p>
<h3 dir="auto"><a id="user-content-fpga-implementations" aria-hidden="true" href="#fpga-implementations"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>FPGA Implementations</h3>
<p dir="auto">The LiteX hBPF implementation can be converted to
Verilog and processed by toolchains for various
target devices and boards. Included are three real
hardware implementations for Xilinx devices
(Spartan7, Artix7 and Zynq) on
<a href="https://digilent.com/reference/programmable-logic/arty-s7/start" rel="nofollow">Arty-S7</a>,
<a href="https://digilent.com/reference/programmable-logic/arty-a7/start" rel="nofollow">Arty-A7</a> and
<a href="https://digilent.com/reference/programmable-logic/zybo-z7/start" rel="nofollow">Zybo-Z7</a> boards.</p>
<p dir="auto">Based on the following overview, they can be used to
test and debug hBPF and also to run the HW
unit-tests as described under <em>testing</em> further
down. They are not connected to an Ethernet PHY/MAC at the moment. Next samples will show how to use LiteETH to process real network packets.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/rprinz08/hBPF/blob/main/doc/images/hbpf-debug-overview.png"><img src="https://github.com/rprinz08/hBPF/raw/main/doc/images/hbpf-debug-overview.png" alt="test-overview"/></a></p>
<p dir="auto">Each implementation requires about 10500 LUTs
including Wishbone Bridge and LiteScope Debugger.
The CPU core alone requires about 8000 LUTs. Both
implementations were tested with 100MHz.</p>
<h3 dir="auto"><a id="user-content-deviations-from-ebpf" aria-hidden="true" href="#deviations-from-ebpf"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Deviations from eBPF</h3>
<p dir="auto">In contrast to the eBPF implementation used in the Linux
Kernel, hBPF has some deviations and differences.</p>
<h4 dir="auto"><a id="user-content-calls" aria-hidden="true" href="#calls"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Calls</h4>
<p dir="auto">In eBPF, the <code>call</code> instruction is used to call selected
subroutines in the Linux Kernel (so called <em>Helper Functions</em>). In the hBPF implementation, the <code>call</code> opcode can be used to extend the CPU by means of <a href="https://github.com/rprinz08/hBPF/blob/main/doc/call_handler.md">call-handlers</a>.</p>
<h4 dir="auto"><a id="user-content-register-r1" aria-hidden="true" href="#register-r1"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Register R1</h4>
<p dir="auto">In the Linux eBPF implementation register R1 is used as base
pointer to the data-memory. This is not necessary for hBPF so
register R1 is used as input argument just as R2 - R5.</p>
<h4 dir="auto"><a id="user-content-stack" aria-hidden="true" href="#stack"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Stack</h4>
<p dir="auto">Not supported at the moment.</p>
<h2 dir="auto"><a id="user-content-development" aria-hidden="true" href="#development"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Development</h2>
<p dir="auto">This section is divided in two parts:</p>
<ul dir="auto">
<li>
<p dir="auto">Developing hBPF</p>
<p dir="auto">describes how to develop hBPF itself, modifying or extending it.</p>
</li>
<li>
<p dir="auto">Developing for hBPF</p>
<p dir="auto">describes how to develop software which runs on a hBPF (or eBPF) CPU.</p>
</li>
</ul>
<h2 dir="auto"><a id="user-content-developing-hbpf" aria-hidden="true" href="#developing-hbpf"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Developing hBPF</h2>
<h3 dir="auto"><a id="user-content-requirements" aria-hidden="true" href="#requirements"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Requirements</h3>
<p dir="auto">hBPF is completely written in Python3 and uses the following tools:</p>
<ul dir="auto">
<li><a href="https://www.python.org/" rel="nofollow">Python3</a></li>
<li><a href="https://github.com/enjoy-digital/litex">LiteX</a></li>
<li><a href="https://github.com/iovisor/ubpf">userspace BPF (uBPF)</a></li>
<li><a href="https://github.com/mmisono/rust-cbpf">cbpf-rust</a></li>
<li><a href="https://github.com/litex-hub/wishbone-utils">wishbone-utils</a></li>
<li>FPGA Toolchain (e.g. <a href="https://www.xilinx.com/products/design-tools/vivado.html" rel="nofollow">Xilinx Vivado</a>)</li>
<li><a href="http://openocd.org/" rel="nofollow">OpenOCD</a> to load/flash FPGA targets (can normally be done by toolchain but OpenOCD is simpler and faster)</li>
<li><a href="https://code.visualstudio.com/" rel="nofollow">VS-Code</a> as IDE and Test-runner</li>
</ul>
<h3 dir="auto"><a id="user-content-building" aria-hidden="true" href="#building"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Building</h3>
<p dir="auto">Assuming you have all prerequisites installed and their
binaries are available via search path, perform the following
steps:</p>
<ol dir="auto">
<li>
<p dir="auto">check out hBPFs Git repository</p>
</li>
<li>
<p dir="auto">open hBPF repository folder in VS-Code</p>
<ul dir="auto">
<li>start developing</li>
</ul>
</li>
<li>
<p dir="auto">run unit-tests either inside VS-Code or direct from the command line.</p>
</li>
<li>
<p dir="auto">to build an FPGA bitstream for a real hardware target, select a target in <code>source/fpga/hw</code> folder and run <code>build.py</code>.</p>
</li>
</ol>
<h3 dir="auto"><a id="user-content-testing" aria-hidden="true" href="#testing"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Testing</h3>
<p dir="auto">All three hBPF implementations can be tested using
comprehensive unit-tests. All based on the same set of test
cases. To accomplish this, the Python based eBPF assembler of
the <a href="https://github.com/iovisor/ubpf">userspace BPF (uBPF)</a> project is used.</p>
<p dir="auto">Unit-tests can either be run from inside VS-Code or direct
from command line in <code>tests</code> folder.</p>
<ul dir="auto">
<li><code>test_vm.py</code> - run test cases against emulated CPU (fast)</li>
<li><code>test_fpga_sim.py</code> - runs tests against simulated FPGA design (takes long, be patient)</li>
<li><code>test_fpga_hw.py</code> - runs test-cases against hBPF CPU running on real hardware via a serial Wishbone bridge (medium fast)</li>
</ul>
<p dir="auto">Each test-case consists of a file in the <code>test</code> (or one of
its sub-folders) folder. Test files are text files with a <code>.test</code> file extension. It consists of sections starting with
<code>--</code> describing the test. The following test description shows
a Fibonacci test with an <code>asm</code> section which is compiled on
the fly before the test is executed, an <code>args</code> section which
defines the input values, a <code>result</code> section defining whats
expected in register R0 after test completes and an <code>expected</code>
section which defines additional criteria that must be
met like the number of clock cycles the test may take.</p>
<div data-snippet-clipboard-copy-content="# Example test case description. Calculating the Fibonacci
# for provided input in register R1
-- asm
mov r0, r1
jeq r1, 0, +11
jeq r1, 1, +9
mov r3, 0
mov r0, 1
mov r2, 2
mov r4, r0
add r0, r3
add r2, 1
mov r3, r4
jgt r2, r1, +2
ja -6
mov r0, 1
exit
-- args
r1 = 9
-- result
0x22
-- expected
clocks = 324"><pre><span># Example </span><span>test</span><span> case description. Calculating the Fibonacci</span>
<span># for provided input </span><span>in</span><span> register R1</span>
<span>--</span><span> asm</span>
<span>mov</span><span> r0</span><span>,</span><span> r1</span>
<span>jeq r1</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>+</span><span>11</span>
<span>jeq r1</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>+</span><span>9</span>
<span>mov</span><span> r3</span><span>,</span><span> </span><span>0</span>
<span>mov</span><span> r0</span><span>,</span><span> </span><span>1</span>
<span>mov</span><span> r2</span><span>,</span><span> </span><span>2</span>
<span>mov</span><span> r4</span><span>,</span><span> r0</span>
<span>add</span><span> r0</span><span>,</span><span> r3</span>
<span>add</span><span> r2</span><span>,</span><span> </span><span>1</span>
<span>mov</span><span> r3</span><span>,</span><span> r4</span>
<span>jgt r2</span><span>,</span><span> r1</span><span>,</span><span> </span><span>+</span><span>2</span>
<span>ja</span><span> </span><span>-</span><span>6</span>
<span>mov</span><span> r0</span><span>,</span><span> </span><span>1</span>
<span>exit</span>
<span>--</span><span> args</span>
<span>r1 = </span><span>9</span>
<span>--</span><span> result</span>
<span>0x22</span>
<span>--</span><span> expected</span>
<span>clocks = </span><span>324</span></pre></div>
<p dir="auto">Also available are a <code>raw</code> section which describes a test
program as hex dump and a <code>mem</code> section which describes the
data-memory as hex dump.</p>
<p dir="auto">Before executing a test the <code>asm</code> section is compiled to
binary and sent to the device under test (either the
emulator, simulator or hardware). For real hardware this is
done using the Wishbone serial bridge. If a <code>raw</code> section is
found in the test description it is sent after converting to
binary from hex dump. Also the data-memory is loaded from the
<code>mem</code> section contents if available.</p>
<p dir="auto">Next input registers R1-R5 are set according to <code>args</code>
section. If section is not available or some
registers are not set in section then they are set to 0. To
start the test the hBPF CPU is brought out of reset by
setting <code>RESET_N</code> signal to HIGH and monitoring hBPF CPU
signals until <code>HALT</code> signal goes high or expected clocks
(when not specified default clocks = 1000) are reached. Then
control signals and output register R0 are compared against
the test definition.</p>
<p dir="auto">In addition, statistic information per test case is collected as described
<a href="https://github.com/rprinz08/hBPF/blob/main/doc/statistics.md">here</a>.</p>
<h2 dir="auto"><a id="user-content-developing-for-hbpf" aria-hidden="true" href="#developing-for-hbpf"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Developing for hBPF</h2>
<p dir="auto">The existing eBPF development tools (compilers, assemblers,
filters) can be used to develop for hBPF. Samples can be found
in the <code>development</code> directory.</p>
<h2 dir="auto"><a id="user-content-hardware-targets-and-examples" aria-hidden="true" href="#hardware-targets-and-examples"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Hardware targets and examples</h2>
<p dir="auto">Some examples on the included targets are provided:</p>
<p dir="auto">hBPF development targets</p>
<ul dir="auto">
<li><a href="https://github.com/rprinz08/hBPF/blob/main/source/fpga/hw/arty-s7-50/readme.md">Arty S7</a></li>
<li><a href="https://github.com/rprinz08/hBPF/blob/main/source/fpga/hw/arty-a7-100/readme.md">Arty A7</a></li>
<li><a href="https://github.com/rprinz08/hBPF/blob/main/source/fpga/hw/zybo-z7-20/readme.md">Zybo Z7</a></li>
</ul>
<p dir="auto">Packet processing with LiteETH and hBPF</p>
<ul dir="auto">
<li><a href="https://github.com/rprinz08/hBPF/blob/main/source/fpga/hw/arty-s7-50-nic/readme.md">Arty S7 MultiNIC</a></li>
</ul>
<h2 dir="auto"><a id="user-content-misc" aria-hidden="true" href="#misc"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Misc</h2>
<p dir="auto">This project is by no means complete or error free or
production ready. Feel free to play with it and contribute if
you find a bug or thing which could be made better.</p>
<h3 dir="auto"><a id="user-content-license" aria-hidden="true" href="#license"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>License</h3>
<p dir="auto">This project is licensed under <strong>BSD 3-Clause License</strong>.
See <a href="https://github.com/rprinz08/hBPF/blob/main/LICENSE">LICENSE</a> file.</p>
<h3 dir="auto"><a id="user-content-contributing" aria-hidden="true" href="#contributing"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Contributing</h3>
<p dir="auto">If you would like to contribute to hBPF (which we would greatly appreciate)
please read the <a href="https://github.com/rprinz08/hBPF/blob/main/CONTRIBUTING.md">Contributing Guide</a> beforehand.</p>
<h3 dir="auto"><a id="user-content-code-of-conduct" aria-hidden="true" href="#code-of-conduct"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Code of conduct</h3>
<p dir="auto"><a href="https://github.com/rprinz08/hBPF/blob/main/CODE_OF_CONDUCT.md"><img src="https://camo.githubusercontent.com/966523edeac6e0c8fc3afeb347df2aaccd7407c0885946e96aa3c5297ebecb59/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f436f6e7472696275746f72253230436f76656e616e742d322e312d3462616161612e737667" alt="Contributor Covenant" data-canonical-src="https://img.shields.io/badge/Contributor%20Covenant-2.1-4baaaa.svg"/></a></p>
<p dir="auto">Also please read the <a href="https://github.com/rprinz08/hBPF/blob/main/CODE_OF_CONDUCT.md">Code of Conduct</a> to keep the hBPF
community approachable and respectable!</p>
<h3 dir="auto"><a id="user-content-logo--icon" aria-hidden="true" href="#logo--icon"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Logo / Icon</h3>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/rprinz08/hBPF/blob/main/doc/images/hbpf-icon-s.png"><img src="https://github.com/rprinz08/hBPF/raw/main/doc/images/hbpf-icon-s.png" alt="hBPF Icon"/></a></p>
<p dir="auto">The <strong>PCbee</strong> (Printed Circuit Board Bee) was created based
on <a href="https://github.com/rprinz08/hBPF/blob/main/ebpf.io">ebpf.io</a>&#39;s bee icon to visualize the hardware
aspect of hBPF.</p>
</article>
          </div></div>
  </body>
</html>
