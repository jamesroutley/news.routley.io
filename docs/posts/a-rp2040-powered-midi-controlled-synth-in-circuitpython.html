<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://gist.github.com/todbot/96a654c5fa27625147d65c45c8bfd47b">Original</a>
    <h1>A RP2040 Powered MIDI-Controlled Synth in CircuitPython</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="Python" data-tagsearch-path="synthio_midi_synth.py">
        <tbody><tr>
          <td id="file-synthio_midi_synth-py-L1" data-line-number="1"></td>
          <td id="file-synthio_midi_synth-py-LC1"><span># synthio_midi_synth.py - pretty usable MIDI-controlled synth using synthio in CircuitPython</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L2" data-line-number="2"></td>
          <td id="file-synthio_midi_synth-py-LC2"><span># 11 May 2023 - @todbot / Tod Kurt</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L3" data-line-number="3"></td>
          <td id="file-synthio_midi_synth-py-LC3"><span># Uses cheapie PCM5102 DAC on QTPY RP2040</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L4" data-line-number="4"></td>
          <td id="file-synthio_midi_synth-py-LC4"><span># Video demo: https://www.youtube.com/watch?v=N-PbbWWDE6k</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L5" data-line-number="5"></td>
          <td id="file-synthio_midi_synth-py-LC5"><span># Features:</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L6" data-line-number="6"></td>
          <td id="file-synthio_midi_synth-py-LC6"><span># - midi velocity controls attack rate (gentle press = slow, hard press = fast)</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L7" data-line-number="7"></td>
          <td id="file-synthio_midi_synth-py-LC7"><span># - notes have small random detune on all oscillators to reduce phase stacking</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L8" data-line-number="8"></td>
          <td id="file-synthio_midi_synth-py-LC8"><span># - adjustable number of detuned oscillators per note 1-5 (midi controller 83)</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L9" data-line-number="9"></td>
          <td id="file-synthio_midi_synth-py-LC9"><span># - five selectable waveforms: saw, squ, sin, noisy sin, noise (midi controller 82)</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L10" data-line-number="10"></td>
          <td id="file-synthio_midi_synth-py-LC10"><span># - vibrato depth on mod wheel (midi controller 1)</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L11" data-line-number="11"></td>
          <td id="file-synthio_midi_synth-py-LC11"><span>#</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L12" data-line-number="12"></td>
          <td id="file-synthio_midi_synth-py-LC12"><span>import</span> <span>time</span>, <span>random</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L13" data-line-number="13"></td>
          <td id="file-synthio_midi_synth-py-LC13"><span>import</span> <span>board</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L14" data-line-number="14"></td>
          <td id="file-synthio_midi_synth-py-LC14"><span>import</span> <span>audiobusio</span>, <span>audiomixer</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L15" data-line-number="15"></td>
          <td id="file-synthio_midi_synth-py-LC15"><span>import</span> <span>synthio</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L16" data-line-number="16"></td>
          <td id="file-synthio_midi_synth-py-LC16"><span>import</span> <span>ulab</span>.<span>numpy</span> <span>as</span> <span>np</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L17" data-line-number="17"></td>
          <td id="file-synthio_midi_synth-py-LC17">
</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L18" data-line-number="18"></td>
          <td id="file-synthio_midi_synth-py-LC18"><span>import</span> <span>usb_midi</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L19" data-line-number="19"></td>
          <td id="file-synthio_midi_synth-py-LC19"><span>import</span> <span>adafruit_midi</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L20" data-line-number="20"></td>
          <td id="file-synthio_midi_synth-py-LC20"><span>from</span> <span>adafruit_midi</span>.<span>note_on</span> <span>import</span> <span>NoteOn</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L21" data-line-number="21"></td>
          <td id="file-synthio_midi_synth-py-LC21"><span>from</span> <span>adafruit_midi</span>.<span>note_off</span> <span>import</span> <span>NoteOff</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L22" data-line-number="22"></td>
          <td id="file-synthio_midi_synth-py-LC22"><span>from</span> <span>adafruit_midi</span>.<span>control_change</span> <span>import</span> <span>ControlChange</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L23" data-line-number="23"></td>
          <td id="file-synthio_midi_synth-py-LC23"><span>import</span> <span>neopixel</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L24" data-line-number="24"></td>
          <td id="file-synthio_midi_synth-py-LC24">
</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L25" data-line-number="25"></td>
          <td id="file-synthio_midi_synth-py-LC25"><span>led</span> <span>=</span> <span>neopixel</span>.<span>NeoPixel</span>(<span>board</span>.<span>NEOPIXEL</span>, <span>1</span>, <span>brightness</span><span>=</span><span>0.2</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L26" data-line-number="26"></td>
          <td id="file-synthio_midi_synth-py-LC26"><span>midi</span> <span>=</span> <span>adafruit_midi</span>.<span>MIDI</span>(<span>midi_in</span><span>=</span><span>usb_midi</span>.<span>ports</span>[<span>0</span>], <span>in_channel</span><span>=</span><span>0</span> )</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L27" data-line-number="27"></td>
          <td id="file-synthio_midi_synth-py-LC27">
</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L28" data-line-number="28"></td>
          <td id="file-synthio_midi_synth-py-LC28"><span># qtpy rp2040 SPI pins, be sure PCM5102 SCK is tied to Gnd</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L29" data-line-number="29"></td>
          <td id="file-synthio_midi_synth-py-LC29"><span>lck_pin</span>, <span>bck_pin</span>, <span>dat_pin</span>  <span>=</span> <span>board</span>.<span>MISO</span>, <span>board</span>.<span>MOSI</span>, <span>board</span>.<span>SCK</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L30" data-line-number="30"></td>
          <td id="file-synthio_midi_synth-py-LC30">
</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L31" data-line-number="31"></td>
          <td id="file-synthio_midi_synth-py-LC31"><span>SAMPLE_RATE</span> <span>=</span> <span>28000</span>  <span># clicks @ 36kHz &amp; 48kHz on rp2040</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L32" data-line-number="32"></td>
          <td id="file-synthio_midi_synth-py-LC32"><span>SAMPLE_SIZE</span> <span>=</span> <span>256</span>    <span># we like powers of two</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L33" data-line-number="33"></td>
          <td id="file-synthio_midi_synth-py-LC33"><span>VOLUME</span> <span>=</span> <span>12000</span>       <span># 16384 is max volume I think</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L34" data-line-number="34"></td>
          <td id="file-synthio_midi_synth-py-LC34"><span>wave_saw</span> <span>=</span> <span>np</span>.<span>linspace</span>(<span>VOLUME</span>, <span>-</span><span>VOLUME</span>, <span>num</span><span>=</span><span>SAMPLE_SIZE</span>, <span>dtype</span><span>=</span><span>np</span>.<span>int16</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L35" data-line-number="35"></td>
          <td id="file-synthio_midi_synth-py-LC35"><span>wave_squ</span> <span>=</span> <span>np</span>.<span>concatenate</span>((<span>np</span>.<span>ones</span>(<span>SAMPLE_SIZE</span><span>//</span><span>2</span>, <span>dtype</span><span>=</span><span>np</span>.<span>int16</span>)<span>*</span><span>VOLUME</span>,<span>np</span>.<span>ones</span>(<span>SAMPLE_SIZE</span><span>//</span><span>2</span>, <span>dtype</span><span>=</span><span>np</span>.<span>int16</span>)<span>*</span><span>-</span><span>VOLUME</span>))</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L36" data-line-number="36"></td>
          <td id="file-synthio_midi_synth-py-LC36"><span>wave_sin</span> <span>=</span> <span>np</span>.<span>array</span>(<span>np</span>.<span>sin</span>(<span>np</span>.<span>linspace</span>(<span>0</span>, <span>4</span><span>*</span><span>np</span>.<span>pi</span>, <span>SAMPLE_SIZE</span>, <span>endpoint</span><span>=</span><span>False</span>)) <span>*</span> <span>VOLUME</span>, <span>dtype</span><span>=</span><span>np</span>.<span>int16</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L37" data-line-number="37"></td>
          <td id="file-synthio_midi_synth-py-LC37"><span>wave_noise</span> <span>=</span> <span>np</span>.<span>array</span>([<span>random</span>.<span>randint</span>(<span>-</span><span>VOLUME</span>, <span>VOLUME</span>) <span>for</span> <span>i</span> <span>in</span> <span>range</span>(<span>SAMPLE_SIZE</span>)], <span>dtype</span><span>=</span><span>np</span>.<span>int16</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L38" data-line-number="38"></td>
          <td id="file-synthio_midi_synth-py-LC38"><span>wave_sin_dirty</span> <span>=</span> <span>np</span>.<span>array</span>( <span>wave_sin</span> <span>+</span> (<span>wave_noise</span><span>/</span><span>4</span>), <span>dtype</span><span>=</span><span>np</span>.<span>int16</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L39" data-line-number="39"></td>
          <td id="file-synthio_midi_synth-py-LC39"><span>waveforms</span> <span>=</span> (<span>wave_saw</span>, <span>wave_squ</span>, <span>wave_sin</span>, <span>wave_sin_dirty</span>, <span>wave_noise</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L40" data-line-number="40"></td>
          <td id="file-synthio_midi_synth-py-LC40">
</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L41" data-line-number="41"></td>
          <td id="file-synthio_midi_synth-py-LC41"><span>synth</span> <span>=</span> <span>synthio</span>.<span>Synthesizer</span>(<span>sample_rate</span><span>=</span><span>SAMPLE_RATE</span>)  <span># note: no envelope or waveform, we do that in Note now!</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L42" data-line-number="42"></td>
          <td id="file-synthio_midi_synth-py-LC42"><span>audio</span> <span>=</span> <span>audiobusio</span>.<span>I2SOut</span>(<span>bit_clock</span><span>=</span><span>bck_pin</span>, <span>word_select</span><span>=</span><span>lck_pin</span>, <span>data</span><span>=</span><span>dat_pin</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L43" data-line-number="43"></td>
          <td id="file-synthio_midi_synth-py-LC43"><span>mixer</span> <span>=</span> <span>audiomixer</span>.<span>Mixer</span>(<span>voice_count</span><span>=</span><span>1</span>, <span>sample_rate</span><span>=</span><span>SAMPLE_RATE</span>, <span>channel_count</span><span>=</span><span>1</span>,</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L44" data-line-number="44"></td>
          <td id="file-synthio_midi_synth-py-LC44">                         <span>bits_per_sample</span><span>=</span><span>16</span>, <span>samples_signed</span><span>=</span><span>True</span>, <span>buffer_size</span><span>=</span><span>2048</span> ) <span># buffer_size=4096 )</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L45" data-line-number="45"></td>
          <td id="file-synthio_midi_synth-py-LC45"><span>audio</span>.<span>play</span>(<span>mixer</span>)           <span># attach mixer to DAC</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L46" data-line-number="46"></td>
          <td id="file-synthio_midi_synth-py-LC46"><span>mixer</span>.<span>voice</span>[<span>0</span>].<span>play</span>(<span>synth</span>)  <span># start synth engine playing</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L47" data-line-number="47"></td>
          <td id="file-synthio_midi_synth-py-LC47">
</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L48" data-line-number="48"></td>
          <td id="file-synthio_midi_synth-py-LC48"><span>wave_i</span> <span>=</span> <span>0</span>  <span># which waveform to play</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L49" data-line-number="49"></td>
          <td id="file-synthio_midi_synth-py-LC49"><span>num_oscs</span> <span>=</span> <span>1</span>  <span># how many oscillators per note</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L50" data-line-number="50"></td>
          <td id="file-synthio_midi_synth-py-LC50"><span>max_oscs</span> <span>=</span> <span>5</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L51" data-line-number="51"></td>
          <td id="file-synthio_midi_synth-py-LC51"><span>osc_detune</span> <span>=</span> <span>0.01</span> <span># how much detune (fatness)</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L52" data-line-number="52"></td>
          <td id="file-synthio_midi_synth-py-LC52">
</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L53" data-line-number="53"></td>
          <td id="file-synthio_midi_synth-py-LC53"><span>notes_pressed</span> <span>=</span> {}  <span># which notes are currently being pressed, and their note objects (so we can unpress them)</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L54" data-line-number="54"></td>
          <td id="file-synthio_midi_synth-py-LC54"><span>mod_val</span> <span>=</span> <span>0</span>  <span># ranges 0-1</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L55" data-line-number="55"></td>
          <td id="file-synthio_midi_synth-py-LC55">
</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L56" data-line-number="56"></td>
          <td id="file-synthio_midi_synth-py-LC56"><span>def</span> <span>note_on</span>(<span>notenum</span>, <span>vel</span>):</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L57" data-line-number="57"></td>
          <td id="file-synthio_midi_synth-py-LC57">    <span>at_time</span> <span>=</span> <span>max</span>(<span>0</span>, <span>2</span> <span>*</span> (<span>127</span><span>-</span>(<span>vel</span><span>*</span><span>1.2</span>)) <span>/</span> <span>127</span>) <span># velocity controls attack time</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L58" data-line-number="58"></td>
          <td id="file-synthio_midi_synth-py-LC58">    <span>amp_env</span> <span>=</span> <span>synthio</span>.<span>Envelope</span>(<span>attack_time</span><span>=</span><span>at_time</span>, <span>decay_time</span><span>=</span><span>0.05</span>, <span>release_time</span><span>=</span><span>0.8</span>,</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L59" data-line-number="59"></td>
          <td id="file-synthio_midi_synth-py-LC59">                               <span>attack_level</span><span>=</span><span>1</span>, <span>sustain_level</span><span>=</span><span>0.8</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L60" data-line-number="60"></td>
          <td id="file-synthio_midi_synth-py-LC60">    <span>waveform</span> <span>=</span> <span>waveforms</span>[<span>wave_i</span>]</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L61" data-line-number="61"></td>
          <td id="file-synthio_midi_synth-py-LC61">    <span>notes</span> <span>=</span> []</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L62" data-line-number="62"></td>
          <td id="file-synthio_midi_synth-py-LC62">    <span>f</span> <span>=</span> <span>synthio</span>.<span>midi_to_hz</span>(<span>notenum</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L63" data-line-number="63"></td>
          <td id="file-synthio_midi_synth-py-LC63">    <span>for</span> <span>i</span> <span>in</span> <span>range</span>(<span>num_oscs</span>):</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L64" data-line-number="64"></td>
          <td id="file-synthio_midi_synth-py-LC64">        <span>#  add detuning to oscillators + a bit of random so phases w/ other notes don&#39;t perfectly align</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L65" data-line-number="65"></td>
          <td id="file-synthio_midi_synth-py-LC65">        <span>fr</span> <span>=</span> <span>f</span> <span>*</span> (<span>1</span> <span>+</span> (<span>osc_detune</span><span>*</span><span>i</span>) <span>+</span> (<span>random</span>.<span>random</span>()<span>/</span><span>1000</span>) )</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L66" data-line-number="66"></td>
          <td id="file-synthio_midi_synth-py-LC66">        <span>print</span>(<span>&#34;fr:&#34;</span>,<span>fr</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L67" data-line-number="67"></td>
          <td id="file-synthio_midi_synth-py-LC67">        <span>notes</span>.<span>append</span>( <span>synthio</span>.<span>Note</span>( <span>frequency</span><span>=</span><span>fr</span>, <span>envelope</span><span>=</span><span>amp_env</span>, <span>waveform</span><span>=</span><span>waveform</span>,</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L68" data-line-number="68"></td>
          <td id="file-synthio_midi_synth-py-LC68">                                    <span>bend_mode</span><span>=</span><span>synthio</span>.<span>BendMode</span>.<span>VIBRATO</span>,</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L69" data-line-number="69"></td>
          <td id="file-synthio_midi_synth-py-LC69">                                    <span>bend_depth</span> <span>=</span> <span>0.5</span> <span>*</span> <span>mod_val</span>, <span>bend_rate</span> <span>=</span> <span>20</span> <span>*</span> <span>mod_val</span> ) )</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L70" data-line-number="70"></td>
          <td id="file-synthio_midi_synth-py-LC70">    <span>notes_pressed</span>[<span>notenum</span>] <span>=</span> <span>notes</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L71" data-line-number="71"></td>
          <td id="file-synthio_midi_synth-py-LC71">    <span>synth</span>.<span>press</span>(<span>notes</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L72" data-line-number="72"></td>
          <td id="file-synthio_midi_synth-py-LC72">
</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L73" data-line-number="73"></td>
          <td id="file-synthio_midi_synth-py-LC73"><span>def</span> <span>note_off</span>(<span>notenum</span>,<span>vel</span>):</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L74" data-line-number="74"></td>
          <td id="file-synthio_midi_synth-py-LC74">    <span>notes</span> <span>=</span> <span>notes_pressed</span>.<span>get</span>(<span>notenum</span>, <span>None</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L75" data-line-number="75"></td>
          <td id="file-synthio_midi_synth-py-LC75">    <span>if</span> <span>notes</span>:</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L76" data-line-number="76"></td>
          <td id="file-synthio_midi_synth-py-LC76">        <span>synth</span>.<span>release</span>(<span>notes</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L77" data-line-number="77"></td>
          <td id="file-synthio_midi_synth-py-LC77">        <span>del</span> <span>notes_pressed</span>[<span>notenum</span>]</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L78" data-line-number="78"></td>
          <td id="file-synthio_midi_synth-py-LC78">
</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L79" data-line-number="79"></td>
          <td id="file-synthio_midi_synth-py-LC79"><span>debug_notes</span> <span>=</span> <span>False</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L80" data-line-number="80"></td>
          <td id="file-synthio_midi_synth-py-LC80">
</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L81" data-line-number="81"></td>
          <td id="file-synthio_midi_synth-py-LC81"><span>print</span>(<span>&#34;synthio_midi_synth ready&#34;</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L82" data-line-number="82"></td>
          <td id="file-synthio_midi_synth-py-LC82"><span>while</span> <span>True</span>:</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L83" data-line-number="83"></td>
          <td id="file-synthio_midi_synth-py-LC83">    <span>msg</span> <span>=</span> <span>midi</span>.<span>receive</span>()</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L84" data-line-number="84"></td>
          <td id="file-synthio_midi_synth-py-LC84">    <span>if</span> <span>isinstance</span>(<span>msg</span>, <span>NoteOn</span>) <span>and</span> <span>msg</span>.<span>velocity</span> <span>!=</span> <span>0</span>:</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L85" data-line-number="85"></td>
          <td id="file-synthio_midi_synth-py-LC85">        <span>print</span>(<span>&#34;noteOn: &#34;</span>, <span>msg</span>.<span>note</span>, <span>&#34;vel=&#34;</span>, <span>msg</span>.<span>velocity</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L86" data-line-number="86"></td>
          <td id="file-synthio_midi_synth-py-LC86">        <span>led</span>.<span>fill</span>(<span>0xff00ff</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L87" data-line-number="87"></td>
          <td id="file-synthio_midi_synth-py-LC87">        <span>note_on</span>( <span>msg</span>.<span>note</span>, <span>msg</span>.<span>velocity</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L88" data-line-number="88"></td>
          <td id="file-synthio_midi_synth-py-LC88">        <span>if</span> <span>debug_notes</span>: <span>print</span>(<span>&#34;notes_pressed:&#34;</span>, <span>notes_pressed</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L89" data-line-number="89"></td>
          <td id="file-synthio_midi_synth-py-LC89">    <span>elif</span> <span>isinstance</span>(<span>msg</span>,<span>NoteOff</span>) <span>or</span> <span>isinstance</span>(<span>msg</span>,<span>NoteOn</span>) <span>and</span> <span>msg</span>.<span>velocity</span><span>==</span><span>0</span>:</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L90" data-line-number="90"></td>
          <td id="file-synthio_midi_synth-py-LC90">        <span>print</span>(<span>&#34;noteOff:&#34;</span>, <span>msg</span>.<span>note</span>, <span>&#34;vel=&#34;</span>, <span>msg</span>.<span>velocity</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L91" data-line-number="91"></td>
          <td id="file-synthio_midi_synth-py-LC91">        <span>led</span>.<span>fill</span>(<span>0x00000</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L92" data-line-number="92"></td>
          <td id="file-synthio_midi_synth-py-LC92">        <span>note_off</span>( <span>msg</span>.<span>note</span>, <span>msg</span>.<span>velocity</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L93" data-line-number="93"></td>
          <td id="file-synthio_midi_synth-py-LC93">        <span>if</span> <span>debug_notes</span>: <span>print</span>(<span>&#34;notes_pressed:&#34;</span>, <span>notes_pressed</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L94" data-line-number="94"></td>
          <td id="file-synthio_midi_synth-py-LC94">    <span>elif</span> <span>isinstance</span>(<span>msg</span>,<span>ControlChange</span>):</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L95" data-line-number="95"></td>
          <td id="file-synthio_midi_synth-py-LC95">        <span>print</span>(<span>&#34;controlChange&#34;</span>, <span>msg</span>.<span>control</span>, <span>&#34;=&#34;</span>, <span>msg</span>.<span>value</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L96" data-line-number="96"></td>
          <td id="file-synthio_midi_synth-py-LC96">        <span>if</span> <span>msg</span>.<span>control</span> <span>==</span> <span>1</span>: <span># mod wheel</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L97" data-line-number="97"></td>
          <td id="file-synthio_midi_synth-py-LC97">            <span>mod_val</span> <span>=</span> <span>msg</span>.<span>value</span> <span>/</span> <span>127</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L98" data-line-number="98"></td>
          <td id="file-synthio_midi_synth-py-LC98">            <span>for</span> <span>notes</span> <span>in</span> <span>notes_pressed</span>.<span>values</span>():</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L99" data-line-number="99"></td>
          <td id="file-synthio_midi_synth-py-LC99">                <span>for</span> <span>n</span> <span>in</span> <span>notes</span>:  <span># adjust vibrato depth &amp; rate for all notes</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L100" data-line-number="100"></td>
          <td id="file-synthio_midi_synth-py-LC100">                    <span>n</span>.<span>bend_depth</span> <span>=</span> <span>0.5</span> <span>*</span> <span>mod_val</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L101" data-line-number="101"></td>
          <td id="file-synthio_midi_synth-py-LC101">                    <span>n</span>.<span>bend_rate</span> <span>=</span> <span>20</span> <span>*</span> <span>mod_val</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L102" data-line-number="102"></td>
          <td id="file-synthio_midi_synth-py-LC102">        <span>elif</span> <span>msg</span>.<span>control</span> <span>==</span> <span>82</span>:  <span># leftmost slider on minilab3</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L103" data-line-number="103"></td>
          <td id="file-synthio_midi_synth-py-LC103">            <span>num_oscs</span> <span>=</span> <span>int</span>( <span>1</span> <span>+</span> (<span>msg</span>.<span>value</span><span>/</span><span>127</span>) <span>*</span> <span>max_oscs</span> )</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L104" data-line-number="104"></td>
          <td id="file-synthio_midi_synth-py-LC104">            <span>print</span>(<span>&#34;num_oscs:&#34;</span>,<span>num_oscs</span>)</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L105" data-line-number="105"></td>
          <td id="file-synthio_midi_synth-py-LC105">        <span>elif</span> <span>msg</span>.<span>control</span> <span>==</span> <span>83</span>:  <span># leftmost+1 slider on minilab3</span></td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L106" data-line-number="106"></td>
          <td id="file-synthio_midi_synth-py-LC106">            <span>wave_i</span> <span>=</span> <span>int</span>( (<span>msg</span>.<span>value</span><span>/</span><span>127</span>) <span>*</span> (<span>len</span>(<span>waveforms</span>)<span>-</span><span>1</span>) )</td>
        </tr>
        <tr>
          <td id="file-synthio_midi_synth-py-L107" data-line-number="107"></td>
          <td id="file-synthio_midi_synth-py-LC107">            <span>print</span>(<span>&#34;wave_i:&#34;</span>,<span>wave_i</span>)</td>
        </tr>
  </tbody></div></div>
  </body>
</html>
