<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.spice-space.org/usbredir.html">Original</a>
    <h1>usbredir: A protocol for sending USB device traffic over a network connection</h1>
    
    <div id="readability-page-1" class="page"><div>
    
    
    <p>usbredir is the name of a network protocol for sending USB device
traffic over a network connection. It is also the name of the software
package offering a parsing library, a usbredirhost library and several
utilities implementing this protocol.</p>
<p>The protocol is documented
<a href="https://gitlab.freedesktop.org/spice/usbredir/raw/master/usb-redirection-protocol.txt">here</a>,
this document also explains what is meant with a usbhost and a usbguest.</p>
<p>usbredir was created for use with Spice, which is why it is hosted on
spice-space.org, but the protocol and the usbredirhost are completely
independent of spice, they could for example also be used to create a
vnc extension for redirecting USB devices over a vnc connection to a
qemu virtual machine.</p>
<p>The usbguest side is currently only implemented for qemu, and shipped as
part of qemu (enabling this in qemu requires the libusbredirparser
library to be available when building qemu).</p>
<p>usbredir supports USB device filtering configurable by a filter string</p>
<div id="host-configuration">
<h2>Host Configuration</h2>
<p>For redirection to work, the virtual machine must have a supported USB
controller. Qemu supports both USB2 and USB3, but at the time of
writing, USB3 has had less testing. For USB2 support, the guest must
have a EHCI controller and companion UHCI controller (companion UHCI is needed
in order to support also USB1.x devices). For USB3 support, an XHCI controller
is required.
It also needs to have Spice channels for USB redirection. The number of such
channels determine the number of USB devices that it&#39;s possible to redirect at
the same time.</p>
<p>More information about USB controllers in qemu could be found
<a href="http://git.qemu-project.org/?p=qemu.git;a=blob_plain;f=docs/usb2.txt;hb=HEAD">here</a>.</p>
<div id="using-virt-manager">
<h3>Using virt-manager</h3>
<p>Virtual machines created with virt-manager should have a USB controller
by default. In the virtual machine details, select &#34;Controller USB&#34; in
the left pane. If you only need to support USB2 devices, make sure its
model is set to &#34;USB2&#34;. For USB 3.0 support, select &#34;USB3&#34; for the
model type.</p>
<p>You can then click on &#34;Add Hardware&#34; and add &#34;USB Redirection&#34; items as the
number of USB devices you want to be able to redirect simultaneously.</p>
</div>
<div id="using-libvirt">
<h3>Using libvirt</h3>
<p>The following libvirt XML will configure a guest with USB2 support and the
ability to redirect 3 devices simultaneously:</p>
<div><pre><span></span>&lt;controller<span> </span><span>type</span><span>=</span><span>&#39;usb&#39;</span><span> </span><span>index</span><span>=</span><span>&#39;0&#39;</span><span> </span><span>model</span><span>=</span><span>&#39;ich9-ehci1&#39;</span>/&gt;
&lt;controller<span> </span><span>type</span><span>=</span><span>&#39;usb&#39;</span><span> </span><span>index</span><span>=</span><span>&#39;0&#39;</span><span> </span><span>model</span><span>=</span><span>&#39;ich9-uhci1&#39;</span>&gt;
<span>  </span>&lt;master<span> </span><span>startport</span><span>=</span><span>&#39;0&#39;</span>/&gt;
&lt;/controller&gt;
&lt;controller<span> </span><span>type</span><span>=</span><span>&#39;usb&#39;</span><span> </span><span>index</span><span>=</span><span>&#39;0&#39;</span><span> </span><span>model</span><span>=</span><span>&#39;ich9-uhci2&#39;</span>&gt;
<span>  </span>&lt;master<span> </span><span>startport</span><span>=</span><span>&#39;2&#39;</span>/&gt;
&lt;/controller&gt;
&lt;controller<span> </span><span>type</span><span>=</span><span>&#39;usb&#39;</span><span> </span><span>index</span><span>=</span><span>&#39;0&#39;</span><span> </span><span>model</span><span>=</span><span>&#39;ich9-uhci3&#39;</span>&gt;
<span>  </span>&lt;master<span> </span><span>startport</span><span>=</span><span>&#39;4&#39;</span>/&gt;
&lt;/controller&gt;
&lt;redirdev<span> </span><span>bus</span><span>=</span><span>&#39;usb&#39;</span><span> </span><span>type</span><span>=</span><span>&#39;spicevmc&#39;</span>/&gt;
&lt;redirdev<span> </span><span>bus</span><span>=</span><span>&#39;usb&#39;</span><span> </span><span>type</span><span>=</span><span>&#39;spicevmc&#39;</span>/&gt;
&lt;redirdev<span> </span><span>bus</span><span>=</span><span>&#39;usb&#39;</span><span> </span><span>type</span><span>=</span><span>&#39;spicevmc&#39;</span>/&gt;
</pre></div>
<p>For USB3 support, the configuration can be simplified to:</p>
<div><pre><span></span>&lt;controller<span> </span><span>type</span><span>=</span><span>&#39;usb&#39;</span><span> </span><span>index</span><span>=</span><span>&#39;0&#39;</span><span> </span><span>model</span><span>=</span><span>&#39;nec-xhci&#39;</span>/&gt;
&lt;redirdev<span> </span><span>bus</span><span>=</span><span>&#39;usb&#39;</span><span> </span><span>type</span><span>=</span><span>&#39;spicevmc&#39;</span>/&gt;
&lt;redirdev<span> </span><span>bus</span><span>=</span><span>&#39;usb&#39;</span><span> </span><span>type</span><span>=</span><span>&#39;spicevmc&#39;</span>/&gt;
&lt;redirdev<span> </span><span>bus</span><span>=</span><span>&#39;usb&#39;</span><span> </span><span>type</span><span>=</span><span>&#39;spicevmc&#39;</span>/&gt;
</pre></div>
</div>
<div id="using-qemu">
<h3>Using QEMU</h3>
<p>The following qemu options will configure a guest with USB2 support and the
ability to redirect 3 devices simultaneously</p>
<div><pre><span></span>-device<span> </span>ich9-usb-ehci1,id<span>=</span>usb<span> </span><span>\</span>
-device<span> </span>ich9-usb-uhci1,masterbus<span>=</span>usb.0,firstport<span>=</span><span>0</span>,multifunction<span>=</span>on<span> </span><span>\</span>
-device<span> </span>ich9-usb-uhci2,masterbus<span>=</span>usb.0,firstport<span>=</span><span>2</span><span> </span><span>\</span>
-device<span> </span>ich9-usb-uhci3,masterbus<span>=</span>usb.0,firstport<span>=</span><span>4</span><span> </span><span>\</span>
-chardev<span> </span>spicevmc,name<span>=</span>usbredir,id<span>=</span>usbredirchardev1<span> </span><span>\</span>
-device<span> </span>usb-redir,chardev<span>=</span>usbredirchardev1,id<span>=</span>usbredirdev1<span> </span><span>\</span>
-chardev<span> </span>spicevmc,name<span>=</span>usbredir,id<span>=</span>usbredirchardev2<span> </span><span>\</span>
-device<span> </span>usb-redir,chardev<span>=</span>usbredirchardev2,id<span>=</span>usbredirdev2<span> </span><span>\</span>
-chardev<span> </span>spicevmc,name<span>=</span>usbredir,id<span>=</span>usbredirchardev3<span> </span><span>\</span>
-device<span> </span>usb-redir,chardev<span>=</span>usbredirchardev3,id<span>=</span>usbredirdev3
</pre></div>
<p>For USB3 support, the configuration can be simplified to:</p>
<div><pre><span></span>-device<span> </span>nec-usb-xhci,id<span>=</span>usb<span> </span><span>\</span>
-chardev<span> </span>spicevmc,name<span>=</span>usbredir,id<span>=</span>usbredirchardev1<span> </span><span>\</span>
-device<span> </span>usb-redir,chardev<span>=</span>usbredirchardev1,id<span>=</span>usbredirdev1<span> </span><span>\</span>
-chardev<span> </span>spicevmc,name<span>=</span>usbredir,id<span>=</span>usbredirchardev2<span> </span><span>\</span>
-device<span> </span>usb-redir,chardev<span>=</span>usbredirchardev2,id<span>=</span>usbredirdev2<span> </span><span>\</span>
-chardev<span> </span>spicevmc,name<span>=</span>usbredir,id<span>=</span>usbredirchardev3<span> </span><span>\</span>
-device<span> </span>usb-redir,chardev<span>=</span>usbredirchardev3,id<span>=</span>usbredirdev3
</pre></div>
</div>
</div>
<div id="client-configuration">
<h2>Client Configuration</h2>
<p>The client needs to have support for USB redirection. In remote-viewer, you can
select which USB devices to redirect under the &#34;File-&gt;USB device selection&#34; menu
once the Spice connection is established. There are also various command line
redirection options which are described below and when running remote-viewer
with --help-spice.</p>
<p>To get USB redirection working on Windows clients, you need to install
<a href="https://effectivetypescript.com/download/windows/usbdk/">UsbDk</a></p>
</div>
<div id="filter-string-format">
<h2>Filter String Format</h2>
<p>A filter is used to set blocking or autoconnect rules for USB devices. It
consists of one or more rules, where each rule has the form of:</p>
<p><strong>&lt;class&gt;,&lt;vendor&gt;,&lt;product&gt;,&lt;version&gt;,&lt;allow&gt;</strong></p>
<p>Use -1 for class/vendor/product/version to accept any value.</p>
<p>And the rules themselves are concatenated like this:</p>
<p><strong>rule1|rule2|rule3</strong></p>
<p>A client&#39;s default auto-connect filter string is 0x03,-1,-1,-1,0|-1,-1,-1,-1,1</p>
<p>This filters out HID (class 0x03) USB devices from auto connect and auto
connects anything else. Note the explicit allow rule at the end, this is
necessary since by default all devices without a matching filter rule will not
auto-connect.</p>
</div>
<div id="client-filtering">
<h2>Client Filtering</h2>
<p>Set a string specifying a filter to determine which USB devices, when plugged
in, are allowed/blocked to <strong>auto-redirect</strong> USB traffic to the guest (client&#39;s
window has to be in focus).</p>
<div><pre><span></span>remote-viewer<span> </span>--spice-usbredir-auto-redirect-filter<span>=</span><span>&#34;0x03,-1,-1,-1,0|-1,-1,-1,-1,1&#34;</span>
</pre></div>
<p>Set a string specifying a filter to determine which USB devices, that are
already plugged in, to <strong>redirect on connect</strong> once Spice connection is
established.</p>
<div><pre><span></span>remote-viewer<span> </span>--spice-usbredir-redirect-on-connect<span>=</span><span>&#34;0x03,-1,-1,-1,0|-1,-1,-1,-1,1&#34;</span>
</pre></div>
</div>
<div id="host-filtering">
<h2>Host Filtering</h2>
<p>Set a string specifying a filter to determine which USB devices are
<strong>allowed/blocked</strong> to redirect USB traffic to the guest.</p>
<div id="using-qemu-1">
<h3>Using QEMU</h3>
<div><pre><span></span>-device<span> </span>usb-redir,filter<span>=</span><span>&#39;0x03:-1:-1:-1:0|-1:-1:-1:-1:1&#39;</span>,chardev<span>=</span>usbredirchardev1,id<span>=</span>usbredirdev1
</pre></div>
<p>Note that in a QEMU command, the filter string should use a <strong>&#39;:&#39;</strong> character as
a separator within the rule.</p>
</div>
<div id="using-libvirt-1">
<h3>Using libvirt</h3>
<div><pre><span></span>...
<span>&lt;devices&gt;</span>
<span> </span>...
<span>  </span><span>&lt;redirfilter&gt;</span>
<span>    </span><span>&lt;usbdev</span><span> </span><span>class=</span><span>&#39;0x08&#39;</span><span> </span><span>vendor=</span><span>&#39;0x1234&#39;</span><span> </span><span>product=</span><span>&#39;0xbeef&#39;</span><span> </span><span>version=</span><span>&#39;2.56&#39;</span><span> </span><span>allow=</span><span>&#39;yes&#39;</span><span>/&gt;</span>
<span>    </span><span>&lt;usbdev</span><span> </span><span>allow=</span><span>&#39;no&#39;</span><span>/&gt;</span>
<span>  </span><span>&lt;/redirfilter&gt;</span>
<span>&lt;/devices&gt;</span>
...
</pre></div>
</div>
</div>
<div id="download">
<h2>Download</h2>
<p>Latest versions:</p>
<ul>
<li>For use with qemu 1.3 and newer:
<a href="https://effectivetypescript.com/download/usbredir/usbredir-0.7.1.tar.bz2">usbredir-0.7.1.tar.bz2</a></li>
<li>For use with qemu 1.0 / 1.1 / 1.2 release:
<a href="https://effectivetypescript.com/download/usbredir/usbredir-0.4.4.tar.bz2">usbredir-0.4.4.tar.bz2</a></li>
</ul>
<p>Older versions:
<a href="https://effectivetypescript.com/download/usbredir/usbredir-0.7.tar.bz2">0.7</a>,
<a href="https://effectivetypescript.com/download/usbredir/usbredir-0.6.tar.bz2">0.6</a>,
<a href="https://effectivetypescript.com/download/usbredir/usbredir-0.5.2.tar.bz2">0.5.2</a>,
<a href="https://effectivetypescript.com/download/usbredir/usbredir-0.5.1.tar.bz2">0.5.1</a>,
<a href="https://effectivetypescript.com/download/usbredir/usbredir-0.5.tar.bz2">0.5</a>,
<a href="https://effectivetypescript.com/download/usbredir/usbredir-0.4.3.tar.bz2">0.4.3</a>,
<a href="https://effectivetypescript.com/download/usbredir/usbredir-0.4.2.tar.bz2">0.4.2</a>,
<a href="https://effectivetypescript.com/download/usbredir/usbredir-0.4.1.tar.bz2">0.4.1</a>,
<a href="https://effectivetypescript.com/download/usbredir/usbredir-0.4.tar.bz2">0.4</a>,
<a href="https://effectivetypescript.com/download/usbredir/usbredir-0.3.3.tar.bz2">0.3.3</a>,
<a href="https://effectivetypescript.com/download/usbredir/usbredir-0.3.2.tar.bz2">0.3.2</a>,
<a href="https://effectivetypescript.com/download/usbredir/usbredir-0.3.1.tar.bz2">0.3.1</a>,
<a href="https://effectivetypescript.com/download/usbredir/usbredir-0.3.tar.bz2">0.3</a></p>
<div id="sourcecode">
<h3>sourcecode</h3>
<p>You can find the official usbredir git repository
<a href="https://gitlab.freedesktop.org/spice/usbredir">here</a>.</p>
</div>
</div>

</div></div>
  </body>
</html>
