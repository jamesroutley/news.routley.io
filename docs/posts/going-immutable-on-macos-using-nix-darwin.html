<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://carette.xyz/posts/going_immutable_macos/">Original</a>
    <h1>Going immutable on macOS, using Nix-Darwin</h1>
    
    <div id="readability-page-1" class="page"><div>
      <p>With no surprise the end of one year marks the start of the next.</p>
<p>But managing a good working environment on macOS has long been a game of “hope for the best.” We’ve all been there: a <code>curl | sh</code> here, a manual <code>brew install</code> there, and six months later, you’re staring at a broken <code>PATH</code> and a Python environment that seems to have developed its own consciousness.</p>
<p>I’ve spent a lot of time recently moving my entire workflow into a declarative system using nix. From my zsh setup to my odin toolchain, here is why the transition from the imperative world of <a href="https://brew.sh/">Homebrew</a> to the immutable world of <a href="https://nix-darwin.org/">nix-darwin</a> has been both a revelation and a fight.</p>
<h2 id="the-problem-to-solve-imperative-rot">
  The problem to solve: imperative rot
  <a href="#the-problem-to-solve-imperative-rot">#</a>
</h2>
<p>Homebrew is great.</p>
<p>When you run <code>brew install</code> <strong>you are changing the state of your machine</strong> in a way that is difficult to reverse or replicate exactly.</p>
<p>A solution to that is postfix every brew package by its version, but this is not possible for every package.</p>
<p>Another solution is system immutability and the Nix store.</p>
<h2 id="system-immutablility-and-the-nix-store">
  System immutablility, and the Nix store
  <a href="#system-immutablility-and-the-nix-store">#</a>
</h2>
<p><a href="https://nixos.org/">Nix</a> approaches the problem from a functional programming perspective.</p>
<p>This allows different strong points like:</p>
<ul>
<li><strong>reproducibility</strong>: Every package lives in <code>/nix/store</code> with a unique hash. This means I can have three different versions of the Odin compiler side-by-side, and they will never see each other, or even mess up with the different versions.</li>
<li><strong>rollbacks</strong>: If a system update breaks my shell, I don’t panic. I just boot into a previous generation. The previous state of my system is still sitting in the store, untouched.</li>
<li><strong>flakes</strong>: Using <code>flake.lock</code>, I pin my setup to specific git commits. If it works on my laptop then <strong>it will work</strong> on yours. Period.</li>
</ul>
<p>Rollbacks on macOS exist, and are great to go back to a previous version “that works”.</p>
<div><pre tabindex="0"><code data-lang="sh"><span><span>&gt; sudo nix-env --list-generations -p /nix/var/nix/profiles/system
</span></span><span><span>   1   2025-12-28 01:21:38
</span></span><span><span>   2   2025-12-28 01:33:47
</span></span><span><span>   3   2025-12-28 09:34:27
</span></span><span><span>   4   2025-12-28 09:43:15
</span></span><span><span>   5   2025-12-28 11:00:49
</span></span><span><span>   6   2025-12-28 11:10:12
</span></span><span><span>   7   2025-12-28 11:19:03
</span></span><span><span>   ...
</span></span></code></pre></div><p>Each generation is also stored in a read-only specific volume on your system, which prevents accidental mutability of your packages.</p>
<p>On macOS <code>nix-darwin</code> allows me to modify everything, from Finder settings to the Dock, or the Trackpad.</p>
<p>As an example, this is a part of my setup:</p>
<div><pre tabindex="0"><code data-lang="nix"><span><span>...
</span></span><span><span>configuration = { pkgs, ... }: {
</span></span><span><span>    <span># Firewall settings</span>
</span></span><span><span>    networking.applicationFirewall = {
</span></span><span><span>        enable = <span>true</span>;
</span></span><span><span>        enableStealthMode = <span>true</span>;
</span></span><span><span>        allowSigned = <span>true</span>;
</span></span><span><span>        allowSignedApp = <span>true</span>;
</span></span><span><span>    };
</span></span><span><span>
</span></span><span><span>    system.defaults = {
</span></span><span><span>        CustomUserPreferences = {
</span></span><span><span>          <span># Disable siri</span>
</span></span><span><span>          <span>&#34;com.apple.Siri&#34;</span> = {
</span></span><span><span>            <span>&#34;UAProfileCheckingStatus&#34;</span> = 0;
</span></span><span><span>            <span>&#34;siriEnabled&#34;</span> = 0;
</span></span><span><span>          };
</span></span><span><span>          <span># Disable personalized ads </span>
</span></span><span><span>          <span>&#34;com.apple.AdLib&#34;</span> = {
</span></span><span><span>            allowApplePersonalizedAdvertising = <span>false</span>;
</span></span><span><span>          };
</span></span><span><span>        };
</span></span><span><span>
</span></span><span><span>        <span># Show battery percentage in the menu bar</span>
</span></span><span><span>        controlcenter.BatteryShowPercentage = <span>true</span>;
</span></span><span><span>
</span></span><span><span>        <span># Allow touch to click</span>
</span></span><span><span>        trackpad.Clicking = <span>true</span>;
</span></span><span><span>
</span></span><span><span>        <span># Hide the dock after a small delay of inactivity</span>
</span></span><span><span>        dock.autohide = <span>true</span>;
</span></span><span><span>        dock.autohide-delay = 0.25;
</span></span><span><span>
</span></span><span><span>        ...
</span></span><span><span>    };
</span></span><span><span>}
</span></span></code></pre></div><p>And all those settings are documented in the official nix-darwin manual <a href="https://nix-darwin.github.io/nix-darwin/manual/">here</a>.</p>
<h3 id="the-nix-flake">
  The Nix flake
  <a href="#the-nix-flake">#</a>
</h3>
<p>Before diving into the pros and cons of Nix, we need to address the engine under the hood: <strong>The Nix Flake</strong>.</p>
<p>In the traditional Nix world, things were a bit loose.</p>
<p>Every Flake has a <code>flake.nix</code> (the blueprint) and a <code>flake.lock</code> (the time capsule).</p>
<p>The lockfile is actually the secret sauce.</p>
<p>So, when you run <code>darwin-rebuild switch --flake .</code> to update your system (depending on configuration changes), Nix will look first at the lockfile.
If the lockfile says you are using <code>nixpkgs</code> from October 12th at 10:45 PM, that is exactly what it fetches.
Nix doesn’t matter if you are on a new MacBook or an old iMac. If the lockfile is the same, then the resulting environment will be identical to your previous setup.</p>
<p>This turns system administration into a pure function: <strong>the same inputs always produce the same result</strong>.</p>
<h2 id="the-get-and-forget-workflow">
  The “get and forget” workflow
  <a href="#the-get-and-forget-workflow">#</a>
</h2>
<p>One of the most liberating features is the “ephemeral shell” provided by Nix.</p>
<p>With Nix, you run:</p>
<div><pre tabindex="0"><code data-lang="sh"><span><span>nix shell nixpkgs#python314
</span></span></code></pre></div><p>Suddenly, <code>python --version</code> returns 3.14.
You run your tests, you exit the shell, <strong>and it’s gone</strong>.</p>
<p>No leftovers, no site-packages conflicts, no trace.
It is the ultimate “get and forget” utility, without messing up your system.</p>
<p>However be careful as <strong>“ephemeral” does not mean “sandboxed” or “isolated”</strong> in this context!
A common misconception is that <code>nix shell</code> is like a Docker container or a VM, but it is not as <code>nix shell</code> only isolated the environment variables, and is still running directly on the darwin kernel.</p>
<h2 id="the-learning-curve-cliff">
  The learning <del>curve</del> cliff
  <a href="#the-learning-curve-cliff">#</a>
</h2>
<p>Is this configuration exempt from defaults? Absolutely not.</p>
<p>The learning curve for Nix is actually not a curve, but a vertical cliff face.</p>
<p>Unlike Homebrew, where you just type a command and forget it, Nix requires you to learn a <a href="https://nix.dev/tutorials/nix-language.html">domain-specific language called… <code>Nix</code> (I know, it is confusing)</a>. You have to understand how symbolic links work on macOS, how the Nix daemon interacts with Apple’s read-only system volume, and why your applications don’t magically appear in Spotlight.</p>
<p>For instance, getting GUI apps to show up in the Applications folder requires “trampoline” binaries or custom activation scripts using <code>mkalias</code>.</p>
<p>The documentation is great, but maybe not well arranged.</p>
<h2 id="the-hybrid-reality">
  The hybrid reality
  <a href="#the-hybrid-reality">#</a>
</h2>
<p>Despite my love for Nix, it isn’t perfect for everything.
macOS GUI applications like Thunderbird, Firefox, or CrossOver, often fight against the read-only nature of the Nix store.</p>
<p>I found the sane path to be an hybrid approach: I use <code>nix-darwin</code> to manage my critical state (compilers, LSPs, shell aliases), and use the homebrew module inside my Nix config to handle the big GUI pieces. It looks like this:</p>
<div><pre tabindex="0"><code data-lang="Nix"><span><span>// file: brew.nix
</span></span><span><span>homebrew = {
</span></span><span><span>  enable = <span>true</span>;
</span></span><span><span>  casks = [ 
</span></span><span><span>    <span>&#34;firefox&#34;</span> 
</span></span><span><span>    <span>&#34;thunderbird&#34;</span> 
</span></span><span><span>    <span>&#34;crossover&#34;</span> 
</span></span><span><span>  ];
</span></span><span><span>};
</span></span></code></pre></div><p>That’s it!
And using this, I am sure Nix will use <code>brew</code> to install those software on my system, as I did manually with my <code>brew install</code> scripts.</p>
<p>This gives me the best of both worlds: Homebrew handles the macOS-specific integration, but Nix still “records” that they should exist in my declarative blueprint.</p>
<h2 id="how-to-start">
  How to start
  <a href="#how-to-start">#</a>
</h2>
<p>If you want to move away from “hope-based” configuration:</p>
<ol>
<li>
<p>install the <a href="https://docs.determinate.systems/">Determinate Nix Installer</a>: it handles the messy macOS multi-user setup for you.</p>
</li>
<li>
<p>initialize a Flake and <a href="https://nix-community.github.io/home-manager/"><code>home-manager</code></a>: Create a <code>flake.nix</code> and a <code>home.nix</code> for your home-manager instance.</p>
</li>
<li>
<p>think <strong>“modularity”</strong>, like keeping your system settings in <code>system.nix</code>, your dev tools in <code>dev.nix</code>, and your GUI apps in <code>brew.nix</code>.</p>
</li>
<li>
<p>version <strong>everything</strong> and commit your <code>flake.lock</code>! It is the source of truth for your system.</p>
</li>
</ol>
<p>If you are curious I’ve documented my current setup, including my security hardening (firewall, stealth mode, etc.) here: <a href="https://github.com/k0pernicus/dotfiles/tree/master/config/nix-darwin-config">k0pernicus/dotfiles/nix-darwin-config</a>.</p>
<p>Keep in mind this configuration is personal, and might not be interesting (and certainly not useful) for everyone.</p>
<p>A few links that helped me to make a first setup version for my mac:</p>
<ul>
<li><a href="https://nixcademy.com/posts/nix-on-macos/">https://nixcademy.com/posts/nix-on-macos/</a></li>
<li><a href="https://dreamsofcode.io/blog/nix-darwin-my-favorite-package-manager-for-macos">https://dreamsofcode.io/blog/nix-darwin-my-favorite-package-manager-for-macos</a></li>
<li><a href="https://github.com/torgeir/nix-darwin">https://github.com/torgeir/nix-darwin</a></li>
</ul>
<p>It’s more work upfront, certainly.
But there is a profound peace of mind in knowing that your system is defined by code, not by a history of forgotten terminal commands.</p>

    </div></div>
  </body>
</html>
