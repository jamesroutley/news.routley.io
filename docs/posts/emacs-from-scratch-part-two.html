<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://arne.me/articles/emacs-from-scratch-part-two">Original</a>
    <h1>Emacs from Scratch Part Two</h1>
    
    <div id="readability-page-1" class="page"><div id="main"><article><header></header><p>This is the second post in my Emacs From Scratch series.</p>
<p>In <a href="https://arne.me/articles/emacs-from-scratch-part-one-foundations">Part 1</a>, we’ve set up
the UI and evil mode.
Today we’ll set up a way to manage projects, quickly find files, set up custom keybindings, interact with Git and open a terminal inside Emacs.</p>
<h2><a href="#table-of-contents" aria-hidden="true" id="table-of-contents"></a>Table of Contents</h2>
<ul>
<li><a href="#project-manager">Project manager</a></li>
<li><a href="#custom-keybindings">Custom keybindings</a></li>
<li><a href="#fuzzy-finding">Fuzzy finding</a></li>
<li><a href="#git-integration">Git integration</a></li>
<li><a href="#terminal">Terminal</a></li>
<li><a href="#small-tweaks">Small tweaks</a>
<ul>
<li><a href="#make-ctrl-u-work-like-in-vim">Make <code>Ctrl-u</code> work like in Vim</a></li>
<li><a href="#comment-lines">Comment lines</a></li>
<li><a href="#optimizing-the-garbage-collector">Optimizing the garbage collector</a></li>
<li><a href="#dont-use-esc-as-a-modifier">Don’t use ESC as a modifier</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
<h2><a href="#project-manager" aria-hidden="true" id="project-manager"></a>Project manager</h2>
<p>Vim is usually terminal-first; you navigate to a directory and open Vim.
Emacs is the other way around; you start Emacs, open a project and maybe a terminal buffer (see <a href="#terminal">Terminal</a> further down).</p>
<p>Let’s set up <a href="https://github.com/bbatsov/projectile">Projectile</a> to manage our
projects and quickly find files.</p>
<pre><span><span><span>(</span><span>use-package</span> projectile
  :demand
  :init
  <span><span>(</span>projectile<span>-</span>mode <span>+</span><span>1</span><span>)</span></span><span>)</span></span>
</span></pre>
<p>You can now run <code>M-x</code> (a.k.a. <code>Opt-x</code> on macOS) and type
<code>projectile-add-known-project</code> to add a project as well as
<code>projectile-switch-project</code> to open a project.</p>
<p>This is neither fast, nor discoverable. Let’s set up some custom keybindings.</p>
<h2><a href="#custom-keybindings" aria-hidden="true" id="custom-keybindings"></a>Custom keybindings</h2>
<p>Before we define our own keybindings, we need to do something to improve
discoverability. <a href="https://github.com/justbur/emacs-which-key">which-key</a> will
show available commands as you start a keybinding sequence:</p>
<pre><span><span><span>(</span><span>use-package</span> which<span>-</span>key
  :demand
  :init
  <span><span>(</span><span>setq</span> which<span>-</span>key<span>-</span>idle<span>-</span>delay <span>0.5</span><span>)</span></span>   :config
  <span><span>(</span>which<span>-</span>key<span>-</span>mode<span>)</span></span><span>)</span></span>
</span></pre>
<p>We’ll use <a href="https://github.com/noctuid/general.el">general.el</a> because it makes
it super easy to define keybindings and allows us to define them in a
<code>use-package</code> function.</p>
<p>We’ll have <code>SPC</code> as our leader key, which allows us to press <code>SPC</code> and have all our custom keybindings show up.</p>
<pre><span><span><span>(</span><span>use-package</span> general
  :demand
  :config
  <span><span>(</span>general<span>-</span>evil<span>-</span>setup<span>)</span></span>

  <span><span>(</span>general<span>-</span>create<span>-</span>definer leader<span>-</span>keys
    :states &#39;<span><span>(</span>normal insert visual emacs<span>)</span></span>
    :keymaps &#39;override
    :prefix <span><span>&#34;</span>SPC<span>&#34;</span></span>
    :global<span>-</span>prefix <span><span>&#34;</span>C-SPC<span>&#34;</span></span><span>)</span></span>

  <span><span>(</span>leader<span>-</span>keys
    <span><span>&#34;</span>x<span>&#34;</span></span> &#39;<span><span>(</span>execute<span>-</span>extended<span>-</span>command :which<span>-</span>key <span><span>&#34;</span>execute command<span>&#34;</span></span><span>)</span></span>
    <span><span>&#34;</span>r<span>&#34;</span></span> &#39;<span><span>(</span>restart<span>-</span>emacs :whick<span>-</span>key <span><span>&#34;</span>restart emacs<span>&#34;</span></span><span>)</span></span>
    <span><span>&#34;</span>i<span>&#34;</span></span> &#39;<span><span>(</span><span><span>(</span><span>lambda</span> <span><span>(</span><span>)</span></span> <span><span>(</span>interactive<span>)</span></span> <span><span>(</span><span>find</span><span>-</span>file user<span>-</span>init<span>-</span>file<span>)</span></span><span>)</span></span> :which<span>-</span>key <span><span>&#34;</span>open init file<span>&#34;</span></span><span>)</span></span>

        <span><span>&#34;</span>b<span>&#34;</span></span> &#39;<span><span>(</span>:ignore <span>t</span> :which<span>-</span>key <span><span>&#34;</span>buffer<span>&#34;</span></span><span>)</span></span>
        <span><span>&#34;</span>b &lt;escape&gt;<span>&#34;</span></span> &#39;<span><span>(</span>keyboard<span>-</span>escape<span>-</span>quit :which<span>-</span>key <span>t</span><span>)</span></span>
    <span><span>&#34;</span>bd<span>&#34;</span></span>  &#39;kill<span>-</span>current<span>-</span>buffer
  <span>)</span></span>
</span></span></pre>
<p>We’re using <code>:which-key</code> to add a description that will show up next to the
command.
To add custom keybindings to Projectile, we need to edit the <code>use-package</code>
definition and move it after the <code>use-package general</code> function:</p>
<pre><span><span><span>(</span><span>use-package</span> projectile
  :demand
  :general
  <span><span>(</span>leader<span>-</span>keys
    :states &#39;normal
    <span><span>&#34;</span>SPC<span>&#34;</span></span> &#39;<span><span>(</span>projectile<span>-</span><span>find</span><span>-</span>file :which<span>-</span>key <span><span>&#34;</span>find file<span>&#34;</span></span><span>)</span></span>

        <span><span>&#34;</span>b b<span>&#34;</span></span> &#39;<span><span>(</span>projectile<span>-</span>switch<span>-</span><span>to</span><span>-</span>buffer :which<span>-</span>key <span><span>&#34;</span>switch buffer<span>&#34;</span></span><span>)</span></span>

        <span><span>&#34;</span>p<span>&#34;</span></span> &#39;<span><span>(</span>:ignore <span>t</span> :which<span>-</span>key <span><span>&#34;</span>projects<span>&#34;</span></span><span>)</span></span>
    <span><span>&#34;</span>p &lt;escape&gt;<span>&#34;</span></span> &#39;<span><span>(</span>keyboard<span>-</span>escape<span>-</span>quit :which<span>-</span>key <span>t</span><span>)</span></span>
    <span><span>&#34;</span>p p<span>&#34;</span></span> &#39;<span><span>(</span>projectile<span>-</span>switch<span>-</span>project :which<span>-</span>key <span><span>&#34;</span>switch project<span>&#34;</span></span><span>)</span></span>
    <span><span>&#34;</span>p a<span>&#34;</span></span> &#39;<span><span>(</span>projectile<span>-</span>add<span>-</span>known<span>-</span>project :which<span>-</span>key <span><span>&#34;</span>add project<span>&#34;</span></span><span>)</span></span>
    <span><span>&#34;</span>p r<span>&#34;</span></span> &#39;<span><span>(</span>projectile<span>-</span><span>remove</span><span>-</span>known<span>-</span>project :which<span>-</span>key <span><span>&#34;</span>remove project<span>&#34;</span></span><span>)</span></span><span>)</span></span>
  :init
  <span><span>(</span>projectile<span>-</span>mode <span>+</span><span>1</span><span>)</span></span><span>)</span></span>
</span></pre>
<p>Now we can press <code>SPC</code> and get suggestions that we can navigate along.
<code>SPC SPC</code> lets you open a file in the current project (or a project if none is open),
<code>SPC b</code> opens buffer options, <code>SPC p</code> project options, etc.</p>
<p>This is what it looks like:</p>
<picture>
  <source srcset="/articles/emacs-from-scratch-part-two/which-key.avif" type="image/avif"/>
  <img src="https://arne.me/articles/emacs-from-scratch-part-two/which-key.avif" alt="And Emacs window with a drawer open showing different shortcuts, e.g. SPC → find file, r → +buffer et al"/>
</picture>
<p>But when you try to find a file, or add a project, you’ll notice that this is
clunky as you need to type the exact path for it to work.
Let’s fix that.</p>
<h2><a href="#fuzzy-finding" aria-hidden="true" id="fuzzy-finding"></a>Fuzzy finding</h2>
<p>We’ll be using <a href="https://github.com/abo-abo/swiper">ivy</a> as our generic completion frontend.
This will make choosing files and projects a lot more ergonomic:</p>
<pre><span><span><span>(</span><span>use-package</span> ivy
  :config
  <span><span>(</span>ivy<span>-</span>mode<span>)</span></span><span>)</span></span>
</span></pre>
<p>Now we get a list of possible entries and live-search.</p>
<h2><a href="#git-integration" aria-hidden="true" id="git-integration"></a>Git integration</h2>
<p>To manage source control, we’ll use <a href="https://github.com/magit/magit">Magit</a>, which is–rightfully–widely considered to be the best Git client ever:</p>
<pre><span><span><span>(</span><span>use-package</span> magit
  :general
  <span><span>(</span>leader<span>-</span>keys
    <span><span>&#34;</span>g<span>&#34;</span></span> &#39;<span><span>(</span>:ignore <span>t</span> :which<span>-</span>key <span><span>&#34;</span>git<span>&#34;</span></span><span>)</span></span>
    <span><span>&#34;</span>g &lt;escape&gt;<span>&#34;</span></span> &#39;<span><span>(</span>keyboard<span>-</span>escape<span>-</span>quit :which<span>-</span>key <span>t</span><span>)</span></span>
    <span><span>&#34;</span>g g<span>&#34;</span></span> &#39;<span><span>(</span>magit<span>-</span>status :which<span>-</span>key <span><span>&#34;</span>status<span>&#34;</span></span><span>)</span></span>
    <span><span>&#34;</span>g l<span>&#34;</span></span> &#39;<span><span>(</span>magit<span>-</span><span>log</span> :which<span>-</span>key <span><span>&#34;</span>log<span>&#34;</span></span><span>)</span></span><span>)</span></span>
  <span><span>(</span>general<span>-</span>nmap
    <span><span>&#34;</span>&lt;escape&gt;<span>&#34;</span></span> <span><span>#</span>&#39;transient-quit-one</span><span>)</span></span><span>)</span></span>
</span></pre>
<p>To make Magit work nicely with Evil, let’s add <a href="https://github.com/emacs-evil/evil-collection">evil-collection</a>:</p>
<pre><span><span><span>(</span><span>use-package</span> evil<span>-</span>collection
  :after evil
  :demand
  :config
  <span><span>(</span>evil<span>-</span>collection<span>-</span>init<span>)</span></span><span>)</span></span>
</span></pre>
<p>In addition we need to add this to the <code>:init</code> block of <code>use-package evil</code> to
prevent evil and evil-collection interfering:</p>
<pre><span><span><span>(</span><span>setq</span> evil<span>-</span>want<span>-</span>keybinding <span>nil</span><span>)</span></span>
</span></pre>
<p>Now <code>SPC g g</code> will open up the current Git status.
You can stage single files with <code>s</code>, all files with <code>S</code> and commit by pressing <code>cc</code>.</p>
<p>Finally, we want to highlight uncommited changes in the gutter:</p>
<pre><span><span><span>(</span><span>use-package</span> diff<span>-</span>hl
  :init
  <span><span>(</span>add<span>-</span>hook &#39;magit<span>-</span>pre<span>-</span>refresh<span>-</span>hook &#39;diff<span>-</span>hl<span>-</span>magit<span>-</span>pre<span>-</span>refresh<span>)</span></span>
  <span><span>(</span>add<span>-</span>hook &#39;magit<span>-</span>post<span>-</span>refresh<span>-</span>hook &#39;diff<span>-</span>hl<span>-</span>magit<span>-</span>post<span>-</span>refresh<span>)</span></span>
  :config
  <span><span>(</span>global<span>-</span>diff<span>-</span>hl<span>-</span>mode<span>)</span></span><span>)</span></span>
</span></pre>
<h2><a href="#terminal" aria-hidden="true" id="terminal"></a>Terminal</h2>
<p>Even though we’ll try to make everything work from inside Emacs, sometimes it’s just quicker and easier to have a shell.</p>
<p>We’ll use <a href="https://github.com/akermu/emacs-libvterm">vterm</a> as a terminal emulator we can use inside emacs.</p>
<pre><span><span><span>(</span><span>use-package</span> vterm<span>)</span></span>
</span></pre>
<p>We’ll also install <a href="https://github.com/jixiuf/vterm-toggle">vterm-toggle</a>, a package that allows us to toggle between the active buffer and a vterm buffer:</p>
<pre><span><span><span>(</span><span>use-package</span> vterm<span>-</span>toggle
  :general
  <span><span>(</span>leader<span>-</span>keys
    <span><span>&#34;</span>&#39;<span>&#34;</span></span> &#39;<span><span>(</span>vterm<span>-</span>toggle :which<span>-</span>key <span><span>&#34;</span>terminal<span>&#34;</span></span><span>)</span></span><span>)</span></span><span>)</span></span>
</span></pre>
<p>Pressing <code>SPC &#39;</code> will open a terminal. Pressing it again will hide it, but keep any processes running.</p>
<h2><a href="#small-tweaks" aria-hidden="true" id="small-tweaks"></a>Small tweaks</h2>
<p>As every time, we’ll do a few small tweaks:</p>
<h3><a href="#make-ctrl-u-work-like-in-vim" aria-hidden="true" id="make-ctrl-u-work-like-in-vim"></a>Make <code>Ctrl-u</code> work like in Vim</h3>
<p>Add the following to the <code>:init</code> block of <code>use-package evil</code>:</p>
<pre><span><span><span>(</span><span>setq</span> evil<span>-</span>want<span>-</span>C<span>-</span>u<span>-</span>scroll <span>t</span><span>)</span></span>
</span></pre>
<h3><a href="#comment-lines" aria-hidden="true" id="comment-lines"></a>Comment lines</h3>
<p>We want similar behaviour to <a href="https://github.com/tpope/vim-commentary">commentary.vim</a> and comment objects in/out with <code>gc</code>:</p>
<pre><span><span><span>(</span><span>use-package</span> evil<span>-</span>nerd<span>-</span>commenter
  :general
  <span><span>(</span>general<span>-</span>nvmap
    <span><span>&#34;</span>gc<span>&#34;</span></span> &#39;evilnc<span>-</span>comment<span>-</span>operator<span>)</span></span><span>)</span></span>
</span></pre>
<h3><a href="#optimizing-the-garbage-collector" aria-hidden="true" id="optimizing-the-garbage-collector"></a>Optimizing the garbage collector</h3>
<p>We’ll use <a href="https://github.com/emacsmirror/gcmh">GCMH</a>, “the Garbage Collector Magic Hack”, to minimize GC interference with user activity:</p>
<pre><span><span><span>(</span><span>use-package</span> gcmh
  :demand
  :config
  <span><span>(</span>gcmh<span>-</span>mode <span>1</span><span>)</span></span><span>)</span></span>
</span></pre>
<p>Move this up to be the first package loaded after configuring <code>use-package</code>, to improve start-up time.</p>
<h3><a href="#dont-use-esc-as-a-modifier" aria-hidden="true" id="dont-use-esc-as-a-modifier"></a>Don’t use ESC as a modifier</h3>
<p>If you want to exit a menu, <code>&lt;escape&gt;</code> is the key of choice, esp. coming from Vim. Let’s match that behaviour:</p>
<pre><span><span><span>(</span><span>use-package</span> emacs
  :init
	<span><span>(</span>global<span>-</span><span>set</span><span>-</span>key <span><span>(</span>kbd <span><span>&#34;</span>&lt;escape&gt;<span>&#34;</span></span><span>)</span></span> &#39;keyboard<span>-</span>escape<span>-</span>quit<span>)</span></span><span>)</span></span>
</span></pre>
<h2><a href="#conclusion" aria-hidden="true" id="conclusion"></a>Conclusion</h2>
<p>We now have everything we need to manage projects, navigate to files, run terminal commands and manage Git.
Starting with this post, I’m using this very setup to edit this series.</p>
<p>In part 3, we’ll set up Tree-sitter and, if available, LSP for Rust, Go, TypeScript and Markdown.</p>
<p>Subscribe to the <a href="https://arne.me/articles/atom.xml">RSS Feed</a> so you don’t miss the following
parts, and <a href="https://arne.me/contact">let me know</a> what you think!</p>
</article></div></div>
  </body>
</html>
