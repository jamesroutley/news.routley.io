<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://e10v.me/tea-tasting-analysis-of-experiments/">Original</a>
    <h1>Show HN: Tea-tasting, a Python package for the statistical analysis of A/B tests</h1>
    
    <div id="readability-page-1" class="page"><div><article><p><small>Jul 29, 2024</small> <small><a href="https://e10v.me/tags/a-b-testing/">a/b testing</a></small> <small><a href="https://e10v.me/tags/statistics/">statistics</a></small> <small><a href="https://e10v.me/tags/tea-tasting/">tea-tasting</a></small> <small><a href="https://e10v.me/tags/python/">python</a></small></p><h2 id="intro">Intro <a aria-label="Anchor link for: intro" href="#intro">#</a></h2><p>I developed <strong>tea-tasting</strong>, a Python package for the statistical analysis of A/B tests featuring:</p><ul><li>Student&#39;s t-test, Bootstrap, variance reduction with CUPED, power analysis, and other statistical methods and approaches out of the box.</li><li>Support for a wide range of data backends, such as BigQuery, ClickHouse, PostgreSQL/GreenPlum, Snowflake, Spark, Pandas, and 20+ other backends supported by <a href="https://ibis-project.org/" rel="noopener" target="_blank">Ibis</a>.</li><li>Extensible API: define custom metrics and use statistical tests of your choice.</li><li>Convenient API for reducing manual work, and a framework for minimizing errors.</li><li>Detailed documentation.</li></ul><p>In this blog post, I explore each of these advantages of using <strong>tea-tasting</strong> in the analysis of experiments.</p><p>If you are eager to try it, check the <a href="https://tea-tasting.e10v.me/" rel="noopener" target="_blank">documentation</a>.</p><h2 id="statistical-methods">Statistical methods <a aria-label="Anchor link for: statistical-methods" href="#statistical-methods">#</a></h2><p><strong>tea-tasting</strong> includes statistical methods and techniques that cover most of what you might need in the analysis of experiments.</p><p>Analyze metric averages and proportions with the Student&#39;s t-test and the Z-test. Or use Bootstrap to analyze any other statistic of your choice. And there is a predefined method for the analysis of quantiles using Bootstrap. <strong>tea-tasting</strong> also detects mismatches in the sample ratios of different variants of an A/B test.</p><p><strong>tea-tasting</strong> applies <a href="https://alexdeng.github.io/public/files/kdd2018-dm.pdf" rel="noopener" target="_blank">delta method</a> for the analysis of ratios of averages. For example, average number of orders per average number of sessions, assuming that session is not a randomization unit.</p><p>Use pre-experiment data, metric forecasts, or other covariates to reduce variance and increase the sensitivity of an experiment. This approach is also known as <a href="https://exp-platform.com/Documents/2013-02-CUPED-ImprovingSensitivityOfControlledExperiments.pdf" rel="noopener" target="_blank">CUPED</a> or <a href="https://doordash.engineering/2020/06/08/improving-experimental-power-through-control-using-predictions-as-covariate-cupac/" rel="noopener" target="_blank">CUPAC</a>.</p><p>The calculation of confidence intervals for <em>percentage</em> change in Student&#39;s t-test and Z-test can be tricky. Just taking confidence interval for <em>absolute</em> change and dividing it by control average will produce a biased result. <strong>tea-tasting</strong> applies <a href="https://alexdeng.github.io/public/files/kdd2018-dm.pdf" rel="noopener" target="_blank">delta method</a> to calculate the correct interval.</p><p>Analyze statistical power for Student&#39;s t-test and Z-test. There are three possible options:</p><ul><li>Calculate the effect size, given statistical power and the total number of observations.</li><li>Calculate the total number of observations, given statistical power and the effect size.</li><li>Calculate statistical power, given the effect size and the total number of observations.</li></ul><p>Learn more in the detailed <a href="https://tea-tasting.e10v.me/user-guide/" rel="noopener" target="_blank">user guide</a>.</p><p>The roadmap includes:</p><ul><li>A/A tests and simulations to analyze power of any statistical test.</li><li>More statistical tests: <ul><li>Asymptotic and exact tests for frequency data.</li><li>Mann–Whitney U test.</li></ul></li></ul><p>You can define a <a href="https://tea-tasting.e10v.me/custom-metrics/" rel="noopener" target="_blank">custom metric</a> with a statistical test of your choice.</p><h2 id="data-backends">Data backends <a aria-label="Anchor link for: data-backends" href="#data-backends">#</a></h2><p>There are many different databases and engines for storing and processing experimental data. And in most cases it&#39;s not efficient to pull the detailed experimental data into a Python environment. Many statistical tests, such as the Student&#39;s t-test or the Z-test, require only aggregated data for analysis.</p><p>For example, if the raw experimental data are stored in ClickHouse, it&#39;s faster and more efficient to calculate counts, averages, variances, and covariances directly in ClickHouse rather than fetching granular data and performing aggregations in a Python environment.</p><p>Querying all the required statistics manually can be a daunting and error-prone task. For example, analysis of ratio metrics and variance reduction with CUPED require not only number of rows and variance, but also covariances. But don&#39;t worry—<strong>tea-tasting</strong> does all this work for you.</p><p><strong>tea-tasting</strong> accepts data either as a Pandas DataFrame or an Ibis Table. <a href="https://ibis-project.org/" rel="noopener" target="_blank">Ibis</a> is a Python package which serves as a DataFrame API to various data backends. It supports 20+ backends including BigQuery, ClickHouse, PostgreSQL/GreenPlum, Snowflake, and Spark. You can write an SQL query, <a href="https://ibis-project.org/how-to/extending/sql#backend.sql" rel="noopener" target="_blank">wrap</a> it as an Ibis Table, and pass it to <strong>tea-tasting</strong>.</p><p>Keep in mind that <strong>tea-tasting</strong> assumes that:</p><ul><li>Data is grouped by randomization units, such as individual users.</li><li>There is a column indicating variant of the A/B test (typically labeled as A, B, etc.).</li><li>All necessary columns for metric calculations (like the number of orders, revenue, etc.) are included in the table.</li></ul><p>Some statistical methods, like Bootstrap, require granular data for the analysis. In this case, <strong>tea-tasting</strong> fetches the detailed data as well.</p><p>Learn more in the guide on <a href="https://tea-tasting.e10v.me/data-backends/" rel="noopener" target="_blank">data backends</a>.</p><h2 id="convenient-api">Convenient API <a aria-label="Anchor link for: convenient-api" href="#convenient-api">#</a></h2><p>You can perform all the tasks listed above using just NumPy, SciPy, and Ibis. In fact, <strong>tea-tasting</strong> uses these packages under the hood. What <strong>tea-tasting</strong> offers on top is a convenient higher-level API.</p><p>It&#39;s easier to show than to describe. Here is the basic example:</p><pre data-lang="python"><code data-lang="python"><span>import </span><span>tea_tasting </span><span>as </span><span>tt
</span><span>
</span><span>
</span><span>data = tt.</span><span>make_users_data</span><span>(</span><span>seed</span><span>=</span><span>42</span><span>)
</span><span>
</span><span>experiment = tt.</span><span>Experiment</span><span>(
</span><span>    </span><span>sessions_per_user</span><span>=tt.</span><span>Mean</span><span>(&#34;</span><span>sessions</span><span>&#34;),
</span><span>    </span><span>orders_per_session</span><span>=tt.</span><span>RatioOfMeans</span><span>(&#34;</span><span>orders</span><span>&#34;, &#34;</span><span>sessions</span><span>&#34;),
</span><span>    </span><span>orders_per_user</span><span>=tt.</span><span>Mean</span><span>(&#34;</span><span>orders</span><span>&#34;),
</span><span>    </span><span>revenue_per_user</span><span>=tt.</span><span>Mean</span><span>(&#34;</span><span>revenue</span><span>&#34;),
</span><span>)
</span><span>
</span><span>result = experiment.</span><span>analyze</span><span>(data)
</span><span>print</span><span>(result)
</span><span>#&gt;             metric control treatment rel_effect_size rel_effect_size_ci pvalue
</span><span>#&gt;  sessions_per_user    2.00      1.98          -0.66%      [-3.7%, 2.5%]  0.674
</span><span>#&gt; orders_per_session   0.266     0.289            8.8%      [-0.89%, 19%] 0.0762
</span><span>#&gt;    orders_per_user   0.530     0.573            8.0%       [-2.0%, 19%]  0.118
</span><span>#&gt;   revenue_per_user    5.24      5.73            9.3%       [-2.4%, 22%]  0.123
</span></code></pre><p>The two-stage approach, with separate parametrization and inference, is common in statistical modeling. This separation helps in making the code more modular and easier to understand.</p><p><strong>tea-tasting</strong> performs calculations that can be tricky and error-prone:</p><ul><li>Analysis of ratio metrics with delta method.</li><li>Variance reduction with CUPED/CUPAC (also in combination with the delta method for ratio metrics).</li><li>Calculation of confidence intervals for both absolute and percentage change.</li><li>Analysis of statistical power.</li></ul><p>It also provides a framework for representing experimental data to avoid errors. Grouping the data by randomization units and including all units in the dataset is important for correct analysis.</p><p>In addition, <strong>tea-tasting</strong> provides some convenience methods and functions, such as pretty formatting of the result and a context manager for metric parameters.</p><h2 id="documentation">Documentation <a aria-label="Anchor link for: documentation" href="#documentation">#</a></h2><p>Last but not least: documentation. I believe that good documentation is crucial for tool adoption. That&#39;s why I wrote several user guides and an API reference.</p><p>I recommend starting with the example of basic usage in the <a href="https://tea-tasting.e10v.me/user-guide/" rel="noopener" target="_blank">user guide</a>. Then you can explore specific topics, such as variance reduction or power analysis, in the same guide.</p><p>See the guide on <a href="https://tea-tasting.e10v.me/data-backends/" rel="noopener" target="_blank">data backends</a> to learn how to use a data backend of your choice with <strong>tea-tasting</strong>.</p><p>See the guide on <a href="https://tea-tasting.e10v.me/custom-metrics/" rel="noopener" target="_blank">custom metrics</a> if you want to perform statistical test that is not included in <strong>tea-tasting</strong>.</p><p>Use the <a href="https://tea-tasting.e10v.me/api/" rel="noopener" target="_blank">API reference</a> to explore all parameters and detailed information about the functions, classes, and methods available in <strong>tea-tasting</strong>.</p><h2 id="conclusions">Conclusions <a aria-label="Anchor link for: conclusions" href="#conclusions">#</a></h2><p>There are a variety of statistical methods that can be applied in the analysis of an experiment. But only a handful of them are actually used in most cases.</p><p>On the other hand, there are methods specific to the analysis of A/B tests that are not included in the general purpose statistical packages like SciPy.</p><p><strong>tea-tasting</strong> functionality includes the most important statistical tests, as well as methods specific to the analysis of A/B tests.</p><p><strong>tea-tasting</strong> provides a convenient API that helps to reduce the time spent on analysis and minimize the probability of error.</p><p>In addition, <strong>tea-tasting</strong> optimizes computational efficiency by calculating the statistics in the data backend of your choice, where the data are stored.</p><p>With the detailed <a href="https://tea-tasting.e10v.me/" rel="noopener" target="_blank">documentation</a>, you can quickly learn how to use <strong>tea-tasting</strong> for the analysis of your experiments.</p><h2 id="p-s-package-name">P.S. Package name <a aria-label="Anchor link for: p-s-package-name" href="#p-s-package-name">#</a></h2><p>The package name &#34;tea-tasting&#34; is a play on words that refers to two subjects:</p><ul><li><a href="https://en.wikipedia.org/wiki/Lady_tasting_tea" rel="noopener" target="_blank">Lady tasting tea</a> is a famous experiment which was devised by Ronald Fisher. In this experiment, Fisher developed the null hypothesis significance testing framework to analyze a lady&#39;s claim that she could discern whether the tea or the milk was added first to the cup.</li><li>&#34;tea-tasting&#34; phonetically resembles &#34;t-testing&#34; or Student&#39;s t-test, a statistical test developed by William Gosset.</li></ul><p>© Evgeny Ivanov 2024</p></article></div></div>
  </body>
</html>
