<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/ziglang/glibc-abi-tool">Original</a>
    <h1>Show HN: A 166 KB file for cross compiling glibc for any version, any target</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
          <article itemprop="text">
<p dir="auto">This repository contains <code>.abilist</code> files from every version of glibc. These
files are consolidated to generate a single 166 KB symbol mapping file that is
shipped with Zig to target any version of glibc. This repository is for Zig
maintainers to use when a new glibc version is tagged upstream; Zig users have
no need for this repository.</p>
<h2 dir="auto"><a id="user-content-adding-new-glibc-version-abilist-files" aria-hidden="true" href="#adding-new-glibc-version-abilist-files"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Adding new glibc version <code>.abilist</code> files</h2>
<ol dir="auto">
<li>Clone glibc</li>
</ol>
<div data-snippet-clipboard-copy-content="git clone git://sourceware.org/git/glibc.git"><pre>git clone git://sourceware.org/git/glibc.git</pre></div>
<ol start="2" dir="auto">
<li>
<p dir="auto">Check out the new glibc version git tag, e.g. <code>glibc-2.34</code>.</p>
</li>
<li>
<p dir="auto">Run the tool to grab the new abilist files:</p>
</li>
</ol>
<div data-snippet-clipboard-copy-content="zig run collect_abilist_files.zig -- $GLIBC_GIT_REPO_PATH"><pre>zig run collect_abilist_files.zig -- <span>$GLIBC_GIT_REPO_PATH</span></pre></div>
<ol start="4" dir="auto">
<li>
<p dir="auto">This mirrors the directory structure into the <code>glibc</code> subdirectory,
namespaced under the version number, but only copying files with the
.abilist extension.</p>
</li>
<li>
<p dir="auto">Inspect the changes and then commit these new files into git.</p>
</li>
</ol>
<h2 dir="auto"><a id="user-content-updating-zig" aria-hidden="true" href="#updating-zig"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Updating Zig</h2>
<ol dir="auto">
<li>Run <code>consolidate.zig</code> at the root of this repo.</li>
</ol>

<p dir="auto">This will generate the file <code>abilists</code> which you can then inspect and make sure
it is OK. Copy it to <code>$ZIG_GIT_REPO_PATH/lib/libc/glibc/abilist</code>.</p>
<h2 dir="auto"><a id="user-content-debugging-an-abilists-file" aria-hidden="true" href="#debugging-an-abilists-file"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Debugging an abilists file</h2>
<div data-snippet-clipboard-copy-content="zig run list_symbols.zig -- abilists"><pre>zig run list_symbols.zig -- abilists</pre></div>
<h2 dir="auto"><a id="user-content-strategy" aria-hidden="true" href="#strategy"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Strategy</h2>
<p dir="auto">The abilist files from the latest glibc are <em>almost</em> enough to completely
encode all the information that we need to generate the symbols db. The only
problem is when a function migrates from one library to another. For example,
in glibc 2.32, the function <code>pthread_sigmask</code> migrated from libpthread to libc,
and the latest abilist files only show it in libc. However, if a user targets
glibc 2.31, Zig needs to know to put the symbol into libpthread.so and not
libc.so.</p>
<p dir="auto">In glibc upstream, they simply renamed the abilist files from pthread.abilist to
libc.abilist. This resulted in the following line being present in libc.abilist
in glibc 2.32 and later:</p>
<div data-snippet-clipboard-copy-content="GLIBC_2.0 pthread_sigmask F"><pre><code>GLIBC_2.0 pthread_sigmask F
</code></pre></div>
<p dir="auto">This implies that in glibc 2.0, libc.so has the <code>pthread_sigmask</code> symbol, which
is incorrect, because it was only found in libpthread.so.</p>
<p dir="auto">This is why this repository contains abilist files from all past
versions of glibc as well as the most recent one - it allows us to
detect this situation, and generate a corrected symbols database.</p>
<p dir="auto">The strategy is to start with the earliest glibc version, consume the abilist
files, and then treat that data as correct. Next we move on to the next
earliest glibc version, but now we have to detect a contradiction: if the newer
glibc version claims that e.g. <code>pthread_sigmask</code> is available in glibc 2.0,
when our correct data says that it does not, we ignore that incorrect piece of
data. However we must take in new data if the version it talks about is greater
than the version corresponding to the &#34;correct&#34; data set.</p>
<p dir="auto">After merging in the newer glibc version, we mark the current dataset as
&#34;correct&#34; and move on to the next, and so on until we have processed all the
sets of abilist files.</p>
<p dir="auto">When this process completes, we have in memory something that looks like this:</p>
<ul dir="auto">
<li>For each glibc symbol
<ul dir="auto">
<li>For each glibc library
<ul dir="auto">
<li>For each target
<ul dir="auto">
<li>For each glibc version
<ul dir="auto">
<li>Whether the symbol is absent, a function, or an object+size</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p dir="auto">And our job is now to <em>encode</em> this information into a file that does not waste
installation size and yet remains simple to decode and use in the Zig compiler.</p>
<h3 dir="auto"><a id="user-content-inclusions" aria-hidden="true" href="#inclusions"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Inclusions</h3>
<p dir="auto">Next, the script generates the minimal number of &#34;inclusions&#34; to encode all the
information. An &#34;inclusion&#34; is:</p>
<ul dir="auto">
<li>A symbol name.</li>
<li>The set of targets this inclusion applies to.</li>
<li>The set of glibc versions this inclusion applies to.</li>
<li>The set of libraries this inclusion applies to.</li>
<li>Whether it is a function or object, and if an object, its size in bytes.</li>
</ul>
<p dir="auto">As an example, consider <code>dlopen</code>. An inclusion is something like this:</p>
<ul dir="auto">
<li><code>dlopen</code></li>
<li>targets: aarch64-linux-gnu powerpc64le-linux-gnu</li>
<li>versions: 2.17 2.34</li>
<li>libraries: libdl.so</li>
<li>type: function</li>
</ul>
<p dir="auto">This does not cover all the places <code>dlopen</code> can be found however. There will
need to be more inclusions for more targets, for example:</p>
<ul dir="auto">
<li><code>dlopen</code></li>
<li>targets: x86_64-linux-gnu</li>
<li>versions: 2.2.5 2.34</li>
<li>libraries: libdl.so</li>
<li>type: function</li>
</ul>
<p dir="auto">Now we have more coverage of all the places <code>dlopen</code> can be found, but there are
yet more that need to be emitted. The script emits as many inclusions as
necessary so that all the information is represented.</p>
<p dir="auto">Next we make few observations which lead to a more compact data encoding.</p>
<h3 dir="auto"><a id="user-content-observation-all-symbols-are-consistently-either-functions-or-objects" aria-hidden="true" href="#observation-all-symbols-are-consistently-either-functions-or-objects"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Observation: All symbols are consistently either functions or objects</h3>
<p dir="auto">There is no symbol that is a function on one target, and an object on another
target. Similarly there is no symbol that is a function on one glibc version,
but an object in another, and there is no symbol that is a function in one
shared library, but an object in another.</p>
<p dir="auto">We exploit this by encoding functions and object symbols in separate lists.</p>
<h3 dir="auto"><a id="user-content-observation-over-half-of-the-objects-are-exactly-4-bytes" aria-hidden="true" href="#observation-over-half-of-the-objects-are-exactly-4-bytes"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Observation: Over half of the objects are exactly 4 bytes</h3>
<p dir="auto">51% of all object entries are 4 bytes, and 68% of all object entries are either
4 or 8 bytes.</p>
<p dir="auto">Total object inclusions are 765. If we stored 4 and 8 byte objects in separate
lists, this would save 2 bytes from 520 inclusions, totaling 1 KB. Not worth.</p>
<h3 dir="auto"><a id="user-content-observation-average-number-of-different-versions-per-inclusion-is-102" aria-hidden="true" href="#observation-average-number-of-different-versions-per-inclusion-is-102"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Observation: Average number of different versions per inclusion is 1.02</h3>
<p dir="auto">Nearly every inclusion has typically 1 version attached to it, rarely more.
This makes a u64 bitset uneconomical. With 19530 total inclusions, this comes
out to 153 KB spent on the version bitset. However if we encoded it as one byte
per version, using 1 bit of the byte to indicate the terminal item, this would
bring the 153 KB down to 19 KB. That is almost a 50% reduction from the total
size of the encoded abilists file. Definitely worth it.</p>
<h2 dir="auto"><a id="user-content-binary-encoding-format" aria-hidden="true" href="#binary-encoding-format"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Binary encoding format:</h2>
<p dir="auto">All integers are stored little-endian.</p>
<ul dir="auto">
<li>u8 number of glibc libraries (7). For each:
<ul dir="auto">
<li>null-terminated name, e.g. &#34;c&#34;, &#34;m&#34;, &#34;dl&#34;, &#34;ld&#34;, &#34;pthread&#34;</li>
</ul>
</li>
<li>u8 number of glibc versions (44), sorted ascending. For each:
<ul dir="auto">
<li>u8 major</li>
<li>u8 minor</li>
<li>u8 patch</li>
</ul>
</li>
<li>u8 number of targets (20). For each:
<ul dir="auto">
<li>null-terminated target triple</li>
</ul>
</li>
<li>u16 number of function inclusions (18765)
<ul dir="auto">
<li>null-terminated symbol name (not repeated for subsequent same symbol inclusions)</li>
<li>Set of Unsized Inclusions</li>
</ul>
</li>
<li>u16 number of object inclusion sets (2165)
<ul dir="auto">
<li>null-terminated symbol name (not repeated for subsequent same symbol inclusions)</li>
<li>Set of Sized Inclusions</li>
</ul>
</li>
</ul>
<p dir="auto">Set of Unsized Inclusions:</p>
<ul dir="auto">
<li>u32 set of targets this inclusion applies to (1 &lt;&lt; INDEX_IN_TARGET_LIST)
<ul dir="auto">
<li>last inclusion is indicated if 1 &lt;&lt; 31 bit is set in target bitset</li>
</ul>
</li>
<li>u8 index of glibc library this inclusion applies to</li>
<li>[N]u8 set of glibc versions this inclusion applies to. MSB set indicates last.</li>
</ul>
<p dir="auto">Set of Sized Inclusions:</p>
<ul dir="auto">
<li>u32 set of targets this inclusion applies to (1 &lt;&lt; INDEX_IN_TARGET_LIST)
<ul dir="auto">
<li>last inclusion is indicated if 1 &lt;&lt; 31 bit is set in target bitset</li>
</ul>
</li>
<li>u16 object size</li>
<li>u8 index of glibc library this inclusion applies to</li>
<li>[N]u8 set of glibc versions this inclusion applies to. MSB set indicates last.</li>
</ul>
</article>
        </div></div>
  </body>
</html>
