<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://asahilina.net/agx-exploit/">Original</a>
    <h1>CVE-2022-32947: I hacked macOS</h1>
    
    <div id="readability-page-1" class="page"><div>
			<div>
				<section>
					<section>
						
						<h3>CVE-2022-32947</h3>
						<p>With Linaâœ¨ &amp; CyanðŸ’Ž </p>
						<p><a href="https://github.com/asahilina/agx-exploit">GitHub</a> Â· <a href="https://www.youtube.com/watch?v=hDek2cp0dmI">Video</a></p>
					</section>
					<section>
						<h2>On today&#39;s menu...</h2>
						<ul>
							<li><a href="#s_gpuintro">AÂ bit about GPUs</a></li>
							<li><a href="#s_vm">How virtual memory works</a></li>
							<li><a href="#s_cmdbuf">What&#39;s a GPU command buffer?</a></li>
							<li><a href="#s_uppl">Apple&#39;s super secret uPPL</a></li>
							<li><a href="#s_rop">Return-oriented programming</a></li>
							<li><a href="#s_demo">Special demo!</a></li>
						</ul>
					</section>
					<section>
						
					</section>
					<section>
						<img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/root.png" height="600"/>
						<p>
							<a href="https://www.youtube.com/watch?v=hDek2cp0dmI&amp;t=10m">Live demo</a> Â·
							<a href="https://github.com/asahilina/agx-exploit/tree/main/demo_exploit">Source code</a>
						</p>
					</section>
				</section>
				<section>
					<section id="s_gpuintro">
						
					</section>
					<section>
						<h2>CPU vs. GPU</h2>
						<img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/cpugpu.svg" height="600"/>
					</section>
					<section>
						<h2>How Apple GPUs work</h2>
						<img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/gpufwhw.svg" height="600"/>
					</section>
				</section>
				<section>
					<section>
						
					</section>
					<section>
						<p><img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/lina_notices.png"/>
						</p>
					</section>
				</section>
				<section>
					<section id="s_vm">
						
						<h3>What&#39;s a page table anyway?</h3>
					</section>
					<section>
						<h2>Pointers</h2>
						<pre><code>#include &lt;iostream&gt;

	using namespace std;

	int main() {
		int a = 0;
		void *p = &amp;a;

		cout &lt;&lt; &#34;&amp;a is &#34; &lt;&lt; p &lt;&lt; &#34; nya!&#34; &lt;&lt; endl;
	}</code></pre>
						<pre><code>&amp;a is 0x7fffc6ba5ddc nya!</code></pre>
					</section>
					<section>
						<p>This is a virtual address!</p>
						<p><code>0x7fffc6ba5ddc</code></p>
						<p>â†“</p>
					</section>
					<section>
						
					</section>
					<section>
						<p><img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/virtualmemory.svg" height="600"/>
							<img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/virtualmemory2.svg" height="600"/>
						</p>
					</section>
					<section>
						<p><img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/pagetables.svg" height="600"/>
							<img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/pagetables2.svg" height="600"/>
							</p>
					</section>
					<section>
						<p><img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/cpugpuproc.svg" height="850"/>
							<img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/cpugpuproc_1.svg" height="850"/>
							<img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/cpugpuproc_2.svg" height="850"/>
						</p>
					</section>
					<section>
						<h2>GPU/CPU Memory</h2>
						<p><img data-fragment-index="1" src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/cpugpupt.svg" height="850"/>
							<img data-fragment-index="1" src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/cpugpukpt.svg" height="850"/>
						</p>
					</section>
					<section>
						
					</section>
					<section>
						<div>
							<p><img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/pt_big.svg" height="900"/>
								<img data-fragment-index="1" src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/pt_big2.svg" height="900"/>
							</p>
							<div data-fragment-index="1">
								<p>40 bits for virtual address (1 TiB)</p>
								<p>16 KiB pages â†’ 67,108,864 pages total</p>
								<p>8 bytes per page address</p>
								<p><span data-fragment-index="2">Too big!!!
							</span></p></div>
						</div>
					</section>
					<section>
						<img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/pt_tree.svg" height="900"/>
					</section>
					<section>
						<img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/pt_translation.svg" height="900"/>
					</section>
					<section>
						<h2>Permissions</h2>
						<img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/pt_permissions.svg" height="600"/>
					</section>
					<section>
						<img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/uat_space.svg" height="900"/>
					</section>
					<section>
						<h2>TTBAT</h2>
						<p>Translation Table Base Address Table</p>
						<img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/ttbat.svg" height="700"/>
					</section>
				</section>
				<section>
					<section>
						
					</section>
					<section>
						<p><img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/lina_notices.png"/>
							<img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/lina_notices_1.svg"/>
							<img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/lina_notices_2.svg"/>
							<img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/lina_notices_3.svg"/>
							<img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/lina_notices_4.svg"/>
							<img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/lina_notices_5.svg"/>
						</p>
					</section>
				</section>
				<section>
					<section id="s_cmdbuf">
						
						<h3>Weird machines?</h3>
					</section>
					<section>
						<h2>Command buffers</h2>
						<p><img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/cmdbuf.svg" height="750"/>
							<img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/cmdbuf_1.svg" height="750"/>
							<img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/cmdbuf_2.svg" height="750"/>
							<img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/cmdbuf_3.svg" height="750"/>
						</p>
					</section>
					<section>
						<h2>Micro Commands</h2>
						<div>
							<ul>
								<li><code>00</code>: <span data-fragment-index="1">-</span></li>
								<li><code>01</code>: <span>Wait For Idle</span></li>
								<li><code>02</code>: <span data-fragment-index="1">Wait 2</span></li>
								<li><code>03</code>: <span data-fragment-index="1">Doorbell</span></li>
								<li><code>04</code>: <span data-fragment-index="1">Write 8-bit reg</span></li>
								<li><code>05</code>: <span data-fragment-index="1">Write 32-bit reg</span></li>
								<li><code>06</code>: <span data-fragment-index="1">Write 64-bit reg</span></li>
								<li><code>07</code>: <span data-fragment-index="1">-</span></li>
								<li><code>08</code>: <span data-fragment-index="1">Read 8-bit reg</span></li>
								<li><code>09</code>: <span data-fragment-index="1">Read 32-bit reg</span></li>
								<li><code>0a</code>: <span data-fragment-index="1">Read 64-bit reg</span></li>
								<li><code>0b</code>: <span data-fragment-index="1">Wait 32-bit reg</span></li>
								<li><code>0c</code>: <span data-fragment-index="1">Wait 64-bit reg</span></li>
								<li><code>0d</code>: <span data-fragment-index="1">-</span></li>
								<li><code>0e</code>: <span data-fragment-index="1">Store 32-bit</span>
									<b data-fragment-index="2"></b></li>
							</ul>
							<ul>
								<li><code>0f</code>: <span data-fragment-index="1">Store 64-bit</span>
									<b data-fragment-index="2"></b></li>
								<li><code>10</code>: <span data-fragment-index="1">Load 32-bit</span>
									<b data-fragment-index="2"></b></li>
								<li><code>11</code>: <span data-fragment-index="1">Load 64-bit</span>
									<b data-fragment-index="2"></b></li>
								<li><code>12</code>: <span data-fragment-index="1">?</span></li>
								<li><code>13</code>: <span data-fragment-index="1">?</span></li>
								<li><code>14</code>: <span data-fragment-index="1">?</span></li>
								<li><code>15</code>: <span data-fragment-index="1">Test (If)</span>
									<b data-fragment-index="2"></b></li>
								<li><code>16</code>: <span data-fragment-index="1">Logic op</span>
									<b data-fragment-index="2"></b></li>
								<li><code>17</code>: <span data-fragment-index="1">Add 16-bit</span>
									<b data-fragment-index="2"></b></li>
								<li><code>18</code>: <span>Retire</span></li>
								<li><code>19</code>: <span>Timestamp</span></li>
								<li><code>1a</code>: <span data-fragment-index="1">KTrace</span></li>
								<li><code>1b</code>: <span data-fragment-index="1">?</span></li>
								<li><code>1c</code>: <span data-fragment-index="1">?</span></li>
								<li><code>1d</code>: <span data-fragment-index="1">?</span></li>
							</ul>
							<ul>
								<li><code>1e</code>: <span data-fragment-index="1">Jump (Cond)</span>
									<b data-fragment-index="2"></b></li>
								<li><code>1f</code>: <span data-fragment-index="1">?</span></li>
								<li><code>20</code>: <span data-fragment-index="1">?</span></li>
								<li><code>21</code>: <span data-fragment-index="1">?</span></li>
								<li><code>22</code>: <span>Start Vertex</span></li>
								<li><code>23</code>: <span>Finish Vertex</span></li>
								<li><code>24</code>: <span>Start Fragment</span></li>
								<li><code>25</code>: <span>Finish Fragment</span></li>
								<li><code>26</code>: <span>Start Blit</span></li>
								<li><code>27</code>: <span>Finish Blit</span></li>
								<li><code>28</code>: <span data-fragment-index="1">?</span></li>
								<li><code>29</code>: <span>Start Compute</span></li>
								<li><code>2a</code>: <span>Finish Compute</span></li>
								<li><code>2b</code>: <span data-fragment-index="1">?</span></li>
								<li><code>2c</code>: <span data-fragment-index="1">?</span></li>
							</ul>
						</div>
					</section>
					<section>
						<h2>It&#39;s Turing Complete!</h2>
						<ul>
							<li>2 64-bit scratch registers</li>
							<li>Loads and stores (direct only)</li>
							<li>AND, OR, XOR, shifts</li>
							<li>Test for zero (&#34;if&#34;)</li>
							<li>Jump / Conditional jump</li>
						</ul>
					</section>
					<section>
						<h2>Tricks</h2>
						<p>Indirect read/writes?</p>
						<p><img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/selfmod.svg" height="450"/></p>
					</section>
					<section>
						<h2>Tricks</h2>
						<p>Multiply?</p>
						<p><img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/multiply.svg" height="600"/></p>
					</section>
					<section>
						<h2>We can:</h2>
						<ul>
							<li>Read/write firmware data memory</li>
							<li>Do math</li>
						</ul>
						<h2>We can&#39;t:</h2>
						<ul>
							<li>Modify the firmware code</li>
							<li>Modify the page tables</li>
						</ul>
						<p>But...</p>
					</section>
				</section>
				<section>
					<section id="s_uppl">
						
					</section>
					<section>
						<h2>More secrets...</h2>
						<p><img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/uppl.svg" height="750"/>
							<img src="http://harihareswara.net/posts/2023/on-jon-boiss-work/img/uppl_1.svg" height="750"/>
						</p>
					</section>
					<section>
						<h2>uPPL can map memory!</h2>
						<ul>
							<li>If page is uPPL: <b>DENY</b></li>
							<li>If page is page table: <b>DENY</b></li>
							<li>If page is secure uPPL/kernel data: <b>DENY</b></li>
							<li>If page is TTBAT.... ??? <b>ALLOWED!!!</b></li>
							<p><b>They forgot to blocklist that one!!!!</b></p>
						</ul>
					</section>
					<section>
						<h2>Hack Idea</h2>
						<ul>
							<li>Make fake PT that gives access to the real PTs</li>
							<li>Ask uPPL to give us access to the TTBAT</li>
							<li>Write fake PT to TTBAT (context 63 TTB0)</li>
							<li>Ask uPPL to activate context 63</li>
							<li>Write fake PT address to TTB1 page table</li>
						</ul>
						<p><b>GPU can now read/write page tables directly!!</b>
					</p></section>
					<section>
						<h2>Problem</h2>
						<p>We can read/write stuff from the microsequence, but we can&#39;t call the uPPL...</p>
						<p>We can&#39;t modify the firmware code directly...</p>
						<h2>Solution</h2>
						<p>Return-oriented Programming (ROP)!</p>
					</section>
				</section>
				<section>
					<section id="s_rop">
						
						<h3>More weird machines????</h3>
					</section>
					<section>
						<h2>Call and return</h2>
						
					</section>
					<section>
						<h2>Multiple calls?</h2>
						
					</section>
					<section>
						<h2>Challenge!</h2>
						
					</section>
					<section>
						<h2>Data registers</h2>
						
					</section>
					<section>
						<h2>Gadgets can be weird...</h2>
						<p><code>g_calltwo</code>: Call two functions...</p>
						<p>But the first argument is a pointer to a pointer to a pointer to the function</p>
						<p>And the second one is a pointer to 0x70 before a pointer to the function</p>
					</section>
					<section>
						<h2>Gadgets can be weird...</h2>
						<p><code>g_store</code>: Store a value to memory...</p>
						<p>But it actually stores to the address you pass plus 0xa78</p>
					</section>
				</section>
				<section>
					<section id="s_demo">
						
						<h3>This is going to be so yabai...</h3>
					</section>
					<section>
						<h2>Putting it together</h2>
						<ul>
							<li><b>Shader</b>: Set up microseq and ROP chain data in unused memory</li>
							<li><b>Shader</b>: Overwrite microseq pointers</li>
							<li><b>Microsequence</b>: Calculate and fill in a lot of data using firmware info, then overwrite stack to start ROP</li>
							<li><b>ROP</b>: Use uPPL bug and make a page table accessible to shaders</li>
							<li><b>Shader</b>: Map more page tables and get access to <b>ALL RAM</b></li>
							<li>Profit?????</li>
						</ul>
					</section>
					<section>
						<p>It&#39;s hard to demo this all working in practice...</p>
						<p>Challenge Accepted!</p>
					</section>
					<section id="demoslide">
						<div id="demo">
							<div id="leftpane">
								
								
								<div id="mseqregpanel">
									<h3>Microsequence registers</h3>
									<table id="mseqregs">
										<tbody><tr>
											<td>R0</td>
											<td id="mseq0">0x0000000000000000</td>
											<td>R1</td>
											<td id="mseq1">0x0000000000000000</td>
										</tr>
									</tbody></table>
								</div>
							</div>
							<table id="registers">
								<tbody><tr><td>X0</td><td id="rx0"></td></tr>
								<tr><td>X1</td><td id="rx1"></td></tr>
								<tr><td>X2</td><td id="rx2"></td></tr>
								<tr><td>X3</td><td id="rx3"></td></tr>
								<tr><td>X4</td><td id="rx4"></td></tr>
								<tr><td>X5</td><td id="rx5"></td></tr>
								<tr><td>X6</td><td id="rx6"></td></tr>
								<tr><td>X7</td><td id="rx7"></td></tr>
								<tr><td>X8</td><td id="rx8"></td></tr>
								<tr><td>X9</td><td id="rx9"></td></tr>
								<tr><td>X10</td><td id="rx10"></td></tr>
								<tr><td>X11</td><td id="rx11"></td></tr>
								<tr><td>X12</td><td id="rx12"></td></tr>
								<tr><td>X13</td><td id="rx13"></td></tr>
								<tr><td>X14</td><td id="rx14"></td></tr>
								<tr><td>X15</td><td id="rx15"></td></tr>
								<tr><td>X16</td><td id="rx16"></td></tr>
								<tr><td>X17</td><td id="rx17"></td></tr>
								<tr><td>X18</td><td id="rx18"></td></tr>
								<tr><td>X19</td><td id="rx19"></td></tr>
								<tr><td>X20</td><td id="rx20"></td></tr>
								<tr><td>X21</td><td id="rx21"></td></tr>
								<tr><td>X22</td><td id="rx22"></td></tr>
								<tr><td>X23</td><td id="rx23"></td></tr>
								<tr><td>X24</td><td id="rx24"></td></tr>
								<tr><td>X25</td><td id="rx25"></td></tr>
								<tr><td>X26</td><td id="rx26"></td></tr>
								<tr><td>X27</td><td id="rx27"></td></tr>
								<tr><td>X28</td><td id="rx28"></td></tr>
								<tr><td>X29</td><td id="rx29"></td></tr>
								<tr><td>LR</td><td id="rx30"></td></tr>
								<tr><td>SP</td><td id="rsp"></td></tr>
								<tr><td>PC</td><td id="rpc"></td></tr>
							</tbody></table>
						</div>
					</section>
				</section>
			</div>
		</div></div>
  </body>
</html>
