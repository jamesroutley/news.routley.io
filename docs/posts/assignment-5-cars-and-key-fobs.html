<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://web.stanford.edu/class/ee26n/Assignments/Assignment5.html">Original</a>
    <h1>Assignment 5: Cars and Key Fobs</h1>
    
    <div id="readability-page-1" class="page"><div id="layout-content">


<h2>Overview</h2>
<p>Almost all cars currently come with a key fob, which allows you to open the doors, and start the car.  When you buy a car, the convenience is the compelling feature.  You can leave the key fob in your pocket, and never again worry about having a physical key. It sounds great.</p>
<p>The implicit assumption you make is that the key fob system is secure, and that some random person with $50 of hardware can&#39;t drive off with your car.  You have no real way to tell whether the car company did a reasonable job with their system, so you have to trust them.  Unfortunately, that trust is not always warranted.  And it isn&#39;t until people try to hack these systems that the problems come out.  Problems that less scrupulous people may have already been exploiting.</p>
<h2>Your Car&#39;s Key Fob</h2>
<p>There are lots of different key fob systems.  We&#39;ll start by looking at the key fob for my 2006 Prius. Key fobs use something called a Remote Keyless System (RKS).  In the U.S. these operate at 315 MHz, +/- 2.5 MHz.  My Prius key turned out to be at 312.590 MHz.The keyfobs are all listed in the FCC database.  Watching for new entries is one of the ways people can tell when new car models are coming out. These will appear long before the official announcement.</p>
<p>You can figure out what frequency your key fob transmits on using your SDR and use GQRX or SDR# to monitor the spectrum.  When you push a button on the fob, you should see a brief jump in the spectrum.  You may need to shift the frequency band up or down by a couple of MHz to find the signal, mine was almost 2.5 MHz low.</p>
<p>One word of caution.  Don&#39;t get too carried away pushing the button!  The RKS system uses a rolling pseudo-randomly generated code.  Both the key fob and the car keep in sync, so that the car recognizes the next code.  However, if the key fob gets too far ahead in the sequence (100s of button pushes) the car won&#39;t recognize it.  That makes the key (and the car) considerably less useful!</p>
<p>If we capture the signal the result is shown below</p>
<div>
<p><img src="https://web.stanford.edu/class/ee26n/Assignments/graphics/rks_sig.png" width="800"/></p></div>
<p>The total width of the plot is 10 seconds, so you can see there is one key press shortly after 2 seconds, and another shortly after 5 seconds.</p>
<p>If we plot 100 ms starting at 2 seconds, we can see the digital signal we are looking for:</p>
<div>
<p><img src="https://web.stanford.edu/class/ee26n/Assignments/graphics/rks_zoom1.png" width="800"/> </p></div>
<p>Zooming in to the first couple of bits, we get</p>
<div>
<p><img src="https://web.stanford.edu/class/ee26n/Assignments/graphics/rks_zoom2.png" width="800"/> </p></div>
<p>The bits are easy to identify.  A decision threshold of 15 will give almost perfect detection. If we do this, and then plot first part of the digital data for the two key presses, we get this</p>
<div>
<p><img src="https://web.stanford.edu/class/ee26n/Assignments/graphics/rks_digital.png" width="800"/> </p></div>
<p>Although the two start the same, they rapidly diverge.  This is fortunate, because if the signal was the same every time, you&#39;d have enough information to steal my car now!</p>
<p>The data is again on-off keying (OOK).  It is also almost certainly split phase  (or Manchester) encoding. Instead of a “1” being high, and a “0” being low, the information is  encoding in the transition from high to low or low to high. That means that a “0” bit is a rising transition, and a “1” bit is a falling transition.  A good way to recognize split phase encoding is that you can only have one or two low or high segments in a row.  The nice thing about Manchester encoding is that every symbol has a transition, and these are easier to find then when the signal has been high or low for several intervals.</p>
<p>This example is OOK, which is the most common for car remotes.  Some use frequency-shift keying (FSK), where each bit is transmitted as a different frequency, and the envelope is constant.</p>
<h2>Attacks on Car Remotes</h2>
<p>There are lots of different attacks that can be used against car remotes, depending on how they work, and what sort of access you are looking for.  The simplest just let you open the car up.  More thorough attacks give you complete control by basically cloning the remote.</p>
<p>Most key fobs use a rolling key. This produces a new waveform that depends on the ID of the key fob, a random seed, and how many times the key has been pressed.  The car keeps track of the last code it received, and knows what the next several hundred codes might be.  If it detects one of the expected future codes it opens the car.  If it gets a previously used code, it stops responding to the key fob.  For the Prius you have to do the <a href="https://www.youtube.com/watch?v=xAuYVsokC5o">“Chicken Dance”</a> to get it to work again, provided you have another working key fob.  Otherwise, you have to have the dealer rekey the car, for many hundreds of dollars. I have had to do this a couple times, now (for other reasons).</p>
<p>There are several lines of attack.  One is simply recording the key fob output for a couple of button presses when it is away from the car, or the car is being jammed.  With recorded unused codes, you can open the car. </p>
<p>Another is to reverse engineer the RKS sequence.  In general this should be extremely hard.  However, there have been several situations where this is very easy. </p>
<p>Finally, there are cars that open when the owner gets close to the car.  This is based on a low power signal that can only be received when the key fob is very close.  This can be defeated by amplifying these small signals.</p>
<p>There are many more attacks, and these will continue to multiply as cars get more complex, and have more embedded computer systems to go after.  You can look at some of these for next week.</p>
<h3>Replay Attacks</h3>
<p>The oldest and simplest approach was to record the waveform that a key fob puts out (using your rtl-sdr), and then replay it.  This works well for older garage door openers, that used a single fixed key. There are still cars out there that have key fobs that work this way (some pre-2000 Mercedes for example).</p>
<p>For key fobs that use a rolling key, you can still use a replay attack. If you can get access to the key fob when it is away from the car and record several key presses, you can replay these to have the car open. </p>
<p>If you can&#39;t get access to the key fob, a second approach is to make a device that records the output of the key fob when it is used, and simultaneously jams the car.  A standard way to do this is to listen to the key fob transmission, and then start jamming when the error correction bits are transmitted at the end. That way you don&#39;t jam yourself.  The car won&#39;t recognize the packet, but you can recreate the error correction bits, and retransmit the waveform later.  </p>
<p>Finally, a jammer by itself will keep the remote from begin able to lock the car.  If the driver isn&#39;t attentive, they may walk away from the car leaving it open.</p>
<h3>Retransmission Devices</h3>
<p>All of this depends on your ability to both transmit and receive RF. Your rtl-sdr&#39;s are just receivers, and do a great job of acquiring signals. There are lots of options for transmitting.  There are a number of usb dongles that are based on the TI CC111X chips that are used in key fobs, like this one</p>
<div>
<p><img src="https://web.stanford.edu/class/ee26n/Assignments/graphics/CC1111_USB.png" width="600"/> </p></div>
<p>Another recent device that has attracted a lot of attention is the Flipper Zero</p>
<div>
<p><img src="https://web.stanford.edu/class/ee26n/Assignments/graphics/Flipper_Zero.png" width="600"/></p></div>
<p>This has the same chip as the previous device, but is much more accessiuble packaged.  This is the Swiss army knife of RF hacking.  It has generated a lot of controversy, as you can look into for this week&#39;s assignment.</p>
<p>An interesting, more flexible approach uses your Raspberry PI to generate RF by sending a carefully crafted data sequence to the GPIO port.  This is described in detail, with videos, and links to the code here:</p>
<p><a href="https://www.rtl-sdr.com/transmitting-fm-am-ssb-sstv-and-fsq-with-just-a-raspberry-pi">Raspberry PI transmitter</a></p>
<p>With this, you can generate pretty much any digital packet waveform you would like. Power levels are more than adequate for emulating a key fob.  The rtl-sdr&#39;s are also well supported on the Raspberry PI, so the two together give you a total key fob hacking system for $50 or so, as we will see shortly.</p>
<h3>Attacking Passive Keyless Entry and Start (PKES) Systems</h3>
<p>Many higher end cars use a passive system for opening the car when the driver approaches.  A low power signal is transmitted from the car as a challenge.  The key fob then responds with an authentication.  Because the power is so low, the car assumes the driver must be in close proximity if it receives a response.</p>
<p>These systems can be hacked by building a repeater that placed near the car.  It captures the car&#39;s signal and retransmits it at higher power.  The remote can be anywhere with in a couple hundred meters, and it will still hear the signal.  The remote responds, and that is again captured by the repeater, and retransmitted.  The car thinks the key fob is nearby and opens the car.</p>
<div>
<p><img src="https://web.stanford.edu/class/ee26n/Assignments/graphics/PKES.png" width="400"/> </p></div>
<p>The nice thing about this approach is that you don&#39;t need to know anything about the key fob, except its frequency.  You don&#39;t need to reverse engineer the protocol it uses, you are actually just using the real key!</p>
<p>Here is a video of some care thieves stealing a Tesla with this approach</p>
<p><a href="https://www.theverge.com/2018/10/22/18008514/tesla-model-s-stolen-key-fob-hack-watch-video">Passive Remote Attack, Tesla Model 3</a></p>
<p>How can you reduce this risk?</p>
<h3>Attacking the Rolling Key System</h3>
<p>The next attacks go after the rolling key system itself.  The way this generally works is that the key fob sends an ID, along with a counter of how many times a key has been pressed.  This is encrypted, and transmitted to the car when you push the button.</p>
<div>
<p><img src="https://web.stanford.edu/class/ee26n/Assignments/graphics/RKS_Car.png" width="600"/> </p></div>
<p>If the encryption is strong, it is extremely difficult to figure out what the userid and counter is.  There are several interesting cases.  One is for the 20 years of VW&#39;s (and Audi&#39;s, Porsche&#39;s, etc), that we&#39;ll look at here.  Another is for Subarus, that you can look at for your assignment this week.</p>
<p>A description of the VW RKS system is given here</p>
<p><a href="https://www.wired.com/2016/08/oh-good-new-hack-can-unlock-100-million-volkswagens/">VW Hack</a></p>
<p>This points to a Wired article (which unfortunately currently behind a paywall), and includes a technical paper that goes into great detail about how it works.  The authors of the technical paper looked at the VW RKS systems for the last 20 years. </p>
<p>For the most recent systems, the encryption was relatively strong, equivalent to a 90 bit key.  However, it turns out they used the <b>same key</b> in every car!  100 million of them!</p>
<p>The challenge then is to figure out what the key is, and what the encryption algorithm is.   The car itself helps you solve that one.  When button is pushed the car receives the signal, and then decodes it in the onboard computer (ECU).  The key and the algorithm are stored in the ECU firmware.  The authors bought some ECUs on EBay, downloaded the firmware, and reverse engineered the encryption (these are usually fairly simple bitwise operations that are easy to identify).  With this knowledge, after acquiring the signal from a single key press, the user ID and counter can be decoded, and the key fob cloned, giving complete control of the car.</p>
<p>There are a couple of interesting things here.  One is that every VW car decodes every key fob, so by monitoring the execution of your ECU, you can find the user ID and counter for all of the cars around you. There are reports of people using systems like this to steal other makes of cars, also.</p>
<p>The reason only your car responds to your remote is that your car has a “allow list” of 
key fob ID&#39;s it responds to.  That is what gets set when you rekey the car.</p>
<p>This all sounds pretty alarming.  But it gets worse, as we&#39;ll see next week.</p>
<div>
<div>
<h2>Assignment</h2>
<p>You have several options for your assignment this week. For each topic, generate about 5 slides to describe your thoughts or results. Sign up here</p>
<p><a href="https://docs.google.com/spreadsheets/d/1U9bNqlV4cXqNPDBIRoxuOmPMbRGMeoGzIOwI0_hZr1Y/edit?usp=share_link">Signup</a></p>
<p>and upload your slides here:</p>
<p><a href="https://drive.google.com/drive/folders/1QpThT_bgUZadzqQ98c9nEW_fpIYQueNq?usp=share_link">Week 5 Slides</a></p>
<p>1. This article concerns the Subaru RKS system.  Read it, watch the videos, and describe what you find.</p>
<p><a href="https://www.rtl-sdr.com/using-an-rtl-sdr-and-rpitx-to-defeat-the-rolling-code-scheme-used-on-some-subaru-cars/">Subaru RKS</a></p>
<p>2. The Flipper Zero has gotten lots of attention.  What controversies can you find? What can the device actually do?  Should it be banned?</p>
<p>3. Why steal a car when you can have a bulldozer!  Read this article, and watch the video, to see how this works.</p>
<p><a href="https://www.rtl-sdr.com/industrial-machines-like-cranes-excavators-can-easily-be-hacked-with-software-defined-radios/">Hacking Industrial Machines</a></p>
<p>4. There are lots of other car hacks out there.  See if you can find something interesting, and describe it.  Look for stories where you can figure out how it works. Entertainment systems are a common mode of access (check the Uconnect hack for Jeeps). Tesla and hackers have a long running cat-and-mouse game going.  There are lots of interesting examples here.  Two recent are <a href="https://techcrunch.com/2022/05/18/bluetooth-attack-unlock-tesla/">Teslas</a> and <a href="https://techcrunch.com/2022/07/12/honda-key-fob-flaw-hackers/">Hondas</a>.  </p>
<p>Finally, if you haven&#39;t already, please send me an email about how the class is going for you.  I appreciate hearing your thoughts. Thanks!</p>
</div></div>

</div></div>
  </body>
</html>
