<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://briancallahan.net/blog/20220704.html">Original</a>
    <h1>Next C compiler is a D compiler: Introducing DMD&#39;s ImportC</h1>
    
    <div id="readability-page-1" class="page">
	<a name="top"></a>
	<div id="main">
	    
	    <p>academic, developer, with an eye towards a brighter techno-social life</p>
	    <hr/>
		
	    <hr/>
	</div>
<h5 id="prev"><a href="https://briancallahan.net/blog/20220629.html">[prev]</a></h5>
<h5 id="next">[next]</h5>
    <h2 id="title">2022-07-04</h2>
<p>In my never ending quest to have <a href="https://github.com/ibara/oksh">oksh</a> support every <a href="https://en.wikipedia.org/wiki/C_(programming_language)">C</a> <a href="https://en.wikipedia.org/wiki/Compiler">compiler</a> in existence, I sometimes find C compilers in places you wouldn&#39;t expect them. Today, I&#39;d like to demonstrate the C compiler built into the <a href="https://www.digitalmars.com/">Digital Mars</a> <a href="https://dlang.org/">D</a> compiler, or <a href="https://wiki.dlang.org/DMD">DMD</a> for short. Recent versions of DMD have a complete <a href="https://en.wikipedia.org/wiki/C11_(C_standard_revision)">C11</a> compiler built in named <a href="https://forum.dlang.org/post/s79ib1$1122$1@digitalmars.com">ImportC</a>. It is mature enough to <span>almost</span> fully build oksh. Let&#39;s take a look at it.</p>
<h4>About ImportC</h4>
<p>ImportC was written by <a href="https://en.wikipedia.org/wiki/Walter_Bright">Walter Bright</a>, who is the person who created the <a href="https://en.wikipedia.org/wiki/D_(programming_language)">D programming language</a>. Previously, he developed one of the first <a href="https://en.wikipedia.org/wiki/C%2B%2B">C++</a> compilers by himself known as Zortech C++. He also created the <a href="https://en.wikipedia.org/wiki/Empire_(1977_video_game)">Empire</a> video game.</p>
<p>Full disclose, I have met Walter (virtually, at least). And as many of you know, I completed the <a href="https://briancallahan.net/blog/20210320.html">port</a> of all three D compilers, DMD, <a href="https://wiki.dlang.org/GDC">GDC</a>, and <a href="https://wiki.dlang.org/LDC">LDC</a>. I maintain the DMD, LDC, and <a href="https://github.com/dlang/dub">Dub</a> OpenBSD packages and help out with the GDC OpenBSD package. I have also <a href="https://www.youtube.com/watch?v=4Uu96MEoHqk">spoken</a> and done a <a href="https://www.youtube.com/watch?v=6QQl876Wlow">Q&amp;A session</a> at <a href="https://dconf.org/">DConf</a>, the annual D conference. All this to say that yes I am biased towards D succeeding but I will do my best to provide a clear picture of what ImportC can do today.</p>
<p>ImportC as mentioned is a C11 compiler. As I understand it, ImportC focuses on standard compliance rather than implementing lots of different extensions. Because D modules and libraries can be freely linked with C modules and libraries, a common activity in the D community is to port C headers to D modules. These translations allow D code to be more easily written that interacts with the C code and libraries. ImportC aims to help solve this tedious work by allowing DMD to ingest C code directly, bypassing the need to write these C header to D module translations at least in some cases.</p>
<p>As <a href="https://github.com/dlang/phobos">Phobos</a>, the D Standard Library, incorporates a copy of <a href="https://www.zlib.net/">zlib</a>, ImportC eliminates the need for an external C compiler during the DMD build process, meaning that all of DMD can be built by DMD. Indeed, that was one of the motivations behind the development of ImportC.</p>
<p>However, as a side effect, this means that the DMD compiler is also a C compiler and can be used directly on C codebases that don&#39;t include any D code.</p>
<h4>Building oksh with DMD</h4>
<p>oksh is a C codebase without any D code in it. Let&#39;s see if DMD can compile oksh. I started by configuring oksh with OpenBSD <code>cc</code>, aka <a href="https://clang.llvm.org/">clang</a>.</p>
<p>DMD uses different flags than the C compiler, and this needs to be taken into account. One of the first things to notice is that DMD does not have an <code>-o</code> flag. If you want to set the name of the output file, you need to use the <code>-of</code> flag. And there is no space between <code>-of</code> and the name of the output file. Next thing to know is that D itself does not use a preprocessor, and so there is a different syntax to specify flags to send to the C preprocessor when using ImportC. That flag is <code>-P=</code>. As oksh uses <code>-DEMACS</code> and <code>-DVI</code> flags, those need to be converted to <code>-P=-DEMACS</code> and <code>-P=-DVI</code> for DMD.</p>
<p>Because of the <code>-of</code> flag difference, I had to write a new rule in the <code>Makefile</code>:</p>
<pre>.c.o:
	${CC} ${CFLAGS} -of$@ -c $&lt;
</pre>
<p>Combined with the converted <code>CFLAGS</code>, that yield invocations that look like this:</p>
<pre>dmd -g -O -P=-DEMACS -P=-DVI -ofalloc.o -c alloc.c
</pre>
<h4>Running <code>make</code></h4>
<p>One last thing before we get started: as we learned in the <a href="https://briancallahan.net/blog/20220629.html">previous post</a>, OpenBSD uses <a href="https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html#Extended-Asm">GNU extended assembly</a> in some of its headers. While DMD does understand inline assembly, it does not understand GNU extended assembly. I simply <code>#ifdef</code>&#39;d out the offending code in that header file so that I didn&#39;t have to do anything more complicated. It would be great if DMD learned how to handle GNU extended assembly, but for now this workaround is fine.</p>
<p>Now I could run <code>make</code>. And it began compiling. Unfortunately, oksh triggers an error for an as-of-now unimplemented item:</p>
<pre>dmd -g -O -P=-DEMACS -P=-DVI -ofc_ksh.o -c c_ksh.c
c_ksh.c(1210): Error: C designator-list not supported yet
</pre>
<p>OK, so I built this file with clang and kept going. There was one more file that DMD couldn&#39;t compile:</p>
<pre>dmd -g -O -P=-DEMACS -P=-DVI -ofexpr.o -c expr.c
expr.c(204): Error: cannot modify `const` expression `(*es).tok`
expr.c(205): Error: cannot modify `const` expression `(*es).val`
</pre>
<p>I wonder if this is a bug in ImportC. No other C compiler we&#39;ve tried fails on this code.</p>
<p>Other than those two files, everything else builds with DMD. We need to change the library invocation in the link stage from <code>-lcurses</code> to <code>-L=-lcurses</code> as that&#39;s the format DMD expects, but that&#39;s not too dissimilar to the C preprocessor and the <code>-P=</code> modifications.</p>
<p>However, we get a lot of linker errors for multiple definitions of signal-related symbols. The solution is to add the <code>_ANSI_LIBRARY</code> definition to the C preprocessor. So we just add <code>-P=-D_ANSI_LIBRARY</code> to <code>CFLAGS</code>. That solved the problem.</p>
<p>And with that, we have a working oksh built (mostly) with DMD.</p>
<h4>Refining the process</h4>
<p>If we run <code>size</code> on the newly built oksh, we get surprisingly large numbers:</p>
<pre>/home/brian/oksh $ size oksh
text    data    bss     dec     hex
1082444 315776  55020   1453240 162cb8
</pre>
<p>This is suprising because DMD is an optimizing compiler, so we should expect numbers much better than this. It turns out a lot of this is wasted space; DMD is linking in the <a href="https://github.com/dlang/druntime">DRuntime</a> and Phobos libraries into the executable, but we&#39;re not using the D standard library. The solution is to add the <code>-betterC</code> flag to <code>CFLAGS</code>. This flag disables the Phobos standard library from being linked in. It also disables the ability for you to use any features from Phobos, but since we&#39;re only compiling C code, there&#39;s nothing from Phobos that we need.</p>
<p>And indeed, that does the trick:</p>
<pre>/home/brian/oksh $ size oksh
text    data    bss     dec     hex
799716  67872   55020   922608  e13f0
</pre>
<p>But that still seems a little large. We can add the <code>-release</code> and <code>-inline</code> flags to <code>CFLAGS</code> to tell DMD not to emit contracts and asserts, and to try to inline functions as it can. This gets us to a size <a href="https://briancallahan.net/blog/20211010.html">comparable</a> to clang and <a href="https://gcc.gnu.org/">gcc</a>:</p>
<pre>/home/brian/oksh $ size oksh
text    data    bss     dec     hex
284573  8488    50480   343541  53df5
</pre>
<p>Neat. The resulting binary works fine.</p>
<p>The only interesting bit left to report is that DMD links in many libraries that the other C compilers do not such as libc++ and libpthread. The solution here is to add <code>-L=--as-needed</code> to the linking step to tell <a href="https://lld.llvm.org/">lld</a> not to link in shared libraries that are not used.</p>
<h4>Building some other software</h4>
<p>DMD was able to build <a href="https://github.com/ibara/oed">oed</a> without issue and was able to build <a href="https://github.com/ibara/mg">mg</a> with the exception of <code>interpreter.c</code>:</p>
<pre>dmd -g -O -release -inline -betterC -P=-DREGEX -P=-D_ANSI_LIBRARY -P=-D__DMD__ -ofinterpreter.o -c interpreter.c
interpreter.c(108): Error: cannot implicitly convert expression `&#34;define&#34;` of type `char[7]` to `char`
interpreter.c(109): Error: cannot implicitly convert expression `&#34;list&#34;` of type `char[5]` to `char`
interpreter.c(110): Error: cannot implicitly convert expression `&#34;if&#34;` of type `char[3]` to `char`
interpreter.c(111): Error: cannot implicitly convert expression `&#34;lambda&#34;` of type `char[7]` to `char`
</pre>
<h4>Conclusion</h4>
<p>ImportC has come a long way since it was <a href="https://github.com/dlang/dmd/commit/40541dd18250e961040b2e94b1728b4870344825">imported</a> into DMD a little over a year ago. It helps DMD be fully self-contained, and can help in certain situations combining C and D code together. While there is the side effect of being able to be used to compile C-only codebases, that really is a side effect I think. With that said, definitely feel free to try ImportC on your own C codebases. It might just be the soft introduction to D you&#39;ve been looking for.</p>
<p>While ImportC would be difficult to use in a <code>configure</code> script due to incompatible flags, like we did with oksh you can use it after configuring with another C compiler and altering commandline flags as necessary.</p>
<p>This kind of experimentation has made being a part of the D community a lot of fun and I&#39;m looking forward to seeing what D has in store in the future.</p>
<p><a href="#top"><img alt="Top" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAICAYAAADJEc7MAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4wkWDyUKJxzXegAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAAUklEQVQY02Ocd/j/fwY0kGjDwMhACPz//5/h////DPMO//8PYxODWXAZOP8Iw39k22F8uBg2G7Gx0cWYGMgEWJ2aaMPAiO5UDOcTGxjogUe2UwHwdJDZUucW5QAAAABJRU5ErkJggg=="/></a></p>
<a href="https://briancallahan.net/blog/feed.xml"><img alt="RSS" src="https://briancallahan.net/blog/media/pic_rss.gif"/></a>
	</div>
  </body>
</html>
