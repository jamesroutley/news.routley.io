<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/hexagonal-sun/moss">Original</a>
    <h1>Moss: a Rust Linux-compatible kernel in 26,000 lines of code</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/42fec9032bb44dc60c8fe930df7a597acbc36f94c56bc8c75c9e772e38af5e29/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f617263682d616172636836342d626c7565"><img src="https://camo.githubusercontent.com/42fec9032bb44dc60c8fe930df7a597acbc36f94c56bc8c75c9e772e38af5e29/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f617263682d616172636836342d626c7565" alt="Architecture" data-canonical-src="https://img.shields.io/badge/arch-aarch64-blue"/></a>
<a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/6619aab17230004114ae2459c470007f3807146691e7c1c3acab9bc30353f620/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f6c616e67756167652d527573742d6f72616e6765"><img src="https://camo.githubusercontent.com/6619aab17230004114ae2459c470007f3807146691e7c1c3acab9bc30353f620/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f6c616e67756167652d527573742d6f72616e6765" alt="Language" data-canonical-src="https://img.shields.io/badge/language-Rust-orange"/></a>
<a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/3921b6a636b7d3fc4db90f929b9047fb47fa4fdd6233a2b5fa60b827480fc2c5/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f6c6963656e73652d4d49542d79656c6c6f77"><img src="https://camo.githubusercontent.com/3921b6a636b7d3fc4db90f929b9047fb47fa4fdd6233a2b5fa60b827480fc2c5/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f6c6963656e73652d4d49542d79656c6c6f77" alt="License" data-canonical-src="https://img.shields.io/badge/license-MIT-yellow"/></a></p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/hexagonal-sun/moss-kernel/blob/master/etc/moss_demo.gif"><img src="https://github.com/hexagonal-sun/moss-kernel/raw/master/etc/moss_demo.gif" alt="Moss Boot Demo" data-animated-image=""/></a></p>
<p dir="auto"><strong>moss</strong> is a Unix-like, Linux-compatible kernel written in Rust and Aarch64
assembly.</p>
<p dir="auto">It features a modern, asynchronous core, a modular architecture abstraction
layer, and binary compatibility with Linux userspace applications (currently
capable of running most BusyBox commands).</p>


<ul dir="auto">
<li>Full support for aarch64.</li>
<li>A well-defined HAL allowing for easy porting to other architectures (e.g.,
x86_64, RISC-V).</li>
<li>Memory Management:
<ul dir="auto">
<li>Full MMU enablement and page table management.</li>
<li>Copy-on-Write (CoW) pages.</li>
<li>Safe copy to/from userspace async functions.</li>
<li>Kernel and userspace page fault management.</li>
<li>Buddy allocator for physical addresses and <code>smalloc</code> for boot allocations
and tracking memory reservations.</li>
</ul>
</li>
</ul>

<p dir="auto">One of the defining features of <code>moss</code> is its usage of Rust&#39;s <code>async/await</code>
model within the kernel context:</p>
<ul dir="auto">
<li>All non-trivial system calls are written as <code>async</code> functions, sleep-able
functions are prefixed with <code>.await</code>.</li>
<li>The compiler enforces that spinlocks cannot be held over sleep points,
eliminating a common class of kernel deadlocks.</li>
</ul>

<ul dir="auto">
<li>Full task management including scheduling and task migration via IPIs.</li>
<li>Currently implements <a href="https://github.com/hexagonal-sun/moss-kernel/blob/master/etc/syscalls_linux_aarch64.md">51 Linux syscalls</a>; sufficient to execute most BusyBox
commands.</li>
<li>Advanced forking capabilities via <code>clone()</code>.</li>
<li>Process and thread signal delivery and raising support.</li>
</ul>

<ul dir="auto">
<li>Virtual File System with full async abstractions.</li>
<li>Drivers:
<ul dir="auto">
<li>Ramdisk block device implementation.</li>
<li>FAT32 filesystem driver (ro).</li>
<li><code>devtmpfs</code> driver for kernel character device access.</li>
</ul>
</li>
</ul>

<p dir="auto"><code>moss</code> is built on top of <code>libkernel</code>, a utility library designed to be
architecture-agnostic. This allows logic to be tested on a host machine (e.g.,
x86) before running on bare metal.</p>
<ul dir="auto">
<li>Address Types: Strong typing for <code>VA</code> (Virtual), <code>PA</code> (Physical), and <code>UA</code>
(User) addresses.</li>
<li>Containers: <code>VMA</code> management, generic page-based ring buffer (<code>kbuf</code>), and
waker sets.</li>
<li>Sync Primitives: <code>spinlock</code>, <code>mutex</code>, <code>condvar</code>, <code>per_cpu</code>.</li>
<li>Test Suite: A comprehensive suite of 230+ tests ensuring functionality across
architectures (e.g., validating Aarch64 page table parsing logic on an x86
host).</li>
</ul>


<p dir="auto">You will need QEMU for aarch64 emulation and dosfstools to create the virtual file system.</p>
<div dir="auto" data-snippet-clipboard-copy-content="sudo apt install qemu-system-aarch64 dosfstools"><pre>sudo apt install qemu-system-aarch64 dosfstools</pre></div>
<p dir="auto">Additionally you will need a version of the <a href="https://developer.arm.com/Tools%20and%20Software/GNU%20Toolchain" rel="nofollow">aarch64-none-elf</a> toolchain installed.</p>

<p dir="auto">To install aarch64-none-elf on any os, download the correct release of <code>aarch64-none-elf</code> onto your computer, unpack it, then export the <code>bin</code> folder to path.</p>

<p dir="auto">Run the following command</p>
<div dir="auto" data-snippet-clipboard-copy-content="nix shell nixpkgs#pkgsCross.aarch64-embedded.stdenv.cc nixpkgs#pkgsCross.aarch64-embedded.stdenv.cc.bintools"><pre>nix shell nixpkgs#pkgsCross.aarch64-embedded.stdenv.cc nixpkgs#pkgsCross.aarch64-embedded.stdenv.cc.bintools</pre></div>

<p dir="auto">First, run the following script to prepare the binaries for the image:</p>

<p dir="auto">This will download and build the necessary dependencies for the kernel and put them
into the <code>build</code> directory.</p>
<p dir="auto">Once that is done, you can create the image using the following command:</p>
<div dir="auto" data-snippet-clipboard-copy-content="sudo ./scripts/create-image.sh"><pre>sudo ./scripts/create-image.sh</pre></div>
<p dir="auto">This will create an image file named <code>moss.img</code> in the root directory of the project,
format it as VFAT 32 and create the necessary files and directories for the kernel.</p>
<p dir="auto">This script needs to run with sudo to mount the image through a loop device,
which is required to properly create the image for the kernel to work.</p>

<p dir="auto">To build the kernel and launch it in QEMU:</p>


<p dir="auto">Because <code>libkernel</code> is architecturally decoupled, you can run the logic tests on
your host machine:</p>
<div dir="auto" data-snippet-clipboard-copy-content="cargo test -p libkernel --target x86_64-unknown-linux-gnu"><pre>cargo <span>test</span> -p libkernel --target x86_64-unknown-linux-gnu</pre></div>

<p dir="auto">moss is under active development. Current focus areas include:</p>
<ul dir="auto">
<li>Basic Linux Syscall Compatibility (Testing through BusyBox).</li>
<li>Networking Stack: TCP/IP implementation.</li>
<li>Scheduler Improvements: Task load balancing.</li>
<li>A fully read/write capable filesystem driver (e.g., ext2/4).</li>
<li>Expanding coverage beyond the current 49 calls.</li>
</ul>

<p dir="auto">Contributions are welcome! Whether you are interested in writing a driver,
porting to x86, or adding syscalls.</p>

<p dir="auto">Distributed under the MIT License. See LICENSE for more information.</p>
</article></div></div>
  </body>
</html>
