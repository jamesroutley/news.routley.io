<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/winterknife/PINKPANTHER">Original</a>
    <h1>Windows x64 handcrafted token stealing kernel-mode shellcode</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<h2 dir="auto"><a id="user-content-brief" aria-hidden="true" href="#brief"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Brief</h2>
<p dir="auto"><code>Windows</code> <code>x64</code> kernel-mode handcrafted shellcode to replace primary access token of executing process with <code>SYSTEM</code> process token for <code>Elevation of Privilege(EoP)</code>.</p>
<h2 dir="auto"><a id="user-content-supported-os-versions" aria-hidden="true" href="#supported-os-versions"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Supported OS Versions</h2>
<ul dir="auto">
<li><code>Windows 7/Windows Server 2008 R2 Build 7601</code></li>
<li><code>Windows 8/Windows Server 2012 Build 9200</code></li>
<li><code>Windows 8.1/Windows Server 2012 R2 Build 9600</code></li>
<li><code>Windows 10 1507/TS1 Build 10240</code></li>
<li><code>Windows 10 1511/TS2 Build 10586</code></li>
<li><code>Windows 10 1607/RS1/Windows Server 2016 Build 14393</code></li>
<li><code>Windows 10 1703/RS2 Build 15063</code></li>
<li><code>Windows 10 1709/RS3 Build 16299</code></li>
<li><code>Windows 10 1803/RS4 Build 17134</code></li>
<li><code>Windows 10 1809/RS5/Windows Server 2019 Build 17763</code></li>
<li><code>Windows 10 1903/19H1 Build 18362</code></li>
<li><code>Windows 10 1909/19H2 Build 18363</code></li>
<li><code>Windows 10 2004/20H1 Build 19041</code></li>
<li><code>Windows 10 2009/20H2 Build 19042</code></li>
<li><code>Windows 10 2104/21H1 Build 19043</code></li>
<li><code>Windows 10 2110/21H2 Build 19044</code></li>
</ul>
<h2 dir="auto"><a id="user-content-building-and-deployment" aria-hidden="true" href="#building-and-deployment"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Building and Deployment</h2>
<p dir="auto">The prerequisites for building this project are:</p>
<ol dir="auto">
<li><code>Visual Studio 2019(any edition will do fine)</code></li>
<li><code>Windows 10 SDK, version 2004</code></li>
<li><code>Windows 10 WDK, version 2004</code></li>
<li><code>Python3</code></li>
</ol>
<p dir="auto">After installing the above, it should be as easy as opening the solution with <code>Visual Studio</code> and building for <code>x64</code> target.</p>
<p dir="auto">After a successful build, binaries can be found inside the <code>Bin</code> directory under the appropriate bitness sub-directory.</p>
<p dir="auto">Alternatively, you may download ready-to-deploy position independent shellcode from <code>Releases</code>.</p>
<p dir="auto">Please do <strong>NOT</strong> try to deploy the payload on a machine that you rely on to get work done if you are unsure of how it works.</p>
<p dir="auto">Refer to <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/download-the-wdk" rel="nofollow">Microsoft docs</a> for any additional information.</p>
<h2 dir="auto"><a id="user-content-testing" aria-hidden="true" href="#testing"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Testing</h2>
<p dir="auto">For testing purposes, I would highly recommend using <a href="https://github.com/mandiant/flare-kscldr">flare-kscldr</a> to deploy the kernel-mode shellcode on a test <code>VM</code> and <a href="https://www.codemachine.com/articles/system_setup_for_kernel_development.html" rel="nofollow">CodeMachine System setup for kernel development and debugging guide</a> to set up a <code>Hyper-V Guest VM</code> with full kernel debugging support.</p>
<p dir="auto">Optionally, you may also consider automating the process with <a href="https://github.com/ioncodes/kdbg-driver-vagrant">kdbg-driver-vagrant</a> to quickly spin up a test <code>VM</code> with full kernel debugging using <a href="https://www.vagrantup.com/" rel="nofollow">Vagrant</a>.</p>
<h2 dir="auto"><a id="user-content-screenshots" aria-hidden="true" href="#screenshots"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Screenshots</h2>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/winterknife/PINKPANTHER/blob/master/Misc/demo.PNG"><img src="https://github.com/winterknife/PINKPANTHER/raw/master/Misc/demo.PNG" alt="demo"/></a></p>
<h2 dir="auto"><a id="user-content-related-works" aria-hidden="true" href="#related-works"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Related Works</h2>
<ol dir="auto">
<li><a href="https://connormcgarr.github.io/x64-Kernel-Shellcode-Revisited-and-SMEP-Bypass/" rel="nofollow">Exploit Development: Panic! At The Kernel - Token Stealing Payloads Revisited on Windows 10 x64 and Bypassing SMEP</a></li>
<li><a href="https://hshrzd.wordpress.com/2017/06/22/starting-with-windows-kernel-exploitation-part-3-stealing-the-access-token/" rel="nofollow">Starting with Windows Kernel Exploitation – part 3 – stealing the Access Token</a></li>
<li><a href="https://www.abatchy.com/2018/01/kernel-exploitation-2" rel="nofollow">[Kernel Exploitation] 2: Payloads</a></li>
<li><a href="https://www.matteomalvica.com/blog/2019/07/06/windows-kernel-shellcode/" rel="nofollow">Windows Kernel Shellcodes - a compendium</a></li>
<li><a href="https://improsec.com/tech-blog/windows-kernel-shellcode-on-windows-10-part-1" rel="nofollow">Windows Kernel Shellcode on Windows 10 – Part 1</a></li>
<li><a href="https://amriunix.com/post/windows-kernel-shellcode-tokenstealer/" rel="nofollow">Windows Kernel Shellcode : TokenStealer</a></li>
<li><a href="https://mcdcyber.wordpress.com/2011/03/07/x64-kernel-privilege-escalation/" rel="nofollow">x64 Kernel Privilege Escalation</a></li>
</ol>
</article>
          </div></div>
  </body>
</html>
