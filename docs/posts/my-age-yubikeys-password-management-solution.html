<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://words.filippo.io/dispatches/passage/">Original</a>
    <h1>My age&#43;YubiKeys Password Management Solution</h1>
    
    <div id="readability-page-1" class="page"><article>
        <span>
            <time datetime="2022-12-28">28 Dec 2022</time>
        </span>
        
        
        <section>
            <!--kg-card-begin: markdown--><p>Password managers are in the news, and it‚Äôs the holidays, so it‚Äôs as good a time as ever to describe my password and secret management setup. It‚Äôs very much not for everyone, but it‚Äôs minimal, simple, and has some interesting security properties: even if my laptop were compromised, it would take an attacker a very long time to extract more than a few low-importance secrets.</p>
<p>I use <a href="https://github.com/FiloSottile/passage">passage</a>, a fork of <a href="https://www.passwordstore.org/">password-store</a> that encrypts files with <a href="https://age-encryption.org/">age</a> instead of GnuPG, along with <a href="https://github.com/str4d/age-plugin-yubikey">age-plugin-yubikey</a> by <a href="https://github.com/str4d">Str4d</a>.</p>
<h2 id="storage-and-sync">Storage and sync</h2>
<p><code>passage</code>, like <code>pass</code>, is effectively a script that makes it convenient to store and retrieve encrypted passwords and secrets from the command line. Each secret is stored in a separate file in <code>$PASSAGE_DIR</code>, which I keep synced with <a href="https://syncthing.net/">Syncthing</a> and backed up with <a href="https://restic.net/">restic</a>. Changes are automatically versioned with git.</p>
<pre><code>$ passage generate -n example.com 20
[main de2abc4] Add generated password for example.com.
 1 file changed, 0 insertions(+), 0 deletions(-)
 create mode 100644 example.com.age
The generated password for example.com is:
EOUblkyPqAXHtKT963aP
$ passage -c example.com
Copied example.com to clipboard. Will clear in 45 seconds.
</code></pre>
<h2 id="security">Security</h2>
<p>Secrets are encrypted to two keys generated on two YubiKeys with the default settings of age-plugin-yubikey. These keys can‚Äôt be extracted or cracked by any attacker, regardless of how compromised my laptop or vault gets. One YubiKey is a USB-C Nano that lives in my laptop, the other one lives on my keychain. If (when!) one breaks, I can use the other to re-encrypt all files to the replacement.</p>
<pre><code>age-plugin-yubikey # run interactive setup
age-plugin-yubikey --identity &gt;&gt; $HOME/.passage/identities
age-plugin-yubikey --list &gt;&gt; $HOME/.passage/store/.age-recipients
</code></pre>
<p>Since age-plugin-yubikey configures keys to require a PIN for every session, and PINs are limited to 3 + 3 attempts before locking, losing a YubiKey is pretty much a non-event. More importantly, since keys are configured to require touch <em>at every use</em> and each secret is encrypted separately, <strong>even a full compromise of my laptop wouldn‚Äôt let an attacker dump the whole vault at once</strong>: each secret needs a separate physical YubiKey tap to decrypt. I might not notice a decryption failure or two in daily usage, but I will definitely notice something‚Äôs off before I tap the YubiKey dozens of times.</p>
<p>Some secrets which I consider especially sensitive and are used rarely are saved in a subdirectory (called &#34;Brooklyn Battery Tunnel&#34;, in case anyone catches the reference) and encrypted only to the keychain YubiKey. If an attacker wants even one of those secrets, they will have to compromise my laptop and then wait for weeks until I plug in the higher-privilege YubiKey and tap it. If they hijacked the tap to decrypt a different secret, I would immediately notice that the secret I requested didn‚Äôt decrypt successfully.</p>
<p>Note that this is designed to fit my threat model: I trust my sync and storage backend, and I‚Äôm mostly interested in hardware-binding the secrets to the YubiKey, to rate-limit exfiltration and give myself a chance to recover from compromise. If you don‚Äôt trust your storage, you‚Äôll want to at the very least set <code>$PASSAGE_RECIPIENTS_FILE</code> to a path on the local system, instead of keeping <code>.age-recipients</code> files next to the encrypted files, where the storage provider could change them.</p>
<h2 id="recovery">Recovery</h2>
<p>The <code>.age-recipients</code> files also include the public key for an offline disaster recovery key. I generated the key with <code>age-keygen</code>, encrypted it with <code>age -p</code>, printed the ciphertext as a QR code, and wrote the random passphrase in pen. This is a bit convoluted, but I don‚Äôt trust printers. üñ®Ô∏èüßê All this was done in a tmpfs, so nothing reached storage. Only had to do this once, and have been using that key as the anchor for all my disaster recovery data.</p>
<p>I also periodically rsync the passage store to an SD card. That SD card along with a YubiKey is the starting point to reprovision a new laptop. This is kind of a hassle and I might move that role to iCloud Drive now that it‚Äôs end-to-end encrypted.</p>
<h2 id="mobile">Mobile</h2>
<p>Everyone asks what I do for mobile, and the thing is, I don‚Äôt really use passwords on my phone all that often. Most apps stay logged in forever with Face ID, as they should. I also like not carrying access to all my secrets on me, even if the iPhone is probably the most secure device I have.</p>
<p>When I need to log into an app, I generate a QR code with <code>passage -q</code>, scan it with the iOS camera app, and copy and paste it. It would be nice if there was an app that used the password management API to automate this, but this happens rarely enough that it‚Äôs not worth optimizing for me.</p>
<p><img src="https://words.filippo.io/content/images/2022/12/IMG_F232C83A0E1A-1.jpeg" alt="A screenshot of the iOS camera app scanning a QR code generated by passage" loading="lazy"/></p>
<h2 id="p-fzf">p / fzf</h2>
<p>A big usability upgrade is a five-lines bash script that uses <a href="https://github.com/junegunn/fzf">fzf</a> to provide fuzzy search.</p>
<pre><code>#! /usr/bin/env bash
set -eou pipefail
PREFIX=&#34;${PASSAGE_DIR:-$HOME/.passage/store}&#34;
FZF_DEFAULT_OPTS=&#34;&#34;
name=&#34;$(find &#34;$PREFIX&#34; -type f -name &#39;*.age&#39; | \
  sed -e &#34;s|$PREFIX/||&#34; -e &#39;s|\.age$||&#39; | \
  fzf --height 40% --reverse --no-multi)&#34;
passage &#34;${@}&#34; &#34;$name&#34;
</code></pre>
<p>I have it on <code>$PATH</code> as <code>p</code>, and ‚åò-0 brings up iTerm2, so I can do</p>
<p>‚åò-0, ‚Äúp -c‚Äù, ‚Ü©, ‚Äúex‚Äù, ‚Ü©, tap YubiKey, ‚åò-0, ‚åò-V</p>
<p>to copy and paste the password for example.com. It fits nicely in muscle memory.</p>
<h2 id="future-work-yubikey-agent-integration">Future work: yubikey-agent integration</h2>
<p>I‚Äôm pretty happy with the setup as it is, but there‚Äôs one thing still on the roadmap: <a href="https://github.com/FiloSottile/yubikey-agent">yubikey-agent</a> integration. yubikey-agent is an SSH agent that uses the YubiKey PIV applet like age-plugin-yubikey. It has a native graphical PIN prompt on macOS, is compatible with all servers, and unlike gpg-agent doesn‚Äôt need restarting all the time. It also keeps a persistent connection to the PIV applet, which allows it to use the YubiKey‚Äôs PIN cache to require the PIN only once per session. Unfortunately, this connection <a href="https://github.com/FiloSottile/yubikey-agent/issues/4">keeps an exclusive lock on the applet</a> which conflicts with age-plugin-yubikey.</p>
<p>For now, I solved it by adding <code>killall -SIGHUP yubikey-agent</code> to the <code>p</code> script, and everything works smoothly, despite having to type the PIN when I switch from SSH to passage.</p>
<p>Soon, I plan to make an age-plugin-yubikey-agent which talks to a running instance of yubikey-agent and uses the keys generated by age-plugin-yubikey. This way, I‚Äôll basically never have to type the PIN.</p>
<p>The main blocker is figuring out the protocol to make age-plugin-yubikey-agent talk to yubikey-agent. One compelling option is to use an SSH agent protocol extension, but I need to make sure it doesn‚Äôt get forwarded by <code>ssh -A</code> by default. It would be pretty surprising if forwarding SSH authentications also forwarded age decryptions. <a href="https://www.openssh.com/agent-restrict.html">OpenSSH recently added some support for detecting forwarded requests</a>, so that might allow me to deny them for the age protocol, and maybe also add a confirmation prompt for forwarded SSH authentication that tells the user what host the remote is trying to authenticate to.</p>
<h2 id="bonus-using-passage-in-scripts">Bonus: using passage in scripts</h2>
<p>A final tip: age-plugin-yubikey delegates the PIN prompt to age via <a href="https://github.com/C2SP/C2SP/pull/5">the plugin protocol</a>, and age has <a href="https://github.com/FiloSottile/age/blob/main/cmd/age/tui.go">a pretty good terminal UI</a>, so it can ask for the PIN even if used from a script and even if stdin and stderr are redirected.</p>
<p>This means I can use it from Python scripts such as <a href="https://github.com/OfflineIMAP/offlineimap">offlineimap</a>‚Äôs <code>remotepasseval</code> function</p>
<pre><code>#! /usr/bin/env python2
from subprocess import check_output
def get_pass():
    return check_output([&#34;passage&#34;, &#34;credentials/offlineimap&#34;]).splitlines()[0]
</code></pre>
<p>or with Ansible‚Äôs <code>passwordstore</code> plugin (after adding a <code>pass</code> alias for <code>passage</code> in <code>$PATH</code>)</p>
<pre><code>- name: cache passwordstore access
  set_fact:
    secrets: &#34;{{ lookup(&#39;passwordstore&#39;, &#39;credentials/fleet.yaml returnall=true&#39;) | from_yaml }}&#34;
</code></pre>
<p>If this looks interesting, there‚Äôs a script for migrating from password-store in <a href="https://github.com/FiloSottile/passage/blob/main/README">the passage README</a>, and I always welcome UX reports (positive or negative) as GitHub Discussions.</p>
<p>To get updates on all these projects, you can subscribe to this newsletter below or <a href="https://abyssdomain.expert/@filippo">follow me at @filippo@abyssdomain.expert</a>!</p>
<h2 id="the-picture">The picture</h2>
<p>This is a &#34;succo d‚Äôerba&#34; from the early 1900&#39;s, painted with natural pigments on tapestry cloth. My 95 years old grandfather shipped this to me. It used to hang in his father&#39;s office, then in his own, and it now hangs in mine.</p>
<p><img src="https://words.filippo.io/content/images/2022/12/Fi6fyAqWYAARFy-.jpg" alt="The side of a room, at the bottom there&#39;s a sofa, above it a large painting. It shows two tigers in the grass, with a painted frame." loading="lazy"/></p>


<!--kg-card-end: markdown-->
        </section>
    </article></div>
  </body>
</html>
