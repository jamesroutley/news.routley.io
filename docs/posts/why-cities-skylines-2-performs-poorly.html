<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.paavo.me/cities-skylines-2-performance/">Original</a>
    <h1>Why Cities: Skylines 2 performs poorly</h1>
    
    <div id="readability-page-1" class="page"><div>
    

<article>
  <header>
    
    
    <p role="doc-subtitle">The teeth are not the only problem</p>
    
    <time datetime="2023-11-05">2023-11-05</time>
  </header>

  
  <details>
    <summary>
      Table of contents
    </summary>
    <ol>
      
      <li>
        <a href="https://blog.paavo.me/cities-skylines-2-performance/#this-is-not-a-performance-review">(This is not) a performance review</a>
        
      </li>
      
      <li>
        <a href="https://blog.paavo.me/cities-skylines-2-performance/#pulling-back-the-curtain">Pulling back the curtain</a>
        
        <ul>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#engine-and-architecture">Engine and architecture</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#attachment-issues">Attachment issues</a>
          </li>
          
        </ul>
        
      </li>
      
      <li>
        <a href="https://blog.paavo.me/cities-skylines-2-performance/#renderdoc-analysis">Renderdoc analysis</a>
        
        <ul>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#dots-instance-data-update">DOTS instance data update</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#simulation">Simulation</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#virtual-texturing-cache-update">Virtual texturing cache update</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#skybox-generation">Skybox generation</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#pre-pass">Pre-pass</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#the-teeth-controversy">The teeth controversy</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#pre-pass-continued-featuring-the-high-poly-hall-of-shame">Pre-pass continued, featuring the high poly hall of shame</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#motion-vectors">Motion vectors</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#roads-and-decals">Roads and decals</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#main-pass">Main pass</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#ambient-occlusion">Ambient occlusion</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#cascaded-shadow-mapping">Cascaded shadow mapping</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#screen-space-reflections-and-global-illumination">Screen space reflections and global illumination</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#deferred-lighting">Deferred lighting</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#weird-clothing-pass">Weird clothing pass</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#sky-rendering">Sky rendering</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#transparent-objects-pre-pass">Transparent objects pre-pass</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#water-rendering">Water rendering</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#particles-rain-and-transparent-objects">Particles, rain and transparent objects</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#vt-feedback-processing">VT feedback processing</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#bunch-of-post-processing">Bunch of post-processing</a>
          </li>
          
          <li>
            <a href="https://blog.paavo.me/cities-skylines-2-performance/#outlines-text-and-other-ui">Outlines, text and other UI</a>
          </li>
          
        </ul>
        
      </li>
      
      <li>
        <a href="https://blog.paavo.me/cities-skylines-2-performance/#summary-and-conclusions">Summary and conclusions</a>
        
      </li>
      
    </ol>
  </details>
  

  <p>One of the most highly anticipated PC games of the year <a href="https://www.paradoxinteractive.com/games/cities-skylines-ii/about">Cities: Skylines 2</a> was released last week to a <a href="https://opencritic.com/game/15195/cities-skylines-2">mixed reception</a>. My impression is that gameplay and simulation-wise it seems to be a step in the right direction, and at least on paper the game seems more well-rounded in terms of features than the original was at launch. There are however significant issues with the game, ranging from balance problems and questionable design choices to <a href="https://forum.paradoxplaza.com/forum/threads/im-export-bug-hints-symptoms-and-causes-all-resource-management-in-the-game-is-a-deception.1604434/page-4#post-29216506">bugs</a> rendering a lot of the game‚Äôs economic simulation almost pointless. Whether or not the game is a worthy successor to the original is an open question at this point, but one thing is almost universally agreed upon: the title‚Äôs performance is not up to par.</p>
<h2 id="this-is-not-a-performance-review"><a href="#this-is-not-a-performance-review" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>(This is not) a performance review</h2>
<p>There were warning signs. Under a month before release date there was <a href="https://forum.paradoxplaza.com/forum/threads/cities-skylines-ii-console-release-window-faq.1600202/">an announcement</a> informing that the game‚Äôs recommended system requirements had been raised, and the console release was delayed to 2024. Quite a few YouTubers and streamers got early access to the game, but they were explicitly forbidden to talk about performance until the regular review embargo was lifted. This wasn‚Äôt exceptional as games tend to receive frequent performance optimizations and other fixes in the last few weeks before release, but it wasn‚Äôt a good sign either. Then, just a week before release Colossal Order issued <a href="https://forum.paradoxplaza.com/forum/threads/updates-on-modding-and-performance-for-cities-skylines-ii.1601865/">a statement</a> which I‚Äôd describe as a pre-emptive apology for the poor performance of the game. And then the game was released.</p>
<p>Simulation-heavy games like city builders can be surprisingly hard to run at a good framerate, but what makes Cities: Skylines 2 stand out is that on most systems and in most situations the game is <a href="https://devblogs.microsoft.com/directx/cpu-and-gpu-boundedness/">GPU-bound</a> ‚Äî rather unusual for a game of this genre, as most games like this tend to be really heavy on the CPU (such as the original Cities: Skylines), but relatively light on graphics. Visually the game is an improvement on most aspects compared to the 2015 original, but nothing really justifies the game <a href="https://www.pcgameshardware.de/Cities-Skylines-2-Spiel-74219/Tests/Release-Benchmarks-Performance-Tuning-Tipps-1431613/2/">being harder to run</a> than maxed out Cyberpunk 2077 with path tracing enabled. Personally I‚Äôd even argue that C:S2 looks quite unpleasant; while individual models are relatively detailed and the sense of scale is impressive, the shading is decidedly last-gen and the screen is absolutely covered in rendering artifacts and poorly filtered textures. Comparing the game‚Äôs graphics to a relatively close competitor <a href="https://store.steampowered.com/app/916440/Anno_1800/">Anno 1800</a> (which was released in 2019) doesn‚Äôt do it any favours. Anno goes for a slightly more stylized look and in my humble opinion manages to look more polished and consistent, while <a href="https://www.guru3d.com/review/anno-1800-open-beta-pc-graphics-performance-benchmark-review/page-7/">offering decent performance</a> even on hardware that was considered low-to-mid range in 2019.</p>
<figure>
  <img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_character.jpeg" alt="A screenshot of a character in Cities: Skylines 2"/>
  <figcaption>There‚Äôs a lot going on this with this character: oddly smooth hair, weirdly chunky beard, suspicious moustache, 100% opaque drug dealer sunglasses, a seam between the head and the rest of the body, and painted-on clothes.</figcaption>
</figure>
<p>I‚Äôm not going to waste my time meticulously benchmarking the game because many others have done that already and to a significantly higher standard than I could. If you are interested in that, check out <a href="https://www.pcgameshardware.de/Cities-Skylines-2-Spiel-74219/Tests/Release-Benchmarks-Performance-Tuning-Tipps-1431613/2/">this written article</a> from PC Games Hardware (in German) or <a href="https://www.youtube.com/watch?v=l4DX6mUY78s">this video</a> from Gamers Nexus (in Americanese). I‚Äôll summarize the results as such: when the settings are turned above the bare minimum (the ‚Äúvery low‚Äù graphics preset completely disables decadent luxuries such as shadows and fog) you need a graphics card that costs about 1000 to 2000 euros to run at the game at 60 frames per second at 1080p. As a comparison similar hardware in Alan Wake 2 ‚Äî which was released the same week as C:S2 and is considered <a href="https://www.eurogamer.net/digitalfoundry-2023-alan-wake-2-optimised-settings-for-pc">by some</a> to be the best looking game of this console generation ‚Äî <a href="https://www.techpowerup.com/review/alan-wake-2-performance-benchmark/8.html">reaches comparable average framerates</a> with all settings cranked <em>including path tracing</em>, either at 1440p without any upscaling magic or at 4K with some help from DLSS. I think that‚Äôs a good illustration of how bizarrely demanding C:S2 is.</p>
<figure>
  <img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_perf.png" alt="A screenshot of a CPU usage graph and utilization percentages for different aspects of hardware."/>
  <figcaption>The game ran so poorly that Windows Game Bar refused to acknowledge there even was a framerate.</figcaption>
</figure>
<p>Some personal experiences to cap off this introduction: when I started the game for the first time on my relatively beefy gaming PC (equipped with an NVidia RTX 3080 graphics card, an AMD Ryzen 7 5800X CPU and a 5120x1440 super ultrawide monitor) I was greeted by a frame rate of under 10 FPS in the main menu. After tweaking the settings <a href="https://store.steampowered.com/news/app/949230/view/3744239011016263869">as instructed by the developer</a> (which involved disabling depth of field, motion blur and volumetric effects) my FPS reached almost 90. What made this especially bizarre was that the menu features just a static background image and a few buttons. Loading into an empty map gave me about 30 to 40 FPS, and the frame rate stayed around that level after playing for about an hour, with the occasional stutter. Let‚Äôs investigate.</p>
<figure>
  <img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_mainmenu.jpg" alt="A screenshot of a Cities: Skylines 2‚Äôs main menu."/>
  <figcaption>100% GPU usage and 7 frames per second, everyone. Cropped from 32:9.</figcaption>
</figure>
<h2 id="pulling-back-the-curtain"><a href="#pulling-back-the-curtain" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Pulling back the curtain</h2>
<p>Cities: Skylines 2 like its predecessor is made in <a href="https://unity.com/">Unity</a>, which means the game can be decompiled and inspected quite easily using any .NET decompiler. I used <a href="https://www.jetbrains.com/decompiler/">JetBrains dotPeek</a> which has a decent Visual Studio -like UI with a large variety of search and analysis options. However static analysis doesn‚Äôt really tell us anything concrete about the rendering performance of the game. To analyze what‚Äôs going with rendering I used <a href="https://renderdoc.org/">Renderdoc</a>, an open source graphics debugger which has saved my bacon with <a href="https://blog.paavo.me/gpu-tilemap-rendering/">some of my previous GPU-y personal projects</a>.</p>
<h3 id="engine-and-architecture"><a href="#engine-and-architecture" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Engine and architecture</h3>
<p>Let‚Äôs go through some of the technical basics of the game. Cities: Skylines 2 uses <strong>Unity 2022.3.7</strong>, which is just a few months old at the time of writing. The most notable aspect of Unity 2022 was the stabilization of the <a href="https://unity.com/dots">DOTS</a> set of technologies which Unity has been working on for several years, and interestingly C:S2 seems to be largely built on top of this stuff, including the newfangled Entity Component System (ECS) implementation and Burst compiler. I‚Äôve been interested in <a href="https://bevyengine.org/learn/book/getting-started/ecs/">the ECS architecture</a> for a few years and have experimented with implementations such as <a href="https://github.com/amethyst/specs">Specs</a>, <a href="https://github.com/amethyst/legion">Legion</a> and most recently <a href="https://bevyengine.org/">Bevy</a>, and if it weren‚Äôt for the many issues in this game I‚Äôd rather be writing about how ECS is basically the ideal architecture for a game like this. Cities: Skylines 2 seems to use DOTS to great effect as the game makes use of multiple CPU cores much more efficiently than its predecessor. Unfortunately a lot of the graphics-related issues are indirectly caused by the game‚Äôs use of DOTS. I‚Äôll expand on that later.</p>
<figure>
  <img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_ecs.png" alt="A screenshot from dotPeek showing different ECS-related types from the game."/>
  <figcaption>Judging by the code there are about 1200 different systems powering practically all of the game logic.</figcaption>
</figure>
<p>The game also utilizes a bunch of third party middleware and some custom / forked libraries. Unlike DOTS, Unity‚Äôs <a href="https://unity.com/features/ui-toolkit">UI Toolkit</a> is apparently still not ready for production as C:S2 uses HTML, CSS and JavaScript based <a href="https://coherent-labs.com/products/coherent-gameface/">Coherent Gameface</a> (what a name!) for its user interfaces. A brief glance at the JS bundle reveals that they are using React and bundling using Webpack. While this is something that is guaranteed to make the average native development purist yell at clouds and complain that the darned kids should get off their lawn, I think at least on paper this will make the game‚Äôs UIs significantly easier to maintain and modify than before. Other notable bundled libraries include <a href="https://instalod.com/">InstaLOD</a>, <a href="https://odininspector.com/odin-serializer">Odin Serializer</a>, and a DLL file for NVidia DLSS 3, even though the technology is not currently supported by the game.</p>
<p>For graphics rendering the game makes use of Direct3D 11 and Unity‚Äôs <a href="https://unity.com/srp/High-Definition-Render-Pipeline">High Definition Rendering Pipeline</a>, also known as HDRP. Unity‚Äôs regular rendering system only works with traditional <code>MonoBehaviour</code>-based game objects, so a game built using DOTS &amp; ECS needs something to bridge the gap. Unity has a package called <a href="https://docs.unity3d.com/Packages/com.unity.entities.graphics@1.1/manual/index.html">Entities Graphics</a>, but surprisingly Cities: Skylines 2 doesn‚Äôt seem to use that. The reason might be its relative immaturity and its limited set of supported rendering features; according to the <a href="https://docs.unity3d.com/Packages/com.unity.entities.graphics@1.1/manual/entities-graphics-versions.html">feature matrix</a> both skinning (used for animated models like characters) and occlusion culling (not rendering things that are behind other things) are marked as experimental, and virtual texturing (making GPU texture handling more complex but hopefully more efficient) is not supported at all. Instead it seems that Colossal Order decided to implement the glue between the ECS and the renderer by themselves, utilizing <a href="https://docs.unity3d.com/ScriptReference/Rendering.BatchRendererGroup.html"><code>BatchRendererGroup</code></a> and a lot of relatively low level code. I‚Äôll cover this and its many implications in more detail later.</p>
<h3 id="attachment-issues"><a href="#attachment-issues" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Attachment issues</h3>
<p>Getting Renderdoc attached to a process and collecting rendering events is usually quite trivial. Normally you just need to provide Renderdoc the path of the executable, the working directory and some command line arguments, and then Renderdoc starts the binary and injects itself to the game process. However, my issue was that I had the game on Xbox Game Pass, which does some weird sandboxing and / or NTFS ownership magic to limit what you can do with the game files. Renderdoc was not allowed to read the game‚Äôs executable, even when running as administrator. Before I knew Game Pass was the problem I also tried to use <a href="https://developer.nvidia.com/nsight-graphics">NVidia Nsight Graphics</a>‚Ñ¢Ô∏è instead (a tool similar to Renderdoc from NVidia), but it had the same issue. Ultimately I ended up solving that particular problem with my credit card: I bought the game again on Steam at full price, despite knowing it had severe issues. Sorry.</p>
<p>However, the Steam version didn‚Äôt immediately start co-operating either. This time the problem was Paradox Launcher, a little piece of bloatware used in most big budget Paradox-published titles. The launcher binary is also included in the Game Pass version, but at least on release it seemed to be completely unused. Basically when you start C:S2 from Steam it pops up Paradox Launcher, you click either Resume or Play, and then it actually runs the game binary. I tried to attach Renderdoc by running <code>Cities2.exe</code> directly but that didn‚Äôt work ‚Äî it creates the game window, but then runs for a few seconds, opens the launcher and then exits. There is an option in Renderdoc called ‚ÄúCapture child processes‚Äù which should in theory make Renderdoc inject itself to all processes started by the target process ‚Äî so it should attach itself to the launcher started by the game binary, and then get injected to the game binary again ‚Äî but I think there was some extra layer of indirection which unfortunately prevented that from working. I configured Renderdoc to start Paradox Launcher directly, but in short that didn‚Äôt work either, as Steam and the launcher do some communication to select which game to start and to handle authentication / DRM thingies. Some of that communication happens through command line arguments which I was able to extract using <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/process-explorer">Process Explorer</a>, but reusing the same arguments didn‚Äôt work either, so I gave up on that approach as well.</p>
<p>Ultimately I was able to finally attach Renderdoc by using the <a href="https://renderdoc.org/docs/window/capture_attach.html#global-process-hook">Global Process Hook</a> option, which the program hides by default and advices against using. It is a very invasive method of hooking as it injects a DLL to every single process that is started on the system, but hey, it worked! We can finally see what‚Äôs going on.</p>
<figure>
<blockquote>
<p>This place is a message... and part of a system of messages... pay attention to it!
Sending this message was important to us. We considered ourselves to be a powerful culture.
This place is not a place of honor... no highly esteemed deed is commemorated here... nothing valued is here.</p>
</blockquote>
<figcaption>‚Äî Renderdoc when you try to enable global process hooking.</figcaption>
</figure>
<p>I was later able to get NVidia Nsight Graphics‚Ñ¢Ô∏è working as well. Instead of trying to start the game or the launcher, I opened Steam from Nsight and then started the game from Steam‚Äôs UI as usual. Ultimately I wasn‚Äôt able to get much more information out of Nsight than I already had from Renderdoc, as it seems that many of NSight‚Äôs profiling and performance focused features are not supported with D3D11.</p>
<h2 id="renderdoc-analysis"><a href="#renderdoc-analysis" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Renderdoc analysis</h2>
<p>I‚Äôll preface this section by admitting that I‚Äôm not a professional graphics programmer nor even a particularly proficient hobbyist. I do graphics programming occasionally and have spent quite a lot of time toying with game engines, but I‚Äôm not an expert on either subject. I have never implemented Actual Proper Graphics Things like deferred rendering or cascaded shadow mapping, though I think I know how they should work in theory. So as difficult it might be to believe, there is a chance that I‚Äôm wrong about some of the things I‚Äôm about to say. If you think I‚Äôm wrong, please let me know!</p>
<p>Let‚Äôs begin by analyzing the following frame (click to open it as a new tab):</p>
<p><img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_night.jpg" alt="A screenshot from Cities: Skylines 2 at night"/></p>
<p>This is a decently complex frame, but it‚Äôs far from the scale the game can actually reach. This was captured in a town of about 1000 inhabitants under an hour into a new save. There‚Äôs rain and it‚Äôs night time, but in my experience neither moves the needle much in terms of performance. The game version was <code>1.0.11f1</code>, so the first post-release hotfix is included. It should be noted that latest patch at the time of publication (<code>1.0.12f1</code>) was released during the making of this article and it includes some improvements for the issues I‚Äôm about to describe, but it‚Äôs far from having solved all of them.</p>
<p>Renderdoc reports that the frame took about 87.8 milliseconds to render, which would average to about 11.4 FPS. The game was running at 30-40 FPS on average at the time, so either this frame is an outlier (which ‚Äî as we‚Äôve learned <a href="https://youtu.be/l4DX6mUY78s?t=546">from the Gamers Nexus video</a> ‚Äî is ironically quite common) or perhaps more likely Renderdoc adds a bit of overhead in a way that affects the measurements, as all of the frames I‚Äôve captured have reported slightly higher frame times than what I‚Äôve seen in-game when playing normally. I‚Äôm making the assumption that even if Renderdoc does add some overhead, it adds it in a way that doesn‚Äôt completely invalidate the measurements, like making specific API calls take 10x longer than they normally would.</p>
<p>For reference, at consistent 60 FPS the frametime should always be about <code>1000 / 60 = 16.666...</code> milliseconds.</p>
<p>Here are some basic rendering statistics reported by Renderdoc:</p>
<pre><code><span>Draw calls: 6705
Dispatch calls: 191
API calls: 53361
Index/vertex bind calls: 8724
Constant bind calls: 25006
Sampler bind calls: 563
Resource bind calls: 13451
Shader set calls: 1252
Blend set calls: 330
Depth/stencil set calls: 301
Rasterization set calls: 576
Resource update calls: 1679
Output set calls: 739
API:Draw/Dispatch call ratio: 7.73796

342 Textures - 3926.25 MB (3924.10 MB over 32x32), 180 RTs - 2327.51 MB.
Avg. tex dimension: 1611.08x2212.36 (2133.47x2984.88 over 32x32)
4144 Buffers - 446.59 MB total 6.48 MB IBs 43.35 MB VBs.
6700.34 MB - Grand total GPU buffer + texture load.
</span></code></pre>
<p>There‚Äôs not much we can deduce from these figures alone. 6705 draw calls and over 50000 API calls both sound like a lot, but without further context their cost is hard to evaluate. 6.7 gigabytes of used video memory is a lot for a relatively simple scene like this, especially considering there are still current generation mid-tier graphics cards with only 8 gigabytes of VRAM.</p>
<p><img src="https://blog.paavo.me/cities-skylines-2-performance/renderdoc_events.png" alt="A screenshot from Renderdoc, showing API calls grouped by rendering pass."/></p>
<p>Since the game uses HDRP <a href="https://docs.unity3d.com/Packages/com.unity.render-pipelines.high-definition@17.0/manual/rendering-excecution-order.html">its documentation</a> might serve as a good starting point for understanding the different rendering and compute passes the game perform on each frame. I‚Äôm not going to do a fancy graphics study like these legendary ones for <a href="http://www.adriancourreges.com/blog/2016/09/09/doom-2016-graphics-study/">DOOM 2016</a> and <a href="http://www.adriancourreges.com/blog/2015/11/02/gta-v-graphics-study/">GTA V</a>, but I‚Äôll go through most of the rendering process step by step and highlight some of the more interesting things along the way.</p>
<h3 id="dots-instance-data-update"><a href="#dots-instance-data-update" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>DOTS instance data update</h3>
<p>Almost every draw call the game makes uses <a href="https://learnopengl.com/Advanced-OpenGL/Instancing">instancing</a>, which is required in a game of this scale. To make instancing work the game has a single large buffer of instance data which contains everything necessary for rendering any and all objects. The contents and size of per-instance data varies by the type of entity but it seems that regular game objects like buildings take about 50 floats per instance, roads significantly more. I haven‚Äôt fully figured out how the buffer is managed because it‚Äôs a very complex system, but essentially the instance data for every visible object is updated to the buffer each frame, and the changes are then uploaded to the GPU. The buffer starts at about 60 megabytes, and is reallocated to a larger size when necessary.</p>
<p>The buffer is used for practically every draw call the game makes, and according to Renderdoc it‚Äôs at least available in every vertex and pixel shader, though I would assume it‚Äôs primarily only used in vertex shaders. It would be interesting to know how this buffer affects GPU‚Äôs cache as I would assume instances are not laid out in the buffer in the same order they are rendered and that could be a problem for caching, but I lack the expertise to figure that out. Regardless there is a certain cost associated with looking up data from this buffer for every vertex, and it might explain some of the issues regarding high poly meshes I‚Äôll get to soon.</p>
<h3 id="simulation"><a href="#simulation" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Simulation</h3>
<p>Several compute shaders are used for graphics-related simulations, such as water, snow and particles, as well as skeletal animation. These take about 1.5 milliseconds in total, which is under 2% of frame time.</p>
<p>One early theory regarding the game‚Äôs poor performance was that maybe it was offloading a lot of the actual game simulation to the GPU, saving CPU time but taking processing power away from rendering. However, I can conclude based on both decompiled code and GPU calls that this is simply not the case.</p>
<h3 id="virtual-texturing-cache-update"><a href="#virtual-texturing-cache-update" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Virtual texturing cache update</h3>
<p>Remember how I mentioned that virtual texturing is not supported by Entities Graphics? Well, it seems that C:S2 implements its own virtual texturing / texture streaming system. I first assumed that the game is using <a href="https://unity.com/products/granite-sdk">Unity‚Äôs built-in solution</a> for that, but in traditional Unity fashion even though it was added to the engine in 2020 following an acquisition it remains as <a href="https://docs.unity3d.com/Manual/svt-streaming-virtual-texturing.html">experimental and unsupported</a> as ever (<a href="https://forum.unity.com/threads/feedback-wanted-streaming-virtual-texturing.849133/page-5#post-8371560">if not more so</a>).</p>
<p>What is virtual texturing, anyway? My understanding is that virtual texturing is an approach for loading and managing texture data in a potentially more memory efficient way than the m√©thode traditionnelle of using one GPU texture per texture asset. Textures are stored in texture atlases, which are basically fancier versions of sprite sheets (which I also happened to cover in my <a href="https://blog.paavo.me/gpu-tilemap-rendering/#shader-method-summarised-with-more-words-and-less-detail-than-the-original-article">GPU tile mapping article</a>). Atlases consist of tiles of a fixed size, and each tile can contain one or more textures. The trick which can save memory is that large textures can be split into multiple tiles, so if you have a large texture that is only visible in a small portion of the screen, you only need to load the tiles that are actually visible. Virtual texture visibility information is produced as a side product of normal rendering in a later pass, and the visibility information is used on the CPU side to determine which tiles need to be loaded and which can be unloaded. If you want to know more, <a href="https://docs.unrealengine.com/5.3/en-US/streaming-virtual-texturing-in-unreal-engine/">Unreal Engine‚Äôs documentation</a> seems to offer a great description of the technique in more detail. The game seems to use virtual texturing for all static 3D objects except the terrain.</p>
<figure>
  <img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_tiles.jpg" alt="A screenshot from Renderdoc, showing a virtual texture tile atlas."/>
  <figcaption>One of the tile atlases used in the rendering of my example frame. Massively downscaled; the original is 16368x8448.</figcaption>
</figure>
<p>This approach to texturing is quite elegant in theory but it comes with many tradeoffs, and the game‚Äôs implementation still has some teething issues, such as high resolution textures sometimes failing to load even when the surface is close to the camera. The use of virtual texturing is also likely the culprit for the game‚Äôs lack of support for <a href="https://www.pcgamingwiki.com/wiki/Glossary:Anisotropic_filtering_(AF)">anisotropic texture filtering</a>, a standard feature in PC games since the beginning of the millennium.</p>
<p>The pass took about 0.5 milliseconds.</p>
<h3 id="skybox-generation"><a href="#skybox-generation" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Skybox generation</h3>
<p>The game uses Unity HDRP‚Äôs <a href="https://docs.unity3d.com/Packages/com.unity.render-pipelines.high-definition@17.0/manual/create-a-physically-based-sky.html">built-in sky system</a>, so it generates a skybox texture (a <a href="https://en.wikipedia.org/wiki/Cube_mapping">cubemap</a>) every frame. This takes about 0.65 milliseconds which is not a lot compared to everything else, but if the game was targeting 60 FPS it would be almost 4% of the total frame time budget.</p>
<h3 id="pre-pass"><a href="#pre-pass" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Pre-pass</h3>
<p><img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_prepass.jpg" alt="A screenshot from Renderdoc, showing the normal/roughness buffer of my example frame."/></p>
<p>Now we get to the actual rendering. C:S2 uses <a href="https://learnopengl.com/Advanced-Lighting/Deferred-Shading">deferred rendering</a>, which basically means that rendering is done in many phases and using several different intermediate render targets. The first phase is the pre-pass, which produces per-pixel depth, normal and (presumably) smoothness information into two separate textures.</p>
<p>This pass is surprisingly heavy as it takes about 8.2 milliseconds, or roughly about far too long, and this is where some of the biggest issues with the game‚Äôs rendering start to appear. But first we need to talk about <strong>THE TEETH</strong>.</p>
<h3 id="the-teeth-controversy"><a href="#the-teeth-controversy" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>The teeth controversy</h3>
<p><img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_mouth.png" alt="A screenshot from Renderdoc, showing a simply shaded mesh of a character‚Äôs mouth."/></p>
<p>One bizarre yet popular talking point about Cities: Skylines 2‚Äôs performance is the fact that the character models have fully modelled teeth, even though there‚Äôs literally no way to see them in-game, unless we count using the photo mode and clipping the camera inside a character‚Äôs head. Reddit user Hexcoder0 did some digging using NVidia Nsight Graphics‚Ñ¢Ô∏è and posted their findings in to <a href="https://www.reddit.com/r/CitiesSkylines/comments/17gfq13/the_game_does_render_individual_teeth_with_no_lod/">a thread</a> in the official subreddit (which inspired me to do my own research and write this pointlessly long article). It was revealed that not only does the game have fully modelled teeth, they are rendered <em>literally all the time</em> at maximum quality. More importantly this is the case for everything related to characters: none of the character meshes have any <a href="https://en.wikipedia.org/wiki/Level_of_detail_(computer_graphics)">LOD</a> variants. Colossal Order <a href="https://www.pcgamer.com/cities-skyline-2-dev-says-yes-our-characters-have-teeth-no-the-characters-teeth-are-not-affecting-performance/">was quick</a> to acknowledge this publicly, and they even referenced broader problems with LOD handling. Ignore all the weird rambling about simulating citizens‚Äôs teeth and whatnot; this is not <a href="https://www.pcgamer.com/how-cats-get-drunk-in-dwarf-fortress-and-why-its-creators-havent-figured-out-time-travel-yet/">Dwarf Fortress</a> so they are not doing that, and even if they were that obviously wouldn‚Äôt require rendering the teeth.</p>
<p>Colossal Order has also <a href="https://forum.paradoxplaza.com/forum/developer-diary/behind-the-scenes-5-citizen-characters.1602554/">told us that</a> that they are using a middleware called <a href="https://www.didimo.co/">Didimo Popul8</a> to generate the character models. If I recall correctly the teeth controversy began even before the game was released when someone noticed that the Didimo <a href="https://developer.didimo.co/docs/mesh">character specification</a> includes separate meshes for things like teeth and eyelashes. I had originally assumed that the game is using Didimo‚Äôs default character meshes ‚Äî because to be honest they look very generic and soulless ‚Äî but now I‚Äôm not so sure. The meshes in the game in fact have even more polygons than Didimo‚Äôs defaults: the infamous mouth / teeth model for example consists of 6108 vertices, significantly more than the default mesh‚Äôs 1060. A single character <em>even before we add hair, clothing and accessories</em> is about 56 thousand vertices, which is a lot. For context the average low-density residential building uses less than 10 thousand vertices before yard props and other details are added.</p>
<p>In this example frame the game renders 13 sets of teeth, and their visual impact on the frame is zero: not a single pixel is affected. Even the characters themselves contribute basically nothing to the frame except for noise and artifacts.</p>
<figure>
  <img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_citizen.png" alt="A screenshot from Renderdoc highlighting the impact a single charater has on the final image."/>
  <figcaption>At this distance and rendering resolution an individual character (the purple Tetris block) affects a literal handful of pixels. Scaled 4x to make the individual pixels visible.</figcaption>
</figure>
<h3 id="pre-pass-continued-featuring-the-high-poly-hall-of-shame"><a href="#pre-pass-continued-featuring-the-high-poly-hall-of-shame" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Pre-pass continued, featuring the high poly hall of shame</h3>
<p>The egregiously unoptimized character models are not the sole cause of the game‚Äôs poor performance (because it‚Äôs never that easy), but they are an indicator of the broader issues with the game‚Äôs assets and rendering. The game regularly draws too many objects with too many polygons that have quite literally zero impact on the final image. This is not specific to the pre-pass, as the same issues seem to affect all rendering passes which rasterize geometry. I think there are two main causes for this:</p>
<ol>
<li>Some models don‚Äôt have any LOD variants at all.</li>
<li>The game‚Äôs culling system is not very advanced; the custom rendering code only implements frustum culling and there‚Äôs no sign of occlusion culling at all. There is some culling based on distance but it‚Äôs not very aggressive, which is great for avoiding pop-in but bad for performance.</li>
</ol>
<p>Here are a few other examples besides the character models.</p>
<figure>
    <p><img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_gastank_frame.png" alt="The pixels affected by a pallet of gas tanks"/>
<img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_gastank_mesh.png" alt="The gas tank pallet mesh"/>
    </p>
    
    <figcaption>This highly detailed pallet of gas tanks consists of over 17K vertices.</figcaption>
    
</figure>
<figure>
    <p><img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_clotheslines_frame.png" alt="The pixels affected by several instances of a clotheslines mesh"/>
<img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_clotheslines_mesh.png" alt="The clotheslines mesh"/>
<img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_clotheslines_clothespins.png" alt="Closeup of the clotheslines mesh"/>
<img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_clotheslines_mesh2.png" alt="An alternative clotheslines mesh"/>
    </p>
    
    <figcaption>These densely packed clotheslines are made from 25K vertices per piece and feature dozens of individually modelled clothespins, or <em>laundry boys</em> as we call them in Finland. There‚Äôs also an even more dense variant featuring over 30K vertices.</figcaption>
    
</figure>
<figure>
    <p><img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_parkingbooth_mesh1.png" alt="The parking booth mesh"/>
<img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_parkingbooth_mesh2.png" alt="The parking booth mesh"/>
<img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_parkingbooth_mesh3.png" alt="The parking booth mesh"/>
    </p>
    
    <figcaption>This parking booth mesh is technically not used in my example frame‚Äôs pre-pass, but it is still present in the scene and later used in the shadow mapping pass. This mesh consists of over 40K vertices with no LODs, and features luxurious details you don‚Äôt even get in most AAA games, like individually modelled cables connecting screens and keyboards. They are even routed through a (relatively round) hole in the desk! Combining the building and the furniture into one mesh saves on draw calls, but it also means that the props can‚Äôt be culled individually.</figcaption>
    
</figure>
<figure>
  <img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_logs_mesh.png" alt="A pile of logs"/>
  <figcaption>This mesh of a pile of logs is similarly only used in the shadow rendering pass, and features <strong>over 100K</strong> vertices. It is the highest poly model in the game I‚Äôve encountered so far, though I haven‚Äôt played for more than a few hours.</figcaption>
</figure>
<p>Now you might say that these are just cherry-picked examples, and that modern hardware handles models like these just fine. And you would be broadly correct in that, but the problem is that all of these relatively small costs start to add up, especially in a city builder where one unoptimized model might get rendered a few hundred times in a single frame. Rasterizing tens of thousands of polygons per instance per frame and literally not affecting a single pixel is just wasteful, whether or not the hardware can handle it. The issues are luckily quite easy to fix, both by creating more LOD variants and by improving the culling system. It will take some time though, and it remains to be seen if CO and Paradox want to invest that time, especially if it involves going through most of the game‚Äôs assets and fixing them one by one.</p>
<p>To be clear having highly detailed models is not a problem in itself, especially if you are intending to make a self-proclaimed next generation city builder. The problem is that the game is struggling to handle this level of detail, and that polygons are used inefficiently and inconsistently. For every character model with opulently modelled nostril hairs there are common props with surprisingly low polycounts. I think if the game ran well people would be celebrating these highly detailed models and making hyperbolic social media posts and clickbait videos titled ‚ÄúOMG the devs thought of EVERYTHING ü§Øü§Øü§Ø‚Äù and ‚ÄúI can‚Äôt believe they modelled the cables in the parking booth üò±üò±üò±‚Äù and ‚ÄúCITY SKYLINES 2 MOST DETAILED GAME EVER CONFIRMED?‚Äù. Instead we are here.</p>
<p>Oh yeah I was talking about rendering at some point, wasn‚Äôt I? Let‚Äôs continue.</p>
<h3 id="motion-vectors"><a href="#motion-vectors" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Motion vectors</h3>
<p>The game renders per-pixel motion vectors as a separate pass, which can be used for anti-aliasing and motion blur. I think motion vectors are slightly broken now, which is also the reason the game doesn‚Äôt support DLSS or FSR2 at the time of writing. There is a temporal anti-aliasing option hidden in the advanced settings menu and it improves the rendering quality to some extent, but things animated using vertex shaders like trees are just covered in artifacts and ghosting.</p>
<p>This pass takes about 0.6 milliseconds.</p>
<h3 id="roads-and-decals"><a href="#roads-and-decals" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Roads and decals</h3>
<p><img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_lawn.jpg" alt="The decal buffer of my example frame."/></p>
<p><img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_lawn_closeup.png" alt="A closeup of the decal buffer."/></p>
<p>Now we are finally rendering something recognizable: roads! And lawns, and other things that follow the surface of the terrain.</p>
<p>This pass takes about 1 millisecond.</p>
<h3 id="main-pass"><a href="#main-pass" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Main pass</h3>
<p><img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_main_pass.jpg" alt="The albedo buffer of the main pass."/></p>
<p><img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_main_pass_closeup.png" alt="A closeup of the albedo buffer."/></p>
<p><img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_main_pass_normal.jpg" alt="The normal buffer of the main pass."/></p>
<p>This is the meat (vegan alternatives are available) of the deferred rendering process. This pass takes in all the intermediate render targets produced so far alongside the virtual texture caches and some seemingly hardcoded textures and produces several more buffers, including ones for albedo, normals, different PBR properties and depth. It also produces the virtual texture visibility information I mentioned earlier. It is rendered at half horizontal resolution, presumably as an optimization. Terrain doesn‚Äôt use virtual texturing, so it is rendered at full resolution and with a constant color regardless of the actual terrain texture.</p>
<p><img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_vt_feedback.png" alt="The virtual texture visibility buffer."/></p>
<p>This pass takes 16.7 milliseconds, or about as long the entire frame should take if we were aiming for 60 frames per second. The pass rasterizes all of the geometry again, so the same reasons for the pre-pass being slow apply here as well. The additional cost is probably explained by the number of additional outputs, plus the cost of virtual texture cache lookups and texture mapping itself.</p>
<h3 id="ambient-occlusion"><a href="#ambient-occlusion" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Ambient occlusion</h3>
<p>Next the game produces an ambient occlusion buffer using motion vectors, normals and the depth buffer plus copies of the last two from the previous frame. Judging by the debug names of the shaders the algorithm is <a href="https://www.activision.com/cdn/research/Practical_Real_Time_Strategies_for_Accurate_Indirect_Occlusion_NEW%20VERSION_COLOR.pdf">GTAO</a>. This takes about 1.6 milliseconds.</p>
<h3 id="cascaded-shadow-mapping"><a href="#cascaded-shadow-mapping" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Cascaded shadow mapping</h3>
<p><img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_shadowmap.jpg" alt="The shadow map buffer."/></p>
<p>C:S2 uses <a href="https://learn.microsoft.com/en-us/windows/win32/dxtecharts/cascaded-shadow-maps">cascaded shadow mapping</a>, and in my opinion not very well. Shadows are full of artifacts and constantly flickering especially when either the sun or any foliage are moving (and they are, all of the time). Even when the screen isn‚Äôt completely covered with artifacts, the resolution of the shadows is quite low, and the jump in quality between the different shadow cascades is very noticeable.</p>
<p>The game uses four cascades with a resolution of 2048x2048 pixels per cascade. There‚Äôs a directional shadow map resolution setting in the advanced graphics settings menu, but at the time of writing it‚Äôs not connected to anything in the code; neither the individual setting nor the overall shadow quality setting alters the resolution of the shadow map. This is the reason why the medium and the high shadow setting presets are literally identical. I don‚Äôt know whether this is an oversight or if the setting was hastily disabled because it was causing issues. The low preset differs from medium and high in that it disables shadows cast by the terrain.</p>
<p>Despite the low quality, it is by far the slowest rendering pass, taking about 40 milliseconds or almost half of total frametime. It also dwarfs all other passes in terms of the number of draw calls: in my test frame 4828 out of 6705 draw calls were for shadow mapping, a staggering 72%. This is why there‚Äôs such a huge performance gain when shadows are disabled.</p>
<p>The reasons behind this pass‚Äôs slowness are mostly the same as with the pre-pass and the main pass: too much unnecessary geometry rendered with way too many draw calls. Renderdoc‚Äôs performance counters view indicates that many of the draw calls affect between zero and under 100 pixels in the shadow map, and the teeth are back again. The game seems to treat every single 3D object as a potential shadow caster on all quality settings regardless of size or distance. There‚Äôs a lot of room for optimization here, and in theory general improvements to LODs and culling should have a large impact on shadow mapping performance as well. Hopefully after performance has been improved CO (or modders) can turn the shadow quality setting back up, and raise the shadow map resolution to something more 2023.</p>
<p>Let‚Äôs end this part on a positive side note: when digging into shadow handling code I stumbled upon the fact that the game computes the positions of the sun and the moon using the current date, time and coordinates of the city. That‚Äôs a really neat detail!</p>
<h3 id="screen-space-reflections-and-global-illumination"><a href="#screen-space-reflections-and-global-illumination" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Screen space reflections and global illumination</h3>
<p><img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_ssr.jpg" alt="The screen space reflection buffer."/></p>
<p><img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_gi_buffer.jpg" alt="The screen space global illumination buffer."/></p>
<p>The game uses Unity HDRP‚Äôs built-in implementations of <a href="https://docs.unity3d.com/Packages/com.unity.render-pipelines.high-definition@17.0/manual/Override-Screen-Space-Reflection.html">screen space reflections</a> (SSR) and <a href="https://docs.unity3d.com/Packages/com.unity.render-pipelines.high-definition@17.0/manual/Override-Screen-Space-GI.html">screen space global illumination</a> (SSGI). I won‚Äôt be covering them in detail because Unity‚Äôs documentation is already decently comprehensive, plus I‚Äôm not going to pretend I fully understand them. Global illumination uses ray-marching and is evaluated by default at half resolution. Denoising and temporal accumulation are used to improve the quality. It would be nice if the game as a self-proclaimed next generation city builder supported hardware accelerated ray tracing in addition to these screen space solutions, but I‚Äôm not holding my breath.</p>
<p>These two effects combined took about 3 milliseconds.</p>
<h3 id="deferred-lighting"><a href="#deferred-lighting" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Deferred lighting</h3>
<p><img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_lit.jpg" alt="The results of deferred lighting"/></p>
<p>This is where it all comes together. Most of the intermediate buffers produced so far are combined to render the near-final image. Not much more to say about this pass, except that it takes about 2.1 milliseconds.</p>
<h3 id="weird-clothing-pass"><a href="#weird-clothing-pass" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Weird clothing pass</h3>
<p>There‚Äôs a small rendering pass just for the clothes of the Didimo characters, in this case 3 dresses, 1 jumpsuit and 1 set of suit trousers. The remaining 8 characters are either naked or their clothes use different shaders. This pass affects almost no pixels at this zoom level. Luckily it takes just 0.2 milliseconds.</p>
<h3 id="sky-rendering"><a href="#sky-rendering" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Sky rendering</h3>
<p>The sky is rendered next using the previously generated skybox texture, though it is not visible in my example frame. This pass takes about 0.3 milliseconds.</p>
<h3 id="transparent-objects-pre-pass"><a href="#transparent-objects-pre-pass" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Transparent objects pre-pass</h3>
<p>Traditional deferred rendering doesn‚Äôt work with transparent objects, so they are rendered separately. Transparent objects are rendered in two phases, starting with this pre-pass which only updates the normal and depth buffers. There are not many unique transparent objects in the frame, so this pass takes about 0.12 milliseconds.</p>
<h3 id="water-rendering"><a href="#water-rendering" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Water rendering</h3>
<p>The game does some pre-processing in compute shaders to prepare for water rendering and then produces several downscaled and blurred versions of the almost-final image. These inputs are fed to the main water rendering shader which renders the water surface. This takes about 1 millisecond.</p>
<h3 id="particles-rain-and-transparent-objects"><a href="#particles-rain-and-transparent-objects" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Particles, rain and transparent objects</h3>
<p>This pass handles most things transparent, including particles, weather effects and 3D objects made of glass and other transparent materials. No particles are visible in the frame, but the game still tries to render the smoke from the industrial zone‚Äôs chimneys, as well as the stream of goop produced by the sewage pipe. Rain is rendered next, using 20 instances of 12K vertices each. Interestingly the remaining transparent objects are rendered after the rain, causing some weirdness when transparent objects (like greenhouses and power lines) and rain overlap. All of this takes about 0.56 milliseconds.</p>
<h3 id="vt-feedback-processing"><a href="#vt-feedback-processing" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>VT feedback processing</h3>
<p><img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_vt_feedback_2.png" alt="The virtual texture feedback buffer."/></p>
<p>The virtual texture visibility buffer we got earlier is processed with a compute shader, resulting in an output texture 1/16th of the original resolution. For the visualization I nearest neighbor scaled the output 8x to make it more readable. This is the information the game ultimately gets back from the GPU to decide which texture tiles to load and unload. Renderdoc reported very little time spent on this, well under 0.1 milliseconds.</p>
<h3 id="bunch-of-post-processing"><a href="#bunch-of-post-processing" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Bunch of post-processing</h3>
<p>The game uses many of Unity‚Äôs built-in post-processing effects, including temporal AA (which is a bit broken as I previously mentioned), bloom and tonemapping, plus DOF and motion blur if enabled. I can‚Äôt be bothered to sum up the timings of all of these, but it‚Äôs about 1 to 2 milliseconds in total.</p>
<h3 id="outlines-text-and-other-ui"><a href="#outlines-text-and-other-ui" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Outlines, text and other UI</h3>
<p><img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_sdf_text.png" alt="Road names are rendered using SDF"/></p>
<p>The last remaining draw calls are used to render all of the different UI elements, both the ones that are drawn into the world as well as the more traditional UI elements like the bottom bar and other controls. Quite a lot of draw calls are used for the Gameface-powered UI elements, though ultimately these calls are very fast compared to the rest of the rendering process. The names of roads are rendered into the scene using 2D <a href="https://libgdx.com/wiki/graphics/2d/fonts/distance-field-fonts">signed distance fields</a>. The depth buffer is used to blend the text with the scene if the text is behind a building or other object, which is a nice touch. This final pass takes an irrelevant amount of time.</p>
<p>And we are done!</p>
<p><img src="https://blog.paavo.me/cities-skylines-2-performance/cs2_night.jpg" alt="A screenshot from Cities: Skylines 2 at night"/></p>
<p>I tried not to make this into an in-depth graphics study, but I think I failed. Hope you learned something new.</p>
<h2 id="summary-and-conclusions"><a href="#summary-and-conclusions" role="presentation" title="Link to subsection">
  <img src="https://blog.paavo.me/svg/anchor.svg" aria-hidden="true"/>
</a>Summary and conclusions</h2>
<p>So why is Cities: Skylines 2 so incredibly heavy on the GPU? The short answer is that the game is throwing so much unnecessary geometry at the graphics card that the game manages to be largely limited by the available rasterization performance. The cause for unnecessary geometry is both the lack of simplified LOD variants for many of the game‚Äôs meshes, as well as the simplistic and seemingly untuned culling implementation. And the reason why the game has its own culling implementation instead of using Unity‚Äôs built in solution (which should at least in theory be much more advanced) is because Colossal Order had to implement quite a lot of the graphics side themselves because Unity‚Äôs integration between DOTS and HDRP is still very much a work in progress and arguably unsuitable for most actual games. Similarly Unity‚Äôs virtual texturing solution remains eternally in beta, so CO had to implement their own solution for that too, which still has some teething issues.</p>
<p>Here‚Äôs what I think that happened (a.k.a this is speculation): Colossal Order took a gamble on Unity‚Äôs new and shiny tech, and in some ways it paid off massively and in others it caused them a lot of headache. This is not a rare situation in software development and is something I‚Äôve experienced myself as well in my dayjob as a web-leaning developer. They chose DOTS as the architecture to fix the CPU bottlenecks their previous game suffered from and to increase the scale &amp; depth of the simulation, and largely succeeded on that front. CO started the game when DOTS was still experimental, and it probably came as a surprise how much they had to implement themselves even when DOTS was officially considered production ready. I wouldn‚Äôt be surprised if they started the game with Entities Graphics but then had to pivot to custom solutions for culling, skeletal animation, texture streaming and so on when they realized Unity‚Äôs official solution was not going to cut it. Ultimately the game had to be released too early when these systems were still unpolished, likely due to financial and / or publisher pressure. None of these technical issues were news for the developers on release day, and I don‚Äôt believe their claim that the game was intended to target 30 FPS from the beginning ‚Äî no purebred PC game has done that since the early 2000s, and the graphical fidelity doesn‚Äôt justify it.</p>
<p>While I did find a lot to complain about the game‚Äôs technology, this little investigation which has been consuming a large share of my free time for the past 1.5 weeks has also made me appreciate the game‚Äôs lofty goals and sympathize more with the developers of this technically ambitious yet troubled game. I‚Äôve learned a lot about how Cities: Skylines 2 &amp; Unity HDRP work under the hood, and I‚Äôve also gotten some good practice with Renderdoc.</p>
<p>If you liked this article, good for you! I don‚Äôt have anything to sell you. Write a comment or something to the media aggregator or social media of your choice. Subscribe to my Atom feed if it still works. Stay tuned for my next article in a couple of years.</p>

</article>


  </div></div>
  </body>
</html>
