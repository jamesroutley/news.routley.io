<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://kevinlynagh.com/z3-simpsons-paradox/">Original</a>
    <h1>Generating Simpson&#39;s Paradox with Z3</h1>
    
    <div id="readability-page-1" class="page"><div><p><a href="https://kevinlynagh.com/">← Back to Kevin&#39;s homepage</a><span>Published: 2024 August 11</span><span>Last updated: 2024 August 12</span></p><p>I’ve been reading Pearl’s <a href="https://amzn.to/3M0TwON">Causal Inference in Statistics</a>, and one of the exercises poses this problem:</p>

<blockquote>
<p>Baseball batter A has a better batting average than his teammate B. However, someone notices that B has a better batting average than A against both right-handed and left-handed pitchers. How can this happen?</p>
</blockquote>

<p>The <a href="https://github.com/Z3Prover/z3">Z3 Theorem Prover</a> is a great lil’ tool for solving these sorts of problems.
The following generates an example of this situation, which is more commonly known as <a href="https://en.wikipedia.org/wiki/Simpson%27s_paradox">Simpson’s Paradox</a>.
(See also <a href="https://robertheaton.com/2019/02/24/making-peace-with-simpsons-paradox/">this great explanation</a> from Robert Heaton, which I found via the <a href="https://news.ycombinator.com/item?id=41219562">HN comments</a> about the page you’re currently reading.)</p>
<div><pre><span></span>;; Player A&#39;s hits and misses against left-handed pitchers
(declare-const A_L_hits Int)
(declare-const A_L_misses Int)

;; and right-handed ones.
(declare-const A_R_hits Int)
(declare-const A_R_misses Int)

;; ditto for player B
(declare-const B_L_hits Int)
(declare-const B_L_misses Int)
(declare-const B_R_hits Int)
(declare-const B_R_misses Int)

;; All hits and miss counts must be positive
(assert (&lt; 0 A_L_hits))
(assert (&lt; 0 A_L_misses))
(assert (&lt; 0 A_R_hits))
(assert (&lt; 0 A_R_misses))
(assert (&lt; 0 B_L_hits))
(assert (&lt; 0 B_L_misses))
(assert (&lt; 0 B_R_hits))
(assert (&lt; 0 B_R_misses))

;; overall batting averages
(define-const A Real
  (/ (+ A_L_hits A_R_hits)
     (+ A_L_hits A_R_hits A_L_misses A_R_misses)))
(define-const B Real
  (/ (+ B_L_hits B_R_hits)
     (+ B_L_hits B_R_hits B_L_misses B_R_misses)))

;; batting averages against left and right-handed pitches
(define-const A_L Real
  (/ A_L_hits (+ A_L_hits A_L_misses)))
(define-const A_R Real
  (/ A_R_hits (+ A_R_hits A_R_misses)))
(define-const B_L Real
  (/ B_L_hits (+ B_L_hits B_L_misses)))
(define-const B_R Real
  (/ B_R_hits (+ B_R_hits B_R_misses)))

;; A has a higher overall batting average
(assert (&lt; B A))

;; B has a better average against left-handed pitchers
(assert (&lt; A_L B_L))

;; B has a better average against right-handed pitchers
(assert (&lt; A_R B_R))

(set-option :pp.decimal true)
(check-sat)
(get-model)
(get-value (A A_L A_R A_L_hits A_L_misses A_R_hits A_R_misses))
(get-value (B B_L B_R B_L_hits B_L_misses B_R_hits B_R_misses))
</pre></div>
<p>Running Z3 against this file generates this output, showing an example satisyfing our constraints:</p>
<div><pre><span></span>((A 0.2352941176?)
 (A_L 0.4)
 (A_R 0.1666666666?)
 (A_L_hits 2)
 (A_L_misses 3)
 (A_R_hits 2)
 (A_R_misses 10))

((B 0.2307692307?)
 (B_L 0.5)
 (B_R 0.1818181818?)
 (B_L_hits 1)
 (B_L_misses 1)
 (B_R_hits 2)
 (B_R_misses 9))
</pre></div>
<p>The batting avergaes in tabular form:</p>

<table><thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead><tbody>
<tr>
<td>Player</td>
<td>Left</td>
<td>Right</td>
<td>Overall</td>
</tr>
<tr>
<td>A</td>
<td>0.4</td>
<td>0.167</td>
<td>0.235</td>
</tr>
<tr>
<td>B</td>
<td>0.5</td>
<td>0.182</td>
<td>0.230</td>
</tr>
</tbody></table>

<p>The key to understanding the paradox is that the players did not bat against the same set of pitchers. Player A batted against 5 lefties and 12 righties; B against 2 and 11.</p>
</div></div>
  </body>
</html>
