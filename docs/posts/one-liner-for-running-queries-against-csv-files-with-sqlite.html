<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://til.simonwillison.net/sqlite/one-line-csv-operations">Original</a>
    <h1>One-liner for running queries against CSV files with SQLite</h1>
    
    <div id="readability-page-1" class="page"><section>



<p>I figured out how to run a SQL query directly against a CSV file using the <code>sqlite3</code> command-line utility:</p>
<pre><code>sqlite3 :memory: -cmd &#39;.mode csv&#39; -cmd &#39;.import taxi.csv taxi&#39; \
  &#39;SELECT passenger_count, COUNT(*), AVG(total_amount) FROM taxi GROUP BY passenger_count&#39;
</code></pre>
<p>This uses the special <code>:memory:</code> filename to open an in-memory database. Then it uses two <code>-cmd</code> options to turn on CSV mode and import the <code>taxi.csv</code> file into a table called <code>taxi</code>. Then it runs the SQL query.</p>
<p>You can get <code>taxi.csv</code> by downloading the compressed file from <a href="https://github.com/multiprocessio/dsq/blob/43e72ff1d2c871082fed0ae401dd59e2ff9f6cfe/testdata/taxi.csv.7z">here</a> and running:</p>
<pre><code>7z e -aos taxi.csv.7z
</code></pre>
<p>I figured this out while commenting on <a href="https://github.com/multiprocessio/dsq/issues/70">this issue</a>.</p>
<p>The output looks like this:</p>
<pre><code>&#34;&#34;,128020,32.2371511482553
0,42228,17.0214016766151
1,1533197,17.6418833067999
2,286461,18.0975870711456
3,72852,17.9153958710923
4,25510,18.452774990196
5,50291,17.2709248175672
6,32623,17.6002964166367
7,2,87.17
8,2,95.705
9,1,113.6
</code></pre>
<p>Add <code>-cmd &#39;.mode column&#39;</code> to output in columns instead:</p>
<pre><code>$ sqlite3 :memory: -cmd &#39;.mode csv&#39; -cmd &#39;.import taxi.csv taxi&#39; -cmd &#39;.mode column&#39; \
    &#39;SELECT passenger_count, COUNT(*), AVG(total_amount) FROM taxi GROUP BY passenger_count&#39;
passenger_count  COUNT(*)  AVG(total_amount)
---------------  --------  -----------------
                 128020    32.2371511482553 
0                42228     17.0214016766151 
1                1533197   17.6418833067999 
2                286461    18.0975870711456 
3                72852     17.9153958710923 
4                25510     18.452774990196  
5                50291     17.2709248175672 
6                32623     17.6002964166367 
7                2         87.17            
8                2         95.705           
9                1         113.6            
</code></pre>
<p>Or use <code>-cmd &#39;.mode markdown&#39;</code> to get a Markdown table:</p>
<table>
<thead>
<tr>
<th>passenger_count</th>
<th>COUNT(*)</th>
<th>AVG(total_amount)</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>128020</td>
<td>32.2371511482553</td>
</tr>
<tr>
<td>0</td>
<td>42228</td>
<td>17.0214016766151</td>
</tr>
<tr>
<td>1</td>
<td>1533197</td>
<td>17.6418833067999</td>
</tr>
<tr>
<td>2</td>
<td>286461</td>
<td>18.0975870711456</td>
</tr>
<tr>
<td>3</td>
<td>72852</td>
<td>17.9153958710923</td>
</tr>
<tr>
<td>4</td>
<td>25510</td>
<td>18.452774990196</td>
</tr>
<tr>
<td>5</td>
<td>50291</td>
<td>17.2709248175672</td>
</tr>
<tr>
<td>6</td>
<td>32623</td>
<td>17.6002964166367</td>
</tr>
<tr>
<td>7</td>
<td>2</td>
<td>87.17</td>
</tr>
<tr>
<td>8</td>
<td>2</td>
<td>95.705</td>
</tr>
<tr>
<td>9</td>
<td>1</td>
<td>113.6</td>
</tr>
</tbody>
</table>
<p>A full list of output modes can be seen like this:</p>
<pre><code>% sqlite3 -cmd &#39;.help mode&#39;
.mode MODE ?TABLE?       Set output mode
   MODE is one of:
     ascii     Columns/rows delimited by 0x1F and 0x1E
     box       Tables using unicode box-drawing characters
     csv       Comma-separated values
     column    Output in columns.  (See .width)
     html      HTML &lt;table&gt; code
     insert    SQL insert statements for TABLE
     json      Results in a JSON array
     line      One value per line
     list      Values delimited by &#34;|&#34;
     markdown  Markdown table format
     quote     Escape answers as for SQL
     table     ASCII-art table
     tabs      Tab-separated values
     tcl       TCL list elements
</code></pre>
<h2>
<a id="user-content-other-options" href="#other-options" aria-hidden="true"><span aria-hidden="true"></span></a>Other options</h2>
<p>There are a whole bunch of other tools that can be used for this kind of thing!</p>
<p>My own <a href="https://simonwillison.net/2021/Jun/19/sqlite-utils-memory/" rel="nofollow">sqlite-utils memory</a> command can load data from JSON, CSV or TSV into an in-memory database and run a query against it. It&#39;s a LOT slower than using <code>sqlite3</code> directly though.</p>
<p><a href="https://github.com/multiprocessio/dsq">dsq</a> is a tool that does this kind of thing (and a lot more). Author Phil Eaton compiled <a href="https://github.com/multiprocessio/dsq#benchmark">a collection of benchmarks</a> of other similar tools, and his <a href="https://github.com/multiprocessio/dsq/blob/43e72ff1d2c871082fed0ae401dd59e2ff9f6cfe/scripts/benchmark.sh">benchmarking script</a> demonstrates how to use each one of them.</p>


<p>Created 2022-06-20T16:00:51-07:00, updated 2022-06-20T19:06:35-07:00 · <a href="https://github.com/simonw/til/commits/main/sqlite/one-line-csv-operations.md">History</a> · <a href="https://github.com/simonw/til/blob/main/sqlite/one-line-csv-operations.md">Edit</a></p>

</section></div>
  </body>
</html>
