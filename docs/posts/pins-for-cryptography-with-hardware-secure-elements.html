<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://words.filippo.io/dispatches/secure-elements/">Original</a>
    <h1>PINs for Cryptography with Hardware Secure Elements</h1>
    
    <div id="readability-page-1" class="page"><article>
        <span>
            <time datetime="2024-02-14">14 Feb 2024</time>
        </span>
        
        <section>
            <p>I’m a big fan of technologies that enable otherwise impossible security properties and user experiences, like cryptography often can. One such technology is hardware secure elements.</p>
<p>Here’s a thing you can’t do with cryptography: encrypt data securely with a low-entropy secret, like a PIN. If a high-speed brute-force attack is possible, you need a high-entropy passphrase or key. We do have <a href="https://en.wikipedia.org/wiki/Key_stretching?ref=words.filippo.io">password stretching</a> algorithms like scrypt and Argon2 which make brute-force attacks slower and force them to target one victim at a time (through salting), but if your secret is small enough—like a 6-digit PIN—you’re just <a href="https://xkcd.com/1133/?ref=words.filippo.io">not going to space today</a>. Even if you’re ok with decryption on the user’s device taking five seconds, and assuming conservatively that an attacker’s system is only ten times more powerful than the user’s device, <a href="https://www.wolframalpha.com/input?key=&amp;i=5s+*+10%5E6+%2F+10&amp;ref=words.filippo.io">a 6-digit PIN will fall in less than a week</a>. But PINs provide such a better UX than long, high-entropy passwords (even if we pretended humans can generate and produce the latter)!</p>
<p>This is a conundrum you can solve with hardware secure elements. You put a high-entropy randomly generated cryptographic key inside some secure tamper-resistant computer, and then you program it to ever only give out the key if presented with the right PIN. Since you have arbitrary software running on that computer, you can implement things like maximum incorrect retries counters, exponential retry cooling timers, self-destruction… You’re not bound by the capabilities of cryptography and information theory anymore. This is easier said than done (the key might be extracted through side-channels, the secure computer might get hacked, and so on) but it’s also not at all a new idea. This is what smart cards and Hardware Security Modules have always been about.</p>
<p>This is for example how I use my <a href="https://www.yubico.com/products/yubikey-5-overview/?ref=words.filippo.io">Yubikey</a>, a smart card in a USB form factor: I encrypt my passwords with <a href="https://github.com/FiloSottile/passage?ref=words.filippo.io">passage</a> and <a href="https://github.com/str4d/age-plugin-yubikey?ref=words.filippo.io">age-plugin-yubikey</a>, which stores the cryptographic key PIN-protected on the YubiKey. My PIN would be laughable as an encryption secret, but you only get six tries to figure it out before the YubiKey permanently locks.</p>
<p>Although smart cards have been around forever, the technology was heavily popularized by the introduction of secure elements in mobile devices. Every iPhone has a hardware secure element called the Secure Enclave that stores the encryption key for the internal flash storage, and only produces it when provided with the PIN. It’s why locked iPhones are so hard to unlock even if the PIN is just six digits. You can’t just pull out the storage chip and brute-force the PIN. This technology took some time to get to laptops, because there users kinda <em>do</em> expect to be able to pull out the drive and recover data from it, and because secure passphrases are easier to type on a physical keyboard, but by now the latest versions of <a href="https://tinyurl.com/bdhu7bun?ref=words.filippo.io">Bitlocker</a> and <a href="https://support.apple.com/guide/deployment/intro-to-filevault-dep82064ec40/web?ref=words.filippo.io">FileVault</a> also work like this.</p>
<p>The security UX step forward is massive: with just an easily-remembered and easy to type PIN users have cryptographically robust device encryption that makes a misplaced or stolen phone or laptop a security non-event! We were nowhere close to that 10 years ago.</p>
<p>Recently, a few services successfully ported this technology and UX progress beyond local device encryption and to cloud storage. Here’s the problem statement. Imagine you have some user data that you’d like to backup or sync to the cloud, but which is too sensitive to keep in plaintext on your servers. Arguably, all user data you don’t need to process server-side qualifies. Some easy examples are end-to-end encrypted message backups, or password manager vaults. A simple solution is to encrypt it client-side with a password only known to the user. However, the security UX of that is poor: if the user forgets the password, they are locked out; if they pick a simple one it can be brute-forced. Do you see where this is going?</p>
<p>In 2016, Apple <a href="https://blog.cryptographyengineering.com/2016/08/13/is-apples-cloud-key-vault-crypto/?ref=words.filippo.io">got a bunch of HSMs</a> and programmed them to only decrypt iCloud Keychain data when provided with the PIN of a linked iOS device. This way users don’t need to remember any high-entropy secret, but their data can’t be brute-forced server-side. They have since expanded this protection <a href="https://support.apple.com/en-us/102651?ref=words.filippo.io">to other classes of data</a>, including <em>finally</em> iCloud backups for users who opt in to “Advanced Data Protection”, closing the final major end-to-end encryption loophole. (There are a lot of details in the <a href="https://help.apple.com/pdf/security/en_US/apple-platform-security-guide.pdf?ref=words.filippo.io">Platform Security whitepaper</a>.)</p>
<p>WhatsApp recently deployed a similar system for backups, which they aptly call <a href="https://engineering.fb.com/2021/09/10/security/whatsapp-e2ee-backups/?ref=words.filippo.io">end-to-end encrypted backups</a>. The user is given the option of writing down a randomly generated high-entropy key, or to provide a PIN that will wrap that key in a HSM-based system. The <a href="https://www.whatsapp.com/security/WhatsApp_Security_Encrypted_Backups_Whitepaper.pdf?ref=words.filippo.io">whitepaper</a> is a good read.</p>
<p>Signal also has <a href="https://signal.org/blog/secure-value-recovery/?ref=words.filippo.io">a similar system</a>, based on CPU integrated enclaves, for storing account metadata backups, and Celo has <a href="https://docs.celo.org/protocol/identity/encrypted-cloud-backup?ref=words.filippo.io">one based on some fancy cryptography</a> and a consensus of nodes. The idea is always the same: introducing policies (like retry timers and counters) that make low-entropy PINs suitable for strong encryption by hosting secure hardware for the user.</p>
<p>An interesting consequence, which goes to show how fundamental this UX progress is, is that we need to amend <a href="https://blog.cryptographyengineering.com/2012/04/05/icloud-who-holds-key/?ref=words.filippo.io">Matthew Green’s excellent “puddle test”</a>. The original goes a bit like this (paraphrased):</p>
<blockquote>
<p>If you can recover your data after you drop your phone in a mud puddle without having to remember any high-entropy secret, then the data is not encrypted.</p>
</blockquote>
<p>With these systems, we can scratch “high-entropy”: if the recovery process requires even just a PIN, it’s <em>possible</em> that it actually makes the data unavailable to the service provider!</p>
<p>I hope to see this design applied more broadly. There is no reason to relegate it to end-to-end encrypted message backups and password vaults! Anything that doesn’t need to be in plaintext on a server should be protected like this. Along with <a href="https://passkey.org/?ref=words.filippo.io">passkeys</a> solving authentication, I think we have the tools to move on from passwords and passphrases forever.</p>
<p>If you got this far, you might want to follow me on Bluesky (now open for registration!) at <a href="https://bsky.app/profile/filippo.abyssdomain.expert?ref=words.filippo.io">@filippo.abyssdomain.expert</a> or on Mastodon at <a href="https://abyssdomain.expert/@filippo?ref=words.filippo.io">@filippo@abyssdomain.expert</a>.</p>
<h2 id="the-picture">The picture</h2>
<p>One cold evening I sort of stumbled into <a href="https://www.turismoroma.it/en/places/botanical-garden-rome?ref=words.filippo.io">the Botanical Garden of Rome</a> while it was all lit up for <a href="https://roma.tramediluce.it/en/?ref=words.filippo.io">Plots of Light</a>. It was pretty magical. If you stepped just off the allowed path, there was a bench in the darkness from where you could see St. Peter&#39;s.</p>
<p><img src="https://words.filippo.io/content/images/2024/02/plotsoflight.jpeg" alt="On the left, a bamboo forest is lit in blue and red lights. On the right, the dark outline of some trees frames the city skyline lit in contrasting soft yellow lights. In the middle, the Dome of St. Peter&#39;s raises above the horizon." loading="lazy"/></p>
<p>My awesome clients—<a href="https://www.sigsum.org/?ref=words.filippo.io">Sigsum</a>, <a href="https://www.latacora.com/?ref=words.filippo.io">Latacora</a>, <a href="https://interchain.io/?ref=words.filippo.io">Interchain</a>, <a href="https://smallstep.com/?ref=words.filippo.io">Smallstep</a>, <a href="https://www.avalabs.org/?ref=words.filippo.io">Ava Labs</a>, <a href="https://goteleport.com/?ref=words.filippo.io">Teleport</a>, and <a href="https://tailscale.com/?ref=words.filippo.io">Tailscale</a>—are funding all my work for the community and through our retainer contracts they get face time and unlimited access to advice on Go and cryptography.</p>
<p>Here are a few words from some of them!</p>
<p>Latacora — <a href="https://www.latacora.com/?ref=words.filippo.io">Latacora</a> bootstraps security practices for startups. Instead of wasting your time trying to hire a security person who is good at everything from Android security to AWS IAM strategies to SOC2 and apparently has the time to answer all your security questionnaires plus never gets sick or takes a day off, you hire us. We provide a crack team of professionals prepped with processes and power tools, coupling individual security capabilities with strategic program management and tactical project management.</p>
<p>Teleport — For the past five years, attacks and compromises have been shifting from traditional malware and security breaches to identifying and compromising valid user accounts and credentials with social engineering, credential theft, or phishing. <a href="https://goteleport.com/identity-governance-security/?utm=filippo&amp;ref=words.filippo.io">Teleport Identity Governance &amp; Security</a> is designed to eliminate weak access patterns through access monitoring, minimize attack surface with access requests, and purge unused permissions via mandatory access reviews.</p>
<p>Ava Labs — We at <a href="https://www.avalabs.org/?ref=words.filippo.io">Ava Labs</a>, maintainer of <a href="https://github.com/ava-labs/avalanchego?ref=words.filippo.io">AvalancheGo</a> (the most widely used client for interacting with the <a href="https://www.avax.network/?ref=words.filippo.io">Avalanche Network</a>), believe the sustainable maintenance and development of open source cryptographic protocols is critical to the broad adoption of blockchain technology. We are proud to support this necessary and impactful work through our ongoing sponsorship of Filippo and his team.</p>



        </section>
    </article></div>
  </body>
</html>
