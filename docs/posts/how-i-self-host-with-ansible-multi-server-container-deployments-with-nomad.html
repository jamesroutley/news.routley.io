<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://hamy.xyz/blog/2025-12_how-i-self-host">Original</a>
    <h1>How I self-host with Ansible - Multi-server Container Deployments with Nomad</h1>
    
    <div id="readability-page-1" class="page"><p>DISCLOSURE: If you buy through affiliate links, I may earn a small commission. <a href="https://www.cs251.com/blog/disclosures">(disclosures)</a></p><div><p>I recently overhauled my hosting / deployment infrastructure as an incident followup to <a href="https://hamy.xyz/blog/2025-11_post-mortem-hamy-xyz-404s">my site going down in 2025.11</a>. Before that I&#39;d moved from <a href="https://hamy.xyz/blog/2025-08_coolify-to-ansible">Coolify to Ansible</a> and before that <a href="https://hamy.xyz/blog/2024-10_host-docker-container-coolify">from serverless cloud hosting to my own infrastructure</a>.</p>
<p>In this post we&#39;re going to walk through my current infra and why I chose it.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/I07Nk2WVc30?si=pf7M5LPUx_jKRqQZ" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>
<h2 id="how-i-host-my-apps">How I host my apps</h2>
<p><img src="https://storage.googleapis.com/iamhamy-static/labs/posts/2025/2025-12_how-i-self-host/2025-11_how-i-self-host_architecture.png" alt="Architecture Overview"/></p>
<p>I have a 3 server (role) setup:</p>
<ul>
<li><strong>Analytics server</strong> - Hosts my analytics, monitoring, and admin workloads like Grafana, Prometheus, Loki, Uptime Kuma, and Umami. Separated for fault tolerance.</li>
<li><strong>DB Server</strong> - Hosts my Postgres and Redis DBs. Separated for performance and fault tolerance.</li>
<li><strong>App Server(s)</strong> - Hosts all my apps. Currently just 1 server but can spin up to n. Uses Nomad for app deploys, rollouts, healthchecks, etc.</li>
</ul>
<p>All servers are configured to be part of my Tailscale network which allows me to close most external ports on my servers while still allowing them to talk to each other. I also hook my personal computers up to the Tailscale network so they get privileged access to things like my analytics dashboards.</p>
<h2 id="why-i-use-ansible">Why I use Ansible</h2>
<p>When I first started self-hosting, <a href="https://hamy.xyz/blog/2024-10_host-docker-container-coolify">I chose Coolify - an opensource PaaS</a>. This allowed me to get the price:performance ratio of a VPS while allowing me to manage my servers and apps with a cloud-like UI I was used to.</p>
<p>Coolify worked great for a couple apps but I realized that each new app required ab the same amount of effort to setup. I had to dive through UI flows, set various environment variables, copy/paste my configurations over. It wasn&#39;t terrible, but it felt like a lot of manual effort and opened the door to copypasta issues. Worse, if Coolify ever went down I&#39;d have no way of recovering the setups I had before which would make disaster recovery messy.</p>
<p><em>Coolify does support recover from backups but reliability is spotty and IME the server to server transfers are annoying so I often side stepped them by recreating the apps manually.</em></p>
<p>So I decided to move from <a href="https://hamy.xyz/blog/2025-08_coolify-to-ansible">Coolify to Ansible</a> which gave me more control over my servers and all the config lived in code so I could easily reuse variables / configs across apps and map entirely new servers to host my infrastructure in a couple minutes. I&#39;ve been able to prove this numerous times through my testing by spinning up new servers and flashing them with my setup.</p>
<h2 id="how-i-use-ansible">How I use Ansible</h2>
<p>I use Ansible to rollout my infrastructure in phases:</p>
<ul>
<li><strong>Server Foundations</strong> - All Servers - Hardens OS, sets up auto updates, connects to Tailscale and locks down all other access, installs Docker to run my containers, and preinstalls monitoring daemons. All servers get the same base setup and then workload-specific tweaks are setup in the other playbooks.</li>
<li><strong>Core Services</strong> - Analytics + DB Servers - Creates the analytics and db servers, installs appropriate apps / configurations, and opens access for the machines / apps that need them.</li>
<li><strong>App Servers</strong> - Creates the app servers with environment variables pointing them to the appropriate analytics and db servers. Each app server is a Nomad client so workloads can be provisioned on them from the Nomad orchestrator.</li>
</ul>
<h3 id="analytics-server">Analytics Server</h3>
<p>This is the monitoring / supervisor server. It coordinates things and gives me a window into the other servers. If there&#39;s one special server in my architecture it&#39;s this one. The others are workers could be scaled 1...n but this one would be tough to do so.</p>
<ul>
<li><strong>Monitoring</strong> - Grafana, Prometheus, Loki. Probably overkill but I figured if I&#39;m going to do the work, I might as well just get the full power of it. Each server is seeded with exporters to get server data / logs and each server role has exporters to get data / logs from their specific workloads. I also run Umami for web analytics.</li>
</ul>
<blockquote><p lang="en" dir="ltr">Uptime Kuma was way easier to setup than I expected.</p>‚Äî Hamilton Greene üê∑ü¶î (@SIRHAMY) <a href="https://twitter.com/SIRHAMY/status/1993762437640691787?ref_src=twsrc%5Etfw">November 26, 2025</a></blockquote> 
<ul>
<li><strong>Healthchecks</strong> - I installed Uptime Kuma as an <a href="https://hamy.xyz/blog/2025-11_post-mortem-hamy-xyz-404s">incident followup</a> to give me uptime monitoring across all my apps. It was super simple to install (literally just a docker container added via my Ansible script) and has been working well. Grafana should be able to do smth similar but I found Uptime Kuma was way simpler so just went with that. I have a personal Discord server I setup to send me auto notifications from my infra which has worked well and simpler than dealing w email smtp config.</li>
<li><strong>Orchestration</strong> - I decided to put the Nomad controller on my analytics server because it already serves as a kind of overview / admin server anyway. Nomad uses a primary / secondary model so made sense to have one primary and n secondaries which would be the app servers.</li>
</ul>
<h3 id="db-server">DB Server</h3>
<p>The db server is where I host my databases. I chose to have it on its own server as I wanted to play around w multi-server paradigms and figured it would scale better - the apps and dbs won&#39;t fight for contention and I can scale them independently.</p>
<p>For my usecases this is WAY overkill but now I know how this stuff works and have peace of mind in case I accidentally create a smash hit app (in my dreams).</p>
<ul>
<li><strong>Primary</strong> - Postgres is the primary because <a href="https://hamy.xyz/blog/2024-09_postgres-over-everything">you should probably just use Postgres</a>. Postgres is the GOAT - it does relational and non-relational well, it outperforms most other technologies, it has great tooling support, and it has tons of plugins to configure it to work better for specific usecases like time series or RAG or geo data. So all-in-all it&#39;s hard to go wrong with Postgres - especially for my scale.</li>
<li><strong>Secondary</strong> - Redis is the secondary for things like caching and, potentially, non durable queueing. None of my workloads really <em>need</em> caching but I figured I should just set it up to see how it works and because it&#39;s just an extra docker container to set up w my script.</li>
<li><strong>Pgbouncer</strong> - None of my apps will likely scale that high but I do expect to run many apps at the same time - I&#39;m projecting ~50 in the next few years. So the bottleneck for this setup is likely connections, not performance. I looked around and it seems like pgbouncer is the de facto way to help manage connections - it basically works like a queueing system so an app can use Postgres as if it has all connections open but Postgres only uses a fraction of that amount cause pgbouncer is internally queueing the workloads and funneling them into the smaller number of connections (a connection pool). Again overkill for my setup but I feel better knowing this failure mode is covered (or has a pathway to being covered).</li>
</ul>
<h3 id="app-servers">App Servers</h3>
<p>The app servers are built to be stateless workers. They&#39;re all setup the same and they receive Docker containers to run. The orchestration bit is managed by Nomad and each app server is a &#34;client&#34; to the analytics server&#39;s &#34;server&#34;. The Nomad server looks at the workloads it has and chooses how to run them on the clients depending on data around app usage and reserved resources.</p>
<p>Each server has a traefik container on it that understands the config mapping of all the urls and can query Nomad to figure out where to redirect the request to hit the appropriate workload. In a more &#34;production&#34; setup I&#39;d probably use Consul for a lot of its capabilities like service discovery but it was simpler for me to just stick w Nomad.</p>
<p>Previously I was spinning up the Docker Composes on servers directly via Ansible and having auto deploys via periodic pulls with Watchtower but I ran into a couple issues with it that led me to seek out alternatives. Primarily it seemed like I&#39;d be reinventing the wheel for many things like health checks, blue / green deploys, push-based deploys, resource reservations, and container packing / orchestration. Ansible makes this a lot easier to manage because it&#39;s all in code BUT I don&#39;t necessarily want to have to maintain all that stuff - the best code is the code never written.</p>
<p>After researching other options Nomad seemed the most interesting because it stuck with IaC, has a lot of nice integrations / built-ins, is supported by a large co (Hashicorp for better or worse), and can scale to enterprise scale all without the &#34;complexity&#34; of a full-blown k8s. Only time will tell if this was a good decision or not but it seems to hit all the boxes I was looking for.</p>
<h2 id="faq">FAQ</h2>
<h3 id="why-multi-server">Why multi-server?</h3>
<p>Way overkill but I wanted to try out multi-server and figured if I ever needed to scale - due to so many apps or users - I&#39;d need to figure this out anyway. IaC makes multi-server configurations a lot easier (and maybe even feasible) so felt like a good time to make the leap.</p>
<p>DBs are typically the bottleneck in most apps so moving it to its own server is useful so it doesn&#39;t fight with apps for resources. Of course if an app gets super big then I&#39;d probably move it and its db to separate servers but with IaC I&#39;ve already got a blueprint for how that would work.</p>
<h3 id="why-use-nomad-vs-k8s-komodo-coolify-docker-swarm-kamal-etc">Why use Nomad vs k8s, Komodo, Coolify, Docker Swarm, Kamal, etc?</h3>
<p>There are a lot of different options out there for self hosting and they run the gamut from super flexible to opinionated and DIY to off the shelf.</p>
<ul>
<li><strong>PaaS</strong> - Komodo and Coolify offer good off-the-shelf, fully-featured PaaS that you can self host yourself (or use a managed option). These are great and where I&#39;d recommend most people start because you get the UI of the cloud with the price and performance of your own servers. But for me they didn&#39;t offer enough IaC which I think is necessary when you are trying to manage dozens of apps across multiple servers.</li>
<li><strong>Simplified IaC</strong> - Kamal, Docker Swarm - These are good and if you&#39;re running apps on their own servers alongside their DB I think these are great, simple IaC options. It gets complicated when you&#39;re doing multiple apps with shared infra like dbs and monitoring so I felt they didn&#39;t add much vs my existing Ansible and docker compose setup.</li>
<li><strong>K8s</strong> - K8s is the enterprise option. It&#39;s got everything but you also need to understand everything. Basically everything I read said K8s can do it but you should consider every other option first cause once you&#39;re in there it gets complicated fast. I just wasn&#39;t sure I wanted to go down the k8s route yet though if Nomad fails me, k8s might be my next choice.</li>
</ul>
<p>Nomad seemed to fit in a gap where it was simpler than k8s but brought with it a lot of the common things I wanted - service discovery, orchestration, routing, health checks, blue / green deploys, resource reservations, etc. So I decided to try it and got smth working in a couple hours which was a good sign.</p>
<h3 id="why-self-host-vs-cloud">Why self-host vs cloud?</h3>
<p>Cloud is expensive and has a lot of vendor-specific cruft associated with it like iam users, UI-based configurations, navigating how the various services connect w each other etc.</p>
<p>Self-hosting gives me more flexibility and control which lets me run my apps cheaper and how I want. Of course it takes a lot more time in setting it up and potentially ongoing maintenance so there&#39;s a tradeoff.</p>
<p>I was radicalized when I actually did comparisons for price:performance while building <a href="https://cloudcompare.xyz/">CloudCompare</a> - self hosting can often save you 10-100x over cloud for similar offerings.</p>
<h2 id="next">Next</h2>
<p>Anyway that&#39;s how I&#39;m currently running my setup. It probably will change in the future but for now I&#39;m pretty happy with it and think it would work for me for the next couple years.</p>
<p>Let me know if you have questions or would like to see code / examples. I&#39;ve got a lot I could clean up and share but not sure if anyone&#39;s interested and in what parts.</p>
<p><strong>Get $20 off Hetzner Cloud:</strong> If you&#39;re curious ab self hosting and want to get some cheap, quality VPS - I like and use Hetzner and you can <a href="https://hetzner.cloud/?ref=8HuJz94yRocp">get $20 off Hetzner cloud when you use my link</a>.</p>
<p>If you liked this post you might also like:</p>
<ul>
<li><a href="https://hamy.xyz/blog/2024-09_postgres-over-everything">Postgres Over Everything - Why You Should Probably Just use Postgres for your next Web App</a></li>
<li><a href="https://hamy.xyz/blog/2024-10_host-docker-container-coolify">Hosting my Docker Container on a VPS with Coolify as a PaaS with GitHub Autodeploys</a></li>
<li><a href="https://hamy.xyz/blog/2025-08_coolify-to-ansible">Why I&#39;m Ditching Coolify for Ansible for Deploying my Web Apps</a></li>
</ul>
</div></div>
  </body>
</html>
