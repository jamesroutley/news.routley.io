<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://beringresearch.github.io/macpine/lxd_macpine/">Original</a>
    <h1>LXD containers on macOS at near-native speeds</h1>
    
    <div id="readability-page-1" class="page"><div data-md-component="container">
      
      
        
          
        
      
      <main data-md-component="main">
        <div>
          
            
              
              
            
            
              
              
            
          
          
            <div data-md-component="content">
              <article>
                
                  

  <a href="https://github.com/beringresearch/macpine/edit/master/docs/lxd_macpine.md" title="Edit this page">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"></path></svg>
  </a>



<h2 id="overview">Overview</h2>
<p><a href="https://linuxcontainers.org/lxd/introduction/">LXD</a> is a next generation system container manager with support for <a href="https://uk.lxd.images.canonical.com">a wide number of Linux distributions</a>. It provides a simple way to build, test, and run multiple Linux environments across a single machine or multiple compute clusters.</p>
<p>Under the hood, LXD uses <a href="https://linuxcontainers.org/lxc/introduction/">LXC</a>, through liblxc and its Go binding, to create and manage the containers. However, LXD relies on a number of Linux kernel features, such as CGroups and kernel namespaces, which aren&#39;t natively available on MacOS.</p>
<p>Macpine makes it possible to run LXD/LXC containers on MacOS with support for both amd64 and arm64 processors, through its lightweight virtualisation layer. This workflow makes it easy to develop and test LXD containers locally.</p>
<h2 id="prerequisites">Prerequisites</h2>
<ol>
<li>Install QEMU</li>
</ol>
<pre><code>brew install qemu
</code></pre>
<ol>
<li>
<p>Install <a href="https://github.com/beringresearch/macpine#install-the-latest-binary">the latest Macpine binary</a></p>
</li>
<li>
<p>Install the LXD client</p>
</li>
</ol>
<pre><code>brew install lxc
</code></pre>
<h2 id="launch-an-lxd-vm">Launch an LXD VM</h2>
<p>Now that that the system is ready, we can create a lightweight Macpine VM, which has been preconfigured to run LXD. In your terminal run:</p>
<pre><code>alpine launch --image alpine_3.16.0_lxd --name lxd --port 8443 --ssh 2222 --mount $(pwd)
</code></pre>
<p>This will create a new VM called <code>lxd</code> and forward port <code>8443</code> (the default port that LXD client uses to communicate with the LXD server) of the VM to host. Macpine will attempt to match the native CPU architecture of your host to the correct VM image. However, if you can explicitly specify the architecture by adding either <code>--arch aarch64</code> or <code>--arch x86_64</code> to the above command. This will mount your current working directory to <code>/root/mnt</code> inside of the <code>lxd</code> VM.</p>
<h2 id="configure-lxd">Configure LXD</h2>
<p>Before you can create an instance, you need to configure LXD.</p>
<p>Run the following command to accept all automatic defaults:</p>
<pre><code>alpine exec lxd &#34;lxd init --auto&#34;
</code></pre>
<p>For the purposes of this tutorial, it is recommended to accept default settings.</p>
<blockquote>
<blockquote>
<p>NOTE: the above command is executed inside your <code>lxd</code> VM and is sandboxed from your host.</p>
</blockquote>
</blockquote>
<h2 id="configure-lxd-remote">Configure LXD remote</h2>
<p>Set up your LXD remote to communicate with the LXD client on your host.</p>
<pre><code>alpine exec lxd &#34;lxc config set core.https_address 0.0.0.0&#34;
alpine exec lxd &#34;lxc config set core.trust_password root&#34;
</code></pre>
<blockquote>
<blockquote>
<p>NOTE: for the purposes of this demonstration, the remote password is configured as <code>root</code>. This password can be configured with <code>lxc config set core.trust_password</code> above</p>
</blockquote>
</blockquote>
<h2 id="add-the-remote-to-your-lxd-host">Add the remote to your LXD host:</h2>
<pre><code>lxc remote add macpine 127.0.0.1 --accept-certificate --password root
</code></pre>
<blockquote>
<blockquote>
<p>NOTE: if you create an alpine lxd VM, then destroy it, then try to reconfigure another on later on your host, you may need to delete <code>macpine</code> remote from <code>~/.config/lxc/config.yml</code> due to new certificates each time?</p>
</blockquote>
</blockquote>
<p>Finally, set this remote as the default:</p>
<pre><code>lxc remote switch macpine
</code></pre>
<p>That&#39;s it - you can now run LXD containers through Macpine at nearly-native speeds!</p>
<h2 id="launching-your-first-lxd-container">Launching your first LXD container</h2>
<p>LXD containers can now be launched and manipulated through the <code>lxc</code> client:</p>
<pre><code>lxc launch images:debian/bullseye debian
</code></pre>
<h2 id="mounting-host-directory-lxd-macpine-vm-lxd-container">Mounting host directory -&gt; lxd Macpine VM -&gt; lxd container</h2>
<pre><code>lxc config device add debian share disk source=/root/mnt path=/root/mnt
</code></pre>
<h2 id="connecting-to-your-first-lxd-container">Connecting to your first LXD container</h2>
<pre><code>lxc exec debian -- bash
</code></pre>
<h2 id="cleanup">Cleanup</h2>
<pre><code>lxc stop debian
lxc delete debian
alpine stop lxd
alpine delete lxd
</code></pre>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        
      
    </div></div>
  </body>
</html>
