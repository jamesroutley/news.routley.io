<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://bolinlang.com/does-it-inline">Original</a>
    <h1>Does it inline?</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>One of C and C++&#39;s strengths is being able to inline a function and preform additional optimizations on it. Most of us have no idea when something will inline or not. Let&#39;s play a game called &#34;Does It Inline?&#34;. Every round we&#39;ll show you multiple source files with a comment pointing out a difference and you&#39;ll have to guess if main will compile down to `return 0`. You can follow along by writing</p>

<pre>g++ -march=native -O2 main.cpp &amp;&amp; gdb -batch -ex &#39;file a.out&#39; -ex &#39;disassemble main&#39;</pre>

<p>If you rather use lldb you can write <span>lldb ./a.out -s myscript</span> with myscript containing</p>
<pre>disassemble -n main
exit
</pre>

<p>Let&#39;s start off easy</p>
<h2>Round 1:</h2>

<p>A:</p>

<pre><span>inline</span> <span>int</span> <span>fn</span><span>(</span><span>int</span> <span>v</span><span>)</span> <span>{</span> <span>return</span> <span>v</span>; <span>}</span>
<span>int</span> <span>main</span><span>(</span><span>int</span> <span>argc</span><span>,</span> <span>char</span> <span>*</span><span>argv</span><span>[])</span> <span>{</span> <span>return</span> <span>fn</span><span>(</span><span>0</span><span>)</span>; <span>}</span>
</pre>
    

<p>B:</p>

<pre>

<span>int</span> <span>fn</span><span>(</span><span>int</span> <span>v</span><span>)</span> <span>{</span> <span>return</span> <span>v</span>; <span>}</span>
<span>int</span> <span>main</span><span>(</span><span>int</span> <span>argc</span><span>,</span> <span>char</span> <span>*</span><span>argv</span><span>[])</span> <span>{</span> <span>return</span> <span>fn</span><span>(</span><span>0</span><span>)</span>; <span>}</span>
</pre>

<p>C:</p>

<pre>

<span>int</span> <span>fn</span><span>(</span><span>int</span> <span>v</span><span>)</span>;
<span>int</span> <span>main</span><span>(</span><span>int</span> <span>argc</span><span>,</span> <span>char</span> <span>*</span><span>argv</span><span>[])</span> <span>{</span> <span>return</span> <span>fn</span><span>(</span><span>0</span><span>)</span>; <span>}</span>
<span>int</span> <span>fn</span><span>(</span><span>int</span> <span>v</span><span>)</span> <span>{</span> <span>return</span> <span>v</span>; <span>}</span>
</pre>    

<p>D:</p>

<pre>

<span>extern</span> <span>&#34;C&#34;</span> <span>int</span> <span>fn</span><span>(</span><span>int</span> <span>v</span><span>)</span>;
<span>int</span> <span>main</span><span>(</span><span>int</span> <span>argc</span><span>,</span> <span>char</span> <span>*</span><span>argv</span><span>[])</span> <span>{</span> <span>return</span> <span>fn</span><span>(</span><span>123</span><span>)</span>; <span>}</span>
<span>int</span> <span>fn</span><span>(</span><span>int</span> <span>v</span><span>)</span> <span>{</span> <span>return</span> <span>v</span><span>*</span><span>0</span>; <span>}</span>
<span></span>
</pre>
    

<p>Result: All inline in both clang and gcc</p>

<h2>Round 2:</h2>

<p>Examples will be the header file, the source of all are</p>

<pre><span>#</span><span>include</span> <span>&#34;header.h&#34;</span>
<span>int</span> <span>main</span><span>(</span><span>int</span> <span>argc</span><span>,</span> <span>char</span> <span>*</span><span>argv</span><span>[])</span> <span>{</span> <span>return</span> <span>fn</span><span>(</span><span>123</span><span>)</span>; <span>}</span>
</pre>
    

<p>A:</p>

<pre>

<span>int</span> <span>fn</span><span>(</span><span>int</span> <span>v</span><span>)</span> <span>{</span> <span>return</span> <span>v</span><span>*</span><span>0</span>; <span>}</span></pre>
    

<p>B:</p>

<pre>

<span>__attribute__</span> <span>((</span><span>noinline</span><span>))</span>
<span>int</span> <span>fn</span><span>(</span><span>int</span> <span>v</span><span>)</span> <span>{</span> <span>return</span> <span>v</span><span>*</span><span>0</span>; <span>}</span>
<span></span></pre>
    
    
<p>C:</p>

<pre>

<span>__attribute__</span> <span>((</span><span>noinline</span><span>))</span>
<span>__inline</span> <span>int</span> <span>fn</span><span>(</span><span>int</span> <span>v</span><span>)</span> <span>{</span> <span>return</span> <span>v</span><span>*</span><span>0</span>; <span>}</span>
</pre>

<p>D:</p>

<pre>

<span>__attribute__</span> <span>((</span><span>noinline</span><span>))</span>
<span>__attribute__</span><span>((</span><span>always_inline</span><span>))</span>
<span>__inline</span> <span>int</span> <span>fn</span><span>(</span><span>int</span> <span>v</span><span>)</span> <span>{</span> <span>return</span> <span>v</span><span>*</span><span>0</span>; <span>}</span>
</pre>
    

<p>E:</p>
<pre>

<span>__attribute__</span><span>((</span><span>always_inline</span><span>))</span>
<span>__attribute__</span> <span>((</span><span>noinline</span><span>))</span>
<span>__inline</span> <span>int</span> <span>fn</span><span>(</span><span>int</span> <span>v</span><span>)</span> <span>{</span> <span>return</span> <span>v</span><span>*</span><span>0</span>; <span>}</span>
<span></span></pre>
    

<p>Result:
</p><ol type="A">
<li>clang and gcc both inline</li>
<li>clang ignores the attribute and inline, gcc does not</li>
<li>Neither inline, however gcc skips setting the function parameter</li>
<li>same but now gcc warns that always_inline conflicts with noinline</li>
<li>Both will inline. gcc warns that noinline conflicts with always_inline</li>
</ol><p>

To my surpise if you remove __inline clang will inline both C and D. Optimizers can be fickle
</p>

<h2>Round 3:</h2>

<p>A:</p>

<pre><span>#</span><span>include</span> <span>&lt;</span><span>stdlib</span><span>.</span><span>h</span><span>&gt;</span>
<span>int</span> <span>main</span><span>(</span><span>int</span> <span>argc</span><span>,</span> <span>char</span> <span>*</span><span>argv</span><span>[])</span> <span>{</span> <span>return</span> <span>atoi</span><span>(</span><span>&#34;0&#34;</span><span>)</span>; <span>}</span>
</pre>
        
<p>B:</p>

<pre>

<span>#</span><span>include</span> <span>&lt;</span><span>stdlib</span><span>.</span><span>h</span><span>&gt;</span>
<span>int</span> <span>main</span><span>(</span><span>int</span> <span>argc</span><span>,</span> <span>char</span> <span>*</span><span>argv</span><span>[])</span> <span>{</span> <span>return</span> <span>strtol</span><span>(</span><span>&#34;0&#34;</span><span>,</span> <span>0</span><span>,</span> <span>10</span><span>)</span>; <span>}</span>
</pre>

<p>C:</p>

<pre>

<span>#</span><span>include</span> <span>&lt;</span><span>stdlib</span><span>.</span><span>h</span><span>&gt;</span>
<span>int</span> <span>main</span><span>(</span><span>int</span> <span>argc</span><span>,</span> <span>char</span> <span>*</span><span>argv</span><span>[])</span> <span>{</span> <span>return</span> <span>strtod</span><span>(</span><span>&#34;0&#34;</span><span>,</span> <span>0</span><span>)</span>; <span>}</span>
<span></span></pre>
    

<p>Result: A: clang inline, gcc inline atoi but atoi calls strtol which isn&#39;t inlined. B) Same as previous C: Both call strtod </p>

<h2>Round 4:</h2>

<p>A:</p>

<pre><span>#</span><span>include</span> <span>&lt;</span><span>vector</span><span>&gt;</span>
<span>int</span> <span>main</span><span>(</span><span>int</span> <span>argc</span><span>,</span> <span>char</span> <span>*</span><span>argv</span><span>[])</span> <span>{</span> <span>std</span><span>::</span><span>vector</span><span>&lt;</span><span>int</span><span>&gt;</span> <span>v</span>; <span>v</span><span>.</span><span>push_back</span><span>(</span><span>1000</span><span>)</span>; <span>return</span> <span>0</span>; <span>}</span>
</pre>

<p>B:</p>

<pre>

<span>#</span><span>include</span> <span>&lt;</span><span>vector</span><span>&gt;</span>
<span>int</span> <span>main</span><span>(</span><span>int</span> <span>argc</span><span>,</span> <span>char</span> <span>*</span><span>argv</span><span>[])</span> <span>{</span> <span>std</span><span>::</span><span>vector</span><span>&lt;</span><span>int</span><span>&gt;</span> <span>v</span>; <span>v</span><span>.</span><span>push_back</span><span>(</span><span>1000</span><span>)</span>; <span>if</span> <span>(</span><span>v</span><span>.</span><span>size</span><span>()</span> <span>&gt;</span> <span>0</span><span>)</span> <span>{</span> <span>return</span> <span>0</span>; <span>}</span> <span>return</span> <span>1</span>; <span>}</span>
</pre>

<p>C:</p>

<pre>

<span>#</span><span>include</span> <span>&lt;</span><span>vector</span><span>&gt;</span>
<span>int</span> <span>main</span><span>(</span><span>int</span> <span>argc</span><span>,</span> <span>char</span> <span>*</span><span>argv</span><span>[])</span> <span>{</span> <span>std</span><span>::</span><span>vector</span><span>&lt;</span><span>int</span><span>&gt;</span> <span>v</span>; <span>v</span><span>.</span><span>push_back</span><span>(</span><span>1000</span><span>)</span>; <span>if</span> <span>(</span><span>v</span><span>.</span><span>size</span><span>()</span> <span>&gt;</span> <span>0</span><span>)</span> <span>{</span> <span>v</span><span>.</span><span>pop_back</span><span>()</span>; <span>return</span> <span>v</span><span>.</span><span>size</span><span>()</span>; <span>}</span> <span>return</span> <span>1</span>; <span>}</span>
</pre>
    
<p>Amazingly clang inline all of them including C. gcc doesn&#39;t inline any</p>

<h2>Round 5:</h2>

<p>A:</p>

<pre><span>class</span> <span>B</span> <span>{</span> <span>public</span><span>:</span> <span>virtual</span> <span>int</span> <span>test</span><span>()</span> <span>{</span> <span>return</span> <span>0</span>; <span>}}</span>;
<span>class</span> <span>D</span> <span>:</span> <span>public</span> <span>B</span> <span>{</span> <span>public</span><span>:</span> <span>int</span> <span>test</span><span>()</span> <span>override</span> <span>{</span> <span>return</span> <span>1</span>; <span>}}</span>;
<span>int</span> <span>main</span><span>(</span><span>int</span> <span>argc</span><span>,</span> <span>char</span> <span>*</span><span>argv</span><span>[])</span> <span>{</span>
    <span>D</span> <span>d</span>;
    <span>B</span><span>*</span><span>b</span> <span>=</span> <span>&amp;</span><span>d</span>;
    <span>auto</span> <span>p</span> <span>=</span> <span>dynamic_cast</span><span>&lt;</span><span>D</span><span>*&gt;(</span><span>b</span><span>)</span>;
    <span>return</span> <span>!</span><span>p</span>;
<span>}</span></pre>

<p>B:</p>

<pre>

<span>class</span> <span>B</span> <span>{</span> <span>public</span><span>:</span> <span>virtual</span> <span>int</span> <span>test</span><span>()</span> <span>{</span> <span>return</span> <span>0</span>; <span>}}</span>;
<span>class</span> <span>D</span> <span>final</span> <span>:</span> <span>public</span> <span>B</span> <span>{</span> <span>public</span><span>:</span> <span>int</span> <span>test</span><span>()</span> <span>override</span> <span>{</span> <span>return</span> <span>1</span>; <span>}}</span>;
<span>int</span> <span>main</span><span>(</span><span>int</span> <span>argc</span><span>,</span> <span>char</span> <span>*</span><span>argv</span><span>[])</span> <span>{</span>
	<span>D</span> <span>d</span>;
	<span>B</span><span>*</span><span>b</span> <span>=</span> <span>&amp;</span><span>d</span>;
	<span>auto</span> <span>p</span> <span>=</span> <span>dynamic_cast</span><span>&lt;</span><span>D</span><span>*&gt;(</span><span>b</span><span>)</span>;
	<span>return</span> <span>!</span><span>p</span>;
<span>}</span></pre>

<p>C:</p>

<pre>

<span>class</span> <span>B</span> <span>{</span> <span>public</span><span>:</span> <span>virtual</span> <span>int</span> <span>test</span><span>()</span> <span>{</span> <span>return</span> <span>0</span>; <span>}}</span>;
<span>class</span> <span>D</span> <span>final</span> <span>:</span> <span>public</span> <span>B</span> <span>{</span> <span>public</span><span>:</span> <span>int</span> <span>test</span><span>()</span> <span>override</span> <span>{</span> <span>return</span> <span>1</span>; <span>}}</span>;
<span>int</span> <span>main</span><span>(</span><span>int</span> <span>argc</span><span>,</span> <span>char</span> <span>*</span><span>argv</span><span>[])</span> <span>{</span>
	<span>D</span> <span>d</span>;
	<span>B</span><span>*</span><span>b</span> <span>=</span> <span>&amp;</span><span>d</span>;
	<span>auto</span> <span>p</span> <span>=</span> <span>dynamic_cast</span><span>&lt;</span><span>D</span><span>*&gt;(</span><span>b</span><span>)</span>;
	<span>if</span> <span>(</span><span>p</span><span>)</span>
		<span>return</span> <span>0</span>;
	<span>return</span> <span>0</span>;
<span>}</span></pre>


<p>D:</p>

<pre>

<span>class</span> <span>B</span> <span>{</span> <span>public</span><span>:</span> <span>virtual</span> <span>int</span> <span>test</span><span>()</span> <span>{</span> <span>return</span> <span>0</span>; <span>}}</span>;
<span>class</span> <span>D</span> <span>final</span> <span>:</span> <span>public</span> <span>B</span> <span>{</span> <span>public</span><span>:</span> <span>int</span> <span>test</span><span>()</span> <span>override</span> <span>{</span> <span>return</span> <span>1</span>; <span>}}</span>;
<span>int</span> <span>main</span><span>(</span><span>int</span> <span>argc</span><span>,</span> <span>char</span> <span>*</span><span>argv</span><span>[])</span> <span>{</span>
	<span>D</span> <span>d</span>;
	<span>B</span><span>*</span><span>b</span> <span>=</span> <span>&amp;</span><span>d</span>;
	<span>auto</span> <span>p</span> <span>=</span> <span>dynamic_cast</span><span>&lt;</span><span>D</span><span>*&gt;(</span><span>b</span><span>)</span>;
	<span>if</span> <span>(</span><span>p</span><span>)</span>
		<span>return</span> <span>((</span><span>D</span><span>*)</span><span>p</span><span>)-&gt;</span><span>test</span><span>()-</span><span>1</span>;
	<span>return</span> <span>0</span>;
<span>}</span></pre>

<p>E:</p>

<pre>

<span>class</span> <span>B</span> <span>{</span> <span>public</span><span>:</span> <span>virtual</span> <span>int</span> <span>test</span><span>()</span> <span>{</span> <span>return</span> <span>0</span>; <span>}}</span>;
<span>class</span> <span>D</span> <span>final</span> <span>:</span> <span>public</span> <span>B</span> <span>{</span> <span>public</span><span>:</span> <span>int</span> <span>test</span><span>()</span> <span>override</span> <span>{</span> <span>return</span> <span>1</span>; <span>}}</span>;
<span>int</span> <span>main</span><span>(</span><span>int</span> <span>argc</span><span>,</span> <span>char</span> <span>*</span><span>argv</span><span>[])</span> <span>{</span>
	<span>D</span> <span>d</span>;
	<span>B</span><span>*</span><span>b</span> <span>=</span> <span>&amp;</span><span>d</span>;
	<span>auto</span> <span>p</span> <span>=</span> <span>reinterpret_cast</span><span>&lt;</span><span>D</span><span>*&gt;(</span><span>b</span><span>)</span>;
	<span>if</span> <span>(</span><span>p</span><span>)</span>
		<span>return</span> <span>((</span><span>D</span><span>*)</span><span>p</span><span>)-&gt;</span><span>test</span><span>()-</span><span>1</span>;
	<span>return</span> <span>0</span>;
<span>}</span>
<span></span></pre>

<p>Result: Neither inline A and B. gcc inline C and D, both inline E</p>


<h2>Round 6:</h2>

<p>A:</p>
<pre>

<span>inline</span> <span>int</span> <span>getzero</span><span>()</span>;
<span>int</span> <span>main</span><span>(</span><span>int</span> <span>argc</span><span>,</span> <span>char</span> <span>*</span><span>argv</span><span>[])</span> <span>{</span> <span>return</span> <span>getzero</span><span>()</span>; <span>}</span>


<span>int</span> <span>getzero</span><span>()</span> <span>{</span> <span>return</span> <span>0</span>; <span>}</span></pre>
    

<p>B:</p>
<pre></pre>

<p>C:</p>

<pre>

<span>#</span><span>include</span> <span>&lt;</span><span>stdlib</span><span>.</span><span>h</span><span>&gt;</span>
<span>int</span> <span>main</span><span>(</span><span>int</span> <span>argc</span><span>,</span> <span>char</span> <span>*</span><span>argv</span><span>[])</span> <span>{</span> <span>return</span> <span>strtol</span><span>(</span><span>&#34;0&#34;</span><span>,</span> <span>0</span><span>,</span> <span>10</span><span>)</span>; <span>}</span></pre>

<p>D:</p>

<pre>

<span>int</span> <span>fibonacci</span><span>(</span><span>int</span> <span>n</span><span>)</span> <span>{</span>
	<span>if</span><span>(</span><span>n</span> <span>==</span> <span>0</span><span>)</span>
		<span>return</span> <span>0</span>;
	<span>else</span> <span>if</span><span>(</span><span>n</span> <span>==</span> <span>1</span><span>)</span>
		<span>return</span> <span>1</span>;
	<span>else</span> <span>{</span>
		<span>return</span> <span>(</span><span>fibonacci</span><span>(</span><span>n</span><span>-</span><span>1</span><span>)</span> <span>+</span> <span>fibonacci</span><span>(</span><span>n</span><span>-</span><span>2</span><span>))</span>;
	<span>}</span>
<span>}</span>
<span>int</span> <span>main</span><span>()</span> <span>{</span> <span>return</span> <span>fibonacci</span><span>(</span><span>0</span><span>)</span>; <span>}</span>
<span></span></pre>

<p>A: Both warn and use a jump. B: Using -flto both will inline C: gcc continues to not inline (even with -static) and clang had always inlined. D: Neither compilers are clever enough to see it doesn&#39;t need to call fibonacci</p>

<p>For the past few weeks we the Bolin team have been playing with an experimental feature, using a C header to inline C code into Bolin. It might make the next release</p>
</div></div>
  </body>
</html>
