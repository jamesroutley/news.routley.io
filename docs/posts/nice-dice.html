<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://cceckman.com/writing/nice-dice/">Original</a>
    <h1>Nice Dice</h1>
    
    <div id="readability-page-1" class="page"><div>

<p><a href="https://crates.io/crates/nice-dice/" rel="external" target="_blank">nice-dice</a> is a tool that charts the probability of a dice expression.</p>
<p>This code:</p>
<pre tabindex="0"><code>&lt;nice-dice&gt;
[MOD: +4] [PROFICIENCY: +3] [AC: 10]
2 (
     [ATK: 2d20kl] [DIE: 1d10] [CRIT: 1d10] 
     (ATK = 20) * (DIE + CRIT + MOD) +
     (ATK &lt; 20) * (ATK &gt; 1) * (ATK + MOD + PROFICIENCY &gt;= AC) * (DIE + MOD)
)
&lt;/nice-dice&gt;
</code></pre><p>Makes this:</p>
<nice-dice>
[MOD: +4] [PROFICIENCY: +3] [AC: 10]
2 (
     [ATK: 2d20kl] [DIE: 1d10] [CRIT: 1d10] 
     (ATK = 20) * (DIE + CRIT + MOD) +
     (ATK &lt; 20) * (ATK &gt; 1) * (ATK + MOD + PROFICIENCY &gt;= AC) * (DIE + MOD)
)
</nice-dice>
<p>The grammar is explained <a href="https://docs.rs/nice-dice" rel="external" target="_blank">in the docs</a>; you can play with a demo <a href="https://www.jeffgeerling.com/blog/2025/demo.html">here</a>.</p>
<p>If you want to use it on your site or in your program, check out the documentation <a href="https://docs.rs/nice-dice" rel="external" target="_blank">here</a>.</p>
<p>This article covers why I made it, how it works, and the interesting problems I found along the way.</p>


<h2 id="re-rolling-the-roller">Re-rolling the roller</h2>
<p>When I wrote <a href="https://www.jeffgeerling.com/writing/eldritch-blast/">my post on <em>Eldritch Blast</em></a>,
I wanted a widget<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup> that would chart the probability distribution for particular roll.
Specifically, I wanted to compare the damage of two cantrips, <em>eldritch blast</em> and <em>firebolt</em>.<sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup></p>
<p>I put something together using JavaScript. It worked, but it was pretty janky:</p>
<figure><a href="https://www.jeffgeerling.com/blog/2025/wonky-widget.webp"><img src="https://www.jeffgeerling.com/writing/nice-dice/wonky-widget.webp" alt="A screenshot of the widget from the previous article. The chart shows the probabilities of the two spells as a bar chart. But the chart and its controls extend off the right of the page&#39;s text area."/></a><figcaption>
      <p>Graphic design is my passion</p>
    </figcaption>
</figure>
<p>Style aside, I was bothered that I had hard-coded a bunch of the math:
to-hit, attack modifiers, die size.</p>
<p>There’s existing conventions – variants of <a href="https://en.wikipedia.org/wiki/Dice_notation" rel="external" target="_blank">dice notation</a> – for expressing die rolls.
I’ve enjoyed using <a href="https://sophieh.itch.io/sophies-dice" rel="external" target="_blank">Sophie’s Dice</a> for years, which lets you input dice expressions and <del>roll the dice</del> sample the distribution.
If I had something similar, but showing the <em>distribution</em>, I could answer so many of my own questions!</p>
<p>So I made nice-dice!</p>
<p>…and after completing it, found <a href="https://anydice.com" rel="external" target="_blank">AnyDice</a>.
I’m still happy that I’ve got my own version though!</p>
<h2 id="exploring-the-grammar-tree">Exploring the grammar tree</h2>
<p>It took me a while to come up with a grammar that could cover all D&amp;D expressions.
I’m still not sure that I full coverage! But nice-dice handles what I usually roll.</p>
<h3 id="a-basic-grammar">A basic grammar</h3>
<p>I used the <a href="https://crates.io/crates/peg" rel="external" target="_blank"><code>peg</code> crate</a> to build up a grammar for dice expressions.
I started with the basics, like constants (<code>4</code>), dice (<code>d6</code>),
addition and subtraction (<code>+</code> and <code>-</code>), and precedence (parentheses).</p>
<p>In “normal” math expressions, you can express multiplication in two ways:
\(4y\) means the same as \(4 \times y\).
In dice expressions, <code>4d6</code> means <em>repetition</em>, not multiplication: “roll a six-sided die four times and sum the results”.
I elected to carry this forward as <em>generalized repetition</em>: <code>2(1d20 + 2)</code> means “roll <code>1d20 + 2</code> twice and sum the results”.
This makes some calculations – namely, expected damage for <a href="https://www.dndbeyond.com/sources/dnd/br-2024/character-classes#Level5FighterExtraAttack" rel="external" target="_blank">multiattack</a> – easy to express.</p>
<p>I included multiplication (<code>*</code> or <code>×</code>) and division (<code>/</code>) as well.<sup id="fnref:3"><a href="#fn:3" role="doc-noteref">3</a></sup>
Division, at the moment, is only truncating integer division; in D&amp;D, division is <em>typically</em> “half round down”.<sup id="fnref:4"><a href="#fn:4" role="doc-noteref">4</a></sup></p>
<p>Beyond basic math, D&amp;D requires a “keep N” feature. In several cases, the player repeat a die roll, but only keep the highest or lowest value:</p>
<ul>
<li>Advantage: roll two <code>d20</code>s, keep the higher</li>
<li>Disadvantage: roll two <code>d20</code>s, keep the lower</li>
<li>Randomized stat: roll four <code>d6</code>s, keep the highest three and sum them</li>
</ul>
<p>I adopted the grammar from <a href="https://sophieh.itch.io/sophies-dice" rel="external" target="_blank">Sophie’s Dice</a>: <code>2d20kl</code> means “two <code>d20</code>s, keep the lowest one”; <code>4d6kh3</code> means “four <code>d6</code>s, keep the highest 3 and sum”.</p>
<figure>
<nice-dice>4d6kh3</nice-dice>
  Randomized character stat: 4d6kh3
</figure>
<h3 id="if-only">If only…</h3>
<p>This covered a lot of D&amp;D scenarios. But it was missing a big and important one: attack rolls.</p>
<p>In D&amp;D, there are <em>four</em> possible outcomes to an attack roll. The steps to an attack are:</p>
<ol>
<li>Roll <code>1d20</code> to hit (with advantage or disadvantage, as directed).</li>
<li>On a <code>20</code>, <strong>critical hit</strong>: roll the damage dice twice, and add any modifiers, to compute damage.</li>
<li>On a <code>1</code>, <strong>critical miss</strong>: zero damage.</li>
<li>Otherwise, add your attack modifier to the to-hit roll.</li>
<li>If the value meets or exceeds the target’s AC, <strong>hit</strong>: roll the damage dice and add any modifiers.</li>
<li>Otherwise, <strong>miss</strong>: zero damage.</li>
</ol>
<p>This requires some pretty gnarly conditions. In particular, it requires matching the same <code>d20</code> roll, with and without modifiers, against multiple conditions.</p>
<p>I started with a basic “if / else” structure. Expressions with comparison operators, e.g. <code>(1d20 &gt;= 17)</code>, produce values of <code>1</code> or <code>0</code>
with probabilities according to the expression’s truth/falsehood.
Multiplying by another expression creates an “if” block: <code>(1d20 &gt;= 17) * 2d6</code> represents the damage of a “simple” attack (steps 4-6 above).</p>
<p>However, this cannot account for the effects of criticals. Consider adding “critical miss” to the above:</p>
<pre tabindex="0"><code>(1 - (1d20 = 1)) * (1d20 &gt;= 17) * 2d6
</code></pre><p>indicates <em>two distinct</em> <code>d20</code> rolls, with independent probabilities – not one roll.</p>
<p>I tried to resolve this by switching to a “case”-style operator, allowing multiple comparisons for single expression:</p>
<pre tabindex="0"><code>(1d20){ = 20: &lt;crit hit&gt;} { = 1: &lt;crit miss&gt; } { &gt;= 14 - 7: &lt;normal hit&gt; }{ &lt;miss&gt; }
</code></pre><p>This is <em>technically</em> sufficient to handle attack rolls. However, it requires an unusual transformation: any modifiers to the attack roll must be <em>subtracted</em> from the target’s AC. In the above example,
<code>&gt;= 14 - 7</code> indicates a creature with <code>+7</code> to hit attacking a target with AC <code>14</code>. This is pretty counterintuitive – the sign of the to-hit number is backwards!</p>
<p>I discarded the “case” construct and created a grammar of <em>comparisons</em> and <em>bindings</em>.</p>
<p>As before, a comparison expression results in a value of <code>1</code> or <code>0</code>.</p>
<p>A named roll in brackets, like <code>[ATK: 1d20]</code>, is “evaluated” once in its context, and used for the remainder of the expression:</p>
<div><div>
<table><tbody><tr><td>
<pre tabindex="0"><code><span id="hl-3-1"><a href="#hl-3-1">1</a>
</span><span id="hl-3-2"><a href="#hl-3-2">2</a>
</span><span id="hl-3-3"><a href="#hl-3-3">3</a>
</span><span id="hl-3-4"><a href="#hl-3-4">4</a>
</span><span id="hl-3-5"><a href="#hl-3-5">5</a>
</span><span id="hl-3-6"><a href="#hl-3-6">6</a>
</span><span id="hl-3-7"><a href="#hl-3-7">7</a>
</span><span id="hl-3-8"><a href="#hl-3-8">8</a>
</span></code></pre></td>
<td>
<pre tabindex="0"><code data-lang="text"><span><span>[ATK: 1d20]
</span></span><span><span>  (ATK = 20) *
</span></span><span><span>    (2d10 + 4)
</span></span><span><span>+
</span></span><span><span>  (ATK &lt; 20) *
</span></span><span><span>  (ATK &gt; 1) *
</span></span><span><span>  (ATK + 7 &gt;= 14) *
</span></span><span><span>    (1d10 + 4)
</span></span></code></pre></td></tr></tbody></table>
</div>
</div><p>Line 1 represents a single attack roll.
Line 2 matches the “critical” condition, and line 3 gives the critical damage roll. Multiplying these means this term has a value of <code>0</code> except on a critical hit.</p>
<p>Lines 5 and 6 matche non-critical rolls (neither critical hit nor critical miss); line 7 matches normal hits.
Line 8 provides “normal” damage. So, the term spanning lines 5-10 has a value of 0 except on a normal (not critical) hit.</p>
<figure>
<nice-dice>
[ATK: 1d20]
  (ATK = 20) *
    (2d10 + 4)
+
  (ATK &lt; 20) *
  (ATK &gt; 1) *
  (ATK + 7 &gt;= 14) *
    (1d10 + 4)
</nice-dice>
  Damage dealt by an attack: +3 proficiency, +4 modifier, 1d10 + modifier damage, target AC 14
</figure>
<h2 id="running-the-numbers">Running the numbers</h2>
<p>How does nice-dice compute probabilities?</p>
<p>For <a href="https://www.jeffgeerling.com/writing/eldritch-blast/">the other post</a>, I simulated die rolls and tabulated the results.
I started with that approach here too, but I realized the quality was not what I wanted.
I had some tests of the form “the mean of this expression is within episilon of the expected value”–
these would only pass when given hundreds of thousands of rolls. Morover, these values were only approximations.</p>
<p>I switched to using combinatorics.
For each subexpression, I realized I could compute the <a href="https://cceckman.com/r/nice-dice/src/commit/d63f96df5770bd4172a40031b81489fc23a2c3a7/src/discrete.rs#L16" rel="external" target="_blank"><code>Distribution</code></a> as a discrete <code>result -&gt; occurrences</code> mapping:
for each value, how many different ways could this value be produced?
The various operators then combine <code>Distribution</code>s, from simple dice on up.</p>
<p>This has the nice property of using integers throughout– speedy in theory, though I have yet to benchmark it.</p>
<p>Using combinatorics does mean nice-dice can’t handle unbounded distributions, such as exploding dice.<sup id="fnref:5"><a href="#fn:5" role="doc-noteref">5</a></sup>
Since D&amp;D doesn’t use exploding dice, I decided to <a href="https://en.wikipedia.org/wiki/Scope_creep" rel="external" target="_blank">not worry about it</a>.</p>
<h3 id="zeros-get-everywhere">Zeros get everywhere</h3>
<p>Something that annoys me about this approach is that we can’t reject division-by-zero until actually evaluating the expression. Our signature has to be <code>expression -&gt; result&lt;distribution&gt;</code> rather than just <code>expression -&gt; distribution</code>.</p>
<p>Consider this expression:</p>
<pre tabindex="0"><code>[ODD: (1d4) * 2 - 5]
  10 / ODD
</code></pre><p>We can compute the range of <code>ODD</code> without fully evaluting the expression: it ranges from <code>-3</code> (rolled a <code>1</code>) to <code>3</code> (rolled a <code>4</code>). That range includes the value <code>0</code>– so we should be wary of <code>10 / ODD</code>. (Thanks <a href="https://hannahilea.com/" rel="external" target="_blank">Hannah</a> for pointing out I had this wrong earlier!)</p>
<p>However, the probability of <code>ODD = 0</code> is <code>0%</code>. The expression <code>(1d4) * 2</code> will always result in an even number, and subtracting <code>5</code> will always result in an odd number – never zero. Working that out effectively requires computing the probability of zero… so might as well do it in the same pass as all the other probabilities.</p>
<nice-dice>
[ODD: (1d4) * 2 - 5]
  10 / ODD
</nice-dice>
<p>Compare to the output for <code>10 / (1d4 - 2)</code>:</p>
<figure>
<nice-dice>
10 / (1d4 - 2)
</nice-dice>
</figure>
<h2 id="putting-it-on-the-web">Putting it on the web</h2>
<p>Ultimately, nice-dice just outputs an HTML table. Really- check the source!</p>
<p>All the charting magic comes from <a href="https://chartscss.org/" rel="external" target="_blank">Charts.css</a>, a CSS-only library for turning tables into charts.
The output of nice-dice has Charts.css markup to make it Look Nice. When invoked as a CLI,
that HTML is all you get – handy for static sites!</p>
<p>But I also wanted something interactive, like the <a href="https://www.jeffgeerling.com/blog/2025/demo.html">demo page</a>.
My day job involves writing Rust that goes into WebAssembly modules,<sup id="fnref:6"><a href="#fn:6" role="doc-noteref">6</a></sup>
so I wrapped nice-dice in a WASM envelope and then in a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_components" rel="external" target="_blank">Web Component</a> to improve the ergonomics.</p>
<h3 id="wasm-modules-and-components">WASM: modules and components</h3>
<p>The WebAssembly ecosystem is going through a transition from <em>modules</em> to <em>components</em>.
I ran into some of the rough edges of this in putting nice-dice on the web.</p>
<p>WASM modules are a bit like a dynamically-linked library. The ABI is very low-level: bytes and pointers.
There’s good support for creating WASM modules from Rust via <a href="https://wasm-bindgen.github.io/wasm-bindgen/" rel="external" target="_blank">wasm_bindgen</a>, along with the JavaScript glue to call them.
My first verision of nice-dice did just that; but whenever there were errors, they were opaque and difficult to understand.</p>
<p><a href="https://component-model.bytecodealliance.org/introduction.html" rel="external" target="_blank">WASM components</a> provide a higher-level interface.
A Wasm Interface Type (WIT) definition describes the interace, including rich types like <code>result</code> and <code>option</code>
and opaque handles (<code>resource</code> types). There’s good Rust integration from <a href="https://github.com/bytecodealliance/cargo-component" rel="external" target="_blank">cargo component</a> to create Rust interfaces.
And the resulting component includes the WIT, so the component is self-describing.</p>
<p>The story for WASM components on the web is not complete, though; browsers don’t understand the component model.
When I rebuilt nice-dice as a component, I was somewhat stuck.
Luckly, some coworkers pointed me at the <a href="https://github.com/bytecodealliance/jco/tree/main" rel="external" target="_blank">jco</a> project, which can take a component (with its embedded WIT)
and generate appropriate Javascript bindings.</p>
<h3 id="web-components">Web Components</h3>
<p>The <code>&lt;nice-dice&gt;</code> HTML element is a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_components" rel="external" target="_blank">Web Component</a>, that is <a href="https://codeberg.org/cceckman/nice-dice/src/branch/main/web-component/nice-dice-element.js" rel="external" target="_blank">a JavaScript class</a> that adds custom behavior.
Specifically, it spins up a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers" rel="external" target="_blank">Web Worker</a> to host the WASM, to avoid blocking the main thread while recomputing.</p>
<p>I really like Web Components! I wish I had a better story for running them server-side on my site– but that’s a project <a href="https://cceckman.com/writing/publish-then-program/" rel="external" target="_blank">for the future</a>.</p>
<h2 id="try-it-out">Try it out!</h2>
<p>If you’re interested in using nice-dice on your site or for a project, let me know! I’ve put in a little effort in packaging, but I could use some encouragement to get it over the finish line.</p>
<p>Or if you find bugs, or have ideas for improvements, also let me know!</p>




</div></div>
  </body>
</html>
