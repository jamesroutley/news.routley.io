<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/microsoft/snmalloc">Original</a>
    <h1>Snmalloc: A Message Passing Allocator</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">snmalloc is a high-performance allocator.
snmalloc can be used directly in a project as a header-only C++ library,
it can be <code>LD_PRELOAD</code>ed on Elf platforms (e.g. Linux, BSD),
and there is a <a href="https://crates.io/crates/snmalloc-rs" rel="nofollow">crate</a> to use it from Rust.</p>
<p dir="auto">Its key design features are:</p>
<ul dir="auto">
<li>Memory that is freed by the same thread that allocated it does not require any
synchronising operations.</li>
<li>Freeing memory in a different thread to initially allocated it, does not take
any locks and instead uses a novel message passing scheme to return the
memory to the original allocator, where it is recycled.  This enables 1000s of remote
deallocations to be performed with only a single atomic operation enabling great
scaling with core count.</li>
<li>The allocator uses large ranges of pages to reduce the amount of meta-data
required.</li>
<li>The fast paths are highly optimised with just two branches on the fast path
for malloc (On Linux compiled with Clang).</li>
<li>The platform dependencies are abstracted away to enable porting to other platforms.</li>
</ul>
<p dir="auto">snmalloc&#39;s design is particular well suited to the following two difficult
scenarios that can be problematic for other allocators:</p>
<ul dir="auto">
<li>Allocations on one thread are freed by a different thread</li>
<li>Deallocations occur in large batches</li>
</ul>
<p dir="auto">Both of these can cause massive reductions in performance of other allocators, but
do not for snmalloc.</p>
<p dir="auto">The implementation of snmalloc has evolved significantly since the <a href="https://ntietz.com/microsoft/snmalloc/blob/main/snmalloc.pdf">initial paper</a>.
The mechanism for returning memory to remote threads has remained, but most of the meta-data layout has changed.
We recommend you read <a href="https://ntietz.com/microsoft/snmalloc/blob/main/docs/security/README.md">docs/security</a> to find out about the current design, and
if you want to dive into the code <a href="https://ntietz.com/microsoft/snmalloc/blob/main/docs/AddressSpace.md">docs/AddressSpace.md</a> provides a good overview of the allocation and deallocation paths.</p>
<p dir="auto"><a href="https://github.com/microsoft/snmalloc/actions/workflows/main.yml"><img src="https://github.com/microsoft/snmalloc/actions/workflows/main.yml/badge.svg" alt="snmalloc CI"/></a>
<a href="https://github.com/microsoft/snmalloc/actions/workflows/morello.yml"><img src="https://github.com/microsoft/snmalloc/actions/workflows/morello.yml/badge.svg" alt="snmalloc CI for Morello"/></a></p>

<p dir="auto">There is a hardened version of snmalloc, it contains</p>
<ul dir="auto">
<li>Randomisation of the allocations&#39; relative locations,</li>
<li>Most meta-data is stored separately from allocations, and is protected with guard pages,</li>
<li>All in-band meta-data is protected with a novel encoding that can detect corruption, and</li>
<li>Provides a <code>memcpy</code> that automatically checks the bounds relative to the underlying malloc.</li>
</ul>
<p dir="auto">A more comprehensive write up is in <a href="https://ntietz.com/microsoft/snmalloc/blob/main/docs/security/README.md">docs/security</a>.</p>

<ul dir="auto">
<li><a href="https://ntietz.com/microsoft/snmalloc/blob/main/docs/BUILDING.md">Instructions for building snmalloc</a></li>
<li><a href="https://ntietz.com/microsoft/snmalloc/blob/main/docs/PORTING.md">Instructions for porting snmalloc</a></li>
</ul>

<p dir="auto">This project welcomes contributions and suggestions.  Most contributions require you to agree to a
Contributor License Agreement (CLA) declaring that you have the right to, and actually do, grant us
the rights to use your contribution. For details, visit <a href="https://cla.microsoft.com" rel="nofollow">https://cla.microsoft.com</a>.</p>
<p dir="auto">When you submit a pull request, a CLA-bot will automatically determine whether you need to provide
a CLA and decorate the PR appropriately (e.g., label, comment). Simply follow the instructions
provided by the bot. You will only need to do this once across all repos using our CLA.</p>
<p dir="auto">This project has adopted the <a href="https://opensource.microsoft.com/codeofconduct/" rel="nofollow">Microsoft Open Source Code of Conduct</a>.
For more information see the <a href="https://opensource.microsoft.com/codeofconduct/faq/" rel="nofollow">Code of Conduct FAQ</a> or
contact <a href="mailto:opencode@microsoft.com">opencode@microsoft.com</a> with any additional questions or comments.</p>
</article>
          </div></div>
  </body>
</html>
