<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://bea.goth.cafe/terraform-with-virtual-mfa/">Original</a>
    <h1>Terraform With Virtual MFA</h1>
    
    <div id="readability-page-1" class="page"><div><hr/><p>In this post, I will guide you on how to add an extra layer of security to Terraform when you’re using it on hobby projects with AWS. This is particularly helpful when your AWS API keys are stored in an unencrypted form on your local machine.</p><p>My suggested strategy involves creating a specific user with limited access. This user’s only permission will be to assume a role that has more privileges. We will then add a policy to this privileged role, allowing only those users who have successfully authenticated via Multi-Factor Authentication (MFA) to assume it. This approach might sound straightforward, but it’s effective. Here’s how to do it:</p><h4 id="create-a-user">Create A User</h4><ol><li><p>Create a user</p><ol><li>IAM -&gt; Users -&gt; Create user</li><li>Add a name, don’t check <code>allow access to aws console</code></li><li>Don’t add any permissions, just click through</li></ol></li><li><p>Edit the newly created user and add a virtual MFA device:</p></li><li><p>Click the security credentials tab</p></li><li><p>Click <code>Assign MFA device</code>, name the device, and choose Virtual (this is important), use your phone to set it up. Remember the ARN, it will look like <code>arn:aws:iam::123:mfa/USER</code></p></li><li><p>Click the <code>Access Keys</code> tab, add an API key for <code>Command Line Interface</code> and save it in a secure location.</p></li></ol><h4 id="create-a-role">Create A Role</h4><ol><li>Create a role that is used to do administrative/power user things on AWS.<ol><li>Navigate to IAM -&gt; Roles -&gt; Create Role</li><li>Add the permissions policies that you want</li><li>Add a name and description for the role</li><li>Select <code>Custom Trust Policy</code> for the trusted entity type, and choose the json editor</li><li>Paste in the following policy, update the user field to match the user that you just created, and add a random secret for the ExternalId:</li></ol></li></ol><div><pre tabindex="0"><code data-lang="json"><span><span>{
</span></span><span><span>	<span>&#34;Version&#34;</span>: <span>&#34;2012-10-17&#34;</span>,
</span></span><span><span>	<span>&#34;Statement&#34;</span>: [
</span></span><span><span>		{
</span></span><span><span>			<span>&#34;Sid&#34;</span>: <span>&#34;AssumeAdminRolePolicy&#34;</span>,
</span></span><span><span>			<span>&#34;Effect&#34;</span>: <span>&#34;Allow&#34;</span>,
</span></span><span><span>			<span>&#34;Principal&#34;</span>: {
</span></span><span><span>				<span>&#34;AWS&#34;</span>: <span>&#34;arn:aws:iam::123:user/USER&#34;</span>
</span></span><span><span>			},
</span></span><span><span>			<span>&#34;Action&#34;</span>: <span>&#34;sts:AssumeRole&#34;</span>,
</span></span><span><span>            <span>&#34;Condition&#34;</span>: {
</span></span><span><span>                <span>&#34;StringEquals&#34;</span>: {<span>&#34;sts:ExternalId&#34;</span>: <span>&#34;a-random-string&#34;</span>},
</span></span><span><span>                <span>&#34;Bool&#34;</span>: { <span>&#34;aws:multifactorAuthPresent&#34;</span>: <span>true</span>} 
</span></span><span><span>		    }
</span></span><span><span>		}
</span></span><span><span>	]
</span></span><span><span>}
</span></span></code></pre></div><p><em>Note</em>: Remember the role ARN, it will look something like <code>arn:aws:iam::123:role/ROLE</code></p><h4 id="install-and-configure-aws-cli">Install and configure AWS cli</h4><ol><li>Install the AWS cli.</li><li>Create the <code>~/.aws</code> directory if it doesn’t exist:</li></ol><ol start="3"><li>Create an empty configuration file:</li></ol><ol start="4"><li>Create an empty credentials file:</li></ol><ol start="5"><li>In the config file put the following, with the correct region</li></ol><div><pre tabindex="0"><code data-lang="yaml"><span><span>[<span>default]</span>
</span></span><span><span><span>region = us-east-1</span>
</span></span><span><span><span>output = json</span>
</span></span></code></pre></div><ol start="6"><li>In the credentials file, put the following, with the correct values:</li></ol><div><pre tabindex="0"><code data-lang="yaml"><span><span>[<span>default]</span>
</span></span><span><span><span>aws_access_key_id = &lt;YOUR_KEY_ID&gt;</span>
</span></span><span><span><span>aws_secret_access_key = &lt;YOUR_ACCESS_KEY&gt;</span>
</span></span></code></pre></div><h4 id="create-a-policy-for-your-user">Create A Policy For Your User</h4><ol><li>Navigate to IAM &gt; Users &gt; (User you created).</li><li>Go to the permissions section, and create an inline permissions policy.</li><li>Click the “JSON” button and paste the following policy JSON and save:</li></ol><div><pre tabindex="0"><code data-lang="json"><span><span>{
</span></span><span><span>    <span>&#34;Version&#34;</span>: <span>&#34;2012-10-17&#34;</span>,
</span></span><span><span>    <span>&#34;Statement&#34;</span>: [
</span></span><span><span>        {
</span></span><span><span>            <span>&#34;Effect&#34;</span>: <span>&#34;Allow&#34;</span>,
</span></span><span><span>            <span>&#34;Action&#34;</span>: <span>&#34;sts:AssumeRole&#34;</span>,
</span></span><span><span>            <span>&#34;Resource&#34;</span>: <span>&#34;arn:aws:iam::123:role/ROLE&#34;</span>
</span></span><span><span>        }
</span></span><span><span>    ]
</span></span><span><span>}
</span></span></code></pre></div><h4 id="authenticate-terraform">Authenticate Terraform</h4><ol><li>For this section, we are going to use the AWS Security Token Service (STS) to get some AWS session credentials that have the privileged role attached!</li><li>Before running Terraform, obtain session credentials for <code>duration</code> seconds, the <code>serial-number</code> and <code>token-code</code> parameters are important!</li></ol><div><pre tabindex="0"><code data-lang="bash"><span><span>aws --profile default sts assume-role <span>\
</span></span></span><span><span><span></span>  --role-arn arn:aws:iam::&lt;account id&gt;:role/terraform-admin <span>\
</span></span></span><span><span><span></span>  --role-session-name TFsession <span>\
</span></span></span><span><span><span></span>  --output text <span>\
</span></span></span><span><span><span></span>  --query <span>&#34;Credentials.[AccessKeyId,SecretAccessKey]&#34;</span> <span>\
</span></span></span><span><span><span></span>  --external-id a-random-string <span>\
</span></span></span><span><span><span></span>  --duration <span>900</span> <span>\
</span></span></span><span><span><span></span>  --serial-number arn:aws:iam::&lt;account id&gt;:mfa/terraform-mfa <span>\
</span></span></span><span><span><span></span>  --token-code <span>12345</span>
</span></span></code></pre></div><p>This command will output the temporary AccessKeyId, SecretAccessKey, and SessionToken, you can now place these into the shell environment – and run terraform:</p><div><pre tabindex="0"><code data-lang="bash"><span><span>export AWS_ACCESS_KEY_ID<span>=</span><span>&#34;new_access_key_id&#34;</span>
</span></span><span><span>export AWS_SECRET_ACCESS_KEY<span>=</span><span>&#34;new_secret_access_key&#34;</span>
</span></span><span><span>export AWS_SESSION_TOKEN<span>=</span><span>&#34;new_session_token&#34;</span>
</span></span></code></pre></div><p>Make sure that the terraform provider has minimal configuration, you’ll especially need to make sure that it doesn’t specify a profile, otherwise it will interfere with how the credentials are read. This is mine:</p><div><pre tabindex="0"><code data-lang="json"><span><span><span>provider</span> <span>&#34;aws&#34;</span> {
</span></span><span><span>	<span>region</span> <span>=</span> <span>&#34;us-east-1&#34;</span>
</span></span><span><span>}
</span></span></code></pre></div><p>I have created a simple script that makes it easier to obtain a session when you want to run terraform:</p><p><em>Important</em>: Please ensure to ‘source’ the script instead of executing it in a regular manner. ‘Sourcing’ the script ensures that the environment variables, which are set by the script, persist even after the script finishes its execution. This is crucial because the Terraform client relies on these environment variables. If you don’t ‘source’ the script, these variables will not be available to the Terraform client once the script execution is completed.</p><div><pre tabindex="0"><code data-lang="bash"><span><span>source get_tf_session.sh --aid <span>123</span> --eid a-random-string --role terraform-admin --mfa terraform-mfa --code <span>12345</span>
</span></span><span><span>...
</span></span><span><span>...
</span></span><span><span>terraform plan
</span></span></code></pre></div><p>Thats it! You should now be able to run terraform commands with the correct permissions from the privileged role, but only if you provide the correct MFA code.</p></div></div>
  </body>
</html>
