<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://bea.goth.cafe/terraform-with-virtual-mfa/">Original</a>
    <h1>Terraform With Virtual MFA</h1>
    
    <div id="readability-page-1" class="page"><div><hr/><p>In this post, I will guide you on how to add an extra layer of security to Terraform when you’re using it with AWS. This is particularly helpful if your AWS API keys are stored in an unencrypted form on your local machine.</p><p>My suggested strategy involves creating a specific user with limited access. This user’s only permission will be to assume a role that has more privileges. We will then add a policy to this privileged role, allowing only those users who have successfully authenticated via Multi-Factor Authentication (MFA) to assume it. This approach might sound straightforward, but it’s effective. Here’s how to do it:</p><h4 id="create-a-user">Create A User</h4><ol><li><p>Create a user</p><ol><li>IAM -&gt; Users -&gt; Create user</li><li>Add a name, don’t check <code>allow access to aws console</code></li><li>Don’t add any permissions, just click through</li></ol></li><li><p>Edit the newly created user and add a virtual MFA device:</p></li><li><p>Click the security credentials tab</p></li><li><p>Click <code>Assign MFA device</code>, name the device, and choose Virtual (this is important), use your phone to set it up. Remember the ARN, it will look like <code>arn:aws:iam::123:mfa/USER</code></p></li><li><p>Click the <code>Access Keys</code> tab, add an API key for <code>Command Line Interface</code> and save it in a secure location.</p></li></ol><h4 id="create-a-role">Create A Role</h4><ol><li>Create a role that is used to do administrative/power user things on AWS.<ol><li>Navigate to IAM -&gt; Roles -&gt; Create Role</li><li>Add the permissions policies that you want</li><li>Add a name and description for the role</li><li>Select <code>Custom Trust Policy</code> for the trusted entity type, and choose the json editor</li><li>Paste in the following policy, update the user field to match the user that you just created, and add a random secret for the ExternalId:</li></ol></li></ol><div><pre tabindex="0"><code data-lang="json"><span><span>{
</span></span><span><span>	<span>&#34;Version&#34;</span>: <span>&#34;2012-10-17&#34;</span>,
</span></span><span><span>	<span>&#34;Statement&#34;</span>: [
</span></span><span><span>		{
</span></span><span><span>			<span>&#34;Sid&#34;</span>: <span>&#34;AssumeAdminRolePolicy&#34;</span>,
</span></span><span><span>			<span>&#34;Effect&#34;</span>: <span>&#34;Allow&#34;</span>,
</span></span><span><span>			<span>&#34;Principal&#34;</span>: {
</span></span><span><span>				<span>&#34;AWS&#34;</span>: <span>&#34;arn:aws:iam::123:user/USER&#34;</span>
</span></span><span><span>			},
</span></span><span><span>			<span>&#34;Action&#34;</span>: <span>&#34;sts:AssumeRole&#34;</span>,
</span></span><span><span>            <span>&#34;Condition&#34;</span>: {
</span></span><span><span>                <span>&#34;StringEquals&#34;</span>: {<span>&#34;sts:ExternalId&#34;</span>: <span>&#34;a-random-string&#34;</span>},
</span></span><span><span>                <span>&#34;Bool&#34;</span>: { <span>&#34;aws:multifactorAuthPresent&#34;</span>: <span>true</span>} 
</span></span><span><span>		    }
</span></span><span><span>		}
</span></span><span><span>	]
</span></span><span><span>}
</span></span></code></pre></div><p><em>Note</em>: Remember the role ARN, it will look something like <code>arn:aws:iam::123:role/ROLE</code></p><h4 id="install-and-configure-aws-cli">Install and configure AWS cli</h4><ol><li>Install the AWS cli.</li><li>Create the <code>~/.aws</code> directory if it doesn’t exist:</li></ol><ol start="3"><li>Create an empty configuration file:</li></ol><ol start="4"><li>Create an empty credentials file:</li></ol><ol start="5"><li>In the config file put the following, with the correct region</li></ol><div><pre tabindex="0"><code data-lang="yaml"><span><span>[<span>default]</span>
</span></span><span><span><span>region = us-east-1</span>
</span></span><span><span><span>output = json</span>
</span></span></code></pre></div><ol start="6"><li>In the credentials file, put the following, with the correct values:</li></ol><div><pre tabindex="0"><code data-lang="yaml"><span><span>[<span>default]</span>
</span></span><span><span><span>aws_access_key_id = &lt;YOUR_KEY_ID&gt;</span>
</span></span><span><span><span>aws_secret_access_key = &lt;YOUR_ACCESS_KEY&gt;</span>
</span></span></code></pre></div><h4 id="create-a-policy-for-your-user">Create A Policy For Your User</h4><ol><li>Navigate to IAM &gt; Users &gt; (User you created).</li><li>Go to the permissions section, and create an inline permissions policy.</li><li>Click the “JSON” button and paste the following policy JSON and save:</li></ol><div><pre tabindex="0"><code data-lang="json"><span><span>{
</span></span><span><span>    <span>&#34;Version&#34;</span>: <span>&#34;2012-10-17&#34;</span>,
</span></span><span><span>    <span>&#34;Statement&#34;</span>: [
</span></span><span><span>        {
</span></span><span><span>            <span>&#34;Effect&#34;</span>: <span>&#34;Allow&#34;</span>,
</span></span><span><span>            <span>&#34;Action&#34;</span>: <span>&#34;sts:AssumeRole&#34;</span>,
</span></span><span><span>            <span>&#34;Resource&#34;</span>: <span>&#34;arn:aws:iam::123:role/ROLE&#34;</span>
</span></span><span><span>        }
</span></span><span><span>    ]
</span></span><span><span>}
</span></span></code></pre></div><h4 id="authenticate-terraform">Authenticate Terraform</h4><ol><li>For this section, we are going to use the AWS Security Token Service (STS) to get some AWS session credentials that have the privileged role attached!</li><li>Before running Terraform, obtain session credentials for <code>duration</code> seconds, the <code>serial-number</code> and <code>token-code</code> parameters are important!</li></ol><div><pre tabindex="0"><code data-lang="bash"><span><span>aws --profile default sts assume-role --role-arn arn:aws:iam::&lt;account id&gt;:role/terraform-admin --role-session-name TFsession --output text --query <span>&#34;Credentials.[AccessKeyId,SecretAccessKey]&#34;</span> --external-id a-password --duration <span>900</span> --serial-number arn:aws:iam::&lt;account id&gt;:mfa/terraform-mfa --token-code <span>12345</span>
</span></span></code></pre></div><p>This command will output the temporary AccessKeyId, SecretAccessKey, and SessionToken, you can now place these into the shell environment – and run terraform:</p><div><pre tabindex="0"><code data-lang="bash"><span><span>export AWS_ACCESS_KEY_ID<span>=</span><span>&#34;new_access_key_id&#34;</span>
</span></span><span><span>export AWS_SECRET_ACCESS_KEY<span>=</span><span>&#34;new_secret_access_key&#34;</span>
</span></span><span><span>export AWS_SESSION_TOKEN<span>=</span><span>&#34;new_session_token&#34;</span>
</span></span></code></pre></div><p>Make sure that the terraform provider has minimal configuration, otherwise it will interfere with how the credentials are read. This is mine:</p><div><pre tabindex="0"><code data-lang="json"><span><span><span>provider</span> <span>&#34;aws&#34;</span> {
</span></span><span><span>	<span>region</span> <span>=</span> <span>&#34;us-east-1&#34;</span>
</span></span><span><span>}
</span></span></code></pre></div><p>I have created a simple script that makes it easier to obtain a session when you want to run terraform:</p><div><pre tabindex="0"><code data-lang="bash"><span><span><span>#!/bin/bash
</span></span></span><span><span><span></span><span># WARNING! DO NOT USE THIS SCRIPT WITH UNTRUSTED INPUTS</span>
</span></span><span><span>
</span></span><span><span><span>function</span> print_usage <span>{</span>
</span></span><span><span>  echo <span>&#34;Usage: source get_ft_session.sh&#34;</span> &gt;&amp;<span>2</span>
</span></span><span><span>  echo <span>&#34;  --aid &lt;account-id&gt;&#34;</span> &gt;&amp;<span>2</span>
</span></span><span><span>  echo <span>&#34;  --mfa &lt;virtual-mfa-arn&gt;&#34;</span> &gt;&amp;<span>2</span>
</span></span><span><span>  echo <span>&#34;  --eid &lt;external-id&gt;&#34;</span> &gt;&amp;<span>2</span>
</span></span><span><span>  echo <span>&#34;  --role &lt;role-name&gt;&#34;</span> &gt;&amp;<span>2</span>
</span></span><span><span>  echo <span>&#34;  --code &lt;mfa-code&gt;&#34;</span> &gt;&amp;<span>2</span>
</span></span><span><span>  echo <span>&#34;  [--duration &lt;session-duration-in-seconds&gt;]&#34;</span> &gt;&amp;<span>2</span>
</span></span><span><span>  echo <span>&#34;&#34;</span> &gt;&amp;<span>2</span>
</span></span><span><span>  echo <span>&#34;All parameters are required except for --duration. Default duration is 900 seconds.&#34;</span> &gt;&amp;<span>2</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>function</span> is_aws_cli_installed <span>{</span>
</span></span><span><span>  <span>if</span> ! command -v aws &amp;&gt; /dev/null; <span>then</span>
</span></span><span><span>    echo <span>&#34;AWS CLI could not be found. Please install it.&#34;</span> &gt;&amp;<span>2</span>
</span></span><span><span>    <span>return</span> <span>1</span>
</span></span><span><span>  <span>fi</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>function</span> generate_session_name <span>{</span>
</span></span><span><span>  DATE<span>=</span><span>$(</span>date +%Y%m%d%H%M%S<span>)</span>
</span></span><span><span>  RANDOM_STR<span>=</span><span>$(</span>uuidgen | cut -c-10<span>)</span>
</span></span><span><span>  echo <span>&#34;tf-session-</span>$DATE<span>-</span>$RANDOM_STR<span>&#34;</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>function</span> print_final_message <span>{</span>
</span></span><span><span>  DURATION_IN_MINUTES<span>=</span><span>$((</span>$1 <span>/</span> <span>60</span><span>))</span>
</span></span><span><span>  echo <span>&#34;Terraform is now configured to use the role </span>$2<span> for </span>$DURATION_IN_MINUTES<span> minutes&#34;</span> &gt;&amp;<span>2</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span>unset ACCOUNT_ID
</span></span><span><span>unset VIRTUAL_MFA
</span></span><span><span>unset EXTERNAL_ID
</span></span><span><span>unset ROLE_NAME
</span></span><span><span>unset MFA_CODE
</span></span><span><span>
</span></span><span><span><span># Parse command-line arguments</span>
</span></span><span><span><span>while</span> <span>[[</span> $# -gt <span>0</span> <span>]]</span>
</span></span><span><span><span>do</span>
</span></span><span><span>key<span>=</span><span>&#34;</span>$1<span>&#34;</span>
</span></span><span><span>
</span></span><span><span><span>case</span> $key in
</span></span><span><span>    --aid<span>)</span>
</span></span><span><span>    ACCOUNT_ID<span>=</span><span>&#34;</span>$2<span>&#34;</span>
</span></span><span><span>    shift <span># past argument</span>
</span></span><span><span>    shift <span># past value</span>
</span></span><span><span>    ;;
</span></span><span><span>    --mfa<span>)</span>
</span></span><span><span>    VIRTUAL_MFA<span>=</span><span>&#34;</span>$2<span>&#34;</span>
</span></span><span><span>    shift
</span></span><span><span>    shift
</span></span><span><span>    ;;
</span></span><span><span>    --eid<span>)</span>
</span></span><span><span>    EXTERNAL_ID<span>=</span><span>&#34;</span>$2<span>&#34;</span>
</span></span><span><span>    shift
</span></span><span><span>    shift
</span></span><span><span>    ;;
</span></span><span><span>    --role<span>)</span>
</span></span><span><span>    ROLE_NAME<span>=</span><span>&#34;</span>$2<span>&#34;</span>
</span></span><span><span>    shift
</span></span><span><span>    shift
</span></span><span><span>    ;;
</span></span><span><span>    --code<span>)</span>
</span></span><span><span>    MFA_CODE<span>=</span><span>&#34;</span>$2<span>&#34;</span>
</span></span><span><span>    shift
</span></span><span><span>    shift
</span></span><span><span>    ;;
</span></span><span><span>    --duration<span>)</span>
</span></span><span><span>    DURATION<span>=</span><span>&#34;</span>$2<span>&#34;</span>
</span></span><span><span>    shift
</span></span><span><span>    shift
</span></span><span><span>    ;;
</span></span><span><span>    *<span>)</span>    <span># unknown option</span>
</span></span><span><span>    echo <span>&#34;Unknown argument: </span>$1<span>&#34;</span> &gt;&amp;<span>2</span>
</span></span><span><span>    <span>return</span> <span>1</span>
</span></span><span><span>    ;;
</span></span><span><span><span>esac</span>
</span></span><span><span><span>done</span>
</span></span><span><span>
</span></span><span><span><span># Call the function to check if AWS CLI is installed</span>
</span></span><span><span>is_aws_cli_installed
</span></span><span><span>
</span></span><span><span><span># Set default duration of the session to 15 minutes</span>
</span></span><span><span>LANG<span>=</span>en_US.UTF-8
</span></span><span><span>DURATION<span>=</span><span>900</span>
</span></span><span><span>SESSION_NAME<span>=</span><span>$(</span>generate_session_name<span>)</span>
</span></span><span><span>
</span></span><span><span><span># Validate inputs</span>
</span></span><span><span><span>if</span> <span>[[</span> -z <span>&#34;</span>$ACCOUNT_ID<span>&#34;</span> <span>||</span> -z <span>&#34;</span>$VIRTUAL_MFA<span>&#34;</span> <span>||</span> -z <span>&#34;</span>$EXTERNAL_ID<span>&#34;</span> <span>||</span> -z <span>&#34;</span>$ROLE_NAME<span>&#34;</span> <span>||</span> -z <span>&#34;</span>$MFA_CODE<span>&#34;</span> <span>]]</span>; <span>then</span>
</span></span><span><span>    print_usage
</span></span><span><span>    <span>return</span> <span>1</span>
</span></span><span><span><span>fi</span>
</span></span><span><span>
</span></span><span><span><span># Request temporary credentials for terraform admin</span>
</span></span><span><span>CREDENTIALS<span>=</span><span>$(</span>aws sts assume-role <span>\
</span></span></span><span><span><span></span>  --profile default <span>\
</span></span></span><span><span><span></span>  --role-arn arn:aws:iam::<span>${</span>ACCOUNT_ID<span>}</span>:role/<span>${</span>ROLE_NAME<span>}</span> <span>\
</span></span></span><span><span><span></span>  --duration <span>${</span>DURATION<span>}</span> <span>\
</span></span></span><span><span><span></span>  --role-session-name <span>${</span>SESSION_NAME<span>}</span> <span>\
</span></span></span><span><span><span></span>  --serial-number arn:aws:iam::<span>${</span>ACCOUNT_ID<span>}</span>:mfa/<span>${</span>VIRTUAL_MFA<span>}</span> <span>\
</span></span></span><span><span><span></span>  --external-id <span>${</span>EXTERNAL_ID<span>}</span> <span>\
</span></span></span><span><span><span></span>  --token-code <span>${</span>MFA_CODE<span>}</span> <span>\
</span></span></span><span><span><span></span>  --query <span>&#39;Credentials.[AccessKeyId,SecretAccessKey,SessionToken]&#39;</span> <span>\
</span></span></span><span><span><span></span>  --output text <span>\
</span></span></span><span><span><span></span>  2&gt;&amp;1<span>)</span>
</span></span><span><span>
</span></span><span><span><span># Handle error in assume-role call</span>
</span></span><span><span><span>if</span> <span>[</span> $? -ne <span>0</span> <span>]</span>; <span>then</span>
</span></span><span><span>    echo <span>&#34;Error: Failed to assume role&#34;</span> &gt;&amp;<span>2</span>
</span></span><span><span>    <span>return</span> <span>1</span>
</span></span><span><span><span>fi</span>
</span></span><span><span>
</span></span><span><span><span># Export the temporary credentials</span>
</span></span><span><span>read AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN <span>&lt;&lt;&lt;</span> $CREDENTIALS
</span></span><span><span>export AWS_ACCESS_KEY_ID<span>=</span><span>&#34;</span><span>${</span>AWS_ACCESS_KEY_ID<span>}</span><span>&#34;</span>
</span></span><span><span>export AWS_SECRET_ACCESS_KEY<span>=</span><span>&#34;</span><span>${</span>AWS_SECRET_ACCESS_KEY<span>}</span><span>&#34;</span>
</span></span><span><span>export AWS_SESSION_TOKEN<span>=</span><span>&#34;</span><span>${</span>AWS_SESSION_TOKEN<span>}</span><span>&#34;</span>
</span></span><span><span>
</span></span><span><span>print_final_message <span>${</span>DURATION<span>}</span> <span>${</span>ROLE_NAME<span>}</span>
</span></span></code></pre></div><p>You need to source the script, instead of running it the way you might normally do. This will make sure the exported environment remains after the script completes execution. That is important because the script is setting the environment variables for the Terraform client to use.</p><div><pre tabindex="0"><code data-lang="bash"><span><span>source get_tf_session.sh --aid <span>123</span> --eid a-test-password --role terraform-admin --mfa terraform-mfa --code <span>12345</span>
</span></span><span><span>...
</span></span><span><span>...
</span></span><span><span>terraform plan
</span></span></code></pre></div><p>Thats it! You should now be able to run terraform commands with the correct permissions from the privileged role, but only if you pro vide the correct MFA code.</p></div></div>
  </body>
</html>
