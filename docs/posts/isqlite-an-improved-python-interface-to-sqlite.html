<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://iafisher.com/blog/2021/10/isqlite">Original</a>
    <h1>isqlite: An improved Python interface to SQLite</h1>
    
    <div id="readability-page-1" class="page"><div class="page">
  
  

  <p>In <a href="https://iafisher.com/blog/2021/10/using-sqlite-effectively-in-python">last week&#39;s post</a>, I wrote about how to use SQLite effectively in Python. Since I use SQLite and Python in many of my personal projects, I wrote my own library that wraps Python&#39;s <code>sqlite3</code> module with a better API, support for schema migrations like in <a href="https://docs.djangoproject.com/en/3.2/topics/migrations/">Django</a>, and a command-line interface. I call it isqlite.</p>
<h2>Better Python API</h2>
<p>Python&#39;s standard <code>sqlite3</code> module was designed to be compliant with the DB-API 2.0 standard described in <a href="https://www.python.org/dev/peps/pep-0249/">PEP 249</a>. DB-API 2.0 is conservative in the operations it requires modules to implement. In particular, the API provides no help in constructing specific SQL statements, instead only exposing <code>execute</code> and <code>executemany</code> methods and requiring the library user to write all the SQL themselves.</p>
<p>I find SQL syntax difficult to remember, especially since <code>SELECT</code>, <code>INSERT</code>, <code>UPDATE</code>, and <code>DELETE</code> queries are all structured differently, so isqlite provides methods for common SQL operations:</p>
<div><pre><span></span><code><span>with</span> <span>Database</span><span>(</span><span>&#34;:memory:&#34;</span><span>)</span> <span>as</span> <span>db</span><span>:</span>
    <span># Create a new employee.</span>
    <span>db</span><span>.</span><span>insert</span><span>(</span><span>&#34;employees&#34;</span><span>,</span> <span>{</span><span>&#34;name&#34;</span><span>:</span> <span>&#34;John Doe&#34;</span><span>,</span> <span>&#34;title&#34;</span><span>:</span> <span>&#34;Software Engineer&#34;</span><span>})</span>

    <span># Fetch all managers.</span>
    <span>managers</span> <span>=</span> <span>db</span><span>.</span><span>select</span><span>(</span><span>&#34;employees&#34;</span><span>,</span> <span>where</span><span>=</span><span>&#34;title = &#39;Manager&#39;&#34;</span><span>)</span>
    <span># Return value is a list of OrderedDict objects.</span>
    <span>print</span><span>(</span><span>managers</span><span>[</span><span>0</span><span>][</span><span>&#34;name&#34;</span><span>])</span>

    <span># Set a holiday bonus for all employees with a certain tenure.</span>
    <span>db</span><span>.</span><span>update</span><span>(</span>
      <span>&#34;employees&#34;</span><span>,</span>
      <span>{</span><span>&#34;holiday_bonus&#34;</span><span>:</span> <span>500</span><span>},</span>
      <span>where</span><span>=</span><span>&#34;tenure &gt;= :tenure&#34;</span><span>,</span>
      <span>values</span><span>=</span><span>{</span><span>&#34;tenure&#34;</span><span>:</span> <span>MINIMUM_TENURE_FOR_BONUS</span><span>},</span>
    <span>)</span>
</code></pre></div>

<p>Instead of requiring you to call <code>fetchone</code> or <code>fetchall</code> to get the results of your queries, isqlite returns the rows directly, as <a href="https://docs.python.org/3/library/collections.html#collections.OrderedDict"><code>OrderedDict</code></a> objects instead of tuples to make them easier to use.</p>
<p>isqlite also has helper methods for common patterns (<code>get_by_pk</code>, <code>insert_and_get</code>, <code>get_or_insert</code>) and can automatically and efficiently fetch related rows using the <code>get_related</code> parameter:</p>
<div><pre><span></span><code><span>book</span> <span>=</span> <span>db</span><span>.</span><span>get_by_pk</span><span>(</span><span>&#34;books&#34;</span><span>,</span> <span>123</span><span>,</span> <span>get_related</span><span>=</span><span>[</span><span>&#34;author&#34;</span><span>])</span>
<span># Full author row has been fetched and embedded in the book object.</span>
<span>print</span><span>(</span><span>book</span><span>[</span><span>&#34;author&#34;</span><span>][</span><span>&#34;name&#34;</span><span>])</span>
</code></pre></div>

<p>If you need to drop into raw SQL, you can easily do so with the <code>Database.sql</code> method, which is a thin wrapper around <code>sqlite3.execute</code>.</p>
<h2>Schema migrations</h2>
<p>Where isqlite really shines is in its support for schema migrations. isqlite can take a schema written in Python, e.g.</p>
<div><pre><span></span><code><span>from</span> <span>isqlite</span> <span>import</span> <span>Schema</span><span>,</span> <span>Table</span><span>,</span> <span>columns</span>

<span>SCHEMA</span> <span>=</span> <span>Schema</span><span>(</span>
  <span>[</span>
    <span>Table</span><span>(</span>
      <span>&#34;authors&#34;</span><span>,</span>
      <span>[</span>
        <span>columns</span><span>.</span><span>text</span><span>(</span><span>&#34;first_name&#34;</span><span>),</span>
        <span>columns</span><span>.</span><span>text</span><span>(</span><span>&#34;last_name&#34;</span><span>),</span>
        <span>columns</span><span>.</span><span>text</span><span>(</span><span>&#34;country&#34;</span><span>,</span> <span>required</span><span>=</span><span>False</span><span>),</span>
      <span>],</span>
    <span>),</span>
    <span>Table</span><span>(</span>
      <span>&#34;books&#34;</span><span>,</span>
      <span>[</span>
        <span>columns</span><span>.</span><span>text</span><span>(</span><span>&#34;title&#34;</span><span>),</span>
        <span>columns</span><span>.</span><span>foreign_key</span><span>(</span><span>&#34;author&#34;</span><span>,</span> <span>foreign_table</span><span>=</span><span>&#34;authors&#34;</span><span>),</span>
      <span>],</span>
    <span>),</span>
  <span>]</span>
<span>)</span>
</code></pre></div>

<p>...diff the Python schema against the actual database schema, and run the SQL commands to make the two match. Migrating your database to a new schema is as easy as running <code>isqlite migrate path/to/db path/to/schema.py</code> and confirming the list of changes to be made. isqlite is able to detect renaming of columns and tables and reordering of columns within a table as well as adding and dropping columns.</p>
<p>There are a few reasons to write the schema in Python:</p>
<ul>
<li>Schema changes can be tracked by version control.</li>
<li>An explicit schema ensures that all deployments of the applications are using the same database schema.</li>
<li>Common patterns can be simplified with Python code, e.g. isqlite provides an <code>AutoTable</code> class that automatically creates a primary key column called <code>id</code> and <code>created_at</code> and <code>last_updated_at</code> timestamp columns. The <code>text_column</code> macro enforces that all <code>TEXT</code> columns must be non-null so that there is only one way to represent the absence of a value (the empty string).</li>
</ul>
<p>If you prefer, you can manually make schema alterations on the command-line with commands like <code>isqlite add-column</code> and <code>isqlite drop-table</code>. This does not require a Python schema.</p>
<h2>Odds and ends</h2>
<p>As mentioned in <a href="https://iafisher.com/blog/2021/10/using-sqlite-effectively-in-python">my previous post on SQLite</a>, SQLite disables foreign-key constraint enforcement by default. isqlite turns it back on.</p>
<p>isqlite handles SQL transactions in a straightforward manner. If you connect to the database in a <code>with</code> statement, a transaction is automatically opened and persists for the length of the <code>with</code> statement. The transaction will be committed at the end or rolled back if an exception occurred.</p>
<p>If you need more finely-grained control of transactions, you can use <code>Database.transaction</code> as a context manager:</p>
<div><pre><span></span><code><span>with</span> <span>Database</span><span>(</span><span>&#34;:memory:&#34;</span><span>,</span> <span>transaction</span><span>=</span><span>False</span><span>)</span> <span>as</span> <span>db</span><span>:</span>
    <span>with</span> <span>db</span><span>.</span><span>transaction</span><span>():</span>
        <span>...</span>

    <span>with</span> <span>db</span><span>.</span><span>transaction</span><span>():</span>
        <span>...</span>
</code></pre></div>

<p>isqlite turns on <a href="https://docs.python.org/3/library/sqlite3.html#converting-sqlite-values-to-custom-python-types">converters</a> so that SQL values are mapped to corresponding Python values where possible, and registers a few useful converters and adapters of its own for <code>datetime.time</code> and <code>decimal.Decimal</code> values.</p>
<h2>Uses</h2>
<p>isqlite is designed as a replacement for the built-in <code>sqlite3</code> module, not for a full-fledged ORM like <a href="https://www.sqlalchemy.org/">SQLAlchemy</a>. isqlite does not and will never support any database engine other than SQLite, which makes it less than suitable for, e.g., a realistic web application. However, it is a good fit for applications that <a href="https://sqlite.org/appfileformat.html">use SQLite as a file format</a>, for hobby projects that will never need a client-server database engine like Postgres, and for <em>ad hoc</em> database operations on the command-line.</p>
<p>If you&#39;d like to try isqlite out for yourself, you can install it with pip:</p>


<p>Comprehensive documentation is available online at <a href="https://isqlite.readthedocs.io/en/latest/">https://isqlite.readthedocs.io/en/latest/</a>, and bug reports and feature requests can be filed at <a href="https://github.com/iafisher/isqlite/issues">https://github.com/iafisher/isqlite/issues</a>. ∎</p>

  

  <hr/>
  <p><strong>Disclaimer:</strong> I occasionally make corrections and changes to posts after I publish them. You can view
    the full history of this post <a href="https://github.com/iafisher/blog/commits/master/2021-10-isqlite.md">on
    GitHub</a>.
  </p>
</div></div>
  </body>
</html>
