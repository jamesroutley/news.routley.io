<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tigerbeetle.com/blog/2023-07-11-we-put-a-distributed-database-in-the-browser/">Original</a>
    <h1>We put a distributed database in the browser and made a game of it</h1>
    
    <div id="readability-page-1" class="page"><div>
            <p>
              TigerBeetle is a distributed financial transactions database,
              designed for mission critical safety. How do you test something so
              critical? Well, we could tell you (and we will), but why not show
              you?
            </p>
            <p>
              <a href="https://sim.tigerbeetle.com">TLDR: You can now run TigerBeetle… compiled to
                WebAssembly… in your browser!</a>
              With perfect network conditions, then not-so-perfect
              Jepsen’esque conditions, and finally, with unprecedented
              (cosmic) levels of disk corruption.
            </p>
            <p>
              This is our take on
              <a href="https://pmg.csail.mit.edu/papers/vr-revisited.pdf">Viewstamped Replication</a>
              and
              <a href="https://www.usenix.org/system/files/conference/fast18/fast18-alagappan.pdf">Protocol-Aware Recovery for Consensus-Based Storage</a>. It’s running in a deterministic simulator (that can speed
              up time and replay scenarios for debugging velocity), compiled to
              WebAssembly thanks to Zig’s toolchain. And a graphical
              gaming frontend on top, for the kid in all of us.
            </p>
            <h2 id="a-deterministic-simulator-called-the-vopr">
              A Deterministic Simulator Called The VOPR
            </h2>
            <p>
              The Viewstamped Operation Replicator (VOPR) takes its name from
              the
              <a href="https://www.youtube.com/watch?v=iRsycWRQrc8">WOPR simulator in WarGames</a>, and was inspired by our love of fuzzing, by Dropbox’s
              <a href="https://dropbox.tech/infrastructure/-testing-our-new-sync-engine">Nucleus testing</a>, and by FoundationDB’s
              <a href="https://www.youtube.com/watch?v=4fFDFbi3toc">deterministic simulation testing</a>.
            </p>
            <p>
              The impetus behind the VOPR is that complex distributed systems
              bugs take time to find, and once found, might never be found
              again. Deterministic simulation testing solves this by combining a
              fuzzer with simulated time dilation and reproducible failures.
            </p>
            
            <p>
              The VOPR fuzzes many clusters of TigerBeetle replicas and clients
              interacting through TigerBeetle’s Viewstamped Replication
              consensus protocol (VSR), all in a single process on a
              developer’s machine. All I/O is mocked out: with a
              <a href="https://github.com/tigerbeetledb/tigerbeetle/blob/main/src/testing/packet_simulator.zig">network simulator</a>
              to simulate all kinds of network faults and latencies, and an
              in-memory
              <a href="https://github.com/tigerbeetledb/tigerbeetle/blob/main/src/testing/storage.zig">storage simulator</a>
              to simulate all kinds of storage faults and latencies.
            </p>
            <p>
              The VOPR can
              <a href="https://tigerbeetle.com/blog/2023-07-06-simulation-testing-for-liveness/">control the degree</a>
              to which faults are applied, the
              <a href="https://github.com/tigerbeetle/tigerbeetle/blob/main/docs/DESIGN.md#fault-models">kinds of faults</a>
              that are applied, and
              <a href="https://github.com/tigerbeetle/tigerbeetle/blob/803d30604f29266d1de733f4eee7410f5b9e1186/src/testing/cluster/state_checker.zig#L142-L169">verify linearizability</a>. And the
              <a href="https://github.com/tigerbeetledb/tigerbeetle/blob/main/src/simulator.zig">simulator</a>, with varying scenarios, is what you’re now seeing in your
              browser!
            </p>
            <h2 id="level-1-city-breeze">Level 1: City Breeze</h2>
            <p><img src="https://tigerbeetle.com/assets/sim-city-breeze.webp" alt="City Breeze"/></p>
            <p>
              In City Breeze, we simulate a perfect environment. No network
              partitions. No packet loss or replays. No crashes or disk
              corruption, and, of course, low latency network and disk I/O.
            </p>
            <p>
              Once the cluster has started up, clients (at the top of the
              screen) send new messages to the <em>primary</em>. The primary
              replicates these messages to the <em>backup</em> replicas (for
              durability), before replying back to the clients.
            </p>
            <p>
              You’ll see each replica’s <em>op number</em> (a serial
              identifier for each message) increase as messages are replicated
              to that replica, and the <em>commit number</em> increase as
              replicated messages are then
              <a href="https://github.com/tigerbeetle/tigerbeetle/blob/803d30604f29266d1de733f4eee7410f5b9e1186/src/state_machine.zig#L587-L619">executed through the business logic</a>.
            </p>
            <p>
              This is replication at its most optimal (and most intuitive). At
              least, if for safety you require data to be on more than one
              machine before committing a transaction with
              <a href="https://jepsen.io/consistency/models/strict-serializable">strict serializability</a>.
            </p>
            <p>
              In such an easy scenario, you’re unlikely to see a
              <em>view change</em> (where the cluster has to agree on a new
              replica as primary). That is, replica 0 will be primary and will
              likely stay primary the whole time.
            </p>
            <p>
              Again, this is real TigerBeetle code, running a cluster of
              ‘Beetles… in your browser!
            </p>
            <h2 id="level-2-red-desert">Level 2: Red Desert</h2>
            <p><img src="https://tigerbeetle.com/assets/sim-red-desert.webp" alt="Red Desert"/></p>
            <p>
              In the second level, things get real. We’re talking
              <a href="https://github.com/jepsen-io/jepsen">Jepsen</a>-level
              nemeses.
            </p>
            <p>
              We introduce high storage and network latency, process crashes,
              and a flaky network, but no disk corruption.
            </p>
            <p>
              You’re going to see <em>view changes</em> when the primary
              crashes or is partitioned, and VSR’s telltale round robin
              rotation of the new primary among replicas, until a new primary is
              established. This is in contrast to Raft, which elects a primary
              at random, but then suffers from the risk of (or increased latency
              to mitigate) dueling leaders.
            </p>
            <p>
              The committed op number will increase more slowly, as it takes the
              cluster longer to replicate messages in this more challenging
              environment—but that’s fine, because you can’t get
              much worse than this?
            </p>
            <p>
              Sure, we’re not yet injecting storage faults, but then
              formal proofs for protocols like Raft and Paxos assume that disks
              are perfect, and depend on this for correctness? After all, you
              can always run your database over RAID, right?
              <a href="https://www.usenix.org/legacy/events/fast08/tech/full_papers/krioukov/krioukov.pdf">Right</a>?
            </p>
            <p>
              If your distributed database was
              <a href="https://www.youtube.com/watch?v=_jfOk4L7CiY">designed before 2018</a>, you probably couldn’t have done much. The research
              <a href="https://www.usenix.org/system/files/conference/fast18/fast18-alagappan.pdf">didn’t exist</a>.
            </p>
            
            <h2 id="level-3-radioactive">Level 3: Radioactive</h2>
            <p><img src="https://tigerbeetle.com/assets/sim-radioactive.webp" alt="Radioactive"/></p>
            <p>
              The final level of SimTigerBeetle simulates catastrophic failure.
              Not just network and process faults but up to 8% corruption
              probability on the storage read path, and 9% corruption
              probability on the storage write path—for each replica! Again,
              this is something Jepsen (and most databases in general)
              don’t fully test for (or recover from yet).
            </p>
            <p>
              And this is astronomic failure. If a disk were corrupting 8% of
              data, you’d throw it away immediately. But this is a
              scenario TigerBeetle actually handles and recovers from.
            </p>
            <h2 id="the-matrix">The Matrix</h2>
            <p>
              With the VOPR, we’ve been able to explore and test
              TigerBeetle against huge state spaces in a short amount of time,
              by literally speeding up the passing of time within the simulation
              itself. Just like the Matrix.
            </p>
            <p>
              The VOPR is only
              <a href="https://www.youtube.com/watch?v=w3WYdYyjek4">one of the ways</a>
              we test TigerBeetle. But it is the biggest reason we’ve been
              able to build confidence in our system in such a short time.
            </p>
            <h2 id="evolution">Evolution</h2>
            <p>
              We started this project in July 2022, with Joran pitching a
              wireframe of the idea to illustrator
              <a href="https://twitter.com/joymachs">Joy Machs</a> and game
              developer
              <a href="https://twitter.com/captainhorst">Fabio Arnold</a>. We
              wanted an interactive demo to explain how TigerBeetle works.
              Simple enough for a child to watch, understand and get excited
              about.
            </p>
            <p>
              <img src="https://tigerbeetle.com/assets/sim-communication-sketch.webp" alt="Communication sketch"/>
            </p>
            <p>
              An early sketch of communication between replicas by Joy.
            </p>
            <p>
              Although Zig compiles easily to WebAssembly, WebAssembly is a
              32-bit architecture and TigerBeetle supports only 64-bit
              architectures. Getting the simulator’s memory usage below 2
              GiB (for the whole cluster!) was one of the challenges Fabio
              worked through to get this running in the browser.
            </p>
            <p>
              The graphics are rendered in WebGL with Fabio’s
              <a href="https://github.com/fabioarnold/nanovg-zig">port of nanovg to Zig</a>.
            </p>
            <p>
              <img src="https://tigerbeetle.com/assets/sim-level-sketch.webp" alt="Level sketch"/>
            </p>
            <p>An early sketch of a level by Joy.</p>
            <p>
              Joy Machs has been illustrating for the Zig communities since
              2021, beginning with
              <a href="https://youtu.be/4nVhByP-npU?t=367">the mascot, Suzie</a>. And he’s been working with TigerBeetle, since that same
              year, to tell our story through all the artwork you see
            </p>
            <h2 id="heres-to-the-pioneers">Here’s to the Pioneers</h2>
            <p>
              TigerBeetle takes cues from LMAX by Martin Thompson; storage fault
              research by Remzi and Andrea Arpaci-Dusseau at UW-Madison with
              Ramnatthan Alagappan and Aishwarya Ganesan; Viewstamped
              Replication by Brian M. Oki, Barbara Liskov, and James Cowling;
              and many others (check out
              <a href="https://github.com/tigerbeetledb/tigerbeetle/blob/main/docs/DESIGN.md#references">the full collection of papers</a>
              behind TigerBeetle).
            </p>
            <p>
              Finally, for all of you, who have inspired and encouraged us along
              the way—this is your game.
            </p>
            <h2 id="law-of-demos">Law of Demos</h2>
            <p>
              Can’t play the game?
              <a href="mailto:hi@tigerbeetle.com">Let us know</a>! In the
              meantime, we’ve got you covered — watch our recording of the
              game in action!
            </p>
            <figure>
              <p>
                <iframe allowfullscreen="true" frameborder="0" scrolling="no" src="https://www.youtube.com/embed/Vch4BWUVzMM"></iframe>
              </p>
            </figure>
            <p>
              <sup id="link-1">1</sup>
              <a href="https://www.youtube.com/watch?v=oeYBdghaIjc">https://www.youtube.com/watch?v=oeYBdghaIjc</a>
            </p>
            <blockquote>
              <p lang="en" dir="ltr">
                We put TigerBeetle in the browser — and made a game of it!<a href="https://t.co/F3rhcI7ReI">https://t.co/F3rhcI7ReI</a>
                <a href="https://t.co/54h0ZYziOH">pic.twitter.com/54h0ZYziOH</a>
              </p>
              — TigerBeetle (@TigerBeetleDB)
              <a href="https://twitter.com/TigerBeetleDB/status/1678736304060653568?ref_src=twsrc%5Etfw">July 11, 2023</a>
            </blockquote>
            
          </div></div>
  </body>
</html>
