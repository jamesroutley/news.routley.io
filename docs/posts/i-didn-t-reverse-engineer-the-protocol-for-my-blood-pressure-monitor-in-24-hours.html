<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://james.belchamber.com/articles/blood-pressure-monitor-reverse-engineering/">Original</a>
    <h1>I didn&#39;t reverse-engineer the protocol for my blood pressure monitor in 24 hours</h1>
    
    <div id="readability-page-1" class="page"><div>
            <div>
                
                <p>Yesterday after receiving my yearly flu vaccine at the pharmacy I was offered a blood pressure test, which reported a reading that made the young pharmacist who had just given me my vaccine a bit worried.</p>
<p>Off the back of this she offered me a 24 hour study, and then strapped a cuff to my arm plumbed into a little device which I had to wear in a little caddy - the cuff would inflate every 30 minutes during the day and every 60 minutes during the night, and then tomorrow I would bring it back for analysis.</p>
<p>&#34;Can I read the measurements?&#34; I asked, as it was being strapped to me.</p>
<p>&#34;Oh, no, that will just stress you out. We turn that off&#34;. Fair enough.</p>
<p>Thing is, this device had a little micro-USB port on the side.</p>
<p><img src="https://james.belchamber.com/articles/blood-pressure-monitor-reverse-engineering/images/revealing-the-port.jpg" alt="A blood pressure monitor with a flap being held back, revealing a micro-USB port"/></p><p>A blood pressure monitor with a flap being held back, revealing a micro-USB port</p>

<p>I had started researching the device - a <a href="https://www.microlife.com/professional-products/watchbp-o3/watchbp-o3-ambulatory-2g">Microlife WatchBP O3</a> - before I got out of the chemist, and once I&#39;d got back to the office I downloaded <a href="https://www.microlife.com/support/ambulatory-support">the software</a> that&#39;s freely available to interact with it, setting up a Bottles instance to run the software since I don&#39;t (knowingly) have a Windows machine within 100 metres of me.</p>
<p><img src="https://james.belchamber.com/articles/blood-pressure-monitor-reverse-engineering/images/installing-watchbp-analyzer-in-bottles.png" alt="Installing WatchBP Analyzer in Bottles"/></p><p>Installing WatchBP Analyzer in Bottles</p>
<p>Unfortunately it didn&#39;t seem to be able to access the device, and I had no clue why. In Linux it was just presenting as a standard <code>hidraw</code> device:</p>
<pre><code>[33301.736724] hid-generic 0003:04D9:B554.001E: hiddev96,hidraw1: USB HID v1.11 Device [USB HID UART Bridge] on usb-0000:c5:00.0-1/input0
</code></pre>
<p><em>Fine</em>, I&#39;ll install windows.</p>
<p><img src="https://james.belchamber.com/articles/blood-pressure-monitor-reverse-engineering/images/send-diagnostic-data-to-microsoft.png" alt="Microsoft wants my diagnostic data"/></p><p>Microsoft wants my diagnostic data</p>
<p>After dodging around Microsoft&#39;s idea of UX, and then forwarding the USB device to the VM (I used <a href="https://apps.gnome.org/en-GB/Boxes/">Gnome Boxes</a> for this, works nicely), I finally got to see WatchBP Analyzer with the data downloaded from the device.</p>
<p><img src="https://james.belchamber.com/articles/blood-pressure-monitor-reverse-engineering/images/watchbp-analyzer.png" alt="WatchBP Analyzer with my first three measurements"/></p><p>WatchBP Analyzer with my first three measurements</p>
<p>But I don&#39;t want to open a Virtual Machine running Windows to see this data, and anyway - I&#39;m pretty sure that reverse-engineering this will be good for my blood pressure.</p>

<p>Since I&#39;m running this in a Virtual Machine I can just rely on Wireshark in Linux to get the traffic between the host and the device. <code>usbmon</code> is already installed and we know that the device is on Bus 3, so we can select usbmon3 on startup and start capturing.</p>
<p><img src="https://james.belchamber.com/articles/blood-pressure-monitor-reverse-engineering/images/wireshark-initial.png" alt="Wireshark with the initial capture"/></p><p>Wireshark with the initial capture</p>
<p>I&#39;m very much out of my depth at this point but, being <a href="https://www.sciencefocus.com/science/could-i-land-a-plane-in-an-emergency">one of those who could land a plane in an emergency</a> (why would you talk yourself out of it?!) I decided to crack on regardless. I know that the interesting stuff is sent after I press &#34;Download&#34;, and I know that <em>something</em> in there is gonna say <em>&#34;my blood pressure is 137/113&#34;</em> - so let&#39;s look for that. Just convert to show bytes as decimal and..</p>
<p><img src="https://james.belchamber.com/articles/blood-pressure-monitor-reverse-engineering/images/hex-blood-pressure.png" alt="My blood pressure seems to be encoded in this packet"/></p><p>My blood pressure seems to be encoded in this packet</p>
<p>..that looks like a blood pressure! Let&#39;s copy that out as hex:</p>
<pre><code>05 0a 89 71 43 9b
</code></pre>
<p>I&#39;m not sure if this is &#34;valid&#34; HID Data (Wireshark seems convinced that only the first byte is the Vendor Data, with the rest being padding) but it seems like the data is being sent in 32-byte &#34;chunks&#34;, of which the first byte tells you the number of significant (SIG) following bits in the chunk (I deleted the rest - all zeroes - for clarity). The third byte is my <em>Systolic</em> blood Pressure (SYS), the fourth is my <em>Diastolic</em> blood pressure (DIA), and the fifth is my heart rate (HR) - no clue what the second or last byte is, but let&#39;s find all other bytes with my blood pressure in them (in decimal this time, because I can&#39;t read hex without help):</p>
<pre><code>SIG ??? SYS DIA  HR ??? ??? ???
  5  10 137 113  67 155
  5   0 132  86  68 155
  6   0 126  84  82 155  83
  6  10 128  80  61 155  83
  7   0 148  93  65 155  83  64
  7   0 121  92  74 155  83  94
  7   0 123  83  65 155  83  95
  7   0 123  79  78 155  83 129
</code></pre>
<p>Hmm. So we&#39;re still looking for the Oscillometric signal peak pressure (OPP)as well as some timestamps (we can calculate Mean arterial pressure - MAP - as <code>(2*DIA+SYS)/3</code>, according to <a href="https://www.microlife.com/support/software-professional-products/watchbp-analyzer-support">the manual</a>, and Pulse Pressure (PP) is just <code>SYS-DIA</code>). We can see the OPP in the packets that come after each of those above, but they don&#39;t seem to consistently come in on the same line:</p>
<pre><code> 10  82  195   80 *121    0    0    0    0    0    0
 10  82  223   80  *95    0    0    0    0    0    0
  9   1   80  *90    0    0    0    0    0    0
  9  35   80  *86    0    0    0    0    0    0
  8  80 *103    0    0    0    0    0    0
  8  80 *106    0    0    0    0    0    0
  8  80  *90    0    0    0    0    0    0
 10  80  *88    0    0    0    0    0    0   29  251
</code></pre>
<p>Oh. Maybe if I stick them together?</p>
<pre><code>??? SYS DIA  HR ??? ??? ??? ??? OPP ??? ??? ??? ??? ??? ??? ??? ???
 10 137 113  67 155  82 195  80 121   0   0   0   0   0   0
  0 132  86  68 155  82 223  80  95   0   0   0   0   0   0
  0 126  84  82 155  83   1  80  90   0   0   0   0   0   0
 10 128  80  61 155  83  35  80  86   0   0   0   0   0   0
  0 148  93  65 155  83  64  80 103   0   0   0   0   0   0
  0 121  92  74 155  83  94  80 106   0   0   0   0   0   0
  0 123  83  65 155  83  95  80  90   0   0   0   0   0   0
  0 123  79  78 155  83 129  80  88   0   0   0   0   0   0  29 251
</code></pre>
<p>Right, timestamps. I first guessed that the four populated contiguous bytes between <code>HR</code> and <code>OPP</code> are a 32-bit unix timestamp, but that would make the first one <code>9B52C350</code>; either <code>Jul 29 2052</code> or <code>Dec 08 2012</code> depending on which endianness the protocol is into. The 8 readings we have here are all from <code>November 10th</code>, at <code>11:03</code>, <code>11:31</code>, <code>12:01</code>, <code>12:35</code>, <code>13:00</code>, <code>13:30</code>, <code>13:31</code> and <code>14:01</code>, which isn&#39;t.. isn&#39;t that.</p>
<p>But note that the number in the 6th column flips from <code>82</code> to <code>83</code> when we switch from AM to PM - that&#39;s something, and when it does the 7th column resets. And hey - <code>1</code>, <code>35</code>, <code>64</code>, <code>94</code>, <code>95</code>.. that seems dangerously close to <code>12:01</code>, <code>12:35</code>, <code>13:00</code>, <code>13:30</code> and <code>13:31</code> if you were just to count the minutes. What&#39;s going on?</p>

<p>I tried feeding a lot of this into various Als (Kagi gives you access to a few with a nice interface) and I found that they mostly were stupid in ways that made me think. A few times I thought they had <em>&#34;cracked the case&#34;</em> but actually they just made me waste time. But they did remind me e.g. of endianness, so I did get a bit out of them.</p>
<p><img src="https://james.belchamber.com/articles/blood-pressure-monitor-reverse-engineering/images/hex-is-hard-for-llms.png" alt="Kimi K2 demonstrating creativity with numbers"/></p>
<p>I also spent quite a bit of time trying to write some Python that emulated the initial handshake and download button of the interface so that it could push out the data as a stream instead of me having to wrestle it out of Wireshark - again, Al had a habit of giving me incorrect code (although it did turn me on to <a href="https://pypi.org/project/hid/">pyhidapi</a>).</p>
<p>But ultimately I had a deadline, and I had to return the device even though I wanted to spend more time with it. Possibly for the best - while it did give me some reverse engineering practice (which it turns out I really enjoy), I should do some work instead of procrastinating.</p>
<p>My final lesson was a new word - <em>Normotension</em>, normal blood pressure - and a new phrase - <em>White Coat Hypertension</em>, the phenomena of high blood pressure in a clinical setting. Turns out that when you check someone&#39;s blood pressure after giving them an injection, it&#39;s higher than normal.</p>
<p>I don&#39;t think I&#39;d recommend getting your blood pressure tested after your next flu jab. But then, I&#39;m not a doctor.</p>

                <br/>
            </div>
            

        </div></div>
  </body>
</html>
