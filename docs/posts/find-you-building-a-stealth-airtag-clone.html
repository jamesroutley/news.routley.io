<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://positive.security/blog/find-you">Original</a>
    <h1>Find You: Building a stealth AirTag clone</h1>
    
    <div id="readability-page-1" class="page"><div><ul role="list"><li>After AirTags are reportedly used more and more frequently for malicious purposes, Apple has published a statement that lists its current and future efforts to prevent misuse</li><li>We built an AirTag clone that bypasses all those tracking protection features and confirmed it working in a real-world experiment (source code available <a href="https://github.com/positive-security/find-you">here</a>)</li><li>We encourage Apple to include AirTag clones/modified AirTags into their threat model when planning the next changes to the Find My ecosystem</li></ul><h2>Introduction</h2><p>Recently, reports about AirTags being used to track other people and their belongings were <a href="https://www.nytimes.com/2021/12/30/technology/apple-airtags-tracking-stalking.html">becoming</a> <a href="https://www.theguardian.com/technology/2022/jan/20/apple-airtags-stalking-complaints-technology">much</a> <a href="https://www.nbcnews.com/news/apple-airtag-showing-up-crimes-rcna9416">more</a> <a href="https://www.fox2detroit.com/news/man-finds-apple-air-tag-tracker-on-his-dodge-charger">frequent</a>.</p><p><a href="https://swimsuit.si.com/swimnews/brooks-nader-shares-scary-stalking-story-involving-an-air-tag">In one exemplary stalking case</a>, a fashion and fitness model discovered an AirTag in her coat pocket after having received a tracking warning notification from her iPhone. <a href="https://www.youtube.com/watch?v=WswKQxGOgWI">Other times</a>, AirTags were placed in expensive cars or motorbikes to track them from parking spots to their owner’s home, where they were then stolen.</p><p>On February 10, Apple addressed this by publishing <a href="https://www.apple.com/newsroom/2022/02/an-update-on-airtag-and-unwanted-tracking/">a news statement</a> titled “An update on AirTag and unwanted tracking” in which they describe the way they are currently trying to prevent AirTags and the Find My network from being misused and what they have planned for the future.</p><p>Admittedly, I might be slightly more familiar with AirTags than the average hacker (having <a href="https://positive.security/blog/send-my">designed</a> and <a href="https://github.com/positive-security/send-my">implemented</a> a communication protocol on top of Find My for arbitrary data transmission), but even so I was quite surprised, that when reading Apple’s statement I was able to immediately devise quite obvious bypass ideas for every current and upcoming protection measure mentioned in that relatively long list.</p><p>The following section will discuss each anti-stalking feature and how it can be bypassed in theory. Thereafter I will describe how I implemented those ideas to build a stealth AirTag and successfully tracked an iPhone user (with their consent of course) for over 5 days without triggering a tracking notification.</p><p>The goal of this blog post is to raise awareness of these issues to hopefully also guide future changes. In particular, Apple needs to incorporate non-genuine AirTags into their threat model, thus implementing security and anti-stalking features into the Find My protocol and ecosystem instead of in the AirTag itself, which <a href="https://www.vice.com/en/article/pkbpa7/hackers-are-having-a-field-day-with-airtags">can run modified firmware</a> or not be an AirTag at all (Apple devices currently have no way to distinguish genuine AirTags from clones via Bluetooth).</p><p>The source code used for the experiment can be found <a href="https://github.com/positive-security/find-you">here</a>.</p><h2>Table of Contents</h2><p>-- MARKDOWN --</p><h2>In Theory</h2><p>Let’s take a look at all of Apple’s (planned) tracking protection features and how we could bypass them with an <a href="https://github.com/seemoo-lab/openhaystack">OpenHaystack</a>-based AirTag clone.</p><h3>Current Features</h3><h4>Serial number</h4><p>From the news statement:</p><blockquote>“Every AirTag has a unique serial number, and paired AirTags are associated with an Apple ID. Apple can provide the paired account details in response to a subpoena or valid request from law enforcement. We have successfully partnered with them on cases where information we provided has been used to trace an AirTag back to the perpetrator”</blockquote><p>Why this does not affect our scenario:</p><ol role="list"><li>The microcontroller used to build the AirTag clone (e.g. an ESP32) does not have an AirTag serial number (neither in software nor on the hardware).</li><li>OpenHaystack-based clones are already not paired with an Apple ID (as this is not necessary as a result of the privacy-focused design).</li></ol><h4>Beeping</h4><p>Initially, an AirTag that has not been in Bluetooth reach of its paired Apple device for over 3 days started to beep. With an update in June 2021, Apple decreased this to a random time frame between 8 and 24 hours.</p><p>This one is easy: Our ESP32 does not even have a speaker. Furthermore the OpenHaystack firmware does not implement <a href="https://github.com/seemoo-lab/AirGuard/blob/1214230bd4b4059c5521068d6c96b6e21d8b07d2/app/src/main/java/de/seemoo/at_tracking_detection/util/ble/BluetoothLeService.kt#L113-L147">the BLE service to remotely trigger the sound</a>, so the “Play Sound”-button is not even shown.</p><p>As a side note, there is already a market for so-called “Silent AirTags” (modified AirTags that had their speaker removed/disconnected).</p><figure><a href="https://positive.security/#zoom" target="_blank"><p><img src="https://uploads-ssl.webflow.com/5f6498c074436c349716e747/6210d43c1cd882b7a2886558_find_you_silent_airtag_ebay.png" loading="lazy" alt=""/></p></a><figcaption>Searching for “silent airtag” on <a href="http://ebay.de">ebay.de</a> currently shows several options for AirTags with deactivated speakers</figcaption></figure><h4>iPhone notifications</h4><p>From the <a href="https://support.apple.com/en-us/HT212227">docs</a>:</p><blockquote>“If any AirTag, AirPods, or other Find My network accessory separated from its owner is seen moving with you over time, you&#39;ll be notified”</blockquote><p>Here, things are becoming more interesting. From the news reports linked in the beginning, this also seems to be the most common way unwanted AirTags are detected.</p><p>Here, we have an interesting and quite unique trade-off between privacy and... privacy:</p><ul role="list"><li>On the one hand, Apple wants AirTags to be indistinguishable from each other via Bluetooth to prevent identification of a specific AirTag over a longer period of time to thwart continuous tracking of specific AirTags (or iPhones, etc.) via a network of distributed Bluetooth receivers</li><li>On the other hand, Apple wants to identify specific AirTags over some period of time to distinguish between one AirTag traveling with the user (where it should send a notification), and the user walking through a busy area constantly receiving pings from different nearby AirTags (where it should not alert the user)</li></ul><p>By programming an AirTag (clone) to continuously broadcast new, never-seen-before public keys (just once per public key), we can simulate the second scenario with a single device.</p><p>For the below PoC/experiment, the AirTag clone was iterating over a list of 2000 preloaded public keys and sending 1 beacon per public key every 30s (more details in the next section).</p><h4>Android notifications</h4><p>With the initial launch of AirTags, besides the beeping there was no way for Android users to be notified of unwanted tracking devices traveling with them. In December 2021, Apple released an Android app called <a href="https://play.google.com/store/apps/details?id=com.apple.trackerdetect&amp;hl=en&amp;gl=US">Tracker Detect</a> that could be used to actively scan for nearby tracking devices.</p><figure><a href="https://positive.security/#zoom" target="_blank"><p><img src="https://uploads-ssl.webflow.com/5f6498c074436c349716e747/6210d4862c640bf558df6574_trackerdetect_scanning.png" loading="lazy" alt=""/></p></a></figure><p>This however has two issues:</p><ul role="list"><li>The app does not run in the background; an Android user would need to perform an active scan when they are close to the AirTag</li><li>In case the app tries to prevent false positives from a single received beacon from a passing Find My device, it is vulnerable to the same “1-beacon-per-public-key-attack” described above</li></ul><p>(There is also a (better) alternative app by the OpenHaystack team called AirGuard, which we will also discuss shortly in the next section)</p><h4>Side note: Apple ID needed to query location reports</h4><p>While OpenHaystack-based AirTag clones are not paired with an Apple ID, the retrieval of location reports requires authentication. Such an account however can be created anonymously using an email address without any identity/KYC-verification.</p><p>The OpenHaystack team currently <a href="https://github.com/seemoo-lab/openhaystack/issues/63#issuecomment-876196521">even considers running a server</a> that proxies those location report requests, which in the future might take away the need to create an account oneself.</p><h3>Upcoming features</h3><p>Let’s take a look at each item listed in the news statement’s “Advancements Coming” section:</p><h4>New privacy warnings during AirTag setup</h4><p>Irrelevant as it won’t deter criminals and is not seen when using OpenHaystack.</p><h4>Addressing alert issues for AirPods</h4><p>Irrelevant as it just changes the warning message content in case an alert is triggered by AirPods.</p><h4>Updated support documentation</h4><p>Irrelevant as it does not include any technical changes.</p><h4>Precision Finding</h4><p>Precision Finding requires Apple’s U1 Ultra Wideband chip in the tag. As the AirTag clone microcontroller does not include such an UWB chip, those simply can’t be found using Precision Finding.</p><h4>Display alert with sound</h4><blockquote>”When AirTag automatically emits a sound to alert anyone nearby of its presence and is detected moving with your iPhone, iPad, or iPod touch, we will also display an alert on your device that you can then take action on, like playing a sound or using Precision Finding, if available. This will help in cases where the AirTag may be in a location where it is hard to hear, or if the AirTag speaker has been tampered with.”</blockquote><p>This notification can simply be skipped in a clone implementation (as it’s currently the case with OpenHaystack).</p><h4>Refining unwanted tracking alert logic</h4><blockquote>“Our unwanted tracking alert system uses sophisticated logic to determine how we alert users. We plan to update our unwanted tracking alert system to notify users earlier that an unknown AirTag or Find My network accessory may be traveling with them.”</blockquote><p>This is very vague, but the most relevant point. The dilemma: if they don’t want to notify users every single time a location report is sent to Apple by their device, it will be hard to defend against constantly rotating public keys.</p><p>In any case, the conducted experiment shows that currently the tracking alert logic can be bypassed while still being able to track iPhone users.</p><h4>Tuning AirTag’s sound</h4><blockquote>“Currently, iOS users receiving an unwanted tracking alert can play a sound to help them find the unknown AirTag. We will be adjusting the tone sequence to use more of the loudest tones to make an unknown AirTag more easily findable.”</blockquote><p>This will only be helpful if already having received a tracking alert and does not apply to AirTag clones without a speaker.</p><h2>In Practice</h2><blockquote>&#34;In theory there is no difference between theory and practice. In practice there is.&#34;</blockquote><p>I decided to test my hypotheses (mainly on the single-use public keys) by building such a stealth AirTag and performing a real-world experiment.</p><h3>Test setup</h3><p>What we need:</p><ul role="list"><li>An ESP32, a power bank and a USB cable </li></ul><figure><a href="https://positive.security/#zoom" target="_blank"><p><img src="https://uploads-ssl.webflow.com/5f6498c074436c349716e747/6210d49ee841982a11997f36_custom2.jpeg" loading="lazy" alt=""/></p></a></figure><ul role="list"><li>A custom ESP32 firmware that constantly rotates public keys</li><li>A way to retrieve and display the decrypted location reports for each broadcasted public key</li></ul><p>For the experiment, I decided to pre-generate random key pairs on the correct elliptic curve and include the public keys in the firmware to be flashed. The corresponding private keys will be stored in an OpenHaystack-compatible .plist file. In theory, this allows using the vanilla (and even pre-compiled) OpenHaystack macOS client to import each possible public key as its own tag.</p><p>In practice, the client is not designed to handle thousands of tags (note that Apple is officially only allowing 16!), so I made a few changes to optimize for that use case (combining location report requests for different devices into a single HTTP request, skipping keychain operations, slightly optimizing a quadratic complexity operation).</p><p>The modified firmware and macOS retrieval application can be found at <a href="https://github.com/positive-security/find-you">https://github.com/positive-security/find-you</a>. The python script used for generating key pairs in the correct format has purposefully been omitted.</p><p>Some more notes/details:</p><ul role="list"><li>For the experiment, I chose to iterate through 2000 key pairs and send one beacon every 30 seconds (a public key will therefore be repeated every ~17 hours)</li><li>Instead of a finite list of keypairs, a common seed and derivation algorithm could be used on the AirTag clone and in the Mac application to generate a virtually never-repeating stream of keys</li><li>When using a irreversible derivation function and always overwriting the seed with the next round’s output, Apple or law enforcement could not retrieve the tag’s previously broadcasted public keys or discovered locations, even with physical access in case the device is discovered</li><li>The tracked person was using an iPhone with iOS 15.3.1 with <a href="https://support.apple.com/en-us/HT212227#unwantedtracking">all relevant settings configured</a> to receive Find My Safety Alerts</li><li>The stealth AirTag clone was with the tracked person for over 5 days, also when leaving their house</li></ul><figure><a href="https://positive.security/#zoom" target="_blank"><p><img src="https://uploads-ssl.webflow.com/5f6498c074436c349716e747/6210d4f35dbdb580005c33fa_custom1.jpeg" loading="lazy" alt=""/></p></a><figcaption>Previous prototype with a larger power bank (the logic analyzer just acts as a dummy load to hinder the power bank from turning off)</figcaption></figure><h3>Android detection</h3><h4>Tracker Detect</h4><p>Running Apple’s Tracker Detect’s active scan to search for Find My devices will not show the stealth AirTag at all, all the while location reports for the broadcasted public keys were uploaded and could be retrieved.</p><figure><a href="https://positive.security/#zoom" target="_blank"><p><img src="https://uploads-ssl.webflow.com/5f6498c074436c349716e747/6210d526dcfe49b5b949f446_screen_scan_nothing.png" loading="lazy" alt=""/></p></a><figcaption>No results when scanning for trackers right next to the stealth AirTag clone. Side note: In case a tracker was found, Tracker Detect apparently enforces a 15 minute cooldown in the app until a sound can be played on an AirTag</figcaption></figure><p>While not having investigated this more, the likely reason is that the app is waiting for multiple beacons with the same public key before the tag is shown in the UI.</p><h4>AirGuard</h4><p>First released in August 2021 (&gt;4 months before Tracker Detect) by SEEMOO, the TU Darmstadt lab also behind OpenHaystack, <a href="https://github.com/seemoo-lab/AirGuard">AirGuard</a> provides an alternative way to scan for nearby Find My devices.</p><p>The advantage is that, similar to Apple’s iOS implementation, the app also supports continuous scanning in background. However, this feature is also implemented in a way that requires multiple beacons with the same public key to trigger an alert, and therefore can also be bypassed with a “1-beacon-per-public-key”-AirTag:</p><blockquote>“Whenever a tracker gets detected multiple times the app will recognize this. It compares the locations where the tracker has been detected. If a tracker is detected at least 3 times and the locations have changed (to make sure [it&#39;s] not your neighbour) the app sends you a notification.”</blockquote><p>In contrast to Tracker Detect, AirGuard&#39;s “Manual Scan” feature however will show the stealth AirTag clone (as one new device per received beacon):</p><figure><a href="https://positive.security/#zoom" target="_blank"><p><img src="https://uploads-ssl.webflow.com/5f6498c074436c349716e747/6210d535d581843493b01e3f_airguard.png" loading="lazy" alt=""/></p></a><figcaption>The AirTag clone showing up as multiple devices (one device per beacon). Also note that the app does not provide the usual option to play a sound, as the AirTag clone does not offer <a href="https://github.com/seemoo-lab/AirGuard/blob/1214230bd4b4059c5521068d6c96b6e21d8b07d2/app/src/main/java/de/seemoo/at_tracking_detection/util/ble/BluetoothLeService.kt#L113-L147">this BLE GATT service</a>.</figcaption></figure><h3>iOS detection</h3><p>The stealth AirTag clone was passed to the tracked person on February 16 and continuously stayed with them until February 21. During this time frame, the person spent a lot of time at their home, but we could also track several trips outside (not shown below for privacy reasons).</p><figure><a href="https://positive.security/#zoom" target="_blank"><p><img src="https://uploads-ssl.webflow.com/5f6498c074436c349716e747/621262386f6e247facb29d85_OpenHaystack_tracking_overview.png" loading="lazy" alt=""/></p></a><figcaption>The modified macOS retrieval application running on an AWS instance and showing one device per broadcasted beacon</figcaption></figure><p>There is not much to say except that neither the tracked iPhone user, nor their iPhone-using roommate received any tracking alerts throughout that period. All the while, their iPhones were forwarding their location to Apple’s servers in a way that allowed me to retrieve and decrypt them.</p><p>Well, and the ESP32 obviously didn’t start to beep during that time.</p><h2>Closing Thoughts</h2><p>In the initially referenced news statement, Apple also writes:</p><blockquote>&#34;It’s why we innovated with the first-ever proactive system to alert you of unwanted tracking. We hope this starts an industry trend for others to also provide these sorts of proactive warnings in their products.”</blockquote><p>I find it quite funny how they promote having tracking alerts for a tracking system that they have brought to life in the first place. They introduced the first-ever system for easy, cheap, worldwide tracking into a world where “unwanted tracking has long been a societal problem”, applaud themselves for implementing broken anti-stalking features, and now coerce others into also implementing protection against the tracking network they have rolled out.</p><p>The main risk does not lie in the introduction of AirTags, but in the introduction of the Find My ecosystem that utilizes the customer’s devices to provide this Apple service. Since Apple in the current Find My design can’t limit its usage to only genuine AirTags (and official partner’s devices), they need to take into account the threats of custom-made, potentially malicious beacons that implement the Find My protocol (or AirTags with a modified firmware). With a power bank + ESP32 being cheaper than an AirTag, this might be an additional motivation for some to build a clone themselves instead.</p><p>With the system’s current design, it seems very difficult to technically distinguish one malicious AirTag clone with constant public key rotations continuously traveling with you from you passing by a few genuine AirTags in your day-to-day life.</p><p>While the unusual behavior of constantly receiving Find My beacons from seemingly different devices every time could be detected by implementing some more logic, this probably falls down when the AirTag clone is then sending data in random intervals and, in case it’s needed to trick the behavioral analysis, a few beacons multiple times.</p><p>When performing the tests, only the active scan mode of the 3rd-party app AirGuard was detecting the stealth AirTag clone. While we don’t encourage misuse, we hope that sharing this experiment will yield positive changes to the security and privacy of the Find My ecosystem.</p><p>‍</p></div></div>
  </body>
</html>
