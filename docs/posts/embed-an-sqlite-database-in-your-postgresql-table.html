<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/frectonz/pglite-fusion">Original</a>
    <h1>Show HN: Embed an SQLite database in your PostgreSQL table</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">Embed an SQLite database in your PostgreSQL table. AKA multitenancy has been solved.</p>

<p dir="auto">Run a PostgreSQL database that has <code>pglite-fusion</code> already installed.</p>
<div dir="auto" data-snippet-clipboard-copy-content="docker run --network=host frectonz/pglite-fusion"><pre>docker run --network=host frectonz/pglite-fusion</pre></div>
<p dir="auto">Connect to the PostgreSQL database using <code>psql</code>.</p>
<div dir="auto" data-snippet-clipboard-copy-content="psql postgresql://postgres@localhost:5432/"><pre>psql postgresql://postgres@localhost:5432/</pre></div>
<p dir="auto">Here&#39;s some demo usage.</p>
<div dir="auto" data-snippet-clipboard-copy-content="-- Load PG extension
CREATE EXTENSION pglite_fusion;

-- Create a table with an SQLite column
CREATE TABLE people (
    name     TEXT NOT NULL,
    database SQLITE DEFAULT execute_sqlite(
        empty_sqlite(),
        &#39;CREATE TABLE todos (task TEXT)&#39;
    )
);

-- Insert a row into the people table
INSERT INTO people VALUES (&#39;frectonz&#39;);

-- Create a todo for &#34;frectonz&#34;
UPDATE people
SET database = execute_sqlite(
    database,
    &#39;INSERT INTO todos VALUES (&#39;&#39;solve multitenancy&#39;&#39;)&#39;
)
WHERE name = &#39;frectonz&#39;;

-- Create a todo for &#34;frectonz&#34;
UPDATE people
SET database = execute_sqlite(
    database,
    &#39;INSERT INTO todos VALUES (&#39;&#39;buy milk&#39;&#39;)&#39;
)
WHERE name = &#39;frectonz&#39;;

-- Fetch frectonz&#39;s info
SELECT 
    name, 
    (
        SELECT json_agg(get_sqlite_text(sqlite_row, 0))
        FROM query_sqlite(
            database, 
            &#39;SELECT * FROM todos&#39;
        )
    ) AS todos
FROM 
    people 
WHERE 
    name = &#39;frectonz&#39;;"><pre><span><span>--</span> Load PG extension</span>
CREATE EXTENSION pglite_fusion;

<span><span>--</span> Create a table with an SQLite column</span>
<span>CREATE</span> <span>TABLE</span> <span>people</span> (
    name     <span>TEXT</span> <span>NOT NULL</span>,
    database SQLITE DEFAULT execute_sqlite(
        empty_sqlite(),
        <span><span>&#39;</span>CREATE TABLE todos (task TEXT)<span>&#39;</span></span>
    )
);

<span><span>--</span> Insert a row into the people table</span>
<span>INSERT INTO</span> people <span>VALUES</span> (<span><span>&#39;</span>frectonz<span>&#39;</span></span>);

<span><span>--</span> Create a todo for &#34;frectonz&#34;</span>
<span>UPDATE</span> people
<span>SET</span> database <span>=</span> execute_sqlite(
    database,
    <span><span>&#39;</span>INSERT INTO todos VALUES (<span>&#39;</span><span>&#39;</span>solve multitenancy<span>&#39;</span><span>&#39;</span>)<span>&#39;</span></span>
)
<span>WHERE</span> name <span>=</span> <span><span>&#39;</span>frectonz<span>&#39;</span></span>;

<span><span>--</span> Create a todo for &#34;frectonz&#34;</span>
<span>UPDATE</span> people
<span>SET</span> database <span>=</span> execute_sqlite(
    database,
    <span><span>&#39;</span>INSERT INTO todos VALUES (<span>&#39;</span><span>&#39;</span>buy milk<span>&#39;</span><span>&#39;</span>)<span>&#39;</span></span>
)
<span>WHERE</span> name <span>=</span> <span><span>&#39;</span>frectonz<span>&#39;</span></span>;

<span><span>--</span> Fetch frectonz&#39;s info</span>
<span>SELECT</span> 
    name, 
    (
        <span>SELECT</span> json_agg(get_sqlite_text(sqlite_row, <span>0</span>))
        <span>FROM</span> query_sqlite(
            database, 
            <span><span>&#39;</span>SELECT * FROM todos<span>&#39;</span></span>
        )
    ) <span>AS</span> todos
<span>FROM</span> 
    people 
<span>WHERE</span> 
    name <span>=</span> <span><span>&#39;</span>frectonz<span>&#39;</span></span>;</pre></div>

<div dir="auto" data-snippet-clipboard-copy-content="git clone git@github.com:frectonz/pglite-fusion.git 
cd pglite-fusion
nix develop
cargo pgrx init # this will take some time, since you will compiling postgres from source
cargo pgrx run # this will drop you into a psql repl, you can then follow the example shown above"><pre>git clone git@github.com:frectonz/pglite-fusion.git 
<span>cd</span> pglite-fusion
nix develop
cargo pgrx init <span><span>#</span> this will take some time, since you will compiling postgres from source</span>
cargo pgrx run <span><span>#</span> this will drop you into a psql repl, you can then follow the example shown above</span></pre></div>


<p dir="auto">Creates an empty SQLite database and returns it as a binary object. This can be used to initialize an empty SQLite database in a PostgreSQL column.</p>


<hr/>

<p dir="auto">Executes a SQL query on a SQLite database stored as a binary object and returns the result as a table of JSON-encoded rows. This function is useful for querying SQLite databases stored in PostgreSQL columns.</p>

<ul dir="auto">
<li><code>sqlite</code>: The SQLite database to query, stored as a binary object.</li>
<li><code>query</code>: The SQL query string to execute on the SQLite database.</li>
</ul>

<div dir="auto" data-snippet-clipboard-copy-content="SELECT * FROM query_sqlite(
    database, 
    &#39;SELECT * FROM todos&#39;
);"><pre><span>SELECT</span> <span>*</span> <span>FROM</span> query_sqlite(
    database, 
    <span><span>&#39;</span>SELECT * FROM todos<span>&#39;</span></span>
);</pre></div>
<hr/>

<p dir="auto">Executes a SQL statement (such as <code>INSERT</code>, <code>UPDATE</code>, or <code>DELETE</code>) on a SQLite database stored as a binary object. The updated SQLite database is returned as a binary object, allowing further operations on it.</p>

<ul dir="auto">
<li><code>sqlite</code>: The SQLite database to execute the SQL query on, stored as a binary object.</li>
<li><code>query</code>: The SQL statement to execute on the SQLite database.</li>
</ul>

<div dir="auto" data-snippet-clipboard-copy-content="UPDATE people
SET database = execute_sqlite(
    database,
    &#39;INSERT INTO todos VALUES (&#39;&#39;solve multitenancy&#39;&#39;)&#39;
)
WHERE name = &#39;frectonz&#39;;"><pre><span>UPDATE</span> people
<span>SET</span> database <span>=</span> execute_sqlite(
    database,
    <span><span>&#39;</span>INSERT INTO todos VALUES (<span>&#39;</span><span>&#39;</span>solve multitenancy<span>&#39;</span><span>&#39;</span>)<span>&#39;</span></span>
)
<span>WHERE</span> name <span>=</span> <span><span>&#39;</span>frectonz<span>&#39;</span></span>;</pre></div>
<hr/>

<p dir="auto">Extracts a text value from a specific column in a row returned by <code>query_sqlite</code>. Use this function to retrieve text values from query results.</p>

<ul dir="auto">
<li><code>sqlite_row</code>: A row from the results of <code>query_sqlite</code>.</li>
<li><code>index</code>: The index of the column to extract from the row.</li>
</ul>

<div dir="auto" data-snippet-clipboard-copy-content="SELECT get_sqlite_text(sqlite_row, 0) 
FROM query_sqlite(database, &#39;SELECT * FROM todos&#39;);"><pre><span>SELECT</span> get_sqlite_text(sqlite_row, <span>0</span>) 
<span>FROM</span> query_sqlite(database, <span><span>&#39;</span>SELECT * FROM todos<span>&#39;</span></span>);</pre></div>
<hr/>

<p dir="auto">Extracts an integer value from a specific column in a row returned by <code>query_sqlite</code>. Use this function to retrieve integer values from query results.</p>

<ul dir="auto">
<li><code>sqlite_row</code>: A row from the results of <code>query_sqlite</code>.</li>
<li><code>index</code>: The index of the column to extract from the row.</li>
</ul>

<div dir="auto" data-snippet-clipboard-copy-content="SELECT get_sqlite_integer(sqlite_row, 1) 
FROM query_sqlite(database, &#39;SELECT * FROM todos&#39;);"><pre><span>SELECT</span> get_sqlite_integer(sqlite_row, <span>1</span>) 
<span>FROM</span> query_sqlite(database, <span><span>&#39;</span>SELECT * FROM todos<span>&#39;</span></span>);</pre></div>
<hr/>

<p dir="auto">Extracts a real (floating-point) value from a specific column in a row returned by <code>query_sqlite</code>. Use this function to retrieve real number values from query results.</p>

<ul dir="auto">
<li><code>sqlite_row</code>: A row from the results of <code>query_sqlite</code>.</li>
<li><code>index</code>: The index of the column to extract from the row.</li>
</ul>

<div dir="auto" data-snippet-clipboard-copy-content="SELECT get_sqlite_real(sqlite_row, 2) 
FROM query_sqlite(database, &#39;SELECT * FROM todos&#39;);"><pre><span>SELECT</span> get_sqlite_real(sqlite_row, <span>2</span>) 
<span>FROM</span> query_sqlite(database, <span><span>&#39;</span>SELECT * FROM todos<span>&#39;</span></span>);</pre></div>
</article></div></div>
  </body>
</html>
