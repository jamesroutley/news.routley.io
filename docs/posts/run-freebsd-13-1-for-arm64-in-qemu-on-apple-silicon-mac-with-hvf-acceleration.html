<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://gist.github.com/ctsrc/a1f57933a2cde9abc0f07be12889f97f">Original</a>
    <h1>Run FreeBSD 13.1 for ARM64 in QEMU on Apple Silicon Mac with HVF Acceleration</h1>
    
    <div id="readability-page-1" class="page"><p>
    Guide: Run FreeBSD 13.1-RELEASE for ARM64 in QEMU on Apple Silicon Mac (MacBook Pro M1, etc) with HVF acceleration (Hypervisor.framework)
  </p><div>
  <div id="file-readme-md">
      
      <div id="file-readme-md-readme">
    <article itemprop="text">
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://raw.githubusercontent.com/ctsrc/ctsrc/01b8bc95d6b0a4a432712a471eb3ab208efd2ace/ef3d7019735ad9cb8d3af35aa91dfdec7674aa4b.png"><img src="https://raw.githubusercontent.com/ctsrc/ctsrc/01b8bc95d6b0a4a432712a471eb3ab208efd2ace/ef3d7019735ad9cb8d3af35aa91dfdec7674aa4b.png" alt="FreeBSD 13.1-RELEASE for ARM64 boot in QEMU on Apple Silicon Mac screenshot"/></a></p>
<p dir="auto">This guide was adapted from <a href="https://gist.github.com/niw/e4313b9c14e968764a52375da41b4278#running-ubuntu-server-for-arm64">https://gist.github.com/niw/e4313b9c14e968764a52375da41b4278#running-ubuntu-server-for-arm64</a></p>
<h2 dir="auto"><a id="user-content-running-freebsd-131-release-for-arm64" aria-hidden="true" href="#running-freebsd-131-release-for-arm64"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Running FreeBSD 13.1-RELEASE for ARM64</h2>
<ol dir="auto">
<li>
<p dir="auto">Install Xcode from App Store or install Command Line Tools on your Mac running on Apple Silicon.</p>
<pre><code>xcode-select --install
</code></pre>
</li>
<li>
<p dir="auto">Install Homebrew and QEMU.</p>
<p dir="auto"><a href="https://brew.sh/" rel="nofollow">https://brew.sh/</a></p>


<div><pre>qemu-system-aarch64 --version</pre></div>
<pre lang="text"><code>QEMU emulator version 7.0.0
Copyright (c) 2003-2022 Fabrice Bellard and the QEMU Project developers
</code></pre>
</li>
<li>
<p dir="auto">Download pre-build EDK II OVMF EFI image for QEMU.</p>
<p dir="auto">This EFI image is built from <code>stable202011</code> tag with additional resolutions in <code>QemuRamfb.c</code>.</p>
<p dir="auto"><a href="https://gist.github.com/niw/4f1f9bb572f40d406866f23b3127919b/raw/f546faea68f4149c06cca88fa67ace07a3758268/QEMU_EFI-cb438b9-edk2-stable202011-with-extra-resolutions.tar.gz">https://gist.github.com/niw/4f1f9bb572f40d406866f23b3127919b/raw/f546faea68f4149c06cca88fa67ace07a3758268/QEMU_EFI-cb438b9-edk2-stable202011-with-extra-resolutions.tar.gz</a></p>
<p dir="auto">To build it from the source code for adding more resolutions, see the following section.</p>
</li>
<li>
<p dir="auto">Prepare pflash for non-volatile variable store, such as screen resolution.</p>
<pre><code>mkdir ~/qemu-vm/
cd ~/qemu-vm/
tar xvf ~/Downloads/QEMU_EFI-cb438b9-edk2-stable202011-with-extra-resolutions.tar.gz
dd if=/dev/zero of=pflash0.img bs=1m count=64
dd if=/dev/zero of=pflash1.img bs=1m count=64
dd if=QEMU_EFI.fd of=pflash0.img conv=notrunc
dd if=QEMU_VARS.fd of=pflash1.img conv=notrunc
</code></pre>
<ul dir="auto">
<li>This step is optional, you can use <code>-bios QEMU_EFI.fd</code> instead of <code>-drive ...if=pflash</code> lines in the next step,
but in that case, any changes in EFI will not be persistent.</li>
</ul>
</li>
<li>
<p dir="auto">Download FreeBSD 13.1-RELEASE for ARM64 raw VM image xz-compressed file</p>
<p dir="auto"><a href="https://ftp2.uk.freebsd.org/pub/FreeBSD/releases/VM-IMAGES/13.1-RELEASE/aarch64/Latest/FreeBSD-13.1-RELEASE-arm64-aarch64.raw.xz" rel="nofollow">https://ftp2.uk.freebsd.org/pub/FreeBSD/releases/VM-IMAGES/13.1-RELEASE/aarch64/Latest/FreeBSD-13.1-RELEASE-arm64-aarch64.raw.xz</a></p>
<p dir="auto">(See <a href="https://docs.freebsd.org/en/books/handbook/mirrors/" rel="nofollow">https://docs.freebsd.org/en/books/handbook/mirrors/</a> for a list of mirrors to choose from.)</p>
</li>
<li>
<p dir="auto">Decompress xz-compressed file, keeping a copy of the original compressed file</p>
<p dir="auto">Keeping a copy of the original file is convenient because then you can use it if you want to create additional VMs later. Just be careful not to overwrite the image of your first VM when you want to make a second VM though :P</p>
<pre><code>mv ~/Downloads/FreeBSD-13.1-RELEASE-arm64-aarch64.raw.xz .
unxz -k FreeBSD-13.1-RELEASE-arm64-aarch64.raw.xz
</code></pre>
</li>
<li>
<p dir="auto">Grow the disk image</p>
<p dir="auto">After you&#39;ve decompressed the disk image, it&#39;ll be about 5 GiB in size. Depending on what you plan to do the amount of available space may be a bit on the low side. Let&#39;s grow the disk image by another 30 GiB.</p>
<pre><code>qemu-img resize -f raw FreeBSD-13.1-RELEASE-arm64-aarch64.raw +30G
</code></pre>
<p dir="auto">By performing this resize <em>before</em> you boot the VM for the first time, FreeBSD will automatically adjust the partition size during first boot.</p>
</li>
<li>
<p dir="auto">Run your FreeBSD 13.1-RELEASE for ARM64 VM</p>
<pre><code>qemu-system-aarch64 \
  -M virt \
  -accel hvf \
  -cpu host \
  -smp 4 \
  -m 4096 \
  -drive file=pflash0.img,format=raw,if=pflash,readonly=on \
  -drive file=pflash1.img,format=raw,if=pflash \
  -device virtio-gpu-pci \
  -display default,show-cursor=on \
  -device qemu-xhci \
  -device usb-kbd \
  -device usb-tablet \
  -device intel-hda \
  -device hda-duplex \
  -drive file=FreeBSD-13.1-RELEASE-arm64-aarch64.raw,format=raw,if=virtio,cache=writethrough \
  -nographic \
  -serial mon:stdio
</code></pre>
</li>
</ol>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://raw.githubusercontent.com/ctsrc/ctsrc/01b8bc95d6b0a4a432712a471eb3ab208efd2ace/467816f73fc23f12b9fd3bb5edeaa34dbd11e70b.png"><img src="https://raw.githubusercontent.com/ctsrc/ctsrc/01b8bc95d6b0a4a432712a471eb3ab208efd2ace/467816f73fc23f12b9fd3bb5edeaa34dbd11e70b.png" alt="A screenshot of FreeBSD 13.1-RELEASE for ARM64 console in QEMU on Apple Silicon Mac, showing the output of uname -a"/></a>
<a target="_blank" rel="noopener noreferrer" href="https://raw.githubusercontent.com/ctsrc/ctsrc/01b8bc95d6b0a4a432712a471eb3ab208efd2ace/c1c5d3bc3202d816215ee0612ef0b24fa3ca745e.png"><img src="https://raw.githubusercontent.com/ctsrc/ctsrc/01b8bc95d6b0a4a432712a471eb3ab208efd2ace/c1c5d3bc3202d816215ee0612ef0b24fa3ca745e.png" alt="Another screenshot of FreeBSD 13.1-RELEASE for ARM64 console in QEMU on Apple Silicon Mac, this time showing that networking is working and is able to connect over HTTP to the website www.example.com"/></a></p>
<h2 dir="auto"><a id="user-content-sysbench-cpu-benchmark-comparison" aria-hidden="true" href="#sysbench-cpu-benchmark-comparison"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><code>sysbench</code> CPU benchmark comparison</h2>
<h3 dir="auto"><a id="user-content-running-natively-in-macos-monterey-version-125-21g72-on-macbook-pro-13-inch-m1-2020" aria-hidden="true" href="#running-natively-in-macos-monterey-version-125-21g72-on-macbook-pro-13-inch-m1-2020"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Running natively in macOS Monterey Version 12.5 (21G72) on MacBook Pro (13-inch, M1, 2020)</h3>
<p dir="auto">(Installed via Homebrew.)</p>
<p dir="auto"><strong>Events per second: 25,445,903.16</strong>  or ~25.4 Mio events/sec</p>
<div><pre>sysbench cpu --threads=2 run</pre></div>
<pre lang="text"><code>sysbench 1.0.20 (using system LuaJIT 2.1.0-beta3)

Running the test with following options:
Number of threads: 2
Initializing random number generator from current time


Prime numbers limit: 10000

Initializing worker threads...

Threads started!

CPU speed:
    events per second: 25445903.16

General statistics:
    total time:                          10.0000s
    total number of events:              254468472

Latency (ms):
         min:                                    0.00
         avg:                                    0.00
         max:                                    0.12
         95th percentile:                        0.00
         sum:                                 8916.15

Threads fairness:
    events (avg/stddev):           127234236.0000/15768.00
    execution time (avg/stddev):   4.4581/0.00
</code></pre>
<h3 dir="auto"><a id="user-content-running-in-freebsd-131-release-for-arm64-in-qemu-on-macbook-pro-13-inch-m1-2020" aria-hidden="true" href="#running-in-freebsd-131-release-for-arm64-in-qemu-on-macbook-pro-13-inch-m1-2020"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Running in FreeBSD 13.1-RELEASE for ARM64 in QEMU on MacBook Pro (13-inch, M1, 2020)</h3>
<p dir="auto">(Installed via FreeBSD ports.)</p>
<p dir="auto"><strong>Events per second: 15,467,914.47</strong> or ~15.5 Mio events/sec</p>
<div><pre>sysbench cpu --threads=2 run</pre></div>
<pre lang="text"><code>sysbench 1.0.20 (using system LuaJIT 2.1.0-beta3)

Running the test with following options:
Number of threads: 2
Initializing random number generator from current time


Prime numbers limit: 10000

Initializing worker threads...

Threads started!

CPU speed:
    events per second: 15467914.47

General statistics:
    total time:                          10.0003s
    total number of events:              154689213

Latency (ms):
         min:                                    0.00
         avg:                                    0.00
         max:                                    0.21
         95th percentile:                        0.00
         sum:                                 5684.03

Threads fairness:
    events (avg/stddev):           77344606.5000/169564.50
    execution time (avg/stddev):   2.8420/0.00
</code></pre>
</article>
  </div>

  </div>
</div></div>
  </body>
</html>
