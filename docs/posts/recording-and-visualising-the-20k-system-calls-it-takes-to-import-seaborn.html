<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://blog.mattstuchlik.com/2024/02/16/counting-syscalls-in-python.html">Original</a>
    <h1>Recording and visualising the 20k system calls it takes to &#34;import seaborn&#34;</h1>
    
    <div id="readability-page-1" class="page"><div aria-label="Content">
      <div>
        <article itemscope="" itemtype="http://schema.org/BlogPosting">

  

  <div itemprop="articleBody">
    <p>Last time we <a href="http://blog.mattstuchlik.com/2024/02/08/counting-cpu-instructions-in-python.html">counted CPU
instructions</a>,
let’s look at <a href="https://en.wikipedia.org/wiki/System_call">syscalls</a> now!</p>

<p>I’ll show you a little tiny tool I added to
<a href="https://github.com/s7nfo/Cirron">Cirron</a> that lets you see exactly what
syscalls a piece of Python code is calling and how to analyze the trace more effectively.</p>

<p>Let’s start with <code>print(&#34;Hello&#34;)</code> as before:</p>
<div><div><pre><code><span>from</span> <span>cirron</span> <span>import</span> <span>Tracer</span>

<span>t</span> <span>=</span> <span>Tracer</span><span>()</span>

<span>t</span><span>.</span><span>start</span><span>()</span>
<span>print</span><span>(</span><span>&#34;Hello&#34;</span><span>)</span>
<span>trace</span> <span>=</span> <span>t</span><span>.</span><span>end</span><span>()</span>

<span>print</span><span>(</span><span>trace</span><span>)</span>
<span># write(1, &#34;Hello\n&#34;, 6) = 6 &lt;0.000150s&gt;
</span></code></pre></div></div>

<p>You can see<sup id="fnref:0" role="doc-noteref"><a href="#fn:0" rel="footnote">1</a></sup> <code>print</code> uses only a single
<a href="https://man7.org/linux/man-pages/man2/write.2.html">write</a> to write the string
<code>&#34;Hello\n&#34;</code> to stdout (that’s what the <code>1</code> stands for) and asks it to write at
most <code>6</code> bytes. Write then returns <code>6</code>, meaning it managed to write all the
bytes we asked it to. You can also see it took 0.00015s or 150μs (that’s just the
<code>write</code> call, not the whole <code>print</code> statement).</p>

<p>Pretty cool!</p>

<p>How does <code>Tracer</code> work? I initially wanted to use the
<a href="https://man7.org/linux/man-pages/man2/ptrace.2.html">ptrace</a> syscall to
implement it, but that turned out to be a little more complicated that what I
wanted, so in the end I just used the <code>strace</code> tool, which also uses <code>ptrace</code>
but handles all the complexity. <code>Tracer</code> simply <a href="https://github.com/s7nfo/Cirron/blob/master/cirron/tracer.py#L138">starts tracing
itself</a> with
it, redirecting output to a file, which is then parsed when it’s asked to stop.</p>

<p>Let’s trace <code>import seaborn</code> now:</p>
<div><div><pre><code><span>from</span> <span>cirron</span> <span>import</span> <span>Tracer</span>

<span>t</span> <span>=</span> <span>Tracer</span><span>()</span>

<span>t</span><span>.</span><span>start</span><span>()</span>
<span>import</span> <span>seaborn</span>
<span>trace</span> <span>=</span> <span>t</span><span>.</span><span>end</span><span>()</span>

<span>print</span><span>(</span><span>len</span><span>(</span><span>trace</span><span>))</span>
<span># 20462
</span></code></pre></div></div>

<p>Turns out importing Seaborn takes ~20k syscalls! That’s obviously too many to
just print out, so what’s a better way to analyze what it’s doing?</p>

<h2 id="visualizing-traces-with-perfetto">Visualizing traces with Perfetto</h2>

<p><a href="https://ui.perfetto.dev">Perfetto Trace Viewer</a> let’s you visualize all kinds
of traces. It can’t ingest <code>strace</code> output directly, but I’ve included a
function that converts Tracer output to <a href="https://docs.google.com/document/d/1CvAClvFfyA5R-PhYUmn5OOQtYMH4h6I0nSsKchNAySU/preview">Trace Event
Format</a>,
something Perfetto can load:</p>

<div><div><pre><code><span>from</span> <span>cirron</span> <span>import</span> <span>to_tef</span>

<span>(...)</span>

<span>open</span><span>(</span><span>&#34;/tmp/trace&#34;</span><span>,</span> <span>&#34;w&#34;</span><span>).</span><span>write</span><span>(</span><span>to_tef</span><span>(</span><span>trace</span><span>))</span>
</code></pre></div></div>



<p>This gets you a file you can open with Perfetto. I’m not going to describe all it can do; I uploaded a trace of <code>import seaborn</code> <a href="https://gist.github.com/s7nfo/4cda90818a07d851fea79c8c17e8eab8">here</a>, go <a href="https://ui.perfetto.dev/">play with it</a>!</p>



<p><img src="http://blog.mattstuchlik.com/assets/perfetto.png" alt="Perfetto"/></p>



<p>I was surprised to find it uses 4 threads, which mostly spend time looking up files and reading them, but one of the threads seems to be very curious about your CPU details!</p>



  </div>
</article>

      </div>
    </div></div>
  </body>
</html>
