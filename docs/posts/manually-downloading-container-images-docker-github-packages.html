<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tech.michaelaltfield.net/2024/09/03/container-download-curl-wget/">Original</a>
    <h1>Manually Downloading Container Images (Docker, Github Packages)</h1>
    
    <div id="readability-page-1" class="page"><div><p>This article will describe how to download an image from a (docker) container registry.</p>
<p><a href="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/container-download-curl-wget_featuredImage1.jpg"><img decoding="async" fetchpriority="high" src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_featuredImage1.jpg.pagespeed.ic.a2V6BtJ0d1.jpg" alt="Manual Download of Container Images with wget and curl" width="1200" height="628" srcset="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_featuredImage1.jpg.pagespeed.ic.a2V6BtJ0d1.jpg 1200w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_featuredImage1-300x157.jpg.pagespeed.ic.OJWnlIxgYA.jpg 300w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_featuredImage1-1024x536.jpg.pagespeed.ic.MzW1T79wmC.jpg 1024w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_featuredImage1-768x402.jpg.pagespeed.ic.TzjDOfeHrP.jpg 768w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_featuredImage1-150x79.jpg.pagespeed.ic.36aD52b1lk.jpg 150w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_featuredImage1-400x209.jpg.pagespeed.ic.mHvYNEAV9s.jpg 400w" sizes="(max-width: 1200px) 100vw, 1200px"/></a></p>

<p>Remember the good &#39;ol days when you could just download software by visiting a website and click &#34;download&#34;?</p>
<p>Even <code>apt</code> and <code>yum</code> repositories were just simple HTTP servers that you could just <code>curl</code> (or <code>wget</code>) from. Using the package manager was, of course, more secure and convenient -- but you could always just download packages manually, if you wanted.</p>
<p>But <strong>have you ever tried to <code>curl</code> an image from a container registry</strong>, such as docker? Well friends, I have tried. And I have the <a href="https://github.com/BusKill/buskill-app/issues/78#issuecomment-1987374445">scars</a> to prove it.</p>
<p>It was a remarkably complex process that took me weeks to figure-out. Lucky you, this article will break it down.</p>
<h2>Examples</h2>
<p>Specifically, we&#39;ll look at how to download files from two OCI registries.</p>
<ol>
<li><a href="#docker-hub">Docker Hub</a></li>
<li><a href="#github-packages">GitHub Packages</a></li>
</ol>
<h2>Terms</h2>
<p>First, here&#39;s some terminology used by OCI</p>
<ol>
<li>OCI - <a href="#what-oci">Open Container Initiative</a></li>
<li>blob - A &#34;blob&#34; in the OCI spec just means a file</li>
<li>manifest - A &#34;manifest&#34; in the OCI spec means a list of files</li>
</ol>
<h2>Prerequisites</h2>
<p>This guide was written in 2024, and it uses the following software and versions:</p>
<ol>
<li>debian 12 (bookworm)</li>
<li>curl 7.88.1</li>
<li>OCI Distribution Spec v1.1.0 (which, unintuitively, uses the &#39;<a href="https://github.com/distribution/distribution/blob/5e75227fb213162564bab74b146300ffed9f0bbd/docs/content/spec/api.md">/v2/</a>&#39; endpoint)</li>
</ol>
<p>Of course, you&#39;ll need &#39;<code>curl</code>&#39; installed. And, to parse json, &#39;<code>jq</code>&#39; too.</p>
<pre title="">sudo apt-get install curl jq
</pre>
<h2 id="what-oci">What is OCI?</h2>
<p>OCI stands for Open Container Initiative.</p>
<p>OCI was <a href="https://opencontainers.org/about/overview/">originally formed</a> in June 2015 for Docker and CoreOS. Today it&#39;s a wider, general-purpose (and annoyingly complex) way that many projects host files (that are extremely non-trivial to download).</p>
<p>One does not simply download a file from an OCI-complianet container registry. You must:</p>
<ol>
<li>Generate an authentication token for the API</li>
<li>Make an API call to the registry, requesting to download a JSON &#34;Manifest&#34;</li>
<li>Parse the JSON Manifest to figure out the hash of the file that you want</li>
<li>Determine the download URL from the hash</li>
<li>Download the file (which might actually be many distinct file &#34;layers&#34;)</li>
</ol>
<p><a href="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/container-download-curl-wget_one-does-not-simply1.jpg"><img decoding="async" src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_one-does-not-simply1.jpg.pagespeed.ic.dqHglfs-oy.jpg" alt="One does not simply download from a container registry" width="1452" height="708" srcset="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_one-does-not-simply1.jpg.pagespeed.ic.dqHglfs-oy.jpg 1452w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_one-does-not-simply1-300x146.jpg.pagespeed.ic.QJOjZntppR.jpg 300w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_one-does-not-simply1-1024x499.jpg.pagespeed.ic.3x-2r3GKyQ.jpg 1024w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_one-does-not-simply1-768x374.jpg.pagespeed.ic.NFv9OS69AM.jpg 768w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_one-does-not-simply1-150x73.jpg.pagespeed.ic.VTBPOo7qyN.jpg 150w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_one-does-not-simply1-400x195.jpg.pagespeed.ic.3grXZeNBtI.jpg 400w" sizes="(max-width: 1452px) 100vw, 1452px"/></a></p>
<p>In order to figure out how to make an API call to the registry, you must first read (and understand) the OCI specs <a href="https://opencontainers.org/release-notices/overview/">here</a>.</p>
<ul>
<li><a href="https://opencontainers.org/release-notices/overview/">https://opencontainers.org/release-notices/overview/</a></li>
</ul>
<h2>OCI APIs</h2>
<p>OCI maintains three distinct specifications:</p>
<ol>
<li>image spec</li>
<li>runtime spec</li>
<li>distribution spec</li>
</ol>
<h3>OCI &#34;Distribution Spec&#34; API</h3>
<p>To figure out how to download a file from a container registry, we&#39;re interested in the &#34;distribution spec&#34;. At the time of writing, the latest &#34;distribution spec&#34; can be downloaded <a href="https://github.com/opencontainers/distribution-spec/releases/download/v1.1.0/oci-distribution-spec-v1.1.0.pdf">here</a>:</p>
<ul>
<li><a href="https://github.com/opencontainers/distribution-spec/releases/tag/v1.1.0">https://github.com/opencontainers/distribution-spec/releases/tag/v1.1.0</a></li>
<li><a href="https://github.com/opencontainers/distribution-spec/releases/download/v1.1.0/oci-distribution-spec-v1.1.0.pdf">https://github.com/opencontainers/distribution-spec/releases/download/v1.1.0/oci-distribution-spec-v1.1.0.pdf</a></li>
</ul>
<p>The above PDF file defines a set of API endpoints that we can use to query, parse, and then figure out how to download a file from a container registry. The table from the above PDF is copied below:</p>
<table id="table">
<colgroup>
<col/>
<col/>
<col/>
<col/>
<col/>
</colgroup>
<thead>
<tr>
<th>ID</th>
<th>Method</th>
<th>API Endpoint</th>
<th>Success</th>
<th>Failure</th>
</tr>
</thead>
<tbody>
<tr>
<td>end-1</td>
<td><code>GET</code></td>
<td><code>/v2/</code></td>
<td><code>200</code></td>
<td><code>404</code>/<code>401</code></td>
</tr>
<tr>
<td>end-2</td>
<td><code>GET</code> / <code>HEAD</code></td>
<td><code>/v2/&lt;name&gt;/blobs/&lt;digest&gt;</code></td>
<td><code>200</code></td>
<td><code>404</code></td>
</tr>
<tr>
<td>end-3</td>
<td><code>GET</code> / <code>HEAD</code></td>
<td><code>/v2/&lt;name&gt;/manifests/&lt;reference&gt;</code></td>
<td><code>200</code></td>
<td><code>404</code></td>
</tr>
<tr>
<td>end-4a</td>
<td><code>POST</code></td>
<td><code>/v2/&lt;name&gt;/blobs/uploads/</code></td>
<td><code>202</code></td>
<td><code>404</code></td>
</tr>
<tr>
<td>end-4b</td>
<td><code>POST</code></td>
<td><code>/v2/&lt;name&gt;/blobs/uploads/?digest=&lt;digest&gt;</code></td>
<td><code>201</code>/<code>202</code></td>
<td><code>404</code>/<code>400</code></td>
</tr>
<tr>
<td>end-5</td>
<td><code>PATCH</code></td>
<td><code>/v2/&lt;name&gt;/blobs/uploads/&lt;reference&gt;</code></td>
<td><code>202</code></td>
<td><code>404</code>/<code>416</code></td>
</tr>
<tr>
<td>end-6</td>
<td><code>PUT</code></td>
<td><code>/v2/&lt;name&gt;/blobs/uploads/&lt;reference&gt;?digest=&lt;digest&gt;</code></td>
<td><code>201</code></td>
<td><code>404</code>/<code>400</code></td>
</tr>
<tr>
<td>end-7</td>
<td><code>PUT</code></td>
<td><code>/v2/&lt;name&gt;/manifests/&lt;reference&gt;</code></td>
<td><code>201</code></td>
<td><code>404</code></td>
</tr>
<tr>
<td>end-8a</td>
<td><code>GET</code></td>
<td><code>/v2/&lt;name&gt;/tags/list</code></td>
<td><code>200</code></td>
<td><code>404</code></td>
</tr>
<tr>
<td>end-8b</td>
<td><code>GET</code></td>
<td><code>/v2/&lt;name&gt;/tags/list?n=&lt;integer&gt;&amp;last=&lt;integer&gt;</code></td>
<td><code>200</code></td>
<td><code>404</code></td>
</tr>
<tr>
<td>end-9</td>
<td><code>DELETE</code></td>
<td><code>/v2/&lt;name&gt;/manifests/&lt;reference&gt;</code></td>
<td><code>202</code></td>
<td><code>404</code>/<code>400</code>/<code>405</code></td>
</tr>
<tr>
<td>end-10</td>
<td><code>DELETE</code></td>
<td><code>/v2/&lt;name&gt;/blobs/&lt;digest&gt;</code></td>
<td><code>202</code></td>
<td><code>404</code>/<code>405</code></td>
</tr>
<tr>
<td>end-11</td>
<td><code>POST</code></td>
<td><code>/v2/&lt;name&gt;/blobs/uploads/?mount=&lt;digest&gt;&amp;from=&lt;other_name&gt;</code></td>
<td><code>201</code></td>
<td><code>404</code></td>
</tr>
<tr>
<td>end-12a</td>
<td><code>GET</code></td>
<td><code>/v2/&lt;name&gt;/referrers/&lt;digest&gt;</code></td>
<td><code>200</code></td>
<td><code>404</code>/<code>400</code></td>
</tr>
<tr>
<td>end-12b</td>
<td><code>GET</code></td>
<td><code>/v2/&lt;name&gt;/referrers/&lt;digest&gt;?artifactType=&lt;artifactType&gt;</code></td>
<td><code>200</code></td>
<td><code>404</code>/<code>400</code></td>
</tr>
<tr>
<td>end-13</td>
<td><code>GET</code></td>
<td><code>/v2/&lt;name&gt;/blobs/uploads/&lt;reference&gt;</code></td>
<td><code>204</code></td>
<td><code>404</code></td>
</tr>
</tbody>
</table>
<p>In OCI, files are (cryptically) called &#34;<code>blobs</code>&#34;. In order to figure out the file that we want to download, we must first reference the list of files (called a &#34;<code>manifest</code>&#34;).</p>
<p>The above table shows us how we can download a list of files (manifest) and then download the actual file (blob).</p>

<p>Let&#39;s look at how to download files from a couple different OCI registries:</p>
<ol>
<li><a href="#docker-hub">Docker Hub</a></li>
<li><a href="#github-packages">GitHub Packages</a></li>
</ol>
<h2 id="docker-hub">Docker Hub</h2>
<p>Probably the most well-known OCI registry is <a href="https://hub.docker.com">Docker Hub</a>. Indeed, as stated above, Docker was one of the original founding members of OCI, and they contributed the original specifications and implementations of the OCI runtime and image specifications.</p>
<p>In this example, we&#39;ll manually download the official docker image for <a href="https://github.com/varnish/docker-hitch/">hitch</a>, and then we&#39;ll manually import it into docker.</p>
<h3>Determine Package Name</h3>
<p>The easiest way to figure out a given docker image&#39;s namespace is to use the WUI: <a href="https://hub.docker.com">hub.docker.com</a>.</p>
<p>After loading the above page, just type the package name (in our case &#39;<code>hitch</code>&#39;) into the search bar.</p>

		
		

<p>It might be difficult to determine which is the official author of the docker image that you want to download, as many third party providers may provide an image of similar or identical name.</p>
<p>If the official project documentation doesn&#39;t explicitly link to the official listing on Docker Hub, it may be a good idea to contact the developer to confirm which account is publishing their official docker releases (and then open a ticket or PR to update the docs with this info). In any case, you should never expect the files downloaded from Docker Hub to be authentic, even if you confirmed the namespace to be correct -- because <a href="#3tofu">Docker infamously lacks authentication</a> of everything that it downloads by default.</p>
<p>The namespace of the repository for a given package in Docker Hub is typically &#39;<code>library/&lt;package_name&gt;</code>&#39;. So, for &#39;<code>hitch</code>&#39;, <strong>our namespace is going to be &#39;<code>library/hitch</code>&#39;</strong>.</p>
<h3>Determine Package Tag</h3>
<p>Click on the &#34;Tags&#34; tab to view all of the tags available for the image.</p>

		
		

<p>In our case, <strong>we&#39;ll use the latest version at the time of writing, which is &#39;<code>1.8.0-1</code>&#39;</strong></p>
<h3>Get an Auth Token</h3>
<p>Execute the following command to get an <a href="https://distribution.github.io/distribution/spec/auth/oauth/">authentication token</a> from Docker Hub within the scope of the &#39;<code>hitch</code>&#39; package&#39;s namespace.</p>
<pre title=""># get a JSON with an anonymous token
curl -so &#34;token.json&#34; &#34;https://auth.docker.io/token?service=registry.docker.io&amp;scope=&lt;resourcetype&gt;:&lt;component&gt;/&lt;component&gt;:&lt;action&gt;&#34;;

# extract token from JSON
token=$(cat token.json | jq -jr &#34;.token&#34;)
</pre>
<blockquote><p>
â“˜ INFO: If you&#39;re like me and wondering where the heck is the OCI spec that defines this `<code>/token</code>` endpoint for authentication, know that <a href="https://github.com/opencontainers/distribution-spec/issues/240">it doesn&#39;t exist</a> ðŸ¤¦</p>
<p>To learn more about the syntax of this URL and &#39;<code>scope</code>&#39; GET variable, see docker&#39;s <a href="https://distribution.github.io/distribution/spec/auth/scope/">Token Scope Documentation</a>.
</p></blockquote>
<p>The above commands will get a free/temporary token that you can use in subsequent API calls. If all went well, there will be no output from these commands. Here&#39;s an example execution</p>
<pre title="">user@disp7456:~$ curl -so &#34;token.json&#34; &#34;https://auth.docker.io/token?service=registry.docker.io&amp;scope=repository:library/hitch:pull&#34;;
user@disp7456:~$ 

user@disp7456:~$ token=$(cat token.json | jq -jr &#34;.token&#34;)
user@disp7456:~$ 
</pre>
<h3>List the Tags</h3>
<p>We can list all of the available tags for the &#39;<code>hitch</code>&#39; package with the &#39;<code>GET /v2/&lt;name&gt;/tags/list</code>&#39; API endpoint, as shown in the <a href="#table">table</a> above</p>
<pre title="">curl -i -H &#34;Authorization: Bearer ${token}&#34; https://registry-1.docker.io/v2/library/&lt;package_name&gt;/tags/list
</pre>
<p>Here&#39;s an example execution. Note that it affirms the existence of the &#39;<code>1.8.0-1</code>&#39; tag that we found above.</p>
<pre title="">user@disp7456:~$ curl -i -H &#34;Authorization: Bearer ${token}&#34; https://registry-1.docker.io/v2/library/hitch/tags/list
HTTP/1.1 200 OK
content-type: application/json
docker-distribution-api-version: registry/2.0
date: Tue, 04 Jun 2024 21:11:33 GMT
content-length: 131
strict-transport-security: max-age=31536000

{&#34;name&#34;:&#34;library/hitch&#34;,&#34;tags&#34;:[&#34;1&#34;,&#34;1.7&#34;,&#34;1.7.0&#34;,&#34;1.7.0-1&#34;,&#34;1.7.2&#34;,&#34;1.7.2-1&#34;,&#34;1.7.3&#34;,&#34;1.7.3-1&#34;,&#34;1.8&#34;,&#34;1.8.0&#34;,&#34;1.8.0-1&#34;,&#34;latest&#34;]}
user@disp7456:~$ 
</pre>
<h3>Download the Manifest</h3>
<p>We can download the manifest for the &#39;<code>1.8.0-1</code>&#39; tag of the &#39;<code>hitch</code>&#39; package with the &#39;<code>GET /v2/&lt;name&gt;/manifests/&lt;reference&gt;</code>&#39; API endpoint, as shown in the <a href="#table">table</a> above</p>
<pre title="">curl -o manifest.json -s -H &#34;Authorization: Bearer ${token}&#34; https://registry-1.docker.io/v2/library/&lt;package_name&gt;/manifests/&lt;tag&gt;
</pre>
<p>And here&#39;s an example execution that downloads the manifest for the &#39;<code>1.8.0-1</code>&#39; tag of the &#39;<code>hitch</code>&#39; package</p>
<pre title="">

user@disp7456:~$ curl -o manifest.json -s -H &#34;Authorization: Bearer ${token}&#34; https://registry-1.docker.io/v2/library/hitch/manifests/1.8.0-1
user@disp7456:~$ 

user@disp7456:~$ ls
manifest.json
user@disp7456:~$ 
</pre>
<h3>Parse the Manifest</h3>
<p>The previous step downloaded a file named &#39;<code>manifest.json</code>&#39;. This &#39;<code>manifest.json</code>&#39; file lists all of the &#34;layers&#34; that make up the image of the &#39;<code>hitch</code>&#39; package.</p>
<p>Each &#34;layer&#34; consists of a tarball and some metadata about the layer in json format. The information that we need to download the layer&#39;s tar file is located in the &#39;<code>manifest.json</code>&#39; file. And the metadata about each layer is also in the &#39;<code>manifest.json</code>&#39; file.</p>
<p>The format of the &#39;<code>manifest.json</code>&#39; file is &#39;<code>vnd.docker.distribution.manifest.v1+json</code>&#39;, which is defined in <a href="https://github.com/distribution/distribution/blob/bf9f80eaffb0eabc768762bc4ff03ded277ea594/docs/spec/manifest-v2-1.md">Image Manifest Version 2, Schema 1</a>.</p>
<p>Most importantly, the &#39;<code>manifest.json</code>&#39; file contains two <a href="https://en.wikipedia.org/wiki/Parallel_array">parallel arrays</a> of the same length:</p>
<ol>
<li>fsLayers[]</li>
<li>history[]</li>
</ol>
<p>Consider this truncated snippet of the manifest for the &#39;<code>hitch</code>&#39; package&#39;s &#39;<code>1.8.0-1</code>&#39; tag:</p>
<pre title="">{
   &#34;schemaVersion&#34;: 1,
   &#34;name&#34;: &#34;library/hitch&#34;,
   &#34;tag&#34;: &#34;1.8.0-1&#34;,
   &#34;architecture&#34;: &#34;amd64&#34;,
   &#34;fsLayers&#34;: [
      {
         &#34;blobSum&#34;: &#34;sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4&#34;
      },
      {
         &#34;blobSum&#34;: &#34;sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4&#34;
      },
      {
         &#34;blobSum&#34;: &#34;sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4&#34;
      },
      {
         &#34;blobSum&#34;: &#34;sha256:3148f4af0a813bcff0a3ed2562aabfb1b596b52ef36eb5eb4d82ce836350b73a&#34;
      },
      {
         &#34;blobSum&#34;: &#34;sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4&#34;
      },
      {
         &#34;blobSum&#34;: &#34;sha256:a0e9543db8c1238572466cf00b55436bc7b7e849f7cb305128f391a94b75c2fc&#34;
      },
      {
         &#34;blobSum&#34;: &#34;sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4&#34;
      },
      {
         &#34;blobSum&#34;: &#34;sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4&#34;
      },
      {
         &#34;blobSum&#34;: &#34;sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4&#34;
      },
      {
         &#34;blobSum&#34;: &#34;sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4&#34;
      },
      {
         &#34;blobSum&#34;: &#34;sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4&#34;
      },
      {
         &#34;blobSum&#34;: &#34;sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4&#34;
      },
      {
         &#34;blobSum&#34;: &#34;sha256:728328ac3bde9b85225b1f0d60f5c149f5635a191f5d8eaeeb00e095d36ef9fd&#34;
      }
   ],
   &#34;history&#34;: [
      {
         &#34;v1Compatibility&#34;: &#34;{\&#34;architecture\&#34;:\&#34;amd64\&#34;,\&#34;config\&#34;:{\&#34;Hostname\&#34;:\&#34;\&#34;,\&#34;Domainname\&#34;:\&#34;\&#34;,\&#34;User\&#34;:\&#34;\&#34;,\&#34;AttachStdin\&#34;:false,\&#34;AttachStdout\&#34;:false,\&#34;AttachStderr\&#34;:false,\&#34;ExposedPorts\&#34;:{\&#34;443/tcp\&#34;:{}},\&#34;Tty\&#34;:false,\&#34;OpenStdin\&#34;:false,\&#34;StdinOnce\&#34;:false,\&#34;Env\&#34;:[\&#34;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\&#34;],\&#34;Cmd\&#34;:[],\&#34;Image\&#34;:\&#34;sha256:996009c7d7eb032c9ea750e5decc1f8aedbf4530b892cf4ebc7716e1458f36d9\&#34;,\&#34;Volumes\&#34;:null,\&#34;WorkingDir\&#34;:\&#34;/etc/hitch\&#34;,\&#34;Entrypoint\&#34;:[\&#34;docker-hitch-entrypoint\&#34;],\&#34;OnBuild\&#34;:null,\&#34;Labels\&#34;:null},\&#34;container\&#34;:\&#34;0ff54ee96c4bbfe77da3b2124720ef95c6154d3bc1d3e40a168920dd818367c4\&#34;,\&#34;container_config\&#34;:{\&#34;Hostname\&#34;:\&#34;0ff54ee96c4b\&#34;,\&#34;Domainname\&#34;:\&#34;\&#34;,\&#34;User\&#34;:\&#34;\&#34;,\&#34;AttachStdin\&#34;:false,\&#34;AttachStdout\&#34;:false,\&#34;AttachStderr\&#34;:false,\&#34;ExposedPorts\&#34;:{\&#34;443/tcp\&#34;:{}},\&#34;Tty\&#34;:false,\&#34;OpenStdin\&#34;:false,\&#34;StdinOnce\&#34;:false,\&#34;Env\&#34;:[\&#34;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\&#34;],\&#34;Cmd\&#34;:[\&#34;/bin/sh\&#34;,\&#34;-c\&#34;,\&#34;#(nop) \&#34;,\&#34;CMD []\&#34;],\&#34;Image\&#34;:\&#34;sha256:996009c7d7eb032c9ea750e5decc1f8aedbf4530b892cf4ebc7716e1458f36d9\&#34;,\&#34;Volumes\&#34;:null,\&#34;WorkingDir\&#34;:\&#34;/etc/hitch\&#34;,\&#34;Entrypoint\&#34;:[\&#34;docker-hitch-entrypoint\&#34;],\&#34;OnBuild\&#34;:null,\&#34;Labels\&#34;:{}},\&#34;created\&#34;:\&#34;2024-05-14T05:23:11.666992342Z\&#34;,\&#34;docker_version\&#34;:\&#34;20.10.23\&#34;,\&#34;id\&#34;:\&#34;6703605aae83084affcafb4abcc7c556f0e436c4992ae224f1f58e88242328cb\&#34;,\&#34;os\&#34;:\&#34;linux\&#34;,\&#34;parent\&#34;:\&#34;c48ca3d95161bbcdfcaa2e016a675965d55f4f06147ef4445c69347c5965f188\&#34;,\&#34;throwaway\&#34;:true}&#34;
      },
      {
         &#34;v1Compatibility&#34;: &#34;{\&#34;id\&#34;:\&#34;c48ca3d95161bbcdfcaa2e016a675965d55f4f06147ef4445c69347c5965f188\&#34;,\&#34;parent\&#34;:\&#34;1d2af5a156bbc461d98824c2f6bfe295327d4419105c0b7f88f14cb28d0bb240\&#34;,\&#34;created\&#34;:\&#34;2024-05-14T05:23:11.581588417Z\&#34;,\&#34;container_config\&#34;:{\&#34;Cmd\&#34;:[\&#34;/bin/sh -c #(nop)  EXPOSE 443\&#34;]},\&#34;throwaway\&#34;:true}&#34;
      },
      {
         &#34;v1Compatibility&#34;: &#34;{\&#34;id\&#34;:\&#34;1d2af5a156bbc461d98824c2f6bfe295327d4419105c0b7f88f14cb28d0bb240\&#34;,\&#34;parent\&#34;:\&#34;8f914c821cbe154cc6677bceb043669e4295ad5cfb6409efa9c2ec1beba75fad\&#34;,\&#34;created\&#34;:\&#34;2024-05-14T05:23:11.489285564Z\&#34;,\&#34;container_config\&#34;:{\&#34;Cmd\&#34;:[\&#34;/bin/sh -c #(nop)  ENTRYPOINT [\\\&#34;docker-hitch-entrypoint\\\&#34;]\&#34;]},\&#34;throwaway\&#34;:true}&#34;
      },
      {
         &#34;v1Compatibility&#34;: &#34;{\&#34;id\&#34;:\&#34;8f914c821cbe154cc6677bceb043669e4295ad5cfb6409efa9c2ec1beba75fad\&#34;,\&#34;parent\&#34;:\&#34;a8d8314458142ee2a4ebccb19f48b6f9c696100103c3d49cbbe7ecd2575120e5\&#34;,\&#34;created\&#34;:\&#34;2024-05-14T05:23:11.403178706Z\&#34;,\&#34;container_config\&#34;:{\&#34;Cmd\&#34;:[\&#34;/bin/sh -c #(nop) COPY file:1abf3c94dce5dc9f6617dc8d36a6fe6f4f7236189d4819f16cefb54288e80e0d in /usr/local/bin/ \&#34;]}}&#34;
      },
      {
         &#34;v1Compatibility&#34;: &#34;{\&#34;id\&#34;:\&#34;a8d8314458142ee2a4ebccb19f48b6f9c696100103c3d49cbbe7ecd2575120e5\&#34;,\&#34;parent\&#34;:\&#34;5a78b0e89bbae2390b83e60174ae1efc583f766eff7dffaffa747ccb67472d0f\&#34;,\&#34;created\&#34;:\&#34;2024-05-14T05:23:11.304477182Z\&#34;,\&#34;container_config\&#34;:{\&#34;Cmd\&#34;:[\&#34;/bin/sh -c #(nop) WORKDIR /etc/hitch\&#34;]},\&#34;throwaway\&#34;:true}&#34;
      },
      {
         &#34;v1Compatibility&#34;: &#34;{\&#34;id\&#34;:\&#34;5a78b0e89bbae2390b83e60174ae1efc583f766eff7dffaffa747ccb67472d0f\&#34;,\&#34;parent\&#34;:\&#34;5a12a2c67ff9b5bfad288a4ede18d08c259c301efb85403d08a40ea2ad0eb1f8\&#34;,\&#34;created\&#34;:\&#34;2024-05-14T05:23:11.160227264Z\&#34;,\&#34;container_config\&#34;:{\&#34;Cmd\&#34;:[\&#34;|5 DISTVER=bullseye PKGCOMMIT=f12ab7958bc4885f3f00311cbca5103d9e6ba794 PKGVER=1 SHASUM=62b3554d668c9d17382415db10898bf661ee76343e4ee364f904457efda6cb1eeee7cb81d7a3897734024812b64b1c0e2dc305605706d81a0c1f6030508bf7e2 SRCVER=1.8.0 /bin/sh -c set -ex;     BASE_PKGS=\\\&#34;apt-utils curl dirmngr dpkg-dev debhelper devscripts equivs fakeroot git gnupg pkg-config\\\&#34;;     export DEBIAN_FRONTEND=noninteractive;     export DEBCONF_NONINTERACTIVE_SEEN=true;     tmpdir=\\\&#34;$(mktemp -d)\\\&#34;;     cd \\\&#34;$tmpdir\\\&#34;;     apt-get update;     apt-get install -y --no-install-recommends $BASE_PKGS;     git clone https://github.com/varnish/pkg-hitch.git;     cd pkg-hitch;     git checkout ${PKGCOMMIT};     rm -rf .git;     curl -Lf https://hitch-tls.org/source/hitch-${SRCVER}.tar.gz -o $tmpdir/orig.tgz;     echo \\\&#34;${SHASUM}  $tmpdir/orig.tgz\\\&#34; | sha512sum -c -;     tar xavf $tmpdir/orig.tgz --strip 1;     sed -i         -e \\\&#34;s/@SRCVER@/${SRCVER}/g\\\&#34;         -e \\\&#34;s/@PKGVER@/${PKGVER:-1}/g\\\&#34;         -e \\\&#34;s/@DISTVER@/$DISTVER/g\\\&#34; debian/changelog;     mk-build-deps --install --tool=\\\&#34;apt-get -o Debug::pkgProblemResolver=yes --yes\\\&#34; debian/control;     sed -i &#39;&#39; debian/hitch*;     dpkg-buildpackage -us -uc -j\\\&#34;$(nproc)\\\&#34;;     apt-get -y purge --auto-remove hitch-build-deps $BASE_PKGS;     apt-get -y --no-install-recommends install ../*.deb;     sed -i &#39;s/daemon = on/daemon = off/&#39; /etc/hitch/hitch.conf;     rm -rf /var/lib/apt/lists/* \\\&#34;$tmpdir\\\&#34;\&#34;]}}&#34;
      },
      {
         &#34;v1Compatibility&#34;: &#34;{\&#34;id\&#34;:\&#34;5a12a2c67ff9b5bfad288a4ede18d08c259c301efb85403d08a40ea2ad0eb1f8\&#34;,\&#34;parent\&#34;:\&#34;c03ad9230005f64133de4501e14a882ef25f03443da4da55ca002d5619f998be\&#34;,\&#34;created\&#34;:\&#34;2024-05-14T05:21:33.061082853Z\&#34;,\&#34;container_config\&#34;:{\&#34;Cmd\&#34;:[\&#34;/bin/sh -c #(nop)  ARG SHASUM=62b3554d668c9d17382415db10898bf661ee76343e4ee364f904457efda6cb1eeee7cb81d7a3897734024812b64b1c0e2dc305605706d81a0c1f6030508bf7e2\&#34;]},\&#34;throwaway\&#34;:true}&#34;
      },
      {
         &#34;v1Compatibility&#34;: &#34;{\&#34;id\&#34;:\&#34;c03ad9230005f64133de4501e14a882ef25f03443da4da55ca002d5619f998be\&#34;,\&#34;parent\&#34;:\&#34;24e7aee556d6a38bfa2e13430db8a998c023a2920017eabc0b3bf0dd7661bf7d\&#34;,\&#34;created\&#34;:\&#34;2024-05-14T05:21:32.967727298Z\&#34;,\&#34;container_config\&#34;:{\&#34;Cmd\&#34;:[\&#34;/bin/sh -c #(nop)  ARG PKGCOMMIT=f12ab7958bc4885f3f00311cbca5103d9e6ba794\&#34;]},\&#34;throwaway\&#34;:true}&#34;
      },
      {
         &#34;v1Compatibility&#34;: &#34;{\&#34;id\&#34;:\&#34;24e7aee556d6a38bfa2e13430db8a998c023a2920017eabc0b3bf0dd7661bf7d\&#34;,\&#34;parent\&#34;:\&#34;f0d07a99d7d1f0b849a4cbe8fc4552d374f4448c2e7f8bfd908aa43132c4ec34\&#34;,\&#34;created\&#34;:\&#34;2024-05-14T05:21:32.875807605Z\&#34;,\&#34;container_config\&#34;:{\&#34;Cmd\&#34;:[\&#34;/bin/sh -c #(nop)  ARG DISTVER=bullseye\&#34;]},\&#34;throwaway\&#34;:true}&#34;
      },
      {
         &#34;v1Compatibility&#34;: &#34;{\&#34;id\&#34;:\&#34;f0d07a99d7d1f0b849a4cbe8fc4552d374f4448c2e7f8bfd908aa43132c4ec34\&#34;,\&#34;parent\&#34;:\&#34;65c7b6d17437bf7a3216e2fea283071e9b5c0d71c6b97472baa8807a30b5d9d8\&#34;,\&#34;created\&#34;:\&#34;2024-05-14T05:21:32.781941821Z\&#34;,\&#34;container_config\&#34;:{\&#34;Cmd\&#34;:[\&#34;/bin/sh -c #(nop)  ARG PKGVER=1\&#34;]},\&#34;throwaway\&#34;:true}&#34;
      },
      {
         &#34;v1Compatibility&#34;: &#34;{\&#34;id\&#34;:\&#34;65c7b6d17437bf7a3216e2fea283071e9b5c0d71c6b97472baa8807a30b5d9d8\&#34;,\&#34;parent\&#34;:\&#34;863a608d086b1bcf7f9b30ccf57260e6cb5d3d793b4e1131aa8f6041b07a7270\&#34;,\&#34;created\&#34;:\&#34;2024-05-14T05:21:32.682503634Z\&#34;,\&#34;container_config\&#34;:{\&#34;Cmd\&#34;:[\&#34;/bin/sh -c #(nop)  ARG SRCVER=1.8.0\&#34;]},\&#34;throwaway\&#34;:true}&#34;
      },
      {
         &#34;v1Compatibility&#34;: &#34;{\&#34;id\&#34;:\&#34;863a608d086b1bcf7f9b30ccf57260e6cb5d3d793b4e1131aa8f6041b07a7270\&#34;,\&#34;parent\&#34;:\&#34;e00e363f3a25341591a5a5e724e20ae3e70f0396be8483a07c0b39d25d33fecd\&#34;,\&#34;created\&#34;:\&#34;2024-05-14T01:28:27.043980081Z\&#34;,\&#34;container_config\&#34;:{\&#34;Cmd\&#34;:[\&#34;/bin/sh -c #(nop)  CMD [\\\&#34;bash\\\&#34;]\&#34;]},\&#34;throwaway\&#34;:true}&#34;
      },
      {
         &#34;v1Compatibility&#34;: &#34;{\&#34;id\&#34;:\&#34;e00e363f3a25341591a5a5e724e20ae3e70f0396be8483a07c0b39d25d33fecd\&#34;,\&#34;created\&#34;:\&#34;2024-05-14T01:28:26.699066026Z\&#34;,\&#34;container_config\&#34;:{\&#34;Cmd\&#34;:[\&#34;/bin/sh -c #(nop) ADD file:9b38b383dd93169a663eed88edf3f2285b837257ead69dc40ab5ed1fb3f52c35 in / \&#34;]}}&#34;
      }
   ],
   ...
   ]
}
</pre>
<p>The sha256sum used to download the blob of the <strong>first layer</strong> is found at the first element of the <code>fsLayers[]</code> array (<code><strong>fsLayers[0]</strong></code>). The metadata about this first layer is found at the first element of the <code>history[]</code> array (<code><strong>history[0]</strong></code>).</p>
<p>The sha256sum used to download the blob of the <strong>second layer</strong> is found at second element of the <code>fsLayers[]</code> array (<code><strong>fsLayers[1]</strong></code>). The metadata about this second layer is found at the second element of the <code>history[]</code> array (<code><strong>history[1]</strong></code>).</p>
<p>Et cetera...</p>
<h3>Download the Layers</h3>
<p>So how do we download each of these layers separately, yet organize them such that we can later import them as a single image into docker? The answer to that lies in the <a href="https://github.com/moby/moby/blob/79910625f0a7aa76590e4362817dda22f28343aa/image/spec/v1.md">Docker Image Specification v1.0.0</a>.</p>
<p>The above spec provides an example tree of the files:</p>
<blockquote><p>
For example, here&#39;s what the full archive of <code>library/busybox</code> is (displayed in <code>tree</code> format):</p>

<p>There are one or more directories named with the ID for each layer in a full image. Each of these directories contains 3 files:</p>
<ul>
<li>`VERSION` - The schema version of the `json` file</li>
<li>`json` - The JSON metadata for an image layer</li>
<li>`layer.tar` - The Tar archive of the filesystem changeset for an image</li>
</ul>
<p>The content of the <code>VERSION</code> files is simply the semantic version of the JSON metadata schema:</p>
<p>And the <code>repositories</code> file is another JSON file which describes names/tags:</p>
<pre>{  
    &#34;busybox&#34;:{  
        &#34;latest&#34;:&#34;5785b62b697b99a5af6cd5d0aabc804d5748abbb6d3d07da5d1d3795f2dcc83e&#34;
    }
}
</pre>
<p>Every key in this object is the name of a repository, and maps to a collection of tag suffixes. Each tag maps to the ID of the image represented by that tag.
</p></blockquote>
<p>So, as shown in the quote from the spec above, what we need to do is to create a set of directories -- one for each layer -- named after the layer&#39;s ID. Each of these layer-specific directories must contain 3 files:</p>
<ol>
<li>The actual tarball of the layer (named &#39;<code>layer.tar</code>&#39;),</li>
<li>The metadata of the layer (in a file literally named &#39;<code>json</code>&#39; -- with no file extension)</li>
<li>A file named &#39;<code>VERSION</code>&#39; whose contents is literally just &#39;<code>1.0</code>&#39;</li>
</ol>
<p>All of the information that we need is in the &#39;<code>manifest.json</code>&#39; file that we already downloaded. Let&#39;s just loop through each layer that it defines, download the <code>layer.tar</code> tarball, create the &#39;<code>json</code>&#39; metadata file, and hard-code the &#39;<code>VERSION</code>&#39; file with the following BASH snippet</p>
<pre title="">num_layers=$(cat manifest.json | jq -r &#34;.history | length&#34;)

for ((i = 0 ; i &lt; $num_layers ; i++)); do
    layer_blobSum=$(cat manifest.json | jq -r &#34;.fsLayers[$i].blobSum&#34;)
    layer_metadata=$(cat manifest.json | jq -r &#34;.history[$i].v1Compatibility&#34;)
    layer_id=$(echo $layer_metadata | jq -r &#34;.id&#34;)

    echo $layer_id
    echo $layer_blobSum

    mkdir -p &#34;layers/$layer_id&#34;
    echo &#34;1.0&#34; &gt; &#34;layers/$layer_id/VERSION&#34;
    echo $layer_metadata &gt; &#34;layers/$layer_id/json&#34;
    curl -o &#34;layers/$layer_id/layer.tar&#34; -#LH &#34;Authorization: Bearer ${token}&#34; &#34;https://registry-1.docker.io/v2/library/&lt;package_name&gt;/blobs/${layer_blobSum}&#34;
done
</pre>
<p>And here&#39;s an example execution that executes the above snippet to download all of the layers onto disk in a set of directories as defined by the <a href="https://github.com/moby/moby/blob/79910625f0a7aa76590e4362817dda22f28343aa/image/spec/v1.md">Docker Image Specification v1.0.0</a>.</p>
<pre title="">user@disp7456:~$ num_layers=$(cat manifest.json | jq -r &#34;.history | length&#34;)
user@disp7456:~$ 

user@disp7456:~$ for ((i = 0 ; i &lt; $num_layers ; i++)); do
    layer_blobSum=$(cat manifest.json | jq -r &#34;.fsLayers[$i].blobSum&#34;)
    layer_metadata=$(cat manifest.json | jq -r &#34;.history[$i].v1Compatibility&#34;)
    layer_id=$(echo $layer_metadata | jq -r &#34;.id&#34;)

    echo $layer_id
    echo $layer_blobSum

    mkdir -p &#34;layers/$layer_id&#34;
    echo &#34;1.0&#34; &gt; &#34;layers/$layer_id/VERSION&#34;
    echo $layer_metadata &gt; &#34;layers/$layer_id/json&#34;
    curl -o &#34;layers/$layer_id/layer.tar&#34; -#LH &#34;Authorization: Bearer ${token}&#34; &#34;https://registry-1.docker.io/v2/library/hitch/blobs/${layer_blobSum}&#34;
done
6703605aae83084affcafb4abcc7c556f0e436c4992ae224f1f58e88242328cb
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
################################################################ 100.0%
c48ca3d95161bbcdfcaa2e016a675965d55f4f06147ef4445c69347c5965f188
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
################################################################ 100.0%
1d2af5a156bbc461d98824c2f6bfe295327d4419105c0b7f88f14cb28d0bb240
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
################################################################ 100.0%
8f914c821cbe154cc6677bceb043669e4295ad5cfb6409efa9c2ec1beba75fad
sha256:3148f4af0a813bcff0a3ed2562aabfb1b596b52ef36eb5eb4d82ce836350b73a
################################################################ 100.0%
a8d8314458142ee2a4ebccb19f48b6f9c696100103c3d49cbbe7ecd2575120e5
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
################################################################ 100.0%
5a78b0e89bbae2390b83e60174ae1efc583f766eff7dffaffa747ccb67472d0f
sha256:a0e9543db8c1238572466cf00b55436bc7b7e849f7cb305128f391a94b75c2fc
################################################################ 100.0%
5a12a2c67ff9b5bfad288a4ede18d08c259c301efb85403d08a40ea2ad0eb1f8
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
################################################################ 100.0%
c03ad9230005f64133de4501e14a882ef25f03443da4da55ca002d5619f998be
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
################################################################ 100.0%
24e7aee556d6a38bfa2e13430db8a998c023a2920017eabc0b3bf0dd7661bf7d
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
################################################################ 100.0%
f0d07a99d7d1f0b849a4cbe8fc4552d374f4448c2e7f8bfd908aa43132c4ec34
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
################################################################ 100.0%
65c7b6d17437bf7a3216e2fea283071e9b5c0d71c6b97472baa8807a30b5d9d8
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
################################################################ 100.0%
863a608d086b1bcf7f9b30ccf57260e6cb5d3d793b4e1131aa8f6041b07a7270
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
################################################################ 100.0%
e00e363f3a25341591a5a5e724e20ae3e70f0396be8483a07c0b39d25d33fecd
sha256:728328ac3bde9b85225b1f0d60f5c149f5635a191f5d8eaeeb00e095d36ef9fd
################################################################ 100.0%
user@disp7456:~$ 

user@disp7456:~$ tree layers/
layers/
â”œâ”€â”€ 1d2af5a156bbc461d98824c2f6bfe295327d4419105c0b7f88f14cb28d0bb240
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â”œâ”€â”€ layer.tar
â”‚Â Â  â””â”€â”€ VERSION
â”œâ”€â”€ 24e7aee556d6a38bfa2e13430db8a998c023a2920017eabc0b3bf0dd7661bf7d
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â”œâ”€â”€ layer.tar
â”‚Â Â  â””â”€â”€ VERSION
â”œâ”€â”€ 5a12a2c67ff9b5bfad288a4ede18d08c259c301efb85403d08a40ea2ad0eb1f8
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â”œâ”€â”€ layer.tar
â”‚Â Â  â””â”€â”€ VERSION
â”œâ”€â”€ 5a78b0e89bbae2390b83e60174ae1efc583f766eff7dffaffa747ccb67472d0f
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â”œâ”€â”€ layer.tar
â”‚Â Â  â””â”€â”€ VERSION
â”œâ”€â”€ 65c7b6d17437bf7a3216e2fea283071e9b5c0d71c6b97472baa8807a30b5d9d8
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â”œâ”€â”€ layer.tar
â”‚Â Â  â””â”€â”€ VERSION
â”œâ”€â”€ 6703605aae83084affcafb4abcc7c556f0e436c4992ae224f1f58e88242328cb
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â”œâ”€â”€ layer.tar
â”‚Â Â  â””â”€â”€ VERSION
â”œâ”€â”€ 863a608d086b1bcf7f9b30ccf57260e6cb5d3d793b4e1131aa8f6041b07a7270
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â”œâ”€â”€ layer.tar
â”‚Â Â  â””â”€â”€ VERSION
â”œâ”€â”€ 8f914c821cbe154cc6677bceb043669e4295ad5cfb6409efa9c2ec1beba75fad
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â”œâ”€â”€ layer.tar
â”‚Â Â  â””â”€â”€ VERSION
â”œâ”€â”€ a8d8314458142ee2a4ebccb19f48b6f9c696100103c3d49cbbe7ecd2575120e5
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â”œâ”€â”€ layer.tar
â”‚Â Â  â””â”€â”€ VERSION
â”œâ”€â”€ c03ad9230005f64133de4501e14a882ef25f03443da4da55ca002d5619f998be
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â”œâ”€â”€ layer.tar
â”‚Â Â  â””â”€â”€ VERSION
â”œâ”€â”€ c48ca3d95161bbcdfcaa2e016a675965d55f4f06147ef4445c69347c5965f188
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â”œâ”€â”€ layer.tar
â”‚Â Â  â””â”€â”€ VERSION
â”œâ”€â”€ e00e363f3a25341591a5a5e724e20ae3e70f0396be8483a07c0b39d25d33fecd
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â”œâ”€â”€ layer.tar
â”‚Â Â  â””â”€â”€ VERSION
â””â”€â”€ f0d07a99d7d1f0b849a4cbe8fc4552d374f4448c2e7f8bfd908aa43132c4ec34
    â”œâ”€â”€ json
    â”œâ”€â”€ layer.tar
    â””â”€â”€ VERSION

14 directories, 39 files
user@disp7456:~$ 
</pre>
<p>Finally, besides these layer-specific dirs, we need one additional file (named simply &#39;<code>repository</code>&#39;, with no file extension) at the same height as these dirs. As defined by the <a href="https://github.com/moby/moby/blob/79910625f0a7aa76590e4362817dda22f28343aa/image/spec/v1.md">Docker Image Specification v1.0.0</a>, this file should state the name &amp; tag of the image, and it points to the first layer of the image.</p>
<p>Note the <code>0th</code> item in the <code>history[]</code> array is the first layer of the image, so we can create this file with the following command</p>
<pre title="">start_image=$(cat manifest.json | jq -r &#34;.history[0].v1Compatibility&#34;)
start_image_id=$(echo $start_image | jq -r &#34;.id&#34;)

cat &gt; layers/repositories &lt;&lt;EOF
{
    &#34;&lt;image_name&gt;&#34;: { &#34;stable&#34;: &#34;$start_image_id&#34; }
}
EOF
</pre>
<p>And here&#39;s an example execution to create our &#39;<code>repository</code>&#39; file for the &#39;<code>hitch</code>&#39; package.</p>
<pre title="">user@disp7456:~$ start_image=$(cat manifest.json | jq -r &#34;.history[0].v1Compatibility&#34;)
user@disp7456:~$ 

user@disp7456:~$ start_image_id=$(echo $start_image | jq -r &#34;.id&#34;)
user@disp7456:~$ 

user@disp7456:~$ cat &gt; layers/repositories &lt;&lt;EOF
{
    &#34;hitch&#34;: { &#34;stable&#34;: &#34;$start_image_id&#34; }
}
EOF
user@disp7456:~$

user@disp7456:~$ ls layers
1d2af5a156bbc461d98824c2f6bfe295327d4419105c0b7f88f14cb28d0bb240
24e7aee556d6a38bfa2e13430db8a998c023a2920017eabc0b3bf0dd7661bf7d
5a12a2c67ff9b5bfad288a4ede18d08c259c301efb85403d08a40ea2ad0eb1f8
5a78b0e89bbae2390b83e60174ae1efc583f766eff7dffaffa747ccb67472d0f
65c7b6d17437bf7a3216e2fea283071e9b5c0d71c6b97472baa8807a30b5d9d8
6703605aae83084affcafb4abcc7c556f0e436c4992ae224f1f58e88242328cb
863a608d086b1bcf7f9b30ccf57260e6cb5d3d793b4e1131aa8f6041b07a7270
8f914c821cbe154cc6677bceb043669e4295ad5cfb6409efa9c2ec1beba75fad
a8d8314458142ee2a4ebccb19f48b6f9c696100103c3d49cbbe7ecd2575120e5
c03ad9230005f64133de4501e14a882ef25f03443da4da55ca002d5619f998be
c48ca3d95161bbcdfcaa2e016a675965d55f4f06147ef4445c69347c5965f188
e00e363f3a25341591a5a5e724e20ae3e70f0396be8483a07c0b39d25d33fecd
f0d07a99d7d1f0b849a4cbe8fc4552d374f4448c2e7f8bfd908aa43132c4ec34
repositories
user@disp7456:~$

user@disp7456:~$ cat layers/repositories
{
    &#34;hitch&#34;: { &#34;stable&#34;: &#34;6703605aae83084affcafb4abcc7c556f0e436c4992ae224f1f58e88242328cb&#34; }
}
user@disp7456:~$ 
</pre>
<p>Your &#39;<code>layers/</code>&#39; directory should now be prepared-to-spec for importing the entire image into docker.</p>
<p>For reference, here&#39;s the contents of just one of the layers:</p>
<pre title="">user@disp7456:~$ ls layers/8f914c821cbe154cc6677bceb043669e4295ad5cfb6409efa9c2ec1beba75fad/
json  layer.tar  VERSION
user@disp7456:~$ 

user@disp7456:~$ cat layers/8f914c821cbe154cc6677bceb043669e4295ad5cfb6409efa9c2ec1beba75fad/VERSION 
1.0
user@disp7456:~$ 

user@disp7456:~$ cat layers/8f914c821cbe154cc6677bceb043669e4295ad5cfb6409efa9c2ec1beba75fad/json 
{&#34;id&#34;:&#34;8f914c821cbe154cc6677bceb043669e4295ad5cfb6409efa9c2ec1beba75fad&#34;,&#34;parent&#34;:&#34;a8d8314458142ee2a4ebccb19f48b6f9c696100103c3d49cbbe7ecd2575120e5&#34;,&#34;created&#34;:&#34;2024-05-14T05:23:11.403178706Z&#34;,&#34;container_config&#34;:{&#34;Cmd&#34;:[&#34;/bin/sh -c #(nop) COPY file:1abf3c94dce5dc9f6617dc8d36a6fe6f4f7236189d4819f16cefb54288e80e0d in /usr/local/bin/ &#34;]}}
user@disp7456:~$ 

user@disp7456:~$ sha256sum layers/8f914c821cbe154cc6677bceb043669e4295ad5cfb6409efa9c2ec1beba75fad/layer.tar 
3148f4af0a813bcff0a3ed2562aabfb1b596b52ef36eb5eb4d82ce836350b73a  layers/8f914c821cbe154cc6677bceb043669e4295ad5cfb6409efa9c2ec1beba75fad/layer.tar
user@disp7456:~$ 

user@disp7456:~$ tar -tvf layers/8f914c821cbe154cc6677bceb043669e4295ad5cfb6409efa9c2ec1beba75fad/layer.tar 
drwxr-xr-x 0/0               0 2024-05-12 19:00 usr/
drwxr-xr-x 0/0               0 2024-05-12 19:00 usr/local/
drwxr-xr-x 0/0               0 2024-05-14 00:23 usr/local/bin/
-rwxrwxr-x 0/0             319 2024-05-14 00:21 usr/local/bin/docker-hitch-entrypoint
user@disp7456:~$ 
</pre>
<h3>Load the Image</h3>
<p>Finally, you can load the layers as one image into docker with <code>docker image load</code></p>
<pre title="">tar -cC layers . | docker image load
</pre>
<p>Here&#39;s an example execution</p>
<pre title="">user@disp7456:~$ docker image ls
REPOSITORY   TAG       IMAGE ID   CREATED   SIZE
user@disp7456:~$ 

user@disp7456:~$ tar -cC layers . | docker load
e00e363f3a25: Loading layer [==================================================&gt;]  31.43MB/31.43MB
863a608d086b: Loading layer [==================================================&gt;]      32B/32B
65c7b6d17437: Loading layer [==================================================&gt;]      32B/32B
f0d07a99d7d1: Loading layer [==================================================&gt;]      32B/32B
24e7aee556d6: Loading layer [==================================================&gt;]      32B/32B
c03ad9230005: Loading layer [==================================================&gt;]      32B/32B
5a12a2c67ff9: Loading layer [==================================================&gt;]      32B/32B
5a78b0e89bba: Loading layer [==================================================&gt;]  1.573MB/1.573MB
a8d831445814: Loading layer [==================================================&gt;]      32B/32B
8f914c821cbe: Loading layer [==================================================&gt;]     415B/415B
1d2af5a156bb: Loading layer [==================================================&gt;]      32B/32B
c48ca3d95161: Loading layer [==================================================&gt;]      32B/32B
6703605aae83: Loading layer [==================================================&gt;]      32B/32B
user@disp7456:~$ 

user@disp7456:~$ docker image ls
REPOSITORY   TAG       IMAGE ID       CREATED       SIZE
hitch        stable    f07eadb841be   3 weeks ago   85.1MB
user@disp7456:~$ 
</pre>
<p>The image is now available in <code>docker</code>.</p>
<div id="attachment_3810"><p><a href="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/container-download-curl-wget_github-packages-homebrew-org1.jpg"><img aria-describedby="caption-attachment-3810" decoding="async" src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_github-packages-homebrew-org1.jpg.pagespeed.ic.f2IglFP69q.jpg" alt="Screenshot of the GitHub WUI in firefox, browsing the &#34;Homebrew&#34; org&#39;s page. The &#34;Packages&#34; tab link is highlighted in red." width="767" height="620" srcset="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_github-packages-homebrew-org1.jpg.pagespeed.ic.f2IglFP69q.jpg 767w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_github-packages-homebrew-org1-300x243.jpg.pagespeed.ic.X7YfA3J5cR.jpg 300w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_github-packages-homebrew-org1-150x121.jpg.pagespeed.ic.GnRDYoWxFO.jpg 150w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_github-packages-homebrew-org1-400x323.jpg.pagespeed.ic.DzPsoN6C58.jpg 400w" sizes="(max-width: 767px) 100vw, 767px"/></a></p><p id="caption-attachment-3810">From the GitHub org&#39;s main page, click on &#34;Packages&#34; to browse its files uploaded to its GitHub Packages registry</p></div>
<h2 id="github-packages">GitHub Packages</h2>
<p>GitHub Packages was <a href="https://github.blog/2019-05-10-introducing-github-package-registry/">launched</a> as a Beta in May 2019. It allowed users to publish packages in many formats, including images uploaded to a GitHub Docker Registry. In September 2020, GitHub added a generic <a href="https://github.blog/2020-09-01-introducing-github-container-registry/">Container Registry</a> as a Beta to GitHub Packages. In June 2021, GitHub <a href="https://github.blog/2021-06-21-github-packages-container-registry-generally-available/">migrated all images</a> uploaded to GitHub Packages&#39; Docker Registry (at the domain &#39;<code>docker.pkg.github.com</code>&#39;) to their Container Registry (at the domain &#39;<code>ghcr.io</code>&#39;).</p>
<p>This <a href="https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry">GitHub Packages Container Registry</a> lets users (like Brew) upload (and download) images <a href="https://github.com/opencontainers/image-spec">in accordance with</a> the Open Container Initiative (OCI) Specifications (described above).</p>
<h3>Determine Package Name</h3>
<p>In this example, let&#39;s say that we want to download the &#39;<code>vim</code>&#39; package from the Homebrew project, which is hosted on GitHub Packages.</p>
<p>To start, go the <a href="https://github.com/Homebrew">org&#39;s page</a> on GitHub</p>
<ul>
<a href="https://github.com/Homebrew">https://github.com/Homebrew</a>
</ul>
<p>Click on &#34;<a href="https://github.com/orgs/Homebrew/packages">Packages</a>&#34;</p>
<p>Type the name of the package that you want to download</p>


		
		

<p>This will tell you the name of the package, which you may want to cross-check with <a href="https://formulae.brew.sh/">formulae.brew.sh</a></p>

		
		

<h3>Determine Package Version</h3>
<p>To figure out which version (tag) we want to download from GitHub Packages, we need to check the Brew &#34;recipe&#34;. All the brew recipes are found in the <a href="https://github.com/Homebrew/homebrew-core">Homebrew/homebrew-core repo</a>.</p>
<p>Click the &#34;Formulas&#34; directory, and then click the &#34;v&#34; directory (which holds all the brew formula files for packages that start with the letter &#39;v&#39;).</p>

		
		

<div id="attachment_3809"><p><a href="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/container-download-curl-wget_github-packages-homebrew-core-formula-v1-scaled.jpg"><img aria-describedby="caption-attachment-3809" decoding="async" loading="lazy" src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_github-packages-homebrew-core-formula-v1-243x1024.jpg.pagespeed.ic.zrEZc3-oES.jpg" alt="Screenshot of the GitHub WUI in firefox, browsing the &#34;Formula/v/&#34; directory of the &#39;Homebrew/homebrew-core&#39; repo. A file titled &#34;vim.rb&#34; is highlighted in red." width="243" height="1024" srcset="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_github-packages-homebrew-core-formula-v1-243x1024.jpg.pagespeed.ic.zrEZc3-oES.jpg 243w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_github-packages-homebrew-core-formula-v1-71x300.jpg.pagespeed.ic.2Mn_gQr81Z.jpg 71w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_github-packages-homebrew-core-formula-v1-365x1536.jpg.pagespeed.ic.7-NyzFDw-Q.jpg 365w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_github-packages-homebrew-core-formula-v1-486x2048.jpg.pagespeed.ic.m3hnKGVBSJ.jpg 486w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_github-packages-homebrew-core-formula-v1-400x1685.jpg.pagespeed.ic.NEZPqJWHAa.jpg 400w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcontainer-download-curl-wget_github-packages-homebrew-core-formula-v1-scaled.jpg.pagespeed.ic.hxvmdxsOiI.jpg 608w" sizes="(max-width: 243px) 100vw, 243px"/></a></p><p id="caption-attachment-3809">Click on the &#39;vim.rb&#39; file to view the formula for the &#39;vim&#39; brew package</p></div>
<p>Finally, click the &#39;<code>vim.rb</code>&#39; file.</p>
<p>You may just want to download the latest version of vim, but let&#39;s say that we&#39;re using an old machine that can&#39;t be updated beyond MacOS 11.7.10 (Big Sur). If you check the latest recipe, you see entries for sonoma (macOS 12), ventura (macOS 13), and monterey (macOS 14). But big_sur is absent because it isn&#39;t supported.</p>
<p>The easiest way that I&#39;m aware-of to determine what is the latest brew package&#39;s version that supports your OS (without having to fight with the API) is to view the history of the recipe file.</p>

		
		

<p>After clicking-through all the previous versions, we can see that big_sur was removed (and not replaced) in a commit on Sep 28, 2023 in <a href="https://github.com/Homebrew/homebrew-core/commit/a153795af9c53680065e63556bda6cedf936055b&#34;">commit a153795</a>, which has a commit message &#34;vim: update 9.0.1900_1 bottle&#34;. Therefore, it looks like &#34;big_sur&#34; was no longer supported the vim package version &#39;9.0.1900_1&#39;. The version immediately before that is &#39;9.0.1900&#39;, and it looks like <a href="https://github.com/Homebrew/homebrew-core/blob/2f36c53c74e366322e68429eb63eb55ec9294261/Formula/v/vim.rb">it <em>does</em> have a package</a> for &#34;big_sur&#34;</p>

		
		

<p>Now that we know that we want to download &#39;9.0.1900&#39; version of the &#39;vim&#39; package, we can go back to the <a href="https://github.com/Homebrew/homebrew-core/pkgs/container/core%2Fvim">GitHub Packages page</a> and find the tag for this version.</p>
<p>Click on &#34;View all tagged versions&#34; and then scroll-down to the tag that corresponds to the version we want (9.0.1900).</p>

		
		

<h3>Get an Auth Token</h3>
<p>Execute the following command to get an <a href="https://distribution.github.io/distribution/spec/auth/oauth/">authentication token</a> from GitHub Packages.</p>
<pre title=""># get a JSON with an anonymous token
curl -so &#34;token.json&#34; &#34;https://ghcr.io/token?service=ghcr.io&amp;scope=&lt;resourcetype&gt;:&lt;component&gt;/&lt;component&gt;/&lt;component&gt;:&lt;action&gt;&#34;;

# extract token from JSON
token=$(cat token.json | jq -jr &#34;.token&#34;)
</pre>
<p>The above commands will get a free/temporary token that you can use in subsequent API calls. If all went well, there will be no output from these commands. Here&#39;s an example execution</p>
<pre title="">user@disp7456:~$ curl -so &#34;token.json&#34; &#34;https://ghcr.io/token?service=ghcr.io&amp;scope=repository:homebrew/core/go:pull&#34;;
user@disp7456:~$

user@disp7456:~$ token=$(cat token.json | jq -jr &#34;.token&#34;)
user@disp7456:~$ 
</pre>
<h3>List the Tags</h3>
<p>We can list all of the available tags for the &#39;<code>vim</code>&#39; package with the &#39;<code>GET /v2/&lt;name&gt;/tags/list</code>&#39; API endpoint, as shown in the <a href="#table">table</a> above</p>
<pre title="">curl -i -H &#34;Authorization: Bearer ${token}&#34; https://ghcr.io/v2/homebrew/core/&lt;package_name&gt;/tags/list
</pre>
<p>Here&#39;s an example execution. Note that it affirms the existence of the &#39;<code>9.0.1900</code>&#39; tag that we found above.</p>
<pre title="">user@disp7456:~$ curl -i -H &#34;Authorization: Bearer ${token}&#34; https://ghcr.io/v2/homebrew/core/vim/tags/list
HTTP/2 200 
content-type: application/json
docker-distribution-api-version: registry/2.0
link: &lt;/v2/homebrew/core/vim/tags/list?last=9.0.1500&amp;n=0&gt;; rel=&#34;next&#34;
date: Mon, 06 May 2024 01:06:25 GMT
content-length: 1164
x-github-request-id: CD4E:29D249:57F4C1F:5A244F1:66382D11

{&#34;name&#34;:&#34;homebrew/core/vim&#34;,&#34;tags&#34;:[&#34;8.2.2725_1&#34;,&#34;8.2.2750&#34;,&#34;8.2.2775&#34;,&#34;8.2.2800&#34;,&#34;8.2.2825&#34;,&#34;8.2.2850&#34;,&#34;8.2.2875&#34;,&#34;8.2.2875_1&#34;,&#34;8.2.2900&#34;,&#34;8.2.2925&#34;,&#34;8.2.2950&#34;,&#34;8.2.2975&#34;,&#34;8.2.3000&#34;,&#34;8.2.3025&#34;,&#34;8.2.3050&#34;,&#34;8.2.3075&#34;,&#34;8.2.3100&#34;,&#34;8.2.3125&#34;,&#34;8.2.3150&#34;,&#34;8.2.3175&#34;,&#34;8.2.3200&#34;,&#34;8.2.3225&#34;,&#34;8.2.3250&#34;,&#34;8.2.3275&#34;,&#34;8.2.3300&#34;,&#34;8.2.3325&#34;,&#34;8.2.3350&#34;,&#34;8.2.3400&#34;,&#34;8.2.3450&#34;,&#34;8.2.3500&#34;,&#34;8.2.3550&#34;,&#34;8.2.3600&#34;,&#34;8.2.3650&#34;,&#34;8.2.3700&#34;,&#34;8.2.3750&#34;,&#34;8.2.3750_1&#34;,&#34;8.2.3800&#34;,&#34;8.2.3850&#34;,&#34;8.2.3900&#34;,&#34;8.2.3950&#34;,&#34;8.2.4000&#34;,&#34;8.2.4050&#34;,&#34;8.2.4100&#34;,&#34;8.2.4150&#34;,&#34;8.2.4200&#34;,&#34;8.2.4250&#34;,&#34;8.2.4300&#34;,&#34;8.2.4300_1&#34;,&#34;8.2.4350&#34;,&#34;8.2.4400&#34;,&#34;8.2.4450&#34;,&#34;8.2.4500&#34;,&#34;8.2.4550&#34;,&#34;8.2.4600&#34;,&#34;8.2.4650&#34;,&#34;8.2.4700&#34;,&#34;8.2.4750&#34;,&#34;8.2.4800&#34;,&#34;8.2.4800_1&#34;,&#34;8.2.4850&#34;,&#34;8.2.4850-1&#34;,&#34;8.2.4900&#34;,&#34;8.2.4950&#34;,&#34;8.2.5000&#34;,&#34;8.2.5050&#34;,&#34;8.2.5100&#34;,&#34;8.2.5150&#34;,&#34;8.2.5150_1&#34;,&#34;9.0.0000&#34;,&#34;9.0.0050&#34;,&#34;9.0.0100&#34;,&#34;9.0.0150&#34;,&#34;9.0.0150_1&#34;,&#34;9.0.0200&#34;,&#34;9.0.0250&#34;,&#34;9.0.0300&#34;,&#34;9.0.0350&#34;,&#34;9.0.0350_1&#34;,&#34;9.0.0350_2&#34;,&#34;9.0.0650&#34;,&#34;9.0.0700&#34;,&#34;9.0.0750&#34;,&#34;9.0.0800&#34;,&#34;9.0.0850&#34;,&#34;9.0.0900&#34;,&#34;9.0.0950&#34;,&#34;9.0.1000&#34;,&#34;9.0.1050&#34;,&#34;9.0.1050-1&#34;,&#34;9.0.1100&#34;,&#34;9.0.1100_1&#34;,&#34;9.0.1150&#34;,&#34;9.0.1200&#34;,&#34;9.0.1250&#34;,&#34;9.0.1300&#34;,&#34;9.0.1350&#34;,&#34;9.0.1400&#34;,&#34;9.0.1400-1&#34;,&#34;9.0.1450&#34;,&#34;9.0.1500&#34;]}
user@disp7456:~$ 
</pre>
<h3>Download the Manifest</h3>
<p>We can download the manifest for the &#39;<code>9.0.1900</code>&#39; tag of the &#39;<code>vim</code>&#39; package with the &#39;<code>GET /v2/&lt;name&gt;/manifests/&lt;reference&gt;</code>&#39; API endpoint, as shown in the <a href="#table">table</a> above</p>
<pre title="">curl -o manifest.json -s -H &#34;Authorization: Bearer ${token}&#34; -H &#39;Accept: application/vnd.oci.image.index.v1+json&#39; https://ghcr.io/v2/homebrew/core/&lt;package_name&gt;/manifests/&lt;tag&gt;
</pre>
<p>And here&#39;s an example execution that downloads the manifest for the &#39;<code>9.0.1900</code>&#39; tag of the &#39;<code>vim</code>&#39; package</p>
<pre title="">

user@disp7456:~$ curl -o manifest.json -s -H &#34;Authorization: Bearer ${token}&#34; -H &#39;Accept: application/vnd.oci.image.index.v1+json&#39; https://ghcr.io/v2/homebrew/core/vim/manifests/9.0.1900
user@disp7456:~$ 

user@disp7456:~$ ls
manifest.json
user@disp7456:~$ 
</pre>
<blockquote><p>
âš  Note that we MUST specify the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Accept">Accept</a> header here. If we don&#39;t, then the registry will respond with the following error message</p>
<p><code>{&#34;errors&#34;:[{&#34;code&#34;:&#34;MANIFEST_UNKNOWN&#34;,&#34;message&#34;:&#34;OCI index found, but Accept header does not support OCI indexes&#34;}]}</code></p>
<p>For more information on the OCI media types and their MIME types, see the list of <a href="https://github.com/opencontainers/image-spec/blob/main/media-types.md">OCI Image Media Types</a>.
</p></blockquote>
<h3>Parse the Manifest</h3>
<p>The previous step downloaded a file named &#39;<code>manifest.json</code>&#39;. This &#39;<code>manifest.json</code>&#39; file lists all of the many files available for the &#39;<code>9.0.1900</code>&#39; version of the &#39;<code>vim</code>&#39; package -- spanning many OS versions and processor architectures.</p>
<p>In order to proceed and download our actual brew bottle file, we need to extract the &#39;<code>sh.brew.bottle.digest</code>&#39; for our target system, which is a sha256sum hash that we&#39;ll use in the &#39;GET <code>/v2/&lt;name&gt;/blobs/<digest></digest></code>&#39; API call to actually download the file from the container registry.</p>
<p>There&#39;s only one dictionary in the &#39;<code>manifests</code>&#39; array that has a &#39;<code>platform</code>&#39; dict with the following keys:</p>
<ol>
<li><code>&#34;architecture&#34;: &#34;amd64&#34;</code>, and</li>
<li><code>&#34;os.version&#34;: &#34;macOS 11.7&#34;</code></li>
</ol>
<p>...And that&#39;s the one we want:</p>
<pre title="">{
  &#34;schemaVersion&#34;: 2,
  &#34;manifests&#34;: [
    ...
    {
      &#34;mediaType&#34;: &#34;application/vnd.oci.image.manifest.v1+json&#34;,
      &#34;digest&#34;: &#34;sha256:5b538ff92ab00c3658b152dee240e30f9ffa65d817540b6a461460b02b93ceda&#34;,
      &#34;size&#34;: 5357,
      &#34;platform&#34;: {
        &#34;architecture&#34;: &#34;amd64&#34;,
        &#34;os&#34;: &#34;darwin&#34;,
        &#34;os.version&#34;: &#34;macOS 11.7&#34;
      },
      &#34;annotations&#34;: {
        &#34;org.opencontainers.image.ref.name&#34;: &#34;9.0.1900.big_sur&#34;,
        &#34;sh.brew.bottle.digest&#34;: &#34;6cbad503034158806227128743d2acc08773c90890cea12efee25c4a53399d02&#34;,
        &#34;sh.brew.bottle.size&#34;: &#34;13598246&#34;,
        &#34;sh.brew.tab&#34;: &#34;{\&#34;homebrew_version\&#34;:\&#34;4.1.11-36-g184efd9\&#34;,\&#34;changed_files\&#34;:[\&#34;share/vim/vim90/doc/vim2html.pl\&#34;,\&#34;share/vim/vim90/tools/efm_filter.pl\&#34;,\&#34;share/vim/vim90/tools/efm_perl.pl\&#34;,\&#34;share/vim/vim90/tools/pltags.pl\&#34;,\&#34;share/vim/vim90/tools/shtags.pl\&#34;,\&#34;share/man/da/man1/vim.1\&#34;,\&#34;share/man/da/man1/vimtutor.1\&#34;,\&#34;share/man/da.ISO8859-1/man1/vim.1\&#34;,\&#34;share/man/da.ISO8859-1/man1/vimtutor.1\&#34;,\&#34;share/man/da.UTF-8/man1/vim.1\&#34;,\&#34;share/man/da.UTF-8/man1/vimtutor.1\&#34;,\&#34;share/man/de/man1/vim.1\&#34;,\&#34;share/man/de.ISO8859-1/man1/vim.1\&#34;,\&#34;share/man/de.UTF-8/man1/vim.1\&#34;,\&#34;share/man/fr/man1/evim.1\&#34;,\&#34;share/man/fr/man1/vim.1\&#34;,\&#34;share/man/fr/man1/vimtutor.1\&#34;,\&#34;share/man/fr.ISO8859-1/man1/evim.1\&#34;,\&#34;share/man/fr.ISO8859-1/man1/vim.1\&#34;,\&#34;share/man/fr.ISO8859-1/man1/vimtutor.1\&#34;,\&#34;share/man/fr.UTF-8/man1/evim.1\&#34;,\&#34;share/man/fr.UTF-8/man1/vim.1\&#34;,\&#34;share/man/fr.UTF-8/man1/vimtutor.1\&#34;,\&#34;share/man/it/man1/evim.1\&#34;,\&#34;share/man/it/man1/vim.1\&#34;,\&#34;share/man/it/man1/vimtutor.1\&#34;,\&#34;share/man/it.ISO8859-1/man1/evim.1\&#34;,\&#34;share/man/it.ISO8859-1/man1/vim.1\&#34;,\&#34;share/man/it.ISO8859-1/man1/vimtutor.1\&#34;,\&#34;share/man/it.UTF-8/man1/evim.1\&#34;,\&#34;share/man/it.UTF-8/man1/vim.1\&#34;,\&#34;share/man/it.UTF-8/man1/vimtutor.1\&#34;,\&#34;share/man/ja/man1/evim.1\&#34;,\&#34;share/man/ja/man1/vim.1\&#34;,\&#34;share/man/ja/man1/vimtutor.1\&#34;,\&#34;share/man/man1/evim.1\&#34;,\&#34;share/man/man1/vim.1\&#34;,\&#34;share/man/man1/vimtutor.1\&#34;,\&#34;share/man/pl/man1/evim.1\&#34;,\&#34;share/man/pl/man1/vim.1\&#34;,\&#34;share/man/pl/man1/vimtutor.1\&#34;,\&#34;share/man/pl.ISO8859-2/man1/evim.1\&#34;,\&#34;share/man/pl.ISO8859-2/man1/vim.1\&#34;,\&#34;share/man/pl.ISO8859-2/man1/vimtutor.1\&#34;,\&#34;share/man/pl.UTF-8/man1/evim.1\&#34;,\&#34;share/man/pl.UTF-8/man1/vim.1\&#34;,\&#34;share/man/pl.UTF-8/man1/vimtutor.1\&#34;,\&#34;share/man/ru.KOI8-R/man1/evim.1\&#34;,\&#34;share/man/ru.KOI8-R/man1/vim.1\&#34;,\&#34;share/man/ru.KOI8-R/man1/vimtutor.1\&#34;,\&#34;share/man/ru.UTF-8/man1/evim.1\&#34;,\&#34;share/man/ru.UTF-8/man1/vim.1\&#34;,\&#34;share/man/ru.UTF-8/man1/vimtutor.1\&#34;,\&#34;share/man/tr/man1/evim.1\&#34;,\&#34;share/man/tr/man1/vim.1\&#34;,\&#34;share/man/tr/man1/vimtutor.1\&#34;,\&#34;share/man/tr.ISO8859-9/man1/evim.1\&#34;,\&#34;share/man/tr.ISO8859-9/man1/vim.1\&#34;,\&#34;share/man/tr.ISO8859-9/man1/vimtutor.1\&#34;,\&#34;share/man/tr.UTF-8/man1/evim.1\&#34;,\&#34;share/man/tr.UTF-8/man1/vim.1\&#34;,\&#34;share/man/tr.UTF-8/man1/vimtutor.1\&#34;,\&#34;share/vim/vim90/filetype.vim\&#34;],\&#34;source_modified_time\&#34;:1694864306,\&#34;compiler\&#34;:\&#34;clang\&#34;,\&#34;runtime_dependencies\&#34;:[{\&#34;full_name\&#34;:\&#34;gettext\&#34;,\&#34;version\&#34;:\&#34;0.21.1\&#34;,\&#34;declared_directly\&#34;:true},{\&#34;full_name\&#34;:\&#34;libsodium\&#34;,\&#34;version\&#34;:\&#34;1.0.18\&#34;,\&#34;declared_directly\&#34;:true},{\&#34;full_name\&#34;:\&#34;lua\&#34;,\&#34;version\&#34;:\&#34;5.4.6\&#34;,\&#34;declared_directly\&#34;:true},{\&#34;full_name\&#34;:\&#34;ncurses\&#34;,\&#34;version\&#34;:\&#34;6.4\&#34;,\&#34;declared_directly\&#34;:true},{\&#34;full_name\&#34;:\&#34;ca-certificates\&#34;,\&#34;version\&#34;:\&#34;2023-08-22\&#34;,\&#34;declared_directly\&#34;:false},{\&#34;full_name\&#34;:\&#34;openssl@3\&#34;,\&#34;version\&#34;:\&#34;3.1.2\&#34;,\&#34;declared_directly\&#34;:false},{\&#34;full_name\&#34;:\&#34;berkeley-db\&#34;,\&#34;version\&#34;:\&#34;18.1.40\&#34;,\&#34;declared_directly\&#34;:false},{\&#34;full_name\&#34;:\&#34;gdbm\&#34;,\&#34;version\&#34;:\&#34;1.23\&#34;,\&#34;declared_directly\&#34;:false},{\&#34;full_name\&#34;:\&#34;perl\&#34;,\&#34;version\&#34;:\&#34;5.36.1\&#34;,\&#34;declared_directly\&#34;:true},{\&#34;full_name\&#34;:\&#34;mpdecimal\&#34;,\&#34;version\&#34;:\&#34;2.5.1\&#34;,\&#34;declared_directly\&#34;:false},{\&#34;full_name\&#34;:\&#34;readline\&#34;,\&#34;version\&#34;:\&#34;8.2.1\&#34;,\&#34;declared_directly\&#34;:false},{\&#34;full_name\&#34;:\&#34;sqlite\&#34;,\&#34;version\&#34;:\&#34;3.43.1\&#34;,\&#34;declared_directly\&#34;:false},{\&#34;full_name\&#34;:\&#34;xz\&#34;,\&#34;version\&#34;:\&#34;5.4.4\&#34;,\&#34;declared_directly\&#34;:false},{\&#34;full_name\&#34;:\&#34;python@3.11\&#34;,\&#34;version\&#34;:\&#34;3.11.5\&#34;,\&#34;declared_directly\&#34;:true},{\&#34;full_name\&#34;:\&#34;libyaml\&#34;,\&#34;version\&#34;:\&#34;0.2.5\&#34;,\&#34;declared_directly\&#34;:false},{\&#34;full_name\&#34;:\&#34;ruby\&#34;,\&#34;version\&#34;:\&#34;3.2.2\&#34;,\&#34;declared_directly\&#34;:true}],\&#34;arch\&#34;:\&#34;x86_64\&#34;,\&#34;built_on\&#34;:{\&#34;os\&#34;:\&#34;Macintosh\&#34;,\&#34;os_version\&#34;:\&#34;macOS 11.7\&#34;,\&#34;cpu_family\&#34;:\&#34;penryn\&#34;,\&#34;xcode\&#34;:\&#34;13.2.1\&#34;,\&#34;clt\&#34;:\&#34;13.2.0.0.1.1638488800\&#34;,\&#34;preferred_perl\&#34;:\&#34;5.30\&#34;}}&#34;
      }
    },
    ...
  ],
  &#34;annotations&#34;: {
    &#34;com.github.package.type&#34;: &#34;homebrew_bottle&#34;,
    &#34;org.opencontainers.image.created&#34;: &#34;2023-09-16&#34;,
    &#34;org.opencontainers.image.description&#34;: &#34;Vi &#39;workalike&#39; with many additional features&#34;,
    &#34;org.opencontainers.image.documentation&#34;: &#34;https://formulae.brew.sh/formula/vim&#34;,
    &#34;org.opencontainers.image.license&#34;: &#34;Vim&#34;,
    &#34;org.opencontainers.image.ref.name&#34;: &#34;9.0.1900&#34;,
    &#34;org.opencontainers.image.revision&#34;: &#34;a78712b62dd7fba03243de22c20e4858d0fd1802&#34;,
    &#34;org.opencontainers.image.source&#34;: &#34;https://github.com/homebrew/homebrew-core/blob/a78712b62dd7fba03243de22c20e4858d0fd1802/Formula/v/vim.rb&#34;,
    &#34;org.opencontainers.image.title&#34;: &#34;vim&#34;,
    &#34;org.opencontainers.image.url&#34;: &#34;https://www.vim.org/&#34;,
    &#34;org.opencontainers.image.vendor&#34;: &#34;homebrew&#34;,
    &#34;org.opencontainers.image.version&#34;: &#34;9.0.1900&#34;
  }
}
</pre>
<p>And, voilÃ , the block above shows us the &#39;<code>sh.brew.bottle.digest</code>&#39; that we need in the next step</p>
<p>You can either pick through the file in your fav editor of-choice, but I found (when downloading many files from GitHub Packages) it was much easier to use &#39;<code>jq</code>&#39;</p>
<pre title="">cat manifest.json | jq &#39;.manifests[] | select(.platform.&#34;os.version&#34; | startswith(&#34;macOS &lt;version_num&gt;&#34;)) | select(.platform.architecture==&#34;&lt;arch&gt;&#34;)&#39; | jq -r &#39;.annotations.&#34;sh.brew.bottle.digest&#34;&#39;
</pre>
<p>For example, here&#39;s an execution that uses &#39;<code>jq</code>&#39; to extract the bottle digest hash for the blob for macOS 11 on a system with an amd64 processor.</p>
<pre title="">user@disp7456:~$ cat manifest.json | jq &#39;.manifests[] | select(.platform.&#34;os.version&#34; | startswith(&#34;macOS 11&#34;)) | select(.platform.architecture==&#34;amd64&#34;)&#39; | jq -r &#39;.annotations.&#34;sh.brew.bottle.digest&#34;&#39;
6cbad503034158806227128743d2acc08773c90890cea12efee25c4a53399d02
user@disp7456:~$ 
</pre>
<h3>Download the file</h3>
<p>Now, we can finally download our file if we just pass the &#39;<code>sh.brew.bottle.digest</code>&#39; hash found above into the <code>GET /v2/&lt;name&gt;/blobs/<digest></digest></code>&#39; API endpoint, as shown in the <a href="#table">table</a> above</p>
<pre title="">curl -Lo &lt;package_name&gt;-&lt;package_version&gt;.bottle.tar.gz -H &#34;Authorization: Bearer ${token}&#34; -H &#39;Accept: application/vnd.oci.image.layer.v1.tar+gzip&#39; https://ghcr.io/v2/homebrew/core/&lt;package_name&gt;/blobs/sha256:&lt;sh.brew.bottle.digest&gt;
</pre>
<p>For example, the following command downloads &#39;<code>vim-9.0.1900.bottle.tar.gz</code>&#39;</p>
<pre title="">user@disp7456:~$ curl -Lo vim-9.0.1900.bottle.tar.gz -H &#34;Authorization: Bearer ${token}&#34; -H &#39;Accept: application/vnd.oci.image.layer.v1.tar+gzip&#39; https://ghcr.io/v2/homebrew/core/vim/blobs/sha256:6cbad503034158806227128743d2acc08773c90890cea12efee25c4a53399d02
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
100 12.9M  100 12.9M    0     0  1450k      0  0:00:09  0:00:09 --:--:-- 2798k
user@disp7456:~$ 

user@disp7456:~$ ls
 vim-9.0.1900.bottle.tar.gz
user@disp7456:~$ 
</pre>
<h3>Install the file</h3>
<p>Finally, you can now transfer the file &#39;<code>vim-9.0.1900.bottle.tar.gz</code>&#39; to your macOS system and install it with brew.</p>
<pre title="">brew reinstall --verbose --debug path/to/&lt;package_name&gt;-&lt;package_version&gt;.tar.gz
</pre>
<p>Here&#39;s an example execution</p>
<pre title="">user@host ~ % /usr/local/bin/brew reinstall --debug --verbose build/deps/vim-9.0.1900.bottle.tar.gz
/usr/local/Homebrew/Library/Homebrew/brew.rb (Formulary::FromNameLoader): loading vim
/usr/local/Homebrew/Library/Homebrew/brew.rb (Formulary::FromBottleLoader): loading build/deps/vim-9.0.1900.bottle.tar.gz
...
â›[34m==&gt;â›[0m â›[1mSummaryâ›[0m
ðŸº  /usr/local/Cellar/vim/9.0.1900: 2,220 files, 40.3MB
...
user@host ~ % 
</pre>
<p>The package &#39;<code>vim</code>&#39; is now installed.</p>

<p>I wrote this article because many, many folks have inquired about how to manually download files from OCI registries on the Internet, but their simple queries are usually returned with a barrage of useless counter-questions: why the heck would you want to do that!?!</p>
<p>The answer is varied.</p>
<p>Some people need to get files onto a restricted environment. Either their org doesn&#39;t grant them permission to install software on the machine, or the system has firewall-restricted internet access -- or doesn&#39;t have internet access at all.</p>
<h2 id="3tofu">3TOFU</h2>
<p>Personally, the reason that I wanted to be able to download files from an OCI registry was for <a href="https://tech.michaelaltfield.net/2024/08/04/3tofu/">3TOFU</a>.</p>
<p><a href="https://tech.michaelaltfield.net/2024/08/04/3tofu/"><img decoding="async" loading="lazy" src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/x3tofu_featuredImage.jpg.pagespeed.ic.St6s51_dPp.jpg" alt="Verifying Unsigned Releases with 3TOFU" width="1200" height="628" srcset="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/x3tofu_featuredImage.jpg.pagespeed.ic.St6s51_dPp.jpg 1200w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/x3tofu_featuredImage-300x157.jpg.pagespeed.ic.T5UE3kAvEO.jpg 300w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/x3tofu_featuredImage-1024x536.jpg.pagespeed.ic.KjX67P86_E.jpg 1024w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/x3tofu_featuredImage-768x402.jpg.pagespeed.ic.iXREC1J7qz.jpg 768w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/x3tofu_featuredImage-150x79.jpg.pagespeed.ic.meZGDvdY3h.jpg 150w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/x3tofu_featuredImage-400x209.jpg.pagespeed.ic.3QDDoI44ya.jpg 400w" sizes="(max-width: 1200px) 100vw, 1200px"/></a></p>
<p>Unfortunately, most apps using OCI registries are <em>extremely</em> insecure. Docker, for example, will happily download malicious images. By default, <a href="https://security.stackexchange.com/questions/238916/how-to-pin-public-root-key-when-downloading-an-image-with-docker-pull-docker-co?noredirect=1&amp;lq=1">it doesn&#39;t do <em>any</em> authenticity verifications</a> on the payloads it downloaded. Even if you manually enable DCT, there&#39;s loads of <a href="https://github.com/docker/cli/issues/2752">pending issues</a> with it.</p>
<p>Likewise, the macOS package manager <a href="https://brew.sh/">brew</a> has this same problem: it will happily download and install malicious code, because it doesn&#39;t use cryptography to verify the authenticity of anything that it downloads. This introduces <a href="https://en.wikipedia.org/wiki/Watering_hole_attack">watering hole vulnerabilities</a> when developers use brew to install dependencies in their CI pipelines.</p>
<p>My solution to this? <a href="https://tech.michaelaltfield.net/2024/08/04/3tofu/">3TOFU</a>. And that requires me to be able to download the file (for verification) on three distinct linux VMs using curl or wget.</p>
<blockquote><p>
âš  NOTE: 3TOFU is an approach to harm reduction.</p>
<p>It is not wise to download and run binaries or code whose authenticity you cannot verify using a cryptographic signature from a key stored offline. However, sometimes we cannot avoid it. If you&#39;re going to proceed with running untrusted code, then following a <a href="https://tech.michaelaltfield.net/2024/08/04/3tofu/">3TOFU procedure</a> may reduce your risk, but it&#39;s better to avoid running unauthenticated code if at all possible.
</p></blockquote>
<h2>Registry (ab)use</h2>
<p>Container registries were created in 2013 to provide a clever &amp; complex solution to a problem: how to package and serve multiple versions of simplified sources to various consumers spanning multiple operating systems and architectures -- while also packaging them into small, discrete &#34;layers&#34;.</p>
<p>However, if your project is just serving simple files, then the only thing gained by uploading them to a complex system like a container registry is headaches. Why do developers do this?</p>
<p>In the case of brew, their free hosing provider (JFrog&#39;s Bintray) <a href="https://jfrog.com/blog/into-the-sunset-bintray-jcenter-gocenter-and-chartcenter/">shutdown in 2021</a>. Brew was already hosting their code on GitHub, so I guess someone looked at &#34;GitHub Packages&#34; and <a href="https://github.com/orgs/Homebrew/discussions/691">figured it was</a> a good (read: free) replacement.</p>
<p>Many developers using Container Registries don&#39;t need the complexity, but -- well -- they&#39;re just using it as a free place for their FOSS project to store some files, man.</p>

<ol>
<li><a href="https://github.com/opencontainers/distribution-spec/releases/download/v1.1.0/oci-distribution-spec-v1.1.0.pdf">OCI Distribution Spec v1.1.0</a></li>
<li><a href="https://github.com/distribution/distribution/blob/5cb406d511b7b9163bff9b6439072e4892e5ae3b/docs/spec/api.md">Docker Registry HTTP API V2 Protocol Specification</a></li>
<li><a href="https://github.com/moby/moby/blob/79910625f0a7aa76590e4362817dda22f28343aa/image/spec/v1.md">Docker Image Specification v1.0.0</a></li>
<li>List of <a href="https://github.com/opencontainers/image-spec/blob/main/media-types.md">OCI Media Types</a></li>
<li><a href="https://docs.docker.com/registry/">Docker Registry (Documentation)</a></li>
<li><a href="https://docs.github.com/en/packages/learn-github-packages">GitHub Packages (Documentation)</a></li>
<li><a href="https://github.com/distribution/distribution/">CNCF Distribution Specification (GitHub)</a></li>
<li><a href="https://github.com/opencontainers/distribution-spec">OCI Distribution Specification (GitHub)</a></li>
<li>Request to add the not-yet-existing <a href="https://github.com/opencontainers/distribution-spec/issues/240">OCI Auth Specification (GitHub)</a></li>
<li><a href="https://github.com/moby/moby">Moby Project (GitHub)</a></li>
<li>My <a href="https://github.com/BusKill/buskill-app/issues/78#issuecomment-2015962034">GitHub Ticket</a> learning how to manually download brew package dependencies from GitHub Packages for 3TOFU with BusKill</li>
<li>More info about the Docker Image Spec (V1 and V2) - <a href="https://matrix.ai/blog/docker-image-specification-v1-vs-v2/">https://matrix.ai/blog/docker-image-specification-v1-vs-v2/</a></li>
<li>Cool tool that serves as a proxy for downloading docker images for you - <a href="https://github.com/jadolg/DockerImageSave">DockerImageSave</a></li>
<li>Script for downloading &#34;frozen&#34; images from docker - <a href="https://github.com/moby/moby/blob/master/contrib/download-frozen-image-v2.sh">download-frozen-image-v2.sh</a></li>
<li>Python tool to download docker images - <a href="https://github.com/NotGlop/docker-drag/">docker-drag</a></li>
<li>My article on <a href="https://tech.michaelaltfield.net/2024/08/04/3tofu/">3TOFU</a></li>
</ol>
<div itemtype="http://schema.org/Person" itemscope="" itemprop="author"><div><p><img src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/2019/04/100x100xavatar_square_150.jpg.pagespeed.ic.lvLST4AWRQ.jpg" width="100" height="100" alt="headshot of Michael Altfield" itemprop="image"/></p><div><div itemprop="description"><p>Hi, Iâ€™m Michael Altfield. I write articles about opsec, privacy, and devops <a href="https://michaelaltfield.net/biography/">âž¡</a></p>
<p><a href="https://michaelaltfield.net/biography/">About Michael</a></p>
</div></div></div></div></div></div>
  </body>
</html>
