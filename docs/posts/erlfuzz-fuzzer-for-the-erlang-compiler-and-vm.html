<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://erlangforums.com/t/open-sourcing-erlfuzz/2562">Original</a>
    <h1>Erlfuzz – Fuzzer for the Erlang compiler and VM</h1>
    
    <div id="readability-page-1" class="page"><div id="main-outlet" role="main">
        

  


      <div id="post_1" itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          


          <p><span>
              <time itemprop="datePublished" datetime="2023-04-24T14:31:26Z">
                April 24, 2023,  2:31pm
              </time>
              <meta itemprop="dateModified" content="2023-04-24T14:31:26Z"/>
          <span itemprop="position">#1</span>
          </span>
        </p></div>
        <div itemprop="articleBody">
          
<h2>
<a name="what-is-it-2" href="#what-is-it-2"></a>What is it?</h2>
<p>erlfuzz is a new tool for generating random Erlang programs. It is designed to test various pieces of the Erlang ecosystem such as the erlc compiler, the BEAM VM, eqWAlizer, dialyzer, infer for Erlang, erlfmt, etc…</p>
<p>It has been under development since last summer, and has just been open sourced: <a href="https://github.com/WhatsApp/erlfuzz" rel="noopener nofollow ugc">GitHub - WhatsApp/erlfuzz: erlfuzz is a small standalone generator of random erlang programs used to fuzz the erlang compiler and VM, as well as other tools such as erlfmt, dialyzer, eqWAlizer, etc... It does not currently use coverage information or do anything especially clever, except for carefully handling Erlang&#39;s scoping rules.</a></p>
<h2>
<a name="strengths-and-limitations-3" href="#strengths-and-limitations-3"></a>Strengths and limitations</h2>
<p>Its main features are the following:</p>
<ul>
<li>
<p>Support for most of the language, including some new features such as maybe expressions and map comprehensions.</p>
</li>
<li>
<p>A very fine-grained understanding of Erlang’s scoping rules, allowing it to generate complex code that reuses variables without generating invalid Erlang code.</p>
</li>
<li>
<p>An automated test case minimizer, that usually reduces the test cases from several thousand lines to a couple of lines.</p>
</li>
</ul>
<p>It currently has some limitations to be kept in mind:</p>
<ul>
<li>It does not use any coverage information</li>
<li>It generates quite a few ill-typed programs</li>
<li>The test case minimizer only works on test cases found by the fuzzer</li>
</ul>
<h2>
<a name="results-4" href="#results-4"></a>Results</h2>
<p>Erlfuzz has found so far:</p>
<ul>
<li>62 bugs in erlc</li>
<li>7 bugs in the VM</li>
<li>6 bugs in dialyzer</li>
<li>5 bugs in eqwalizer</li>
<li>2 bugs in infer</li>
<li>1 bug in erlfmt</li>
</ul>
<p>While most of these are crashes of the tools on rare code patterns, several bugs are more interesting. For example:</p>
<ul>
<li>Running the VM in debug mode discovered that it was emitting completely wrong (and memory unsafe!) code in release mode for some guards: <a href="https://github.com/erlang/otp/issues/6634" rel="noopener nofollow ugc">[jit] &#34;beam/jit/beam_jit_args.hpp:243:ArgRegister() Assertion failed: isRegister()&#34; · Issue #6634 · erlang/otp · GitHub</a>.</li>
<li>Comparing the result of running the VM in both interpreter and JIT modes discovered another issue with the JIT where it would in some conditions compute the wrong result for negation of floats (<a href="https://github.com/erlang/otp/issues/6717" rel="noopener nofollow ugc">[vm] Floating point discrepancy (-0.0 vs +0.0) between `-emu_flavor emu` and `-emu_flavor jit` · Issue #6717 · erlang/otp · GitHub</a>)</li>
<li>Comparing the result of running erlang code that had been compiled with and without optimizations discovered that a wrong optimization could cause some <code>badkey</code> exceptions to be silently swallowed: <a href="https://github.com/erlang/otp/issues/6960" rel="noopener nofollow ugc">erlc folds away an unused map update that should throw an exception · Issue #6960 · erlang/otp · GitHub</a>
</li>
</ul>
<p>erlfuzz has also been successfully used to detect bugs in PRs before they were merged. The most extreme example is <a href="https://github.com/erlang/otp/pull/6415" rel="noopener nofollow ugc">Lift restrictions for matching of binaries and maps by bjorng · Pull Request #6415 · erlang/otp · GitHub</a> (which itself was motivated by corner cases of the language discovered by erlfuzz). It went through multiple rounds of revisions as the fuzzer found 8 different bugs in it over time.</p>
<p>A more surprising benefit of this work was to improve the official Erlang documentation. I tried to make Erlfuzz able to generate any string that corresponds to a valid Erlang program according to the documentation, and this revealed several places where the documentation was either ambiguous, or outright missing some rules. E.g. <a href="https://github.com/erlang/otp/pull/6929" rel="noopener nofollow ugc">Address a few omissions in documentation of comprehensions by bjorng · Pull Request #6929 · erlang/otp · GitHub</a>.</p>
<p>Finally, Björn Gustavsson made a creative use of the fuzzer, adding crashes on lines of the compiler that were not covered by the test suite, and getting minimized test cases to add to the suite for many of these lines, improving the test coverage: <a href="https://github.com/erlang/otp/pull/6872" rel="noopener nofollow ugc">Cover more code in the compiler application by bjorng · Pull Request #6872 · erlang/otp · GitHub</a>.</p>
<h2>
<a name="future-work-5" href="#future-work-5"></a>Future work</h2>
<p>The main priority at this point is to integrate erlfuzz into CI for all of the tools mentioned above.</p>
<p>I hope to cover the last few missing parts of the language later on, as well as try to generate more well-typed programs to hit code deeper in tools like eqWAlizer.</p>
<h2>
<a name="thanks-6" href="#thanks-6"></a>Thanks</h2>
<p>I owe many thanks to Björn Gustavsson and John Hogberg from Ericsson for fixing with stunning speed all of the erlc and BEAM bugs that I reported.</p>
<p>I’m also grateful to my colleagues at WhatsApp that helped me with various aspects of this work, from getting eqWAlizer and infer working to reviewing all of my patches.</p>
        </div>

        <meta itemprop="headline" content="Open sourcing erlfuzz"/>
          <meta itemprop="keywords" content="erlang"/>

        

         

      </div>
      <div id="post_2" itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            <a itemprop="url" href="https://erlangforums.com/u/nzok"><span itemprop="name">nzok</span></a>
            
          </span></p>


          <p><span>
              <time itemprop="datePublished" datetime="2023-04-25T11:12:47Z">
                April 25, 2023, 11:12am
              </time>
              <meta itemprop="dateModified" content="2023-04-25T11:12:47Z"/>
          <span itemprop="position">#2</span>
          </span>
        </p></div>
        <div itemprop="articleBody">
          <p>I tried to send a congratulatory/appreciative “WELL DONE!” message,</p>
<p>Is that clear enough, Mr Mailserver?</p>
        </div>

        <meta itemprop="headline" content="Open sourcing erlfuzz"/>

        

         

      </div>
      <div id="post_3" itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        <div>
          
          <p><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            <a itemprop="url" href="https://erlangforums.com/u/AstonJ"><span itemprop="name">AstonJ</span></a>
            
          </span></p>


          <p><span>
              <time itemprop="datePublished" datetime="2023-04-25T19:48:50Z">
                April 25, 2023,  7:48pm
              </time>
              <meta itemprop="dateModified" content="2023-04-25T19:48:50Z"/>
          <span itemprop="position">#3</span>
          </span>
        </p></div>
        <div itemprop="articleBody">
          <p>Most modern platforms have a min character check on post submissions as it helps prevent low quality/spam type posts. Yes, sometimes genuine remarks fall foul but on balance the benefits far outweigh the negatives, particularly since this can easily be rectified. In your case you could have just swapped it  for “This is fantastic news - well done!” or, better still, what you ended up saying about it <img src="https://erlangforums.com/images/emoji/apple/smiley.png?v=12" title=":smiley:" alt=":smiley:" loading="lazy" width="20" height="20"/></p>
<p><em>Speaking of forum etiquette, could you also please disable hard-wrapping on your email client when posting to the forum please? This makes it difficult to read your posts, especially on mobile phones and tablets. Thanks <img src="https://erlangforums.com/images/emoji/apple/blush.png?v=12" title=":blush:" alt=":blush:" loading="lazy" width="20" height="20"/></em></p>
        </div>

        <meta itemprop="headline" content="Open sourcing erlfuzz"/>

        

         

      </div>
      <div id="post_4" itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
        
        <div itemprop="articleBody">
          
<p>Very well said. I’m doubling down on the being impressed, happy, and grateful. And kudos to the OTP team on addressing those quickly (as usual!).</p>
        </div>

        <meta itemprop="headline" content="Open sourcing erlfuzz"/>

        

         

      </div>






    </div></div>
  </body>
</html>
