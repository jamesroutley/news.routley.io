<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://minor.gripe/posts/2025-11-18-humbly_maintaining_a_nix_package/">Original</a>
    <h1>Humbly Maintaining a NixOS Package</h1>
    
    <div id="readability-page-1" class="page"><div>
                <div>
  <div>
  

  <div>
    <p><time datetime=" 2025-11-18T11:41:55-0600">
        November 18, 2025
      </time>
      
      <span> - </span>
      <span>
        
          
        

        <span>4 mins read</span>
      </span>
    </p>

    
    <ul>
      
      <li>
        <a href="https://www.blender.org/tags/nix">nix</a>
      </li>
      
      <li>
        <a href="https://www.blender.org/tags/practices">practices</a>
      </li>
      
    </ul>
    
  </div>

  
  

  
</div>

  <p>I’ve got a small handful of packages on <a href="https://search.nixos.org/packages" target="_blank">Nixpkgs</a> that I maintain. When I was starting out, I didn’t really know how to do any of that, and was fortunate enough to have some friends onboard me. In the spirit of giving back, I’ll walk through how I do an update pass today on a simple package, and give some background information on how to make it easy.</p>
<h3 id="workflow-of-updating-a-nixos-package">Workflow of updating a NixOS package</h3>
<p>I’m a maintainer for the <a href="https://search.nixos.org/packages?channel=unstable&amp;query=lmstudio" target="_blank">lmstudio</a> package, which wraps the binaries from <a href="https://lmstudio.ai/" target="_blank">LM Studio</a> (a friendly GUI/IDE for AI model development work). This workflow is for that package; other packages (especially those used by others or built from source) will probably have different details.</p>
<ol>
<li>Find out that my package needs updating.</li>
<li>I sync my nixpkgs fork with upstream.</li>
<li>I create a branch in my fork of the form <code>lmstudio-X.Y.Z.W</code> and switch to it.</li>
<li>I run our update script (from the root nixpkgs directory) via <code>nix-shell maintainers/scripts/update.nix --argstr package lmstudio</code>.</li>
<li>I commit the resulting changes, which in my case are a changed hash and version number, using the format <code>lmstudio: X.Y.Z.W -&gt; Q.R.S.T</code>. You ideally only want one commit or other maintainers get mad at you.</li>
<li>I test the changes via <code>nix-shell -I nixpkgs=~/projects/nix/nixpkgs -p lmstudio</code>.</li>
<li>I open a PR against upstream <code>master</code> branch with the title <code>lmstudio: X.Y.Z.W -&gt; Q.R.S.T</code> and link the changelog. Example <a href="https://github.com/NixOS/nixpkgs/pull/452412" target="_blank">here</a>.</li>
<li>Some kind souls will review the PR using nixpkgs-review: <code>nixpkgs-review pr --post-result 452412</code>. This will (assuming they’re setup with <code>gh</code>) check out the PR in a sandbox, build it, and give them a chance to run it for manual testing. After, it’ll comment with a summary saying that ye, verily, did the PR build on their machine.</li>
<li>Eventually, if approved, it’ll get merged into unstable by somebody with a commit bit. Backporting may or may not also occur.</li>
</ol>
<h3 id="nix-shell-vs-nix-build">nix-shell vs nix-build</h3>
<p>Instead of…</p>
<div><pre tabindex="0"><code data-lang="shell"><span><span>$ nix-shell -I ~/projects/nix/nixpkgs -p lmstudio
</span></span></code></pre></div><p>…you can also use…</p>
<div><pre tabindex="0"><code data-lang="shell"><span><span>$ nix-build -I ~/projects/nix/nixpkgs -A lmstudio
</span></span></code></pre></div><p>After that, you’d have a <code>result</code> directory symlinked into the nix store:</p>
<div><pre tabindex="0"><code data-lang="shell"><span><span><span>[</span>crertel@host:~/projects/nix/nixpkgs<span>]</span>$ ls -la result
</span></span><span><span>lrwxrwxrwx <span>1</span> crertel users <span>61</span> Nov <span>18</span> 12:31 result -&gt; /nix/store/0rifw0s3frxqk6j14gpjag90wd9d28hn-lmstudio-0.3.31-7
</span></span><span><span>
</span></span><span><span><span>[</span>crertel@host:~/projects/nix/nixpkgs<span>]</span>$ ls -la result/
</span></span><span><span>bin/   share/
</span></span><span><span>
</span></span><span><span><span>[</span>crertel@host:~/projects/nix/nixpkgs<span>]</span>$ ls -la result/bin/
</span></span><span><span>total <span>100372</span>
</span></span><span><span>dr-xr-xr-x <span>2</span> root root      <span>4096</span> Dec <span>31</span>  <span>1969</span> .
</span></span><span><span>dr-xr-xr-x <span>4</span> root root      <span>4096</span> Dec <span>31</span>  <span>1969</span> ..
</span></span><span><span>-r-xr-xr-x <span>1</span> root root <span>102767744</span> Dec <span>31</span>  <span>1969</span> lms
</span></span><span><span>lrwxrwxrwx <span>1</span> root root        <span>67</span> Dec <span>31</span>  <span>1969</span> lm-studio -&gt; /nix/store/gp0qyqzb4kp8j892sdnjyd8b891mmvck-lmstudio-0.3.31-7-bwrap
</span></span></code></pre></div><p>Neat, huh? I find that the <code>nix-shell</code> version is a bit easier for iterating and poking around (and it mimics how I normally use nix anyways), but <code>nix-build</code> will be closer to the thing that actually gets the final artifact out.</p>
<h3 id="how-the-update-script-works">How the update script works</h3>
<p>Before we had a good update script (I think @deftdawg was the one who got this working), we had to manually download and hash releases and update the version numbers; with the script, though, we can just use that one-liner above.</p>
<p>The script is called from <code>packages.nix</code>:</p>
<div><pre tabindex="0"><code data-lang="nix"><span><span>{
</span></span><span><span>  lib<span>,</span>
</span></span><span><span>  stdenv<span>,</span>
</span></span><span><span>  callPackage<span>,</span>
</span></span><span><span>  <span>...</span>
</span></span><span><span>}<span>@</span>args:
</span></span><span><span><span>let</span>
</span></span><span><span>  pname <span>=</span> <span>&#34;lmstudio&#34;</span>;
</span></span><span><span>
</span></span><span><span>  version_aarch64-darwin <span>=</span> <span>&#34;0.3.31-7&#34;</span>;
</span></span><span><span>  hash_aarch64-darwin <span>=</span> <span>&#34;sha256-OyPHKUmZsIU0kc3JxwxdxACSN7hR6gFWjMnGp1x5diQ=&#34;</span>;
</span></span><span><span>  version_x86_64-linux <span>=</span> <span>&#34;0.3.31-7&#34;</span>;
</span></span><span><span>  hash_x86_64-linux <span>=</span> <span>&#34;sha256-NeVteQlzygHkwwgLkB5n7meH02WhFE68KkbGRulDiC0=&#34;</span>;
</span></span><span><span>
</span></span><span><span>  meta <span>=</span> {
</span></span><span><span>    description <span>=</span> <span>&#34;LM Studio is an easy to use desktop app for experimenting with local and open-source Large Language Models (LLMs)&#34;</span>;
</span></span><span><span>    homepage <span>=</span> <span>&#34;https://lmstudio.ai/&#34;</span>;
</span></span><span><span>    license <span>=</span> lib<span>.</span>licenses<span>.</span>unfree;
</span></span><span><span>    mainProgram <span>=</span> <span>&#34;lm-studio&#34;</span>;
</span></span><span><span>    maintainers <span>=</span> <span>with</span> lib<span>.</span>maintainers; [ crertel ];
</span></span><span><span>    platforms <span>=</span> [
</span></span><span><span>      <span>&#34;x86_64-linux&#34;</span>
</span></span><span><span>      <span>&#34;aarch64-darwin&#34;</span>
</span></span><span><span>    ];
</span></span><span><span>    sourceProvenance <span>=</span> <span>with</span> lib<span>.</span>sourceTypes; [ binaryNativeCode ];
</span></span><span><span>    broken <span>=</span> stdenv<span>.</span>hostPlatform<span>.</span>isDarwin; <span># Upstream issue: https://github.com/lmstudio-ai/lmstudio-bug-tracker/issues/347</span>
</span></span><span><span>  };
</span></span><span><span><span>in</span>
</span></span><span><span><span>if</span> stdenv<span>.</span>hostPlatform<span>.</span>isDarwin <span>then</span>
</span></span><span><span>  callPackage <span>./darwin.nix</span> {
</span></span><span><span>    <span>inherit</span> pname meta;
</span></span><span><span>    passthru<span>.</span>updateScript <span>=</span> <span>./update.sh</span>;
</span></span><span><span>    version <span>=</span> version_aarch64-darwin;
</span></span><span><span>    url <span>=</span>
</span></span><span><span>      args<span>.</span>url
</span></span><span><span>        or <span>&#34;https://installers.lmstudio.ai/darwin/arm64/</span><span>${</span>version_aarch64-darwin<span>}</span><span>/LM-Studio-</span><span>${</span>version_aarch64-darwin<span>}</span><span>-arm64.dmg&#34;</span>;
</span></span><span><span>    hash <span>=</span> args<span>.</span>hash or hash_aarch64-darwin;
</span></span><span><span>  }
</span></span><span><span><span>else</span>
</span></span><span><span>  callPackage <span>./linux.nix</span> {
</span></span><span><span>    <span>inherit</span> pname meta;
</span></span><span><span>    passthru<span>.</span>updateScript <span>=</span> <span>./update.sh</span>;
</span></span><span><span>    version <span>=</span> version_x86_64-linux;
</span></span><span><span>    url <span>=</span>
</span></span><span><span>      args<span>.</span>url
</span></span><span><span>        or <span>&#34;https://installers.lmstudio.ai/linux/x64/</span><span>${</span>version_x86_64-linux<span>}</span><span>/LM-Studio-</span><span>${</span>version_x86_64-linux<span>}</span><span>-x64.AppImage&#34;</span>;
</span></span><span><span>    hash <span>=</span> args<span>.</span>hash or hash_x86_64-linux;
</span></span><span><span>  }
</span></span></code></pre></div><p>Note the <code>passthru.updateScript</code> attribute, which refers to an <code>update.sh</code>. That script looks like:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span><span>#!/usr/bin/env nix-shell
</span></span></span><span><span><span></span><span>#!nix-shell -i bash -p curl common-updater-scripts</span>
</span></span><span><span>
</span></span><span><span>set -euo pipefail
</span></span><span><span>
</span></span><span><span><span>for</span> system in <span>&#34;aarch64-darwin darwin/arm64&#34;</span> <span>&#34;x86_64-linux linux/x64&#34;</span>; <span>do</span>
</span></span><span><span>  <span># shellcheck disable=SC2086</span>
</span></span><span><span>  set -- <span>${</span>system<span>}</span> <span># split string into variables $1 and $2</span>
</span></span><span><span>
</span></span><span><span>  arch<span>=</span><span>&#34;</span><span>${</span>1<span>}</span><span>&#34;</span>
</span></span><span><span>  platform<span>=</span><span>&#34;</span><span>${</span>2<span>}</span><span>&#34;</span>
</span></span><span><span>
</span></span><span><span>  url<span>=</span><span>$(</span>curl -ILs -o /dev/null -w %<span>{</span>url_effective<span>}</span> <span>&#34;https://lmstudio.ai/download/latest/</span><span>${</span>platform<span>}</span><span>&#34;</span><span>)</span>
</span></span><span><span>  version<span>=</span><span>&#34;</span><span>$(</span>echo <span>&#34;</span><span>${</span>url<span>}</span><span>&#34;</span> | cut -d/ -f6<span>)</span><span>&#34;</span>
</span></span><span><span>  hash<span>=</span><span>$(</span>nix --extra-experimental-features nix-command hash convert --hash-algo sha256 <span>&#34;</span><span>$(</span>nix-prefetch-url <span>&#34;</span><span>${</span>url<span>}</span><span>&#34;</span><span>)</span><span>&#34;</span><span>)</span>
</span></span><span><span>
</span></span><span><span>  update-source-version lmstudio <span>&#34;</span><span>${</span>version<span>}</span><span>&#34;</span> <span>&#34;</span><span>${</span>hash<span>}</span><span>&#34;</span> --system<span>=</span><span>&#34;</span><span>${</span>arch<span>}</span><span>&#34;</span> --version-key<span>=</span><span>&#34;version_</span><span>${</span>arch<span>}</span><span>&#34;</span> <span>\
</span></span></span><span><span><span></span>    2&gt; &gt;<span>(</span>tee /dev/stderr<span>)</span> | grep -q <span>&#34;nothing to do&#34;</span> <span>&amp;&amp;</span> exit
</span></span><span><span><span>done</span>
</span></span></code></pre></div><p>What that script does (and your script could do something similar!) is work out the version and hash for the most recent version of this software using some curl magic, and then invoke the <code>update-source-version</code> script. <a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/common-updater/scripts/update-source-version" target="_blank">That script</a> will fixup the old <code>package.nix</code> and propose the changes (which is why we have to commit it after).</p>
<h3 id="further-learning">Further learning</h3>
<p>If you want to learn more about this, some places to check:</p>
<ul>
<li><a href="https://wiki.nixos.org/wiki/Nixpkgs/Update_Scripts" target="_blank">https://wiki.nixos.org/wiki/Nixpkgs/Update_Scripts</a></li>
<li><a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md#automatic-package-updates" target="_blank">https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md#automatic-package-updates</a></li>
<li><a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/common-updater/scripts/update-source-version" target="_blank">https://github.com/NixOS/nixpkgs/blob/master/pkgs/common-updater/scripts/update-source-version</a></li>
</ul>

  
  <hr/>
<div>
    
	    
            <a href="https://www.blender.org/posts/2025-11-10-bozo_scoring_communities/?ref=footer"><span>« Previous</span></a>
        
	    
    
</div>

  
</div>
            </div></div>
  </body>
</html>
