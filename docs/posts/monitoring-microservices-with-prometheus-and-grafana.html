<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://navendu.me/posts/introduction-to-monitoring-microservices/">Original</a>
    <h1>Monitoring Microservices with Prometheus and Grafana</h1>
    
    <div id="readability-page-1" class="page"><div><p>Continuous monitoring is critical in making microservice systems robust. Without proper monitoring, microservices can quickly become overwhelmed, leading to errors and loss in performance.</p><p>Through continuous monitoring, developers can detect issues with their services as soon as they arise and take measures to prevent significant damage. It also provides insights into how your services are performing, allowing you to make informed decisions.</p><p>This article will introduce how you can set up monitoring on your microservice application using two of the popular tools in this space, <a href="https://prometheus.io/" target="_blank">Prometheus</a>
, and <a href="https://grafana.com/" target="_blank">Grafana</a>
.</p><p>The source code and Docker Compose file for this tutorial are available in <a href="https://github.com/navendu-pottekkat/monitoring-101" target="_blank">monitoring-101</a>
.</p><h2 id="prometheus-basics">Prometheus Basics</h2><p>Prometheus is an open source, monitoring and alerting tool. It “pulls” metrics (measurements) from microservices by sending HTTP requests and stores the results in a time-series database.</p><p>You can instrument your services by using <a href="https://prometheus.io/docs/instrumenting/clientlibs/" target="_blank">client libraries</a>
provided by Prometheus. This will enable you to create and collect custom metrics from your services.</p><p>Prometheus also has <a href="https://prometheus.io/docs/instrumenting/exporters/" target="_blank">exporters</a>
that let you pull metrics that are not in Prometheus format. An exporter acts as a middleman and transforms exported data into Prometheus readable format.</p><p>flowchart LR
app(&#34;Instrumented service\n or Exporter&#34;) &lt;--&gt; |scrape metrics| p --&gt; |push alerts| am(&#34;Alert\nmanager&#34;)
style p stroke: #e6522c
style db stroke: #e6522c
subgraph p [&#34;Prometheus server&#34;]
db(Time series\ndatabase)
end</p><p>Prometheus provides a powerful query language, <a href="https://prometheus.io/docs/prometheus/latest/querying/basics/" target="_blank">PromQL</a>
, to work with this collected data. You can use PromQL to create complex queries to filter, aggregate, and transform the data to the desired format.</p><p>In addition to pulling metrics, Prometheus can also trigger <a href="https://prometheus.io/docs/alerting/latest/overview/" target="_blank">alerts</a>
when set thresholds are breached. The alerting mechanism is highly configurable and can send notifications to places like Slack or email.</p><p>Prometheus has a GUI that lets you visualize the collected metrics easily. It also integrates with other advanced visualization tools like Grafana.</p><figure><a href="https://navendu.me/images/introduction-to-monitoring-microservices/prometheus-dashboard.png" target="_blank"><img loading="lazy" src="https://navendu.me/images/introduction-to-monitoring-microservices/prometheus-dashboard.png#center" alt="Shows the memory stats of a Go-based service"/></a><figcaption>Prometheus Dashboard<p>Shows the memory stats of a Go-based service</p></figcaption></figure><h3 id="metric-types">Metric Types</h3><p>Prometheus offers four core metric types:</p><ol><li><strong>Counter</strong>: represents a single monotonically increasing counter. Its value can increase or reset to zero on restart. You can use it to represent metrics like the number of requests served.</li><li><strong>Gauge</strong>: represents a numerical value that can go up or down. You can use it to represent values like memory usage or the number of requests per second.</li><li><strong>Histogram</strong>: samples data into configurable buckets. Use it to represent values like request durations or response sizes.</li><li><strong>Summary</strong>: similar to histogram, it also calculates configurable values over a sliding time window.</li></ol><p>You can learn more about these metric types and how to use them from the <a href="https://prometheus.io/docs/tutorials/understanding_metric_types/" target="_blank">official documentation</a>
.</p><h2 id="sample-application">Sample Application</h2><p>Our <a href="https://github.com/navendu-pottekkat/monitoring-101" target="_blank">sample application</a>
will consist of an API gateway, a Go app, and a Python app.</p><p>flowchart LR
u(User) --&gt; |/hello/es?name=Navendu| a(Apache\nAPISIX) --&gt; |/es?name=Navendu| g(Go\nservice) --&gt; |/es| p(Python\nservice)
p --&gt; |&#34;{message: &#39;Hola&#39;}&#34;| g
g --&gt; |&#34;Hola Navendu!&#34;| a
a --&gt; |&#34;Hola Navendu!&#34;| u
style a stroke: #e62129</p><p>The application will return, “Hello &lt;name&gt;!” in the language you choose with the <code>&lt;name&gt;</code> you provide. Apache APISIX will be the API gateway that directs traffic to your services.</p><p>The diagram below shows how the system works.</p><p>sequenceDiagram
autonumber
actor u as User
participant a as Apache APISIX
participant g as go-app
participant p as python-app
link a: Website @ https://apisix.apache.org
link g: Source code @ https://github.com/navendu-pottekkat/monitoring-101/blob/master/go-app/main.go
link p: Source code @ https://github.com/navendu-pottekkat/monitoring-101/blob/master/python-app/main.py
u-&gt;&gt;a: GET /hello/es?name=Navendu
activate a
a-&gt;&gt;g: GET /es?name=Navendu
activate g
g-&gt;&gt;p: GET /es
activate p
p--&gt;&gt;g: {message: &#34;Hola&#34;}
deactivate p
g--&gt;&gt;a: Hola Navendu!
deactivate g
a--&gt;&gt;u: Hola Navendu!
deactivate a</p><ol><li>The user sends a GET request to APISIX, the entry point for the application.</li><li>APISIX forwards the request to the Go service.</li><li>The Go service sends a GET request to the Python service to obtain “Hello” in the specified language.</li><li>The Python service responds with the required translation of “Hello.”</li><li>The Go service creates the required response by using the name provided in the query and sends it to APISIX.</li><li>APISIX forwards the response back to the user.</li></ol><h2 id="configuring-prometheus-to-collect-metrics">Configuring Prometheus to Collect Metrics</h2><p>We will instrument and export metrics from all the services in our application and collect them in Prometheus. We will start with our API gateway, <a href="https://apisix.apache.org/" target="_blank">Apache APISIX</a>
.</p><h3 id="exporting-metrics-from-apisix">Exporting Metrics from APISIX</h3><p>Apache APISIX is an open source, cloud native API gateway.</p><p>You don’t need to know about APISIX to follow along, and you can use the <a href="https://github.com/navendu-pottekkat/monitoring-101/blob/master/docker-compose.yml" target="_blank">Docker Compose file</a>
provided to set everything up. To learn more about APISIX, visit <a href="https://apisix.apache.org/" target="_blank">apisix.apache.org</a>
.</p><p>APISIX offers a <a href="https://apisix.apache.org/docs/apisix/2.15/plugins/prometheus/" target="_blank">prometheus Plugin</a>
that easily exports metrics in the Prometheus format. You can configure the Plugin in your APISIX configuration file:</p><div title="config.yml"><pre><code data-lang="yaml"><span>apisix</span>:
  <span>enable_admin</span>: <span>false</span> <span># run APISIX in standalone mode</span>
  <span>config_center</span>: <span>yaml</span> <span># use a YAML file for configuration instead of storing it in etcd</span>
<span>plugin_attr</span>:
  <span>prometheus</span>:
    <span>export_uri</span>: <span>/prometheus/metrics</span> <span># enable the prometheus Plugin and export the metrics to this URI</span>
    <span>enable_export_server</span>: <span>false</span> <span># export the metrics in the default data-plane port </span>
</code></pre></div><p>We can now enable the Plugin on every Route by making it a <a href="https://apisix.apache.org/docs/apisix/2.15/terminology/global-rule/" target="_blank">Global rule</a>
:</p><div title="apisix.yml"><pre><code data-lang="yaml"><span>routes</span>:
  <span># route requests to /hello/* to the go-app</span>
  - <span>uri</span>: <span>/hello/*</span>
    <span>upstream</span>:
      <span>type</span>: <span>roundrobin</span>
      <span>nodes</span>:
        <span>&#34;go-app:8080&#34;: </span><span>1</span>
    <span>plugins</span>:
      <span># remove the prefix &#34;/hello&#34; before forwarding the request to the go-app </span>
      <span>proxy-rewrite</span>:
        <span>regex_uri</span>:
          - <span>&#34;/hello/(.*)&#34;</span>
          - <span>&#34;/$1&#34;</span>
  <span># export Prometheus metrics to the specified URI</span>
  - <span>uri</span>: <span>/prometheus/metrics</span>
    <span>plugins</span>:
      <span>public-api</span>:
<span># enable the Prometheus Plugin globally on all Routes</span>
<span>global_rules</span>:
  - <span>id</span>: <span>1</span>
    <span>plugins</span>:
      <span>prometheus</span>:
        <span>prefer_name</span>: <span>true</span>
<span>#END</span>
</code></pre></div><p>This will export the metrics to the <code>/prometheus/metrics</code> endpoint in Apache APISIX.</p><p>You can learn more about the available metrics from the <a href="https://apisix.apache.org/docs/apisix/2.15/plugins/prometheus/#available-http-metrics" target="_blank">documentation</a>
.</p><h3 id="instrumenting-and-exporting-metrics-from-the-go-service">Instrumenting and Exporting Metrics from the Go Service</h3><p>Prometheus has an <a href="https://github.com/prometheus/client_golang" target="_blank">official Go client library</a>
for instrumenting Go applications.</p><p>By default, Prometheus will expose the default Go metrics. You can also create your own application-specific metrics.</p><p>In our service, we will expose the default metrics and create our own counter metric to track the number of requests:</p><div title="main.go"><pre><code data-lang="go"><span>package</span> <span>main</span>

<span>import</span> (
	<span>&#34;encoding/json&#34;</span>
	<span>&#34;fmt&#34;</span>
	<span>&#34;io/ioutil&#34;</span>
	<span>&#34;log&#34;</span>
	<span>&#34;net/http&#34;</span>
	<span>&#34;os&#34;</span>

	<span>// Prometheus packages
</span><span></span>	<span>&#34;github.com/prometheus/client_golang/prometheus&#34;</span>
	<span>&#34;github.com/prometheus/client_golang/prometheus/promauto&#34;</span>
	<span>&#34;github.com/prometheus/client_golang/prometheus/promhttp&#34;</span>
)

<span>// Response stores the Message obtained from the python-app
</span><span></span><span>type</span> <span>Response</span> <span>struct</span> {
	<span>Message</span> <span>string</span> <span>`json:&#34;message&#34;`</span>
}

<span>// default language and name
</span><span></span><span>var</span> (
	<span>lang</span> = <span>&#34;en&#34;</span>
	<span>name</span> = <span>&#34;John&#34;</span>
)

<span>// create a new custom Prometheus counter metric
</span><span></span><span>var</span> <span>pingCounter</span> = <span>promauto</span>.<span>NewCounter</span>(
	<span>prometheus</span>.<span>CounterOpts</span>{
		<span>Name</span>: <span>&#34;go_app_request_count&#34;</span>,
		<span>Help</span>: <span>&#34;No of requests handled by the go-app&#34;</span>,
	},
)

<span>// HelloHandler handles requests to the go-app
</span><span></span><span>func</span> <span>HelloHandler</span>(<span>w</span> <span>http</span>.<span>ResponseWriter</span>, <span>r</span> <span>*</span><span>http</span>.<span>Request</span>) {
	<span>lang</span> = <span>r</span>.<span>URL</span>.<span>String</span>()
	<span>name</span> = <span>r</span>.<span>URL</span>.<span>Query</span>()[<span>&#34;name&#34;</span>][<span>0</span>]

	<span>fmt</span>.<span>Println</span>(<span>&#34;Request for&#34;</span>, <span>lang</span>, <span>&#34;with name&#34;</span>, <span>name</span>)
	<span>pingCounter</span>.<span>Inc</span>()

	<span>pUrl</span> <span>:=</span> <span>os</span>.<span>Getenv</span>(<span>&#34;PYTHON_APP_URL&#34;</span>)
	<span>if</span> len(<span>pUrl</span>) <span>==</span> <span>0</span> {
		<span>pUrl</span> = <span>&#34;localhost&#34;</span>
	}

	<span>// call the python-app to obtain the translation
</span><span></span>	<span>resp</span>, <span>err</span> <span>:=</span> <span>http</span>.<span>Get</span>(<span>&#34;http://&#34;</span> <span>+</span> <span>pUrl</span> <span>+</span> <span>&#34;:8000&#34;</span> <span>+</span> <span>lang</span>)
	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
		<span>log</span>.<span>Fatalln</span>(<span>err</span>)
	}

	<span>body</span>, <span>err</span> <span>:=</span> <span>ioutil</span>.<span>ReadAll</span>(<span>resp</span>.<span>Body</span>)
	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
		<span>log</span>.<span>Fatalln</span>(<span>err</span>)
	}

	<span>resp</span>.<span>Body</span>.<span>Close</span>()

	<span>var</span> <span>m</span> <span>Response</span>
	<span>json</span>.<span>Unmarshal</span>(<span>body</span>, <span>&amp;</span><span>m</span>)

	<span>// send back response with &#34;Hello name!&#34; in the specified language
</span><span></span>	<span>fmt</span>.<span>Fprintf</span>(<span>w</span>, <span>&#34;%s %s!&#34;</span>, <span>m</span>.<span>Message</span>, <span>name</span>)
}

<span>func</span> <span>main</span>() {
	<span>// expose Prometheus metrics
</span><span></span>	<span>http</span>.<span>Handle</span>(<span>&#34;/metrics&#34;</span>, <span>promhttp</span>.<span>Handler</span>())
	<span>http</span>.<span>HandleFunc</span>(<span>&#34;/&#34;</span>, <span>HelloHandler</span>)

	<span>http</span>.<span>ListenAndServe</span>(<span>&#34;:8080&#34;</span>, <span>nil</span>)
}
</code></pre></div><p>This will expose the metrics to the endpoint <code>/metrics</code>. You can learn more about the Go client library from its <a href="https://github.com/prometheus/client_golang" target="_blank">GitHub repo</a>
.</p><h3 id="instrumenting-and-exporting-metrics-from-the-python-service">Instrumenting and Exporting Metrics from the Python Service</h3><p>Prometheus also has an <a href="https://github.com/prometheus/client_python" target="_blank">official Python client library</a>
. There are also third-party libraries that are tailored to fit specific use cases.</p><p>Our service uses <a href="https://fastapi.tiangolo.com/" target="_blank">FastAPI</a>
, and we will use the <a href="https://github.com/trallnag/prometheus-fastapi-instrumentator#creating-new-metrics" target="_blank">prometheus_fastapi_instrumentator</a>
library to instrument it:</p><div title="main.py"><pre><code data-lang="python"><span>from</span> fastapi <span>import</span> FastAPI
<span>from</span> fastapi.middleware.cors <span>import</span> CORSMiddleware

<span>from</span> prometheus_fastapi_instrumentator <span>import</span> Instrumentator

app <span>=</span> FastAPI()

hello <span>=</span> {<span>&#34;en&#34;</span>: <span>&#34;Hello&#34;</span>, <span>&#34;fr&#34;</span>: <span>&#34;Bonjour&#34;</span>, <span>&#34;es&#34;</span>: <span>&#34;Hola&#34;</span>, <span>&#34;ml&#34;</span>: <span>&#34;ഹലോ&#34;</span>}

<span># expose the default Python metrics to the /metrics endpoint</span>
Instrumentator()<span>.</span>instrument(app)<span>.</span>expose(app)

<span>@app</span><span>.</span>get(<span>&#34;/</span><span>{lang}</span><span>&#34;</span>)
<span>async</span> <span>def</span> <span>get_hello</span>(lang):
    <span>return</span> {<span>&#34;message&#34;</span>: hello[lang]}
</code></pre></div><p>You can learn more about creating custom metrics from the <a href="https://github.com/trallnag/prometheus-fastapi-instrumentator#creating-new-metrics" target="_blank">documentation</a>
.</p><h3 id="configuring-prometheus">Configuring Prometheus</h3><p>We can now scrape and collect these metrics in Prometheus.</p><p>You can configure Prometheus to collect metrics from each of the services. By default, Prometheus checks for metrics in the <code>/metrics</code> path:</p><div title="prometheus.yml"><pre><code data-lang="yaml"><span>global</span>:
  <span>scrape_interval</span>: <span>15s</span>
  <span>evaluation_interval</span>: <span>15s</span>

<span>scrape_configs</span>:
  - <span>job_name</span>: <span>&#34;prometheus&#34;</span>
    <span>static_configs</span>:
      - <span>targets</span>: [<span>&#34;localhost:9090&#34;</span>]
  
  - <span>job_name</span>: <span>&#34;go-app&#34;</span>
    <span>static_configs</span>:
      - <span>targets</span>: [<span>&#34;go-app:8080&#34;</span>]

  - <span>job_name</span>: <span>&#34;python-app&#34;</span>
    <span>static_configs</span>:
      - <span>targets</span>: [<span>&#34;python-app:8000&#34;</span>]

  - <span>job_name</span>: <span>&#34;apisix&#34;</span>
    <span>static_configs</span>:
      - <span>targets</span>: [<span>&#34;apisix:9080&#34;</span>]
    <span>metrics_path</span>: <span>&#34;/prometheus/metrics&#34;</span>
</code></pre></div><p>That’s it! Now, if you open up the Prometheus dashboard (default on port <code>9090</code>) and click on “Status” from the navbar and “Targets,” you will be able to see the status of metrics being scraped from your services.</p><figure><a href="https://navendu.me/images/introduction-to-monitoring-microservices/prometheus-target-status.png" target="_blank"><img loading="lazy" src="https://navendu.me/images/introduction-to-monitoring-microservices/prometheus-target-status.png#center" alt="Metrics are successfully being scraped from all sources"/></a><figcaption>Prometheus targets<p>Metrics are successfully being scraped from all sources</p></figcaption></figure><h2 id="querying-and-visualizing-metrics-in-prometheus">Querying and Visualizing Metrics in Prometheus</h2><p>Now, you can use the Prometheus dashboard to run queries and complex expressions.</p><figure><a href="https://navendu.me/images/introduction-to-monitoring-microservices/prometheus-query.png" target="_blank"><img loading="lazy" src="https://navendu.me/images/introduction-to-monitoring-microservices/prometheus-query.png#center" alt="You can get a lot more complex with your queries than this"/></a><figcaption>Querying Prometheus<p>You can get a lot more complex with your queries than this</p></figcaption></figure><p>You can learn more about querying Prometheus in the <a href="https://prometheus.io/docs/prometheus/latest/querying/basics/" target="_blank">official documentation</a>
.</p><h2 id="using-grafana-to-query-prometheus">Using Grafana to Query Prometheus</h2><p>Grafana is an open source data visualization platform that works with Prometheus to provide a comprehensive tool for collecting, querying, and visualizing metrics.</p><p>Prometheus is good at collecting metrics and querying but lacks in providing tooling for creating meaningful visualizations. Grafana overcomes this limitation by transforming the collected metrics into visualizations.</p><p>Grafana is also compatible with <a href="https://grafana.com/grafana/plugins/?type=datasource" target="_blank">many other data sources</a>
than Prometheus.</p><p>Once you have deployed Grafana, you can open the web UI (default on port <code>3000</code>).</p><p>First, you have to add Prometheus as a data source. To do this, go to `/datasources or “Configuration” and “Data sources.” Click on “Add data source” and select Prometheus. Specify where Prometheus is deployed, save and test the connection.</p><figure><a href="https://navendu.me/images/introduction-to-monitoring-microservices/grafana-add-prometheus.png" target="_blank"><img loading="lazy" src="https://navendu.me/images/introduction-to-monitoring-microservices/grafana-add-prometheus.png#center" alt="Add the details of your Prometheus service, save, and test it"/></a><figcaption>Add Prometheus as a data source<p>Add the details of your Prometheus service, save, and test it</p></figcaption></figure><h3 id="using-pre-built-grafana-dashboards">Using Pre-built Grafana Dashboards</h3><p>Grafana hosts a <a href="https://grafana.com/grafana/dashboards/" target="_blank">public dashboard repository</a>
that contains pre-built Grafana dashboards. You can use them in your Grafana instance to quickly visualize relevant metrics.</p><p>We will use the <a href="https://grafana.com/grafana/dashboards/6671-go-processes/" target="_blank">Go Processes</a>
dashboard which will process and visualize the process status published by the Prometheus Go client library.</p><p>To import this template, first, copy its ID (<code>6671</code>) from the dashboard repository. In your Grafana UI, go to “Dashboards” and select “Import.” Paste the ID you copied and click “Load.”</p><figure><a href="https://navendu.me/images/introduction-to-monitoring-microservices/grafana-dashboard.png" target="_blank"><img loading="lazy" src="https://navendu.me/images/introduction-to-monitoring-microservices/grafana-dashboard.png#center" alt="Visualizes the process status of the Go service"/></a><figcaption>Grafana dashboard<p>Visualizes the process status of the Go service</p></figcaption></figure><p>You can also explore other pre-built dashboards or create your own. Refer to the <a href="https://grafana.com/blog/2022/06/06/grafana-dashboards-a-complete-guide-to-all-the-different-types-you-can-build/" target="_blank">documentation</a>
to learn more about this.</p><h2 id="whats-next">What’s Next?</h2><p>That’s it for this tutorial!</p><p>This article was only an introduction to how you can set up monitoring on your services, and I encourage you to learn more about Prometheus and Grafana from the resources mentioned below:</p><ul><li><a href="https://prometheus.io/docs/practices/naming/" target="_blank">Prometheus Best Practices</a></li><li><a href="https://prometheus.io/docs/tutorials/alerting_based_on_metrics/" target="_blank">Alerting based on metrics</a></li><li><a href="https://grafana.com/docs/grafana/latest/dashboards/" target="_blank">Grafana Dashboards</a></li></ul><p>The complete code and the Docker Compose file for this tutorial are available in <a href="https://github.com/navendu-pottekkat/monitoring-101" target="_blank">monitoring-101</a>
.</p><section><hr/><p>Thank you for reading <i>&#34;An Introduction to Monitoring Microservices with Prometheus and Grafana&#34;</i>.</p><p>Subscribe via <a href="https://navendu.me/subscribe">email</a> or
<a href="https://navendu.me/index.xml" target="_blank">RSS feed</a> to be the first to receive
my content.</p><p>If you liked this post, check out my <a href="https://navendu.me/categories/featured">Featured Posts</a> or learn more <a href="https://navendu.me/about">About Me</a>.</p></section><section><section><p>Join my biweekly newsletter for exclusive content, insights, and updates.</p></section></section></div></div>
  </body>
</html>
