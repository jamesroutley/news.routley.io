<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.bridge.watch/building-bridge-watch/">Original</a>
    <h1>Building Bridge Watch</h1>
    
    <div id="readability-page-1" class="page"><div><div><article itemscope="" itemtype="http://schema.org/Article"><header><p>January 31, 2022</p></header><section itemprop="articleBody"><h2>Motivation</h2>
<p>I like building tools that are broadly useful and informative. One of the most frustrating aspects of working as a structural design engineer for me was the narrow focus of my job. While I spent a lot of time performing highly detailed oriented tasks in building complex analysis models or drawing details, I rarely had the opportunity to look at the bigger picture of what I was contributing to the built environment. Coming from engineering at the “far right” of the <a href="https://twitter.com/dr_danieldavis/status/1455216062782398469" target="_blank" rel="noopener noreferrer">long tail</a>, the question was usually <em>can</em> we engineer this, rather than <em>should</em> we. To that end, when I decided to do a second batch at the <a href="https://www.recurse.com/" target="_blank" rel="noopener noreferrer">Recurse Center</a> and transition my career to focus on software, I wanted to work on a project that would deepen my knowledge of web applications, while also shedding some light on the current state of the built environment.</p>
<p>Just before I started my batch, I discovered the <a href="https://www.fhwa.dot.gov/bridge/nbi.cfm" target="_blank" rel="noopener noreferrer">National Bridge Inventory</a>, which seemed like a perfect fit for the type of project I wanted to do. The data was already normalized in a format that’s been consistent for several decades, it was geographically diverse, and it had enough entries to make working with a database worth it, rather than loading a Pandas dataframe. While the <a href="https://infobridge.fhwa.dot.gov/" target="_blank" rel="noopener noreferrer">InfoBridge Web</a> portal allows some plot customization and analytics capabilities, I wanted to work with much more complex data visualizations utilizing <a href="https://d3js.org/" target="_blank" rel="noopener noreferrer">D3</a>.</p>
<p><a href="https://bridge.watch" target="_blank" rel="noopener noreferrer">Bridge.watch</a> is the final product of this endeavor, allowing users to interactively explore this dataset through a series of <a href="https://bridge.watch/state" target="_blank" rel="noopener noreferrer">maps</a> and <a href="https://bridge.watch/condition" target="_blank" rel="noopener noreferrer">hierarchical plots</a> with custom filtering and data aggregation.</p>
<h2>Data Cleaning and Initial Exploration</h2>
<p>When I figuratively hung up my hard hat, I <a href="https://mclare.blog/posts/why-structural-engineers-use-excel" target="_blank" rel="noopener noreferrer">swore off using Excel</a> for any significant purpose, which I was able to do mainly because I’m a giant <a href="https://www.visidata.org/" target="_blank" rel="noopener noreferrer">Visidata</a> fan now. Using Visidata, I could quickly get histograms of different fields to determine what would be interesting to show as a plot. I also used Visidata to do some data cleaning with regex, and eventually I wrote a Python script to do the same type of data cleaning, and fix some latitude and longitude outliers that were consistent over several years of data (I’m looking at you, whoever in Maryland keeps putting 300 bridges in the Atlantic Ocean!). The 2021 NBI data set was released this month, and with Visidata and Python I was able to quickly adjust and load the new data into my database.</p>
<h4>Resources I used:</h4>
<ul>
<li><a href="https://www.visidata.org/" target="_blank" rel="noopener noreferrer">Visidata</a> by <a href="https://twitter.com/saulfp" target="_blank" rel="noopener noreferrer">Saul Pwanson</a></li>
</ul>
<h2>Backend</h2>
<h3>Building the Database</h3>
<p>Based on the NBI records structure, I thought that a relational database was the best option for looking at the 2021 data. While I probably could have gotten away with just using SQLite, I chose to use <a href="https://www.postgresql.org/" target="_blank" rel="noopener noreferrer">PostgreSQL</a> mainly to be able to do more complex geographic queries with <a href="https://postgis.net/" target="_blank" rel="noopener noreferrer">PostGIS</a> (though I’ve only scratched the surface of it at this point). I wrote some Python functions to automatically generate a SQL file to load the database and normalize each field as well.</p>
<h4>Resources I used:</h4>
<ul>
<li><a href="http://pg4e.com/" target="_blank" rel="noopener noreferrer">PostgreSQL for Everybody</a> by <a href="https://twitter.com/drchuck" target="_blank" rel="noopener noreferrer">Dr. Chuck</a></li>
<li><a href="https://www.postgresql.org/docs/" target="_blank" rel="noopener noreferrer">Postgres Official Documentation</a></li>
</ul>
<h3>Constructing Web APIs</h3>
<p>Django and PostgreSQL are a popular pairing, so I used the Django Rest Framework to create my API endpoints. I’ll admit that this is probably the piece of the project that I’m least happy with (and most likely to refactor in the future; my friend keeps trying to convince me to do it in Haskell for extra bonus points). I discovered a serious performance hit passing data through Django, and what I’d originally thought was lousy database performance from a lack of indices in Postgres, was actually a several second delay in Django which resulted in me ripping out the serializers I’d written and mostly passing on data as a csv through a StreamingHttpResponse.</p>
<h4>Resources I used:</h4>
<ul>
<li><a href="https://docs.djangoproject.com/en/3.2/intro/tutorial01/" target="_blank" rel="noopener noreferrer">Django Documentation &amp; Tutorials</a></li>
<li><a href="https://www.django-rest-framework.org/" target="_blank" rel="noopener noreferrer">Django Rest Framework</a></li>
</ul>
<h3>Express (D3 data aggregation)</h3>
<p>Sending 500k data points to the browser is a <em>bad</em> idea. Rather than rewriting some of D3’s aggregation functions, I created an Express server to postprocess the streaming csv data into the right data shape for D3 (and seriously cut down on the size; no one wants a 15 mb JSON). Originally alongside with Express, I added a Redis cache at this level, but I ended up removing it in the final product and using NGINX’s caching capabilities instead.</p>
<h4>Resources I used:</h4>
<ul>
<li><a href="https://fullstackopen.com/en/" target="_blank" rel="noopener noreferrer">Full Stack Open</a></li>
</ul>
<h3>NGINX</h3>
<p>I didn’t know what <a href="https://www.nginx.com/" target="_blank" rel="noopener noreferrer">NGINX</a> was before starting this project, and I found it very difficult to play around with on the DigitalOcean droplet I was using. Serendipitously, when I reached this step of the project, Julia Evans had just released a <a href="https://twitter.com/b0rk/status/1441111994216574992?s=20" target="_blank" rel="noopener noreferrer">new tool</a> for a NGINX sandbox website. I played around with this and read the docs to create my NGINX config. Configuring NGINX was probably the most “flaily” part of the project, but little by little I was able to build up a file to reverse proxy the backend, cache api calls, and properly redirect domains to avoid CORS errors.</p>
<h4>Resources I used:</h4>
<ul>
<li><a href="https://jvns.ca/blog/2021/09/24/new-tool--an-nginx-playground/" target="_blank" rel="noopener noreferrer">NGINX Playground</a></li>
</ul>
<h2>Frontend</h2>
<h3>Preact</h3>
<p>On the advice of a <a href="https://twitter.com/ryanprior" target="_blank" rel="noopener noreferrer">friend</a>, I chose Preact as the front end framework for the web application. I’ve built React apps before, and the transition to Preact was pretty seamless. I’m definitely <em>not</em> a front-end developer, so I relied on Material UI to give me a set of components I could easily use for the site.</p>
<h4>Resources I used:</h4>
<ul>
<li><a href="https://fullstackopen.com/en/" target="_blank" rel="noopener noreferrer">Full Stack Open</a></li>
<li><a href="https://preactjs.com/" target="_blank" rel="noopener noreferrer">Preact</a></li>
<li><a href="https://mui.com/" target="_blank" rel="noopener noreferrer">Material UI</a></li>
</ul>
<h3>D3</h3>
<p>Before I started developing this project into a proper web application, I <a href="https://observablehq.com/@m-clare/hexbin-map" target="_blank" rel="noopener noreferrer">prototyped</a> <a href="ttps://observablehq.com/@m-clare/nbi-icicle" target="_blank" rel="noopener noreferrer">several</a> of the visualizations on <a href="https://observablehq.com" target="_blank" rel="noopener noreferrer">Observable</a>. Observable is an excellent platform for learning how to use D3. I particularly like its dependency graphs, and of course, the reactive nature of the platform.</p>
<h4>Resources I used:</h4>
<ul>
<li><a href="https://observablehq.com/@observablehq/documentation#learningMore" target="_blank" rel="noopener noreferrer">Observable Documentation</a></li>
<li><a href="https://www.amazon.com/_/dp/1492046779?tag=oreilly20-20" target="_blank" rel="noopener noreferrer">D3 for the Impatient</a><sup id="fnref-1"><a href="#fn-1">1</a></sup> by Philipp K. Janert</li>
</ul>
<h2>Other Miscellany</h2>
<h3>Docker</h3>
<p>I used docker-compose to create a multi-container application based on the pieces above. There was a lot of trial and error coming up with the proper development and production files, but once it finally ‘clicked’, it was super handy for getting everything up and running on a server.</p>
<h3>Books and Websites:</h3>
<p>I also read these books/used these resources these during my batch to gain a bigger picture understanding of data visualization and web applications.</p>
<ul>
<li><a href="https://www.amazon.com/Better-Data-Visualizations-Scholars-Researchers/dp/0231193114" target="_blank" rel="noopener noreferrer">Better Data Visualizations</a> by <a href="https://twitter.com/jschwabish" target="_blank" rel="noopener noreferrer">Jonathan Schwabish</a></li>
<li><a href="https://www.amazon.com/Designing-Data-Intensive-Applications-Reliable-Maintainable/dp/1449373321" target="_blank" rel="noopener noreferrer">Designing Data-Intensive Applications</a><sup id="fnref-1"><a href="#fn-1">1</a></sup> by <a href="https://twitter.com/martinkl" target="_blank" rel="noopener noreferrer">Martin Kleppman</a> (his <a href="https://www.youtube.com/channel/UClB4KPy5LkJj1t3SgYVtMOQ" target="_blank" rel="noopener noreferrer">Youtube</a> content is great too!)</li>
<li><a href="https://www.amazon.com/Building-Microservices-Designing-Fine-Grained-Systems/dp/1491950358" target="_blank" rel="noopener noreferrer">Building Microservices: Designing Fine-Grained Systems</a><sup id="fnref-1"><a href="#fn-1">1</a></sup> by <a href="https://twitter.com/samnewman" target="_blank" rel="noopener noreferrer">Sam Newman</a></li>
<li><a href="https://wizardzines.com/" target="_blank" rel="noopener noreferrer">Wizard Zines</a> by <a href="https://twitter.com/b0rk" target="_blank" rel="noopener noreferrer">Julia Evans</a></li>
<li><a href="https://justjavascript.com/" target="_blank" rel="noopener noreferrer">Just Javascript</a></li>
</ul>
</section><hr/></article></div></div></div>
  </body>
</html>
