<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://gist.github.com/peppergrayxyz/fdc9042760273d137dddd3e97034385f">Original</a>
    <h1>QEMU with VirtIO GPU Vulkan Support</h1>
    
    <div id="readability-page-1" class="page"><div>
  <div id="file-qemu-vulkan-virtio-md">
      
      <div id="file-qemu-vulkan-virtio-md-readme">
    <article itemprop="text">
<p dir="auto">With its latest reales qemu added the Venus patches so that virtio-gpu now support venus encapsulation for vulkan. This is one more piece to the puzzle towards full Vulkan support.</p>
<p dir="auto">An outdated blog post on <a href="https://www.collabora.com/news-and-blog/blog/2021/11/26/venus-on-qemu-enabling-new-virtual-vulkan-driver/" rel="nofollow">clollabora</a> described in 2021 how to enable 3D acceleration of Vulkan applications in QEMU through the Venus experimental Vulkan driver for VirtIO-GPU with a local development environment. Following up on the outdated write up, this is how its done today.</p>

<p dir="auto">Let&#39;s start with the brief description of the projects mentioned in the post &amp; extend them:</p>
<ul dir="auto">
<li>QEMU is a machine emulator</li>
<li>VirGL is an OpenGL driver for VirtIO-GPU, available in Mesa.</li>
<li>Venus is an experimental Vulkan driver for VirtIO-GPU, also available in Mesa.</li>
<li>Virglrenderer is a library that enables hardware acceleration to VM guests, effectively translating commands from the two drivers just mentioned to either OpenGL or Vulkan.</li>
<li>libvirt is an API for managing platform virtualization</li>
<li>virt-manager is a desktop user interface for managing virtual machines through libvirt</li>
</ul>
<p dir="auto">Merged Patches:</p>
<ul dir="auto">
<li>2024-08-14 <a href="https://gitlab.freedesktop.org/mesa/mesa/-/commit/087e9a96d13155e26987befae78b6ccbb7ae242b" rel="nofollow">venus: make cross-device optional</a> merged in <a href="https://www.phoronix.com/news/Mesa-24.2-Released" rel="nofollow">mesa 24.2</a></li>
<li>2024-11-25 <a href="https://lore.kernel.org/all/20240726235234.228822-1-seanjc@google.com/" rel="nofollow">KVM: Stop grabbing references to PFNMAP&#39;d pages</a> merged in <a href="https://www.phoronix.com/news/Linux-6.13-KVM" rel="nofollow">linux 6.13</a></li>
<li>2024-11-12 <a href="https://lists.gnu.org/archive/html/qemu-devel/2024-08/msg03288.html" rel="nofollow">Support blob memory and venus on qemu</a> merged in <a href="https://www.phoronix.com/news/QEMU-9.2-Released" rel="nofollow">qemu 9.2.0</a></li>
</ul>
<p dir="auto">Work in progress:</p>
<ul dir="auto">
<li>libvirt <a href="https://gitlab.com/libvirt/libvirt/-/issues/638" rel="nofollow">Add support for more virtio-vga-gl arguments #638</a></li>
<li>virt-manager <a href="https://github.com/virt-manager/virt-manager/issues/362" data-hovercard-type="issue" data-hovercard-url="/virt-manager/virt-manager/issues/362/hovercard">Add support for Venus / Vulkan VirtIO-GPU driver #362</a></li>
</ul>

<p dir="auto">Make sure you have the proper version installed on the host:</p>
<ul dir="auto">
<li>linux kernel &gt;= 6.13 built with CONFIG_UDMABUF</li>
<li>working Vulkan and kvm setup</li>
<li>qemu &gt;= 9.2.0</li>
</ul>
<p dir="auto">You can verify this like so:</p>
<pre><code>$ uname -r
6.13.0
$ ls /dev/udmabuf
/dev/udmabuf
$ ls /dev/kvm
/dev/kvm
$ qemu-system-x86_64 --version
QEMU emulator version 9.2.0
Copyright (c) 2003-2024 Fabrice Bellard and the QEMU Project developers
</code></pre>
<p dir="auto">For Vulkan to work you need the proper drivers to be installed for your graphics card. To verfiy your setup, install <code>vulkan-tools</code>:</p>
<pre><code>$ vulkaninfo --summary
==========
VULKANINFO
==========

Vulkan Instance Version: ...
...
$ vkcube
Selected GPU x: ..., type: ...
</code></pre>

<p dir="auto">If your distro doesn&#39;t (yet) ship and updated version of qemu, you can build it yourself from source:</p>
<pre><code>wget https://download.qemu.org/qemu-9.2.0.tar.xz
tar xvJf qemu-9.2.0.tar.xz
cd qemu-9.2.0
mkdir build &amp;&amp; cd build
../configure --target-list=x86_64-softmmu  \
  --enable-kvm                 \
  --enable-opengl              \
  --enable-virglrenderer       \
  --enable-gtk                 \
  --enable-sdl
make -j4
</code></pre>
<p dir="auto">The configuration step will throgh errors if packages are missing. Check the qemu wiki for further info what to install: <a href="https://wiki.qemu.org/Hosts/Linux" rel="nofollow">https://wiki.qemu.org/Hosts/Linux</a></p>
<div dir="auto"><h2 dir="auto">Create and run an image for QEMU</h2><a id="user-content-create-and-run-an-image-for-qemu" aria-label="Permalink: Create and run an image for QEMU" href="#create-and-run-an-image-for-qemu"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Create an image &amp; fetch the distro of your choice:</p>

<div dir="auto"><pre>ISO=ubuntu-24.10-desktop-amd64.iso  
wget https://releases.ubuntu.com/oracular/ubuntu-24.10-desktop-amd64.iso  

IMG=ubuntu-24-10.qcow2
qemu-img create -f qcow2 <span>$IMG</span> 16G</pre></div>
<p dir="auto">Run a live version or install the distro</p>
<pre><code>qemu-system-x86_64                                               \
    -enable-kvm                                                  \
    -M q35                                                       \
    -smp 4                                                       \
    -m 4G                                                        \
    -cpu host                                                    \
    -net nic,model=virtio                                        \
    -net user,hostfwd=tcp::2222-:22                              \
    -device virtio-vga-gl,hostmem=4G,blob=true,venus=true        \
    -vga none                                                    \
    -display gtk,gl=on,show-cursor=on                            \
    -usb -device usb-tablet                                      \
    -object memory-backend-memfd,id=mem1,size=4G                 \
    -machine memory-backend=mem1                                 \
    -hda $IMG                                                    \
    -cdrom $ISO                                                  
</code></pre>
<p dir="auto">Adjust the parameters accordingly:</p>
<ul dir="auto">
<li>smp: number of cpu cores</li>
<li>m: RAM</li>
<li>hostmem,size: VRAM</li>
</ul>

<p dir="auto">Install <code>mesa-utilites</code> and <code>vulkan-tools</code> to test the setup:</p>
<pre><code>$ glxinfo -B
</code></pre>
<pre><code>$ vkcube
Selected GPU x: ..., type: ...
</code></pre>
<p dir="auto">If the deive is <code>llvmpipe</code> somehting is wrong. The device should be <code>virgl (...)</code>.</p>

<ul dir="auto">
<li>(host) add <code>-d guest_errors</code> to show error messages from the guest</li>
<li>(guest) try installing vulkan virtio drivers and mesa</li>
<li>check the original <a href="https://www.collabora.com/news-and-blog/blog/2021/11/26/venus-on-qemu-enabling-new-virtual-vulkan-driver/" rel="nofollow">blog post</a></li>
</ul>

<p dir="auto">-- work in progress --</p>
<p dir="auto">Currently this is work in progress, so there is no option to add vulkan support in virt-manager. There are no fields to configure this. Also xml doesnt work, because libvirt doesn&#39;t know about these options either, so xml validation fails. There is however an option for <a href="https://libvirt.org/kbase/qemu-passthrough-security.html" rel="nofollow">QEMU command-line passthrough</a> which bypasses the validation.</p>
<p dir="auto">If you setup a default machine with 4G of memory, you can do this:</p>
<div dir="auto"><pre>  &lt;<span>qemu</span><span>:</span><span>commandline</span>&gt;
    &lt;<span>qemu</span><span>:</span><span>arg</span> <span>value</span>=<span><span>&#34;</span>-device<span>&#34;</span></span>/&gt;
    &lt;<span>qemu</span><span>:</span><span>arg</span> <span>value</span>=<span><span>&#34;</span>virtio-vga-gl,hostmem=4G,blob=true,venus=true<span>&#34;</span></span>/&gt;
    &lt;<span>qemu</span><span>:</span><span>arg</span> <span>value</span>=<span><span>&#34;</span>-object<span>&#34;</span></span>/&gt;
    &lt;<span>qemu</span><span>:</span><span>arg</span> <span>value</span>=<span><span>&#34;</span>memory-backend-memfd,id=mem1,size=4G<span>&#34;</span></span>/&gt;
    &lt;<span>qemu</span><span>:</span><span>arg</span> <span>value</span>=<span><span>&#34;</span>-machine<span>&#34;</span></span>/&gt;
    &lt;<span>qemu</span><span>:</span><span>arg</span> <span>value</span>=<span><span>&#34;</span>memory-backend=mem1<span>&#34;</span></span>/&gt;
    &lt;<span>qemu</span><span>:</span><span>arg</span> <span>value</span>=<span><span>&#34;</span>-vga<span>&#34;</span></span>/&gt;
    &lt;<span>qemu</span><span>:</span><span>arg</span> <span>value</span>=<span><span>&#34;</span>none<span>&#34;</span></span>/&gt;
  &lt;/<span>qemu</span><span>:</span><span>commandline</span>&gt;</pre></div>
<p dir="auto">Which gives this error:</p>
<pre><code>qemu-system-x86_64: virgl could not be initialized: -1
</code></pre>
<p dir="auto">Changing the number from 4G to 4194304k (same as memory) leds to this error:</p>
<pre><code>qemu-system-x86_64: Spice: ../spice-0.15.2/server/red-qxl.cpp:435:spice_qxl_gl_scanout: condition `qxl_state-&gt;gl_draw_cookie == GL_DRAW_COOKIE_INVALID&#39; failed
</code></pre>
<p dir="auto">to be further investigated.</p>
</article>
  </div>

  </div>
</div></div>
  </body>
</html>
