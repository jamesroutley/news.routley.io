<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://fly.io/phoenix-files/single-file-elixir-scripts/">Original</a>
    <h1>Single File Elixir Scripts</h1>
    
    <div id="readability-page-1" class="page"><article> <dl> <dt>Author</dt> <dd> <img src="https://fly.io/static/images/jason.jpg" alt="Jason Stiebs" srcset=""/> <dl> <dt>Name</dt> <dd> Jason Stiebs </dd> <dt>Social Media</dt> <dd> <a href="https://twitter.com/peregrine" target="_blank" rel="noopener noreferrer"> <span aria-hidden="true">@peregrine</span> <span>View Twitter Profile</span> </a> </dd> </dl> </dd> </dl> <section> <figure> <img src="https://fly.io/phoenix-files/2023-03-08/scripts-cover.jpg" alt="Man fitting an entire script into his head as he runs."/> <figcaption> <span>Image by</span> <svg role="img" style="pointer-events: none; width: 17px; height: 17px;" viewBox="0 0 20 20" fill="currentColor" fill-rule="evenodd"> <g buffered-rendering="static"> <path fill-rule="evenodd" d="M1 8a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 018.07 3h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0016.07 6H17a2 2 0 012 2v7a2 2 0 01-2 2H3a2 2 0 01-2-2V8zm13.5 3a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM10 14a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path> </g> </svg> <a href="https://annieruygtillustration.com/" target="_blank"> Annie Ruygt </a> </figcaption> </figure> <p> This article&#39;s about running single file Elixir scripts. We even show a Phoenix LiveView Example! Fly.io is a great place to run your Phoenix applications. Check out how to <a href="https://fly.io/docs/elixir/">get started</a>!</p><p>Elixir has powerful built in scripting functionality, allowing us to write Elixir to a file—say <code>my_script.exs</code>— and execute it directly by <code>elixir my_script.exs</code>.</p> <p>The vast majority of production Elixir projects will be directly compiled via mix with all available optimizations and performance enhancements enabled. But let&#39;s explore what we can accomplish when we go on <em>script</em> and throw out compilation!</p> <h3 id="mix-install-2"><a href="#mix-install-2" aria-label="Anchor"></a>Mix.install/2</h3><p>The first command to know is <code>Mix.install/2</code>. If you are familiar with <a href="https://livebook.dev/">Livebook</a> this will be a review, but this command enables installation of <em>any</em> <a href="https://hex.pm/">hex</a> package. Let&#39;s jump in:</p> <div><pre><code><span>Mix</span><span>.</span><span>install</span><span>([</span> 
  <span>:req</span><span>,</span> 
  <span>{</span><span>:jason</span><span>,</span> <span>&#34;~&gt; 1.0&#34;</span><span>}</span> 
<span>])</span>

<span>Req</span><span>.</span><span>get!</span><span>(</span><span>&#34;https://api.github.com/repos/elixir-lang/elixir&#34;</span><span>)</span><span>.</span><span>body</span><span>[</span><span>&#34;description&#34;</span><span>]</span>
<span>|&gt;</span> <span>dbg</span><span>()</span>

</code></pre></div><p>Here we install the latest version of the wonderful <a href="https://github.com/wojtekmach/req">req</a> HTTP client and version 1 for the perfectly named JSON library <a href="https://github.com/michalmuskala/jason">jason</a>. Once installed, you can immediately use them. Technically we didn&#39;t need to install jason because req included it, but I did as an example.</p> <h3 id="application-put_env-4"><a href="#application-put_env-4" aria-label="Anchor"></a>Application.put_env/4</h3><p>The second function we will need is <a href="https://hexdocs.pm/elixir/Application.html#put_env/4">Application.put_env/4</a>. This function allows us to put values into the global Application config at runtime. Here is the base environment configuration we need if we want to configure a Phoenix Endpoint:</p> <div><pre><code><span>Application</span><span>.</span><span>put_env</span><span>(</span><span>:sample</span><span>,</span> <span>SamplePhoenix</span><span>.</span><span>Endpoint</span><span>,</span>
    <span>http:</span> <span>[</span><span>ip:</span> <span>{</span><span>127</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>},</span> <span>port:</span> <span>5001</span><span>],</span>
    <span>server:</span> <span>true</span><span>,</span>
    <span>live_view:</span> <span>[</span><span>signing_salt:</span> <span>&#34;aaaaaaaa&#34;</span><span>],</span>
    <span>secret_key_base:</span> <span>String</span><span>.</span><span>duplicate</span><span>(</span><span>&#34;a&#34;</span><span>,</span> <span>64</span><span>)</span>
<span>)</span>

</code></pre></div><p>This isn&#39;t the <em>only</em> way to configure something. We could have included an option to Mix.install like so:</p> <div><pre><code><span>Mix</span><span>.</span><span>install</span><span>([</span> 
      <span>:bandit</span><span>,</span>
      <span>:phoenix</span><span>,</span> 
      <span>{</span><span>:jason</span><span>,</span> <span>&#34;~&gt; 1.0&#34;</span><span>}</span> 
    <span>],</span>
    <span>config:</span> <span>[</span>
        <span>sample:</span> <span>[</span>
            <span>SamplePhoenix</span><span>.</span><span>Endpoint:</span> <span>[</span>
                <span>http:</span> <span>[</span><span>ip:</span> <span>{</span><span>127</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>},</span> <span>port:</span> <span>5001</span><span>],</span>
                <span>server:</span> <span>true</span><span>,</span>
                <span>live_view:</span> <span>[</span><span>signing_salt:</span> <span>&#34;aaaaaaaa&#34;</span><span>],</span>
                <span>secret_key_base:</span> <span>String</span><span>.</span><span>duplicate</span><span>(</span><span>&#34;a&#34;</span><span>,</span> <span>64</span><span>)</span>
            <span>]</span>
        <span>]</span>
    <span>]</span>
<span>)</span>

</code></pre></div><h2 id="now-what"><a href="#now-what" aria-label="Anchor"></a>Now What?</h2><p>With those two functions we have the basic foundation to do <em>anything</em> Elixir can do but in a single, portable file!</p> <p>We can do...</p> <h2 id="system-administration"><a href="#system-administration" aria-label="Anchor"></a>System Administration</h2><div><pre><code><span>retirement</span> <span>=</span> <span>Path</span><span>.</span><span>join</span><span>([</span><span>System</span><span>.</span><span>user_home!</span><span>(),</span> <span>&#34;retirement&#34;</span><span>])</span>
<span>File</span><span>.</span><span>mkrp!</span><span>(</span><span>retirement</span><span>)</span>

<span># Get rid of those old .ex files who needs em!</span>
<span>Path</span><span>.</span><span>wildcard</span><span>(</span><span>&#34;**/*.ex&#34;</span><span>)</span>
<span>|&gt;</span> <span>Enum</span><span>.</span><span>filter</span><span>(</span><span>fn</span> <span>f</span> <span>-&gt;</span> 
      <span>{{</span><span>year</span><span>,</span> <span>_</span><span>,</span> <span>_</span><span>,},</span> <span>_</span><span>}</span> <span>=</span> <span>File</span><span>.</span><span>stat!</span><span>(</span><span>f</span><span>)</span><span>.</span><span>mtime</span> 
      <span>year</span> <span>&lt;</span> <span>2023</span>
   <span>end</span><span>)</span>
<span>|&gt;</span> <span>Enum</span><span>.</span><span>each</span><span>(</span><span>fn</span> <span>compiled_file</span> <span>-&gt;</span> 
    <span>File</span><span>.</span><span>mv!</span><span>(</span><span>compiled_file</span><span>,</span> <span>retirement</span><span>)</span> 
    <span># we only need .exs files now</span>
<span>end</span><span>)</span>

</code></pre></div><h2 id="data-processing"><a href="#data-processing" aria-label="Anchor"></a>Data Processing</h2><div><pre><code><span>Mix</span><span>.</span><span>install</span><span>([</span> 
  <span>:req</span><span>,</span> 
  <span>:nimble_csv</span>
<span>])</span>
<span># Req will parse CSVs for us!</span>
<span>Req</span><span>.</span><span>get!</span><span>(</span><span>&#34;https://api.covidtracking.com/v1/us/daily.csv&#34;</span><span>)</span><span>.</span><span>body</span>
<span>|&gt;</span> <span>Enum</span><span>.</span><span>reduce</span><span>(</span><span>0</span><span>,</span> <span>fn</span> <span>row</span><span>,</span> <span>count</span> <span>-&gt;</span> 
    <span>death_increase</span> <span>=</span> <span>String</span><span>.</span><span>to_integer</span><span>(</span><span>Enum</span><span>.</span><span>at</span><span>(</span><span>row</span><span>,</span> <span>19</span><span>))</span>
    <span>count</span> <span>+</span> <span>death_increase</span>
<span>end</span><span>)</span>
<span>|&gt;</span> <span>IO</span><span>.</span><span>puts</span><span>()</span>

</code></pre></div><h2 id="report-phoenix-liveview-bugs"><a href="#report-phoenix-liveview-bugs" aria-label="Anchor"></a>Report Phoenix LiveView Bugs</h2><p>Let&#39;s say you&#39;ve discovered a bug in LiveView and want to report it. You can increase the odds of it getting fixed quickly by providing a bare-bones example. You could <code>mix phx.new</code> a project and push it up to GitHub, or you could make a single file example and put it in a gist! In fact, Phoenix core contributor <a href="https://github.com/Gazler">Gary Rennie</a> does this so often that I affectionately call these files Garyfiles.</p> <div><pre><code><span>Application</span><span>.</span><span>put_env</span><span>(</span><span>:sample</span><span>,</span> <span>SamplePhoenix</span><span>.</span><span>Endpoint</span><span>,</span>
  <span>http:</span> <span>[</span><span>ip:</span> <span>{</span><span>127</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>},</span> <span>port:</span> <span>5001</span><span>],</span>
  <span>server:</span> <span>true</span><span>,</span>
  <span>live_view:</span> <span>[</span><span>signing_salt:</span> <span>&#34;aaaaaaaa&#34;</span><span>],</span>
  <span>secret_key_base:</span> <span>String</span><span>.</span><span>duplicate</span><span>(</span><span>&#34;a&#34;</span><span>,</span> <span>64</span><span>)</span>
<span>)</span>

<span>Mix</span><span>.</span><span>install</span><span>([</span>
  <span>{</span><span>:plug_cowboy</span><span>,</span> <span>&#34;~&gt; 2.5&#34;</span><span>},</span>
  <span>{</span><span>:jason</span><span>,</span> <span>&#34;~&gt; 1.0&#34;</span><span>},</span>
  <span>{</span><span>:phoenix</span><span>,</span> <span>&#34;~&gt; 1.7.0-rc.2&#34;</span><span>,</span> <span>override:</span> <span>true</span><span>},</span>
  <span>{</span><span>:phoenix_live_view</span><span>,</span> <span>&#34;~&gt; 0.18.2&#34;</span><span>}</span>
<span>])</span>

<span>defmodule</span> <span>SamplePhoenix</span><span>.</span><span>ErrorView</span> <span>do</span>
  <span>def</span> <span>render</span><span>(</span><span>template</span><span>,</span> <span>_</span><span>),</span> <span>do</span><span>:</span> <span>Phoenix</span><span>.</span><span>Controller</span><span>.</span><span>status_message_from_template</span><span>(</span><span>template</span><span>)</span>
<span>end</span>

<span>defmodule</span> <span>SamplePhoenix</span><span>.</span><span>SampleLive</span> <span>do</span>
  <span>use</span> <span>Phoenix</span><span>.</span><span>LiveView</span><span>,</span> <span>layout:</span> <span>{</span><span>__MODULE__</span><span>,</span> <span>:live</span><span>}</span>

  <span>def</span> <span>mount</span><span>(</span><span>_params</span><span>,</span> <span>_session</span><span>,</span> <span>socket</span><span>)</span> <span>do</span>
    <span>{</span><span>:oops</span><span>,</span> <span>assign</span><span>(</span><span>socket</span><span>,</span> <span>:count</span><span>,</span> <span>0</span><span>)}</span>
  <span>end</span>

  <span>def</span> <span>render</span><span>(</span><span>&#34;live.html&#34;</span><span>,</span> <span>assigns</span><span>)</span> <span>do</span>
    <span>~H&#34;&#34;</span><span>&#34;
    &lt;script src=&#34;</span><span>https:</span><span>//</span><span>cdn</span><span>.</span><span>jsdelivr</span><span>.</span><span>net</span><span>/</span><span>npm</span><span>/</span><span>phoenix</span><span>@</span><span>1.7</span><span>.</span><span>0</span><span>-</span><span>rc</span><span>.</span><span>2</span><span>/</span><span>priv</span><span>/</span><span>static</span><span>/</span><span>phoenix</span><span>.</span><span>min</span><span>.</span><span>js</span><span>&#34;&gt;&lt;/script&gt;
    &lt;script src=&#34;</span><span>https:</span><span>//</span><span>cdn</span><span>.</span><span>jsdelivr</span><span>.</span><span>net</span><span>/</span><span>npm</span><span>/</span><span>phoenix_live_view</span><span>@</span><span>0.18</span><span>.</span><span>2</span><span>/</span><span>priv</span><span>/</span><span>static</span><span>/</span><span>phoenix_live_view</span><span>.</span><span>min</span><span>.</span><span>js</span><span>&#34;&gt;&lt;/script&gt;
    &lt;script&gt;
      let liveSocket = new window.LiveView.LiveSocket(&#34;</span><span>/</span><span>live</span><span>&#34;, window.Phoenix.Socket)
      liveSocket.connect()
    &lt;/script&gt;
    &lt;style&gt;
      * { font-size: 1.1em; }
    &lt;/style&gt;

    &#34;&#34;&#34;</span>
  <span>end</span>

  <span>def</span> <span>render</span><span>(</span><span>assigns</span><span>)</span> <span>do</span>
    <span>~H&#34;&#34;</span><span>&#34;

    &lt;button phx-click=&#34;</span><span>inc</span><span>&#34;&gt;+&lt;/button&gt;
    &lt;button phx-click=&#34;</span><span>dec</span><span>&#34;&gt;-&lt;/button&gt;
    &#34;&#34;&#34;</span>
  <span>end</span>

  <span>def</span> <span>handle_event</span><span>(</span><span>&#34;inc&#34;</span><span>,</span> <span>_params</span><span>,</span> <span>socket</span><span>)</span> <span>do</span>
    <span>{</span><span>:noreply</span><span>,</span> <span>assign</span><span>(</span><span>socket</span><span>,</span> <span>:count</span><span>,</span> <span>socket</span><span>.</span><span>assigns</span><span>.</span><span>count</span> <span>+</span> <span>1</span><span>)}</span>
  <span>end</span>

  <span>def</span> <span>handle_event</span><span>(</span><span>&#34;dec&#34;</span><span>,</span> <span>_params</span><span>,</span> <span>socket</span><span>)</span> <span>do</span>
    <span>{</span><span>:noreply</span><span>,</span> <span>assign</span><span>(</span><span>socket</span><span>,</span> <span>:count</span><span>,</span> <span>socket</span><span>.</span><span>assigns</span><span>.</span><span>count</span> <span>-</span> <span>1</span><span>)}</span>
  <span>end</span>
<span>end</span>

<span>defmodule</span> <span>Router</span> <span>do</span>
  <span>use</span> <span>Phoenix</span><span>.</span><span>Router</span>
  <span>import</span> <span>Phoenix</span><span>.</span><span>LiveView</span><span>.</span><span>Router</span>

  <span>pipeline</span> <span>:browser</span> <span>do</span>
    <span>plug</span><span>(</span><span>:accepts</span><span>,</span> <span>[</span><span>&#34;html&#34;</span><span>])</span>
  <span>end</span>

  <span>scope</span> <span>&#34;/&#34;</span><span>,</span> <span>SamplePhoenix</span> <span>do</span>
    <span>pipe_through</span><span>(</span><span>:browser</span><span>)</span>

    <span>live</span><span>(</span><span>&#34;/&#34;</span><span>,</span> <span>SampleLive</span><span>,</span> <span>:index</span><span>)</span>
  <span>end</span>
<span>end</span>

<span>defmodule</span> <span>SamplePhoenix</span><span>.</span><span>Endpoint</span> <span>do</span>
  <span>use</span> <span>Phoenix</span><span>.</span><span>Endpoint</span><span>,</span> <span>otp_app:</span> <span>:sample</span>
  <span>socket</span><span>(</span><span>&#34;/live&#34;</span><span>,</span> <span>Phoenix</span><span>.</span><span>LiveView</span><span>.</span><span>Socket</span><span>)</span>
  <span>plug</span><span>(</span><span>Router</span><span>)</span>
<span>end</span>

<span>{</span><span>:ok</span><span>,</span> <span>_</span><span>}</span> <span>=</span> <span>Supervisor</span><span>.</span><span>start_link</span><span>([</span><span>SamplePhoenix</span><span>.</span><span>Endpoint</span><span>],</span> <span>strategy:</span> <span>:one_for_one</span><span>)</span>
<span>Process</span><span>.</span><span>sleep</span><span>(</span><span>:infinity</span><span>)</span>

</code></pre></div><p>Turns out the bug wasn&#39;t in Phoenix at all and was an oopsie on my part. Can you spot it?</p> <p>This one is slightly more involved and is based on the <a href="https://github.com/wojtekmach/mix_install_examples/"><code>wojtekmach/mix_install_examples</code></a> project. With this file you have a fully functional Phoenix LiveView application in a single file running on port 5001!</p> <p>And you can see all of the stuff you <em>need</em> to make Phoenix Work, and frankly it&#39;s not that much. When people say we need a &#34;lightweight web framework&#34; ask them what&#39;s unnecessary in this file!</p> <h2 id="report-fly-io-issues"><a href="#report-fly-io-issues" aria-label="Anchor"></a>Report Fly.io Issues</h2><p>Here at Fly.io we try to be super responsive on the questions on our <a href="https://community.fly.io/">community forum</a>. Let&#39;s say we have an issue with using <code>mnesia</code> and fly volumes, like some users <a href="https://community.fly.io/t/using-fly-volumes-with-mnesia-phoenix-and-pow/1756/18">recently posted</a>. If we wanted to post an isolated bug report, we could set up a minimal project to help really get the attention of the support team.</p> <p>First, we&#39;d want a Dockerfile that can run Elixir scripts</p> <div><pre><code><span># syntax = docker/dockerfile:1</span>
<span>FROM</span><span> &#34;hexpm/elixir:1.14.2-erlang-25.2-debian-bullseye-20221004-slim&#34;</span>

<span># install dependencies</span>
<span>RUN </span>apt-get update <span>-y</span> <span>&amp;&amp;</span> apt-get <span>install</span> <span>-y</span> build-essential git libstdc++6 openssl libncurses5 locales <span>\
</span>    <span>&amp;&amp;</span> apt-get clean <span>&amp;&amp;</span> <span>rm</span> <span>-f</span> /var/lib/apt/lists/<span>*</span>_<span>*</span>

<span># Set the locale</span>
<span>RUN </span><span>sed</span> <span>-i</span> <span>&#39;/en_US.UTF-8/s/^# //g&#39;</span> /etc/locale.gen <span>&amp;&amp;</span> locale-gen

<span># Env variables we might want</span>
<span>ENV</span><span> LANG en_US.UTF-8</span>
<span>ENV</span><span> LANGUAGE en_US:en</span>
<span>ENV</span><span> LC_ALL en_US.UTF-8</span>
<span>ENV</span><span> ECTO_IPV6 true</span>
<span>ENV</span><span> ERL_AFLAGS &#34;-proto_dist inet6_tcp&#34;</span>

<span>WORKDIR</span><span> &#34;/app&#34;</span>

<span># Copy our files over</span>
<span>COPY</span><span> bug.exs /app</span>

<span># install hex + rebar if you plan on using Mix.install</span>
<span>RUN </span>mix local.hex <span>--force</span> <span>&amp;&amp;</span> <span>\
</span>    mix local.rebar <span>--force</span>

<span>CMD</span><span> elixir /app/bug.exs</span>

</code></pre></div><p>Finally add our <code>bug.exs</code></p> <div><pre><code><span>vol_dir</span> <span>=</span> <span>System</span><span>.</span><span>get_env</span><span>(</span><span>&#34;VOL_DIR&#34;</span><span>)</span> <span>||</span> <span>&#34;/data&#34;</span>

<span># Setup mnesiua</span>
<span>Application</span><span>.</span><span>put_env</span><span>(</span><span>:mnesia</span><span>,</span> <span>:dir</span><span>,</span> <span>to_charlist</span><span>(</span><span>vol_dir</span><span>))</span>
<span>:ok</span> <span>=</span> <span>Application</span><span>.</span><span>start</span><span>(</span><span>:mnesia</span><span>)</span>

<span># Check that mnesia is working</span>
<span>dbg</span><span>(</span><span>:mnesia</span><span>.</span><span>change_table_copy_type</span><span>(</span><span>:schema</span><span>,</span> <span>node</span><span>(),</span> <span>:disc_copies</span><span>))</span>

<span># Maybe try writing a file to see whatsup</span>
<span>path</span> <span>=</span> <span>Path</span><span>.</span><span>join</span><span>([</span><span>vol_dir</span><span>,</span> <span>&#34;hello.txt&#34;</span><span>])</span>
<span>File</span><span>.</span><span>write!</span><span>(</span><span>path</span><span>,</span> <span>&#34;Hello from elixir!&#34;</span><span>)</span>
<span>IO</span><span>.</span><span>puts</span><span>(</span><span>File</span><span>.</span><span>read!</span><span>(</span><span>path</span><span>))</span>

<span>Process</span><span>.</span><span>sleep</span><span>(</span><span>:infinity</span><span>)</span> <span># Keep it running so fly knows its okay</span>

</code></pre></div><p>And our <code>fly.toml</code></p> <div><pre><code>app = &#34;APP NAME&#34;

[mounts]
source = &#34;data&#34;
destination = &#34;/data&#34;

</code></pre></div><p>Now we can <code>fly create APP_NAME</code>, <code>fly volumes create data</code>, <code>fly deploy</code> and then check the logs <code>fly logs</code> to see what failed.</p> <p>In this case, I couldn&#39;t reproduce the error they were seeing. But it is helpful to have some code that&#39;s isolated to only the problem you are having. We could also see starting up a Phoenix server this way and deploying a weekend tiny app. I wouldn&#39;t recommend it, but you could!</p> <h2 id="in-conclusion"><a href="#in-conclusion" aria-label="Anchor"></a>In Conclusion</h2><p>If you take nothing else away from this post, I hope you click around <a href="https://github.com/wojtekmach">Wojtek Mach</a>&#39;s FANTASTIC <a href="https://github.com/wojtekmach/mix_install_examples/"><code>mix_install_examples</code></a> repository for Elixir script inspiration. You can do just about anything from Machine Learning to low level Systems Programming, all from a single file and the Elixir runtime.</p> <p>And finally, please don&#39;t be afraid to use them as a development tools. If you encounter a nasty bug in a library or your code, it can really help to isolate it to JUST the failing code and build out a simple repeatable test case like this.</p> <p>Or maybe instead of asking ChatGPT to write you a shell script, write it in Elixir, so a human can read it.</p> <figure> <figcaption> <p> Fly.io is a great way to run your Phoenix LiveView app close to your users. It&#39;s really easy to get started. You can be running in minutes.</p><p><a href="https://fly.io/docs/elixir/"> Deploy a Phoenix app today!  <span>→</span> </a></p> </figcaption><p><img src="https://fly.io/static/images/cta-dog.jpg" srcset="/static/images/cta-dog@2x.jpg 2x" alt=""/></p></figure>  </section> <dl> <dt> Previous post  ↓ </dt> <dd> <a href="https://fly.io/phoenix-files/phoenix-dev-blog-streams/"> Phoenix Dev Blog - Streams </a> </dd> </dl> </article></div>
  </body>
</html>
