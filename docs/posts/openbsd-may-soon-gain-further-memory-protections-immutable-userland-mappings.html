<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://undeadly.org/cgi?action=article;sid=20220902100648">Original</a>
    <h1>OpenBSD may soon gain further memory protections: immutable userland mappings</h1>
    
    <div id="readability-page-1" class="page"><div>
<div>
<p>Contributed by
<a href="http://bsdly.blogspot.com/">Peter N. M. Hansteen</a>
on <time datetime="2022-09-02T05:58:14Z">2022-09-02</time>
from the mutable no more dept.</p>
</div><p>
In a September 1st post to <code>tech@</code> titled <a href="https://marc.info/?l=openbsd-tech&amp;m=166203784715942&amp;w=2">immutable userland mappings</a>, Theo de Raadt (<code>deraadt@</code>) gave us a preview of code that may soon land in -current. The message leads in,
</p><blockquote><pre>In the last few years, I have been improving the strictness of userland
memory layout.

An example is the recent addition of MAP_STACK and msyscall().  The first one
marks pages that are stack, so that upon entry to the kernel we can check if
the stack-pointer is pointing in the stack range.  If it isn&#39;t, the most obvious
conclusion is that a ROP pivot has occured, and we kills the process.  The second
one marks the region which contains syscall traps, if upon entry to the kernel
the PC is not in that region, we know somone is trying to do system calls via
an unapproved method.
</pre>
</blockquote>


<blockquote><pre>My next attempt is to lock memory mappings.  The current working name is
mimmutable(void *addr, size_t len).  This identifies all current mapped memory
in a region, and tags the mappings.  Such mappings can never be unmapped.
No new mmap can be done on top of the mappings.  And the permissions cannot
be changed.  Other than that, the underlying storage memory works fine, it is
just the mapping that is locked.</pre>
</blockquote>
<p>
This is about work that is upcoming, still not committed. The post includes a patch which is sort of a snapshot of work in progress. 
</p><p>
You can read the full message and any followups starting <a href="https://marc.info/?l=openbsd-tech&amp;m=166203784715942&amp;w=2">here</a>, and please do test if you feel up to it.
</p></div></div>
  </body>
</html>
