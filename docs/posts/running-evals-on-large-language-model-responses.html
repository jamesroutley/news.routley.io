<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://josephm.dev/blog/20240812/">Original</a>
    <h1>Running Evals on Large Language Model Responses</h1>
    
    <div id="readability-page-1" class="page"><div>
          <main>
            <main>
    <article>
      
      
      <time>Aug 12, 2024</time>
      
      
      <h3 id="evaluating-large-language-models-used-in-a-clinical-charting-application"><strong>Evaluating Large Language Models Used in a Clinical Charting Application</strong></h3>
<p>For companies integrating large language models (LLMs) into their applications, a systematic approach to model and prompt evaluation is essential. This allows them to understand the variability in performance and ensures that they are choosing models optimized for their specific use cases.</p>
<p>A Jupyter or Google Colab Notebook offers a straightforward and flexible platform for generating prediction datasets and conducting comprehensive evaluations (evals). As new LLMs are released, these notebooks can be quickly updated and rerun to generate immediate evals on the latest models.</p>
<p>I created a notebook to generate predictions and evaluate the performance of various LLMs for a medical charting app. The “Generate Predictions” section of this notebook contains the process for generating a dataset of predictions from various models under consideration for use in a medical charting application. This section can be easily updated and rerun as new models are released. The “Prediction Evaluations” section contains analysis across several criteria important for this specific use case. This blog post contains just the text and graphical outputs from the “Prediction Evaluations” section. <a href="https://github.com/josephrmartinez/soapnotescribe/blob/main/evals/model_evals_2024_08_09.ipynb">You can view the full notebook here</a>.</p>
<h3 id="specific-use-case-medical-charting-application"><strong>Specific Use Case: Medical Charting Application</strong></h3>
<p><a href="https://github.com/josephrmartinez/soapnotescribe"><strong>soapnotescribe</strong></a> is a web application that utilizes LLMs to automatically generate structured clinical notes from medical appointment recordings.</p>
<p>The application workflow involves first sending the audio of the medical appointment to a speech-to-text model hosted by Replicate. The transcribed text is then processed by a large language model (served by OpenAI or Anthropic) to organize the content into a structured data object, which is subsequently presented to the physician as a SOAP note. (“SOAP” is an acronym for Subjective, Objective, Assessment, Plan — this is a standard structured format for documenting patient encounters.)</p>
<p><img src="https://josephm.dev/blogimages/model_evals_2024_08_09_files/application_diagram.png" alt="png"/></p>
<p>While all major foundational models can generate acceptable SOAP notes from audio transcriptions, they differ significantly in completion times, costs, and quality. Simple pass/fail evaluations are not sufficient to grasp the performance differences of different models under consideration.</p>
<p>The objective of this notebook is to systematically evaluate the performance of models available to convert transcriptions into structured SOAP notes and determine whether the application should be updated with one of the newly released models from OpenAI.</p>
<h3 id="assessing-new-models-from-openai"><strong>Assessing New Models from OpenAI</strong></h3>
<p>Before this analysis, I had been using gpt-4o-mini in production with completely satisfactory results. With the release of the gpt-4o-mini-2024-07-18 and gpt-4o-2024-08-06 models from OpenAI, I updated the first section of this notebook and reran the evaluations to determine what kinds of improvements, if any, were offered by these models. These systematic evals provided clarity on the following:</p>
<ul>
<li>The performance difference between gpt-4o-mini and gpt-4o-mini-2024-07-18.</li>
<li>The performance difference between gpt-4o and gpt-4o-2024-08-06.</li>
<li>Whether it would be beneficial to switch from gpt-4o-mini to gpt-4o-mini-2024-07-18 or gpt-4o-2024-08-06.</li>
</ul>
<h2 id="prediction-evaluations"><strong>Prediction Evaluations</strong></h2>
<p>In addition to standard evaluations such as cost, response time, and prediction length, this notebook contains evaluations that are specific to this particular use case and scoped down to individual fields in the requested JSON schema:</p>
<ul>
<li>Length of differential diagnosis field.</li>
<li>Inclusion of alternative treatment plan in differential diagnosis.</li>
<li>Correction of medication spelling errors from transcript.</li>
<li>Correction of medication formatting errors from transcript.</li>
</ul>
<h3 id="analysis-prediction-time"><strong>Analysis: Prediction Time</strong></h3>
<p>How long does it take for each model to return a response? Note that for some applications the variability of response times may be an important consideration. This dataset shows that some models are much more consistent in their response times than others.</p>
<p><img src="https://josephm.dev/blogimages/model_evals_2024_08_09_files/model_evals_2024_08_09_36_0.png" alt="png"/></p>
<p><img src="https://josephm.dev/blogimages/model_evals_2024_08_09_files/model_evals_2024_08_09_37_0.png" alt="png"/></p>
<p><strong>Performance difference between gpt-4o and gpt-4o-2024-08-06</strong></p>
<p><strong>Performance difference between gpt-4o-mini and gpt-4o-mini-2024-07-18</strong></p>
<h4 id="conclusions-prediction-time"><strong>Conclusions: Prediction Time</strong></h4>
<ul>
<li>
<p>gpt-4o-2024-08-06 predictions take about 0.77 seconds (12%) less time on average than gpt-4o predictions.</p>
</li>
<li>
<p>gpt-4o-mini-2024-07-18 predictions take about 2.1 seconds (28%) longer on average than gpt-4o-mini predictions</p>
</li>
<li>
<p>Prediction time is not the most important criteria for this use-case, but getting predictions in under ten seconds is desirable. For this reason, switching from gpt-4o-mini to gpt-4o-mini-2024-07-18 does not look advantageous.</p>
</li>
</ul>
<p><strong>Models With Best Prediction Speed and Consistency:</strong></p>
<ol>
<li>claude-3-haiku (reliably under 5 seconds)</li>
<li>gpt-3.5-turbo</li>
<li>gpt-4o-2024-08-06</li>
</ol>
<h3 id="analysis-prediction-cost"><strong>Analysis: Prediction Cost</strong></h3>
<p><img src="https://josephm.dev/blogimages/model_evals_2024_08_09_files/model_evals_2024_08_09_43_0.png" alt="png"/></p>
<p><img src="https://josephm.dev/blogimages/model_evals_2024_08_09_files/model_evals_2024_08_09_44_0.png" alt="png"/></p>
<p><strong>Performance difference between gpt-4o and gpt-4o-2024-08-06</strong></p>
<p><strong>Performance difference between gpt-4o-mini and gpt-4o-mini-2024-07-18</strong></p>
<h4 id="conclusions-prediction-cost"><strong>Conclusions: Prediction Cost</strong></h4>
<ul>
<li>gpt-4o-2024-08-06 has a 48.5% lower average prediction cost compared to gpt-4o.</li>
<li>gpt-4o-mini-2024-07-18 has a 20.4% lower average prediction cost compared to gpt-4o-mini.</li>
<li>gpt-4o-mini-2024-07-18 is now the least expensive model.</li>
</ul>
<p><strong>Models With Best (Lowest) Cost:</strong></p>
<ol>
<li>gpt-4o-mini-2024-07-18</li>
<li>gpt-4o-mini</li>
</ol>
<h3 id="analysis-output-tokens"><strong>Analysis: Output Tokens</strong></h3>
<p>Which models are more or less verbose?</p>
<p><img src="https://josephm.dev/blogimages/model_evals_2024_08_09_files/model_evals_2024_08_09_50_0.png" alt="png"/></p>
<p><img src="https://josephm.dev/blogimages/model_evals_2024_08_09_files/model_evals_2024_08_09_51_0.png" alt="png"/></p>
<p><strong>Performance difference between gpt-4o and gpt-4o-2024-08-06</strong></p>
<p><strong>Performance difference between gpt-4o-mini and gpt-4o-mini-2024-07-18</strong></p>
<h4 id="conclusions-output-tokens"><strong>Conclusions: Output Tokens</strong></h4>
<ul>
<li>The new models from OpenAI appear to be less verbose than their counterpart models.
<ul>
<li>gpt-4o-2024-08-06 returns about 20% less tokens than gpt-4o</li>
<li>gpt-4o-mini-2024-07-18 returns about 33% less tokens than gpt-4o-mini</li>
</ul>
</li>
<li>This less verbose behavior may not be advantageous. Brevity is not necessarily preferred for this use case.</li>
<li>Anthropic’s Claude models generally produce more verbose outputs compared to OpenAI’s GPT models.
<ul>
<li>claude-3-5-sonnet is an outlier in output token length.</li>
</ul>
</li>
</ul>
<p><strong>Models With Best Output Token Length:</strong></p>
<ul>
<li>Not applicable. Longer/shorter is not necessarily better.</li>
</ul>
<h3 id="analysis-differential-diagnosis"><strong>Analysis: Differential Diagnosis</strong></h3>
<ul>
<li>Was a Differential Diagnosis returned? If so, what was the average length?</li>
<li>How many Differential Diagnosis values included “alternative treatments” as requested in the system prompt?</li>
</ul>
<p><img src="https://josephm.dev/blogimages/model_evals_2024_08_09_files/model_evals_2024_08_09_57_0.png" alt="png"/></p>
<p><img src="https://josephm.dev/blogimages/model_evals_2024_08_09_files/model_evals_2024_08_09_58_0.png" alt="png"/></p>
<p><strong>Performance difference between gpt-4o and gpt-4o-2024-08-06</strong></p>
<p><strong>Performance difference between gpt-4o-mini and gpt-4o-mini-2024-07-18</strong></p>
<h4 id="conclusions-differential-diagnosis"><strong>Conclusions: Differential Diagnosis</strong></h4>
<p>The claude-3-5-sonnet model is an outlier with Differential Diagnosis outputs that are 3 to 5 times longer than those of other models. Manual review indicates that these longer outputs are of high quality and significantly enrich the SOAP notes.</p>
<p><strong>gpt-4o-2024-08-06</strong></p>
<ul>
<li>gpt-4o-2024-08-06 returns a differrential about the same length as gpt-4o</li>
<li>gpt-4o-2024-08-06 returns an alternative treatment plan 100% of the time; compared to gpt-4o which only returned an alternative treatment plan 50% of the time.</li>
</ul>
<p><strong>gpt-4o-mini-2024-07-18</strong></p>
<ul>
<li>gpt-4o-mini-2024-07-18 returns a differrential about half the length as gpt-4o-mini</li>
<li>This less verbose behavior may not be advantageous. Brevity is not nessesarily preferred for this use case.</li>
<li>gpt-4o-mini-2024-07-18 returns an alternative treatment plan 50% of the time; compared to gpt-4o-mini which returned an alternative treatment plan 80% of the time.</li>
</ul>
<p><strong>Models With Best Differential Diagnosis:</strong></p>
<ul>
<li>Claude-3.5-Sonnet: Consistently provides a detailed Differential Diagnosis along with alternative treatment options, as requested. Notably produces longer, more comprehensive responses.</li>
<li>gpt-3.5-turbo: Reliably returns a Differential Diagnosis with alternative treatment options.</li>
<li>gpt-4o-2024-08-06: Reliably returns a Differential Diagnosis with alternative treatment options.</li>
</ul>
<h3 id="analysis-fixing-transcription-errors"><strong>Analysis: Fixing Transcription Errors</strong></h3>
<p>The transcript includes the text “Vicodin 5-3, 25 milligrams” for when the speaker said “Vicodin five slash three twenty-five milligrams.” This should have been transcribed as “Vicodin 5/325 milligrams.”</p>
<p>The dosage of medications is typically written with a slash (”/”) to clearly separate the amounts of each ingredient. “5” represents the amount of hydrocodone (usually in milligrams), and “325” represents the amount of acetaminophen (also in milligrams).
“Vicodin 5/325” means each tablet contains 5 mg of hydrocodone and 325 mg of acetaminophen.</p>
<p>The transcript also includes a spelling error related to a medication name: “flexor all 20 milligram tablets” should be “Flexeril 20 milligram tablets”.</p>
<p>While this was not specifically requested in the prompt, some of the models caught these mistakes in the transcript and automatically fixed them in the response.</p>
<p><img src="https://josephm.dev/blogimages/model_evals_2024_08_09_files/model_evals_2024_08_09_64_0.png" alt="png"/></p>
<p><img src="https://josephm.dev/blogimages/model_evals_2024_08_09_files/model_evals_2024_08_09_65_0.png" alt="png"/></p>
<h4 id="conclusions-fixing-transcription-errors"><strong>Conclusions: Fixing Transcription Errors</strong></h4>
<ul>
<li>All models reliably fix the medication formatting error in the transcript.</li>
<li>Except for claude-3-5-sonnet and gpt-3.5-turbo, all models are catching the spelling errors 100% of the time.</li>
<li>Manual inspection of claude-3-5-sonnet and gpt-3.5-turbo predictions that did not catch spelling errors reveals unexpected behavior:
<ul>
<li>On the one occasion when claude-3-5-sonnet failed to correct the spelling of “flexor all” for “Flexeril,” the model actually made the correction to “Cyclobenzaprine,” which is the generic name for Flexeril.</li>
<li>On the five occasions when GPT-3.5-turbo failed to correct the spelling of “flexor all,” the model actually omitted the medication from the note entirely. This error is far more concerning.</li>
</ul>
</li>
</ul>
<h3 id="model-comparisons"><strong>Model Comparisons</strong></h3>
<h4 id="gpt-4o-2024-08-06-compared-to-gpt-4o"><strong>gpt-4o-2024-08-06 compared to gpt-4o</strong></h4>
<p><img src="https://josephm.dev/blogimages/model_evals_2024_08_09_files/model_evals_2024_08_09_73_0.png" alt="png"/></p>
<p><strong>Output Tokens:</strong>
Less verbose (20% less output tokens)</p>
<p><strong>Cost:</strong>
Better (49% cost reduction due to price cut and output reduction)</p>
<p><strong>Prediction times:</strong>
Better (0.77 seconds shorter / 12% shorter avg time)</p>
<p><strong>Fix Transcription Spelling Errors:</strong>
Equal</p>
<p><strong>Fix Transcription Formatting Errors:</strong>
Equal</p>
<p><strong>Include Alternative Treatment Plan with Differential:</strong>
Better (100% success rate compared to 50%)</p>
<p><strong>Length of Differential Diagnosis:</strong>
Equal</p>
<p><strong>Conclusion:</strong> gpt-4o-2024-08-06 is better than gpt-4o for this use case</p>
<h4 id="gpt-4o-mini-2024-07-18-compared-to-gpt-4o-mini"><strong>gpt-4o-mini-2024-07-18 compared to gpt-4o-mini</strong></h4>
<p><img src="https://josephm.dev/blogimages/model_evals_2024_08_09_files/model_evals_2024_08_09_70_0.png" alt="png"/></p>
<p><strong>Output Tokens:</strong>
Less verbose (33% less output tokens)</p>
<p><strong>Cost:</strong>
Better (20% cost reduction simply due to output reduction)</p>
<p><strong>Prediction times:</strong>
Worse (2.11 seconds longer / 27.7% longer avg time)</p>
<p><strong>Fix Transcription Spelling Errors:</strong>
Equal</p>
<p><strong>Fix Transcription Formatting Errors:</strong>
Equal</p>
<p><strong>Include Alternative Treatment Plan with Differential:</strong>
Worse (50% success rate compared to 80%)</p>
<p><strong>Length of Differential Diagnosis:</strong>
Less verbose (59% shorter)</p>
<p><strong>Conclusion:</strong> gpt-4o-mini-2024-07-18 is worse than gpt-4o-mini for this use case</p>
<h3 id="overall-model-rankings-by-criteria"><strong>Overall Model Rankings by Criteria</strong></h3>
<p><strong>Lowest cost:</strong></p>
<ol>
<li>gpt-4o-mini</li>
<li>claude-3-haiku</li>
<li>gpt-3.5-turbo</li>
</ol>
<p><strong>Inclusion of Alternative Treatment with Differential Diagnosis:</strong></p>
<ol>
<li>claude-3.5-sonnet (long, very thorough)</li>
<li>gpt-3.5-turbo</li>
<li>gpt-4o-2024-08-06</li>
</ol>
<ul>
<li>No other models scored 100%</li>
</ul>
<p><strong>Fixing transcription errors:</strong></p>
<ul>
<li>All models 100% except claude-3.5-sonnet and gpt-3.5-turbo</li>
</ul>
<p><strong>Quick, consistent prediction times:</strong></p>
<ol>
<li>claude-3-haiku (reliably under 5 seconds)</li>
<li>gpt-3.5-turbo</li>
<li>gpt-4o-2024-08-06</li>
</ol>
<h4 id="takeaways"><strong>Takeaways</strong>:</h4>
<ul>
<li>gpt-4o-2024-08-06 is generally an improvement over gpt-4o. Perform more detailed analysis on output token reduction and what information might be dropped due to less verbose behavior.</li>
<li>gpt-4o-mini-2024-07-18 is not a significant improvement over gpt-4o-mini for this use case.</li>
<li><strong>Consider Switching Model to gpt-4o-2024-08-06:</strong>
<ul>
<li>100% reliability for including alternative treatment plan</li>
<li>Faster response time</li>
<li>More expensive model, but cost difference has reduced</li>
</ul>
</li>
</ul>
<h3 id="determine-implications-of-switching-to-gpt-4o-2024-08-06-from-gpt-4o-mini"><strong>Determine Implications of Switching to gpt-4o-2024-08-06 from gpt-4o-mini</strong></h3>
<p>Compare model now under consideration (gpt-4o-2024-08-06) to model currently used in production (gpt-4o-mini) to understand implications of switching models.</p>
<p><img src="https://josephm.dev/blogimages/model_evals_2024_08_09_files/model_evals_2024_08_09_78_0.png" alt="png"/></p>
<p><strong>Implications of switching to gpt-4o-2024-08-06 from gpt-4o-mini:</strong></p>
<p><strong>Cost:</strong>
Worse (12 x the cost of gpt-4o-mini)</p>
<p><strong>Output Tokens:</strong>
Less verbose (34% less output tokens)</p>
<p><strong>Prediction times:</strong>
Better (2 seconds shorter / 26% shorter avg time)</p>
<p><strong>Fix Transcription Spelling Errors:</strong>
Equal</p>
<p><strong>Fix Transcription Formatting Errors:</strong>
Equal</p>
<p><strong>Include Alternative Treatment Plan with Differential:</strong>
Better (100% success rate compared to 80%)</p>
<p><strong>Length of Differential Diagnosis:</strong>
Less verbose (38% shorter)</p>
<p><strong>Conclusion:</strong></p>
<ul>
<li>If getting 100% inclusion of alternative treatment plans in the differential diagnosis and quicker response times would make a significant improvement for users of this application, gpt-4o-2024-08-06 could be a better model than gpt-4o-mini for this use case. However, while response time may be specific to that model, it may be possible to get an alternative treatment included in the differential by further developing the prompt.
<ul>
<li>Test separating alternative treatment plan into a separate required field on the JSON Schema to force a 100% successful inclusion rate from gpt-4o-mini.</li>
</ul>
</li>
<li>Note that switching over to gpt-4o-2024-08-06 from gpt-4o-mini will have a 12x increase on prediction costs.</li>
</ul>
<p><strong>Recommendations:</strong></p>
<ul>
<li>Perform detailed review on differential diagnosis results from gpt-4o-2024-08-06 and gpt-4o-mini to understand what information, if any, is being left out in less verbose responses.</li>
</ul>
    </article>
  </main>
          </main>
        </div></div>
  </body>
</html>
