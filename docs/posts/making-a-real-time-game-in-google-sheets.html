<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://eieio.games/nonsense/game-10-realtime-gsheet/">Original</a>
    <h1>Making a real-time game in Google Sheets</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody">
    <p>I made a game. It’s in a Google Sheet:</p>


<p>There’s some stuff going on here! But in addition to aesthetics this game is “real time” - the spreadsheet tracks the time when you complete tasks and compares those times to where the animated blue progress bar is. Your final evaluation (in the lower right) tells you whether you completed your tasks early, on time, or late. This is all driven purely via Google Sheets formulas - no Apps Script or other trickery needed.</p>

<p>Let’s talk about how this works!
<!-- excerpt-end --></p>



<p>Before we get into it - <a href="https://docs.google.com/spreadsheets/d/1cY0YMKkQGrS_Xlsvv5e2-oZru9_nqORSRC2khOLMKkc/copy#gid=714573644">here’s a link to the sheet</a> if you want to play. To play the game, navigate to the “GAME” sheet, <em>refresh</em> your browser tab, and then check the box in the upper left when the first gif says “go.” And then try to complete the tasks in the sheet while animations are playing next to them.</p>

<p><em>Note that you’ll be prompted to copy an Apps Script as well. That script is just used to reset the game to its starting state so that you can replay it.</em></p>



<p>This game relies on 3 tricks to power its interactivity and make it work in real time:</p>
<ul>
  <li>Using circular cell references that allow us to record the first time an action is performed.</li>
  <li>Embedding images in cells so that we can swap them out via formulas</li>
  <li>Adding many seconds of “silence” to non-looping gifs to make unrelated gifs seem connected.</li>
</ul>

<p>I you want to see all of the calculations in the sheet open up the “GAME” tab, scroll down, and click the checkbox to view the ‘calculation zone.’</p>


<p><i>Examples from this section are available in <a href="https://docs.google.com/spreadsheets/d/1cY0YMKkQGrS_Xlsvv5e2-oZru9_nqORSRC2khOLMKkc/copy?usp=sharing">this tab</a>. Mouse over and off of any gif to make it stop playing.</i></p>

<p>To understand whether an action (like checking a checkbox) is “early” or “late,” we need the time at which the action was performed. That’s a little hard to do. Here’s a naive attempt:</p>

<p><img src="https://akuity.io/assets/images/sheets/example2.gif" onmouseover="this.src=&#39;/assets/images/sheets/example2.gif&#39;" onmouseout="this.src=&#39;/assets/images/sheets/example2.png&#39;"/>

</p>
<p>not particularly useful</p>

<p>A cell that depends on a <code>NOW</code> call updates its value whenever another cell in the sheet changes<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" rel="footnote">1</a></sup> (the “force recomputation” checkbox is just to make it clear when I am editing the editing the sheet and forcing an update). So instead of logging when our “BEGIN” box is checked, we’re just logging the current time!  What we want is “the current time, only if we haven’t updated this cell yet.”</p>

<p>And it turns out that we can do exactly that, as long as we <a href="https://www.gworkspacetips.com/how-to-enable-iterative-calculation-in-google-sheets/">enable iterative calculation</a> so that we can make recursive cells.</p>

<p><img src="https://akuity.io/assets/images/sheets/example3.gif" onmouseover="this.src=&#39;/assets/images/sheets/example3.gif&#39;" onmouseout="this.src=&#39;/assets/images/sheets/example3.png&#39;"/>
</p>
<p>a little more useful</p>

<p>By making the formula in <code>A10</code> depend on itself,  we can create a cell that <em>only updates once.</em> The first time that <code>BEGIN</code> is checked, <code>AND(A10=0,BEGIN)</code> is true (because <code>A10</code> has no value, and Google Sheets resolves circular references to empty cells to <code>0</code>), and so we set <code>A10</code> to the current time. From then on <code>A10</code> is never 0, so we always return <code>A10</code>’s current value. So <code>A10</code> can’t be changed and is frozen to the timestamp when I made this example! This is neat but not super useful yet - we want our game to be replayable, so we need some way to reset our stored value.</p>

<p><img src="https://akuity.io/assets/images/sheets/example4.gif" onmouseover="this.src=&#39;/assets/images/sheets/example4.gif&#39;" onmouseout="this.src=&#39;/assets/images/sheets/example4.png&#39;"/>

</p>
<p>almost there</p>

<p>This works! Adding a second <code>IF</code> gives us a cell that updates the <em>first</em> time that <code>BEGIN</code> is checked, and then holds onto that value until <code>BEGIN</code> is unchecked. But in the game I didn’t want unchecking a cell to clear its timestamp since I figured it was easy to uncheck a cell on accident. So instead I use a separate <code>RESET</code> value for clearing state, meaning that <code>BEGIN</code> can be toggled off without clearing the timestamp:</p>

<p><img src="https://akuity.io/assets/images/sheets/example5.gif" onmouseover="this.src=&#39;/assets/images/sheets/example5.gif&#39;" onmouseout="this.src=&#39;/assets/images/sheets/example5.png&#39;"/>

</p>
<p>that&#39;s it!</p>

<p>And that’s the primary technique that this game ends up using to log times. It’s useful for other purposes too - for example, I generate random numbers for the math problem by memoizing a call to <code>RANDBETWEEN</code>.</p>



<p>I also make heavy use of the images embedded in cells. You can embed an image in a cell via the “insert” tab, or you can hotlink an image via the formula <code>IMAGE(&#34;LINK&#34;)</code>. This is fun on its own (it’s weird to see images embedded in cells!) but very powerful when referencing images via formulas, which allows us to dynamically swap images in and out.</p>

<p><img src="https://akuity.io/assets/images/sheets/example6.gif" onmouseover="this.src=&#39;/assets/images/sheets/example6.gif&#39;" onmouseout="this.src=&#39;/assets/images/sheets/example6.png&#39;"/>

</p>
<p>I can&#39;t see without my 3d glasses</p>

<p>I use this for the “find my glasses” and “fridge magnet poetry” games. I’d <em>like</em> to say that I also use this technique to swap in gifs to dynamically trigger animations but unfortunately that doesn’t work! Gifs embedded in cells only display their first frame. This is a huge bummer because being able to swap out animated gifs on the fly would be super powerful. Instead, animated gifs need to be overlaid on <em>top</em> of cells and will automatically play when the sheet loads.</p>



<p>So all of our gifs play on sheet load and they need to all play in sequence. One approach I considered for this is making a single megagif that is overlaid over the whole sheet but that sounds pretty unwieldy (and I think the gif would get huge)[^2]. So instead I generated a series of gifs for the sheet and used <code>convert</code> (part of the ImageMagick suite of tools) to embed more and more “silence” (e.g. repetitions of the first frame) in each gif so that they’d play one after the other.</p>

<p>The code for that looks something like this:</p>
<div><div><pre><code><span>#!/usr/bin/env bash</span>

<span>_empty</span><span>=</span><span>&#34;bar-empty.png&#34;</span>
<span>empty_measure</span><span>=</span><span>&#34;</span><span>$_empty</span><span> </span><span>$_empty</span><span> </span><span>$_empty</span><span> </span><span>$_empty</span><span>&#34;</span>

main<span>()</span> <span>{</span>
    <span>measures_of_silence</span><span>=</span><span>&#34;</span><span>$1</span><span>&#34;</span><span>;</span> <span>shift
    </span><span>target_file</span><span>=</span><span>&#34;bar-</span><span>${</span><span>measures_of_silence</span><span>}</span><span>beats.gif&#34;</span>
    <span>files</span><span>=</span><span>&#34;&#34;</span>

    <span>while</span> <span>((</span> <span>&#34;</span><span>$measures_of_silence</span><span>&#34;</span> <span>&gt;</span> 0 <span>))</span>
    <span>do
        </span><span>files</span><span>=</span><span>&#34;</span><span>$empty_measure</span><span> </span><span>$files</span><span>&#34;</span>
        <span>measures_of_silence</span><span>=</span><span>$((</span>measures_of_silence-1<span>))</span>
    <span>done

    </span><span>files</span><span>=</span><span>&#34;</span><span>$files</span><span> bar1.png bar2.png bar3.png bar4.png&#34;</span>
    convert <span>-dispose</span> previous <span>-delay</span> 25 <span>-loop</span> 1 <span>$files</span> <span>$target_file</span>
<span>}</span>

main <span>&#34;</span><span>$@</span><span>&#34;</span>
</code></pre></div></div>

<p>Briefly: we take in the number of seconds that we want our animation to wait before playing, and embed that many seconds of just our first frame (<code>delay</code> is in centiseconds; we’re running at 4 frames a second). Then we create our gif, which is always 4 frames (animations always last one second). And we disable looping (by setting our loop count to 1) because it’d look weird if our starting animation played the whole time.</p>



<p>To start the game I have players refresh the tab, which causes all the gifs to reload. Then they check the box in the upper left when “GO” is displayed - this gives me a start time from which I can derive when other animations on the sheet should play. I also pay attention to when some other early tasks are performed and use that to update my notion of when animations are playing (in case the player checked the first box early or late).</p>

<p>All the tasks in the sheet use the same trick to track when they’re completed - the game compares those times to a hardcoded “range at which this task can be performed” to decide whether you’re early, on time, or late. This, along with a giant table of calculations, drives the evaluation that you get.</p>

<p><img src="https://akuity.io/assets/images/sheets/example7.png"/>
</p>
<p>calculations from the first two zones</p>

<p>Most of the rest of the sheet was about spending hours messing with formatting to make everything look right. A few other tricks or hard to google things that I can call out:</p>
<ul>
  <li>To make the “pops” section I hand-coded 15 conditional formatting rules to make one new cell show every time you check a cell.</li>
  <li>To make the code easier to read I make heavy use of <a href="https://support.google.com/docs/answer/63175?hl=en">named ranges</a> and <a href="https://support.google.com/docs/answer/12504534?hl=en">named functions</a></li>
  <li>Iterative calculation sometimes requires an extra page edit to force all values to update<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" rel="footnote">2</a></sup>. This is why there are 3 checkboxes to show the final “report” - only two are needed for the report to be displayed, but having 3 encourages folks to toggle all three of them on and off, and the 3rd toggle should always force a refresh to the “right” state.</li>
  <li>The one thing I couldn’t figure out how to do without Apps Script was reset the state of the game! So I added a script to do that during testing and just kept it in for the final game. It makes the sheet a bit less pure but I think it’s worth it.</li>
</ul>



<p>I got started with Google Sheets games during a gamejam at the lovely <a href="https://www.wonderville.nyc/">Wonderville</a> bar in New York, where <a href="https://twitter.com/snakesandrews">Blake Andrews</a> runs a monthly 2 hour gamejam using unusual engines. For this jam <a href="https://www.literallyaking.com/">Alexander King</a> gave an excellent talk about how (and why) to build games in Google Sheets, which taught me some of the techniques that this game uses. Alexander was also nice enough to chat with me after the jam and point me in the right direction on using recursive references for impure memoization. Thank you both!</p>

<p>I <em>built</em> this game in my last week at <a href="https://www.recurse.com/">Recurse Center</a>, a place that functions like a writers retreat for programmers. Recurse has been an incredible environment to build and share fun and bizarre stuff like this game. If that sounds fun to you you should consider <a href="https://www.recurse.com/apply">applying!</a>.</p>



  </div></div>
  </body>
</html>
