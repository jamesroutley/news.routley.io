<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://dillan.org/articles/how-to-get-root-access-to-your-sleep-number-bed">Original</a>
    <h1>How to get root access to your Sleep Number bed</h1>
    
    <div id="readability-page-1" class="page"><div><h2 id="table-of-contents">Table of Contents</h2>
<nav><ol><li><a href="#motivation">Motivation</a></li><li><a href="#pre-requisites">Pre-Requisites</a></li><li><a href="#gaining-root-access">Gaining Root Access</a></li><li><a href="#creating-a-local-network-control-and-monitoring-server">Creating a Local Network Control and Monitoring Server</a><ol><li><a href="#adding-rcd-scripts-to-the-realroot-partition-stored-on-disk-outside-the-chroot">Adding rc.d Scripts to the /real.root Partition Stored on Disk (Outside the chroot)</a></li><li><a href="#useful-commands">Useful Commands</a></li></ol></li><li><a href="#next-steps">Next Steps</a></li><li><a href="#appendix-original-u-boot-env-variables-on-my-hub">Appendix: Original U-Boot Env Variables on My Hub</a></li><li><a href="#footnote-label">Footnotes</a></li></ol></nav>
<p><em>Disclaimer: Following this guide will require modifying internal files on your Sleep Number hub. This will void your warranty and if something goes wrong as a result of this process, you will not receive help from Sleep Number to fix it. There are many ways you can damage your system, through both hardware and software modifications. The author provides no guarantees and you follow this process at your own risk.</em></p>
<p>As an Amazon Associate, I earn from qualifying purchases. Thank you for your support.</p>
<h2 id="motivation">Motivation</h2>
<p>I have been interested in exploring the possibility of local network access on my Sleep Number bed for a few years. A while back I created a <a href="https://homebridge.io/">homebridge</a> plugin for the platform that would let me control some of the settings of the bed through HomeKit or some automations. The &#34;bed presence&#34; value, which indicated whether somebody was in bed or not, was especially nice for running automations such as turning off all the lights or locking the door. However, after running the plugin for a couple years and growing the user base large enough, I received a friendly phone call from corporate Sleep Number asking me to kindly disable the plugin.</p>
<p>You see, I had set the plugin to request data from the SleepIQ API every 5 seconds to get an accurate reading on the bed presence value. Multiply that by the couple thousand users of the plugin at that point and the result was enough strain on their network that they had taken notice and started looking for the cause. They also weren&#39;t too fond of the branding of the repository, since to the untrained eye it looked like an official Sleep Number tool, which it definitely was not. Oh well, lessons learned, I shut it down.</p>
<p>This was the motivator for finding a way to access the local network and bypass their servers completely. I passed my learnings from the homebridge plugin to a good friend who restarted that project in a <a href="https://github.com/hbblebc/homebridge-bed-control">new and improved plugin</a> (which disables the bed presence monitoring by default and included lots of warnings before enabling it) and turned my focus to the hardware.</p>
<p>I cracked open the hub a couple times and looked around for anything obvious. At first, my attention was drawn to the J10 header near the CPU.</p>
<figure><img alt="J10 Header" loading="lazy" width="3024" height="2357" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fj10.2e873fcb.png&amp;w=3840&amp;q=75 1x" src="https://outsiderart.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fj10.2e873fcb.png&amp;w=3840&amp;q=75"/><figcaption>J10 Header (I took the pictures after installing the pin headers. Yours are probably just holes.)</figcaption></figure>
<p>In one CPU configuration, those pins would contain UART lines. However, try as I might, I was never able to get any UART data out. The CPU is in a different configuration. For some reason, I never thought to test the J16 header lower down on the board during my first attempts, but recently I finally took notice of it.</p>
<figure><img alt="J16 Header" loading="lazy" width="3024" height="2564" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fj16.b279ee9b.png&amp;w=3840&amp;q=75 1x" src="https://outsiderart.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fj16.b279ee9b.png&amp;w=3840&amp;q=75"/><figcaption>J16 Header</figcaption></figure>
<p>This time I wanted to be sure, so I bought a logic analyzer and connected it to all 10 available header pins.</p>
<figure><img alt="Uart data in the logic analyzer" loading="lazy" width="2478" height="970" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flogic_analyzer.501d0ea5.png&amp;w=3840&amp;q=75 1x" src="https://outsiderart.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flogic_analyzer.501d0ea5.png&amp;w=3840&amp;q=75"/><figcaption>UART data in the logic analyzer</figcaption></figure>
<p>Bingo.</p>
<p>I hooked up my UART-TTY device and at long last was greeted with a device console.</p>
<figure><img alt="UART console showing u-boot bootloader output" loading="lazy" width="1293" height="602" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fuart_console.36cba931.png&amp;w=1920&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fuart_console.36cba931.png&amp;w=3840&amp;q=75 2x" src="https://outsiderart.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fuart_console.36cba931.png&amp;w=3840&amp;q=75"/><figcaption>UART console showing u-boot bootloader output</figcaption></figure>
<p>I spent some time dumping the flash to browse the file system on the board and look through the files for different vulnerabilities. At first I was searching for a backdoor that would allow anybody to log into the hub without needing to hook up a UART, but I came up empty. Well, not empty. <span>What I did find was a &#34;convenient&#34; backdoor that Sleep Number can use to SSH back into the hub</span> (and my internal home network as a result). Likely it is to perform maintenance on the hub as needed, but the paranoid part of me was not happy when I found that. Regardless of if you choose to follow this guide or are just reading for fun, I highly recommend you disconnect the wifi on your hub and only use bluetooth controls as much as possible. That being said, for those willing to do a little hardware work, setting up local network access is straightforward, and the rest of this post will detail the steps you need to follow to do so on your own hub.</p>
<p>This guide will also be useful for anybody who purchased a used hub from somebody else, only to find out that Sleep Number refuses to connect to it without an associated order number. The only extra requirement is to add a <code>bam-init.conf</code> file to the USB drive to provide network details to the hub (probably, I haven&#39;t tested that process yet).</p>
<h2 id="pre-requisites">Pre-Requisites</h2>
<p>This process was performed on Sleep Number Hub with model number: 360SIQ01D. It looks like this:</p>
<figure><img alt="Sleep Number Hub" loading="lazy" width="4129" height="3590" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fhub.fcf67824.png&amp;w=3840&amp;q=75 1x" src="https://outsiderart.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fhub.fcf67824.png&amp;w=3840&amp;q=75"/><figcaption>Sleep Number Hub</figcaption></figure>
<p>You will also need a UART to TTY device and some other hardware tools.</p>
<table><thead><tr><th>Item</th><th>Description</th><th>Price</th><th>Paid Link</th></tr></thead><tbody><tr><td>USB-C to UART</td><td>This is the device I used because it is USB-C and less than $10 (at the time of writing)</td><td>$9.99</td><td><a href="https://amzn.to/3xr1rBk">https://amzn.to/3xr1rBk</a></td></tr><tr><td>USB-A to UART</td><td>There are also plenty of USB-A options, such as this one from the same company</td><td>$13.99</td><td><a href="https://amzn.to/3RAmHeR">https://amzn.to/3RAmHeR</a></td></tr><tr><td>Raspberry Pi Pico W</td><td>Another option is to buy a Raspberry Pi Pico W and install it inside the case permanently, so you can easily remotely connect to the console in case the SSH ever stops working<sup><a href="#user-content-fn-1" id="user-content-fnref-1" data-footnote-ref="true" aria-describedby="footnote-label">1</a></sup></td><td>$11.50</td><td><a href="https://amzn.to/3VQ5YXh">https://amzn.to/3VQ5YXh</a></td></tr><tr><td>2.54mm Pin Headers</td><td>These will let you add permanent pin headers to your board</td><td>$7.99</td><td><a href="https://amzn.to/4c9Arp8">https://amzn.to/4c9Arp8</a></td></tr><tr><td>Soldering Iron</td><td>Needed to solder the pin headers in place</td><td>$13.99</td><td><a href="https://amzn.to/3RzKQC4">https://amzn.to/3RzKQC4</a></td></tr><tr><td>PCB Clip Clamp</td><td>A temporary alternative to the above options. You can clip this to the pin headers on the board</td><td>$13.99</td><td><a href="https://amzn.to/3xiuXJE">https://amzn.to/3xiuXJE</a></td></tr></tbody></table>
<p><em>Prices are approximate and may have changed since the time of writing.</em></p>
<p>To make it easier to connect to the board, you will want to either get the pin headers and the soldering iron or the PCB clip clamp.</p>
<p>You will communicate with the UART device through a serial console. On Linux or Mac, you can use <code>minicom</code>. On Windows, PuTTY is a good choice.</p>
<p>You will also need a USB-A flash drive formatted as FAT32 or Ext3.</p>
<h2 id="gaining-root-access">Gaining Root Access</h2>
<ol>
<li>
<p>Connect your UART device to header J16 on the board.The pinout is as follows:</p>
<figure><img alt="UART Connection" loading="lazy" width="4032" height="3024" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fuart_connection.6149aa37.png&amp;w=3840&amp;q=75 1x" src="https://outsiderart.substack.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fuart_connection.6149aa37.png&amp;w=3840&amp;q=75"/><figcaption>UART Connection</figcaption></figure>
<ul>
<li>pin 1 is TX (into hub)</li>
<li>pin 2 is RX (out of hub)</li>
<li>pin 3 is ground</li>
</ul>
</li>
<li>
<p>Connect your console to your UART device (minicom, etc.). The board uses a baud rate of 115200.</p>
</li>
<li>
<p>Power on your hub, you have 2 seconds to press &lt;SPACE&gt; to stop the auto-boot sequence.</p>
</li>
<li>
<p>Edit the boot environment variables:</p>
<ul>
<li>
<p>Back up the default environment variables. Run <code>printenv -a</code> and save the output somewhere you can use to recover the defaults if necessary. I have included a copy in the appendix of this post but my environment might differ from yours, so be sure to note any differences.</p>
</li>
<li>
<p>Run <code>editenv bootcmd</code> and remove the section that says <code>run set_bootargs;</code> (we are going to set the bootargs manually). The variable should contain the following:</p>
<div><pre><span data-line-number="1"><span>bootcmd</span><span>=</span><span>r</span><span>u</span><span>n</span><span> </span><span>find_board_name</span><span>;</span><span> </span><span>setenv</span><span> </span><span>boot_mmcdev</span><span> </span><span>0</span><span>;</span><span> </span><span>run</span><span> </span><span>bootcmd_mmc</span><span>;</span><span>setenv</span><span> </span><span>boot_mmcdev</span><span> </span><span>1</span><span>;</span><span> </span><span>run</span><span> </span><span>bootcmd_mmc</span></span></pre></div>
</li>
<li>
<p>The <code>/init</code> script is stored in the hashed bootrom, so we can&#39;t modify it without flashing an entirely new bootloader. Instead, we will do a runtime modification using the <code>bootargs</code> environment variable. Run <code>editenv bootargs</code> and add the following:</p>
<div><pre><span data-line-number="1"><span>console</span><span>=</span><span>t</span><span>t</span><span>y</span><span>m</span><span>x</span><span>c</span><span>0</span><span>,</span><span>1</span><span>1</span><span>5</span><span>2</span><span>0</span><span>0</span><span> </span><span>root</span><span>=</span><span>/</span><span>d</span><span>e</span><span>v</span><span>/</span><span>m</span><span>m</span><span>c</span><span>b</span><span>l</span><span>k</span><span>$</span><span>{</span><span>linux_mmcdev</span><span>}</span><span>p</span><span>1</span><span> </span><span>rootwait</span><span> </span><span>rdinit=/bin/bash</span><span> </span><span>-</span><span>-</span><span> </span><span>-</span><span>c</span><span> </span><span>&#34;</span><span>sed -i &#39;s/LMR=</span><span>`</span><span>.</span><span>*</span><span>`</span><span>/LMR=let_me_root/&#39; /init; exec /init</span><span>&#34;</span></span></pre></div>
<p>By default, the script is looking for an encrypted file that decrypts to the <code>let_me_root</code> phrase. We replaced the decryption line with the decrypted value so we can bypass the encryption requirement<sup><a href="#user-content-fn-2" id="user-content-fnref-2" data-footnote-ref="true" aria-describedby="footnote-label">2</a></sup>.</p>
</li>
<li>
<p>When everything looks correct, make the changes persistent with <code>saveenv</code>. You can try booting once before saving to make sure everything still works but you will need to repeat the above steps the next time you boot if you don&#39;t save the environment.</p>
</li>
</ul>
</li>
<li>
<p>For the first boot, you will need to insert a flash drive with a file named &#34;let_me_root&#34; on it. If your hub already has what appears to be a flash drive inserted, it is likely a Wi-Fi dongle that will cause a boot loop if it is not present. You will need a USB hub that allows you to connect multiple USB drives at once to get around this issue (just for the first boot). You can boot from the u-boot menu by running <code>run bootcmd</code>. Once you are booted, you should see the following output in the console:</p>
<pre><code>Starting OpenBSD Secure Shell server: sshd
done.
Starting ntpd: done
Starting crond: OK
INIT: no more processes left in this runlevel
</code></pre>
<p>At this point, if everything worked, you should be able to hit the enter key and see <code>root@bam-se:~#</code>.</p>
<p>If you do not see this, double-check the <code>bootargs</code> and make sure they match the example above. Also make sure your flash drive has the <code>let_me_root</code> file in place (its format should be FAT32 or EXT3, I don&#39;t know if any other formats will work but I know these will).</p>
</li>
<li>
<p>Once you have the prompt, we will make it persistent without needing the flash drive</p>
<ul>
<li>Remount the root partition as rw:<!-- -->
<div><pre><span data-line-number="1"><span>/bin/mount</span><span> </span><span>-</span><span>o</span><span> </span><span>remount,rw,async</span><span> </span><span>/</span></span></pre></div>
</li>
<li>Add the <code>let_me_root</code> file:<!-- -->
<div><pre><span data-line-number="1"><span>echo</span><span> </span><span>let_me_root</span><span> </span><span>&gt;</span><span> </span><span>/root/let_me_root</span></span></pre></div>
</li>
<li>Remove the flash drive, reboot, and verify you still have console access.</li>
</ul>
</li>
<li>
<p>Next, we will finish getting SSH access by adding a public key to the authorized_keys file</p>
<ul>
<li>If you haven&#39;t already, generate an SSH key on the machine you want to connect from. I recommend generating an <code>ecdsa</code> key:<!-- -->
<div><pre><span data-line-number="1"><span>ssh-keygen</span><span> </span><span>-</span><span>t</span><span> </span><span>ed25519</span></span></pre></div>
</li>
<li>Make sure the root partition is mounted as rw, then run the following (substituting in your public key contents):<!-- -->
<div><pre><span data-line-number="1"><span>echo</span><span> </span><span>&#34;</span><span>&lt;contents of id_ed25519.pub&gt;</span><span>&#34;</span><span> </span><span>&gt;&gt;</span><span> </span><span>/root/.ssh/authorized_keys</span></span></pre></div>
</li>
<li>Test SSH access with <code>ssh root@$hub_ip -i &lt;path to id_ed25519&gt;</code>. You should be able to connect at this point.</li>
<li>If you are not connected, verify the contents of the <code>authorized_keys</code> file is formatted correctly (there should be two keys in the file).</li>
</ul>
</li>
</ol>
<p>Congratulations, you now have root access!</p>
<h2 id="creating-a-local-network-control-and-monitoring-server">Creating a Local Network Control and Monitoring Server</h2>
<p>By itself, root access is great but doesn&#39;t do much for us. We want to be able to replicate the controls provided by the app so we can control the bed over our local network instead.</p>
<p>The hub includes Python 2.7.18. While extremely old (keep in mind the Hub appears to have been last updated in 2018), it includes the <code>simpleHTTPServer</code> package, which will give us all the capability we need to remotely control and monitor the bed over the local network.</p>
<p>On your local machine, create a python file named <code>script_server.py</code>:</p>
<div><pre><span data-line-number="1"><span>import</span><span> </span><span>os</span></span>
<span data-line-number="2"><span>import</span><span> </span><span>subprocess</span></span>
<span data-line-number="3"><span>import</span><span> </span><span>BaseHTTPServer</span></span>
<span data-line-number="4"><span>from</span><span> </span><span>urlparse</span><span> </span><span>import</span><span> </span><span>urlparse</span><span>,</span><span> </span><span>parse_qs</span></span>
<span data-line-number="5"><span></span></span>
<span data-line-number="6"><span>SCRIPT_DIR</span><span> </span><span>=</span><span> </span><span>&#39;</span><span>/bam/scripts</span><span>&#39;</span></span>
<span data-line-number="7"><span></span></span>
<span data-line-number="8"><span>class</span><span> </span><span>MyHandler</span><span>(</span><span>BaseHTTPServer</span><span>.</span><span>BaseHTTPRequestHandler</span><span>)</span><span>:</span></span>
<span data-line-number="9"><span>    </span><span>def</span><span> </span><span>do_GET</span><span>(</span><span>self</span><span>)</span><span>:</span></span>
<span data-line-number="10"><span>        </span><span>parsed_path</span><span> </span><span>=</span><span> </span><span>urlparse</span><span>(</span><span>self</span><span>.</span><span>path</span><span>)</span></span>
<span data-line-number="11"><span>        </span><span>script_name</span><span> </span><span>=</span><span> </span><span>parsed_path</span><span>.</span><span>path</span><span>.</span><span>lstrip</span><span>(</span><span>&#39;</span><span>/</span><span>&#39;</span><span>)</span></span>
<span data-line-number="12"><span>        </span><span>script_path</span><span> </span><span>=</span><span> </span><span>os</span><span>.</span><span>path</span><span>.</span><span>join</span><span>(</span><span>SCRIPT_DIR</span><span>,</span><span> </span><span>script_name</span><span>)</span></span>
<span data-line-number="13"><span>        </span><span>if</span><span> </span><span>os</span><span>.</span><span>path</span><span>.</span><span>isfile</span><span>(</span><span>script_path</span><span>)</span><span>:</span></span>
<span data-line-number="14"><span>            </span><span>#</span><span> Gather all &#39;arg&#39; query parameters into a list</span></span>
<span data-line-number="15"><span>            </span><span>query_args</span><span> </span><span>=</span><span> </span><span>parse_qs</span><span>(</span><span>parsed_path</span><span>.</span><span>query</span><span>)</span></span>
<span data-line-number="16"><span>            </span><span>args</span><span> </span><span>=</span><span> </span><span>query_args</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>arg</span><span>&#39;</span><span>,</span><span> </span><span>[</span><span>]</span><span>)</span></span>
<span data-line-number="17"><span></span></span>
<span data-line-number="18"><span>            </span><span>#</span><span> Run the script with the arguments requested</span></span>
<span data-line-number="19"><span>            </span><span>output</span><span> </span><span>=</span><span> </span><span>subprocess</span><span>.</span><span>check_output</span><span>(</span><span>[</span><span>script_path</span><span>]</span><span> </span><span>+</span><span> </span><span>args</span><span>)</span></span>
<span data-line-number="20"><span>            </span><span>self</span><span>.</span><span>send_response</span><span>(</span><span>200</span><span>)</span></span>
<span data-line-number="21"><span>            </span><span>self</span><span>.</span><span>end_headers</span><span>(</span><span>)</span></span>
<span data-line-number="22"><span>            </span><span>self</span><span>.</span><span>wfile</span><span>.</span><span>write</span><span>(</span><span>output</span><span>)</span></span>
<span data-line-number="23"><span>        </span><span>else</span><span>:</span></span>
<span data-line-number="24"><span>            </span><span>self</span><span>.</span><span>send_response</span><span>(</span><span>404</span><span>)</span></span>
<span data-line-number="25"><span>            </span><span>self</span><span>.</span><span>end_headers</span><span>(</span><span>)</span></span>
<span data-line-number="26"><span>            </span><span>self</span><span>.</span><span>wfile</span><span>.</span><span>write</span><span>(</span><span>&#39;</span><span>Script not found</span><span>&#39;</span><span>)</span></span>
<span data-line-number="27"><span></span></span>
<span data-line-number="28"><span>def</span><span> </span><span>run</span><span>(</span><span>server_class</span><span>=</span><span>BaseHTTPServer</span><span>.</span><span>HTTPServer</span><span>,</span><span> </span><span>handler_class</span><span>=</span><span>MyHandler</span><span>)</span><span>:</span></span>
<span data-line-number="29"><span>    </span><span>server_address</span><span> </span><span>=</span><span> </span><span>(</span><span>&#39;</span><span>&#39;</span><span>,</span><span> </span><span>8000</span><span>)</span><span>  </span><span>#</span><span> Listen on all interfaces, port 8000</span></span>
<span data-line-number="30"><span>    </span><span>httpd</span><span> </span><span>=</span><span> </span><span>server_class</span><span>(</span><span>server_address</span><span>,</span><span> </span><span>handler_class</span><span>)</span></span>
<span data-line-number="31"><span>    </span><span>httpd</span><span>.</span><span>serve_forever</span><span>(</span><span>)</span></span>
<span data-line-number="32"><span></span></span>
<span data-line-number="33"><span>if</span><span> </span><span>__name__</span><span> </span><span>==</span><span> </span><span>&#34;</span><span>__main__</span><span>&#34;</span><span>:</span></span>
<span data-line-number="34"><span>    </span><span>run</span><span>(</span><span>)</span></span></pre></div>
<p>This script sets up an HTTP server that can run any of the scripts in <code>/bam/scripts</code>. You can provide arguments to the scripts with the query argument <code>arg</code> like so: <code>?arg=value1&amp;arg=value2...&amp;arg=valueN</code>. The result will be displayed in the browser.</p>
<p>Make sure you remounted the root partition as rw since the last reboot, then copy this script to the hub:</p>
<div><pre><span data-line-number="1"><span>scp</span><span> </span><span>-</span><span>O</span><span> </span><span>script_server.py</span><span> </span><span>root@</span><span>$</span><span>hub_ip</span><span>:~</span></span></pre></div>
<p>At this point, you can run the script and test it out, but it won&#39;t auto-start when you reboot the hub. One method of auto-starting the script would be to tack it onto one of the other startup scripts (initBAM seems like a good candidate). Another option is to add an <code>rc.d</code> script so it gets started by the OS. However, there is a snag—the <code>/etc</code> directory is copied from disk and stored in RAM on the system you log in to, so if we want to write to the disk where the original version lives, we will need to do a few extra steps.</p>
<h3 id="adding-rcd-scripts-to-the-realroot-partition-stored-on-disk-outside-the-chroot">Adding rc.d Scripts to the /real.root Partition Stored on Disk (Outside the chroot)</h3>
<p>The running OS instance is actually running inside a chroot that is set up by the bootloader <code>/init</code> script with many of the system files stored in a tmpfs partition so they can&#39;t be modified directly (past a reboot at least). However, we can mount the original partition and modify the files there, so they will be properly copied into place after we reboot.</p>
<p>First, create the following file on your local system named <code>script_server.sh</code>:</p>
<div><pre><span data-line-number="1"><span>#!</span><span>/bin/sh</span></span>
<span data-line-number="2"><span>#</span><span># BEGIN INIT INFO</span></span>
<span data-line-number="3"><span>#</span><span> Provides:          script_server</span></span>
<span data-line-number="4"><span>#</span><span> Required-Start:    $remote_fs $syslog</span></span>
<span data-line-number="5"><span>#</span><span> Required-Stop:     $remote_fs $syslog</span></span>
<span data-line-number="6"><span>#</span><span> Default-Start:     2 3 4 5</span></span>
<span data-line-number="7"><span>#</span><span> Default-Stop:      0 1 6</span></span>
<span data-line-number="8"><span>#</span><span> Short-Description: Start daemon at boot time</span></span>
<span data-line-number="9"><span>#</span><span> Description:       Enable service provided by daemon.</span></span>
<span data-line-number="10"><span>#</span><span># END INIT INFO</span></span>
<span data-line-number="11"><span></span></span>
<span data-line-number="12"><span>dir</span><span>=</span><span>&#34;</span><span>/root</span><span>&#34;</span></span>
<span data-line-number="13"><span>cmd</span><span>=</span><span>&#34;</span><span>python script_server.py</span><span>&#34;</span></span>
<span data-line-number="14"><span></span></span>
<span data-line-number="15"><span>name</span><span>=</span><span>s</span><span>c</span><span>r</span><span>i</span><span>p</span><span>t</span><span>_</span><span>s</span><span>e</span><span>r</span><span>v</span><span>e</span><span>r</span></span>
<span data-line-number="16"><span>pid_file</span><span>=</span><span>&#34;</span><span>/var/run/</span><span>$</span><span>name</span><span>.pid</span><span>&#34;</span></span>
<span data-line-number="17"><span>stdout_log</span><span>=</span><span>&#34;</span><span>/var/log/</span><span>$</span><span>name</span><span>.log</span><span>&#34;</span></span>
<span data-line-number="18"><span>stderr_log</span><span>=</span><span>&#34;</span><span>/var/log/</span><span>$</span><span>name</span><span>.err</span><span>&#34;</span></span>
<span data-line-number="19"><span></span></span>
<span data-line-number="20"><span>get_pid</span><span>(</span><span>)</span><span> </span><span>{</span></span>
<span data-line-number="21"><span>    </span><span>cat</span><span> </span><span>&#34;</span><span>$</span><span>pid_file</span><span>&#34;</span></span>
<span data-line-number="22"><span>}</span></span>
<span data-line-number="23"><span></span></span>
<span data-line-number="24"><span>is_running</span><span>(</span><span>)</span><span> </span><span>{</span></span>
<span data-line-number="25"><span>    </span><span>[</span><span> </span><span>-f</span><span> </span><span>&#34;</span><span>$</span><span>pid_file</span><span>&#34;</span><span> </span><span>]</span><span> </span><span>&amp;&amp;</span><span> </span><span>ps</span><span> </span><span>`</span><span>get_pid</span><span>`</span><span> </span><span>&gt;</span><span> </span><span>/dev/null</span><span> </span><span>2</span><span>&gt;&amp;1</span></span>
<span data-line-number="26"><span>}</span></span>
<span data-line-number="27"><span></span></span>
<span data-line-number="28"><span>case</span><span> </span><span>&#34;</span><span>$</span><span>1</span><span>&#34;</span><span> </span><span>in</span></span>
<span data-line-number="29"><span>    </span><span>s</span><span>t</span><span>a</span><span>r</span><span>t</span><span>)</span></span>
<span data-line-number="30"><span>    </span><span>if</span><span> </span><span>is_running</span><span>;</span><span> </span><span>then</span></span>
<span data-line-number="31"><span>        </span><span>echo</span><span> </span><span>&#34;</span><span>Already started</span><span>&#34;</span></span>
<span data-line-number="32"><span>    </span><span>else</span></span>
<span data-line-number="33"><span>        </span><span>echo</span><span> </span><span>&#34;</span><span>Starting </span><span>$</span><span>name</span><span>&#34;</span></span>
<span data-line-number="34"><span>        </span><span>cd</span><span> </span><span>&#34;</span><span>$</span><span>dir</span><span>&#34;</span></span>
<span data-line-number="35"><span>        </span><span>$</span><span>cmd</span><span> </span><span>&gt;&gt;</span><span> </span><span>&#34;</span><span>$</span><span>stdout_log</span><span>&#34;</span><span> </span><span>2</span><span>&gt;&gt;</span><span> </span><span>&#34;</span><span>$</span><span>stderr_log</span><span>&#34;</span><span> </span><span>&amp;</span></span>
<span data-line-number="36"><span>        </span><span>echo</span><span> </span><span>$</span><span>!</span><span> </span><span>&gt;</span><span> </span><span>&#34;</span><span>$</span><span>pid_file</span><span>&#34;</span></span>
<span data-line-number="37"><span>        </span><span>if</span><span> </span><span>!</span><span> </span><span>is_running</span><span>;</span><span> </span><span>then</span></span>
<span data-line-number="38"><span>            </span><span>echo</span><span> </span><span>&#34;</span><span>Unable to start, see </span><span>$</span><span>stdout_log</span><span> and </span><span>$</span><span>stderr_log</span><span>&#34;</span></span>
<span data-line-number="39"><span>            </span><span>exit</span><span> </span><span>1</span></span>
<span data-line-number="40"><span>        </span><span>fi</span></span>
<span data-line-number="41"><span>    </span><span>fi</span></span>
<span data-line-number="42"><span>    </span><span>;;</span></span>
<span data-line-number="43"><span>    </span><span>s</span><span>t</span><span>o</span><span>p</span><span>)</span></span>
<span data-line-number="44"><span>    </span><span>if</span><span> </span><span>is_running</span><span>;</span><span> </span><span>then</span></span>
<span data-line-number="45"><span>        </span><span>echo</span><span> </span><span>-</span><span>n</span><span> </span><span>&#34;</span><span>Stopping </span><span>$</span><span>name</span><span>..</span><span>&#34;</span></span>
<span data-line-number="46"><span>        </span><span>kill</span><span> </span><span>`get_pid`</span></span>
<span data-line-number="47"><span>        </span><span>for</span><span> </span><span>i</span><span> </span><span>in</span><span> </span><span>{1..10}</span></span>
<span data-line-number="48"><span>        </span><span>do</span></span>
<span data-line-number="49"><span>            </span><span>if</span><span> </span><span>!</span><span> </span><span>is_running</span><span>;</span><span> </span><span>then</span></span>
<span data-line-number="50"><span>                </span><span>break</span></span>
<span data-line-number="51"><span>            </span><span>fi</span></span>
<span data-line-number="52"><span></span></span>
<span data-line-number="53"><span>            </span><span>echo</span><span> </span><span>-</span><span>n</span><span> </span><span>&#34;</span><span>.</span><span>&#34;</span></span>
<span data-line-number="54"><span>            </span><span>sleep</span><span> </span><span>1</span></span>
<span data-line-number="55"><span>        </span><span>done</span></span>
<span data-line-number="56"><span>        </span><span>echo</span></span>
<span data-line-number="57"><span></span></span>
<span data-line-number="58"><span>        </span><span>if</span><span> </span><span>is_running</span><span>;</span><span> </span><span>then</span></span>
<span data-line-number="59"><span>            </span><span>echo</span><span> </span><span>&#34;</span><span>Not stopped; may still be shutting down or shutdown may have failed</span><span>&#34;</span></span>
<span data-line-number="60"><span>            </span><span>exit</span><span> </span><span>1</span></span>
<span data-line-number="61"><span>        </span><span>else</span></span>
<span data-line-number="62"><span>            </span><span>echo</span><span> </span><span>&#34;</span><span>Stopped</span><span>&#34;</span></span>
<span data-line-number="63"><span>            </span><span>if</span><span> </span><span>[</span><span> </span><span>-f</span><span> </span><span>&#34;</span><span>$</span><span>pid_file</span><span>&#34;</span><span> </span><span>]</span><span>;</span><span> </span><span>then</span></span>
<span data-line-number="64"><span>                </span><span>rm</span><span> </span><span>&#34;</span><span>$</span><span>pid_file</span><span>&#34;</span></span>
<span data-line-number="65"><span>            </span><span>fi</span></span>
<span data-line-number="66"><span>        </span><span>fi</span></span>
<span data-line-number="67"><span>    </span><span>else</span></span>
<span data-line-number="68"><span>        </span><span>echo</span><span> </span><span>&#34;</span><span>Not running</span><span>&#34;</span></span>
<span data-line-number="69"><span>    </span><span>fi</span></span>
<span data-line-number="70"><span>    </span><span>;;</span></span>
<span data-line-number="71"><span>    </span><span>r</span><span>e</span><span>s</span><span>t</span><span>a</span><span>r</span><span>t</span><span>)</span></span>
<span data-line-number="72"><span>    </span><span>$</span><span>0</span><span> </span><span>stop</span></span>
<span data-line-number="73"><span>    </span><span>if</span><span> </span><span>is_running</span><span>;</span><span> </span><span>then</span></span>
<span data-line-number="74"><span>        </span><span>echo</span><span> </span><span>&#34;</span><span>Unable to stop, will not attempt to start</span><span>&#34;</span></span>
<span data-line-number="75"><span>        </span><span>exit</span><span> </span><span>1</span></span>
<span data-line-number="76"><span>    </span><span>fi</span></span>
<span data-line-number="77"><span>    </span><span>$</span><span>0</span><span> </span><span>start</span></span>
<span data-line-number="78"><span>    </span><span>;;</span></span>
<span data-line-number="79"><span>    </span><span>s</span><span>t</span><span>a</span><span>t</span><span>u</span><span>s</span><span>)</span></span>
<span data-line-number="80"><span>    </span><span>if</span><span> </span><span>is_running</span><span>;</span><span> </span><span>then</span></span>
<span data-line-number="81"><span>        </span><span>echo</span><span> </span><span>&#34;</span><span>Running</span><span>&#34;</span></span>
<span data-line-number="82"><span>    </span><span>else</span></span>
<span data-line-number="83"><span>        </span><span>echo</span><span> </span><span>&#34;</span><span>Stopped</span><span>&#34;</span></span>
<span data-line-number="84"><span>        </span><span>exit</span><span> </span><span>1</span></span>
<span data-line-number="85"><span>    </span><span>fi</span></span>
<span data-line-number="86"><span>    </span><span>;;</span></span>
<span data-line-number="87"><span>    </span><span>*</span><span>)</span></span>
<span data-line-number="88"><span>    </span><span>echo</span><span> </span><span>&#34;</span><span>Usage: </span><span>$</span><span>0</span><span> {start|stop|restart|status}</span><span>&#34;</span></span>
<span data-line-number="89"><span>    </span><span>exit</span><span> </span><span>1</span></span>
<span data-line-number="90"><span>    </span><span>;;</span></span>
<span data-line-number="91"><span>esac</span></span>
<span data-line-number="92"><span></span></span>
<span data-line-number="93"><span>exit</span><span> </span><span>0</span></span></pre></div>
<p>Copy it to the hub the same as you did the python script previously.</p>
<p>Next, we will move it into place in the pre-init system. Run the following commands to get the disk mounted properly:</p>
<div><pre><span data-line-number="1"><span>mkdir</span><span> </span><span>tmp</span></span>
<span data-line-number="2"><span>ROOT_PART</span><span>=</span><span>/</span><span>d</span><span>e</span><span>v</span><span>/</span><span>m</span><span>m</span><span>c</span><span>b</span><span>l</span><span>k</span><span>0</span><span>p</span><span>1</span></span>
<span data-line-number="3"><span>/bin/mount</span><span> </span><span>-</span><span>a</span></span>
<span data-line-number="4"><span>/bin/mount</span><span> </span><span>-</span><span>o</span><span> </span><span>rw,noatime</span><span> </span><span>$</span><span>{</span><span>ROOT_PART</span><span>}</span><span> </span><span>tmp</span></span></pre></div>
<p>Now we will move the script to its proper home and add the necessary symlinks:</p>
<div><pre><span data-line-number="1"><span>mv</span><span> </span><span>script_server.sh</span><span> </span><span>tmp/etc/init.d</span></span>
<span data-line-number="2"><span>chmod</span><span> </span><span>+x</span><span> </span><span>tmp/etc/init.d/script_server.sh</span></span>
<span data-line-number="3"><span>ln</span><span> </span><span>-</span><span>s</span><span> </span><span>../init.d/script_server.sh</span><span> </span><span>tmp/etc/rc0.d/K99script_server.sh</span></span>
<span data-line-number="4"><span>ln</span><span> </span><span>-</span><span>s</span><span> </span><span>../init.d/script_server.sh</span><span> </span><span>tmp/etc/rc3.d/S99script_server.sh</span></span>
<span data-line-number="5"><span>ln</span><span> </span><span>-</span><span>s</span><span> </span><span>../init.d/script_server.sh</span><span> </span><span>tmp/etc/rc4.d/S99script_server.sh</span></span>
<span data-line-number="6"><span>ln</span><span> </span><span>-</span><span>s</span><span> </span><span>../init.d/script_server.sh</span><span> </span><span>tmp/etc/rc5.d/S99script_server.sh</span></span>
<span data-line-number="7"><span>ln</span><span> </span><span>-</span><span>s</span><span> </span><span>../init.d/script_server.sh</span><span> </span><span>tmp/etc/rc6.d/K99script_server.sh</span></span>
<span data-line-number="8"><span>reboot</span></span></pre></div>
<p>Once it finishes rebooting, try pointing your browser at <code>http://$hub_ip:8000/bamstat</code>. If everything is working correctly you should see some status information about the hub displayed in your browser window.</p>
<h3 id="useful-commands">Useful Commands</h3>
<p>The <code>/bio</code> script appears to be the primary control script for the bed. You can specify commands with the url <code>/bio?arg=XXXX</code>. Here are some useful ones for controlling the bed:</p>
<table><thead><tr><th>Command</th><th>Description</th></tr></thead><tbody><tr><td><code>arg=PSNL</code></td><td>Get the last set sleep number value for the left bed side</td></tr><tr><td><code>arg=PSNR</code></td><td>Get the last set sleep number value for the right bed side</td></tr><tr><td><code>arg=PSNl</code></td><td>Get the current sleep number value for the left bed side</td></tr><tr><td><code>arg=PSNr</code></td><td>Get the current sleep number value for the right bed side</td></tr><tr><td><code>arg=PSNX</code></td><td>Get the last set and current sleep number values for both bed sides</td></tr><tr><td><code>arg=PSNS&amp;arg=L100</code></td><td>Set the sleep number for the left bed side to 100 (L or R for side and 5..100 for value)</td></tr><tr><td><code>arg=SPAU</code></td><td>Get the bed privacy setting</td></tr><tr><td><code>arg=SPAU&amp;arg=on</code></td><td>Set the bed privacy setting (<code>off</code> to disable)</td></tr><tr><td><code>arg=LBPL</code></td><td>Get the presence value for the left side</td></tr><tr><td><code>arg=LBPR</code></td><td>Get the presence value for the right side</td></tr><tr><td><code>arg=LBPX</code></td><td>Get the presence value for both sides</td></tr><tr><td><code>arg=LRSG</code></td><td>Get the responsive air setting for both sides</td></tr><tr><td><code>arg=LRLE&amp;arg=on</code></td><td>Set the responsive air setting for the left side to on</td></tr><tr><td><code>arg=LRRE&amp;arg=off</code></td><td>Set the responsive air setting for the right side to off</td></tr><tr><td><code>arg=MFST</code></td><td>Get the head and foot position for both sides</td></tr><tr><td><code>arg=MFUL&amp;arg=100&amp;arg=0</code></td><td>Set the head position for the left side (0..100 for the position. The second argument is speed, 0=fast, 1=slow)</td></tr><tr><td><code>arg=MFUR&amp;arg=100&amp;arg=0</code></td><td>Set the head position for the right side</td></tr><tr><td><code>arg=MFFL&amp;arg=100&amp;arg=0</code></td><td>Set the foot position for the left side</td></tr><tr><td><code>arg=MFFR&amp;arg=100&amp;arg=0</code></td><td>Set the foot position for the right side</td></tr><tr><td><code>arg=MFO3</code></td><td>Get the right underbed light status (if you have a bed with other outlets or lights, MFO1..4 all work)</td></tr><tr><td><code>arg=MFSO&amp;arg=IBT</code><sup><a href="#user-content-fn-3" id="user-content-fnref-3" data-footnote-ref="true" aria-describedby="footnote-label">3</a></sup></td><td>Set the outlet values, I=index&lt;1=R, 2=L, 3=R-under, 4=L-under, 5=Both, 6=Both-under, 7=All, 8=All-R, 9=All-L&gt;; B=brightness&lt;0=off, 1=on/bright, 2=dim, 3=moderate&gt; T=timer&lt;0-180&gt;. Timer is optional</td></tr><tr><td><code>arg=MUAS&amp;arg=on</code></td><td>Enable or disable the auto setting for the underbed light (<code>off</code> to disable)</td></tr><tr><td><code>arg=FWGL</code></td><td>Get the footwarming level and timer for the left side</td></tr><tr><td><code>arg=FWGR</code></td><td>Get the footwarming level and timer for the right side</td></tr><tr><td><code>arg=FWSL&amp;arg=100&amp;arg=360</code></td><td>Set the footwarming level and timer for the left side (level is 0..100 and timer is 0..360)</td></tr><tr><td><code>arg=FWSR&amp;arg=100&amp;arg=360</code></td><td>Set the footwarming level and timer for the right side</td></tr><tr><td><code>arg=SBAS</code></td><td>Baseline the bed</td></tr></tbody></table>
<p>There are many other controls in the <code>bio</code> script, such as getters and setters for foundation presets, snore configuration, DualTemp controls, and status information (watch out for the more destructive commands such as <code>factory reset</code> or the radio controls). You can explore the script to find all the available commands: if you point your browser at <code>/bio?arg=help</code>, you will see a list of the commands you can run. If you add a command as a second argument to the <code>help</code> call, it will provide detailed information for that command.</p>
<h2 id="next-steps">Next Steps</h2>
<p>There are a few things to explore in the OS now that you have access:</p>
<ul>
<li>
<p>The bed control functionality is all in the <code>/bam</code> root directory. You can explore the various scripts contained there and learn how the hub operates.</p>
</li>
<li>
<p>I spent some time exploring the system to find a backdoor that doesn&#39;t require UART access but it appears (fortunately) that the developers covered their tracks pretty well and shut down all the obvious access channels I could think of. If anybody finds something I might have missed, I would love to hear about it.</p>
</li>
<li>
<p>The hub communicates with the Sleep Number servers by opening an SSH tunnel and providing a reverse tunnel back to the hub that their developers can use to connect to the hub and do maintenance when needed. The idea that unknown users can directly connect to my internal home network is a scary thought, so I will probably be disconnecting the hub from the external internet once I am satisfied with my internal network control script. It also makes me wonder how many other internet-connected appliances include a similar backdoor into the home network like this one has.</p>
</li>
<li>
<p>It might be fun to write a simple progressive web app to control the bed settings that can directly replace the SleepIQ app.</p>
</li>
</ul>
<p>If anybody has any feedback, please reach out! I would love to hear from you.</p>
<h2 id="appendix-original-u-boot-env-variables-on-my-hub">Appendix: Original U-Boot Env Variables on My Hub</h2>
<div><pre><span data-line-number="1"><span>baudrate</span><span>=</span><span>1</span><span>1</span><span>5</span><span>2</span><span>0</span><span>0</span></span>
<span data-line-number="2"><span>bootcmd</span><span>=</span><span>r</span><span>u</span><span>n</span><span> </span><span>find_board_name</span><span>;</span><span> </span><span>run</span><span> </span><span>set_bootargs</span><span>;</span><span>setenv</span><span> </span><span>boot_mmcdev</span><span> </span><span>0</span><span>;</span><span> </span><span>run</span><span> </span><span>bootcmd_mmc</span><span>;</span><span>setenv</span><span> </span><span>boot_mmcdev</span><span> </span><span>1</span><span>;</span><span> </span><span>run</span><span> </span><span>bootcmd_mmc</span></span>
<span data-line-number="3"><span>bootcmd_mmc</span><span>=</span><span>m</span><span>m</span><span>c</span><span> </span><span>dev</span><span> </span><span>$</span><span>{</span><span>boot_mmcdev</span><span>}</span><span>;</span><span> </span><span>mmc</span><span> </span><span>read</span><span> </span><span>$</span><span>{</span><span>loadaddr</span><span>}</span><span> </span><span>0x800</span><span> </span><span>$</span><span>{</span><span>initrd_size</span><span>}</span><span>;</span><span>bootm</span><span> </span><span>$</span><span>{</span><span>loadaddr</span><span>}</span><span>#</span><span>$</span><span>{</span><span>board_name</span><span>}</span></span>
<span data-line-number="4"><span>bootdelay</span><span>=</span><span>2</span></span>
<span data-line-number="5"><span>bootm_size</span><span>=</span><span>0</span><span>x</span><span>1</span><span>0</span><span>0</span><span>0</span><span>0</span><span>0</span><span>0</span><span>0</span></span>
<span data-line-number="6"><span>fdtcontroladdr</span><span>=</span><span>b</span><span>f</span><span>c</span><span>8</span><span>3</span><span>1</span><span>f</span><span>0</span></span>
<span data-line-number="7"><span>find_board_name</span><span>=</span><span>i</span><span>f</span><span> </span><span>gpio</span><span> </span><span>input</span><span> </span><span>102</span><span>;</span><span> </span><span>then</span><span> </span><span>if</span><span> </span><span>gpio</span><span> </span><span>input</span><span> </span><span>98</span><span>;</span><span> </span><span>then</span><span> </span><span>setenv</span><span> </span><span>board_name</span><span> </span><span>siq-360</span><span>;</span><span>else</span><span> setenv board_name siq-selc</span><span>;</span><span>fi</span><span>;</span><span> </span><span>else</span><span> </span><span>setenv</span><span> </span><span>board_name</span><span> </span><span>siq-se</span><span>;</span><span>fi</span></span>
<span data-line-number="8"><span>initrd_size</span><span>=</span><span>0</span><span>x</span><span>7</span><span>0</span><span>0</span><span>0</span></span>
<span data-line-number="9"><span>linux_mmcdev</span><span>=</span><span>0</span></span>
<span data-line-number="10"><span>loadaddr</span><span>=</span><span>0</span><span>x</span><span>8</span><span>2</span><span>0</span><span>0</span><span>0</span><span>0</span><span>0</span><span>0</span></span>
<span data-line-number="11"><span>set_bootargs</span><span>=</span><span>s</span><span>e</span><span>t</span><span>e</span><span>n</span><span>v</span><span> </span><span>bootargs</span><span> </span><span>console=ttymxc0,115200</span><span> </span><span>root=/dev/mmcblk</span><span>$</span><span>{</span><span>linux_mmcdev</span><span>}</span><span>p1</span><span> </span><span>rootwait</span></span>
<span data-line-number="12"><span>stderr</span><span>=</span><span>s</span><span>e</span><span>r</span><span>i</span><span>a</span><span>l</span></span>
<span data-line-number="13"><span>stdin</span><span>=</span><span>s</span><span>e</span><span>r</span><span>i</span><span>a</span><span>l</span></span>
<span data-line-number="14"><span>stdout</span><span>=</span><span>s</span><span>e</span><span>r</span><span>i</span><span>a</span><span>l</span></span></pre></div>
<section data-footnotes="true"><h2 id="footnote-label">Footnotes</h2>
<ol>
<li id="user-content-fn-1">
<p>Setting this up is left as an exercise for the reader <a href="#user-content-fnref-1" data-footnote-backref="true" aria-label="Back to content">↩</a></p>
</li>
<li id="user-content-fn-2">
<p>This encrypted file is a key-hole the developers put in place to grant both console and SSH access to the hub. If the original encrypted file were to be obtained or reverse-engineered, most of this process would not be necessary. <a href="#user-content-fnref-2" data-footnote-backref="true" aria-label="Back to content">↩</a></p>
</li>
<li id="user-content-fn-3">
<p>On my version of the <code>bio</code> script, the <code>MFSO</code> lines were in the wrong order in the <code>LIST</code> and couldn&#39;t be called. I had to move them up a couple rows to get them to work. <a href="#user-content-fnref-3" data-footnote-backref="true" aria-label="Back to content">↩</a></p>
</li>
</ol>
</section></div></div>
  </body>
</html>
