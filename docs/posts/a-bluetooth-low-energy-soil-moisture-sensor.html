<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/rbaron/b-parasite">Original</a>
    <h1>A Bluetooth Low Energy  soil moisture sensor</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><p dir="auto"><a href="https://github.com/rbaron/b-parasite/actions/workflows/b-parasite.yml"><img src="https://github.com/rbaron/b-parasite/actions/workflows/b-parasite.yml/badge.svg?branch=main" alt="b-parasite firmware build"/></a></p>

<p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://github.com/rbaron/b-parasite/blob/main/img/resized/img1.jpg"><img src="https://github.com/rbaron/b-parasite/raw/main/img/resized/img1.jpg" width="512px" alt="PCB front and back photo"/></a>
</p>
<p dir="auto">b-parasite is an open source Bluetooth Low Energy (BLE) soil moisture and ambient temperature/humidity/light sensor.</p>

<ul dir="auto">
<li>Soil moisture sensor. I wrote about how capacitive soil moisture sensors works on <a href="https://twitter.com/rbaron_/status/1367182806368071685" rel="nofollow">this Twitter thread</a>, based on <a href="https://wemakethings.net/2012/09/26/capacitance_measurement/" rel="nofollow">this great post</a> on wemakethings.net</li>
<li>Air temperature and humidity sensor using a <a href="https://www.sensirion.com/en/environmental-sensors/humidity-sensors/digital-humidity-sensor-shtc3-our-new-standard-for-consumer-electronics/" rel="nofollow">Sensirion&#39;s SHTC3</a></li>
<li>Light sensor using an <a href="https://everlighteurope.com/ambient-light-sensors/7/ALSPT19315CL177TR8.html" rel="nofollow">ALS-PT19</a> phototransistor</li>
<li>Powered by a common CR2032 coin cell, with a battery life of possibly over a year - see &#34;Battery Life&#34; below</li>
<li>Open hardware and open source design</li>
</ul>

<ul dir="auto">
<li><a href="https://github.com/rbaron/b-parasite/wiki/Hardware-Versions">Hardware Versions</a></li>
<li><a href="https://github.com/rbaron/b-parasite/wiki/How-to-order:-PCB-fabrication-and-SMT-assembly">How to order: PCB fabrication and SMT assembly</a></li>
<li><a href="https://github.com/rbaron/b-parasite/wiki/How-to-Program">How to Program</a></li>
</ul>

<ul dir="auto">
<li><a href="https://github.com/rbaron/b-parasite/blob/main/code/b-parasite">code/b-parasite/</a> - firmware code based on the <a href="https://infocenter.nordicsemi.com/index.jsp?topic=%2Fstruct_sdk%2Fstruct%2Fsdk_nrf5_latest.html&amp;cp=7_1" rel="nofollow">nRF5 SDK</a></li>
<li><a href="https://github.com/rbaron/b-parasite/blob/main/kicad">kicad/</a> - KiCad schematic, layout and fabrication files for the printed circuit board (PCB)</li>
<li><a href="https://github.com/rbaron/b-parasite/blob/main/data">data/</a> - data for testing and sensor calibration</li>
<li><a href="https://github.com/rbaron/b-parasite/blob/main/bridge">bridge/</a> - an <a href="https://github.com/esphome/esphome">ESPHome</a>-based BLE-MQTT bridge</li>
<li><a href="https://github.com/rbaron/b-parasite/blob/main/case">case/</a> - a 3D printable case</li>
</ul>

<p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://github.com/rbaron/b-parasite/blob/main/img/excalidraw/diagram.png"><img src="https://github.com/rbaron/b-parasite/raw/main/img/excalidraw/diagram.png" alt="Diagram containing two b-parasites, a bridge &amp; an MQTT broker"/></a>
</p>
<p dir="auto">b-parasite works by periodically measuring the soil moisture, air temperature/humidity and broadcasting those values via Bluetooth Low Energy (BLE) advertisement packets. After doing so, the board goes into a sleep mode until it&#39;s time for another measurement. The sleep interval is configurable - I often use 10 minutes between readings, which is a good compromise between fresh data and saving battery.</p>
<p dir="auto">At this point, b-parasite&#39;s job is done. We have many possibilities of how to capture its BLE advertisement packet and what to do with the data. A common pattern is having a BLE-MQTT bridge that listens for these BLE broadcasts, decodes them and ships the sensor values through MQTT messages. The MQTT broker is then responsible for relaying the sensor data to interested parties. This is the topology shown in the diagram above.</p>
<h2 dir="auto"><a id="user-content-integrations" aria-hidden="true" href="#integrations"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Integrations</h2>
<h3 dir="auto"><a id="user-content-esphome" aria-hidden="true" href="#esphome"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>ESPHome</h3>
<p dir="auto">A popular choice for a BLE-MQTT bridge is the <a href="https://github.com/esphome/esphome">ESPHome</a> project, which runs on our beloved <a href="https://www.espressif.com/en/products/socs/esp32" rel="nofollow">ESP32</a> boards. b-parasite is officially supported and documentation for using it can be found in <a href="https://esphome.io/components/sensor/b_parasite.html" rel="nofollow">the b-parasite ESPHome docs</a>. An example of using this platform is also available in this repo, under <a href="https://github.com/rbaron/b-parasite/blob/main/bridge">bridge/</a> (check out <a href="https://github.com/rbaron/b-parasite/blob/main/bridge/README.md">README.md</a> there for more info).</p>
<p dir="auto">ESPHome is a battle-tested project with a vibrant community, and is currently the most mature b-parasite bridge. ESP32 are also cheap, so you can sprinkle a few of them around the house to cover a wide range, and even share the same ESP32 with other sensors.</p>
<h3 dir="auto"><a id="user-content-home-assistant" aria-hidden="true" href="#home-assistant"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Home Assistant</h3>
<p dir="auto">b-parasite is supported by the <a href="https://github.com/custom-components/ble_monitor">ble_monitor</a> Home Assistant custom component - please refer to the <a href="https://custom-components.github.io/ble_monitor/by_brand#rbaron" rel="nofollow">docs</a>. This custom component gets Home Assistant to automatically discover nearby b-parasites based on their advertisement data.</p>
<h3 dir="auto"><a id="user-content-linuxraspberry-pi--macos" aria-hidden="true" href="#linuxraspberry-pi--macos"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Linux/Raspberry Pi &amp; macOS</h3>
<p dir="auto">Another possibility is running <a href="https://github.com/rbaron/parasite-scanner">parasite-scanner</a>. It is a purpose-built bridge for b-parasites, and runs on Linux and macOS.</p>
<p dir="auto">This is the quickest way to collect and visualize data from b-parasites, and I personally use it a lot for testing and debugging.</p>
<h2 dir="auto"><a id="user-content-protocol-and-data-encoding" aria-hidden="true" href="#protocol-and-data-encoding"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Protocol and Data Encoding</h2>
<p dir="auto">Sensor data is transmitted via BLE advertisement broadcasts. <a href="https://github.com/rbaron/b-parasite/blob/main/code/b-parasite/README.md">Here</a> you can find a byte-by-byte description of the data as it is encoded inside the advertisement packet.</p>

<p dir="auto"><strong>tl;dr:</strong> By taking readings 10 minutes apart, the battery should last for over a couple of years.</p>
<p dir="auto">The main parameters involved in estimating the battery life are:</p>
<ul dir="auto">
<li>Current consumption (both in operation and during sleep)</li>
<li>Duty cycle (how much time it spends in operation vs. sleeping)</li>
<li>Battery capacity - this is roughly 200 mAh for CR2032 cells</li>
</ul>
<p dir="auto">Details and power comsumption measurements in the #48. <a href="https://docs.google.com/spreadsheets/d/157JQiX20bGkTrlbvWbWRrs_WViL3MgVZffSCWRR7uAI/edit#gid=0" rel="nofollow">This spreadsheet</a> can be used to estimate battery life for different parameters.</p>
<p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://github.com/rbaron/b-parasite/blob/main/img/resized/img2.jpg"><img src="https://github.com/rbaron/b-parasite/raw/main/img/resized/img2.jpg" alt="b-parasite stuck into a small plant vase"/></a>
</p>

<p dir="auto">A 3D printable case model can be found in <a href="https://github.com/rbaron/b-parasite/blob/main/case">case/</a>.
<a target="_blank" rel="noopener noreferrer" href="https://github.com/rbaron/b-parasite/blob/main/img/case/screenshot.png"><img src="https://github.com/rbaron/b-parasite/raw/main/img/case/screenshot.png" alt="Render of the 3D printable case"/></a></p>

<p dir="auto">The hardware and associated design files are released under the <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="nofollow">Creative Commons CC BY-SA 4.0 license</a>.
The code is released under the <a href="https://opensource.org/licenses/MIT" rel="nofollow">MIT license</a>.</p>
</article>
          </div></div>
  </body>
</html>
