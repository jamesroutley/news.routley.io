<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.blog/2023-10-09-coordinated-disclosure-1-click-rce-on-gnome-cve-2023-43641/">Original</a>
    <h1>Coordinated Disclosure: 1-Click RCE on Gnome (CVE-2023-43641)</h1>
    
    <div id="readability-page-1" class="page"><div>
  <div>
    


<main role="main" id="post-74613">
  
<p>Today, in coordination with <a href="https://github.com/lipnitsk">Ilya Lipnitskiy</a> (the maintainer of libcue) and the <a href="https://oss-security.openwall.org/wiki/mailing-lists/distros">distros mailing list</a>, the GitHub Security Lab is disclosing <a href="https://github.com/lipnitsk/libcue/security/advisories/GHSA-5982-x7hv-r9cj">CVE-2023-43641</a>, a memory corruption vulnerability in <a href="https://github.com/lipnitsk/libcue">libcue</a>. We have also sent a text-only version of this blog post to the <a href="https://oss-security.openwall.org/wiki/mailing-lists/oss-security">oss-security list</a>.</p>
<p>It’s quite likely that you have never heard of libcue before, and are wondering why it’s important. This situation is neatly illustrated by <a href="https://xkcd.com/2347/">xkcd 2347</a>:</p>
<p><a href="https://xkcd.com/2347/"><img decoding="async" fetchpriority="high" src="https://i0.wp.com/imgs.xkcd.com/comics/dependency.png?resize=385%2C489&amp;ssl=1" width="385" height="489" loading="lazy" data-recalc-dims="1"/></a></p>
<p>libcue is a library used for parsing <a href="https://en.wikipedia.org/wiki/Cue_sheet_%28computing%29">cue sheets</a>—a metadata format for describing the layout of the tracks on a CD. Cue sheets are often used in combination with the <a href="https://en.wikipedia.org/wiki/FLAC">FLAC</a> audio file format, which means that libcue is a dependency of some audio players, such as <a href="https://audacious-media-player.org/">Audacious</a>. But the reason why I decided to audit libcue for security vulnerabilities is that it’s used by <a href="https://gitlab.gnome.org/GNOME/tracker-miners">tracker-miners</a>: an application that’s included with <a href="https://www.gnome.org/">GNOME</a>—the default graphical desktop environment of many open source operating systems.<sup id="fnref-74613-1"><a href="#fn-74613-1" title="Read footnote.">1</a></sup> The purpose of tracker-miners is to index the files in your home directory to make them easily searchable. For example, the index is used by this search bar:</p>
<p><img decoding="async" src="https://github.blog/wp-content/uploads/2023/10/rickastley.png?w=1024&amp;resize=1024%2C576" alt="" width="1024" height="576" srcset="https://github.blog/wp-content/uploads/2023/10/rickastley.png?w=1600 1600w, https://github.blog/wp-content/uploads/2023/10/rickastley.png?w=300 300w, https://github.blog/wp-content/uploads/2023/10/rickastley.png?w=768 768w, https://github.blog/wp-content/uploads/2023/10/rickastley.png?w=1024&amp;resize=1024%2C576 1024w, https://github.blog/wp-content/uploads/2023/10/rickastley.png?w=1536 1536w" sizes="(max-width: 1000px) 100vw, 1000px" loading="lazy" data-recalc-dims="1"/></p>
<p>The index is automatically updated when you add or modify a file in certain subdirectories of your home directory, in particular including <code>~/Downloads</code>. To make a long story short, that means that inadvertently clicking a malicious link is all it takes for an attacker to exploit CVE-2023-43641 and get code execution on your computer:</p>

<p>The video shows me clicking a link in a webpage<sup id="fnref-74613-2"><a href="#fn-74613-2" title="Read footnote.">2</a></sup>, which causes a cue sheet to be downloaded. Because the file is saved to <code>~/Downloads</code>, it is then automatically scanned by tracker-miners. And because it has a <code>.cue</code> filename extension, tracker-miners uses libcue to parse the file. The file exploits the vulnerability in libcue to gain code execution and pop a calculator. Cue sheets are just one of <a href="https://gitlab.gnome.org/GNOME/tracker-miners/-/tree/83054c8c145f12c83289e6c424f55b87a5b609d9/src/tracker-extract">many</a> file formats supported by tracker-miners. For example, it also includes scanners for <a href="https://gitlab.gnome.org/GNOME/tracker-miners/-/blob/83054c8c145f12c83289e6c424f55b87a5b609d9/src/tracker-extract/tracker-extract-html.c">HTML</a>, <a href="https://gitlab.gnome.org/GNOME/tracker-miners/-/blob/83054c8c145f12c83289e6c424f55b87a5b609d9/src/tracker-extract/tracker-extract-jpeg.c">JPEG</a>, and <a href="https://gitlab.gnome.org/GNOME/tracker-miners/-/blob/83054c8c145f12c83289e6c424f55b87a5b609d9/src/tracker-extract/tracker-extract-pdf.c">PDF</a>.</p>
<p>I am delaying publication of the proof of concept (PoC) used in the video, to give users time to install the patch. But if you’d like to test if your system is vulnerable, try downloading <a href="https://github.com/github/securitylab/blob/3cb0ebc37170149ef5e91a3bd641631c4eeedd06/SecurityExploits/libcue/track_set_index_CVE-2023-43641/CVE-2023-43641-poc-simple.cue">this file</a>, which contains a much simpler version of the PoC that merely causes a (benign) crash.</p>
<p>The offsets in the full PoC need to be tuned for different distributions. I have <em>only</em> done this for Ubuntu 23.04 and Fedora 38, the most recent releases of <a href="https://ubuntu.com/">Ubuntu</a> and <a href="https://fedoraproject.org/">Fedora</a> at this time. In my testing, I have found that the PoC works very reliably when run on the correct distribution (and will trigger a SIGSEGV when run on the wrong distribution). I have not created PoCs for any other distributions, but I believe that all distributions that run GNOME are potentially exploitable.</p>
<h2 id="the-bug-in-libcue">The bug in libcue<a href="#the-bug-in-libcue" aria-label="The bug in libcue"></a></h2>
<p>libcue is quite a small project. It’s primarily a <a href="https://www.gnu.org/software/bison">bison</a> grammar for cue sheets, with a few data structures for storing the parsed data. A simple example of a cue sheet looks like this:</p>
<pre><code>REM GENRE &#34;Pop, dance pop&#34;
REM DATE 1987
PERFORMER &#34;Rick Astley&#34;
TITLE &#34;Whenever You Need Somebody&#34;
FILE &#34;Whenever You Need Somebody.mp3&#34; MP3
  TRACK 01 AUDIO
    TITLE &#34;Never Gonna Give You Up&#34;
    PERFORMER &#34;Rick Astley&#34;
    SONGWRITER &#34;Mike Stock, Matt Aitken, Pete Waterman&#34;
    INDEX 01 00:00:00
  TRACK 02 AUDIO
    TITLE &#34;Whenever You Need Somebody&#34;
    PERFORMER &#34;Rick Astley&#34;
    SONGWRITER &#34;Mike Stock, Matt Aitken, Pete Waterman&#34;
    INDEX 01 03:35:00
</code></pre>
<p>The vulnerability is in the handling of the <code>INDEX</code> syntax. Replacing one of those <code>INDEX</code> statements with this will trigger the bug:</p>
<pre><code>INDEX 4294567296 0
</code></pre>
<p>There are two parts to the problem. The first is that the scanner (<a href="https://github.com/lipnitsk/libcue/blob/1b0f3917b8f908c81bb646ce42f29cf7c86443a1/cue_scanner.l#L132">cue_scanner.l, line 132</a>) uses <code><a href="https://manpages.ubuntu.com/manpages/jammy/en/man3/atoi.3.html">atoi</a></code> to scan the integers:</p>
<pre><code>[[:digit:]]+    { yylval.ival = atoi(yytext); return NUMBER; }
</code></pre>
<p><code>atoi</code> does not check for integer overflow, so it is easy to construct a negative index. For example, 4294567296 is converted to -400000 by <code>atoi</code>.</p>
<p>The second part of the problem (and this is the actual vulnerability) is that <code><a href="https://github.com/lipnitsk/libcue/blob/1b0f3917b8f908c81bb646ce42f29cf7c86443a1/cd.c#L340-L348">track_set_index</a></code> does not check that <code>i ≥ 0</code>:</p>
<pre><code>void track_set_index(Track *track, int i, long ind)
{
    if (i &gt; MAXINDEX) {
        fprintf(stderr, &#34;too many indexes\n&#34;);
                return;
    }

    track-&gt;index[i] = ind;
}
</code></pre>
<p>If <code>i</code> is negative, then this code can write to an address outside the bounds of the array. Since the value of <code>ind</code> is also attacker-controlled, this is a very powerful vulnerability.</p>
<p>The bug is simple to fix by adding an extra condition to the if-statement in <code>track_set_index</code>. This is the proposed patch:</p>
<pre><code>diff --git a/cd.c b/cd.c
index cf77a18..4bbea19 100644
--- a/cd.c
+++ b/cd.c
@@ -339,7 +339,7 @@ track_get_rem(const Track* track)

 void track_set_index(Track *track, int i, long ind)
 {
-       if (i &gt; MAXINDEX) {
+       if (i &lt; 0 || i &gt; MAXINDEX) {
                fprintf(stderr, &#34;too many indexes\n&#34;);
                return;
        }
</code></pre>
<h2 id="more-about-tracker-miners">More about tracker-miners<a href="#more-about-tracker-miners" aria-label="More about tracker-miners"></a></h2>
<p>I want to be clear that this bug is <em>not</em> a vulnerability in tracker-miners. But I have focused on tracker-miners because it magnifies the impact of this bug due to the way that it automatically scans the files in your <code>~/Downloads</code> directory.</p>
<p>tracker-miners consists of two processes:</p>
<ol>
<li>tracker-miner-fs</li>
<li>tracker-extract</li>
</ol>
<p>The first, tracker-miner-fs, is a background process which is always running, whereas the second, tracker-extract, is only started on demand to scan new files. tracker-miner-fs uses <a href="https://manpages.ubuntu.com/manpages/jammy/en/man7/inotify.7.html">inotify</a> to monitor specific directories, such as <code>~/Downloads</code>, <code>~/Music</code>, and <code>~/Videos</code>. When a new file is created, it launches tracker-extract to scan the file. tracker-extract sends the results back to tracker-miner-fs (which maintains the index) and then usually shuts down again after a few seconds. The vulnerability only affects tracker-extract, because that’s where libcue is used. Both processes run as the current user, so this vulnerability would need to be chained with a separate privilege escalation vulnerability for an attacker to gain admin privileges.</p>
<p>The vulnerability will not trigger if tracker-miners is not running. To check if it is, I use the command <code>ps aux | grep track</code>. It usually shows that tracker-miner-fs is running and that tracker-extract isn’t. If <em>neither</em> is running (which I think is rare), then using the search bar (press the “super” key and type something) should automatically restart tracker-miner-fs. As far as I know, tracker-miners is quite tightly integrated into GNOME, so there’s no easy way to switch it off. There’s certainly nothing like a simple checkbox in the settings dialog. There’s some discussion <a href="https://askubuntu.com/a/1187273">here</a> about how to switch it off by modifying your systemd configuration.</p>
<p>The two-process architecture of tracker-miners is helpful for exploitation. Firstly, it’s much easier to predict the memory layout in a freshly started process than in one that’s already been running for hours, so the fact that tracker-extract is only started on-demand is very convenient. Even better, tracker-extract always creates a fresh thread to scan the downloaded file, and I’ve found that the heap layout in the thread’s malloc arena is <em>very</em> consistent: it varies between distributions, so, for example, Ubuntu 23.04 has a slightly different layout than Fedora 38, but on the same distribution the layout is identical every single time. Secondly, because tracker-extract is restarted on demand, an attacker could potentially crash it many times until their exploit succeeds. Due to the consistency of the heap layout, I’ve found that my exploit works very reliably without needing to use this, but I could imagine an attacker loading a zip file with thousands of copies of their exploit to increase their chance of success when the victim unzips the download.</p>
<h3 id="tracker-miners-seccomp-sandbox-escape">tracker-miners seccomp sandbox escape<a href="#tracker-miners-seccomp-sandbox-escape" aria-label="tracker-miners seccomp sandbox escape"></a></h3>
<p>The difficult part of exploiting this vulnerability was finding a way to bypass <a href="https://en.wikipedia.org/wiki/Address_space_layout_randomization">ASLR</a>. But what I <em>didn’t</em> realize when I started writing the PoC, is that tracker-extract also has a <a href="https://gitlab.gnome.org/GNOME/tracker-miners/-/blob/83054c8c145f12c83289e6c424f55b87a5b609d9/src/libtracker-miners-common/tracker-seccomp.c">seccomp sandbox</a> which is intended to prevent this kind of exploit from working. It was a nasty surprise when I thought I had all the pieces in place for a working PoC and it failed with the error message: <code>Disallowed syscall &#34;close_range&#34; caught in sandbox</code>. But I still failed to understand that I was attempting a sandbox escape here. I just thought I needed to take a different code path that didn’t use the <code>close_range</code> function. So I tried a different route, it worked, and I didn’t give it any more thought until the GNOME developers asked how I’d managed to escape the sandbox. It turned out that I’d discovered the escape entirely by accident: while I was working on the new route, I unwittingly made a change to the PoC that solved it. I have since discovered that I could have got the original PoC working with a one-line change. I’ll go into more detail on this in a follow-up blog post when I publish the PoC, but for now I’ll just mention that, in response to this, <a href="https://gitlab.gnome.org/carlosg">Carlos Garnacho</a> has very quickly implemented <a href="https://gitlab.gnome.org/GNOME/tracker-miners/-/commit/f0c880a0ec0e650dbdc037c59e58e07442f82fef">some changes</a> to strengthen the sandbox, which will prevent this exploitation path from working in the future.</p>
<h2 id="conclusion">Conclusion<a href="#conclusion" aria-label="Conclusion"></a></h2>
<p>Sometimes a vulnerability in a seemingly innocuous library can have a large impact. Due to the way that it’s used by tracker-miners, this vulnerability in libcue became a 1-click RCE. If you use GNOME, please update today!</p>
<p>I’m delaying the release of the full PoC to give users time to install the update, but planning to publish a follow-up blog post soon with details of how the full PoC works. Save an unpatched VM with Ubuntu 23.04 or Fedora 38 if you’d like to test the full PoC when I release it.</p>

<h4 id="notes">Notes<a href="#notes" aria-label="Notes"></a></h4>


      
  </main>


  </div>
</div><div data-color-mode="dark" data-light-theme="light" data-dark-theme="dark">
  <section id="newsletter">
  <div>
    <div>
      <div>
        <div>
          <h2> Subscribe to The GitHub Insider</h2>
          <p>Discover tips, technical guides, and best practices in our monthly newsletter for developers.</p>
        </div>
        
      </div>
    </div>
  </div>
</section>
	
</div></div>
  </body>
</html>
