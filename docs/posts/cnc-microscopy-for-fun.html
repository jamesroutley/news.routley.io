<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.anfractuosity.com/projects/cnc-microscopy/">Original</a>
    <h1>Show HN: CNC Microscopy for Fun</h1>
    
    <div id="readability-page-1" class="page"><article>
                        




<p>I wanted to build a CNC microscope using off the shelf parts in order to attempt image fairly large objects such leaves, CD-ROMs etc. to reveal detail that can’t be seen with the naked eye.</p>



<p>This required a metallurgical style microscope, which shines light through a microscope objective, onto a sample.</p>







<p>I initially attempted to fix the microscope in place using a rather large amount of plasticine. This did hold it in place for a little while, until it began to creep and fall through!</p>



<p>To fit the microscope through the tool holder I had to first unscrew the mirror section of the microscope and re-install after.</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/06/plasticine-scaled.jpg"><img fetchpriority="high" decoding="async" width="683" height="1024" src="https://www.anfractuosity.com/wp-content/uploads/2024/06/plasticine-683x1024.jpg" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/06/plasticine-683x1024.jpg 683w, https://www.anfractuosity.com/wp-content/uploads/2024/06/plasticine-200x300.jpg 200w, https://www.anfractuosity.com/wp-content/uploads/2024/06/plasticine-768x1152.jpg 768w, https://www.anfractuosity.com/wp-content/uploads/2024/06/plasticine-1024x1536.jpg 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/06/plasticine-1365x2048.jpg 1365w, https://www.anfractuosity.com/wp-content/uploads/2024/06/plasticine-scaled.jpg 1707w" sizes="(max-width: 683px) 100vw, 683px"/></a></figure>



<p>I switched from plasticine to neoprene tape, which held the microscope in place much more effectively!</p>



<p>To install the microscope I wrapped it with the neoprene tape and unscrewed the CNC’s tool holder and gently prised it wide open to install the scope and re-install the screw.</p>



<p>The AmScope imaging sensor was then attached to the C-Mount thread on top of the microscope. It was necessary to rotate the image sensor, to do this I gently unscrewed the screw labelled in the following image and turned the sensor and re-tightened the screws.</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/06/unscrew-scaled.jpg"><img decoding="async" width="769" height="1024" src="https://www.anfractuosity.com/wp-content/uploads/2024/06/unscrew-769x1024.jpg" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/06/unscrew-769x1024.jpg 769w, https://www.anfractuosity.com/wp-content/uploads/2024/06/unscrew-225x300.jpg 225w, https://www.anfractuosity.com/wp-content/uploads/2024/06/unscrew-768x1023.jpg 768w, https://www.anfractuosity.com/wp-content/uploads/2024/06/unscrew-1153x1536.jpg 1153w, https://www.anfractuosity.com/wp-content/uploads/2024/06/unscrew-1538x2048.jpg 1538w, https://www.anfractuosity.com/wp-content/uploads/2024/06/unscrew-scaled.jpg 1922w" sizes="(max-width: 769px) 100vw, 769px"/></a></figure>



<p>An adapter provided by Lapsun was then attached to the RMS thread of the 20x objective and then the objective was screwed into the bottom of the microscope.</p>



<p>The LED light source provided by Lapsun was attached to the light port on the side of the microscope.</p>







<ul>
<li><a href="https://www.sainsmart.com/products/genmitsu-3018-prover-v2-upgraded-semi-assembled-cnc-router-kit">Genmitsu 3018-PROVer V2</a> – CNC machine – <strong>£216</strong></li>



<li><a href="https://www.aliexpress.com/item/4000731943174.html">Lapsun Microscope</a> – Chose Color: 40X-400X Lens – <strong>£240</strong></li>



<li><a href="https://www.aliexpress.com/item/4001351566621.html">Metallurgical Objective</a> – Chose Color: Only 20X Lens – <strong>£108</strong></li>



<li>AmScope MU1803 18MP USB 3.0 – Used – <strong>£120 </strong></li>



<li>Black neoprene tape – 0.5mm thick, 50mm height – <strong>£15</strong></li>



<li>Sorbothane discs – used for feet for the CNC machine – <strong>£20</strong></li>



<li>Acrylic block – used to raise sample on CNC stage – 300x180x30mm –<strong> £40</strong></li>
</ul>







<p>In the following image, you can see the microscope attached to the moveable head of the CNC machine using neoprene tape.</p>



<p>I placed a large cast plastic block onto the CNC stage, so that samples were closer to the microscope (the Z-axis couldn’t reach down far enough for the microscope to image without this).</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/07/cncscope.jpg"><img decoding="async" width="683" height="1024" src="https://www.anfractuosity.com/wp-content/uploads/2024/07/cncscope-683x1024.jpg" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/07/cncscope-683x1024.jpg 683w, https://www.anfractuosity.com/wp-content/uploads/2024/07/cncscope-200x300.jpg 200w, https://www.anfractuosity.com/wp-content/uploads/2024/07/cncscope-768x1152.jpg 768w, https://www.anfractuosity.com/wp-content/uploads/2024/07/cncscope-1024x1536.jpg 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/07/cncscope-1365x2048.jpg 1365w, https://www.anfractuosity.com/wp-content/uploads/2024/07/cncscope.jpg 1636w" sizes="(max-width: 683px) 100vw, 683px"/></a></figure>



<p>The Z-axis was at -11.798mm to take the first picture from the microscope of a CD-ROM. I then moved the CNC 11cm to the left.</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/07/a-scaled.jpg"><img decoding="async" width="1024" height="768" src="https://www.anfractuosity.com/wp-content/uploads/2024/07/a-1024x768.jpg" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/07/a-1024x768.jpg 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/07/a-300x225.jpg 300w, https://www.anfractuosity.com/wp-content/uploads/2024/07/a-768x576.jpg 768w, https://www.anfractuosity.com/wp-content/uploads/2024/07/a-1536x1152.jpg 1536w, https://www.anfractuosity.com/wp-content/uploads/2024/07/a-2048x1536.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<p>To get from the image shown below, to an in-focus image, I had to adjust the Z-axis upwards to -11.488mm. A difference of 0.31mm.</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/07/b-scaled.jpg"><img decoding="async" width="1024" height="768" src="https://www.anfractuosity.com/wp-content/uploads/2024/07/b-1024x768.jpg" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/07/b-1024x768.jpg 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/07/b-300x225.jpg 300w, https://www.anfractuosity.com/wp-content/uploads/2024/07/b-768x576.jpg 768w, https://www.anfractuosity.com/wp-content/uploads/2024/07/b-1536x1152.jpg 1536w, https://www.anfractuosity.com/wp-content/uploads/2024/07/b-2048x1536.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<h2>Magnification</h2>



<p>The following image is of white paper with 20x magnification objective and using 4x magnification on the microscope dial.</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/07/paper-scaled.jpg"><img decoding="async" width="1024" height="768" src="https://www.anfractuosity.com/wp-content/uploads/2024/07/paper-1024x768.jpg" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/07/paper-1024x768.jpg 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/07/paper-300x225.jpg 300w, https://www.anfractuosity.com/wp-content/uploads/2024/07/paper-768x576.jpg 768w, https://www.anfractuosity.com/wp-content/uploads/2024/07/paper-1536x1152.jpg 1536w, https://www.anfractuosity.com/wp-content/uploads/2024/07/paper-2048x1536.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<p>The following image is of white paper with a 20x magnification objective and using 1x magnification on the microscope dial – you can see significant vignetting due to poor illumination (I since found this assumption regarding illumination was incorrect, see below for more information).</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/07/paper2-scaled.jpg"><img decoding="async" width="1024" height="768" src="https://www.anfractuosity.com/wp-content/uploads/2024/07/paper2-1024x768.jpg" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/07/paper2-1024x768.jpg 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/07/paper2-300x225.jpg 300w, https://www.anfractuosity.com/wp-content/uploads/2024/07/paper2-768x576.jpg 768w, https://www.anfractuosity.com/wp-content/uploads/2024/07/paper2-1536x1152.jpg 1536w, https://www.anfractuosity.com/wp-content/uploads/2024/07/paper2-2048x1536.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/07/1-scaled.jpg"><img decoding="async" width="1024" height="768" src="https://www.anfractuosity.com/wp-content/uploads/2024/07/1-1024x768.jpg" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/07/1-1024x768.jpg 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/07/1-300x225.jpg 300w, https://www.anfractuosity.com/wp-content/uploads/2024/07/1-768x576.jpg 768w, https://www.anfractuosity.com/wp-content/uploads/2024/07/1-1536x1152.jpg 1536w, https://www.anfractuosity.com/wp-content/uploads/2024/07/1-2048x1536.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<p>After tightening the screws, which you can see in the image below, more properly.  The image looks a lot better!</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/07/mirror-scaled.jpg"><img decoding="async" width="1024" height="769" src="https://www.anfractuosity.com/wp-content/uploads/2024/07/mirror-1024x769.jpg" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/07/mirror-1024x769.jpg 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/07/mirror-300x225.jpg 300w, https://www.anfractuosity.com/wp-content/uploads/2024/07/mirror-768x577.jpg 768w, https://www.anfractuosity.com/wp-content/uploads/2024/07/mirror-1536x1154.jpg 1536w, https://www.anfractuosity.com/wp-content/uploads/2024/07/mirror-2048x1538.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/07/2-scaled.jpg"><img decoding="async" width="1024" height="768" src="https://www.anfractuosity.com/wp-content/uploads/2024/07/2-1024x768.jpg" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/07/2-1024x768.jpg 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/07/2-300x225.jpg 300w, https://www.anfractuosity.com/wp-content/uploads/2024/07/2-768x576.jpg 768w, https://www.anfractuosity.com/wp-content/uploads/2024/07/2-1536x1152.jpg 1536w, https://www.anfractuosity.com/wp-content/uploads/2024/07/2-2048x1536.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>







<p>onilink_ (see their website here – <a href="http://ic.onidev.fr/en/index.html">http://ic.onidev.fr/en/index.html</a>) suggested to me the great idea of splitting a single microscope image into multiple ’tiles’ and measuring the sharpness of each tile, using the Laplacian of Gaussian –  this works since a CD-ROM has a repeating pattern.</p>



<p>I used the Laplacian function I found from <a href="https://github.com/ArduCAM/RaspberryPi/blob/master/Motorized_Focus_Camera/python/Autofocus.py">Arducam</a>, but adapted slightly to use ksize=1 , iterated over tiles and generated a heat-map, which you can see below.</p>



<p>The original image has a shape of (3684, 4912) and the number of tiles is (13, 17).</p>



<p>You can see in the heat-map the far right of the image is the sharpest. I’m just hoping this means the CD-ROM is tilted rather than the microscope!</p>


<div>
<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/09/cd-heatmap.png"><img decoding="async" width="640" height="480" src="https://www.anfractuosity.com/wp-content/uploads/2024/09/cd-heatmap.png" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/09/cd-heatmap.png 640w, https://www.anfractuosity.com/wp-content/uploads/2024/09/cd-heatmap-300x225.png 300w" sizes="(max-width: 640px) 100vw, 640px"/></a></figure></div>


<p>Using a higher quality 10x CD-ROM image from ZeptoBars (see their site <a href="https://zeptobars.com/">https://zeptobars.com/</a>) and the same code, with a tile size of 150.  You can see the area of sharpness is in the centre of the image, which makes  more sense.</p>


<div>
<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/09/zepto-heatmap.png"><img decoding="async" width="640" height="480" src="https://www.anfractuosity.com/wp-content/uploads/2024/09/zepto-heatmap.png" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/09/zepto-heatmap.png 640w, https://www.anfractuosity.com/wp-content/uploads/2024/09/zepto-heatmap-300x225.png 300w" sizes="(max-width: 640px) 100vw, 640px"/></a></figure></div>


<p>I made a few adjustments – rotating the light source to try to improve light distribution as well as re-tightening the mirror section.</p>



<p>The following shows experiments with CD-ROM images with a 10x objective, with different magnifications on the microscope dial.</p>


<div>
<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/09/10x.png"><img decoding="async" width="640" height="480" src="https://www.anfractuosity.com/wp-content/uploads/2024/09/10x.png" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/09/10x.png 640w, https://www.anfractuosity.com/wp-content/uploads/2024/09/10x-300x225.png 300w" sizes="(max-width: 640px) 100vw, 640px"/></a></figure></div>


<p>The following shows experiments with CD-ROM images with a 20x objective, with different magnifications on the microscope dial.</p>


<div>
<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/09/20x.png"><img decoding="async" width="640" height="480" src="https://www.anfractuosity.com/wp-content/uploads/2024/09/20x.png" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/09/20x.png 640w, https://www.anfractuosity.com/wp-content/uploads/2024/09/20x-300x225.png 300w" sizes="(max-width: 640px) 100vw, 640px"/></a></figure></div>


<p>Note that in these previous heatmaps I had manually adjusted the Z height of the microscope to perform focusing.</p>







<p>I created a very simplistic script using Python which you can find at – <a href="https://github.com/anfractuosity/cncmicroscopy">https://github.com/anfractuosity/cncmicroscopy</a> to automatically capture images from the AmScope camera from x0,y0, to x1,y1 with arbitrary steps.</p>



<p>You can see in the follow image, the pattern that the software generates for the movement of the CNC microscope whilst moving across a sample and capturing images.</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/07/scan.png"><img decoding="async" width="1024" height="529" src="https://www.anfractuosity.com/wp-content/uploads/2024/07/scan-1024x529.png" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/07/scan-1024x529.png 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/07/scan-300x155.png 300w, https://www.anfractuosity.com/wp-content/uploads/2024/07/scan-768x397.png 768w, https://www.anfractuosity.com/wp-content/uploads/2024/07/scan-1536x793.png 1536w, https://www.anfractuosity.com/wp-content/uploads/2024/07/scan.png 2000w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<p>I made use of Hugin to stitch the resulting images. following the procedure from – <a href="https://hugin.sourceforge.io/tutorials/scans/en.shtml">https://hugin.sourceforge.io/tutorials/scans/en.shtml</a></p>



<p>The first image consists of microscope images of a book cover. You can see how the image becomes more out of focus nearer the bottom.  Later in this article I talk about using a simple auto focus algorithm.</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/07/scan.jpg"><img decoding="async" width="1024" height="848" src="https://www.anfractuosity.com/wp-content/uploads/2024/07/scan-1024x848.jpg" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/07/scan-1024x848.jpg 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/07/scan-300x248.jpg 300w, https://www.anfractuosity.com/wp-content/uploads/2024/07/scan-768x636.jpg 768w, https://www.anfractuosity.com/wp-content/uploads/2024/07/scan-1536x1272.jpg 1536w, https://www.anfractuosity.com/wp-content/uploads/2024/07/scan.jpg 1687w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<h2>Mean Square Error (MSE)</h2>



<p>I made use of mean square error to compare pairs of frames for similarity and store these values in a circular buffer.  If the standard deviation of this buffer is less than 0.1, I decide the image from the camera has stabilised and so can be used.</p>



<p>I found currently the MSE seems fairly high, due to vibrations being transferred to the table with the microscope on.  To lower these I plan to make use of a thick block of granite underneath the microscope as well as removing the CNC machine’s rubber feet and placing sorbothane discs underneath it instead.</p>



<p>In the following experiments an autofocus procedure is first run.  The microscope X axis is then moved 1mm to the right and back 1mm to the left.  Then MSE values of pairs of images are created over time and graphed.  You can see the MSE value is very high at first at 90, due to the vibrations from the CNC machine itself.</p>



<p>The following graph shows MSE values graphed across time, when external hard disk drives where powered on, on the same desk as the CNC microscope, upstairs.</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis.png"><img decoding="async" width="1024" height="768" src="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-1024x768.png" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-1024x768.png 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-300x225.png 300w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-768x576.png 768w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-1536x1152.png 1536w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-2048x1536.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<p>The following graph shows MSE values graphed across time, when external hard disk drives where powered off, on the same desk as the CNC microscope, upstairs.</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-1.png"><img decoding="async" width="1024" height="768" src="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-1-1024x768.png" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-1-1024x768.png 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-1-300x225.png 300w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-1-768x576.png 768w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-1-1536x1152.png 1536w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-1-2048x1536.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<p>The following shows the same experiment with the CNC machine on the carpet, upstairs.</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-3.png"><img decoding="async" width="1024" height="768" src="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-3-1024x768.png" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-3-1024x768.png 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-3-300x225.png 300w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-3-768x576.png 768w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-3-1536x1152.png 1536w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-3-2048x1536.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<p>The following shows the same experiment with the CNC machine on the carpet, downstairs.</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-2.png"><img decoding="async" width="1024" height="768" src="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-2-1024x768.png" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-2-1024x768.png 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-2-300x225.png 300w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-2-768x576.png 768w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-2-1536x1152.png 1536w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-2-2048x1536.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<p>The following shows the same experiment with the CNC machine on the carpet, downstairs and no rubber feet.</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-4.png"><img decoding="async" width="1024" height="768" src="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-4-1024x768.png" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-4-1024x768.png 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-4-300x225.png 300w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-4-768x576.png 768w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-4-1536x1152.png 1536w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-4-2048x1536.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<p>The following shows the same experiment with the CNC machine on the carpet, downstairs and no rubber feet, but adding sorbothane discs.</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-5.png"><img decoding="async" width="1024" height="768" src="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-5-1024x768.png" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-5-1024x768.png 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-5-300x225.png 300w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-5-768x576.png 768w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-5-1536x1152.png 1536w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-5-2048x1536.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<p>The following shows the same experiment with the CNC machine downstairs on stone fireplace with no feet.</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-6.png"><img decoding="async" width="1024" height="768" src="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-6-1024x768.png" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-6-1024x768.png 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-6-300x225.png 300w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-6-768x576.png 768w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-6-1536x1152.png 1536w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-6-2048x1536.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<p>The following shows the same experiment with the CNC machine downstairs on stone fireplace with no feet but sorbothane discs.</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-7.png"><img decoding="async" width="1024" height="768" src="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-7-1024x768.png" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-7-1024x768.png 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-7-300x225.png 300w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-7-768x576.png 768w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-7-1536x1152.png 1536w, https://www.anfractuosity.com/wp-content/uploads/2024/08/mse_analysis-7-2048x1536.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<h2>Exposure and framerate</h2>



<p>Initially I wasn’t setting the exposure duration manually, but using automatic exposures.  I found I was getting only around 3 fps from the camera.</p>



<p>This was significantly improved by dropping the resolution from 4912×3684 to 2456×1842 as well as using manual exposures instead by doing the following:</p>


<div><pre title="">ctx.hcam.put_AutoExpoEnable(False)
ctx.hcam.put_ExpoTime(ctx.exposure)
ctx.hcam.put_ExpoAGain(100)
</pre></div>


<p>A high framerate is necessary so that MSE can be quickly calculated.</p>



<h2>Autofocus</h2>



<p>You can see in the following animation, the Z-axis of the CNC machine is adjusted, to adjust focus.  It iterates from -10.000 to -12.000mm in steps of 0.01mm.  The Laplacian function is used as a method of measuring sharpness.</p>



<p>The video below was generated using the following command:</p>


<div><pre title="">ffmpeg -framerate 10 -pattern_type glob -i &#39;*.tif&#39; -c:v libx264 out.mp4
</pre></div>


<figure><p>
<iframe title="CNC microscope controlling Z axis height to adjust focus" width="940" height="705" src="https://www.youtube.com/embed/BS486vP_3Z0?feature=oembed" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>
</p></figure>



<h2>Stitching</h2>



<p>After tiles have been generated it is necessary to stitch them. I initially was using <a href="https://hugin.sourceforge.io/">Hugin</a> but then tried <a href="https://imagej.net/software/fiji/">Fiji</a> (a distribution of ImageJ2, with lots of plugins).</p>



<p>I needed to flip the images from the camera vertically, so they face the correct direction for stitching.  I initially used:</p>





<p>I then created a script for Fiji to do this using the stitching plugin.  It looks roughly like the below:</p>


<div><pre title="">run(&#34;Grid/Collection stitching&#34;, &#34;type=[Filename defined position] order=[Defined by filename         ] 
grid_size_x=11 grid_size_y=11 tile_overlap=50 first_file_index_x=0 first_file_index_y=0 
directory=/tmp/images file_names=tileb_{x}_{y}.tif output_textfile_name=TileConfiguration.txt 
fusion_method=[Linear Blending] regression_threshold=0.30 max/avg_displacement_threshold=2.50 
absolute_displacement_threshold=3.50 compute_overlap computation_parameters=[Save memory (but be slower)]
image_output=[Write to disk] output_directory=/tmp/images&#34;);
</pre></div>


<p>The overlap value itself doesn’t appear to be that important, as compute_overlap appears to calculate this.</p>



<p>I then automated the generation and running of the above ImageJ macro using a simple Python script.  It also handles the flipping of images and inversion of the Y axis.  I placed this script in the repository for this project, called <strong>stitch.py</strong>.</p>



<p>I was able to stitch images from an area of 0.5mm x 0.5mm of a CD-ROM, with 0.05mm x/y steps a 20x objective with the microscope tube set to 4x. And obtained a stitched image of 10319×9724, this is shown below, resized and compressed to take up less space. You will notice there appears a slight tilt to the stitched image, this is due I believe to my camera not being perfectly rotated to align with my stage.</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/09/cd-scaled.jpg"><img decoding="async" width="1024" height="965" src="https://www.anfractuosity.com/wp-content/uploads/2024/09/cd-1024x965.jpg" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/09/cd-1024x965.jpg 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/09/cd-300x283.jpg 300w, https://www.anfractuosity.com/wp-content/uploads/2024/09/cd-768x724.jpg 768w, https://www.anfractuosity.com/wp-content/uploads/2024/09/cd-1536x1448.jpg 1536w, https://www.anfractuosity.com/wp-content/uploads/2024/09/cd-2048x1930.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<p>I improved the technique from that of the previous approach by using an autofocus algorithm and splitting the area into 0.25mm x 0.25mm squares, within those squares I use steps of around 0.1mm following a ‘snake’ type pattern within the square.  Before I capture images within the square, I jump to the mid point of the square (0.25/2=0.125mm, therefore 0.125×0.125mm) and move the Z height from around -11.2m to -11.5mm in 0.001mm steps.  At each step I measure the sharpness of the image.  I then move above the best Z height, by 0.07mm and iterate from that to beyond the best Z height by 0.07mm.  I measure the sharpness again and compare against the best previous sharpness and finish if it’s within 0.5.</p>



<p>I was able to stitch images from an area of 1mm x 1mm of a CD-ROM, with 0.10mm x/y steps a 20x objective with the microscope tube set to 2x.</p>



<p>The stitched image was 10609×10077.  I took the stitched image and used the GNU Image Manipulation Program to increase exposure by 2 and reduced both the width and height by 4, so I can present it below.</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/09/blog_image-1-scaled.jpg"><img decoding="async" width="1024" height="973" src="https://www.anfractuosity.com/wp-content/uploads/2024/09/blog_image-1-1024x973.jpg" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/09/blog_image-1-1024x973.jpg 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/09/blog_image-1-300x285.jpg 300w, https://www.anfractuosity.com/wp-content/uploads/2024/09/blog_image-1-768x729.jpg 768w, https://www.anfractuosity.com/wp-content/uploads/2024/09/blog_image-1-1536x1459.jpg 1536w, https://www.anfractuosity.com/wp-content/uploads/2024/09/blog_image-1-2048x1945.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<p>You will notice there appears a grid like effect. This is due to the lighting not being perfectly uniform throughout the image. To fix this I used the code from <a href="https://stackoverflow.com/questions/74786867/subtract-vignetting-template-from-image-in-opencv-python">stackoverflow</a>. I took an image at -11mm Z height with the same exposure as previous images, but of the blank white plastic surface of my CNC bed and saved that image and was then able to use this algorithm to remove the vignette from my images, before stitching.</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/09/blog_image-2-scaled.jpg"><img decoding="async" width="1024" height="973" src="https://www.anfractuosity.com/wp-content/uploads/2024/09/blog_image-2-1024x973.jpg" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/09/blog_image-2-1024x973.jpg 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/09/blog_image-2-300x285.jpg 300w, https://www.anfractuosity.com/wp-content/uploads/2024/09/blog_image-2-768x729.jpg 768w, https://www.anfractuosity.com/wp-content/uploads/2024/09/blog_image-2-1536x1459.jpg 1536w, https://www.anfractuosity.com/wp-content/uploads/2024/09/blog_image-2-2048x1945.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<p>You can see the results look much improved.</p>



<p>The following is a crop from the above image, you will notice lines on the right, I believe these may be due to lighting flicker possibly.</p>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/09/crop.jpg"><img decoding="async" width="1024" height="682" src="https://www.anfractuosity.com/wp-content/uploads/2024/09/crop-1024x682.jpg" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/09/crop-1024x682.jpg 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/09/crop-300x200.jpg 300w, https://www.anfractuosity.com/wp-content/uploads/2024/09/crop-768x512.jpg 768w, https://www.anfractuosity.com/wp-content/uploads/2024/09/crop.jpg 1483w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<figure><a href="https://www.anfractuosity.com/wp-content/uploads/2024/09/contours-1.jpg"><img decoding="async" width="1024" height="682" src="https://www.anfractuosity.com/wp-content/uploads/2024/09/contours-1-1024x682.jpg" alt="" srcset="https://www.anfractuosity.com/wp-content/uploads/2024/09/contours-1-1024x682.jpg 1024w, https://www.anfractuosity.com/wp-content/uploads/2024/09/contours-1-300x200.jpg 300w, https://www.anfractuosity.com/wp-content/uploads/2024/09/contours-1-768x512.jpg 768w, https://www.anfractuosity.com/wp-content/uploads/2024/09/contours-1.jpg 1051w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<p>The above image shows contours drawn around the pits.</p>







<ul>
<li>See if kinematic table means I can move 11cm across CD-ROM without having to adjust Z-axis</li>



<li>Try out focus stacking</li>
</ul>







<ul>
<li><a href="https://openflexure.org/">https://openflexure.org/</a> – Cool looking DIY 3D printed motorised microscope</li>



<li><a href="https://github.com/TadPath/PUMA">https://github.com/TadPath/PUMA</a> – Another awesome 3D printed microscope</li>
</ul>







<p>The following is a list of some commercial solutions:</p>



<ul>
<li><a href="https://www.labsmore.com/">https://www.labsmore.com/</a> – Lots of cool looking microscopes as well as graphical open source software – <a href="https://github.com/Labsmore/pyuscope">https://github.com/Labsmore/pyuscope</a></li>



<li><a href="https://meijitechno.com/product/mt8500-m-motorized-metallurgical-microscope/">https://meijitechno.com/product/mt8500-m-motorized-metallurgical-microscope/</a> – Rather pricey (around $44k)</li>
</ul>
                        <!-- END #leave_comment -->
                
 
                </article></div>
  </body>
</html>
