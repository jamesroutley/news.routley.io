<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://a.exozy.me/posts/floats-weird/">Original</a>
    <h1>Floats Are Weird</h1>
    
    <div id="readability-page-1" class="page"><div id="content"><div><div><p>Floats are weird. Anyways, hereâ€™s a basic calculus exercise:</p><p>$$\lim_{x \to 0} \frac{e^x-1}{x} = 1$$</p><p>However, I wonâ€™t prove that limit here, because this is a post about floats being weird, not a post about calculus. Instead, letâ€™s try to approximate this limit numerically using Python, because whatâ€™s the worst that could happen? Letâ€™s write that fraction as a Python function and plug in smaller and smaller $x$.</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>def</span> <span>f</span>(x):
</span></span><span><span>    <span>return</span> (math<span>.</span>exp(x)<span>-</span><span>1</span>)<span>/</span>x
</span></span></code></pre></div><p><code>f(1e-9)</code> returns 1.000000082740371 and <code>f(1e-12)</code> returns 1.000088900582341, which is already weird. Shouldnâ€™t the approximation get better with smaller $x$? However, trouble really strikes with <code>f(1e-15)</code>. It returns a shocking 1.1102230246251565, which has a more than 10% error!</p><p>But, with this one weird trickâ€¦</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>def</span> <span>g</span>(x):
</span></span><span><span>    y <span>=</span> math<span>.</span>exp(x)
</span></span><span><span>    <span>return</span> (y<span>-</span><span>1</span>)<span>/</span>math<span>.</span>log(y)
</span></span></code></pre></div><p><code>g(1e-9)</code> returns 1.0000000005, <code>g(1e-12)</code> returns 1.0000000000005, and <code>g(1e-15)</code> returns 1.0000000000000004, giving us exactly what we want! ðŸ¤¯</p><p>Wait a minute! This new function is doing redundant computation! Why should we take $\log(e^x)$ when we can simply divide by $x$? How does this reduce the error so effectively?</p><h2 id="an-assumption">An assumption</h2><p>To explain this phenomena, we need to make a huge simplifying assumption. For some operation like $x+y$ when done using floating-point arithmetic, the final answer wonâ€™t be exactly equal to the exact value of $x+y$. Letâ€™s use $fl(x+y)$ to denote the value of this floating-point calculation. Then we will assume that $fl(x+y) = (x+y)(1+\delta)$ for some small $\delta$. The upper bound on $\delta$ depends on what kind of floating-point numbers weâ€™re using. Python uses IEEE 754 double-precision floats, which have a $\delta$ with magnitude at most $2^{-53}$.</p><p>You might be wondering why we didnâ€™t choose a different assumption that $|fl(x+y) - (x+y)| &lt; \epsilon$ for some small $\epsilon$. This is because floating-point numbers become spaced out farther apart as they get larger, so $fl(x+y)$ for large $x, y$ might have a large absolute difference from $x+y$, but the relative difference of $\frac{fl(x+y)}{x+y}$ will still be small. Thus, our original assumption is indeed the correct one to make.</p><p>We will also assume that this $1+\delta$ assumption holds for other operations like subtraction, multiplication, exponentiation, and logarithms. Now we have the necessary tools to tackle the problem!</p><h2 id="analyzing-f">Analyzing f</h2><p>First, letâ€™s find $fl\left(\frac{e^x-1}{x}\right)$. Using our $1+\delta$ assumption repeatedly, we have</p><p>$$fl\left(\frac{e^x-1}{x}\right) = \frac{(e^x(1+\delta_1)-1)(1+\delta_2)}{x}(1+\delta_3)$$</p><p>You might remember from calculus that $e^x = 1+x+\frac{x^2}{2!}+\frac{x^3}{3!}+\dots$, which is a Taylor series. Since we are only plugging in very small values of $x$, $x^2$ and $x^3$ and other higher powers are very, very small numbers so we can simply ignore them. Weâ€™ll just say $e^x \approx 1+x$. This is a common trick in math and physics. We now get</p><p>$$fl\left(\frac{e^x-1}{x}\right) = \frac{((1+x)(1+\delta_1)-1)(1+\delta_2)}{x}(1+\delta_3) = \frac{(x+\delta_1+x\delta_1)(1+\delta_2)}{x}(1+\delta_3)$$</p><p>Again, since $x$ is small, $x\delta_1$ will be absolutely tiny, so we can also ignore it. Thus, the whole thing simplifies to</p><p>$$fl\left(\frac{e^x-1}{x}\right) = (1+\frac{\delta_1}{x})(1+\delta_2)(1+\delta_3)$$</p><p>If we plug in $x = 10^{-15}, \delta_1 = 2^{-53}$, we get $1+\frac{\delta_1}{x} = 1.1110$ which is pretty similar to the actual error that we got at the beginning! Cool, now we can see the source of the error: $x$ is in the denominator, so as it gets smaller, the error grows.</p><h2 id="analyzing-g">Analyzing g</h2><p>Next, letâ€™s find $fl\left(\frac{e^x-1}{\log(e^x)}\right)$. Using our favorite assumption again, we get</p><p>$$fl\left(\frac{e^x-1}{\log(e^x)}\right) = \frac{(e^x(1+\delta_1)-1)(1+\delta_2)}{\log(e^x(1+\delta_1))(1+\delta_4)}(1+\delta_3)$$</p><p>This looks pretty scary, but we can use our $e^x \approx 1+x$ and $x\delta_1 \approx 0$ approximations to reduce it down to</p><p>$$fl\left(\frac{e^x-1}{\log(e^x)}\right) = \frac{(x+\delta_1)(1+\delta_2)}{\log(1+x+\delta_1))(1+\delta_4)}(1+\delta_3)$$</p><p>Now we need one last Taylor series, for $\log(x)$. Since this post isnâ€™t about calculus (although it kind of is), Iâ€™m just going to give you the Taylor series that we need: $\log(x) = (x-1) - \frac{(x-1)^2}{2} + \frac{(x-1)^3}{3} - \frac{(x-1)^4}{4} + \dots$ (this series doesnâ€™t converge for all $x$, but whatever). The important thing is that $(x-1)^2$ and the higher powers are going to be very small, since our $x$ that weâ€™re plugging into $\log(x)$ is $1+x+\delta_1$. Thus, we can just ignore them and conclude $\log(x) \approx x-1$.</p><p>Something magical happens when we plug that approximation in. The $x+\delta_1$ in the numerator and the denominator cancel out! Weâ€™re just left with</p><p>$$fl\left(\frac{e^x-1}{\log(e^x)}\right) = \frac{1+\delta_2}{1+\delta_4}(1+\delta_3)$$</p><p>Awesome! Now we can clearly see that for small $x$, the resulting error is tiny. You might be wondering why there isnâ€™t an $x$ in this answer. When we plugged in $x = 10^{-6}$, it wasnâ€™t all that close to 1. This is because with $x = 10^{-6}$, our approximations of $e^x \approx 1+x$ and $\log(x) \approx x-1$ arenâ€™t exactly valid since the squared terms do contribute a bit. Basically, our answer is only true for when $x$ is very small and close to $10^-15$.</p><p>Intuitively, <code>g</code> is more accurate than <code>f</code> because the errors of the $e^x$ in the numerator and denominator end up cancelling each other out, but this is actually a pretty misleading explanation. The only way to see why this happens is to crunch through the analysis.</p><p>Anyways, floats are weird.</p></div></div></div></div>
  </body>
</html>
