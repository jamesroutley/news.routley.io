<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://extism.org/blog/extending-fly-io-distributed-game-system-part-3/">Original</a>
    <h1>GameBox is a programmable, turn-based, WebAssembly game platform</h1>
    
    <div id="readability-page-1" class="page"><div id="post-content" itemprop="articleBody"><h2 id="lets-make-some-games">Let&#39;s make some games<a href="#lets-make-some-games" aria-label="Direct link to Let&#39;s make some games" title="Direct link to Let&#39;s make some games">​</a></h2><p>In the previous parts to this blog series (<a href="https://extism.org/blog/extending-fly-io-distributed-game-system-part-1">Part I</a> and <a href="https://extism.org/blog/extending-fly-io-distributed-game-system-part-2">Part II</a>),
we discussed the creation of <a href="https://gamebox.fly.dev/" target="_blank" rel="noopener noreferrer">GameBox</a>,
an Elixir application implemented as an <a href="https://extism.org/docs/concepts/host-sdk" target="_blank" rel="noopener noreferrer">Extism host</a>,
that provides an extensible platform for multi-player, turn-based games. </p><p>In this post, we&#39;re going to explore the nuts and bolts of writing some GameBox games! The best part about this is we can harness the power of the
<a href="https://extism.org/docs/concepts/pdk" target="_blank" rel="noopener noreferrer">Extism Plug-in Development Kits (PDKs)</a> to write our games in
<a href="https://extism.org/docs/category/write-a-plug-in" target="_blank" rel="noopener noreferrer">any number of languages</a> that can be compiled into WebAssembly, even though GameBox itself is implemented in Elixir.
This gives you, the game creator, the flexibility needed to unleash your creative power expressed in the programming language that best suits your passion and skills,
all while ensuring the game platform itself remains secure, and the games themselves are lightweight and portable. </p><h2 id="the-game-api">The Game API<a href="#the-game-api" aria-label="Direct link to The Game API" title="Direct link to The Game API">​</a></h2><p>As the game creator, you need only implement and export four basic functions that GameBox will call during the course of the gameplay.
Let’s demonstrate this by creating a “game” which has a single button and shows the log of events coming into the game:</p><p><img loading="lazy" alt="GameBox Screenshot" src="https://extism.org/assets/images/gamebox-log-7b5e1372ef7c3eff089a8807e7306f45.png" width="2866" height="1000"/></p><p>We’re going to write this in JavaScript for simplicity. Our <a href="https://github.com/extism/js-pdk" target="_blank" rel="noopener noreferrer">JavaScript PDK</a> still has a fairly primitive
API for defining Extism functions. Different languages come with various levels of sugar to make it prettier. But this should be the easiest to follow.</p><h3 id="helpers">Helpers<a href="#helpers" aria-label="Direct link to Helpers" title="Direct link to Helpers">​</a></h3><p>Let’s start with some helper functions. Currently GameBox expects you, the game programmer, to store the state of the game yourself.
This can be accomplished with plug-in variables. So let’s make some helpers to get and set the state into a plug-in variable called “state”:</p><div><div><pre tabindex="0"><code><span><span>function</span><span> </span><span>set_state</span><span>(</span><span>state</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>  </span><span>Var</span><span>.</span><span>set</span><span>(</span><span>&#39;state&#39;</span><span>,</span><span> </span><span>JSON</span><span>.</span><span>stringify</span><span>(</span><span>state</span><span>)</span><span>)</span><span></span><br/></span><span><span></span><span>}</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span>function</span><span> </span><span>get_state</span><span>(</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>  </span><span>return</span><span> </span><span>JSON</span><span>.</span><span>parse</span><span>(</span><span>Var</span><span>.</span><span>getString</span><span>(</span><span>&#39;state&#39;</span><span>)</span><span>)</span><span></span><br/></span><span><span></span><span>}</span><br/></span></code></pre></div></div><div><p><span><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</p><p> The variable doesn’t need to be JSON, but this is the easiest way to consistently store any JS object into bytes in this language.</p></div><p>This uses Extism’s <code>Var.set</code> and <code>Var.getString</code> to set and get the variable, and the data will persist between calls.</p><h3 id="interface-functions">Interface Functions<a href="#interface-functions" aria-label="Direct link to Interface Functions" title="Direct link to Interface Functions">​</a></h3><p>Now with our helper functions ready to go, let&#39;s move on to the interactions with GameBox itself.</p><p>The first function that GameBox will invoke, <code>get_constraints</code>, provides it with some metadata about the constraints you want to apply as the game creator.
Currently, these constraints are related to the minimum and maximum number of players, specified as integers, but additional constraints could be added in the future. </p><h4 id="get_constraintsvoid---gameconstraints">get_constraints(void) -&gt; GameConstraints<a href="#get_constraintsvoid---gameconstraints" aria-label="Direct link to get_constraints(void) -&gt; GameConstraints" title="Direct link to get_constraints(void) -&gt; GameConstraints">​</a></h4><div><div><pre tabindex="0"><code><span><span>function</span><span> </span><span>get_constraints</span><span>(</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>  </span><span>const</span><span> constraints </span><span>=</span><span>{</span><span></span><br/></span><span><span>    </span><span>min_players</span><span>:</span><span> </span><span>2</span><span>,</span><span></span><br/></span><span><span>    </span><span>max_players</span><span>:</span><span> </span><span>10</span><span>,</span><span></span><br/></span><span><span>  </span><span>}</span><span></span><br/></span><span><span>  </span><span>Host</span><span>.</span><span>outputString</span><span>(</span><span>JSON</span><span>.</span><span>stringify</span><span>(</span><span>constraints</span><span>)</span><span>)</span><span></span><br/></span><span><span></span><span>}</span><br/></span></code></pre></div></div><p>Once all players are ready to start the game, GameBox will call <code>init_game</code>, passing in information about the players and allowing your game to allocate state,
memory, and anything else required. Here we are only interested in the player_ids that are joining the game. We define our state and persist it with our <code>set_state</code> helper:</p><h4 id="init_gamegameconfig---void">init_game(GameConfig) -&gt; void<a href="#init_gamegameconfig---void" aria-label="Direct link to init_game(GameConfig) -&gt; void" title="Direct link to init_game(GameConfig) -&gt; void">​</a></h4><div><div><pre tabindex="0"><code><span><span>function</span><span> </span><span>init_game</span><span>(</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>  </span><span>const</span><span> game_config </span><span>=</span><span> </span><span>JSON</span><span>.</span><span>parse</span><span>(</span><span>Host</span><span>.</span><span>inputString</span><span>(</span><span>)</span><span>)</span><span></span><br/></span><span><span>  </span><span>const</span><span> state </span><span>=</span><span> </span><span>{</span><span></span><br/></span><span><span>    </span><span>player_ids</span><span>:</span><span> game_config</span><span>.</span><span>player_ids</span><span>,</span><span></span><br/></span><span><span>    </span><span>events</span><span>:</span><span> </span><span>[</span><span>]</span><span>,</span><span></span><br/></span><span><span>    </span><span>version</span><span>:</span><span> </span><span>0</span><span>,</span><span></span><br/></span><span><span>  </span><span>}</span><span></span><br/></span><span><span>  </span><span>set_state</span><span>(</span><span>state</span><span>)</span><span></span><br/></span><span><span></span><span>}</span><br/></span></code></pre></div></div><div><p><span><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</p><p>The <code>version</code> property here will be incremented every time the game state changes. This will be used to tell the system to re-render the clients.</p></div><p>Next, the <code>render</code> function is called each time the game board needs to be rendered. It&#39;s called for each user watching or playing the game and each time the state version changes.
You can render the game depending on who is viewing it by looking at the metadata on the user&#39;s socket. This is passed in as an object called <code>assigns</code>. For example,
you will render the game differently based on who&#39;s turn it is and which screen it&#39;s being rendered on. By default the assigns will always have the player_id, but you can attach whatever you want to it. Take note this may be called for people who are only viewing the game and not playing, so you may want to conditionally render things like controls for those people.</p><h4 id="renderassigns--string">render(Assigns) → String<a href="#renderassigns--string" aria-label="Direct link to render(Assigns) → String" title="Direct link to render(Assigns) → String">​</a></h4><div><div><pre tabindex="0"><code><span><span>function</span><span> </span><span>ui</span><span>(</span><span>state</span><span>,</span><span> assigns</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>  </span><span>const</span><span> version </span><span>=</span><span> </span><span>`</span><span>&lt;h1&gt;Version: </span><span>${</span><span>state</span><span>.</span><span>version</span><span>}</span><span>&lt;/h1&gt;</span><span>`</span><span></span><br/></span><span><span>  </span><span>const</span><span> youare </span><span>=</span><span> </span><span>`</span><span>&lt;h1&gt;You are </span><span>${</span><span>assigns</span><span>.</span><span>player_id</span><span>}</span><span>`</span><span></span><br/></span><span><span>  </span><span>const</span><span> button </span><span>=</span><span> </span><span>`</span><span>&lt;button phx-click=&#34;cell-clicked&#34; phx-value-cell=&#34;0&#34;&gt;Click me&lt;/button&gt;</span><span>`</span><span></span><br/></span><span><span>  </span><span></span><br/></span><span><span>  </span><span>const</span><span> events </span><span>=</span><span> state</span><span>.</span><span>events</span><span>.</span><span>map</span><span>(</span><span>e</span><span> </span><span>=&gt;</span><span> </span><span>`</span><span>&lt;li&gt;</span><span>${</span><span>JSON</span><span>.</span><span>stringify</span><span>(</span><span>e</span><span>)</span><span>}</span><span>&lt;/li&gt;</span><span>`</span><span>)</span><span></span><br/></span><span><span></span><br/></span><span><span>  </span><span>return</span><span> </span><span>`</span><span>${</span><span>version</span><span>}</span><span> </span><span>${</span><span>youare</span><span>}</span><span> </span><span>${</span><span>button</span><span>}</span><span> </span><span>${</span><span>events</span><span>}</span><span>`</span><span></span><br/></span><span><span></span><span>}</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span>function</span><span> </span><span>render</span><span>(</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>  </span><span>const</span><span> assigns </span><span>=</span><span> </span><span>JSON</span><span>.</span><span>parse</span><span>(</span><span>Host</span><span>.</span><span>inputString</span><span>(</span><span>)</span><span>)</span><span></span><br/></span><span><span>  </span><span>Host</span><span>.</span><span>outputString</span><span>(</span><span>ui</span><span>(</span><span>get_state</span><span>(</span><span>)</span><span>,</span><span> assigns</span><span>)</span><span>)</span><span></span><br/></span><span><span></span><span>}</span><br/></span></code></pre></div></div><div><p><span><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</p><p>You can attach any assigns you want to the user’s socket in <code>handle_event</code> , but by default it will always contain the <code>version</code> and the <code>player_id</code></p></div><div><p><span><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</p><p>For simplicity sake we are just rendering the html using string interpolation. How you render the html is up to you. In
<a href="https://github.com/extism/game_box/blob/1bba76dd1b2f812dbd1bd2a0e7b6b43727a438c5/games/tictactoe/src/templates/app.html" target="_blank" rel="noopener noreferrer">tic-tac-toe</a> for example, we use
<a href="https://tera.netlify.app/" target="_blank" rel="noopener noreferrer">tera templates</a>.</p></div><div><p><span><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</p><p>It&#39;s important to learn about <a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.html" target="_blank" rel="noopener noreferrer">LiveView</a> to understand how the system works and how a game can be created.</p></div><p>And finally, during the course of the game lifecycle, GameBox will proxy any events (e.g. a player making a move, answering a trivia question, etc.)
it receives to your game through <code>handle_event</code> and accept a return value that contains some player-specific information. </p><h4 id="handle_eventliveevent---assigns">handle_event(LiveEvent) -&gt; Assigns<a href="#handle_eventliveevent---assigns" aria-label="Direct link to handle_event(LiveEvent) -&gt; Assigns" title="Direct link to handle_event(LiveEvent) -&gt; Assigns">​</a></h4><div><div><pre tabindex="0"><code><span><span>function</span><span> </span><span>handle_event</span><span>(</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>  </span><span>const</span><span> event </span><span>=</span><span> </span><span>JSON</span><span>.</span><span>parse</span><span>(</span><span>Host</span><span>.</span><span>inputString</span><span>(</span><span>)</span><span>)</span><span></span><br/></span><span><span>  </span><span>const</span><span> state </span><span>=</span><span> </span><span>get_state</span><span>(</span><span>)</span><span></span><br/></span><span><span>  state</span><span>.</span><span>events</span><span>.</span><span>push</span><span>(</span><span>event</span><span>)</span><span> </span><span></span><br/></span><span><span>  state</span><span>.</span><span>version</span><span> </span><span>+=</span><span> </span><span>1</span><span>       </span><span></span><br/></span><span><span>  </span><span>set_state</span><span>(</span><span>state</span><span>)</span><span></span><br/></span><span><span>  </span><span></span><br/></span><span><span>  </span><span>Host</span><span>.</span><span>outputString</span><span>(</span><span>JSON</span><span>.</span><span>stringify</span><span>(</span><span>{</span><span> </span><span>version</span><span>:</span><span> state</span><span>.</span><span>version</span><span> </span><span>}</span><span>)</span><span>)</span><span></span><br/></span><span><span></span><span>}</span><br/></span></code></pre></div></div><p>The shape of the input <code>LiveEvent</code> will depend on what <a href="https://hexdocs.pm/phoenix_live_view/bindings.html" target="_blank" rel="noopener noreferrer">Phoenix binding</a> the user interacts with.
In our case, with the button we defined, it will look something like this:</p><div><div><pre tabindex="0"><code><span><span>{</span><span></span><br/></span><span><span>  </span><span>&#34;event_name&#34;</span><span>:</span><span>&#34;cell-clicked&#34;</span><span>,</span><span></span><br/></span><span><span>  </span><span>&#34;player_id&#34;</span><span>:</span><span>&#34;BEN&#34;</span><span>,</span><span></span><br/></span><span><span>  </span><span>&#34;value&#34;</span><span>:</span><span>{</span><span></span><br/></span><span><span>    </span><span>&#34;cell&#34;</span><span>:</span><span> </span><span>&#34;0&#34;</span><span></span><br/></span><span><span>  </span><span>}</span><span></span><br/></span><span><span></span><span>}</span><br/></span></code></pre></div></div><p>The return value, <code>Assigns</code>, can be anything you want it to be, but at a minimum it should contain the <code>version</code>.
Any assigns you return will get attached to the user’s socket and passed back to you in <code>render</code>. </p><div><p><span><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</p><p>Your game should be viewed as a <a href="https://developer.mozilla.org/en-US/docs/Glossary/State_machine" target="_blank" rel="noopener noreferrer">state machine</a> that receives these events and updates the state
until a state transition occurs and the rules change. See some of the <a href="https://github.com/extism/game_box/tree/main/games" target="_blank" rel="noopener noreferrer">example games</a> to understand how this idea can be applied. </p></div><hr/><p>And that’s all folks! Of course, your game can be as simple or complex as you like, but the interactions between GameBox and your game are streamlined and simple.</p><p>For more details on the API check out the <a href="https://github.com/extism/game_box" target="_blank" rel="noopener noreferrer">GameBox repo on Github</a>,
which also includes a few <a href="https://github.com/extism/game_box/tree/main/games" target="_blank" rel="noopener noreferrer">example games</a> for reference.</p><h2 id="whats-next">What’s Next<a href="#whats-next" aria-label="Direct link to What’s Next" title="Direct link to What’s Next">​</a></h2><p>While this is all fun and games, the implications are staggering when one thinks about the opportunity for user-generated content that becomes possible
across a wide variety of applications when WebAssembly is in the mix. One need only look at <a href="https://shopify.dev/docs/apps/functions" target="_blank" rel="noopener noreferrer">Shopify functions</a>
as an example of an extendable eCommerce platform, or data platforms such as <a href="https://www.singlestore.com/" target="_blank" rel="noopener noreferrer">SingleStore</a> that
enable users to write their own data transformations that run right alongside the host code to further see the possibilities. </p><p>Whether you want to create an extensible platform of your own, or write plug-ins that extend another platform,
<a href="https://extism.org/" target="_blank" rel="noopener noreferrer">Extism</a>, the universal plug-in system, provides you with a powerful facilitation agent to orchestrate the magic on both sides.</p><p>Feeling inspired? We’d love to hear about your ideas. Join us on <a href="https://discord.gg/cx3usBCWnc" target="_blank" rel="noopener noreferrer">Discord</a>!</p></div></div>
  </body>
</html>
