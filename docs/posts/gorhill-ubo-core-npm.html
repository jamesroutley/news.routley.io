<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.npmjs.com/package/@gorhill/ubo-core">Original</a>
    <h1>@gorhill/ubo-core â€“ npm</h1>
    
    <div id="readability-page-1" class="page"><div><article> <div id="readme">
<p>The core filtering engines used in the uBlock Origin (&#34;uBO&#34;) extension, and has
no external dependencies.</p>
<h2>
<a id="user-content-installation" href="#installation" aria-hidden="true"><span aria-hidden="true"></span></a>Installation</h2>
<p>Install: <code>npm install @gorhill/ubo-core</code></p>
<p>This is a very early version and the API is subject to change at any time.</p>
<p>This package uses <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules" rel="nofollow">native JavaScript modules</a>.</p>
<h2>
<a id="user-content-description" href="#description" aria-hidden="true"><span aria-hidden="true"></span></a>Description</h2>
<p>The package contains uBO&#39;s static network filtering engine (&#34;SNFE&#34;), which
purpose is to parse and enforce filter lists. The matching algorithm is highly
efficient, and <em>especially</em> optimized to match against large sets of pure
hostnames.</p>
<p>The SNFE can be fed filter lists from a variety of sources, such as <a href="https://easylist.to/" rel="nofollow">EasyList/EasyPrivacy</a>,
<a href="https://github.com/uBlockOrigin/uAssets/tree/master/filters">uBlock filters</a>,
and also lists of domain names or hosts file format (i.e. block lists from <a href="https://github.com/blocklistproject/Lists#the-block-list-project">The Block List Project</a>,
<a href="https://github.com/StevenBlack/hosts#readme">Steven Black&#39;s HOSTS</a>, etc).</p>
<h2>
<a id="user-content-usage" href="#usage" aria-hidden="true"><span aria-hidden="true"></span></a>Usage</h2>
<p>At the moment, there can be only one instance of the static network filtering
engine (&#34;SNFE&#34;), which proxy API must be imported as follow:</p>
<div><pre><span>import</span> <span>{</span> <span>StaticNetFilteringEngine</span> <span>}</span> <span>from</span> <span>&#39;@gorhill/ubo-core&#39;</span><span>;</span></pre></div>
<p>If you must import as a NodeJS module:</p>
<div><pre><span>const</span> <span>{</span> StaticNetFilteringEngine <span>}</span> <span>=</span> <span>await</span> <span>import</span><span>(</span><span>&#39;@gorhill/ubo-core&#39;</span><span>)</span><span>;</span></pre></div>
<p>Create an instance of SNFE:</p>
<div><pre><span>const</span> <span>snfe</span> <span>=</span> <span>StaticNetFilteringEngine</span><span>.</span><span>create</span><span>(</span><span>)</span><span>;</span></pre></div>
<p>Feed the SNFE with filter lists -- <code>useLists()</code> accepts an array of
objects (or promises to object) which expose the raw text of a list
through the <code>raw</code> property, and optionally the name of the list through the
<code>name</code> property (how you fetch the lists is up to you):</p>
<div><pre><span>await</span> <span>snfe</span><span>.</span><span>useLists</span><span>(</span><span>[</span>
    <span>fetch</span><span>(</span><span>&#39;easylist&#39;</span><span>)</span><span>.</span><span>then</span><span>(</span><span>raw</span> <span>=&gt;</span> <span>(</span><span>{</span> <span>name</span>: <span>&#39;easylist&#39;</span><span>,</span> raw <span>}</span><span>)</span><span>)</span><span>,</span>
    <span>fetch</span><span>(</span><span>&#39;easyprivacy&#39;</span><span>)</span><span>.</span><span>then</span><span>(</span><span>raw</span> <span>=&gt;</span> <span>(</span><span>{</span> <span>name</span>: <span>&#39;easyprivacy&#39;</span><span>,</span> raw <span>}</span><span>)</span><span>)</span><span>,</span>
<span>]</span><span>)</span><span>;</span></pre></div>
<p>Now we are ready to match network requests:</p>
<div><pre><span>// Not blocked</span>
<span>if</span> <span>(</span> <span>snfe</span><span>.</span><span>matchRequest</span><span>(</span><span>{</span>
    <span>originURL</span>: <span>&#39;https://www.bloomberg.com/&#39;</span><span>,</span>
    <span>url</span>: <span>&#39;https://www.bloomberg.com/tophat/assets/v2.6.1/that.css&#39;</span><span>,</span>
    <span>type</span>: <span>&#39;stylesheet&#39;</span>
<span>}</span><span>)</span> <span>!==</span> <span>0</span> <span>)</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>snfe</span><span>.</span><span>toLogData</span><span>(</span><span>)</span><span>)</span><span>;</span>
<span>}</span>

<span>// Blocked</span>
<span>if</span> <span>(</span> <span>snfe</span><span>.</span><span>matchRequest</span><span>(</span><span>{</span>
    <span>originURL</span>: <span>&#39;https://www.bloomberg.com/&#39;</span><span>,</span>
    <span>url</span>: <span>&#39;https://securepubads.g.doubleclick.net/tag/js/gpt.js&#39;</span><span>,</span>
    <span>type</span>: <span>&#39;script&#39;</span>
<span>}</span><span>)</span> <span>!==</span> <span>0</span> <span>)</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>snfe</span><span>.</span><span>toLogData</span><span>(</span><span>)</span><span>)</span><span>;</span>
<span>}</span>

<span>// Unblocked</span>
<span>if</span> <span>(</span> <span>snfe</span><span>.</span><span>matchRequest</span><span>(</span><span>{</span>
    <span>originURL</span>: <span>&#39;https://www.bloomberg.com/&#39;</span><span>,</span>
    <span>url</span>: <span>&#39;https://sourcepointcmp.bloomberg.com/ccpa.js&#39;</span><span>,</span>
    <span>type</span>: <span>&#39;script&#39;</span>
<span>}</span><span>)</span> <span>!==</span> <span>0</span> <span>)</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>snfe</span><span>.</span><span>toLogData</span><span>(</span><span>)</span><span>)</span><span>;</span>
<span>}</span></pre></div>
<p>It is possible to pre-parse filter lists and save the intermediate results for
later use -- useful to speed up the loading of filter lists. This will be
documented eventually, but if you feel adventurous, you can look at the code
and use this capability now if you figure out the details.</p>
<hr/>
<h2>
<a id="user-content-extras" href="#extras" aria-hidden="true"><span aria-hidden="true"></span></a>Extras</h2>
<p>You can directly use specific APIs exposed by this package, here are some of
them, which are used internally by uBO&#39;s SNFE.</p>
<h3>
<a id="user-content-hntriecontainer" href="#hntriecontainer" aria-hidden="true"><span aria-hidden="true"></span></a>HNTrieContainer</h3>
<p>A well optimised <a href="https://en.wikipedia.org/wiki/Trie#Compressing_tries" rel="nofollow">compressed trie</a>
container specialized to specifically store and lookup hostnames.</p>
<p>The matching algorithm is designed for hostnames, i.e. the hostname labels
making up a hostname are matched from right to left, such that <code>www.example.org</code>
with be a match if <code>example.org</code> is stored into the trie, while
<code>anotherexample.org</code> won&#39;t be a match.</p>
<p><code>HNTrieContainer</code> is designed to store a large number of hostnames with CPU and
memory efficiency as a main concern -- and is a key component of uBO.</p>
<p>To create and use a standalone <code>HNTrieContainer</code> object:</p>
<div><pre><span>import</span> <span>HNTrieContainer</span> <span>from</span> <span>&#39;@gorhill/ubo-core/js/hntrie.js&#39;</span><span>;</span>

<span>const</span> <span>trieContainer</span> <span>=</span> <span>new</span> <span>HNTrieContainer</span><span>(</span><span>)</span><span>;</span>

<span>const</span> <span>aTrie</span> <span>=</span> <span>trieContainer</span><span>.</span><span>createOne</span><span>(</span><span>)</span><span>;</span>
<span>trieContainer</span><span>.</span><span>add</span><span>(</span><span>aTrie</span><span>,</span> <span>&#39;example.org&#39;</span><span>)</span><span>;</span>
<span>trieContainer</span><span>.</span><span>add</span><span>(</span><span>aTrie</span><span>,</span> <span>&#39;example.com&#39;</span><span>)</span><span>;</span>

<span>const</span> <span>anotherTrie</span> <span>=</span> <span>trieContainer</span><span>.</span><span>createOne</span><span>(</span><span>)</span><span>;</span>
<span>trieContainer</span><span>.</span><span>add</span><span>(</span><span>anotherTrie</span><span>,</span> <span>&#39;foo.invalid&#39;</span><span>)</span><span>;</span>
<span>trieContainer</span><span>.</span><span>add</span><span>(</span><span>anotherTrie</span><span>,</span> <span>&#39;bar.invalid&#39;</span><span>)</span><span>;</span>

<span>// matches() return the position at which the match starts, or -1 when</span>
<span>// there is no match.</span>

<span>// Matches: return 4</span>
<span>console</span><span>.</span><span>log</span><span>(</span><span>&#34;trieContainer.matches(aTrie, &#39;www.example.org&#39;)&#34;</span><span>,</span> <span>trieContainer</span><span>.</span><span>matches</span><span>(</span><span>aTrie</span><span>,</span> <span>&#39;www.example.org&#39;</span><span>)</span><span>)</span><span>;</span>

<span>// Does not match: return -1</span>
<span>console</span><span>.</span><span>log</span><span>(</span><span>&#34;trieContainer.matches(aTrie, &#39;www.foo.invalid&#39;)&#34;</span><span>,</span> <span>trieContainer</span><span>.</span><span>matches</span><span>(</span><span>aTrie</span><span>,</span> <span>&#39;www.foo.invalid&#39;</span><span>)</span><span>)</span><span>;</span>

<span>// Does not match: return -1</span>
<span>console</span><span>.</span><span>log</span><span>(</span><span>&#34;trieContainer.matches(anotherTrie, &#39;www.example.org&#39;)&#34;</span><span>,</span> <span>trieContainer</span><span>.</span><span>matches</span><span>(</span><span>anotherTrie</span><span>,</span> <span>&#39;www.example.org&#39;</span><span>)</span><span>)</span><span>;</span>

<span>// Matches: return 0</span>
<span>console</span><span>.</span><span>log</span><span>(</span><span>&#34;trieContainer.matches(anotherTrie, &#39;foo.invalid&#39;)&#34;</span><span>,</span> <span>trieContainer</span><span>.</span><span>matches</span><span>(</span><span>anotherTrie</span><span>,</span> <span>&#39;foo.invalid&#39;</span><span>)</span><span>)</span><span>;</span></pre></div>
<p>The <code>reset()</code> method must be used to remove all the tries from a trie container,
you can&#39;t remove a single trie from the container.</p>

<p>When you reset a trie container, you can&#39;t use the reference to prior instances
of trie, i.e. <code>aTrie</code> and <code>anotherTrie</code> are no longer valid and shouldn&#39;t be
used following a reset.</p>
</div></article></div></div>
  </body>
</html>
