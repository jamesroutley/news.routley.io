<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://healeycodes.com/when-im-sad-my-computer-sends-me-a-cat">Original</a>
    <h1>I wrote a program that sends cats to my phone when I&#39;m sad at the computer</h1>
    
    <div id="readability-page-1" class="page"><div><div><p>I wrote a program that sends cats to my phone when I&#39;m sad at the computer. I was inspired by a tweet I saw last week. I&#39;ve lost the link but, to paraphrase, it went something like this:</p><blockquote><p>I&#39;m okay submitting myself to The Algorithm as long as it knows when I&#39;m sad and forwards cats directly to my face</p></blockquote><p>I figured that you could probably solve this problem locally without leaking any personal data.</p><center>
<p><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%27375%27%20height=%27667%27/%3e"/></span><img alt="A notification on my phone of &#34;Marcus&#34;, a cat, who &#34;needs my attention&#34;." srcset="/_next/image?url=%2Fposts%2Fwhen-im-sad-my-computer-sends-me-a-cat%2Fcatalert2.png&amp;w=384&amp;q=100 1x, /_next/image?url=%2Fposts%2Fwhen-im-sad-my-computer-sends-me-a-cat%2Fcatalert2.png&amp;w=750&amp;q=100 2x" src="https://healeycodes.com/_next/image?url=%2Fposts%2Fwhen-im-sad-my-computer-sends-me-a-cat%2Fcatalert2.png&amp;w=750&amp;q=100" decoding="async" data-nimg="intrinsic"/></span></p></center><p>Our computers are fast enough that we can run machine learning models in a browser in the background, maybe without even noticing. I tried out a few different JavaScript face recognition libraries that came prepackaged with trained models, and evaluated them by the following criteria:</p><ul><li>Is there example code I can easily hack on?</li><li>Does it accurately reporting when I&#39;m frowning, furrowing, or furious?</li></ul><p>I went with <a href="https://github.com/vladmandic/human">vladmandic/human</a> â€” another strong contender was <a href="https://github.com/justadudewhohacks/face-api.js">justadudewhohacks/face-api.js</a>. Both these libraries provide an API to get the weights of some common emotions.</p><pre><div><div><p><span>[</span><span>&#39;sad&#39;</span><span>,</span><span> </span><span>&#39;angry&#39;</span><span>,</span><span> </span><span>&#39;disgust&#39;</span><span>,</span><span> </span><span>&#39;fear&#39;</span><span>,</span><span> </span><span>&#39;neutral&#39;</span><span>,</span><span> </span><span>&#39;happy&#39;</span><span>,</span><span> </span><span>&#39;surprise&#39;</span><span>]</span></p></div></div></pre><p>I split the emotions into good vs. bad to get a clearer read of my mood. The overall score swings between -1 (very bad) and 1 (very good). I don&#39;t want to be spammed with cats every time I itch my nose and trigger a frame of video that&#39;s interpreted as negative so I added a three-second trailing average to look for prolonged periods of negative emotion. There&#39;s also a timeout of five minutes after sending a cat before it starts checking again.</p><p>You can see some of the emotion scores below in the debug console I added.</p><p><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%27725%27%20height=%27415.5693261037955%27/%3e"/></span><img alt="Side by side comparison of the debug log when I&#39;m happy vs. when I&#39;m sad." srcset="/_next/image?url=%2Fposts%2Fwhen-im-sad-my-computer-sends-me-a-cat%2Fhappysad.png&amp;w=750&amp;q=100 1x, /_next/image?url=%2Fposts%2Fwhen-im-sad-my-computer-sends-me-a-cat%2Fhappysad.png&amp;w=1920&amp;q=100 2x" src="https://healeycodes.com/_next/image?url=%2Fposts%2Fwhen-im-sad-my-computer-sends-me-a-cat%2Fhappysad.png&amp;w=1920&amp;q=100" decoding="async" data-nimg="intrinsic"/></span></p><p>I wrote all the frontend code in an <code>index.html</code> file for the prototype. The main loop runs at 30-40FPS on a decade-old desktop (it reads emotion accurately at far lower FPS and should probably be capped to save resources).</p><pre><div><div><p><span>function</span><span> </span><span>main</span><span>(</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>    </span><span>const</span><span> config </span><span>=</span><span> </span><span>{</span><span> backend</span><span>:</span><span> </span><span>&#39;webgl&#39;</span><span> </span><span>}</span><span></span></p><p><span>    </span><span>const</span><span> human </span><span>=</span><span> </span><span>new</span><span> </span><span>Human</span><span>.</span><span>Human</span><span>(</span><span>config</span><span>)</span><span></span></p><p><span>    </span><span>async</span><span> </span><span>function</span><span> </span><span>detectVideo</span><span>(</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>        </span><span>// `inputVideo` is a video of a webcam stream</span><span></span></p><p><span>        </span><span>const</span><span> result </span><span>=</span><span> </span><span>await</span><span> human</span><span>.</span><span>detect</span><span>(</span><span>inputVideo</span><span>)</span><span></span></p><p><span>        </span><span>// `result` contains an array of faces along with emotion weights</span><span></span></p><p><span>        </span><span>handleResult</span><span>(</span><span>result</span><span>)</span><span></span></p><p><span>        </span><span>requestAnimationFrame</span><span>(</span><span>detectVideo</span><span>)</span><span></span></p><p><span>    </span><span>}</span><span></span></p><p><span>    </span><span>detectVideo</span><span>(</span><span>)</span><span></span></p><p><span></span><span>}</span></p></div></div></pre><p>The web server runs locally and serves this file and the model data. The full source code is on <a href="https://github.com/healeycodes/if-sad-send-cat">healeycodes/if-sad-send-cat</a>.</p><h2 id="notifications">Notifications</h2><p>I used <a href="https://pushover.net/">Pushover</a> to send notifications to my iPhone. The <a href="https://pushover.net/api">API</a>/docs and <a href="https://support.pushover.net/i44-example-code-and-pushover-libraries">community libraries</a> are delightful, and there&#39;s a one month free trial (no credit card required, etc). I had heard of programmers using Pushover as part of different home automation projects and was keen to try it out.</p><p>Here&#39;s how I send a message and an image from <code>server.py</code>:</p><pre><div><div><p><span>r </span><span>=</span><span> requests</span><span>.</span><span>post</span><span>(</span><span></span></p><p><span>    </span><span>&#34;https://api.pushover.net/1/messages.json&#34;</span><span>,</span><span></span></p><p><span>    data</span><span>=</span><span>{</span><span></span></p><p><span>        </span><span>&#34;token&#34;</span><span>:</span><span> token</span><span>,</span><span></span></p><p><span>        </span><span>&#34;user&#34;</span><span>:</span><span> user</span><span>,</span><span></span></p><p><span>        </span><span>&#34;message&#34;</span><span>:</span><span> </span><span>f&#34;</span><span>{</span><span>cat_name</span><span>}</span><span> needs your attention.&#34;</span><span>,</span><span></span></p><p><span>    </span><span>}</span><span>,</span><span></span></p><p><span>    files</span><span>=</span><span>{</span><span>&#34;attachment&#34;</span><span>:</span><span> </span><span>(</span><span>f&#34;</span><span>{</span><span>cat_name</span><span>}</span><span>&#34;</span><span>,</span><span> </span><span>open</span><span>(</span><span>cat_picture</span><span>,</span><span> </span><span>&#34;rb&#34;</span><span>)</span><span>,</span><span> </span><span>&#34;image/jpeg&#34;</span><span>)</span><span>}</span><span>,</span><span></span></p><p><span></span><span>)</span></p></div></div></pre><p>You&#39;d think that I would be most impressed by my computer being able to read the emotions from my face but I actually think Pushover is the coolest part of this project. The phrase &#34;it just works&#34; is over-used but I found Pushover to be the real deal. I&#39;m going to use it to replace Slack/email/text alerts in my future projects.</p><h2 id="the-cats">The Cats</h2><p>I glued together two APIs to get the message data. A random name comes from <a href="https://randomuser.me/api/">https://randomuser.me/api/</a> and a random cat image is downloaded from <a href="https://api.thecatapi.com/v1/images/search">https://api.thecatapi.com/v1/images/search</a>. I actually need to download and resize the images because The Cat API (Cats as a Service) seems committed to providing very high resolution felines (we&#39;re talking 5MB+). Which is how I ended up with this cutely-named function:</p><pre><div><div><p><span>def</span><span> </span><span>shrink_cat</span><span>(</span><span>path</span><span>)</span><span>:</span><span></span></p><p><span>    image </span><span>=</span><span> Image</span><span>.</span><span>open</span><span>(</span><span>path</span><span>)</span><span></span></p><p><span>    image</span><span>.</span><span>thumbnail</span><span>(</span><span>(</span><span>400</span><span>,</span><span> </span><span>400</span><span>)</span><span>)</span><span></span></p><p><span>    image</span><span>.</span><span>save</span><span>(</span><span>path</span><span>)</span></p></div></div></pre><p>I used Python&#39;s <code>SimpleHTTPRequestHandler</code> to serve my static files. This is the same server that runs when you serve files with the famous one-liner <code>python -m http.server</code>.</p><p>My plan was to have no backend running for this, and while that&#39;s still an achievable goal, I found it quicker to write the API glue code in Python. When I realised that I needed an API route to handle the &#34;send cat&#34; event I was about to install Flask when I realised I could just .. keep on using this simple server by adding this hack:</p><pre><div><div><p><span>class</span><span> </span><span>HttpRequestHandler</span><span>(</span><span>http</span><span>.</span><span>server</span><span>.</span><span>SimpleHTTPRequestHandler</span><span>)</span><span>:</span><span></span></p><p><span>    </span><span># future employers, please look away</span><span></span></p><p><span>    </span><span># while I override this function</span><span></span></p><p><span>    </span><span>def</span><span> </span><span>translate_path</span><span>(</span><span>self</span><span>,</span><span> path</span><span>)</span><span>:</span><span></span></p><p><span>        </span><span>if</span><span> path </span><span>==</span><span> </span><span>&#34;/web/cat.json&#34;</span><span>:</span><span></span></p><p><span>            send_cat</span><span>(</span><span>)</span><span></span></p><p><span>        </span><span>return</span><span> </span><span>super</span><span>(</span><span>)</span><span>.</span><span>translate_path</span><span>(</span><span>path</span><span>)</span></p></div></div></pre><h2 id="whats-your-plan-with-the-emotion-tracking">What&#39;s Your Plan With The Emotion Tracking?</h2><p>My original idea was to track my emotions and which programming language I was currently editing. So I might work on that next.</p><p>Prepare yourself for a future blog post with one of the following empirical titles:</p><ul><li>I&#39;m more surprised when I&#39;m writing JavaScript instead of TypeScript</li><li>Python Just Makes Me Happy</li><li>YAML Makes Me Feel Fear</li></ul></div></div></div>
  </body>
</html>
