<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://netflixtechblog.com/netflixs-distributed-counter-abstraction-8d0c45eb66b2">Original</a>
    <h1>Netflix&#39;s Distributed Counter Abstraction</h1>
    
    <div id="readability-page-1" class="page"><section><div><div><div><div><div><div><div><div><div><div><div><div><div aria-hidden="false"><a href="https://netflixtechblog.medium.com" rel="noopener follow"><div><div><p><img alt="Netflix Technology Blog" src="https://miro.medium.com/v2/resize:fill:88:88/1*BJWRqfSMf9Da9vsXG9EBRQ.jpeg" width="44" height="44" loading="lazy" data-testid="authorPhoto"/></p></div></div></a></div></div><div><div><div aria-hidden="false"><a href="https://netflixtechblog.com" rel="noopener  ugc nofollow"><div><div><p><img alt="Netflix TechBlog" src="https://miro.medium.com/v2/resize:fill:48:48/1*ty4NvNrGg4ReETxqU2N3Og.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto"/></p></div></div></a></div></div></div></div></div></div></div></div></div></div><p id="f7ea">By: <a href="https://www.linkedin.com/in/rajiv-shringi/" rel="noopener ugc nofollow" target="_blank">Rajiv Shringi</a>, <a href="https://www.linkedin.com/in/oleksii-tkachuk-98b47375/" rel="noopener ugc nofollow" target="_blank">Oleksii Tkachuk</a>, <a href="https://www.linkedin.com/in/kartik894/" rel="noopener ugc nofollow" target="_blank">Kartik Sathyanarayanan</a></p><p id="41fb">In our previous blog post, we introduced <a rel="noopener ugc nofollow" target="_blank" href="https://netflixtechblog.com/introducing-netflix-timeseries-data-abstraction-layer-31552f6326f8">Netflix’s TimeSeries Abstraction</a>, a distributed service designed to store and query large volumes of temporal event data with low millisecond latencies. Today, we’re excited to present the <strong>Distributed Counter Abstraction</strong>. This counting service, built on top of the TimeSeries Abstraction, enables distributed counting at scale while maintaining similar low latency performance. As with all our abstractions, we use our <a href="https://netflixtechblog.medium.com/data-gateway-a-platform-for-growing-and-protecting-the-data-tier-f1ed8db8f5c6" rel="noopener">Data Gateway Control Plane</a> to shard, configure, and deploy this service globally.</p><p id="aebc">Distributed counting is a challenging problem in computer science. In this blog post, we’ll explore the diverse counting requirements at Netflix, the challenges of achieving accurate counts in near real-time, and the rationale behind our chosen approach, including the necessary trade-offs.</p><p id="fb3c"><strong>Note</strong>: <em>When it comes to distributed counters, terms such as ‘accurate’ or ‘precise’ should be taken with a grain of salt. In this context, they refer to a count very close to accurate, presented with minimal delays.</em></p><p id="1e4f">At Netflix, our counting use cases include tracking millions of user interactions, monitoring how often specific features or experiences are shown to users, and counting multiple facets of data during <a rel="noopener ugc nofollow" target="_blank" href="https://netflixtechblog.com/its-all-a-bout-testing-the-netflix-experimentation-platform-4e1ca458c15">A/B test experiments</a>, among others.</p><p id="e35a">At Netflix, these use cases can be classified into two broad categories:</p><ol><li id="fc33"><strong>Best-Effort</strong>: For this category, the count doesn’t have to be very accurate or durable. However, this category requires near-immediate access to the current count at low latencies, all while keeping infrastructure costs to a minimum.</li><li id="d9a3"><strong>Eventually Consistent</strong>: This category needs accurate and durable counts, and is willing to tolerate a slight delay in accuracy and a slightly higher infrastructure cost as a trade-off.</li></ol><p id="7d8e">Both categories share common requirements, such as high throughput and high availability. The table below provides a detailed overview of the diverse requirements across these two categories.</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*_Mx2WRBWOfASpK_e2xgoVw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*_Mx2WRBWOfASpK_e2xgoVw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*_Mx2WRBWOfASpK_e2xgoVw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*_Mx2WRBWOfASpK_e2xgoVw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*_Mx2WRBWOfASpK_e2xgoVw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*_Mx2WRBWOfASpK_e2xgoVw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Mx2WRBWOfASpK_e2xgoVw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*_Mx2WRBWOfASpK_e2xgoVw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*_Mx2WRBWOfASpK_e2xgoVw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*_Mx2WRBWOfASpK_e2xgoVw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*_Mx2WRBWOfASpK_e2xgoVw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*_Mx2WRBWOfASpK_e2xgoVw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*_Mx2WRBWOfASpK_e2xgoVw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*_Mx2WRBWOfASpK_e2xgoVw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="494" loading="lazy" role="presentation"/></picture></div></div></figure><p id="16d7">To meet the outlined requirements, the Counter Abstraction was designed to be highly configurable. It allows users to choose between different counting modes, such as <strong>Best-Effort</strong> or <strong>Eventually Consistent</strong>, while considering the documented trade-offs of each option. After selecting a mode, users can interact with APIs without needing to worry about the underlying storage mechanisms and counting methods.</p><p id="0799">Let’s take a closer look at the structure and functionality of the API.</p><p id="0433">Counters are organized into separate namespaces that users set up for each of their specific use cases. Each namespace can be configured with different parameters, such as Type of Counter, Time-To-Live (TTL), and Counter Cardinality, using the service’s Control Plane.</p><p id="cc02">The Counter Abstraction API resembles Java’s <a href="https://docs.oracle.com/en/java/javase/22/docs/api/java.base/java/util/concurrent/atomic/AtomicInteger.html" rel="noopener ugc nofollow" target="_blank">AtomicInteger</a> interface:</p><p id="d3f4"><strong>AddCount/AddAndGetCount</strong>: Adjusts the count for the specified counter by the given delta value within a dataset. The delta value can be positive or negative. The <em>AddAndGetCount</em> counterpart also returns the count after performing the add operation.</p><pre><span id="537a">{</span></pre><p id="2e22">The idempotency token can be used for counter types that support them. Clients can use this token to safely retry or <a href="https://research.google/pubs/the-tail-at-scale/" rel="noopener ugc nofollow" target="_blank">hedge</a> their requests. Failures in a distributed system are a given, and having the ability to safely retry requests enhances the reliability of the service.</p><p id="b098"><strong>GetCount</strong>: Retrieves the count value of the specified counter within a dataset.</p><pre><span id="690a">{</span></pre><p id="a50d"><strong>ClearCount</strong>: Effectively resets the count to 0 for the specified counter within a dataset.</p><pre><span id="f7fa">{</span></pre><p id="560d">Now, let’s look at the different types of counters supported within the Abstraction.</p><p id="0ea6">The service primarily supports two types of counters: <strong>Best-Effort</strong> and <strong>Eventually Consistent</strong>, along with a third experimental type: <strong>Accurate</strong>. In the following sections, we’ll describe the different approaches for these types of counters and the trade-offs associated with each.</p><p id="1497">This type of counter is powered by <a rel="noopener ugc nofollow" target="_blank" href="https://netflixtechblog.com/announcing-evcache-distributed-in-memory-datastore-for-cloud-c26a698c27f7">EVCache</a>, Netflix’s distributed caching solution built on the widely popular <a href="https://memcached.org/" rel="noopener ugc nofollow" target="_blank">Memcached</a>. It is suitable for use cases like A/B experiments, where many concurrent experiments are run for relatively short durations and an approximate count is sufficient. Setting aside the complexities of provisioning, resource allocation, and control plane management, the core of this solution is remarkably straightforward:</p><pre><span id="5b19">// counter cache key</span></pre><p id="70af">EVCache delivers extremely high throughput at low millisecond latency or better within a single region, enabling a multi-tenant setup within a shared cluster, saving infrastructure costs. However, there are some trade-offs: it lacks cross-region replication for the <em>increment</em> operation and does not provide <a href="https://netflix.github.io/EVCache/features/#consistency" rel="noopener ugc nofollow" target="_blank">consistency guarantees</a>, which may be necessary for an accurate count. Additionally, idempotency is not natively supported, making it unsafe to retry or hedge requests.</p><p id="3c43">While some users may accept the limitations of a Best-Effort counter, others opt for precise counts, durability and global availability. In the following sections, we’ll explore various strategies for achieving durable and accurate counts. Our objective is to highlight the challenges inherent in global distributed counting and explain the reasoning behind our chosen approach.</p><p id="e5ff"><strong>Approach 1: Storing a Single Row per Counter</strong></p><p id="f787">Let’s start simple by using a single row per counter key within a table in a globally replicated datastore.</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/0*X6k4-4N36IQ5yEPe 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*X6k4-4N36IQ5yEPe 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*X6k4-4N36IQ5yEPe 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*X6k4-4N36IQ5yEPe 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*X6k4-4N36IQ5yEPe 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*X6k4-4N36IQ5yEPe 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*X6k4-4N36IQ5yEPe 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*X6k4-4N36IQ5yEPe 640w, https://miro.medium.com/v2/resize:fit:720/0*X6k4-4N36IQ5yEPe 720w, https://miro.medium.com/v2/resize:fit:750/0*X6k4-4N36IQ5yEPe 750w, https://miro.medium.com/v2/resize:fit:786/0*X6k4-4N36IQ5yEPe 786w, https://miro.medium.com/v2/resize:fit:828/0*X6k4-4N36IQ5yEPe 828w, https://miro.medium.com/v2/resize:fit:1100/0*X6k4-4N36IQ5yEPe 1100w, https://miro.medium.com/v2/resize:fit:1400/0*X6k4-4N36IQ5yEPe 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="578" loading="lazy" role="presentation"/></picture></div></div></figure><p id="ca59">Let’s examine some of the drawbacks of this approach:</p><ul><li id="61e8"><strong>Lack of Idempotency</strong>: There is no idempotency key baked into the storage data-model preventing users from safely retrying requests. Implementing idempotency would likely require using an external system for such keys, which can further degrade performance or cause race conditions.</li><li id="2b44"><strong>Heavy Contention</strong>: To update counts reliably, every writer must perform a Compare-And-Swap operation for a given counter using locks or transactions. Depending on the throughput and concurrency of operations, this can lead to significant contention, heavily impacting performance.</li></ul><p id="a373"><strong>Secondary Keys</strong>: One way to reduce contention in this approach would be to use a secondary key, such as a <em>bucket_id</em>, which allows for distributing writes by splitting a given counter into <em>buckets</em>, while enabling reads to aggregate across buckets. The challenge lies in determining the appropriate number of buckets. A static number may still lead to contention with <em>hot keys</em>, while dynamically assigning the number of buckets per counter across millions of counters presents a more complex problem.</p><p id="121f">Let’s see if we can iterate on our solution to overcome these drawbacks.</p><p id="875d"><strong>Approach 2: Per Instance Aggregation</strong></p><p id="ca5b">To address issues of hot keys and contention from writing to the same row in real-time, we could implement a strategy where each instance aggregates the counts in memory and then flushes them to disk at regular intervals. Introducing sufficient jitter to the flush process can further reduce contention.</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/0*6iUKbxJ093jJTiYL 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*6iUKbxJ093jJTiYL 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*6iUKbxJ093jJTiYL 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*6iUKbxJ093jJTiYL 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*6iUKbxJ093jJTiYL 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*6iUKbxJ093jJTiYL 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6iUKbxJ093jJTiYL 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*6iUKbxJ093jJTiYL 640w, https://miro.medium.com/v2/resize:fit:720/0*6iUKbxJ093jJTiYL 720w, https://miro.medium.com/v2/resize:fit:750/0*6iUKbxJ093jJTiYL 750w, https://miro.medium.com/v2/resize:fit:786/0*6iUKbxJ093jJTiYL 786w, https://miro.medium.com/v2/resize:fit:828/0*6iUKbxJ093jJTiYL 828w, https://miro.medium.com/v2/resize:fit:1100/0*6iUKbxJ093jJTiYL 1100w, https://miro.medium.com/v2/resize:fit:1400/0*6iUKbxJ093jJTiYL 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="336" loading="lazy" role="presentation"/></picture></div></div></figure><p id="24b1">However, this solution presents a new set of issues:</p><ul><li id="dba3"><strong>Vulnerability to Data Loss</strong>: The solution is vulnerable to data loss for all in-memory data during instance failures, restarts, or deployments.</li><li id="c41b"><strong>Inability to Reliably Reset Counts</strong>: Due to counting requests being distributed across multiple machines, it is challenging to establish consensus on the exact point in time when a counter reset occurred.</li><li id="2535"><strong>Lack of Idempotency: </strong>Similar to the previous approach, this method does not natively guarantee idempotency. One way to achieve idempotency is by consistently routing the same set of counters to the same instance. However, this approach may introduce additional complexities, such as leader election, and potential challenges with availability and latency in the write path.</li></ul><p id="038c">That said, this approach may still be suitable in scenarios where these trade-offs are acceptable. However, let’s see if we can address some of these issues with a different event-based approach.</p><p id="f599"><strong>Approach 3: Using Durable Queues</strong></p><p id="7eb6">In this approach, we log counter events into a durable queuing system like <a href="https://kafka.apache.org/" rel="noopener ugc nofollow" target="_blank">Apache Kafka</a> to prevent any potential data loss. By creating multiple topic partitions and hashing the counter key to a specific partition, we ensure that the same set of counters are processed by the same set of consumers. This setup simplifies facilitating idempotency checks and resetting counts. Furthermore, by leveraging additional stream processing frameworks such as <a href="https://kafka.apache.org/documentation/streams/" rel="noopener ugc nofollow" target="_blank">Kafka Streams</a> or <a href="https://flink.apache.org/" rel="noopener ugc nofollow" target="_blank">Apache Flink</a>, we can implement windowed aggregations.</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/0*mQikuGyuzZ_lT7Y4 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*mQikuGyuzZ_lT7Y4 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*mQikuGyuzZ_lT7Y4 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*mQikuGyuzZ_lT7Y4 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*mQikuGyuzZ_lT7Y4 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*mQikuGyuzZ_lT7Y4 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mQikuGyuzZ_lT7Y4 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*mQikuGyuzZ_lT7Y4 640w, https://miro.medium.com/v2/resize:fit:720/0*mQikuGyuzZ_lT7Y4 720w, https://miro.medium.com/v2/resize:fit:750/0*mQikuGyuzZ_lT7Y4 750w, https://miro.medium.com/v2/resize:fit:786/0*mQikuGyuzZ_lT7Y4 786w, https://miro.medium.com/v2/resize:fit:828/0*mQikuGyuzZ_lT7Y4 828w, https://miro.medium.com/v2/resize:fit:1100/0*mQikuGyuzZ_lT7Y4 1100w, https://miro.medium.com/v2/resize:fit:1400/0*mQikuGyuzZ_lT7Y4 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="437" loading="lazy" role="presentation"/></picture></div></div></figure><p id="25bf">However, this approach comes with some challenges:</p><ul><li id="708e"><strong>Potential Delays</strong>: Having the same consumer process all the counts from a given partition can lead to backups and delays, resulting in stale counts.</li><li id="f448"><strong>Rebalancing Partitions</strong>: This approach requires auto-scaling and rebalancing of topic partitions as the cardinality of counters and throughput increases.</li></ul><p id="5f3d">Furthermore, all approaches that pre-aggregate counts make it challenging to support two of our requirements for accurate counters:</p><ul><li id="5818"><strong>Auditing of Counts</strong>: Auditing involves extracting data to an offline system for analysis to ensure that increments were applied correctly to reach the final value. This process can also be used to track the provenance of increments. However, auditing becomes infeasible when counts are aggregated without storing the individual increments.</li><li id="51be"><strong>Potential Recounting</strong>: Similar to auditing, if adjustments to increments are necessary and recounting of events within a time window is required, pre-aggregating counts makes this infeasible.</li></ul><p id="ccda">Barring those few requirements, this approach can still be effective if we determine the right way to scale our queue partitions and consumers while maintaining idempotency. However, let’s explore how we can adjust this approach to meet the auditing and recounting requirements.</p><p id="83bd"><strong>Approach 4: Event Log of Individual Increments</strong></p><p id="57ab">In this approach, we log each individual counter increment along with its <strong>event_time</strong> and <strong>event_id</strong>. The event_id can include the source information of where the increment originated. The combination of event_time and event_id can also serve as the idempotency key for the write.</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/0*0wKFK7xyTHnEKIhO 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*0wKFK7xyTHnEKIhO 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*0wKFK7xyTHnEKIhO 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*0wKFK7xyTHnEKIhO 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*0wKFK7xyTHnEKIhO 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*0wKFK7xyTHnEKIhO 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0wKFK7xyTHnEKIhO 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*0wKFK7xyTHnEKIhO 640w, https://miro.medium.com/v2/resize:fit:720/0*0wKFK7xyTHnEKIhO 720w, https://miro.medium.com/v2/resize:fit:750/0*0wKFK7xyTHnEKIhO 750w, https://miro.medium.com/v2/resize:fit:786/0*0wKFK7xyTHnEKIhO 786w, https://miro.medium.com/v2/resize:fit:828/0*0wKFK7xyTHnEKIhO 828w, https://miro.medium.com/v2/resize:fit:1100/0*0wKFK7xyTHnEKIhO 1100w, https://miro.medium.com/v2/resize:fit:1400/0*0wKFK7xyTHnEKIhO 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="532" loading="lazy" role="presentation"/></picture></div></div></figure><p id="e421">However, <em>in its simplest form</em>, this approach has several drawbacks:</p><ul><li id="1932"><strong>Read Latency</strong>: Each read request requires scanning all increments for a given counter potentially degrading performance.</li><li id="5891"><strong>Duplicate Work</strong>: Multiple threads might duplicate the effort of aggregating the same set of counters during read operations, leading to wasted effort and subpar resource utilization.</li><li id="973d"><strong>Wide Partitions</strong>: If using a datastore like <a href="https://cassandra.apache.org/_/index.html" rel="noopener ugc nofollow" target="_blank">Apache Cassandra</a>, storing many increments for the same counter could lead to a <a href="https://thelastpickle.com/blog/2019/01/11/wide-partitions-cassandra-3-11.html" rel="noopener ugc nofollow" target="_blank">wide partition</a>, affecting read performance.</li><li id="21ef"><strong>Large Data Footprint</strong>: Storing each increment individually could also result in a substantial data footprint over time. Without an efficient data retention strategy, this approach may struggle to scale effectively.</li></ul><p id="e879">The combined impact of these issues can lead to increased infrastructure costs that may be difficult to justify. However, adopting an event-driven approach seems to be a significant step forward in addressing some of the challenges we’ve encountered and meeting our requirements.</p><p id="04e4">How can we improve this solution further?</p><p id="0918">We use a combination of the previous approaches, where we log each counting activity as an event, and continuously aggregate these events in the background using queues and a sliding time window. Additionally, we employ a bucketing strategy to prevent wide partitions. In the following sections, we’ll explore how this approach addresses the previously mentioned drawbacks and meets all our requirements.</p><p id="ff08"><strong>Note</strong>: <em>From here on, we will use the words “</em><strong><em>rollup</em></strong><em>” and “</em><strong><em>aggregate</em></strong><em>” interchangeably. They essentially mean the same thing, i.e., collecting individual counter increments/decrements and arriving at the final value.</em></p><p id="68cd"><strong>TimeSeries Event Store:</strong></p><p id="aa41">We chose the <a rel="noopener ugc nofollow" target="_blank" href="https://netflixtechblog.com/introducing-netflix-timeseries-data-abstraction-layer-31552f6326f8">TimeSeries Data Abstraction</a> as our event store, where counter mutations are ingested as event records. Some of the benefits of storing events in TimeSeries include:</p><p id="11da"><strong>High-Performance</strong>: The TimeSeries abstraction already addresses many of our requirements, including high availability and throughput, reliable and fast performance, and more.</p><p id="b03a"><strong>Reducing Code Complexity</strong>: We reduce a lot of code complexity in Counter Abstraction by delegating a major portion of the functionality to an existing service.</p><p id="6c3a">TimeSeries Abstraction uses Cassandra as the underlying event store, but it can be configured to work with any persistent store. Here is what it looks like:</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/0*ge4X7ywSmtizcNE5 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*ge4X7ywSmtizcNE5 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*ge4X7ywSmtizcNE5 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*ge4X7ywSmtizcNE5 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*ge4X7ywSmtizcNE5 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*ge4X7ywSmtizcNE5 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ge4X7ywSmtizcNE5 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*ge4X7ywSmtizcNE5 640w, https://miro.medium.com/v2/resize:fit:720/0*ge4X7ywSmtizcNE5 720w, https://miro.medium.com/v2/resize:fit:750/0*ge4X7ywSmtizcNE5 750w, https://miro.medium.com/v2/resize:fit:786/0*ge4X7ywSmtizcNE5 786w, https://miro.medium.com/v2/resize:fit:828/0*ge4X7ywSmtizcNE5 828w, https://miro.medium.com/v2/resize:fit:1100/0*ge4X7ywSmtizcNE5 1100w, https://miro.medium.com/v2/resize:fit:1400/0*ge4X7ywSmtizcNE5 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="334" loading="lazy" role="presentation"/></picture></div></div></figure><p id="2b96"><strong>Handling Wide Partitions</strong>: The <em>time_bucket</em> and <em>event_bucket</em> columns play a crucial role in breaking up a wide partition, preventing high-throughput counter events from overwhelming a given partition. <em>For more information regarding this, refer to our previous </em><a rel="noopener ugc nofollow" target="_blank" href="https://netflixtechblog.com/introducing-netflix-timeseries-data-abstraction-layer-31552f6326f8"><em>blog</em></a>.</p><p id="3dc8"><strong>No Over-Counting</strong>: The <em>event_time</em>, <em>event_id</em> and <em>event_item_key</em> columns form the idempotency key for the events for a given counter, enabling clients to retry safely without the risk of over-counting.</p><p id="43a9"><strong>Event Ordering</strong>: TimeSeries orders all events in descending order of time allowing us to leverage this property for events like count resets.</p><p id="278b"><strong>Event Retention</strong>: The TimeSeries Abstraction includes retention policies to ensure that events are not stored indefinitely, saving disk space and reducing infrastructure costs. Once events have been aggregated and moved to a more cost-effective store for audits, there’s no need to retain them in the primary storage.</p><p id="f647">Now, let’s see how these events are aggregated for a given counter.</p><p id="5a6c"><strong>Aggregating Count Events:</strong></p><p id="80b9">As mentioned earlier, collecting all individual increments for every read request would be cost-prohibitive in terms of read performance. Therefore, a background aggregation process is necessary to continually converge counts and ensure optimal read performance.</p><p id="2ed6"><em>But how can we safely aggregate count events amidst ongoing write operations?</em></p><p id="0a22">This is where the concept of <em>Eventually Consistent </em>counts becomes crucial. <em>By intentionally lagging behind the current time by a safe margin</em>, we ensure that aggregation always occurs within an immutable window.</p><p id="5460">Lets see what that looks like:</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/0*EOpW-VnA_YZF7KOP 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*EOpW-VnA_YZF7KOP 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*EOpW-VnA_YZF7KOP 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*EOpW-VnA_YZF7KOP 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*EOpW-VnA_YZF7KOP 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*EOpW-VnA_YZF7KOP 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EOpW-VnA_YZF7KOP 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*EOpW-VnA_YZF7KOP 640w, https://miro.medium.com/v2/resize:fit:720/0*EOpW-VnA_YZF7KOP 720w, https://miro.medium.com/v2/resize:fit:750/0*EOpW-VnA_YZF7KOP 750w, https://miro.medium.com/v2/resize:fit:786/0*EOpW-VnA_YZF7KOP 786w, https://miro.medium.com/v2/resize:fit:828/0*EOpW-VnA_YZF7KOP 828w, https://miro.medium.com/v2/resize:fit:1100/0*EOpW-VnA_YZF7KOP 1100w, https://miro.medium.com/v2/resize:fit:1400/0*EOpW-VnA_YZF7KOP 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="470" loading="lazy" role="presentation"/></picture></div></div></figure><p id="a980">Let’s break this down:</p><ul><li id="c8ce"><strong>lastRollupTs</strong>: This represents the most recent time when the counter value was last aggregated. For a counter being operated for the first time, this timestamp defaults to a reasonable time in the past.</li><li id="881b"><strong>Immutable Window and Lag</strong>: Aggregation can only occur safely within an immutable window that is no longer receiving counter events. The “acceptLimit” parameter of the TimeSeries Abstraction plays a crucial role here, as it rejects incoming events with timestamps beyond this limit. During aggregations, this window is pushed slightly further back to account for clock skews.</li></ul><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/0*DbtPCHPWoaauUkDr 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*DbtPCHPWoaauUkDr 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*DbtPCHPWoaauUkDr 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*DbtPCHPWoaauUkDr 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*DbtPCHPWoaauUkDr 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*DbtPCHPWoaauUkDr 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DbtPCHPWoaauUkDr 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*DbtPCHPWoaauUkDr 640w, https://miro.medium.com/v2/resize:fit:720/0*DbtPCHPWoaauUkDr 720w, https://miro.medium.com/v2/resize:fit:750/0*DbtPCHPWoaauUkDr 750w, https://miro.medium.com/v2/resize:fit:786/0*DbtPCHPWoaauUkDr 786w, https://miro.medium.com/v2/resize:fit:828/0*DbtPCHPWoaauUkDr 828w, https://miro.medium.com/v2/resize:fit:1100/0*DbtPCHPWoaauUkDr 1100w, https://miro.medium.com/v2/resize:fit:1400/0*DbtPCHPWoaauUkDr 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="153" loading="lazy" role="presentation"/></picture></div></div></figure><p id="1fee">This does mean that the counter value will lag behind its most recent update by some margin (typically in the order of seconds). <em>This approach does leave the door open for missed events due to cross-region replication issues. See “Future Work” section at the end.</em></p><ul><li id="f593"><strong>Aggregation Process</strong>: The rollup process aggregates all events in the aggregation window <em>since the last rollup </em>to arrive at the new value.</li></ul><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/0*oSHneX5BOi5VNGYM 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*oSHneX5BOi5VNGYM 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*oSHneX5BOi5VNGYM 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*oSHneX5BOi5VNGYM 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*oSHneX5BOi5VNGYM 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*oSHneX5BOi5VNGYM 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*oSHneX5BOi5VNGYM 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*oSHneX5BOi5VNGYM 640w, https://miro.medium.com/v2/resize:fit:720/0*oSHneX5BOi5VNGYM 720w, https://miro.medium.com/v2/resize:fit:750/0*oSHneX5BOi5VNGYM 750w, https://miro.medium.com/v2/resize:fit:786/0*oSHneX5BOi5VNGYM 786w, https://miro.medium.com/v2/resize:fit:828/0*oSHneX5BOi5VNGYM 828w, https://miro.medium.com/v2/resize:fit:1100/0*oSHneX5BOi5VNGYM 1100w, https://miro.medium.com/v2/resize:fit:1400/0*oSHneX5BOi5VNGYM 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="129" loading="lazy" role="presentation"/></picture></div></div></figure><p id="19c8"><strong>Rollup Store:</strong></p><p id="48a1">We save the results of this aggregation in a persistent store. The next aggregation will simply continue from this checkpoint.</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/0*93S_a1YJ6zacuBnn 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*93S_a1YJ6zacuBnn 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*93S_a1YJ6zacuBnn 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*93S_a1YJ6zacuBnn 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*93S_a1YJ6zacuBnn 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*93S_a1YJ6zacuBnn 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*93S_a1YJ6zacuBnn 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*93S_a1YJ6zacuBnn 640w, https://miro.medium.com/v2/resize:fit:720/0*93S_a1YJ6zacuBnn 720w, https://miro.medium.com/v2/resize:fit:750/0*93S_a1YJ6zacuBnn 750w, https://miro.medium.com/v2/resize:fit:786/0*93S_a1YJ6zacuBnn 786w, https://miro.medium.com/v2/resize:fit:828/0*93S_a1YJ6zacuBnn 828w, https://miro.medium.com/v2/resize:fit:1100/0*93S_a1YJ6zacuBnn 1100w, https://miro.medium.com/v2/resize:fit:1400/0*93S_a1YJ6zacuBnn 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="318" loading="lazy" role="presentation"/></picture></div></div></figure><p id="586a">We create one such Rollup table <em>per dataset</em> and use Cassandra as our persistent store. However, as you will soon see in the Control Plane section, the Counter service can be configured to work with any persistent store.</p><p id="18db"><strong>LastWriteTs</strong>: Every time a given counter receives a write, we also log a <strong>last-write-timestamp</strong> as a columnar update in this table. This is done using Cassandra’s <a href="https://docs.datastax.com/en/cql-oss/3.x/cql/cql_reference/cqlInsert.html#cqlInsert__timestamp-value" rel="noopener ugc nofollow" target="_blank">USING TIMESTAMP</a> feature to predictably apply the Last-Write-Win (LWW) semantics. This timestamp is the same as the <em>event_time</em> for the event. In the subsequent sections, we’ll see how this timestamp is used to keep some counters in active rollup circulation until they have caught up to their latest value.</p><p id="336a"><strong>Rollup Cache</strong></p><p id="25be">To optimize read performance, these values are cached in EVCache for each counter. We combine the <strong>lastRollupCount</strong> and <strong>lastRollupTs</strong> <em>into a single cached value per counter</em> to prevent potential mismatches between the count and its corresponding checkpoint timestamp.</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/0*giCU1AtWUYMXHZcI 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*giCU1AtWUYMXHZcI 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*giCU1AtWUYMXHZcI 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*giCU1AtWUYMXHZcI 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*giCU1AtWUYMXHZcI 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*giCU1AtWUYMXHZcI 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*giCU1AtWUYMXHZcI 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*giCU1AtWUYMXHZcI 640w, https://miro.medium.com/v2/resize:fit:720/0*giCU1AtWUYMXHZcI 720w, https://miro.medium.com/v2/resize:fit:750/0*giCU1AtWUYMXHZcI 750w, https://miro.medium.com/v2/resize:fit:786/0*giCU1AtWUYMXHZcI 786w, https://miro.medium.com/v2/resize:fit:828/0*giCU1AtWUYMXHZcI 828w, https://miro.medium.com/v2/resize:fit:1100/0*giCU1AtWUYMXHZcI 1100w, https://miro.medium.com/v2/resize:fit:1400/0*giCU1AtWUYMXHZcI 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="496" loading="lazy" role="presentation"/></picture></div></div></figure><p id="1bbf">But, how do we know which counters to trigger rollups for? Let’s explore our Write and Read path to understand this better.</p><p id="77ab"><strong>Add/Clear Count:</strong></p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/0*wsxgnWH1yR0gHAEL 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*wsxgnWH1yR0gHAEL 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*wsxgnWH1yR0gHAEL 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*wsxgnWH1yR0gHAEL 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*wsxgnWH1yR0gHAEL 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*wsxgnWH1yR0gHAEL 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wsxgnWH1yR0gHAEL 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*wsxgnWH1yR0gHAEL 640w, https://miro.medium.com/v2/resize:fit:720/0*wsxgnWH1yR0gHAEL 720w, https://miro.medium.com/v2/resize:fit:750/0*wsxgnWH1yR0gHAEL 750w, https://miro.medium.com/v2/resize:fit:786/0*wsxgnWH1yR0gHAEL 786w, https://miro.medium.com/v2/resize:fit:828/0*wsxgnWH1yR0gHAEL 828w, https://miro.medium.com/v2/resize:fit:1100/0*wsxgnWH1yR0gHAEL 1100w, https://miro.medium.com/v2/resize:fit:1400/0*wsxgnWH1yR0gHAEL 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="359" loading="lazy" role="presentation"/></picture></div></div></figure><p id="6b09">An <em>add</em> or <em>clear</em> count request writes durably to the TimeSeries Abstraction and updates the last-write-timestamp in the Rollup store. If the durability acknowledgement fails, clients can retry their requests with the same idempotency token without the risk of overcounting.<strong> </strong>Upon durability, we send a <em>fire-and-forget </em>request to trigger the rollup for the request counter.</p><p id="6a87"><strong>GetCount:</strong></p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/0*76pQR6OISx9yuRmi 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*76pQR6OISx9yuRmi 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*76pQR6OISx9yuRmi 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*76pQR6OISx9yuRmi 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*76pQR6OISx9yuRmi 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*76pQR6OISx9yuRmi 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*76pQR6OISx9yuRmi 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*76pQR6OISx9yuRmi 640w, https://miro.medium.com/v2/resize:fit:720/0*76pQR6OISx9yuRmi 720w, https://miro.medium.com/v2/resize:fit:750/0*76pQR6OISx9yuRmi 750w, https://miro.medium.com/v2/resize:fit:786/0*76pQR6OISx9yuRmi 786w, https://miro.medium.com/v2/resize:fit:828/0*76pQR6OISx9yuRmi 828w, https://miro.medium.com/v2/resize:fit:1100/0*76pQR6OISx9yuRmi 1100w, https://miro.medium.com/v2/resize:fit:1400/0*76pQR6OISx9yuRmi 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="359" loading="lazy" role="presentation"/></picture></div></div></figure><p id="23ce">We return the last rolled-up count as<em> a quick point-read operation</em>, accepting the trade-off of potentially delivering a slightly stale count. We also trigger a rollup during the read operation to advance the last-rollup-timestamp, enhancing the performance of <em>subsequent</em> aggregations. This process also <em>self-remediates </em>a stale count if any previous rollups had failed.</p><p id="2bdc">With this approach, the counts<em> continually converge</em> to their latest value. Now, let’s see how we scale this approach to millions of counters and thousands of concurrent operations using our Rollup Pipeline.</p><p id="9ab5"><strong>Rollup Pipeline:</strong></p><p id="c974">Each <strong>Counter-Rollup</strong> server operates a rollup pipeline to efficiently aggregate counts across millions of counters. This is where most of the complexity in Counter Abstraction comes in. In the following sections, we will share key details on how efficient aggregations are achieved.</p><p id="d23a"><strong>Light-Weight Roll-Up Event: </strong>As seen in our Write and Read paths above, every operation on a counter sends a light-weight event to the Rollup server:</p><pre><span id="0c58">rollupEvent: {</span></pre><p id="8d93">Note that this event does not include the increment. This is only an indication to the Rollup server that this counter has been accessed and now needs to be aggregated. Knowing exactly which specific counters need to be aggregated prevents scanning the entire event dataset for the purpose of aggregations.</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/0*Yusg6kC9Jj9ayjbi 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*Yusg6kC9Jj9ayjbi 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*Yusg6kC9Jj9ayjbi 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*Yusg6kC9Jj9ayjbi 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*Yusg6kC9Jj9ayjbi 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*Yusg6kC9Jj9ayjbi 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Yusg6kC9Jj9ayjbi 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*Yusg6kC9Jj9ayjbi 640w, https://miro.medium.com/v2/resize:fit:720/0*Yusg6kC9Jj9ayjbi 720w, https://miro.medium.com/v2/resize:fit:750/0*Yusg6kC9Jj9ayjbi 750w, https://miro.medium.com/v2/resize:fit:786/0*Yusg6kC9Jj9ayjbi 786w, https://miro.medium.com/v2/resize:fit:828/0*Yusg6kC9Jj9ayjbi 828w, https://miro.medium.com/v2/resize:fit:1100/0*Yusg6kC9Jj9ayjbi 1100w, https://miro.medium.com/v2/resize:fit:1400/0*Yusg6kC9Jj9ayjbi 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="284" loading="lazy" role="presentation"/></picture></div></div></figure><p id="0e5d"><strong>In-Memory Rollup Queues:</strong> A given Rollup server instance runs a set of <em>in-memory</em> queues to receive rollup events and parallelize aggregations. In the first version of this service, we settled on using in-memory queues to reduce provisioning complexity, save on infrastructure costs, and make rebalancing the number of queues fairly straightforward. However, this comes with the trade-off of potentially missing rollup events in case of an instance crash. For more details, see the “Stale Counts” section in “Future Work.”</p><p id="0d6d"><strong>Minimize Duplicate Effort</strong>: We use a fast non-cryptographic hash like <a href="https://xxhash.com/" rel="noopener ugc nofollow" target="_blank">XXHash</a> to ensure that the same set of counters end up on the same queue. Further, we try to minimize the amount of duplicate aggregation work by having a separate rollup stack that chooses to run <em>fewer</em> <em>beefier</em> instances.</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/0*u3p0kGfuwvK5mP_j 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*u3p0kGfuwvK5mP_j 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*u3p0kGfuwvK5mP_j 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*u3p0kGfuwvK5mP_j 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*u3p0kGfuwvK5mP_j 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*u3p0kGfuwvK5mP_j 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*u3p0kGfuwvK5mP_j 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*u3p0kGfuwvK5mP_j 640w, https://miro.medium.com/v2/resize:fit:720/0*u3p0kGfuwvK5mP_j 720w, https://miro.medium.com/v2/resize:fit:750/0*u3p0kGfuwvK5mP_j 750w, https://miro.medium.com/v2/resize:fit:786/0*u3p0kGfuwvK5mP_j 786w, https://miro.medium.com/v2/resize:fit:828/0*u3p0kGfuwvK5mP_j 828w, https://miro.medium.com/v2/resize:fit:1100/0*u3p0kGfuwvK5mP_j 1100w, https://miro.medium.com/v2/resize:fit:1400/0*u3p0kGfuwvK5mP_j 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="440" loading="lazy" role="presentation"/></picture></div></div></figure><p id="223c"><strong>Availability and Race Conditions: </strong>Having a single Rollup server instance can minimize duplicate aggregation work but may create availability challenges for triggering rollups. <em>If</em> we choose to horizontally scale the Rollup servers, we allow threads to overwrite rollup values while avoiding any form of distributed locking mechanisms to maintain high availability and performance. This approach remains safe because aggregation occurs within an immutable window. Although the concept of <em>now()</em> may differ between threads, causing rollup values to sometimes fluctuate, the counts will eventually converge to an accurate value within each immutable aggregation window.</p><p id="acf2"><strong>Rebalancing Queues</strong>: If we need to scale the number of queues, a simple Control Plane configuration update followed by a re-deploy is enough to rebalance the number of queues.</p><pre><span id="845c">      &#34;eventual_counter_config&#34;: {             </span></pre><p id="3a8b"><strong>Handling Deployments</strong>: During deployments, these queues shut down gracefully, draining all existing events first, while the new Rollup server instance starts up with potentially new queue configurations. There may be a brief period when both the old and new Rollup servers are active, but as mentioned before, this race condition is managed since aggregations occur within immutable windows.</p><p id="a67a"><strong>Minimize Rollup Effort</strong>: Receiving multiple events for the same counter doesn’t mean rolling it up multiple times. We drain these rollup events into a Set, ensuring <em>a given counter is rolled up only once</em> <em>during a rollup window</em>.</p><p id="c500"><strong>Efficient Aggregation: </strong>Each rollup consumer processes a batch of counters simultaneously. Within each batch, it queries the underlying TimeSeries abstraction in parallel to aggregate events within specified time boundaries. The TimeSeries abstraction optimizes these range scans to achieve low millisecond latencies.</p><p id="fea5"><strong>Dynamic Batching</strong>: The Rollup server dynamically adjusts the number of time partitions that need to be scanned based on cardinality of counters in order to prevent overwhelming the underlying store with many parallel read requests.</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/0*hoPpSmQeScn87q0U 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*hoPpSmQeScn87q0U 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*hoPpSmQeScn87q0U 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*hoPpSmQeScn87q0U 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*hoPpSmQeScn87q0U 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*hoPpSmQeScn87q0U 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hoPpSmQeScn87q0U 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*hoPpSmQeScn87q0U 640w, https://miro.medium.com/v2/resize:fit:720/0*hoPpSmQeScn87q0U 720w, https://miro.medium.com/v2/resize:fit:750/0*hoPpSmQeScn87q0U 750w, https://miro.medium.com/v2/resize:fit:786/0*hoPpSmQeScn87q0U 786w, https://miro.medium.com/v2/resize:fit:828/0*hoPpSmQeScn87q0U 828w, https://miro.medium.com/v2/resize:fit:1100/0*hoPpSmQeScn87q0U 1100w, https://miro.medium.com/v2/resize:fit:1400/0*hoPpSmQeScn87q0U 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="557" loading="lazy" role="presentation"/></picture></div></div></figure><p id="9446"><strong>Adaptive Back-Pressure</strong>: Each consumer waits for one batch to complete before issuing the rollups for the next batch. It adjusts the wait time between batches based on the performance of the previous batch. This approach provides back-pressure during rollups to prevent overwhelming the underlying TimeSeries store.</p><p id="2693"><strong>Handling Convergence</strong>:</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/0*-hlw324cMUaC6pQJ 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*-hlw324cMUaC6pQJ 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*-hlw324cMUaC6pQJ 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*-hlw324cMUaC6pQJ 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*-hlw324cMUaC6pQJ 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*-hlw324cMUaC6pQJ 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-hlw324cMUaC6pQJ 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*-hlw324cMUaC6pQJ 640w, https://miro.medium.com/v2/resize:fit:720/0*-hlw324cMUaC6pQJ 720w, https://miro.medium.com/v2/resize:fit:750/0*-hlw324cMUaC6pQJ 750w, https://miro.medium.com/v2/resize:fit:786/0*-hlw324cMUaC6pQJ 786w, https://miro.medium.com/v2/resize:fit:828/0*-hlw324cMUaC6pQJ 828w, https://miro.medium.com/v2/resize:fit:1100/0*-hlw324cMUaC6pQJ 1100w, https://miro.medium.com/v2/resize:fit:1400/0*-hlw324cMUaC6pQJ 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="447" loading="lazy" role="presentation"/></picture></div></div></figure><p id="da2c">In order to prevent <strong>low-cardinality</strong> counters from lagging behind too much and subsequently scanning too many time partitions, they are kept in constant rollup circulation. For <strong>high-cardinality</strong> counters, continuously circulating them would consume excessive memory in our Rollup queues. This is where the <strong>last-write-timestamp</strong> mentioned previously plays a crucial role. The Rollup server inspects this timestamp to determine if a given counter needs to be re-queued, ensuring that we continue aggregating until it has fully caught up with the writes.</p><p id="af9d">Now, let’s see how we leverage this counter type to provide an up-to-date current count in near-realtime.</p><p id="8e14">We are experimenting with a slightly modified version of the Eventually Consistent counter. Again, take the term ‘Accurate’ with a grain of salt. The key difference between this type of counter and its counterpart is that the <em>delta</em>, representing the counts since the last-rolled-up timestamp, is computed in real-time.</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/0*FVOlMO0VgrQoVBBi 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*FVOlMO0VgrQoVBBi 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*FVOlMO0VgrQoVBBi 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*FVOlMO0VgrQoVBBi 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*FVOlMO0VgrQoVBBi 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*FVOlMO0VgrQoVBBi 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*FVOlMO0VgrQoVBBi 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*FVOlMO0VgrQoVBBi 640w, https://miro.medium.com/v2/resize:fit:720/0*FVOlMO0VgrQoVBBi 720w, https://miro.medium.com/v2/resize:fit:750/0*FVOlMO0VgrQoVBBi 750w, https://miro.medium.com/v2/resize:fit:786/0*FVOlMO0VgrQoVBBi 786w, https://miro.medium.com/v2/resize:fit:828/0*FVOlMO0VgrQoVBBi 828w, https://miro.medium.com/v2/resize:fit:1100/0*FVOlMO0VgrQoVBBi 1100w, https://miro.medium.com/v2/resize:fit:1400/0*FVOlMO0VgrQoVBBi 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="290" loading="lazy" role="presentation"/></picture></div></div></figure><p id="a925">Aggregating this delta in real-time can impact the performance of this operation, depending on the number of events and partitions that need to be scanned to retrieve this delta. The same principle of rolling up in batches applies here to prevent scanning too many partitions in parallel.</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/0*M3dbSof98dTfeuNe 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*M3dbSof98dTfeuNe 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*M3dbSof98dTfeuNe 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*M3dbSof98dTfeuNe 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*M3dbSof98dTfeuNe 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*M3dbSof98dTfeuNe 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*M3dbSof98dTfeuNe 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*M3dbSof98dTfeuNe 640w, https://miro.medium.com/v2/resize:fit:720/0*M3dbSof98dTfeuNe 720w, https://miro.medium.com/v2/resize:fit:750/0*M3dbSof98dTfeuNe 750w, https://miro.medium.com/v2/resize:fit:786/0*M3dbSof98dTfeuNe 786w, https://miro.medium.com/v2/resize:fit:828/0*M3dbSof98dTfeuNe 828w, https://miro.medium.com/v2/resize:fit:1100/0*M3dbSof98dTfeuNe 1100w, https://miro.medium.com/v2/resize:fit:1400/0*M3dbSof98dTfeuNe 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="239" loading="lazy" role="presentation"/></picture></div></div></figure><p id="3b68">Conversely, if the counters in this dataset are<em> </em>accessed<em> </em>frequently, the time gap for the delta remains narrow, making this approach of fetching current counts quite effective.</p><p id="49a2">Now, let’s see how all this complexity is managed by having a unified Control Plane configuration.</p><p id="47f1">The <a href="https://netflixtechblog.medium.com/data-gateway-a-platform-for-growing-and-protecting-the-data-tier-f1ed8db8f5c6" rel="noopener">Data Gateway Platform Control Plane</a> manages control settings for all abstractions and namespaces, including the Counter Abstraction. Below, is an example of a control plane configuration for a namespace that supports eventually consistent counters with low cardinality:</p><pre><span id="f298">&#34;persistence_configuration&#34;: [</span></pre><p id="9fd9">Using such a control plane configuration, we compose multiple abstraction layers using containers deployed on the same host, with each container fetching configuration specific to its scope.</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/0*4MdrlEjWg2MXU9S3 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*4MdrlEjWg2MXU9S3 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*4MdrlEjWg2MXU9S3 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*4MdrlEjWg2MXU9S3 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*4MdrlEjWg2MXU9S3 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*4MdrlEjWg2MXU9S3 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4MdrlEjWg2MXU9S3 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*4MdrlEjWg2MXU9S3 640w, https://miro.medium.com/v2/resize:fit:720/0*4MdrlEjWg2MXU9S3 720w, https://miro.medium.com/v2/resize:fit:750/0*4MdrlEjWg2MXU9S3 750w, https://miro.medium.com/v2/resize:fit:786/0*4MdrlEjWg2MXU9S3 786w, https://miro.medium.com/v2/resize:fit:828/0*4MdrlEjWg2MXU9S3 828w, https://miro.medium.com/v2/resize:fit:1100/0*4MdrlEjWg2MXU9S3 1100w, https://miro.medium.com/v2/resize:fit:1400/0*4MdrlEjWg2MXU9S3 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="737" loading="lazy" role="presentation"/></picture></div></div></figure><p id="ec90">As with the TimeSeries abstraction, our automation uses a bunch of user inputs regarding their workload and cardinalities to arrive at the right set of infrastructure and related control plane configuration. You can learn more about this process in a talk given by one of our stunning colleagues, <a href="https://www.linkedin.com/in/joseph-lynch-9976a431/" rel="noopener ugc nofollow" target="_blank">Joey Lynch</a> : <a href="https://www.youtube.com/watch?v=Lf6B1PxIvAs" rel="noopener ugc nofollow" target="_blank">How Netflix optimally provisions infrastructure in the cloud</a>.</p><p id="f469">At the time of writing this blog, this service was processing close to <strong>75K count requests/second</strong><em> globally</em> across the different API endpoints and datasets:</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/0*1h_af4Kk3YrZrqlc 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*1h_af4Kk3YrZrqlc 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*1h_af4Kk3YrZrqlc 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*1h_af4Kk3YrZrqlc 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*1h_af4Kk3YrZrqlc 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*1h_af4Kk3YrZrqlc 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1h_af4Kk3YrZrqlc 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*1h_af4Kk3YrZrqlc 640w, https://miro.medium.com/v2/resize:fit:720/0*1h_af4Kk3YrZrqlc 720w, https://miro.medium.com/v2/resize:fit:750/0*1h_af4Kk3YrZrqlc 750w, https://miro.medium.com/v2/resize:fit:786/0*1h_af4Kk3YrZrqlc 786w, https://miro.medium.com/v2/resize:fit:828/0*1h_af4Kk3YrZrqlc 828w, https://miro.medium.com/v2/resize:fit:1100/0*1h_af4Kk3YrZrqlc 1100w, https://miro.medium.com/v2/resize:fit:1400/0*1h_af4Kk3YrZrqlc 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="357" loading="lazy" role="presentation"/></picture></div></div></figure><p id="92ef">while providing<strong> single-digit millisecond</strong> latencies for all its endpoints:</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/0*UnI7eore6gvuqrrF 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*UnI7eore6gvuqrrF 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*UnI7eore6gvuqrrF 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*UnI7eore6gvuqrrF 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*UnI7eore6gvuqrrF 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*UnI7eore6gvuqrrF 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*UnI7eore6gvuqrrF 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/0*UnI7eore6gvuqrrF 640w, https://miro.medium.com/v2/resize:fit:720/0*UnI7eore6gvuqrrF 720w, https://miro.medium.com/v2/resize:fit:750/0*UnI7eore6gvuqrrF 750w, https://miro.medium.com/v2/resize:fit:786/0*UnI7eore6gvuqrrF 786w, https://miro.medium.com/v2/resize:fit:828/0*UnI7eore6gvuqrrF 828w, https://miro.medium.com/v2/resize:fit:1100/0*UnI7eore6gvuqrrF 1100w, https://miro.medium.com/v2/resize:fit:1400/0*UnI7eore6gvuqrrF 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="366" loading="lazy" role="presentation"/></picture></div></div></figure><p id="19ec">While our system is robust, we still have work to do in making it more reliable and enhancing its features. Some of that work includes:</p><ul><li id="bafb"><strong>Regional Rollups: </strong>Cross-region replication issues can result in missed events from other regions. An alternate strategy involves establishing a rollup table for each region, and then tallying them in a global rollup table. A key challenge in this design would be effectively communicating the clearing of the counter across regions.</li><li id="7818"><strong>Error Detection and Stale Counts</strong>: Excessively stale counts can occur if rollup events are lost or if a rollups fails and isn’t retried. This isn’t an issue for frequently accessed counters, as they remain in rollup circulation. This issue is more pronounced for counters that aren’t accessed frequently. Typically, the initial read for such a counter will trigger a rollup,<em> self-remediating </em>the issue. However, for use cases that cannot accept potentially stale initial reads, we plan to implement improved error detection, rollup handoffs, and durable queues for resilient retries.</li></ul><p id="64c0">Distributed counting remains a challenging problem in computer science. In this blog, we explored multiple approaches to implement and deploy a Counting service at scale. While there may be other methods for distributed counting, our goal has been to deliver blazing fast performance at low infrastructure costs while maintaining high availability and providing idempotency guarantees. Along the way, we make various trade-offs to meet the diverse counting requirements at Netflix. We hope you found this blog post insightful.</p><p id="a883">Stay tuned for <strong>Part 3 </strong>of Composite Abstractions at Netflix, where we’ll introduce our <strong>Graph Abstraction</strong>, a new service being built on top of the <a rel="noopener ugc nofollow" target="_blank" href="https://netflixtechblog.com/introducing-netflixs-key-value-data-abstraction-layer-1ea8a0a11b30">Key-Value Abstraction</a> <em>and</em> the <a rel="noopener ugc nofollow" target="_blank" href="https://netflixtechblog.com/introducing-netflix-timeseries-data-abstraction-layer-31552f6326f8">TimeSeries Abstraction</a> to handle high-throughput, low-latency graphs.</p><p id="78b5">Special thanks to our stunning colleagues who contributed to the Counter Abstraction’s success: <a href="https://www.linkedin.com/in/joseph-lynch-9976a431/" rel="noopener ugc nofollow" target="_blank">Joey Lynch</a>, <a href="https://www.linkedin.com/in/vinaychella/" rel="noopener ugc nofollow" target="_blank">Vinay Chella</a>, <a href="https://www.linkedin.com/in/kaidanfullerton/" rel="noopener ugc nofollow" target="_blank">Kaidan Fullerton</a>, <a href="https://www.linkedin.com/in/tomdevoe/" rel="noopener ugc nofollow" target="_blank">Tom DeVoe</a>, <a href="https://www.linkedin.com/in/mengqingwang/" rel="noopener ugc nofollow" target="_blank">Mengqing Wang</a></p></div></div></div></div></section></div>
  </body>
</html>
