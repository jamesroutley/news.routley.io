<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://dev.to/thormeier/dont-try-this-at-home-css-as-the-backend-what-3oih">Original</a>
    <h1>CSS as the back end – Cascading Server Sheets</h1>
    
    <div id="readability-page-1" class="page"><div id="main-title">
            <p><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--9z45oQX1--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1bwk153kkfdnqa4h6060.png" width="1000" height="420" alt="Cover image for ⚠️ Don&#39;t try this at home: CSS _as_ the backend - introducing Cascading Server Sheets!"/>
            </p>

          <div>
            <div>
              
              <div>
                <p><a href="https://dev.to/thormeier"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--1KH7xOM6--/c_fill,f_auto,fl_progressive,h_50,q_auto,w_50/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/436259/00cde9af-e704-48b7-a00a-32cdc4997190.jpeg" width="40" height="40" alt="Pascal Thormeier"/></a>
                </p>
                
              </div>
            </div>

            

              
          </div>
        </div><div>

          <div data-article-id="958566" id="article-body">
            <p>Here we go again! Another one of these, and promise, you <em>will</em> be questioning my sanity after this one.</p>

<p>I was just getting groceries. I walked down the street to the local shop when it hit me. Cascading... <em>Server</em> Sheets!</p>

<p>Today, we&#39;ll use CSS as a server-side language. That&#39;s right. Use CSS to declare routing, do maths, heck, even use CSS to do templating! And we&#39;re not using anything like SASS or LESS (pff, we don&#39;t need no stinkin&#39; loops!), but plain ol&#39; CSS.</p>

<h2>
  <a name="what-why" href="#what-why">
  </a>
  What?? Why??
</h2>

<p><a href="https://www.smbc-comics.com/comic/qc">SMBC has lately put it quite well, although it&#39;s part of a comic about quantum computers</a>:</p>

<p><a href="https://www.smbc-comics.com/comic/qc"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--z_DcJ_6P--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/vfgad8hv28f2ljmtie6i.png" alt="Comic about a person explaining the &#34;deep abiding goal of every engineer&#34;: To take a thing and make it do something it wasn&#39;t supposed to do." loading="lazy" width="291" height="339"/></a></p>

<p>Imagine changing a tire with the Hubble telescope. Doesn&#39;t exactly work out, does it? Well, how awesome would it feel if you managed to do it, though? And that&#39;s what I&#39;m after. Hey, maybe I&#39;m starting a new trend here, who knows! Even if the trend is just laughing at my silly ideas and never taking me seriously ever again.</p>

<p>You might know the saying that &#34;people were so obsessed with wether they could that they forgot to ask if they <em>should</em>&#34;. I&#39;m well aware of that fact that I probably shouldn&#39;t, but the question is <em>could I</em>?</p>

<p>This tool will be something I&#39;ll never ever <em>ever</em> use in production, and you, dear reader, should not do it either. Please. There. You&#39;ve been warned.</p>

<h2>
  <a name="ok-cascading-st-server-sheets-it-is" href="#ok-cascading-st-server-sheets-it-is">
  </a>
  Ok, Cascading St... Server Sheets it is.
</h2>

<p>First, let&#39;s define how this thing will even work. I was thinking about an interface to Express. Basically define a catch-all route in Express, load the CSS file, parse and interpret the styles (this part will be fun, I guess) and shoot whatever DOM emerges over the wire.</p>

<p>To do that, let&#39;s first install Express. Please note that I&#39;m using <a href="https://github.com/nvm-sh/nvm">nvm</a> to switch between Node versions here.<br/>
</p>

<div>
<pre><code><span>echo</span> <span>&#34;14&#34;</span> <span>&gt;</span> .nvmrc
nvm use
npm init <span># Hit enter a few times</span>
npm i express
</code></pre>
<div>
<p>
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</p>
</div>
</div>



<p>Awesome! Now let&#39;s create a little app and add a start script to the <code>package.json</code>:<br/>
</p>

<div>
<pre><code><span>{</span><span>
  </span><span>&#34;name&#34;</span><span>:</span><span> </span><span>&#34;css-server&#34;</span><span>,</span><span>
  </span><span>&#34;version&#34;</span><span>:</span><span> </span><span>&#34;1.0.0&#34;</span><span>,</span><span>
  </span><span>&#34;description&#34;</span><span>:</span><span> </span><span>&#34;A bad idea.&#34;</span><span>,</span><span>
  </span><span>&#34;main&#34;</span><span>:</span><span> </span><span>&#34;index.js&#34;</span><span>,</span><span>
  </span><span>&#34;scripts&#34;</span><span>:</span><span> </span><span>{</span><span>
    </span><span>&#34;start&#34;</span><span>:</span><span> </span><span>&#34;node ./css-server.js&#34;</span><span>
  </span><span>},</span><span>
  </span><span>&#34;author&#34;</span><span>:</span><span> </span><span>&#34;Pascal Thormeier&#34;</span><span>,</span><span>
  </span><span>&#34;license&#34;</span><span>:</span><span> </span><span>&#34;donttrythisathome&#34;</span><span>,</span><span>
  </span><span>&#34;dependencies&#34;</span><span>:</span><span> </span><span>{</span><span>
    </span><span>&#34;express&#34;</span><span>:</span><span> </span><span>&#34;^4.17.2&#34;</span><span>
  </span><span>}</span><span>
</span><span>}</span><span>
</span></code></pre>
<div>
<p>
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</p>
</div>
</div>



<p>In the express app, we define a catch-all route that tries to figure out if a given route corresponds to a CSS file or not. If it exists, it simply returns the content of this file, if not, a 404 will be thrown.<br/>
</p>

<div>
<pre><code><span>const</span> <span>express</span> <span>=</span> <span>require</span><span>(</span><span>&#39;</span><span>express</span><span>&#39;</span><span>)</span>
<span>const</span> <span>bodyParser</span> <span>=</span> <span>require</span><span>(</span><span>&#39;</span><span>body-parser</span><span>&#39;</span><span>)</span>
<span>const</span> <span>path</span> <span>=</span> <span>require</span><span>(</span><span>&#39;</span><span>path</span><span>&#39;</span><span>)</span>
<span>const</span> <span>fs</span> <span>=</span> <span>require</span><span>(</span><span>&#39;</span><span>fs</span><span>&#39;</span><span>)</span>

<span>const</span> <span>app</span> <span>=</span> <span>express</span><span>()</span>

<span>// Allows to get POST bodies as JSON </span>
<span>app</span><span>.</span><span>use</span><span>(</span><span>bodyParser</span><span>.</span><span>urlencoded</span><span>({</span> <span>extended</span><span>:</span> <span>true</span> <span>}))</span>

<span>// Catch-all route</span>
<span>app</span><span>.</span><span>use</span><span>((</span><span>req</span><span>,</span> <span>res</span><span>)</span> <span>=&gt;</span> <span>{</span>
  <span>let</span> <span>cssFile</span> <span>=</span> <span>req</span><span>.</span><span>path</span>

  <span>// So `index.css` works.</span>
  <span>if</span> <span>(</span><span>cssFile</span><span>.</span><span>endsWith</span><span>(</span><span>&#39;</span><span>/</span><span>&#39;</span><span>))</span> <span>{</span>
    <span>cssFile</span> <span>+=</span> <span>&#39;</span><span>index</span><span>&#39;</span>
  <span>}</span>

  <span>const</span> <span>cssFilePath</span> <span>=</span> <span>path</span><span>.</span><span>resolve</span><span>(</span><span>&#39;</span><span>./app</span><span>&#39;</span> <span>+</span> <span>cssFile</span> <span>+</span> <span>&#39;</span><span>.css</span><span>&#39;</span><span>)</span>

  <span>try</span> <span>{</span>
    <span>const</span> <span>css</span> <span>=</span> <span>fs</span><span>.</span><span>readFileSync</span><span>(</span><span>cssFilePath</span><span>,</span> <span>&#39;</span><span>utf8</span><span>&#39;</span><span>)</span>
    <span>res</span><span>.</span><span>send</span><span>(</span><span>css</span><span>)</span>
  <span>}</span> <span>catch</span> <span>(</span><span>e</span><span>)</span> <span>{</span>
    <span>// Any error of the file system will </span>
    <span>// be caught and treated as &#34;not found&#34;</span>
    <span>res</span><span>.</span><span>sendStatus</span><span>(</span><span>404</span><span>)</span>
  <span>}</span>
<span>})</span>

<span>app</span><span>.</span><span>listen</span><span>(</span><span>3000</span><span>)</span>
</code></pre>
<div>
<p>
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</p>
</div>
</div>



<p>A quick test shows that everything, except a small <code>index.css</code> file yields a 404; the CSS file gets shown.</p>

<h2>
  <a name="evaluating-css-thinking-aloud" href="#evaluating-css-thinking-aloud">
  </a>
  Evaluating CSS - Thinking aloud
</h2>

<p>Ok, here&#39;s the fun part. We somehow need to figure out how to execute the CSS server-side and take whatever it outputs as the apps response.</p>

<p>The first thing that comes to mind for rendering is to simply use the CSS <code>content</code> rule to render - well - content. It can use CSS variables and counters, so we can technically even do math with it. There&#39;s just one problem: The browser evaluates counters and vars on the fly, so we cannot just evaluate the CSS, take whatever is in the <code>content</code> and output that. So, the &#34;computed style&#34; approach doesn&#39;t work. (Believe me, I tried...)</p>

<p>Basically, you&#39;ll get what you see in the &#34;CSS&#34; tab of your dev tools.</p>

<p>Imagine this piece of CSS:<br/>
</p>

<div>
<pre><code><span>body</span> <span>{</span>
  <span>--num1</span><span>:</span> <span>12</span><span>;</span>
  <span>--num2</span><span>:</span> <span>13</span><span>;</span>
  <span>counter-set</span><span>:</span> <span>sum</span> <span>15</span><span>;</span>
<span>}</span>

<span>body</span><span>::before</span> <span>{</span>
  <span>content</span><span>:</span> <span>&#39;&lt;h1&gt;The sum is &#39;</span> <span>counter</span><span>(</span><span>sum</span><span>)</span> <span>&#39;&lt;/h1&gt;&#39;</span><span>;</span>
<span>}</span>
</code></pre>
<div>
<p>
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</p>
</div>
</div>



<p>This is what you&#39;ll get:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--cO4y2e2F--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/zofvhlkraqkomtehfx7s.png"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--cO4y2e2F--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/zofvhlkraqkomtehfx7s.png" alt="A browser window with open inspector, showing the exact thing mentioned above." loading="lazy" width="561" height="404"/></a></p>

<p>Hm. So why don&#39;t we use a browser to do just that? The browser does evaluate this stuff <em>somehow</em>, right? The only issue is, that we&#39;re shifting the problem here. There <em>are</em> Node implementations of CSS. They offer computed styles and the browser we would be using would only offer the same thing, right? If only there was a way to let the computer &#34;read&#34; what&#39;s on screen.</p>

<p>Ideally, the browser would load the CSS file and we wouldn&#39;t inline anything; otherwise we cannot really use stuff like <code>@import</code>. So we need another controller that loads CSS files.</p>

<p>Anyways, sounds a lot like a &#34;future me&#34; problem. Let&#39;s first introduce puppeteer and make it execute the CSS.</p>

<h2>
  <a name="adding-puppeteer" href="#adding-puppeteer">
  </a>
  Adding puppeteer
</h2>

<p>Straight forward:<br/>
</p>

<div>
<pre><code>npm i <span>-s</span> puppeteer
</code></pre>
<div>
<p>
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</p>
</div>
</div>



<p>To load the CSS, we need some HTML. We can create that on the fly, inject the loaded CSS as a <code>&lt;link&gt;</code>, base64 encode the entire blob and make the browser parse that:<br/>
</p>

<div>
<pre><code><span>const</span> <span>escapeVarValue</span> <span>=</span> <span>value</span> <span>=&gt;</span> <span>{</span>
  <span>if</span> <span>(</span><span>!</span><span>isNaN</span><span>(</span><span>value</span><span>)){</span>
    <span>return</span> <span>value</span>
  <span>}</span>

  <span>return</span> <span>`&#39;</span><span>${</span><span>value</span><span>}</span><span>&#39;`</span>
<span>}</span>

<span>const</span> <span>createDOM</span> <span>=</span> <span>(</span><span>cssFilePath</span><span>,</span> <span>method</span><span>,</span> <span>args</span><span>)</span> <span>=&gt;</span> <span>{</span>
  <span>const</span> <span>varifiedArgs</span> <span>=</span> <span>Object</span><span>.</span><span>entries</span><span>(</span><span>args</span><span>).</span><span>map</span><span>(([</span><span>key</span><span>,</span> <span>value</span><span>])</span> <span>=&gt;</span> <span>`--</span><span>${</span><span>key</span><span>}</span><span>: </span><span>${</span><span>escapeVarValue</span><span>(</span><span>value</span><span>)}</span><span>;\n`</span><span>).</span><span>join</span><span>(</span><span>&#34;</span><span>\n</span><span>&#34;</span><span>)</span>
  <span>const</span> <span>dataifiedArgs</span> <span>=</span> <span>Object</span><span>.</span><span>entries</span><span>(</span><span>args</span><span>).</span><span>map</span><span>(([</span><span>key</span><span>,</span> <span>value</span><span>])</span> <span>=&gt;</span> <span>`data-</span><span>${</span><span>key</span><span>}</span><span>=&#34;</span><span>${</span><span>value</span><span>}</span><span>&#34;`</span><span>).</span><span>join</span><span>(</span><span>&#39;</span><span> </span><span>&#39;</span><span>)</span>

  <span>return</span> <span>`
    &lt;!DOCTYPE html&gt;
    &lt;html data-http-method=&#34;</span><span>${</span><span>method</span><span>.</span><span>toUpperCase</span><span>()}</span><span>&#34;&gt;
      &lt;head&gt;
        &lt;style&gt;
          :root {
            </span><span>${</span><span>varifiedArgs</span><span>}</span><span>
          }
        &lt;/style&gt;
        &lt;!-- Load the actual CSS --&gt;
        &lt;link rel=&#34;stylesheet&#34; href=&#34;</span><span>${</span><span>cssFilePath</span><span>}</span><span>&#34;&gt;
      &lt;/head&gt;
      &lt;body </span><span>${</span><span>dataifiedArgs</span><span>}</span><span>&gt;
      &lt;/body&gt;
    &lt;/html&gt;
  `</span>
<span>}</span>
</code></pre>
<div>
<p>
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</p>
</div>
</div>



<p>Note how we already added the HTTP method as a data attribute and any args as CSS variables <em>and</em> data attributes.</p>

<p>Next, we add the <code>_internal</code> route to our express app that serves the requested CSS file:<br/>
</p>

<div>
<pre><code><span>app</span><span>.</span><span>get</span><span>(</span><span>&#39;</span><span>/_internal/*</span><span>&#39;</span><span>,</span> <span>(</span><span>req</span><span>,</span> <span>res</span><span>)</span> <span>=&gt;</span> <span>{</span>
  <span>const</span> <span>appPath</span> <span>=</span> <span>req</span><span>.</span><span>path</span><span>.</span><span>replace</span><span>(</span><span>&#39;</span><span>_internal</span><span>&#39;</span><span>,</span> <span>&#39;</span><span>app</span><span>&#39;</span><span>)</span>
  <span>if</span> <span>(</span><span>appPath</span><span>.</span><span>includes</span><span>(</span><span>&#39;</span><span>..</span><span>&#39;</span><span>)</span> <span>||</span> <span>!</span><span>appPath</span><span>.</span><span>endsWith</span><span>(</span><span>&#39;</span><span>.css</span><span>&#39;</span><span>))</span> <span>{</span>
    <span>res</span><span>.</span><span>send</span><span>(</span><span>&#39;</span><span>Invalid file</span><span>&#39;</span><span>)</span>
    <span>return</span>
  <span>}</span>

  <span>const</span> <span>internalFilePath</span> <span>=</span> <span>path</span><span>.</span><span>resolve</span><span>(</span><span>&#39;</span><span>.</span><span>&#39;</span> <span>+</span> <span>appPath</span><span>)</span>
  <span>res</span><span>.</span><span>sendFile</span><span>(</span><span>internalFilePath</span><span>)</span>
<span>})</span>
</code></pre>
<div>
<p>
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</p>
</div>
</div>



<p>A request to <code>/_internal/index.css</code> would then load <code>app/index.css</code> and serve it. Puppeteer can now load our apps code and execute it. We could do more validation here, but I kept it basic here for the sake of simplicity.</p>

<p>Now to get puppeteer into the game:<br/>
</p>

<div>
<pre><code><span>const</span> <span>getContent</span> <span>=</span> <span>async</span> <span>(</span><span>cssPath</span><span>,</span> <span>method</span><span>,</span> <span>args</span><span>)</span> <span>=&gt;</span> <span>{</span>
  <span>const</span> <span>dom</span> <span>=</span> <span>createDOM</span><span>(</span><span>cssPath</span><span>,</span> <span>method</span><span>,</span> <span>args</span><span>)</span>

  <span>const</span> <span>browser</span> <span>=</span> <span>await</span> <span>puppeteer</span><span>.</span><span>launch</span><span>({</span>
    <span>headless</span><span>:</span> <span>true</span><span>,</span>
    <span>args</span><span>:</span> <span>[</span><span>&#39;</span><span>--no-sandbox</span><span>&#39;</span><span>,</span> <span>&#39;</span><span>--disable-setuid-sandbox</span><span>&#39;</span><span>],</span>
  <span>})</span>
  <span>const</span> <span>page</span> <span>=</span> <span>await</span> <span>browser</span><span>.</span><span>newPage</span><span>()</span>
  <span>const</span> <span>base64Html</span> <span>=</span> <span>Buffer</span><span>.</span><span>from</span><span>(</span><span>dom</span><span>).</span><span>toString</span><span>(</span><span>&#39;</span><span>base64</span><span>&#39;</span><span>)</span>

  <span>await</span> <span>page</span><span>.</span><span>goto</span><span>(</span><span>&#39;</span><span>data:text</span><span>\</span><span>/html;base64;charset=UTF-8,</span><span>&#39;</span> <span>+</span> <span>base64Html</span><span>,</span> <span>{</span>
    <span>waitUntil</span><span>:</span> <span>&#39;</span><span>load</span><span>&#39;</span><span>,</span>
    <span>timeout</span><span>:</span> <span>300000</span><span>,</span>
    <span>waitFor</span><span>:</span> <span>30000</span><span>,</span>
  <span>})</span>

  <span>// Magic!</span>
<span>}</span>
</code></pre>
<div>
<p>
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</p>
</div>
</div>



<p>Let&#39;s try this with a basic little <code>index.css</code>:<br/>
</p>

<div>
<pre><code><span>body</span><span>::after</span> <span>{</span>
  <span>content</span><span>:</span> <span>&#39;&lt;h1&gt;Hello, World!&lt;/h1&gt;&#39;</span><span>;</span>
<span>}</span>
</code></pre>
<div>
<p>
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</p>
</div>
</div>



<p>Lo and behold: It works! Puppeteer executes the CSS and displays the result:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--4BZ8C2p3--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/gsfow86pxxvf8m6cg94l.png"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--4BZ8C2p3--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/gsfow86pxxvf8m6cg94l.png" alt="A browser displaying the CSS above as rendered text." loading="lazy" width="648" height="241"/></a></p>

<p>Neat side effect: Changing <code>headless: true</code> to <code>false</code> allows us to debug the CSS. An out of the box debugger is definitely a nice thing.</p>

<h2>
  <a name="extracting-the-content" href="#extracting-the-content">
  </a>
  Extracting the content
</h2>

<p>Remember the &#34;future me&#34; problem? Yeah.</p>

<p>We know that we cannot use computed styles to get any element&#39;s <code>content</code>, especially if it contains variables or counters. We also cannot select and copy/paste the rendered text since Chromium cannot do that. So, how do we get the rendered, evaluated text?</p>

<p>Ever downloaded a website as PDF? The evaluated text gets selectable. Can puppeteer create a PDF from a website? Yes, it can. Can we somehow parse the PDF to get the text? Of <em>course</em> we can!<br/>
</p>

<div>
<pre><code>npm i <span>-s</span> pdf-parse
</code></pre>
<div>
<p>
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</p>
</div>
</div>



<p>This library lets us parse any given PDF and extract its text. We&#39;re not doing any shenanigans with images, layouts and whatnot here. We only render out plain ol&#39; HTML as an unparsed string. We <em>can</em> copy/paste that:<br/>
</p>

<div>
<pre><code><span>const</span> <span>pdf</span> <span>=</span> <span>require</span><span>(</span><span>&#39;</span><span>pdf-parse</span><span>&#39;</span><span>)</span>

<span>const</span> <span>getContent</span> <span>=</span> <span>async</span> <span>(</span><span>cssPath</span><span>,</span> <span>method</span><span>,</span> <span>args</span><span>)</span> <span>=&gt;</span> <span>{</span>
  <span>const</span> <span>dom</span> <span>=</span> <span>createDOM</span><span>(</span><span>cssPath</span><span>,</span> <span>method</span><span>,</span> <span>args</span><span>)</span>

  <span>const</span> <span>browser</span> <span>=</span> <span>await</span> <span>puppeteer</span><span>.</span><span>launch</span><span>({</span>
    <span>headless</span><span>:</span> <span>true</span><span>,</span>
    <span>args</span><span>:</span> <span>[</span><span>&#39;</span><span>--no-sandbox</span><span>&#39;</span><span>,</span> <span>&#39;</span><span>--disable-setuid-sandbox</span><span>&#39;</span><span>],</span>
  <span>})</span>
  <span>const</span> <span>page</span> <span>=</span> <span>await</span> <span>browser</span><span>.</span><span>newPage</span><span>()</span>
  <span>const</span> <span>base64Html</span> <span>=</span> <span>Buffer</span><span>.</span><span>from</span><span>(</span><span>dom</span><span>).</span><span>toString</span><span>(</span><span>&#39;</span><span>base64</span><span>&#39;</span><span>)</span>

  <span>await</span> <span>page</span><span>.</span><span>goto</span><span>(</span><span>&#39;</span><span>data:text</span><span>\</span><span>/html;base64;charset=UTF-8,</span><span>&#39;</span> <span>+</span> <span>base64Html</span><span>,{</span>
    <span>waitUntil</span><span>:</span> <span>&#39;</span><span>load</span><span>&#39;</span><span>,</span>
    <span>timeout</span><span>:</span> <span>300000</span><span>,</span>
    <span>waitFor</span><span>:</span> <span>30000</span><span>,</span>
  <span>})</span>

  <span>// Get a PDF buffer</span>
  <span>const</span> <span>pdfBuffer</span> <span>=</span> <span>await</span> <span>page</span><span>.</span><span>pdf</span><span>()</span>

  <span>// Parse the PDF</span>
  <span>const</span> <span>renderedData</span> <span>=</span> <span>await</span> <span>pdf</span><span>(</span><span>pdfBuffer</span><span>)</span>

  <span>// Get the PDFs text</span>
  <span>return</span> <span>Promise</span><span>.</span><span>resolve</span><span>(</span><span>renderedData</span><span>.</span><span>text</span><span>)</span>
<span>}</span>
</code></pre>
<div>
<p>
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</p>
</div>
</div>



<p>And as a last step, let&#39;s adjust the catch-all route to get the text:<br/>
</p>

<div>
<pre><code><span>// Catch-all route</span>
<span>app</span><span>.</span><span>use</span><span>((</span><span>req</span><span>,</span> <span>res</span><span>)</span> <span>=&gt;</span> <span>{</span>
  <span>let</span> <span>cssFile</span> <span>=</span> <span>req</span><span>.</span><span>path</span>

  <span>// So `index.css` works.</span>
  <span>if</span> <span>(</span><span>cssFile</span><span>.</span><span>endsWith</span><span>(</span><span>&#39;</span><span>/</span><span>&#39;</span><span>))</span> <span>{</span>
    <span>cssFile</span> <span>+=</span> <span>&#39;</span><span>index</span><span>&#39;</span>
  <span>}</span>

  <span>cssFile</span> <span>+=</span> <span>&#39;</span><span>.css</span><span>&#39;</span>

  <span>// File doesn&#39;t exist, so we break here</span>
  <span>if</span> <span>(</span><span>!</span><span>fs</span><span>.</span><span>existsSync</span><span>(</span><span>path</span><span>.</span><span>resolve</span><span>(</span><span>&#39;</span><span>./app/</span><span>&#39;</span> <span>+</span> <span>cssFile</span><span>)))</span> <span>{</span>
    <span>res</span><span>.</span><span>sendStatus</span><span>(</span><span>404</span><span>)</span>
    <span>return</span>
  <span>}</span>

  <span>const</span> <span>cssFilePath</span> <span>=</span> <span>&#39;</span><span>http://localhost:3000/_internal</span><span>&#39;</span> <span>+</span> <span>cssFile</span>

  <span>getContent</span><span>(</span><span>cssFilePath</span><span>,</span> <span>req</span><span>.</span><span>method</span><span>,</span> <span>{</span>
    <span>...</span><span>req</span><span>.</span><span>query</span><span>,</span> <span>// GET parameters</span>
    <span>...</span><span>req</span><span>.</span><span>body</span><span>,</span> <span>// POST body</span>
  <span>}).</span><span>then</span><span>(</span><span>content</span> <span>=&gt;</span> <span>{</span>
    <span>res</span><span>.</span><span>send</span><span>(</span><span>content</span><span>)</span>
  <span>})</span>
<span>})</span>
</code></pre>
<div>
<p>
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</p>
</div>
</div>



<p>That <em>should</em> do the trick.</p>

<h2>
  <a name="demo-time" href="#demo-time">
  </a>
  Demo time!
</h2>

<p>Let&#39;s put this thing to test.</p>

<h3>
  <a name="calculator-using-a-form" href="#calculator-using-a-form">
  </a>
  Calculator using a form
</h3>

<p>A basic &#34;Hello World&#34; is simple enough. Let&#39;s build a CSS calculator:<br/>
</p>

<div>
<pre><code><span>body</span> <span>{</span>
    <span>--title</span><span>:</span> <span>&#39;&lt;h1&gt;Calculator:&lt;/h1&gt;&#39;</span><span>;</span>
    <span>--form</span><span>:</span> <span>&#39;&lt;form method=&#34;POST&#34; action=&#34;/&#34;&gt;&lt;div&gt;&lt;label for=&#34;num1&#34;&gt;Number 1&lt;/label&gt;&lt;input id=&#34;num1&#34; name=&#34;num1&#34;&gt;&lt;/div&gt;&lt;div&gt;&lt;label for=&#34;num2&#34;&gt;Number 2&lt;/label&gt;&lt;input id=&#34;num2&#34; name=&#34;num2&#34;&gt;&lt;/div&gt;&lt;button type=&#34;submit&#34;&gt;Add two numbers&lt;/button&gt;&lt;/form&gt;&#39;</span><span>;</span>
<span>}</span>

<span>[</span><span>data-http-method</span><span>=</span><span>&#34;POST&#34;</span><span>]</span> <span>body</span> <span>{</span>
    <span>counter-set</span><span>:</span> <span>sum</span> <span>var</span><span>(</span><span>--num1</span><span>,</span> <span>0</span><span>)</span> <span>val1</span> <span>var</span><span>(</span><span>--num1</span><span>,</span> <span>0</span><span>)</span> <span>val2</span> <span>var</span><span>(</span><span>--num2</span><span>,</span> <span>0</span><span>);</span>
<span>}</span>

<span>[</span><span>data-http-method</span><span>=</span><span>&#34;GET&#34;</span><span>]</span> <span>body</span><span>::before</span> <span>{</span>
    <span>content</span><span>:</span> <span>var</span><span>(</span><span>--title</span><span>)</span> <span>var</span><span>(</span><span>--form</span><span>);</span>
<span>}</span>

<span>[</span><span>data-http-method</span><span>=</span><span>&#34;POST&#34;</span><span>]</span> <span>body</span><span>::before</span> <span>{</span>
    <span>--form</span><span>:</span> <span>&#39;&lt;form method=&#34;POST&#34; action=&#34;/&#34;&gt;&lt;div&gt;&lt;label for=&#34;num1&#34;&gt;Number 1&lt;/label&gt;&lt;input id=&#34;num1&#34; name=&#34;num1&#34; value=&#34;&#39;</span> <span>counter</span><span>(</span><span>val1</span><span>)</span> <span>&#39;&#34;&gt;&lt;/div&gt;&lt;div&gt;&lt;label for=&#34;num2&#34;&gt;Number 2&lt;/label&gt;&lt;input id=&#34;num2&#34; name=&#34;num2&#34; value=&#34;&#39;</span> <span>counter</span><span>(</span><span>val2</span><span>)</span> <span>&#39;&#34;&gt;&lt;/div&gt;&lt;button type=&#34;submit&#34;&gt;Add two numbers&lt;/button&gt;&lt;/form&gt;&#39;</span><span>;</span>
    <span>counter-increment</span><span>:</span> <span>sum</span> <span>var</span><span>(</span><span>--num2</span><span>,</span> <span>0</span><span>);</span>
    <span>content</span><span>:</span> <span>var</span><span>(</span><span>--title</span><span>)</span> <span>var</span><span>(</span><span>--form</span><span>)</span> <span>&#39;&lt;div&gt;Result: &#39;</span> <span>counter</span><span>(</span><span>sum</span><span>)</span> <span>&#39;&lt;/div&gt;&#39;</span><span>;</span>
<span>}</span>
</code></pre>
<div>
<p>
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</p>
</div>
</div>



<p>This calculator uses multiple features:</p>

<ul>
<li>Reacting to GET vs POST</li>
<li>Doing maths</li>
<li>Displaying the result</li>
</ul>

<p>So, what does this actually do?</p>

<p>We render a title and a form with two input fields called <code>num1</code> and <code>num2</code>. If the &#34;app&#34; encounters a POST request, it displays the result, which is calculated via a CSS counter. The CSS counter is first set to <code>num1</code> and later on increased by <code>num2</code>, yielding the sum of the two numbers. Hence: A basic addition calculator.</p>

<p>Does it work? Indeed it does:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--mcoOIhfm--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/p7c39f1sx2ymehrvu1of.png"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--mcoOIhfm--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/p7c39f1sx2ymehrvu1of.png" alt="Browser window showing a simple calculator, a terminal to the left showing the DOM." loading="lazy" width="880" height="290"/></a></p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--Sx2ks05Z--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/k5m4pi1eus9kpst79a5r.png"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--Sx2ks05Z--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/k5m4pi1eus9kpst79a5r.png" alt="The same calculator, showing the result" loading="lazy" width="880" height="358"/></a></p>

<h2>
  <a name="simple-two-page-app-with-navigation" href="#simple-two-page-app-with-navigation">
  </a>
  Simple two page app with navigation
</h2>

<p>Let&#39;s abstract away some header and some footer into a <code>globals.css</code> file:<br/>
</p>

<div>
<pre><code><span>:root</span> <span>{</span>
    <span>--navigation</span><span>:</span> <span>&#39;&lt;ul&gt;&lt;li&gt;&lt;a href=&#34;/&#34;&gt;Home&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=&#34;/about&#34;&gt;About&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&#39;</span><span>;</span>
    <span>--footer</span><span>:</span> <span>&#39;&lt;footer&gt;&amp;copy; 2022&lt;/footer&gt;&#39;</span><span>;</span>
<span>}</span>
</code></pre>
<div>
<p>
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</p>
</div>
</div>



<p>We can then use it in a <code>index.css</code> like so:<br/>
</p>

<div>
<pre><code><span>@import</span> <span>&#34;./globals.css&#34;</span><span>;</span>

<span>body</span><span>::after</span> <span>{</span>
    <span>content</span><span>:</span> <span>var</span><span>(</span><span>--navigation</span><span>)</span> <span>&#39;&lt;h1&gt;Hello, World!&lt;/h1&gt;&#39;</span> <span>var</span><span>(</span><span>--footer</span><span>);</span>
<span>}</span>
</code></pre>
<div>
<p>
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 24 24"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</p>
</div>
</div>



<p>Works like a charm:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--OrkbENPC--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/euqfkm6qkbwpjifq622g.png"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--OrkbENPC--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/euqfkm6qkbwpjifq622g.png" alt="A simple page with navigation, a title and a footer, no styling." loading="lazy" width="602" height="355"/></a></p>

<p>Phew. What a ride.</p>


<hr/>

<p><em>I hope you enjoyed reading this article as much as I enjoyed writing it! If so, leave a</em> ❤️ <em>or a</em> 🦄<em>! I write tech articles in my free time and like to drink coffee every once in a while.</em></p>

<p><em>If you want to support my efforts,</em> <a href="http://buymeacoffee.com/pthormeier"><em>you can offer me a coffee</em> ☕</a> <em>or</em> <a href="https://twitter.com/pthormeier"><em>follow me on Twitter</em> 🐦</a><em>!</em> <em>You can also support me directly via <a href="https://www.paypal.me/pthormeier">Paypal</a>!</em></p>

<p><a href="http://buymeacoffee.com/pthormeier"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--kc4mYYLu--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/i/x55hp6jopwyy161d8e2u.png" alt="Buy me a coffee button" loading="lazy" width="262" height="60"/></a></p>


          </div>

        </div></div>
  </body>
</html>
