<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lichess.org/@/thibault/blog/lichess-on-scala3-help-needed/2bpotLb0">Original</a>
    <h1>Lichess on Scala3 â€“ Help needed</h1>
    
    <div id="readability-page-1" class="page"><p><strong>A week after deploying Lichess rewritten with scala 3, I had to revert to the scala 2 version. I need help diagnosing a peculiar JVM behaviour.</strong></p><div><h2>TLDR The problem</h2>
<p>Since its recent rewrite to scala3, Lichess is using way more CPU than usual, but the problem takes a while to kick in and has peculiar patterns.</p>
<h2>Available data</h2>
<ul>
<li>30-days monitoring for context
<ul>
<li><a href="https://monitor.lichess.ovh/dashboard/snapshot/ryIMsCEKhmCUbXxvH3hE9E6moBogh9Mw">Overview</a></li>
<li><a href="https://monitor.lichess.ovh/dashboard/snapshot/yTPu9kl1kxSGSW5y79TYTXt4JpG55kPd">JVM CPU/threads/pools</a></li>
<li><a href="https://monitor.lichess.ovh/dashboard/snapshot/GHegHH7K6S16JhVzZ1qCxacqqsVioQ57">JVM memory</a></li>
<li><a href="https://monitor.lichess.ovh/dashboard/snapshot/WGD1dK6jzJ2hOU8ueNIHs6B4bsKJPTMW">JVM GC (G1)</a></li>
</ul>
</li>
<li>peak time monitoring for granularity (4pm-7pm)
<ul>
<li><a href="https://monitor.lichess.ovh/dashboard/snapshot/jdPPwCn6k3oXU4hGNj6snymlaPiTBK8g">Overview</a></li>
<li><a href="https://monitor.lichess.ovh/dashboard/snapshot/ZWmyMUq34oWn0u5CrywqihVfBeUF4L5m">JVM CPU/threads/pools</a></li>
<li><a href="https://monitor.lichess.ovh/dashboard/snapshot/XbLGVqeeqrosIVDnKQVDh7gL5OWLAZMB">JVM memory</a></li>
<li><a href="https://monitor.lichess.ovh/dashboard/snapshot/Dwjptuw3pu88elU13BYBzPlf24bgbvty">JVM GC (G1)</a></li>
</ul>
</li>
<li><a href="https://gist.githubusercontent.com/ornicar/ebe70a84bb383357e9cfbd09706ba908/raw/1f526757b6b1ace6554c7ce0caa56983cb2ba62d/lila3.jstats.txt">Thread dumps at peak time</a> Raw: <a href="https://gist.githubusercontent.com/ornicar/286ff7246251fbf35a0e8b297f2b1fb5/raw/105912e3d764b63039b1ba05ff4ce3a960d99cd2/lila3.thread-dump.1.txt">1</a> <a href="https://gist.githubusercontent.com/ornicar/286ff7246251fbf35a0e8b297f2b1fb5/raw/105912e3d764b63039b1ba05ff4ce3a960d99cd2/lila3.thread-dump.2.txt">2</a> <a href="https://gist.githubusercontent.com/ornicar/286ff7246251fbf35a0e8b297f2b1fb5/raw/105912e3d764b63039b1ba05ff4ce3a960d99cd2/lila3.thread-dump.3.txt">3</a> <a href="https://gist.githubusercontent.com/ornicar/286ff7246251fbf35a0e8b297f2b1fb5/raw/105912e3d764b63039b1ba05ff4ce3a960d99cd2/lila3.thread-dump.4.txt">4</a> <a href="https://gist.githubusercontent.com/ornicar/286ff7246251fbf35a0e8b297f2b1fb5/raw/105912e3d764b63039b1ba05ff4ce3a960d99cd2/lila3.thread-dump.5.txt">5</a></li>
<li><a href="https://gist.githubusercontent.com/ornicar/ebe70a84bb383357e9cfbd09706ba908/raw/1f526757b6b1ace6554c7ce0caa56983cb2ba62d/lila3.jstats.txt">JVM GC stats dumped every 500ms, at peak time</a></li>
</ul>
<h2>Context</h2>
<p>The core of Lichess is <a href="https://github.com/lichess-org/lila">a monolith written in scala</a>.</p>
<p>Until now, lila was written in scala 2.13.10, and it was running well and performing well. We&#39;ll call it <a href="https://github.com/lichess-org/lila/tree/scala2">lila2</a>.</p>
<p>About a month ago, I started migrating it to scala 3.2.1 - we&#39;ll call it <a href="https://github.com/lichess-org/lila/tree/scala3">lila3</a>. It was fun and I&#39;ll write about it... After problems are solved.</p>
<p>On the 2022-11-22 at 7AM UTC, I deployed lila3 to production, and it worked quite well, and performed quite well.</p>
<h3>Symptoms</h3>
<p>But when I let it run for more than 24h, the CPU usage started increasing dramatically. It became obvious that lila3 could not handle more than 48h of uptime.</p>
<p><img src="https://i.imgur.com/96qYcEO.png" alt=""/></p>
<p><img src="https://i.imgur.com/WyBiag3.png" alt=""/></p>
<h3>A closer look at CPU usage</h3>
<p>The CPU usage is not regular, even during the worst times. Instead, it will be normal for a minute or two; then be crazy for a minute or two. Then back to normal.</p>
<p><img src="https://i.imgur.com/VjBM6KI.png" alt=""/></p>
<h3>Memory pressure / GC problem?</h3>
<p><a href="https://monitor.lichess.ovh/dashboard/snapshot/WGD1dK6jzJ2hOU8ueNIHs6B4bsKJPTMW">I don&#39;t think the garbage collector is to blame</a>. During the worst times, when the JVM almost maxed out 90 CPUs, the GC was only using 3s of CPU time per minute.</p>
<p><a href="https://monitor.lichess.ovh/dashboard/snapshot/GHegHH7K6S16JhVzZ1qCxacqqsVioQ57">Allocations and memory usage</a> also look rather normal.</p>
<h3>What about exceptions or log messages?</h3>
<p>There are none relevant. We have extensive logging in lila and no new errors are popping up. No timeouts either.</p>
<h2>Help</h2>
<p>I had to revert to the scala2 version of Lichess. This is very unfortunate, as the gap between lila2 and lila3 is huge, and every day we spend with lila2 in production makes it bigger.</p>
<p>At this point I don&#39;t know how to diagnose and fix the problem with lila3.</p>
<p>If you know about large JVM deployments and have an idea about what could be causing this, please let me know.</p>
<p>You can use the <a href="https://discord.gg/lichess">Lichess programming discord channel</a> or our <a href="https://lichess.org/@/thibault/blog/lichess-on-scala3-help-needed/contact@lichess.org">email address</a>.</p>
<p>I will update this post with more data and info, as people ask for them.</p>
<h2>FAQ</h2>
<p>For monitoring data, thread dumps and GC logs, see the top of this post.</p>
<h3>Versions</h3>
<p>lila2 and lila3 are compiled with java 17, and the prod server runs the same JVM:</p>
<p><code># java -version</code></p>
<p><code># uname -a</code></p>
<p>JVM args are the same as before: <code>-Xms30g -Xmx30g -XX:+UseG1GC</code></p>
<p>lila2 runs scala 2.13.10, lila3 runs scala 3.2.1.</p>
</div></div>
  </body>
</html>
