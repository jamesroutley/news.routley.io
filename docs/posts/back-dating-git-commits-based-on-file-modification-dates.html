<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://til.simonwillison.net/git/backdate-git-commits">Original</a>
    <h1>Back dating Git commits based on file modification dates</h1>
    
    <div id="readability-page-1" class="page"><section>



<p>I fell down a bit of a rabbit hole this morning. In trying to figure out <a href="https://simonwillison.net/2024/Aug/1/august-1st-world-wide-web-day/" rel="nofollow">where the idea of celebrating World Wide Web Day on August 1st</a> came from I ran across Tim Berner-Lee&#39;s original code for the WorldWideWeb application for NeXT on the W3C&#39;s website:</p>
<p><a href="https://www.w3.org/History/1991-WWW-NeXT/Implementation/" rel="nofollow">https://www.w3.org/History/1991-WWW-NeXT/Implementation/</a></p>
<p>It&#39;s served up as a browseable Apache directory listing, but that&#39;s not the most delightful way to browse code - clicking a link to a <code>.m</code> file triggers a download, for example.</p>
<p>I decided to copy the code over to a GitHub repository, in order to browse it more easily with syntax highlighting and the like.</p>
<p>My end result is here: <a href="https://github.com/simonw/1991-WWW-NeXT-Implementation">https://github.com/simonw/1991-WWW-NeXT-Implementation</a></p>
<p><a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/71a6c5d0-7ddf-48e7-8fb2-0e4032f3baf3"><img src="https://github.com/user-attachments/assets/71a6c5d0-7ddf-48e7-8fb2-0e4032f3baf3" alt="File system listing with 5 entries: folder &#39;Test&#39; from 1990-12-20 (34 years ago), folder &#39;WorldWideWeb.app&#39; from 1995-02-01 (30 years ago), file &#39;,Features.html&#39; from 1993-12-01 (31 years ago), files &#39;Anchor.h&#39; and &#39;Anchor.m&#39; both from 1991-09-04 (33 years ago); each row shows icon, name, &#39;Adding files from [DATE]&#39;"/></a></p>
<div><h2>Fetching the code with wget</h2></div>
<p>I started by using <code>wget</code> to grab the the code:</p>
<div><pre>wget \
  --recursive \
  --no-parent \
  --no-host-directories \
  https://www.w3.org/History/1991-WWW-NeXT/Implementation/</pre></div>
<p>This gave me a directory full of files... and to my delight they included the correct last modified dates, according to <code>ls -lah</code>:</p>
<pre><code>-rw-r--r--   1 simon  wheel   1.5K Sep  4  1991 Anchor.h
-rw-r--r--   1 simon  wheel   8.1K Sep  4  1991 Anchor.m
-rw-r--r--   1 simon  wheel   3.6K Dec  1  1993 Bugs.html
-rw-r--r--   1 simon  wheel   7.7K Jun  2  1994 Features.html
</code></pre>
<p>I decided to attempt to mirror those dates in my new GitHub repository.</p>
<div><h2>Writing a script to back-date Git commits</h2></div>
<p>Short version: to back-date Git commits you need to set the following environment variables before running <code>git commit</code>:</p>
<ul>
<li>
<code>GIT_AUTHOR_DATE</code> - to a format like <code>2004-01-25 00:00:00</code>
</li>
<li>
<code>GIT_COMMITTER_DATE</code> - same</li>
<li><code>GIT_AUTHOR_NAME</code></li>
<li><code>GIT_AUTHOR_EMAIL</code></li>
<li><code>GIT_COMMITTER_NAME</code></li>
<li><code>GIT_COMMITTER_EMAIL</code></li>
</ul>
<p>I figured this out through asking <a href="https://claude.ai/" rel="nofollow">Claude</a> to write me a script to rebuild my repo based on those last modified dates:</p>
<blockquote>
<p>I want to create a GitHub repository where I back-date files to when they were first created</p>
<p>I have the files on my local disk like this:</p>
<pre><code>-rw-r--r--   1 simon  wheel   1.5K Sep  4  1991 Anchor.h
-rw-r--r--   1 simon  wheel   8.1K Sep  4  1991 Anchor.m
-rw-r--r--   1 simon  wheel   3.6K Dec  1  1993 Bugs.html
</code></pre>
<p>Write me a Python script I can run which will group files by date and then do one grouped commit for each of those dates, backdated to the date (at 00:00), with an author that I pass to the script like this:</p>
<p><code>populate-git-repo-historically . --author &#34;Simon Blah&#34;</code></p>
<p>It should assume a .git repo is already there with nothing in it, it should print out the commit hash and backdated date for everything it commits</p>
</blockquote>
<p>It gave me <a href="https://claude.site/artifacts/6c4bb4e1-6bae-4d1e-8270-640c3b06f645" rel="nofollow">this</a>, and I followed-up with:</p>
<blockquote>
<p>Problem: the script you wrote sets the commit date to now - I want the commit date to be backdated to the author date</p>
</blockquote>
<p>Which got <a href="https://claude.site/artifacts/6546a006-9e39-485b-9fde-7b98bf67420e" rel="nofollow">this v2</a> - almost right, but I made one more tweak:</p>
<blockquote>
<p>Set the committer to the same as the author</p>
</blockquote>
<p>And that produced <a href="https://claude.site/artifacts/d51a8003-a39b-48fb-99f0-8603c8cd1ed4" rel="nofollow">a v3</a> which ran correctly, but made a weird editorial choice to use <code>@example.com</code> in the commit messages. I fixed that and ended up with this script - all comments are by me:</p>
<div><pre><span>import</span> <span>os</span>
<span>import</span> <span>sys</span>
<span>import</span> <span>argparse</span>
<span>from</span> <span>datetime</span> <span>import</span> <span>datetime</span>
<span>from</span> <span>collections</span> <span>import</span> <span>defaultdict</span>
<span>import</span> <span>subprocess</span>


<span>def</span> <span>get_file_date</span>(<span>file_path</span>):
    <span>return</span> <span>datetime</span>.<span>fromtimestamp</span>(<span>os</span>.<span>path</span>.<span>getmtime</span>(<span>file_path</span>)).<span>date</span>()


<span>def</span> <span>group_files_by_date</span>(<span>directory</span>):
    <span># I decided to group files edited on the same day in a single commit:</span>
    <span>grouped_files</span> <span>=</span> <span>defaultdict</span>(<span>list</span>)
    <span>for</span> <span>root</span>, <span>_</span>, <span>files</span> <span>in</span> <span>os</span>.<span>walk</span>(<span>directory</span>):
        <span>for</span> <span>file</span> <span>in</span> <span>files</span>:
            <span>if</span> <span>file</span>.<span>startswith</span>(<span>&#34;.&#34;</span>):
                <span>continue</span>
            <span>file_path</span> <span>=</span> <span>os</span>.<span>path</span>.<span>join</span>(<span>root</span>, <span>file</span>)
            <span># I added this hack to skip the .git directory</span>
            <span>if</span> <span>&#34;.git&#34;</span> <span>in</span> <span>file_path</span>:
                <span>continue</span>
            <span>file_date</span> <span>=</span> <span>get_file_date</span>(<span>file_path</span>)
            <span>grouped_files</span>[<span>file_date</span>].<span>append</span>(<span>file_path</span>)
    <span>return</span> <span>grouped_files</span>


<span>def</span> <span>commit_files</span>(<span>files</span>, <span>date</span>, <span>author</span>, <span>author_email</span>):
    <span>print</span>(<span>files</span>)
    <span>for</span> <span>file</span> <span>in</span> <span>files</span>:
        <span>subprocess</span>.<span>run</span>([<span>&#34;git&#34;</span>, <span>&#34;add&#34;</span>, <span>file</span>], <span>check</span><span>=</span><span>True</span>)

    <span>commit_date</span> <span>=</span> <span>date</span>.<span>strftime</span>(<span>&#34;%Y-%m-%d 00:00:00&#34;</span>)
    <span>commit_message</span> <span>=</span> <span>f&#34;Adding files from <span><span>{</span><span>date</span><span>}</span></span>&#34;</span>

    <span>env</span> <span>=</span> <span>os</span>.<span>environ</span>.<span>copy</span>()
    <span># Here&#39;This is the most important bit: these environment variables are used</span>
    <span># by Git to set the author and committer dates and names</span>
    <span>env</span>[<span>&#34;GIT_AUTHOR_DATE&#34;</span>] <span>=</span> <span>commit_date</span>
    <span>env</span>[<span>&#34;GIT_COMMITTER_DATE&#34;</span>] <span>=</span> <span>commit_date</span>
    <span>env</span>[<span>&#34;GIT_AUTHOR_NAME&#34;</span>] <span>=</span> <span>author</span>
    <span>env</span>[<span>&#34;GIT_AUTHOR_EMAIL&#34;</span>] <span>=</span> <span>author_email</span>
    <span>env</span>[<span>&#34;GIT_COMMITTER_NAME&#34;</span>] <span>=</span> <span>author</span>
    <span>env</span>[<span>&#34;GIT_COMMITTER_EMAIL&#34;</span>] <span>=</span> <span>author_email</span>

    <span>result</span> <span>=</span> <span>subprocess</span>.<span>run</span>(
        [<span>&#34;git&#34;</span>, <span>&#34;commit&#34;</span>, <span>&#34;-m&#34;</span>, <span>commit_message</span>],
        <span>capture_output</span><span>=</span><span>True</span>,
        <span>text</span><span>=</span><span>True</span>,
        <span>check</span><span>=</span><span>True</span>,
        <span>env</span><span>=</span><span>env</span>,
    )

    <span>commit_hash</span> <span>=</span> <span>result</span>.<span>stdout</span>.<span>split</span>()[<span>1</span>]
    <span>return</span> <span>commit_hash</span>


<span>def</span> <span>main</span>():
    <span>parser</span> <span>=</span> <span>argparse</span>.<span>ArgumentParser</span>(
        <span>description</span><span>=</span><span>&#34;Populate Git repo with historical commits&#34;</span>
    )
    <span>parser</span>.<span>add_argument</span>(<span>&#34;directory&#34;</span>, <span>help</span><span>=</span><span>&#34;Directory containing the files&#34;</span>)
    <span>parser</span>.<span>add_argument</span>(<span>&#34;--author&#34;</span>, <span>required</span><span>=</span><span>True</span>, <span>help</span><span>=</span><span>&#34;Author of the commits&#34;</span>)
    <span># I added this option by hand:</span>
    <span>parser</span>.<span>add_argument</span>(<span>&#34;--email&#34;</span>, <span>required</span><span>=</span><span>True</span>, <span>help</span><span>=</span><span>&#34;Email of author&#34;</span>)
    <span>args</span> <span>=</span> <span>parser</span>.<span>parse_args</span>()

    <span>os</span>.<span>chdir</span>(<span>args</span>.<span>directory</span>)

    <span>if</span> <span>not</span> <span>os</span>.<span>path</span>.<span>exists</span>(<span>&#34;.git&#34;</span>):
        <span>print</span>(
            <span>&#34;Error: No .git directory found. Please initialize a Git repository first.&#34;</span>
        )
        <span>sys</span>.<span>exit</span>(<span>1</span>)

    <span>grouped_files</span> <span>=</span> <span>group_files_by_date</span>(<span>args</span>.<span>directory</span>)

    <span>for</span> <span>date</span>, <span>files</span> <span>in</span> <span>sorted</span>(<span>grouped_files</span>.<span>items</span>()):
        <span>commit_hash</span> <span>=</span> <span>commit_files</span>(<span>files</span>, <span>date</span>, <span>args</span>.<span>author</span>, <span>args</span>.<span>email</span>)
        <span>print</span>(<span>f&#34;Commit: <span><span>{</span><span>commit_hash</span><span>}</span></span>, Date: <span><span>{</span><span>date</span><span>}</span></span>&#34;</span>)


<span>if</span> <span>__name__</span> <span>==</span> <span>&#34;__main__&#34;</span>:
    <span>main</span>()</pre></div>
<p>Then I saved it in <code>/tmp/populate.py</code> and ran it like this:</p>
<div><pre>git init
python /tmp/populate.py <span>.</span> --author <span><span>&#39;</span>Tim Berners-Lee<span>&#39;</span></span> --email <span><span>&#39;</span>tbl@none<span>&#39;</span></span></pre></div>
<p>I iterated on this a bunch of times, each time running <code>rm -rf .git &amp;&amp; git init</code> first to reset state.</p>
<div><h2>Pushing the result to GitHub</h2></div>
<p>Once I was happy with the result (checked using <code>git log</code>) I pushed it to my repository on GitHub like this:</p>
<div><pre>git remote add origin https://github.com/simonw/1991-WWW-NeXT-Implementation.git     
git branch -M main
git push -u origin main --force</pre></div>
<p>The <code>--force</code> there replaces the existing <code>main</code> branch on GitHub entirely - useful for iterating on the script and then replacing the results.</p>
<p>Finally, I added the <code>README.md</code> file using the GitHub web interface.</p>




  
  


<p>Created 2024-08-01T14:08:13-07:00 · <a href="https://github.com/simonw/til/blob/main/git/backdate-git-commits.md">Edit</a></p>



</section></div>
  </body>
</html>
