<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.grepular.com/Fun_with_Gzip_Bombs_and_Email_Clients">Original</a>
    <h1>Fun with gzip bombs and email clients</h1>
    
    <div id="readability-page-1" class="page"><div><p>Gzip/Zip bombs have been a thing for decades. Lets create a 10MB gzip file which decompresses to 10GB:</p>
<pre><code>dd <span>if</span>=/dev/zero <span>bs</span>=1G <span>count</span>=10 | gzip &gt; 10gb.gz
</code></pre><p>This is called a Gzip bomb, because when it is decompressed, it blows up to a much larger size (~1000 larger). Add it your website document root and configure <a href="https://nginx.org/">Nginx</a> to serve it up as an image, with gzip Content-Encoding:</p>
<pre><code><span>location</span> /10gb.png {
    <span>default_type</span> image/png;
    <span>add_header</span>   Content-Encoding gzip;
    <span>try_files</span>    /10gb.gz =<span>404</span>;
}
</code></pre><p>An HTTP client which fetches this file will see that the Content-Encoding is set to gzip and so will usually try to decompress it on the fly, meaning you will have sent 10MB of data over the network, but the HTTP client will now have 10GB of data to deal with.</p>
<p><a href="https://getfirefox.com">Firefox</a> doesn’t seem to have an issue with this. It figures out pretty quickly that it’s not an image and doesn’t seem to store the decompressed data anywhere.</p>
<p>What about email clients though? And what about the proxies that some email services have started to use to hide your IP from the sender? Send a html email containing:</p>
<pre><code>&lt;img <span>src</span>=<span>&#34;https://YOUR_WEBSITE/10gb.png&#34;</span>&gt;
</code></pre><p><a href="https://getthunderbird.com">Thunderbird</a> and Gmail’s web proxies, start to fetch the image, but bail out early before finishing fetching the 10MB. I’m not sure if this is because they can tell it’s not an image, or because they’re decompressing it, and hit a limit. Hopefully the latter. Either way, it works well.</p>
<p><a href="https://proton.me/mail">Protonmail</a> and iCloud webmail’s proxies seem to fetch the whole 10MB file, but discard it. Protonmail will warn you that it failed to load the image, and give you the option of loading it directly from your web browser (not using their proxy). If you say yes, you leak your IP, but the browser doesn’t crash. This works well.</p>
<p><a href="https://www.fastmail.com/">Fastmail</a> webmail’s proxies downloaded the full 10MB and proceeded to send me 385MB of data before giving up. The UI remained responsive, so although they should have bailed earlier, at least it works. I wonder if there is a 10GB file sat on one of their servers now.</p>
<p>iOS Mail partially downloads the file and then crashes. Not a great experience, but not the end of the World; you can just delete the email when you get back in.</p>
<p><a href="https://wiki.gnome.org/Apps/Evolution">Evolution Mail</a> has no defense for this. It downloads the whole 10MB and then proceeds to fully decompress it into its cache/evolution/http/ directory. I sent myself an email with this in the body:</p>
<pre><code>&lt;img <span>src</span>=<span>&#34;https://YOUR_HOSTNAME/10gb.png&#34;</span>&gt;
&lt;img <span>src</span>=<span>&#34;https://YOUR_HOSTNAME/10gb.png?x=1&#34;</span>&gt;
&lt;img <span>src</span>=<span>&#34;https://YOUR_HOSTNAME/10gb.png?x=2&#34;</span>&gt;
&lt;img <span>src</span>=<span>&#34;https://YOUR_HOSTNAME/10gb.png?x=3&#34;</span>&gt;
&lt;img <span>src</span>=<span>&#34;https://YOUR_HOSTNAME/10gb.png?x=4&#34;</span>&gt;
&lt;img <span>src</span>=<span>&#34;https://YOUR_HOSTNAME/10gb.png?x=5&#34;</span>&gt;
&lt;img <span>src</span>=<span>&#34;https://YOUR_HOSTNAME/10gb.png?x=6&#34;</span>&gt;
&lt;img <span>src</span>=<span>&#34;https://YOUR_HOSTNAME/10gb.png?x=7&#34;</span>&gt;
&lt;img <span>src</span>=<span>&#34;https://YOUR_HOSTNAME/10gb.png?x=8&#34;</span>&gt;
&lt;img <span>src</span>=<span>&#34;https://YOUR_HOSTNAME/10gb.png?x=9&#34;</span>&gt;
</code></pre><p>In less than a minute after clicking “Load remote content”, Evolution Mail had added 100GB of data to my laptops disk.</p>
<p>It’s always a good idea to code defensively when you’re fetching data from external services. Always assume some smart arse will make their server send you more data than is reasonable.</p>
<p>Another weird thing I noticed about Evolution Mail when testing this. It caches the downloaded remote content in a file with a filename consisting of an MD5 of the URL. But if you don’t use one of the limited query string formats they like, they remove the query string from the MD5 calculation. According to Evolution Mail’s cache these two URLs are the same and should be cached to the same file:</p>
<ul>
<li><a href="https://www.example.com/foo?image1">https://www.example.com/foo?image1</a></li>
<li><a href="https://www.example.com/foo?image2">https://www.example.com/foo?image2</a></li>
</ul>
<p>So if you receive an email containing an &lt;img src=”<a href="https://www.example.com/foo?image1&#34;&gt;">https://www.example.com/foo?image1&#34;&gt;</a>, and then receive a second email containing an &lt;img src=”<a href="https://www.example.com/foo?image2&#34;&gt;">https://www.example.com/foo?image2&#34;&gt;</a> the cached image from the first email is displayed in the second email.</p>
</div><p>Want to leave a tip?<a href="bitcoin:1PQLtWnjUi1itHLG6QCQeHM3Nxua8pRsq1" title="Donate Bitcoin"><img alt="Bitcoin" src="https://www.grepular.com/images/bitcoin.png"/></a><a href="xmr:44zg8QFZza5cMBWcEF4VqsU5panam7tMhfB6fFdzWbDpBcaVy7feqQXKD92smbYGy3C7KPA6d7Q6UWY8f11noJLWUrVKJAK" title="Donate Monero"><img alt="Monero" src="https://www.grepular.com/images/monero.svg" width="26" height="26"/></a><a href="zcash:zcAN9ij9YZ7Cc9HMqCfcjpusELTTKQWutgjSRH9Dxx5E4DLTKTxRye5FgFs7vDPn1edSoBNFvLPTxn7byjgwQaMVJeJ64kQ" title="Donate Zcash"><img alt="Zcash" src="https://www.grepular.com/images/zcash.png"/></a><a href="https://www.paypal.me/grepular" title="Donate via Paypal" rel="noreferrer"><img alt="Paypal" src="https://www.grepular.com/images/paypal.png"/></a>You can follow this Blog using <a href="https://www.grepular.com/rss">RSS</a> or <a href="https://mastodon.social/@grepular" rel="noreferrer">Mastodon</a>. To read more, visit my <a href="https://www.grepular.com/blog">blog index</a>.</p></div>
  </body>
</html>
