<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://danielchasehooper.com/posts/code-animated-rick/">Original</a>
    <h1>Programming SDF animations of Rick and Morty</h1>
    
    <div id="readability-page-1" class="page"><div><div></div><p>This animation of Rick was made with 240 lines of code. No libraries, no images. I’m going to show you how to use GPU shaders and signed distance fields to make animations like it for videos, video games, or just for fun! I even built a live coding editor into the page so you can see the examples running and tinker with them.</p><div><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>vec2</span> <span>rotateAt</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>angle</span><span>,</span> <span>vec2</span> <span>origin</span><span>)</span> <span>{</span> 
</span></span><span><span>    <span>float</span> <span>s</span> <span>=</span> <span>sin</span><span>(</span><span>angle</span><span>),</span> <span>c</span> <span>=</span> <span>cos</span><span>(</span><span>angle</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>(</span><span>p</span><span>-</span><span>origin</span><span>)</span><span>*</span><span>mat2</span><span>(</span> <span>c</span><span>,</span> <span>-</span><span>s</span><span>,</span> <span>s</span><span>,</span> <span>c</span> <span>)</span> <span>+</span> <span>origin</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>map</span><span>(</span><span>float</span> <span>value</span><span>,</span> <span>float</span> <span>inMin</span><span>,</span> <span>float</span> <span>inMax</span><span>,</span> <span>float</span> <span>outMin</span><span>,</span> <span>float</span> <span>outMax</span><span>)</span> <span>{</span> 
</span></span><span><span>  <span>value</span> <span>=</span> <span>clamp</span><span>(</span><span>value</span><span>,</span> <span>inMin</span><span>,</span> <span>inMax</span><span>);</span>
</span></span><span><span>  <span>return</span> <span>outMin</span> <span>+</span> <span>(</span><span>outMax</span> <span>-</span> <span>outMin</span><span>)</span> <span>*</span> <span>(</span><span>value</span> <span>-</span> <span>inMin</span><span>)</span> <span>/</span> <span>(</span><span>inMax</span> <span>-</span> <span>inMin</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>vec2</span> <span>grad</span><span>(</span><span>ivec2</span> <span>z</span><span>)</span>  <span>{</span> 
</span></span><span><span>    <span>int</span> <span>n</span> <span>=</span> <span>z</span><span>.</span><span>x</span><span>+</span><span>z</span><span>.</span><span>y</span><span>*</span><span>11111</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>=</span> <span>(</span><span>n</span><span>&lt;&lt;</span><span>13</span><span>)</span><span>^</span><span>n</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>=</span> <span>(</span><span>n</span><span>*</span><span>(</span><span>n</span><span>*</span><span>n</span><span>*</span><span>15731</span><span>+</span><span>789221</span><span>)</span><span>+</span><span>1376312589</span><span>)</span><span>&gt;&gt;</span><span>16</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>&amp;=</span> <span>7</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>gr</span> <span>=</span> <span>vec2</span><span>(</span><span>n</span><span>&amp;</span><span>1</span><span>,</span><span>n</span><span>&gt;&gt;</span><span>1</span><span>)</span><span>*</span><span>2.0</span><span>-</span><span>1.0</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>(</span> <span>n</span><span>&gt;=</span><span>6</span> <span>)</span> <span>?</span> <span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>gr</span><span>.</span><span>x</span><span>)</span> <span>:</span> 
</span></span><span><span>           <span>(</span> <span>n</span><span>&gt;=</span><span>4</span> <span>)</span> <span>?</span> <span>vec2</span><span>(</span><span>gr</span><span>.</span><span>x</span><span>,</span><span>0.0</span><span>)</span> <span>:</span>
</span></span><span><span>                              <span>gr</span><span>;</span>                            
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>noise</span><span>(</span><span>vec2</span> <span>p</span><span>)</span> <span>{</span> 
</span></span><span><span>    <span>ivec2</span> <span>i</span> <span>=</span> <span>ivec2</span><span>(</span><span>floor</span><span>(</span><span>p</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>f</span> <span>=</span>       <span>fract</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>vec2</span> <span>u</span> <span>=</span> <span>f</span><span>*</span><span>f</span><span>*</span><span>(</span><span>3.0</span><span>-</span><span>2.0</span><span>*</span><span>f</span><span>);</span> 
</span></span><span><span>    <span>return</span> <span>mix</span><span>(</span> <span>mix</span><span>(</span> <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>0</span><span>,</span><span>0</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>0.0</span><span>)</span> <span>),</span> 
</span></span><span><span>                     <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>1</span><span>,</span><span>0</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>1.0</span><span>,</span><span>0.0</span><span>)</span> <span>),</span> <span>u</span><span>.</span><span>x</span><span>),</span>
</span></span><span><span>                <span>mix</span><span>(</span> <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>0</span><span>,</span><span>1</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>1.0</span><span>)</span> <span>),</span> 
</span></span><span><span>                     <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>1</span><span>,</span><span>1</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>1.0</span><span>,</span><span>1.0</span><span>)</span> <span>),</span> <span>u</span><span>.</span><span>x</span><span>),</span> <span>u</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>vec2</span> <span>warp</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>scale</span><span>,</span> <span>float</span> <span>strength</span><span>)</span> <span>{</span> 
</span></span><span><span>    <span>float</span> <span>offsetX</span> <span>=</span> <span>noise</span><span>(</span><span>p</span> <span>*</span> <span>scale</span> <span>+</span> <span>vec2</span><span>(</span><span>0.0</span><span>,</span> <span>100.0</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>offsetY</span> <span>=</span> <span>noise</span><span>(</span><span>p</span> <span>*</span> <span>scale</span> <span>+</span> <span>vec2</span><span>(</span><span>100.0</span><span>,</span> <span>0.0</span><span>));</span>
</span></span><span><span>    <span>return</span> <span>p</span> <span>+</span> <span>vec2</span><span>(</span><span>offsetX</span><span>,</span> <span>offsetY</span><span>)</span> <span>*</span> <span>strength</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>bezier</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>v0</span><span>,</span> <span>vec2</span> <span>v1</span><span>,</span> <span>vec2</span> <span>v2</span><span>)</span> <span>{</span> 
</span></span><span><span>    <span>vec2</span> <span>i</span> <span>=</span> <span>v0</span> <span>-</span> <span>v2</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>j</span> <span>=</span> <span>v2</span> <span>-</span> <span>v1</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>k</span> <span>=</span> <span>v1</span> <span>-</span> <span>v0</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>w</span> <span>=</span> <span>j</span><span>-</span><span>k</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>v0</span><span>-=</span> <span>p</span><span>;</span> <span>v1</span><span>-=</span> <span>p</span><span>;</span> <span>v2</span><span>-=</span> <span>p</span><span>;</span>
</span></span><span><span>    
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>v0</span><span>.</span><span>x</span><span>*</span><span>v2</span><span>.</span><span>y</span><span>-</span><span>v0</span><span>.</span><span>y</span><span>*</span><span>v2</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>y</span> <span>=</span> <span>v1</span><span>.</span><span>x</span><span>*</span><span>v0</span><span>.</span><span>y</span><span>-</span><span>v1</span><span>.</span><span>y</span><span>*</span><span>v0</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>z</span> <span>=</span> <span>v2</span><span>.</span><span>x</span><span>*</span><span>v1</span><span>.</span><span>y</span><span>-</span><span>v2</span><span>.</span><span>y</span><span>*</span><span>v1</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>vec2</span> <span>s</span> <span>=</span> <span>2.0</span><span>*</span><span>(</span><span>y</span><span>*</span><span>j</span><span>+</span><span>z</span><span>*</span><span>k</span><span>)</span><span>-</span><span>x</span><span>*</span><span>i</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span>  <span>(</span><span>y</span><span>*</span><span>z</span><span>-</span><span>x</span><span>*</span><span>x</span><span>*</span><span>0.25</span><span>)</span><span>/</span><span>dot</span><span>(</span><span>s</span><span>,</span><span>s</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>t</span> <span>=</span> <span>clamp</span><span>(</span> <span>(</span><span>0.5</span><span>*</span><span>x</span><span>+</span><span>y</span><span>+</span><span>r</span><span>*</span><span>dot</span><span>(</span><span>s</span><span>,</span><span>w</span><span>))</span><span>/</span><span>(</span><span>x</span><span>+</span><span>y</span><span>+</span><span>z</span><span>),</span><span>0.0</span><span>,</span><span>1.0</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>vec2</span> <span>d</span> <span>=</span> <span>v0</span><span>+</span><span>t</span><span>*</span><span>(</span><span>k</span><span>+</span><span>k</span><span>+</span><span>t</span><span>*</span><span>w</span><span>);</span>
</span></span><span><span>    <span>vec2</span> <span>outQ</span> <span>=</span> <span>d</span> <span>+</span> <span>p</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>d</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>parabola</span><span>(</span><span>vec2</span> <span>pos</span><span>,</span> <span>float</span> <span>k</span><span>)</span> <span>{</span> 
</span></span><span><span>    <span>// from https://www.shadertoy.com/view/ws3GD7</span>
</span></span><span><span>    <span>pos</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>ik</span> <span>=</span> <span>1.0</span><span>/</span><span>k</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>p</span> <span>=</span> <span>ik</span><span>*</span><span>(</span><span>pos</span><span>.</span><span>y</span> <span>-</span> <span>0.5</span><span>*</span><span>ik</span><span>)</span><span>/</span><span>3.0</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>q</span> <span>=</span> <span>0.25</span><span>*</span><span>ik</span><span>*</span><span>ik</span><span>*</span><span>pos</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>h</span> <span>=</span> <span>q</span><span>*</span><span>q</span> <span>-</span> <span>p</span><span>*</span><span>p</span><span>*</span><span>p</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span> <span>sqrt</span><span>(</span><span>abs</span><span>(</span><span>h</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>(</span><span>h</span><span>&gt;</span><span>0.0</span><span>)</span> <span>?</span> 
</span></span><span><span>        <span>pow</span><span>(</span><span>q</span><span>+</span><span>r</span><span>,</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span> <span>-</span> <span>pow</span><span>(</span><span>abs</span><span>(</span><span>q</span><span>-</span><span>r</span><span>),</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>r</span><span>-</span><span>q</span><span>)</span> <span>:</span>
</span></span><span><span>        <span>2.0</span><span>*</span><span>cos</span><span>(</span><span>atan</span><span>(</span><span>r</span><span>,</span><span>q</span><span>)</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sqrt</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>pos</span><span>-</span><span>vec2</span><span>(</span><span>x</span><span>,</span><span>k</span><span>*</span><span>x</span><span>*</span><span>x</span><span>))</span> <span>*</span> <span>sign</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>-</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>round_rect</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>b</span><span>,</span> <span>vec4</span> <span>r</span><span>)</span> <span>{</span> 
</span></span><span><span>    <span>r</span><span>.</span><span>xy</span> <span>=</span> <span>(</span><span>p</span><span>.</span><span>x</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>r</span><span>.</span><span>xy</span> <span>:</span> <span>r</span><span>.</span><span>zw</span><span>;</span>
</span></span><span><span>    <span>r</span><span>.</span><span>x</span>  <span>=</span> <span>(</span><span>p</span><span>.</span><span>y</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>r</span><span>.</span><span>x</span>  <span>:</span> <span>r</span><span>.</span><span>y</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>q</span> <span>=</span> <span>abs</span><span>(</span><span>p</span><span>)</span><span>-</span><span>b</span><span>+</span><span>r</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>min</span><span>(</span><span>max</span><span>(</span><span>q</span><span>.</span><span>x</span><span>,</span><span>q</span><span>.</span><span>y</span><span>),</span><span>0.0</span><span>)</span> <span>+</span> <span>length</span><span>(</span><span>max</span><span>(</span><span>q</span><span>,</span><span>0.0</span><span>))</span> <span>-</span> <span>r</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>star</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>r</span><span>,</span> <span>float</span> <span>points</span><span>,</span> <span>float</span> <span>ratio</span><span>)</span> <span>{</span> 
</span></span><span><span>    <span>// next 4 lines can be precomputed for a given shape</span>
</span></span><span><span>    <span>float</span> <span>an</span> <span>=</span> <span>3.141593</span><span>/</span><span>points</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>en</span> <span>=</span> <span>3.141593</span><span>/</span><span>(</span><span>ratio</span><span>*</span><span>(</span><span>points</span><span>-</span><span>2.</span><span>)</span> <span>+</span> <span>2.</span><span>);</span> 
</span></span><span><span>    <span>vec2</span>  <span>acs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>an</span><span>),</span><span>sin</span><span>(</span><span>an</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>ecs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>en</span><span>),</span><span>sin</span><span>(</span><span>en</span><span>));</span> <span>// ecs=vec2(0,1) for regular polygon</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>bn</span> <span>=</span> <span>mod</span><span>(</span><span>atan</span><span>(</span><span>p</span><span>.</span><span>x</span><span>,</span><span>p</span><span>.</span><span>y</span><span>),</span><span>2.0</span><span>*</span><span>an</span><span>)</span> <span>-</span> <span>an</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>=</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>vec2</span><span>(</span><span>cos</span><span>(</span><span>bn</span><span>),</span><span>abs</span><span>(</span><span>sin</span><span>(</span><span>bn</span><span>)));</span>
</span></span><span><span>    <span>p</span> <span>-=</span> <span>r</span><span>*</span><span>acs</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>+=</span> <span>ecs</span><span>*</span><span>clamp</span><span>(</span> <span>-</span><span>dot</span><span>(</span><span>p</span><span>,</span><span>ecs</span><span>),</span> <span>0.0</span><span>,</span> <span>r</span><span>*</span><span>acs</span><span>.</span><span>y</span><span>/</span><span>ecs</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>p</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>#define H(i,j) fract(sin(dot(ceil(P+vec2(i,j)), resolution.xy )) * 4e3)</span>
</span></span><span><span><span>float</span> <span>N</span><span>(</span> <span>vec2</span> <span>P</span><span>)</span> <span>{</span> 
</span></span><span><span>    <span>float</span> <span>s</span><span>,</span><span>i</span><span>,</span><span>w</span> <span>=</span> <span>.5</span><span>;</span>
</span></span><span><span>    <span>for</span> <span>(;</span> <span>i</span> <span>&lt;</span> <span>3.</span> <span>;</span> <span>i</span><span>++</span><span>,</span> <span>w</span> <span>*=</span> <span>.4</span><span>,</span> <span>P</span> <span>*=</span> <span>1.9</span> <span>)</span> <span>{</span>
</span></span><span><span>        <span>vec2</span> <span>F</span> <span>=</span> <span>fract</span><span>(</span> <span>P</span> <span>*=</span> <span>mat2</span><span>(</span><span>.866</span><span>,</span><span>-</span><span>.5</span><span>,</span><span>.5</span><span>,</span><span>.866</span><span>)</span> <span>);</span> 
</span></span><span><span>        <span>F</span> <span>*=</span> <span>F</span><span>*</span><span>(</span><span>3.</span><span>-</span><span>F</span><span>-</span><span>F</span><span>);</span>
</span></span><span><span>        <span>s</span> <span>+=</span> <span>w</span><span>*</span> <span>mix</span><span>(</span> <span>mix</span><span>(</span><span>H</span><span>(</span><span>0</span><span>,</span><span>0</span><span>)</span> <span>,</span> <span>H</span><span>(</span><span>1</span><span>,</span><span>0</span><span>),</span> <span>F</span><span>.</span><span>x</span><span>),</span>
</span></span><span><span>                     <span>mix</span><span>(</span><span>H</span><span>(</span><span>0</span><span>,</span><span>1</span><span>)</span> <span>,</span> <span>H</span><span>(</span><span>1</span><span>,</span><span>1</span><span>),</span> <span>F</span><span>.</span><span>x</span><span>),</span>
</span></span><span><span>                     <span>F</span><span>.</span><span>y</span> <span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>    <span>return</span> <span>s</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>vec3</span> <span>portal</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span> 
</span></span><span><span>    <span>float</span> <span>l</span> <span>=</span> <span>length</span><span>(</span> <span>pixel</span> <span>),</span> 
</span></span><span><span>          <span>a</span> <span>=</span> <span>atan</span><span>(</span><span>pixel</span><span>.</span><span>y</span><span>,</span> <span>pixel</span><span>.</span><span>x</span><span>)</span> <span>/</span> <span>6.28</span> <span>+</span> <span>.5</span><span>,</span>
</span></span><span><span>          <span>k</span> <span>=</span> <span>10.</span><span>;</span>
</span></span><span><span>     
</span></span><span><span>    <span>a</span> <span>=</span> <span>fract</span><span>(</span><span>a</span> <span>+</span> <span>l</span><span>*</span><span>.3</span> <span>-</span> <span>time</span><span>*</span><span>.01</span> <span>);</span>
</span></span><span><span>    <span>vec2</span> <span>U</span> <span>=</span> <span>vec2</span><span>(</span> <span>l</span><span>+</span><span>time</span><span>*</span><span>.3</span><span>,</span> <span>a</span> <span>);</span>
</span></span><span><span>     
</span></span><span><span>    <span>return</span> <span>vec3</span><span>[](</span> <span>vec3</span><span>(</span><span>.18</span><span>,</span> <span>.53</span><span>,</span> <span>.09</span><span>),</span>
</span></span><span><span>                    <span>vec3</span><span>(</span><span>.56</span><span>,</span> <span>.89</span><span>,</span> <span>.16</span><span>),</span>
</span></span><span><span>                    <span>vec3</span><span>(</span><span>.35</span><span>,</span> <span>.84</span><span>,</span> <span>.11</span><span>),</span>
</span></span><span><span>                    <span>vec3</span><span>(</span><span>.92</span><span>,</span> <span>.98</span><span>,</span> <span>.85</span><span>)</span>
</span></span><span><span>                  <span>)</span> <span>[</span> <span>int</span><span>(</span> <span>4.</span><span>*</span> <span>pow</span><span>(</span> <span>mix</span><span>(</span> <span>N</span><span>(</span><span>U</span><span>*</span><span>k</span><span>),</span> <span>N</span><span>(</span><span>U</span><span>*</span><span>k</span><span>-</span><span>vec2</span><span>(</span><span>0</span><span>,</span><span>k</span><span>)),</span> <span>U</span><span>.</span><span>y</span><span>)</span> <span>*</span> <span>1.5</span><span>,</span> <span>2.5</span><span>))];</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span> 
</span></span><span><span>    <span>{</span> 
</span></span><span><span>        <span>// rotate the whole drawing</span>
</span></span><span><span>        <span>pixel</span> <span>=</span> <span>rotateAt</span><span>(</span><span>pixel</span><span>,</span> <span>sin</span><span>(</span><span>time</span><span>*</span><span>2.</span><span>)</span><span>*</span><span>.1</span><span>,</span> <span>vec2</span><span>(</span><span>0</span><span>,</span><span>-</span><span>.6</span><span>));</span>
</span></span><span><span>        <span>pixel</span><span>.</span><span>y</span> <span>+=</span> <span>.1</span><span>;</span>
</span></span><span><span>    
</span></span><span><span>    
</span></span><span><span>    <span>// Blink eyes</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>mod</span><span>(</span><span>time</span><span>+</span><span>1.</span><span>,</span> <span>3.</span><span>)</span> <span>&lt;</span> <span>.09</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>// closed eyes</span>
</span></span><span><span>        <span>float</span> <span>d</span> <span>=</span> <span>round_rect</span><span>(</span><span>pixel</span><span>+</span><span>vec2</span><span>(</span><span>.07</span><span>,</span><span>-</span><span>.16</span><span>),</span> <span>vec2</span><span>(</span><span>.24</span><span>,</span><span>0</span><span>),</span> <span>vec4</span><span>(</span><span>0</span><span>));</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.008</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>      
</span></span><span><span>    <span>}</span> 
</span></span><span><span>    <span>else</span> <span>{</span> 
</span></span><span><span>        <span>// move pupils randomly</span>
</span></span><span><span>        <span>vec2</span> <span>pupil_warp</span> <span>=</span> <span>pixel</span> <span>+</span> <span>vec2</span><span>(</span><span>.095</span><span>,</span><span>-</span><span>.18</span><span>);</span>
</span></span><span><span>        <span>pupil_warp</span><span>.</span><span>x</span> <span>-=</span> <span>noise</span><span>(</span><span>vec2</span><span>(</span><span>round</span><span>(</span><span>time</span><span>)</span><span>*</span><span>7.</span><span>+</span><span>.5</span><span>,</span> <span>0.5</span><span>))</span><span>*</span><span>.1</span><span>;</span>
</span></span><span><span>        <span>pupil_warp</span><span>.</span><span>y</span> <span>-=</span> <span>noise</span><span>(</span><span>vec2</span><span>(</span><span>round</span><span>(</span><span>time</span><span>)</span><span>*</span><span>9.</span><span>+</span><span>.5</span><span>,</span> <span>0.5</span><span>))</span><span>*</span><span>.1</span><span>;</span>
</span></span><span><span>        <span>pupil_warp</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pupil_warp</span><span>.</span><span>x</span><span>)</span> <span>-</span> <span>.16</span><span>;</span>
</span></span><span><span>        <span>float</span> <span>d</span> <span>=</span> <span>star</span><span>(</span><span>pupil_warp</span><span>,</span> <span>0.019</span><span>,</span> <span>6.</span><span>,</span> <span>.9</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.007</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>.1</span><span>);</span>
</span></span><span><span>        <span>}</span>
</span></span><span><span>            
</span></span><span><span>        <span>// Eyeballs</span>
</span></span><span><span>        <span>vec2</span> <span>eye</span> <span>=</span> <span>vec2</span><span>(</span><span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.1</span><span>)</span><span>-</span><span>.17</span><span>,</span> <span>pixel</span><span>.</span><span>y</span><span>*</span><span>.93</span> <span>-</span> <span>.16</span><span>);</span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>length</span><span>(</span><span>eye</span><span>)</span> <span>-</span> <span>.16</span><span>;</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>step</span><span>(</span><span>.013</span><span>,</span> <span>-</span><span>d</span><span>));</span>
</span></span><span><span>        
</span></span><span><span>        <span>// under eye lines</span>
</span></span><span><span>        <span>bool</span> <span>should_show</span> <span>=</span> <span>pixel</span><span>.</span><span>y</span> <span>&lt;</span> <span>0.25</span> <span>&amp;&amp;</span> 
</span></span><span><span>            <span>(</span><span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.29</span><span>)</span> <span>&lt;</span> <span>.05</span> <span>||</span> 
</span></span><span><span>            <span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>-</span><span>.12</span><span>)</span> <span>&lt;</span> <span>.085</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>abs</span><span>(</span><span>d</span> <span>-</span> <span>.04</span><span>)</span> <span>&lt;</span> <span>.0055</span> <span>&amp;&amp;</span> <span>should_show</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>  
</span></span><span><span>    
</span></span><span><span>        <span>// Mouth</span>
</span></span><span><span>        <span>float</span> <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>pixel</span><span>,</span>  
</span></span><span><span>                     <span>vec2</span><span>(</span><span>-</span><span>.26</span><span>,</span> <span>-</span><span>.28</span><span>),</span> 
</span></span><span><span>                     <span>vec2</span><span>(</span><span>-</span><span>.05</span><span>,</span><span>-</span><span>.42</span><span>),</span> 
</span></span><span><span>                     <span>vec2</span><span>(</span><span>.115</span><span>,</span> <span>-</span><span>.25</span><span>));</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.11</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>// Teeth</span>
</span></span><span><span>            <span>float</span> <span>width</span> <span>=</span> <span>.065</span><span>;</span>
</span></span><span><span>            <span>vec2</span> <span>teeth</span> <span>=</span> <span>pixel</span><span>;</span>
</span></span><span><span>            <span>teeth</span><span>.</span><span>x</span> <span>=</span> <span>mod</span><span>(</span><span>teeth</span><span>.</span><span>x</span><span>,</span> <span>width</span><span>)</span><span>-</span><span>width</span><span>*</span><span>.5</span><span>;</span>
</span></span><span><span>            <span>teeth</span><span>.</span><span>y</span> <span>-=</span> <span>pow</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.09</span><span>,</span> <span>2.</span><span>)</span> <span>*</span> <span>1.5</span> <span>-</span> <span>.34</span><span>;</span>
</span></span><span><span>            <span>teeth</span><span>.</span><span>y</span> <span>=</span> <span>abs</span><span>(</span><span>teeth</span><span>.</span><span>y</span><span>)</span><span>-</span><span>.06</span><span>;</span>
</span></span><span><span>            <span>d</span> <span>=</span> <span>parabola</span><span>(</span><span>teeth</span><span>,</span> <span>38.</span><span>);</span>
</span></span><span><span>            <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span> <span>&amp;&amp;</span> <span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.06</span><span>)</span> <span>&lt;</span> <span>.194</span><span>)</span> 
</span></span><span><span>                <span>return</span> <span>vec3</span><span>(</span><span>0.902</span><span>,</span> <span>0.890</span><span>,</span> <span>0.729</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.01</span><span>);</span>
</span></span><span><span>          
</span></span><span><span>            <span>// Tongue</span>
</span></span><span><span>            <span>// `map()` is used to change the thickness of </span>
</span></span><span><span>            <span>// the tongue along the x axis</span>
</span></span><span><span>            <span>vec2</span> <span>tongue</span> <span>=</span> <span>rotateAt</span><span>(</span><span>pixel</span><span>,</span> <span>sin</span><span>(</span><span>time</span><span>*</span><span>2.</span><span>-</span><span>1.5</span><span>)</span><span>*</span><span>.15</span><span>+</span><span>.1</span><span>,</span> <span>vec2</span><span>(</span><span>0</span><span>,</span><span>-</span><span>.5</span><span>));</span>
</span></span><span><span>            <span>float</span> <span>tongue_thickness</span> <span>=</span> <span>map</span><span>(</span><span>tongue</span><span>.</span><span>x</span><span>,</span> <span>-</span><span>.16</span><span>,</span> <span>.01</span><span>,</span> <span>.02</span><span>,</span> <span>.045</span><span>);</span>
</span></span><span><span>            <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>tongue</span><span>,</span>  
</span></span><span><span>                <span>vec2</span><span>(</span><span>-</span><span>.16</span><span>,</span> <span>-</span><span>.35</span><span>),</span> 
</span></span><span><span>                <span>vec2</span><span>(</span><span>.001</span><span>,</span><span>-</span><span>.33</span><span>),</span> 
</span></span><span><span>                <span>vec2</span><span>(</span><span>.01</span><span>,</span> <span>-</span><span>.5</span><span>))</span> <span>-</span> <span>tongue_thickness</span><span>;</span>
</span></span><span><span>            <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0</span><span>)</span> 
</span></span><span><span>                <span>return</span> <span>vec3</span><span>(</span><span>0.816</span><span>,</span> <span>0.302</span><span>,</span> <span>0.275</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>0.01</span><span>);</span>
</span></span><span><span>              
</span></span><span><span>            <span>// mouth fill color</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>.42</span><span>,</span> <span>.147</span><span>,</span> <span>.152</span><span>);</span> 
</span></span><span><span>        <span>}</span> 
</span></span><span><span>        
</span></span><span><span>        <span>// lip outlines</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.12</span> <span>||</span> <span>(</span><span>abs</span><span>(</span><span>d</span><span>-</span><span>.16</span><span>)</span> <span>&lt;</span> <span>.005</span> 
</span></span><span><span>                        <span>&amp;&amp;</span> <span>(</span><span>pixel</span><span>.</span><span>x</span><span>*-</span><span>6.4</span> <span>&gt;</span> <span>-</span><span>pixel</span><span>.</span><span>y</span><span>+</span><span>1.6</span> 
</span></span><span><span>                          <span>||</span> <span>pixel</span><span>.</span><span>x</span><span>*</span><span>1.7</span> <span>&gt;</span> <span>-</span><span>pixel</span><span>.</span><span>y</span><span>+</span><span>.1</span> 
</span></span><span><span>                          <span>||</span> <span>pixel</span><span>.</span><span>y</span> <span>&lt;</span> <span>-</span><span>0.49</span><span>)))</span> 
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span> 
</span></span><span><span>        
</span></span><span><span>        <span>// lips</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.16</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>.838</span><span>,</span> <span>.799</span><span>,</span> <span>0.76</span><span>);</span>
</span></span><span><span>       
</span></span><span><span>        
</span></span><span><span>    
</span></span><span><span>        <span>// Nose  </span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>min</span><span>(</span>
</span></span><span><span>                <span>bezier</span><span>(</span><span>pixel</span><span>,</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.15</span><span>,</span> <span>-</span><span>.13</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.21</span><span>,</span><span>-</span><span>.14</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.14</span><span>,</span> <span>.08</span><span>)),</span>
</span></span><span><span>                <span>bezier</span><span>(</span><span>pixel</span><span>,</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.085</span><span>,</span> <span>-</span><span>.01</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.12</span><span>,</span> <span>-</span><span>.13</span><span>),</span>
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.15</span><span>,</span><span>-</span><span>.13</span><span>)));</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0055</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>
</span></span><span><span>    <span>// Eyebrow</span>
</span></span><span><span>    <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>pixel</span><span>,</span>  
</span></span><span><span>            <span>vec2</span><span>(</span><span>-</span><span>.34</span><span>,</span> <span>.38</span><span>),</span> 
</span></span><span><span>            <span>// NEW animate the middle up and down</span>
</span></span><span><span>            <span>vec2</span><span>(</span><span>-</span><span>.05</span><span>,</span> <span>0.5</span> <span>+</span> <span>cos</span><span>(</span><span>time</span><span>)</span><span>*</span><span>.1</span><span>),</span>
</span></span><span><span>            <span>vec2</span><span>(</span><span>.205</span><span>,</span> <span>.36</span><span>))</span> <span>-</span> <span>0.035</span><span>;</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0</span><span>)</span> 
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>.71</span><span>,</span> <span>.839</span><span>,</span> <span>.922</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.013</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>        <span>d</span> <span>=</span> <span>min</span><span>(</span>
</span></span><span><span>            <span>// Head</span>
</span></span><span><span>            <span>round_rect</span><span>(</span>
</span></span><span><span>            <span>pixel</span><span>,</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.36</span><span>,</span> <span>.6385</span><span>),</span> 
</span></span><span><span>            <span>vec4</span><span>(</span><span>.34</span><span>,</span> <span>.415</span><span>,</span> <span>.363</span><span>,</span> <span>.315</span><span>)),</span>
</span></span><span><span>            
</span></span><span><span>            <span>// Ear</span>
</span></span><span><span>            <span>round_rect</span><span>(</span>
</span></span><span><span>            <span>pixel</span> <span>+</span> <span>vec2</span><span>(</span><span>-</span><span>.32</span><span>,</span> <span>.15</span><span>),</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.15</span><span>,</span> <span>0.12</span><span>),</span> 
</span></span><span><span>            <span>vec4</span><span>(</span><span>.13</span><span>,</span><span>.1</span><span>,</span><span>.13</span><span>,</span><span>.13</span><span>))</span>
</span></span><span><span>        <span>);</span>
</span></span><span><span>            
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>.838</span><span>,</span> <span>.799</span><span>,</span> <span>.76</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.01</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    
</span></span><span><span>        <span>// Hair     </span>
</span></span><span><span>        <span>float</span> <span>twist</span> <span>=</span> <span>sin</span><span>(</span><span>time</span><span>*</span><span>2.</span><span>-</span><span>length</span><span>(</span><span>pixel</span><span>)</span><span>*</span><span>2.1</span><span>)</span><span>*</span><span>.12</span><span>;</span>
</span></span><span><span>        <span>vec2</span> <span>hair</span> <span>=</span> <span>rotateAt</span><span>(</span><span>pixel</span><span>,</span> <span>twist</span><span>,</span> <span>vec2</span><span>(</span><span>0.</span><span>,</span><span>.1</span><span>));</span>
</span></span><span><span>        <span>hair</span> <span>-=</span> <span>vec2</span><span>(</span><span>.08</span><span>,</span><span>.15</span><span>);</span>
</span></span><span><span>        <span>hair</span><span>.</span><span>x</span> <span>*=</span> <span>1.3</span><span>;</span>
</span></span><span><span>        <span>hair</span> <span>=</span> <span>warp</span><span>(</span><span>hair</span><span>,</span> <span>4.0</span><span>,</span> <span>0.07</span><span>);</span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>star</span><span>(</span><span>hair</span><span>,</span> <span>0.95</span><span>,</span> <span>11.</span><span>,</span> <span>.28</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>0.682</span><span>,</span> <span>0.839</span><span>,</span> <span>0.929</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>0.012</span><span>);</span>
</span></span><span><span>        <span>}</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>    
</span></span><span><span>    <span>return</span> <span>portal</span><span>(</span><span>pixel</span><span>,</span> <span>time</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div></div><p>This is the editor I used to create Pixel Rick. It updates after every code edit — try changing <code>green = 0.9</code> to <code>green = 0.1</code>.</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>// fract returns fractional part. fract(1.3) == 0.3</span>
</span></span><span><span>    <span>float</span> <span>red</span>   <span>=</span> <span>fract</span><span>(</span><span>pixel</span><span>.</span><span>y</span><span>);</span> 
</span></span><span><span>    <span>float</span> <span>green</span> <span>=</span> <span>0.9</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>blue</span>  <span>=</span> <span>fract</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>red</span><span>,</span> <span>green</span><span>,</span> <span>blue</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>The code is written in OpenGL Shading Language (GLSL), and the <code>color_for_pixel</code> function runs on your GPU for every pixel in the preview. Amazingly this is all you need to make animations — a function that answers “What color should this pixel be at this time?”.</p><p>Optional Challenge: What happens if you set <code>green = time</code>? What could you do to make it keep going? (<code>time</code> counts seconds since last edit)</p><p>To draw Rick, we’ll start with drawing a circle and build up to other shapes. Let’s use GLSL’s built in<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup> <code>length()</code> function to visualize how far each pixel is from the center of the screen (aka the origin, aka position <code>(0,0)</code>). By returning that distance as the pixel’s color, we get 0 (black) near the center, and fade to 1 (white) further away:</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>length</span><span>(</span><span>pixel</span><span>));</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>GLSL Tip: <code>vec3(x)</code> is the same as <code>vec3(x, x, x)</code>. We’ll use this trick a lot.</p><p>To draw a circle, we compare the distance to a radius:</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>float</span> <span>radius</span> <span>=</span> <span>0.6</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>length</span><span>(</span><span>pixel</span><span>)</span> <span>&gt;</span> <span>radius</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>GLSL Tip: <code>vec3</code> turns the boolean result of <code>&gt;</code> into <code>1</code> or <code>0</code>.</p><p>What would that circle look like if you replaced <code>length()</code> with your own function that calculates <a href="https://en.wikipedia.org/wiki/Taxicab_geometry" target="_blank" rel="noopener">Manhattan distance</a>?</p><p>We can extract that into a reusable <code>circle()</code> function:</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>float</span> <span>circle</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>radius</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>pixel</span><span>)</span> <span>-</span> <span>radius</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>
</span></span><span><span>    <span>if</span> <span>(</span><span>circle</span><span>(</span><span>pixel</span> <span>-</span> <span>vec2</span><span>(</span><span>.3</span><span>,</span> <span>-</span><span>.3</span><span>),</span> <span>.4</span><span>)</span> <span>&lt;</span> <span>0.0</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>0.2</span><span>,</span><span>.7</span><span>,</span><span>.5</span><span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>  
</span></span><span><span>    <span>if</span> <span>(</span><span>circle</span><span>(</span><span>pixel</span> <span>-</span> <span>vec2</span><span>(</span><span>-</span><span>.4</span><span>,</span><span>0</span><span>),</span> <span>.8</span><span>)</span> <span>&lt;</span> <span>0.0</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>.7</span><span>,</span><span>.5</span><span>,</span> <span>.3</span><span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>.2</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>The circles are positioned by shifting the pixel passed to <code>circle()</code>. The line order of that code is important - it determines which circle appears in front of the other.</p><p>Notice that <code>circle()</code> returns the <em>distance</em> to the perimeter instead of just a <code>bool</code> to indicate inside/outside. This is known as a “signed distance field” (SDF) function. The word “signed” here means that the distances for locations inside the shape are negative, and positive outside. We’ll use the distance to achieve some cool effects in a bit.</p><p>There are <a href="https://iquilezles.org/articles/distfunctions2d/" target="_blank" rel="noopener">many SDF functions</a> besides <code>circle()</code>. Here are a few we’ll be using:</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>// Click {...} to see the code</span>
</span></span><span><span><span>float</span> <span>bezier</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>v0</span><span>,</span> <span>vec2</span> <span>v1</span><span>,</span> <span>vec2</span> <span>v2</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// from https://www.shadertoy.com/view/MlKcDD</span>
</span></span><span><span>    <span>vec2</span> <span>i</span> <span>=</span> <span>v0</span> <span>-</span> <span>v2</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>j</span> <span>=</span> <span>v2</span> <span>-</span> <span>v1</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>k</span> <span>=</span> <span>v1</span> <span>-</span> <span>v0</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>w</span> <span>=</span> <span>j</span><span>-</span><span>k</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>v0</span><span>-=</span> <span>p</span><span>;</span> <span>v1</span><span>-=</span> <span>p</span><span>;</span> <span>v2</span><span>-=</span> <span>p</span><span>;</span>
</span></span><span><span>    
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>v0</span><span>.</span><span>x</span><span>*</span><span>v2</span><span>.</span><span>y</span><span>-</span><span>v0</span><span>.</span><span>y</span><span>*</span><span>v2</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>y</span> <span>=</span> <span>v1</span><span>.</span><span>x</span><span>*</span><span>v0</span><span>.</span><span>y</span><span>-</span><span>v1</span><span>.</span><span>y</span><span>*</span><span>v0</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>z</span> <span>=</span> <span>v2</span><span>.</span><span>x</span><span>*</span><span>v1</span><span>.</span><span>y</span><span>-</span><span>v2</span><span>.</span><span>y</span><span>*</span><span>v1</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>vec2</span> <span>s</span> <span>=</span> <span>2.0</span><span>*</span><span>(</span><span>y</span><span>*</span><span>j</span><span>+</span><span>z</span><span>*</span><span>k</span><span>)</span><span>-</span><span>x</span><span>*</span><span>i</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span>  <span>(</span><span>y</span><span>*</span><span>z</span><span>-</span><span>x</span><span>*</span><span>x</span><span>*</span><span>0.25</span><span>)</span><span>/</span><span>dot</span><span>(</span><span>s</span><span>,</span><span>s</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>t</span> <span>=</span> <span>clamp</span><span>(</span> <span>(</span><span>0.5</span><span>*</span><span>x</span><span>+</span><span>y</span><span>+</span><span>r</span><span>*</span><span>dot</span><span>(</span><span>s</span><span>,</span><span>w</span><span>))</span><span>/</span><span>(</span><span>x</span><span>+</span><span>y</span><span>+</span><span>z</span><span>),</span><span>0.0</span><span>,</span><span>1.0</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>vec2</span> <span>d</span> <span>=</span> <span>v0</span><span>+</span><span>t</span><span>*</span><span>(</span><span>k</span><span>+</span><span>k</span><span>+</span><span>t</span><span>*</span><span>w</span><span>);</span>
</span></span><span><span>    <span>vec2</span> <span>outQ</span> <span>=</span> <span>d</span> <span>+</span> <span>p</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>d</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>star</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>r</span><span>,</span> <span>float</span> <span>points</span><span>,</span> <span>float</span> <span>ratio</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// from https://www.shadertoy.com/view/3tSGDy</span>
</span></span><span><span>    <span>float</span> <span>an</span> <span>=</span> <span>3.141593</span><span>/</span><span>points</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>en</span> <span>=</span> <span>3.141593</span><span>/</span><span>(</span><span>ratio</span><span>*</span><span>(</span><span>points</span><span>-</span><span>2.</span><span>)</span> <span>+</span> <span>2.</span><span>);</span> 
</span></span><span><span>    <span>vec2</span>  <span>acs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>an</span><span>),</span><span>sin</span><span>(</span><span>an</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>ecs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>en</span><span>),</span><span>sin</span><span>(</span><span>en</span><span>));</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>bn</span> <span>=</span> <span>mod</span><span>(</span><span>atan</span><span>(</span><span>p</span><span>.</span><span>x</span><span>,</span><span>p</span><span>.</span><span>y</span><span>),</span><span>2.0</span><span>*</span><span>an</span><span>)</span> <span>-</span> <span>an</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>=</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>vec2</span><span>(</span><span>cos</span><span>(</span><span>bn</span><span>),</span><span>abs</span><span>(</span><span>sin</span><span>(</span><span>bn</span><span>)));</span>
</span></span><span><span>    <span>p</span> <span>-=</span> <span>r</span><span>*</span><span>acs</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>+=</span> <span>ecs</span><span>*</span><span>clamp</span><span>(</span> <span>-</span><span>dot</span><span>(</span><span>p</span><span>,</span><span>ecs</span><span>),</span> <span>0.0</span><span>,</span> <span>r</span><span>*</span><span>acs</span><span>.</span><span>y</span><span>/</span><span>ecs</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>p</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>round_rect</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>size</span><span>,</span> <span>vec4</span> <span>radii</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// from https://www.shadertoy.com/view/4llXD7</span>
</span></span><span><span>    <span>radii</span><span>.</span><span>xy</span> <span>=</span> <span>(</span><span>p</span><span>.</span><span>x</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>radii</span><span>.</span><span>xy</span> <span>:</span> <span>radii</span><span>.</span><span>zw</span><span>;</span>
</span></span><span><span>    <span>radii</span><span>.</span><span>x</span>  <span>=</span> <span>(</span><span>p</span><span>.</span><span>y</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>radii</span><span>.</span><span>x</span>  <span>:</span> <span>radii</span><span>.</span><span>y</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>q</span> <span>=</span> <span>abs</span><span>(</span><span>p</span><span>)</span><span>-</span><span>size</span><span>+</span><span>radii</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>min</span><span>(</span><span>max</span><span>(</span><span>q</span><span>.</span><span>x</span><span>,</span><span>q</span><span>.</span><span>y</span><span>),</span><span>0.0</span><span>)</span> <span>+</span> <span>length</span><span>(</span><span>max</span><span>(</span><span>q</span><span>,</span><span>0.0</span><span>))</span> <span>-</span> <span>radii</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>bezier</span><span>(</span><span>pixel</span><span>,</span> 
</span></span><span><span>        <span>vec2</span><span>(</span><span>-</span><span>.7</span><span>,</span><span>-</span><span>.35</span><span>),</span> 
</span></span><span><span>        <span>vec2</span><span>(</span><span>-</span><span>1.5</span><span>,</span><span>-</span><span>.4</span><span>),</span> 
</span></span><span><span>        <span>vec2</span><span>(</span><span>-</span><span>1.2</span><span>,</span><span>.35</span><span>))</span> <span>&lt;</span> <span>0.1</span><span>)</span> 
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>.9</span><span>,</span><span>.3</span><span>,</span><span>.3</span><span>);</span> 
</span></span><span><span>    
</span></span><span><span>    <span>if</span> <span>(</span><span>round_rect</span><span>(</span><span>pixel</span><span>,</span> <span>vec2</span><span>(</span><span>.3</span><span>,</span> <span>.4</span><span>),</span> <span>vec4</span><span>(</span><span>.1</span><span>))</span> <span>&lt;</span> <span>0.0</span><span>)</span> 
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>.3</span><span>,</span> <span>.9</span><span>,</span> <span>.3</span><span>);</span> 
</span></span><span><span>    
</span></span><span><span>    <span>if</span> <span>(</span><span>star</span><span>(</span><span>pixel</span> <span>-</span> <span>vec2</span><span>(</span><span>1.</span><span>,</span><span>0.</span><span>),</span> <span>.45</span><span>,</span> <span>5.</span><span>,</span> <span>.3</span><span>)</span> <span>&lt;</span> <span>0.0</span><span>)</span> 
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>.2</span><span>,</span> <span>.4</span><span>,</span> <span>.9</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>1.0</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>With those shapes in hand, let’s get started on Rick.</p><h2 id="drawing-rick">Drawing Rick</h2><p>I wish I could tell you I had the ability to look at a cartoon and then effortlessly replicate it in code. Unfortunately, I don’t. I spent <em>a lot</em> of time painstakingly trying numbers to recreate Rick’s face from the season 1 poster.</p><p>I did find one trick that sped up the trial and error process: I flashed my reference image of Rick on top of the preview so I could compare my drawing to the original while I was changing the code. The editor below has that enabled so you can experience what my week has been like.</p><p>Change the size and corner radii parameters to make the rectangle match Rick’s head shape.</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>float</span> <span>round_rect</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>size</span><span>,</span> <span>vec4</span> <span>radii</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>radii</span><span>.</span><span>xy</span> <span>=</span> <span>(</span><span>p</span><span>.</span><span>x</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>radii</span><span>.</span><span>xy</span> <span>:</span> <span>radii</span><span>.</span><span>zw</span><span>;</span>
</span></span><span><span>    <span>radii</span><span>.</span><span>x</span>  <span>=</span> <span>(</span><span>p</span><span>.</span><span>y</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>radii</span><span>.</span><span>x</span>  <span>:</span> <span>radii</span><span>.</span><span>y</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>q</span> <span>=</span> <span>abs</span><span>(</span><span>p</span><span>)</span><span>-</span><span>size</span><span>+</span><span>radii</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>min</span><span>(</span><span>max</span><span>(</span><span>q</span><span>.</span><span>x</span><span>,</span><span>q</span><span>.</span><span>y</span><span>),</span><span>0.0</span><span>)</span> <span>+</span> <span>length</span><span>(</span><span>max</span><span>(</span><span>q</span><span>,</span><span>0.0</span><span>))</span> <span>-</span> <span>radii</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span>   
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>float</span> <span>dist</span> <span>=</span> <span>round_rect</span><span>(</span>
</span></span><span><span>        <span>pixel</span><span>,</span> 
</span></span><span><span>        <span>// Change these:</span>
</span></span><span><span>        <span>vec2</span><span>(</span><span>.3</span><span>,</span> <span>.5</span><span>),</span>  <span>// size</span>
</span></span><span><span>        <span>vec4</span><span>(</span><span>.1</span><span>,</span> <span>.01</span><span>,</span> <span>.05</span><span>,</span> <span>.1</span><span>)</span> <span>// corner radii</span>
</span></span><span><span>    <span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>if</span> <span>(</span><span>dist</span> <span>&lt;</span> <span>0.</span><span>)</span> 
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>.838</span><span>,</span> <span>0.8</span><span>,</span> <span>0.76</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>1</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>In case it isn’t obvious by now, the techniques in this post won’t be replacing your favorite vector drawing tool. This is the only time we’ll do the flashing exercise; just know that all the seemingly random numbers in the rest of this post were discovered via this process. I found the color values using an image editor’s eyedropper tool.</p><p>Ok, so here are the values I came up with for Rick’s head. I also added a second <code>round_rect()</code> for his ear:</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>float</span> <span>round_rect</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>size</span><span>,</span> <span>vec4</span> <span>radii</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>radii</span><span>.</span><span>xy</span> <span>=</span> <span>(</span><span>p</span><span>.</span><span>x</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>radii</span><span>.</span><span>xy</span> <span>:</span> <span>radii</span><span>.</span><span>zw</span><span>;</span>
</span></span><span><span>    <span>radii</span><span>.</span><span>x</span>  <span>=</span> <span>(</span><span>p</span><span>.</span><span>y</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>radii</span><span>.</span><span>x</span>  <span>:</span> <span>radii</span><span>.</span><span>y</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>q</span> <span>=</span> <span>abs</span><span>(</span><span>p</span><span>)</span><span>-</span><span>size</span><span>+</span><span>radii</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>min</span><span>(</span><span>max</span><span>(</span><span>q</span><span>.</span><span>x</span><span>,</span><span>q</span><span>.</span><span>y</span><span>),</span><span>0.0</span><span>)</span> <span>+</span> <span>length</span><span>(</span><span>max</span><span>(</span><span>q</span><span>,</span><span>0.0</span><span>))</span> <span>-</span> <span>radii</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span>   
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>    
</span></span><span><span>    <span>vec3</span> <span>skin_color</span> <span>=</span> <span>vec3</span><span>(</span><span>0.838</span><span>,</span> <span>0.799</span><span>,</span> <span>0.760</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>// head</span>
</span></span><span><span>    <span>float</span> <span>dist</span> <span>=</span> <span>round_rect</span><span>(</span>
</span></span><span><span>        <span>pixel</span><span>,</span> 
</span></span><span><span>        <span>vec2</span><span>(</span><span>.36</span><span>,</span> <span>0.6385</span><span>),</span> 
</span></span><span><span>        <span>vec4</span><span>(</span><span>.34</span><span>,</span> <span>.415</span><span>,</span> <span>.363</span><span>,</span> <span>.315</span><span>)</span>
</span></span><span><span>    <span>);</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>dist</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>skin_color</span><span>;</span>
</span></span><span><span>    
</span></span><span><span>    <span>// ear</span>
</span></span><span><span>    <span>dist</span> <span>=</span> <span>round_rect</span><span>(</span>
</span></span><span><span>        <span>pixel</span> <span>+</span> <span>vec2</span><span>(</span><span>-</span><span>.32</span><span>,</span> <span>.15</span><span>),</span> 
</span></span><span><span>        <span>vec2</span><span>(</span><span>.15</span><span>,</span> <span>0.12</span><span>),</span> 
</span></span><span><span>        <span>vec4</span><span>(</span><span>.13</span><span>,</span><span>.1</span><span>,</span><span>.13</span><span>,</span><span>.13</span><span>));</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>dist</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>skin_color</span><span>;</span>
</span></span><span><span>    
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>1</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Let’s add the outline. This is where drawing with signed distance functions comes in handy. We can return black for pixels with a distance between -0.01 and 0.0.</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>float</span> <span>round_rect</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>size</span><span>,</span> <span>vec4</span> <span>radii</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>radii</span><span>.</span><span>xy</span> <span>=</span> <span>(</span><span>p</span><span>.</span><span>x</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>radii</span><span>.</span><span>xy</span> <span>:</span> <span>radii</span><span>.</span><span>zw</span><span>;</span>
</span></span><span><span>    <span>radii</span><span>.</span><span>x</span>  <span>=</span> <span>(</span><span>p</span><span>.</span><span>y</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>radii</span><span>.</span><span>x</span>  <span>:</span> <span>radii</span><span>.</span><span>y</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>q</span> <span>=</span> <span>abs</span><span>(</span><span>p</span><span>)</span><span>-</span><span>size</span><span>+</span><span>radii</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>min</span><span>(</span><span>max</span><span>(</span><span>q</span><span>.</span><span>x</span><span>,</span><span>q</span><span>.</span><span>y</span><span>),</span><span>0.0</span><span>)</span> <span>+</span> <span>length</span><span>(</span><span>max</span><span>(</span><span>q</span><span>,</span><span>0.0</span><span>))</span> <span>-</span> <span>radii</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span>   
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>
</span></span><span><span>    <span>vec3</span> <span>skin_color</span> <span>=</span> <span>vec3</span><span>(</span><span>0.838</span><span>,</span> <span>0.799</span><span>,</span> <span>0.760</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>// head</span>
</span></span><span><span>    <span>float</span> <span>dist</span> <span>=</span> <span>round_rect</span><span>(</span>
</span></span><span><span>        <span>pixel</span><span>,</span> 
</span></span><span><span>        <span>vec2</span><span>(</span><span>.36</span><span>,</span> <span>0.6385</span><span>),</span> 
</span></span><span><span>        <span>vec4</span><span>(</span><span>.34</span><span>,</span> <span>.415</span><span>,</span> <span>.363</span><span>,</span> <span>.315</span><span>)</span>
</span></span><span><span>    <span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>if</span> <span>(</span><span>dist</span> <span>&lt;</span> <span>-</span><span>0.01</span><span>)</span> <span>return</span> <span>skin_color</span><span>;</span> 
</span></span><span><span>    <span>if</span> <span>(</span><span>dist</span> <span>&lt;</span> <span>0.0</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span> <span>// outline</span>
</span></span><span><span>    
</span></span><span><span>    <span>// ear</span>
</span></span><span><span>    <span>dist</span> <span>=</span> <span>round_rect</span><span>(</span>
</span></span><span><span>        <span>pixel</span> <span>+</span> <span>vec2</span><span>(</span><span>-</span><span>.32</span><span>,</span> <span>.15</span><span>),</span> 
</span></span><span><span>        <span>vec2</span><span>(</span><span>.15</span><span>,</span> <span>0.12</span><span>),</span> 
</span></span><span><span>        <span>vec4</span><span>(</span><span>.13</span><span>,</span><span>.1</span><span>,</span><span>.13</span><span>,</span><span>.13</span><span>));</span>
</span></span><span><span>        
</span></span><span><span>    <span>if</span> <span>(</span><span>dist</span> <span>&lt;</span> <span>-</span><span>0.01</span><span>)</span> <span>return</span> <span>skin_color</span><span>;</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>dist</span> <span>&lt;</span> <span>0.0</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span> <span>// outline</span>
</span></span><span><span>    
</span></span><span><span>    
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>1</span><span>);</span> <span>// background</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>That line between the ear and the head shouldn’t be there (according to my reference image of Rick). I don’t want to outline each shape individually, I want to outline the <em>union</em> of the shapes. Union is easy with SDFs - use <code>min()</code> to combine two distances:</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>float</span> <span>round_rect</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>size</span><span>,</span> <span>vec4</span> <span>radii</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>radii</span><span>.</span><span>xy</span> <span>=</span> <span>(</span><span>p</span><span>.</span><span>x</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>radii</span><span>.</span><span>xy</span> <span>:</span> <span>radii</span><span>.</span><span>zw</span><span>;</span>
</span></span><span><span>    <span>radii</span><span>.</span><span>x</span>  <span>=</span> <span>(</span><span>p</span><span>.</span><span>y</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>radii</span><span>.</span><span>x</span>  <span>:</span> <span>radii</span><span>.</span><span>y</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>q</span> <span>=</span> <span>abs</span><span>(</span><span>p</span><span>)</span><span>-</span><span>size</span><span>+</span><span>radii</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>min</span><span>(</span><span>max</span><span>(</span><span>q</span><span>.</span><span>x</span><span>,</span><span>q</span><span>.</span><span>y</span><span>),</span><span>0.0</span><span>)</span> <span>+</span> <span>length</span><span>(</span><span>max</span><span>(</span><span>q</span><span>,</span><span>0.0</span><span>))</span> <span>-</span> <span>radii</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span>   
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>float</span> <span>dist</span> <span>=</span> <span>min</span><span>(</span> <span>// &lt;- combine the shapes</span>
</span></span><span><span>        <span>// head</span>
</span></span><span><span>        <span>round_rect</span><span>(</span>
</span></span><span><span>        <span>pixel</span><span>,</span> 
</span></span><span><span>        <span>vec2</span><span>(</span><span>.36</span><span>,</span> <span>0.6385</span><span>),</span> 
</span></span><span><span>        <span>vec4</span><span>(</span><span>.34</span><span>,</span> <span>.415</span><span>,</span> <span>.363</span><span>,</span> <span>.315</span><span>)),</span>
</span></span><span><span>        
</span></span><span><span>        <span>// ear</span>
</span></span><span><span>        <span>round_rect</span><span>(</span>
</span></span><span><span>        <span>pixel</span> <span>+</span> <span>vec2</span><span>(</span><span>-</span><span>.32</span><span>,</span> <span>.15</span><span>),</span> 
</span></span><span><span>        <span>vec2</span><span>(</span><span>.15</span><span>,</span> <span>0.12</span><span>),</span> 
</span></span><span><span>        <span>vec4</span><span>(</span><span>.13</span><span>,</span><span>.1</span><span>,</span><span>.13</span><span>,</span><span>.13</span><span>))</span>
</span></span><span><span>    <span>);</span>
</span></span><span><span>        
</span></span><span><span>    <span>if</span> <span>(</span><span>dist</span> <span>&lt;</span> <span>-</span><span>0.01</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0.838</span><span>,</span> <span>0.799</span><span>,</span> <span>0.760</span><span>);</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>dist</span> <span>&lt;</span> <span>0.0</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>1</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>There are <a href="https://iquilezles.org/articles/distfunctions/#:~:text=Primitive%20combinations" target="_blank" rel="noopener">other ways</a> to combine two signed distance fields. Try swapping out <code>min()</code> for the smooth union function to smoothly blend the ear with the head.</p><p>Let’s draw an eye:</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>float</span> <span>circle</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>radius</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>pixel</span><span>)</span> <span>-</span> <span>radius</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>round_rect</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>size</span><span>,</span> <span>vec4</span> <span>radii</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>radii</span><span>.</span><span>xy</span> <span>=</span> <span>(</span><span>p</span><span>.</span><span>x</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>radii</span><span>.</span><span>xy</span> <span>:</span> <span>radii</span><span>.</span><span>zw</span><span>;</span>
</span></span><span><span>    <span>radii</span><span>.</span><span>x</span>  <span>=</span> <span>(</span><span>p</span><span>.</span><span>y</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>radii</span><span>.</span><span>x</span>  <span>:</span> <span>radii</span><span>.</span><span>y</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>q</span> <span>=</span> <span>abs</span><span>(</span><span>p</span><span>)</span><span>-</span><span>size</span><span>+</span><span>radii</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>min</span><span>(</span><span>max</span><span>(</span><span>q</span><span>.</span><span>x</span><span>,</span><span>q</span><span>.</span><span>y</span><span>),</span><span>0.0</span><span>)</span> <span>+</span> <span>length</span><span>(</span><span>max</span><span>(</span><span>q</span><span>,</span><span>0.0</span><span>))</span> <span>-</span> <span>radii</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>star</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>r</span><span>,</span> <span>float</span> <span>points</span><span>,</span> <span>float</span> <span>ratio</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>float</span> <span>an</span> <span>=</span> <span>3.141593</span><span>/</span><span>points</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>en</span> <span>=</span> <span>3.141593</span><span>/</span><span>(</span><span>ratio</span><span>*</span><span>(</span><span>points</span><span>-</span><span>2.</span><span>)</span> <span>+</span> <span>2.</span><span>);</span> 
</span></span><span><span>    <span>vec2</span>  <span>acs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>an</span><span>),</span><span>sin</span><span>(</span><span>an</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>ecs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>en</span><span>),</span><span>sin</span><span>(</span><span>en</span><span>));</span> 
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>bn</span> <span>=</span> <span>mod</span><span>(</span><span>atan</span><span>(</span><span>p</span><span>.</span><span>x</span><span>,</span><span>p</span><span>.</span><span>y</span><span>),</span><span>2.0</span><span>*</span><span>an</span><span>)</span> <span>-</span> <span>an</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>=</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>vec2</span><span>(</span><span>cos</span><span>(</span><span>bn</span><span>),</span><span>abs</span><span>(</span><span>sin</span><span>(</span><span>bn</span><span>)));</span>
</span></span><span><span>    <span>p</span> <span>-=</span> <span>r</span><span>*</span><span>acs</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>+=</span> <span>ecs</span><span>*</span><span>clamp</span><span>(</span> <span>-</span><span>dot</span><span>(</span><span>p</span><span>,</span><span>ecs</span><span>),</span> <span>0.0</span><span>,</span> <span>r</span><span>*</span><span>acs</span><span>.</span><span>y</span><span>/</span><span>ecs</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>p</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>   
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>     <span>// pupil</span>
</span></span><span><span>    <span>vec2</span> <span>pupil_pos</span> <span>=</span> <span>pixel</span> <span>-</span> <span>vec2</span><span>(</span><span>.16</span><span>-</span><span>.13</span><span>,</span><span>.24</span><span>);</span> 
</span></span><span><span>
</span></span><span><span>    <span>// subtract 0.007 to outset &amp; round the corners of star</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>star</span><span>(</span><span>pupil_pos</span><span>,</span> <span>0.019</span><span>,</span> <span>6.</span><span>,</span> <span>.9</span><span>)</span> <span>-</span> <span>0.007</span> <span>&lt;</span> <span>0.0</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>.1</span><span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>    
</span></span><span><span>    <span>// eyeball</span>
</span></span><span><span>    <span>vec2</span> <span>eyeball_pos</span> <span>=</span> <span>pixel</span><span>;</span>
</span></span><span><span>    <span>eyeball_pos</span><span>.</span><span>y</span> <span>*=</span> <span>.93</span><span>;</span> <span>// stretch vertically</span>
</span></span><span><span>    <span>eyeball_pos</span> <span>-=</span> <span>vec2</span><span>(</span><span>0.07</span><span>,</span> <span>.16</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>dist</span> <span>=</span> <span>circle</span><span>(</span><span>eyeball_pos</span><span>,</span> <span>.16</span><span>);</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>dist</span> <span>&lt;</span> <span>0.0</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>dist</span> <span>&lt;</span> <span>-</span><span>0.013</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>// head</span>
</span></span><span><span>    <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>dist</span> <span>=</span> <span>min</span><span>(</span>
</span></span><span><span>        <span>// head</span>
</span></span><span><span>        <span>round_rect</span><span>(</span>
</span></span><span><span>        <span>pixel</span><span>,</span> 
</span></span><span><span>        <span>vec2</span><span>(</span><span>.36</span><span>,</span> <span>0.6385</span><span>),</span> 
</span></span><span><span>        <span>vec4</span><span>(</span><span>.34</span><span>,</span> <span>.415</span><span>,</span> <span>.363</span><span>,</span> <span>.315</span><span>)),</span>
</span></span><span><span>        
</span></span><span><span>        <span>// ear</span>
</span></span><span><span>        <span>round_rect</span><span>(</span>
</span></span><span><span>        <span>pixel</span> <span>+</span> <span>vec2</span><span>(</span><span>-</span><span>.32</span><span>,</span> <span>.15</span><span>),</span> 
</span></span><span><span>        <span>vec2</span><span>(</span><span>.15</span><span>,</span> <span>0.12</span><span>),</span> 
</span></span><span><span>        <span>vec4</span><span>(</span><span>.13</span><span>,</span><span>.1</span><span>,</span><span>.13</span><span>,</span><span>.13</span><span>))</span>
</span></span><span><span>    <span>);</span>
</span></span><span><span>        
</span></span><span><span>    <span>if</span> <span>(</span><span>dist</span> <span>&lt;</span> <span>-</span><span>0.01</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0.838</span><span>,</span> <span>0.799</span><span>,</span> <span>0.760</span><span>);</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>dist</span> <span>&lt;</span> <span>0.0</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span> <span>// outline</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>    
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>1.</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Two interesting things here:</p><ol><li><code>eyeball_pos.y *= .93</code> stretches the eyeball a <em>tiny</em> bit — just like we move shapes by adding to positions, we scale by multiplying positions.</li><li>I used a 6-point star for the eye, and I subtracted a little from the star’s distance to round its corners. Any SDF shape can be rounded this way. It helps to visualize the distance field so you see how it gets more round the further from the shape you get:</li></ol><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>float</span> <span>star</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>r</span><span>,</span> <span>float</span> <span>points</span><span>,</span> <span>float</span> <span>ratio</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>float</span> <span>an</span> <span>=</span> <span>3.141593</span><span>/</span><span>points</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>en</span> <span>=</span> <span>3.141593</span><span>/</span><span>(</span><span>ratio</span><span>*</span><span>(</span><span>points</span><span>-</span><span>2.</span><span>)</span> <span>+</span> <span>2.</span><span>);</span> 
</span></span><span><span>    <span>vec2</span>  <span>acs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>an</span><span>),</span><span>sin</span><span>(</span><span>an</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>ecs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>en</span><span>),</span><span>sin</span><span>(</span><span>en</span><span>));</span> 
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>bn</span> <span>=</span> <span>mod</span><span>(</span><span>atan</span><span>(</span><span>p</span><span>.</span><span>x</span><span>,</span><span>p</span><span>.</span><span>y</span><span>),</span><span>2.0</span><span>*</span><span>an</span><span>)</span> <span>-</span> <span>an</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>=</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>vec2</span><span>(</span><span>cos</span><span>(</span><span>bn</span><span>),</span><span>abs</span><span>(</span><span>sin</span><span>(</span><span>bn</span><span>)));</span>
</span></span><span><span>    <span>p</span> <span>-=</span> <span>r</span><span>*</span><span>acs</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>+=</span> <span>ecs</span><span>*</span><span>clamp</span><span>(</span> <span>-</span><span>dot</span><span>(</span><span>p</span><span>,</span><span>ecs</span><span>),</span> <span>0.0</span><span>,</span> <span>r</span><span>*</span><span>acs</span><span>.</span><span>y</span><span>/</span><span>ecs</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>p</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>   
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>float</span> <span>d</span> <span>=</span> <span>star</span><span>(</span><span>pixel</span><span>,</span> <span>0.4</span><span>,</span> <span>6.</span><span>,</span> <span>.5</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>// show blue inside shape, orange outside</span>
</span></span><span><span>    <span>vec3</span> <span>color</span> <span>=</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0</span><span>)</span> <span>?</span> <span>vec3</span><span>(</span><span>0.5</span><span>,</span> <span>.8</span><span>,</span> <span>1.</span><span>)</span> <span>:</span> <span>vec3</span><span>(</span><span>0.98</span><span>,</span><span>.6</span><span>,</span><span>.13</span><span>);</span>
</span></span><span><span>    <span>color</span> <span>*=</span> <span>sin</span><span>(</span><span>d</span><span>*</span><span>150.</span><span>)</span><span>*</span><span>.1</span><span>+</span><span>.8</span><span>;</span> <span>// show distance field lines</span>
</span></span><span><span>    <span>color</span> <span>*=</span> <span>1.0</span> <span>-</span> <span>exp</span><span>(</span><span>-</span><span>20.0</span><span>*</span><span>abs</span><span>(</span><span>d</span><span>));</span> <span>// darken near perimeter</span>
</span></span><span><span>    
</span></span><span><span>    <span>float</span> <span>offset</span> <span>=</span> <span>(</span><span>sin</span><span>(</span><span>time</span><span>)</span><span>+</span><span>1.</span><span>)</span><span>*</span><span>.25</span><span>;</span> <span>// animate outline offset</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>abs</span><span>(</span><span>d</span><span>-</span><span>offset</span><span>)</span> <span>&lt;</span> <span>0.01</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>1.0</span><span>);</span> <span>// draw white outline</span>
</span></span><span><span>  
</span></span><span><span>    <span>return</span> <span>color</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>For the second eye, we could duplicate the first eye’s code, but instead let’s mirror it horizontally with <code>pixel.x = abs(pixel.x)</code>. To rationalize this, consider that if the point <code>(1, 0)</code> is inside the circle, then it’s mirror <code>(-1, 0)</code> will <em>also</em> be inside the circle after <code>pixel.x = abs(pixel.x)</code>, so both points will get colored.</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>float</span> <span>circle</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>radius</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>pixel</span><span>)</span> <span>-</span> <span>radius</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span>   
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>pixel</span><span>.</span><span>x</span> <span>-=</span> <span>.3</span><span>;</span> <span>// controls position</span>
</span></span><span><span>    <span>pixel</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>);</span> <span>// mirror</span>
</span></span><span><span>    <span>pixel</span><span>.</span><span>x</span> <span>-=</span> <span>.7</span><span>;</span> <span>// controls spacing</span>
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>circle</span><span>(</span><span>pixel</span><span>,</span> <span>.5</span><span>)</span> <span>&gt;</span> <span>0.0</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>The way that order of operations works still hurts my head, but it helps to play with the code to get a feel for what’s going on.</p><p>Mirror the circles on both the x <em>and</em> the y axis</p><p>Here is the mirroring technique applied to Rick’s eyes:</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>float</span> <span>circle</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>radius</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>pixel</span><span>)</span> <span>-</span> <span>radius</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>round_rect</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>size</span><span>,</span> <span>vec4</span> <span>radii</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>radii</span><span>.</span><span>xy</span> <span>=</span> <span>(</span><span>p</span><span>.</span><span>x</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>radii</span><span>.</span><span>xy</span> <span>:</span> <span>radii</span><span>.</span><span>zw</span><span>;</span>
</span></span><span><span>    <span>radii</span><span>.</span><span>x</span>  <span>=</span> <span>(</span><span>p</span><span>.</span><span>y</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>radii</span><span>.</span><span>x</span>  <span>:</span> <span>radii</span><span>.</span><span>y</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>q</span> <span>=</span> <span>abs</span><span>(</span><span>p</span><span>)</span><span>-</span><span>size</span><span>+</span><span>radii</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>min</span><span>(</span><span>max</span><span>(</span><span>q</span><span>.</span><span>x</span><span>,</span><span>q</span><span>.</span><span>y</span><span>),</span><span>0.0</span><span>)</span> <span>+</span> <span>length</span><span>(</span><span>max</span><span>(</span><span>q</span><span>,</span><span>0.0</span><span>))</span> <span>-</span> <span>radii</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>star</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>r</span><span>,</span> <span>float</span> <span>points</span><span>,</span> <span>float</span> <span>ratio</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>float</span> <span>an</span> <span>=</span> <span>3.141593</span><span>/</span><span>points</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>en</span> <span>=</span> <span>3.141593</span><span>/</span><span>(</span><span>ratio</span><span>*</span><span>(</span><span>points</span><span>-</span><span>2.</span><span>)</span> <span>+</span> <span>2.</span><span>);</span> 
</span></span><span><span>    <span>vec2</span>  <span>acs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>an</span><span>),</span><span>sin</span><span>(</span><span>an</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>ecs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>en</span><span>),</span><span>sin</span><span>(</span><span>en</span><span>));</span> 
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>bn</span> <span>=</span> <span>mod</span><span>(</span><span>atan</span><span>(</span><span>p</span><span>.</span><span>x</span><span>,</span><span>p</span><span>.</span><span>y</span><span>),</span><span>2.0</span><span>*</span><span>an</span><span>)</span> <span>-</span> <span>an</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>=</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>vec2</span><span>(</span><span>cos</span><span>(</span><span>bn</span><span>),</span><span>abs</span><span>(</span><span>sin</span><span>(</span><span>bn</span><span>)));</span>
</span></span><span><span>    <span>p</span> <span>-=</span> <span>r</span><span>*</span><span>acs</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>+=</span> <span>ecs</span><span>*</span><span>clamp</span><span>(</span> <span>-</span><span>dot</span><span>(</span><span>p</span><span>,</span><span>ecs</span><span>),</span> <span>0.0</span><span>,</span> <span>r</span><span>*</span><span>acs</span><span>.</span><span>y</span><span>/</span><span>ecs</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>p</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>     <span>// pupils</span>
</span></span><span><span>    <span>vec2</span> <span>pupil_pos</span> <span>=</span> <span>pixel</span><span>;</span>
</span></span><span><span>    <span>pupil_pos</span> <span>+=</span> <span>vec2</span><span>(</span><span>.13</span><span>,</span> <span>-</span><span>.24</span><span>);</span> <span>// position pupils on eyeballs</span>
</span></span><span><span>    <span>pupil_pos</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pupil_pos</span><span>.</span><span>x</span><span>);</span> <span>// mirror pupils</span>
</span></span><span><span>    <span>pupil_pos</span><span>.</span><span>x</span> <span>-=</span> <span>.16</span><span>;</span> <span>// pupil spacing</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>star</span><span>(</span><span>pupil_pos</span><span>,</span> <span>0.019</span><span>,</span> <span>6.</span><span>,</span> <span>.9</span><span>)</span> <span>&lt;</span> <span>0.007</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>.1</span><span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>    
</span></span><span><span>    <span>// eyeballs</span>
</span></span><span><span>    <span>// position/mirror/scale one liner</span>
</span></span><span><span>    <span>vec2</span> <span>eye_pos</span> <span>=</span> <span>vec2</span><span>(</span><span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.1</span><span>)</span><span>-</span><span>.17</span><span>,</span> <span>pixel</span><span>.</span><span>y</span><span>*</span><span>.93</span> <span>-</span> <span>.16</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>dist</span> <span>=</span> <span>circle</span><span>(</span><span>eye_pos</span><span>,</span> <span>.16</span><span>);</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>dist</span> <span>&lt;</span> <span>0.0</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>dist</span> <span>&lt;</span> <span>-</span><span>0.013</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>// head</span>
</span></span><span><span>    <span>{</span> <span>// fold</span>
</span></span><span><span>        <span>dist</span> <span>=</span> <span>min</span><span>(</span>
</span></span><span><span>            <span>// head</span>
</span></span><span><span>            <span>round_rect</span><span>(</span>
</span></span><span><span>            <span>pixel</span><span>,</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.36</span><span>,</span> <span>0.6385</span><span>),</span> 
</span></span><span><span>            <span>vec4</span><span>(</span><span>.34</span><span>,</span> <span>.415</span><span>,</span> <span>.363</span><span>,</span> <span>.315</span><span>)),</span>
</span></span><span><span>            
</span></span><span><span>            <span>// ear</span>
</span></span><span><span>            <span>round_rect</span><span>(</span>
</span></span><span><span>            <span>pixel</span> <span>+</span> <span>vec2</span><span>(</span><span>-</span><span>.32</span><span>,</span> <span>.15</span><span>),</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.15</span><span>,</span> <span>.12</span><span>),</span> 
</span></span><span><span>            <span>vec4</span><span>(</span><span>.13</span><span>,</span> <span>.1</span><span>,</span> <span>.13</span><span>,</span> <span>.13</span><span>))</span>
</span></span><span><span>        <span>);</span>
</span></span><span><span>            
</span></span><span><span>        <span>if</span> <span>(</span><span>dist</span> <span>&lt;</span> <span>-</span><span>0.01</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0.838</span><span>,</span> <span>0.799</span><span>,</span> <span>0.760</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>dist</span> <span>&lt;</span> <span>0.0</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span> <span>// outline</span>
</span></span><span><span>    <span>}</span>   
</span></span><span><span>    
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>1</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Let’s skip ahead. The mouth, nose, and eyebrow are all created with <code>bezier()</code>. The hair is an 11-point <code>star()</code> that I stretched vertically.</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>float</span> <span>bezier</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>v0</span><span>,</span> <span>vec2</span> <span>v1</span><span>,</span> <span>vec2</span> <span>v2</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>vec2</span> <span>i</span> <span>=</span> <span>v0</span> <span>-</span> <span>v2</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>j</span> <span>=</span> <span>v2</span> <span>-</span> <span>v1</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>k</span> <span>=</span> <span>v1</span> <span>-</span> <span>v0</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>w</span> <span>=</span> <span>j</span><span>-</span><span>k</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>v0</span><span>-=</span> <span>p</span><span>;</span> <span>v1</span><span>-=</span> <span>p</span><span>;</span> <span>v2</span><span>-=</span> <span>p</span><span>;</span>
</span></span><span><span>    
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>v0</span><span>.</span><span>x</span><span>*</span><span>v2</span><span>.</span><span>y</span><span>-</span><span>v0</span><span>.</span><span>y</span><span>*</span><span>v2</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>y</span> <span>=</span> <span>v1</span><span>.</span><span>x</span><span>*</span><span>v0</span><span>.</span><span>y</span><span>-</span><span>v1</span><span>.</span><span>y</span><span>*</span><span>v0</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>z</span> <span>=</span> <span>v2</span><span>.</span><span>x</span><span>*</span><span>v1</span><span>.</span><span>y</span><span>-</span><span>v2</span><span>.</span><span>y</span><span>*</span><span>v1</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>vec2</span> <span>s</span> <span>=</span> <span>2.0</span><span>*</span><span>(</span><span>y</span><span>*</span><span>j</span><span>+</span><span>z</span><span>*</span><span>k</span><span>)</span><span>-</span><span>x</span><span>*</span><span>i</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span>  <span>(</span><span>y</span><span>*</span><span>z</span><span>-</span><span>x</span><span>*</span><span>x</span><span>*</span><span>0.25</span><span>)</span><span>/</span><span>dot</span><span>(</span><span>s</span><span>,</span><span>s</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>t</span> <span>=</span> <span>clamp</span><span>(</span> <span>(</span><span>0.5</span><span>*</span><span>x</span><span>+</span><span>y</span><span>+</span><span>r</span><span>*</span><span>dot</span><span>(</span><span>s</span><span>,</span><span>w</span><span>))</span><span>/</span><span>(</span><span>x</span><span>+</span><span>y</span><span>+</span><span>z</span><span>),</span><span>0.0</span><span>,</span><span>1.0</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>vec2</span> <span>d</span> <span>=</span> <span>v0</span><span>+</span><span>t</span><span>*</span><span>(</span><span>k</span><span>+</span><span>k</span><span>+</span><span>t</span><span>*</span><span>w</span><span>);</span>
</span></span><span><span>    <span>vec2</span> <span>outQ</span> <span>=</span> <span>d</span> <span>+</span> <span>p</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>d</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>round_rect</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>b</span><span>,</span> <span>vec4</span> <span>r</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>r</span><span>.</span><span>xy</span> <span>=</span> <span>(</span><span>p</span><span>.</span><span>x</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>r</span><span>.</span><span>xy</span> <span>:</span> <span>r</span><span>.</span><span>zw</span><span>;</span>
</span></span><span><span>    <span>r</span><span>.</span><span>x</span>  <span>=</span> <span>(</span><span>p</span><span>.</span><span>y</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>r</span><span>.</span><span>x</span>  <span>:</span> <span>r</span><span>.</span><span>y</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>q</span> <span>=</span> <span>abs</span><span>(</span><span>p</span><span>)</span><span>-</span><span>b</span><span>+</span><span>r</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>min</span><span>(</span><span>max</span><span>(</span><span>q</span><span>.</span><span>x</span><span>,</span><span>q</span><span>.</span><span>y</span><span>),</span><span>0.0</span><span>)</span> <span>+</span> <span>length</span><span>(</span><span>max</span><span>(</span><span>q</span><span>,</span><span>0.0</span><span>))</span> <span>-</span> <span>r</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>circle</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>r</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>p</span><span>)</span> <span>-</span> <span>r</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>star</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>r</span><span>,</span> <span>float</span> <span>points</span><span>,</span> <span>float</span> <span>ratio</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// next 4 lines can be precomputed for a given shape</span>
</span></span><span><span>    <span>float</span> <span>an</span> <span>=</span> <span>3.141593</span><span>/</span><span>points</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>en</span> <span>=</span> <span>3.141593</span><span>/</span><span>(</span><span>ratio</span><span>*</span><span>(</span><span>points</span><span>-</span><span>2.</span><span>)</span> <span>+</span> <span>2.</span><span>);</span> 
</span></span><span><span>    <span>vec2</span>  <span>acs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>an</span><span>),</span><span>sin</span><span>(</span><span>an</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>ecs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>en</span><span>),</span><span>sin</span><span>(</span><span>en</span><span>));</span> <span>// ecs=vec2(0,1) for regular polygon</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>bn</span> <span>=</span> <span>mod</span><span>(</span><span>atan</span><span>(</span><span>p</span><span>.</span><span>x</span><span>,</span><span>p</span><span>.</span><span>y</span><span>),</span><span>2.0</span><span>*</span><span>an</span><span>)</span> <span>-</span> <span>an</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>=</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>vec2</span><span>(</span><span>cos</span><span>(</span><span>bn</span><span>),</span><span>abs</span><span>(</span><span>sin</span><span>(</span><span>bn</span><span>)));</span>
</span></span><span><span>    <span>p</span> <span>-=</span> <span>r</span><span>*</span><span>acs</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>+=</span> <span>ecs</span><span>*</span><span>clamp</span><span>(</span> <span>-</span><span>dot</span><span>(</span><span>p</span><span>,</span><span>ecs</span><span>),</span> <span>0.0</span><span>,</span> <span>r</span><span>*</span><span>acs</span><span>.</span><span>y</span><span>/</span><span>ecs</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>p</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>float</span> <span>d</span><span>;</span>
</span></span><span><span>  
</span></span><span><span>   <span>// eyes</span>
</span></span><span><span>   <span>{</span> <span>// fold</span>
</span></span><span><span>        <span>// pupils</span>
</span></span><span><span>        <span>vec2</span> <span>pupil_warp</span> <span>=</span> <span>pixel</span><span>;</span>
</span></span><span><span>        <span>pupil_warp</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pupil_warp</span><span>.</span><span>x</span> <span>+</span><span>.13</span><span>);</span>
</span></span><span><span>        <span>pupil_warp</span> <span>-=</span> <span>vec2</span><span>(</span><span>.16</span><span>,</span><span>.24</span><span>);</span>
</span></span><span><span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>star</span><span>(</span><span>pupil_warp</span><span>,</span> <span>0.019</span><span>,</span> <span>6.</span><span>,</span> <span>.9</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.007</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>.1</span><span>);</span>
</span></span><span><span>        <span>}</span>
</span></span><span><span>        
</span></span><span><span>        <span>// eyeballs</span>
</span></span><span><span>        <span>vec2</span> <span>eye</span> <span>=</span> <span>vec2</span><span>(</span><span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.1</span><span>)</span><span>-</span><span>.17</span><span>,</span> <span>pixel</span><span>.</span><span>y</span><span>*</span><span>.93</span> <span>-</span> <span>.16</span><span>);</span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>length</span><span>(</span><span>eye</span><span>)</span> <span>-</span> <span>.16</span><span>;</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>step</span><span>(</span><span>0.013</span><span>,</span> <span>-</span><span>d</span><span>));</span>
</span></span><span><span>        <span>}</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>    
</span></span><span><span>    <span>// nose  </span>
</span></span><span><span>    <span>d</span> <span>=</span> <span>min</span><span>(</span> <span>// combine the curves</span>
</span></span><span><span>            <span>bezier</span><span>(</span><span>pixel</span><span>,</span> 
</span></span><span><span>                <span>vec2</span><span>(</span><span>-</span><span>.15</span><span>,</span> <span>-</span><span>.13</span><span>),</span> 
</span></span><span><span>                <span>vec2</span><span>(</span><span>-</span><span>.21</span><span>,</span><span>-</span><span>.14</span><span>),</span> 
</span></span><span><span>                <span>vec2</span><span>(</span><span>-</span><span>.14</span><span>,</span> <span>.08</span><span>)),</span>
</span></span><span><span>            <span>bezier</span><span>(</span><span>pixel</span><span>,</span> 
</span></span><span><span>                <span>vec2</span><span>(</span><span>-</span><span>.085</span><span>,</span> <span>-</span><span>.01</span><span>),</span> 
</span></span><span><span>                <span>vec2</span><span>(</span><span>-</span><span>.12</span><span>,</span> <span>-</span><span>.13</span><span>),</span>
</span></span><span><span>                <span>vec2</span><span>(</span><span>-</span><span>.15</span><span>,</span><span>-</span><span>.13</span><span>)));</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0055</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>
</span></span><span><span>  
</span></span><span><span>        
</span></span><span><span>    <span>// mouth</span>
</span></span><span><span>    <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>pixel</span><span>,</span>  
</span></span><span><span>                 <span>vec2</span><span>(</span><span>-</span><span>.26</span><span>,</span> <span>-</span><span>.28</span><span>),</span> 
</span></span><span><span>                 <span>vec2</span><span>(</span><span>-</span><span>.05</span><span>,</span><span>-</span><span>.42</span><span>),</span> 
</span></span><span><span>                 <span>vec2</span><span>(</span><span>.115</span><span>,</span> <span>-</span><span>.25</span><span>));</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.12</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>// The `*step(d, .11)` creates the outline.</span>
</span></span><span><span>        <span>// it&#39;s the same as `*vec3(d &lt; .11)` </span>
</span></span><span><span>        <span>// aka, it multiplies the color by zero for </span>
</span></span><span><span>        <span>// pixels near the perimeter  </span>
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>.42</span><span>,</span> <span>.147</span><span>,</span> <span>.152</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>.11</span><span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>  
</span></span><span><span>    <span>// eyebrow</span>
</span></span><span><span>    <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>pixel</span><span>,</span>  
</span></span><span><span>                 <span>vec2</span><span>(</span><span>-</span><span>.34</span><span>,</span> <span>.38</span><span>),</span> 
</span></span><span><span>                 <span>vec2</span><span>(</span><span>-</span><span>.05</span><span>,</span> <span>.68</span><span>),</span> 
</span></span><span><span>                 <span>vec2</span><span>(</span><span>.205</span><span>,</span> <span>.36</span><span>))</span> <span>-</span> <span>0.035</span><span>;</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0</span><span>)</span> 
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>.71</span><span>,</span> <span>.839</span><span>,</span> <span>.922</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.013</span><span>);</span>
</span></span><span><span>
</span></span><span><span>    <span>// head</span>
</span></span><span><span>    <span>{</span>  <span>// fold</span>
</span></span><span><span>        <span>float</span> <span>dist</span> <span>=</span> <span>min</span><span>(</span>
</span></span><span><span>            <span>// head</span>
</span></span><span><span>            <span>round_rect</span><span>(</span>
</span></span><span><span>            <span>pixel</span><span>,</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.36</span><span>,</span> <span>.6385</span><span>),</span> 
</span></span><span><span>            <span>vec4</span><span>(</span><span>.34</span><span>,</span> <span>.415</span><span>,</span> <span>.363</span><span>,</span> <span>.315</span><span>)),</span>
</span></span><span><span>            
</span></span><span><span>            <span>// ear</span>
</span></span><span><span>            <span>round_rect</span><span>(</span>
</span></span><span><span>            <span>pixel</span> <span>+</span> <span>vec2</span><span>(</span><span>-</span><span>.32</span><span>,</span> <span>.15</span><span>),</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.15</span><span>,</span> <span>0.12</span><span>),</span> 
</span></span><span><span>            <span>vec4</span><span>(</span><span>.13</span><span>,</span><span>.1</span><span>,</span><span>.13</span><span>,</span><span>.13</span><span>))</span>
</span></span><span><span>        <span>);</span>
</span></span><span><span>            
</span></span><span><span>        <span>if</span> <span>(</span><span>dist</span> <span>&lt;</span> <span>-</span><span>.01</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>.838</span><span>,</span> <span>.799</span><span>,</span> <span>.76</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>dist</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span> <span>// outline</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>    
</span></span><span><span>    <span>// hair</span>
</span></span><span><span>    <span>d</span> <span>=</span> <span>star</span><span>((</span><span>pixel</span><span>-</span><span>vec2</span><span>(</span><span>.08</span><span>,</span><span>.15</span><span>))</span><span>*</span><span>vec2</span><span>(</span><span>1.3</span><span>,</span><span>1.</span><span>),</span> <span>0.95</span><span>,</span> <span>11.</span><span>,</span> <span>.28</span><span>);</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>0.682</span><span>,</span> <span>0.839</span><span>,</span> <span>0.929</span><span>)</span><span>*</span><span>step</span><span>(</span><span>0.012</span><span>,</span> <span>-</span><span>d</span><span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>    
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>1.</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>That’s as far as basic shape positioning, scaling, and outlining can get us.</p><h2 id="making-the-hair-wavy">Making the Hair Wavy</h2><p>The remaining steps will elevate our crude sketch of Rick into a drawing that looks exactly like him. We’ll learn a few more techniques to make this possible. First up: let’s fix his rigid looking hair. There isn’t a “wavy hair” signed distance function, but we can make the star shape more wavy using a technique called <a href="https://iquilezles.org/articles/warp/" target="_blank" rel="noopener">domain warping</a>.</p><p>Domain warping randomly offsets pixel locations. That random offset is “seeded” by the pixel’s location, so the offset is consistent over time for any given location. You can use that warped location for whatever shapes you want warped. Here’s an 11-point star with and without warping:</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>float</span> <span>star</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>r</span><span>,</span> <span>float</span> <span>points</span><span>,</span> <span>float</span> <span>ratio</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// next 4 lines can be precomputed for a given shape</span>
</span></span><span><span>    <span>float</span> <span>an</span> <span>=</span> <span>3.141593</span><span>/</span><span>points</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>en</span> <span>=</span> <span>3.141593</span><span>/</span><span>(</span><span>ratio</span><span>*</span><span>(</span><span>points</span><span>-</span><span>2.</span><span>)</span> <span>+</span> <span>2.</span><span>);</span> 
</span></span><span><span>    <span>vec2</span>  <span>acs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>an</span><span>),</span><span>sin</span><span>(</span><span>an</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>ecs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>en</span><span>),</span><span>sin</span><span>(</span><span>en</span><span>));</span> <span>// ecs=vec2(0,1) for regular polygon</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>bn</span> <span>=</span> <span>mod</span><span>(</span><span>atan</span><span>(</span><span>p</span><span>.</span><span>x</span><span>,</span><span>p</span><span>.</span><span>y</span><span>),</span><span>2.0</span><span>*</span><span>an</span><span>)</span> <span>-</span> <span>an</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>=</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>vec2</span><span>(</span><span>cos</span><span>(</span><span>bn</span><span>),</span><span>abs</span><span>(</span><span>sin</span><span>(</span><span>bn</span><span>)));</span>
</span></span><span><span>    <span>p</span> <span>-=</span> <span>r</span><span>*</span><span>acs</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>+=</span> <span>ecs</span><span>*</span><span>clamp</span><span>(</span> <span>-</span><span>dot</span><span>(</span><span>p</span><span>,</span><span>ecs</span><span>),</span> <span>0.0</span><span>,</span> <span>r</span><span>*</span><span>acs</span><span>.</span><span>y</span><span>/</span><span>ecs</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>p</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>// these functions are used by the `warp()` function </span>
</span></span><span><span><span>// to generate pseudo random numbers. The details aren&#39;t </span>
</span></span><span><span><span>// super important. I looked these functions up:</span>
</span></span><span><span><span>// https://www.shadertoy.com/view/XdXGW8</span>
</span></span><span><span><span>vec2</span> <span>grad</span><span>(</span><span>ivec2</span> <span>z</span><span>)</span>  <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>int</span> <span>n</span> <span>=</span> <span>z</span><span>.</span><span>x</span><span>+</span><span>z</span><span>.</span><span>y</span><span>*</span><span>11111</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>=</span> <span>(</span><span>n</span><span>&lt;&lt;</span><span>13</span><span>)</span><span>^</span><span>n</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>=</span> <span>(</span><span>n</span><span>*</span><span>(</span><span>n</span><span>*</span><span>n</span><span>*</span><span>15731</span><span>+</span><span>789221</span><span>)</span><span>+</span><span>1376312589</span><span>)</span><span>&gt;&gt;</span><span>16</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>&amp;=</span> <span>7</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>gr</span> <span>=</span> <span>vec2</span><span>(</span><span>n</span><span>&amp;</span><span>1</span><span>,</span><span>n</span><span>&gt;&gt;</span><span>1</span><span>)</span><span>*</span><span>2.0</span><span>-</span><span>1.0</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>(</span> <span>n</span><span>&gt;=</span><span>6</span> <span>)</span> <span>?</span> <span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>gr</span><span>.</span><span>x</span><span>)</span> <span>:</span> 
</span></span><span><span>           <span>(</span> <span>n</span><span>&gt;=</span><span>4</span> <span>)</span> <span>?</span> <span>vec2</span><span>(</span><span>gr</span><span>.</span><span>x</span><span>,</span><span>0.0</span><span>)</span> <span>:</span>
</span></span><span><span>                              <span>gr</span><span>;</span>                            
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>noise</span><span>(</span><span>vec2</span> <span>p</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>ivec2</span> <span>i</span> <span>=</span> <span>ivec2</span><span>(</span><span>floor</span><span>(</span><span>p</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>f</span> <span>=</span>       <span>fract</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>vec2</span> <span>u</span> <span>=</span> <span>f</span><span>*</span><span>f</span><span>*</span><span>(</span><span>3.0</span><span>-</span><span>2.0</span><span>*</span><span>f</span><span>);</span> 
</span></span><span><span>    <span>return</span> <span>mix</span><span>(</span> <span>mix</span><span>(</span> <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>0</span><span>,</span><span>0</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>0.0</span><span>)</span> <span>),</span> 
</span></span><span><span>                     <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>1</span><span>,</span><span>0</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>1.0</span><span>,</span><span>0.0</span><span>)</span> <span>),</span> <span>u</span><span>.</span><span>x</span><span>),</span>
</span></span><span><span>                <span>mix</span><span>(</span> <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>0</span><span>,</span><span>1</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>1.0</span><span>)</span> <span>),</span> 
</span></span><span><span>                     <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>1</span><span>,</span><span>1</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>1.0</span><span>,</span><span>1.0</span><span>)</span> <span>),</span> <span>u</span><span>.</span><span>x</span><span>),</span> <span>u</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>vec2</span> <span>warp</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>scale</span><span>,</span> <span>float</span> <span>strength</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>float</span> <span>offsetX</span> <span>=</span> <span>noise</span><span>(</span><span>p</span> <span>*</span> <span>scale</span> <span>+</span> <span>vec2</span><span>(</span><span>0.0</span><span>,</span> <span>100.0</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>offsetY</span> <span>=</span> <span>noise</span><span>(</span><span>p</span> <span>*</span> <span>scale</span> <span>+</span> <span>vec2</span><span>(</span><span>100.0</span><span>,</span> <span>0.0</span><span>));</span>
</span></span><span><span>    <span>return</span> <span>p</span> <span>+</span> <span>vec2</span><span>(</span><span>offsetX</span><span>,</span> <span>offsetY</span><span>)</span> <span>*</span> <span>strength</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>vec2</span> <span>warped_pixel</span> <span>=</span> <span>warp</span><span>(</span><span>pixel</span><span>,</span> <span>4.</span><span>,</span> <span>.07</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>d</span> <span>=</span> <span>min</span><span>(</span>
</span></span><span><span>        <span>star</span><span>(</span><span>warped_pixel</span> <span>+</span> <span>vec2</span><span>(</span><span>.8</span><span>,</span><span>0</span><span>),</span> <span>0.7</span><span>,</span> <span>11.</span><span>,</span> <span>.28</span><span>),</span>
</span></span><span><span>        <span>star</span><span>(</span><span>pixel</span> <span>-</span> <span>vec2</span><span>(</span><span>.8</span><span>,</span><span>0</span><span>),</span> <span>0.7</span><span>,</span> <span>11.</span><span>,</span> <span>.28</span><span>)</span>
</span></span><span><span>        <span>);</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>0.682</span><span>,</span> <span>0.839</span><span>,</span> <span>0.929</span><span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>    
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>1</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Visualize the warp offsets by drawing the x offset to the red channel and the y offset to the green channel</p><p>Fun fact: the Lord of the Rings movies <a href="https://www.youtube.com/watch?v=6Koa50421Pg&amp;t=1056s" target="_blank" rel="noopener">used domain warping</a> to create the visual effect seen when Frodo is wearing the Ring. Their warp offsets came from tracking fire movement.</p><p>Animate the warp effect above to achieve the Lord of the Rings effect.</p><h2 id="drawing-infinite-teeth">Drawing Infinite Teeth</h2><p>Rick needs teeth, a lot them. But we’ll start by drawing one. A parabola is the best tooth shape I could find:</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>float</span> <span>parabola</span><span>(</span><span>vec2</span> <span>pos</span><span>,</span> <span>float</span> <span>k</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// from https://www.shadertoy.com/view/ws3GD7</span>
</span></span><span><span>    <span>pos</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>ik</span> <span>=</span> <span>1.0</span><span>/</span><span>k</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>p</span> <span>=</span> <span>ik</span><span>*</span><span>(</span><span>pos</span><span>.</span><span>y</span> <span>-</span> <span>0.5</span><span>*</span><span>ik</span><span>)</span><span>/</span><span>3.0</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>q</span> <span>=</span> <span>0.25</span><span>*</span><span>ik</span><span>*</span><span>ik</span><span>*</span><span>pos</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>h</span> <span>=</span> <span>q</span><span>*</span><span>q</span> <span>-</span> <span>p</span><span>*</span><span>p</span><span>*</span><span>p</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span> <span>sqrt</span><span>(</span><span>abs</span><span>(</span><span>h</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>(</span><span>h</span><span>&gt;</span><span>0.0</span><span>)</span> <span>?</span> 
</span></span><span><span>        <span>pow</span><span>(</span><span>q</span><span>+</span><span>r</span><span>,</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span> <span>-</span> <span>pow</span><span>(</span><span>abs</span><span>(</span><span>q</span><span>-</span><span>r</span><span>),</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>r</span><span>-</span><span>q</span><span>)</span> <span>:</span>
</span></span><span><span>        <span>2.0</span><span>*</span><span>cos</span><span>(</span><span>atan</span><span>(</span><span>r</span><span>,</span><span>q</span><span>)</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sqrt</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>pos</span><span>-</span><span>vec2</span><span>(</span><span>x</span><span>,</span><span>k</span><span>*</span><span>x</span><span>*</span><span>x</span><span>))</span> <span>*</span> <span>sign</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>-</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>float</span> <span>d</span> <span>=</span> <span>parabola</span><span>(</span><span>pixel</span><span>,</span> <span>38.</span><span>);</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0.902</span><span>,</span> <span>0.890</span><span>,</span> <span>0.729</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.01</span><span>);</span>
</span></span><span><span>
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>1</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Yes that is a tooth. Stick with me.</p><p>Is there a way to draw multiple teeth without duplicating a bunch of code, or using a <code>for</code> loop? Yes! Similar to how we used <code>abs()</code> to mirror shapes, we can use <code>mod()</code> to repeat shapes. <code>mod(a,b)</code> calculates the reminder of <code>a/b</code>. Look below at what <code>mod(pixel.x, 0.5)</code> does. Every time <code>pixel.x</code> increases above a multiple of <code>.5</code> , <code>mod()</code> starts back at zero (black) again.</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>mod</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>,</span> <span>0.5</span><span>));</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Here is <code>mod()</code> applied to the single tooth</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>float</span> <span>parabola</span><span>(</span><span>vec2</span> <span>pos</span><span>,</span> <span>float</span> <span>k</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// from https://www.shadertoy.com/view/ws3GD7</span>
</span></span><span><span>    <span>pos</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>ik</span> <span>=</span> <span>1.0</span><span>/</span><span>k</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>p</span> <span>=</span> <span>ik</span><span>*</span><span>(</span><span>pos</span><span>.</span><span>y</span> <span>-</span> <span>0.5</span><span>*</span><span>ik</span><span>)</span><span>/</span><span>3.0</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>q</span> <span>=</span> <span>0.25</span><span>*</span><span>ik</span><span>*</span><span>ik</span><span>*</span><span>pos</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>h</span> <span>=</span> <span>q</span><span>*</span><span>q</span> <span>-</span> <span>p</span><span>*</span><span>p</span><span>*</span><span>p</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span> <span>sqrt</span><span>(</span><span>abs</span><span>(</span><span>h</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>(</span><span>h</span><span>&gt;</span><span>0.0</span><span>)</span> <span>?</span> 
</span></span><span><span>        <span>pow</span><span>(</span><span>q</span><span>+</span><span>r</span><span>,</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span> <span>-</span> <span>pow</span><span>(</span><span>abs</span><span>(</span><span>q</span><span>-</span><span>r</span><span>),</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>r</span><span>-</span><span>q</span><span>)</span> <span>:</span>
</span></span><span><span>        <span>2.0</span><span>*</span><span>cos</span><span>(</span><span>atan</span><span>(</span><span>r</span><span>,</span><span>q</span><span>)</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sqrt</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>pos</span><span>-</span><span>vec2</span><span>(</span><span>x</span><span>,</span><span>k</span><span>*</span><span>x</span><span>*</span><span>x</span><span>))</span> <span>*</span> <span>sign</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>-</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>float</span> <span>width</span> <span>=</span> <span>.065</span><span>;</span>    
</span></span><span><span>    <span>pixel</span><span>.</span><span>x</span> <span>=</span> <span>mod</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>,</span> <span>width</span><span>)</span><span>-</span><span>width</span><span>*</span><span>.5</span><span>;</span> <span>// NEW: repeat horizontally</span>
</span></span><span><span>    <span>float</span> <span>d</span> <span>=</span> <span>parabola</span><span>(</span><span>pixel</span><span>,</span> <span>38.</span><span>);</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0.902</span><span>,</span> <span>0.890</span><span>,</span> <span>0.729</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.01</span><span>);</span>
</span></span><span><span>
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>1</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Repeat the teeth <a href="https://iquilezles.org/articles/sdfrepetition/#:~:text=Rotational%20and%20Rectangular%20Repetition" target="_blank" rel="noopener">in a circle</a> instead of in a line to create a <a href="https://duckduckgo.com/?q=sandworm&amp;iax=images&amp;ia=images" target="_blank" rel="noopener">sandworm mouth</a></p><p>and we can mirror that to get the bottom teeth</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>float</span> <span>parabola</span><span>(</span><span>vec2</span> <span>pos</span><span>,</span> <span>float</span> <span>k</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// from https://www.shadertoy.com/view/ws3GD7</span>
</span></span><span><span>    <span>pos</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>ik</span> <span>=</span> <span>1.0</span><span>/</span><span>k</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>p</span> <span>=</span> <span>ik</span><span>*</span><span>(</span><span>pos</span><span>.</span><span>y</span> <span>-</span> <span>0.5</span><span>*</span><span>ik</span><span>)</span><span>/</span><span>3.0</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>q</span> <span>=</span> <span>0.25</span><span>*</span><span>ik</span><span>*</span><span>ik</span><span>*</span><span>pos</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>h</span> <span>=</span> <span>q</span><span>*</span><span>q</span> <span>-</span> <span>p</span><span>*</span><span>p</span><span>*</span><span>p</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span> <span>sqrt</span><span>(</span><span>abs</span><span>(</span><span>h</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>(</span><span>h</span><span>&gt;</span><span>0.0</span><span>)</span> <span>?</span> 
</span></span><span><span>        <span>pow</span><span>(</span><span>q</span><span>+</span><span>r</span><span>,</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span> <span>-</span> <span>pow</span><span>(</span><span>abs</span><span>(</span><span>q</span><span>-</span><span>r</span><span>),</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>r</span><span>-</span><span>q</span><span>)</span> <span>:</span>
</span></span><span><span>        <span>2.0</span><span>*</span><span>cos</span><span>(</span><span>atan</span><span>(</span><span>r</span><span>,</span><span>q</span><span>)</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sqrt</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>pos</span><span>-</span><span>vec2</span><span>(</span><span>x</span><span>,</span><span>k</span><span>*</span><span>x</span><span>*</span><span>x</span><span>))</span> <span>*</span> <span>sign</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>-</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>float</span> <span>width</span> <span>=</span> <span>.065</span><span>;</span>
</span></span><span><span>    <span>pixel</span><span>.</span><span>y</span> <span>=</span> <span>abs</span><span>(</span><span>pixel</span><span>.</span><span>y</span><span>)</span><span>-</span><span>.06</span><span>;</span> <span>// NEW: mirror vertically </span>
</span></span><span><span>    <span>pixel</span><span>.</span><span>x</span> <span>=</span> <span>mod</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>,</span> <span>width</span><span>)</span><span>-</span><span>width</span><span>*</span><span>.5</span><span>;</span> <span>// repeat horizontally</span>
</span></span><span><span>    <span>float</span> <span>d</span> <span>=</span> <span>parabola</span><span>(</span><span>pixel</span><span>,</span> <span>38.</span><span>);</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0.902</span><span>,</span> <span>0.890</span><span>,</span> <span>0.729</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.01</span><span>);</span>
</span></span><span><span>
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>1</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Then to make it a smile, we offset the y position of the tooth based on <code>pixel.x</code>.</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>float</span> <span>parabola</span><span>(</span><span>vec2</span> <span>pos</span><span>,</span> <span>float</span> <span>k</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// from https://www.shadertoy.com/view/ws3GD7</span>
</span></span><span><span>    <span>pos</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>ik</span> <span>=</span> <span>1.0</span><span>/</span><span>k</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>p</span> <span>=</span> <span>ik</span><span>*</span><span>(</span><span>pos</span><span>.</span><span>y</span> <span>-</span> <span>0.5</span><span>*</span><span>ik</span><span>)</span><span>/</span><span>3.0</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>q</span> <span>=</span> <span>0.25</span><span>*</span><span>ik</span><span>*</span><span>ik</span><span>*</span><span>pos</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>h</span> <span>=</span> <span>q</span><span>*</span><span>q</span> <span>-</span> <span>p</span><span>*</span><span>p</span><span>*</span><span>p</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span> <span>sqrt</span><span>(</span><span>abs</span><span>(</span><span>h</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>(</span><span>h</span><span>&gt;</span><span>0.0</span><span>)</span> <span>?</span> 
</span></span><span><span>        <span>pow</span><span>(</span><span>q</span><span>+</span><span>r</span><span>,</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span> <span>-</span> <span>pow</span><span>(</span><span>abs</span><span>(</span><span>q</span><span>-</span><span>r</span><span>),</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>r</span><span>-</span><span>q</span><span>)</span> <span>:</span>
</span></span><span><span>        <span>2.0</span><span>*</span><span>cos</span><span>(</span><span>atan</span><span>(</span><span>r</span><span>,</span><span>q</span><span>)</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sqrt</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>pos</span><span>-</span><span>vec2</span><span>(</span><span>x</span><span>,</span><span>k</span><span>*</span><span>x</span><span>*</span><span>x</span><span>))</span> <span>*</span> <span>sign</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>-</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>float</span> <span>width</span> <span>=</span> <span>.065</span><span>;</span>
</span></span><span><span>    <span>pixel</span><span>.</span><span>y</span> <span>-=</span> <span>pow</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>,</span> <span>2.</span><span>);</span> <span>// NEW: curve into a smile</span>
</span></span><span><span>    <span>pixel</span><span>.</span><span>y</span> <span>=</span> <span>abs</span><span>(</span><span>pixel</span><span>.</span><span>y</span><span>)</span><span>-</span><span>.06</span><span>;</span> <span>// mirror vertically</span>
</span></span><span><span>    <span>pixel</span><span>.</span><span>x</span> <span>=</span> <span>mod</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>,</span> <span>width</span><span>)</span><span>-</span><span>width</span><span>*</span><span>.5</span><span>;</span> <span>// repeat horizontally</span>
</span></span><span><span>    <span>float</span> <span>d</span> <span>=</span> <span>parabola</span><span>(</span><span>pixel</span><span>,</span> <span>38.</span><span>);</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0.902</span><span>,</span> <span>0.890</span><span>,</span> <span>0.729</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.01</span><span>);</span>
</span></span><span><span>
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>1</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Kind of creepy. Reducing the infinite teeth down to 12 will make it a little less creepy — done by only drawing teeth when <code>pixel.x</code> is within the desired range</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>float</span> <span>parabola</span><span>(</span><span>vec2</span> <span>pos</span><span>,</span> <span>float</span> <span>k</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// from https://www.shadertoy.com/view/ws3GD7</span>
</span></span><span><span>    <span>pos</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>ik</span> <span>=</span> <span>1.0</span><span>/</span><span>k</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>p</span> <span>=</span> <span>ik</span><span>*</span><span>(</span><span>pos</span><span>.</span><span>y</span> <span>-</span> <span>0.5</span><span>*</span><span>ik</span><span>)</span><span>/</span><span>3.0</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>q</span> <span>=</span> <span>0.25</span><span>*</span><span>ik</span><span>*</span><span>ik</span><span>*</span><span>pos</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>h</span> <span>=</span> <span>q</span><span>*</span><span>q</span> <span>-</span> <span>p</span><span>*</span><span>p</span><span>*</span><span>p</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span> <span>sqrt</span><span>(</span><span>abs</span><span>(</span><span>h</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>(</span><span>h</span><span>&gt;</span><span>0.0</span><span>)</span> <span>?</span> 
</span></span><span><span>        <span>pow</span><span>(</span><span>q</span><span>+</span><span>r</span><span>,</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span> <span>-</span> <span>pow</span><span>(</span><span>abs</span><span>(</span><span>q</span><span>-</span><span>r</span><span>),</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>r</span><span>-</span><span>q</span><span>)</span> <span>:</span>
</span></span><span><span>        <span>2.0</span><span>*</span><span>cos</span><span>(</span><span>atan</span><span>(</span><span>r</span><span>,</span><span>q</span><span>)</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sqrt</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>pos</span><span>-</span><span>vec2</span><span>(</span><span>x</span><span>,</span><span>k</span><span>*</span><span>x</span><span>*</span><span>x</span><span>))</span> <span>*</span> <span>sign</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>-</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>float</span> <span>width</span> <span>=</span> <span>.065</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>teeth</span> <span>=</span> <span>pixel</span><span>;</span>
</span></span><span><span>    <span>teeth</span><span>.</span><span>y</span> <span>-=</span> <span>pow</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>,</span> <span>2.</span><span>);</span>
</span></span><span><span>    <span>teeth</span><span>.</span><span>y</span> <span>=</span> <span>abs</span><span>(</span><span>teeth</span><span>.</span><span>y</span><span>)</span><span>-</span><span>.06</span><span>;</span> 
</span></span><span><span>    <span>teeth</span><span>.</span><span>x</span> <span>=</span> <span>mod</span><span>(</span><span>teeth</span><span>.</span><span>x</span><span>,</span> <span>width</span><span>)</span><span>-</span><span>width</span><span>*</span><span>.5</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>d</span> <span>=</span> <span>parabola</span><span>(</span><span>teeth</span><span>,</span> <span>38.</span><span>);</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span> 
</span></span><span><span>        <span>// Limit where the teeth are drawn</span>
</span></span><span><span>        <span>&amp;&amp;</span> <span>pixel</span><span>.</span><span>x</span> <span>&lt;</span> <span>width</span><span>*</span><span>3.</span>
</span></span><span><span>        <span>&amp;&amp;</span> <span>pixel</span><span>.</span><span>x</span> <span>&gt;</span> <span>-</span><span>width</span><span>*</span><span>3.</span>
</span></span><span><span>    <span>)</span> <span>{</span>
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>0.902</span><span>,</span> <span>0.890</span><span>,</span> <span>0.729</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.01</span><span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>1</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Here’s Rick with wavy hair and new set of teeth. I also added the tongue. Notice that the tongue and teeth only draw inside the mouth thanks to placing their code inside the <code>if</code> that checks the mouth distance.</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>float</span> <span>map</span><span>(</span><span>float</span> <span>value</span><span>,</span> <span>float</span> <span>inMin</span><span>,</span> <span>float</span> <span>inMax</span><span>,</span> <span>float</span> <span>outMin</span><span>,</span> <span>float</span> <span>outMax</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>  <span>value</span> <span>=</span> <span>clamp</span><span>(</span><span>value</span><span>,</span> <span>inMin</span><span>,</span> <span>inMax</span><span>);</span>
</span></span><span><span>  <span>return</span> <span>outMin</span> <span>+</span> <span>(</span><span>outMax</span> <span>-</span> <span>outMin</span><span>)</span> <span>*</span> <span>(</span><span>value</span> <span>-</span> <span>inMin</span><span>)</span> <span>/</span> <span>(</span><span>inMax</span> <span>-</span> <span>inMin</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>vec2</span> <span>grad</span><span>(</span><span>ivec2</span> <span>z</span><span>)</span>  <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>int</span> <span>n</span> <span>=</span> <span>z</span><span>.</span><span>x</span><span>+</span><span>z</span><span>.</span><span>y</span><span>*</span><span>11111</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>=</span> <span>(</span><span>n</span><span>&lt;&lt;</span><span>13</span><span>)</span><span>^</span><span>n</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>=</span> <span>(</span><span>n</span><span>*</span><span>(</span><span>n</span><span>*</span><span>n</span><span>*</span><span>15731</span><span>+</span><span>789221</span><span>)</span><span>+</span><span>1376312589</span><span>)</span><span>&gt;&gt;</span><span>16</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>&amp;=</span> <span>7</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>gr</span> <span>=</span> <span>vec2</span><span>(</span><span>n</span><span>&amp;</span><span>1</span><span>,</span><span>n</span><span>&gt;&gt;</span><span>1</span><span>)</span><span>*</span><span>2.0</span><span>-</span><span>1.0</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>(</span> <span>n</span><span>&gt;=</span><span>6</span> <span>)</span> <span>?</span> <span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>gr</span><span>.</span><span>x</span><span>)</span> <span>:</span> 
</span></span><span><span>           <span>(</span> <span>n</span><span>&gt;=</span><span>4</span> <span>)</span> <span>?</span> <span>vec2</span><span>(</span><span>gr</span><span>.</span><span>x</span><span>,</span><span>0.0</span><span>)</span> <span>:</span>
</span></span><span><span>                              <span>gr</span><span>;</span>                            
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>noise</span><span>(</span><span>vec2</span> <span>p</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>ivec2</span> <span>i</span> <span>=</span> <span>ivec2</span><span>(</span><span>floor</span><span>(</span><span>p</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>f</span> <span>=</span>       <span>fract</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>vec2</span> <span>u</span> <span>=</span> <span>f</span><span>*</span><span>f</span><span>*</span><span>(</span><span>3.0</span><span>-</span><span>2.0</span><span>*</span><span>f</span><span>);</span> 
</span></span><span><span>    <span>return</span> <span>mix</span><span>(</span> <span>mix</span><span>(</span> <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>0</span><span>,</span><span>0</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>0.0</span><span>)</span> <span>),</span> 
</span></span><span><span>                     <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>1</span><span>,</span><span>0</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>1.0</span><span>,</span><span>0.0</span><span>)</span> <span>),</span> <span>u</span><span>.</span><span>x</span><span>),</span>
</span></span><span><span>                <span>mix</span><span>(</span> <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>0</span><span>,</span><span>1</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>1.0</span><span>)</span> <span>),</span> 
</span></span><span><span>                     <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>1</span><span>,</span><span>1</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>1.0</span><span>,</span><span>1.0</span><span>)</span> <span>),</span> <span>u</span><span>.</span><span>x</span><span>),</span> <span>u</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>vec2</span> <span>warp</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>scale</span><span>,</span> <span>float</span> <span>strength</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>float</span> <span>offsetX</span> <span>=</span> <span>noise</span><span>(</span><span>p</span> <span>*</span> <span>scale</span> <span>+</span> <span>vec2</span><span>(</span><span>0.0</span><span>,</span> <span>100.0</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>offsetY</span> <span>=</span> <span>noise</span><span>(</span><span>p</span> <span>*</span> <span>scale</span> <span>+</span> <span>vec2</span><span>(</span><span>100.0</span><span>,</span> <span>0.0</span><span>));</span>
</span></span><span><span>    <span>return</span> <span>p</span> <span>+</span> <span>vec2</span><span>(</span><span>offsetX</span><span>,</span> <span>offsetY</span><span>)</span> <span>*</span> <span>strength</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>bezier</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>v0</span><span>,</span> <span>vec2</span> <span>v1</span><span>,</span> <span>vec2</span> <span>v2</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>vec2</span> <span>i</span> <span>=</span> <span>v0</span> <span>-</span> <span>v2</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>j</span> <span>=</span> <span>v2</span> <span>-</span> <span>v1</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>k</span> <span>=</span> <span>v1</span> <span>-</span> <span>v0</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>w</span> <span>=</span> <span>j</span><span>-</span><span>k</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>v0</span><span>-=</span> <span>p</span><span>;</span> <span>v1</span><span>-=</span> <span>p</span><span>;</span> <span>v2</span><span>-=</span> <span>p</span><span>;</span>
</span></span><span><span>    
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>v0</span><span>.</span><span>x</span><span>*</span><span>v2</span><span>.</span><span>y</span><span>-</span><span>v0</span><span>.</span><span>y</span><span>*</span><span>v2</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>y</span> <span>=</span> <span>v1</span><span>.</span><span>x</span><span>*</span><span>v0</span><span>.</span><span>y</span><span>-</span><span>v1</span><span>.</span><span>y</span><span>*</span><span>v0</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>z</span> <span>=</span> <span>v2</span><span>.</span><span>x</span><span>*</span><span>v1</span><span>.</span><span>y</span><span>-</span><span>v2</span><span>.</span><span>y</span><span>*</span><span>v1</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>vec2</span> <span>s</span> <span>=</span> <span>2.0</span><span>*</span><span>(</span><span>y</span><span>*</span><span>j</span><span>+</span><span>z</span><span>*</span><span>k</span><span>)</span><span>-</span><span>x</span><span>*</span><span>i</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span>  <span>(</span><span>y</span><span>*</span><span>z</span><span>-</span><span>x</span><span>*</span><span>x</span><span>*</span><span>0.25</span><span>)</span><span>/</span><span>dot</span><span>(</span><span>s</span><span>,</span><span>s</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>t</span> <span>=</span> <span>clamp</span><span>(</span> <span>(</span><span>0.5</span><span>*</span><span>x</span><span>+</span><span>y</span><span>+</span><span>r</span><span>*</span><span>dot</span><span>(</span><span>s</span><span>,</span><span>w</span><span>))</span><span>/</span><span>(</span><span>x</span><span>+</span><span>y</span><span>+</span><span>z</span><span>),</span><span>0.0</span><span>,</span><span>1.0</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>vec2</span> <span>d</span> <span>=</span> <span>v0</span><span>+</span><span>t</span><span>*</span><span>(</span><span>k</span><span>+</span><span>k</span><span>+</span><span>t</span><span>*</span><span>w</span><span>);</span>
</span></span><span><span>    <span>vec2</span> <span>outQ</span> <span>=</span> <span>d</span> <span>+</span> <span>p</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>d</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>parabola</span><span>(</span><span>vec2</span> <span>pos</span><span>,</span> <span>float</span> <span>k</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// from https://www.shadertoy.com/view/ws3GD7</span>
</span></span><span><span>    <span>pos</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>ik</span> <span>=</span> <span>1.0</span><span>/</span><span>k</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>p</span> <span>=</span> <span>ik</span><span>*</span><span>(</span><span>pos</span><span>.</span><span>y</span> <span>-</span> <span>0.5</span><span>*</span><span>ik</span><span>)</span><span>/</span><span>3.0</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>q</span> <span>=</span> <span>0.25</span><span>*</span><span>ik</span><span>*</span><span>ik</span><span>*</span><span>pos</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>h</span> <span>=</span> <span>q</span><span>*</span><span>q</span> <span>-</span> <span>p</span><span>*</span><span>p</span><span>*</span><span>p</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span> <span>sqrt</span><span>(</span><span>abs</span><span>(</span><span>h</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>(</span><span>h</span><span>&gt;</span><span>0.0</span><span>)</span> <span>?</span> 
</span></span><span><span>        <span>pow</span><span>(</span><span>q</span><span>+</span><span>r</span><span>,</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span> <span>-</span> <span>pow</span><span>(</span><span>abs</span><span>(</span><span>q</span><span>-</span><span>r</span><span>),</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>r</span><span>-</span><span>q</span><span>)</span> <span>:</span>
</span></span><span><span>        <span>2.0</span><span>*</span><span>cos</span><span>(</span><span>atan</span><span>(</span><span>r</span><span>,</span><span>q</span><span>)</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sqrt</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>pos</span><span>-</span><span>vec2</span><span>(</span><span>x</span><span>,</span><span>k</span><span>*</span><span>x</span><span>*</span><span>x</span><span>))</span> <span>*</span> <span>sign</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>-</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>round_rect</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>b</span><span>,</span> <span>vec4</span> <span>r</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>r</span><span>.</span><span>xy</span> <span>=</span> <span>(</span><span>p</span><span>.</span><span>x</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>r</span><span>.</span><span>xy</span> <span>:</span> <span>r</span><span>.</span><span>zw</span><span>;</span>
</span></span><span><span>    <span>r</span><span>.</span><span>x</span>  <span>=</span> <span>(</span><span>p</span><span>.</span><span>y</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>r</span><span>.</span><span>x</span>  <span>:</span> <span>r</span><span>.</span><span>y</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>q</span> <span>=</span> <span>abs</span><span>(</span><span>p</span><span>)</span><span>-</span><span>b</span><span>+</span><span>r</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>min</span><span>(</span><span>max</span><span>(</span><span>q</span><span>.</span><span>x</span><span>,</span><span>q</span><span>.</span><span>y</span><span>),</span><span>0.0</span><span>)</span> <span>+</span> <span>length</span><span>(</span><span>max</span><span>(</span><span>q</span><span>,</span><span>0.0</span><span>))</span> <span>-</span> <span>r</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>star</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>r</span><span>,</span> <span>float</span> <span>points</span><span>,</span> <span>float</span> <span>ratio</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// next 4 lines can be precomputed for a given shape</span>
</span></span><span><span>    <span>float</span> <span>an</span> <span>=</span> <span>3.141593</span><span>/</span><span>points</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>en</span> <span>=</span> <span>3.141593</span><span>/</span><span>(</span><span>ratio</span><span>*</span><span>(</span><span>points</span><span>-</span><span>2.</span><span>)</span> <span>+</span> <span>2.</span><span>);</span> 
</span></span><span><span>    <span>vec2</span>  <span>acs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>an</span><span>),</span><span>sin</span><span>(</span><span>an</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>ecs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>en</span><span>),</span><span>sin</span><span>(</span><span>en</span><span>));</span> <span>// ecs=vec2(0,1) for regular polygon</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>bn</span> <span>=</span> <span>mod</span><span>(</span><span>atan</span><span>(</span><span>p</span><span>.</span><span>x</span><span>,</span><span>p</span><span>.</span><span>y</span><span>),</span><span>2.0</span><span>*</span><span>an</span><span>)</span> <span>-</span> <span>an</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>=</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>vec2</span><span>(</span><span>cos</span><span>(</span><span>bn</span><span>),</span><span>abs</span><span>(</span><span>sin</span><span>(</span><span>bn</span><span>)));</span>
</span></span><span><span>    <span>p</span> <span>-=</span> <span>r</span><span>*</span><span>acs</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>+=</span> <span>ecs</span><span>*</span><span>clamp</span><span>(</span> <span>-</span><span>dot</span><span>(</span><span>p</span><span>,</span><span>ecs</span><span>),</span> <span>0.0</span><span>,</span> <span>r</span><span>*</span><span>acs</span><span>.</span><span>y</span><span>/</span><span>ecs</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>p</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>float</span> <span>d</span><span>;</span>
</span></span><span><span>  
</span></span><span><span>    <span>// Mouth</span>
</span></span><span><span>    <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>pixel</span><span>,</span>  
</span></span><span><span>                 <span>vec2</span><span>(</span><span>-</span><span>.26</span><span>,</span> <span>-</span><span>.28</span><span>),</span> 
</span></span><span><span>                 <span>vec2</span><span>(</span><span>-</span><span>.05</span><span>,</span><span>-</span><span>.42</span><span>),</span> 
</span></span><span><span>                 <span>vec2</span><span>(</span><span>.115</span><span>,</span> <span>-</span><span>.25</span><span>));</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.11</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>// only draw the teeth and tongue inside hte mouth shape</span>
</span></span><span><span>        
</span></span><span><span>        <span>// Teeth</span>
</span></span><span><span>        <span>float</span> <span>width</span> <span>=</span> <span>.065</span><span>;</span>
</span></span><span><span>        <span>vec2</span> <span>teeth</span> <span>=</span> <span>pixel</span><span>;</span>
</span></span><span><span>        <span>teeth</span><span>.</span><span>x</span> <span>=</span> <span>mod</span><span>(</span><span>teeth</span><span>.</span><span>x</span><span>,</span> <span>width</span><span>)</span><span>-</span><span>width</span><span>*</span><span>.5</span><span>;</span>
</span></span><span><span>        <span>teeth</span><span>.</span><span>y</span> <span>-=</span> <span>pow</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.09</span><span>,</span> <span>2.</span><span>)</span> <span>*</span> <span>1.5</span> <span>-</span> <span>.34</span><span>;</span>
</span></span><span><span>        <span>teeth</span><span>.</span><span>y</span> <span>=</span> <span>abs</span><span>(</span><span>teeth</span><span>.</span><span>y</span><span>)</span><span>-</span><span>.06</span><span>;</span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>parabola</span><span>(</span><span>teeth</span><span>,</span> <span>38.</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span> <span>&amp;&amp;</span> <span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.06</span><span>)</span> <span>&lt;</span> <span>.194</span><span>)</span> 
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>0.902</span><span>,</span> <span>0.890</span><span>,</span> <span>0.729</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.01</span><span>);</span>
</span></span><span><span>      
</span></span><span><span>        <span>// Tongue</span>
</span></span><span><span>        <span>// Make the right side of the tongue thicker</span>
</span></span><span><span>        <span>float</span> <span>tongue_thickness</span> <span>=</span> <span>map</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>,</span> <span>-</span><span>.16</span><span>,</span> <span>.01</span><span>,</span> <span>.02</span><span>,</span> <span>.045</span><span>);</span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>pixel</span><span>,</span>  
</span></span><span><span>            <span>vec2</span><span>(</span><span>-</span><span>.16</span><span>,</span> <span>-</span><span>.35</span><span>),</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.001</span><span>,</span><span>-</span><span>.33</span><span>),</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.01</span><span>,</span> <span>-</span><span>.5</span><span>))</span> <span>-</span> <span>tongue_thickness</span><span>;</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0</span><span>)</span> 
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>0.816</span><span>,</span> <span>0.302</span><span>,</span> <span>0.275</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>0.01</span><span>);</span>
</span></span><span><span>          
</span></span><span><span>        <span>// mouth fill color</span>
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>.42</span><span>,</span> <span>.147</span><span>,</span> <span>.152</span><span>);</span> 
</span></span><span><span>    <span>}</span> 
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.12</span><span>)</span> <span>// mouth outline</span>
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span> 
</span></span><span><span>  
</span></span><span><span>    <span>// Eyebrow, Eyes, Nose &amp; Head</span>
</span></span><span><span>   <span>{</span> <span>// fold</span>
</span></span><span><span>        <span>// Pupils</span>
</span></span><span><span>        <span>vec2</span> <span>pupil_warp</span> <span>=</span> <span>pixel</span><span>;</span>
</span></span><span><span>        <span>pupil_warp</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pupil_warp</span><span>.</span><span>x</span> <span>+</span><span>.13</span><span>);</span>
</span></span><span><span>        <span>pupil_warp</span> <span>-=</span> <span>vec2</span><span>(</span><span>.16</span><span>,</span><span>.24</span><span>);</span>
</span></span><span><span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>star</span><span>(</span><span>pupil_warp</span><span>,</span> <span>0.019</span><span>,</span> <span>6.</span><span>,</span> <span>.9</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.007</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>.1</span><span>);</span>
</span></span><span><span>        <span>}</span>
</span></span><span><span>        
</span></span><span><span>        <span>// Eyeballs</span>
</span></span><span><span>        <span>vec2</span> <span>eye</span> <span>=</span> <span>vec2</span><span>(</span><span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.1</span><span>)</span><span>-</span><span>.17</span><span>,</span> <span>pixel</span><span>.</span><span>y</span><span>*</span><span>.93</span> <span>-</span> <span>.16</span><span>);</span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>length</span><span>(</span><span>eye</span><span>)</span> <span>-</span> <span>.16</span><span>;</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>step</span><span>(</span><span>0.013</span><span>,</span> <span>-</span><span>d</span><span>));</span>
</span></span><span><span>        <span>}</span>
</span></span><span><span>    
</span></span><span><span>        <span>// Nose  </span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>min</span><span>(</span>
</span></span><span><span>                <span>bezier</span><span>(</span><span>pixel</span><span>,</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.15</span><span>,</span> <span>-</span><span>.13</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.21</span><span>,</span><span>-</span><span>.14</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.14</span><span>,</span> <span>.08</span><span>)),</span>
</span></span><span><span>                <span>bezier</span><span>(</span><span>pixel</span><span>,</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.085</span><span>,</span> <span>-</span><span>.01</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.12</span><span>,</span> <span>-</span><span>.13</span><span>),</span>
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.15</span><span>,</span><span>-</span><span>.13</span><span>)));</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0055</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>
</span></span><span><span>
</span></span><span><span>        <span>// Eyebrow</span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>pixel</span><span>,</span>  
</span></span><span><span>                <span>vec2</span><span>(</span><span>-</span><span>.34</span><span>,</span> <span>.38</span><span>),</span> 
</span></span><span><span>                <span>vec2</span><span>(</span><span>-</span><span>.05</span><span>,</span> <span>.68</span><span>),</span> 
</span></span><span><span>                <span>vec2</span><span>(</span><span>.205</span><span>,</span> <span>.36</span><span>))</span> <span>-</span> <span>0.035</span><span>;</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0</span><span>)</span> 
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>.71</span><span>,</span> <span>.839</span><span>,</span> <span>.922</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.013</span><span>);</span>
</span></span><span><span>  
</span></span><span><span>        <span>d</span> <span>=</span> <span>min</span><span>(</span>
</span></span><span><span>            <span>// Head</span>
</span></span><span><span>            <span>round_rect</span><span>(</span>
</span></span><span><span>            <span>pixel</span><span>,</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.36</span><span>,</span> <span>.6385</span><span>),</span> 
</span></span><span><span>            <span>vec4</span><span>(</span><span>.34</span><span>,</span> <span>.415</span><span>,</span> <span>.363</span><span>,</span> <span>.315</span><span>)),</span>
</span></span><span><span>            
</span></span><span><span>            <span>// Ear</span>
</span></span><span><span>            <span>round_rect</span><span>(</span>
</span></span><span><span>            <span>pixel</span> <span>+</span> <span>vec2</span><span>(</span><span>-</span><span>.32</span><span>,</span> <span>.15</span><span>),</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.15</span><span>,</span> <span>0.12</span><span>),</span> 
</span></span><span><span>            <span>vec4</span><span>(</span><span>.13</span><span>,</span><span>.1</span><span>,</span><span>.13</span><span>,</span><span>.13</span><span>))</span>
</span></span><span><span>        <span>);</span>
</span></span><span><span>            
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>.838</span><span>,</span> <span>.799</span><span>,</span> <span>.76</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.01</span><span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>    
</span></span><span><span>    <span>// Hair</span>
</span></span><span><span>    <span>vec2</span> <span>hair</span> <span>=</span> <span>pixel</span><span>;</span>
</span></span><span><span>    <span>hair</span> <span>-=</span> <span>vec2</span><span>(</span><span>.08</span><span>,</span><span>.15</span><span>);</span>
</span></span><span><span>    <span>hair</span><span>.</span><span>x</span> <span>*=</span> <span>1.3</span><span>;</span>
</span></span><span><span>    <span>hair</span> <span>=</span> <span>warp</span><span>(</span><span>hair</span><span>,</span> <span>4.0</span><span>,</span> <span>0.07</span><span>);</span>
</span></span><span><span>    <span>d</span> <span>=</span> <span>star</span><span>(</span><span>hair</span><span>,</span> <span>0.95</span><span>,</span> <span>11.</span><span>,</span> <span>.28</span><span>);</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>0.682</span><span>,</span> <span>0.839</span><span>,</span> <span>0.929</span><span>)</span><span>*</span><span>step</span><span>(</span><span>0.012</span><span>,</span> <span>-</span><span>d</span><span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>    
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>1.</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><h2 id="artistic-lines">Artistic Lines</h2><p>The final bits needed are the curves below the eyes and around the mouth. Those lines are just like our normal shape outlines, except they’re offset away from the perimeter of the shape. This can be done by subtracting a little from distance when drawing the outline. In other words this:</p><p>Since Rick’s under-eye lines should only be visible…under the eye, we’ll need to limit where they are drawn. That can be done using whatever logic you can think of, as shown by the green line:</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>float</span> <span>round_rect</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>b</span><span>,</span> <span>vec4</span> <span>r</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>r</span><span>.</span><span>xy</span> <span>=</span> <span>(</span><span>p</span><span>.</span><span>x</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>r</span><span>.</span><span>xy</span> <span>:</span> <span>r</span><span>.</span><span>zw</span><span>;</span>
</span></span><span><span>    <span>r</span><span>.</span><span>x</span>  <span>=</span> <span>(</span><span>p</span><span>.</span><span>y</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>r</span><span>.</span><span>x</span>  <span>:</span> <span>r</span><span>.</span><span>y</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>q</span> <span>=</span> <span>abs</span><span>(</span><span>p</span><span>)</span><span>-</span><span>b</span><span>+</span><span>r</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>min</span><span>(</span><span>max</span><span>(</span><span>q</span><span>.</span><span>x</span><span>,</span><span>q</span><span>.</span><span>y</span><span>),</span><span>0.0</span><span>)</span> <span>+</span> <span>length</span><span>(</span><span>max</span><span>(</span><span>q</span><span>,</span><span>0.0</span><span>))</span> <span>-</span> <span>r</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>float</span> <span>dist</span> <span>=</span> <span>round_rect</span><span>(</span><span>pixel</span><span>,</span> <span>vec2</span><span>(</span><span>.5</span><span>),</span> <span>vec4</span><span>(</span><span>.1</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>thickness</span> <span>=</span> <span>.02</span><span>;</span>
</span></span><span><span>    
</span></span><span><span>    <span>// outline</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>abs</span><span>(</span><span>dist</span><span>)</span> <span>&lt;</span> <span>thickness</span><span>)</span> 
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span> 
</span></span><span><span>    
</span></span><span><span>    <span>// outset outline</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>abs</span><span>(</span><span>dist</span><span>-</span><span>.2</span><span>)</span> <span>&lt;</span> <span>thickness</span><span>)</span> 
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>.1</span><span>,</span><span>.1</span><span>,</span><span>1</span><span>);</span> 
</span></span><span><span>    
</span></span><span><span>    <span>// limited outline</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>abs</span><span>(</span><span>dist</span><span>-</span><span>.4</span><span>)</span> <span>&lt;</span> <span>thickness</span> <span>&amp;&amp;</span> <span>pixel</span><span>.</span><span>y</span> <span>&lt;</span> <span>-</span><span>.4</span><span>)</span> 
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>.1</span><span>,</span><span>.9</span><span>,</span><span>.1</span><span>);</span> 
</span></span><span><span>    
</span></span><span><span>    <span>// fill</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>dist</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>1</span><span>);</span> 
</span></span><span><span>    
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>.92</span><span>);</span>    
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Here are those techniques applied to Rick:</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>float</span> <span>map</span><span>(</span><span>float</span> <span>value</span><span>,</span> <span>float</span> <span>inMin</span><span>,</span> <span>float</span> <span>inMax</span><span>,</span> <span>float</span> <span>outMin</span><span>,</span> <span>float</span> <span>outMax</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>  <span>value</span> <span>=</span> <span>clamp</span><span>(</span><span>value</span><span>,</span> <span>inMin</span><span>,</span> <span>inMax</span><span>);</span>
</span></span><span><span>  <span>return</span> <span>outMin</span> <span>+</span> <span>(</span><span>outMax</span> <span>-</span> <span>outMin</span><span>)</span> <span>*</span> <span>(</span><span>value</span> <span>-</span> <span>inMin</span><span>)</span> <span>/</span> <span>(</span><span>inMax</span> <span>-</span> <span>inMin</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>vec2</span> <span>grad</span><span>(</span><span>ivec2</span> <span>z</span><span>)</span>  <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>int</span> <span>n</span> <span>=</span> <span>z</span><span>.</span><span>x</span><span>+</span><span>z</span><span>.</span><span>y</span><span>*</span><span>11111</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>=</span> <span>(</span><span>n</span><span>&lt;&lt;</span><span>13</span><span>)</span><span>^</span><span>n</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>=</span> <span>(</span><span>n</span><span>*</span><span>(</span><span>n</span><span>*</span><span>n</span><span>*</span><span>15731</span><span>+</span><span>789221</span><span>)</span><span>+</span><span>1376312589</span><span>)</span><span>&gt;&gt;</span><span>16</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>&amp;=</span> <span>7</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>gr</span> <span>=</span> <span>vec2</span><span>(</span><span>n</span><span>&amp;</span><span>1</span><span>,</span><span>n</span><span>&gt;&gt;</span><span>1</span><span>)</span><span>*</span><span>2.0</span><span>-</span><span>1.0</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>(</span> <span>n</span><span>&gt;=</span><span>6</span> <span>)</span> <span>?</span> <span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>gr</span><span>.</span><span>x</span><span>)</span> <span>:</span> 
</span></span><span><span>           <span>(</span> <span>n</span><span>&gt;=</span><span>4</span> <span>)</span> <span>?</span> <span>vec2</span><span>(</span><span>gr</span><span>.</span><span>x</span><span>,</span><span>0.0</span><span>)</span> <span>:</span>
</span></span><span><span>                              <span>gr</span><span>;</span>                            
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>noise</span><span>(</span><span>vec2</span> <span>p</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>ivec2</span> <span>i</span> <span>=</span> <span>ivec2</span><span>(</span><span>floor</span><span>(</span><span>p</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>f</span> <span>=</span>       <span>fract</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>vec2</span> <span>u</span> <span>=</span> <span>f</span><span>*</span><span>f</span><span>*</span><span>(</span><span>3.0</span><span>-</span><span>2.0</span><span>*</span><span>f</span><span>);</span> 
</span></span><span><span>    <span>return</span> <span>mix</span><span>(</span> <span>mix</span><span>(</span> <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>0</span><span>,</span><span>0</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>0.0</span><span>)</span> <span>),</span> 
</span></span><span><span>                     <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>1</span><span>,</span><span>0</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>1.0</span><span>,</span><span>0.0</span><span>)</span> <span>),</span> <span>u</span><span>.</span><span>x</span><span>),</span>
</span></span><span><span>                <span>mix</span><span>(</span> <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>0</span><span>,</span><span>1</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>1.0</span><span>)</span> <span>),</span> 
</span></span><span><span>                     <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>1</span><span>,</span><span>1</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>1.0</span><span>,</span><span>1.0</span><span>)</span> <span>),</span> <span>u</span><span>.</span><span>x</span><span>),</span> <span>u</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>vec2</span> <span>warp</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>scale</span><span>,</span> <span>float</span> <span>strength</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>float</span> <span>offsetX</span> <span>=</span> <span>noise</span><span>(</span><span>p</span> <span>*</span> <span>scale</span> <span>+</span> <span>vec2</span><span>(</span><span>0.0</span><span>,</span> <span>100.0</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>offsetY</span> <span>=</span> <span>noise</span><span>(</span><span>p</span> <span>*</span> <span>scale</span> <span>+</span> <span>vec2</span><span>(</span><span>100.0</span><span>,</span> <span>0.0</span><span>));</span>
</span></span><span><span>    <span>return</span> <span>p</span> <span>+</span> <span>vec2</span><span>(</span><span>offsetX</span><span>,</span> <span>offsetY</span><span>)</span> <span>*</span> <span>strength</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>bezier</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>v0</span><span>,</span> <span>vec2</span> <span>v1</span><span>,</span> <span>vec2</span> <span>v2</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>vec2</span> <span>i</span> <span>=</span> <span>v0</span> <span>-</span> <span>v2</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>j</span> <span>=</span> <span>v2</span> <span>-</span> <span>v1</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>k</span> <span>=</span> <span>v1</span> <span>-</span> <span>v0</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>w</span> <span>=</span> <span>j</span><span>-</span><span>k</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>v0</span><span>-=</span> <span>p</span><span>;</span> <span>v1</span><span>-=</span> <span>p</span><span>;</span> <span>v2</span><span>-=</span> <span>p</span><span>;</span>
</span></span><span><span>    
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>v0</span><span>.</span><span>x</span><span>*</span><span>v2</span><span>.</span><span>y</span><span>-</span><span>v0</span><span>.</span><span>y</span><span>*</span><span>v2</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>y</span> <span>=</span> <span>v1</span><span>.</span><span>x</span><span>*</span><span>v0</span><span>.</span><span>y</span><span>-</span><span>v1</span><span>.</span><span>y</span><span>*</span><span>v0</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>z</span> <span>=</span> <span>v2</span><span>.</span><span>x</span><span>*</span><span>v1</span><span>.</span><span>y</span><span>-</span><span>v2</span><span>.</span><span>y</span><span>*</span><span>v1</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>vec2</span> <span>s</span> <span>=</span> <span>2.0</span><span>*</span><span>(</span><span>y</span><span>*</span><span>j</span><span>+</span><span>z</span><span>*</span><span>k</span><span>)</span><span>-</span><span>x</span><span>*</span><span>i</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span>  <span>(</span><span>y</span><span>*</span><span>z</span><span>-</span><span>x</span><span>*</span><span>x</span><span>*</span><span>0.25</span><span>)</span><span>/</span><span>dot</span><span>(</span><span>s</span><span>,</span><span>s</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>t</span> <span>=</span> <span>clamp</span><span>(</span> <span>(</span><span>0.5</span><span>*</span><span>x</span><span>+</span><span>y</span><span>+</span><span>r</span><span>*</span><span>dot</span><span>(</span><span>s</span><span>,</span><span>w</span><span>))</span><span>/</span><span>(</span><span>x</span><span>+</span><span>y</span><span>+</span><span>z</span><span>),</span><span>0.0</span><span>,</span><span>1.0</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>vec2</span> <span>d</span> <span>=</span> <span>v0</span><span>+</span><span>t</span><span>*</span><span>(</span><span>k</span><span>+</span><span>k</span><span>+</span><span>t</span><span>*</span><span>w</span><span>);</span>
</span></span><span><span>    <span>vec2</span> <span>outQ</span> <span>=</span> <span>d</span> <span>+</span> <span>p</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>d</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>parabola</span><span>(</span><span>vec2</span> <span>pos</span><span>,</span> <span>float</span> <span>k</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// from https://www.shadertoy.com/view/ws3GD7</span>
</span></span><span><span>    <span>pos</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>ik</span> <span>=</span> <span>1.0</span><span>/</span><span>k</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>p</span> <span>=</span> <span>ik</span><span>*</span><span>(</span><span>pos</span><span>.</span><span>y</span> <span>-</span> <span>0.5</span><span>*</span><span>ik</span><span>)</span><span>/</span><span>3.0</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>q</span> <span>=</span> <span>0.25</span><span>*</span><span>ik</span><span>*</span><span>ik</span><span>*</span><span>pos</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>h</span> <span>=</span> <span>q</span><span>*</span><span>q</span> <span>-</span> <span>p</span><span>*</span><span>p</span><span>*</span><span>p</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span> <span>sqrt</span><span>(</span><span>abs</span><span>(</span><span>h</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>(</span><span>h</span><span>&gt;</span><span>0.0</span><span>)</span> <span>?</span> 
</span></span><span><span>        <span>pow</span><span>(</span><span>q</span><span>+</span><span>r</span><span>,</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span> <span>-</span> <span>pow</span><span>(</span><span>abs</span><span>(</span><span>q</span><span>-</span><span>r</span><span>),</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>r</span><span>-</span><span>q</span><span>)</span> <span>:</span>
</span></span><span><span>        <span>2.0</span><span>*</span><span>cos</span><span>(</span><span>atan</span><span>(</span><span>r</span><span>,</span><span>q</span><span>)</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sqrt</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>pos</span><span>-</span><span>vec2</span><span>(</span><span>x</span><span>,</span><span>k</span><span>*</span><span>x</span><span>*</span><span>x</span><span>))</span> <span>*</span> <span>sign</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>-</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>round_rect</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>b</span><span>,</span> <span>vec4</span> <span>r</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>r</span><span>.</span><span>xy</span> <span>=</span> <span>(</span><span>p</span><span>.</span><span>x</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>r</span><span>.</span><span>xy</span> <span>:</span> <span>r</span><span>.</span><span>zw</span><span>;</span>
</span></span><span><span>    <span>r</span><span>.</span><span>x</span>  <span>=</span> <span>(</span><span>p</span><span>.</span><span>y</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>r</span><span>.</span><span>x</span>  <span>:</span> <span>r</span><span>.</span><span>y</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>q</span> <span>=</span> <span>abs</span><span>(</span><span>p</span><span>)</span><span>-</span><span>b</span><span>+</span><span>r</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>min</span><span>(</span><span>max</span><span>(</span><span>q</span><span>.</span><span>x</span><span>,</span><span>q</span><span>.</span><span>y</span><span>),</span><span>0.0</span><span>)</span> <span>+</span> <span>length</span><span>(</span><span>max</span><span>(</span><span>q</span><span>,</span><span>0.0</span><span>))</span> <span>-</span> <span>r</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>star</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>r</span><span>,</span> <span>float</span> <span>points</span><span>,</span> <span>float</span> <span>ratio</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// next 4 lines can be precomputed for a given shape</span>
</span></span><span><span>    <span>float</span> <span>an</span> <span>=</span> <span>3.141593</span><span>/</span><span>points</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>en</span> <span>=</span> <span>3.141593</span><span>/</span><span>(</span><span>ratio</span><span>*</span><span>(</span><span>points</span><span>-</span><span>2.</span><span>)</span> <span>+</span> <span>2.</span><span>);</span> 
</span></span><span><span>    <span>vec2</span>  <span>acs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>an</span><span>),</span><span>sin</span><span>(</span><span>an</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>ecs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>en</span><span>),</span><span>sin</span><span>(</span><span>en</span><span>));</span> <span>// ecs=vec2(0,1) for regular polygon</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>bn</span> <span>=</span> <span>mod</span><span>(</span><span>atan</span><span>(</span><span>p</span><span>.</span><span>x</span><span>,</span><span>p</span><span>.</span><span>y</span><span>),</span><span>2.0</span><span>*</span><span>an</span><span>)</span> <span>-</span> <span>an</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>=</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>vec2</span><span>(</span><span>cos</span><span>(</span><span>bn</span><span>),</span><span>abs</span><span>(</span><span>sin</span><span>(</span><span>bn</span><span>)));</span>
</span></span><span><span>    <span>p</span> <span>-=</span> <span>r</span><span>*</span><span>acs</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>+=</span> <span>ecs</span><span>*</span><span>clamp</span><span>(</span> <span>-</span><span>dot</span><span>(</span><span>p</span><span>,</span><span>ecs</span><span>),</span> <span>0.0</span><span>,</span> <span>r</span><span>*</span><span>acs</span><span>.</span><span>y</span><span>/</span><span>ecs</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>p</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>  
</span></span><span><span>    <span>// Mouth</span>
</span></span><span><span>    <span>float</span> <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>pixel</span><span>,</span>  
</span></span><span><span>                 <span>vec2</span><span>(</span><span>-</span><span>.26</span><span>,</span> <span>-</span><span>.28</span><span>),</span> 
</span></span><span><span>                 <span>vec2</span><span>(</span><span>-</span><span>.05</span><span>,</span><span>-</span><span>.42</span><span>),</span> 
</span></span><span><span>                 <span>vec2</span><span>(</span><span>.115</span><span>,</span> <span>-</span><span>.25</span><span>));</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.11</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>        <span>// Teeth</span>
</span></span><span><span>        <span>float</span> <span>width</span> <span>=</span> <span>.065</span><span>;</span>
</span></span><span><span>        <span>vec2</span> <span>teeth</span> <span>=</span> <span>pixel</span><span>;</span>
</span></span><span><span>        <span>teeth</span><span>.</span><span>x</span> <span>=</span> <span>mod</span><span>(</span><span>teeth</span><span>.</span><span>x</span><span>,</span> <span>width</span><span>)</span><span>-</span><span>width</span><span>*</span><span>.5</span><span>;</span>
</span></span><span><span>        <span>teeth</span><span>.</span><span>y</span> <span>-=</span> <span>pow</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.09</span><span>,</span> <span>2.</span><span>)</span> <span>*</span> <span>1.5</span> <span>-</span> <span>.34</span><span>;</span>
</span></span><span><span>        <span>teeth</span><span>.</span><span>y</span> <span>=</span> <span>abs</span><span>(</span><span>teeth</span><span>.</span><span>y</span><span>)</span><span>-</span><span>.06</span><span>;</span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>parabola</span><span>(</span><span>teeth</span><span>,</span> <span>38.</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span> <span>&amp;&amp;</span> <span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.06</span><span>)</span> <span>&lt;</span> <span>.194</span><span>)</span> 
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>0.902</span><span>,</span> <span>0.890</span><span>,</span> <span>0.729</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.01</span><span>);</span>
</span></span><span><span>      
</span></span><span><span>        <span>// Tongue</span>
</span></span><span><span>        <span>// Make the right side of the tongue thicker</span>
</span></span><span><span>        <span>float</span> <span>tongue_thickness</span> <span>=</span> <span>map</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>,</span> <span>-</span><span>.16</span><span>,</span> <span>.01</span><span>,</span> <span>.02</span><span>,</span> <span>.045</span><span>);</span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>pixel</span><span>,</span>  
</span></span><span><span>            <span>vec2</span><span>(</span><span>-</span><span>.16</span><span>,</span> <span>-</span><span>.35</span><span>),</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.001</span><span>,</span><span>-</span><span>.33</span><span>),</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.01</span><span>,</span> <span>-</span><span>.5</span><span>))</span> <span>-</span> <span>tongue_thickness</span><span>;</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0</span><span>)</span> 
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>0.816</span><span>,</span> <span>0.302</span><span>,</span> <span>0.275</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>0.01</span><span>);</span>
</span></span><span><span>          
</span></span><span><span>        <span>// mouth fill color</span>
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>.42</span><span>,</span> <span>.147</span><span>,</span> <span>.152</span><span>);</span> 
</span></span><span><span>    <span>}</span> 
</span></span><span><span>    
</span></span><span><span>    <span>// lip outlines</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.12</span> <span>||</span> <span>(</span><span>abs</span><span>(</span><span>d</span><span>-</span><span>.16</span><span>)</span> <span>&lt;</span> <span>.005</span> 
</span></span><span><span>                    <span>&amp;&amp;</span> <span>(</span><span>pixel</span><span>.</span><span>x</span><span>*-</span><span>6.4</span> <span>&gt;</span> <span>-</span><span>pixel</span><span>.</span><span>y</span><span>+</span><span>1.6</span> 
</span></span><span><span>                      <span>||</span> <span>pixel</span><span>.</span><span>x</span><span>*</span><span>1.7</span> <span>&gt;</span> <span>-</span><span>pixel</span><span>.</span><span>y</span><span>+</span><span>.1</span> 
</span></span><span><span>                      <span>||</span> <span>pixel</span><span>.</span><span>y</span> <span>&lt;</span> <span>-</span><span>0.49</span><span>)))</span> 
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span> 
</span></span><span><span>    
</span></span><span><span>    <span>// lips</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.16</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>.838</span><span>,</span> <span>.799</span><span>,</span> <span>0.76</span><span>);</span>
</span></span><span><span>   
</span></span><span><span>    <span>// Pupils</span>
</span></span><span><span>    <span>{</span> <span>// fold</span>
</span></span><span><span>        <span>vec2</span> <span>pupil_warp</span> <span>=</span> <span>pixel</span><span>;</span>
</span></span><span><span>        <span>pupil_warp</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pupil_warp</span><span>.</span><span>x</span> <span>+</span><span>.13</span><span>);</span>
</span></span><span><span>        <span>pupil_warp</span> <span>-=</span> <span>vec2</span><span>(</span><span>.16</span><span>,</span><span>.24</span><span>);</span>
</span></span><span><span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>star</span><span>(</span><span>pupil_warp</span><span>,</span> <span>0.019</span><span>,</span> <span>6.</span><span>,</span> <span>.9</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.007</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>.1</span><span>);</span>
</span></span><span><span>        <span>}</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>        
</span></span><span><span>    <span>// Eyeballs</span>
</span></span><span><span>    <span>vec2</span> <span>eye</span> <span>=</span> <span>vec2</span><span>(</span><span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.1</span><span>)</span><span>-</span><span>.17</span><span>,</span> <span>pixel</span><span>.</span><span>y</span><span>*</span><span>.93</span> <span>-</span> <span>.16</span><span>);</span>
</span></span><span><span>    <span>d</span> <span>=</span> <span>length</span><span>(</span><span>eye</span><span>)</span> <span>-</span> <span>.16</span><span>;</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>step</span><span>(</span><span>.013</span><span>,</span> <span>-</span><span>d</span><span>));</span>
</span></span><span><span>    
</span></span><span><span>    <span>// under eye lines</span>
</span></span><span><span>    <span>bool</span> <span>should_show</span> <span>=</span> <span>pixel</span><span>.</span><span>y</span> <span>&lt;</span> <span>0.25</span> <span>&amp;&amp;</span> 
</span></span><span><span>        <span>(</span><span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.29</span><span>)</span> <span>&lt;</span> <span>.05</span> <span>||</span> 
</span></span><span><span>        <span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>-</span><span>.12</span><span>)</span> <span>&lt;</span> <span>.085</span><span>);</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>abs</span><span>(</span><span>d</span> <span>-</span> <span>.04</span><span>)</span> <span>&lt;</span> <span>.0055</span> <span>&amp;&amp;</span> <span>should_show</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>// Nose, Eyebrow, Head, Hair</span>
</span></span><span><span>    <span>{</span> <span>// fold</span>
</span></span><span><span>        <span>// Nose  </span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>min</span><span>(</span>
</span></span><span><span>                <span>bezier</span><span>(</span><span>pixel</span><span>,</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.15</span><span>,</span> <span>-</span><span>.13</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.21</span><span>,</span><span>-</span><span>.14</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.14</span><span>,</span> <span>.08</span><span>)),</span>
</span></span><span><span>                <span>bezier</span><span>(</span><span>pixel</span><span>,</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.085</span><span>,</span> <span>-</span><span>.01</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.12</span><span>,</span> <span>-</span><span>.13</span><span>),</span>
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.15</span><span>,</span><span>-</span><span>.13</span><span>)));</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0055</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>
</span></span><span><span>
</span></span><span><span>        <span>// Eyebrow</span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>pixel</span><span>,</span>  
</span></span><span><span>                <span>vec2</span><span>(</span><span>-</span><span>.34</span><span>,</span> <span>.38</span><span>),</span> 
</span></span><span><span>                <span>vec2</span><span>(</span><span>-</span><span>.05</span><span>,</span> <span>.68</span><span>),</span> 
</span></span><span><span>                <span>vec2</span><span>(</span><span>.205</span><span>,</span> <span>.36</span><span>))</span> <span>-</span> <span>0.035</span><span>;</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0</span><span>)</span> 
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>.71</span><span>,</span> <span>.839</span><span>,</span> <span>.922</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.013</span><span>);</span>
</span></span><span><span>  
</span></span><span><span>        <span>d</span> <span>=</span> <span>min</span><span>(</span>
</span></span><span><span>            <span>// Head</span>
</span></span><span><span>            <span>round_rect</span><span>(</span>
</span></span><span><span>            <span>pixel</span><span>,</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.36</span><span>,</span> <span>.6385</span><span>),</span> 
</span></span><span><span>            <span>vec4</span><span>(</span><span>.34</span><span>,</span> <span>.415</span><span>,</span> <span>.363</span><span>,</span> <span>.315</span><span>)),</span>
</span></span><span><span>            
</span></span><span><span>            <span>// Ear</span>
</span></span><span><span>            <span>round_rect</span><span>(</span>
</span></span><span><span>            <span>pixel</span> <span>+</span> <span>vec2</span><span>(</span><span>-</span><span>.32</span><span>,</span> <span>.15</span><span>),</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.15</span><span>,</span> <span>0.12</span><span>),</span> 
</span></span><span><span>            <span>vec4</span><span>(</span><span>.13</span><span>,</span><span>.1</span><span>,</span><span>.13</span><span>,</span><span>.13</span><span>))</span>
</span></span><span><span>        <span>);</span>
</span></span><span><span>            
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>.838</span><span>,</span> <span>.799</span><span>,</span> <span>.76</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.01</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>        <span>// Hair</span>
</span></span><span><span>        <span>vec2</span> <span>hair</span> <span>=</span> <span>pixel</span><span>;</span>
</span></span><span><span>        <span>hair</span> <span>-=</span> <span>vec2</span><span>(</span><span>.08</span><span>,</span><span>.15</span><span>);</span>
</span></span><span><span>        <span>hair</span><span>.</span><span>x</span> <span>*=</span> <span>1.3</span><span>;</span>
</span></span><span><span>        <span>hair</span> <span>=</span> <span>warp</span><span>(</span><span>hair</span><span>,</span> <span>4.0</span><span>,</span> <span>0.07</span><span>);</span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>star</span><span>(</span><span>hair</span><span>,</span> <span>0.95</span><span>,</span> <span>11.</span><span>,</span> <span>.28</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>0.682</span><span>,</span> <span>0.839</span><span>,</span> <span>0.929</span><span>)</span><span>*</span><span>step</span><span>(</span><span>0.012</span><span>,</span> <span>-</span><span>d</span><span>);</span>
</span></span><span><span>        <span>}</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>    
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>1</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Draw another character from Rick and Morty, or whatever your favorite cartoon is.</p><p>Use <a href="https://www.youtube.com/results?search_query=raymarching" target="_blank" rel="noopener">raymarching</a> with 3D signed distance fields to draw a 3D version of Rick. Let me know if you do this, I want to see.</p><h2 id="animation">Animation</h2><p>With our drawing complete, there are several animation techniques we can use to introduce movement. First up:</p><h3 id="1-looping-values">1. Looping Values</h3><p>The easiest way to add animation is to slap a <code>sin(time)</code> into the code somewhere. The <code>sin</code> is important because it wraps the ever-increasing <code>time</code> value into the range of -1 to 1, which makes nice looping animations. You will often change that range with a scale and offset like so: <code>sin(time)*.5 + .5</code>. The head angle, tongue angle, and eyebrow height are animated in this way. I added a <code>rotateAt</code> function to do the rotation math.</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>vec2</span> <span>rotateAt</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>angle</span><span>,</span> <span>vec2</span> <span>origin</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>float</span> <span>s</span> <span>=</span> <span>sin</span><span>(</span><span>angle</span><span>),</span> <span>c</span> <span>=</span> <span>cos</span><span>(</span><span>angle</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>(</span><span>p</span><span>-</span><span>origin</span><span>)</span><span>*</span><span>mat2</span><span>(</span> <span>c</span><span>,</span> <span>-</span><span>s</span><span>,</span> <span>s</span><span>,</span> <span>c</span> <span>)</span> <span>+</span> <span>origin</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>float</span> <span>map</span><span>(</span><span>float</span> <span>value</span><span>,</span> <span>float</span> <span>inMin</span><span>,</span> <span>float</span> <span>inMax</span><span>,</span> <span>float</span> <span>outMin</span><span>,</span> <span>float</span> <span>outMax</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>  <span>value</span> <span>=</span> <span>clamp</span><span>(</span><span>value</span><span>,</span> <span>inMin</span><span>,</span> <span>inMax</span><span>);</span>
</span></span><span><span>  <span>return</span> <span>outMin</span> <span>+</span> <span>(</span><span>outMax</span> <span>-</span> <span>outMin</span><span>)</span> <span>*</span> <span>(</span><span>value</span> <span>-</span> <span>inMin</span><span>)</span> <span>/</span> <span>(</span><span>inMax</span> <span>-</span> <span>inMin</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>vec2</span> <span>grad</span><span>(</span><span>ivec2</span> <span>z</span><span>)</span>  <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>int</span> <span>n</span> <span>=</span> <span>z</span><span>.</span><span>x</span><span>+</span><span>z</span><span>.</span><span>y</span><span>*</span><span>11111</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>=</span> <span>(</span><span>n</span><span>&lt;&lt;</span><span>13</span><span>)</span><span>^</span><span>n</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>=</span> <span>(</span><span>n</span><span>*</span><span>(</span><span>n</span><span>*</span><span>n</span><span>*</span><span>15731</span><span>+</span><span>789221</span><span>)</span><span>+</span><span>1376312589</span><span>)</span><span>&gt;&gt;</span><span>16</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>&amp;=</span> <span>7</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>gr</span> <span>=</span> <span>vec2</span><span>(</span><span>n</span><span>&amp;</span><span>1</span><span>,</span><span>n</span><span>&gt;&gt;</span><span>1</span><span>)</span><span>*</span><span>2.0</span><span>-</span><span>1.0</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>(</span> <span>n</span><span>&gt;=</span><span>6</span> <span>)</span> <span>?</span> <span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>gr</span><span>.</span><span>x</span><span>)</span> <span>:</span> 
</span></span><span><span>           <span>(</span> <span>n</span><span>&gt;=</span><span>4</span> <span>)</span> <span>?</span> <span>vec2</span><span>(</span><span>gr</span><span>.</span><span>x</span><span>,</span><span>0.0</span><span>)</span> <span>:</span>
</span></span><span><span>                              <span>gr</span><span>;</span>                            
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>noise</span><span>(</span><span>vec2</span> <span>p</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>ivec2</span> <span>i</span> <span>=</span> <span>ivec2</span><span>(</span><span>floor</span><span>(</span><span>p</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>f</span> <span>=</span>       <span>fract</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>vec2</span> <span>u</span> <span>=</span> <span>f</span><span>*</span><span>f</span><span>*</span><span>(</span><span>3.0</span><span>-</span><span>2.0</span><span>*</span><span>f</span><span>);</span> 
</span></span><span><span>    <span>return</span> <span>mix</span><span>(</span> <span>mix</span><span>(</span> <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>0</span><span>,</span><span>0</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>0.0</span><span>)</span> <span>),</span> 
</span></span><span><span>                     <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>1</span><span>,</span><span>0</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>1.0</span><span>,</span><span>0.0</span><span>)</span> <span>),</span> <span>u</span><span>.</span><span>x</span><span>),</span>
</span></span><span><span>                <span>mix</span><span>(</span> <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>0</span><span>,</span><span>1</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>1.0</span><span>)</span> <span>),</span> 
</span></span><span><span>                     <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>1</span><span>,</span><span>1</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>1.0</span><span>,</span><span>1.0</span><span>)</span> <span>),</span> <span>u</span><span>.</span><span>x</span><span>),</span> <span>u</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>vec2</span> <span>warp</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>scale</span><span>,</span> <span>float</span> <span>strength</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>float</span> <span>offsetX</span> <span>=</span> <span>noise</span><span>(</span><span>p</span> <span>*</span> <span>scale</span> <span>+</span> <span>vec2</span><span>(</span><span>0.0</span><span>,</span> <span>100.0</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>offsetY</span> <span>=</span> <span>noise</span><span>(</span><span>p</span> <span>*</span> <span>scale</span> <span>+</span> <span>vec2</span><span>(</span><span>100.0</span><span>,</span> <span>0.0</span><span>));</span>
</span></span><span><span>    <span>return</span> <span>p</span> <span>+</span> <span>vec2</span><span>(</span><span>offsetX</span><span>,</span> <span>offsetY</span><span>)</span> <span>*</span> <span>strength</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>bezier</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>v0</span><span>,</span> <span>vec2</span> <span>v1</span><span>,</span> <span>vec2</span> <span>v2</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>vec2</span> <span>i</span> <span>=</span> <span>v0</span> <span>-</span> <span>v2</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>j</span> <span>=</span> <span>v2</span> <span>-</span> <span>v1</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>k</span> <span>=</span> <span>v1</span> <span>-</span> <span>v0</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>w</span> <span>=</span> <span>j</span><span>-</span><span>k</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>v0</span><span>-=</span> <span>p</span><span>;</span> <span>v1</span><span>-=</span> <span>p</span><span>;</span> <span>v2</span><span>-=</span> <span>p</span><span>;</span>
</span></span><span><span>    
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>v0</span><span>.</span><span>x</span><span>*</span><span>v2</span><span>.</span><span>y</span><span>-</span><span>v0</span><span>.</span><span>y</span><span>*</span><span>v2</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>y</span> <span>=</span> <span>v1</span><span>.</span><span>x</span><span>*</span><span>v0</span><span>.</span><span>y</span><span>-</span><span>v1</span><span>.</span><span>y</span><span>*</span><span>v0</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>z</span> <span>=</span> <span>v2</span><span>.</span><span>x</span><span>*</span><span>v1</span><span>.</span><span>y</span><span>-</span><span>v2</span><span>.</span><span>y</span><span>*</span><span>v1</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>vec2</span> <span>s</span> <span>=</span> <span>2.0</span><span>*</span><span>(</span><span>y</span><span>*</span><span>j</span><span>+</span><span>z</span><span>*</span><span>k</span><span>)</span><span>-</span><span>x</span><span>*</span><span>i</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span>  <span>(</span><span>y</span><span>*</span><span>z</span><span>-</span><span>x</span><span>*</span><span>x</span><span>*</span><span>0.25</span><span>)</span><span>/</span><span>dot</span><span>(</span><span>s</span><span>,</span><span>s</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>t</span> <span>=</span> <span>clamp</span><span>(</span> <span>(</span><span>0.5</span><span>*</span><span>x</span><span>+</span><span>y</span><span>+</span><span>r</span><span>*</span><span>dot</span><span>(</span><span>s</span><span>,</span><span>w</span><span>))</span><span>/</span><span>(</span><span>x</span><span>+</span><span>y</span><span>+</span><span>z</span><span>),</span><span>0.0</span><span>,</span><span>1.0</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>vec2</span> <span>d</span> <span>=</span> <span>v0</span><span>+</span><span>t</span><span>*</span><span>(</span><span>k</span><span>+</span><span>k</span><span>+</span><span>t</span><span>*</span><span>w</span><span>);</span>
</span></span><span><span>    <span>vec2</span> <span>outQ</span> <span>=</span> <span>d</span> <span>+</span> <span>p</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>d</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>parabola</span><span>(</span><span>vec2</span> <span>pos</span><span>,</span> <span>float</span> <span>k</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// from https://www.shadertoy.com/view/ws3GD7</span>
</span></span><span><span>    <span>pos</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>ik</span> <span>=</span> <span>1.0</span><span>/</span><span>k</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>p</span> <span>=</span> <span>ik</span><span>*</span><span>(</span><span>pos</span><span>.</span><span>y</span> <span>-</span> <span>0.5</span><span>*</span><span>ik</span><span>)</span><span>/</span><span>3.0</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>q</span> <span>=</span> <span>0.25</span><span>*</span><span>ik</span><span>*</span><span>ik</span><span>*</span><span>pos</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>h</span> <span>=</span> <span>q</span><span>*</span><span>q</span> <span>-</span> <span>p</span><span>*</span><span>p</span><span>*</span><span>p</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span> <span>sqrt</span><span>(</span><span>abs</span><span>(</span><span>h</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>(</span><span>h</span><span>&gt;</span><span>0.0</span><span>)</span> <span>?</span> 
</span></span><span><span>        <span>pow</span><span>(</span><span>q</span><span>+</span><span>r</span><span>,</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span> <span>-</span> <span>pow</span><span>(</span><span>abs</span><span>(</span><span>q</span><span>-</span><span>r</span><span>),</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>r</span><span>-</span><span>q</span><span>)</span> <span>:</span>
</span></span><span><span>        <span>2.0</span><span>*</span><span>cos</span><span>(</span><span>atan</span><span>(</span><span>r</span><span>,</span><span>q</span><span>)</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sqrt</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>pos</span><span>-</span><span>vec2</span><span>(</span><span>x</span><span>,</span><span>k</span><span>*</span><span>x</span><span>*</span><span>x</span><span>))</span> <span>*</span> <span>sign</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>-</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>round_rect</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>b</span><span>,</span> <span>vec4</span> <span>r</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>r</span><span>.</span><span>xy</span> <span>=</span> <span>(</span><span>p</span><span>.</span><span>x</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>r</span><span>.</span><span>xy</span> <span>:</span> <span>r</span><span>.</span><span>zw</span><span>;</span>
</span></span><span><span>    <span>r</span><span>.</span><span>x</span>  <span>=</span> <span>(</span><span>p</span><span>.</span><span>y</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>r</span><span>.</span><span>x</span>  <span>:</span> <span>r</span><span>.</span><span>y</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>q</span> <span>=</span> <span>abs</span><span>(</span><span>p</span><span>)</span><span>-</span><span>b</span><span>+</span><span>r</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>min</span><span>(</span><span>max</span><span>(</span><span>q</span><span>.</span><span>x</span><span>,</span><span>q</span><span>.</span><span>y</span><span>),</span><span>0.0</span><span>)</span> <span>+</span> <span>length</span><span>(</span><span>max</span><span>(</span><span>q</span><span>,</span><span>0.0</span><span>))</span> <span>-</span> <span>r</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>star</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>r</span><span>,</span> <span>float</span> <span>points</span><span>,</span> <span>float</span> <span>ratio</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// next 4 lines can be precomputed for a given shape</span>
</span></span><span><span>    <span>float</span> <span>an</span> <span>=</span> <span>3.141593</span><span>/</span><span>points</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>en</span> <span>=</span> <span>3.141593</span><span>/</span><span>(</span><span>ratio</span><span>*</span><span>(</span><span>points</span><span>-</span><span>2.</span><span>)</span> <span>+</span> <span>2.</span><span>);</span> 
</span></span><span><span>    <span>vec2</span>  <span>acs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>an</span><span>),</span><span>sin</span><span>(</span><span>an</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>ecs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>en</span><span>),</span><span>sin</span><span>(</span><span>en</span><span>));</span> <span>// ecs=vec2(0,1) for regular polygon</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>bn</span> <span>=</span> <span>mod</span><span>(</span><span>atan</span><span>(</span><span>p</span><span>.</span><span>x</span><span>,</span><span>p</span><span>.</span><span>y</span><span>),</span><span>2.0</span><span>*</span><span>an</span><span>)</span> <span>-</span> <span>an</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>=</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>vec2</span><span>(</span><span>cos</span><span>(</span><span>bn</span><span>),</span><span>abs</span><span>(</span><span>sin</span><span>(</span><span>bn</span><span>)));</span>
</span></span><span><span>    <span>p</span> <span>-=</span> <span>r</span><span>*</span><span>acs</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>+=</span> <span>ecs</span><span>*</span><span>clamp</span><span>(</span> <span>-</span><span>dot</span><span>(</span><span>p</span><span>,</span><span>ecs</span><span>),</span> <span>0.0</span><span>,</span> <span>r</span><span>*</span><span>acs</span><span>.</span><span>y</span><span>/</span><span>ecs</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>p</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span> 
</span></span><span><span>    
</span></span><span><span>    <span>// NEW: rotate the whole drawing</span>
</span></span><span><span>    <span>pixel</span> <span>=</span> <span>rotateAt</span><span>(</span><span>pixel</span><span>,</span> <span>sin</span><span>(</span><span>time</span><span>*</span><span>2.</span><span>)</span><span>*</span><span>.1</span><span>,</span> <span>vec2</span><span>(</span><span>0</span><span>,</span><span>-</span><span>.6</span><span>));</span>
</span></span><span><span>    <span>pixel</span><span>.</span><span>y</span> <span>+=</span> <span>.1</span><span>;</span>
</span></span><span><span>    
</span></span><span><span>    <span>// Mouth, eyes, nose</span>
</span></span><span><span>    <span>{</span> <span>// fold</span>
</span></span><span><span>        <span>// Mouth</span>
</span></span><span><span>        <span>float</span> <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>pixel</span><span>,</span>  
</span></span><span><span>                     <span>vec2</span><span>(</span><span>-</span><span>.26</span><span>,</span> <span>-</span><span>.28</span><span>),</span> 
</span></span><span><span>                     <span>vec2</span><span>(</span><span>-</span><span>.05</span><span>,</span><span>-</span><span>.42</span><span>),</span> 
</span></span><span><span>                     <span>vec2</span><span>(</span><span>.115</span><span>,</span> <span>-</span><span>.25</span><span>));</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.11</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>// Teeth</span>
</span></span><span><span>            <span>float</span> <span>width</span> <span>=</span> <span>.065</span><span>;</span>
</span></span><span><span>            <span>vec2</span> <span>teeth</span> <span>=</span> <span>pixel</span><span>;</span>
</span></span><span><span>            <span>teeth</span><span>.</span><span>x</span> <span>=</span> <span>mod</span><span>(</span><span>teeth</span><span>.</span><span>x</span><span>,</span> <span>width</span><span>)</span><span>-</span><span>width</span><span>*</span><span>.5</span><span>;</span>
</span></span><span><span>            <span>teeth</span><span>.</span><span>y</span> <span>-=</span> <span>pow</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.09</span><span>,</span> <span>2.</span><span>)</span> <span>*</span> <span>1.5</span> <span>-</span> <span>.34</span><span>;</span>
</span></span><span><span>            <span>teeth</span><span>.</span><span>y</span> <span>=</span> <span>abs</span><span>(</span><span>teeth</span><span>.</span><span>y</span><span>)</span><span>-</span><span>.06</span><span>;</span>
</span></span><span><span>            <span>d</span> <span>=</span> <span>parabola</span><span>(</span><span>teeth</span><span>,</span> <span>38.</span><span>);</span>
</span></span><span><span>            <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span> <span>&amp;&amp;</span> <span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.06</span><span>)</span> <span>&lt;</span> <span>.194</span><span>)</span> 
</span></span><span><span>                <span>return</span> <span>vec3</span><span>(</span><span>0.902</span><span>,</span> <span>0.890</span><span>,</span> <span>0.729</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.01</span><span>);</span>
</span></span><span><span>          
</span></span><span><span>            <span>// Tongue</span>
</span></span><span><span>            <span>vec2</span> <span>tongue</span> <span>=</span> <span>rotateAt</span><span>(</span><span>pixel</span><span>,</span> <span>sin</span><span>(</span><span>time</span><span>*</span><span>2.</span><span>-</span><span>1.5</span><span>)</span><span>*</span><span>.15</span><span>+</span><span>.1</span><span>,</span> <span>vec2</span><span>(</span><span>0</span><span>,</span><span>-</span><span>.5</span><span>));</span>
</span></span><span><span>            <span>float</span> <span>tongue_thickness</span> <span>=</span> <span>map</span><span>(</span><span>tongue</span><span>.</span><span>x</span><span>,</span> <span>-</span><span>.16</span><span>,</span> <span>.01</span><span>,</span> <span>.02</span><span>,</span> <span>.045</span><span>);</span>
</span></span><span><span>            <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>tongue</span><span>,</span>  
</span></span><span><span>                <span>vec2</span><span>(</span><span>-</span><span>.16</span><span>,</span> <span>-</span><span>.35</span><span>),</span> 
</span></span><span><span>                <span>vec2</span><span>(</span><span>.001</span><span>,</span><span>-</span><span>.33</span><span>),</span> 
</span></span><span><span>                <span>vec2</span><span>(</span><span>.01</span><span>,</span> <span>-</span><span>.5</span><span>))</span> <span>-</span> <span>tongue_thickness</span><span>;</span>
</span></span><span><span>            <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0</span><span>)</span> 
</span></span><span><span>                <span>return</span> <span>vec3</span><span>(</span><span>0.816</span><span>,</span> <span>0.302</span><span>,</span> <span>0.275</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>0.01</span><span>);</span>
</span></span><span><span>              
</span></span><span><span>            <span>// mouth fill color</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>.42</span><span>,</span> <span>.147</span><span>,</span> <span>.152</span><span>);</span> 
</span></span><span><span>        <span>}</span> 
</span></span><span><span>        
</span></span><span><span>        <span>// lip outlines</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.12</span> <span>||</span> <span>(</span><span>abs</span><span>(</span><span>d</span><span>-</span><span>.16</span><span>)</span> <span>&lt;</span> <span>.005</span> 
</span></span><span><span>                        <span>&amp;&amp;</span> <span>(</span><span>pixel</span><span>.</span><span>x</span><span>*-</span><span>6.4</span> <span>&gt;</span> <span>-</span><span>pixel</span><span>.</span><span>y</span><span>+</span><span>1.6</span> 
</span></span><span><span>                          <span>||</span> <span>pixel</span><span>.</span><span>x</span><span>*</span><span>1.7</span> <span>&gt;</span> <span>-</span><span>pixel</span><span>.</span><span>y</span><span>+</span><span>.1</span> 
</span></span><span><span>                          <span>||</span> <span>pixel</span><span>.</span><span>y</span> <span>&lt;</span> <span>-</span><span>0.49</span><span>)))</span> 
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span> 
</span></span><span><span>        
</span></span><span><span>        <span>// lips</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.16</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>.838</span><span>,</span> <span>.799</span><span>,</span> <span>0.76</span><span>);</span>
</span></span><span><span>       
</span></span><span><span>        <span>// Pupils</span>
</span></span><span><span>        <span>vec2</span> <span>pupil_warp</span> <span>=</span> <span>pixel</span><span>;</span>
</span></span><span><span>        <span>pupil_warp</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pupil_warp</span><span>.</span><span>x</span> <span>+</span><span>.13</span><span>);</span>
</span></span><span><span>        <span>pupil_warp</span> <span>-=</span> <span>vec2</span><span>(</span><span>.16</span><span>,</span><span>.24</span><span>);</span>
</span></span><span><span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>star</span><span>(</span><span>pupil_warp</span><span>,</span> <span>0.019</span><span>,</span> <span>6.</span><span>,</span> <span>.9</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.007</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>.1</span><span>);</span>
</span></span><span><span>        <span>}</span>
</span></span><span><span>            
</span></span><span><span>        <span>// Eyeballs</span>
</span></span><span><span>        <span>vec2</span> <span>eye</span> <span>=</span> <span>vec2</span><span>(</span><span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.1</span><span>)</span><span>-</span><span>.17</span><span>,</span> <span>pixel</span><span>.</span><span>y</span><span>*</span><span>.93</span> <span>-</span> <span>.16</span><span>);</span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>length</span><span>(</span><span>eye</span><span>)</span> <span>-</span> <span>.16</span><span>;</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>step</span><span>(</span><span>.013</span><span>,</span> <span>-</span><span>d</span><span>));</span>
</span></span><span><span>        
</span></span><span><span>        <span>// under eye lines</span>
</span></span><span><span>        <span>bool</span> <span>should_show</span> <span>=</span> <span>pixel</span><span>.</span><span>y</span> <span>&lt;</span> <span>0.25</span> <span>&amp;&amp;</span> 
</span></span><span><span>            <span>(</span><span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.29</span><span>)</span> <span>&lt;</span> <span>.05</span> <span>||</span> 
</span></span><span><span>            <span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>-</span><span>.12</span><span>)</span> <span>&lt;</span> <span>.085</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>abs</span><span>(</span><span>d</span> <span>-</span> <span>.04</span><span>)</span> <span>&lt;</span> <span>.0055</span> <span>&amp;&amp;</span> <span>should_show</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>        <span>// Nose  </span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>min</span><span>(</span>
</span></span><span><span>                <span>bezier</span><span>(</span><span>pixel</span><span>,</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.15</span><span>,</span> <span>-</span><span>.13</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.21</span><span>,</span><span>-</span><span>.14</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.14</span><span>,</span> <span>.08</span><span>)),</span>
</span></span><span><span>                <span>bezier</span><span>(</span><span>pixel</span><span>,</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.085</span><span>,</span> <span>-</span><span>.01</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.12</span><span>,</span> <span>-</span><span>.13</span><span>),</span>
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.15</span><span>,</span><span>-</span><span>.13</span><span>)));</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0055</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>
</span></span><span><span>    <span>// Eyebrow</span>
</span></span><span><span>    <span>float</span> <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>pixel</span><span>,</span>  
</span></span><span><span>            <span>vec2</span><span>(</span><span>-</span><span>.34</span><span>,</span> <span>.38</span><span>),</span> 
</span></span><span><span>            <span>// NEW: animate the middle up and down</span>
</span></span><span><span>            <span>vec2</span><span>(</span><span>-</span><span>.05</span><span>,</span> <span>0.5</span> <span>+</span> <span>cos</span><span>(</span><span>time</span><span>)</span><span>*</span><span>.1</span><span>),</span>
</span></span><span><span>            <span>vec2</span><span>(</span><span>.205</span><span>,</span> <span>.36</span><span>))</span> <span>-</span> <span>0.035</span><span>;</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0</span><span>)</span> 
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>.71</span><span>,</span> <span>.839</span><span>,</span> <span>.922</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.013</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>// Head and hair</span>
</span></span><span><span>    <span>{</span> <span>// fold</span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>min</span><span>(</span>
</span></span><span><span>            <span>// Head</span>
</span></span><span><span>            <span>round_rect</span><span>(</span>
</span></span><span><span>            <span>pixel</span><span>,</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.36</span><span>,</span> <span>.6385</span><span>),</span> 
</span></span><span><span>            <span>vec4</span><span>(</span><span>.34</span><span>,</span> <span>.415</span><span>,</span> <span>.363</span><span>,</span> <span>.315</span><span>)),</span>
</span></span><span><span>            
</span></span><span><span>            <span>// Ear</span>
</span></span><span><span>            <span>round_rect</span><span>(</span>
</span></span><span><span>            <span>pixel</span> <span>+</span> <span>vec2</span><span>(</span><span>-</span><span>.32</span><span>,</span> <span>.15</span><span>),</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.15</span><span>,</span> <span>0.12</span><span>),</span> 
</span></span><span><span>            <span>vec4</span><span>(</span><span>.13</span><span>,</span><span>.1</span><span>,</span><span>.13</span><span>,</span><span>.13</span><span>))</span>
</span></span><span><span>        <span>);</span>
</span></span><span><span>            
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>.838</span><span>,</span> <span>.799</span><span>,</span> <span>.76</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.01</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>        <span>// Hair</span>
</span></span><span><span>        <span>vec2</span> <span>hair</span> <span>=</span> <span>pixel</span><span>;</span>
</span></span><span><span>        <span>hair</span> <span>-=</span> <span>vec2</span><span>(</span><span>.08</span><span>,</span><span>.15</span><span>);</span>
</span></span><span><span>        <span>hair</span><span>.</span><span>x</span> <span>*=</span> <span>1.3</span><span>;</span>
</span></span><span><span>        <span>hair</span> <span>=</span> <span>warp</span><span>(</span><span>hair</span><span>,</span> <span>4.0</span><span>,</span> <span>0.07</span><span>);</span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>star</span><span>(</span><span>hair</span><span>,</span> <span>0.95</span><span>,</span> <span>11.</span><span>,</span> <span>.28</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>0.682</span><span>,</span> <span>0.839</span><span>,</span> <span>0.929</span><span>)</span><span>*</span><span>step</span><span>(</span><span>0.012</span><span>,</span> <span>-</span><span>d</span><span>);</span>
</span></span><span><span>        <span>}</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>    
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>1.</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Animate Rick’s head as if he is walking left and right. Flip the face direction when he is moving to the right (this is easier than it sounds!).</p><h3 id="2-switching-whats-drawn">2. Switching What’s Drawn</h3><p>Animating a property with <code>sin()</code> just moves stuff around, but you can also draw something totally different based on time. We’ll do that to make Rick blink.</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>vec2</span> <span>rotateAt</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>angle</span><span>,</span> <span>vec2</span> <span>origin</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>float</span> <span>s</span> <span>=</span> <span>sin</span><span>(</span><span>angle</span><span>),</span> <span>c</span> <span>=</span> <span>cos</span><span>(</span><span>angle</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>(</span><span>p</span><span>-</span><span>origin</span><span>)</span><span>*</span><span>mat2</span><span>(</span> <span>c</span><span>,</span> <span>-</span><span>s</span><span>,</span> <span>s</span><span>,</span> <span>c</span> <span>)</span> <span>+</span> <span>origin</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>map</span><span>(</span><span>float</span> <span>value</span><span>,</span> <span>float</span> <span>inMin</span><span>,</span> <span>float</span> <span>inMax</span><span>,</span> <span>float</span> <span>outMin</span><span>,</span> <span>float</span> <span>outMax</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>  <span>value</span> <span>=</span> <span>clamp</span><span>(</span><span>value</span><span>,</span> <span>inMin</span><span>,</span> <span>inMax</span><span>);</span>
</span></span><span><span>  <span>return</span> <span>outMin</span> <span>+</span> <span>(</span><span>outMax</span> <span>-</span> <span>outMin</span><span>)</span> <span>*</span> <span>(</span><span>value</span> <span>-</span> <span>inMin</span><span>)</span> <span>/</span> <span>(</span><span>inMax</span> <span>-</span> <span>inMin</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>vec2</span> <span>grad</span><span>(</span><span>ivec2</span> <span>z</span><span>)</span>  <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>int</span> <span>n</span> <span>=</span> <span>z</span><span>.</span><span>x</span><span>+</span><span>z</span><span>.</span><span>y</span><span>*</span><span>11111</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>=</span> <span>(</span><span>n</span><span>&lt;&lt;</span><span>13</span><span>)</span><span>^</span><span>n</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>=</span> <span>(</span><span>n</span><span>*</span><span>(</span><span>n</span><span>*</span><span>n</span><span>*</span><span>15731</span><span>+</span><span>789221</span><span>)</span><span>+</span><span>1376312589</span><span>)</span><span>&gt;&gt;</span><span>16</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>&amp;=</span> <span>7</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>gr</span> <span>=</span> <span>vec2</span><span>(</span><span>n</span><span>&amp;</span><span>1</span><span>,</span><span>n</span><span>&gt;&gt;</span><span>1</span><span>)</span><span>*</span><span>2.0</span><span>-</span><span>1.0</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>(</span> <span>n</span><span>&gt;=</span><span>6</span> <span>)</span> <span>?</span> <span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>gr</span><span>.</span><span>x</span><span>)</span> <span>:</span> 
</span></span><span><span>           <span>(</span> <span>n</span><span>&gt;=</span><span>4</span> <span>)</span> <span>?</span> <span>vec2</span><span>(</span><span>gr</span><span>.</span><span>x</span><span>,</span><span>0.0</span><span>)</span> <span>:</span>
</span></span><span><span>                              <span>gr</span><span>;</span>                            
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>noise</span><span>(</span><span>vec2</span> <span>p</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>ivec2</span> <span>i</span> <span>=</span> <span>ivec2</span><span>(</span><span>floor</span><span>(</span><span>p</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>f</span> <span>=</span>       <span>fract</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>vec2</span> <span>u</span> <span>=</span> <span>f</span><span>*</span><span>f</span><span>*</span><span>(</span><span>3.0</span><span>-</span><span>2.0</span><span>*</span><span>f</span><span>);</span> 
</span></span><span><span>    <span>return</span> <span>mix</span><span>(</span> <span>mix</span><span>(</span> <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>0</span><span>,</span><span>0</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>0.0</span><span>)</span> <span>),</span> 
</span></span><span><span>                     <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>1</span><span>,</span><span>0</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>1.0</span><span>,</span><span>0.0</span><span>)</span> <span>),</span> <span>u</span><span>.</span><span>x</span><span>),</span>
</span></span><span><span>                <span>mix</span><span>(</span> <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>0</span><span>,</span><span>1</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>1.0</span><span>)</span> <span>),</span> 
</span></span><span><span>                     <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>1</span><span>,</span><span>1</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>1.0</span><span>,</span><span>1.0</span><span>)</span> <span>),</span> <span>u</span><span>.</span><span>x</span><span>),</span> <span>u</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>vec2</span> <span>warp</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>scale</span><span>,</span> <span>float</span> <span>strength</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>float</span> <span>offsetX</span> <span>=</span> <span>noise</span><span>(</span><span>p</span> <span>*</span> <span>scale</span> <span>+</span> <span>vec2</span><span>(</span><span>0.0</span><span>,</span> <span>100.0</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>offsetY</span> <span>=</span> <span>noise</span><span>(</span><span>p</span> <span>*</span> <span>scale</span> <span>+</span> <span>vec2</span><span>(</span><span>100.0</span><span>,</span> <span>0.0</span><span>));</span>
</span></span><span><span>    <span>return</span> <span>p</span> <span>+</span> <span>vec2</span><span>(</span><span>offsetX</span><span>,</span> <span>offsetY</span><span>)</span> <span>*</span> <span>strength</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>bezier</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>v0</span><span>,</span> <span>vec2</span> <span>v1</span><span>,</span> <span>vec2</span> <span>v2</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>vec2</span> <span>i</span> <span>=</span> <span>v0</span> <span>-</span> <span>v2</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>j</span> <span>=</span> <span>v2</span> <span>-</span> <span>v1</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>k</span> <span>=</span> <span>v1</span> <span>-</span> <span>v0</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>w</span> <span>=</span> <span>j</span><span>-</span><span>k</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>v0</span><span>-=</span> <span>p</span><span>;</span> <span>v1</span><span>-=</span> <span>p</span><span>;</span> <span>v2</span><span>-=</span> <span>p</span><span>;</span>
</span></span><span><span>    
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>v0</span><span>.</span><span>x</span><span>*</span><span>v2</span><span>.</span><span>y</span><span>-</span><span>v0</span><span>.</span><span>y</span><span>*</span><span>v2</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>y</span> <span>=</span> <span>v1</span><span>.</span><span>x</span><span>*</span><span>v0</span><span>.</span><span>y</span><span>-</span><span>v1</span><span>.</span><span>y</span><span>*</span><span>v0</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>z</span> <span>=</span> <span>v2</span><span>.</span><span>x</span><span>*</span><span>v1</span><span>.</span><span>y</span><span>-</span><span>v2</span><span>.</span><span>y</span><span>*</span><span>v1</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>vec2</span> <span>s</span> <span>=</span> <span>2.0</span><span>*</span><span>(</span><span>y</span><span>*</span><span>j</span><span>+</span><span>z</span><span>*</span><span>k</span><span>)</span><span>-</span><span>x</span><span>*</span><span>i</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span>  <span>(</span><span>y</span><span>*</span><span>z</span><span>-</span><span>x</span><span>*</span><span>x</span><span>*</span><span>0.25</span><span>)</span><span>/</span><span>dot</span><span>(</span><span>s</span><span>,</span><span>s</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>t</span> <span>=</span> <span>clamp</span><span>(</span> <span>(</span><span>0.5</span><span>*</span><span>x</span><span>+</span><span>y</span><span>+</span><span>r</span><span>*</span><span>dot</span><span>(</span><span>s</span><span>,</span><span>w</span><span>))</span><span>/</span><span>(</span><span>x</span><span>+</span><span>y</span><span>+</span><span>z</span><span>),</span><span>0.0</span><span>,</span><span>1.0</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>vec2</span> <span>d</span> <span>=</span> <span>v0</span><span>+</span><span>t</span><span>*</span><span>(</span><span>k</span><span>+</span><span>k</span><span>+</span><span>t</span><span>*</span><span>w</span><span>);</span>
</span></span><span><span>    <span>vec2</span> <span>outQ</span> <span>=</span> <span>d</span> <span>+</span> <span>p</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>d</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>parabola</span><span>(</span><span>vec2</span> <span>pos</span><span>,</span> <span>float</span> <span>k</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// from https://www.shadertoy.com/view/ws3GD7</span>
</span></span><span><span>    <span>pos</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>ik</span> <span>=</span> <span>1.0</span><span>/</span><span>k</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>p</span> <span>=</span> <span>ik</span><span>*</span><span>(</span><span>pos</span><span>.</span><span>y</span> <span>-</span> <span>0.5</span><span>*</span><span>ik</span><span>)</span><span>/</span><span>3.0</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>q</span> <span>=</span> <span>0.25</span><span>*</span><span>ik</span><span>*</span><span>ik</span><span>*</span><span>pos</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>h</span> <span>=</span> <span>q</span><span>*</span><span>q</span> <span>-</span> <span>p</span><span>*</span><span>p</span><span>*</span><span>p</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span> <span>sqrt</span><span>(</span><span>abs</span><span>(</span><span>h</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>(</span><span>h</span><span>&gt;</span><span>0.0</span><span>)</span> <span>?</span> 
</span></span><span><span>        <span>pow</span><span>(</span><span>q</span><span>+</span><span>r</span><span>,</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span> <span>-</span> <span>pow</span><span>(</span><span>abs</span><span>(</span><span>q</span><span>-</span><span>r</span><span>),</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>r</span><span>-</span><span>q</span><span>)</span> <span>:</span>
</span></span><span><span>        <span>2.0</span><span>*</span><span>cos</span><span>(</span><span>atan</span><span>(</span><span>r</span><span>,</span><span>q</span><span>)</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sqrt</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>pos</span><span>-</span><span>vec2</span><span>(</span><span>x</span><span>,</span><span>k</span><span>*</span><span>x</span><span>*</span><span>x</span><span>))</span> <span>*</span> <span>sign</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>-</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>round_rect</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>b</span><span>,</span> <span>vec4</span> <span>r</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>r</span><span>.</span><span>xy</span> <span>=</span> <span>(</span><span>p</span><span>.</span><span>x</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>r</span><span>.</span><span>xy</span> <span>:</span> <span>r</span><span>.</span><span>zw</span><span>;</span>
</span></span><span><span>    <span>r</span><span>.</span><span>x</span>  <span>=</span> <span>(</span><span>p</span><span>.</span><span>y</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>r</span><span>.</span><span>x</span>  <span>:</span> <span>r</span><span>.</span><span>y</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>q</span> <span>=</span> <span>abs</span><span>(</span><span>p</span><span>)</span><span>-</span><span>b</span><span>+</span><span>r</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>min</span><span>(</span><span>max</span><span>(</span><span>q</span><span>.</span><span>x</span><span>,</span><span>q</span><span>.</span><span>y</span><span>),</span><span>0.0</span><span>)</span> <span>+</span> <span>length</span><span>(</span><span>max</span><span>(</span><span>q</span><span>,</span><span>0.0</span><span>))</span> <span>-</span> <span>r</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>star</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>r</span><span>,</span> <span>float</span> <span>points</span><span>,</span> <span>float</span> <span>ratio</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// next 4 lines can be precomputed for a given shape</span>
</span></span><span><span>    <span>float</span> <span>an</span> <span>=</span> <span>3.141593</span><span>/</span><span>points</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>en</span> <span>=</span> <span>3.141593</span><span>/</span><span>(</span><span>ratio</span><span>*</span><span>(</span><span>points</span><span>-</span><span>2.</span><span>)</span> <span>+</span> <span>2.</span><span>);</span> 
</span></span><span><span>    <span>vec2</span>  <span>acs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>an</span><span>),</span><span>sin</span><span>(</span><span>an</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>ecs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>en</span><span>),</span><span>sin</span><span>(</span><span>en</span><span>));</span> <span>// ecs=vec2(0,1) for regular polygon</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>bn</span> <span>=</span> <span>mod</span><span>(</span><span>atan</span><span>(</span><span>p</span><span>.</span><span>x</span><span>,</span><span>p</span><span>.</span><span>y</span><span>),</span><span>2.0</span><span>*</span><span>an</span><span>)</span> <span>-</span> <span>an</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>=</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>vec2</span><span>(</span><span>cos</span><span>(</span><span>bn</span><span>),</span><span>abs</span><span>(</span><span>sin</span><span>(</span><span>bn</span><span>)));</span>
</span></span><span><span>    <span>p</span> <span>-=</span> <span>r</span><span>*</span><span>acs</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>+=</span> <span>ecs</span><span>*</span><span>clamp</span><span>(</span> <span>-</span><span>dot</span><span>(</span><span>p</span><span>,</span><span>ecs</span><span>),</span> <span>0.0</span><span>,</span> <span>r</span><span>*</span><span>acs</span><span>.</span><span>y</span><span>/</span><span>ecs</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>p</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>     
</span></span><span><span>    <span>{</span> <span>// fold</span>
</span></span><span><span>        <span>// rotate the whole drawing</span>
</span></span><span><span>        <span>pixel</span> <span>=</span> <span>rotateAt</span><span>(</span><span>pixel</span><span>,</span> <span>sin</span><span>(</span><span>time</span><span>*</span><span>2.</span><span>)</span><span>*</span><span>.1</span><span>,</span> <span>vec2</span><span>(</span><span>0</span><span>,</span><span>-</span><span>.6</span><span>));</span>
</span></span><span><span>        <span>pixel</span><span>.</span><span>y</span> <span>+=</span> <span>.1</span><span>;</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>
</span></span><span><span>    <span>// blink for .09 seconds, every 2 seconds</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>mod</span><span>(</span><span>time</span><span>,</span> <span>2.</span><span>)</span> <span>&lt;</span> <span>.09</span><span>)</span> <span>{</span> <span>// closed eyes</span>
</span></span><span><span>        <span>float</span> <span>d</span> <span>=</span> <span>round_rect</span><span>(</span><span>pixel</span><span>+</span><span>vec2</span><span>(</span><span>.07</span><span>,</span><span>-</span><span>.16</span><span>),</span> <span>vec2</span><span>(</span><span>.24</span><span>,</span><span>0</span><span>),</span> <span>vec4</span><span>(</span><span>0</span><span>));</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.008</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>      
</span></span><span><span>    <span>}</span> 
</span></span><span><span>    <span>else</span> <span>// open eyes</span>
</span></span><span><span>    <span>{</span> <span>// fold</span>
</span></span><span><span>        <span>// Pupils</span>
</span></span><span><span>        <span>vec2</span> <span>pupil_warp</span> <span>=</span> <span>pixel</span><span>;</span>
</span></span><span><span>        <span>pupil_warp</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pupil_warp</span><span>.</span><span>x</span> <span>+</span><span>.13</span><span>);</span>
</span></span><span><span>        <span>pupil_warp</span> <span>-=</span> <span>vec2</span><span>(</span><span>.16</span><span>,</span><span>.24</span><span>);</span>
</span></span><span><span>
</span></span><span><span>        <span>float</span> <span>d</span> <span>=</span> <span>star</span><span>(</span><span>pupil_warp</span><span>,</span> <span>0.019</span><span>,</span> <span>6.</span><span>,</span> <span>.9</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.007</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>.1</span><span>);</span>
</span></span><span><span>        <span>}</span>
</span></span><span><span>            
</span></span><span><span>        <span>// Eyeballs</span>
</span></span><span><span>        <span>vec2</span> <span>eye</span> <span>=</span> <span>vec2</span><span>(</span><span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.1</span><span>)</span><span>-</span><span>.17</span><span>,</span> <span>pixel</span><span>.</span><span>y</span><span>*</span><span>.93</span> <span>-</span> <span>.16</span><span>);</span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>length</span><span>(</span><span>eye</span><span>)</span> <span>-</span> <span>.16</span><span>;</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>step</span><span>(</span><span>.013</span><span>,</span> <span>-</span><span>d</span><span>));</span>
</span></span><span><span>        
</span></span><span><span>        <span>// under eye lines</span>
</span></span><span><span>        <span>bool</span> <span>should_show</span> <span>=</span> <span>pixel</span><span>.</span><span>y</span> <span>&lt;</span> <span>0.25</span> <span>&amp;&amp;</span> 
</span></span><span><span>            <span>(</span><span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.29</span><span>)</span> <span>&lt;</span> <span>.05</span> <span>||</span> 
</span></span><span><span>            <span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>-</span><span>.12</span><span>)</span> <span>&lt;</span> <span>.085</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>abs</span><span>(</span><span>d</span> <span>-</span> <span>.04</span><span>)</span> <span>&lt;</span> <span>.0055</span> <span>&amp;&amp;</span> <span>should_show</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>  
</span></span><span><span>    <span>// Rest of face</span>
</span></span><span><span>    <span>{</span> <span>// fold</span>
</span></span><span><span>        <span>// Mouth</span>
</span></span><span><span>        <span>float</span> <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>pixel</span><span>,</span>  
</span></span><span><span>                     <span>vec2</span><span>(</span><span>-</span><span>.26</span><span>,</span> <span>-</span><span>.28</span><span>),</span> 
</span></span><span><span>                     <span>vec2</span><span>(</span><span>-</span><span>.05</span><span>,</span><span>-</span><span>.42</span><span>),</span> 
</span></span><span><span>                     <span>vec2</span><span>(</span><span>.115</span><span>,</span> <span>-</span><span>.25</span><span>));</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.11</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>// Teeth</span>
</span></span><span><span>            <span>float</span> <span>width</span> <span>=</span> <span>.065</span><span>;</span>
</span></span><span><span>            <span>vec2</span> <span>teeth</span> <span>=</span> <span>pixel</span><span>;</span>
</span></span><span><span>            <span>teeth</span><span>.</span><span>x</span> <span>=</span> <span>mod</span><span>(</span><span>teeth</span><span>.</span><span>x</span><span>,</span> <span>width</span><span>)</span><span>-</span><span>width</span><span>*</span><span>.5</span><span>;</span>
</span></span><span><span>            <span>teeth</span><span>.</span><span>y</span> <span>-=</span> <span>pow</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.09</span><span>,</span> <span>2.</span><span>)</span> <span>*</span> <span>1.5</span> <span>-</span> <span>.34</span><span>;</span>
</span></span><span><span>            <span>teeth</span><span>.</span><span>y</span> <span>=</span> <span>abs</span><span>(</span><span>teeth</span><span>.</span><span>y</span><span>)</span><span>-</span><span>.06</span><span>;</span>
</span></span><span><span>            <span>d</span> <span>=</span> <span>parabola</span><span>(</span><span>teeth</span><span>,</span> <span>38.</span><span>);</span>
</span></span><span><span>            <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span> <span>&amp;&amp;</span> <span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.06</span><span>)</span> <span>&lt;</span> <span>.194</span><span>)</span> 
</span></span><span><span>                <span>return</span> <span>vec3</span><span>(</span><span>0.902</span><span>,</span> <span>0.890</span><span>,</span> <span>0.729</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.01</span><span>);</span>
</span></span><span><span>          
</span></span><span><span>            <span>// Tongue</span>
</span></span><span><span>            <span>// `map()` is used to change the thickness of </span>
</span></span><span><span>            <span>// the tongue along the x axis</span>
</span></span><span><span>            <span>vec2</span> <span>tongue</span> <span>=</span> <span>rotateAt</span><span>(</span><span>pixel</span><span>,</span> <span>sin</span><span>(</span><span>time</span><span>*</span><span>2.</span><span>-</span><span>1.5</span><span>)</span><span>*</span><span>.15</span><span>+</span><span>.1</span><span>,</span> <span>vec2</span><span>(</span><span>0</span><span>,</span><span>-</span><span>.5</span><span>));</span>
</span></span><span><span>            <span>float</span> <span>tongue_thickness</span> <span>=</span> <span>map</span><span>(</span><span>tongue</span><span>.</span><span>x</span><span>,</span> <span>-</span><span>.16</span><span>,</span> <span>.01</span><span>,</span> <span>.02</span><span>,</span> <span>.045</span><span>);</span>
</span></span><span><span>            <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>tongue</span><span>,</span>  
</span></span><span><span>                <span>vec2</span><span>(</span><span>-</span><span>.16</span><span>,</span> <span>-</span><span>.35</span><span>),</span> 
</span></span><span><span>                <span>vec2</span><span>(</span><span>.001</span><span>,</span><span>-</span><span>.33</span><span>),</span> 
</span></span><span><span>                <span>vec2</span><span>(</span><span>.01</span><span>,</span> <span>-</span><span>.5</span><span>))</span> <span>-</span> <span>tongue_thickness</span><span>;</span>
</span></span><span><span>            <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0</span><span>)</span> 
</span></span><span><span>                <span>return</span> <span>vec3</span><span>(</span><span>0.816</span><span>,</span> <span>0.302</span><span>,</span> <span>0.275</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>0.01</span><span>);</span>
</span></span><span><span>              
</span></span><span><span>            <span>// mouth fill color</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>.42</span><span>,</span> <span>.147</span><span>,</span> <span>.152</span><span>);</span> 
</span></span><span><span>        <span>}</span> 
</span></span><span><span>        
</span></span><span><span>        <span>// lip outlines</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.12</span> <span>||</span> <span>(</span><span>abs</span><span>(</span><span>d</span><span>-</span><span>.16</span><span>)</span> <span>&lt;</span> <span>.005</span> 
</span></span><span><span>                        <span>&amp;&amp;</span> <span>(</span><span>pixel</span><span>.</span><span>x</span><span>*-</span><span>6.4</span> <span>&gt;</span> <span>-</span><span>pixel</span><span>.</span><span>y</span><span>+</span><span>1.6</span> 
</span></span><span><span>                          <span>||</span> <span>pixel</span><span>.</span><span>x</span><span>*</span><span>1.7</span> <span>&gt;</span> <span>-</span><span>pixel</span><span>.</span><span>y</span><span>+</span><span>.1</span> 
</span></span><span><span>                          <span>||</span> <span>pixel</span><span>.</span><span>y</span> <span>&lt;</span> <span>-</span><span>0.49</span><span>)))</span> 
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span> 
</span></span><span><span>        
</span></span><span><span>        <span>// lips</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.16</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>.838</span><span>,</span> <span>.799</span><span>,</span> <span>0.76</span><span>);</span>
</span></span><span><span>       
</span></span><span><span>        
</span></span><span><span>    
</span></span><span><span>        <span>// Nose  </span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>min</span><span>(</span>
</span></span><span><span>                <span>bezier</span><span>(</span><span>pixel</span><span>,</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.15</span><span>,</span> <span>-</span><span>.13</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.21</span><span>,</span><span>-</span><span>.14</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.14</span><span>,</span> <span>.08</span><span>)),</span>
</span></span><span><span>                <span>bezier</span><span>(</span><span>pixel</span><span>,</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.085</span><span>,</span> <span>-</span><span>.01</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.12</span><span>,</span> <span>-</span><span>.13</span><span>),</span>
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.15</span><span>,</span><span>-</span><span>.13</span><span>)));</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0055</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>
</span></span><span><span>    <span>// Eyebrow</span>
</span></span><span><span>    <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>pixel</span><span>,</span>  
</span></span><span><span>            <span>vec2</span><span>(</span><span>-</span><span>.34</span><span>,</span> <span>.38</span><span>),</span> 
</span></span><span><span>            <span>// NEW animate the middle up and down</span>
</span></span><span><span>            <span>vec2</span><span>(</span><span>-</span><span>.05</span><span>,</span> <span>0.5</span> <span>+</span> <span>cos</span><span>(</span><span>time</span><span>)</span><span>*</span><span>.1</span><span>),</span>
</span></span><span><span>            <span>vec2</span><span>(</span><span>.205</span><span>,</span> <span>.36</span><span>))</span> <span>-</span> <span>0.035</span><span>;</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0</span><span>)</span> 
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>.71</span><span>,</span> <span>.839</span><span>,</span> <span>.922</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.013</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>        <span>d</span> <span>=</span> <span>min</span><span>(</span>
</span></span><span><span>            <span>// Head</span>
</span></span><span><span>            <span>round_rect</span><span>(</span>
</span></span><span><span>            <span>pixel</span><span>,</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.36</span><span>,</span> <span>.6385</span><span>),</span> 
</span></span><span><span>            <span>vec4</span><span>(</span><span>.34</span><span>,</span> <span>.415</span><span>,</span> <span>.363</span><span>,</span> <span>.315</span><span>)),</span>
</span></span><span><span>            
</span></span><span><span>            <span>// Ear</span>
</span></span><span><span>            <span>round_rect</span><span>(</span>
</span></span><span><span>            <span>pixel</span> <span>+</span> <span>vec2</span><span>(</span><span>-</span><span>.32</span><span>,</span> <span>.15</span><span>),</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.15</span><span>,</span> <span>0.12</span><span>),</span> 
</span></span><span><span>            <span>vec4</span><span>(</span><span>.13</span><span>,</span><span>.1</span><span>,</span><span>.13</span><span>,</span><span>.13</span><span>))</span>
</span></span><span><span>        <span>);</span>
</span></span><span><span>            
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>.838</span><span>,</span> <span>.799</span><span>,</span> <span>.76</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.01</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>        <span>// Hair</span>
</span></span><span><span>        <span>vec2</span> <span>hair</span> <span>=</span> <span>pixel</span><span>;</span>
</span></span><span><span>        <span>hair</span> <span>-=</span> <span>vec2</span><span>(</span><span>.08</span><span>,</span><span>.15</span><span>);</span>
</span></span><span><span>        <span>hair</span><span>.</span><span>x</span> <span>*=</span> <span>1.3</span><span>;</span>
</span></span><span><span>        <span>hair</span> <span>=</span> <span>warp</span><span>(</span><span>hair</span><span>,</span> <span>4.0</span><span>,</span> <span>0.07</span><span>);</span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>star</span><span>(</span><span>hair</span><span>,</span> <span>0.95</span><span>,</span> <span>11.</span><span>,</span> <span>.28</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>0.682</span><span>,</span> <span>0.839</span><span>,</span> <span>0.929</span><span>)</span><span>*</span><span>step</span><span>(</span><span>0.012</span><span>,</span> <span>-</span><span>d</span><span>);</span>
</span></span><span><span>        <span>}</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>    
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>1</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Use this technique to animate Rick’s mouth so it looks like he is talking.</p><h3 id="3-noisy-movement">3. Noisy Movement</h3><p>If <code>sin</code> is too smooth for you, try using noise! I used <code>noise()</code> to make the eyes randomly look around. Since I don’t want the eyes to be continuously moving, I rounded the time value before passing it to <code>noise()</code>.</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>vec2</span> <span>rotateAt</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>angle</span><span>,</span> <span>vec2</span> <span>origin</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>float</span> <span>s</span> <span>=</span> <span>sin</span><span>(</span><span>angle</span><span>),</span> <span>c</span> <span>=</span> <span>cos</span><span>(</span><span>angle</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>(</span><span>p</span><span>-</span><span>origin</span><span>)</span><span>*</span><span>mat2</span><span>(</span> <span>c</span><span>,</span> <span>-</span><span>s</span><span>,</span> <span>s</span><span>,</span> <span>c</span> <span>)</span> <span>+</span> <span>origin</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>map</span><span>(</span><span>float</span> <span>value</span><span>,</span> <span>float</span> <span>inMin</span><span>,</span> <span>float</span> <span>inMax</span><span>,</span> <span>float</span> <span>outMin</span><span>,</span> <span>float</span> <span>outMax</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>  <span>value</span> <span>=</span> <span>clamp</span><span>(</span><span>value</span><span>,</span> <span>inMin</span><span>,</span> <span>inMax</span><span>);</span>
</span></span><span><span>  <span>return</span> <span>outMin</span> <span>+</span> <span>(</span><span>outMax</span> <span>-</span> <span>outMin</span><span>)</span> <span>*</span> <span>(</span><span>value</span> <span>-</span> <span>inMin</span><span>)</span> <span>/</span> <span>(</span><span>inMax</span> <span>-</span> <span>inMin</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>vec2</span> <span>grad</span><span>(</span><span>ivec2</span> <span>z</span><span>)</span>  <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>int</span> <span>n</span> <span>=</span> <span>z</span><span>.</span><span>x</span><span>+</span><span>z</span><span>.</span><span>y</span><span>*</span><span>11111</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>=</span> <span>(</span><span>n</span><span>&lt;&lt;</span><span>13</span><span>)</span><span>^</span><span>n</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>=</span> <span>(</span><span>n</span><span>*</span><span>(</span><span>n</span><span>*</span><span>n</span><span>*</span><span>15731</span><span>+</span><span>789221</span><span>)</span><span>+</span><span>1376312589</span><span>)</span><span>&gt;&gt;</span><span>16</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>&amp;=</span> <span>7</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>gr</span> <span>=</span> <span>vec2</span><span>(</span><span>n</span><span>&amp;</span><span>1</span><span>,</span><span>n</span><span>&gt;&gt;</span><span>1</span><span>)</span><span>*</span><span>2.0</span><span>-</span><span>1.0</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>(</span> <span>n</span><span>&gt;=</span><span>6</span> <span>)</span> <span>?</span> <span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>gr</span><span>.</span><span>x</span><span>)</span> <span>:</span> 
</span></span><span><span>           <span>(</span> <span>n</span><span>&gt;=</span><span>4</span> <span>)</span> <span>?</span> <span>vec2</span><span>(</span><span>gr</span><span>.</span><span>x</span><span>,</span><span>0.0</span><span>)</span> <span>:</span>
</span></span><span><span>                              <span>gr</span><span>;</span>                            
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>noise</span><span>(</span><span>vec2</span> <span>p</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>ivec2</span> <span>i</span> <span>=</span> <span>ivec2</span><span>(</span><span>floor</span><span>(</span><span>p</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>f</span> <span>=</span>       <span>fract</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>vec2</span> <span>u</span> <span>=</span> <span>f</span><span>*</span><span>f</span><span>*</span><span>(</span><span>3.0</span><span>-</span><span>2.0</span><span>*</span><span>f</span><span>);</span> 
</span></span><span><span>    <span>return</span> <span>mix</span><span>(</span> <span>mix</span><span>(</span> <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>0</span><span>,</span><span>0</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>0.0</span><span>)</span> <span>),</span> 
</span></span><span><span>                     <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>1</span><span>,</span><span>0</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>1.0</span><span>,</span><span>0.0</span><span>)</span> <span>),</span> <span>u</span><span>.</span><span>x</span><span>),</span>
</span></span><span><span>                <span>mix</span><span>(</span> <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>0</span><span>,</span><span>1</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>1.0</span><span>)</span> <span>),</span> 
</span></span><span><span>                     <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>1</span><span>,</span><span>1</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>1.0</span><span>,</span><span>1.0</span><span>)</span> <span>),</span> <span>u</span><span>.</span><span>x</span><span>),</span> <span>u</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>vec2</span> <span>warp</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>scale</span><span>,</span> <span>float</span> <span>strength</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>float</span> <span>offsetX</span> <span>=</span> <span>noise</span><span>(</span><span>p</span> <span>*</span> <span>scale</span> <span>+</span> <span>vec2</span><span>(</span><span>0.0</span><span>,</span> <span>100.0</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>offsetY</span> <span>=</span> <span>noise</span><span>(</span><span>p</span> <span>*</span> <span>scale</span> <span>+</span> <span>vec2</span><span>(</span><span>100.0</span><span>,</span> <span>0.0</span><span>));</span>
</span></span><span><span>    <span>return</span> <span>p</span> <span>+</span> <span>vec2</span><span>(</span><span>offsetX</span><span>,</span> <span>offsetY</span><span>)</span> <span>*</span> <span>strength</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>bezier</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>v0</span><span>,</span> <span>vec2</span> <span>v1</span><span>,</span> <span>vec2</span> <span>v2</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>vec2</span> <span>i</span> <span>=</span> <span>v0</span> <span>-</span> <span>v2</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>j</span> <span>=</span> <span>v2</span> <span>-</span> <span>v1</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>k</span> <span>=</span> <span>v1</span> <span>-</span> <span>v0</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>w</span> <span>=</span> <span>j</span><span>-</span><span>k</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>v0</span><span>-=</span> <span>p</span><span>;</span> <span>v1</span><span>-=</span> <span>p</span><span>;</span> <span>v2</span><span>-=</span> <span>p</span><span>;</span>
</span></span><span><span>    
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>v0</span><span>.</span><span>x</span><span>*</span><span>v2</span><span>.</span><span>y</span><span>-</span><span>v0</span><span>.</span><span>y</span><span>*</span><span>v2</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>y</span> <span>=</span> <span>v1</span><span>.</span><span>x</span><span>*</span><span>v0</span><span>.</span><span>y</span><span>-</span><span>v1</span><span>.</span><span>y</span><span>*</span><span>v0</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>z</span> <span>=</span> <span>v2</span><span>.</span><span>x</span><span>*</span><span>v1</span><span>.</span><span>y</span><span>-</span><span>v2</span><span>.</span><span>y</span><span>*</span><span>v1</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>vec2</span> <span>s</span> <span>=</span> <span>2.0</span><span>*</span><span>(</span><span>y</span><span>*</span><span>j</span><span>+</span><span>z</span><span>*</span><span>k</span><span>)</span><span>-</span><span>x</span><span>*</span><span>i</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span>  <span>(</span><span>y</span><span>*</span><span>z</span><span>-</span><span>x</span><span>*</span><span>x</span><span>*</span><span>0.25</span><span>)</span><span>/</span><span>dot</span><span>(</span><span>s</span><span>,</span><span>s</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>t</span> <span>=</span> <span>clamp</span><span>(</span> <span>(</span><span>0.5</span><span>*</span><span>x</span><span>+</span><span>y</span><span>+</span><span>r</span><span>*</span><span>dot</span><span>(</span><span>s</span><span>,</span><span>w</span><span>))</span><span>/</span><span>(</span><span>x</span><span>+</span><span>y</span><span>+</span><span>z</span><span>),</span><span>0.0</span><span>,</span><span>1.0</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>vec2</span> <span>d</span> <span>=</span> <span>v0</span><span>+</span><span>t</span><span>*</span><span>(</span><span>k</span><span>+</span><span>k</span><span>+</span><span>t</span><span>*</span><span>w</span><span>);</span>
</span></span><span><span>    <span>vec2</span> <span>outQ</span> <span>=</span> <span>d</span> <span>+</span> <span>p</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>d</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>parabola</span><span>(</span><span>vec2</span> <span>pos</span><span>,</span> <span>float</span> <span>k</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// from https://www.shadertoy.com/view/ws3GD7</span>
</span></span><span><span>    <span>pos</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>ik</span> <span>=</span> <span>1.0</span><span>/</span><span>k</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>p</span> <span>=</span> <span>ik</span><span>*</span><span>(</span><span>pos</span><span>.</span><span>y</span> <span>-</span> <span>0.5</span><span>*</span><span>ik</span><span>)</span><span>/</span><span>3.0</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>q</span> <span>=</span> <span>0.25</span><span>*</span><span>ik</span><span>*</span><span>ik</span><span>*</span><span>pos</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>h</span> <span>=</span> <span>q</span><span>*</span><span>q</span> <span>-</span> <span>p</span><span>*</span><span>p</span><span>*</span><span>p</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span> <span>sqrt</span><span>(</span><span>abs</span><span>(</span><span>h</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>(</span><span>h</span><span>&gt;</span><span>0.0</span><span>)</span> <span>?</span> 
</span></span><span><span>        <span>pow</span><span>(</span><span>q</span><span>+</span><span>r</span><span>,</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span> <span>-</span> <span>pow</span><span>(</span><span>abs</span><span>(</span><span>q</span><span>-</span><span>r</span><span>),</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>r</span><span>-</span><span>q</span><span>)</span> <span>:</span>
</span></span><span><span>        <span>2.0</span><span>*</span><span>cos</span><span>(</span><span>atan</span><span>(</span><span>r</span><span>,</span><span>q</span><span>)</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sqrt</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>pos</span><span>-</span><span>vec2</span><span>(</span><span>x</span><span>,</span><span>k</span><span>*</span><span>x</span><span>*</span><span>x</span><span>))</span> <span>*</span> <span>sign</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>-</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>round_rect</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>b</span><span>,</span> <span>vec4</span> <span>r</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>r</span><span>.</span><span>xy</span> <span>=</span> <span>(</span><span>p</span><span>.</span><span>x</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>r</span><span>.</span><span>xy</span> <span>:</span> <span>r</span><span>.</span><span>zw</span><span>;</span>
</span></span><span><span>    <span>r</span><span>.</span><span>x</span>  <span>=</span> <span>(</span><span>p</span><span>.</span><span>y</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>r</span><span>.</span><span>x</span>  <span>:</span> <span>r</span><span>.</span><span>y</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>q</span> <span>=</span> <span>abs</span><span>(</span><span>p</span><span>)</span><span>-</span><span>b</span><span>+</span><span>r</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>min</span><span>(</span><span>max</span><span>(</span><span>q</span><span>.</span><span>x</span><span>,</span><span>q</span><span>.</span><span>y</span><span>),</span><span>0.0</span><span>)</span> <span>+</span> <span>length</span><span>(</span><span>max</span><span>(</span><span>q</span><span>,</span><span>0.0</span><span>))</span> <span>-</span> <span>r</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>star</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>r</span><span>,</span> <span>float</span> <span>points</span><span>,</span> <span>float</span> <span>ratio</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// next 4 lines can be precomputed for a given shape</span>
</span></span><span><span>    <span>float</span> <span>an</span> <span>=</span> <span>3.141593</span><span>/</span><span>points</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>en</span> <span>=</span> <span>3.141593</span><span>/</span><span>(</span><span>ratio</span><span>*</span><span>(</span><span>points</span><span>-</span><span>2.</span><span>)</span> <span>+</span> <span>2.</span><span>);</span> 
</span></span><span><span>    <span>vec2</span>  <span>acs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>an</span><span>),</span><span>sin</span><span>(</span><span>an</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>ecs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>en</span><span>),</span><span>sin</span><span>(</span><span>en</span><span>));</span> <span>// ecs=vec2(0,1) for regular polygon</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>bn</span> <span>=</span> <span>mod</span><span>(</span><span>atan</span><span>(</span><span>p</span><span>.</span><span>x</span><span>,</span><span>p</span><span>.</span><span>y</span><span>),</span><span>2.0</span><span>*</span><span>an</span><span>)</span> <span>-</span> <span>an</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>=</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>vec2</span><span>(</span><span>cos</span><span>(</span><span>bn</span><span>),</span><span>abs</span><span>(</span><span>sin</span><span>(</span><span>bn</span><span>)));</span>
</span></span><span><span>    <span>p</span> <span>-=</span> <span>r</span><span>*</span><span>acs</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>+=</span> <span>ecs</span><span>*</span><span>clamp</span><span>(</span> <span>-</span><span>dot</span><span>(</span><span>p</span><span>,</span><span>ecs</span><span>),</span> <span>0.0</span><span>,</span> <span>r</span><span>*</span><span>acs</span><span>.</span><span>y</span><span>/</span><span>ecs</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>p</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span> 
</span></span><span><span>    <span>{</span> <span>// fold</span>
</span></span><span><span>        <span>// rotate the whole drawing</span>
</span></span><span><span>        <span>pixel</span> <span>=</span> <span>rotateAt</span><span>(</span><span>pixel</span><span>,</span> <span>sin</span><span>(</span><span>time</span><span>*</span><span>2.</span><span>)</span><span>*</span><span>.1</span><span>,</span> <span>vec2</span><span>(</span><span>0</span><span>,</span><span>-</span><span>.6</span><span>));</span>
</span></span><span><span>        <span>pixel</span><span>.</span><span>y</span> <span>+=</span> <span>.1</span><span>;</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>    
</span></span><span><span>    <span>// Blink eyes</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>mod</span><span>(</span><span>time</span><span>,</span> <span>2.</span><span>)</span> <span>&lt;</span> <span>.09</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>        <span>// closed eyes</span>
</span></span><span><span>        <span>float</span> <span>d</span> <span>=</span> <span>round_rect</span><span>(</span><span>pixel</span><span>+</span><span>vec2</span><span>(</span><span>.07</span><span>,</span><span>-</span><span>.16</span><span>),</span> <span>vec2</span><span>(</span><span>.24</span><span>,</span><span>0</span><span>),</span> <span>vec4</span><span>(</span><span>0</span><span>));</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.008</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>      
</span></span><span><span>    <span>}</span> 
</span></span><span><span>    <span>else</span> <span>{</span> 
</span></span><span><span>        <span>// move pupils randomly</span>
</span></span><span><span>        <span>vec2</span> <span>pupil_warp</span> <span>=</span> <span>pixel</span> <span>+</span> <span>vec2</span><span>(</span><span>.095</span><span>,</span><span>-</span><span>.18</span><span>);</span>
</span></span><span><span>        <span>pupil_warp</span><span>.</span><span>x</span> <span>-=</span> <span>noise</span><span>(</span><span>vec2</span><span>(</span><span>round</span><span>(</span><span>time</span><span>)</span><span>*</span><span>7.</span><span>+</span><span>.5</span><span>,</span> <span>0.5</span><span>))</span><span>*</span><span>.1</span><span>;</span>
</span></span><span><span>        <span>pupil_warp</span><span>.</span><span>y</span> <span>-=</span> <span>noise</span><span>(</span><span>vec2</span><span>(</span><span>round</span><span>(</span><span>time</span><span>)</span><span>*</span><span>9.</span><span>+</span><span>.5</span><span>,</span> <span>0.5</span><span>))</span><span>*</span><span>.1</span><span>;</span>
</span></span><span><span>        <span>pupil_warp</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pupil_warp</span><span>.</span><span>x</span><span>)</span> <span>-</span> <span>.16</span><span>;</span>
</span></span><span><span>        <span>float</span> <span>d</span> <span>=</span> <span>star</span><span>(</span><span>pupil_warp</span><span>,</span> <span>0.019</span><span>,</span> <span>6.</span><span>,</span> <span>.9</span><span>);</span>
</span></span><span><span>        
</span></span><span><span>        <span>{</span><span>// fold</span>
</span></span><span><span>            <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.007</span><span>)</span> <span>{</span>
</span></span><span><span>                <span>return</span> <span>vec3</span><span>(</span><span>.1</span><span>);</span>
</span></span><span><span>            <span>}</span>
</span></span><span><span>                
</span></span><span><span>            <span>// Eyeballs</span>
</span></span><span><span>            <span>vec2</span> <span>eye</span> <span>=</span> <span>vec2</span><span>(</span><span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.1</span><span>)</span><span>-</span><span>.17</span><span>,</span> <span>pixel</span><span>.</span><span>y</span><span>*</span><span>.93</span> <span>-</span> <span>.16</span><span>);</span>
</span></span><span><span>            <span>d</span> <span>=</span> <span>length</span><span>(</span><span>eye</span><span>)</span> <span>-</span> <span>.16</span><span>;</span>
</span></span><span><span>            <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>step</span><span>(</span><span>.013</span><span>,</span> <span>-</span><span>d</span><span>));</span>
</span></span><span><span>            
</span></span><span><span>            <span>// under eye lines</span>
</span></span><span><span>            <span>bool</span> <span>should_show</span> <span>=</span> <span>pixel</span><span>.</span><span>y</span> <span>&lt;</span> <span>0.25</span> <span>&amp;&amp;</span> 
</span></span><span><span>                <span>(</span><span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.29</span><span>)</span> <span>&lt;</span> <span>.05</span> <span>||</span> 
</span></span><span><span>                <span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>-</span><span>.12</span><span>)</span> <span>&lt;</span> <span>.085</span><span>);</span>
</span></span><span><span>            <span>if</span> <span>(</span><span>abs</span><span>(</span><span>d</span> <span>-</span> <span>.04</span><span>)</span> <span>&lt;</span> <span>.0055</span> <span>&amp;&amp;</span> <span>should_show</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>
</span></span><span><span>        <span>}</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>  
</span></span><span><span>    <span>// Rest of face</span>
</span></span><span><span>    <span>{</span> <span>// fold</span>
</span></span><span><span>        <span>// Mouth</span>
</span></span><span><span>        <span>float</span> <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>pixel</span><span>,</span>  
</span></span><span><span>                     <span>vec2</span><span>(</span><span>-</span><span>.26</span><span>,</span> <span>-</span><span>.28</span><span>),</span> 
</span></span><span><span>                     <span>vec2</span><span>(</span><span>-</span><span>.05</span><span>,</span><span>-</span><span>.42</span><span>),</span> 
</span></span><span><span>                     <span>vec2</span><span>(</span><span>.115</span><span>,</span> <span>-</span><span>.25</span><span>));</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.11</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>// Teeth</span>
</span></span><span><span>            <span>float</span> <span>width</span> <span>=</span> <span>.065</span><span>;</span>
</span></span><span><span>            <span>vec2</span> <span>teeth</span> <span>=</span> <span>pixel</span><span>;</span>
</span></span><span><span>            <span>teeth</span><span>.</span><span>x</span> <span>=</span> <span>mod</span><span>(</span><span>teeth</span><span>.</span><span>x</span><span>,</span> <span>width</span><span>)</span><span>-</span><span>width</span><span>*</span><span>.5</span><span>;</span>
</span></span><span><span>            <span>teeth</span><span>.</span><span>y</span> <span>-=</span> <span>pow</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.09</span><span>,</span> <span>2.</span><span>)</span> <span>*</span> <span>1.5</span> <span>-</span> <span>.34</span><span>;</span>
</span></span><span><span>            <span>teeth</span><span>.</span><span>y</span> <span>=</span> <span>abs</span><span>(</span><span>teeth</span><span>.</span><span>y</span><span>)</span><span>-</span><span>.06</span><span>;</span>
</span></span><span><span>            <span>d</span> <span>=</span> <span>parabola</span><span>(</span><span>teeth</span><span>,</span> <span>38.</span><span>);</span>
</span></span><span><span>            <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span> <span>&amp;&amp;</span> <span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.06</span><span>)</span> <span>&lt;</span> <span>.194</span><span>)</span> 
</span></span><span><span>                <span>return</span> <span>vec3</span><span>(</span><span>0.902</span><span>,</span> <span>0.890</span><span>,</span> <span>0.729</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.01</span><span>);</span>
</span></span><span><span>          
</span></span><span><span>            <span>// Tongue</span>
</span></span><span><span>            <span>// `map()` is used to change the thickness of </span>
</span></span><span><span>            <span>// the tongue along the x axis</span>
</span></span><span><span>            <span>vec2</span> <span>tongue</span> <span>=</span> <span>rotateAt</span><span>(</span><span>pixel</span><span>,</span> <span>sin</span><span>(</span><span>time</span><span>*</span><span>2.</span><span>-</span><span>1.5</span><span>)</span><span>*</span><span>.15</span><span>+</span><span>.1</span><span>,</span> <span>vec2</span><span>(</span><span>0</span><span>,</span><span>-</span><span>.5</span><span>));</span>
</span></span><span><span>            <span>float</span> <span>tongue_thickness</span> <span>=</span> <span>map</span><span>(</span><span>tongue</span><span>.</span><span>x</span><span>,</span> <span>-</span><span>.16</span><span>,</span> <span>.01</span><span>,</span> <span>.02</span><span>,</span> <span>.045</span><span>);</span>
</span></span><span><span>            <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>tongue</span><span>,</span>  
</span></span><span><span>                <span>vec2</span><span>(</span><span>-</span><span>.16</span><span>,</span> <span>-</span><span>.35</span><span>),</span> 
</span></span><span><span>                <span>vec2</span><span>(</span><span>.001</span><span>,</span><span>-</span><span>.33</span><span>),</span> 
</span></span><span><span>                <span>vec2</span><span>(</span><span>.01</span><span>,</span> <span>-</span><span>.5</span><span>))</span> <span>-</span> <span>tongue_thickness</span><span>;</span>
</span></span><span><span>            <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0</span><span>)</span> 
</span></span><span><span>                <span>return</span> <span>vec3</span><span>(</span><span>0.816</span><span>,</span> <span>0.302</span><span>,</span> <span>0.275</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>0.01</span><span>);</span>
</span></span><span><span>              
</span></span><span><span>            <span>// mouth fill color</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>.42</span><span>,</span> <span>.147</span><span>,</span> <span>.152</span><span>);</span> 
</span></span><span><span>        <span>}</span> 
</span></span><span><span>        
</span></span><span><span>        <span>// lip outlines</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.12</span> <span>||</span> <span>(</span><span>abs</span><span>(</span><span>d</span><span>-</span><span>.16</span><span>)</span> <span>&lt;</span> <span>.005</span> 
</span></span><span><span>                        <span>&amp;&amp;</span> <span>(</span><span>pixel</span><span>.</span><span>x</span><span>*-</span><span>6.4</span> <span>&gt;</span> <span>-</span><span>pixel</span><span>.</span><span>y</span><span>+</span><span>1.6</span> 
</span></span><span><span>                          <span>||</span> <span>pixel</span><span>.</span><span>x</span><span>*</span><span>1.7</span> <span>&gt;</span> <span>-</span><span>pixel</span><span>.</span><span>y</span><span>+</span><span>.1</span> 
</span></span><span><span>                          <span>||</span> <span>pixel</span><span>.</span><span>y</span> <span>&lt;</span> <span>-</span><span>0.49</span><span>)))</span> 
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span> 
</span></span><span><span>        
</span></span><span><span>        <span>// lips</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.16</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>.838</span><span>,</span> <span>.799</span><span>,</span> <span>0.76</span><span>);</span>
</span></span><span><span>       
</span></span><span><span>        
</span></span><span><span>    
</span></span><span><span>        <span>// Nose  </span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>min</span><span>(</span>
</span></span><span><span>                <span>bezier</span><span>(</span><span>pixel</span><span>,</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.15</span><span>,</span> <span>-</span><span>.13</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.21</span><span>,</span><span>-</span><span>.14</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.14</span><span>,</span> <span>.08</span><span>)),</span>
</span></span><span><span>                <span>bezier</span><span>(</span><span>pixel</span><span>,</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.085</span><span>,</span> <span>-</span><span>.01</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.12</span><span>,</span> <span>-</span><span>.13</span><span>),</span>
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.15</span><span>,</span><span>-</span><span>.13</span><span>)));</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0055</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>
</span></span><span><span>    <span>// Eyebrow</span>
</span></span><span><span>    <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>pixel</span><span>,</span>  
</span></span><span><span>            <span>vec2</span><span>(</span><span>-</span><span>.34</span><span>,</span> <span>.38</span><span>),</span> 
</span></span><span><span>            <span>// NEW animate the middle up and down</span>
</span></span><span><span>            <span>vec2</span><span>(</span><span>-</span><span>.05</span><span>,</span> <span>0.5</span> <span>+</span> <span>cos</span><span>(</span><span>time</span><span>)</span><span>*</span><span>.1</span><span>),</span>
</span></span><span><span>            <span>vec2</span><span>(</span><span>.205</span><span>,</span> <span>.36</span><span>))</span> <span>-</span> <span>0.035</span><span>;</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0</span><span>)</span> 
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>.71</span><span>,</span> <span>.839</span><span>,</span> <span>.922</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.013</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>        <span>d</span> <span>=</span> <span>min</span><span>(</span>
</span></span><span><span>            <span>// Head</span>
</span></span><span><span>            <span>round_rect</span><span>(</span>
</span></span><span><span>            <span>pixel</span><span>,</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.36</span><span>,</span> <span>.6385</span><span>),</span> 
</span></span><span><span>            <span>vec4</span><span>(</span><span>.34</span><span>,</span> <span>.415</span><span>,</span> <span>.363</span><span>,</span> <span>.315</span><span>)),</span>
</span></span><span><span>            
</span></span><span><span>            <span>// Ear</span>
</span></span><span><span>            <span>round_rect</span><span>(</span>
</span></span><span><span>            <span>pixel</span> <span>+</span> <span>vec2</span><span>(</span><span>-</span><span>.32</span><span>,</span> <span>.15</span><span>),</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.15</span><span>,</span> <span>0.12</span><span>),</span> 
</span></span><span><span>            <span>vec4</span><span>(</span><span>.13</span><span>,</span><span>.1</span><span>,</span><span>.13</span><span>,</span><span>.13</span><span>))</span>
</span></span><span><span>        <span>);</span>
</span></span><span><span>            
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>.838</span><span>,</span> <span>.799</span><span>,</span> <span>.76</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.01</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>        <span>// Hair</span>
</span></span><span><span>        <span>vec2</span> <span>hair</span> <span>=</span> <span>pixel</span><span>;</span>
</span></span><span><span>        <span>hair</span> <span>-=</span> <span>vec2</span><span>(</span><span>.08</span><span>,</span><span>.15</span><span>);</span>
</span></span><span><span>        <span>hair</span><span>.</span><span>x</span> <span>*=</span> <span>1.3</span><span>;</span>
</span></span><span><span>        <span>hair</span> <span>=</span> <span>warp</span><span>(</span><span>hair</span><span>,</span> <span>4.0</span><span>,</span> <span>0.07</span><span>);</span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>star</span><span>(</span><span>hair</span><span>,</span> <span>0.95</span><span>,</span> <span>11.</span><span>,</span> <span>.28</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>0.682</span><span>,</span> <span>0.839</span><span>,</span> <span>0.929</span><span>)</span><span>*</span><span>step</span><span>(</span><span>0.012</span><span>,</span> <span>-</span><span>d</span><span>);</span>
</span></span><span><span>        <span>}</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>    
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>1</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Make the pupil movement <a href="https://www.youtube.com/watch?v=Fmg9ZOHESgQ" target="_blank" rel="noopener">more realistic</a> instead of jumping between positions</p><h3 id="bonus-warping-time">Bonus: Warping Time</h3><p>Our final animation technique is “time domain warping” to make the hair bend as the head tilts. It’s like domain warping, except instead of offsetting <em>space</em> we offset <em>time</em>. Basically we delay time more the closer to the hair tip a pixel is. Because that delay isn’t constant along the length of the hair, the hair will bend instead of rotate rigidly.</p><div><pre tabindex="0"><code data-lang="glsl"><span><span>
</span></span><span><span><span>vec2</span> <span>rotateAt</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>angle</span><span>,</span> <span>vec2</span> <span>origin</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>float</span> <span>s</span> <span>=</span> <span>sin</span><span>(</span><span>angle</span><span>),</span> <span>c</span> <span>=</span> <span>cos</span><span>(</span><span>angle</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>(</span><span>p</span><span>-</span><span>origin</span><span>)</span><span>*</span><span>mat2</span><span>(</span> <span>c</span><span>,</span> <span>-</span><span>s</span><span>,</span> <span>s</span><span>,</span> <span>c</span> <span>)</span> <span>+</span> <span>origin</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>map</span><span>(</span><span>float</span> <span>value</span><span>,</span> <span>float</span> <span>inMin</span><span>,</span> <span>float</span> <span>inMax</span><span>,</span> <span>float</span> <span>outMin</span><span>,</span> <span>float</span> <span>outMax</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>  <span>value</span> <span>=</span> <span>clamp</span><span>(</span><span>value</span><span>,</span> <span>inMin</span><span>,</span> <span>inMax</span><span>);</span>
</span></span><span><span>  <span>return</span> <span>outMin</span> <span>+</span> <span>(</span><span>outMax</span> <span>-</span> <span>outMin</span><span>)</span> <span>*</span> <span>(</span><span>value</span> <span>-</span> <span>inMin</span><span>)</span> <span>/</span> <span>(</span><span>inMax</span> <span>-</span> <span>inMin</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>vec2</span> <span>grad</span><span>(</span><span>ivec2</span> <span>z</span><span>)</span>  <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>int</span> <span>n</span> <span>=</span> <span>z</span><span>.</span><span>x</span><span>+</span><span>z</span><span>.</span><span>y</span><span>*</span><span>11111</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>=</span> <span>(</span><span>n</span><span>&lt;&lt;</span><span>13</span><span>)</span><span>^</span><span>n</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>=</span> <span>(</span><span>n</span><span>*</span><span>(</span><span>n</span><span>*</span><span>n</span><span>*</span><span>15731</span><span>+</span><span>789221</span><span>)</span><span>+</span><span>1376312589</span><span>)</span><span>&gt;&gt;</span><span>16</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>&amp;=</span> <span>7</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>gr</span> <span>=</span> <span>vec2</span><span>(</span><span>n</span><span>&amp;</span><span>1</span><span>,</span><span>n</span><span>&gt;&gt;</span><span>1</span><span>)</span><span>*</span><span>2.0</span><span>-</span><span>1.0</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>(</span> <span>n</span><span>&gt;=</span><span>6</span> <span>)</span> <span>?</span> <span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>gr</span><span>.</span><span>x</span><span>)</span> <span>:</span> 
</span></span><span><span>           <span>(</span> <span>n</span><span>&gt;=</span><span>4</span> <span>)</span> <span>?</span> <span>vec2</span><span>(</span><span>gr</span><span>.</span><span>x</span><span>,</span><span>0.0</span><span>)</span> <span>:</span>
</span></span><span><span>                              <span>gr</span><span>;</span>                            
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>noise</span><span>(</span><span>vec2</span> <span>p</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>ivec2</span> <span>i</span> <span>=</span> <span>ivec2</span><span>(</span><span>floor</span><span>(</span><span>p</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>f</span> <span>=</span>       <span>fract</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>vec2</span> <span>u</span> <span>=</span> <span>f</span><span>*</span><span>f</span><span>*</span><span>(</span><span>3.0</span><span>-</span><span>2.0</span><span>*</span><span>f</span><span>);</span> 
</span></span><span><span>    <span>return</span> <span>mix</span><span>(</span> <span>mix</span><span>(</span> <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>0</span><span>,</span><span>0</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>0.0</span><span>)</span> <span>),</span> 
</span></span><span><span>                     <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>1</span><span>,</span><span>0</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>1.0</span><span>,</span><span>0.0</span><span>)</span> <span>),</span> <span>u</span><span>.</span><span>x</span><span>),</span>
</span></span><span><span>                <span>mix</span><span>(</span> <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>0</span><span>,</span><span>1</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>1.0</span><span>)</span> <span>),</span> 
</span></span><span><span>                     <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>1</span><span>,</span><span>1</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>1.0</span><span>,</span><span>1.0</span><span>)</span> <span>),</span> <span>u</span><span>.</span><span>x</span><span>),</span> <span>u</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>vec2</span> <span>warp</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>scale</span><span>,</span> <span>float</span> <span>strength</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>float</span> <span>offsetX</span> <span>=</span> <span>noise</span><span>(</span><span>p</span> <span>*</span> <span>scale</span> <span>+</span> <span>vec2</span><span>(</span><span>0.0</span><span>,</span> <span>100.0</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>offsetY</span> <span>=</span> <span>noise</span><span>(</span><span>p</span> <span>*</span> <span>scale</span> <span>+</span> <span>vec2</span><span>(</span><span>100.0</span><span>,</span> <span>0.0</span><span>));</span>
</span></span><span><span>    <span>return</span> <span>p</span> <span>+</span> <span>vec2</span><span>(</span><span>offsetX</span><span>,</span> <span>offsetY</span><span>)</span> <span>*</span> <span>strength</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>bezier</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>v0</span><span>,</span> <span>vec2</span> <span>v1</span><span>,</span> <span>vec2</span> <span>v2</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>vec2</span> <span>i</span> <span>=</span> <span>v0</span> <span>-</span> <span>v2</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>j</span> <span>=</span> <span>v2</span> <span>-</span> <span>v1</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>k</span> <span>=</span> <span>v1</span> <span>-</span> <span>v0</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>w</span> <span>=</span> <span>j</span><span>-</span><span>k</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>v0</span><span>-=</span> <span>p</span><span>;</span> <span>v1</span><span>-=</span> <span>p</span><span>;</span> <span>v2</span><span>-=</span> <span>p</span><span>;</span>
</span></span><span><span>    
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>v0</span><span>.</span><span>x</span><span>*</span><span>v2</span><span>.</span><span>y</span><span>-</span><span>v0</span><span>.</span><span>y</span><span>*</span><span>v2</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>y</span> <span>=</span> <span>v1</span><span>.</span><span>x</span><span>*</span><span>v0</span><span>.</span><span>y</span><span>-</span><span>v1</span><span>.</span><span>y</span><span>*</span><span>v0</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>z</span> <span>=</span> <span>v2</span><span>.</span><span>x</span><span>*</span><span>v1</span><span>.</span><span>y</span><span>-</span><span>v2</span><span>.</span><span>y</span><span>*</span><span>v1</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>vec2</span> <span>s</span> <span>=</span> <span>2.0</span><span>*</span><span>(</span><span>y</span><span>*</span><span>j</span><span>+</span><span>z</span><span>*</span><span>k</span><span>)</span><span>-</span><span>x</span><span>*</span><span>i</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span>  <span>(</span><span>y</span><span>*</span><span>z</span><span>-</span><span>x</span><span>*</span><span>x</span><span>*</span><span>0.25</span><span>)</span><span>/</span><span>dot</span><span>(</span><span>s</span><span>,</span><span>s</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>t</span> <span>=</span> <span>clamp</span><span>(</span> <span>(</span><span>0.5</span><span>*</span><span>x</span><span>+</span><span>y</span><span>+</span><span>r</span><span>*</span><span>dot</span><span>(</span><span>s</span><span>,</span><span>w</span><span>))</span><span>/</span><span>(</span><span>x</span><span>+</span><span>y</span><span>+</span><span>z</span><span>),</span><span>0.0</span><span>,</span><span>1.0</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>vec2</span> <span>d</span> <span>=</span> <span>v0</span><span>+</span><span>t</span><span>*</span><span>(</span><span>k</span><span>+</span><span>k</span><span>+</span><span>t</span><span>*</span><span>w</span><span>);</span>
</span></span><span><span>    <span>vec2</span> <span>outQ</span> <span>=</span> <span>d</span> <span>+</span> <span>p</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>d</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>parabola</span><span>(</span><span>vec2</span> <span>pos</span><span>,</span> <span>float</span> <span>k</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// from https://www.shadertoy.com/view/ws3GD7</span>
</span></span><span><span>    <span>pos</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>ik</span> <span>=</span> <span>1.0</span><span>/</span><span>k</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>p</span> <span>=</span> <span>ik</span><span>*</span><span>(</span><span>pos</span><span>.</span><span>y</span> <span>-</span> <span>0.5</span><span>*</span><span>ik</span><span>)</span><span>/</span><span>3.0</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>q</span> <span>=</span> <span>0.25</span><span>*</span><span>ik</span><span>*</span><span>ik</span><span>*</span><span>pos</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>h</span> <span>=</span> <span>q</span><span>*</span><span>q</span> <span>-</span> <span>p</span><span>*</span><span>p</span><span>*</span><span>p</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span> <span>sqrt</span><span>(</span><span>abs</span><span>(</span><span>h</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>(</span><span>h</span><span>&gt;</span><span>0.0</span><span>)</span> <span>?</span> 
</span></span><span><span>        <span>pow</span><span>(</span><span>q</span><span>+</span><span>r</span><span>,</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span> <span>-</span> <span>pow</span><span>(</span><span>abs</span><span>(</span><span>q</span><span>-</span><span>r</span><span>),</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>r</span><span>-</span><span>q</span><span>)</span> <span>:</span>
</span></span><span><span>        <span>2.0</span><span>*</span><span>cos</span><span>(</span><span>atan</span><span>(</span><span>r</span><span>,</span><span>q</span><span>)</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sqrt</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>pos</span><span>-</span><span>vec2</span><span>(</span><span>x</span><span>,</span><span>k</span><span>*</span><span>x</span><span>*</span><span>x</span><span>))</span> <span>*</span> <span>sign</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>-</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>round_rect</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>b</span><span>,</span> <span>vec4</span> <span>r</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>r</span><span>.</span><span>xy</span> <span>=</span> <span>(</span><span>p</span><span>.</span><span>x</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>r</span><span>.</span><span>xy</span> <span>:</span> <span>r</span><span>.</span><span>zw</span><span>;</span>
</span></span><span><span>    <span>r</span><span>.</span><span>x</span>  <span>=</span> <span>(</span><span>p</span><span>.</span><span>y</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>r</span><span>.</span><span>x</span>  <span>:</span> <span>r</span><span>.</span><span>y</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>q</span> <span>=</span> <span>abs</span><span>(</span><span>p</span><span>)</span><span>-</span><span>b</span><span>+</span><span>r</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>min</span><span>(</span><span>max</span><span>(</span><span>q</span><span>.</span><span>x</span><span>,</span><span>q</span><span>.</span><span>y</span><span>),</span><span>0.0</span><span>)</span> <span>+</span> <span>length</span><span>(</span><span>max</span><span>(</span><span>q</span><span>,</span><span>0.0</span><span>))</span> <span>-</span> <span>r</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>star</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>r</span><span>,</span> <span>float</span> <span>points</span><span>,</span> <span>float</span> <span>ratio</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// next 4 lines can be precomputed for a given shape</span>
</span></span><span><span>    <span>float</span> <span>an</span> <span>=</span> <span>3.141593</span><span>/</span><span>points</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>en</span> <span>=</span> <span>3.141593</span><span>/</span><span>(</span><span>ratio</span><span>*</span><span>(</span><span>points</span><span>-</span><span>2.</span><span>)</span> <span>+</span> <span>2.</span><span>);</span> 
</span></span><span><span>    <span>vec2</span>  <span>acs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>an</span><span>),</span><span>sin</span><span>(</span><span>an</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>ecs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>en</span><span>),</span><span>sin</span><span>(</span><span>en</span><span>));</span> <span>// ecs=vec2(0,1) for regular polygon</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>bn</span> <span>=</span> <span>mod</span><span>(</span><span>atan</span><span>(</span><span>p</span><span>.</span><span>x</span><span>,</span><span>p</span><span>.</span><span>y</span><span>),</span><span>2.0</span><span>*</span><span>an</span><span>)</span> <span>-</span> <span>an</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>=</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>vec2</span><span>(</span><span>cos</span><span>(</span><span>bn</span><span>),</span><span>abs</span><span>(</span><span>sin</span><span>(</span><span>bn</span><span>)));</span>
</span></span><span><span>    <span>p</span> <span>-=</span> <span>r</span><span>*</span><span>acs</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>+=</span> <span>ecs</span><span>*</span><span>clamp</span><span>(</span> <span>-</span><span>dot</span><span>(</span><span>p</span><span>,</span><span>ecs</span><span>),</span> <span>0.0</span><span>,</span> <span>r</span><span>*</span><span>acs</span><span>.</span><span>y</span><span>/</span><span>ecs</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>p</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span> 
</span></span><span><span>    <span>{</span> <span>// fold</span>
</span></span><span><span>        <span>// rotate the whole drawing</span>
</span></span><span><span>        <span>pixel</span> <span>=</span> <span>rotateAt</span><span>(</span><span>pixel</span><span>,</span> <span>sin</span><span>(</span><span>time</span><span>*</span><span>2.</span><span>)</span><span>*</span><span>.1</span><span>,</span> <span>vec2</span><span>(</span><span>0</span><span>,</span><span>-</span><span>.6</span><span>));</span>
</span></span><span><span>        <span>pixel</span><span>.</span><span>y</span> <span>+=</span> <span>.1</span><span>;</span>
</span></span><span><span>    
</span></span><span><span>    
</span></span><span><span>    <span>// Blink eyes</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>mod</span><span>(</span><span>time</span><span>,</span> <span>2.</span><span>)</span> <span>&lt;</span> <span>.09</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>// closed eyes</span>
</span></span><span><span>        <span>float</span> <span>d</span> <span>=</span> <span>round_rect</span><span>(</span><span>pixel</span><span>+</span><span>vec2</span><span>(</span><span>.07</span><span>,</span><span>-</span><span>.16</span><span>),</span> <span>vec2</span><span>(</span><span>.24</span><span>,</span><span>0</span><span>),</span> <span>vec4</span><span>(</span><span>0</span><span>));</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.008</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>      
</span></span><span><span>    <span>}</span> 
</span></span><span><span>    <span>else</span> <span>{</span> 
</span></span><span><span>        <span>// move pupils randomly</span>
</span></span><span><span>        <span>vec2</span> <span>pupil_warp</span> <span>=</span> <span>pixel</span> <span>+</span> <span>vec2</span><span>(</span><span>.095</span><span>,</span><span>-</span><span>.18</span><span>);</span>
</span></span><span><span>        <span>pupil_warp</span><span>.</span><span>x</span> <span>-=</span> <span>noise</span><span>(</span><span>vec2</span><span>(</span><span>round</span><span>(</span><span>time</span><span>)</span><span>*</span><span>7.</span><span>+</span><span>.5</span><span>,</span> <span>0.5</span><span>))</span><span>*</span><span>.1</span><span>;</span>
</span></span><span><span>        <span>pupil_warp</span><span>.</span><span>y</span> <span>-=</span> <span>noise</span><span>(</span><span>vec2</span><span>(</span><span>round</span><span>(</span><span>time</span><span>)</span><span>*</span><span>9.</span><span>+</span><span>.5</span><span>,</span> <span>0.5</span><span>))</span><span>*</span><span>.1</span><span>;</span>
</span></span><span><span>        <span>pupil_warp</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pupil_warp</span><span>.</span><span>x</span><span>)</span> <span>-</span> <span>.16</span><span>;</span>
</span></span><span><span>        <span>float</span> <span>d</span> <span>=</span> <span>star</span><span>(</span><span>pupil_warp</span><span>,</span> <span>0.019</span><span>,</span> <span>6.</span><span>,</span> <span>.9</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.007</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>.1</span><span>);</span>
</span></span><span><span>        <span>}</span>
</span></span><span><span>            
</span></span><span><span>        <span>// Eyeballs</span>
</span></span><span><span>        <span>vec2</span> <span>eye</span> <span>=</span> <span>vec2</span><span>(</span><span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.1</span><span>)</span><span>-</span><span>.17</span><span>,</span> <span>pixel</span><span>.</span><span>y</span><span>*</span><span>.93</span> <span>-</span> <span>.16</span><span>);</span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>length</span><span>(</span><span>eye</span><span>)</span> <span>-</span> <span>.16</span><span>;</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>step</span><span>(</span><span>.013</span><span>,</span> <span>-</span><span>d</span><span>));</span>
</span></span><span><span>        
</span></span><span><span>        <span>// under eye lines</span>
</span></span><span><span>        <span>bool</span> <span>should_show</span> <span>=</span> <span>pixel</span><span>.</span><span>y</span> <span>&lt;</span> <span>0.25</span> <span>&amp;&amp;</span> 
</span></span><span><span>            <span>(</span><span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.29</span><span>)</span> <span>&lt;</span> <span>.05</span> <span>||</span> 
</span></span><span><span>            <span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>-</span><span>.12</span><span>)</span> <span>&lt;</span> <span>.085</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>abs</span><span>(</span><span>d</span> <span>-</span> <span>.04</span><span>)</span> <span>&lt;</span> <span>.0055</span> <span>&amp;&amp;</span> <span>should_show</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>  
</span></span><span><span>    
</span></span><span><span>        <span>// Mouth</span>
</span></span><span><span>        <span>float</span> <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>pixel</span><span>,</span>  
</span></span><span><span>                     <span>vec2</span><span>(</span><span>-</span><span>.26</span><span>,</span> <span>-</span><span>.28</span><span>),</span> 
</span></span><span><span>                     <span>vec2</span><span>(</span><span>-</span><span>.05</span><span>,</span><span>-</span><span>.42</span><span>),</span> 
</span></span><span><span>                     <span>vec2</span><span>(</span><span>.115</span><span>,</span> <span>-</span><span>.25</span><span>));</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.11</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>// Teeth</span>
</span></span><span><span>            <span>float</span> <span>width</span> <span>=</span> <span>.065</span><span>;</span>
</span></span><span><span>            <span>vec2</span> <span>teeth</span> <span>=</span> <span>pixel</span><span>;</span>
</span></span><span><span>            <span>teeth</span><span>.</span><span>x</span> <span>=</span> <span>mod</span><span>(</span><span>teeth</span><span>.</span><span>x</span><span>,</span> <span>width</span><span>)</span><span>-</span><span>width</span><span>*</span><span>.5</span><span>;</span>
</span></span><span><span>            <span>teeth</span><span>.</span><span>y</span> <span>-=</span> <span>pow</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.09</span><span>,</span> <span>2.</span><span>)</span> <span>*</span> <span>1.5</span> <span>-</span> <span>.34</span><span>;</span>
</span></span><span><span>            <span>teeth</span><span>.</span><span>y</span> <span>=</span> <span>abs</span><span>(</span><span>teeth</span><span>.</span><span>y</span><span>)</span><span>-</span><span>.06</span><span>;</span>
</span></span><span><span>            <span>d</span> <span>=</span> <span>parabola</span><span>(</span><span>teeth</span><span>,</span> <span>38.</span><span>);</span>
</span></span><span><span>            <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span> <span>&amp;&amp;</span> <span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.06</span><span>)</span> <span>&lt;</span> <span>.194</span><span>)</span> 
</span></span><span><span>                <span>return</span> <span>vec3</span><span>(</span><span>0.902</span><span>,</span> <span>0.890</span><span>,</span> <span>0.729</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.01</span><span>);</span>
</span></span><span><span>          
</span></span><span><span>            <span>// Tongue</span>
</span></span><span><span>            <span>// `map()` is used to change the thickness of </span>
</span></span><span><span>            <span>// the tongue along the x axis</span>
</span></span><span><span>            <span>vec2</span> <span>tongue</span> <span>=</span> <span>rotateAt</span><span>(</span><span>pixel</span><span>,</span> <span>sin</span><span>(</span><span>time</span><span>*</span><span>2.</span><span>-</span><span>1.5</span><span>)</span><span>*</span><span>.15</span><span>+</span><span>.1</span><span>,</span> <span>vec2</span><span>(</span><span>0</span><span>,</span><span>-</span><span>.5</span><span>));</span>
</span></span><span><span>            <span>float</span> <span>tongue_thickness</span> <span>=</span> <span>map</span><span>(</span><span>tongue</span><span>.</span><span>x</span><span>,</span> <span>-</span><span>.16</span><span>,</span> <span>.01</span><span>,</span> <span>.02</span><span>,</span> <span>.045</span><span>);</span>
</span></span><span><span>            <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>tongue</span><span>,</span>  
</span></span><span><span>                <span>vec2</span><span>(</span><span>-</span><span>.16</span><span>,</span> <span>-</span><span>.35</span><span>),</span> 
</span></span><span><span>                <span>vec2</span><span>(</span><span>.001</span><span>,</span><span>-</span><span>.33</span><span>),</span> 
</span></span><span><span>                <span>vec2</span><span>(</span><span>.01</span><span>,</span> <span>-</span><span>.5</span><span>))</span> <span>-</span> <span>tongue_thickness</span><span>;</span>
</span></span><span><span>            <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0</span><span>)</span> 
</span></span><span><span>                <span>return</span> <span>vec3</span><span>(</span><span>0.816</span><span>,</span> <span>0.302</span><span>,</span> <span>0.275</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>0.01</span><span>);</span>
</span></span><span><span>              
</span></span><span><span>            <span>// mouth fill color</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>.42</span><span>,</span> <span>.147</span><span>,</span> <span>.152</span><span>);</span> 
</span></span><span><span>        <span>}</span> 
</span></span><span><span>        
</span></span><span><span>        <span>// lip outlines</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.12</span> <span>||</span> <span>(</span><span>abs</span><span>(</span><span>d</span><span>-</span><span>.16</span><span>)</span> <span>&lt;</span> <span>.005</span> 
</span></span><span><span>                        <span>&amp;&amp;</span> <span>(</span><span>pixel</span><span>.</span><span>x</span><span>*-</span><span>6.4</span> <span>&gt;</span> <span>-</span><span>pixel</span><span>.</span><span>y</span><span>+</span><span>1.6</span> 
</span></span><span><span>                          <span>||</span> <span>pixel</span><span>.</span><span>x</span><span>*</span><span>1.7</span> <span>&gt;</span> <span>-</span><span>pixel</span><span>.</span><span>y</span><span>+</span><span>.1</span> 
</span></span><span><span>                          <span>||</span> <span>pixel</span><span>.</span><span>y</span> <span>&lt;</span> <span>-</span><span>0.49</span><span>)))</span> 
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span> 
</span></span><span><span>        
</span></span><span><span>        <span>// lips</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.16</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>.838</span><span>,</span> <span>.799</span><span>,</span> <span>0.76</span><span>);</span>
</span></span><span><span>       
</span></span><span><span>        
</span></span><span><span>    
</span></span><span><span>        <span>// Nose  </span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>min</span><span>(</span>
</span></span><span><span>                <span>bezier</span><span>(</span><span>pixel</span><span>,</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.15</span><span>,</span> <span>-</span><span>.13</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.21</span><span>,</span><span>-</span><span>.14</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.14</span><span>,</span> <span>.08</span><span>)),</span>
</span></span><span><span>                <span>bezier</span><span>(</span><span>pixel</span><span>,</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.085</span><span>,</span> <span>-</span><span>.01</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.12</span><span>,</span> <span>-</span><span>.13</span><span>),</span>
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.15</span><span>,</span><span>-</span><span>.13</span><span>)));</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0055</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>
</span></span><span><span>    <span>// Eyebrow</span>
</span></span><span><span>    <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>pixel</span><span>,</span>  
</span></span><span><span>            <span>vec2</span><span>(</span><span>-</span><span>.34</span><span>,</span> <span>.38</span><span>),</span> 
</span></span><span><span>            <span>// NEW animate the middle up and down</span>
</span></span><span><span>            <span>vec2</span><span>(</span><span>-</span><span>.05</span><span>,</span> <span>0.5</span> <span>+</span> <span>cos</span><span>(</span><span>time</span><span>)</span><span>*</span><span>.1</span><span>),</span>
</span></span><span><span>            <span>vec2</span><span>(</span><span>.205</span><span>,</span> <span>.36</span><span>))</span> <span>-</span> <span>0.035</span><span>;</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0</span><span>)</span> 
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>.71</span><span>,</span> <span>.839</span><span>,</span> <span>.922</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.013</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>        <span>d</span> <span>=</span> <span>min</span><span>(</span>
</span></span><span><span>            <span>// Head</span>
</span></span><span><span>            <span>round_rect</span><span>(</span>
</span></span><span><span>            <span>pixel</span><span>,</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.36</span><span>,</span> <span>.6385</span><span>),</span> 
</span></span><span><span>            <span>vec4</span><span>(</span><span>.34</span><span>,</span> <span>.415</span><span>,</span> <span>.363</span><span>,</span> <span>.315</span><span>)),</span>
</span></span><span><span>            
</span></span><span><span>            <span>// Ear</span>
</span></span><span><span>            <span>round_rect</span><span>(</span>
</span></span><span><span>            <span>pixel</span> <span>+</span> <span>vec2</span><span>(</span><span>-</span><span>.32</span><span>,</span> <span>.15</span><span>),</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.15</span><span>,</span> <span>0.12</span><span>),</span> 
</span></span><span><span>            <span>vec4</span><span>(</span><span>.13</span><span>,</span><span>.1</span><span>,</span><span>.13</span><span>,</span><span>.13</span><span>))</span>
</span></span><span><span>        <span>);</span>
</span></span><span><span>            
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>.838</span><span>,</span> <span>.799</span><span>,</span> <span>.76</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.01</span><span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>    
</span></span><span><span>    <span>// Hair     </span>
</span></span><span><span>    <span>float</span> <span>twist</span> <span>=</span> <span>sin</span><span>(</span><span>time</span><span>*</span><span>2.</span><span>-</span><span>length</span><span>(</span><span>pixel</span><span>)</span><span>*</span><span>2.1</span><span>)</span><span>*</span><span>.12</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>hair</span> <span>=</span> <span>rotateAt</span><span>(</span><span>pixel</span><span>,</span> <span>twist</span><span>,</span> <span>vec2</span><span>(</span><span>0.</span><span>,</span><span>.1</span><span>));</span>
</span></span><span><span>    <span>hair</span> <span>-=</span> <span>vec2</span><span>(</span><span>.08</span><span>,</span><span>.15</span><span>);</span>
</span></span><span><span>    <span>hair</span><span>.</span><span>x</span> <span>*=</span> <span>1.3</span><span>;</span>
</span></span><span><span>    <span>hair</span> <span>=</span> <span>warp</span><span>(</span><span>hair</span><span>,</span> <span>4.0</span><span>,</span> <span>0.07</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>d</span> <span>=</span> <span>star</span><span>(</span><span>hair</span><span>,</span> <span>0.95</span><span>,</span> <span>11.</span><span>,</span> <span>.28</span><span>);</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>0.682</span><span>,</span> <span>0.839</span><span>,</span> <span>0.929</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>0.012</span><span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>    
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>1</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Apply this trick to to other parts of Rick’s face for a rubbery and ricklaxed look.</p><h2 id="wrapping-up">Wrapping up</h2><p>After we add a portal effect<sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup> our animation is complete.</p><div><pre tabindex="0"><code data-lang="glsl"><span><span>
</span></span><span><span><span>vec2</span> <span>rotateAt</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>angle</span><span>,</span> <span>vec2</span> <span>origin</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>float</span> <span>s</span> <span>=</span> <span>sin</span><span>(</span><span>angle</span><span>),</span> <span>c</span> <span>=</span> <span>cos</span><span>(</span><span>angle</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>(</span><span>p</span><span>-</span><span>origin</span><span>)</span><span>*</span><span>mat2</span><span>(</span> <span>c</span><span>,</span> <span>-</span><span>s</span><span>,</span> <span>s</span><span>,</span> <span>c</span> <span>)</span> <span>+</span> <span>origin</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>map</span><span>(</span><span>float</span> <span>value</span><span>,</span> <span>float</span> <span>inMin</span><span>,</span> <span>float</span> <span>inMax</span><span>,</span> <span>float</span> <span>outMin</span><span>,</span> <span>float</span> <span>outMax</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>  <span>value</span> <span>=</span> <span>clamp</span><span>(</span><span>value</span><span>,</span> <span>inMin</span><span>,</span> <span>inMax</span><span>);</span>
</span></span><span><span>  <span>return</span> <span>outMin</span> <span>+</span> <span>(</span><span>outMax</span> <span>-</span> <span>outMin</span><span>)</span> <span>*</span> <span>(</span><span>value</span> <span>-</span> <span>inMin</span><span>)</span> <span>/</span> <span>(</span><span>inMax</span> <span>-</span> <span>inMin</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>vec2</span> <span>grad</span><span>(</span><span>ivec2</span> <span>z</span><span>)</span>  <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>int</span> <span>n</span> <span>=</span> <span>z</span><span>.</span><span>x</span><span>+</span><span>z</span><span>.</span><span>y</span><span>*</span><span>11111</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>=</span> <span>(</span><span>n</span><span>&lt;&lt;</span><span>13</span><span>)</span><span>^</span><span>n</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>=</span> <span>(</span><span>n</span><span>*</span><span>(</span><span>n</span><span>*</span><span>n</span><span>*</span><span>15731</span><span>+</span><span>789221</span><span>)</span><span>+</span><span>1376312589</span><span>)</span><span>&gt;&gt;</span><span>16</span><span>;</span>
</span></span><span><span>    <span>n</span> <span>&amp;=</span> <span>7</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>gr</span> <span>=</span> <span>vec2</span><span>(</span><span>n</span><span>&amp;</span><span>1</span><span>,</span><span>n</span><span>&gt;&gt;</span><span>1</span><span>)</span><span>*</span><span>2.0</span><span>-</span><span>1.0</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>(</span> <span>n</span><span>&gt;=</span><span>6</span> <span>)</span> <span>?</span> <span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>gr</span><span>.</span><span>x</span><span>)</span> <span>:</span> 
</span></span><span><span>           <span>(</span> <span>n</span><span>&gt;=</span><span>4</span> <span>)</span> <span>?</span> <span>vec2</span><span>(</span><span>gr</span><span>.</span><span>x</span><span>,</span><span>0.0</span><span>)</span> <span>:</span>
</span></span><span><span>                              <span>gr</span><span>;</span>                            
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>noise</span><span>(</span><span>vec2</span> <span>p</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>ivec2</span> <span>i</span> <span>=</span> <span>ivec2</span><span>(</span><span>floor</span><span>(</span><span>p</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>f</span> <span>=</span>       <span>fract</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>vec2</span> <span>u</span> <span>=</span> <span>f</span><span>*</span><span>f</span><span>*</span><span>(</span><span>3.0</span><span>-</span><span>2.0</span><span>*</span><span>f</span><span>);</span> 
</span></span><span><span>    <span>return</span> <span>mix</span><span>(</span> <span>mix</span><span>(</span> <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>0</span><span>,</span><span>0</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>0.0</span><span>)</span> <span>),</span> 
</span></span><span><span>                     <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>1</span><span>,</span><span>0</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>1.0</span><span>,</span><span>0.0</span><span>)</span> <span>),</span> <span>u</span><span>.</span><span>x</span><span>),</span>
</span></span><span><span>                <span>mix</span><span>(</span> <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>0</span><span>,</span><span>1</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>0.0</span><span>,</span><span>1.0</span><span>)</span> <span>),</span> 
</span></span><span><span>                     <span>dot</span><span>(</span> <span>grad</span><span>(</span> <span>i</span><span>+</span><span>ivec2</span><span>(</span><span>1</span><span>,</span><span>1</span><span>)</span> <span>),</span> <span>f</span><span>-</span><span>vec2</span><span>(</span><span>1.0</span><span>,</span><span>1.0</span><span>)</span> <span>),</span> <span>u</span><span>.</span><span>x</span><span>),</span> <span>u</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>vec2</span> <span>warp</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>scale</span><span>,</span> <span>float</span> <span>strength</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>float</span> <span>offsetX</span> <span>=</span> <span>noise</span><span>(</span><span>p</span> <span>*</span> <span>scale</span> <span>+</span> <span>vec2</span><span>(</span><span>0.0</span><span>,</span> <span>100.0</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>offsetY</span> <span>=</span> <span>noise</span><span>(</span><span>p</span> <span>*</span> <span>scale</span> <span>+</span> <span>vec2</span><span>(</span><span>100.0</span><span>,</span> <span>0.0</span><span>));</span>
</span></span><span><span>    <span>return</span> <span>p</span> <span>+</span> <span>vec2</span><span>(</span><span>offsetX</span><span>,</span> <span>offsetY</span><span>)</span> <span>*</span> <span>strength</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>bezier</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>v0</span><span>,</span> <span>vec2</span> <span>v1</span><span>,</span> <span>vec2</span> <span>v2</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>vec2</span> <span>i</span> <span>=</span> <span>v0</span> <span>-</span> <span>v2</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>j</span> <span>=</span> <span>v2</span> <span>-</span> <span>v1</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>k</span> <span>=</span> <span>v1</span> <span>-</span> <span>v0</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>w</span> <span>=</span> <span>j</span><span>-</span><span>k</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>v0</span><span>-=</span> <span>p</span><span>;</span> <span>v1</span><span>-=</span> <span>p</span><span>;</span> <span>v2</span><span>-=</span> <span>p</span><span>;</span>
</span></span><span><span>    
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>v0</span><span>.</span><span>x</span><span>*</span><span>v2</span><span>.</span><span>y</span><span>-</span><span>v0</span><span>.</span><span>y</span><span>*</span><span>v2</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>y</span> <span>=</span> <span>v1</span><span>.</span><span>x</span><span>*</span><span>v0</span><span>.</span><span>y</span><span>-</span><span>v1</span><span>.</span><span>y</span><span>*</span><span>v0</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>z</span> <span>=</span> <span>v2</span><span>.</span><span>x</span><span>*</span><span>v1</span><span>.</span><span>y</span><span>-</span><span>v2</span><span>.</span><span>y</span><span>*</span><span>v1</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>vec2</span> <span>s</span> <span>=</span> <span>2.0</span><span>*</span><span>(</span><span>y</span><span>*</span><span>j</span><span>+</span><span>z</span><span>*</span><span>k</span><span>)</span><span>-</span><span>x</span><span>*</span><span>i</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span>  <span>(</span><span>y</span><span>*</span><span>z</span><span>-</span><span>x</span><span>*</span><span>x</span><span>*</span><span>0.25</span><span>)</span><span>/</span><span>dot</span><span>(</span><span>s</span><span>,</span><span>s</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>t</span> <span>=</span> <span>clamp</span><span>(</span> <span>(</span><span>0.5</span><span>*</span><span>x</span><span>+</span><span>y</span><span>+</span><span>r</span><span>*</span><span>dot</span><span>(</span><span>s</span><span>,</span><span>w</span><span>))</span><span>/</span><span>(</span><span>x</span><span>+</span><span>y</span><span>+</span><span>z</span><span>),</span><span>0.0</span><span>,</span><span>1.0</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    <span>vec2</span> <span>d</span> <span>=</span> <span>v0</span><span>+</span><span>t</span><span>*</span><span>(</span><span>k</span><span>+</span><span>k</span><span>+</span><span>t</span><span>*</span><span>w</span><span>);</span>
</span></span><span><span>    <span>vec2</span> <span>outQ</span> <span>=</span> <span>d</span> <span>+</span> <span>p</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>d</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>parabola</span><span>(</span><span>vec2</span> <span>pos</span><span>,</span> <span>float</span> <span>k</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// from https://www.shadertoy.com/view/ws3GD7</span>
</span></span><span><span>    <span>pos</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>ik</span> <span>=</span> <span>1.0</span><span>/</span><span>k</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>p</span> <span>=</span> <span>ik</span><span>*</span><span>(</span><span>pos</span><span>.</span><span>y</span> <span>-</span> <span>0.5</span><span>*</span><span>ik</span><span>)</span><span>/</span><span>3.0</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>q</span> <span>=</span> <span>0.25</span><span>*</span><span>ik</span><span>*</span><span>ik</span><span>*</span><span>pos</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>h</span> <span>=</span> <span>q</span><span>*</span><span>q</span> <span>-</span> <span>p</span><span>*</span><span>p</span><span>*</span><span>p</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>r</span> <span>=</span> <span>sqrt</span><span>(</span><span>abs</span><span>(</span><span>h</span><span>));</span>
</span></span><span><span>    <span>float</span> <span>x</span> <span>=</span> <span>(</span><span>h</span><span>&gt;</span><span>0.0</span><span>)</span> <span>?</span> 
</span></span><span><span>        <span>pow</span><span>(</span><span>q</span><span>+</span><span>r</span><span>,</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span> <span>-</span> <span>pow</span><span>(</span><span>abs</span><span>(</span><span>q</span><span>-</span><span>r</span><span>),</span><span>1.0</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>r</span><span>-</span><span>q</span><span>)</span> <span>:</span>
</span></span><span><span>        <span>2.0</span><span>*</span><span>cos</span><span>(</span><span>atan</span><span>(</span><span>r</span><span>,</span><span>q</span><span>)</span><span>/</span><span>3.0</span><span>)</span><span>*</span><span>sqrt</span><span>(</span><span>p</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>pos</span><span>-</span><span>vec2</span><span>(</span><span>x</span><span>,</span><span>k</span><span>*</span><span>x</span><span>*</span><span>x</span><span>))</span> <span>*</span> <span>sign</span><span>(</span><span>pos</span><span>.</span><span>x</span><span>-</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>round_rect</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>b</span><span>,</span> <span>vec4</span> <span>r</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>r</span><span>.</span><span>xy</span> <span>=</span> <span>(</span><span>p</span><span>.</span><span>x</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>r</span><span>.</span><span>xy</span> <span>:</span> <span>r</span><span>.</span><span>zw</span><span>;</span>
</span></span><span><span>    <span>r</span><span>.</span><span>x</span>  <span>=</span> <span>(</span><span>p</span><span>.</span><span>y</span><span>&gt;</span><span>0.0</span><span>)</span><span>?</span><span>r</span><span>.</span><span>x</span>  <span>:</span> <span>r</span><span>.</span><span>y</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>q</span> <span>=</span> <span>abs</span><span>(</span><span>p</span><span>)</span><span>-</span><span>b</span><span>+</span><span>r</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>min</span><span>(</span><span>max</span><span>(</span><span>q</span><span>.</span><span>x</span><span>,</span><span>q</span><span>.</span><span>y</span><span>),</span><span>0.0</span><span>)</span> <span>+</span> <span>length</span><span>(</span><span>max</span><span>(</span><span>q</span><span>,</span><span>0.0</span><span>))</span> <span>-</span> <span>r</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>float</span> <span>star</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>r</span><span>,</span> <span>float</span> <span>points</span><span>,</span> <span>float</span> <span>ratio</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// next 4 lines can be precomputed for a given shape</span>
</span></span><span><span>    <span>float</span> <span>an</span> <span>=</span> <span>3.141593</span><span>/</span><span>points</span><span>;</span>
</span></span><span><span>    <span>float</span> <span>en</span> <span>=</span> <span>3.141593</span><span>/</span><span>(</span><span>ratio</span><span>*</span><span>(</span><span>points</span><span>-</span><span>2.</span><span>)</span> <span>+</span> <span>2.</span><span>);</span> 
</span></span><span><span>    <span>vec2</span>  <span>acs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>an</span><span>),</span><span>sin</span><span>(</span><span>an</span><span>));</span>
</span></span><span><span>    <span>vec2</span>  <span>ecs</span> <span>=</span> <span>vec2</span><span>(</span><span>cos</span><span>(</span><span>en</span><span>),</span><span>sin</span><span>(</span><span>en</span><span>));</span> <span>// ecs=vec2(0,1) for regular polygon</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>bn</span> <span>=</span> <span>mod</span><span>(</span><span>atan</span><span>(</span><span>p</span><span>.</span><span>x</span><span>,</span><span>p</span><span>.</span><span>y</span><span>),</span><span>2.0</span><span>*</span><span>an</span><span>)</span> <span>-</span> <span>an</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>=</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>vec2</span><span>(</span><span>cos</span><span>(</span><span>bn</span><span>),</span><span>abs</span><span>(</span><span>sin</span><span>(</span><span>bn</span><span>)));</span>
</span></span><span><span>    <span>p</span> <span>-=</span> <span>r</span><span>*</span><span>acs</span><span>;</span>
</span></span><span><span>    <span>p</span> <span>+=</span> <span>ecs</span><span>*</span><span>clamp</span><span>(</span> <span>-</span><span>dot</span><span>(</span><span>p</span><span>,</span><span>ecs</span><span>),</span> <span>0.0</span><span>,</span> <span>r</span><span>*</span><span>acs</span><span>.</span><span>y</span><span>/</span><span>ecs</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>p</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>p</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>#define H(i,j) fract(sin(dot(ceil(P+vec2(i,j)), resolution.xy )) * 4e3)</span>
</span></span><span><span><span>float</span> <span>N</span><span>(</span> <span>vec2</span> <span>P</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>float</span> <span>s</span><span>,</span><span>i</span><span>,</span><span>w</span> <span>=</span> <span>.5</span><span>;</span>
</span></span><span><span>    <span>for</span> <span>(;</span> <span>i</span> <span>&lt;</span> <span>3.</span> <span>;</span> <span>i</span><span>++</span><span>,</span> <span>w</span> <span>*=</span> <span>.4</span><span>,</span> <span>P</span> <span>*=</span> <span>1.9</span> <span>)</span> <span>{</span>
</span></span><span><span>        <span>vec2</span> <span>F</span> <span>=</span> <span>fract</span><span>(</span> <span>P</span> <span>*=</span> <span>mat2</span><span>(</span><span>.866</span><span>,</span><span>-</span><span>.5</span><span>,</span><span>.5</span><span>,</span><span>.866</span><span>)</span> <span>);</span> 
</span></span><span><span>        <span>F</span> <span>*=</span> <span>F</span><span>*</span><span>(</span><span>3.</span><span>-</span><span>F</span><span>-</span><span>F</span><span>);</span>
</span></span><span><span>        <span>s</span> <span>+=</span> <span>w</span><span>*</span> <span>mix</span><span>(</span> <span>mix</span><span>(</span><span>H</span><span>(</span><span>0</span><span>,</span><span>0</span><span>)</span> <span>,</span> <span>H</span><span>(</span><span>1</span><span>,</span><span>0</span><span>),</span> <span>F</span><span>.</span><span>x</span><span>),</span>
</span></span><span><span>                     <span>mix</span><span>(</span><span>H</span><span>(</span><span>0</span><span>,</span><span>1</span><span>)</span> <span>,</span> <span>H</span><span>(</span><span>1</span><span>,</span><span>1</span><span>),</span> <span>F</span><span>.</span><span>x</span><span>),</span>
</span></span><span><span>                     <span>F</span><span>.</span><span>y</span> <span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>    <span>return</span> <span>s</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>vec3</span> <span>portal</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span> <span>// fold</span>
</span></span><span><span>    <span>// from https://www.shadertoy.com/view/l3f3zM</span>
</span></span><span><span>    <span>float</span> <span>l</span> <span>=</span> <span>length</span><span>(</span> <span>pixel</span> <span>),</span> 
</span></span><span><span>          <span>a</span> <span>=</span> <span>atan</span><span>(</span><span>pixel</span><span>.</span><span>y</span><span>,</span> <span>pixel</span><span>.</span><span>x</span><span>)</span> <span>/</span> <span>6.28</span> <span>+</span> <span>.5</span><span>,</span>
</span></span><span><span>          <span>k</span> <span>=</span> <span>10.</span><span>;</span>
</span></span><span><span>     
</span></span><span><span>    <span>a</span> <span>=</span> <span>fract</span><span>(</span><span>a</span> <span>+</span> <span>l</span><span>*</span><span>.3</span> <span>-</span> <span>time</span><span>*</span><span>.01</span> <span>);</span>
</span></span><span><span>    <span>vec2</span> <span>U</span> <span>=</span> <span>vec2</span><span>(</span> <span>l</span><span>+</span><span>time</span><span>*</span><span>.3</span><span>,</span> <span>a</span> <span>);</span>
</span></span><span><span>     
</span></span><span><span>    <span>return</span> <span>vec3</span><span>[](</span> <span>vec3</span><span>(</span><span>.18</span><span>,</span> <span>.53</span><span>,</span> <span>.09</span><span>),</span>
</span></span><span><span>                    <span>vec3</span><span>(</span><span>.56</span><span>,</span> <span>.89</span><span>,</span> <span>.16</span><span>),</span>
</span></span><span><span>                    <span>vec3</span><span>(</span><span>.35</span><span>,</span> <span>.84</span><span>,</span> <span>.11</span><span>),</span>
</span></span><span><span>                    <span>vec3</span><span>(</span><span>.92</span><span>,</span> <span>.98</span><span>,</span> <span>.85</span><span>)</span>
</span></span><span><span>                  <span>)</span> <span>[</span> <span>int</span><span>(</span> <span>4.</span><span>*</span> <span>pow</span><span>(</span> <span>mix</span><span>(</span> <span>N</span><span>(</span><span>U</span><span>*</span><span>k</span><span>),</span> <span>N</span><span>(</span><span>U</span><span>*</span><span>k</span><span>-</span><span>vec2</span><span>(</span><span>0</span><span>,</span><span>k</span><span>)),</span> <span>U</span><span>.</span><span>y</span><span>)</span> <span>*</span> <span>1.5</span><span>,</span> <span>2.5</span><span>))];</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>pixel</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span> 
</span></span><span><span>    <span>{</span> <span>// fold</span>
</span></span><span><span>        <span>// rotate the whole drawing</span>
</span></span><span><span>        <span>pixel</span> <span>=</span> <span>rotateAt</span><span>(</span><span>pixel</span><span>,</span> <span>sin</span><span>(</span><span>time</span><span>*</span><span>2.</span><span>)</span><span>*</span><span>.1</span><span>,</span> <span>vec2</span><span>(</span><span>0</span><span>,</span><span>-</span><span>.6</span><span>));</span>
</span></span><span><span>        <span>pixel</span><span>.</span><span>y</span> <span>+=</span> <span>.1</span><span>;</span>
</span></span><span><span>    
</span></span><span><span>    
</span></span><span><span>    <span>// Blink eyes</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>mod</span><span>(</span><span>time</span><span>,</span> <span>2.</span><span>)</span> <span>&lt;</span> <span>.09</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>// closed eyes</span>
</span></span><span><span>        <span>float</span> <span>d</span> <span>=</span> <span>round_rect</span><span>(</span><span>pixel</span><span>+</span><span>vec2</span><span>(</span><span>.07</span><span>,</span><span>-</span><span>.16</span><span>),</span> <span>vec2</span><span>(</span><span>.24</span><span>,</span><span>0</span><span>),</span> <span>vec4</span><span>(</span><span>0</span><span>));</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.008</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>      
</span></span><span><span>    <span>}</span> 
</span></span><span><span>    <span>else</span> <span>{</span> 
</span></span><span><span>        <span>// move pupils randomly</span>
</span></span><span><span>        <span>vec2</span> <span>pupil_warp</span> <span>=</span> <span>pixel</span> <span>+</span> <span>vec2</span><span>(</span><span>.095</span><span>,</span><span>-</span><span>.18</span><span>);</span>
</span></span><span><span>        <span>pupil_warp</span><span>.</span><span>x</span> <span>-=</span> <span>noise</span><span>(</span><span>vec2</span><span>(</span><span>round</span><span>(</span><span>time</span><span>)</span><span>*</span><span>7.</span><span>+</span><span>.5</span><span>,</span> <span>0.5</span><span>))</span><span>*</span><span>.1</span><span>;</span>
</span></span><span><span>        <span>pupil_warp</span><span>.</span><span>y</span> <span>-=</span> <span>noise</span><span>(</span><span>vec2</span><span>(</span><span>round</span><span>(</span><span>time</span><span>)</span><span>*</span><span>9.</span><span>+</span><span>.5</span><span>,</span> <span>0.5</span><span>))</span><span>*</span><span>.1</span><span>;</span>
</span></span><span><span>        <span>pupil_warp</span><span>.</span><span>x</span> <span>=</span> <span>abs</span><span>(</span><span>pupil_warp</span><span>.</span><span>x</span><span>)</span> <span>-</span> <span>.16</span><span>;</span>
</span></span><span><span>        <span>float</span> <span>d</span> <span>=</span> <span>star</span><span>(</span><span>pupil_warp</span><span>,</span> <span>0.019</span><span>,</span> <span>6.</span><span>,</span> <span>.9</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.007</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>.1</span><span>);</span>
</span></span><span><span>        <span>}</span>
</span></span><span><span>            
</span></span><span><span>        <span>// Eyeballs</span>
</span></span><span><span>        <span>vec2</span> <span>eye</span> <span>=</span> <span>vec2</span><span>(</span><span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.1</span><span>)</span><span>-</span><span>.17</span><span>,</span> <span>pixel</span><span>.</span><span>y</span><span>*</span><span>.93</span> <span>-</span> <span>.16</span><span>);</span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>length</span><span>(</span><span>eye</span><span>)</span> <span>-</span> <span>.16</span><span>;</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>step</span><span>(</span><span>.013</span><span>,</span> <span>-</span><span>d</span><span>));</span>
</span></span><span><span>        
</span></span><span><span>        <span>// under eye lines</span>
</span></span><span><span>        <span>bool</span> <span>should_show</span> <span>=</span> <span>pixel</span><span>.</span><span>y</span> <span>&lt;</span> <span>0.25</span> <span>&amp;&amp;</span> 
</span></span><span><span>            <span>(</span><span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.29</span><span>)</span> <span>&lt;</span> <span>.05</span> <span>||</span> 
</span></span><span><span>            <span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>-</span><span>.12</span><span>)</span> <span>&lt;</span> <span>.085</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>abs</span><span>(</span><span>d</span> <span>-</span> <span>.04</span><span>)</span> <span>&lt;</span> <span>.0055</span> <span>&amp;&amp;</span> <span>should_show</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>  
</span></span><span><span>    
</span></span><span><span>        <span>// Mouth</span>
</span></span><span><span>        <span>float</span> <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>pixel</span><span>,</span>  
</span></span><span><span>                     <span>vec2</span><span>(</span><span>-</span><span>.26</span><span>,</span> <span>-</span><span>.28</span><span>),</span> 
</span></span><span><span>                     <span>vec2</span><span>(</span><span>-</span><span>.05</span><span>,</span><span>-</span><span>.42</span><span>),</span> 
</span></span><span><span>                     <span>vec2</span><span>(</span><span>.115</span><span>,</span> <span>-</span><span>.25</span><span>));</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.11</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>// Teeth</span>
</span></span><span><span>            <span>float</span> <span>width</span> <span>=</span> <span>.065</span><span>;</span>
</span></span><span><span>            <span>vec2</span> <span>teeth</span> <span>=</span> <span>pixel</span><span>;</span>
</span></span><span><span>            <span>teeth</span><span>.</span><span>x</span> <span>=</span> <span>mod</span><span>(</span><span>teeth</span><span>.</span><span>x</span><span>,</span> <span>width</span><span>)</span><span>-</span><span>width</span><span>*</span><span>.5</span><span>;</span>
</span></span><span><span>            <span>teeth</span><span>.</span><span>y</span> <span>-=</span> <span>pow</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.09</span><span>,</span> <span>2.</span><span>)</span> <span>*</span> <span>1.5</span> <span>-</span> <span>.34</span><span>;</span>
</span></span><span><span>            <span>teeth</span><span>.</span><span>y</span> <span>=</span> <span>abs</span><span>(</span><span>teeth</span><span>.</span><span>y</span><span>)</span><span>-</span><span>.06</span><span>;</span>
</span></span><span><span>            <span>d</span> <span>=</span> <span>parabola</span><span>(</span><span>teeth</span><span>,</span> <span>38.</span><span>);</span>
</span></span><span><span>            <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span> <span>&amp;&amp;</span> <span>abs</span><span>(</span><span>pixel</span><span>.</span><span>x</span><span>+</span><span>.06</span><span>)</span> <span>&lt;</span> <span>.194</span><span>)</span> 
</span></span><span><span>                <span>return</span> <span>vec3</span><span>(</span><span>0.902</span><span>,</span> <span>0.890</span><span>,</span> <span>0.729</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.01</span><span>);</span>
</span></span><span><span>          
</span></span><span><span>            <span>// Tongue</span>
</span></span><span><span>            <span>// `map()` is used to change the thickness of </span>
</span></span><span><span>            <span>// the tongue along the x axis</span>
</span></span><span><span>            <span>vec2</span> <span>tongue</span> <span>=</span> <span>rotateAt</span><span>(</span><span>pixel</span><span>,</span> <span>sin</span><span>(</span><span>time</span><span>*</span><span>2.</span><span>-</span><span>1.5</span><span>)</span><span>*</span><span>.15</span><span>+</span><span>.1</span><span>,</span> <span>vec2</span><span>(</span><span>0</span><span>,</span><span>-</span><span>.5</span><span>));</span>
</span></span><span><span>            <span>float</span> <span>tongue_thickness</span> <span>=</span> <span>map</span><span>(</span><span>tongue</span><span>.</span><span>x</span><span>,</span> <span>-</span><span>.16</span><span>,</span> <span>.01</span><span>,</span> <span>.02</span><span>,</span> <span>.045</span><span>);</span>
</span></span><span><span>            <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>tongue</span><span>,</span>  
</span></span><span><span>                <span>vec2</span><span>(</span><span>-</span><span>.16</span><span>,</span> <span>-</span><span>.35</span><span>),</span> 
</span></span><span><span>                <span>vec2</span><span>(</span><span>.001</span><span>,</span><span>-</span><span>.33</span><span>),</span> 
</span></span><span><span>                <span>vec2</span><span>(</span><span>.01</span><span>,</span> <span>-</span><span>.5</span><span>))</span> <span>-</span> <span>tongue_thickness</span><span>;</span>
</span></span><span><span>            <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0</span><span>)</span> 
</span></span><span><span>                <span>return</span> <span>vec3</span><span>(</span><span>0.816</span><span>,</span> <span>0.302</span><span>,</span> <span>0.275</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>0.01</span><span>);</span>
</span></span><span><span>              
</span></span><span><span>            <span>// mouth fill color</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>.42</span><span>,</span> <span>.147</span><span>,</span> <span>.152</span><span>);</span> 
</span></span><span><span>        <span>}</span> 
</span></span><span><span>        
</span></span><span><span>        <span>// lip outlines</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.12</span> <span>||</span> <span>(</span><span>abs</span><span>(</span><span>d</span><span>-</span><span>.16</span><span>)</span> <span>&lt;</span> <span>.005</span> 
</span></span><span><span>                        <span>&amp;&amp;</span> <span>(</span><span>pixel</span><span>.</span><span>x</span><span>*-</span><span>6.4</span> <span>&gt;</span> <span>-</span><span>pixel</span><span>.</span><span>y</span><span>+</span><span>1.6</span> 
</span></span><span><span>                          <span>||</span> <span>pixel</span><span>.</span><span>x</span><span>*</span><span>1.7</span> <span>&gt;</span> <span>-</span><span>pixel</span><span>.</span><span>y</span><span>+</span><span>.1</span> 
</span></span><span><span>                          <span>||</span> <span>pixel</span><span>.</span><span>y</span> <span>&lt;</span> <span>-</span><span>0.49</span><span>)))</span> 
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span> 
</span></span><span><span>        
</span></span><span><span>        <span>// lips</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>.16</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>.838</span><span>,</span> <span>.799</span><span>,</span> <span>0.76</span><span>);</span>
</span></span><span><span>       
</span></span><span><span>        
</span></span><span><span>    
</span></span><span><span>        <span>// Nose  </span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>min</span><span>(</span>
</span></span><span><span>                <span>bezier</span><span>(</span><span>pixel</span><span>,</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.15</span><span>,</span> <span>-</span><span>.13</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.21</span><span>,</span><span>-</span><span>.14</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.14</span><span>,</span> <span>.08</span><span>)),</span>
</span></span><span><span>                <span>bezier</span><span>(</span><span>pixel</span><span>,</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.085</span><span>,</span> <span>-</span><span>.01</span><span>),</span> 
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.12</span><span>,</span> <span>-</span><span>.13</span><span>),</span>
</span></span><span><span>                    <span>vec2</span><span>(</span><span>-</span><span>.15</span><span>,</span><span>-</span><span>.13</span><span>)));</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0055</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>
</span></span><span><span>    <span>// Eyebrow</span>
</span></span><span><span>    <span>d</span> <span>=</span> <span>bezier</span><span>(</span><span>pixel</span><span>,</span>  
</span></span><span><span>            <span>vec2</span><span>(</span><span>-</span><span>.34</span><span>,</span> <span>.38</span><span>),</span> 
</span></span><span><span>            <span>// NEW animate the middle up and down</span>
</span></span><span><span>            <span>vec2</span><span>(</span><span>-</span><span>.05</span><span>,</span> <span>0.5</span> <span>+</span> <span>cos</span><span>(</span><span>time</span><span>)</span><span>*</span><span>.1</span><span>),</span>
</span></span><span><span>            <span>vec2</span><span>(</span><span>.205</span><span>,</span> <span>.36</span><span>))</span> <span>-</span> <span>0.035</span><span>;</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.0</span><span>)</span> 
</span></span><span><span>        <span>return</span> <span>vec3</span><span>(</span><span>.71</span><span>,</span> <span>.839</span><span>,</span> <span>.922</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.013</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>        <span>d</span> <span>=</span> <span>min</span><span>(</span>
</span></span><span><span>            <span>// Head</span>
</span></span><span><span>            <span>round_rect</span><span>(</span>
</span></span><span><span>            <span>pixel</span><span>,</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.36</span><span>,</span> <span>.6385</span><span>),</span> 
</span></span><span><span>            <span>vec4</span><span>(</span><span>.34</span><span>,</span> <span>.415</span><span>,</span> <span>.363</span><span>,</span> <span>.315</span><span>)),</span>
</span></span><span><span>            
</span></span><span><span>            <span>// Ear</span>
</span></span><span><span>            <span>round_rect</span><span>(</span>
</span></span><span><span>            <span>pixel</span> <span>+</span> <span>vec2</span><span>(</span><span>-</span><span>.32</span><span>,</span> <span>.15</span><span>),</span> 
</span></span><span><span>            <span>vec2</span><span>(</span><span>.15</span><span>,</span> <span>0.12</span><span>),</span> 
</span></span><span><span>            <span>vec4</span><span>(</span><span>.13</span><span>,</span><span>.1</span><span>,</span><span>.13</span><span>,</span><span>.13</span><span>))</span>
</span></span><span><span>        <span>);</span>
</span></span><span><span>            
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>return</span> <span>vec3</span><span>(</span><span>.838</span><span>,</span> <span>.799</span><span>,</span> <span>.76</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>.01</span><span>);</span>
</span></span><span><span>    
</span></span><span><span>    
</span></span><span><span>        <span>// Hair     </span>
</span></span><span><span>        <span>float</span> <span>twist</span> <span>=</span> <span>sin</span><span>(</span><span>time</span><span>*</span><span>2.</span><span>-</span><span>length</span><span>(</span><span>pixel</span><span>)</span><span>*</span><span>2.1</span><span>)</span><span>*</span><span>.12</span><span>;</span>
</span></span><span><span>        <span>vec2</span> <span>hair</span> <span>=</span> <span>rotateAt</span><span>(</span><span>pixel</span><span>,</span> <span>twist</span><span>,</span> <span>vec2</span><span>(</span><span>0.</span><span>,</span><span>.1</span><span>));</span>
</span></span><span><span>        <span>hair</span> <span>-=</span> <span>vec2</span><span>(</span><span>.08</span><span>,</span><span>.15</span><span>);</span>
</span></span><span><span>        <span>hair</span><span>.</span><span>x</span> <span>*=</span> <span>1.3</span><span>;</span>
</span></span><span><span>        <span>hair</span> <span>=</span> <span>warp</span><span>(</span><span>hair</span><span>,</span> <span>4.0</span><span>,</span> <span>0.07</span><span>);</span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>star</span><span>(</span><span>hair</span><span>,</span> <span>0.95</span><span>,</span> <span>11.</span><span>,</span> <span>.28</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>return</span> <span>vec3</span><span>(</span><span>0.682</span><span>,</span> <span>0.839</span><span>,</span> <span>0.929</span><span>)</span><span>*</span><span>step</span><span>(</span><span>d</span><span>,</span> <span>-</span><span>0.012</span><span>);</span>
</span></span><span><span>        <span>}</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>    
</span></span><span><span>    <span>return</span> <span>portal</span><span>(</span><span>pixel</span><span>,</span> <span>time</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>I prioritized readability over performance for this code - see how much faster you can make it run.</p><p>That’s everything I know about making 2D animations using shaders. I hope it’s useful. Maybe next time we’ll talk about 3D, or some totally different topic! If you’d like to be notified about my next post, please join my newsletter.</p><form action="https://app.kit.com/forms/7632615/subscriptions" method="post">
</form><p>Join my newsletter lol</p><p>While I love teaching and making posts like this, they are very time consuming to make — this one took about two weeks of work spread over 8 months. So if you’d like to see more work like this, please consider <a href="#" onclick="event.preventDefault(),document.getElementById(&#34;tipform&#34;).submit()">supporting me</a>.</p><h2 id="appendix-1-creating-a-video">Appendix 1: Creating a Video</h2><p>When you’re done with an animation you’ll probably want to turn it into a video. The editor we’ve been using on this page can not yet do that, but I’m working on it. Join my newsletter to be notified when I add video export!</p><p>In the meantime, you can use a script with <a href="https://github.com/patriciogonzalezvivo/glslViewer" target="_blank" rel="noopener">glslviewer</a> and <a href="https://www.ffmpeg.org" target="_blank" rel="noopener">ffmpeg</a>. Below is my macOS workflow, on Windows and Linux you’ll have to figure out what your platform’s equivalent is.</p><ol><li>Install the dependencies.</li></ol><div><pre tabindex="0"><code data-lang="bash"><span><span>brew install glslviewer ffmpeg <span># brew is macos only</span>
</span></span></code></pre></div><ol start="2"><li><p>Write your <code>shader.frag</code> file</p></li><li><p>And then put this in a bash file and run to export your video</p></li></ol><div><pre tabindex="0"><code data-lang="bash"><span><span><span>#!/bin/bash
</span></span></span><span><span><span></span>
</span></span><span><span><span>set</span> -e
</span></span><span><span><span>set</span> -o pipefail
</span></span><span><span>
</span></span><span><span><span>if</span> <span>[</span> -z <span>&#34;</span><span>$1</span><span>&#34;</span> <span>]</span><span>;</span> <span>then</span>
</span></span><span><span>  <span>echo</span> <span>&#34;Usage: </span><span>$0</span><span> &lt;shader_file&gt;&#34;</span>
</span></span><span><span>  <span>exit</span> <span>1</span>
</span></span><span><span><span>fi</span>
</span></span><span><span>
</span></span><span><span><span>ORIGINAL_DIR</span><span>=</span><span>$(</span><span>pwd</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span>TMP_DIR</span><span>=</span><span>$(</span>mktemp -d<span>)</span>
</span></span><span><span><span>if</span> <span>[</span> ! -d <span>&#34;</span><span>$TMP_DIR</span><span>&#34;</span> <span>]</span><span>;</span> <span>then</span>
</span></span><span><span>  <span>echo</span> <span>&#34;Failed to create temporary directory.&#34;</span>
</span></span><span><span>  <span>exit</span> <span>1</span>
</span></span><span><span><span>fi</span>
</span></span><span><span><span>cd</span> <span>&#34;</span><span>$TMP_DIR</span><span>&#34;</span>
</span></span><span><span>
</span></span><span><span>glslViewer <span>&#34;</span><span>$ORIGINAL_DIR</span><span>/</span><span>$1</span><span>&#34;</span> -w <span>1920</span> -h <span>1080</span> --headless -e sequence,0,7,60 -e q
</span></span><span><span>ffmpeg -framerate <span>60</span> -y -i %05d.png -c:v libx264 -pix_fmt yuv420p animation.mp4
</span></span><span><span>mv animation.mp4 <span>&#34;</span><span>$ORIGINAL_DIR</span><span>/&#34;</span>
</span></span><span><span>
</span></span><span><span><span>cd</span> <span>&#34;</span><span>$ORIGINAL_DIR</span><span>&#34;</span>
</span></span><span><span>rm -rf <span>&#34;</span><span>$TMP_DIR</span><span>&#34;</span>
</span></span></code></pre></div><p>And if you want to live code locally, use this:</p><div><pre tabindex="0"><code data-lang="bash"><span><span>glslViewer shader.frag -w <span>575</span> -h <span>324</span> --noncurses -x <span>0</span> -y <span>0</span>
</span></span></code></pre></div><h3 id="appendix-2-super-sampling">Appendix 2: Super Sampling</h3><p>You may have noticed that the edges of shapes in the examples on this page are smooth. I did a bit of work behind the scenes make that happen. I use a technique called super sampling where I call <code>color_for_pixel()</code> for 9 locations within each screen pixel and then display the average. The left side of this example shows what it looks like with super sampling disabled. You may need to zoom in on the page to see the difference.</p><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>#version 300 es </span>
</span></span><span><span><span>// The above line switches the editor to &#34;pro&#34; mode </span>
</span></span><span><span><span>// and removes automatic super sampling</span>
</span></span><span><span>
</span></span><span><span><span>precision</span> <span>highp</span> <span>float</span><span>;</span>
</span></span><span><span><span>uniform</span> <span>float</span> <span>time</span><span>;</span>
</span></span><span><span><span>uniform</span> <span>vec2</span> <span>resolution</span><span>;</span>
</span></span><span><span><span>out</span> <span>vec4</span> <span>outColor</span><span>;</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>   
</span></span><span><span>    <span>return</span> <span>vec3</span><span>(</span><span>length</span><span>(</span><span>mod</span><span>(</span><span>p</span><span>+</span><span>time</span><span>*</span><span>.05</span><span>,</span> <span>.5</span><span>)</span> <span>-</span> <span>.25</span><span>)</span> <span>&gt;</span> <span>0.2</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>void</span> <span>main</span><span>()</span> <span>{</span>
</span></span><span><span>    <span>float</span> <span>zone</span> <span>=</span> <span>gl_FragCoord</span><span>.</span><span>x</span> <span>-</span> <span>resolution</span><span>.</span><span>x</span><span>*</span><span>.5</span><span>;</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>abs</span><span>(</span><span>zone</span><span>)</span> <span>&lt;</span> <span>1.5</span><span>)</span> <span>{</span>
</span></span><span><span>      <span>// vertical line</span>
</span></span><span><span>      <span>outColor</span> <span>=</span> <span>vec4</span><span>(</span><span>1</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>);</span>
</span></span><span><span>    <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>zone</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>      <span>// left side: no super sampling</span>
</span></span><span><span>      <span>vec2</span> <span>st</span> <span>=</span> <span>(</span><span>2.0</span><span>*</span><span>(</span><span>gl_FragCoord</span><span>.</span><span>xy</span><span>)</span><span>-</span><span>resolution</span><span>)</span><span>/</span><span>resolution</span><span>.</span><span>y</span><span>;</span>
</span></span><span><span>      <span>outColor</span> <span>=</span> <span>vec4</span><span>(</span><span>color_for_pixel</span><span>(</span><span>st</span><span>,</span> <span>time</span><span>),</span> <span>1</span><span>);</span>
</span></span><span><span>    <span>}</span> <span>else</span> <span>{</span>
</span></span><span><span>      <span>// right side: super sampling</span>
</span></span><span><span>      <span>int</span> <span>sample_count</span> <span>=</span> <span>3</span><span>;</span>     
</span></span><span><span>      <span>vec3</span> <span>sum</span> <span>=</span> <span>vec3</span><span>(</span><span>0</span><span>);</span>
</span></span><span><span>      <span>for</span><span>(</span> <span>int</span> <span>m</span><span>=</span><span>0</span><span>;</span> <span>m</span><span>&lt;</span><span>sample_count</span><span>;</span> <span>m</span><span>++</span> <span>)</span> <span>{</span>
</span></span><span><span>          <span>for</span><span>(</span> <span>int</span> <span>n</span><span>=</span><span>0</span><span>;</span> <span>n</span><span>&lt;</span><span>sample_count</span><span>;</span> <span>n</span><span>++</span> <span>)</span> <span>{</span>
</span></span><span><span>              <span>vec2</span> <span>o</span> <span>=</span> <span>(</span><span>vec2</span><span>(</span><span>m</span><span>,</span><span>n</span><span>)</span> <span>+</span> <span>0.5</span><span>)</span> <span>/</span> <span>float</span><span>(</span><span>sample_count</span><span>);</span>
</span></span><span><span>              <span>vec2</span> <span>st</span> <span>=</span> <span>(</span><span>2.0</span><span>*</span><span>(</span><span>gl_FragCoord</span><span>.</span><span>xy</span><span>+</span><span>o</span><span>)</span><span>-</span><span>resolution</span><span>)</span><span>/</span><span>resolution</span><span>.</span><span>y</span><span>;</span>
</span></span><span><span>              <span>sum</span> <span>+=</span> <span>color_for_pixel</span><span>(</span><span>st</span><span>,</span> <span>time</span><span>);</span>
</span></span><span><span>          <span>}</span>
</span></span><span><span>      <span>}</span>
</span></span><span><span>
</span></span><span><span>      <span>outColor</span> <span>=</span> <span>vec4</span><span>(</span><span>sum</span> <span>/</span> <span>float</span><span>(</span><span>sample_count</span><span>*</span><span>sample_count</span><span>),</span> <span>1</span><span>);</span> 
</span></span><span><span>    <span>}</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><h3 id="appendix-3-post-origins">Appendix 3: Post Origins</h3><p>Eight months ago I published a video titled “<em><a href="https://youtu.be/-Xb3Kk3HhIw?si=XN--6NbM2Ux23Gez" target="_blank" rel="noopener">I Made a 3D Modeler, in C, in a Week</a></em>”. The video has several animations, like this one that illustrates the the marching cubes algorithm:</p><div><div><pre tabindex="0"><code data-lang="glsl"><span><span><span>#define INTERP 1.0</span>
</span></span><span><span>
</span></span><span><span><span>#define GRID_RESOLUTION 0</span>
</span></span><span><span>
</span></span><span><span><span>#define TRIANGULATE_4</span>
</span></span><span><span><span>#define TRIANGULATE_3</span>
</span></span><span><span><span>#define TRIANGULATE_2</span>
</span></span><span><span><span>#define TRIANGULATE_1</span>
</span></span><span><span>
</span></span><span><span><span>#define SHOW_INNER_DOTS 1</span>
</span></span><span><span><span>#define SHOW_OUTER_DOTS 1</span>
</span></span><span><span>
</span></span><span><span><span>#define ANTIALIAS_LEVEL 3</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>fill_color</span> <span>=</span> <span>vec3</span><span>(</span><span>0.4</span><span>);</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>wireframe_color</span> <span>=</span> <span>vec3</span><span>(</span><span>.1</span><span>);</span>
</span></span><span><span><span>float</span> <span>wireframe_thickness</span> <span>=</span> <span>.003</span><span>;</span>
</span></span><span><span>
</span></span><span><span><span>vec2</span> <span>repeated</span><span>(</span> <span>vec2</span> <span>p</span><span>,</span> <span>float</span> <span>s</span> <span>)</span> <span>{</span>
</span></span><span><span>    <span>vec2</span> <span>r</span> <span>=</span> <span>p</span> <span>-</span> <span>s</span><span>*</span><span>floor</span><span>(</span><span>p</span><span>/</span><span>s</span><span>);</span>
</span></span><span><span>    <span>return</span> <span>r</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>float</span> <span>Circle</span><span>(</span><span>vec2</span> <span>p</span><span>,</span> <span>vec2</span> <span>origin</span><span>,</span> <span>float</span> <span>radius</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>return</span> <span>length</span><span>(</span><span>p</span> <span>-</span> <span>origin</span><span>)</span> <span>-</span> <span>radius</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>float</span> <span>sdTriangle</span><span>(</span> <span>in</span> <span>vec2</span> <span>p</span><span>,</span> <span>in</span> <span>vec2</span> <span>p0</span><span>,</span> <span>in</span> <span>vec2</span> <span>p1</span><span>,</span> <span>in</span> <span>vec2</span> <span>p2</span> <span>)</span>
</span></span><span><span><span>{</span>
</span></span><span><span>    <span>vec2</span> <span>e0</span> <span>=</span> <span>p1</span> <span>-</span> <span>p0</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>e1</span> <span>=</span> <span>p2</span> <span>-</span> <span>p1</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>e2</span> <span>=</span> <span>p0</span> <span>-</span> <span>p2</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>vec2</span> <span>v0</span> <span>=</span> <span>p</span> <span>-</span> <span>p0</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>v1</span> <span>=</span> <span>p</span> <span>-</span> <span>p1</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>v2</span> <span>=</span> <span>p</span> <span>-</span> <span>p2</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>vec2</span> <span>pq0</span> <span>=</span> <span>v0</span> <span>-</span> <span>e0</span><span>*</span><span>clamp</span><span>(</span> <span>dot</span><span>(</span><span>v0</span><span>,</span><span>e0</span><span>)</span><span>/</span><span>dot</span><span>(</span><span>e0</span><span>,</span><span>e0</span><span>),</span> <span>0.0</span><span>,</span> <span>1.0</span> <span>);</span>
</span></span><span><span>    <span>vec2</span> <span>pq1</span> <span>=</span> <span>v1</span> <span>-</span> <span>e1</span><span>*</span><span>clamp</span><span>(</span> <span>dot</span><span>(</span><span>v1</span><span>,</span><span>e1</span><span>)</span><span>/</span><span>dot</span><span>(</span><span>e1</span><span>,</span><span>e1</span><span>),</span> <span>0.0</span><span>,</span> <span>1.0</span> <span>);</span>
</span></span><span><span>    <span>vec2</span> <span>pq2</span> <span>=</span> <span>v2</span> <span>-</span> <span>e2</span><span>*</span><span>clamp</span><span>(</span> <span>dot</span><span>(</span><span>v2</span><span>,</span><span>e2</span><span>)</span><span>/</span><span>dot</span><span>(</span><span>e2</span><span>,</span><span>e2</span><span>),</span> <span>0.0</span><span>,</span> <span>1.0</span> <span>);</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>s</span> <span>=</span> <span>e0</span><span>.</span><span>x</span><span>*</span><span>e2</span><span>.</span><span>y</span> <span>-</span> <span>e0</span><span>.</span><span>y</span><span>*</span><span>e2</span><span>.</span><span>x</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>d</span> <span>=</span> <span>min</span><span>(</span> <span>min</span><span>(</span> <span>vec2</span><span>(</span> <span>dot</span><span>(</span> <span>pq0</span><span>,</span> <span>pq0</span> <span>),</span> <span>s</span><span>*</span><span>(</span><span>v0</span><span>.</span><span>x</span><span>*</span><span>e0</span><span>.</span><span>y</span><span>-</span><span>v0</span><span>.</span><span>y</span><span>*</span><span>e0</span><span>.</span><span>x</span><span>)</span> <span>),</span>
</span></span><span><span>                       <span>vec2</span><span>(</span> <span>dot</span><span>(</span> <span>pq1</span><span>,</span> <span>pq1</span> <span>),</span> <span>s</span><span>*</span><span>(</span><span>v1</span><span>.</span><span>x</span><span>*</span><span>e1</span><span>.</span><span>y</span><span>-</span><span>v1</span><span>.</span><span>y</span><span>*</span><span>e1</span><span>.</span><span>x</span><span>)</span> <span>)),</span>
</span></span><span><span>                       <span>vec2</span><span>(</span> <span>dot</span><span>(</span> <span>pq2</span><span>,</span> <span>pq2</span> <span>),</span> <span>s</span><span>*</span><span>(</span><span>v2</span><span>.</span><span>x</span><span>*</span><span>e2</span><span>.</span><span>y</span><span>-</span><span>v2</span><span>.</span><span>y</span><span>*</span><span>e2</span><span>.</span><span>x</span><span>)</span> <span>));</span>
</span></span><span><span>
</span></span><span><span>    <span>return</span> <span>-</span><span>sqrt</span><span>(</span><span>d</span><span>.</span><span>x</span><span>)</span><span>*</span><span>sign</span><span>(</span><span>d</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>float</span> <span>sdf</span><span>(</span><span>vec2</span> <span>p</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>float</span> <span>d</span> <span>=</span> <span>Circle</span><span>(</span><span>p</span><span>,</span> <span>vec2</span><span>(</span><span>0</span><span>,</span><span>-</span><span>.2</span><span>),</span> <span>0.7</span><span>);</span>
</span></span><span><span>
</span></span><span><span>    <span>d</span> <span>=</span> <span>min</span><span>(</span><span>d</span><span>,</span> <span>Circle</span><span>(</span><span>vec2</span><span>(</span><span>abs</span><span>(</span><span>p</span><span>.</span><span>x</span><span>),</span><span>p</span><span>.</span><span>y</span><span>),</span> <span>vec2</span><span>(</span><span>.73</span><span>,</span><span>.45</span><span>),</span> <span>0.4</span><span>));</span>
</span></span><span><span>    <span>return</span> <span>d</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>float</span> <span>triangle_wave</span><span>(</span><span>float</span> <span>x</span><span>,</span> <span>float</span> <span>amplitude</span><span>,</span> <span>float</span> <span>period</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>return</span> <span>(</span><span>amplitude</span><span>/</span><span>period</span><span>)</span> <span>*</span> <span>(</span><span>period</span> <span>-</span> <span>abs</span><span>(</span><span>mod</span><span>(</span><span>x</span><span>,</span> <span>(</span><span>2.</span><span>*</span><span>period</span><span>))</span> <span>-</span> <span>period</span><span>)</span> <span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span>    <span>vec2</span> <span>interpVert</span><span>(</span><span>vec2</span> <span>p1</span><span>,</span> <span>vec2</span> <span>p2</span><span>,</span> <span>float</span> <span>w1</span><span>,</span> <span>float</span> <span>w2</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>return</span> <span>p1</span> <span>+</span> <span>(</span><span>-</span><span>w1</span> <span>/</span> <span>(</span><span>w2</span><span>-</span><span>w1</span><span>))</span> <span>*</span> <span>(</span><span>p2</span><span>-</span><span>p1</span><span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>
</span></span><span><span><span>vec3</span> <span>color_for_pixel</span><span>(</span><span>vec2</span> <span>st</span><span>,</span> <span>float</span> <span>time</span><span>)</span> <span>{</span>
</span></span><span><span>
</span></span><span><span>    <span>vec3</span> <span>color</span><span>;</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>sdf</span><span>(</span><span>st</span><span>)</span> <span>&gt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>color</span> <span>=</span> <span>vec3</span><span>(</span><span>.2</span><span>);</span>
</span></span><span><span>    <span>}</span> <span>else</span> <span>{</span>
</span></span><span><span>        <span>color</span> <span>=</span> <span>vec3</span><span>(</span><span>1.</span><span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>grid_resolution</span> <span>=</span>  <span>sin</span><span>(</span><span>time</span><span>/</span><span>1.2</span><span>)</span><span>/</span><span>4.</span> <span>+</span> <span>0.4</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>// find 4 nearest points</span>
</span></span><span><span>    <span>vec2</span> <span>p1</span> <span>=</span> <span>floor</span><span>((</span><span>st</span><span>)</span> <span>/</span> <span>grid_resolution</span><span>)</span> <span>*</span> <span>grid_resolution</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>p2</span> <span>=</span> <span>p1</span> <span>+</span> <span>vec2</span><span>(</span><span>0</span><span>,</span> <span>grid_resolution</span><span>);</span>
</span></span><span><span>    <span>vec2</span> <span>p3</span> <span>=</span> <span>p1</span> <span>+</span> <span>vec2</span><span>(</span><span>grid_resolution</span><span>,</span> <span>0</span><span>);</span>
</span></span><span><span>    <span>vec2</span> <span>p4</span> <span>=</span> <span>p1</span> <span>+</span> <span>vec2</span><span>(</span><span>grid_resolution</span><span>,</span> <span>grid_resolution</span><span>);</span>
</span></span><span><span>
</span></span><span><span>    <span>vec2</span> <span>nearest</span> <span>=</span> <span>vec2</span><span>(</span><span>round</span><span>(</span><span>st</span><span>.</span><span>x</span><span>/</span><span>grid_resolution</span><span>)</span><span>*</span><span>grid_resolution</span><span>,</span>
</span></span><span><span>                        <span>round</span><span>(</span><span>st</span><span>.</span><span>y</span><span>/</span><span>grid_resolution</span><span>)</span><span>*</span><span>grid_resolution</span><span>);</span>
</span></span><span><span>
</span></span><span><span>    <span>vec2</span> <span>j</span> <span>=</span> <span>abs</span><span>(</span><span>nearest</span> <span>-</span> <span>st</span><span>);</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span>    <span>// sample sdf</span>
</span></span><span><span>    <span>float</span> <span>v1</span> <span>=</span> <span>sdf</span><span>(</span><span>p1</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>v2</span> <span>=</span> <span>sdf</span><span>(</span><span>p2</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>v3</span> <span>=</span> <span>sdf</span><span>(</span><span>p3</span><span>);</span>
</span></span><span><span>    <span>float</span> <span>v4</span> <span>=</span> <span>sdf</span><span>(</span><span>p4</span><span>);</span>
</span></span><span><span>
</span></span><span><span>    <span>// count number inside</span>
</span></span><span><span>    <span>float</span> <span>count</span> <span>=</span> <span>step</span><span>(</span><span>0.</span><span>,</span><span>-</span><span>v1</span><span>)</span> <span>+</span> <span>step</span><span>(</span><span>0.</span><span>,</span><span>-</span><span>v2</span><span>)</span> <span>+</span><span>step</span><span>(</span><span>0.</span><span>,</span><span>-</span><span>v3</span><span>)</span> <span>+</span><span>step</span><span>(</span><span>0.</span><span>,</span><span>-</span><span>v4</span><span>);</span>
</span></span><span><span>
</span></span><span><span>    <span>vec2</span> <span>p12</span> <span>=</span> <span>(</span><span>p1</span> <span>+</span> <span>p2</span><span>)</span> <span>/</span> <span>2.</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>p13</span> <span>=</span> <span>(</span><span>p1</span> <span>+</span> <span>p3</span><span>)</span> <span>/</span> <span>2.</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>p24</span> <span>=</span> <span>(</span><span>p4</span> <span>+</span> <span>p2</span><span>)</span> <span>/</span> <span>2.</span><span>;</span>
</span></span><span><span>    <span>vec2</span> <span>p34</span> <span>=</span> <span>(</span><span>p4</span> <span>+</span> <span>p3</span><span>)</span> <span>/</span> <span>2.</span><span>;</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span>    <span>p12</span> <span>=</span> <span>mix</span><span>(</span><span>p12</span><span>,</span> <span>interpVert</span><span>(</span><span>p1</span><span>,</span> <span>p2</span><span>,</span> <span>v1</span><span>,</span> <span>v2</span><span>),</span> <span>min</span><span>(</span><span>1.</span><span>,</span><span>time</span><span>*</span><span>INTERP</span><span>));</span>
</span></span><span><span>    <span>p13</span> <span>=</span> <span>mix</span><span>(</span><span>p13</span><span>,</span> <span>interpVert</span><span>(</span><span>p1</span><span>,</span> <span>p3</span><span>,</span> <span>v1</span><span>,</span> <span>v3</span><span>),</span> <span>min</span><span>(</span><span>1.</span><span>,</span><span>time</span><span>*</span><span>INTERP</span><span>));</span>
</span></span><span><span>    <span>p24</span> <span>=</span> <span>mix</span><span>(</span><span>p24</span><span>,</span> <span>interpVert</span><span>(</span><span>p2</span><span>,</span> <span>p4</span><span>,</span> <span>v2</span><span>,</span> <span>v4</span><span>),</span> <span>min</span><span>(</span><span>1.</span><span>,</span><span>time</span><span>*</span><span>INTERP</span><span>));</span>
</span></span><span><span>    <span>p34</span> <span>=</span> <span>mix</span><span>(</span><span>p34</span><span>,</span> <span>interpVert</span><span>(</span><span>p4</span><span>,</span> <span>p3</span><span>,</span> <span>v4</span><span>,</span> <span>v3</span><span>),</span> <span>min</span><span>(</span><span>1.</span><span>,</span><span>time</span><span>*</span><span>INTERP</span><span>));</span>
</span></span><span><span>
</span></span><span><span>    <span>float</span> <span>d</span> <span>=</span> <span>10.</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>vec3</span> <span>special_fill</span> <span>=</span> <span>fill_color</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>if</span> <span>(</span><span>count</span> <span>==</span> <span>4.</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>#</span><span>ifdef</span> <span>TRIANGULATE_4</span>
</span></span><span><span>        <span>special_fill</span> <span>=</span> <span>vec3</span><span>(</span><span>0.178</span><span>,</span> <span>0.321</span><span>,</span> <span>0.400</span><span>);</span>
</span></span><span><span>        <span>d</span> <span>=</span> <span>min</span><span>(</span><span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p1</span><span>,</span><span>p2</span><span>,</span><span>p3</span><span>),</span> <span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p4</span><span>,</span><span>p2</span><span>,</span><span>p3</span><span>));</span>
</span></span><span><span>        <span>#</span><span>endif</span>
</span></span><span><span>    <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>count</span> <span>==</span> <span>3.</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>#</span><span>ifdef</span> <span>TRIANGULATE_3</span>
</span></span><span><span>        <span>special_fill</span> <span>=</span> <span>vec3</span><span>(</span><span>0.431</span><span>,</span> <span>0.532</span><span>,</span> <span>0.595</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>v1</span>  <span>&gt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>d</span> <span>=</span> <span>min</span><span>(</span><span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p4</span><span>,</span><span>p2</span><span>,</span><span>p12</span><span>),</span> <span>min</span><span>(</span><span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p4</span><span>,</span><span>p3</span><span>,</span><span>p13</span><span>),</span> <span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p4</span><span>,</span><span>p13</span><span>,</span><span>p12</span><span>)));</span>
</span></span><span><span>        <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>v2</span>  <span>&gt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>d</span> <span>=</span> <span>min</span><span>(</span><span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p1</span><span>,</span><span>p3</span><span>,</span><span>p12</span><span>),</span> <span>min</span><span>(</span><span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p12</span><span>,</span><span>p3</span><span>,</span><span>p24</span><span>),</span> <span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p4</span><span>,</span><span>p3</span><span>,</span><span>p24</span><span>)));</span>
</span></span><span><span>        <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>v3</span>  <span>&gt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>d</span> <span>=</span> <span>min</span><span>(</span><span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p1</span><span>,</span><span>p2</span><span>,</span><span>p13</span><span>),</span> <span>min</span><span>(</span><span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p2</span><span>,</span><span>p13</span><span>,</span><span>p34</span><span>),</span> <span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p2</span><span>,</span><span>p4</span><span>,</span><span>p34</span><span>)));</span>
</span></span><span><span>        <span>}</span> <span>else</span> <span>{</span>
</span></span><span><span>            <span>d</span> <span>=</span> <span>min</span><span>(</span><span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p1</span><span>,</span><span>p2</span><span>,</span><span>p24</span><span>),</span> <span>min</span><span>(</span><span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p1</span><span>,</span><span>p24</span><span>,</span><span>p34</span><span>),</span> <span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p1</span><span>,</span><span>p3</span><span>,</span><span>p34</span><span>)));</span>
</span></span><span><span>        <span>}</span>
</span></span><span><span>        <span>#</span><span>endif</span>
</span></span><span><span>    <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>count</span> <span>==</span> <span>2.</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>#</span><span>ifdef</span> <span>TRIANGULATE_2</span>
</span></span><span><span>        <span>special_fill</span> <span>=</span> <span>vec3</span><span>(</span><span>0.622</span><span>,</span> <span>0.692</span><span>,</span> <span>0.738</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>((</span><span>v1</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>==</span> <span>(</span><span>v2</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>||</span> <span>(</span><span>v1</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>==</span> <span>(</span><span>v3</span> <span>&lt;</span> <span>0.</span><span>))</span> <span>{</span>
</span></span><span><span>            <span>if</span> <span>(</span><span>v1</span> <span>&lt;</span> <span>0.</span> <span>&amp;&amp;</span> <span>v2</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>                <span>d</span> <span>=</span> <span>min</span><span>(</span><span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p1</span><span>,</span><span>p2</span><span>,</span><span>p24</span><span>),</span> <span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p1</span><span>,</span><span>p24</span><span>,</span><span>p13</span><span>));</span>
</span></span><span><span>            <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>v3</span> <span>&lt;</span> <span>0.</span> <span>&amp;&amp;</span> <span>v4</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>                <span>d</span> <span>=</span> <span>min</span><span>(</span><span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p3</span><span>,</span><span>p4</span><span>,</span><span>p24</span><span>),</span> <span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p3</span><span>,</span><span>p24</span><span>,</span><span>p13</span><span>));</span>
</span></span><span><span>            <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>v3</span> <span>&lt;</span> <span>0.</span> <span>&amp;&amp;</span> <span>v1</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>                <span>d</span> <span>=</span> <span>min</span><span>(</span><span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p3</span><span>,</span><span>p1</span><span>,</span><span>p12</span><span>),</span> <span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p3</span><span>,</span><span>p12</span><span>,</span><span>p34</span><span>));</span>
</span></span><span><span>            <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>v2</span> <span>&lt;</span> <span>0.</span> <span>&amp;&amp;</span> <span>v4</span> <span>&lt;</span> <span>0.</span><span>){</span>
</span></span><span><span>                <span>d</span> <span>=</span> <span>min</span><span>(</span><span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p4</span><span>,</span><span>p2</span><span>,</span><span>p12</span><span>),</span> <span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p4</span><span>,</span><span>p12</span><span>,</span><span>p34</span><span>));</span>
</span></span><span><span>            <span>}</span>
</span></span><span><span>        <span>}</span> <span>else</span> <span>{</span>
</span></span><span><span>            <span>// unhandled</span>
</span></span><span><span>        <span>}</span>
</span></span><span><span>        <span>#</span><span>endif</span>
</span></span><span><span>    <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>count</span> <span>==</span> <span>1.</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>#</span><span>ifdef</span> <span>TRIANGULATE_1</span>
</span></span><span><span>        <span>special_fill</span> <span>=</span> <span>vec3</span><span>(</span><span>0.825</span><span>,</span> <span>0.815</span><span>,</span> <span>0.794</span><span>);</span>
</span></span><span><span>        <span>if</span> <span>(</span><span>v1</span>  <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>d</span> <span>=</span> <span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p1</span><span>,</span><span>p12</span><span>,</span><span>p13</span><span>);</span>
</span></span><span><span>        <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>v2</span>  <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>d</span> <span>=</span> <span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p2</span><span>,</span><span>p12</span><span>,</span><span>p24</span><span>);</span>
</span></span><span><span>        <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>v3</span>  <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>d</span> <span>=</span> <span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p3</span><span>,</span><span>p13</span><span>,</span><span>p34</span><span>);</span>
</span></span><span><span>        <span>}</span> <span>else</span> <span>{</span>
</span></span><span><span>            <span>d</span> <span>=</span> <span>sdTriangle</span><span>(</span><span>st</span><span>,</span> <span>p4</span><span>,</span><span>p24</span><span>,</span><span>p34</span><span>);</span>
</span></span><span><span>        <span>}</span>
</span></span><span><span>        <span>#</span><span>endif</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>
</span></span><span><span>    <span>if</span> <span>(</span><span>abs</span><span>(</span><span>d</span><span>)</span> <span>&lt;</span> <span>wireframe_thickness</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>color</span> <span>=</span> <span>wireframe_color</span><span>;</span>
</span></span><span><span>    <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>color</span> <span>=</span> <span>special_fill</span><span>;</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span>    <span>if</span> <span>(</span><span>Circle</span><span>(</span><span>repeated</span><span>(</span><span>st</span><span>+</span><span>.05</span><span>,</span> <span>grid_resolution</span><span>),</span> <span>vec2</span><span>(</span><span>.05</span><span>,</span><span>.05</span><span>),</span> <span>0.007</span><span>)</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>
</span></span><span><span>        <span>if</span> <span>(</span><span>sdf</span><span>(</span><span>nearest</span><span>)</span> <span>&lt;</span> <span>0.</span><span>)</span> <span>{</span>
</span></span><span><span>            <span>#</span><span>if</span> <span>SHOW_INNER_DOTS</span>
</span></span><span><span>            <span>color</span> <span>=</span>  <span>vec3</span><span>(</span><span>0.404</span><span>,</span> <span>0.827</span><span>,</span> <span>0.478</span><span>);</span>
</span></span><span><span>            <span>#</span><span>endif</span>
</span></span><span><span>        <span>}</span> <span>else</span> <span>{</span>
</span></span><span><span>            <span>#</span><span>if</span> <span>SHOW_OUTER_DOTS</span>
</span></span><span><span>            <span>color</span> <span>=</span>  <span>vec3</span><span>(</span><span>0.875</span><span>,</span> <span>0.376</span><span>,</span> <span>0.243</span><span>);</span>
</span></span><span><span>            <span>#</span><span>endif</span>
</span></span><span><span>        <span>}</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>
</span></span><span><span>    <span>return</span> <span>color</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div></div><p>I needed this animation for the video to make sense, but couldn’t get past how painful and time consuming it’d be to make in a typical animation program. It seemed like the only way to accurately and quickly make it was with code. So I started coding, and the animation above is what I ended up with. I’m pretty happy with it. Some people asked me how I made the animations, so I wrote this post to answer that question.</p><hr/></div></div>
  </body>
</html>
