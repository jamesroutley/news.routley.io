<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.danman.eu/about-adding-a-static-route-to-my-docsis-modem/">Original</a>
    <h1>About adding a static route to my DOCSIS modem</h1>
    
    <div id="readability-page-1" class="page"><div>
		
<p>You may think this is an easy task but let’s find out. One would expect such functionality in a web interface …</p>



<figure><img loading="lazy" width="1024" height="690" src="https://blog.danman.eu/wp-content/uploads/2019/03/router-gui-1024x690.png" alt="" srcset="https://blog.danman.eu/wp-content/uploads/2019/03/router-gui-1024x690.png 1024w, https://blog.danman.eu/wp-content/uploads/2019/03/router-gui-300x202.png 300w, https://blog.danman.eu/wp-content/uploads/2019/03/router-gui-768x518.png 768w, https://blog.danman.eu/wp-content/uploads/2019/03/router-gui.png 1209w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p>… but no, it’s not there. So what’s next? Let’s hack it!</p>



<h2>Research</h2>



<p>First I checked how the webUI works, how does it send requests for config change, tried to abuse ping to do remote exec but without luck. Later, I’ve found out that there were some <a href="https://www.exploit-db.com/exploits/40159">vulnerabilities found</a> but they all seemed to be fixed in my FW revision.</p>



<p>But there’s even better source of info about this modem: <a href="http://www.search-lab.hu/media/Compal_CH7465LG_Evaluation_Report_1.1.pdf">security evaluation report</a>. It still refers to the outdated firmware but describes some hardware attack vectors. </p>



<h2>Internals</h2>



<p>HW hacking can be dangerous so I bought another modem of the same type from eBay and performed following on that one. This is how the device looks from inside (imagine it without those hacked wires):<br/></p>



<figure><ul><li><figure><a href="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_075923-1024x768.jpg"><img loading="lazy" width="1024" height="768" src="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_075923-1024x768.jpg" alt="" data-id="1392" data-link="https://blog.danman.eu/img_20190312_075923/" srcset="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_075923-1024x768.jpg 1024w, https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_075923-300x225.jpg 300w, https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_075923-768x576.jpg 768w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure></li><li><figure><a href="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080438-768x1024.jpg"><img loading="lazy" width="768" height="1024" src="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080438-768x1024.jpg" alt="" data-id="1386" data-link="https://blog.danman.eu/img_20190312_080438/" srcset="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080438-768x1024.jpg 768w, https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080438-225x300.jpg 225w" sizes="(max-width: 768px) 100vw, 768px"/></a></figure></li><li><figure><a href="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080757-768x1024.jpg"><img loading="lazy" width="768" height="1024" src="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080757-768x1024.jpg" alt="" data-id="1381" data-link="https://blog.danman.eu/img_20190312_080757/" srcset="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080757-768x1024.jpg 768w, https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080757-225x300.jpg 225w" sizes="(max-width: 768px) 100vw, 768px"/></a></figure></li><li><figure><a href="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080736-1024x768.jpg"><img loading="lazy" width="1024" height="768" src="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080736-1024x768.jpg" alt="" data-id="1382" data-link="https://blog.danman.eu/img_20190312_080736/" srcset="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080736-1024x768.jpg 1024w, https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080736-300x225.jpg 300w, https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080736-768x576.jpg 768w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure></li><li><figure><a href="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080913-768x1024.jpg"><img loading="lazy" width="768" height="1024" src="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080913-768x1024.jpg" alt="" data-id="1373" data-link="https://blog.danman.eu/img_20190312_080913/" srcset="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080913-768x1024.jpg 768w, https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080913-225x300.jpg 225w" sizes="(max-width: 768px) 100vw, 768px"/></a></figure></li><li><figure><a href="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080905-768x1024.jpg"><img loading="lazy" width="768" height="1024" src="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080905-768x1024.jpg" alt="" data-id="1374" data-link="https://blog.danman.eu/img_20190312_080905/" srcset="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080905-768x1024.jpg 768w, https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080905-225x300.jpg 225w" sizes="(max-width: 768px) 100vw, 768px"/></a></figure></li><li><figure><a href="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080852-768x1024.jpg"><img loading="lazy" width="768" height="1024" src="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080852-768x1024.jpg" alt="" data-id="1375" data-link="https://blog.danman.eu/img_20190312_080852/" srcset="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080852-768x1024.jpg 768w, https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080852-225x300.jpg 225w" sizes="(max-width: 768px) 100vw, 768px"/></a></figure></li><li><figure><a href="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080836-768x1024.jpg"><img loading="lazy" width="768" height="1024" src="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080836-768x1024.jpg" alt="" data-id="1377" data-link="https://blog.danman.eu/img_20190312_080836/" srcset="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080836-768x1024.jpg 768w, https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080836-225x300.jpg 225w" sizes="(max-width: 768px) 100vw, 768px"/></a></figure></li><li><figure><a href="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080830-768x1024.jpg"><img loading="lazy" width="768" height="1024" src="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080830-768x1024.jpg" alt="" data-id="1378" data-link="https://blog.danman.eu/img_20190312_080830/" srcset="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080830-768x1024.jpg 768w, https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190312_080830-225x300.jpg 225w" sizes="(max-width: 768px) 100vw, 768px"/></a></figure></li></ul></figure>



<p>There are two pin headers which provide 115200 baud serial access but they only show  a few lines of output (see pictures), they don’t accept any input and on the latest board revision they are not even there.</p>



<figure><img loading="lazy" width="696" height="99" src="https://blog.danman.eu/wp-content/uploads/2019/03/boot-arm.png" alt="" srcset="https://blog.danman.eu/wp-content/uploads/2019/03/boot-arm.png 696w, https://blog.danman.eu/wp-content/uploads/2019/03/boot-arm-300x43.png 300w" sizes="(max-width: 696px) 100vw, 696px"/></figure>



<figure><img loading="lazy" width="712" height="129" src="https://blog.danman.eu/wp-content/uploads/2019/03/boot-x86.png" alt="" srcset="https://blog.danman.eu/wp-content/uploads/2019/03/boot-x86.png 712w, https://blog.danman.eu/wp-content/uploads/2019/03/boot-x86-300x54.png 300w" sizes="(max-width: 712px) 100vw, 712px"/></figure>



<p>For storage the device uses a NAND flash with an eMMC controller (PS8211-0) – you can see a full description of a similar board together with boot logs at  <a href="https://www.mobile-computer-repairs.co.uk/blog/topic/29/routers/Arris-TG2492">mobile-computer-repairs.co.uk (MCR now on)</a>.  As my board showed limited boot logs and no way to influence the boot process, I tried (as some forums suggested) to short NAND pins to break the booting. But the only thing I achieved was to <strong>brick my test subject</strong> so I <strong>do not recommend</strong> this approach. </p>



<h2>Identifying the eMMC pinout</h2>



<p>MCR page shows a pinout of the eMMC, so I took an oscilloscope and started to measure signals on pins. This actually yielded conflicting results so I chose a different approach. This is a known technique and you can read about it <a href="https://www.blackhat.com/docs/us-17/wednesday/us-17-Etemadieh-Hacking-Hardware-With-A-$10-SD-Card-Reader-wp.pdf">here</a>. I scraped the solder mask from all the traces between the main CPU and eMMC to get access to the signals:</p>



<figure><img loading="lazy" width="1024" height="760" src="https://blog.danman.eu/wp-content/uploads/2019/03/router-upc-pinout-e1552293030853-1024x760.jpg" alt="" srcset="https://blog.danman.eu/wp-content/uploads/2019/03/router-upc-pinout-e1552293030853-1024x760.jpg 1024w, https://blog.danman.eu/wp-content/uploads/2019/03/router-upc-pinout-e1552293030853-300x223.jpg 300w, https://blog.danman.eu/wp-content/uploads/2019/03/router-upc-pinout-e1552293030853-768x570.jpg 768w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p>attached some wires:</p>



<figure><img loading="lazy" width="1024" height="768" src="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20180901_162444-1024x768.jpg" alt="" srcset="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20180901_162444-1024x768.jpg 1024w, https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20180901_162444-300x225.jpg 300w, https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20180901_162444-768x576.jpg 768w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p>and started to measure signals with my oscilloscope. This immediately revealed CMD and CLK pins and a few DATx pins. For the purpose of reading, I ordered Transcend TS-RDF5 SD card reader which was supposed to handle 1-bit SD mode. The revision I got has GL3233 controller on it and works  correctly.</p>



<figure><img loading="lazy" width="1024" height="768" src="https://blog.danman.eu/wp-content/uploads/2021/03/transcend-sd-reader-1024x768.jpg" alt="" srcset="https://blog.danman.eu/wp-content/uploads/2021/03/transcend-sd-reader-1024x768.jpg 1024w, https://blog.danman.eu/wp-content/uploads/2021/03/transcend-sd-reader-300x225.jpg 300w, https://blog.danman.eu/wp-content/uploads/2021/03/transcend-sd-reader-768x576.jpg 768w, https://blog.danman.eu/wp-content/uploads/2021/03/transcend-sd-reader-1536x1152.jpg 1536w, https://blog.danman.eu/wp-content/uploads/2021/03/transcend-sd-reader-2048x1536.jpg 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/><figcaption>Transcend TS-RDF5 with GL3233</figcaption></figure>



<p>Unfortunately, there is also one <a href="https://blog.danman.eu/about-adding-a-static-route-to-my-docsis-modem/#comment-44839">revision with GL3232 which doesn’t work</a>. </p>



<p>I just guessed the DAT0 pin to be the first one following CMD and it was a lucky guess :). At the end, the pinout looked like this:</p>



<figure><img loading="lazy" width="1024" height="760" src="https://blog.danman.eu/wp-content/uploads/2019/03/router-upc-pinout-desc-1-1024x760.jpg" alt="" srcset="https://blog.danman.eu/wp-content/uploads/2019/03/router-upc-pinout-desc-1-1024x760.jpg 1024w, https://blog.danman.eu/wp-content/uploads/2019/03/router-upc-pinout-desc-1-300x223.jpg 300w, https://blog.danman.eu/wp-content/uploads/2019/03/router-upc-pinout-desc-1-768x570.jpg 768w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p>Then I traced the lines towards the controller and the resulting controller pinout looks like this:</p>



<figure><img loading="lazy" width="979" height="493" src="https://blog.danman.eu/wp-content/uploads/2019/03/Phison_PS8211-0_Pinout_Ps7000-0.jpg" alt="" srcset="https://blog.danman.eu/wp-content/uploads/2019/03/Phison_PS8211-0_Pinout_Ps7000-0.jpg 979w, https://blog.danman.eu/wp-content/uploads/2019/03/Phison_PS8211-0_Pinout_Ps7000-0-300x151.jpg 300w, https://blog.danman.eu/wp-content/uploads/2019/03/Phison_PS8211-0_Pinout_Ps7000-0-768x387.jpg 768w" sizes="(max-width: 979px) 100vw, 979px"/></figure>



<p><s> 31 – CMD</s></p>



<p><strong>UPDATE 4.4. 2021</strong>: I have found a full schematic of Puma 6 modem <a href="https://fccid.io/LDKDPC3939DECT/Schematics/Schematics-1975861">here</a>. From this I was able to extract the schematic for PS7000 which seems to be the same as PS8211:</p>



<figure><img loading="lazy" width="1024" height="604" src="https://blog.danman.eu/wp-content/uploads/2021/04/PS7000-schematic-1024x604.png" alt="" srcset="https://blog.danman.eu/wp-content/uploads/2021/04/PS7000-schematic-1024x604.png 1024w, https://blog.danman.eu/wp-content/uploads/2021/04/PS7000-schematic-300x177.png 300w, https://blog.danman.eu/wp-content/uploads/2021/04/PS7000-schematic-768x453.png 768w, https://blog.danman.eu/wp-content/uploads/2021/04/PS7000-schematic-1536x907.png 1536w, https://blog.danman.eu/wp-content/uploads/2021/04/PS7000-schematic.png 1662w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p>But watch out, it is using a different pin numbering:</p>



<div><figure><img loading="lazy" width="679" height="291" src="https://blog.danman.eu/wp-content/uploads/2021/04/PS7000-pinout.png" alt="" srcset="https://blog.danman.eu/wp-content/uploads/2021/04/PS7000-pinout.png 679w, https://blog.danman.eu/wp-content/uploads/2021/04/PS7000-pinout-300x129.png 300w" sizes="(max-width: 679px) 100vw, 679px"/></figure></div>



<p>After connecting it to the card reader, my PC recognized following:</p>



<pre>[352807.254686] usb 2-2: new high-speed USB device number 49 using xhci_hcd</pre>



<p>After that I immediately dumped it to a file and started to analyze it.</p>



<pre>dd if=/dev/sdc of=upc-sub3.bin bs=1M</pre>



<p>For the connection I used a microSD breakout board which I designed:</p>



<figure><img loading="lazy" width="1024" height="768" src="https://blog.danman.eu/wp-content/uploads/2018/12/IMG_20181205_133011-1024x768.jpg" alt="" srcset="https://blog.danman.eu/wp-content/uploads/2018/12/IMG_20181205_133011-1024x768.jpg 1024w, https://blog.danman.eu/wp-content/uploads/2018/12/IMG_20181205_133011-300x225.jpg 300w, https://blog.danman.eu/wp-content/uploads/2018/12/IMG_20181205_133011-768x576.jpg 768w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p>And in later test subjects I also improved the connection setup:</p>



<figure><img loading="lazy" width="768" height="1024" src="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20181114_210722-2-768x1024.jpg" alt="" srcset="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20181114_210722-2-768x1024.jpg 768w, https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20181114_210722-2-225x300.jpg 225w" sizes="(max-width: 768px) 100vw, 768px"/></figure>



<p>and:</p>



<figure><img loading="lazy" width="768" height="1024" src="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190309_231528-768x1024.jpg" alt="" srcset="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190309_231528-768x1024.jpg 768w, https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190309_231528-225x300.jpg 225w" sizes="(max-width: 768px) 100vw, 768px"/></figure>



<p>I recommend to use a hot glue for attaching the pin header in order to prevent the thin wires from mechanical stress.</p>



<h2>Cloning</h2>



<p>As the eMMC is the only nonvolatile storage in the device, I was able to dump my “production” modem (on the picture with colorful wires) with minimal traces of tampering and to copy the whole eMMC dump to my test subject and surprisingly it worked. Later on I’ve added a convenient eMMC breakout cable and started to use to the cloned one for my internet access. If anything goes wrong, I can always flash  the working version back without problems.</p>



<figure><img loading="lazy" width="1024" height="768" src="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190310_202716-1-1024x768.jpg" alt="" srcset="https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190310_202716-1-1024x768.jpg 1024w, https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190310_202716-1-300x225.jpg 300w, https://blog.danman.eu/wp-content/uploads/2019/03/IMG_20190310_202716-1-768x576.jpg 768w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<h2>Flash contents</h2>



<p>The eMMC storage is 128MB big and contains partitions. These are actually very useful because they separate multiple kernels and filesystems so we don’t need to explore the whole flash with binwalk.</p>



<p>I created <a href="https://github.com/danielkucera/fwtools/blob/master/extract.sh" target="_blank" rel="noreferrer noopener" aria-label="extract.sh (opens in a new tab)">extract.sh</a> which extracts these partitions to separate files so I could easily analyze them and mount them via loop. First, I checked them with <code>file</code>command.</p>



<ul><li> upc-sub3.bin1: Linux kernel x86 boot executable bzImage, version 3.12.17 (jason@alphago) #1 SMP PREEMPT Tue Mar 20 18:56:18 CST 2018, RO-rootFS, swap_dev 0x3, Normal VGA</li><li> upc-sub3.bin2: Linux kernel x86 boot executable bzImage, version 2.6.39 (root@ftd-sw) #2 SMP PREEMPT Wed Apr 5 11:58:12 CST 2017, RO-rootFS, root_dev 0x801, swap_dev 0x3, Normal VGA</li><li> upc-sub3.bin3: Squashfs filesystem, little endian, version 4.0, 13826280 bytes, 2277 inodes, blocksize: 65536 bytes, created: Tue Mar 20 11:14:38 2018</li><li> upc-sub3.bin4: DOS/MBR boot sector; partition 1 : ID=0x83, start-CHS (0x36c,0,1), end-CHS (0x3ff,3,16), startsector 256, 34816 sectors; partition 2 : ID=0x5, start-CHS (0x3ff,3,16), end-CHS (0x3ff,3,16), startsector 35312, 4112 sectors, extended partition table</li><li> upc-sub3.bin5: Squashfs filesystem, little endian, version 4.0, 14369432 bytes, 1377 inodes, blocksize: 65536 bytes, created: Wed Apr  5 04:39:44 2017</li><li> upc-sub3.bin6: Linux rev 1.0 ext3 filesystem data, UUID=10ac6b3f-779b-4b07-af20-6141776df879 (needs journal recovery)</li><li> upc-sub3.bin7: data</li><li> upc-sub3.bin8: u-boot legacy uImage, Boot Script File, Linux/PowerPC, Script File (Not compressed), 8912 bytes, Tue Mar 20 11:26:12 2018, Load Address: 0x00000000, Entry Point: 0x00000000, Header CRC: 0xFF8DF93B, Data CRC: 0xC4A18791</li><li> upc-sub3.bin9: u-boot legacy uImage, Boot Script File, Linux/PowerPC, Script File (Not compressed), 8912 bytes, Wed Apr  5 05:33:39 2017, Load Address: 0x00000000, Entry Point: 0x00000000, Header CRC: 0xADC57663, Data CRC: 0xC4A18791</li><li> upc-sub3.bin10: Linux rev 1.0 ext3 filesystem data, UUID=3df5f8ad-bede-492f-9825-22605d50313c (needs journal recovery)</li><li> upc-sub3.bin11: Linux rev 1.0 ext3 filesystem data, UUID=3df5f8ad-bede-492f-9825-22605d50313c (needs journal recovery)</li><li> upc-sub3.bin12: Squashfs filesystem, little endian, version 4.0, 7994036 bytes, 731 inodes, blocksize: 131072 bytes, created: Tue Mar 20 11:26:09 2018</li><li> upc-sub3.bin13: Squashfs filesystem, little endian, version 4.0, 8068210 bytes, 706 inodes, blocksize: 131072 bytes, created: Wed Apr  5 05:33:36 2017</li><li> upc-sub3.bin14: Squashfs filesystem, little endian, version 4.0, 6108687 bytes, 666 inodes, blocksize: 131072 bytes, created: Tue Mar 20 11:26:11 2018</li><li> upc-sub3.bin15: Squashfs filesystem, little endian, version 4.0, 5493347 bytes, 602 inodes, blocksize: 131072 bytes, created: Wed Apr  5 05:33:39 2017</li></ul>



<p>The mentioned security report says, that the main SoC consists of two separate CPU cores/systems: x86 and ARMv6. Also the content of partitions suggested this. I was mounting and exploring all mountable partitions to get more info about the system.</p>



<h2>BPI/SEC Certificates</h2>



<p>The certificates which are used for <a href="https://en.wikipedia.org/wiki/DOCSIS#Security">BPI/SEC</a> are stored in partition 10:</p>



<pre># ls -la /nvram/1/security/</pre>



<pre>$ openssl x509 -in cbn_cm_euro_cert.cer -inform der --noout -text
Certificate:
     Data:
         Version: 3 (0x2)
         Serial Number: 343337499263393 (0x138437dae81a1)
         Signature Algorithm: sha1WithRSAEncryption
         Issuer: C = TW, O = Compal Broadband Networks, OU = Euro-DOCSIS, CN = Compal Broadband Networks Cable Modem Root Certificate Authority
         Validity
             Not Before: Mar 26 19:31:05 2018 GMT
             Not After : Mar 26 19:31:05 2038 GMT
         Subject: C = TW, O = Compal Broadband Networks, OU = Euro-DOCSIS, CN = 38:43:7D:AE:81:A1
         Subject Public Key Info:
             Public Key Algorithm: rsaEncryption
                 RSA Public-Key: (1024 bit)
                 Modulus:
                     00:b8:1b:65:03:78:0c:eb:b8:67:cc:14:a5:36:1d:
                     43:5a:ab:c3:48:8d:2c:79:05:74:5d:8c:b6:44:8c:
                     1e:1e:6c:b7:fa:b0:7d:cb:ce:7f:aa:b1:64:05:49:
                     31:c7:61:f3:73:56:f9:06:75:04:57:59:6f:f6:b8:
                     96:9a:17:21:59:68:1b:4b:8d:cb:bc:d3:dc:43:09:
                     6e:45:4b:03:2e:47:75:4a:b1:75:5f:6f:1e:75:9b:
                     6b:c4:04:f9:70:9a:16:d1:96:8c:d8:9b:92:d6:d0:
                     9f:33:f9:74:ca:21:ac:f7:1c:9e:a8:53:69:49:6b:
                     ab:5d:d5:47:ec:08:10:3c:a3
                 Exponent: 65537 (0x10001)
     Signature Algorithm: sha1WithRSAEncryption
          a0:56:88:ed:c5:d2:eb:0b:b2:31:15:e9:cc:3d:77:60:63:11:
          55:f7:5d:b9:85:ed:a1:d8:b5:56:c7:75:42:b4:ea:55:38:b3:
          f3:3c:39:f7:f4:9e:79:34:b7:8a:53:bd:d3:57:bd:2b:a0:cf:
          a6:80:be:bb:0b:f1:eb:42:71:45:0c:9e:86:b5:9a:bb:a5:06:
          a6:7e:05:bd:e9:4a:dd:7e:46:e2:01:9b:02:52:db:21:7e:b6:
          d7:13:99:7a:d4:f1:ad:c9:91:b1:21:f0:c2:19:fb:e8:8d:10:
          f5:62:4a:50:44:07:61:2e:c3:10:21:7e:58:f8:a9:ac:3e:34:
          f7:40:b6:88:58:bd:f8:c3:3b:47:22:5a:ed:24:0b:b7:60:0b:
          6b:37:bb:84:56:08:46:ae:d9:b3:6d:dc:2b:e8:b5:e3:ef:6a:
          d6:1c:aa:51:f7:61:6a:e4:01:0a:74:29:77:cb:bf:ee:53:7d:
          b7:27:df:ff:46:80:41:fc:00:62:36:4b:3b:ad:35:f8:0d:10:
          80:3a:d1:a0:af:e1:d2:e0:65:47:f8:66:e6:4a:28:90:ff:c5:
          ed:9c:07:b5:7a:1b:60:5f:5f:8f:ae:41:c2:87:d6:bd:60:94:
          80:6d:06:95:62:95:e6:44:d7:d5:76:bf:86:86:69:0b:15:12:
          ae:0b:3e:c6</pre>



<p>As you can see below, the key file is no known format because it is encrypted so you cannot use it in any other device.</p>



<pre>$ openssl rsa -in cbn_cm_euro_privkey.bin -inform der --noout -text</pre>



<p>One of my friends was so kind to provide a <a href="https://gist.github.com/danielkucera/fa9df248f6e0ea5dc2908743360d5cb7">decrypting program</a> so after running it, you will get a decrypted key:</p>



<pre>$ ./compal-decrypt cbn_cm_euro_privkey.bin cbn_cm_euro_privkey.bin.decrypt</pre>



<pre>$ openssl rsa -in cbn_cm_euro_privkey.bin.decrypt -inform der --noout -text

RSA Private-Key: (1024 bit, 2 primes)

...</pre>



<p>After porting these certificates to another modem (with cloned MAC) you can use the other device for internet access.</p>



<p><em>This is of course not my “production” certificate. 🙂</em></p>



<h2>Arbitrary code execution</h2>



<p>As a first target I chose the x86 system because I thought it is more important.</p>



<p>I expected that FS’s with 2018 timestamp are the actual production FW and after mounting them via <code><code><a href="https://github.com/danielkucera/fwtools/blob/master/mount-part.sh">mount-part.sh</a> upc-sub3.binX</code></code> and exploring them, I found out that p3 contains a read-only root squashfs and p6 is writable ext3 partition and contains some configuration data. I also found out that p6 is mounted as /nvram in the system. Next, I was trying to find some init script which executes another script/binary from /nvram . </p>



<p>Modifying the contents of /nvram was easy just by mounting and manipulating it on my PC. The process was following:</p>



<ol><li>explore init scripts in squashfs and look for something executed from /nvram</li><li>connect modem via reader to my PC</li><li>mount /dev/sdc6 /mnt/tst</li><li>create/mnt/tst/something which will run some command and redirect output to &gt; /nvram/something.log </li><li>chmod +x /mnt/tst/something</li><li>umount, sync and disconnect the modem</li><li>boot modem and wait few minutes</li><li>turn the modem off and connect to PC</li><li>check the presence/contents of /mnt/tst/something.log</li><li>if not successful goto 1.</li></ol>



<p> I tried several possible candidates for /nvram/something but without luck. So I needed to modify the root squashfs itself. </p>



<h2>Modifying squashfs</h2>



<p>Extracting was quite easy, I just run:</p>



<pre>$ <strong>sudo unsquashfs upc-sub3.bin3</strong></pre>



<p>After that I edited one init script:</p>



<pre>--- squashfs-root/etc/init.d/nvram    2018-03-20 11:56:47.000000000 +0100</pre>



<p>and packed back by running:</p>



<pre>sudo mksquashfs squashfs-root/* upc-sub3.bin3.nocomp -comp xz -b 65536 -noappend</pre>



<p>After that I copied the file to the real device:</p>



<pre>sudo dd if=upc-sub3.bin3.nocomp of=/dev/sdc3 bs=1M</pre>



<h2>System analysis</h2>



<p>Then I created /nvram/startup.sh with following contents:</p>



<pre>cd /nvram/

/usr/sbin/brctl show &amp;&gt; brctl.log
lsmod &gt; lsmod.log
uname -a &gt; uname.log
ip a &gt; ipa.log
ip r &gt; ipr.log
ifconfig &gt; ifconfig.log
mount &gt; mount.log
netstat -an &gt; netstat.log
ps &gt; ps.log
iptables -L -n &amp;&gt; iptablesln.log

/usr/sbin/telnetd

sync</pre>



<p>I let it run for a few minutes, turned off, connected back to my PC and checked results in /dev/sdc6. All log files were created with an interresting content, Perfect! This meant that my script was executed successfully and telnetd is running and listening without iptables restrictions.</p>



<p>This also revealed IP address 192.168.254.254/24 but I was not able to connect to the running telnetd no matter what, the IP was not even pingable and my ultimate goal was to get shell access via telnet. But in netstat it showed established connections from 192.168.254.253 which I expected to be the other ARM system. So I left if like this and started to attack the other system.</p>



<p><em>Later I have found out that to start a standard telnetd present in init scripts you only need to create file </em><code><em>/nvram/sdk/docsis_relax</em></code></p>



<h2>Exploiting the ARM core</h2>



<p>This was basically a very similar story. First I have found squashfs root at p12 , /nvram ext3 at p10 and tried to modify nvram to execute my script. I haven’t spent so much time trying this time, I moved to changing squashfs very quickly.</p>



<p>After a few tries I managed to get my /nvram/startup.sh running by modifying following:</p>



<pre>cat &lt;&lt; EOF &gt;&gt; squashfs-root/etc/scripts/docsis_active.pcd 

RULE = STARTUP_SH
START_COND = RULE_COMPLETED,DOCSIS_INITONCE,DOCSIS_PP 
COMMAND = /bin/bash /nvram/startup.sh
SCHED = NICE,0
DAEMON = NO
END_COND = NONE
END_COND_TIMEOUT = -1
FAILURE_ACTION = NONE
ACTIVE = YES
 
EOF</pre>



<p>This file seems to be read by some kind of a proprietary process manager (pcd) which ensures all required services are running. I packed it back by running:</p>



<pre>sudo mksquashfs squashfs-root/* upc-sub3.bin12.mod -comp xz -b 131072 -noappend</pre>



<p>Inside /nvram/startup.sh I put:</p>



<pre>#!/bin/bash

/nvram/telnet.sh &amp;</pre>



<p>And into /nvram/telnet.sh:</p>



<pre>while true
do
/sbin/utelnetd -p 23 -l /bin/bash
sync
sleep 1
done</pre>



<p>After booting the box… Shell access!</p>



<pre>$ telnet 192.168.0.1
Trying 192.168.0.1...
Connected to 192.168.0.1.
Escape character is &#39;^]&#39;.
/bin/bash


BusyBox v1.22.1 (2018-03-20 18:44:48 CST) built-in shell (ash)
Enter &#39;help&#39; for a list of built-in commands.

# uname -a
Linux 3.12.14 #1 PREEMPT Tue Mar 20 18:43:41 CST 2018 armv6b GNU/Linux
# cat /proc/cpuinfo 
processor       : 0
model name      : ARMv6-compatible processor rev 4 (v6b)
Features        : swp half thumb fastmult edsp java tls 
CPU implementer : 0x41
CPU architecture: 7
CPU variant     : 0x0
CPU part        : 0xb76
CPU revision    : 4

Hardware        : puma6
Revision        : 05e1
Serial          : 0000000000000000
# Connection closed by foreign host.
</pre>



<p>I run utelnetd in a loop because every time I connected via telnet, the session was live for about 10 seconds and then the utelned died. I haven’t found out why, so I put it into a loop but it really annoyed me. The available command set was also quite limited:</p>



<pre># /bin/busybox
BusyBox v1.22.1 (2018-03-20 18:44:48 CST) multi-call binary.
BusyBox is copyrighted by many authors between 1998-2012.
Licensed under GPLv2. See source distribution for detailed
copyright notices.

Usage: busybox [function [arguments]...]
   or: busybox --list
   or: function [arguments]...

        BusyBox is a multi-call binary that combines many common Unix
        utilities into a single executable.  Most people will create a
        link to busybox for each function they wish to use and BusyBox
        will act like whatever it was invoked as.

Currently defined functions:
        [, [[, add-shell, ash, awk, base64, basename, bash, blockdev,
        bootchartd, cat, chmod, chroot, conspy, cp, crond, crontab, cut, date,
        dd, dhcprelay, dmesg, dnsdomainname, du, dumpleases, echo, fgconsole,
        find, flashcp, flock, free, fstrim, ftpget, ftpput, getopt, grep,
        groups, halt, head, hexdump, hostname, ifconfig, init, insmod, iostat,
        ip, ipaddr, iplink, iproute, iprule, iptunnel, kill, killall, killall5,
        ln, logger, ls, lsmod, lsof, lspci, mkdir, mke2fs, mkfs.ext2, mknod,
        modinfo, mount, mpstat, mv, nanddump, nandwrite, nbd-client, netstat,
        ntpd, passwd, ping, ping6, pmap, poweroff, powertop, ps, pstree, pwd,
        pwdx, reboot, renice, rev, rm, rmmod, route, sed, setserial, sh,
        sha3sum, sleep, smemcap, sync, sysctl, tail, tar, test, tftp, time,
        top, tr, traceroute, traceroute6, tune2fs, ubiattach, ubidetach,
        ubimkvol, ubirmvol, ubirsvol, ubiupdatevol, udhcpc, udhcpd, umount,
        uname, unxz, users, vconfig, vi, wall, watchdog, wc, wget, which,
        whois, xz, xzcat
</pre>



<p>There was no telnet, nc, … so I started to research how to build my own (busybox) binary.</p>



<h2>Crosscompiling</h2>



<p>My best option was to use buildroot because it is very easy to use. I had no idea how to configure it so I checked some CPU info:</p>



<pre>$ cat /proc/cpuinfo
 processor       : 0
 model name      : ARMv6-compatible processor rev 4 (v6b)
 Features        : swp half thumb fastmult edsp java tls 
 CPU implementer : 0x41
 CPU architecture: 7
 CPU variant     : 0x0
 CPU part        : 0xb76
 CPU revision    : 4
 Hardware        : puma6
 Revision        : 05e1
 Serial          : 0000000000000000</pre>



<p>So I tried following:</p>



<figure><img loading="lazy" width="898" height="534" src="https://blog.danman.eu/wp-content/uploads/2019/07/buildroot-puma.png" alt="" srcset="https://blog.danman.eu/wp-content/uploads/2019/07/buildroot-puma.png 898w, https://blog.danman.eu/wp-content/uploads/2019/07/buildroot-puma-300x178.png 300w, https://blog.danman.eu/wp-content/uploads/2019/07/buildroot-puma-768x457.png 768w" sizes="(max-width: 898px) 100vw, 898px"/></figure>



<p>After running <code>make</code> it has created following busybox binary:</p>



<pre>$ file output/build/busybox-1.29.3/busybox
 output/build/busybox-1.29.3/busybox: ELF 32-bit MSB executable, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter /lib/ld-, with debug_info, not stripped</pre>



<p>This is quite close to what we need </p>



<pre>$ file bin/busybox
 bin/busybox: ELF 32-bit MSB executable, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter /lib/ld-, stripped</pre>



<p>but the linked libraries may be different so it’s better to use statically linked binary. This can be done in a following way:</p>



<pre>$ cd output/build/busybox-1.29.3/
$ make menuconfig</pre>



<figure><img loading="lazy" width="1024" height="562" src="https://blog.danman.eu/wp-content/uploads/2019/07/busybox-static-1024x562.png" alt="" srcset="https://blog.danman.eu/wp-content/uploads/2019/07/busybox-static-1024x562.png 1024w, https://blog.danman.eu/wp-content/uploads/2019/07/busybox-static-300x165.png 300w, https://blog.danman.eu/wp-content/uploads/2019/07/busybox-static-768x422.png 768w, https://blog.danman.eu/wp-content/uploads/2019/07/busybox-static.png 1177w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<figure><img loading="lazy" width="1024" height="562" src="https://blog.danman.eu/wp-content/uploads/2019/07/busybox-telnet-1024x562.png" alt="" srcset="https://blog.danman.eu/wp-content/uploads/2019/07/busybox-telnet-1024x562.png 1024w, https://blog.danman.eu/wp-content/uploads/2019/07/busybox-telnet-300x165.png 300w, https://blog.danman.eu/wp-content/uploads/2019/07/busybox-telnet-768x422.png 768w, https://blog.danman.eu/wp-content/uploads/2019/07/busybox-telnet.png 1175w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<pre>$ cd -
$ rm output/build/busybox-1.29.3/busybox
$ make busybox-rebuild
$ file output/build/busybox-1.29.3/busybox
output/build/busybox-1.29.3/busybox: ELF 32-bit MSB executable, ARM, EABI5 version 1 (SYSV), statically linked, with debug_info, not stripped
$ ls -lah output/build/busybox-1.29.3/busybox
 -rwxr-xr-x 1 root root 1.2M Jul  9 22:27 output/build/busybox-1.29.3/busybox</pre>



<p>Cool, this is what we needed and after downloading to /var on the router and running, we’ve got:</p>



<pre># cd /var/
 wget http://192.168.0.14/busybox
 Connecting to 192.168.0.14 (192.168.0.14:80)
 busybox              100% |*|  1132k  0:00:00 ETA
# chmod +x busybox
# ./busybox
 BusyBox v1.29.3 (2019-07-02 17:07:42 CEST) multi-call binary.
 BusyBox is copyrighted by many authors between 1998-2015.
 Licensed under GPLv2. See source distribution for detailed
 copyright notices.
 Usage: busybox [function [arguments]…]
    or: busybox --list[-full]
    or: busybox --install [-s] [DIR]
    or: function [arguments]…
 <code>    BusyBox is a multi-call binary that combines many common Unix     utilities into a single executable.  Most people will create a     link to busybox for each function they wish to use and BusyBox     will act like whatever it was invoked as.</code>
 Currently defined functions:
         [, [[, addgroup, adduser, ar, arch, arp, arping, ash, awk, base64, basename, blkid, bunzip2, bzcat, cat, chattr, chgrp, chmod, chown, chroot, chrt, chvt, cksum, clear, cmp, cp, cpio,
         crond, crontab, cut, date, dc, dd, deallocvt, delgroup, deluser, devmem, df, diff, dirname, dmesg, dnsd, dnsdomainname, dos2unix, du, dumpkmap, echo, egrep, eject, env, ether-wake,
         expr, factor, fallocate, false, fbset, fdflush, fdformat, fdisk, fgrep, find, flock, fold, free, freeramdisk, fsck, fsfreeze, fstrim, fuser, getopt, getty, grep, gunzip, gzip, halt,
         hdparm, head, hexdump, hexedit, hostid, hostname, hwclock, i2cdetect, i2cdump, i2cget, i2cset, id, ifconfig, ifdown, ifup, inetd, init, insmod, install, ip, ipaddr, ipcrm, ipcs,
         iplink, ipneigh, iproute, iprule, iptunnel, kill, killall, killall5, klogd, last, less, link, linux32, linux64, linuxrc, ln, loadfont, loadkmap, logger, login, logname, losetup, ls,
         lsattr, lsmod, lsof, lspci, lsscsi, lsusb, lzcat, lzma, lzopcat, makedevs, md5sum, mdev, mesg, microcom, mkdir, mkdosfs, mke2fs, mkfifo, mknod, mkpasswd, mkswap, mktemp, modprobe,
         more, mount, mountpoint, mt, mv, nameif, netstat, nice, nl, nohup, nproc, nslookup, nuke, od, openvt, partprobe, passwd, paste, patch, pidof, ping, pipe_progress, pivot_root,
         poweroff, printenv, printf, ps, pwd, rdate, readlink, readprofile, realpath, reboot, renice, reset, resize, resume, rm, rmdir, rmmod, route, run-init, run-parts, runlevel, sed, seq,
         setarch, setconsole, setfattr, setkeycodes, setlogcons, setpriv, setserial, setsid, sh, sha1sum, sha256sum, sha3sum, sha512sum, shred, sleep, sort, start-stop-daemon, strings, stty,
         su, sulogin, svc, svok, swapoff, swapon, switch_root, sync, sysctl, syslogd, tail, tar, tc, tee, telnet, telnetd, test, tftp, time, top, touch, tr, traceroute, true, truncate, tty,
         ubirename, udhcpc, uevent, umount, uname, uniq, unix2dos, unlink, unlzma, unlzop, unxz, unzip, uptime, usleep, uudecode, uuencode, vconfig, vi, vlock, w, watch, watchdog, wc, wget,
         which, who, whoami, xargs, xxd, xz, xzcat, yes, zcat</pre>



<p>Very good. Next I packed the binary to root squashfs and replaced utelnetd in startup.sh with:</p>



<pre>/bin/busybox.my telnetd -l /nvram/login.sh &gt;/nvram/telnet.std 2&gt;/nvram/telnet.err</pre>



<p>login.sh performs some basic authentication a throws you into shell. After this, the telnet connection dropped never again. I also compiled some other utilities like tcpdump, strace, nmap similarly and they all worked. This was all I needed to better look around in the system.</p>



<h2>Adding a static route</h2>



<p>The routing/firewalling on this device is a mess because it has to deal with a management interface, “inter-CPU” network, internal network, WiFi, BPI interface, IPv6 routing, AFTR, etc. It has several route tables but the one I was interrested was table “3”:</p>



<pre># ip route list table 3
 default dev ip6tnl1  scope link 
 192.168.0.0/24 dev l2sd0.2  scope link 
 192.168.101.0/24 dev lsdbr2  scope link </pre>



<p>So all I needed at the end was to run:</p>



<pre># ip route add 192.168.88.0/24 via 192.168.0.2 table 3</pre>



<p>Problem solved, job’s done. </p>



<p>There are some other topics I had to tackle during this adventure, maybe I will post a second part later. If you have any questions or comments please ask bellow.</p>



<p>Bye!</p>
	</div></div>
  </body>
</html>
