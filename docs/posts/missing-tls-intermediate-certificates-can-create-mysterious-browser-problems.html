<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/web/TLSIntermediateCertHell">Original</a>
    <h1>Missing TLS intermediate certificates can create mysterious browser problems</h1>
    
    <div id="readability-page-1" class="page"><div><h2>Missing TLS intermediate certificates can create mysterious browser problems</h2>

	<p><small>May 18, 2022</small></p>
</div><div><p>Today I wound up helping someone with a weird and mysterious browser
problem, where they couldn&#39;t connect to a particular HTTPS site
with either Chrome and Microsoft Edge on their up to date Windows
machine; when they attempted to do so, Chrome (and Edge) reported
that the TLS certificate was issued by an unknown Certificate
Authority. Firefox on their machine could connect and I could connect
with various browsers (including from Chrome and Microsoft Edge on
some Windows 10 machines I have access to). Given the title of this
entry, you already know the ultimate cause; the website&#39;s TLS
certificate was signed by an intermediate certificate that the
website wasn&#39;t serving.</p>

<p>With a missing intermediate certificate, the website&#39;s TLS certificate
looked like it was signed by an unknown CA, that being the &#34;CA&#34; of
<a href="https://utcc.utoronto.ca/~cks/space/blog/tech/TLSCertificateIdentity">the name of the intermediate certificate</a>
(although neither Chrome nor Microsoft Edge reported the name of
the unknown CA, probably for good reasons). The website worked in
other browsers because <strong>browsers silently cache intermediate TLS
certificates that they&#39;ve seen before</strong>, in addition to being willing
to download them under the right circumstances. The person who had
this problem almost never uses Chrome or Microsoft Edge (they mostly
use Firefox), so those browsers had never had the chance to see
<a href="https://ssl-tools.net/subjects/0ba882a3e868b9b611daa8a0b510253d697b0245">this particular intermediate certificate</a>
before.</p>

<p>(To make things worse, I believe that this particular intermediate
certificate is deprecated, so you won&#39;t find many sites still using
it and providing it to you.)</p>

<p>This is a hard problem for a lot of people to even see, much less
identify. The browser&#39;s intermediate certificate cache is basically
invisible and I think most browsers provide no way to clear the
cache or to explicitly check your site with an empty one (and
<a href="https://blog.mozilla.org/security/2020/11/13/preloading-intermediate-ca-certificates-into-firefox/">Firefox actively pre-populates its cache</a>,
which includes this particular intermediate certificate). If you&#39;re
a website developer or a system administrator and you check such a
site, it&#39;s very likely that your regular browsers will have the
necessary intermediate certificate cached. In Firefox, I think you
have to test your website with a new scratch profile (and do it
immediately after creating the profile before Firefox starts
downloading intermediates on you).</p>

<p>Figuring out the actual problem took me rather a long time. First
I spent a while trying some browsers in various environments, and
then I thought that Windows on the machine might have an incomplete
or damaged root certificate store. Only when I started peering very
closely at Chrome&#39;s view of certificates on another Windows machine
did I notice that the particular certificate was an intermediate
certificate, not a CA certificate, and the penny dropped. I&#39;m not
sure a non-specialist could ever have diagnosed the problem, and
even diagnosing the problem didn&#39;t make it easy to fix.</p>

<p>(The website&#39;s TLS certificate included an &#39;issuing certificate
URL&#39; (from <a href="https://www.rfc-editor.org/rfc/rfc5280.html#section-4.2.2.1">RFC 5280 section 4.2.2.1</a>), so
a browser could have distinguished this from a completely unknown
certificate authority if it wanted to.)</p>

<p>In retrospect, there was an important clue that I ignored and some
things that I should have done. The important clue was that <a href="https://github.com/square/certigo">certigo</a>, my usual tool for dumping
certificate information, reported that it couldn&#39;t verify the
certificate chain; at the time I wrote this off as &#39;maybe Fedora&#39;s
root certificate list is odd&#39;, but I shouldn&#39;t have. The obvious
thing I should have done was immediately run the site through <a href="https://www.ssllabs.com/ssltest/">the
SSL Server Test</a>, which would
have immediately pointed out the problem. I could also have tried
the site in a new scratch Firefox profile on my machine, which would
probably also have pointed out the issue.</p>

<p>(I was blinded mostly because I was thinking of this as a client problem
instead of a server one. Partly this is my Windows biases showing.)</p>

<p>In many environments, command line tools are useful for diagnosing
this sort of thing because they (mostly) don&#39;t download or cache
intermediate certificates. Instead, most of them verify the server&#39;s
TLS certificate purely from the certificates provided in the TLS
connection and the local CA trust store (which may include intermediate
certificates but usually doesn&#39;t). If your browser works but something
like <a href="https://github.com/square/certigo">certigo</a> complains, generally either there&#39;s a missing
intermediate or your system CA trust store is incomplete. I need to
remember that for the next time around.</p>

<p>PS: At one point Firefox had an about:config preference that could
be used to disable its cache of intermediate certificates, among
other things, but that preference seems to have vanished in code
rewrites since then.</p>
</div></div>
  </body>
</html>
