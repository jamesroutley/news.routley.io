<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://neuralmagic.com/blog/fast-llama-2-on-cpus-with-sparse-fine-tuning-and-deepsparse/">Original</a>
    <h1>Fast Llama 2 on CPUs with Sparse Fine-Tuning and DeepSparse</h1>
    
    <div id="readability-page-1" class="page"><div id="content">
		<div id="primary">
			<main id="main" role="main">


<section id="hero322">
	<div>

		<p><img src="https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-HEADER-Fast_Llama_2_on_CPUs_With_Sparse_Fine_Tuning_and_DeepSparse-001-1024x536.png"/>
		</p>

		

		
	</div>
</section>

<article>

	<div>
		
		<p> | <span><time datetime="2023-11-22T04:54:26-05:00">11/22/23</time></span></p>		
<h3>Key Takeaways</h3>



<ul>
<li>We expanded our Sparse Fine-Tuning research results to include Llama 2. The results include 60% sparsity with INT8 quantization and no drop in accuracy.</li>



<li>DeepSparse now supports accelerated inference of sparse-quantized Llama 2 models, with inference speeds 6-8x faster over the baseline at 60-80% sparsity.</li>



<li>We used some interesting algorithmic techniques in order to quantize Llama 2 weights and activations. We hardened the implementation and packaged them in SparseML for enterprise ML engineers to use.</li>
</ul>



<p>This year has been an exceptionally exciting year for open-source large language models (LLMs). Just 11 months ago proprietary models, like GPT-3, were the only reasonable choice for companies to build generative AI applications. Now, there is a thriving ecosystem of high-quality open-source models, like Meta’s Llama family. In February, Meta released the LLaMA models, proving it is possible to train a high-quality open-source LLM and share the recipe on how to do it. Later in the year, Meta released Llama 2, an improved version trained on twice as much data and licensed for commercial use, which made Llama 2 the top choice for enterprises building GenAI applications.</p>



<p>Neural Magic’s mission is to enable enterprises to deploy deep learning models, like Llama 2, performantly on standard CPU infrastructure. In our recent research paper collaboration with the Institute of Science and Technology Austria (ISTA), “<a href="https://arxiv.org/abs/2310.06927" title="">Sparse Fine-Tuning for Inference Acceleration of Large Language Models</a>,” we showed that combining pruning and quantization with Neural Magic&#39;s <a href="https://github.com/neuralmagic/deepsparse" title="">DeepSparse</a>, a sparsity-aware inference runtime, can accelerate LLM inference on CPUs with no drop in accuracy. This <a href="https://neuralmagic.com/blog/sparse-finetuning-for-accelerating-large-language-models-with-deepsparse/" title="">blog</a> summarizes detailed insights on the sparse fine-tuning approach, which focuses on MosaicML’s MPT architecture.</p>



<p>Today, we are excited to announce that we now support Llama 2 in DeepSparse and have extended our Sparse Fine-Tuning research to <a href="https://sparsezoo.neuralmagic.com/?architectures=llama2&amp;datasets=gsm8k&amp;subArchitectures=7b&amp;task=text_generation&amp;ungrouped=true&amp;sort=Latency%3Aasc" title="">Llama 2 7B</a>. Yet again, we are able to demonstrate the applicability of our software-acceleration approach to leading model architectures.</p>


<div>
<figure><img decoding="async" fetchpriority="high" width="1024" height="659" src="https://neuralmagic.com/wp-content/uploads/2023/11/CHART-Acceleration_of_Sparse_Fine_Tunes_LLMs_on_GSM8k-003-1024x659.png" alt="" srcset="https://neuralmagic.com/wp-content/uploads/2023/11/CHART-Acceleration_of_Sparse_Fine_Tunes_LLMs_on_GSM8k-003-1024x659.png 1024w, https://neuralmagic.com/wp-content/uploads/2023/11/CHART-Acceleration_of_Sparse_Fine_Tunes_LLMs_on_GSM8k-003-300x193.png 300w, https://neuralmagic.com/wp-content/uploads/2023/11/CHART-Acceleration_of_Sparse_Fine_Tunes_LLMs_on_GSM8k-003-768x495.png 768w, https://neuralmagic.com/wp-content/uploads/2023/11/CHART-Acceleration_of_Sparse_Fine_Tunes_LLMs_on_GSM8k-003-1536x989.png 1536w, https://neuralmagic.com/wp-content/uploads/2023/11/CHART-Acceleration_of_Sparse_Fine_Tunes_LLMs_on_GSM8k-003-2048x1319.png 2048w, https://neuralmagic.com/wp-content/uploads/2023/11/CHART-Acceleration_of_Sparse_Fine_Tunes_LLMs_on_GSM8k-003-1568x1010.png 1568w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure></div>






<h2>Recap: What is Sparse Fine-Tuning?</h2>



<p>Training a task-specific LLM consists of two steps:</p>



<ul>
<li>First, the model is trained on a very large corpus of text, to create a general model. This first step is called “pre-training.”</li>



<li>Second, the pre-trained model is then adapted for a specific downstream use case by continuing training with a much smaller, high-quality, curated dataset. This second step is called “fine-tuning”.</li>
</ul>



<p>Our paper with ISTA demonstrates that by applying model compression algorithms like pruning (which removes parameters from the network) and quantization (which converts parameters from high precision FP32 to low precision INT8) <strong><em>during the fine-tuning process</em>, </strong>we can create a highly compressed version of the model without losing accuracy. The compressed models can then be deployed with Neural Magic&#39;s DeepSparse, an inference runtime optimized to accelerate sparse-quantized models, to speed up inference by 7x over the unoptimized baseline, and to unlock CPUs as a deployment target for LLMs.</p>


<div>
<figure><img decoding="async" width="1886" height="636" src="https://neuralmagic.com/wp-content/uploads/2023/11/image1-1.png" alt="" srcset="https://neuralmagic.com/wp-content/uploads/2023/11/image1-1.png 1886w, https://neuralmagic.com/wp-content/uploads/2023/11/image1-1-300x101.png 300w, https://neuralmagic.com/wp-content/uploads/2023/11/image1-1-1024x345.png 1024w, https://neuralmagic.com/wp-content/uploads/2023/11/image1-1-768x259.png 768w, https://neuralmagic.com/wp-content/uploads/2023/11/image1-1-1536x518.png 1536w, https://neuralmagic.com/wp-content/uploads/2023/11/image1-1-1568x529.png 1568w" sizes="(max-width: 1886px) 100vw, 1886px"/></figure></div>






<h2>Llama 2 Sparse Fine-Tuning Results</h2>



<p>Similar to the MPT setup, we focused on the GSM8k dataset, which consists of diverse grade school math questions. This task is very challenging for LLMs, and the Llama 2 7B base model achieves 0% zero-shot accuracy without any fine-tuning. By fine-tuning for two epochs on the training split of GSM (just ~7k examples), we dramatically improve the test set accuracy to 35.5%.</p>


<div>
<figure><img decoding="async" width="1886" height="462" src="https://neuralmagic.com/wp-content/uploads/2023/11/image4.png" alt="" srcset="https://neuralmagic.com/wp-content/uploads/2023/11/image4.png 1886w, https://neuralmagic.com/wp-content/uploads/2023/11/image4-300x73.png 300w, https://neuralmagic.com/wp-content/uploads/2023/11/image4-1024x251.png 1024w, https://neuralmagic.com/wp-content/uploads/2023/11/image4-768x188.png 768w, https://neuralmagic.com/wp-content/uploads/2023/11/image4-1536x376.png 1536w, https://neuralmagic.com/wp-content/uploads/2023/11/image4-1568x384.png 1568w" sizes="(max-width: 1886px) 100vw, 1886px"/></figure></div>






<p>After fine-tuning, we apply <a href="https://arxiv.org/abs/2301.00774">SparseGPT</a> to prune the model and continue training (with model distillation) to recover accuracy. After converging, we apply one-shot quantization to convert both the weights and activations of the model to INT8 from FP32. At the 60% sparse INT8 optimization level, we achieve the full accuracy of the unoptimized model.</p>


<div>
<figure><img decoding="async" loading="lazy" width="1024" height="720" src="https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-CHART-Llama2_7B_GSM8k_Accuracy_with_Fine_Tuning-002-1024x720.png" alt="" srcset="https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-CHART-Llama2_7B_GSM8k_Accuracy_with_Fine_Tuning-002-1024x720.png 1024w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-CHART-Llama2_7B_GSM8k_Accuracy_with_Fine_Tuning-002-300x211.png 300w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-CHART-Llama2_7B_GSM8k_Accuracy_with_Fine_Tuning-002-768x540.png 768w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-CHART-Llama2_7B_GSM8k_Accuracy_with_Fine_Tuning-002-1536x1080.png 1536w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-CHART-Llama2_7B_GSM8k_Accuracy_with_Fine_Tuning-002-2048x1440.png 2048w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-CHART-Llama2_7B_GSM8k_Accuracy_with_Fine_Tuning-002-1568x1103.png 1568w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure></div>






<p>The resulting sparse-quantized models can be accelerated with <a href="https://github.com/neuralmagic/deepsparse">DeepSparse</a>. Running on AMD’s latest Zen 4 Genoa cores (on an AWS c7a.4xlarge instance), DeepSparse accelerates the sparse-quantized Llama models to 6-8x faster over the dense FP32 baseline.</p>


<div>
<figure><img decoding="async" loading="lazy" width="1024" height="667" src="https://neuralmagic.com/wp-content/uploads/2023/11/CHART-Llama2-Sparse_Fine_tuned_GSM8k_Text_Generation_Performance-005-1-1024x667.png" alt="" srcset="https://neuralmagic.com/wp-content/uploads/2023/11/CHART-Llama2-Sparse_Fine_tuned_GSM8k_Text_Generation_Performance-005-1-1024x667.png 1024w, https://neuralmagic.com/wp-content/uploads/2023/11/CHART-Llama2-Sparse_Fine_tuned_GSM8k_Text_Generation_Performance-005-1-300x195.png 300w, https://neuralmagic.com/wp-content/uploads/2023/11/CHART-Llama2-Sparse_Fine_tuned_GSM8k_Text_Generation_Performance-005-1-768x500.png 768w, https://neuralmagic.com/wp-content/uploads/2023/11/CHART-Llama2-Sparse_Fine_tuned_GSM8k_Text_Generation_Performance-005-1-1536x1000.png 1536w, https://neuralmagic.com/wp-content/uploads/2023/11/CHART-Llama2-Sparse_Fine_tuned_GSM8k_Text_Generation_Performance-005-1-2048x1333.png 2048w, https://neuralmagic.com/wp-content/uploads/2023/11/CHART-Llama2-Sparse_Fine_tuned_GSM8k_Text_Generation_Performance-005-1-1568x1021.png 1568w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure></div>






<h2>Technical Deep Dive: Quantizing Llama 2</h2>



<div><figure><img decoding="async" loading="lazy" width="1024" height="1024" src="https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-GRAPHIC-Fast_Llama_2_on_CPUs_With_Sparse_Fine_Tuning_and_DeepSparse-001-copy-1024x1024.png" alt="" srcset="https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-GRAPHIC-Fast_Llama_2_on_CPUs_With_Sparse_Fine_Tuning_and_DeepSparse-001-copy-1024x1024.png 1024w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-GRAPHIC-Fast_Llama_2_on_CPUs_With_Sparse_Fine_Tuning_and_DeepSparse-001-copy-300x300.png 300w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-GRAPHIC-Fast_Llama_2_on_CPUs_With_Sparse_Fine_Tuning_and_DeepSparse-001-copy-150x150.png 150w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-GRAPHIC-Fast_Llama_2_on_CPUs_With_Sparse_Fine_Tuning_and_DeepSparse-001-copy-768x768.png 768w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-GRAPHIC-Fast_Llama_2_on_CPUs_With_Sparse_Fine_Tuning_and_DeepSparse-001-copy-600x600.png 600w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-GRAPHIC-Fast_Llama_2_on_CPUs_With_Sparse_Fine_Tuning_and_DeepSparse-001-copy.png 1188w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure><p>Quantization is an important technique for compressing models and accelerating inference. Most quantization methods for LLMs (such as <a href="https://arxiv.org/abs/2210.17323">GPTQ</a>) focus on weight-only quantization. However, since the activations remain at FP16 or FP32, the weights are up-converted at inference time to compute at floating-point precision, meaning inference performance only benefits from reduced data movement (i.e., there is no compute savings; only data movement savings). Minimizing data movement is meaningful for batch 1 inference performance since batch 1 inference is memory-bound, but becomes less valuable for server scenarios where batching can be utilized and the workload becomes more compute-bound.</p></div>



<p>At Neural Magic, we focus on quantizing <span>both the weights and activations</span>, so we can compress the model and accelerate inference by reducing data movement and compute requirements. However, one of the challenges with quantizing Llama 2 activations (and LLMs in general) is that activations can be tricky due to the presence of outliers in certain layers of the network. To get a quantized value from a floating point number, we use the function <code>x_quant = round(x / scale + zero_point)</code>. When outliers are present, the quantization scale must stretch to include them. For example, if a layer has values mostly between -1 and 1, but a few outliers near -10 or 10, the quantization scale must accommodate these extreme values. Because the quantization function becomes less sensitive to variations within the normal range, small yet crucial differences in common values are not accurately captured.</p>



<p>The Neural Magic research team has developed a strong default strategy for quantizing activations for Llama 2 that overcomes these outlier issues. This strategy has been codified in “recipes” available in Neural Magic’s SparseZoo, to make it easy for enterprises to leverage our research to quantize their Llama 2 models. </p>



<p>There are two pieces to the strategy:</p>



<ul>
<li><strong>Selective Quantization</strong>: One approach to dealing with outliers is to perform “selective quantization,” where we choose not to quantize the most problematic layers (keeping these layers at FP32 while the rest of the network is at INT8). The optimal criterion for selective quantization is to quantize one layer at a time, measuring the difference in accuracy. This combinatorial process, however, is very time-consuming and our team has developed a much faster heuristic that quickly identifies the most sensitive layers without much experimentation. The graph below shows the top 10 layers of Llama 2 7B sorted by the highest range of activations (the difference between the min and max value of the input) for each layer. The largest layer has a range that is almost 4000x larger than the 10th largest one! Clearly, we will need to treat these layers differently when we develop our quantization recipes.</li>
</ul>


<div>
<figure><img decoding="async" loading="lazy" width="1024" height="556" src="https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-CHART-Top_10_Layers_by_Range_of_Input_Activations_in_Llama2_7B-002-1024x556.png" alt="" srcset="https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-CHART-Top_10_Layers_by_Range_of_Input_Activations_in_Llama2_7B-002-1024x556.png 1024w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-CHART-Top_10_Layers_by_Range_of_Input_Activations_in_Llama2_7B-002-300x163.png 300w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-CHART-Top_10_Layers_by_Range_of_Input_Activations_in_Llama2_7B-002-768x417.png 768w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-CHART-Top_10_Layers_by_Range_of_Input_Activations_in_Llama2_7B-002-1536x833.png 1536w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-CHART-Top_10_Layers_by_Range_of_Input_Activations_in_Llama2_7B-002-2048x1111.png 2048w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-CHART-Top_10_Layers_by_Range_of_Input_Activations_in_Llama2_7B-002-1568x851.png 1568w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure></div>






<ul>
<li><strong>Smoothing Approaches:</strong> In addition to selective quantization, the research community has developed several techniques to deal with outliers in the weights and activations of LLMs, such as <a href="https://arxiv.org/abs/2306.03078">SpQR</a>, <a href="https://arxiv.org/abs/2308.15987">Logarithmic Activation Equalization (LAE)</a>, and <a href="https://arxiv.org/abs/2211.10438">SmoothQuant</a>, which offer methodologies for smoothing, adjusting, or extracting the distribution of outliers in weights and activations, to reduce their impact. By applying these algorithms in concert with selective quantization, we can improve the accuracy recovery at various levels of sparsity, as indicated by the graph below, which shows SmoothQuant and LAE consistently outperforming regular quantization approaches across all sparsity levels.</li>
</ul>


<div>
<figure><img decoding="async" loading="lazy" width="1024" height="659" src="https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-CHART-Best_Quantization_Algorithms_for_Sparse_Tine_Tuned_Llama2_7B_GSM8k-001-1024x659.png" alt="" srcset="https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-CHART-Best_Quantization_Algorithms_for_Sparse_Tine_Tuned_Llama2_7B_GSM8k-001-1024x659.png 1024w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-CHART-Best_Quantization_Algorithms_for_Sparse_Tine_Tuned_Llama2_7B_GSM8k-001-300x193.png 300w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-CHART-Best_Quantization_Algorithms_for_Sparse_Tine_Tuned_Llama2_7B_GSM8k-001-768x495.png 768w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-CHART-Best_Quantization_Algorithms_for_Sparse_Tine_Tuned_Llama2_7B_GSM8k-001-1536x989.png 1536w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-CHART-Best_Quantization_Algorithms_for_Sparse_Tine_Tuned_Llama2_7B_GSM8k-001-2048x1319.png 2048w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-CHART-Best_Quantization_Algorithms_for_Sparse_Tine_Tuned_Llama2_7B_GSM8k-001-1568x1010.png 1568w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure></div>






<p>Neural Magic’s open-source model optimization toolkit (SparseML) and recipe repository (SparseZoo) contain all the tools needed to apply this quantization strategy to your Llama 2 fine-tune, to make it easy for enterprise ML engineers to create inference optimized sparse quantized Llama 2 that runs performantly with DeepSparse.</p>







<hr/>



<h2>What’s Next?</h2>



<p>This work is an example of our continued commitment and focus on industry-leading LLM optimization. We will continue to expand this research to deliver value to our users through the fast CPU deployment of LLMs that run on DeepSparse.</p>



<p>Our priorities include:</p>



<ul>
<li><strong>Productizing Sparse Fine-Tuning</strong>: We are adapting <a href="https://github.com/IST-DASLab/SparseFinetuning">the research code</a> into <a href="https://github.com/neuralmagic/sparseml">SparseML</a> to enable external users to apply Sparse Fine-Tuning to their custom datasets.</li>



<li><strong>Expanding model support:</strong> We have already applied Sparse Fine-Tuning to the popular MPT and Llama 2 architectures, and we will continue to explore Sparse Fine-Tuning with SOTA models like Mistral.</li>



<li><strong>Pushing to higher sparsity:</strong> We continue to improve our pruning algorithms to reach higher levels of sparsity.</li>
</ul>



<p>Visit the <a href="https://huggingface.co/spaces/neuralmagic/sparse-llama-gsm8k" title="">live demo of a Sparse Fine-Tuned Llama</a> running fully on just a CPU. Star and <a href="https://github.com/neuralmagic/deepsparse/blob/main/research/mpt/README.md" title="">go to the DeepSparse GitHub</a> to learn how to run these models. View all the <a href="https://sparsezoo.neuralmagic.com/?architectures=llama2&amp;datasets=gsm8k&amp;subArchitectures=7b&amp;task=text_generation&amp;ungrouped=true&amp;sort=Latency%3Aasc" title="">Llama models on SparseZoo</a>.</p>






<div>
<figure><img decoding="async" loading="lazy" width="1024" height="1024" src="https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-GRAPHIC-Fast_Llama_2_on_CPUs_With_Sparse_Fine_Tuning_and_DeepSparse-002-copy.png" alt="" srcset="https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-GRAPHIC-Fast_Llama_2_on_CPUs_With_Sparse_Fine_Tuning_and_DeepSparse-002-copy.png 1024w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-GRAPHIC-Fast_Llama_2_on_CPUs_With_Sparse_Fine_Tuning_and_DeepSparse-002-copy-300x300.png 300w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-GRAPHIC-Fast_Llama_2_on_CPUs_With_Sparse_Fine_Tuning_and_DeepSparse-002-copy-150x150.png 150w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-GRAPHIC-Fast_Llama_2_on_CPUs_With_Sparse_Fine_Tuning_and_DeepSparse-002-copy-768x768.png 768w, https://neuralmagic.com/wp-content/uploads/2023/11/BLOG-GRAPHIC-Fast_Llama_2_on_CPUs_With_Sparse_Fine_Tuning_and_DeepSparse-002-copy-600x600.png 600w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure></div>
		
	</div><!-- .entry-content -->

	<!-- .entry-footer -->

				
</article><!-- #post-${ID} -->

	<nav aria-label="Posts">
		<h2>Post navigation</h2>
		
	</nav>			</main><!-- #main -->
		</div><!-- #primary -->
	</div></div>
  </body>
</html>
