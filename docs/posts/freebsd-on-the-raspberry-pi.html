<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://cromwell-intl.com/open-source/samba-active-directory/freebsd-raspberry-pi.html">Original</a>
    <h1>FreeBSD on the Raspberry Pi</h1>
    
    <div id="readability-page-1" class="page"><article itemscope="" itemtype="http://schema.org/Article">
		<!-- start of schema.org microdata included in all pages -->
	<span itemprop="image" itemscope="" itemtype="https://schema.org/imageObject">
			<meta itemprop="url" content="https://cromwell-intl.com/open-source/raspberry-pi/pictures/raspberry-pi-4703.jpg"/>
			<meta itemprop="width" content="494px"/>
			<meta itemprop="height" content="371px"/>
		</span>
		<meta itemprop="author" content="Bob Cromwell"/>
		<span itemprop="publisher" itemscope="" itemtype="https://schema.org/organization">
			<meta itemprop="name" content="Cromwell International"/>
			<span itemprop="logo" itemscope="" itemtype="https://schema.org/imageObject">
				<meta itemprop="url" content="https://cromwell-intl.com/pictures/cartoon-headshot-2484-10pc.jpg"/>
				<meta itemprop="width" content="310px"/>
				<meta itemprop="height" content="259px"/>
			</span>
		</span>
		<meta itemprop="headline" content="Installing FreeBSD on a Raspberry Pi"/>
		<meta itemprop="datePublished" content="2022-10-01"/>
		<meta itemprop="dateModified" content="2022-10-01"/>
		<meta itemprop="mainEntityOfPage" content="https://cromwell-intl.com/open-source/samba-active-directory/freebsd-raspberry-pi.html"/>
	<!-- end of schema.org microdata -->
		<meta itemprop="about" content="Linux"/>
		<meta itemprop="about" content="Raspberry Pi"/>
		<meta itemprop="about" content="Active Directory"/>
		<meta itemprop="about" content="Samba"/>
		<header>
		<p><img src="https://cromwell-intl.com/open-source/samba-active-directory/pictures/raspberry-pi-4677-banner.jpg" alt="Raspberry Pi running Active Directory, using Samba on FreeBSD."/>
		</p>
		
		
		</header>

		<section>
		<h2> FreeBSD on the Raspberry Pi </h2>

		<p>
		<strong>We&#39;re building an Active Directory server
			from Samba running on FreeBSD, free server
			software on a free operating system.</strong>
		We have
		<a href="https://cromwell-intl.com/open-source/samba-active-directory/dns.html">set up the needed DNS infrastructure</a>
		on an existing BIND master (or primary) DNS server.
		Our next step is to put together a system that we will
		make a slave (or secondary) DNS server,
		an initial step in building a Samba-based Active Directory
		server.
		We will do this with FreeBSD running on a Raspberry Pi.
		We must take a few extra steps in this stage because of
		Samba&#39;s requirements for file system security.
		That requirement for POSIX Access Control Lists along
		with this admittedly uncommon combination of
		operating system and hardware means that I will have
		to modify a file system.
		<a href="https://cromwell-intl.com/open-source/samba-active-directory/">
			Jump back to the start</a>
		for an overview of the project.
		</p>

		</section>
		<section>
		<h2> How to install FreeBSD on a Raspberry Pi </h2>

		<a href="https://cromwell-intl.com/open-source/samba-active-directory/slave-dns.html">
			Jump to the next step if you
			aren&#39;t using FreeBSD</a>

		<p>
		I initially used a Raspberry Pi 1 Model B+ for this project.
		It has a Broadcom BCM2835 SoC or System on Chip,
		which includes a 700 MHz ARM1176JZF-S processor,
		512 MB of RAM, and a VideoCore IV GPU.
		The CPU performance is about like a 300 MHz Pentium II of
		1997-1999, so bear in mind that this is just for initial
		testing and experimentation.
		<em>Do not try to run your enterprise on a
			Raspberry Pi Model B+.</em>
		</p>

		<p>
		A Raspberry Pi 3, by comparison, has a 4-core CPU with a
		faster clock, for about 10 times the CPU performance.
		It would get the Samba suite of services running faster.
		We will see in a later step that there are something like
		13 <code>samba</code> processes,
		3 <code>smbd</code> processes, and
		2 <code>winbind</code> processes
		running simultaneously.
		More cores would definitely help.
		Still, don&#39;t run the entire enterprise on one Raspberry Pi.
		They only cost US$ 30-35.
		At least get several and set up replication,
		load balancing, and failover.
		(But seriously, you probably don&#39;t want to deploy this.)
		</p>

		

		<p>
		Both the Raspberry Pi 1 B+ and the model 3 have
		4 USB 2.0 ports, a 100 Mbps Ethernet port,
		and HDMI video and audio output.
		You power it from something like a smart phone charger,
		ideally one that provides more current than the
		usual 1000 mA.
		</p>

		<p>
		I later moved the project to a 4-core Raspberry Pi 3.
		That provides more CPU cores for all the server processes.
		</p>

		<div>

			<p><img src="https://cromwell-intl.com/open-source/samba-active-directory/pictures/raspberry-pi-141644-700px.jpg" alt="Raspberry Pi running FreeBSD." loading="lazy"/>
			</p>

			<div>
			<p><img src="https://cromwell-intl.com/open-source/samba-active-directory/pictures/raspberry-pi-142936-700px.jpg" alt="Raspberry Pi running FreeBSD." loading="lazy"/></p><p>
			A single-core Raspberry Pi Model B+.
			</p>
			</div>

		</div>

		<p>
		You can download FreeBSD images from
		<a href="http://www.raspbsd.org/raspberrypi.html">
			raspbsd.org</a>
		or from
		<a href="ftp://ftp.freebsd.org/pub/FreeBSD/snapshots/arm/">
			freebsd.org</a>.
		</p>

		<p>
		There is also a page about FreeBSD on the Raspberry Pi at
		<a href="https://wiki.freebsd.org/FreeBSD/arm/Raspberry%20Pi">
			FreeBSD.org</a>,
		although that page seems to be updated much less frequently.
		</p>

		

		<p>
		I&#39;m doing this on Linux.
		If you&#39;re writing the image on a BSD system with one disk
		<code>/dev/sd0*</code>,
		the microSD card will appear as something like
		<code>/dev/sd1i</code>
		and the device inventory will not change.
		On either Linux or BSD,
		look at the kernel ring buffer with:</p>

		<p>
		I downloaded the image, uncompressed it, and wrote it
		onto a memory card with <code>dd</code>.
		Be very careful to select the correct device!
		I ran <code>df</code> first, and if I were using LVM I
		would have run <code>pvscan</code>,
		all of that to inventory all the disks holding my data.
		Then get a listing of all device files <code>/dev/sd*</code>.
		</p>

		<p>
		Now plug in the USB device with the SD memory card and
		see what was added.
		As I have several disks in my system, <code>/dev/sda</code>
		through <code>sdf</code>, I saw that the two new devices
		were <code>sdg</code> and <code>sdg1</code>.
		This is because the card has an IBM MBR partition table
		defining one partition spanning the device, and a VFAT
		file system in that partition.
		</p>

		<p>
		Write the image onto the entire device,
		<em>being careful to choose the correct target location.</em>
		Change &#34;sdX&#34; as appropriate in the following.
		I used <code>sdg</code> but <em>don&#39;t destroy your data
			by overwriting the wrong device.</em>
		</p>

		<pre># <strong>dd if=FreeBSD-*-RPI-*.img of=/dev/sd<em>X</em> bs=10M</strong> </pre>

		<p>
		I connected an Ethernet cable and the power supply,
		and waited for it to boot up.
		I saw it get an IP address from my DHCP server.
		I connected in over SSH as user <code>raspberry</code>
		with password <code>raspberry</code>
		for the image from 
		<a href="http://www.raspbsd.org/raspberrypi.html">
			raspbsd.org</a>.
		From there I could run <code>su</code> to become
		<code>root</code> without a password.
		Here&#39;s the resulting file system.
		It resizes the root partition to fill the device at
		first boot.
		My &#34;disk&#34; is a 32 GB microSD card.
		</p>

		<pre>$ <strong>df -hT</strong>
Filesystem      Type       Size    Used   Avail Capacity  Mounted on
/dev/mmcsd0s2a  ufs         29G    1.8G     25G     7%    /
devfs           devfs      1.0K    1.0K      0B   100%    /dev
/dev/mmcsd0s1   msdosfs     17M    4.1M     13M    24%    /boot/msdos
/dev/md0        ufs         29M     24K     26M     0%    /tmp
/dev/md1        ufs         14M     56K     13M     0%    /var/log
/dev/md2        ufs        4.4M    8.0K    4.0M     0%    /var/tmp </pre>

		

		</section>
		<section>
		<h3> Setting up my user account </h3>

		<p>
		I created a user account for myself with the same UID/GID
		as on my other systems, and copied <code>.vimrc</code>,
		<code>.cshrc</code>, and <code>.ssh/</code> into place.
		I also added myself to the <code>wheel</code> group.
		</p>

		</section>
		<section>
		<h3> Modifying <code>/etc/rc.conf</code> </h3>

		<p>
		My main Linux system has one interface on the interior
		network, with hostname <code>router</code> resolving
		to both IPv4 and IPv6 addresses.
		It runs the
		<a href="http://v6web.litech.org/radvd/">RADVD</a>
		IPv6 Router Advertisement Daemon,
		and forwards both IPv4 and IPv6 to and from the Internet
		on another interface connected to a cable modem.
		It advertises a fc00::/7 prefix internally as per
		<a href="https://tools.ietf.org/html/rfc4193">RFC 4193</a>.
		</p>

		<p>
		The FreeBSD <code>/etc/rc.conf</code> file originally
		contained these lines (along with several others):
		</p>

		<pre>hostname=&#34;raspberry-pi&#34;
ifconfig_ue0=&#34;DHCP&#34;
#ntpd_enable=&#34;YES&#34;
syslogd_enable=&#34;NO&#34; </pre>

		<p>
		I replaced those lines with the following to
		customize the hostname and networking.
		</p>

		<pre><span>##ORIGINAL hostname=&#34;raspberry-pi&#34;</span>
hostname=&#34;freebsd&#34;
<span>##ORIGINAL ifconfig_ue0=&#34;DHCP&#34;</span>
ifconfig_ue0=&#34;inet 10.1.1.235/24&#34;
defaultrouter=&#34;router.example.com&#34;
ipv6_prefix_ue0=&#34;fc00:0:0:0&#34;
ipv6_defaultrouter=&#34;router.example.com&#34;
<span>##ORIGINAL #ntpd_enable=&#34;YES&#34;</span>
ntpd_enable=&#34;YES&#34;
<span>##ORIGINAL syslogd_enable=&#34;NO&#34;</span>
syslogd_enable=&#34;yes&#34; </pre>

		<p>
		I restarted networking with the <code>/etc/netstart</code>
		script and found that things have worked:
		</p>

		<pre>$ <strong>ifconfig</strong>
lo0: flags=8049&lt;UP,LOOPBACK,RUNNING,MULTICAST&gt; metric 0 mtu 16384
	options=600003&lt;RXCSUM,TXCSUM,RXCSUM_IPV6,TXCSUM_IPV6&gt;
	inet6 ::1 prefixlen 128
	inet6 fe80::1%lo0 prefixlen 64 scopeid 0x1
	inet 127.0.0.1 netmask 0xff000000
	groups: lo
	nd6 options=21&lt;PERFORMNUD,AUTO_LINKLOCAL&gt;
ue0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
	options=80009&lt;RXCSUM,VLAN_MTU,LINKSTATE&gt;
	ether b8:27:eb:41:b9:ae
	inet 10.1.1.235 netmask 0xffffff00 broadcast 10.1.1.255
	inet6 fe80::ba27:ebff:fe41:b9ae%ue0 prefixlen 64 scopeid 0x2
	inet6 fc00::ba27:ebff:fe41:b9ae prefixlen 64
	media: Ethernet autoselect (100baseTX &lt;full-duplex&gt;)
	status: active
	nd6 options=21&lt;PERFORMNUD,AUTO_LINKLOCAL&gt;

$ <strong>netstat -r</strong>
Routing tables

Internet:
Destination          Gateway             Flags     Netif Expire
default              router.example.com  UGS         ue0
10.1.1.0/24          link#2              U           ue0
freebsd.example.com  link#2              UHS         lo0
localhost            link#1              UH          lo0

Internet6:
Destination          Gateway             Flags     Netif Expire
::/96                localhost           UGRS        lo0
default              router.example.com  UGS         ue0
localhost            link#1              UH          lo0
::ffff:0.0.0.0/96    localhost           UGRS        lo0
fc00::/64            link#2              U           ue0
fc00::ba27:ebff:fe   link#2              UHS         lo0
fe80::/10            localhost           UGRS        lo0
fe80::%lo0/64        link#1              U           lo0
fe80::1%lo0          link#1              UHS         lo0
fe80::%ue0/64        link#2              U           ue0
fe80::ba27:ebff:fe   link#2              UHS         lo0
ff02::/16            localhost           UGRS        lo0

$ <strong>traceroute www.google.com</strong>
 1  router.example.com (10.1.1.100)  1.703 ms  1.499 ms  1.422 ms
 2  96.120.112.89 (96.120.112.89)  17.280 ms  9.576 ms  10.053 ms
 3  68.85.180.213 (68.85.180.213)  9.543 ms  9.771 ms  9.768 ms
 4  68.86.184.189 (68.86.184.189)  10.917 ms  11.047 ms  11.122 ms
 5  68.86.197.49 (68.86.197.49)  22.263 ms  21.605 ms  21.943 ms
 6  be-33491-cr01.chicago.il.ibone.comcast.net (68.86.92.33)  23.310 ms  23.166 ms  22.689 ms
 7  be-10506-cr02.350ecermak.il.ibone.comcast.net (68.86.86.229)  25.958 ms  27.498 ms  27.028 ms
 <span>[... several hops deleted ...]</span>
15  209.85.250.237 (209.85.250.237)  46.348 ms  47.041 ms  46.873 ms
16  den03s09-in-f4.1e100.net (216.58.217.4)  46.300 ms  46.433 ms  46.700 ms

$ <strong>traceroute6 www.google.com</strong>
 1  router.example.com  2.055 ms  1.903 ms  1.797 ms
 2  2001:558:600d:16::1  10.707 ms  10.560 ms  11.185 ms
 3  2001:558:302:191::1  9.734 ms  10.111 ms  9.955 ms
 4  2001:558:320:9a::2  9.845 ms  9.364 ms  9.548 ms
 5  2001:558:300:15c::1  18.606 ms  17.251 ms  17.699 ms
 6  2001:558:300:2003::1  28.996 ms  29.607 ms  29.016 ms
 7  be-33491-cr02.350ecermak.il.ibone.comcast.net  30.339 ms  30.031 ms  31.602 ms
 <span>[... several hops deleted ...]</span>
15  2001:4860:0:1::121f  49.468 ms
    2001:4860::1:0:a619  56.989 ms
    2001:4860:0:1::121f  49.451 ms
16  den03s09-in-x04.1e100.net  49.241 ms  57.925 ms  58.238 ms </pre>

		

		</section>
		<section>
		<h3> Configuring Syslog </h3>

		<p>
		I edited <code>/etc/syslog</code> and commented out
		all the lines sending output to files.
		Then I added one line to the end, sending all syslog output
		to my log collector.
		The result is:
		</p>

		<pre># <strong>egrep -v &#39;^#|^$&#39; /etc/syslog.conf</strong>
include		/etc/syslog.d
include		/usr/local/etc/syslog.d
<span>*.*</span>		<span>@10.1.1.100</span></pre>

		<p>
		The syslogd daemon on FreeBSD does not include its hostname
		in the message.
		Its message is simply the timestamp,
		<code><em>daemon</em>[<em>PID</em>]</code>, and then the message.
		Compare that to other syslog daemons that insert the
		hostname after the timestamp.
		</p>
		<p>
		If there is no hostname or IP address in the message,
		the log collector will insert the IP address of the source.
		If the log collector is using Rsyslog,
		add a new file to get it to resolve that to a name.
		It can be named anything as long as it ends
		&#34;<code>.conf</code>&#34;.
		</p>

		<pre># <strong>cat /etc/rsyslog.d/fqdn.conf</strong>
$PreserveFQDN on
# <strong>systemctl restart rsyslog</strong> </pre>

		</section>
		<section>
		<h3> Configuring the time zone </h3>

		<p>
		Until you set the time zone with <code>tzsetup</code>,
		times and dates will be reported in UTC as
		no local time has been defined.
		You have <em>many</em> choices, they are defined by the files
		under <code>/usr/share/zoneinfo</code>.
		Do something like this:
		</p>

		<pre># <strong>tzsetup EST5EDT</strong> </pre>

		<p>
		Refer to the hierarchy of files,
		in the Yukon you could do something like this:
		</p>

		<pre># <strong>tzsetup America/Yellowknife</strong> </pre>

		<p>
		Also recall that we configured the NTP daemon to run.
		Kerberos requires time synchronization.
		</p>

		

		</section>
		<section>
		<h3> Mounting the root file system with POSIX ACLs </h3>

		<p>
		Samba requires that the file system support
		POSIX access-control lists.
		I modified <code>/etc/fstab</code>,
		additions are highlighted in yellow:
		</p>

		<pre>/dev/mmcsd0s1	/boot/msdos	msdosfs rw,noatime	0 0
/dev/mmcsd0s2a	/		ufs rw,noatime<b>,acls</b>		1 1
md		/tmp		mfs rw,noatime,-s30m<b>,acls</b>	0 0
md		/var/log	mfs rw,noatime,-s15m<b>,acls</b>	0 0
md		/var/tmp	mfs rw,noatime,-s5m<b>,acls</b>	0 0 </pre>

		<p>
		However, the <code>mount</code> command after the next boot
		showed that the root file system was mounted with
		the incompatible <code>nfsv4acls</code> option.
		The others all had the requested <code>acls</code> option.
		The following line went to <code>/var/log/messages</code>
		at each reboot:
		</p>

		<pre>freebsd kernel: WARNING: /: NFSv4 ACLs flag on fs conflicts with &#34;acls&#34; mount option; option ignored
</pre>

		<p>
		This was mysterious, as <code>kenv</code> showed that the
		kernel environment looked right:
		</p>

		<pre># <strong>kenv</strong>
LINES=&#34;24&#34;
autoboot_delay=&#34;10&#34;
bootfile=&#34;kernel&#34;
console=&#34;uboot&#34;
currdev=&#34;disk0s2a:&#34;
interpret=&#34;OK&#34;
kernel=&#34;kernel&#34;
kernelname=&#34;/boot/kernel/kernel&#34;
loaddev=&#34;disk0s2a:&#34;
loader_conf_files=&#34;/boot/loader.conf /boot/loader.conf.local&#34;
module_path=&#34;/boot/kernel;/boot/kernel;/boot/modules;/boot/dtb&#34;
prompt=&#34;loader&gt;&#34;
twiddle_divisor=&#34;1&#34;
<span>vfs.root.mountfrom=&#34;ufs:/dev/mmcsd0s2a&#34;</span>
<span>vfs.root.mountfrom.options=&#34;rw,noatime,acls&#34;</span>
</pre>

		<p>
		I tried creating a new file <code>/boot/loader.conf.local</code>
		with these contents:
		</p>

		<pre>vfs.root.mountfrom.options=&#34;rw,nonfsv4acls,acls,noatime&#34; </pre>

		<p>
		That added the <code>nonfsv4acls</code> option to the
		kernel environment, but it did not have the desired effect.
		</p>

		<p>
		Other file systems could be interactively modified:
		</p>

		<pre># <strong>mount | grep /var/tmp</strong>
/dev/md2 on /var/tmp (ufs, local, noatime, soft-updates, <span>acls</span>)
# <strong>mount -u -o noatime,<span>noacls,nfsv4acls</span> /var/tmp</strong>
# <strong>mount | grep /var/tmp</strong>
/dev/md2 on /var/tmp (ufs, local, noatime, soft-updates, <span>nfsv4acls</span>)
# <strong>mount -u -o noatime,<span>acls,nonfsv4acls</span> /var/tmp</strong>
/dev/md2 on /var/tmp (ufs, local, noatime, soft-updates, <span>acls</span>)
</pre>

		<p>
		But for the root file system, the <code>mount</code> command
		to change the options ran with no error or warning message,
		and exited with a status of 0.
		However, the attributes did not change:
		</p>

		<pre># <strong>mount | grep s2a</strong>
/dev/mmcsd0s2a on / (ufs, local, noatime, journaled soft-updates, <span>nfsv4acls</span>)
# <strong>mount -u -o noatime,<span>acls,nonfsv4acls</span> /</strong>
# <strong>echo $?</strong>
<span>0</span>
# <strong>mount | grep s2a</strong>
/dev/mmcsd0s2a on / (ufs, local, noatime, journaled soft-updates, <span>nfsv4acls</span>)
</pre>

		<p>
		The problem is that the root file system in the Raspberry Pi
		image is set to <em>always</em> use the <code>nfsv4acls</code>
		option for NFSv4 ACLs.
		If NFSv4 ACLs are in use, POSIX ACLs cannot be enabled.
		</p>

		<p>
		As explained on the
		<a href="https://www.freebsd.org/doc/handbook/fs-acl.html">
			FreeBSD Access Control Lists</a>,
		page, the mount-time flag can be set in a persistent manner
		by modifying a flag in the <em>superblock,</em>
		the file system header.
		If a flag is set there, it will be used.
		It cannot be modified without unmounting the file system,
		and you cannot unmount the root file system.
		</p>

		<p>
		As that page explains, for security you want to
		mark the file system itself, precisely for the reason that
		I was unable to proceed — an intruder who gains root
		access cannot disable ACL protection.
		ACLs that are enforced within the superblock
		can prevent a user with otherwise unlimited power
		from modifying protected components of the file system.
		</p>

		

		<p>
		I agree with the logic.
		This is analogous to the reason why in Linux you should not
		be able to disable the Security-Enhanced Linux protection
		while the kernel is running.
		You should be forced to reboot the system and disable it
		at boot time, requiring physical access to the console.
		Notice that Red Hat chooses to build their kernels to
		allow it to be changed during run time, decreasing security
		but making it easy to help their customers solve problems.
		The kernel build configuration variable is
		SECURITY_SELINUX_DISABLE,
		&#34;y&#34; means that it can be disabled while running.
		In the kernel build configuration interface:
		Security Options →
		NSA SELinux Support →
		NSA SELinux runtime disable.
		</p>

		<a href="https://cromwell-intl.com/open-source/linux-kernel.html">
			Building </a>

		<p>
		Samba requires POSIX ACLs for part of its database,
		maintained under <code>/var/db/samba4</code>.
		It uses the ACLs for the part under
		<code>/var/db/samba4/sysvol</code>.
		</p>
		<p>
		There is no other persistent file system
		(<code>/var/log</code>, <code>/var/tmp</code>,
		and <code>/tmp</code> are
		based on RAM, the <code>md</code> pseudodevice.
		</p>

		<p>
		<strong>So, the root file system itself has to be modified,
			and <code>tunefs</code> is
			the tool for the job.</strong>
		</p>

		<p>
		On typical server hardware I could reboot and request
		a boot to single-user or maintenance mode.
		Or, I could boot from media.
		But neither is possible here.
		</p>

		<p>
		I plugged in an HDMI cable to the TV,
		plugged in a USB keyboard, and rebooted.
		The problem was that the early boot environment doesn&#39;t
		see a USB keyboard.
		So, I couldn&#39;t send any key to stop the automated boot
		and ask for a boot into single-user mode.
		</p>

		<p>
		I manually shut down the network services, using
		<code>lsof -i</code> to see what remained.
		</p>
		<p>
		Then I manually unmounted the <code>/boot/msdos</code>,
		<code>/var/log</code>, <code>/var/tmp</code>,
		and <code>/tmp</code> file systems.
		</p>
		<p>
		Then I manually terminated all the processes I could.
		The <code>getty</code> processes respawn.
		</p>
		<p>
		Finally, I forced a change from read/write to read-only:
		</p>

		<pre># <strong>sync</strong>
# <strong>sync</strong>
# <strong>sync</strong>
# <strong>mount -f -u -o ro /</strong> </pre>

		<p>
		Now I could use <code>tunefs</code> to disable
		the NFSv4 ACL enable flag in the file system,
		and <code>dumpfs</code> to verify that it worked:
		</p>

		<pre># <strong>dumpfs / | grep flags</strong>
<span>flags   soft-updates+journal nfsv4acls </span>
# <strong>tunefs -N disable /</strong>
tunefs: NFSv4 acls cleared
tunefs: filesystem reloaded
# <strong>tunefs -a enable /</strong>
tunefs: POSIX 1.e ACLs set
tunefs: filesystem reloaded
# <strong>dumpfs / | head -22</strong>
magic   19540119 (UFS2) time    Fri Feb 17 19:42:56 2017
superblock location     65536   id      [ 5887d304 7cce2791 ]
ncg     130     size    7787248 blocks  7540727
bsize   32768   shift   15      mask    0xffff8000
fsize   4096    shift   12      mask    0xfffff000
frag    8       shift   3       fsbtodb 3
minfree 8%      optim   time    symlinklen 120
maxbsize 32768  maxbpg  4096    maxcontig 4     contigsumsize 4
nbfree  883015  ndir    5571    nifree  3844183 nffree  471
bpg     7493    fpg     59944   ipg     30080   unrefs  0
nindir  4096    inopb   128     maxfilesize     2252349704110079
sbsize  4096    cgsize  16384   csaddr  1920    cssize  4096
sblkno  24      cblkno  32      iblkno  40      dblkno  1920
cgrotor 0       fmod    0       ronly   0       clean   0
metaspace 2392  avgfpdir 64     avgfilesize 16384
<span>flags   soft-updates+journal acls</span>
fsmnt   /
volname         swuid   0       providersize    7787248

cs[].cs_(nbfree,ndir,nifree,nffree):
	(1635,451,25991,4) (15,441,24276,7) (57,440,25955,109) (190,443,23526,23)
	(1949,30,23230,41) (2266,150,24514,113) (4308,356,26422,58) (3137,218,27997,61)

# <strong>tunefs -p /</strong>
tunefs: POSIX.1e ACLs: (-a)                                <span>enabled</span>
tunefs: NFSv4 ACLs: (-N)                                   <span>disabled</span>
tunefs: MAC multilabel: (-l)                               disabled
tunefs: soft updates: (-n)                                 enabled
tunefs: soft update journaling: (-j)                       enabled
tunefs: gjournal: (-J)                                     disabled
tunefs: trim: (-t)                                         disabled
tunefs: maximum blocks per file in a cylinder group: (-e)  4096
tunefs: average file size: (-f)                            16384
tunefs: average number of files in a directory: (-s)       64
tunefs: minimum percentage of free space: (-m)             8%
tunefs: space to hold for metadata blocks: (-k)            2392
tunefs: optimization preference: (-o)                      time
tunefs: volume label: (-L)                                 
</pre>

		<p>
		The <em>soft updates</em> mechanism drastically improves
		file system performance.
		It buffers metadata updates through a memory cache.
		Details are available at the
		<a href="https://www.freebsd.org/doc/handbook/configtuning-disk.html">
			FreeBSD disk tuning</a>
		page.
		</p>

		

		</section>
		<section>
		<h3 id="samba"> Adding Samba and BIND </h3>

		<p>
		I ran out of space on <code>/tmp</code>
		while doing the initial package updating,
		so I umounted it for a while and let it use the root
		partition.
		At the end there wasn&#39;t anything left in <code>/tmp</code>
		so there was no need to clean up before remounting it.
		I later ran out of space again when doing a
		<code>pkg search</code>, so I commented out the line
		in <code>/etc/fstab</code> defining <code>/tmp</code>.
		29 MB of space in <code>/tmp</code> just isn&#39;t enough!
		</p>

		<p>
		It&#39;s a RAM-based &#34;memory device&#34;, faster but limited in size.
		I <em>could</em> make it larger, but RAM is already
		limited on this platform.
		</p>

		<p>
		There wasn&#39;t a package literally named &#34;samba&#34;, or &#34;bind&#34;,
		or &#34;named&#34;.
		That&#39;s because those packages are available in different
		versions, with the version numbers in the names:
		</p>

		<pre># <strong>pkg search &#39;^bind|^named|^samba&#39;</strong>
bind-tools-9.11.0P2            Command line tools from BIND: delv, dig, host, nslookup...
bind9-devel-9.12.0.a.2017.01.21 BIND DNS suite with updated DNSSEC and DNS64
bind910-9.10.4P5_1             BIND DNS suite with updated DNSSEC and DNS64
bind911-9.11.0P2_1             BIND DNS suite with updated DNSSEC and DNS64
bind99-9.9.9P5_1               BIND DNS suite with updated DNSSEC and DNS64
bindgraph-0.3_1                RRDtool frontend for BIND statistics
bindtest-1.56_1                Test bind() semantics of IPv6 sockets
samba-nsupdate-9.8.6_1         nsupdate utility with GSS-TSIG support
samba-virusfilter-0.1.3_1      On-access anti-virus filter for Samba
samba36-3.6.25_3               Free SMB and CIFS client and server for Unix
samba36-libsmbclient-3.6.25_2  Shared lib from the samba package
samba36-nmblookup-3.6.25       NetBIOS Name lookup tool
samba36-smbclient-3.6.25       Samba &#34;ftp-like&#34; client
samba42-4.2.14                 Free SMB/CIFS and AD/DC server and client for Unix
samba43-4.3.13_1               Free SMB/CIFS and AD/DC server and client for Unix
</pre>

		<p>
		OK, so the package with BIND is called &#34;bind&#34; and not &#34;named&#34;.
		</p>

		<a href="https://cromwell-intl.com/open-source/package-management.html">
			Package management on BSD (and Linux and Solaris)</a>

		<p>
		I initially installed BIND 9.11 (<code>bind911</code>)
		and Samba 4.3 (<code>samba43</code>),
		went through everything that follows, and only then found
		that Samba 4.3 only supports BIND 9.10.
		Samba uses <em>dynamically loadable zones</em> (or DLZ),
		which can be accessed through the AD schema.
		We must have a compatible combination of BIND and Samba.
		Here&#39;s the information from Samba&#39;s page on the
		<a href="https://wiki.samba.org/index.php/BIND9_DLZ_DNS_Back_End">
			BIND 9 DLZ DNS back end</a>.
		</p>

		<table>
			<tbody><tr>
				<td> <strong> BIND Version </strong> </td>
				<td> <strong> Supported starting with </strong> </td>
			</tr>
			<tr>
				<td> BIND 9.11 </td> <td> Samba 4.5.2 </td>
			</tr>
			<tr>
				<td> BIND 9.10 </td> <td> Samba 4.2 </td>
			</tr>
			<tr>
				<td> BIND 9.9 </td> <td> Samba 4.0 </td>
			</tr>
			<tr>
				<td> BIND 9.8 </td> <td> Samba 4.0 </td>
			</tr>
		</tbody></table>


		<p>
		Let&#39;s install the latest available version of Samba,
		and the latest available <em>and compatible</em>
		version of BIND:
		</p>

		<pre># <strong>pkg install bind910 samba43</strong>
Updating FreeBSD repository catalogue...
FreeBSD repository is up-to-date.
All repositories are up-to-date.
The following 43 package(s) will be affected (of 0 checked):

New packages to be INSTALLED:
	bind910: 9.10.4P6
	samba43: 4.3.13_1
	 <span>[... more packages deleted ...]</span>

Number of packages to be installed: 43

The process will require 404 MiB more space.
68 MiB to be downloaded.

Proceed with this action? [y/N]: y
Fetching bind910-9.10.4P6.txz: 100%    5 MiB 901.5kB/s    00:06
Fetching samba43-4.3.13_1.txz: 100%   21 MiB 810.3kB/s    00:27
Fetching libxml2-2.9.4.txz: 100%  740 KiB 378.9kB/s    00:02
<span>[... more packages deleted ...]</span>

<span>[... many installations deleted ...]</span>
The OpenLDAP client package has been successfully installed.

Edit
  /usr/local/etc/openldap/ldap.conf
to change the system-wide client defaults.

Try `man ldap.conf&#39; and visit the OpenLDAP FAQ-O-Matic at
  http://www.OpenLDAP.org/faq/index.cgi?file=3
for more information.

<span>[... more installations deleted ...]</span>
Message from bind910-9.10.4P6:
**********************************************************************
*            _  _____ _____ _____ _   _ _____ ___ ___  _   _         *
*           / \|_   _|_   _| ____| \ | |_   _|_ _/ _ \| \ | |        *
*          / _ \ | |   | | |  _| |  \| | | |  | | | | |  \| |        *
*         / ___ \| |   | | | |___| |\  | | |  | | |_| | |\  |        *
*        /_/   \_\_|   |_| |_____|_| \_| |_| |___\___/|_| \_|        *
*                                                                    *
*   BIND requires configuration of rndc, including a &#34;secret&#34; key.   *
*    The easiest, and most secure way to configure rndc is to run    *
*   &#39;rndc-confgen -a&#39; to generate the proper conf file, with a new   *
*            random key, and appropriate file permissions.           *
*                                                                    *
*     The /usr/local/etc/rc.d/named script will do that for you.     *
*                                                                    *
**********************************************************************

<span>[... more installations deleted ...]</span>
Message from samba43-4.3.13_1:
===============================================================================

How to start: http://wiki.samba.org/index.php/Samba4/HOWTO

* Your configuration is: /usr/local/etc/smb4.conf

* All the relevant databases are under: /var/db/samba4

* All the logs are under: /var/log/samba4

* Provisioning script is: /usr/local/bin/samba-tool

For additional documentation check: http://wiki.samba.org/index.php/Samba4
</pre>

		<p>
		The key for BIND was automatically generated the first
		time it started.
		The key is stored in
		<code>/usr/local/etc/namedb/rncd.key</code>.
		You use it if you control BIND with the program
		<code>rndc</code>, but you will probably use the script
		<code>/usr/local/etc/rc.d/named</code>.
		Run it with no argument to see your choices, the
		parameters <code>start</code>,
		<code>stop</code>,
		<code>restart</code>,
		<code>reload</code>, and
		<code>status</code> cover most needs.
		</p>
		<p>
		I also added <code>lsof</code> and <code>vim</code>.
		</p>

		</section>

		<h3> The next step... </h3>

		<p>
		The next step is to turn the new FreeBSD system into a
		<a href="https://cromwell-intl.com/open-source/samba-active-directory/slave-dns.html">
			slave DNS server</a>.
		</p>

		<div>

			

			

			<div>
			<p><img src="https://cromwell-intl.com/open-source/samba-active-directory/pictures/raspberry-pi-141644-300px.jpg" alt="Raspberry Pi running FreeBSD." loading="lazy"/></p><p>
			Raspberry Pi running FreeBSD with BIND and Samba
			software installed.
			</p>
			</div>

		</div>

		<nav>
		<p>
		<a href="https://cromwell-intl.com/open-source/">
			Other Linux Topics</a>
		</p>
		</nav>

		<!-- start of footer.html -->

</article></div>
  </body>
</html>
