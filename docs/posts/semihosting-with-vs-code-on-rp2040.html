<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mcuoneclipse.com/2023/10/14/semihosting-with-vs-code-on-rp2040/">Original</a>
    <h1>Semihosting with VS Code on RP2040</h1>
    
    <div id="readability-page-1" class="page"><div>
		
<p>With semihosting I can use standard I/O function like <code>printf() </code>and I can read and write data on the host through the debug connection. If used with care, this is a great feature especially for unit testing.</p>



<figure><a href="https://mcuoneclipse.files.wordpress.com/2023/10/rp2040-pico-w-board-with-j-link-edu.png"><img data-attachment-id="39010" data-permalink="https://mcuoneclipse.com/2023/10/14/semihosting-with-vs-code-on-rp2040/rp2040-pico-w-board-with-j-link-edu/" data-orig-file="https://mcuoneclipse.files.wordpress.com/2023/10/rp2040-pico-w-board-with-j-link-edu.png" data-orig-size="672,526" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="rp2040-pico-w-board-with-j-link-edu" data-image-description="" data-image-caption="" data-medium-file="https://mcuoneclipse.files.wordpress.com/2023/10/rp2040-pico-w-board-with-j-link-edu.png?w=300" data-large-file="https://mcuoneclipse.files.wordpress.com/2023/10/rp2040-pico-w-board-with-j-link-edu.png?w=584" width="672" height="526" src="https://mcuoneclipse.files.wordpress.com/2023/10/rp2040-pico-w-board-with-j-link-edu.png?w=672" alt="" srcset="https://mcuoneclipse.files.wordpress.com/2023/10/rp2040-pico-w-board-with-j-link-edu.png 672w, https://mcuoneclipse.files.wordpress.com/2023/10/rp2040-pico-w-board-with-j-link-edu.png?w=150 150w, https://mcuoneclipse.files.wordpress.com/2023/10/rp2040-pico-w-board-with-j-link-edu.png?w=300 300w" sizes="(max-width: 672px) 100vw, 672px"/></a><figcaption>Raspberry Pi Pico-W (RP2040) board</figcaption></figure>



<h2>Outline</h2>



<p>Semihosting is a technology originally defined by ARM to allow communication between the host and the target. It is named â€˜semiâ€™ because half of the work is on the target and half of the work is on the host. Basically with semihosting the target runs into a special breakpoint, the debugger catches the breakpoint, reads the target command and executes read and write operations, depending on the command. For details see my other article: <a href="https://mcuoneclipse.com/2023/03/09/using-semihosting-the-direct-way/">Using Semihosting the directÂ Way</a>.</p>



<p>With semihosting I can</p>



<ul>
<li>redirect standard I/O like printf() or scanf() to the host (telnet or gdb console)</li>



<li>open/read/write files on the host</li>



<li>Other operations as implemented in <a href="https://github.com/ErichStyger/McuOnEclipseLibrary/blob/master/lib/src/McuSemihost.c">McuSemihost.c</a></li>
</ul>



<p>In this article I show how I can use semihosting with the Raspberry Pi Pico (RP2040, for example the pico board or the pico-w board, Visual Studio Code, the Cortex-Debug extension and using a <a href="https://www.segger.com/">SEGGER J-Link</a>.</p>



<h2>Semihosting Standard I/O Library</h2>



<p>To use semihosting, link your application with the <code>pico_stdio_semihosting</code> library. One way is to add it with <code>target_link_libraries</code>:</p>



<figure><a href="https://mcuoneclipse.files.wordpress.com/2023/10/pico_stdio_semihosting.png"><img data-attachment-id="39012" data-permalink="https://mcuoneclipse.com/2023/10/14/semihosting-with-vs-code-on-rp2040/pico_stdio_semihosting/" data-orig-file="https://mcuoneclipse.files.wordpress.com/2023/10/pico_stdio_semihosting.png" data-orig-size="637,206" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="pico_stdio_semihosting" data-image-description="" data-image-caption="" data-medium-file="https://mcuoneclipse.files.wordpress.com/2023/10/pico_stdio_semihosting.png?w=300" data-large-file="https://mcuoneclipse.files.wordpress.com/2023/10/pico_stdio_semihosting.png?w=584" width="637" height="206" src="https://mcuoneclipse.files.wordpress.com/2023/10/pico_stdio_semihosting.png?w=637" alt="" srcset="https://mcuoneclipse.files.wordpress.com/2023/10/pico_stdio_semihosting.png 637w, https://mcuoneclipse.files.wordpress.com/2023/10/pico_stdio_semihosting.png?w=150 150w, https://mcuoneclipse.files.wordpress.com/2023/10/pico_stdio_semihosting.png?w=300 300w" sizes="(max-width: 637px) 100vw, 637px"/></a><figcaption>adding pico_stdio_semihosting library</figcaption></figure>



<blockquote>
<p>ðŸ’¡ You might notice the other stdio libraries I have added above: the nice thing with the RP2040 SDK is that I can use standard I/O redirection to USB CDC, UART and Semihosting, all the same time. If I have enabled standard I/O for all of them, e.g. text with printf() is written to all enabled output channels.</p>
</blockquote>



<p>The other way is to add the following to the <code>CMakeLists.txt</code>:</p>



<pre>pico_enable_stdio_semihosting(${CMAKE_PROJECT_NAME} ENABLED)</pre>



<h2>Initialization</h2>



<p>In the application initialization code, I have to init the library:</p>



<p>First, include the header file:</p>


<div><pre title="">#include &#34;pico/stdio_semihosting.h&#34;
</pre></div>


<p>Then initialize the library:</p>


<div><pre title="">stdio_semihosting_init();
</pre></div>


<p>Further, I can configure how CR-LF is treated:</p>


<div><pre title="">stdio_set_translate_crlf(&amp;stdio_semihosting, false);
</pre></div>


<h2>Semihosting Hard Fault Handler</h2>



<p>Semihosting works with debugger breakpoints. If no debugger is attached, the breakpoint will cause an exception and the application wonâ€™t run. For this Iâ€™m using a special hardfault handler which allows me to run the application with no active debug session. The handler is implemented in the McuLib and the module <a href="https://github.com/ErichStyger/McuOnEclipseLibrary/blob/master/lib/src/McuHardFault.c">McuHardFault</a>.</p>



<p>I include the header file:</p>


<div><pre title="">#include &#34;McuHardFault.h&#34;
</pre></div>


<p>and initialize it, so it overwrites the default Hardfault handler of the SDK:</p>





<p>With this, any semihosting exceptions will be skipped in the handler, allowing the application to run.</p>



<p>Cortex-Debug</p>



<p>The <a href="https://marketplace.visualstudio.com/items?itemName=marus25.cortex-debug">Cortex-Debug extension</a> supports semihosting, and requires special launch settings to work. Below is my <code>debug.json</code> using a J-Link:</p>


<div><pre title="">{
    &#34;version&#34;: &#34;0.2.0&#34;,
    &#34;configurations&#34;: [
        {
            &#34;name&#34;: &#34;TSM_PicoW_Blinky Cortex-Debug&#34;,
            &#34;type&#34;: &#34;cortex-debug&#34;,
            &#34;request&#34;: &#34;launch&#34;,
            &#34;servertype&#34;: &#34;jlink&#34;,
            &#34;serverpath&#34;: &#34;${env:PICO_SEGGER_PATH}/JLinkGDBServerCL.exe&#34;, // or: set in global json: cortex-debug.JLinkGDBServerPath
            &#34;cwd&#34;: &#34;${workspaceRoot}&#34;,
            &#34;executable&#34;: &#34;${command:cmake.launchTargetPath}&#34;,
            &#34;armToolchainPath&#34;: &#34;${env:PICO_TOOLCHAIN_PATH}&#34;,  // needed for the gdb
            &#34;device&#34;: &#34;RP2040_M0_0&#34;,
            &#34;interface&#34;: &#34;swd&#34;,
            &#34;serialNumber&#34;: &#34;&#34;, // add J-Link serial number if having multiple attached the same time.
            &#34;runToEntryPoint&#34;: &#34;main&#34;, // &#34;_reset_handler&#34; or for example &#34;main&#34;
            &#34;postLaunchCommands&#34;: [
                &#34;monitor semihosting enable&#34;,
                &#34;monitor semihosting ioclient 3&#34;, // 1: telnet (port 2333); 2: gdb; 3: both telnet and gdbclient output
            ],
            &#34;postRestartCommands&#34;: [],
            &#34;postResetCommands&#34;: [],
             &#34;rtos&#34;: &#34;FreeRTOS&#34;,
            &#34;svdFile&#34;: &#34;${env:PICO_SDK_PATH}/src/rp2040/hardware_regs/rp2040.svd&#34;,
            &#34;rttConfig&#34;: {
                &#34;enabled&#34;: false,
                &#34;address&#34;: &#34;auto&#34;,
                &#34;decoders&#34;: [
                    {
                        &#34;label&#34;: &#34;&#34;,
                        &#34;port&#34;: 0,
                        &#34;type&#34;: &#34;console&#34;
                    }
                ]
            },
            &#34;showDevDebugOutput&#34;: &#34;none&#34;,
        }
    ]
}
</pre></div>


<p>The important part is this:</p>


<div><pre title="">&#34;postLaunchCommands&#34;: [
                &#34;monitor semihosting enable&#34;,
                &#34;monitor semihosting ioclient 3&#34;, // 1: telnet (port 2333); 2: gdb; 3: both telnet and gdbclient output
            ],
</pre></div>


<p>This enables semihosting with the J-Link debug probe and uses <code>telnet </code>and <code>gdbclient </code>for the communication.</p>



<h2>Debug</h2>



<p>Time to check it: use some <code>printf()</code> in your code and the output will be written to the Debug Console:</p>



<figure><a href="https://mcuoneclipse.files.wordpress.com/2023/10/semihosting-output.png"><img data-attachment-id="39025" data-permalink="https://mcuoneclipse.com/2023/10/14/semihosting-with-vs-code-on-rp2040/semihosting-output-3/" data-orig-file="https://mcuoneclipse.files.wordpress.com/2023/10/semihosting-output.png" data-orig-size="1239,768" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="semihosting-output" data-image-description="" data-image-caption="" data-medium-file="https://mcuoneclipse.files.wordpress.com/2023/10/semihosting-output.png?w=300" data-large-file="https://mcuoneclipse.files.wordpress.com/2023/10/semihosting-output.png?w=584" width="1239" height="768" src="https://mcuoneclipse.files.wordpress.com/2023/10/semihosting-output.png?w=1024" alt="" srcset="https://mcuoneclipse.files.wordpress.com/2023/10/semihosting-output.png?w=1024 1024w, https://mcuoneclipse.files.wordpress.com/2023/10/semihosting-output.png 1239w, https://mcuoneclipse.files.wordpress.com/2023/10/semihosting-output.png?w=150 150w, https://mcuoneclipse.files.wordpress.com/2023/10/semihosting-output.png?w=300 300w, https://mcuoneclipse.files.wordpress.com/2023/10/semihosting-output.png?w=768 768w" sizes="(max-width: 1239px) 100vw, 1239px"/></a><figcaption>Semihosting with VS Code</figcaption></figure>



<h2>Summary</h2>



<p>Semihosting is just another nice way for standard I/O communication with the target. Using the RP2040 SDK I need to link with a library and initialize it. I recommend to use the special McuHardFault handler to enable the application running without debugger too. Just keep in mind that standard I/O semihosting and semihosting in general can be intrusive. I recommend to use the <a href="https://mcuoneclipse.com/2023/03/09/using-semihosting-the-direct-way/">McuSemihosting </a>library which is faster and includes file I/O and other features.</p>



<p>Happy hosting ðŸ™‚</p>



<h3>Links</h3>



<ul>
<li><a href="https://mcuoneclipse.com/2023/03/09/using-semihosting-the-direct-way/">Using Semihosting the directÂ Way</a></li>



<li><a href="https://mcuoneclipse.com/2022/01/25/semihosting-with-nxp-mcuxpresso-sdk-and-frdm-ke02z/">Silicon Shortage and Semihosting with NXP MCUXpresso SDK onÂ FRDM-KE02Z</a></li>



<li><a href="https://mcuoneclipse.com/2012/11/24/debugging-hard-faults-on-arm-cortex-m/">Debugging Hard Faults on ARMÂ Cortex-M</a></li>



<li>Cortex-Debug extension: <a href="https://marketplace.visualstudio.com/items?itemName=marus25.cortex-debug">https://marketplace.visualstudio.com/items?itemName=marus25.cortex-debug</a></li>
</ul>
			
			
						</div></div>
  </body>
</html>
