<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://deno.com/blog/roll-your-own-javascript-runtime-pt3">Original</a>
    <h1>Roll your own JavaScript runtime, pt. 3</h1>
    
    <div id="readability-page-1" class="page"><div><p><em>This post is a continuation of
<a href="https://payments.posthaven.com/blog/roll-your-own-javascript-runtime" title="null" rel="noopener noreferrer">Roll your own JavaScript runtime</a> and
<a href="https://payments.posthaven.com/blog/roll-your-own-javascript-runtime-pt2" title="null" rel="noopener noreferrer">Roll your own JavaScript runtime, pt. 2</a>.</em></p>
<p>We&#39;ve been delighted by the positive response to this series on rolling your own
custom JavaScript runtime. One area that
<a href="https://github.com/denoland/deno/issues/18503" title="null" rel="noopener noreferrer">some expressed interest in</a> is
how to use snapshots to get faster startup times. Snapshots can provide improved
performance at a (typically) negligible increase in filesize.</p>
<p>In this blog post, we&#39;ll build on the
<a href="https://payments.posthaven.com/blog/roll-your-own-javascript-runtime" title="null" rel="noopener noreferrer">first</a> and
<a href="https://payments.posthaven.com/blog/roll-your-own-javascript-runtime-pt2" title="null" rel="noopener noreferrer">second part</a> by creating a snapshot
of <code>runtime.js</code> in a build script, then loading that snapshot in <code>main.rs</code> to
speed up start time for our custom runtime.</p>
<p><a href="https://www.youtube.com/watch?v=zlJrMGm-XeA" title="null" rel="noopener noreferrer"><img src="https://payments.posthaven.com/blog/roll-your-own-javascript-runtime-pt3/roll-own-js-runtime-screencap.png" alt="Screenshot of the video walkthrough from Andy and Leo" title=""/></a></p>
<p><em><a href="https://www.youtube.com/watch?v=zlJrMGm-XeA" title="null" rel="noopener noreferrer">Watch the video demo</a> or
<a href="https://github.com/denoland/roll-your-own-javascript-runtime/" title="null" rel="noopener noreferrer">view source code here</a>.</em></p>
<h2 id="getting-setup"><a aria-hidden="true" tabindex="-1" href="#getting-setup"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Getting setup</h2><p>If you followed <a href="https://payments.posthaven.com/blog/roll-your-own-javascript-runtime" title="null" rel="noopener noreferrer">the first</a> and
<a href="https://payments.posthaven.com/blog/roll-your-own-javascript-runtime-pt2" title="null" rel="noopener noreferrer">second blog post</a>, your project
should have three files:</p>
<ul>
<li><code>example.ts</code>: the JavaScript file we intend to execute with the custom runtime</li>
<li><code>src/main.rs</code>: the asynchronous Rust function that creates an instance of
<a href="https://docs.rs/deno_core/latest/deno_core/struct.JsRuntime.html" title="null" rel="noopener noreferrer"><code>JsRuntime</code></a>,
which is responsible for JavaScript execution</li>
<li><code>src/runtime.js</code>: the runtime interface that defines and provides the API that
will interop with the <code>JsRuntime</code> from <code>main.rs</code></li>
</ul>
<p>Let&#39;s write a <code>build.rs</code> file that will create a snapshot of the custom runtime,
<code>runjs</code>.</p>
<h2 id="creating-a-snapshot-in-buildrs"><a aria-hidden="true" tabindex="-1" href="#creating-a-snapshot-in-buildrs"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Creating a snapshot in <code>build.rs</code></h2><p>Before create a <code>build.rs</code> file, let&#39;s first add <code>deno_core</code> as a build
dependency in <code>Cargo.toml</code>:</p>
<div><pre>[package]
name = &#34;runjs&#34;
version = &#34;0.1.0&#34;
edition = &#34;2021&#34;

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html

[dependencies]
deno_ast = { version = &#34;0.22.0&#34;, features = [&#34;transpiling&#34;] }
deno_core = &#34;0.174.0&#34;
reqwest = &#34;0.11.14&#34;
tokio = { version = &#34;1.25.0&#34;, features = [&#34;full&#34;] }

<span><span>+</span><span> [build-dependencies]
</span><span>+</span><span> deno_core = &#34;0.174.0&#34;</span></span></pre></div><p>Next, let&#39;s create a <code>build.rs</code> file in the root of your project. In this file,
we&#39;ll have to do the following steps:</p>
<ul>
<li>Create a small extension of <code>src/runtime.js</code></li>
<li>Build a file path to the snapshot</li>
<li>Create the snapshot</li>
</ul>
<p>Putting the above steps into code, your <code>build.rs</code> script should look like:</p>
<div><pre><span>use</span> <span>std<span>::</span></span>env<span>;</span>
<span>use</span> <span>std<span>::</span>path<span>::</span></span><span>PathBuf</span><span>;</span>
<span>use</span> <span>deno_core<span>::</span></span><span>{</span><span>Extension</span><span>,</span> include_js_files<span>}</span><span>;</span>

<span>fn</span> <span>main</span><span>(</span><span>)</span> <span>{</span>
  <span>// Create the runjs extension.</span>
  <span>let</span> runjs_extension <span>=</span> <span>Extensions</span><span>::</span><span>builder</span><span>(</span><span>&#34;runjs&#34;</span><span>)</span>
    <span>.</span><span>esm</span><span>(</span><span>include_js_files!</span><span>(</span>
      <span>&#34;src/runtime.js&#34;</span><span>,</span>
    <span>)</span><span>)</span>
    <span>.</span><span>build</span><span>(</span><span>)</span><span>;</span>

  <span>// Build the file path to the snapshot.</span>
  <span>let</span> o <span>=</span> <span>PathBuf</span><span>::</span><span>from</span><span>(</span><span>env<span>::</span></span><span>var_os</span><span>(</span><span>&#34;OUT_DIR&#34;</span><span>)</span><span>.</span><span>unwrap</span><span>(</span><span>)</span><span>)</span><span>;</span>
  <span>let</span> snapshot_path <span>=</span> o<span>.</span><span>join</span><span>(</span><span>&#34;RUNJS_SNAPSHOT.bin&#34;</span><span>)</span><span>;</span>

  <span>// Create the snapshot.</span>
  <span>deno_core<span>::</span>snapshot_util<span>::</span></span><span>create_snapshot</span><span>(</span><span>deno_core<span>::</span>snapshot_util<span>::</span></span><span>CreateSnapshotOptions</span> <span>{</span>
    cargo_manifest_dir<span>:</span> <span>env!</span><span>(</span><span>&#34;CARGO_MANIFEST_DIR&#34;</span><span>)</span><span>,</span>
    snapshot_path<span>:</span> snapshot_path<span>,</span>
    startup_snapshot<span>:</span> <span>None</span><span>,</span>
    extensions<span>:</span> <span>vec!</span><span>(</span>runjs_extension<span>)</span><span>,</span>
    compression_cb<span>,</span> <span>None</span><span>,</span>
    <span>Snapshot_module_load_cb</span><span>:</span> <span>None</span><span>,</span>
  <span>}</span><span>)</span>
<span>}</span></pre></div><p>The main function is <code>create_snapshot</code>, which accepts several options. Let&#39;s go
over them in the next section.</p>
<h2 id="diving-into-createsnapshotoptions"><a aria-hidden="true" tabindex="-1" href="#diving-into-createsnapshotoptions"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Diving into <code>CreateSnapshotOptions</code></h2><p>The <code>create_snapshot</code> function is a nice abstraction layer that uses an options
struct to determine how the snapshot is created. Let&#39;s go over the different
fields that are available in <code>CreateSnapshotOptions</code>.</p>
<div><pre><span>pub</span> <span>struct</span> <span>CreateSnapshotOptions</span> <span>{</span>
  <span>pub</span> cargo_manifest_dir<span>:</span> <span>&amp;</span><span>&#39;static</span> <span>str</span><span>,</span>
  <span>pub</span> snapshot_path<span>:</span> <span>PathBuf</span><span>,</span>
  <span>pub</span> startup_snapshot<span>:</span> <span>Option</span><span>&lt;</span><span>Snapshot</span><span>&gt;</span><span>,</span>
  <span>pub</span> extensions<span>:</span> <span>Vec</span><span>&lt;</span><span>Extensions</span><span>&gt;</span><span>,</span>
  <span>pub</span> compression_cb<span>:</span> <span>Option</span><span>&lt;</span><span>Box</span><span>&lt;</span><span>CompressionCb</span><span>&gt;&gt;</span><span>,</span>
  <span>pub</span> snapshot_module_load_cb<span>:</span> <span>Option</span><span>&lt;</span><span>ExtModuleLoaderCb</span><span>&gt;</span><span>,</span>
<span>}</span></pre></div><ul>
<li><code>cargo_manifest_dir</code>: the directory in which Cargo will be compiling
everything into. This should always be the <code>CARGO_MANIFEST_DIR</code> environment
variable.</li>
<li><code>snapshot_path</code>: the path where we write the snapshot to.</li>
<li><code>startup_snapshot</code>: you can pass in a snapshot, if you want to build a
snapshot from another snapshot.</li>
<li><code>extensions</code>: any extensions that you would like to add on top of the snapshot</li>
<li><code>compression_cb</code>: you can set which compression method to use to further
reduce the filesize.</li>
<li><code>snapshot_module_load_cb</code>: you can pass a module loader that will transform
files included in the snapshot. For example, you can transpile TypeScript to
JavaScript.</li>
</ul>
<p>In this example, we only use:</p>
<ul>
<li><code>snapshot_path</code>: we define the snapshot path by resolving <code>OUT_DIR</code> and
<code>RUNJS_SNAPSHOT.bin</code>.</li>
<li><code>extensions</code>: we pass the <code>runjs_extension</code>, which is built from
<code>src/runtime.js</code>.</li>
</ul>
<h2 id="loading-the-snapshot-in-mainrs"><a aria-hidden="true" tabindex="-1" href="#loading-the-snapshot-in-mainrs"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Loading the snapshot in <code>main.rs</code></h2><p>Currently, the <code>main.rs</code> file&#39;s <code>run_js</code> function loads the <code>runjs_extension</code>.
We&#39;ll modify this function to instead load the snapshot we created in
<code>build.rs</code>:</p>
<div><pre><span><span>-</span><span> use deno_core::include_js_files;
</span></span><span><span>+</span><span> use deno_core::Snapshot;
</span></span>
// Other stuff…

<span><span>+</span><span> static RUNTIME_SNAPSHOT: &amp;[u8] = include_bytes!(concat!(env!(&#34;OUT_DIR&#34;), &#34;/RUNJS_SNAPSHOT.bin&#34;));
</span></span>
async fn run_js(file_path: &amp;str) -&gt; Result&lt;(), AnyError&gt; {
<span><span> </span><span>   let main_module = deno_core::resolve_path(file_path)?;
</span><span> </span><span>   let runjs_extension = Extension::builder(&#34;runjs&#34;)
</span></span><span><span>-</span><span>         .esm(include_js_files!(
</span><span>-</span><span>             &#34;runtime.js&#34;,
</span><span>-</span><span>         ))
</span></span><span><span> </span><span>       .ops(vec![
</span><span> </span><span>           op_read_file::decl(),
</span><span> </span><span>           op_write_file::decl(),
</span><span> </span><span>           op_remove_file::decl(),
</span><span> </span><span>           op_fetch::decl(),
</span><span> </span><span>           op_set_timeout::decl(),
</span><span> </span><span>       ])
</span><span> </span><span>       .build();
</span><span> </span><span>   let mut js_runtime = deno_core::JsRuntime::new(deno_core::RuntimeOptions {
</span><span> </span><span>       module_loader: Some(Rc::new(TsModuleLoader)),
</span></span><span><span>+</span><span>      startup_snapshot: Some(Snapshot::Static(RUNTIME_SNAPSHOT)),
</span></span><span><span> </span><span>       extensions: vec![runjs_extension],
</span><span> </span><span>       ..Default::default()
</span><span> </span><span>   });
</span></span>
<span><span> </span><span>   let mod_id = js_runtime.load_main_module(&amp;main_module, None).await?;
</span><span> </span><span>   let result = js_runtime.mod_evaluate(mod_id);
</span><span> </span><span>   js_runtime.run_event_loop(false).await?;
</span><span> </span><span>   result.await?
</span></span>}</pre></div><p>We&#39;ll remove the <code>.esm()</code> function, since that was moved to <code>build.rs</code> script.
Then, we&#39;ll add a line to load the snapshot.</p>
<p>Finally, to load the snapshot, we&#39;ll add <code>startup_snapshot</code> in <code>RuntimeOptions</code>
that points to the <code>RUNTIME_SNAPSHOT</code>, which is defined above <code>run_js</code> as a
static slice of bytes of the snapshot we created in <code>build.rs</code>.</p>
<p>And that&#39;s it! Let&#39;s try running with:</p>
<pre><code>cargo run -- example.ts</code></pre><p>It should work!</p>
<h2 id="whats-next"><a aria-hidden="true" tabindex="-1" href="#whats-next"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>What&#39;s next?</h2><p>Snapshotting is an excellent tool to help improve startup speeds for a custom
runtime. This is an extremely simple example, but we hope that it sheds some
light into how Deno uses snapshots to optimize performance.</p>
<p>Through this series, we&#39;ve shown how to build your own custom JavaScript
runtime, add APIs like <code>fetch</code>, and now speed up startup times via snapshotting.
We love hearing from you so if there&#39;s anything you want us to cover, please let
us know on <a href="https://twitter.com/deno_land" title="null" rel="noopener noreferrer">Twitter</a>,
<a href="https://youtube.com/@deno_land" title="null" rel="noopener noreferrer">YouTube</a>, or
<a href="https://discord.gg/deno" title="null" rel="noopener noreferrer">Discord</a>.</p>
<p><em>Don&#39;t miss any updates — follow us on
<a href="https://twitter.com/deno_land" title="null" rel="noopener noreferrer">Twitter</a>.</em></p>
</div></div>
  </body>
</html>
