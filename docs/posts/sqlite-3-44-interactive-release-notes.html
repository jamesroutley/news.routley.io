<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://antonz.org/sqlite-3-44/">Original</a>
    <h1>SQLite 3.44: Interactive release notes</h1>
    
    <div id="readability-page-1" class="page"><div><div><article><div><div><header></header><p>SQlite 3.44 is just around the corner, and it has some decent features, so I think now it&#39;s a good time to show them off. Let&#39;s get started!</p><h2 id="order-by-in-aggregates">ORDER BY in aggregates</h2><p>Aggregate functions now accept an optional <code>order by</code> after the last parameter. It defines an order in which the function processes its arguments.</p><p><code>order by</code> in aggregates is probably not very useful in <code>avg</code>, <code>count</code> and other functions whose result does not depend on the order of the arguments. However, it can be quite handy for functions like <a href="https://sqlite.org/draft/lang_aggfunc.html#group_concat"><code>group_concat</code></a> and <a href="https://sqlite.org/draft/json1.html#jgrouparray"><code>json_group_array</code></a>.</p><p>Let&#39;s say we have an <code>employees</code> table:</p><pre tabindex="0"><code>┌────┬───────┬────────┬────────────┬────────┐
│ id │ name  │  city  │ department │ salary │
├────┼───────┼────────┼────────────┼────────┤
│ 11 │ Diane │ London │ hr         │ 70     │
│ 12 │ Bob   │ London │ hr         │ 78     │
│ 21 │ Emma  │ London │ it         │ 84     │
│ 22 │ Grace │ Berlin │ it         │ 90     │
│ 23 │ Henry │ London │ it         │ 104    │
│ 24 │ Irene │ Berlin │ it         │ 104    │
│ 25 │ Frank │ Berlin │ it         │ 120    │
│ 31 │ Cindy │ Berlin │ sales      │ 96     │
│ 32 │ Dave  │ London │ sales      │ 96     │
│ 33 │ Alice │ Berlin │ sales      │ 100    │
└────┴───────┴────────┴────────────┴────────┘
</code></pre><p><a href="https://antonz.org/sql-window-functions-book/employees.sql">↓ employees.sql</a></p><p>Suppose we want to show employees who work in each of the departments, so we group by <code>department</code> and use <code>group_concat</code> on the <code>name</code>. Previously, we had to rely on the default record order. But now we can concatenate the employees in straight or reverse alphabetical order (or any other order — try changing the <code>order by</code> clause below):</p><div><pre tabindex="0"><code data-lang="sql"><span><span><span>select</span>
</span></span><span><span>  <span>department</span>,
</span></span><span><span>  <span>group_concat</span>(<span>name</span> <span>order</span> <span>by</span> <span>name</span> <span>desc</span>) <span>as</span> <span>names</span>
</span></span><span><span><span>from</span> <span>employees</span>
</span></span><span><span><span>group</span> <span>by</span> <span>department</span>;
</span></span></code></pre></div><codapi-snippet sandbox="sqlite" editor="basic" template="sample.sql"></codapi-snippet><p>Now let&#39;s group employees by city using <code>json_group_array</code>:</p><div><pre tabindex="0"><code data-lang="sql"><span><span><span>select</span>
</span></span><span><span>  <span>value</span> <span>-&gt;&gt;</span> <span>&#39;city&#39;</span> <span>as</span> <span>city</span>,
</span></span><span><span>  <span>json_group_array</span>(
</span></span><span><span>    <span>value</span> <span>-&gt;</span> <span>&#39;name&#39;</span> <span>order</span> <span>by</span> <span>value</span> <span>-&gt;&gt;</span> <span>&#39;id&#39;</span>
</span></span><span><span>  ) <span>as</span> <span>json_names</span>
</span></span><span><span><span>from</span>
</span></span><span><span>  <span>json_each</span>(<span>readfile</span>(<span>&#39;employees.json&#39;</span>))
</span></span><span><span><span>group</span> <span>by</span>
</span></span><span><span>  <span>value</span> <span>-&gt;&gt;</span> <span>&#39;city&#39;</span>
</span></span></code></pre></div><codapi-snippet sandbox="sqlite" editor="basic" files="employees.json"></codapi-snippet><p>Nice!</p><h2 id="better-string-concatenation">Better string concatenation</h2><p>As you probably know, the <code>group_concat</code> function is SQLite (and MySQL) specific. In other databases (namely, PostgreSQL and SQL Server) the function is called <code>string_agg</code>. As of 3.44, SQLite also supports <code>string_agg</code> as an alias for <code>group_concat(expr, sep)</code>:</p><div><pre tabindex="0"><code data-lang="sql"><span><span><span>select</span>
</span></span><span><span>  <span>department</span>,
</span></span><span><span>  <span>string_agg</span>(<span>name</span>, <span>&#39;;&#39;</span>) <span>as</span> <span>names</span>
</span></span><span><span><span>from</span> <span>employees</span>
</span></span><span><span><span>group</span> <span>by</span> <span>department</span>;
</span></span></code></pre></div><codapi-snippet sandbox="sqlite" editor="basic" template="sample.sql"></codapi-snippet><p>Now the only black sheep is Oracle, where the poor function is called <code>listagg</code>.</p><p>Speaking of concatenation, this release brings a couple of scalar string functions:</p><ul><li><a href="https://sqlite.org/draft/lang_corefunc.html#concat"><code>concat(arg, ...)</code></a> joins non-null arguments without a separator.</li><li><a href="https://sqlite.org/draft/lang_corefunc.html#concat_ws"><code>concat_ws(sep, arg, ...)</code></a> joins non-null arguments using the separator.</li></ul><div><pre tabindex="0"><code data-lang="sql"><span><span><span>select</span> <span>concat_ws</span>(<span>&#39;: &#39;</span>, <span>id</span>, <span>name</span>) <span>as</span> <span>employee</span>
</span></span><span><span><span>from</span> <span>employees</span>
</span></span><span><span><span>where</span> <span>city</span> <span>=</span> <span>&#39;London&#39;</span>;
</span></span></code></pre></div><codapi-snippet sandbox="sqlite" editor="basic" template="sample.sql"></codapi-snippet><p>Both functions are also available in PostgreSQL, MySQL and SQL Server.</p><h2 id="thorough-date-formatting">Thorough date formatting</h2><p>The <a href="https://sqlite.org/lang_datefunc.html#strftm"><code>strftime</code></a> function was already quite powerful. Now it accepts even more formatting verbs:</p><ul><li><code>%F</code> ISO 8601 date: YYYY-MM-DD</li><li><code>%T</code> ISO 8601 time: HH:MM:SS</li><li><code>%R</code> ISO 8601 time: HH:MM</li><li><code>%I</code> hour for 12-hour clock: 01-12</li><li><code>%l</code> hour for 12-hour clock without leading zero: 1-12</li><li><code>%k</code> hour without leading zero: 0-24</li><li><code>%p</code> &#34;AM&#34; or &#34;PM&#34; depending on the hour</li><li><code>%P</code> &#34;am&#34; or &#34;pm&#34; depending on the hour</li><li><code>%e</code> day of month without leading zero: 0-31</li><li><code>%u</code> day of week 1-7 with Monday==1</li></ul><div><pre tabindex="0"><code data-lang="sql"><span><span><span>select</span> <span>&#34;ISO date&#34;</span> <span>as</span> <span>label</span>, <span>strftime</span>(<span>&#39;%F&#39;</span>, <span>datetime</span>(<span>&#39;now&#39;</span>)) <span>as</span> <span>value</span>
</span></span><span><span><span>union</span> <span>all</span>
</span></span><span><span><span>select</span> <span>&#34;ISO time&#34;</span>, <span>strftime</span>(<span>&#39;%R&#39;</span>, <span>datetime</span>(<span>&#39;now&#39;</span>)) <span>as</span> <span>value</span>
</span></span><span><span><span>union</span> <span>all</span>
</span></span><span><span><span>select</span> <span>&#34;AM/PM time&#34;</span>, <span>strftime</span>(<span>&#39;%l:%M %P&#39;</span>, <span>datetime</span>(<span>&#39;now&#39;</span>)) <span>as</span> <span>value</span>
</span></span><span><span><span>union</span> <span>all</span>
</span></span><span><span><span>select</span> <span>&#34;Day of month&#34;</span>, <span>strftime</span>(<span>&#39;%e&#39;</span>, <span>datetime</span>(<span>&#39;now&#39;</span>)) <span>as</span> <span>value</span>
</span></span><span><span><span>union</span> <span>all</span>
</span></span><span><span><span>select</span> <span>&#34;Day of week&#34;</span>, <span>strftime</span>(<span>&#39;%u&#39;</span>, <span>datetime</span>(<span>&#39;now&#39;</span>)) <span>as</span> <span>value</span>
</span></span></code></pre></div><codapi-snippet sandbox="sqlite" editor="basic"></codapi-snippet><p>ISO formatting is most welcome!</p><p>If you are wondering why lowercase <code>p</code> results in uppercase <code>AM/PM</code>, while uppercase <code>P</code> results in lowercase <code>am/pm</code> — it&#39;s because the standard C library function <code>strftime</code> does this (with the <code>%p</code> verb).</p><h2 id="and-a-few-other-things">And a few other things</h2><p><a href="https://sqlite.org/pragma.html#pragma_integrity_check">Integrity checking</a> now works with virtual tables.</p><p><a href="https://sqlite.org/fts5.html">Full-text search</a> tables can be used in triggers.</p><p>There are some query planner optimizations for partial index scans.</p><p>And a handful of other improvements that you can read about in the <a href="https://sqlite.org/draft/releaselog/3_44_0.html">official release notes</a>.</p><p>All in all, a great release!</p><p>──</p><p><mark>Interactive examples in this post</mark> are powered by <a href="https://codapi.org/"><strong>codapi</strong></a> — the platform I&#39;m building. Use it to embed code playgrounds into your online course, documentation, or blog.</p><p><em><a href="https://antonz.org/subscribe/"><i></i> <strong>Subscribe</strong></a>
to keep up with new posts.</em></p></div></div></article></div></div></div>
  </body>
</html>
