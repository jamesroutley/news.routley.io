<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.milanvit.net/post/making-my-dumb-a-c-smart-with-elixir-and-nerves/">Original</a>
    <h1>Making my dumb A/C smart with Elixir and Nerves</h1>
    
    <div id="readability-page-1" class="page"><div id="site-main">
<article>
<header>



<figure>
<img srcset="https://images.unsplash.com/photo-1545280405-f06710f1779d?crop=entropy&amp;cs=tinysrgb&amp;fit=max&amp;fm=jpg&amp;ixid=M3wxMTc3M3wwfDF8c2VhcmNofDZ8fGh2YWN8ZW58MHx8fHwxNzE2MzYyOTI3fDA&amp;ixlib=rb-4.0.3&amp;q=80&amp;w=300 300w,
                            https://images.unsplash.com/photo-1545280405-f06710f1779d?crop=entropy&amp;cs=tinysrgb&amp;fit=max&amp;fm=jpg&amp;ixid=M3wxMTc3M3wwfDF8c2VhcmNofDZ8fGh2YWN8ZW58MHx8fHwxNzE2MzYyOTI3fDA&amp;ixlib=rb-4.0.3&amp;q=80&amp;w=600 600w,
                            https://images.unsplash.com/photo-1545280405-f06710f1779d?crop=entropy&amp;cs=tinysrgb&amp;fit=max&amp;fm=jpg&amp;ixid=M3wxMTc3M3wwfDF8c2VhcmNofDZ8fGh2YWN8ZW58MHx8fHwxNzE2MzYyOTI3fDA&amp;ixlib=rb-4.0.3&amp;q=80&amp;w=1000 1000w,
                            https://images.unsplash.com/photo-1545280405-f06710f1779d?crop=entropy&amp;cs=tinysrgb&amp;fit=max&amp;fm=jpg&amp;ixid=M3wxMTc3M3wwfDF8c2VhcmNofDZ8fGh2YWN8ZW58MHx8fHwxNzE2MzYyOTI3fDA&amp;ixlib=rb-4.0.3&amp;q=80&amp;w=2000 2000w" sizes="(min-width: 1400px) 1400px, 92vw" src="https://images.unsplash.com/photo-1545280405-f06710f1779d?crop=entropy&amp;cs=tinysrgb&amp;fit=max&amp;fm=jpg&amp;ixid=M3wxMTc3M3wwfDF8c2VhcmNofDZ8fGh2YWN8ZW58MHx8fHwxNzE2MzYyOTI3fDA&amp;ixlib=rb-4.0.3&amp;q=80&amp;w=2000" alt="Making my dumb A/C smart with Elixir and Nerves"/>
<figcaption><span>Photo by </span><a href="https://unsplash.com/@timmossholder?utm_source=ghost&amp;utm_medium=referral&amp;utm_campaign=api-credit"><span>Tim Mossholder</span></a><span> / </span><a href="https://unsplash.com/?utm_source=ghost&amp;utm_medium=referral&amp;utm_campaign=api-credit"><span>Unsplash</span></a></figcaption>
</figure>
</header>
<section>
<p>As the scorching Japanese summer creeps ever closer with each passing day, I kept thinking about my yesteryear idea of remotely controlling my bedroom A/C over the Internet. With a simple click of a button ten minutes before bedtime, I could kick-start the A/C unit, ensuring my bedroom is a cool and comfortable oasis by the time I brush my teeth and make my way upstairs. Last year, it remained an idea; this year, I brought the idea to fruition.</p><p>While the idea of remotely controlling an air conditioner is not entirely novel ‚Äì <a href="https://medium.com/@camilloaddis/smart-air-conditioner-with-raspberry-pi-an-odissey-2a5b438fe984?ref=milanvit.net" rel="noreferrer">many</a> <a href="https://www.instructables.com/Zero-to-Air-Conditioner-Controller-With-Raspberry-/?ref=milanvit.net" rel="noreferrer">have</a> <a href="https://blog.bschwind.com/2016/05/29/sending-infrared-commands-from-a-raspberry-pi-without-lirc/?ref=milanvit.net" rel="noreferrer">trodden</a> this path before me, serving as inspiration and encouragement ‚Äì I believe my approach is somewhat unique in its execution.</p><p>Purchasing the necessary components, a <a href="https://www.aliexpress.com/item/1005006064397684.html?ref=milanvit.net" rel="noreferrer">Raspberry Pi Zero WH</a> and an <a href="https://www.aliexpress.com/item/32917774384.html?ref=milanvit.net" rel="noreferrer">Infrared Transceiver Hat</a>, was the easy part; impatiently waiting a week for delivery, not so much.</p><p>Realizing that the transceiver hat arrived without the actual infrared sensor and infrared diodes was heartbreaking; however, ordering the <a href="https://www.amazon.co.jp/gp/product/B09NPYNSN5/?ref=milanvit.net" rel="noreferrer">necessary components from Amazon</a>, soldering them in myself, and verifying that I could receive the infrared signal with LIRC‚Äôs <code>irrecord</code> command in Raspberry Pi OS was an exhilarating experience.</p><figure><img src="https://www.milanvit.net/content/images/2024/05/IMG_2189.JPG" alt="" loading="lazy" width="2000" height="1500" srcset="https://www.milanvit.net/content/images/size/w600/2024/05/IMG_2189.JPG 600w, https://www.milanvit.net/content/images/size/w1000/2024/05/IMG_2189.JPG 1000w, https://www.milanvit.net/content/images/size/w1600/2024/05/IMG_2189.JPG 1600w, https://www.milanvit.net/content/images/2024/05/IMG_2189.JPG 2000w" sizes="(min-width: 1200px) 1200px"/><figcaption><span>Can you spot the missing parts? Also, it will never cease to surprise me just how small the Raspberry Pi Zero is. I didn‚Äôt have a banana for scale üçå, so a bottlecap for scale will have to do.</span></figcaption></figure><p>At this point, I faced a pivotal decision: just how ambitious did I want to get with this project? Four possible paths lay before me.</p><p>The first challenge revolved around the complexity of air conditioner remote signals. Unlike TV or light remotes that typically send the same signal for each button press, allowing the receiver to interpret and reconcile the state, air conditioner remotes hold the state internally and transmit the full updated state with nearly every button press. This raised a question ‚Äì would I be satisfied with simply recording and replaying a few known remote states, or did I want to dive deep, decoding, understanding, and reproducing the signal to <em>any desired state</em>?</p><p>The second challenge centred on deploying the web server that would present the user interface for controlling the A/C. Should I opt for the straightforward approach of deploying a Phoenix web server on Raspberry Pi OS, or should I embrace the more complex yet undeniably cooler option of bundling Phoenix with Nerves?</p><p>For both challenges, I chose the latter, crazier but unquestionably more impressive paths. Let‚Äôs talk Nerves first.</p><figure><img src="https://www.milanvit.net/content/images/2024/05/IMG_2200.JPG" alt="" loading="lazy" width="2000" height="1500" srcset="https://www.milanvit.net/content/images/size/w600/2024/05/IMG_2200.JPG 600w, https://www.milanvit.net/content/images/size/w1000/2024/05/IMG_2200.JPG 1000w, https://www.milanvit.net/content/images/size/w1600/2024/05/IMG_2200.JPG 1600w, https://www.milanvit.net/content/images/2024/05/IMG_2200.JPG 2000w" sizes="(min-width: 1200px) 1200px"/><figcaption><span>It may not be my finest soldering work, but in my defence, it‚Äôs been many moons since I last held the soldering iron in my hands</span><sup><span>[</span></sup><a href="#fn1" rel="noreferrer"><sup><span>1</span></sup></a><sup><span>]</span></sup><span>.</span></figcaption></figure><h2 id="%F0%9F%90%A7%F0%9F%A7%AA-embedded-elixir">üêßüß™ Embedded Elixir</h2><p>Nerves is one of Elixir‚Äôs most significant libraries. Where <a href="https://www.phoenixframework.org/?ref=milanvit.net" rel="noreferrer">Phoenix</a> allows you to write web servers that outperform a cheetah on caffeine, <a href="https://hexdocs.pm/ecto/Ecto.html?ref=milanvit.net" rel="noreferrer">Ecto</a> enables you to communicate with a wide range of databases and <a href="https://github.com/elixir-nx/nx/tree/main/nx?ref=milanvit.net#readme" rel="noreferrer">Nx</a> lets you harness the power of machine learning and artificial intelligence, <a href="https://nerves-project.org/?ref=milanvit.net" rel="noreferrer">Nerves</a> allows you to effortlessly deploy Elixir on embedded devices, such as Raspberry Pi ‚Äì and I finally had the opportunity to use it for the first time!</p><p>Nerves bundles your application, along with a slimmed-down Linux kernel and a few essential utilities, into firmware that you can burn onto a microSD card, allowing your embedded computer to boot directly into BEAM, the Erlang Virtual Machine. This minimalistic approach, compared to deploying your Elixir application on a full-fledged Raspberry Pi OS, offers several advantages:</p><ul><li>the entire OS + application bundle measures in tens of megabytes, not hundreds<sup>[</sup><a href="#fn2" rel="noreferrer"><sup>2</sup></a><sup>]</sup>;</li><li>the system boots and makes your application available in seconds, not tens of seconds;</li><li>the application &amp; its dependencies updates are handled as part of your code, not via a slow and hard-to-reproduce package manager;</li><li>the attack vector is significantly smaller due to the lack of included software;</li><li>instead of dealing with Linux‚Äôs init systems, you define Erlang Applications;</li><li>while still retaining the Linux kernel‚Äôs ability to interact with hardware via Linux drivers.</li></ul><p>Getting a basic Nerves application up and running was a breeze, but getting the infrared receiver and transmitter working in Nerves would prove to be a more daunting task than a simple <code>apt install lirc</code> and some <code>config.txt</code> editing that were required in Raspberry Pi OS.</p><p>Fortunately, Nerves sports an <a href="https://hexdocs.pm/nerves/customizing-systems.html?ref=milanvit.net" rel="noreferrer">absolutely amazing documentation</a> that guides you throughout the entire process of customizing the underlying system. Even though I had very little idea what I was doing half the time, I was able to <a href="https://github.com/Cellane/minetti_os/commit/c0677d4ac1d141d75a0404cf4185164dfb3eb99f?ref=milanvit.net#diff-d7e2af1905e196c2cc08fc681d156432d1cf845dceee9c6ef49705cefe3392f3" rel="noreferrer">package <code>lirc-tools</code> to the userspace</a>, <a href="https://github.com/Cellane/minetti_os/commit/64fc95cc7593eb6047983a272ccbe09eb7c59754?ref=milanvit.net#diff-9b91e2e2d7d2d703307dd4d74f2c4b93f461abe21b276e79650c714d401380bd" rel="noreferrer">infrared remote support into the Linux kernel</a>, and <a href="https://github.com/Cellane/minetti_fw/commit/8ebf84badd1e8d0f5d54b491b8ca4f583d7fa9ee?ref=milanvit.net" rel="noreferrer">configure my Nerves project to use this custom OS</a>. But then‚Ä¶ nothing happened, <code>/dev/lircX</code> devices didn‚Äôt magically become available‚ÄΩ</p><p>Turns out, there were a few more steps that were necessary, and a few obstacles that needed to be hurdled. In particular:</p><ul><li>first, I needed to <a href="https://github.com/Cellane/minetti_fw/commit/456cded319adbbad79cef9f4d0d28f4ce7498645?ref=milanvit.net" rel="noreferrer">overwrite the default <code>fwup.conf</code></a>, so that I can later <a href="https://github.com/Cellane/minetti_fw/commit/574ec4a27baa2e57a2cd0b5f6fc6562a2dc6c469?ref=milanvit.net" rel="noreferrer">overwrite the default <code>config.txt</code></a> and <a href="https://github.com/Cellane/minetti_fw/commit/7ad488b4592568e5bb99a6b0fa705a7ead805841?ref=milanvit.net" rel="noreferrer">load my device tree overlay</a>; as a result of this step, I gained access to the very necessary <code>/dev/lirc0</code> and <code>/dev/lirc1</code> devices;</li><li>overwrite <a href="https://github.com/Cellane/minetti_fw/commit/8b15a8d8fea7fa2809224b347667ab42b95ef5b1?ref=milanvit.net" rel="noreferrer">LIRC‚Äôs broken <code>default.so</code> plug-in with one</a> that I gracefully <s>stole</s>borrowed from my previous Raspberry Pi OS installation; this is certainly not the correct way to solve the issue, and <a href="https://github.com/nerves-project/nerves/issues/974?ref=milanvit.net" rel="noreferrer">I have reported the bug to Nerves</a>, but it might be up to the upstream developers to fix this;</li><li>create <a href="https://github.com/Cellane/minetti_fw/commit/14d4d73c793818dee528fa12e7e6910259a1dbc7?ref=milanvit.net" rel="noreferrer">a <code>/var/run/lirc</code> folder on start-up</a> so that LIRC can create its socket and PID file, and use MuonTrap to keep <code>lircd</code> up and running ‚Äì this is so much easier than having to deal with an init system!;</li><li><a href="https://github.com/Cellane/minetti_fw/commit/45ee0ab156e717a6440bf6e37f33800727f1b6b8?ref=milanvit.net" rel="noreferrer">configure LIRC‚Äôs parameters</a> by layering an <code>overlayfs</code> on top of the default filesystem;</li><li>finally, <a href="https://github.com/Cellane/minetti_fw/commit/68b8cdf3c531b1814ff3bb60bb34a75c60c98e8d?ref=milanvit.net" rel="noreferrer">override <code>erlinit.config</code> to mount <code>tmpfs</code></a> onto <code>/etc/lirc/lircd.conf.d</code> to make it writeable ‚Äì Nerves mounts the root filesystem in read-only mode, so this is necessary to create LIRC configs on the fly!</li></ul><p>Once all of this was done, it was time to <a href="https://github.com/Cellane/minetti_fw/commit/b1634c84796facacdeb97fca0c9a3d448561ef3c?ref=milanvit.net#diff-1543ad3918c37800b7baedda353aa47409a748d6e1de2a5b0871fead64dbbf12" rel="noreferrer">write a simple signal decoder</a> that would turn LIRC‚Äôs <code>mode2</code> command‚Äôs output and turn it into a CSV line that can be imported into Google Sheets for analysis!</p><figure><img src="https://www.milanvit.net/content/images/2024/05/image-2.png" alt="" loading="lazy" width="1402" height="966" srcset="https://www.milanvit.net/content/images/size/w600/2024/05/image-2.png 600w, https://www.milanvit.net/content/images/size/w1000/2024/05/image-2.png 1000w, https://www.milanvit.net/content/images/2024/05/image-2.png 1402w" sizes="(min-width: 1200px) 1200px"/><figcaption><span>SSH to IEx will never stop being wildly amusing to me.</span></figcaption></figure><h2 id="%F0%9F%94%93-cracking-the-code">üîì Cracking the code</h2><p>After reading the articles I mentioned earlier, I had an inkling that the remote‚Äôs infrared signal would be encoded using a modified version<sup>[</sup><a href="#fn3" rel="noreferrer"><sup>3</sup></a><sup>]</sup> of the NEC protocol. This protocol represents a binary zero as a series of a short pulse burst (562.5¬µs) followed by a short space, whereas a binary one as a series of short pulse burst followed by a long (1.6875ms) space<sup>[</sup><a href="#fn4" rel="noreferrer"><sup>4</sup></a><sup>]</sup>.</p><p>Using the decoder mentioned in the previous section (and <a href="https://github.com/Cellane/minetti_fw/commit/cba714c73a8de7f80a3eb47321f3e16c8aa20379?ref=milanvit.net#diff-1543ad3918c37800b7baedda353aa47409a748d6e1de2a5b0871fead64dbbf12" rel="noreferrer">later fixed</a> to distinguish chunk start and end portions), my workflow turned into something akin to this:</p><ul><li>open an SSH connection to my Nerves application to arrive in an IEx shell, not in <code>bash</code> or anything alike;</li><li>call my decoder‚Äôs function which uses MuonTrap to launch <code>mode2</code>, waits 3 seconds for output and then terminates <code>mode2</code> (<code>mode2</code> runs indefinitely but I‚Äôm only interested in scanning one command at a time);</li><li>press a button on my A/C‚Äôs remote control to scan the emitted code ‚Äì focus on making the smallest possible change<sup>[</sup><a href="#fn5" rel="noreferrer"><sup>5</sup></a><sup>]</sup> from the previously scanned command, to easily distinguish changed portions of the signal;</li><li>grab the decoded CSV line and paste it into my monster-Google-Sheet.</li></ul><p>And when I say monster-Google-Sheet, I mean <a href="https://docs.google.com/spreadsheets/d/1c8gXpYuVukQZrgvFq1DJUf-xkyHC-3_pfQpSveNrfj4/edit?usp=sharing&amp;ref=milanvit.net">truly monster-Google-Sheet</a> üë∫.</p><figure><img src="https://www.milanvit.net/content/images/2024/05/image.png" alt="" loading="lazy" width="2000" height="855" srcset="https://www.milanvit.net/content/images/size/w600/2024/05/image.png 600w, https://www.milanvit.net/content/images/size/w1000/2024/05/image.png 1000w, https://www.milanvit.net/content/images/size/w1600/2024/05/image.png 1600w, https://www.milanvit.net/content/images/size/w2400/2024/05/image.png 2400w"/><figcaption><span>Is the spreadsheet way longer than it needed to be? Yes, it is. Was it fun to make it? Yes, it was. Did it make me appreciate the benefits of an ultra-widescreen display? Do I need to even answer the last one?</span><sup><span>[</span></sup><a href="#fn6" rel="noreferrer"><sup><span>6</span></sup></a><sup><span>]</span></sup></figcaption></figure><p>The only byte (or bit? ü§≠) that was slightly tricky to figure out was the very last one, a checksum. Fortunately, it turned out to be a simple sum of bytes in the third datagram (minus the part that would overflow), without even the need to consider different endianness.</p><p>With the spreadsheet in hand, it was time to start <a href="https://github.com/Cellane/minetti_fw/commit/b1634c84796facacdeb97fca0c9a3d448561ef3c?ref=milanvit.net#diff-d8ce94ff16e1a931f19e415bc73713003544bf7ee5f35c776cf98a3fdd0992bf">writing</a> (and subsequently <a href="https://github.com/Cellane/minetti_fw/commit/cba714c73a8de7f80a3eb47321f3e16c8aa20379?ref=milanvit.net#diff-d8ce94ff16e1a931f19e415bc73713003544bf7ee5f35c776cf98a3fdd0992bf">fixing</a>) the encoder module that would be able to convert any state into a representation of the signal that the A/C unit would understand. To my great advantage, my living room A/C is already smart <em>and</em> understands the signal emitted by my upstairs A/C‚Äôs remote, so I could take advantage of a feedback loop consisting of <em>attempt to blast a signal</em> ‚Üí <em>check smart A/C‚Äôs mobile app if it was understood as I expect it</em>.</p><p>Also no, I will not apologize nor repent for representing the binary signal with a string instead of bits. Deal with it üòé</p><p>Fast forward a few hours later, I was able to fully control my A/C from an SSH session, and a few more hours later, I had a <a href="https://github.com/Cellane/minetti_ui/commit/2f899a2b88e9b73f242e4eb6d0968266957d719f?ref=milanvit.net" rel="noreferrer">super shrimple ü¶ê yet functional web interface</a> finished using Phoenix and LiveView<sup>[</sup><a href="#fn7" rel="noreferrer"><sup>7</sup></a><sup>]</sup>. It will never cease to amaze me that you can synchronize the state between two browser windows on two different devices with just two lines of code in LiveView ‚Äì a truly magical feeling ‚ú®.</p><figure><img src="https://www.milanvit.net/content/images/2024/05/image-1.png" alt="" loading="lazy" width="1170" height="2532" srcset="https://www.milanvit.net/content/images/size/w600/2024/05/image-1.png 600w, https://www.milanvit.net/content/images/size/w1000/2024/05/image-1.png 1000w, https://www.milanvit.net/content/images/2024/05/image-1.png 1170w" sizes="(min-width: 720px) 720px"/><figcaption><span>Why did I choose to have the user interface in Japanese? Do I need to have answers to every question?</span></figcaption></figure><p>I‚Äôm truly impressed with how easy and fun it was to develop my first IoT device using Nerves, and am already searching for ideas as to what to do next.</p><p>Also, huge thanks to the Elixir/Nerves community in the <code>#nerves</code> channel on Elixir‚Äôs official Discord server. You were an inspiration, an encouragement and a huge help!</p>




</section>
</article>
</div></div>
  </body>
</html>
