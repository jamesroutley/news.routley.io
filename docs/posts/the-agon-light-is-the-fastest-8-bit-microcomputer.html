<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.thebyteattic.com/p/agon.html">Original</a>
    <h1>The Agon light is the fastest 8-bit microcomputer</h1>
    
    <div id="readability-page-1" class="page"><div id="content">
            

            <p>
    Posted on 29 January 2023
    
</p>


<p>In 2018, <a href="https://markkarpov.com/post/announcing-ghc-syntax-highlighter.html">Mark Karpov announced
<code>ghc-syntax-highlighter</code></a>,
a project which uses GHC’s own lexer to tokenise Haskell source code for the
best possible syntax highlighting. I thought this was extremely cool, and
really wanted to use it for this blog. Unfortunately, this is what the post had
to say about <code>pandoc</code>, which Hakyll uses to process Markdown:</p>
<blockquote>
<p><a href="https://hackage.haskell.org/package/skylighting"><code>skylighting</code></a> is what
Pandoc uses btw. And from what I can tell it’s hardcoded to use only that
library for highlighting, so some creativity may be necessary to get it work.</p>
</blockquote>
<p>I briefly looked into this and reached the same conclusion (and as of this
writing <a href="https://github.com/jgm/pandoc/blob/5f31a01d77f5fea46e2deca51165d5af8fc99677/src/Text/Pandoc/Highlighting.hs#L76-L106">it is still the
case</a>)
so, as a deeply uncreative individual, I sighed deeply and resigned myself to never knowing this particular joy.</p>
<p>Until, just a few days ago, I read <a href="https://tony-zorman.com/posts/2023-01-21-pygmentising-hakyll.html">this lovely blog post by Tony Zorman about
customising Hakyll’s syntax
highlighting</a>
which included this gem of a sentence in the very first paragraph:</p>
<blockquote>
<p>Using <code>pygmentize</code> as an example, I will show you how you can swap out
pandoc’s native syntax highlighting with pretty much any third party tool that
can output HTML.</p>
</blockquote>
<p>And in fact this is an accurate description of what follows. This sounds like
exactly what I want to do, and between this and Mark’s
<a href="https://hackage.haskell.org/package/mmark-ext"><code>mmark-ext</code></a> (which <a href="https://hackage.haskell.org/package/mmark-ext-0.2.1.5/docs/Text-MMark-Extension-GhcSyntaxHighlighter.html">implements
<code>ghc-syntax-highlighter</code> support as an extension for
<code>mmark</code></a>)
I was able to successfully follow the instructions to get
<code>ghc-syntax-highlighter</code> working with my blog. Let me walk you through what
I did.</p>
<p>Here are the language extensions I will be using:</p>
<div><pre><code><span>{-# LANGUAGE LambdaCase        #-}</span><span>
</span><span>{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span>{-# LANGUAGE ViewPatterns      #-}</span></code></pre></div>
<p>and these additional imports:</p>
<div><pre><code><span>import</span><span>           </span><span>GHC.SyntaxHighlighter</span><span> </span><span>(</span><span>Token</span><span>(</span><span>..</span><span>)</span><span>,</span><span> </span><span>tokenizeHaskell</span><span>)</span><span>
</span><span>import</span><span>           </span><span>Text.Blaze.Html.Renderer.Text</span><span> </span><span>(</span><span>renderHtml</span><span>)</span><span>
</span><span>import</span><span>           </span><span>Text.Pandoc.Definition</span><span> </span><span>(</span><span>Block</span><span> </span><span>(</span><span>CodeBlock</span><span>,</span><span> </span><span>RawBlock</span><span>)</span><span>,</span><span> </span><span>Pandoc</span><span>)</span><span>
</span><span>import</span><span>           </span><span>Text.Pandoc.Walk</span><span> </span><span>(</span><span>walk</span><span>)</span><span>
</span><span>import</span><span> </span><span>qualified</span><span> </span><span>Text.Blaze.Html5</span><span> </span><span>as</span><span> </span><span>H</span><span>
</span><span>import</span><span> </span><span>qualified</span><span> </span><span>Text.Blaze.Html5.Attributes</span><span> </span><span>as</span><span> </span><span>A</span></code></pre></div>
<p>I chose to use <a href="https://hackage.haskell.org/package/blaze-html"><code>blaze-html</code></a>
since it is already a transitive dependency of <code>pandoc</code> and using it has no
impact on our dependency tree.</p>
<p>Tony uses <code>walkM</code> since an external program (<code>pygmentize</code>) is involved, but
since we are working with pure Haskell code we can get away with just <code>walk</code>:</p>
<div><pre><code><span>ghcSyntaxHighlight</span><span> </span><span>::</span><span> </span><span>Pandoc</span><span> </span><span>-&gt;</span><span> </span><span>Pandoc</span><span>
</span><span>ghcSyntaxHighlight</span><span> </span><span>=</span><span> </span><span>walk</span><span> </span><span>$</span><span> </span><span>\</span><span>case</span><span>
    </span><span>CodeBlock</span><span> </span><span>(</span><span>_</span><span>,</span><span> </span><span>(</span><span>isHaskell</span><span> </span><span>-&gt;</span><span> </span><span>True</span><span>)</span><span>:</span><span>_</span><span>,</span><span> </span><span>_</span><span>)</span><span> </span><span>(</span><span>tokenizeHaskell</span><span> </span><span>-&gt;</span><span> </span><span>Just</span><span> </span><span>tokens</span><span>)</span><span> </span><span>-&gt;</span><span>
        </span><span>RawBlock</span><span> </span><span>&#34;html&#34;</span><span> </span><span>.</span><span> </span><span>L.toStrict</span><span> </span><span>.</span><span> </span><span>renderHtml</span><span> </span><span>$</span><span> </span><span>formatHaskellTokens</span><span> </span><span>tokens</span><span>
    </span><span>block</span><span> </span><span>-&gt;</span><span> </span><span>block</span><span>
    </span><span>where</span><span> </span><span>isHaskell</span><span> </span><span>=</span><span> </span><span>(</span><span>==</span><span> </span><span>&#34;haskell&#34;</span><span>)</span></code></pre></div>
<p>This only matches Haskell code blocks which <code>tokenizeHaskell</code> is able to
successfully tokenise and otherwise falls back on existing <code>pandoc</code> behaviour.</p>
<p><code>formatHaskellTokens</code> generates markup very similarly to what <code>pandoc</code> already
does:</p>
<div><pre><code><span>formatHaskellTokens</span><span> </span><span>::</span><span> </span><span>[</span><span>(</span><span>Token</span><span>,</span><span> </span><span>T.Text</span><span>)</span><span>]</span><span> </span><span>-&gt;</span><span> </span><span>H.Html</span><span>
</span><span>formatHaskellTokens</span><span> </span><span>tokens</span><span> </span><span>=</span><span>
    </span><span>H.div</span><span> </span><span>H.!</span><span> </span><span>A.class_</span><span> </span><span>&#34;sourceCode&#34;</span><span> </span><span>$</span><span>
        </span><span>H.pre</span><span> </span><span>H.!</span><span> </span><span>A.class_</span><span> </span><span>&#34;sourceCode haskell&#34;</span><span> </span><span>$</span><span>
            </span><span>H.code</span><span> </span><span>H.!</span><span> </span><span>A.class_</span><span> </span><span>&#34;sourceCode haskell&#34;</span><span> </span><span>$</span><span>
                </span><span>mapM_</span><span> </span><span>tokenToHtml</span><span> </span><span>tokens</span></code></pre></div>
<p><code>tokenizeHaskell</code> produces a list of pairs of the token type (<code>KeywordToken</code>,
<code>VariableToken</code>, etc.) and the matched text, and the <code>tokenToHtml</code> (<a href="https://hackage.haskell.org/package/mmark-ext-0.2.1.5/docs/src/Text.MMark.Extension.GhcSyntaxHighlighter.html#tokenToHtml">adapted
from
<code>mmark-ext</code></a>)
function creates a <code>span</code> element with the appropriate class name for our CSS
to style:</p>
<div><pre><code><span>tokenToHtml</span><span> </span><span>::</span><span> </span><span>(</span><span>Token</span><span>,</span><span> </span><span>T.Text</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>H.Html</span><span>
</span><span>tokenToHtml</span><span> </span><span>(</span><span>tokenClass</span><span> </span><span>-&gt;</span><span> </span><span>className</span><span>,</span><span> </span><span>text</span><span>)</span><span> </span><span>=</span><span>
    </span><span>H.span</span><span> </span><span>H.!?</span><span> </span><span>(</span><span>not</span><span> </span><span>$</span><span> </span><span>T.null</span><span> </span><span>className</span><span>,</span><span> </span><span>A.class_</span><span> </span><span>(</span><span>H.toValue</span><span> </span><span>className</span><span>)</span><span>)</span><span> </span><span>$</span><span>
        </span><span>H.toHtml</span><span> </span><span>text</span></code></pre></div>
<p><code>tokenClass</code> (<a href="https://hackage.haskell.org/package/mmark-ext-0.2.1.5/docs/src/Text.MMark.Extension.GhcSyntaxHighlighter.html#tokenClass">also adapted from
<code>mmark-ext</code></a>)
outputs the appropriate class name for each token, and I made only minor
changes for styling purposes:</p>
<div><pre><code><span>tokenClass</span><span> </span><span>::</span><span> </span><span>Token</span><span> </span><span>-&gt;</span><span> </span><span>T.Text</span><span>
</span><span>tokenClass</span><span> </span><span>=</span><span> </span><span>\</span><span>case</span><span>
  </span><span>KeywordTok</span><span> </span><span>-&gt;</span><span> </span><span>&#34;kw&#34;</span><span>
  </span><span>PragmaTok</span><span> </span><span>-&gt;</span><span> </span><span>&#34;pp&#34;</span><span> </span><span>-- Preprocessor</span><span>
  </span><span>SymbolTok</span><span> </span><span>-&gt;</span><span> </span><span>&#34;ot&#34;</span><span> </span><span>-- Other</span><span>
  </span><span>VariableTok</span><span> </span><span>-&gt;</span><span> </span><span>&#34;va&#34;</span><span>
  </span><span>ConstructorTok</span><span> </span><span>-&gt;</span><span> </span><span>&#34;dt&#34;</span><span> </span><span>-- DataType</span><span>
  </span><span>OperatorTok</span><span> </span><span>-&gt;</span><span> </span><span>&#34;op&#34;</span><span>
  </span><span>CharTok</span><span> </span><span>-&gt;</span><span> </span><span>&#34;ch&#34;</span><span>
  </span><span>StringTok</span><span> </span><span>-&gt;</span><span> </span><span>&#34;st&#34;</span><span>
  </span><span>IntegerTok</span><span> </span><span>-&gt;</span><span> </span><span>&#34;dv&#34;</span><span> </span><span>-- DecVal</span><span>
  </span><span>RationalTok</span><span> </span><span>-&gt;</span><span> </span><span>&#34;dv&#34;</span><span> </span><span>-- DecVal</span><span>
  </span><span>CommentTok</span><span> </span><span>-&gt;</span><span> </span><span>&#34;co&#34;</span><span>
  </span><span>SpaceTok</span><span> </span><span>-&gt;</span><span> </span><span>&#34;&#34;</span><span>
  </span><span>OtherTok</span><span> </span><span>-&gt;</span><span> </span><span>&#34;ot&#34;</span></code></pre></div>
<p>Finally we have to actually use <code>ghcSyntaxHighlight</code>, for which we define
a replacement for <code>pandocCompiler</code> called (imaginatively)
<code>customPandocCompiler</code> and use it everywhere:</p>
<div><pre><code><span>customPandocCompiler</span><span> </span><span>::</span><span> </span><span>Compiler</span><span> </span><span>(</span><span>Item</span><span> </span><span>String</span><span>)</span><span>
</span><span>customPandocCompiler</span><span> </span><span>=</span><span>
    </span><span>pandocCompilerWithTransform</span><span>
        </span><span>defaultHakyllReaderOptions</span><span>
        </span><span>defaultHakyllWriterOptions</span><span>
        </span><span>ghcSyntaxHighlight</span></code></pre></div>
<p>Again, since we are using pure functions, we can get away with
<code>pandocCompilerWithTransform</code> instead of <code>pandocCompilerWithTransformM</code>.</p>
<p>And we’re done! I also had to tweak my CSS slightly since <code>pandoc</code> was
generating a <code>span</code> for each line of source code instead of each token like
<code>ghc-syntax-highlighter</code> does. For the complete listing, see
<a href="https://github.com/vaibhavsagar/website/blob/6415721a318fc8fb31f4aadb7cd40ab6aad4fbc4/site.hs">here</a>.</p>

        </div></div>
  </body>
</html>
