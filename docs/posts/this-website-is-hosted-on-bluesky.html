<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://danielmangum.com/posts/this-website-is-hosted-on-bluesky/">Original</a>
    <h1>This website is hosted on Bluesky</h1>
    
    <div id="readability-page-1" class="page"><div>
        
        <p>Well, not this one. But <a href="https://porcini.us-east.host.bsky.network/xrpc/com.atproto.sync.getBlob?did=did:plc:j22nebhg6aek3kt2mex5ng7e&amp;cid=bafkreic5fmelmhqoqxfjz2siw5ey43ixwlzg5gvv2pkkz7o25ikepv4zeq">this
one</a>
is! How? Let’s take a closer look at <a href="https://bsky.app">Bluesky</a> and the <a href="https://atproto.com/">AT
Protocol</a> that underpins it.</p>
<blockquote>
<p>Note: I communicated with the Bluesky team prior to the publishing of this
post. While the functionality described is not the intended use of the
application, it is known behavior and does not constitue a vulnerability
disclosure process. My main motivation for reaching out to them was because I
like the folks and don’t want to make their lives harder.</p>
</blockquote>



<p><img src="https://danielmangum.com/static/website_on_bsky_0.png" alt="website-on-bsky-0"/>
</p>
<p>Being able to host a website on Bluesky really has very little to do with
Bluesky itself. I happen to use Bluesky for hosting my <a href="https://atproto.com/guides/glossary#pds-personal-data-server">Personal Data Server
(PDS)</a>, but all of
the APIs leveraged in uploading the site contents are defined at the AT Protocol
level and implemented by a PDS. Bluesky offers access to my PDS via their <a href="https://docs.bsky.app/docs/advanced-guides/entryway">PDS
entryway</a>, which allows for
the many (have you heard that they are <a href="https://thehill.com/policy/technology/4999675-bluesky-ceo-1m-people-a-day-joining-in-past-week/">growing by a million users per
day</a>?)
PDS instances they run to be exposed via the <code>bsky.social</code> domain. That being
said, individual PDS instances can be accessed directly, and if you clicked the
link at the top of this post to access the Bluesky hosted website, then you have
already visited mine at <code>porcini.us-east.host.bsky.network</code>.</p>
<p>Most social applications, and many applications in general for that matter,
broadly have two primary types of content:
<a href="https://atproto.com/guides/glossary#record">records</a> and
<a href="https://atproto.com/guides/glossary#blob">blobs</a>. Records are the core entity
types that users create. They generally have some defined structure and
metadata, and they may reference other records or content. Blobs are typically
larger unstructured data, such as media assets, that may be uploaded by a user,
but are exposed via a record referencing them. For example, on Bluesky a user
may upload an image, then create a post that references it. From an end-user
perspective, these two operations appear to be one action, but they are
typically decoupled at the API level.</p>
<p>This decoupling is described in detail in the AT Protocol <a href="https://atproto.com/specs/blob">blob
specification</a>.</p>
<blockquote>
<p>Blob files are uploaded and distributed separately from records. Blobs are
authoritatively stored by the account’s PDS instance, but views are commonly
served by CDNs associated with individual applications (“AppViews”), to reduce
traffic on the PDS. CDNs may serve transformed (resized, transcoded, etc)
versions of the original blob.</p>
</blockquote>
<p>Later on, the specification details how blob lifecylce is to be managed.</p>
<blockquote>
<p>Blobs must be uploaded to the PDS before a record can be created referencing
that blob. Note that the server does not know the intended Lexicon when
receiving an upload, so can only apply generic blob limits and restrictions at
initial upload time, and then enforce Lexicon-defined limits later when the
record is created.</p>
</blockquote>
<p>Reading this section is what initially got my wheels turning. While Bluesky has
a limited set of media asset types that can be referenced by posts, posts are
just one record type that is defined by the Bluesky
<a href="https://atproto.com/specs/lexicon">lexicon</a> (<code>app.bsky.*</code>). Records, on the
other hand, are defined in the AT Protocol lexicon (<code>com.atproto.*</code>) and are
designed to accommodate creating any <em>type</em> of record defined by any lexicon.
Because different types of blobs may be relevant for other lexicons, the
specification highlights that restrictions cannot be enforced at time of upload.</p>
<p>Instead blobs are not made available until they are referenced, at which point
the validation can be performed based on the lexicon of the record type.</p>
<blockquote>
<p>After a successful upload, blobs are placed in temporary storage. They are not
accessible for download or distribution while in this state. Servers should
“garbage collect” (delete) un-referenced temporary blobs after an appropriate
time span (see implementation guidelines below). Blobs which are in temporary
storage should not be included in the <code>listBlobs</code> output.</p>
</blockquote>
<blockquote>
<p>The upload blob can now be referenced from records by including the returned
blob metadata in a record. When processing record creation, the server
extracts the set of all referenced blobs, and checks that they are either
already referenced, or are in temporary storage. Once the record creation
succeeds, the server makes the blob publicly accessible.</p>
</blockquote>
<p>However, applying validation does not mean that Bluesky’s restrictions will
necessarily be applied. A record that references a blob could very well be of a
type defined by a different lexicon, or, as we’ll see later on, part of a
<a href="https://docs.bsky.app/docs/advanced-guides/custom-schemas#sub-schemas">sub-schema</a>
enabled by an open union in the Bluesky lexicon. Let’s see how this works in
practice.</p>
<p>In order to perform data creation operations against a PDS, an access token must
be acquired for authentication. The
<a href="https://docs.bsky.app/docs/api/com-atproto-server-create-session"><code>com.atproto.server.createSession</code></a>
<a href="https://atproto.com/guides/glossary#xrpc">XRPC</a> method can be used to exchange
user credentials for a token. In the following <code>curl</code> command, I used
<code>danielmangum.com</code> as <code>$BSKY_HANDLE</code> and my password as <code>$BSKY_PWD</code>.</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>curl -X POST &#39;https://bsky.social/xrpc/com.atproto.server.createSession&#39; \
</span></span><span><span>-H &#39;Content-Type: application/json&#39; \
</span></span><span><span>-d &#39;{&#34;identifier&#34;: &#34;&#39;&#34;$BSKY_HANDLE&#34;&#39;&#34;, &#34;password&#34;: &#34;&#39;&#34;$BSKY_PWD&#34;&#39;&#34;}&#39;
</span></span></code></pre></div><p>The response includes an <code>accessJWT</code> field, which will be used as <code>$ACCESS_JWT</code>
in subsequent operations. As described in the blob specification, a blob must be
uploaded prior to it being referenced. I wanted to verify that the blob was not
present in the
<a href="https://docs.bsky.app/docs/api/com-atproto-sync-list-blobs"><code>com.atproto.sync.listBlobs</code></a>
output, or accessible via the
<a href="https://docs.bsky.app/docs/api/com-atproto-sync-get-blob"><code>com.atproto.sync.getBlob</code></a>
methods immediately after upload, so I checked how many blobs were currently
being returned.</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>curl -s &#39;https://bsky.social/xrpc/com.atproto.sync.listBlobs?did=&#39;&#34;$DID&#34;&#39;&#39; \
</span></span><span><span>-H &#39;Authorization: Bearer &#39;&#34;$ACCESS_JWT&#34;&#39;&#39; | jq -r &#39;.cids | length&#39;
</span></span></code></pre></div><p>The <a href="https://atproto.com/specs/did">decentralized identifier (<code>$DID</code>)</a> used
above can be obtained from the <code>createSession</code> output as well. It is the
underlying identifier for an account. Every Bluesky handle <a href="https://bsky.social/about/blog/4-28-2023-domain-handle-tutorial">resolves to a
DID</a>.</p>
<p>The
<a href="https://docs.bsky.app/docs/api/com-atproto-repo-upload-blob"><code>com.atproto.repo.uploadBlob</code></a>
method is used to upload a blob to a repository. The content of the website is a
simple <code>index.html</code> file.</p>
<div><pre tabindex="0"><code data-lang="html"><span><span>&lt;<span>h1</span>&gt;This Website is Hosted on Bluesky&lt;/<span>h1</span>&gt;
</span></span><span><span>
</span></span><span><span>&lt;<span>p</span>&gt;
</span></span><span><span>This website is just a blob uploaded to Bluesky via the API. Curious about how
</span></span><span><span>this works? Check out the write-up on &lt;<span>a</span>
</span></span><span><span><span>href</span>=<span>&#34;https://danielmangum.com/posts/this-website-is-hosted-on-bluesky/&#34;</span>&gt;danielmangum.com&lt;/<span>a</span>&gt;.
</span></span><span><span>&lt;/<span>p</span>&gt;
</span></span></code></pre></div><p>To upload it, I used the following command.</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>curl -X POST &#39;https://bsky.social/xrpc/com.atproto.repo.uploadBlob&#39; \
</span></span><span><span>-H &#39;Authorization: Bearer &#39;&#34;$ACCESS_JWT&#34;&#39;&#39; \
</span></span><span><span>-H &#39;Content-Type: text/html&#39; \
</span></span><span><span>--data-binary &#39;@index.html&#39;
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="json"><span><span>{
</span></span><span><span>  <span>&#34;blob&#34;</span>: {
</span></span><span><span>    <span>&#34;$type&#34;</span>: <span>&#34;blob&#34;</span>,
</span></span><span><span>    <span>&#34;ref&#34;</span>: {
</span></span><span><span>      <span>&#34;$link&#34;</span>: <span>&#34;bafkreic5fmelmhqoqxfjz2siw5ey43ixwlzg5gvv2pkkz7o25ikepv4zeq&#34;</span>
</span></span><span><span>    },
</span></span><span><span>    <span>&#34;mimeType&#34;</span>: <span>&#34;text/html&#34;</span>,
</span></span><span><span>    <span>&#34;size&#34;</span>: <span>268</span>
</span></span><span><span>  }
</span></span><span><span>}
</span></span></code></pre></div><p>The returned <code>$link</code> can be used as the <a href="https://atproto.com/guides/glossary#cid-content-id">Content Identifier
(<code>cid</code>)</a> when fetching the
blob via the <code>getBlob</code> method. However, according to the specification, because
this blob has to be referenced, it shouldn’t be visible. I checked to see if I
could access it with the following command.</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>curl -L &#39;https://bsky.social/xrpc/com.atproto.sync.getBlob?did=&#39;&#34;$DID&#34;&#39;&amp;cid=&#39;&#34;$LINK&#34;&#39;&#39; 
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="json"><span><span>{
</span></span><span><span>  <span>&#34;error&#34;</span>: <span>&#34;InternalServerError&#34;</span>,
</span></span><span><span>  <span>&#34;message&#34;</span>: <span>&#34;Internal Server Error&#34;</span>
</span></span><span><span>}
</span></span></code></pre></div><p>Not the error I was expecting, but it looks like I indeed cannot access it. I
was also able to determine that it had not beed added to the <code>listBlobs</code> output.</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>curl -s &#39;https://bsky.social/xrpc/com.atproto.sync.listBlobs?did=&#39;&#34;$DID&#34;&#39;&#39; \
</span></span><span><span>-H &#39;Authorization: Bearer &#39;&#34;$ACCESS_JWT&#34;&#39;&#39; | jq -r &#39;.cids | length&#39;
</span></span></code></pre></div><p>Blobs can be referenced in <a href="https://github.com/bluesky-social/atproto/blob/b5c6bce9703faa7a8eb7f629d34f173116cb37b8/lexicons/app/bsky/feed/post.json"><code>app.bsky.feed.post</code>
records</a>
on Bluesky by including an <a href="https://docs.bsky.app/docs/advanced-guides/posts#images-embeds">embedded
image</a>. However,
the <a href="https://github.com/bluesky-social/atproto/blob/b5c6bce9703faa7a8eb7f629d34f173116cb37b8/lexicons/app/bsky/embed/images.json#L23"><code>app.bsky.embed.image</code>
schema</a>
retricts the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/MIME_types">MIME
type</a> to those
prefixed with <code>image/*</code>. We can see this validation in action if we try to
create a post with an embedded image.</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>curl -X POST &#39;https://bsky.social/xrpc/com.atproto.repo.createRecord&#39; \
</span></span><span><span>-H &#39;Authorization: Bearer &#39;&#34;$ACCESS_JWT&#34;&#39;&#39; \
</span></span><span><span>-H &#39;Content-Type: application/json&#39; \
</span></span><span><span>-d &#39;{
</span></span><span><span>  &#34;repo&#34;: &#34;danielmangum.com&#34;,
</span></span><span><span>  &#34;collection&#34;: &#34;app.bsky.feed.post&#34;,
</span></span><span><span>  &#34;record&#34;: {
</span></span><span><span>    &#34;$type&#34;: &#34;app.bsky.feed.post&#34;,
</span></span><span><span>    &#34;text&#34;: &#34;testing123&#34;,
</span></span><span><span>    &#34;createdAt&#34;: &#34;2024-11-23T05:49:35.422015Z&#34;,
</span></span><span><span>    &#34;embed&#34;: {
</span></span><span><span>      &#34;$type&#34;: &#34;app.bsky.embed.images&#34;,
</span></span><span><span>      &#34;images&#34;: [
</span></span><span><span>        {
</span></span><span><span>          &#34;alt&#34;: &#34;that is not an image that is a website!&#34;,
</span></span><span><span>          &#34;image&#34;: {
</span></span><span><span>            &#34;$type&#34;: &#34;blob&#34;,
</span></span><span><span>            &#34;ref&#34;: {
</span></span><span><span>              &#34;$link&#34;: &#34;bafkreidphtuvbzublyzacxukmmk2ikiur5ahme75fegokbhh26o4wfzvry&#34;
</span></span><span><span>            },
</span></span><span><span>            &#34;mimeType&#34;: &#34;text/html&#34;,
</span></span><span><span>            &#34;size&#34;: 21
</span></span><span><span>          }
</span></span><span><span>        }
</span></span><span><span>      ]
</span></span><span><span>    }
</span></span><span><span>  }
</span></span><span><span>}&#39;
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="json"><span><span>{
</span></span><span><span>  <span>&#34;error&#34;</span>: <span>&#34;InvalidMimeType&#34;</span>,
</span></span><span><span>  <span>&#34;message&#34;</span>: <span>&#34;Wrong type of file. It is text/html but it must match image/*.&#34;</span>
</span></span><span><span>}
</span></span></code></pre></div><p>For completeness, I also tried specifying the <code>mimeType</code> as <code>image/jpeg</code> and
verified that the PDS also validates that the blob reference MIME type matches
the blob.</p>
<div><pre tabindex="0"><code data-lang="json"><span><span>{
</span></span><span><span>  <span>&#34;error&#34;</span>: <span>&#34;InvalidMimeType&#34;</span>,
</span></span><span><span>  <span>&#34;message&#34;</span>: <span>&#34;Referenced Mimetype does not match stored blob. Expected: text/html, Got: image/jpeg&#34;</span>
</span></span><span><span>}
</span></span></code></pre></div><p>However, the <a href="https://atproto.com/specs/data-model#blob-type"><code>blob</code> <code>$type</code> is part of the AT Protocol data
model</a> and not specific to
Bluesky. Because Bluesky’s PDS implementation is open source, we can see exactly
how a <a href="https://github.com/bluesky-social/atproto/blob/b5c6bce9703faa7a8eb7f629d34f173116cb37b8/packages/lexicon/src/blob-refs.ts#L26"><code>BlobRef</code> is
defined</a>.</p>
<div><pre tabindex="0"><code data-lang="ts"><span><span><span>export</span> <span>class</span> BlobRef {
</span></span><span><span>  <span>public</span> original: <span>JsonBlobRef</span>
</span></span><span><span>
</span></span><span><span>  <span>constructor</span>(
</span></span><span><span>    <span>public</span> ref: <span>CID</span>,
</span></span><span><span>    <span>public</span> mimeType: <span>string</span>,
</span></span><span><span>    <span>public</span> size: <span>number</span>,
</span></span><span><span>    original?: <span>JsonBlobRef</span>,
</span></span><span><span>  ) {
</span></span><span><span>    <span>this</span>.original = original ?? {
</span></span><span><span>      $type: <span>&#39;blob&#39;</span>,
</span></span><span><span>      ref,
</span></span><span><span>      mimeType,
</span></span><span><span>      size,
</span></span><span><span>    }
</span></span><span><span>  }
</span></span></code></pre></div><p>We can also see exactly how the PDS <a href="https://github.com/bluesky-social/atproto/blob/b5c6bce9703faa7a8eb7f629d34f173116cb37b8/packages/pds/src/repo/prepare.ts#L282">identifies blobs in a
record</a>.</p>
<div><pre tabindex="0"><code data-lang="ts"><span><span><span>export</span> <span>const</span> findBlobRefs = (
</span></span><span><span>  val: <span>LexValue</span>,
</span></span><span><span>  path: <span>string</span>[] = [],
</span></span><span><span>  layer = <span>0</span>,
</span></span><span><span>): FoundBlobRef[] =&gt; {
</span></span><span><span>  <span>if</span> (layer &gt; <span>32</span>) {
</span></span><span><span>    <span>return</span> []
</span></span><span><span>  }
</span></span><span><span>  <span>// walk arrays
</span></span></span><span><span><span></span>  <span>if</span> (<span>Array</span>.isArray(val)) {
</span></span><span><span>    <span>return</span> val.flatMap((item) =&gt; findBlobRefs(item, path, layer + <span>1</span>))
</span></span><span><span>  }
</span></span><span><span>  <span>// objects
</span></span></span><span><span><span></span>  <span>if</span> (val &amp;&amp; <span>typeof</span> val === <span>&#39;object&#39;</span>) {
</span></span><span><span>    <span>// convert blobs, leaving the original encoding so that we don&#39;t change CIDs on re-encode
</span></span></span><span><span><span></span>    <span>if</span> (val <span>instanceof</span> BlobRef) {
</span></span><span><span>      <span>return</span> [
</span></span><span><span>        {
</span></span><span><span>          ref: <span>val</span>,
</span></span><span><span>          path,
</span></span><span><span>        },
</span></span><span><span>      ]
</span></span><span><span>    }
</span></span><span><span>    <span>// retain cids &amp; bytes
</span></span></span><span><span><span></span>    <span>if</span> (CID.asCID(val) || val <span>instanceof</span> Uint8Array) {
</span></span><span><span>      <span>return</span> []
</span></span><span><span>    }
</span></span><span><span>    <span>return</span> <span>Object</span>.entries(val).flatMap(([key, item]) =&gt;
</span></span><span><span>      findBlobRefs(item, [...path, key], layer + <span>1</span>),
</span></span><span><span>    )
</span></span><span><span>  }
</span></span><span><span>  <span>// pass through
</span></span></span><span><span><span></span>  <span>return</span> []
</span></span><span><span>}
</span></span></code></pre></div><p>The important thing to notice is that identifying blob references does require
the presence of a lexicon schema. <code>findBlobRefs</code> recursively navigates a
<code>LexValue</code> and looks for <code>$type: blob</code>. In order to support new lexicons over
time, the PDS needs to be able to handle lexicons that it doesn’t know about.
Because blobs are a fundamental component of so many applications, these new
lexicons also need to be able to leverage them. To put this into action, I
attempted to create a record of type <code>com.danielmangum.hack.website</code>, which
included a reference to the uploaded HTML blob.</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>curl -X POST &#39;https://bsky.social/xrpc/com.atproto.repo.createRecord&#39; \
</span></span><span><span>-H &#39;Authorization: Bearer &#39;&#34;$ACCESS_JWT&#34;&#39;&#39; \
</span></span><span><span>-H &#39;Content-Type: application/json&#39; \
</span></span><span><span>-d &#39;{
</span></span><span><span>  &#34;repo&#34;: &#34;danielmangum.com&#34;,
</span></span><span><span>  &#34;collection&#34;: &#34;com.danielmangum.hack.website&#34;,
</span></span><span><span>  &#34;record&#34;: {
</span></span><span><span>    &#34;$type&#34;: &#34;com.danielmangum.hack.website&#34;,
</span></span><span><span>    &#34;website&#34;: {
</span></span><span><span>      &#34;$type&#34;: &#34;blob&#34;,
</span></span><span><span>      &#34;ref&#34;: {
</span></span><span><span>        &#34;$link&#34;: &#34;bafkreic5fmelmhqoqxfjz2siw5ey43ixwlzg5gvv2pkkz7o25ikepv4zeq&#34;
</span></span><span><span>      },
</span></span><span><span>      &#34;mimeType&#34;: &#34;text/html&#34;,
</span></span><span><span>      &#34;size&#34;: 268
</span></span><span><span>    }
</span></span><span><span>  }
</span></span><span><span>}&#39;
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="json"><span><span>{
</span></span><span><span>  <span>&#34;uri&#34;</span>: <span>&#34;at://did:plc:j22nebhg6aek3kt2mex5ng7e/com.danielmangum.hack.website/3lbnguuzckm2u&#34;</span>,
</span></span><span><span>  <span>&#34;cid&#34;</span>: <span>&#34;bafyreicjcptshc7lmgb7abxlvcb5fmqqjdj6neie23szyum7rcaowmm5qm&#34;</span>,
</span></span><span><span>  <span>&#34;commit&#34;</span>: {
</span></span><span><span>    <span>&#34;cid&#34;</span>: <span>&#34;bafyreid6apjjy56xoyenxmg5xv356twh22n3hayecoxlf6mflpltlzpuwu&#34;</span>,
</span></span><span><span>    <span>&#34;rev&#34;</span>: <span>&#34;3lbnguuzmd42u&#34;</span>
</span></span><span><span>  },
</span></span><span><span>  <span>&#34;validationStatus&#34;</span>: <span>&#34;unknown&#34;</span>
</span></span><span><span>}
</span></span></code></pre></div><p>It worked! We can see in the response that the PDS was unable to validate the
record (<code>validationStatus: unknown</code>) because it does not know about the
<code>com.danielmangum.hack.*</code> lexicon. Nevertheless, it will agree to persist the
record. The next step was to check whether the referenced blob had been
persisted.</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>curl -s &#39;https://bsky.social/xrpc/com.atproto.sync.listBlobs?did=&#39;&#34;$DID&#34;&#39;&#39; \
</span></span><span><span>-H &#39;Authorization: Bearer &#39;&#34;$ACCESS_JWT&#34;&#39;&#39; | jq -r &#39;.cids | length&#39;
</span></span></code></pre></div><p>It looked like it had as the count had increased by 1. Fetching the blob
directly would tell us for sure. Importantly, <code>getBlob</code> <em>does not require
passing the <code>$ACCESS_JWT</code></em> because unauthenticated parties need to be able to
fetch blobs to process alongside records that reference them.</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>curl &#39;https://bsky.social/xrpc/com.atproto.sync.getBlob?did=&#39;&#34;$DID&#34;&#39;&amp;cid=bafkreic5fmelmhqoqxfjz2siw5ey43ixwlzg5gvv2pkkz7o25ikepv4zeq&#39;
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="fallback"><span><span>{
</span></span><span><span>  &#34;error&#34;: &#34;Redirecting&#34;,
</span></span><span><span>  &#34;message&#34;: &#34;Redirecting to new blob location&#34;
</span></span><span><span>}
</span></span></code></pre></div><p>Adding <code>-L</code> to the command enables following redirects.</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>curl -L &#39;https://bsky.social/xrpc/com.atproto.sync.getBlob?did=&#39;&#34;$DID&#34;&#39;&amp;cid=bafkreic5fmelmhqoqxfjz2siw5ey43ixwlzg5gvv2pkkz7o25ikepv4zeq&#39;
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="html"><span><span>&lt;<span>h1</span>&gt;This Website is Hosted on Bluesky&lt;/<span>h1</span>&gt;
</span></span><span><span>
</span></span><span><span>&lt;<span>p</span>&gt;
</span></span><span><span>This website is just a blob uploaded to Bluesky via the API. Curious about how
</span></span><span><span>this works? Check out the write-up on &lt;<span>a</span>
</span></span><span><span><span>href</span>=<span>&#34;https://danielmangum.com/posts/this-website-is-hosted-on-bluesky/&#34;</span>&gt;danielmangum.com&lt;/<span>a</span>&gt;.
</span></span><span><span>&lt;/<span>p</span>&gt;
</span></span></code></pre></div><p>Examining the redirect response, we can see that we are being directed directly
to my PDS.</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>&lt; HTTP/2 302 
</span></span><span><span>&lt; date: Sun, 24 Nov 2024 13:58:21 GMT
</span></span><span><span>&lt; content-type: application/json; charset=utf-8
</span></span><span><span>&lt; content-length: 68
</span></span><span><span>&lt; location: https://porcini.us-east.host.bsky.network/xrpc/com.atproto.sync.getBlob?did=did:plc:j22nebhg6aek3kt2mex5ng7e&amp;cid=bafkreic5fmelmhqoqxfjz2siw5ey43ixwlzg5gvv2pkkz7o25ikepv4zeq
</span></span><span><span>&lt; x-powered-by: Express
</span></span><span><span>&lt; access-control-allow-origin: *
</span></span><span><span>&lt; ratelimit-limit: 3000
</span></span><span><span>&lt; ratelimit-remaining: 2997
</span></span><span><span>&lt; ratelimit-reset: 1732456898
</span></span><span><span>&lt; ratelimit-policy: 3000;w=300
</span></span><span><span>&lt; etag: W/&#34;44-1je7JKzDJZFd5iRtOI+IS+zlOOE&#34;
</span></span><span><span>&lt; vary: Accept-Encoding
</span></span></code></pre></div><p>Opening the <a href="https://porcini.us-east.host.bsky.network/xrpc/com.atproto.sync.getBlob?did=did:plc:j22nebhg6aek3kt2mex5ng7e&amp;cid=bafkreic5fmelmhqoqxfjz2siw5ey43ixwlzg5gvv2pkkz7o25ikepv4zeq"><code>location</code>
URL</a>
in the browser presents the website as expected, And just like that, we have a
website hosted on Bluesky! While this is not <em>really</em> the intended use of blobs
on Bluesky specifically, it <em>could</em> be a legitimate use case in the future.
Records that reference website content, code, or other binary artifacts are a
possibility on the AT Protocol. That being said, if a service like Bluesky is
running PDS instances on behalf of users, this <strong>effectively equates to free
(albiet unreliable) arbiratry file hosting</strong>, which has implications beyond just
racking up large storage and egress data fees. Returning back to the blobs
specification, there is an additional section on <a href="https://atproto.com/specs/blob#security-considerations">Security
Considerations</a>.</p>
<blockquote>
<p>Serving arbitrary user-uploaded files from a web server raises many content
security issues. For example, cross-site scripting (XSS) of scripts or SVG
content form the same “origin” as other web pages. It is effectively mandatory
to enable a Content Security Policy (LINK:
<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP</a>) for the <code>getBlob</code>
endpoint. It is effectively not supported to dynamically serve assets directly
out of blob storage (the <code>getBlob</code> endpoint) directly to browsers and web
applications. Applications must proxy blobs, files, and assets through an
independent CDN, proxy, or other web service before serving to browsers and
web agents, and such services are expected to implement security precautions.</p>
</blockquote>
<p>Bluesky does <a href="https://github.com/bluesky-social/atproto/blob/b5c6bce9703faa7a8eb7f629d34f173116cb37b8/packages/pds/src/api/com/atproto/sync/getBlob.ts#L8">apply recommended CSP headers to the endpoint in the
handler</a>,
which guards against some of the issues described.</p>
<div><pre tabindex="0"><code data-lang="ts"><span><span>      res.setHeader(<span>&#39;x-content-type-options&#39;</span>, <span>&#39;nosniff&#39;</span>)
</span></span><span><span>      res.setHeader(<span>&#39;content-security-policy&#39;</span>, <span>`default-src &#39;none&#39;; sandbox`</span>)
</span></span></code></pre></div><p>There is also a <a href="https://github.com/bluesky-social/atproto/blob/b5c6bce9703faa7a8eb7f629d34f173116cb37b8/packages/pds/src/config/config.ts#L28">default size limit on blob of 5
MB</a>.</p>
<div><pre tabindex="0"><code data-lang="ts"><span><span>    blobUploadLimit: <span>env.blobUploadLimit</span> ?? <span>5</span> * <span>1024</span> * <span>1024</span>, <span>// 5mb
</span></span></span></code></pre></div><p>Images, the most common blob type on the Bluesky application, are expectedly not
served directly from PDS instances, but from the Bluesky CDN. For example, the
following URL points to the feed thumbnail version of an image I recently
uploaded as part of a post.</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>https://cdn.bsky.app/img/feed_thumbnail/plain/did:plc:j22nebhg6aek3kt2mex5ng7e/bafkreie5ci75iujpv34slnh3o4b7xcuxklpcguzed6qqmi4eaagn6cg4ve@jpeg
</span></span></code></pre></div><p>A different URL provides the full size version.</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>https://cdn.bsky.app/img/feed_fullsize/plain/did:plc:j22nebhg6aek3kt2mex5ng7e/bafkreie5ci75iujpv34slnh3o4b7xcuxklpcguzed6qqmi4eaagn6cg4ve@jpeg
</span></span></code></pre></div><p>However, the post that references the image just includes the <code>cid</code>. The
application itself needs to be aware of how images are served from the CDN.</p>
<div><pre tabindex="0"><code data-lang="json"><span><span>{
</span></span><span><span>  <span>&#34;$type&#34;</span>: <span>&#34;app.bsky.feed.post&#34;</span>,
</span></span><span><span>  <span>&#34;createdAt&#34;</span>: <span>&#34;2024-11-12T14:18:44.263Z&#34;</span>,
</span></span><span><span>  <span>&#34;embed&#34;</span>: {
</span></span><span><span>    <span>&#34;$type&#34;</span>: <span>&#34;app.bsky.embed.images&#34;</span>,
</span></span><span><span>    <span>&#34;images&#34;</span>: [
</span></span><span><span>      {
</span></span><span><span>        <span>&#34;alt&#34;</span>: <span>&#34;Title image for blog post \&#34;USB On-The-Go on the ESP32-S3\&#34; on danielmangum.com.&#34;</span>,
</span></span><span><span>        <span>&#34;aspectRatio&#34;</span>: {
</span></span><span><span>          <span>&#34;height&#34;</span>: <span>1080</span>,
</span></span><span><span>          <span>&#34;width&#34;</span>: <span>1920</span>
</span></span><span><span>        },
</span></span><span><span>        <span>&#34;image&#34;</span>: {
</span></span><span><span>          <span>&#34;$type&#34;</span>: <span>&#34;blob&#34;</span>,
</span></span><span><span>          <span>&#34;ref&#34;</span>: {
</span></span><span><span>            <span>&#34;$link&#34;</span>: <span>&#34;bafkreie5ci75iujpv34slnh3o4b7xcuxklpcguzed6qqmi4eaagn6cg4ve&#34;</span>
</span></span><span><span>          },
</span></span><span><span>          <span>&#34;mimeType&#34;</span>: <span>&#34;image/jpeg&#34;</span>,
</span></span><span><span>          <span>&#34;size&#34;</span>: <span>869901</span>
</span></span><span><span>        }
</span></span><span><span>      }
</span></span><span><span>    ]
</span></span><span><span>  },
</span></span><span><span>  <span>&#34;facets&#34;</span>: [
</span></span><span><span>    {
</span></span><span><span>      <span>&#34;features&#34;</span>: [
</span></span><span><span>        {
</span></span><span><span>          <span>&#34;$type&#34;</span>: <span>&#34;app.bsky.richtext.facet#link&#34;</span>,
</span></span><span><span>          <span>&#34;uri&#34;</span>: <span>&#34;https://danielmangum.com/posts/usb-otg-esp32s3/&#34;</span>
</span></span><span><span>        }
</span></span><span><span>      ],
</span></span><span><span>      <span>&#34;index&#34;</span>: {
</span></span><span><span>        <span>&#34;byteEnd&#34;</span>: <span>261</span>,
</span></span><span><span>        <span>&#34;byteStart&#34;</span>: <span>229</span>
</span></span><span><span>      }
</span></span><span><span>    }
</span></span><span><span>  ],
</span></span><span><span>  <span>&#34;langs&#34;</span>: [
</span></span><span><span>    <span>&#34;en&#34;</span>
</span></span><span><span>  ],
</span></span><span><span>  <span>&#34;text&#34;</span>: <span>&#34;ICYMI: This weekend I wrote about USB On-The-Go on the ESP32-S3. OTG allows devices to also act as USB hosts. I dive into how the USB PHY is configured, and demonstrate connecting two ESP32-S3&#39;s, as well as a Raspberry Pi Pico.\n\ndanielmangum.com/posts/usb-ot...&#34;</span>
</span></span><span><span>}
</span></span></code></pre></div><p>The logic is present in <a href="https://github.com/bluesky-social/atproto/blob/b5c6bce9703faa7a8eb7f629d34f173116cb37b8/packages/bsky/src/image/uri.ts#L12">the
<code>ImageUriBuilder</code></a>,
which <a href="https://github.com/bluesky-social/atproto/blob/b5c6bce9703faa7a8eb7f629d34f173116cb37b8/packages/bsky/src/index.ts#L64">will use a CDN if one is
configured</a>.</p>
<div><pre tabindex="0"><code data-lang="ts"><span><span>    <span>const</span> imgUriBuilder = <span>new</span> ImageUriBuilder(
</span></span><span><span>      config.cdnUrl || <span>`</span><span>${</span>config.publicUrl<span>}</span><span>/img`</span>,
</span></span><span><span>    )
</span></span></code></pre></div><p>So why does Bluesky provide direct unauthenticated access to the PDS <code>getBlobs</code>
endpoint? Once again illustrating the beauty of open source, there is an <a href="https://github.com/bluesky-social/atproto/issues/523">issue
describing the original
motivation</a>. In it, image
labeling and user content export, as well as additional future use cases, are
enumerated. There is also a
<a href="https://github.com/bluesky-social/atproto/issues/523#issuecomment-1450545120">mention</a>
of the possibility of users hotlinking content and Bluesky for free hosting, so
these issues are clearly top-of-mind. The <a href="https://github.com/bluesky-social/atproto/pull/606">original
implementation</a> did not
include the proper security headers, but they were <a href="https://github.com/bluesky-social/atproto/commit/3d1b3b367575f2b4d2856a4795b1ca94a9f16554">subsequently
added</a>.</p>
<p>Traditional social platforms can place more restrictions on blobs at time of
upload because there is a limited set of valid content. The extensibility of
Bluesky and the AT Protocol, which is what differentiates it from traditional
networks, also necessitates more complexity. However, I, and clearly the awesome
folks building Bluesky, think it’s clearly worth it.</p>
<h2 id="bonus-content">
  Bonus Content
  <a href="#bonus-content">
    <i aria-hidden="true" title="Link to heading"></i>
    <span>Link to heading</span>
  </a>
</h2>
<p>I mentioned sub-schemas and open unions earlier in this post. The
<code>app.bsky.feed.post</code> type includes a union for valid embeds. Per the AT Protocol
lexicon specification, unions are open unless explicitly marked as <code>closed</code>.</p>
<blockquote>
<p>By default unions are “open”, meaning that future revisions of the schema
could add more types to the list of refs (though can not remove types). This
means that implementations should be permissive when validating, in case they
do not have the most recent version of the Lexicon. The <code>closed</code> flag
(boolean) can indicate that the set of types is fixed and can not be extended
in the future.</p>
</blockquote>
<p>The embed union is not marked as closed.</p>
<div><pre tabindex="0"><code data-lang="json"><span><span>          <span>&#34;embed&#34;</span><span>:</span> {
</span></span><span><span>            <span>&#34;type&#34;</span>: <span>&#34;union&#34;</span>,
</span></span><span><span>            <span>&#34;refs&#34;</span>: [
</span></span><span><span>              <span>&#34;app.bsky.embed.images&#34;</span>,
</span></span><span><span>              <span>&#34;app.bsky.embed.video&#34;</span>,
</span></span><span><span>              <span>&#34;app.bsky.embed.external&#34;</span>,
</span></span><span><span>              <span>&#34;app.bsky.embed.record&#34;</span>,
</span></span><span><span>              <span>&#34;app.bsky.embed.recordWithMedia&#34;</span>
</span></span><span><span>            ]
</span></span><span><span>          }<span>,</span>
</span></span></code></pre></div><p>Therefore, posts can be created with an embed <code>$type</code> that is not enumerated.
For example, I could also persist the website HTML via <a href="https://bsky.app/profile/danielmangum.com/post/3lbpfxwnjoq23">making a post on
Bluesky</a> with a
custom embed.</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>curl -X POST &#39;https://bsky.social/xrpc/com.atproto.repo.createRecord&#39; \
</span></span><span><span>-H &#39;Authorization: Bearer &#39;&#34;$ACCESS_JWT&#34;&#39;&#39; \
</span></span><span><span>-H &#39;Content-Type: application/json&#39; \
</span></span><span><span>-d &#39;{
</span></span><span><span>  &#34;repo&#34;: &#34;danielmangum.com&#34;,
</span></span><span><span>  &#34;collection&#34;: &#34;app.bsky.feed.post&#34;,
</span></span><span><span>  &#34;record&#34;: {
</span></span><span><span>    &#34;$type&#34;: &#34;app.bsky.feed.post&#34;,
</span></span><span><span>    &#34;text&#34;: &#34;This post embeds a website.&#34;,
</span></span><span><span>    &#34;createdAt&#34;: &#34;2024-11-23T05:49:35.422015Z&#34;,
</span></span><span><span>    &#34;embed&#34;: {
</span></span><span><span>      &#34;$type&#34;: &#34;com.danielmangum.hack.sites&#34;,
</span></span><span><span>      &#34;sites&#34;: [
</span></span><span><span>        {
</span></span><span><span>          &#34;site&#34;: {
</span></span><span><span>            &#34;$type&#34;: &#34;blob&#34;,
</span></span><span><span>            &#34;ref&#34;: {
</span></span><span><span>              &#34;$link&#34;: &#34;bafkreic5fmelmhqoqxfjz2siw5ey43ixwlzg5gvv2pkkz7o25ikepv4zeq&#34;
</span></span><span><span>            },
</span></span><span><span>            &#34;mimeType&#34;: &#34;text/html&#34;,
</span></span><span><span>            &#34;size&#34;: 268
</span></span><span><span>          }
</span></span><span><span>        }
</span></span><span><span>      ]
</span></span><span><span>    }
</span></span><span><span>  }
</span></span><span><span>}&#39;
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="fallback"><span><span>{
</span></span><span><span>  &#34;uri&#34;: &#34;at://did:plc:j22nebhg6aek3kt2mex5ng7e/app.bsky.feed.post/3lbpfxwnjoq23&#34;,
</span></span><span><span>  &#34;cid&#34;: &#34;bafyreidnlyhcvlzl5hc3btih6ly5anjld6ss4bgocyichnm72cpnjuzsvu&#34;,
</span></span><span><span>  &#34;commit&#34;: {
</span></span><span><span>    &#34;cid&#34;: &#34;bafyreibv77m3bdyywmotn7ncbbrqv6pv7irzmw27bzklt4tppgsoodarma&#34;,
</span></span><span><span>    &#34;rev&#34;: &#34;3lbpfxwo57q23&#34;
</span></span><span><span>  },
</span></span><span><span>  &#34;validationStatus&#34;: &#34;valid&#34;
</span></span><span><span>}
</span></span></code></pre></div><p>In the Bluesky application, the embed is silently ignored.</p>



<p><img src="https://danielmangum.com/static/website_on_bsky_1.png" alt="website-on-bsky-1"/>
</p>
<p>However, the content is persisted and the reference is included in the post
record, so a different application could choose to start rendering the embed.</p>
<div><pre tabindex="0"><code data-lang="json"><span><span>{
</span></span><span><span>  <span>&#34;$type&#34;</span>: <span>&#34;app.bsky.feed.post&#34;</span>,
</span></span><span><span>  <span>&#34;createdAt&#34;</span>: <span>&#34;2024-11-23T05:49:35.422015Z&#34;</span>,
</span></span><span><span>  <span>&#34;embed&#34;</span>: {
</span></span><span><span>    <span>&#34;$type&#34;</span>: <span>&#34;com.danielmangum.hack.sites&#34;</span>,
</span></span><span><span>    <span>&#34;sites&#34;</span>: [
</span></span><span><span>      {
</span></span><span><span>        <span>&#34;site&#34;</span>: {
</span></span><span><span>          <span>&#34;$type&#34;</span>: <span>&#34;blob&#34;</span>,
</span></span><span><span>          <span>&#34;ref&#34;</span>: {
</span></span><span><span>            <span>&#34;$link&#34;</span>: <span>&#34;bafkreic5fmelmhqoqxfjz2siw5ey43ixwlzg5gvv2pkkz7o25ikepv4zeq&#34;</span>
</span></span><span><span>          },
</span></span><span><span>          <span>&#34;mimeType&#34;</span>: <span>&#34;text/html&#34;</span>,
</span></span><span><span>          <span>&#34;size&#34;</span>: <span>268</span>
</span></span><span><span>        }
</span></span><span><span>      }
</span></span><span><span>    ]
</span></span><span><span>  },
</span></span><span><span>  <span>&#34;text&#34;</span>: <span>&#34;This post embeds a website.&#34;</span>
</span></span><span><span>}
</span></span></code></pre></div><p>In my opinion, this is one of the most interesting features of lexicons because
it allows for “micro-extensions” that build on existing use cases (e.g.
“microblogging”). For example, I for one would love a world in which small code
snippets could be embedded in my posts and run in a
<a href="https://webassembly.org/">WebAssembly</a> sandbox by other users. But that’s a
post for another day.</p>

      </div></div>
  </body>
</html>
