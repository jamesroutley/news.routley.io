<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://richardtier.com/2022/02/16/3-of-666-python-codebases-we-checked-had-silently-failing-unit-tests-and-we-fixed-them-all%ef%bf%bc/">Original</a>
    <h1>3 percent of Python codebases we checked had silently failing unit tests</h1>
    
    <div id="readability-page-1" class="page"><div>
		
<p>Lets coin a name for a very special type of unit test:</p>



<p><strong>Schrödinger’s unit-test</strong><em>: a unit test that passes but fails to test the thing we want to test.</em></p>



<figure><img src="https://rikatee.files.wordpress.com/2022/02/ec9f9-1xp0fu7xtlthmbj-f9y4mag.png" alt=""/><figcaption>This test will not fail</figcaption></figure>



<p>This article focuses on our code scanning of 666 Python codebases to detect one such Schrödinger’s unit tests. Specifically, this gotcha (which we found in 20 codebases and later pushed an auto-generated fix for):</p>



<p>Do you see the mistake? It’s a relatively common mistake for a developer to make. <code>assertEqual</code> and <code>assertTrue</code> were muddled up. In fact of the 666 codebases we checked, we found 3% of them mixed the two up. This is a real problem that affects real codebases, even active large ones with a huge community and strong testing and code review practices:</p>



<p><a href="https://github.com/python/pythondotorg/pull/1987" rel="noreferrer noopener" target="_blank">Python.org</a> (ironically enough)</p>



<p>See the full lists in <a rel="noreferrer noopener" href="https://gist.github.com/code-review-doctor/9b0b4be2129bc2d4678f4e205aec8811" target="_blank">this gist</a>. The fact the problem is so widespread suggests a key cause of this mistake is because it’s so easy to miss during code review. A quick glance at the code does not raise any red flags. It “Looks Good To Me!”.</p>



<h3 id="schrodinger-s-unit-test">Schrödinger’s unit-test</h3>



<p>In the late 19th century Mark Twain apparently said <em>It’s not what you know that gets you. it’s what you think you know but ain’t. </em>What was true in late 19th century literature is also true in early 21st Python unit testing: tests that don’t really test the thing we want to test is worse than no tests at all because a Schrödinger’s test gives unwarranted confidence that the feature is safe.</p>



<p>Have you ever encountered this workflow:</p>



<ul><li>Code change committed, and the tests for the feature passes locally.</li><li>The test ran in CI during the pull request build, and no failures reported.</li><li>The change was peer reviewed and accepted during code review. (“LGTM!”)</li><li>The change was then deployed to prod… only for it to fail upon first encounter with the user</li><li>After reading the bug report proclaim to yourself “but the test passed!”</li></ul>



<p>Upon revisiting the unit test it’s then noted that the unit test that gave such great confidence during the software development life cycle was in fact not testing the feature at all. If you encountered this problem then you encountered this class of unit tests which this specific TestCase.assertTrue is one of.</p>



<h3 id="the-testcase-asserttrue-gotcha">The TestCase.assertTrue gotcha</h3>



<p>While pytest is very popular, 28% of codebases <a href="https://www.jetbrains.com/lp/python-developers-survey-2020/#FrameworksLibraries" rel="noreferrer noopener" target="_blank">still use the built-in unittest package</a>. The codebases that do use the built-in unittest package are at risk of the assertTrue gotcha:</p>



<figure><img src="https://rikatee.files.wordpress.com/2022/02/ec9f9-1xp0fu7xtlthmbj-f9y4mag.png" alt=""/></figure>



<p>The docs for <a href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.assertTrue" rel="noreferrer noopener" target="_blank">assertTrue</a> state that <em>test that expr is True</em>, but this is an incomplete explanation. Really it tests that the expr is <em>truthy</em>, meaning if any of the following values are used in as the first argument the test will pass:</p>



<pre>&#39;foo&#39;, ‘bar’, 1, [1], {‘a’}, True</pre>



<p>And conversely with falsey values the test will fail:</p>



<pre>&#39;&#39;, 0, [], {}, False,</pre>



<p><code>assertTrue</code> also accepts a second argument, which is the custom error message to show if the first argument is not truthy. This call signature allows the mistake to be made and the test to pass and therefore possibly fail silently.</p>



<p>For example when making 20 PRs fixing the problems we found one of the tests started to fail due to faulty application logic once the test was no longer a Schrödinger’s unit test:</p>



<figure><img src="https://rikatee.files.wordpress.com/2022/02/2e8d8-1twg_cuxazxtl0ip79reouw.png" alt=""/></figure>



<p>We also found that at least two of the tests failed because the logic in the test was wrong. This is also bad if we consider unit tests to be a form of documentation describing how the product works. From a developer’s point of view, unit tests can be considered more trustworthy that comments and doc strings because comments and doc strings are <em>claims</em> written (perhaps long ago and perhaps now obsolete or incomplete), while a passing unit test shows a logic <em>contract</em> is being upheld…as long as the test is not a Schrödinger’s test!</p>



<p>Perhaps more data is needed, but this could mean 15% (3 in 20) of Schrödinger’s unit tests are hiding broken functionality.</p>



<h3 id="testcase-assertequal">TestCase.assertEqual</h3>



<p>When the <a href="https://github.com/marketplace/django-doctor/" rel="noreferrer noopener" target="_blank">CodeReview.doctor github bot</a> detects this mistake in a GitHub pull request the following solution is suggested:</p>



<figure><img src="https://rikatee.files.wordpress.com/2022/02/51be5-1e-6ohk368jhrtgcltupyea.png" alt=""/></figure>



<p>You can securely scan your entire codebase online for free at <a href="http://CodeReview.doctor" rel="noreferrer noopener" target="_blank">CodeReview.doctor</a></p>
			
			
						</div></div>
  </body>
</html>
