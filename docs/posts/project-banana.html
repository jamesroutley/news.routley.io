<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://404wolf.com/posts/projectbanana/">Original</a>
    <h1>Project Banana</h1>
    
    <div id="readability-page-1" class="page"><div><astro-slot> <div>  
<div><div><div> <p><img src="https://static.404wolf.com/banana-overall.png" alt="Banana overview" data-zoom-trigger=""/></p> </div> </div><p>Project Banana was an exploratory project I worked on at Val Town to help allow
for concurrent request handling for our nodejs/fastify servers processing user
Val requests. It was based on a file-system based process management idea that I
had which would allow us to introduce concurrency while letting us reuse our
fastify/nodejs backend with minimal changes.</p><p>Previously all user requests would go to one of our nodejs servers, which are
single-threaded, and that server is bottlenecked both in that we would need to
hit the database on each request to know if a current warm worker could be used,
and that even if we got rid of needing to hit the database, we were still
limited by the fact that our nodejs server could only forward a single request
at a time.</p><p>But with some clever tricks, it‚Äôs possible to do better, and keep things
simple-ish!</p></div>

<ul>
<li><a href="#bottlenecks">Bottlenecks!</a>
<ul>
<li><a href="#node-as-a-banana">Node, as a Banana!</a></li>
<li><a href="#going-in-parallel">Going in Parallel</a></li>
<li><a href="#ironing-it-out">Ironing it Out</a></li>
<li><a href="#numbers">Numbers!</a>
<ul>
<li><a href="#300-concurrent-connections-wo-keepalive">300 Concurrent Connections w/o Keepalive</a></li>
<li><a href="#100-concurrent-connections-w-keepalive">100 Concurrent Connections w/ Keepalive</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#extras">Extras</a>
<ul>
<li><a href="#websockets">WebSockets!</a></li>
<li><a href="#docker">Docker</a></li>
<li><a href="#deno">Deno</a></li>
</ul>
</li>
</ul>

<blockquote>
<p>If you‚Äôre not super interested in the nitty gritty, and just want to skip to
the fun part, check out the next section. There we get to more fun technical
details like folder file system locks and using processes-as-files with
inotify!</p>
</blockquote>
<div><div> <p><img src="https://static.404wolf.com/bottleneck-15.png" alt="The bottleneck" data-zoom-trigger=""/></p> </div><p>  (Note that
this is a bit simplified, since there are actually many nodejs servers behind
haproxy, and requests are being consistent hashed to them)</p></div>
<p><strong>Some context:</strong></p>
<p>At Val Town, our request handling backend is pretty simple. We have a fastify
server with a special endpoint for all user Val web requests. When a request
comes in for a user‚Äôs Val, we consistent hash it to a server via haproxy, and
then our nodejs server handles the request by either proxying to a warm Deno
process (calling the user‚Äôs function), or spawning a new one, using our
open-source <a href="https://github.com/val-town/deno-http-worker/">deno-http-worker</a>
library.</p>
<p>As more requests come in, we spawn more processes, and the nodejs parent server
is responsible for managing all children processes and keep track of state. But
over time we‚Äôve run into issues with loosing track of processes, failing to
properly limit process utilization, and been bottlenecked by this single point
of entry.</p>
<p>Right now, we‚Äôre single threaded. When a request comes in, our biggest
bottleneck has been that we hit our database (postgres) to look up the Val‚Äôs
metadata (like a URI to the actual source code, and environment variables).</p>
<p>This is a problem that we‚Äôve needed to solve <em>before</em> thinking about making our
server parallelized, and is the first step down the Project Banana path.</p>
<p>It might seem a bit complicated, but it‚Äôs really pretty simple. In order to run
a Val, there‚Äôs a set of information that we typically query the database for,
and that information stays static until the user edits the Val again in the
future, or does things like change environmental variables, etc.</p>
<p>One point of complexity here, is that there‚Äôs a few servers for our API, and
that means that if <em>we</em> are a given server, and <em>we</em> receive a request to edit a
Val, we need to bust our cache, AND inform all other servers to bust theirs too.</p>
<p>My idea here was to just use a
<a href="https://www.postgresql.org/docs/current/sql-listen.html">Postgres watch channel</a>,
so that we would not need to update our code everywhere to know that the cache
should get busted. But we decided instead to use a Redis Pub/Sub approach,
because we anticipate in the future that we may have too many servers such that
it is too expensive to reserve so many Postgres connection pool seats.</p>
<p>In summary:</p>
<ul>
<li>When a request comes in, check the in-memory cache for the Val‚Äôs boot
information (source code URI, env vars, etc) by hostname.</li>
<li>If it‚Äôs there, proxy to the Deno worker with that information.</li>
<li>If it‚Äôs not there, query the database for that information, store it in the
cache, and then proxy to the Deno worker.</li>
<li>If an edit request comes in, bust the cache for that hostname, and publish a
message to Redis to inform other servers to do the same.</li>
<li>And if we receive a Redis message to bust a cache, we do so.</li>
</ul>

<p>It looks like this (ok, a little complicated :/):</p>
<div data-astro-cid-qz3dz2lk=""> <div data-astro-cid-qz3dz2lk=""><svg aria-roledescription="stateDiagram" role="graphics-document document" viewBox="0 0 865.625 874" style="max-width: 865.625px; background-color: transparent;" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><g><defs><marker orient="auto" markerUnits="userSpaceOnUse" markerHeight="14" markerWidth="20" refY="7" refX="19" id="my-svg_stateDiagram-barbEnd"><path d="M 19,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><g><g></g><g><path marker-end="url(#my-svg_stateDiagram-barbEnd)" style="fill:none;" id="edge0" d="M215.625,22L215.625,26.167C215.625,30.333,215.625,38.667,215.625,47C215.625,55.333,215.625,63.667,215.625,67.833L215.625,72"></path><path marker-end="url(#my-svg_stateDiagram-barbEnd)" style="fill:none;" id="edge1" d="M215.625,112L215.625,120.167C215.625,128.333,215.625,144.667,215.625,161C215.625,177.333,215.625,193.667,215.625,201.833L215.625,210"></path><path marker-end="url(#my-svg_stateDiagram-barbEnd)" style="fill:none;" id="edge2" d="M177.862,250L166.218,256.167C154.575,262.333,131.287,274.667,119.644,290.333C108,306,108,325,108,344C108,363,108,382,108,401C108,420,108,439,108,460C108,481,108,504,108,523.667C108,543.333,108,559.667,108,567.833L108,576"></path><path marker-end="url(#my-svg_stateDiagram-barbEnd)" style="fill:none;" id="edge3" d="M253.388,250L265.032,256.167C276.675,262.333,299.963,274.667,311.606,287C323.25,299.333,323.25,311.667,323.25,317.833L323.25,324"></path><path marker-end="url(#my-svg_stateDiagram-barbEnd)" style="fill:none;" id="edge4" d="M108,616L108,624.167C108,632.333,108,648.667,120.738,665C133.476,681.333,158.953,697.667,171.691,705.833L184.429,714"></path><path marker-end="url(#my-svg_stateDiagram-barbEnd)" style="fill:none;" id="edge5" d="M323.25,364L323.25,370.167C323.25,376.333,323.25,388.667,323.25,401C323.25,413.333,323.25,425.667,323.25,431.833L323.25,438"></path><path marker-end="url(#my-svg_stateDiagram-barbEnd)" style="fill:none;" id="edge6" d="M323.25,478L323.25,486.167C323.25,494.333,323.25,510.667,323.25,527C323.25,543.333,323.25,559.667,323.25,567.833L323.25,576"></path><path marker-end="url(#my-svg_stateDiagram-barbEnd)" style="fill:none;" id="edge7" d="M323.25,616L323.25,624.167C323.25,632.333,323.25,648.667,310.512,665C297.774,681.333,272.297,697.667,259.559,705.833L246.821,714"></path><path marker-end="url(#my-svg_stateDiagram-barbEnd)" style="fill:none;" id="edge8" d="M215.625,754L215.625,762.167C215.625,770.333,215.625,786.667,250.62,803.875C285.616,821.083,355.607,839.166,390.602,848.207L425.598,857.249"></path><path marker-end="url(#my-svg_stateDiagram-barbEnd)" style="fill:none;" id="edge9" d="M537.625,478L537.625,486.167C537.625,494.333,537.625,510.667,550.644,527C563.664,543.333,589.702,559.667,602.722,567.833L615.741,576"></path><path marker-end="url(#my-svg_stateDiagram-barbEnd)" style="fill:none;" id="edge10" d="M757.625,478L757.625,486.167C757.625,494.333,757.625,510.667,744.606,527C731.586,543.333,705.548,559.667,692.528,567.833L679.509,576"></path><path marker-end="url(#my-svg_stateDiagram-barbEnd)" style="fill:none;" id="edge11" d="M647.625,616L647.625,624.167C647.625,632.333,647.625,648.667,647.625,665C647.625,681.333,647.625,697.667,647.625,705.833L647.625,714"></path><path marker-end="url(#my-svg_stateDiagram-barbEnd)" style="fill:none;" id="edge12" d="M647.625,754L647.625,762.167C647.625,770.333,647.625,786.667,612.879,803.873C578.133,821.079,508.641,839.158,473.895,848.198L439.149,857.238"></path></g><g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g transform="translate(215.625, 161)"><g transform="translate(-100, -24)"><foreignObject height="48" width="200"><p><span><p>Query cache by hostname</p></span></p></foreignObject></g></g><g transform="translate(108, 401)"><g transform="translate(-60.5, -12)"><foreignObject height="24" width="121"><p><span><p>Found in cache</p></span></p></foreignObject></g></g><g transform="translate(323.25, 287)"><g transform="translate(-50.5, -12)"><foreignObject height="24" width="101"><p><span><p>Not in cache</p></span></p></foreignObject></g></g><g transform="translate(108, 665)"><g transform="translate(-100, -24)"><foreignObject height="48" width="200"><p><span><p>Use cached boot-package</p></span></p></foreignObject></g></g><g transform="translate(323.25, 401)"><g transform="translate(-89.75, -12)"><foreignObject height="24" width="179.5"><p><span><p>Get boot-package info</p></span></p></foreignObject></g></g><g transform="translate(323.25, 527)"><g transform="translate(-93.5, -12)"><foreignObject height="24" width="187"><p><span><p>Cache under hostname</p></span></p></foreignObject></g></g><g transform="translate(323.25, 665)"><g transform="translate(-95.25, -12)"><foreignObject height="24" width="190.5"><p><span><p>Use fresh boot-package</p></span></p></foreignObject></g></g><g transform="translate(215.625, 803)"><g transform="translate(-58.75, -12)"><foreignObject height="24" width="117.5"><p><span><p>Response sent</p></span></p></foreignObject></g></g><g transform="translate(537.625, 527)"><g transform="translate(-100, -24)"><foreignObject height="48" width="200"><p><span><p>Someone&#39;s edit-a-Val request</p></span></p></foreignObject></g></g><g transform="translate(757.625, 527)"><g transform="translate(-100, -24)"><foreignObject height="48" width="200"><p><span><p>Cache invalidation from Redis</p></span></p></foreignObject></g></g><g transform="translate(647.625, 665)"><g transform="translate(-100, -24)"><foreignObject height="48" width="200"><p><span><p>Publish to Redis if edit request</p></span></p></foreignObject></g></g><g transform="translate(647.625, 803)"><g transform="translate(-100, -24)"><foreignObject height="48" width="200"><p><span><p>Cache busted &amp; advertised</p></span></p></foreignObject></g></g></g><g><g transform="translate(215.625, 15)" id="state-root_start-0"><circle height="14" width="14" r="7"></circle></g><g transform="translate(215.625, 92)" id="state-RequestReceived-1"><rect height="40" width="155" y="-20" x="-77.5" ry="5" rx="5" style=""></rect><g transform="translate(-69.5, -12)" style=""><rect></rect><foreignObject height="24" width="139"><p><span><p>RequestReceived</p></span></p></foreignObject></g></g><g transform="translate(215.625, 230)" id="state-CheckCache-3"><rect height="40" width="115.5" y="-20" x="-57.75" ry="5" rx="5" style=""></rect><g transform="translate(-49.75, -12)" style=""><rect></rect><foreignObject height="24" width="99.5"><p><span><p>CheckCache</p></span></p></foreignObject></g></g><g transform="translate(108, 596)" id="state-CacheHit-4"><rect height="40" width="89" y="-20" x="-44.5" ry="5" rx="5" style=""></rect><g transform="translate(-36.5, -12)" style=""><rect></rect><foreignObject height="24" width="73"><p><span><p>CacheHit</p></span></p></foreignObject></g></g><g transform="translate(323.25, 344)" id="state-CacheMiss-5"><rect height="40" width="101.5" y="-20" x="-50.75" ry="5" rx="5" style=""></rect><g transform="translate(-42.75, -12)" style=""><rect></rect><foreignObject height="24" width="85.5"><p><span><p>CacheMiss</p></span></p></foreignObject></g></g><g transform="translate(215.625, 734)" id="state-ProxyToWorker-8"><rect height="40" width="134" y="-20" x="-67" ry="5" rx="5" style=""></rect><g transform="translate(-59, -12)" style=""><rect></rect><foreignObject height="24" width="118"><p><span><p>ProxyToWorker</p></span></p></foreignObject></g></g><g transform="translate(323.25, 458)" id="state-QueryDatabase-6"><rect height="40" width="142" y="-20" x="-71" ry="5" rx="5" style=""></rect><g transform="translate(-63, -12)" style=""><rect></rect><foreignObject height="24" width="126"><p><span><p>QueryDatabase</p></span></p></foreignObject></g></g><g transform="translate(323.25, 596)" id="state-StoreInCache-7"><rect height="40" width="123" y="-20" x="-61.5" ry="5" rx="5" style=""></rect><g transform="translate(-53.5, -12)" style=""><rect></rect><foreignObject height="24" width="107"><p><span><p>StoreInCache</p></span></p></foreignObject></g></g><g transform="translate(432.375, 859)" id="state-root_end-12"><g><path style="" fill="#ECECFF" stroke-width="0" stroke="none" d="M7 0 C7 0.40517908122283747, 6.964012880168563 0.816513743121899, 6.893654271085456 1.2155372436685123 C6.823295662002349 1.6145607442151257, 6.716427752933756 2.013397210557766, 6.5778483455013586 2.394141003279681 C6.439268938068961 2.7748847960015954, 6.26476736710249 3.149104622578984, 6.062177826491071 3.4999999999999996 C5.859588285879653 3.8508953774210153, 5.622755194947063 4.189128084166967, 5.362311101832846 4.499513267805774 C5.10186700871863 4.809898451444582, 4.809898451444583 5.10186700871863, 4.499513267805775 5.362311101832846 C4.189128084166968 5.622755194947063, 3.8508953774210166 5.859588285879652, 3.500000000000001 6.06217782649107 C3.149104622578985 6.264767367102489, 2.7748847960015963 6.439268938068961, 2.3941410032796817 6.5778483455013586 C2.013397210557767 6.716427752933756, 1.6145607442151264 6.823295662002349, 1.2155372436685128 6.893654271085456 C0.8165137431218992 6.964012880168563, 0.4051790812228379 7, 4.286263797015736e-16 7 C-0.405179081222837 7, -0.8165137431218985 6.964012880168563, -1.2155372436685121 6.893654271085456 C-1.6145607442151257 6.823295662002349, -2.0133972105577667 6.716427752933756, -2.394141003279681 6.5778483455013586 C-2.774884796001595 6.439268938068961, -3.149104622578983 6.26476736710249, -3.4999999999999982 6.062177826491071 C-3.8508953774210135 5.859588285879653, -4.189128084166966 5.6227551949470636, -4.499513267805773 5.362311101832848 C-4.809898451444581 5.101867008718632, -5.101867008718628 4.809898451444586, -5.3623111018328435 4.499513267805779 C-5.622755194947059 4.189128084166971, -5.859588285879649 3.8508953774210206, -6.062177826491068 3.5000000000000053 C-6.264767367102486 3.14910462257899, -6.439268938068958 2.774884796001602, -6.577848345501356 2.394141003279688 C-6.716427752933754 2.0133972105577738, -6.823295662002347 1.614560744215134, -6.893654271085454 1.215537243668521 C-6.9640128801685615 0.816513743121908, -6.999999999999999 0.4051790812228472, -7 1.0183126166254463e-14 C-7.000000000000001 -0.40517908122282686, -6.964012880168565 -0.8165137431218878, -6.893654271085459 -1.215537243668501 C-6.823295662002352 -1.6145607442151142, -6.716427752933759 -2.0133972105577542, -6.577848345501363 -2.394141003279669 C-6.439268938068967 -2.7748847960015834, -6.264767367102496 -3.149104622578972, -6.062177826491078 -3.4999999999999876 C-5.859588285879661 -3.8508953774210033, -5.6227551949470715 -4.1891280841669545, -5.362311101832856 -4.499513267805763 C-5.10186700871864 -4.809898451444571, -4.809898451444594 -5.10186700871862, -4.499513267805787 -5.362311101832836 C-4.189128084166979 -5.622755194947053, -3.850895377421028 -5.859588285879643, -3.5000000000000133 -6.062177826491062 C-3.1491046225789985 -6.264767367102482, -2.774884796001611 -6.439268938068954, -2.3941410032796973 -6.577848345501353 C-2.0133972105577835 -6.716427752933752, -1.6145607442151435 -6.823295662002345, -1.2155372436685306 -6.893654271085453 C-0.8165137431219176 -6.9640128801685615, -0.40517908122285695 -6.999999999999999, -1.9937625952807352e-14 -7 C0.4051790812228171 -7.000000000000001, 0.8165137431218781 -6.964012880168565, 1.2155372436684913 -6.89365427108546 C1.6145607442151044 -6.823295662002354, 2.013397210557745 -6.716427752933763, 2.3941410032796595 -6.5778483455013665 C2.774884796001574 -6.43926893806897, 3.149104622578963 -6.2647673671025, 3.499999999999979 -6.062177826491083 C3.8508953774209953 -5.859588285879665, 4.189128084166947 -5.622755194947077, 4.499513267805756 -5.362311101832862 C4.809898451444564 -5.1018670087186475, 5.101867008718613 -4.809898451444602, 5.362311101832829 -4.499513267805796 C5.622755194947046 -4.189128084166989, 5.859588285879637 -3.8508953774210393, 6.062177826491056 -3.500000000000025 C6.2647673671024755 -3.1491046225790105, 6.439268938068949 -2.774884796001623, 6.577848345501348 -2.3941410032797092 C6.716427752933747 -2.0133972105577955, 6.823295662002342 -1.6145607442151562, 6.893654271085451 -1.2155372436685434 C6.96401288016856 -0.8165137431219307, 6.982275711847575 -0.2025895406114567, 7 -3.2800750208310675e-14 C7.017724288152425 0.2025895406113911, 7.017724288152424 -0.2025895406114242, 7 0"></path><path style="" fill="none" stroke-width="2" stroke="#333333" d="M7 0 C7 0.40517908122283747, 6.964012880168563 0.816513743121899, 6.893654271085456 1.2155372436685123 C6.823295662002349 1.6145607442151257, 6.716427752933756 2.013397210557766, 6.5778483455013586 2.394141003279681 C6.439268938068961 2.7748847960015954, 6.26476736710249 3.149104622578984, 6.062177826491071 3.4999999999999996 C5.859588285879653 3.8508953774210153, 5.622755194947063 4.189128084166967, 5.362311101832846 4.499513267805774 C5.10186700871863 4.809898451444582, 4.809898451444583 5.10186700871863, 4.499513267805775 5.362311101832846 C4.189128084166968 5.622755194947063, 3.8508953774210166 5.859588285879652, 3.500000000000001 6.06217782649107 C3.149104622578985 6.264767367102489, 2.7748847960015963 6.439268938068961, 2.3941410032796817 6.5778483455013586 C2.013397210557767 6.716427752933756, 1.6145607442151264 6.823295662002349, 1.2155372436685128 6.893654271085456 C0.8165137431218992 6.964012880168563, 0.4051790812228379 7, 4.286263797015736e-16 7 C-0.405179081222837 7, -0.8165137431218985 6.964012880168563, -1.2155372436685121 6.893654271085456 C-1.6145607442151257 6.823295662002349, -2.0133972105577667 6.716427752933756, -2.394141003279681 6.5778483455013586 C-2.774884796001595 6.439268938068961, -3.149104622578983 6.26476736710249, -3.4999999999999982 6.062177826491071 C-3.8508953774210135 5.859588285879653, -4.189128084166966 5.6227551949470636, -4.499513267805773 5.362311101832848 C-4.809898451444581 5.101867008718632, -5.101867008718628 4.809898451444586, -5.3623111018328435 4.499513267805779 C-5.622755194947059 4.189128084166971, -5.859588285879649 3.8508953774210206, -6.062177826491068 3.5000000000000053 C-6.264767367102486 3.14910462257899, -6.439268938068958 2.774884796001602, -6.577848345501356 2.394141003279688 C-6.716427752933754 2.0133972105577738, -6.823295662002347 1.614560744215134, -6.893654271085454 1.215537243668521 C-6.9640128801685615 0.816513743121908, -6.999999999999999 0.4051790812228472, -7 1.0183126166254463e-14 C-7.000000000000001 -0.40517908122282686, -6.964012880168565 -0.8165137431218878, -6.893654271085459 -1.215537243668501 C-6.823295662002352 -1.6145607442151142, -6.716427752933759 -2.0133972105577542, -6.577848345501363 -2.394141003279669 C-6.439268938068967 -2.7748847960015834, -6.264767367102496 -3.149104622578972, -6.062177826491078 -3.4999999999999876 C-5.859588285879661 -3.8508953774210033, -5.6227551949470715 -4.1891280841669545, -5.362311101832856 -4.499513267805763 C-5.10186700871864 -4.809898451444571, -4.809898451444594 -5.10186700871862, -4.499513267805787 -5.362311101832836 C-4.189128084166979 -5.622755194947053, -3.850895377421028 -5.859588285879643, -3.5000000000000133 -6.062177826491062 C-3.1491046225789985 -6.264767367102482, -2.774884796001611 -6.439268938068954, -2.3941410032796973 -6.577848345501353 C-2.0133972105577835 -6.716427752933752, -1.6145607442151435 -6.823295662002345, -1.2155372436685306 -6.893654271085453 C-0.8165137431219176 -6.9640128801685615, -0.40517908122285695 -6.999999999999999, -1.9937625952807352e-14 -7 C0.4051790812228171 -7.000000000000001, 0.8165137431218781 -6.964012880168565, 1.2155372436684913 -6.89365427108546 C1.6145607442151044 -6.823295662002354, 2.013397210557745 -6.716427752933763, 2.3941410032796595 -6.5778483455013665 C2.774884796001574 -6.43926893806897, 3.149104622578963 -6.2647673671025, 3.499999999999979 -6.062177826491083 C3.8508953774209953 -5.859588285879665, 4.189128084166947 -5.622755194947077, 4.499513267805756 -5.362311101832862 C4.809898451444564 -5.1018670087186475, 5.101867008718613 -4.809898451444602, 5.362311101832829 -4.499513267805796 C5.622755194947046 -4.189128084166989, 5.859588285879637 -3.8508953774210393, 6.062177826491056 -3.500000000000025 C6.2647673671024755 -3.1491046225790105, 6.439268938068949 -2.774884796001623, 6.577848345501348 -2.3941410032797092 C6.716427752933747 -2.0133972105577955, 6.823295662002342 -1.6145607442151562, 6.893654271085451 -1.2155372436685434 C6.96401288016856 -0.8165137431219307, 6.982275711847575 -0.2025895406114567, 7 -3.2800750208310675e-14 C7.017724288152425 0.2025895406113911, 7.017724288152424 -0.2025895406114242, 7 0"></path><g><path style="" fill="#9370DB" stroke-width="0" stroke="none" d="M2.5 0 C2.5 0.14470681472244193, 2.487147457203058 0.29161205111496386, 2.46201938253052 0.4341204441673258 C2.436891307857982 0.5766288372196877, 2.3987241974763416 0.7190704323420595, 2.3492315519647713 0.8550503583141718 C2.299738906453201 0.991030284286284, 2.2374169168223177 1.124680222349637, 2.165063509461097 1.2499999999999998 C2.092710102099876 1.3753197776503625, 2.0081268553382365 1.496117172916774, 1.915111107797445 1.6069690242163481 C1.8220953602566536 1.7178208755159223, 1.7178208755159226 1.8220953602566536, 1.6069690242163484 1.915111107797445 C1.4961171729167742 2.0081268553382365, 1.375319777650363 2.0927101020998755, 1.2500000000000002 2.1650635094610964 C1.1246802223496375 2.2374169168223172, 0.9910302842862845 2.2997389064532, 0.8550503583141721 2.349231551964771 C0.7190704323420597 2.3987241974763416, 0.576628837219688 2.436891307857982, 0.43412044416732604 2.46201938253052 C0.291612051114964 2.487147457203058, 0.14470681472244212 2.5, 1.5308084989341916e-16 2.5 C-0.1447068147224418 2.5, -0.2916120511149638 2.487147457203058, -0.43412044416732576 2.46201938253052 C-0.5766288372196877 2.436891307857982, -0.7190704323420595 2.3987241974763416, -0.8550503583141718 2.3492315519647713 C-0.991030284286284 2.299738906453201, -1.124680222349637 2.2374169168223177, -1.2499999999999996 2.165063509461097 C-1.375319777650362 2.092710102099876, -1.4961171729167733 2.008126855338237, -1.6069690242163475 1.9151111077974459 C-1.7178208755159217 1.8220953602566548, -1.822095360256653 1.7178208755159234, -1.9151111077974443 1.6069690242163495 C-2.0081268553382357 1.4961171729167755, -2.0927101020998746 1.3753197776503645, -2.1650635094610955 1.250000000000002 C-2.2374169168223164 1.1246802223496395, -2.2997389064531992 0.9910302842862865, -2.34923155196477 0.8550503583141743 C-2.3987241974763407 0.7190704323420621, -2.436891307857981 0.5766288372196907, -2.4620193825305194 0.434120444167329 C-2.487147457203058 0.29161205111496724, -2.5 0.14470681472244545, -2.5 3.636830773662308e-15 C-2.5 -0.14470681472243818, -2.4871474572030587 -0.2916120511149599, -2.4620193825305208 -0.4341204441673218 C-2.436891307857983 -0.5766288372196837, -2.398724197476343 -0.7190704323420553, -2.3492315519647726 -0.8550503583141675 C-2.2997389064532023 -0.9910302842862798, -2.23741691682232 -1.1246802223496328, -2.165063509461099 -1.2499999999999956 C-2.092710102099878 -1.3753197776503583, -2.00812685533824 -1.4961171729167695, -1.9151111077974488 -1.606969024216344 C-1.8220953602566576 -1.7178208755159183, -1.7178208755159263 -1.82209536025665, -1.6069690242163523 -1.9151111077974416 C-1.4961171729167784 -2.0081268553382334, -1.3753197776503672 -2.0927101020998724, -1.2500000000000047 -2.1650635094610937 C-1.1246802223496422 -2.237416916822315, -0.9910302842862897 -2.299738906453198, -0.8550503583141776 -2.3492315519647686 C-0.7190704323420656 -2.3987241974763394, -0.5766288372196942 -2.4368913078579806, -0.43412044416733236 -2.462019382530519 C-0.29161205111497057 -2.4871474572030574, -0.1447068147224489 -2.4999999999999996, -7.120580697431198e-15 -2.5 C0.14470681472243463 -2.5000000000000004, 0.29161205111495647 -2.487147457203059, 0.4341204441673183 -2.4620193825305217 C0.5766288372196802 -2.436891307857984, 0.7190704323420518 -2.3987241974763442, 0.8550503583141642 -2.349231551964774 C0.9910302842862766 -2.2997389064532037, 1.1246802223496295 -2.2374169168223212, 1.2499999999999925 -2.165063509461101 C1.3753197776503554 -2.0927101020998804, 1.4961171729167668 -2.008126855338242, 1.6069690242163412 -1.915111107797451 C1.7178208755159157 -1.82209536025666, 1.8220953602566472 -1.7178208755159294, 1.915111107797439 -1.6069690242163557 C2.0081268553382308 -1.496117172916782, 2.09271010209987 -1.3753197776503712, 2.1650635094610915 -1.2500000000000089 C2.237416916822313 -1.1246802223496466, 2.299738906453196 -0.9910302842862939, 2.3492315519647673 -0.855050358314182 C2.3987241974763385 -0.71907043234207, 2.4368913078579792 -0.5766288372196986, 2.462019382530518 -0.4341204441673369 C2.487147457203057 -0.29161205111497523, 2.4936698970884197 -0.07235340736123454, 2.5 -1.1714553645825241e-14 C2.5063301029115803 0.07235340736121111, 2.50633010291158 -0.07235340736122292, 2.5 0"></path><path style="" fill="none" stroke-width="2" stroke="#9370DB" d="M2.5 0 C2.5 0.14470681472244193, 2.487147457203058 0.29161205111496386, 2.46201938253052 0.4341204441673258 C2.436891307857982 0.5766288372196877, 2.3987241974763416 0.7190704323420595, 2.3492315519647713 0.8550503583141718 C2.299738906453201 0.991030284286284, 2.2374169168223177 1.124680222349637, 2.165063509461097 1.2499999999999998 C2.092710102099876 1.3753197776503625, 2.0081268553382365 1.496117172916774, 1.915111107797445 1.6069690242163481 C1.8220953602566536 1.7178208755159223, 1.7178208755159226 1.8220953602566536, 1.6069690242163484 1.915111107797445 C1.4961171729167742 2.0081268553382365, 1.375319777650363 2.0927101020998755, 1.2500000000000002 2.1650635094610964 C1.1246802223496375 2.2374169168223172, 0.9910302842862845 2.2997389064532, 0.8550503583141721 2.349231551964771 C0.7190704323420597 2.3987241974763416, 0.576628837219688 2.436891307857982, 0.43412044416732604 2.46201938253052 C0.291612051114964 2.487147457203058, 0.14470681472244212 2.5, 1.5308084989341916e-16 2.5 C-0.1447068147224418 2.5, -0.2916120511149638 2.487147457203058, -0.43412044416732576 2.46201938253052 C-0.5766288372196877 2.436891307857982, -0.7190704323420595 2.3987241974763416, -0.8550503583141718 2.3492315519647713 C-0.991030284286284 2.299738906453201, -1.124680222349637 2.2374169168223177, -1.2499999999999996 2.165063509461097 C-1.375319777650362 2.092710102099876, -1.4961171729167733 2.008126855338237, -1.6069690242163475 1.9151111077974459 C-1.7178208755159217 1.8220953602566548, -1.822095360256653 1.7178208755159234, -1.9151111077974443 1.6069690242163495 C-2.0081268553382357 1.4961171729167755, -2.0927101020998746 1.3753197776503645, -2.1650635094610955 1.250000000000002 C-2.2374169168223164 1.1246802223496395, -2.2997389064531992 0.9910302842862865, -2.34923155196477 0.8550503583141743 C-2.3987241974763407 0.7190704323420621, -2.436891307857981 0.5766288372196907, -2.4620193825305194 0.434120444167329 C-2.487147457203058 0.29161205111496724, -2.5 0.14470681472244545, -2.5 3.636830773662308e-15 C-2.5 -0.14470681472243818, -2.4871474572030587 -0.2916120511149599, -2.4620193825305208 -0.4341204441673218 C-2.436891307857983 -0.5766288372196837, -2.398724197476343 -0.7190704323420553, -2.3492315519647726 -0.8550503583141675 C-2.2997389064532023 -0.9910302842862798, -2.23741691682232 -1.1246802223496328, -2.165063509461099 -1.2499999999999956 C-2.092710102099878 -1.3753197776503583, -2.00812685533824 -1.4961171729167695, -1.9151111077974488 -1.606969024216344 C-1.8220953602566576 -1.7178208755159183, -1.7178208755159263 -1.82209536025665, -1.6069690242163523 -1.9151111077974416 C-1.4961171729167784 -2.0081268553382334, -1.3753197776503672 -2.0927101020998724, -1.2500000000000047 -2.1650635094610937 C-1.1246802223496422 -2.237416916822315, -0.9910302842862897 -2.299738906453198, -0.8550503583141776 -2.3492315519647686 C-0.7190704323420656 -2.3987241974763394, -0.5766288372196942 -2.4368913078579806, -0.43412044416733236 -2.462019382530519 C-0.29161205111497057 -2.4871474572030574, -0.1447068147224489 -2.4999999999999996, -7.120580697431198e-15 -2.5 C0.14470681472243463 -2.5000000000000004, 0.29161205111495647 -2.487147457203059, 0.4341204441673183 -2.4620193825305217 C0.5766288372196802 -2.436891307857984, 0.7190704323420518 -2.3987241974763442, 0.8550503583141642 -2.349231551964774 C0.9910302842862766 -2.2997389064532037, 1.1246802223496295 -2.2374169168223212, 1.2499999999999925 -2.165063509461101 C1.3753197776503554 -2.0927101020998804, 1.4961171729167668 -2.008126855338242, 1.6069690242163412 -1.915111107797451 C1.7178208755159157 -1.82209536025666, 1.8220953602566472 -1.7178208755159294, 1.915111107797439 -1.6069690242163557 C2.0081268553382308 -1.496117172916782, 2.09271010209987 -1.3753197776503712, 2.1650635094610915 -1.2500000000000089 C2.237416916822313 -1.1246802223496466, 2.299738906453196 -0.9910302842862939, 2.3492315519647673 -0.855050358314182 C2.3987241974763385 -0.71907043234207, 2.4368913078579792 -0.5766288372196986, 2.462019382530518 -0.4341204441673369 C2.487147457203057 -0.29161205111497523, 2.4936698970884197 -0.07235340736123454, 2.5 -1.1714553645825241e-14 C2.5063301029115803 0.07235340736121111, 2.50633010291158 -0.07235340736122292, 2.5 0"></path></g></g></g><g transform="translate(537.625, 458)" id="state-EditRequest-9"><rect height="40" width="112.5" y="-20" x="-56.25" ry="5" rx="5" style=""></rect><g transform="translate(-48.25, -12)" style=""><rect></rect><foreignObject height="24" width="96.5"><p><span><p>EditRequest</p></span></p></foreignObject></g></g><g transform="translate(647.625, 596)" id="state-BustCache-11"><rect height="40" width="102" y="-20" x="-51" ry="5" rx="5" style=""></rect><g transform="translate(-43, -12)" style=""><rect></rect><foreignObject height="24" width="86"><p><span><p>BustCache</p></span></p></foreignObject></g></g><g transform="translate(757.625, 458)" id="state-RedisMessage-10"><rect height="40" width="130.5" y="-20" x="-65.25" ry="5" rx="5" style=""></rect><g transform="translate(-57.25, -12)" style=""><rect></rect><foreignObject height="24" width="114.5"><p><span><p>RedisMessage</p></span></p></foreignObject></g></g><g transform="translate(647.625, 734)" id="state-AdvertiseInvalidation-12"><rect height="40" width="186" y="-20" x="-93" ry="5" rx="5" style=""></rect><g transform="translate(-85, -12)" style=""><rect></rect><foreignObject height="24" width="170"><p><span><p>AdvertiseInvalidation</p></span></p></foreignObject></g></g></g></g></g></svg></div> </div>  
<h2 id="node-as-a-banana">Node, as a Banana!</h2>
<p>Okay, so finally, we reach a point where we‚Äôre able to have a process where,
<em>sometimes</em>, a request comes in to spawn a new Deno worker for a Val, and we DO
NOT need to query the database. Awesome!</p>
<p>But we‚Äôre still bottlenecked.</p>
<p>Our actual nodejs server is single-threaded. And it turns out,
<a href="https://blog.val.town/blog/node-spawn-performance/">spawning processes is pretty slow</a>,
and being single-threaded is definitely not helping. This is like, quite bad.</p>
<p>At higher loads (i.e., req/sec), we‚Äôre stuck ‚Äî there‚Äôs a capable server that‚Äôs
happy to run (possibly expensive) user code, it <strong>does not</strong> need to query the
database, there‚Äôs already a nice warm worker, but our nodejs server simply
cannot proxy the requests fast enough, because every request is going through a
single ‚Äúfunnel‚Äù.</p>
<p>Making this worse is that our nodejs fastify servers are responsible for
<em>everyone‚Äôs</em> Vals‚Äô executions, so it is possible that if one person‚Äôs Val
experiences a huge amount of traffic all of a sudden, that other peoples‚Äô Vals
that consistently hash to that server will also experience a slow down.</p>
<p><strong>Enter the banana</strong>: splitting up work across threads with hostname specific
PID files for workers. With <code>node:cluster</code>, or even other server side Javascript
options (like
<a href="https://docs.deno.com/runtime/reference/cli/serve/"><code>deno serve --parallel</code></a>).</p>
<p>The name of this project comes from the idea that we‚Äôre transforming our
single-threaded nodejs server into a cluster of many nodejs processes. When a
request comes in for a worker, or to spawn a new one, some arbitrary nodejs
process, of many, will be responsible for handling it, and then proxying the
request. That banana process is also responsible for the worker‚Äôs lifecycle.</p>
<hr/>
<div><div><h4>Sequential (Current)</h4><div data-astro-cid-qz3dz2lk=""> <div data-astro-cid-qz3dz2lk=""><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 958 382" style="max-width: 958px; background-color: transparent;" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g><g></g><g><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_A1_Q_0" d="M193.25,62L193.25,66.167C193.25,70.333,193.25,78.667,224.969,88.605C256.688,98.544,320.126,110.089,351.846,115.861L383.565,121.633"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_A2_Q_0" d="M383.75,62L383.75,66.167C383.75,70.333,383.75,78.667,390.797,86.681C397.844,94.694,411.938,102.389,418.985,106.236L426.032,110.083"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_A3_Q_0" d="M574.25,62L574.25,66.167C574.25,70.333,574.25,78.667,567.203,86.681C560.156,94.694,546.062,102.389,539.015,106.236L531.968,110.083"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_A4_Q_0" d="M764.75,62L764.75,66.167C764.75,70.333,764.75,78.667,733.031,88.605C701.312,98.544,637.874,110.089,606.154,115.861L574.435,121.633"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_Q_B_0" d="M479,166L479,170.167C479,174.333,479,182.667,479,190.333C479,198,479,205,479,208.5L479,212"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_B_C1_0" d="M392,255.161L344.5,261.801C297,268.441,202,281.72,154.5,291.86C107,302,107,309,107,312.5L107,316"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_B_C2_0" d="M414.615,270L404.679,274.167C394.744,278.333,374.872,286.667,364.936,294.333C355,302,355,309,355,312.5L355,316"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_B_C3_0" d="M543.385,270L553.321,274.167C563.256,278.333,583.128,286.667,593.064,294.333C603,302,603,309,603,312.5L603,316"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_B_C4_0" d="M566,255.161L613.5,261.801C661,268.441,756,281.72,803.5,291.86C851,302,851,309,851,312.5L851,316"></path></g><g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g></g><g><g transform="translate(193.25, 35)" id="flowchart-A1-0"><rect height="54" width="140.5" y="-27" x="-70.25" style=""></rect><g transform="translate(-40.25, -12)" style=""><rect></rect><foreignObject height="24" width="80.5"><p><span><p>Request 1</p></span></p></foreignObject></g></g><g transform="translate(479, 139)" id="flowchart-Q-1"><rect height="54" width="183" y="-27" x="-91.5" style=""></rect><g transform="translate(-61.5, -12)" style=""><rect></rect><foreignObject height="24" width="123"><p><span><p>Request Queue</p></span></p></foreignObject></g></g><g transform="translate(383.75, 35)" id="flowchart-A2-2"><rect height="54" width="140.5" y="-27" x="-70.25" style=""></rect><g transform="translate(-40.25, -12)" style=""><rect></rect><foreignObject height="24" width="80.5"><p><span><p>Request 2</p></span></p></foreignObject></g></g><g transform="translate(574.25, 35)" id="flowchart-A3-4"><rect height="54" width="140.5" y="-27" x="-70.25" style=""></rect><g transform="translate(-40.25, -12)" style=""><rect></rect><foreignObject height="24" width="80.5"><p><span><p>Request 3</p></span></p></foreignObject></g></g><g transform="translate(764.75, 35)" id="flowchart-A4-6"><rect height="54" width="140.5" y="-27" x="-70.25" style=""></rect><g transform="translate(-40.25, -12)" style=""><rect></rect><foreignObject height="24" width="80.5"><p><span><p>Request 4</p></span></p></foreignObject></g></g><g transform="translate(479, 243)" id="flowchart-B-9"><rect height="54" width="174" y="-27" x="-87" style=""></rect><g transform="translate(-57, -12)" style=""><rect></rect><foreignObject height="24" width="114"><p><span><p>NodeJS Server</p></span></p></foreignObject></g></g><g transform="translate(107, 347)" id="flowchart-C1-11"><rect height="54" width="198" y="-27" x="-99" style=""></rect><g transform="translate(-69, -12)" style=""><rect></rect><foreignObject height="24" width="138"><p><span><p>Process Worker 1</p></span></p></foreignObject></g></g><g transform="translate(355, 347)" id="flowchart-C2-13"><rect height="54" width="198" y="-27" x="-99" style=""></rect><g transform="translate(-69, -12)" style=""><rect></rect><foreignObject height="24" width="138"><p><span><p>Process Worker 2</p></span></p></foreignObject></g></g><g transform="translate(603, 347)" id="flowchart-C3-15"><rect height="54" width="198" y="-27" x="-99" style=""></rect><g transform="translate(-69, -12)" style=""><rect></rect><foreignObject height="24" width="138"><p><span><p>Process Worker 3</p></span></p></foreignObject></g></g><g transform="translate(851, 347)" id="flowchart-C4-17"><rect height="54" width="198" y="-27" x="-99" style=""></rect><g transform="translate(-69, -12)" style=""><rect></rect><foreignObject height="24" width="138"><p><span><p>Process Worker 4</p></span></p></foreignObject></g></g></g></g></g></svg></div> </div>  </div><hr/><div><h4>Concurrent (Banana) üçå <span>(round-robin)</span></h4><div data-astro-cid-qz3dz2lk=""> <div data-astro-cid-qz3dz2lk=""><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 897.125 510" style="max-width: 897.125px; background-color: transparent;" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g><g></g><g><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_A1_Q1_0" d="M93.875,166L93.875,170.167C93.875,174.333,93.875,182.667,100.922,190.681C107.969,198.694,122.063,206.389,129.11,210.236L136.157,214.083"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_A3_Q1_0" d="M284.375,166L284.375,170.167C284.375,174.333,284.375,182.667,277.328,190.681C270.281,198.694,256.187,206.389,249.14,210.236L242.093,214.083"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_A2_Q2_0" d="M542.125,62L542.125,66.167C542.125,70.333,542.125,78.667,542.125,86.333C542.125,94,542.125,101,542.125,104.5L542.125,108"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_A4_Q2_0" d="M732.625,62L732.625,66.167C732.625,70.333,732.625,78.667,712.143,88.424C691.661,98.182,650.698,109.363,630.216,114.954L609.734,120.545"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_Q1_B1_0" d="M189.125,270L189.125,276.167C189.125,282.333,189.125,294.667,192.795,306.442C196.465,318.218,203.804,329.435,207.474,335.044L211.144,340.653"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_Q2_B2_0" d="M542.125,166L542.125,170.167C542.125,174.333,542.125,182.667,542.125,190.333C542.125,198,542.125,205,542.125,208.5L542.125,212"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_B2_B1_0" d="M472.199,270L456.229,276.167C440.258,282.333,408.316,294.667,378.948,306.731C349.58,318.796,322.786,330.592,309.388,336.49L295.991,342.388"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_B1_C1_0" d="M166.615,398L156.679,402.167C146.744,406.333,126.872,414.667,116.936,422.333C107,430,107,437,107,440.5L107,444"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_B1_C3_0" d="M295.385,398L305.321,402.167C315.256,406.333,335.128,414.667,345.064,422.333C355,430,355,437,355,440.5L355,444"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_B2_C2_0" d="M542.125,270L542.125,276.167C542.125,282.333,542.125,294.667,542.125,306.333C542.125,318,542.125,329,542.125,334.5L542.125,340"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_B2_C4_0" d="M640.875,268.484L665.75,274.903C690.625,281.323,740.375,294.161,765.25,306.081C790.125,318,790.125,329,790.125,334.5L790.125,340"></path></g><g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g transform="translate(376.375, 307)"><g transform="translate(-63.75, -12)"><foreignObject height="24" width="127.5"><p><span><p>Child process of</p></span></p></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g></g><g><g transform="translate(93.875, 139)" id="flowchart-A1-0"><rect height="54" width="140.5" y="-27" x="-70.25" style=""></rect><g transform="translate(-40.25, -12)" style=""><rect></rect><foreignObject height="24" width="80.5"><p><span><p>Request 1</p></span></p></foreignObject></g></g><g transform="translate(189.125, 243)" id="flowchart-Q1-1"><rect height="54" width="127.5" y="-27" x="-63.75" style=""></rect><g transform="translate(-33.75, -12)" style=""><rect></rect><foreignObject height="24" width="67.5"><p><span><p>Queue 1</p></span></p></foreignObject></g></g><g transform="translate(284.375, 139)" id="flowchart-A3-2"><rect height="54" width="140.5" y="-27" x="-70.25" style=""></rect><g transform="translate(-40.25, -12)" style=""><rect></rect><foreignObject height="24" width="80.5"><p><span><p>Request 3</p></span></p></foreignObject></g></g><g transform="translate(542.125, 35)" id="flowchart-A2-4"><rect height="54" width="140.5" y="-27" x="-70.25" style=""></rect><g transform="translate(-40.25, -12)" style=""><rect></rect><foreignObject height="24" width="80.5"><p><span><p>Request 2</p></span></p></foreignObject></g></g><g transform="translate(542.125, 139)" id="flowchart-Q2-5"><rect height="54" width="127.5" y="-27" x="-63.75" style=""></rect><g transform="translate(-33.75, -12)" style=""><rect></rect><foreignObject height="24" width="67.5"><p><span><p>Queue 2</p></span></p></foreignObject></g></g><g transform="translate(732.625, 35)" id="flowchart-A4-6"><rect height="54" width="140.5" y="-27" x="-70.25" style=""></rect><g transform="translate(-40.25, -12)" style=""><rect></rect><foreignObject height="24" width="80.5"><p><span><p>Request 4</p></span></p></foreignObject></g></g><g transform="translate(231, 371)" id="flowchart-B1-9"><rect height="54" width="197.5" y="-27" x="-98.75" style=""></rect><g transform="translate(-68.75, -12)" style=""><rect></rect><foreignObject height="24" width="137.5"><p><span><p>NodeJS Process 1</p></span></p></foreignObject></g></g><g transform="translate(542.125, 243)" id="flowchart-B2-11"><rect height="54" width="197.5" y="-27" x="-98.75" style=""></rect><g transform="translate(-68.75, -12)" style=""><rect></rect><foreignObject height="24" width="137.5"><p><span><p>NodeJS Process 2</p></span></p></foreignObject></g></g><g transform="translate(107, 475)" id="flowchart-C1-15"><rect height="54" width="198" y="-27" x="-99" style=""></rect><g transform="translate(-69, -12)" style=""><rect></rect><foreignObject height="24" width="138"><p><span><p>Process Worker 1</p></span></p></foreignObject></g></g><g transform="translate(355, 475)" id="flowchart-C3-17"><rect height="54" width="198" y="-27" x="-99" style=""></rect><g transform="translate(-69, -12)" style=""><rect></rect><foreignObject height="24" width="138"><p><span><p>Process Worker 3</p></span></p></foreignObject></g></g><g transform="translate(542.125, 371)" id="flowchart-C2-19"><rect height="54" width="198" y="-27" x="-99" style=""></rect><g transform="translate(-69, -12)" style=""><rect></rect><foreignObject height="24" width="138"><p><span><p>Process Worker 2</p></span></p></foreignObject></g></g><g transform="translate(790.125, 371)" id="flowchart-C4-21"><rect height="54" width="198" y="-27" x="-99" style=""></rect><g transform="translate(-69, -12)" style=""><rect></rect><foreignObject height="24" width="138"><p><span><p>Process Worker 4</p></span></p></foreignObject></g></g></g></g></g></svg></div> </div>  </div></div>
<hr/>
<p>But <em>concurrency is hard</em>.</p>
<p>We wanted to be able to accept many requests at once, but preserve a resilient
source of truth for our users‚Äô processes. My idea was simple: cross-thread (err,
process, since <code>node:cluster</code>, discussed later, uses processes) communication in
node is hard and finicky, especially with complex and changing state. Why not,
instead, use the file system?</p>
<details> <summary> What cross-process communication looks like in node:cluster </summary> <div> <pre tabindex="0" data-language="ts"><code><span><span>import</span><span> cluster </span><span>from</span><span> &#39;node:cluster&#39;</span><span>;</span></span>
<span><span>import</span><span> { cpus } </span><span>from</span><span> &#39;node:os&#39;</span><span>;</span></span>
<span><span>import</span><span> { createServer } </span><span>from</span><span> &#39;node:http&#39;</span><span>;</span></span>
<span></span>
<span><span>if</span><span> (cluster.isPrimary) {</span></span>
<span><span>  // Fork one worker per CPU</span></span>
<span><span>  const</span><span> numCPUs</span><span> =</span><span> cpus</span><span>().</span><span>length</span><span>;</span></span>
<span><span>  for</span><span> (</span><span>let</span><span> i </span><span>=</span><span> 0</span><span>; i </span><span>&lt;</span><span> numCPUs; i</span><span>++</span><span>) cluster.</span><span>fork</span><span>();</span></span>
<span></span>
<span><span>  // Example: send message to all workers</span></span>
<span><span>  for</span><span> (</span><span>const</span><span> id</span><span> in</span><span> cluster.workers) {</span></span>
<span><span>    cluster.workers[id]?.</span><span>send</span><span>({ cmd: </span><span>&#39;hello&#39;</span><span>, from: </span><span>&#39;primary&#39;</span><span> });</span></span>
<span><span>  }</span></span>
<span></span>
<span><span>  // Listen for messages from workers</span></span>
<span><span>  cluster.</span><span>on</span><span>(</span><span>&#39;message&#39;</span><span>, (</span><span>worker</span><span>, </span><span>msg</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    console.</span><span>log</span><span>(</span><span>`Primary received from worker ${</span><span>worker</span><span>.</span><span>id</span><span>}:`</span><span>, msg);</span></span>
<span><span>  });</span></span>
<span><span>} </span><span>else</span><span> {</span></span>
<span><span>  // Each worker runs its own HTTP server</span></span>
<span><span>  const</span><span> server</span><span> =</span><span> createServer</span><span>((</span><span>req</span><span>, </span><span>res</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    process.</span><span>send</span><span>?.({ cmd: </span><span>&#39;request&#39;</span><span>, pid: process.pid });</span></span>
<span><span>    res.</span><span>end</span><span>(</span><span>`Handled by worker ${</span><span>process</span><span>.</span><span>pid</span><span>}</span><span>\n</span><span>`</span><span>);</span></span>
<span><span>  });</span></span>
<span></span>
<span><span>  // Listen for messages from primary</span></span>
<span><span>  process.</span><span>on</span><span>(</span><span>&#39;message&#39;</span><span>, (</span><span>msg</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    console.</span><span>log</span><span>(</span><span>`Worker ${</span><span>process</span><span>.</span><span>pid</span><span>} got message:`</span><span>, msg);</span></span>
<span><span>  });</span></span>
<span></span>
<span><span>  server.</span><span>listen</span><span>(</span><span>3000</span><span>);</span></span>
<span><span>}</span></span>
<span></span></code></pre> </div> </details>
<p>Also, another aside: we were exploring writing this part of our server stack in
Deno, and deno does not even have any primitives for communication when using
<code>deno serve --parallel</code>, so this file system approach would be portable to Deno.</p>
<p>Files are nice and easy :)</p>
<p>To route processes to a javascript process manager, let‚Äôs just create a file
with metadata about the process. And while we‚Äôre at it, why not make that the
unix socket file too? I mean, we‚Äôll need to make a unix socket file eventually,
since we will at the end of the day be proxying requests to deno workers over
unix sockets.</p>
<p>I actually had this initial crazy idea of storing the ‚Äúboot information‚Äù in the
<em>name</em> of the socket file itself (as a uri-encoded JSON), and we could rename
the socket file to update the state, but it turns out <a href="https://unix.stackexchange.com/questions/367008/why-is-socket-path-length-limited-to-a-hundred-chars">there‚Äôs pretty strict
limits to the length of unix
filenames</a>.</p>
<p>Okay, so let‚Äôs say that if we are a worker, and we receive a request, and we
look and see that there‚Äôs a unix socket file in a folder that has the literal
name being the hostname of the request we received, we are allowed to proxy. If
we don‚Äôt, then we can delegate to a primary process that‚Äôs allowed to talk to
the database, which can do the actual spawning, while we wait for it to finish
and the needed unix socket file to come into existence.</p>
<p>It‚Äôs a little bit complicated when you start to actually think about how the
system works, but here‚Äôs the general idea:</p>
<ol>
<li>
<p>We have many nodejs workers, these are all forked from a primary nodejs
process. We‚Äôll see what this actually ends up looking like a little bit later
(scroll ahead if you want to see code!)</p>
</li>
<li>
<p>When we spawn a deno worker for the first time, we may need to hit the
database. We may not need to hit the database. It depends on if there‚Äôs a
valid entry in cache. We actually can also store these entries on the file
system, as long as we‚Äôre careful about deleting them. If we see an</p>
</li>
<li>
<p>We don‚Äôt want every single child process to sat up a database pool seat, so
instead we forward the request to the primary process, which is the only
process that is capable of actually hitting the database to get information
necessary to spawn the deno process.</p>
</li>
</ol>
<p>We‚Äôve simplified it a bit, but that‚Äôs the general idea. Here‚Äôs a diagram!</p>
<div data-astro-cid-qz3dz2lk=""> <div data-astro-cid-qz3dz2lk=""><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 1430.5 738.8965454101562" style="max-width: 1430.5px; background-color: transparent;" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g><g><g data-look="classic" id="Workers"><rect height="120.89655303955078" width="1000" y="610" x="90" style=""></rect><g transform="translate(495.5, 610)"><foreignObject height="24" width="189"><p><span><p>Deno Worker Processes</p></span></p></foreignObject></g></g><g data-look="classic" id="FS"><rect height="128" width="885.625" y="336" x="62.625" style=""></rect><g transform="translate(405.4375, 336)"><foreignObject height="48" width="200"><p><span><p>File System (Unix Sockets)</p></span></p></foreignObject></g></g></g><g><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_R1_N1_0" d="M1039.125,98L1039.125,104.167C1039.125,110.333,1039.125,122.667,1039.125,132.333C1039.125,142,1039.125,149,1039.125,152.5L1039.125,156"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_N1_N0_0" d="M1116.865,214L1146.138,224.167C1175.41,234.333,1233.955,254.667,1263.228,275C1292.5,295.333,1292.5,315.667,1292.5,329.333C1292.5,343,1292.5,350,1292.5,353.5L1292.5,357"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_N0_DB_0" d="M1292.5,439L1292.5,443.167C1292.5,447.333,1292.5,455.667,1292.5,472C1292.5,488.333,1292.5,512.667,1292.5,537C1292.5,561.333,1292.5,585.667,1292.5,601.333C1292.5,617,1292.5,624,1292.5,627.5L1292.5,631"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_DB_N0_0" d="M1246.25,655.129L1223.542,647.608C1200.833,640.086,1155.417,625.043,1132.708,605.355C1110,585.667,1110,561.333,1110,537C1110,512.667,1110,488.333,1121.252,472.221C1132.505,456.108,1155.01,448.216,1166.262,444.27L1177.514,440.324"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_N0_N1_0" d="M1162.5,367.163L1141.938,361.969C1121.375,356.776,1080.25,346.388,1059.688,331.027C1039.125,315.667,1039.125,295.333,1039.125,275.667C1039.125,256,1039.125,237,1039.125,227.5L1039.125,218"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_N1_F1_0" d="M944.125,199.274L846.438,211.895C748.75,224.516,553.375,249.758,455.688,272.546C358,295.333,358,315.667,347.977,331.665C337.955,347.663,317.909,359.326,307.886,365.157L297.864,370.988"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_F1_W1_0" d="M248,427L248,433.167C248,439.333,248,451.667,248,470C248,488.333,248,512.667,248,537C248,561.333,248,585.667,248,602.741C248,619.816,248,629.632,248,634.54L248,639.448"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_R2_N2_0" d="M138,110L138,114.167C138,118.333,138,126.667,138,134.333C138,142,138,149,138,152.5L138,156"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_N2_F1_0" d="M138,214L138,224.167C138,234.333,138,254.667,138,275C138,295.333,138,315.667,148.023,331.665C158.045,347.663,178.091,359.326,188.114,365.157L198.136,370.988"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_R3_N3_0" d="M606.375,98L606.375,104.167C606.375,110.333,606.375,122.667,606.375,132.333C606.375,142,606.375,149,606.375,152.5L606.375,156"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_N3_F2_0" d="M615.771,214L619.309,224.167C622.848,234.333,629.924,254.667,633.462,275C637,295.333,637,315.667,637,331.333C637,347,637,358,637,363.5L637,369"></path><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" id="L_F2_W2_0" d="M637,427L637,433.167C637,439.333,637,451.667,637,470C637,488.333,637,512.667,637,537C637,561.333,637,585.667,637,602.741C637,619.816,637,629.632,637,634.54L637,639.448"></path></g><g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g transform="translate(1292.5, 275)"><g transform="translate(-100, -36)"><foreignObject height="72" width="200"><p><span><p>Ask boot info if not in /cache/a.com.json (for example)</p></span></p></foreignObject></g></g><g transform="translate(1292.5, 537)"><g transform="translate(-62.5, -12)"><foreignObject height="24" width="125"><p><span><p>Query boot info</p></span></p></foreignObject></g></g><g transform="translate(1110, 537)"><g transform="translate(-100, -48)"><foreignObject height="96" width="200"><p><span><p>Return boot info and put in /cache/a.com.json (for example)</p></span></p></foreignObject></g></g><g transform="translate(1039.125, 275)"><g transform="translate(-38.75, -12)"><foreignObject height="24" width="77.5"><p><span><p>Responds</p></span></p></foreignObject></g></g><g transform="translate(358, 275)"><g transform="translate(-100, -24)"><foreignObject height="48" width="200"><p><span><p>Spawn worker &amp; create socket</p></span></p></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g transform="translate(138, 275)"><g transform="translate(-100, -24)"><foreignObject height="48" width="200"><p><span><p>Wait for a.com.sock to appear</p></span></p></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g><g transform="translate(637, 275)"><g transform="translate(-80.75, -12)"><foreignObject height="24" width="161.5"><p><span><p>Proxy to b.com.sock</p></span></p></foreignObject></g></g><g><g transform="translate(0, 0)"><foreignObject height="0" width="0"></foreignObject></g></g></g><g><g transform="translate(1039.125, 59)" id="flowchart-R1-0"><rect height="78" width="260" y="-39" x="-130" style="fill:#e0f7fa !important;stroke:#006064 !important"></rect><g transform="translate(-100, -24)" style=""><rect></rect><foreignObject height="48" width="200"><p><span><p>Initial Cold Request --&gt; a.com (arrives first)</p></span></p></foreignObject></g></g><g transform="translate(138, 59)" id="flowchart-R2-1"><rect height="102" width="260" y="-51" x="-130" style="fill:#e0f7fa !important;stroke:#006064 !important"></rect><g transform="translate(-100, -36)" style=""><rect></rect><foreignObject height="72" width="200"><p><span><p>Already Warming Request --&gt; a.com (arrives during spawn)</p></span></p></foreignObject></g></g><g transform="translate(1292.5, 400)" id="flowchart-N0-2"><rect height="78" width="260" y="-39" x="-130" style="fill:#e1f5fe !important;stroke:#0288d1 !important"></rect><g transform="translate(-100, -24)" style=""><rect></rect><foreignObject height="48" width="200"><p><span><p>NodeJS Primary (boot info + cache)</p></span></p></foreignObject></g></g><g transform="translate(1039.125, 187)" id="flowchart-N1-3"><rect height="54" width="190" y="-27" x="-95" style="fill:#f3e5f5 !important;stroke:#7b1fa2 !important"></rect><g transform="translate(-65, -12)" style=""><rect></rect><foreignObject height="24" width="130"><p><span><p>NodeJS Child #1</p></span></p></foreignObject></g></g><g transform="translate(138, 187)" id="flowchart-N2-4"><rect height="54" width="190" y="-27" x="-95" style="fill:#f3e5f5 !important;stroke:#7b1fa2 !important"></rect><g transform="translate(-65, -12)" style=""><rect></rect><foreignObject height="24" width="130"><p><span><p>NodeJS Child #2</p></span></p></foreignObject></g></g><g transform="translate(606.375, 187)" id="flowchart-N3-5"><rect height="54" width="190" y="-27" x="-95" style="fill:#f3e5f5 !important;stroke:#7b1fa2 !important"></rect><g transform="translate(-65, -12)" style=""><rect></rect><foreignObject height="24" width="130"><p><span><p>NodeJS Child #3</p></span></p></foreignObject></g></g><g transform="translate(1292.5, 670.4482765197754)" id="flowchart-DB-6"><path transform="translate(-46.25, -35.44827586206897)" style="fill:#ede7f6 !important;stroke:#5e35b1 !important" d="M0,10.632183908045977 a46.25,10.632183908045977 0,0,0 92.5,0 a46.25,10.632183908045977 0,0,0 -92.5,0 l0,49.632183908045974 a46.25,10.632183908045977 0,0,0 92.5,0 l0,-49.632183908045974"></path><g transform="translate(-38.75, -2)" style=""><rect></rect><foreignObject height="24" width="77.5"><p><span><p>Database</p></span></p></foreignObject></g></g><g transform="translate(248, 400)" id="flowchart-F1-7"><rect height="54" width="151.5" y="-27" x="-75.75" style="fill:#e8f5e8 !important;stroke:#388e3c !important"></rect><g transform="translate(-45.75, -12)" style=""><rect></rect><foreignObject height="24" width="91.5"><p><span><p>a.com.sock</p></span></p></foreignObject></g></g><g transform="translate(637, 400)" id="flowchart-F2-8"><rect height="54" width="151.5" y="-27" x="-75.75" style="fill:#e8f5e8 !important;stroke:#388e3c !important"></rect><g transform="translate(-45.75, -12)" style=""><rect></rect><foreignObject height="24" width="91.5"><p><span><p>b.com.sock</p></span></p></foreignObject></g></g><g transform="translate(838, 400)" id="flowchart-F3-9"><rect height="54" width="150.5" y="-27" x="-75.25" style="fill:#e8f5e8 !important;stroke:#388e3c !important"></rect><g transform="translate(-45.25, -12)" style=""><rect></rect><foreignObject height="24" width="90.5"><p><span><p>c.com.sock</p></span></p></foreignObject></g></g><g transform="translate(248, 670.4482765197754)" id="flowchart-W1-10"><rect height="54" width="246" y="-27" x="-123" style="fill:#fff3e0 !important;stroke:#f57c00 !important"></rect><g transform="translate(-93, -12)" style=""><rect></rect><foreignObject height="24" width="186"><p><span><p>Deno Worker for a.com</p></span></p></foreignObject></g></g><g transform="translate(637, 670.4482765197754)" id="flowchart-W2-11"><rect height="54" width="246" y="-27" x="-123" style="fill:#fff3e0 !important;stroke:#f57c00 !important"></rect><g transform="translate(-93, -12)" style=""><rect></rect><foreignObject height="24" width="186"><p><span><p>Deno Worker for b.com</p></span></p></foreignObject></g></g><g transform="translate(932.5, 670.4482765197754)" id="flowchart-W3-12"><rect height="54" width="245" y="-27" x="-122.5" style="fill:#fff3e0 !important;stroke:#f57c00 !important"></rect><g transform="translate(-92.5, -12)" style=""><rect></rect><foreignObject height="24" width="185"><p><span><p>Deno Worker for c.com</p></span></p></foreignObject></g></g><g transform="translate(606.375, 59)" id="flowchart-R3-31"><rect height="78" width="260" y="-39" x="-130" style="fill:#e0f7fa !important;stroke:#006064 !important"></rect><g transform="translate(-100, -24)" style=""><rect></rect><foreignObject height="48" width="200"><p><span><p>Warm Request --&gt; b.com (happy path)</p></span></p></foreignObject></g></g></g></g></g></svg></div> </div>  
<p>Like we said above, in the diagram there‚Äôs three example requests, and they
arrive in this timeline:</p>
<ol>
<li>An initial cold request for a.com, which requires spawning a new worker. In
order to spawn the new worker the child process creates a lock for the hostname.
It then asks the primary process for boot info, which it queries from the
database, since there was no cached boot info (recall cached boot info just
gets stored in a file). The primary process returns the boot info, and the
child process spawns the worker, creating the unix socket file.</li>
<li>An already warming request for a.com, which arrives while the first request
is still spawning the worker. This process sees that there‚Äôs no socket file
yet, and so it waits for it to appear (it could also ask the primary process
for boot info, but that would be wasteful since another process is already
spawning it).</li>
<li>A warm request for b.com, which is the happy path. The child process sees
that there‚Äôs already a socket file for b.com, and so it just proxies to it.</li>
</ol>
<h2 id="going-in-parallel">Going in Parallel</h2>
<p>Okay so we have a general idea of how the system will work, at a high level. But
how do we implement something like this ‚Äî a proxying setup ‚Äî in, err, server
side javascript?</p>
<p>Well, to start, to do real parallelism in serverside JS land, there‚Äôs a few
paths:</p>
<p>At Val Town, we love Deno! Deno makes super easy to make concurrent request
handlers with
<a href="https://docs.deno.com/runtime/reference/cli/serve/"><code>deno serve --parallel</code></a>!</p>
<p>Deno will:</p>
<ul>
<li>Automatically create multiple threads to handle user requests, and</li>
<li>Round robins between them as requests roll in</li>
</ul>
<pre tabindex="0" data-language="ts"><code><span><span>export</span><span> default</span><span> {</span></span>
<span><span>  async</span><span> fetch</span><span>(request) </span><span>{</span></span>
<span><span>    if</span><span> (request.url.</span><span>endsWith</span><span>(</span><span>&#39;/json&#39;</span><span>)) {</span></span>
<span><span>      return</span><span> Response.</span><span>json</span><span>({ hello: </span><span>&#39;world&#39;</span><span> })</span></span>
<span><span>    }</span></span>
<span></span>
<span><span>    return</span><span> new</span><span> Response</span><span>(</span><span>&#39;Hello world!&#39;</span><span>)</span></span>
<span><span>  }</span><span>,</span></span>
<span><span>} </span><span>satisfies</span><span> Deno.ServeDefaultExport</span></span></code></pre>
<p>Nodejs has the same thing! But it‚Äôs built into the language, not a CLI feature.</p>
<p>This is what we hinted at earlier, and this is node‚Äôs
<a href="https://nodejs.org/api/cluster.html"><code>node:cluster</code></a> module: a way to fork
multiple processes of the same server, and have them share incoming connections
by round robining.</p>
<p>It looks like this:</p>
<pre tabindex="0" data-language="ts"><code><span><span>import</span><span> cluster </span><span>from</span><span> &#39;node:cluster&#39;</span></span>
<span><span>import</span><span> http </span><span>from</span><span> &#39;node:http&#39;</span></span>
<span><span>import</span><span> os </span><span>from</span><span> &#39;node:os&#39;</span></span>
<span></span>
<span><span>const</span><span> numCPUs</span><span> =</span><span> os.</span><span>cpus</span><span>().</span><span>length</span></span>
<span></span>
<span><span>if</span><span> (cluster.isPrimary) {</span></span>
<span><span>  // Fork workers.</span></span>
<span><span>  for</span><span> (</span><span>let</span><span> i </span><span>=</span><span> 0</span><span>; i </span><span>&lt;</span><span> numCPUs; i</span><span>++</span><span>) {</span></span>
<span><span>    cluster.</span><span>fork</span><span>()</span></span>
<span><span>  }</span></span>
<span></span>
<span><span>  cluster.</span><span>on</span><span>(</span><span>&#39;exit&#39;</span><span>, (</span><span>worker</span><span>, </span><span>code</span><span>, </span><span>signal</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    console.</span><span>log</span><span>(</span><span>`Worker ${</span><span>worker</span><span>.</span><span>process</span><span>.</span><span>pid</span><span>} died`</span><span>)</span></span>
<span><span>  })</span></span>
<span><span>} </span><span>else</span><span> {</span></span>
<span><span>  // Workers can share any TCP connection.</span></span>
<span><span>  // In this case, it is an HTTP server.</span></span>
<span><span>  http</span></span>
<span><span>    .</span><span>createServer</span><span>((</span><span>req</span><span>, </span><span>res</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>      res.</span><span>writeHead</span><span>(</span><span>200</span><span>)</span></span>
<span><span>      res.</span><span>end</span><span>(</span><span>&#39;Hello world!&#39;</span><span>)</span></span>
<span><span>    })</span></span>
<span><span>    .</span><span>listen</span><span>(</span><span>8000</span><span>)</span></span>
<span><span>}</span></span></code></pre>
<details> <summary> Of course, we&#39;re using fastify, so it&#39;s really more like this... </summary> <div> <pre tabindex="0" data-language="ts"><code><span><span>import</span><span> cluster </span><span>from</span><span> &#39;node:cluster&#39;</span></span>
<span><span>import</span><span> os </span><span>from</span><span> &#39;node:os&#39;</span></span>
<span><span>import</span><span> Fastify </span><span>from</span><span> &#39;fastify&#39;</span></span>
<span></span>
<span><span>const</span><span> numCPUs</span><span> =</span><span> os.</span><span>cpus</span><span>().</span><span>length</span></span>
<span></span>
<span><span>if</span><span> (cluster.isPrimary) {</span></span>
<span><span>  // Fork workers.</span></span>
<span><span>  for</span><span> (</span><span>let</span><span> i </span><span>=</span><span> 0</span><span>; i </span><span>&lt;</span><span> numCPUs; i</span><span>++</span><span>) {</span></span>
<span><span>    cluster.</span><span>fork</span><span>()</span></span>
<span><span>  }</span></span>
<span></span>
<span><span>  cluster.</span><span>on</span><span>(</span><span>&#39;exit&#39;</span><span>, (</span><span>worker</span><span>, </span><span>code</span><span>, </span><span>signal</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    console.</span><span>log</span><span>(</span><span>`Worker ${</span><span>worker</span><span>.</span><span>process</span><span>.</span><span>pid</span><span>} died`</span><span>)</span></span>
<span><span>  })</span></span>
<span><span>} </span><span>else</span><span> {</span></span>
<span><span>  const</span><span> fastify</span><span> =</span><span> Fastify</span><span>()</span></span>
<span></span>
<span><span>  fastify.</span><span>get</span><span>(</span><span>&#39;/&#39;</span><span>, </span><span>async</span><span> (</span><span>request</span><span>, </span><span>reply</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    return</span><span> { hello: </span><span>&#39;world&#39;</span><span> }</span></span>
<span><span>  })</span></span>
<span></span>
<span><span>  fastify.</span><span>listen</span><span>({ port: </span><span>8000</span><span> }, (</span><span>err</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    if</span><span> (err) {</span></span>
<span><span>      console.</span><span>error</span><span>(err)</span></span>
<span><span>      process.</span><span>exit</span><span>(</span><span>1</span><span>)</span></span>
<span><span>    }</span></span>
<span><span>  })</span></span>
<span><span>}</span></span>
<span></span></code></pre> </div> </details>
<details> <summary> And, for good measure, Bun has its own super cool, Linux way to do this! </summary> <div> <p>With Bun, you can take advantage of <code>SO_REUSEPORT</code> and <code>SO_REUSEADDR</code> socket
options to allow multiple processes to listen on the same port and address (crazy!).</p><p>Here‚Äôs the examples from <a href="https://bun.com/docs/guides/http/cluster">their docs</a>:</p><pre tabindex="0" data-language="ts"><code><span><span>// server.ts</span></span>
<span></span>
<span><span>import</span><span> {serve} </span><span>from</span><span> &#39;bun&#39;</span><span>;</span></span>
<span></span>
<span><span>const</span><span> id</span><span> =</span><span> Math.</span><span>random</span><span>().</span><span>toString</span><span>(</span><span>36</span><span>).</span><span>slice</span><span>(</span><span>2</span><span>);</span></span>
<span></span>
<span><span>serve</span><span>({</span></span>
<span><span>	port: process.env.</span><span>PORT</span><span> ||</span><span> 8080</span><span>,</span></span>
<span><span>	development: </span><span>false</span><span>,</span></span>
<span></span>
<span><span>	// Share the same port across multiple processes</span></span>
<span><span>	// This is the important part!</span></span>
<span><span>	reusePort: </span><span>true</span><span>,</span></span>
<span></span>
<span><span>	async</span><span> fetch</span><span>(</span><span>request</span><span>) {</span></span>
<span><span>		return</span><span> new</span><span> Response</span><span>(</span><span>&#39;Hello from Bun #&#39;</span><span> +</span><span> id </span><span>+</span><span> &#39;!</span><span>\n</span><span>&#39;</span><span>);</span></span>
<span><span>	},</span></span>
<span><span>});</span></span></code></pre><pre tabindex="0" data-language="ts"><code><span><span>// cluster.ts (spawns instances of server.ts)</span></span>
<span><span>import</span><span> { spawn } </span><span>from</span><span> &#39;bun&#39;</span></span>
<span></span>
<span><span>const</span><span> cpus</span><span> =</span><span> navigator.hardwareConcurrency </span><span>// Number of CPU cores</span></span>
<span><span>const</span><span> buns</span><span> =</span><span> new</span><span> Array</span><span>(cpus)</span></span>
<span></span>
<span><span>for</span><span> (</span><span>let</span><span> i </span><span>=</span><span> 0</span><span>; i </span><span>&lt;</span><span> cpus; i</span><span>++</span><span>) {</span></span>
<span><span>  buns[i] </span><span>=</span><span> spawn</span><span>({</span></span>
<span><span>    cmd: [</span><span>&#39;bun&#39;</span><span>, </span><span>&#39;./server.ts&#39;</span><span>],</span></span>
<span><span>    stdout: </span><span>&#39;inherit&#39;</span><span>,</span></span>
<span><span>    stderr: </span><span>&#39;inherit&#39;</span><span>,</span></span>
<span><span>    stdin: </span><span>&#39;inherit&#39;</span><span>,</span></span>
<span><span>  })</span></span>
<span><span>}</span></span>
<span></span>
<span><span>function</span><span> kill</span><span>() {</span></span>
<span><span>  for</span><span> (</span><span>const</span><span> bun</span><span> of</span><span> buns) {</span></span>
<span><span>    bun.</span><span>kill</span><span>()</span></span>
<span><span>  }</span></span>
<span><span>}</span></span>
<span></span>
<span><span>process.</span><span>on</span><span>(</span><span>&#39;SIGINT&#39;</span><span>, kill)</span></span>
<span><span>process.</span><span>on</span><span>(</span><span>&#39;exit&#39;</span><span>, kill)</span></span></code></pre><p>And Bun also supports <code>node:cluster</code>!
<a href="https://docs.deno.com/api/node/cluster/">(Deno does <strong>not</strong>)</a>.</p> </div> </details>
<p>And, since we have control of the code that the primary runs versus the workers,
we can have the primary process be the only one that hits the database, while
the workers just proxy to it when they need to spawn a new Deno worker for a
Val.</p>
<p>We just conditionally grab a database connection!</p>
<details> <summary> Just for fun, you may recall that forking like this is quite similar to good old&#39; C process forking </summary> <div> <pre tabindex="0" data-language="c"><code><span><span>#include</span><span> &lt;unistd.h&gt;</span></span>
<span><span>#include</span><span> &lt;sys/types.h&gt;</span></span>
<span><span>#include</span><span> &lt;sys/wait.h&gt;</span></span>
<span></span>
<span><span>int</span><span> main</span><span>() { </span><span>int</span><span> num_processes </span><span>=</span><span> 4</span><span>;</span><span> // Number of child processes to create for</span></span>
<span><span>(</span><span>int</span><span> i </span><span>=</span><span> 0</span><span>; i </span><span>&lt;</span><span> num_processes; i</span><span>++</span><span>) { </span><span>pid_t</span><span> pid </span><span>=</span><span> fork</span><span>(); </span><span>if</span><span> (pid </span><span>==</span><span> 0</span><span>) {</span><span> //</span></span>
<span><span>Child process </span><span>printf</span><span>(</span><span>&#34;Child process </span><span>%d</span><span> with PID </span><span>%d\n</span><span>&#34;</span><span>, i, </span><span>getpid</span><span>()); </span><span>exit</span><span>(</span><span>0</span><span>);</span><span> //</span></span>
<span><span>Exit child process } }</span></span>
<span></span>
<span><span>    // Parent process waits for all child processes to finish</span></span>
<span><span>    for</span><span> (</span><span>int</span><span> i </span><span>=</span><span> 0</span><span>; i </span><span>&lt;</span><span> num_processes; i</span><span>++</span><span>) {</span></span>
<span><span>        wait</span><span>(</span><span>NULL</span><span>);</span></span>
<span><span>    }</span></span>
<span></span>
<span><span>    printf</span><span>(</span><span>&#34;All child processes have finished.</span><span>\n</span><span>&#34;</span><span>);</span></span>
<span><span>    return</span><span> 0</span><span>;</span></span>
<span></span>
<span><span>}</span></span>
<span></span></code></pre><p>Just a little of an aside</p> </div> </details>
<p>But the point is, we now have many server side js processes, each capable of
handling requests concurrently.</p>
<p>Now there‚Äôs a few more details we have to take care of.</p>
<p>First of all, when a request comes in, as we‚Äôve talked about, we need to check
whether there‚Äôs a worker for it. We said that we‚Äôre going to use the file
system, and again, here that means that every running process is just a file in
a folder. If the file exists, that means a worker is running, and that file can
contain information about how to connect to that worker, or even just be the
unix socket file itself.</p>
<p>But also, rather than checking every time we receive a request whether there is
a running worker that is able to facilitate a request for the given hostname,
why not just use file watchers, so we always have a correct idea of what files
exist without having to make syscalls every single time a request comes in?</p>
<p>Pretty awesome!</p>
<p>We can use <a href="https://www.npmjs.com/package/chokidar"><code>chokidar</code></a> to watch a
directory for unix socket files to appear and disappear, and keep an in-memory
map of what files exist. These are our live workers! When a worker dies, it can
literally delete its own file!</p>
<p>We even can pre-connect to workers (like, open up a TCP pool) when we see a new
socket file appear, so that when a request comes in, we can immediately proxy to
it.</p>
<p>We know that if a file appears, that it was because either:</p>
<ol>
<li>We spawned a new worker (we had enough cache information to do so), or</li>
<li>Another process spawned a new worker (just some other worker, we weren‚Äôt the
one that did it)</li>
<li>We asked the primary process to get us cache information so that we could
spawn the worker, and it did so, and then we spawned the worker. Or that this
was the case for some other worker.</li>
</ol>
<p>For the rest of this blog though, we‚Äôll ignore 3., and assume that if a nodejs
process receives a request and there‚Äôs no socket file, it is the one that spawns
it, adds it to its own memory state, and then proxies to it. If another process
spawns a worker, then all other processes will see the socket file appear via
the file watcher, and add it to their own memory state, and preconnect.</p>
<p>This is pretty elegant since we know that if the socket file appears, that since
we‚Äôre round robining, some other worker spawned the worker, and we are likely to
be the next one who‚Äôs going to proxy to it.</p>
<p>Let‚Äôs look at some code!</p>
<pre tabindex="0" data-language="ts"><code><span><span>const</span><span> conns</span><span> =</span><span> new</span><span> Map</span><span>&lt;</span><span>string</span><span>, </span><span>Pool</span><span>&gt;() </span><span>// Map of hashed hostname to undici connection pool</span></span>
<span><span>// If it has a key in the map, then it has a file on disc!</span></span>
<span></span>
<span><span>watcher</span></span>
<span><span>  .</span><span>on</span><span>(</span><span>&#39;add&#39;</span><span>, (</span><span>path</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    // If another worker creates a socket file, we create a new connection ahead of time</span></span>
<span><span>    const</span><span> socketId</span><span> =</span><span> socketPathToId</span><span>(path) </span><span>// We hash the hostname, since it turns out</span></span>
<span><span>    // that the max size for a unix socket path is</span></span>
<span><span>    // limited</span></span>
<span><span>    conns.</span><span>set</span><span>(</span></span>
<span><span>      socketId,</span></span>
<span><span>      new</span><span> Pool</span><span>(</span><span>&#39;http://localhost&#39;</span><span>, {</span></span>
<span><span>        socketPath: path,</span></span>
<span><span>        connections: </span><span>CONNECTIONS_PER_SOCKET</span><span>,</span></span>
<span><span>      }),</span></span>
<span><span>    ) </span><span>// We&#39;re using undici&#39;s connection pool here. It&#39;s just a really nice HTTP client for node!</span></span>
<span><span>    // Much faster, and with a better API than node&#39;s built-in http module</span></span>
<span><span>  })</span></span>
<span><span>  .</span><span>on</span><span>(</span><span>&#39;unlink&#39;</span><span>, (</span><span>path</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    const</span><span> socketId</span><span> =</span><span> socketPathToId</span><span>(path)</span></span>
<span><span>    const</span><span> pool</span><span> =</span><span> conns.</span><span>get</span><span>(socketId)</span></span>
<span><span>    if</span><span> (pool) {</span></span>
<span><span>      pool.</span><span>close</span><span>()</span></span>
<span><span>      conns.</span><span>delete</span><span>(socketId)</span></span>
<span><span>    }</span></span>
<span></span>
<span><span>    // If we spawned the worker, kill it</span></span>
<span><span>    const</span><span> proc</span><span> =</span><span> procs.</span><span>get</span><span>(socketId)</span></span>
<span><span>    if</span><span> (proc) {</span></span>
<span><span>      proc.</span><span>kill</span><span>(</span><span>&#39;SIGTERM&#39;</span><span>)</span></span>
<span><span>      proc.</span><span>once</span><span>(</span><span>&#39;exit&#39;</span><span>, () </span><span>=&gt;</span><span> {</span></span>
<span><span>        clearTimeout</span><span>(timeout)</span></span>
<span><span>        console.</span><span>log</span><span>(</span><span>`Worker for ${</span><span>path</span><span>} exited`</span><span>)</span></span>
<span><span>      })</span></span>
<span><span>      procs.</span><span>delete</span><span>(socketId)</span></span>
<span><span>    }</span></span>
<span><span>  })</span></span></code></pre>
<p>And the actual worker server (the processes we‚Äôre spawning, which happen to also
be javascript (Deno)) looks like this,</p>
<pre tabindex="0" data-language="ts"><code><span><span>if</span><span> (</span><span>import</span><span>.</span><span>meta</span><span>.url </span><span>===</span><span> Deno.mainModule) {</span></span>
<span><span>  const</span><span> pendingReqs</span><span> =</span><span> new</span><span> pQueue</span><span>()</span></span>
<span></span>
<span><span>  Deno.</span><span>serve</span><span>(</span></span>
<span><span>    {</span></span>
<span><span>      path: Deno.args[</span><span>0</span><span>],</span></span>
<span><span>      transport: </span><span>&#39;unix&#39;</span><span>,</span></span>
<span><span>    },</span></span>
<span><span>    async</span><span> (</span><span>request</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>      const</span><span> resp</span><span> =</span><span> await</span><span> pendingReqs.</span><span>add</span><span>(</span><span>async</span><span> () </span><span>=&gt;</span><span> await</span><span> handler</span><span>(request))</span></span>
<span><span>      if</span><span> (resp) {</span></span>
<span><span>        return</span><span> resp</span></span>
<span><span>      } </span><span>else</span><span> {</span></span>
<span><span>        return</span><span> new</span><span> Response</span><span>(</span><span>&#39;Internal Server Error&#39;</span><span>, { status: </span><span>500</span><span> })</span></span>
<span><span>      }</span></span>
<span><span>    },</span></span>
<span><span>  )</span></span>
<span></span>
<span><span>  Deno.</span><span>addSignalListener</span><span>(</span><span>&#39;SIGTERM&#39;</span><span>, </span><span>async</span><span> () </span><span>=&gt;</span><span> {</span></span>
<span><span>    await</span><span> Deno.</span><span>remove</span><span>(Deno.args[</span><span>0</span><span>]) </span><span>// Clean up the unix socket file</span></span>
<span><span>    await</span><span> pendingReqs.</span><span>onIdle</span><span>() </span><span>// Wait for all pending requests to finish</span></span>
<span><span>    Deno.</span><span>exit</span><span>(</span><span>0</span><span>)</span></span>
<span><span>  })</span></span>
<span><span>}</span></span></code></pre>
<p>Noting that</p>
<ul>
<li>We want to keep track of all requests we‚Äôve received, so that when we are
SIGTERM‚Äôd we can wait for them to finish (we just use a simple promise queue
to make it easy)</li>
<li>We also want to clean up the unix socket file when we exit, so the processes
observe that we are no longer reachable and stop proxying to us.</li>
</ul>
<p>If a deno process dies, then all the nodejs processes will see the socket file
go away and clean up their own memory state.</p>
<h2 id="ironing-it-out">Ironing it Out</h2>
<p>We‚Äôre not quite done yet though! There‚Äôs a few more details to iron out.</p>
<p>Now that we‚Äôre running concurrent nodejs processes, it is totally possible for
multiple processes to try and access the same resources at the same time. This
can lead to all sorts of no-fun issues, like two workers being spawned at the
same time, which wastes resources and slows us down. This is the case when two
network requests come in on the same tick. That wouldn‚Äôt normally be an issue in
a single-threaded server, since requests are handled one at a time, but now that
we have multiple processes, it is totally possible.</p>
<p>Okay, so back to my linux brain ‚Äújust use the file system‚Äù mindset.</p>
<p>Yes, we could use
<a href="https://redis.io/docs/latest/develop/clients/patterns/distributed-locks/">Redis locks</a>.</p>
<details> <summary> Let&#39;s just use the file system... for locks! </summary> <div> <pre tabindex="0" data-language="ts"><code><span><span>/**</span></span>
<span><span> * Try to acquire a lock for a path, running the appropriate callback based on</span></span>
<span><span> * whether the lock was acquired or already held.</span></span>
<span><span> *</span></span>
<span><span> * </span><span>@param</span><span> args.path</span><span> The path to the socket file.</span></span>
<span><span> * </span><span>@param</span><span> args.onAlreadyExists</span><span> Callback to run if the target already exists.</span></span>
<span><span> * </span><span>@param</span><span> args.onAcquired</span><span> Callback to run if the lock is acquired.</span></span>
<span><span> * </span><span>@param</span><span> args.onAlreadyHeld</span><span> Callback to run if the lock is already held.</span></span>
<span><span> */</span></span>
<span><span>async</span><span> function</span><span> tryLockFile</span><span>&lt;</span><span>T</span><span>&gt;({</span></span>
<span><span>  target</span><span>,</span></span>
<span><span>  onAlreadyExists</span><span>,</span></span>
<span><span>  onAcquired</span><span>,</span></span>
<span><span>  onAlreadyHeld</span><span>,</span></span>
<span><span>}</span><span>:</span><span> {</span></span>
<span><span>  target</span><span>:</span><span> string</span><span>;</span></span>
<span><span>  onAlreadyExists</span><span>:</span><span> () </span><span>=&gt;</span><span> Promise</span><span>&lt;</span><span>T</span><span>&gt;;</span></span>
<span><span>  onAcquired</span><span>:</span><span> () </span><span>=&gt;</span><span> Promise</span><span>&lt;</span><span>T</span><span>&gt;;</span></span>
<span><span>  onAlreadyHeld</span><span>:</span><span> () </span><span>=&gt;</span><span> Promise</span><span>&lt;</span><span>T</span><span>&gt;;</span></span>
<span><span>})</span><span>:</span><span> Promise</span><span>&lt;</span><span>T</span><span>&gt; {</span></span>
<span><span>  let</span><span> acquiredLock </span><span>=</span><span> false</span><span>;</span></span>
<span><span>  try</span><span> {</span></span>
<span><span>    await</span><span> fs.</span><span>access</span><span>(target);</span></span>
<span><span>    return</span><span> await</span><span> onAlreadyExists</span><span>();</span></span>
<span><span>  } </span><span>catch</span><span> {</span></span>
<span><span>    console.</span><span>log</span><span>(</span><span>`Socket file ${</span><span>target</span><span>} does not exist, spawning worker...`</span><span>);</span></span>
<span></span>
<span><span>    try</span><span> {</span></span>
<span><span>      await</span><span> fs.</span><span>mkdir</span><span>(</span><span>`${</span><span>target</span><span>}.lock`</span><span>);</span></span>
<span><span>      acquiredLock </span><span>=</span><span> true</span><span>;</span></span>
<span></span>
<span><span>      return</span><span> await</span><span> onAcquired</span><span>();</span></span>
<span><span>    } </span><span>catch</span><span> (e) {</span></span>
<span><span>      if</span><span> (</span><span>!</span><span>(e </span><span>instanceof</span><span> Error</span><span> &amp;&amp;</span><span> e.message.</span><span>includes</span><span>(</span><span>&#34;EEXIST&#34;</span><span>))) </span><span>throw</span><span> e;</span></span>
<span><span>      console.</span><span>log</span><span>(</span><span>`Socket file ${</span><span>target</span><span>} is being created`</span><span>);</span></span>
<span><span>      // Already held</span></span>
<span><span>    }</span></span>
<span></span>
<span><span>    console.</span><span>log</span><span>(</span><span>`Socket file ${</span><span>target</span><span>} is being created by another worker...`</span><span>);</span></span>
<span><span>    return</span><span> await</span><span> onAlreadyHeld</span><span>();</span></span>
<span></span>
<span><span>} </span><span>finally</span><span> { </span><span>if</span><span> (acquiredLock) { </span><span>// Remove the lock directory await</span></span>
<span><span>fs.</span><span>rmdir</span><span>(</span><span>`${</span><span>target</span><span>}.lock`</span><span>); } } }</span></span>
<span></span></code></pre> </div> </details>
<p>We can literally just create a folder right before we spawn a new worker, and delete it
right after. If another process tries to create the same folder at the same time, it
will fail, and we can just wait for the socket file to appear instead.</p>
<p>So finally, putting the pieces together, when a request comes in, we do this:</p>
<pre tabindex="0" data-language="ts"><code><span><span>async</span><span> function</span><span> getConnPool</span><span>(</span><span>socketPath</span><span>:</span><span> string</span><span>) {</span></span>
<span><span>  const</span><span> socketId</span><span> =</span><span> socketPathToId</span><span>(socketPath);</span></span>
<span></span>
<span><span>  const</span><span> existingConn</span><span> =</span><span> conns.</span><span>get</span><span>(socketId);</span></span>
<span><span>  if</span><span> (existingConn) {</span></span>
<span><span>    console.</span><span>log</span><span>(</span><span>`Reusing existing connection for ${</span><span>socketPath</span><span>}`</span><span>);</span></span>
<span><span>    return</span><span> existingConn;</span></span>
<span><span>  }</span></span>
<span></span>
<span><span>  await</span><span> tryLockFile</span><span>({</span></span>
<span><span>    target: socketPath,</span></span>
<span><span>    onAlreadyExists</span><span>: </span><span>async</span><span> () </span><span>=&gt;</span><span> {</span></span>
<span><span>      conns.</span><span>set</span><span>(</span></span>
<span><span>        socketId,</span></span>
<span><span>        new</span><span> Pool</span><span>(</span><span>&#34;http://localhost&#34;</span><span>, {</span></span>
<span><span>          socketPath: socketPath,</span></span>
<span><span>          connections: </span><span>CONNECTIONS_PER_SOCKET</span><span>,</span></span>
<span><span>        }),</span></span>
<span><span>      );</span></span>
<span><span>    },</span></span>
<span><span>    onAcquired</span><span>: </span><span>async</span><span> () </span><span>=&gt;</span><span> {</span></span>
<span><span>      // File doesn&#39;t exist, spawn the worker</span></span>
<span><span>      const</span><span> proc</span><span> =</span><span> spawn</span><span>(</span></span>
<span><span>        &#34;deno&#34;</span><span>,</span></span>
<span><span>        [</span></span>
<span><span>          &#34;run&#34;</span><span>,</span></span>
<span><span>          &#34;-A&#34;</span><span>,</span></span>
<span><span>          &#34;--node-modules-dir=false&#34;</span><span>,</span></span>
<span><span>          join</span><span>(</span><span>WORKERS_DIR</span><span>, </span><span>&#34;worker.ts&#34;</span><span>),</span></span>
<span><span>          socketPath,</span></span>
<span><span>        ],</span></span>
<span><span>        { stdio: </span><span>&#34;pipe&#34;</span><span> },</span></span>
<span><span>      );</span></span>
<span></span>
<span><span>      await</span><span> waitForWatcherEvent</span><span>(</span><span>&#34;add&#34;</span><span>, socketPath);</span></span>
<span></span>
<span><span>      proc.</span><span>once</span><span>(</span><span>&#34;exit&#34;</span><span>, </span><span>async</span><span> (</span><span>code</span><span>, </span><span>signal</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>        console.</span><span>log</span><span>(</span></span>
<span><span>          `${</span><span>socketPath</span><span>} exited with code ${</span><span>code</span><span>}, signal ${</span><span>signal</span><span>}`</span><span>,</span></span>
<span><span>        );</span></span>
<span><span>        procs.</span><span>delete</span><span>(socketId);</span></span>
<span><span>        conns.</span><span>delete</span><span>(socketId);</span></span>
<span><span>        await</span><span> fs.</span><span>rm</span><span>(socketPath, { force: </span><span>true</span><span> });</span></span>
<span><span>      });</span></span>
<span></span>
<span><span>      proc.stdout.</span><span>on</span><span>(</span><span>&#34;data&#34;</span><span>, (</span><span>data</span><span>) </span><span>=&gt;</span><span> injesterTcp.</span><span>write</span><span>(data));</span></span>
<span><span>      proc.stderr.</span><span>on</span><span>(</span><span>&#34;data&#34;</span><span>, (</span><span>data</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>        const</span><span> text</span><span> =</span><span> new</span><span> TextDecoder</span><span>(</span><span>&#34;utf-8&#34;</span><span>);</span></span>
<span><span>        console.</span><span>error</span><span>(text.</span><span>decode</span><span>(data));</span></span>
<span><span>      });</span></span>
<span></span>
<span><span>      procs.</span><span>set</span><span>(socketId, proc);</span></span>
<span></span>
<span><span>      conns.</span><span>set</span><span>(</span></span>
<span><span>        socketId,</span></span>
<span><span>        new</span><span> Pool</span><span>(</span><span>&#34;http://localhost&#34;</span><span>, {</span></span>
<span><span>          socketPath: socketPath,</span></span>
<span><span>          connections: </span><span>CONNECTIONS_PER_SOCKET</span><span>,</span></span>
<span><span>        }),</span></span>
<span><span>      );</span></span>
<span><span>    },</span></span>
<span><span>    onAlreadyHeld</span><span>: </span><span>async</span><span> () </span><span>=&gt;</span><span> {</span></span>
<span><span>      await</span><span> waitForWatcherEvent</span><span>(</span><span>&#34;add&#34;</span><span>, socketPath);</span></span>
<span></span>
<span><span>      conns.</span><span>set</span><span>(</span></span>
<span><span>        socketId,</span></span>
<span><span>        new</span><span> Pool</span><span>(</span><span>&#34;http://localhost&#34;</span><span>, {</span></span>
<span><span>          socketPath: socketPath,</span></span>
<span><span>          connections: </span><span>CONNECTIONS_PER_SOCKET</span><span>,</span></span>
<span><span>        }),</span></span>
<span><span>      );</span></span>
<span><span>    },</span></span>
<span><span>  });</span></span>
<span></span>
<span><span>  const</span><span> conn</span><span> =</span><span> conns.</span><span>get</span><span>(socketId);</span></span>
<span><span>  if</span><span> (</span><span>!</span><span>conn) {</span></span>
<span><span>    throw</span><span> new</span><span> Error</span><span>(</span><span>`Failed to get connection pool for ${</span><span>socketPath</span><span>}`</span><span>);</span></span>
<span><span>  }</span></span>
<span><span>  return</span><span> conn;</span></span>
<span><span>}</span></span></code></pre>
<details> <summary> waitForWatcherEvent is just like it sounds </summary> <div> <pre tabindex="0" data-language="ts"><code><span><span>/**</span></span>
<span><span> * Wait for a file system watcher event.</span></span>
<span><span> *</span></span>
<span><span> * </span><span>@param</span><span> event</span><span> The event to wait for.</span></span>
<span><span> * </span><span>@param</span><span> path</span><span> The path to watch.</span></span>
<span><span> * </span><span>@returns</span><span> A promise that resolves when the event occurs.</span></span>
<span><span> */</span></span>
<span><span>function</span><span> waitForWatcherEvent</span><span>(</span></span>
<span><span>  event</span><span>:</span><span> keyof</span><span> FSWatcherEventMap</span><span>,</span></span>
<span><span>  path</span><span>:</span><span> string</span><span>,</span></span>
<span><span>)</span><span>:</span><span> Promise</span><span>&lt;</span><span>void</span><span>&gt; {</span></span>
<span><span>  return</span><span> new</span><span> Promise</span><span>&lt;</span><span>void</span><span>&gt;((</span><span>res</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    const</span><span> handler</span><span> =</span><span> (</span><span>eventPath</span><span>:</span><span> string</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>      if</span><span> (</span><span>resolve</span><span>(eventPath) </span><span>===</span><span> resolve</span><span>(path)) {</span></span>
<span><span>        watcher.</span><span>off</span><span>(event, handler)</span></span>
<span><span>        res</span><span>()</span></span>
<span><span>      }</span></span>
<span><span>    }</span></span>
<span></span>
<span><span>    watcher.</span><span>on</span><span>(event, handler)</span></span>
<span><span>  })</span></span>
<span><span>}</span></span></code></pre><p>Note that <code>chokidar</code> will batch events together and uses real <code>inotify</code>, so this
is actually quite efficient.</p> </div> </details>
<p>Okay, so now we have a concurrent nodejs server that can handle many requests at
once, and spawn deno workers as needed.</p>
<p>When we get a flood of requests, we can now handle them all concurrently, and
should have an open TCP connection ahead of time so we can snappily proxy.</p>
<h2 id="numbers">Numbers!</h2>
<p>Here‚Äôs some metrics from testing with my favorite network stress tester
(<a href="https://github.com/hatoo/oha">oha</a>).</p>
<p>We tested with and without keepalive (from the client), since in we‚Äôre worried
about the case where many clients are connecting to the same Val (worker) at
once, and thus are not keeping connections alive.</p>
<p>I also tested with different %s of requests being unique hostnames (i.e. 10%
being unique hostnames), where the rest are hitting warm workers, and the actual
spawning was uniformly distributed. The idea is that with less unique hostnames,
most requests are going to warm workers, so we should see the biggest benefits
from multiprocessing. Likewise, with more unique hostnames, more requests
require spawning, which is probably even slower now that we have lock
contention.</p>
<p>All the table entries are in requests per second.</p>
<h3 id="300-concurrent-connections-wo-keepalive">300 Concurrent Connections w/o Keepalive</h3>









































<table><thead><tr><th>% New Workers</th><th>10 Workers</th><th>8 Workers</th><th>1 Worker</th></tr></thead><tbody><tr><td>2.00</td><td>2631</td><td>1848</td><td>1439</td></tr><tr><td>7.00</td><td>1025</td><td>1096</td><td>704</td></tr><tr><td>10.00</td><td>823</td><td>808</td><td>547</td></tr><tr><td>15.00</td><td>453</td><td>502</td><td>372</td></tr><tr><td>20.00</td><td>641</td><td>362</td><td>295</td></tr></tbody></table>
<hr/>
<h3 id="100-concurrent-connections-w-keepalive">100 Concurrent Connections w/ Keepalive</h3>









































<table><thead><tr><th>% New Workers</th><th>10 Workers</th><th>8 Workers</th><th>1 Worker</th></tr></thead><tbody><tr><td>2.00</td><td>3296</td><td>3555</td><td>1960</td></tr><tr><td>7.00</td><td>2351</td><td>2473</td><td>2273</td></tr><tr><td>10.00</td><td>840</td><td>404</td><td>976</td></tr><tr><td>15.00</td><td>412</td><td>310</td><td>520</td></tr><tr><td>20.00</td><td>311</td><td>203</td><td>329</td></tr></tbody></table>
<p>In general, things look great! When we test at high concurrency with high new
worker spawn rate, for all keepalive connections we see that the process
spawning is actually pretty detrimental, but we‚Äôre still competitive. In other
cases, the benefits are super clear cut!</p>
<p>One final note about these numbers ‚Äî for actually simulating load (since, for
example, a simple hello world http server is not particularly realistic), we set
up a simple raw TCP server that we, on each request, would send a bunch of bytes
into, to do some blocking IO. This is somewhat realistic, since Vals, as they
run, are sending along data to ClickHouse in production.</p>

<p>Now here‚Äôs my dump of some fun additional things that came out of the research</p>
<h2 id="websockets">WebSockets!</h2>
<p>First off all, now that the parent process is not the one managing all
connections, we‚Äôre much more primed to start handling WebSocket connections!</p>
<p>Where previous the parent would need to be responsible for maintaining all the
TCP connections to Deno workers, now that each worker process is managing its
own connections, we can distribute it.</p>
<p>It‚Äôs a bit weird to actually do with fastify. That‚Äôs because node‚Äôs built-in
HTTP server does not natively support WebSockets, but it gives you the ability
to respond to <code>upgrade</code> requests, (which makes sense, since this is just part of
the HTTP spec).</p>
<p>That ‚Äúresponding to upgrade requests‚Äù part is a bit tricky because it requires a
WebSocket handshake, but thankfully there‚Äôs a library that handles the framing
and handshake for you, <a href="https://www.npmjs.com/package/ws"><code>ws</code></a>.</p>
<p>When doing it manually with the <code>upgrade</code> callback and nodejs http, it looks
like this:</p>
<pre tabindex="0" data-language="ts"><code><span><span>import</span><span> http </span><span>from</span><span> &#39;http&#39;</span></span>
<span><span>import</span><span> WebSocket, { WebSocketServer } </span><span>from</span><span> &#39;ws&#39;</span></span>
<span></span>
<span><span>const</span><span> server</span><span> =</span><span> http.</span><span>createServer</span><span>()</span></span>
<span><span>const</span><span> wss</span><span> =</span><span> new</span><span> WebSocketServer</span><span>({ noServer: </span><span>true</span><span> })</span></span>
<span></span>
<span><span>server.</span><span>on</span><span>(</span><span>&#39;upgrade&#39;</span><span>, (</span><span>request</span><span>, </span><span>socket</span><span>, </span><span>head</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  // the magic function!</span></span>
<span><span>  //  |            |</span></span>
<span><span>  wss.</span><span>handleUpgrade</span><span>(request, socket, head, (</span><span>ws</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>    ws.</span><span>send</span><span>(</span><span>&#39;Hello World!&#39;</span><span>)</span></span>
<span></span>
<span><span>    ws.</span><span>on</span><span>(</span><span>&#39;message&#39;</span><span>, (</span><span>data</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>      console.</span><span>log</span><span>(</span><span>&#39;Received:&#39;</span><span>, data.</span><span>toString</span><span>())</span></span>
<span><span>      ws.</span><span>send</span><span>(</span><span>`Echo: ${</span><span>data</span><span>}`</span><span>)</span></span>
<span><span>    })</span></span>
<span><span>  })</span></span>
<span><span>})</span></span>
<span></span>
<span><span>server.</span><span>listen</span><span>(</span><span>8080</span><span>, () </span><span>=&gt;</span><span> {</span></span>
<span><span>  console.</span><span>log</span><span>(</span><span>&#39;Server listening on port 8080&#39;</span><span>)</span></span>
<span><span>})</span></span></code></pre>
<p>Under the hood, fastify uses node http too. There‚Äôs a plugin that handles this
for us, which is
<a href="https://github.com/fastify/fastify-websocket"><code>fastify-websocket</code></a>.</p>
<p>There‚Äôs one issue though. According to their GitHub, using it looks like this:</p>
<pre tabindex="0" data-language="ts"><code><span><span>fastify.</span><span>register</span><span>(</span><span>async</span><span> function</span><span> () {</span></span>
<span><span>  fastify.</span><span>route</span><span>({</span></span>
<span><span>    method: </span><span>&#39;GET&#39;</span><span>,</span></span>
<span><span>    url: </span><span>&#39;/hello&#39;</span><span>,</span></span>
<span><span>    handler</span><span>: (</span><span>req</span><span>, </span><span>reply</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>      // this will handle http requests</span></span>
<span><span>      reply.</span><span>send</span><span>({ hello: </span><span>&#39;world&#39;</span><span> })</span></span>
<span><span>    },</span></span>
<span><span>    wsHandler</span><span>: (</span><span>socket</span><span>, </span><span>req</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>      // this will handle websockets connections</span></span>
<span><span>      socket.</span><span>send</span><span>(</span><span>&#39;hello client&#39;</span><span>)</span></span>
<span></span>
<span><span>      socket.</span><span>once</span><span>(</span><span>&#39;message&#39;</span><span>, (</span><span>chunk</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>        socket.</span><span>close</span><span>()</span></span>
<span><span>      })</span></span>
<span><span>    },</span></span>
<span><span>  })</span></span>
<span><span>})</span></span></code></pre>
<p>But we‚Äôre just a proxy! We want to forward all requests, whether HTTP or
WebSocket, to the Deno worker, and irrespective of the path. Having to register
for a path is a big no-no. If we just register the WebSocket server on <code>*</code>, then
fastify will not know how to handle normal HTTP requests.</p>
<p>So what‚Äôs the solution? Just use a
<a href="https://fastify.dev/docs/latest/Reference/Hooks/">hook</a> to intercept requests
before they hit the handler, so by the time we‚Äôre using the WebSocket handler we
know all requests must be real WebSocket requests. It‚Äôs a bit jank, but it does
work.</p>
<details> <summary> 
To actual do the upgrade, we just wire our callbacks to our pool&#39;s, so that when
we receive a message via our WebSocket it just directly pumps to the Deno
worker&#39;s WebSocket, and vice versa.
 </summary> <div> <pre tabindex="0" data-language="ts"><code><span><span>// pool is some undici Pool connected to the Deno worker</span></span>
<span><span>const</span><span> webSocketToUpstream</span><span> =</span><span> new</span><span> WebSocket</span><span>(</span><span>`ws:${</span><span>socketPath</span><span>}:${</span><span>req</span><span>.</span><span>url</span><span>}`</span><span>, {</span></span>
<span><span>  dispatcher: pool,</span></span>
<span><span>  headers: Object.</span><span>fromEntries</span><span>(</span></span>
<span><span>    // filter out websocket-specific headers, since ws library adds them automatically</span></span>
<span><span>    Object.</span><span>entries</span><span>(req.headers)</span></span>
<span><span>      .</span><span>filter</span><span>(</span></span>
<span><span>        ([</span><span>key</span><span>]) </span><span>=&gt;</span></span>
<span><span>          !</span><span>[</span></span>
<span><span>            // don&#39;t include websocket-specific headers</span></span>
<span><span>            &#39;connection&#39;</span><span>,</span></span>
<span><span>            &#39;upgrade&#39;</span><span>,</span></span>
<span><span>            &#39;sec-websocket-version&#39;</span><span>,</span></span>
<span><span>            &#39;sec-websocket-key&#39;</span><span>,</span></span>
<span><span>          ].</span><span>includes</span><span>(key.</span><span>toLowerCase</span><span>()),</span></span>
<span><span>      )</span></span>
<span><span>      .</span><span>map</span><span>(([</span><span>key</span><span>, </span><span>value</span><span>]) </span><span>=&gt;</span><span> [</span></span>
<span><span>        key,</span></span>
<span><span>        Array.</span><span>isArray</span><span>(value) </span><span>?</span><span> value.</span><span>join</span><span>(</span><span>&#39;, &#39;</span><span>) </span><span>:</span><span> value </span><span>||</span><span> &#39;&#39;</span><span>,</span></span>
<span><span>      ]),</span></span>
<span><span>  ),</span></span>
<span><span>})</span></span>
<span></span>
<span><span>const</span><span> websocketToUs</span><span> =</span><span> socket </span><span>// this is given to us in our WebSocket handler</span></span>
<span></span>
<span><span>// Really, it&#39;s pretty stupid simple -- just pipe messages back and forth</span></span>
<span></span>
<span><span>webSocketToUpstream.</span><span>addEventListener</span><span>(</span><span>&#39;message&#39;</span><span>, (</span><span>event</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>websocketToUs.</span><span>send</span><span>(event.data) }) websocketToUs.</span><span>addEventListener</span><span>(</span><span>&#39;message&#39;</span><span>,</span></span>
<span><span>(</span><span>event</span><span>) </span><span>=&gt;</span><span> { webSocketToUpstream.</span><span>send</span><span>(event.data </span><span>as</span><span> any</span><span>) })</span></span>
<span><span>websocketToUs.</span><span>addEventListener</span><span>(</span><span>&#39;close&#39;</span><span>, () </span><span>=&gt;</span><span> { webSocketToUpstream.</span><span>close</span><span>() })</span></span>
<span></span></code></pre> </div> </details>
<p>And, all put together, WebSocket support looks like this:</p>
<pre tabindex="0" data-language="ts"><code><span><span>const</span><span> fastify</span><span> =</span><span> Fastify</span><span>()</span></span>
<span></span>
<span><span>fastify.</span><span>register</span><span>(fastifyWebsocket)</span></span>
<span></span>
<span><span>fastify.</span><span>decorateRequest</span><span>(</span><span>&#39;socketPath&#39;</span><span>, </span><span>&#39;&#39;</span><span>)</span></span>
<span></span>
<span><span>fastify.</span><span>addHook</span><span>(</span><span>&#39;preHandler&#39;</span><span>, </span><span>async</span><span> (</span><span>req</span><span>, </span><span>resp</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  // Skip websocket requests</span></span>
<span><span>  if</span><span> (req.headers.upgrade </span><span>===</span><span> &#39;websocket&#39;</span><span>) {</span></span>
<span><span>    return</span><span> // fall through to websocket handler</span></span>
<span><span>  } </span><span>else</span><span> {</span></span>
<span><span>    // ...</span></span>
<span><span>    // Proxy normal HTTP requests by grabbing the pool and forwarding</span></span>
<span><span>    // ...</span></span>
<span><span>  }</span></span>
<span><span>})</span></span>
<span></span>
<span><span>await</span><span> fastify.</span><span>register</span><span>(</span><span>async</span><span> () </span><span>=&gt;</span><span> {</span></span>
<span><span>  fastify.</span><span>get</span><span>(</span></span>
<span><span>    &#39;*&#39;</span><span>,</span></span>
<span><span>    {</span></span>
<span><span>      websocket: </span><span>true</span><span>,</span></span>
<span><span>    },</span></span>
<span><span>    async</span><span> (</span><span>socket</span><span>, </span><span>req</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>      const</span><span> pool</span><span> =</span><span> await</span><span> getConnPool</span><span>(req.socketPath) </span><span>// warm the worker</span></span>
<span></span>
<span><span>      const</span><span> denoSocket</span><span> =</span><span> new</span><span> WebSocket</span><span>(</span><span>`ws:${</span><span>req</span><span>.</span><span>socketPath</span><span>}:${</span><span>req</span><span>.</span><span>url</span><span>}`</span><span>, {</span></span>
<span><span>        dispatcher: pool,</span></span>
<span><span>        headers: Object.</span><span>fromEntries</span><span>(</span></span>
<span><span>          Object.</span><span>entries</span><span>(req.headers)</span></span>
<span><span>            .</span><span>filter</span><span>(</span></span>
<span><span>              ([</span><span>key</span><span>]) </span><span>=&gt;</span></span>
<span><span>                !</span><span>[</span></span>
<span><span>                  // don&#39;t include websocket-specific headers</span></span>
<span><span>                  &#39;connection&#39;</span><span>,</span></span>
<span><span>                  &#39;upgrade&#39;</span><span>,</span></span>
<span><span>                  &#39;sec-websocket-version&#39;</span><span>,</span></span>
<span><span>                  &#39;sec-websocket-key&#39;</span><span>,</span></span>
<span><span>                ].</span><span>includes</span><span>(key.</span><span>toLowerCase</span><span>()),</span></span>
<span><span>            )</span></span>
<span><span>            .</span><span>map</span><span>(([</span><span>key</span><span>, </span><span>value</span><span>]) </span><span>=&gt;</span><span> [</span></span>
<span><span>              key,</span></span>
<span><span>              Array.</span><span>isArray</span><span>(value) </span><span>?</span><span> value.</span><span>join</span><span>(</span><span>&#39;, &#39;</span><span>) </span><span>:</span><span> value </span><span>||</span><span> &#39;&#39;</span><span>,</span></span>
<span><span>            ]),</span></span>
<span><span>        ),</span></span>
<span><span>      })</span></span>
<span></span>
<span><span>      denoSocket.</span><span>addEventListener</span><span>(</span><span>&#39;message&#39;</span><span>, (</span><span>event</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>        socket.</span><span>send</span><span>(event.data)</span></span>
<span><span>      })</span></span>
<span></span>
<span><span>      socket.</span><span>addEventListener</span><span>(</span><span>&#39;message&#39;</span><span>, (</span><span>event</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>        denoSocket.</span><span>send</span><span>(event.data </span><span>as</span><span> any</span><span>)</span></span>
<span><span>      })</span></span>
<span></span>
<span><span>      socket.</span><span>addEventListener</span><span>(</span><span>&#39;close&#39;</span><span>, () </span><span>=&gt;</span><span> {</span></span>
<span><span>        console.</span><span>log</span><span>(</span><span>&#39;WebSocket closed, closing Deno socket&#39;</span><span>)</span></span>
<span><span>        denoSocket.</span><span>close</span><span>()</span></span>
<span><span>      })</span></span>
<span><span>    },</span></span>
<span><span>  )</span></span>
<span><span>})</span></span>
<span></span>
<span><span>fastify.</span><span>listen</span><span>({ port: </span><span>8000</span><span> }, () </span><span>=&gt;</span><span> {</span></span>
<span><span>  console.</span><span>log</span><span>(</span><span>`Worker listening on port 8000, PID: ${</span><span>process</span><span>.</span><span>pid</span><span>}`</span><span>)</span></span>
<span><span>})</span></span></code></pre>
<h2 id="docker">Docker</h2>
<p>Just for fun, we also tried running our Workers in their own Docker containers.
This really just was using the <code>docker -a=STDIN -a=STDOUT -a=STDERR -i</code> flags to
keep stdin open and attach to the appropriate streams. Then we could just spawn
the container, and pipe commands to its stdin to have it spawn Deno processes
inside the container.</p>
<p>I was a little fancy, and also set up pooling so that we could always have warm
deno processes ready!</p>
<details> <summary> I packaged this into a nice class that could maintain the pools, so that the final implementation just looked like (below): </summary> <div> <pre tabindex="0" data-language="ts"><code><span><span>import</span><span> { spawn } </span><span>from</span><span> &#34;node:child_process&#34;</span><span>;</span></span>
<span><span>import</span><span> { createInterface } </span><span>from</span><span> &#34;node:readline&#34;</span><span>;</span></span>
<span><span>import</span><span> { basename, join, resolve } </span><span>from</span><span> &#34;node:path&#34;</span><span>;</span></span>
<span><span>import</span><span> { Readable } </span><span>from</span><span> &#34;node:stream&#34;</span><span>;</span></span>
<span><span>import</span><span> { EventEmitter } </span><span>from</span><span> &#34;node:events&#34;</span><span>;</span></span>
<span><span>import</span><span> { rm } </span><span>from</span><span> &#34;node:fs/promises&#34;</span><span>;</span></span>
<span><span>import</span><span> { createHash } </span><span>from</span><span> &#34;node:crypto&#34;</span><span>;</span></span>
<span></span>
<span><span>const</span><span> CONTAINER_SOCKETS_DIR</span><span> =</span><span> &#34;/var/run/sockets&#34;</span><span>;</span></span>
<span></span>
<span><span>interface</span><span> LogMessage</span><span> {</span></span>
<span><span>  src</span><span>:</span><span> string</span><span>;</span></span>
<span><span>  msg</span><span>:</span><span> string</span><span>;</span></span>
<span><span>}</span></span>
<span></span>
<span><span>interface</span><span> DenoContainerArgs</span><span> {</span></span>
<span><span>  containerTag</span><span>:</span><span> string</span><span>;</span></span>
<span><span>  socketsDir</span><span>:</span><span> string</span><span>;</span></span>
<span><span>}</span></span>
<span></span>
<span><span>interface</span><span> ContainerEvents</span><span> {</span></span>
<span><span>  /** Exit code and module URL */</span></span>
<span><span>  exit</span><span>:</span><span> [</span><span>number</span><span> |</span><span> null</span><span>, </span><span>string</span><span>?</span><span>];</span></span>
<span><span>  log</span><span>:</span><span> [</span><span>LogMessage</span><span>];</span></span>
<span><span>}</span></span>
<span></span>
<span><span>/**</span></span>
<span><span> * A DenoContainer manages a single Docker container running a Deno supervisor process.</span></span>
<span><span> *</span></span>
<span><span> * The supervisor process listens for JSON payloads on stdin to spawn Deno processes</span></span>
<span><span> * that run user-provided modules.</span></span>
<span><span> *</span></span>
<span><span> * .spawn() - starts the Docker container and supervisor process</span></span>
<span><span> * .stop() - stops the current running module (if any) but keeps the container alive</span></span>
<span><span> * .run() - sends a JSON payload to the supervisor to run a specific module with env</span></span>
<span><span> */</span></span>
<span><span>export</span><span> class</span><span> DenoContainer</span><span> extends</span><span> EventEmitter</span><span>&lt;</span><span>ContainerEvents</span><span>&gt; {</span></span>
<span><span>  public</span><span> id</span><span>:</span><span> string</span><span> |</span><span> null</span><span> =</span><span> null</span><span>;</span></span>
<span></span>
<span><span>  #proc</span><span>!:</span><span> ReturnType</span><span>&lt;</span><span>typeof</span><span> spawn&gt;;</span></span>
<span><span>  #currentModuleUrl</span><span>:</span><span> string</span><span> |</span><span> null</span><span> =</span><span> null</span><span>;</span></span>
<span></span>
<span><span>  #containerTag</span><span>:</span><span> string</span><span>;</span></span>
<span><span>  #socketsDir</span><span>:</span><span> string</span><span>;</span></span>
<span><span>  #stdout</span><span>:</span><span> Readable</span><span>;</span></span>
<span><span>  #stderr</span><span>:</span><span> Readable</span><span>;</span></span>
<span></span>
<span><span>  constructor</span><span>({ </span><span>containerTag</span><span>, </span><span>socketsDir</span><span> }</span><span>:</span><span> DenoContainerArgs</span><span>) {</span></span>
<span><span>    super</span><span>();</span></span>
<span><span>    this</span><span>.#containerTag </span><span>=</span><span> containerTag;</span></span>
<span><span>    this</span><span>.#socketsDir </span><span>=</span><span> resolve</span><span>(socketsDir);</span></span>
<span></span>
<span><span>    this</span><span>.#stdout </span><span>=</span><span> new</span><span> Readable</span><span>({</span></span>
<span><span>      read</span><span>() {}, </span><span>// No-op, data is pushed via events</span></span>
<span><span>    });</span></span>
<span></span>
<span><span>    this</span><span>.#stderr </span><span>=</span><span> new</span><span> Readable</span><span>({</span></span>
<span><span>      read</span><span>() {}, </span><span>// No-op, data is pushed via events</span></span>
<span><span>    });</span></span>
<span><span>  }</span></span>
<span></span>
<span><span>  /**</span></span>
<span><span>   * Readable stream of the container&#39;s running modules&#39; stdout (from the supervisor process).</span></span>
<span><span>   */</span></span>
<span><span>  public</span><span> get</span><span> stdout</span><span>()</span><span>:</span><span> Readable</span><span> {</span></span>
<span><span>    return</span><span> this</span><span>.#stdout;</span></span>
<span><span>  }</span></span>
<span></span>
<span><span>  /**</span></span>
<span><span>   * Readable stream of the container&#39;s running modules&#39; stderr (from the supervisor process).</span></span>
<span><span>   */</span></span>
<span><span>  public</span><span> get</span><span> stderr</span><span>()</span><span>:</span><span> Readable</span><span> {</span></span>
<span><span>    return</span><span> this</span><span>.#stderr;</span></span>
<span><span>  }</span></span>
<span></span>
<span><span>  public</span><span> async</span><span> spawn</span><span>() {</span></span>
<span><span>    const</span><span> DENO_DIR</span><span> =</span><span> process.env.</span><span>DENO_DIR</span><span>;</span></span>
<span></span>
<span><span>    this</span><span>.#proc </span><span>=</span><span> spawn</span><span>(</span></span>
<span><span>      &#34;docker&#34;</span><span>,</span></span>
<span><span>      [</span></span>
<span><span>        &#34;run&#34;</span><span>,</span></span>
<span><span>        ...</span><span>[</span><span>&#34;-v&#34;</span><span>, </span><span>`${</span><span>DENO_DIR</span><span>}:/root/.cache/deno`</span><span>],</span></span>
<span><span>        ...</span><span>[</span><span>&#34;-v&#34;</span><span>, </span><span>`${</span><span>this</span><span>.</span><span>#socketsDir</span><span>}:${</span><span>CONTAINER_SOCKETS_DIR</span><span>}`</span><span>],</span></span>
<span><span>        &#34;--env&#34;</span><span>,</span></span>
<span><span>        `DOCKER_ID=${</span><span>this</span><span>.</span><span>id</span><span>}`</span><span>,</span></span>
<span><span>        &#34;--rm&#34;</span><span>, </span><span>// remove container after exit</span></span>
<span><span>        &#34;-i&#34;</span><span>, </span><span>// keep stdin open</span></span>
<span><span>        &#34;-a=STDIN&#34;</span><span>, </span><span>// attach stdin, stdout, and stderr</span></span>
<span><span>        &#34;-a=STDOUT&#34;</span><span>,</span></span>
<span><span>        &#34;-a=STDERR&#34;</span><span>,</span></span>
<span><span>        this</span><span>.#containerTag,</span></span>
<span><span>      ],</span></span>
<span><span>      { stdio: [</span><span>&#34;pipe&#34;</span><span>, </span><span>&#34;pipe&#34;</span><span>, </span><span>&#34;inherit&#34;</span><span>] },</span></span>
<span><span>    );</span></span>
<span></span>
<span><span>    this</span><span>.#proc.</span><span>on</span><span>(</span><span>&#34;spawn&#34;</span><span>, () </span><span>=&gt;</span><span> {</span></span>
<span><span>      console.</span><span>log</span><span>(</span><span>&#34;Spawned container&#34;</span><span>);</span></span>
<span><span>    });</span></span>
<span></span>
<span><span>    this</span><span>.</span><span>#waitForSupervisorLine</span><span>((</span><span>parsed</span><span>) </span><span>=&gt;</span></span>
<span><span>      parsed.src </span><span>===</span><span> &#34;main&#34;</span><span> &amp;&amp;</span></span>
<span><span>      parsed.msg.</span><span>startsWith</span><span>(</span><span>&#34;exit&#34;</span><span>)</span></span>
<span><span>    )</span></span>
<span><span>      .</span><span>then</span><span>(({ </span><span>msg</span><span> }) </span><span>=&gt;</span><span> {</span></span>
<span><span>        const</span><span> exitCodeStr</span><span> =</span><span> msg?.</span><span>split</span><span>(</span><span>&#34; &#34;</span><span>)[</span><span>1</span><span>];</span></span>
<span><span>        const</span><span> exitCode</span><span> =</span><span> exitCodeStr </span><span>?</span><span> Number.</span><span>parseInt</span><span>(exitCodeStr) </span><span>:</span><span> null</span><span>;</span></span>
<span><span>        this</span><span>.</span><span>emit</span><span>(</span></span>
<span><span>          &#34;exit&#34;</span><span>,</span></span>
<span><span>          exitCode </span><span>||</span><span> null</span><span>,</span></span>
<span><span>          this</span><span>.#currentModuleUrl </span><span>||</span><span> undefined</span><span>,</span></span>
<span><span>        );</span></span>
<span><span>      });</span></span>
<span></span>
<span><span>    createInterface</span><span>({</span></span>
<span><span>      input: </span><span>this</span><span>.#proc.stdout</span><span>!</span><span>,</span></span>
<span><span>      crlfDelay: Number.POSITIVE_INFINITY,</span></span>
<span><span>    }).</span><span>on</span><span>(</span><span>&#34;line&#34;</span><span>, (</span><span>line</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>      const</span><span> parsed</span><span> =</span><span> JSON</span><span>.</span><span>parse</span><span>(line);</span></span>
<span></span>
<span><span>      if</span><span> (parsed.src </span><span>===</span><span> &#34;stdout&#34;</span><span>) {</span></span>
<span><span>        this</span><span>.#stdout.</span><span>push</span><span>(</span><span>`${</span><span>parsed</span><span>.</span><span>msg</span><span>}</span><span>\n</span><span>`</span><span>);</span></span>
<span><span>      } </span><span>else</span><span> if</span><span> (parsed.src </span><span>===</span><span> &#34;stderr&#34;</span><span>) {</span></span>
<span><span>        this</span><span>.#stderr.</span><span>push</span><span>(</span><span>`${</span><span>parsed</span><span>.</span><span>msg</span><span>}</span><span>\n</span><span>`</span><span>);</span></span>
<span><span>      }</span></span>
<span></span>
<span><span>      console.</span><span>log</span><span>(</span><span>`[container ${</span><span>this</span><span>.</span><span>id</span><span>}]`</span><span>, parsed);</span></span>
<span><span>      this</span><span>.</span><span>emit</span><span>(</span><span>&#34;log&#34;</span><span>, parsed);</span></span>
<span><span>    });</span></span>
<span></span>
<span><span>    await</span><span> this</span><span>.</span><span>#waitForSupervisorLine</span><span>(</span></span>
<span><span>      (</span><span>parsed</span><span>) </span><span>=&gt;</span><span> parsed.src </span><span>===</span><span> &#34;main&#34;</span><span> &amp;&amp;</span><span> parsed.msg </span><span>===</span><span> &#34;starting&#34;</span><span>,</span></span>
<span><span>    );</span></span>
<span><span>  }</span></span>
<span></span>
<span><span>  public</span><span> async</span><span> stop</span><span>() {</span></span>
<span><span>    if</span><span> (</span><span>this</span><span>.#proc) {</span></span>
<span><span>      this</span><span>.#proc.</span><span>kill</span><span>(</span><span>&#34;SIGUSR1&#34;</span><span>); </span><span>// Kill the child, but keep the docker container running</span></span>
<span><span>    }</span></span>
<span></span>
<span><span>    await</span><span> this</span><span>.</span><span>#waitForSupervisorLine</span><span>(</span></span>
<span><span>      (</span><span>parsed</span><span>) </span><span>=&gt;</span><span> parsed.src </span><span>===</span><span> &#34;main&#34;</span><span> &amp;&amp;</span><span> parsed.msg </span><span>===</span><span> &#34;stopped&#34;</span><span>,</span></span>
<span><span>    );</span></span>
<span><span>  }</span></span>
<span></span>
<span><span>  public</span><span> async</span><span> run</span><span>({</span></span>
<span><span>    moduleUrl</span><span>,</span></span>
<span><span>    envVars</span><span> =</span><span> {},</span></span>
<span><span>    cwd</span><span> =</span><span> &#34;/app&#34;</span><span>,</span></span>
<span><span>  }</span><span>:</span><span> {</span></span>
<span><span>    moduleUrl</span><span>:</span><span> string</span><span>;</span></span>
<span><span>    envVars</span><span>:</span><span> Record</span><span>&lt;</span><span>string</span><span>, </span><span>string</span><span>&gt;;</span></span>
<span><span>    cwd</span><span>:</span><span> string</span><span>;</span></span>
<span><span>    socketName</span><span>:</span><span> string</span><span>;</span></span>
<span><span>  }) {</span></span>
<span><span>    this</span><span>.id </span><span>=</span><span> moduleUrl;</span></span>
<span><span>    this</span><span>.#currentModuleUrl </span><span>=</span><span> moduleUrl;</span></span>
<span><span>    const</span><span> input</span><span> =</span><span> `${</span></span>
<span><span>      JSON</span><span>.</span><span>stringify</span><span>({</span></span>
<span><span>        moduleUrl</span><span>,</span></span>
<span><span>        envVars</span><span>,</span></span>
<span><span>        cwd</span><span>,</span></span>
<span><span>        socketPath: </span><span>socketPathToUse</span><span>(</span><span>CONTAINER_SOCKETS_DIR</span><span>, moduleUrl)</span><span>,</span></span>
<span><span>      })</span></span>
<span><span>    }</span><span>\n</span><span>`</span><span>;</span></span>
<span><span>    this</span><span>.#proc.stdin?.</span><span>write</span><span>(input);</span></span>
<span></span>
<span><span>    await</span><span> this</span><span>.</span><span>#waitForSupervisorLine</span><span>(</span></span>
<span><span>      (</span><span>parsed</span><span>) </span><span>=&gt;</span><span> parsed.src </span><span>===</span><span> &#34;main&#34;</span><span> &amp;&amp;</span><span> parsed.msg </span><span>===</span><span> &#34;spawned&#34;</span><span>,</span></span>
<span><span>    );</span></span>
<span><span>  }</span></span>
<span></span>
<span><span>  async</span><span> #</span><span>waitForSupervisorLine</span><span>(</span></span>
<span><span>    stop</span><span>:</span><span> (</span><span>msg</span><span>:</span><span> LogMessage</span><span>) </span><span>=&gt;</span><span> boolean</span><span>,</span></span>
<span><span>  )</span><span>:</span><span> Promise</span><span>&lt;</span><span>LogMessage</span><span>&gt; {</span></span>
<span><span>    return</span><span> new</span><span> Promise</span><span>((</span><span>res</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>      const</span><span> onLog</span><span> =</span><span> (</span><span>log</span><span>:</span><span> LogMessage</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>        if</span><span> (</span><span>stop</span><span>(log)) {</span></span>
<span><span>          this</span><span>.</span><span>off</span><span>(</span><span>&#34;log&#34;</span><span>, onLog);</span></span>
<span><span>          res</span><span>(log);</span></span>
<span><span>        }</span></span>
<span><span>      };</span></span>
<span></span>
<span><span>      this</span><span>.</span><span>on</span><span>(</span><span>&#34;log&#34;</span><span>, onLog);</span></span>
<span><span>    });</span></span>
<span><span>  }</span></span>
<span><span>}</span></span>
<span></span>
<span><span>/**</span></span>
<span><span> * A pool of DenoContainers that can be reused to run different modules.</span></span>
<span><span> */</span></span>
<span><span>export</span><span> class</span><span> DenoContainerPool</span><span> {</span></span>
<span><span>  #availablePool</span><span>:</span><span> DenoContainer</span><span>[] </span><span>=</span><span> [];</span></span>
<span><span>  #inUsePool</span><span>:</span><span> Map</span><span>&lt;</span><span>string</span><span>, </span><span>DenoContainer</span><span>&gt; </span><span>=</span><span> new</span><span> Map</span><span>();</span></span>
<span></span>
<span><span>  #containerTag</span><span>:</span><span> string</span><span>;</span></span>
<span><span>  #socketsDir</span><span>:</span><span> string</span><span>;</span></span>
<span></span>
<span><span>  constructor</span><span>(</span><span>initialCount</span><span>:</span><span> number</span><span>, </span><span>containerTag</span><span>:</span><span> string</span><span>, </span><span>socketsDir</span><span>:</span><span> string</span><span>) {</span></span>
<span><span>    this</span><span>.#containerTag </span><span>=</span><span> containerTag;</span></span>
<span><span>    this</span><span>.#socketsDir </span><span>=</span><span> resolve</span><span>(socketsDir);</span></span>
<span></span>
<span><span>    // Preload containers</span></span>
<span><span>    this</span><span>.</span><span>#preloadContainers</span><span>(initialCount);</span></span>
<span><span>  }</span></span>
<span></span>
<span><span>  public</span><span> async</span><span> getContainer</span><span>(</span><span>moduleUrl</span><span>:</span><span> string</span><span>)</span><span>:</span><span> Promise</span><span>&lt;</span><span>DenoContainer</span><span>&gt; {</span></span>
<span><span>    // Check if we already have a container for this module URL</span></span>
<span><span>    const</span><span> existingContainer</span><span> =</span><span> this</span><span>.#inUsePool.</span><span>get</span><span>(moduleUrl);</span></span>
<span><span>    if</span><span> (existingContainer) {</span></span>
<span><span>      return</span><span> existingContainer;</span></span>
<span><span>    }</span></span>
<span></span>
<span><span>    let</span><span> container</span><span>:</span><span> DenoContainer</span><span> |</span><span> undefined</span><span>;</span></span>
<span></span>
<span><span>    if</span><span> (</span><span>this</span><span>.#availablePool.</span><span>length</span><span> &gt;</span><span> 0</span><span>) {</span></span>
<span><span>      container </span><span>=</span><span> this</span><span>.#availablePool.</span><span>pop</span><span>();</span></span>
<span><span>    }</span></span>
<span></span>
<span><span>    if</span><span> (</span><span>!</span><span>container) {</span></span>
<span><span>      console.</span><span>log</span><span>(</span><span>&#34;No available containers, creating a new one...&#34;</span><span>);</span></span>
<span><span>      // Create and spawn a new container if none available</span></span>
<span><span>      container </span><span>=</span><span> new</span><span> DenoContainer</span><span>({</span></span>
<span><span>        containerTag: </span><span>this</span><span>.#containerTag,</span></span>
<span><span>        socketsDir: </span><span>this</span><span>.#socketsDir,</span></span>
<span><span>      });</span></span>
<span><span>      await</span><span> container.</span><span>spawn</span><span>();</span></span>
<span><span>    }</span></span>
<span></span>
<span><span>    this</span><span>.#inUsePool.</span><span>set</span><span>(moduleUrl, container);</span></span>
<span></span>
<span><span>    // Set up recycling when container exits</span></span>
<span><span>    container.</span><span>once</span><span>(</span><span>&#34;exit&#34;</span><span>, </span><span>async</span><span> (</span><span>code</span><span>, </span><span>exitModuleUrl</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>      console.</span><span>log</span><span>(</span><span>`Container for ${</span><span>exitModuleUrl</span><span>} exited with code ${</span><span>code</span><span>}`</span><span>);</span></span>
<span></span>
<span><span>      if</span><span> (</span><span>!</span><span>exitModuleUrl) </span><span>return</span><span>;</span></span>
<span></span>
<span><span>      console.</span><span>log</span><span>(</span><span>`Recycling container for ${</span><span>exitModuleUrl</span><span>}`</span><span>);</span></span>
<span><span>      try</span><span> {</span></span>
<span><span>        this</span><span>.#inUsePool.</span><span>delete</span><span>(exitModuleUrl);</span></span>
<span></span>
<span><span>        await</span><span> container.</span><span>stop</span><span>();</span></span>
<span><span>        await</span><span> rm</span><span>(</span><span>socketPathToUse</span><span>(</span><span>this</span><span>.#socketsDir, exitModuleUrl));</span></span>
<span></span>
<span><span>        await</span><span> container.</span><span>spawn</span><span>();</span></span>
<span><span>        this</span><span>.#availablePool.</span><span>push</span><span>(container);</span></span>
<span><span>      } </span><span>catch</span><span> (error) {</span></span>
<span><span>        console.</span><span>error</span><span>(</span><span>&#34;Failed to recycle container:&#34;</span><span>, error);</span></span>
<span><span>      }</span></span>
<span><span>    });</span></span>
<span></span>
<span><span>    return</span><span> container;</span></span>
<span><span>  }</span></span>
<span></span>
<span><span>  async</span><span> #</span><span>preloadContainers</span><span>(</span><span>count</span><span>:</span><span> number</span><span>)</span><span>:</span><span> Promise</span><span>&lt;</span><span>void</span><span>&gt; {</span></span>
<span><span>    const</span><span> containers</span><span> =</span><span> await</span><span> this</span><span>.</span><span>#getNContainers</span><span>(count);</span></span>
<span></span>
<span><span>    for</span><span> (</span><span>const</span><span> container</span><span> of</span><span> containers) {</span></span>
<span><span>      this</span><span>.#availablePool.</span><span>push</span><span>(container);</span></span>
<span><span>    }</span></span>
<span><span>  }</span></span>
<span></span>
<span><span>  async</span><span> #</span><span>getNContainers</span><span>(</span><span>n</span><span>:</span><span> number</span><span>)</span><span>:</span><span> Promise</span><span>&lt;</span><span>DenoContainer</span><span>[]&gt; {</span></span>
<span><span>    return</span><span> Promise</span><span>.</span><span>all</span><span>(</span></span>
<span><span>      Array.</span><span>from</span><span>({ length: n }, </span><span>async</span><span> () </span><span>=&gt;</span><span> {</span></span>
<span><span>        const</span><span> container</span><span> =</span><span> new</span><span> DenoContainer</span><span>({</span></span>
<span><span>          containerTag: </span><span>this</span><span>.#containerTag,</span></span>
<span><span>          socketsDir: </span><span>this</span><span>.#socketsDir,</span></span>
<span><span>        });</span></span>
<span><span>        await</span><span> container.</span><span>spawn</span><span>();</span></span>
<span><span>        return</span><span> container;</span></span>
<span><span>      }),</span></span>
<span><span>    );</span></span>
<span><span>  }</span></span>
<span><span>}</span></span>
<span></span>
<span><span>export</span><span> function</span><span> socketPathToUse</span><span>(</span><span>socketsDir</span><span>:</span><span> string</span><span>, </span><span>moduleUrl</span><span>:</span><span> string</span><span>)</span><span>:</span><span> string</span><span> {</span></span>
<span><span>  // Socket paths cannot be over 108 characters, so we hash it down</span></span>
<span><span>  const</span><span> hashedPathName</span><span> =</span><span> createHash</span><span>(</span><span>&#34;sha256&#34;</span><span>)</span></span>
<span><span>    .</span><span>update</span><span>(</span><span>basename</span><span>(moduleUrl))</span></span>
<span><span>    .</span><span>digest</span><span>(</span><span>&#34;hex&#34;</span><span>)</span></span>
<span><span>    .</span><span>slice</span><span>(</span><span>0</span><span>, </span><span>6</span><span>);</span></span>
<span></span>
<span><span>  return</span><span> join</span><span>(socketsDir, </span><span>`${</span><span>hashedPathName</span><span>}.sock`</span><span>);</span></span>
<span><span>}</span></span></code></pre> </div> </details>
<pre tabindex="0" data-language="ts"><code><span><span>fastify.</span><span>all</span><span>(</span><span>&#34;*&#34;</span><span>, </span><span>async</span><span> (</span><span>req</span><span>, </span><span>resp</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span><span>  const</span><span> { </span><span>moduleUrl</span><span> } </span><span>=</span><span> req.query </span><span>as</span><span> { </span><span>moduleUrl</span><span>:</span><span> string</span><span> };</span></span>
<span><span>  // Instead of hostname, we&#39;re using some query parameter to identify the Val.</span></span>
<span><span>  // This is sort of arbitrary.</span></span>
<span></span>
<span><span>  const</span><span> socketPath</span><span> =</span><span> socketPathToUse</span><span>(</span><span>SOCKETS_DIR</span><span>, moduleUrl);</span></span>
<span><span>  // socketPathToUse just hashes the hostname, since the length needs to be</span></span>
<span><span>  // short for unix socket file path names (just an antiquated rule)</span></span>
<span><span>  //</span></span>
<span><span>  // https://unix.stackexchange.com/questions/367008/why-is-socket-path-length-limited-to-a-hundred-chars</span></span>
<span><span>  const</span><span> pool</span><span> =</span><span> await</span><span> getConnPool</span><span>(socketPath, moduleUrl);</span></span>
<span></span>
<span><span>  const</span><span> denoResp</span><span> =</span><span> await</span><span> pool.</span><span>request</span><span>({</span></span>
<span><span>    method: req.method,</span></span>
<span><span>    path: req.url,</span></span>
<span><span>    headers: req.headers,</span></span>
<span><span>    body: req.body </span><span>as</span><span> Readable</span><span>,</span></span>
<span><span>  });</span></span>
<span></span>
<span><span>  console.</span><span>log</span><span>(</span><span>`Forwarded request to worker for ${</span><span>req</span><span>.</span><span>url</span><span>}`</span><span>);</span></span>
<span><span>  resp.</span><span>status</span><span>(denoResp.statusCode);</span></span>
<span><span>  Object.</span><span>entries</span><span>(denoResp.headers </span><span>||</span><span> {})</span></span>
<span><span>    .</span><span>forEach</span><span>(([</span><span>key</span><span>, </span><span>value</span><span>]) </span><span>=&gt;</span><span> resp.</span><span>header</span><span>(key, value));</span></span>
<span><span>  Object.</span><span>entries</span><span>(denoResp.trailers </span><span>||</span><span> {})</span></span>
<span><span>    .</span><span>forEach</span><span>(([</span><span>key</span><span>, </span><span>value</span><span>]) </span><span>=&gt;</span><span> resp.</span><span>trailer</span><span>(key, () </span><span>=&gt;</span><span> value));</span></span>
<span><span>  return</span><span> resp.</span><span>send</span><span>(denoResp.body);</span></span>
<span><span>});</span></span></code></pre>
<p>And <code>getConnPool</code> just looks like this (recall from earlier that we have to be
careful about locks to prevent concurrently spawning multiple workers for the
same Val):</p>
<pre tabindex="0" data-language="ts"><code><span><span>async</span><span> function</span><span> getConnPool</span><span>(</span><span>socketPath</span><span>:</span><span> string</span><span>, </span><span>moduleUrl</span><span>:</span><span> string</span><span>) {</span></span>
<span><span>  const</span><span> existingConn</span><span> =</span><span> conns.</span><span>get</span><span>(socketPath)</span></span>
<span><span>  if</span><span> (existingConn) {</span></span>
<span><span>    return</span><span> existingConn</span></span>
<span><span>  }</span></span>
<span></span>
<span><span>  await</span><span> tryLockFile</span><span>({</span></span>
<span><span>    target: socketPath,</span></span>
<span><span>    onAlreadyExists</span><span>: </span><span>async</span><span> () </span><span>=&gt;</span><span> {</span></span>
<span><span>      conns.</span><span>set</span><span>(</span></span>
<span><span>        socketPath,</span></span>
<span><span>        new</span><span> Pool</span><span>(</span><span>&#39;http://localhost&#39;</span><span>, {</span></span>
<span><span>          socketPath: socketPath,</span></span>
<span><span>          connections: </span><span>50</span><span>,</span></span>
<span><span>        }),</span></span>
<span><span>      )</span></span>
<span><span>    },</span></span>
<span><span>    onAcquired</span><span>: </span><span>async</span><span> () </span><span>=&gt;</span><span> {</span></span>
<span><span>      // Get a container from the pool (creates new one if needed)</span></span>
<span><span>      const</span><span> container</span><span> =</span><span> await</span><span> containerPool.</span><span>getContainer</span><span>(moduleUrl)</span></span>
<span></span>
<span><span>      console.</span><span>log</span><span>(</span><span>`Acquired container for ${</span><span>basename</span><span>(</span><span>socketPath</span><span>)</span><span>}`</span><span>)</span></span>
<span><span>      void</span><span> container.</span><span>run</span><span>({</span></span>
<span><span>        moduleUrl,</span></span>
<span><span>        envVars: </span><span>CONTAINER_ENV_VARS</span><span>,</span></span>
<span><span>        cwd: </span><span>&#39;/app&#39;</span><span>,</span></span>
<span><span>        socketName: </span><span>basename</span><span>(socketPath),</span></span>
<span><span>      })</span></span>
<span></span>
<span><span>      container.stdout?.</span><span>pipe</span><span>(process.stdout, { end: </span><span>false</span><span> })</span></span>
<span><span>      container.stderr?.</span><span>pipe</span><span>(process.stderr, { end: </span><span>false</span><span> })</span></span>
<span></span>
<span><span>      await</span><span> waitForWatcherEvent</span><span>(</span><span>&#39;add&#39;</span><span>, socketPath)</span></span>
<span><span>      console.</span><span>log</span><span>(</span><span>`Spawned worker for ${</span><span>socketPath</span><span>}`</span><span>)</span></span>
<span></span>
<span><span>      conns.</span><span>set</span><span>(</span></span>
<span><span>        socketPath,</span></span>
<span><span>        new</span><span> Pool</span><span>(</span><span>&#39;http://localhost&#39;</span><span>, {</span></span>
<span><span>          socketPath: socketPath,</span></span>
<span><span>          connections: </span><span>50</span><span>,</span></span>
<span><span>        }),</span></span>
<span><span>      )</span></span>
<span><span>    },</span></span>
<span><span>    onAlreadyHeld</span><span>: </span><span>async</span><span> () </span><span>=&gt;</span><span> {</span></span>
<span><span>      await</span><span> waitForWatcherEvent</span><span>(</span><span>&#39;add&#39;</span><span>, socketPath)</span></span>
<span></span>
<span><span>      conns.</span><span>set</span><span>(</span></span>
<span><span>        socketPath,</span></span>
<span><span>        new</span><span> Pool</span><span>(</span><span>&#39;http://localhost&#39;</span><span>, {</span></span>
<span><span>          socketPath: socketPath,</span></span>
<span><span>          connections: </span><span>50</span><span>,</span></span>
<span><span>        }),</span></span>
<span><span>      )</span></span>
<span><span>    },</span></span>
<span><span>  })</span></span>
<span></span>
<span><span>  const</span><span> conn</span><span> =</span><span> conns.</span><span>get</span><span>(socketPath)</span></span>
<span><span>  if</span><span> (</span><span>!</span><span>conn) {</span></span>
<span><span>    throw</span><span> new</span><span> Error</span><span>(</span><span>`Failed to get connection pool for ${</span><span>socketPath</span><span>}`</span><span>)</span></span>
<span><span>  }</span></span>
<span><span>  return</span><span> conn</span></span>
<span><span>}</span></span></code></pre>
<p>One more trick we can use here to make sure that there‚Äôs always warm workers is,
when we spawn a worker, to spawn a new container ahead of time in the
background, so that we‚Äôre always able to handle new requests (up to a limit).</p>
<h2 id="deno">Deno</h2>
<p>Okay, finally, we redid the whole thing in <code>Deno</code> with <code>deno serve --parallel</code>
flag for good measure.</p>
<p>The notable differences were:</p>
<ul>
<li>
<p>We can use
<a href="https://docs.deno.com/api/deno/~/Deno.watchFs">Deno‚Äôs built-in file system watcher</a>
for our helpers instead of <code>chokidar</code>.</p>
</li>
<li>
<p>We can use Deno‚Äôs built-in HTTP client with unix socket support instead of
<code>undici</code>. It‚Äôs really really easy!</p>
<pre tabindex="0" data-language="ts"><code><span><span>const</span><span> pool</span><span> =</span><span> Deno.</span><span>createHttpClient</span><span>({</span></span>
<span><span>  proxy: { path: socketPath, transport: </span><span>&#39;unix&#39;</span><span> },</span></span>
<span><span>})</span></span>
<span><span>// And then we can just use fetch with the client!</span></span>
<span><span>const</span><span> resp</span><span> =</span><span> await</span><span> fetch</span><span>(</span><span>&#39;http://localhost/some/path&#39;</span><span>, {</span></span>
<span><span>  method: </span><span>&#39;GET&#39;</span><span>,</span></span>
<span><span>  client: pool,</span></span>
<span><span>})</span></span></code></pre>
<p>At the time I was working on this project,
<a href="https://github.com/denoland/deno/issues/30271">Deno‚Äôs HTTP client did not support WebSockets</a>,
but
<a href="https://github.com/denoland/deno/pull/30692">they actually added it recently!!</a></p>
</li>
</ul>
<p>And put together, it looks like this:</p>
<pre tabindex="0" data-language="ts"><code><span><span>export</span><span> default</span><span> {</span></span>
<span><span>  async</span><span> fetch</span><span>(req) </span><span>{</span></span>
<span><span>    const</span><span> pathname</span><span> =</span><span> new</span><span> URL</span><span>(req.url).pathname</span></span>
<span><span>    const</span><span> socketId</span><span> =</span><span> socketPathToId</span><span>(pathname)</span></span>
<span><span>    const</span><span> socketPath</span><span> =</span><span> join</span><span>(</span><span>SOCKETS_DIR</span><span>, </span><span>`${</span><span>socketId</span><span>}.sock`</span><span>)</span></span>
<span></span>
<span><span>    const</span><span> client</span><span> =</span><span> await</span><span> getConn</span><span>(socketPath)</span></span>
<span></span>
<span><span>    const</span><span> resp</span><span> =</span><span> await</span><span> fetch</span><span>(</span><span>`http://localhost${</span><span>pathname</span><span>}`</span><span>, {</span></span>
<span><span>      method: req.method,</span></span>
<span><span>      headers: req.headers,</span></span>
<span><span>      body: req.body,</span></span>
<span><span>      client,</span></span>
<span><span>    })</span></span>
<span></span>
<span><span>    return</span><span> resp</span></span>
<span><span>  }</span><span>,</span></span>
<span><span>} </span><span>satisfies</span><span> Deno.ServeDefaultExport</span></span>
<span></span>
<span><span>async</span><span> function</span><span> getConn</span><span>(</span><span>socketPath</span><span>:</span><span> string</span><span>) {</span></span>
<span><span>  const</span><span> socketId</span><span> =</span><span> socketPathToId</span><span>(socketPath)</span></span>
<span><span>  const</span><span> existingConn</span><span> =</span><span> conns.</span><span>get</span><span>(socketId)</span></span>
<span><span>  if</span><span> (existingConn) </span><span>return</span><span> existingConn</span></span>
<span></span>
<span><span>  await</span><span> tryLockFile</span><span>({</span></span>
<span><span>    path: socketPath,</span></span>
<span><span>    onAlreadyExists</span><span>: </span><span>async</span><span> () </span><span>=&gt;</span><span> {</span></span>
<span><span>      conns.</span><span>set</span><span>(</span></span>
<span><span>        socketId,</span></span>
<span><span>        Deno.</span><span>createHttpClient</span><span>({</span></span>
<span><span>          proxy: { path: socketPath, transport: </span><span>&#39;unix&#39;</span><span> },</span></span>
<span><span>        }),</span></span>
<span><span>      )</span></span>
<span><span>    },</span></span>
<span><span>    onAcquired</span><span>: </span><span>async</span><span> () </span><span>=&gt;</span><span> {</span></span>
<span><span>      const</span><span> proc</span><span> =</span><span> new</span><span> Deno.</span><span>Command</span><span>(Deno.</span><span>execPath</span><span>(), {</span></span>
<span><span>        args: [</span><span>&#39;run&#39;</span><span>, </span><span>&#39;-A&#39;</span><span>, </span><span>&#39;../workers/worker.ts&#39;</span><span>, socketPath],</span></span>
<span><span>        stdout: </span><span>&#39;inherit&#39;</span><span>,</span></span>
<span><span>        stderr: </span><span>&#39;inherit&#39;</span><span>,</span></span>
<span><span>      }).</span><span>spawn</span><span>()</span></span>
<span></span>
<span><span>      await</span><span> waitForWatcherEvent</span><span>(</span><span>&#39;add&#39;</span><span>, socketPath)</span></span>
<span><span>      procs.</span><span>set</span><span>(socketId, proc)</span></span>
<span><span>    },</span></span>
<span><span>    onAlreadyHeld</span><span>: </span><span>async</span><span> () </span><span>=&gt;</span><span> {</span></span>
<span><span>      await</span><span> waitForWatcherEvent</span><span>(</span><span>&#39;add&#39;</span><span>, socketPath)</span></span>
<span><span>    },</span></span>
<span><span>  })</span></span>
<span></span>
<span><span>  const</span><span> client</span><span> =</span><span> Deno.</span><span>createHttpClient</span><span>({</span></span>
<span><span>    proxy: { path: socketPath, transport: </span><span>&#39;unix&#39;</span><span> },</span></span>
<span><span>  })</span></span>
<span><span>  conns.</span><span>set</span><span>(socketId, client)</span></span>
<span><span>  return</span><span> client</span></span>
<span><span>}</span></span></code></pre>

<p>You made it to the end! Hopefully this was interesting!</p>  </div> </astro-slot></div></div>
  </body>
</html>
