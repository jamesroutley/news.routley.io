<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tylercipriani.com/blog/2024/07/31/git-as-a-password-prompt/">Original</a>
    <h1>Git: The Stupid Password Store</h1>
    
    <div id="readability-page-1" class="page"><article class="page">







<div id="pagebody">

<section id="content" role="main">

<blockquote>
<p>GIT - the stupid content tracker</p>
<p>– Linus Torvalds, <a href="https://kernel.googlesource.com/pub/scm/git/git/+/e83c5163316f89bfbde7d9ab23ca2e25604af290/README#2">Initial
revision of “git”, the information manager from hell</a></p>
</blockquote>
<p>After years of code review with stacked diffs<a href="#fn1" id="fnref1" role="doc-noteref"><sup>1</sup></a>,
I’ve been using GitLab merge requests at work.</p>
<p>Merge requests frustrated me until helpful folks pointed me toward <a href="https://github.com/yaoyuannnn/gerritlab">GerritLab</a>, a small
Python tool for making stacked merge requests in GitLab—exactly what I
was looking for.</p>
<p>But to talk to GitLab, GerritLab required a cleartext token in my
<code>~/.gitconfig</code>. I wanted to stow my token in a password
vault, so I crafted a change for GerritLab that used <a href="https://mirrors.edge.kernel.org/pub/software/scm/git/docs/gitcredentials.html">gitcredentials(7)</a>.</p>
<p>Like most git features, <code>git credentials</code> are obscure,
byzantine, and incredibly useful. It works like this:</p>
<div id="cb1"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span>import</span> subprocess, json</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>INPUT <span>=</span> <span>&#34;&#34;&#34;</span><span>\</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span>protocol=https</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span>host=example.com</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span>username=thcipriani</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span>&#34;&#34;&#34;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>git_credentials_fill <span>=</span> subprocess.run(</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    [<span>&#34;git&#34;</span>, <span>&#34;credential&#34;</span>, <span>&#34;fill&#34;</span>],</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span>input</span><span>=</span>INPUT,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    text<span>=</span><span>True</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    stdout<span>=</span>subprocess.PIPE,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>git_credentials <span>=</span> {</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    key: value <span>for</span> line <span>in</span> git_credentials_fill.stdout.splitlines()</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span>if</span> <span>&#39;=&#39;</span> <span>in</span> line</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span>for</span> key, value <span>in</span> [line.split(<span>&#39;=&#39;</span>, <span>1</span>)]</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span>print</span>(json.dumps(git_credentials, indent<span>=</span><span>4</span>))</span></code></pre></div>
<p>Which looks like this when you run it:</p>
<pre><code>$ ./example-git-creds.py
Password for &#39;https://thcipriani@example.com&#39;:
{
    &#34;protocol&#34;: &#34;https&#34;,
    &#34;host&#34;: &#34;example.com&#34;,
    &#34;username&#34;: &#34;thcipriani&#34;,
    &#34;password&#34;: &#34;hunter2&#34;
}</code></pre>
<p>The magic here is the shell command
<code>git credentials fill</code>, which:</p>
<ol type="1">
<li>Accepts a protocol, username, and host on standard input.</li>
<li>Delegates to a “git credential helper” (<a href="https://github.com/git/git/blob/master/contrib/credential/libsecret/git-credential-libsecret.c"><code>git-credential-libsecret</code></a>
in my case). A credential helper is an executable that retrieves
passwords from the OS or another program that provides secure
storage.</li>
<li>My git credential helper checks for credentials matching
<code>https://thcipriani@example.com</code> and finds none.</li>
<li>Since my credential helper comes up empty, git prompts me for my
password.</li>
<li>Git sends <code>&lt;key&gt;=&lt;value&gt;\n</code> pairs to standard
output for each of the keys <code>protocol</code>, <code>host</code>,
<code>username</code>, and <code>password</code>.</li>
</ol>
<p>To stow the password for later, I can use
<code>git credential approve</code>.</p>
<div id="cb3"><pre><code><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>subprocess.run(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    [<span>&#34;git&#34;</span>, <span>&#34;credential&#34;</span>, <span>&#34;approve&#34;</span>],</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span>input</span><span>=</span>git_credentials_fill.stdout,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    text<span>=</span><span>True</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>If I do that, the next time I run the script, git finds the password
without prompting:</p>
<pre><code>$ ./example-git-creds.py
{
    &#34;protocol&#34;: &#34;https&#34;,
    &#34;host&#34;: &#34;example.com&#34;,
    &#34;username&#34;: &#34;thcipriani&#34;,
    &#34;password&#34;: &#34;hunter2&#34;
}</code></pre>
<section id="git-credentials-purpose">
<h2>Git credential’s purpose</h2>
<p>The problem git credentials solve is this:</p>
<ul>
<li>With git over ssh, you use your keys.</li>
<li>With git over https, you type a password. Over and over and
over.</li>
</ul>
<p>Beleaguered git maintainers solved this dilemma with the <a href="https://git-scm.com/book/en/v2/Git-Tools-Credential-Storage">credential
storage system</a>—git credentials.</p>
<p>With the right configuration, git will stop asking for your password
when you push to an https remote.</p>
<p>Instead, git credentials retrieve and send auth info to remotes.</p>
</section>
<section id="the-maze-of-options">
<h2>The maze of options</h2>
<p>My mind initially refused to learn git credentials due to its <a href="https://en.wikipedia.org/wiki/Twisty_little_maze_of_passages?redirect=no">twisty
little maze of terms that all sound alike</a>:</p>
<ul>
<li><code>git credential fill</code>: how you invoke a user’s configured
git credential helper</li>
<li><code>git credential approve</code>: how you save git credentials
(if this is supported by the user’s git credential helper)</li>
<li><code>git credential.helper</code>: the git config that points to a
script that poops out usernames and passwords. These helper scripts are
often named <code>git-credential-&lt;something&gt;</code>.</li>
<li><code>git-credential-cache</code>: a specific, built-in git
credential helper that caches credentials in memory for a while.</li>
<li><code>git-credential-store</code>: STOP. DON’T TOUCH. This is a
specific, built-in git credential helper that <strong>stores credentials
in cleartext in your home directory</strong>. Whomp whomp.</li>
<li><code>git-credential-manager</code>: a specific and confusingly
named git credential helper from Microsoft®. If you’re on Linux or Mac,
feel free to ignore it.</li>
</ul>
<p>But once I mapped the terms, I only needed to pick a git credential
helper.</p>
</section>
<section id="configuring-good-credential-helpers">
<h2>Configuring good credential helpers</h2>
<p>The built-in <code>git-credential-store</code> is a bad credential
helper—it saves your passwords in cleartext in
<code>~/.git-credentials</code>.<a href="#fn2" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>If you’re on a Mac, you’re in luck<a href="#fn3" id="fnref3" role="doc-noteref"><sup>3</sup></a>—one command points git
credentials to your keychain:</p>
<pre><code>git config --global credential.helper osxkeychain</code></pre>
<p>Third-party developers have contributed helpers for popular password
stores:</p>
<ul>
<li><a href="https://github.com/ethrgeist/git-credential-1password">1Password</a></li>
<li><a href="https://github.com/languitar/pass-git-helper">pass</a>: the
standard <a href="https://www.passwordstore.org/">Unix password
manager</a></li>
<li><a href="https://github.com/hickford/git-credential-oauth">OAuth</a></li>
<li>Git’s documentation contains a <a href="https://git-scm.com/doc/credential-helpers">list of
credential-helpers</a>, too</li>
</ul>
<p>Meanwhile, Linux and Windows have standard options. Git’s source repo
includes helpers for these options in the <a href="https://github.com/git/git/tree/master/contrib/credential">contrib
directory</a>.</p>
<p>On Linux, you can use <a href="https://github.com/GNOME/libsecret?tab=readme-ov-file#libsecret">libsecret</a>.
Here’s how I configured it on Debian:</p>
<pre><code>sudo apt install libsecret-1-0 libsecret-1-dev
cd /usr/share/doc/git/contrib/credential/libsecret/
sudo make
sudo mv git-credential-libsecret /usr/local/bin/
git config --global credential.helper libsecret</code></pre>
<p>On Windows, you can use the confusingly named <a href="https://github.com/git-ecosystem/git-credential-manager">git
credential manager</a>. I have no idea how to do this, and I refuse to
learn.</p>
<p>Now, if you clone a repo over https, you can push over https without
pain<a href="#fn4" id="fnref4" role="doc-noteref"><sup>4</sup></a>. Plus, now you have a handy password
library for shell scripts:</p>
<div id="cb7"><pre><code><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span>#!/usr/bin/env bash</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span>input</span><span>=</span><span>&#34;</span><span>\</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span>protocol=https</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span>host=example.com</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span>user=thcipriani</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span>&#34;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span>eval</span> <span>&#34;</span><span>$(</span><span>echo</span> <span>&#34;</span><span>$input</span><span>&#34;</span> <span>|</span> <span>git</span> credential fill<span>)</span><span>&#34;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span>echo</span> <span>&#34;The password is: </span><span>$password</span><span>&#34;</span></span></code></pre></div>
</section>


</section>









</div>



</article></div>
  </body>
</html>
