<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://sawyer.dev/posts/tree-sitter-asdl/">Original</a>
    <h1>Writing a Tree-Sitter Grammar</h1>
    
    <div id="readability-page-1" class="page"><div>
      



<section id="post">


  <container>
  <nav>
    &gt; <a href="https://fahrplan.events.ccc.de/">home</a>
    &gt; <a href="https://fahrplan.events.ccc.de/posts">blog posts</a>
  </nav>
    <h2 id="post-title"> Writing a Tree-Sitter Grammar </h2>

    <article>
      <p>I recently found a chance to squeeze tree-sitter into a side project of a side project. This post is about getting to this point and writing a grammar for a small language.</p>
<h2>background</h2>
<p>The top-level project is a tool to operate on data definitions. To accomplish this, I&#39;m trying to define an intermediate representation and translate between that and a target format. Like generating JSON schema definitions from Rust, or converting an XML schema to Python dataclasses.</p>
<p>Despite working through a few &#34;how to build a compiler&#34; books, most of this is new to me. I&#39;ve never designed an intermediate representation. However, working through <a href="https://nostarch.com/writing-c-compiler">&#34;Writing a C Compiler&#34;</a> introduced me to ASDL. I thought maybe this would be a useful tool to help me design and implement an IR. One thing I thought about while working through &#34;Writing a C Compiler&#34; was that it would be really convenient to have a tool that took in an ASDL specification and generated all the corresponding structs and enums for me. Faced with the prospect of using ASDL again, I set aside my original project and set out to write <a href="https://codeberg.org/rors/asdl-cli">that tool</a>.</p>
<p>Those aforementioned compiler books helped me understand the vague shape of what I needed: convert an ASDL specification to a series of tokens, parse those tokens into an AST, and then convert that AST into Rust code. ASDL is a simple language, so none of the bugs that popped up were too hard to figure out. I started thinking about what it would take to have a better debugging experience. It would be nice to know what part of the input caused a problem. Still, I wasn&#39;t enthusiastic about breaking out <code>anyhow</code> and <code>thiserror</code> to make things better for myself. I&#39;d put in work trying to implement parsers before, and it&#39;s just not what I want to spend my time doing.</p>
<p>Which brings us to tree-sitter. I don&#39;t have much experience with parser generators, but I figured this would be a good time to learn. Tree-sitter is what I hear about most often these days, so I set about writing a grammar to introduce tree-sitter to ASDL.</p>
<h2><code>tree-sitter-asdl</code></h2>
<p>The process of developing this grammar is more or less the story of me reading the <a href="https://tree-sitter.github.io/tree-sitter/creating-parsers/index.html">documentation for writing parsers</a>. I benefitted from using <a href="https://crates.io/crates/nom">nom</a> to write my original lexer, since the grammar is defined using a very similar DSL in JavaScript. So once I had <a href="https://codeberg.org/unremarkable/tree-sitter-asdl/src/branch/main/grammar.js">my grammar</a> ready to go, it was just a matter of following the rest of the steps to publish my crate, <a href="https://crates.io/crates/tree-sitter-asdl"><code>tree-sitter-asdl</code></a>.</p>
<h2>further work</h2>
<p>I was really impressed with how straightforward it was to add support for a new language in tree-sitter. That said, I still haven&#39;t actually used tree-sitter in my ASDL project. I don&#39;t know if it will feel different to work with a <em>concrete</em> syntax tree instead of an abstract syntax tree, or if I&#39;d even notice using tree-sitter with a language as small as ASDL. I also don&#39;t know what I&#39;m really able to control with the grammar. I don&#39;t know if there are ways of defining my rules that make the output any better or worse to work with. These are the things I&#39;ll be thinking about as I work tree-sitter in to my ASDL tool so I can get back to my schema project.</p>

    </article>

  </container>


</section>

    </div></div>
  </body>
</html>
