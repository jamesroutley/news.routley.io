<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.untrod.com/2023/11/robot-dad.html">Original</a>
    <h1>Robot Dad</h1>
    
    <div id="readability-page-1" class="page"><div>
        <p>Tired of Alexa&#39;s feeble &#34;here&#39;s what I found on wikianswerspam.com&#34; responses to my eight-year-old son&#39;s science questions, I whipped up Robot Dad during my Thanksgiving break. He now runs in the background of our family computer.</p>
<p>Robot Dad sounds like real dad, thanks to voice cloning from <a href="https://elevenlabs.io/speech-synthesis">Eleven Labs</a> (very easy; I rambled about Formula 1 into a new MacOS Voice Memo for about sixty seconds, uploaded it, and voila), and answers appropriately for an eight-year-old, while deflecting prank requests -- though I suspect prompt injection will soon be second nature to this generation.</p>
<p>Here&#39;s my son, Dash, interacting with Robot Dad.</p>

<p>The delays are real, and the speech-to-text is only so-so, but it manages to be just good enough to clear the &#34;provides value&#34; bar. Robot Dad will also inject context from the previous question into the prompt. Dash could follow up with &#34;Robot Dad, tell me more about it&#34; and ChatGPT would know what to do.</p>
<p>A few dozen lines of code glues together different AI services, for a remarkable result. The wakeword and speech-to-text happen locally, while the AI response (ChatGPT) and text-to-speech are via HTTP. It&#39;s trivial to move the LLM bit to a local Llama2 instance, but I haven&#39;t found a satisfactory text-to-speech model that can do voice cloning locally.</p>
<p>I also made a quick speech visualization (turns out kids are not very engaged reading console log messages) that of course ended up providing more entertainment value than the <em>ENTIRE MODERN MIRACLE OF ARTIFICIAL INTELLIGENCE</em>. Code for the visualization is in <a href="https://gist.github.com/chrisclark/b9e7ba61654313a1e2d4a796ad5bb8a9">this gist</a>.</p>
<video controls="controls" width="100%" name="speech visualization">
  <source src="https://blog.untrod.com/media/robot-dad-speech-visualization.mov"/>
</video>

<p>Code for Robot Dad is below. You will need API keys for <a href="https://picovoice.ai/">Picovoice</a> (and a wakeword), <a href="https://elevenlabs.io/speech-synthesis">Eleven Labs</a>, and OpenAI. You can pick a pre-existing Eleven Labs voice or clone your own.</p>
<div><pre><span></span><code><span>import</span> <span>os</span><span>,</span> <span>json</span><span>,</span> <span>threading</span><span>,</span> <span>time</span>
<span>import</span> <span>pvporcupine</span><span>,</span> <span>pvcheetah</span>
<span>from</span> <span>pvrecorder</span> <span>import</span> <span>PvRecorder</span>
<span>from</span> <span>elevenlabs</span> <span>import</span> <span>voices</span><span>,</span> <span>generate</span><span>,</span> <span>play</span><span>,</span> <span>stream</span>
<span>import</span> <span>openai</span>

<span>ENDPOINT_DURATION_SECONDS</span> <span>=</span> <span>2</span> <span># &#39;Quiet&#39; seconds indicating the end of audio capture</span>
<span>VOICE</span> <span>=</span> <span>&#39;Dad&#39;</span> <span># Via Eleven Labs</span>
<span>AUDIO_DEVICE_NAME</span> <span>=</span> <span>&#39;MacBook Pro Microphone&#39;</span>
<span>AUDIO_DEVICE</span> <span>=</span> <span>PvRecorder</span><span>.</span><span>get_available_devices</span><span>()</span><span>.</span><span>index</span><span>(</span><span>AUDIO_DEVICE_NAME</span><span>)</span>
<span>OPENAI_MODEL</span> <span>=</span> <span>&#39;gpt-3.5-turbo-1106&#39;</span>

<span>BASE_PROMPT</span> <span>=</span> <span>&#34;&#34;&#34;You are Robot Dad, and will be speaking with one of my children,</span>
<span>trying to be a helpful parent. You explain things at a level appropriate for</span>
<span>an eight-year-old.</span>

<span>You are encouraging and helpful, but won&#39;t tolerate any inappropriate requests</span>
<span>or attempts at pranks or jokes. If you you are asked or told anything</span>
<span>inappropriate, you gently say &#34;nice try - but Robot Dad isn&#39;t falling for that!&#34;</span>

<span>If you don&#39;t know how to reply, simply say &#34;I&#39;m just Robot Dad, not real dad -</span>
<span>so I&#39;m afraid I can&#39;t help you with that&#34;.</span>

<span>You usually answer in no more than 4 sentences - kids do not have long attention</span>
<span>spans - but you can provide longer answers if it&#39;s clearly needed.</span>
<span>&#34;&#34;&#34;</span>

<span>PREV_CTX_PROMPT</span> <span>=</span> <span>&#34;&#34;&#34;</span>

<span>The last request and response you received is below. The next request may or may</span>
<span>not be a continuation of this conversation.</span>

<span>Previous request:</span>
<span>%s</span><span></span>

<span>Previous response:</span>
<span>%s</span><span></span>
<span>&#34;&#34;&#34;</span>

<span>PREV_CTX_TIMEOUT</span> <span>=</span> <span>60</span> <span># seconds</span>

<span>keyword_paths</span><span>=</span><span>[</span><span>&#39;</span><span>%s</span><span>/wakewords/Robot-Dad.ppn&#39;</span> <span>%</span> <span>ROOT</span><span>]</span>

<span>porcupine_key</span> <span>=</span> <span>os</span><span>.</span><span>environ</span><span>.</span><span>get</span><span>(</span><span>&#34;PORCUPINE_API_KEY&#34;</span><span>)</span>
<span>openai</span><span>.</span><span>api_key</span> <span>=</span> <span>os</span><span>.</span><span>environ</span><span>.</span><span>get</span><span>(</span><span>&#34;OPENAI_API_KEY&#34;</span><span>)</span>

<span>porcupine</span> <span>=</span> <span>pvporcupine</span><span>.</span><span>create</span><span>(</span>
    <span>access_key</span><span>=</span><span>porcupine_key</span><span>,</span>
    <span>keyword_paths</span><span>=</span><span>keyword_paths</span><span>)</span>

<span>cheetah</span> <span>=</span> <span>pvcheetah</span><span>.</span><span>create</span><span>(</span>
    <span>access_key</span><span>=</span><span>porcupine_key</span><span>,</span>
    <span>endpoint_duration_sec</span><span>=</span><span>ENDPOINT_DURATION_SECONDS</span><span>,</span>
    <span>enable_automatic_punctuation</span><span>=</span><span>True</span><span>)</span>

<span>recorder</span> <span>=</span> <span>PvRecorder</span><span>(</span>
    <span>frame_length</span><span>=</span><span>porcupine</span><span>.</span><span>frame_length</span><span>,</span>
    <span>device_index</span><span>=</span><span>AUDIO_DEVICE</span><span>)</span>

<span>break_audio</span> <span>=</span> <span>generate</span><span>(</span><span>text</span><span>=</span><span>&#34;Got it! Robot Dad is thinking...&#34;</span><span>,</span> <span>voice</span><span>=</span><span>VOICE</span><span>)</span>
<span>alert_audio</span> <span>=</span> <span>generate</span><span>(</span><span>text</span><span>=</span><span>&#34;What&#39;s up kiddo?&#34;</span><span>,</span> <span>voice</span><span>=</span><span>VOICE</span><span>)</span>

<span>def</span> <span>llm_req</span><span>(</span><span>prompt</span><span>,</span> <span>txt</span><span>):</span>
    <span>messages</span><span>=</span> <span>[</span>
        <span>{</span><span>&#34;role&#34;</span><span>:</span> <span>&#34;system&#34;</span><span>,</span> <span>&#34;content&#34;</span><span>:</span> <span>prompt</span><span>},</span>
        <span>{</span><span>&#34;role&#34;</span><span>:</span> <span>&#34;user&#34;</span><span>,</span> <span>&#34;content&#34;</span><span>:</span> <span>f</span><span>&#39;Here is what the child has said: </span><span>{</span><span>txt</span><span>}</span><span>&#39;</span><span>}</span>
    <span>]</span>

    <span>resp</span> <span>=</span> <span>openai</span><span>.</span><span>ChatCompletion</span><span>.</span><span>create</span><span>(</span>
      <span>model</span><span>=</span><span>OPENAI_MODEL</span><span>,</span>
      <span>messages</span><span>=</span><span>messages</span>
    <span>)</span>
    <span>return</span> <span>resp</span><span>[</span><span>&#39;choices&#39;</span><span>][</span><span>0</span><span>][</span><span>&#39;message&#39;</span><span>][</span><span>&#39;content&#39;</span><span>]</span>


<span># Speech-to-text using Picovoice&#39;s Cheetah</span>
<span>def</span> <span>capture_input</span><span>():</span>
    <span>transcript</span> <span>=</span> <span>&#39;&#39;</span>
    <span>while</span> <span>True</span><span>:</span>
        <span>partial_transcript</span><span>,</span> <span>is_endpoint</span> <span>=</span> <span>cheetah</span><span>.</span><span>process</span><span>(</span><span>recorder</span><span>.</span><span>read</span><span>())</span>
        <span>transcript</span> <span>+=</span> <span>partial_transcript</span>
        <span>if</span> <span>is_endpoint</span><span>:</span>
            <span>transcript</span> <span>+=</span> <span>cheetah</span><span>.</span><span>flush</span><span>()</span>
            <span>break</span>
    <span>return</span> <span>transcript</span>


<span>def</span> <span>play_async</span><span>(</span><span>audio</span><span>):</span>
    <span>audio_thread</span> <span>=</span> <span>threading</span><span>.</span><span>Thread</span><span>(</span><span>target</span><span>=</span><span>play</span><span>,</span> <span>args</span><span>=</span><span>(</span><span>audio</span><span>,))</span>
    <span>audio_thread</span><span>.</span><span>start</span><span>()</span>


<span>def</span> <span>main</span><span>():</span>
    <span>print</span><span>(</span><span>&#39;Listening...&#39;</span><span>)</span>

    <span>recorder</span><span>.</span><span>start</span><span>()</span>

    <span>prev_request</span> <span>=</span> <span>&#39;&#39;</span>
    <span>prev_response</span> <span>=</span> <span>&#39;&#39;</span>
    <span>last_wake_time</span> <span>=</span> <span>None</span>

    <span>try</span><span>:</span>
        <span>while</span> <span>True</span><span>:</span>
            <span>pcm</span> <span>=</span> <span>recorder</span><span>.</span><span>read</span><span>()</span>
            <span>result</span> <span>=</span> <span>porcupine</span><span>.</span><span>process</span><span>(</span><span>pcm</span><span>)</span>

            <span>if</span> <span>result</span> <span>&gt;=</span> <span>0</span><span>:</span>
                <span>print</span><span>(</span><span>&#39;Detected Robot Dad&#39;</span><span>)</span>
                <span>play_async</span><span>(</span><span>alert_audio</span><span>)</span>

                <span>prompt</span> <span>=</span> <span>BASE_PROMPT</span>
                <span>current_time</span> <span>=</span> <span>time</span><span>.</span><span>time</span><span>()</span>
                <span>if</span> <span>last_wake_time</span> <span>and</span> <span>current_time</span> <span>-</span> <span>last_wake_time</span> <span>&lt;</span> <span>PREV_CTX_TIMEOUT</span><span>:</span>
                    <span>prompt</span> <span>+=</span> <span>PREV_CTX_PROMPT</span> <span>%</span> <span>(</span><span>prev_request</span><span>,</span> <span>prev_response</span><span>)</span>
                <span>last_wake_time</span> <span>=</span> <span>current_time</span>

                <span>transcript</span> <span>=</span> <span>capture_input</span><span>()</span>
                <span>print</span><span>(</span><span>&#39;Heard request: </span><span>%s</span><span>&#39;</span> <span>%</span> <span>transcript</span><span>)</span>
                <span>prev_request</span> <span>=</span> <span>transcript</span>

                <span>play_async</span><span>(</span><span>break_audio</span><span>)</span>

                <span>resp</span> <span>=</span> <span>llm_req</span><span>(</span><span>prompt</span><span>,</span> <span>transcript</span><span>)</span>
                <span>print</span><span>(</span><span>&#39;Answering: </span><span>%s</span><span>&#39;</span> <span>%</span> <span>resp</span><span>)</span>
                <span>prev_response</span> <span>=</span> <span>resp</span>

                <span>resp_audio</span> <span>=</span> <span>generate</span><span>(</span><span>text</span><span>=</span><span>resp</span><span>,</span> <span>voice</span><span>=</span><span>VOICE</span><span>,</span> <span>stream</span><span>=</span><span>True</span><span>)</span>
                <span>stream</span><span>(</span><span>resp_audio</span><span>)</span>
    <span>except</span> <span>KeyboardInterrupt</span><span>:</span>
        <span>pass</span>

    <span>recorder</span><span>.</span><span>stop</span><span>()</span>
    <span>print</span><span>(</span><span>&#39;Stopped.&#39;</span><span>)</span>
<span>main</span><span>()</span>
</code></pre></div>


            <h4><i>Like what you read?</i> <a href="http://tinyletter.com/chrisclark">Join the newsletter</a> and get updated when there&#39;s something new.</h4>


    

    </div></div>
  </body>
</html>
