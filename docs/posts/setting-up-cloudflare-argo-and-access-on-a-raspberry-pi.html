<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://erdaltoprak.com/setting-up-cloudflare-argo-and-access-on-a-raspberry-pi/">Original</a>
    <h1>Setting Up Cloudflare Argo and Access on a Raspberry Pi</h1>
    
    <div id="readability-page-1" class="page"><section><p><span>
      <span></span>
  <img alt="Banner" title="Banner" src="https://erdaltoprak.com/static/619edc28c03f61c33f9b8ab7abc732a4/18e3b/rpi-banner.jpg" srcset="/static/619edc28c03f61c33f9b8ab7abc732a4/46946/rpi-banner.jpg 240w,/static/619edc28c03f61c33f9b8ab7abc732a4/55489/rpi-banner.jpg 480w,/static/619edc28c03f61c33f9b8ab7abc732a4/18e3b/rpi-banner.jpg 960w,/static/619edc28c03f61c33f9b8ab7abc732a4/60e21/rpi-banner.jpg 1440w,/static/619edc28c03f61c33f9b8ab7abc732a4/69b48/rpi-banner.jpg 1920w,/static/619edc28c03f61c33f9b8ab7abc732a4/741c1/rpi-banner.jpg 3517w" sizes="(max-width: 960px) 100vw, 960px" loading="lazy" decoding="async"/>
    </span></p><p>A few nights ago I was casually browsing on <a href="https://www.reddit.com/r/selfhosted/">/r/SelfHosted</a> when I came across a post mentioning how insecure some of the home servers are regarding to their WAN access.</p><p>The obvious answer is Cloudflare Argo &amp; Cloudflare Access. Before explaining everything, let&#39;s clarify what this guide is about:
If you are looking to access your homeserver from outside, for example, your Raspberry Pi, in a secure way without exposing ports on your own, this guide is for you.</p><p>Before you begin you will need a few things:</p><ul><li>A Cloudflare account </li><li>A registered domain name with access to the DNS panel (ideally through Cloudflare but at the very least point the nameservers to them)</li><li>A Raspberry Pi or a server with your favorite Linux distribution </li><li>Some basic knowledge of Docker, shell commands and networking</li></ul><h3>What&#39;s Cloudflare Argo &amp; Access ?</h3><p>Cloudflare Argo tunnels allows you to create an encrypted tunnel between your homeserver and the Cloudflare servers. This is done seamlessly, in a few lines of shell commands.</p><p>As you can see from the image below (<a href="https://www.cloudflare.com/products/tunnel">from the Cloudflare Blog</a>), you should consider the tunnel like a third party making sure you get the fastest access with the least risks of exposing your services.</p><p><span>
      <span></span>
  <img alt="Argo Tunnel" title="Argo Tunnel" src="https://erdaltoprak.com/static/b8f2f466bd456318477fecef858c9839/18e3b/argo-tunnel-diagram.jpg" srcset="/static/b8f2f466bd456318477fecef858c9839/46946/argo-tunnel-diagram.jpg 240w,/static/b8f2f466bd456318477fecef858c9839/55489/argo-tunnel-diagram.jpg 480w,/static/b8f2f466bd456318477fecef858c9839/18e3b/argo-tunnel-diagram.jpg 960w,/static/b8f2f466bd456318477fecef858c9839/60e21/argo-tunnel-diagram.jpg 1440w,/static/b8f2f466bd456318477fecef858c9839/69b48/argo-tunnel-diagram.jpg 1920w,/static/b8f2f466bd456318477fecef858c9839/6f5c0/argo-tunnel-diagram.jpg 2730w" sizes="(max-width: 960px) 100vw, 960px" loading="lazy" decoding="async"/>
    </span></p><p>On the technical side you get a few features as a bonus like TLS certificates, DDOS protection and smart routing.</p><p>Another Cloudflare service is Access, which is part of Cloudflare Teams and it allows you to use their zero-trust infrastructure to access your services securely.
What we are most interested in are the access policies and the application dashboard.</p><p><span>
      <span></span>
  <img alt="Cloudflare Access" title="Cloudflare Access" src="https://erdaltoprak.com/static/3fe18afe2e5d820f4e68a4a5685fab67/18e3b/team-access-diagram.jpg" srcset="/static/3fe18afe2e5d820f4e68a4a5685fab67/46946/team-access-diagram.jpg 240w,/static/3fe18afe2e5d820f4e68a4a5685fab67/55489/team-access-diagram.jpg 480w,/static/3fe18afe2e5d820f4e68a4a5685fab67/18e3b/team-access-diagram.jpg 960w,/static/3fe18afe2e5d820f4e68a4a5685fab67/60e21/team-access-diagram.jpg 1440w,/static/3fe18afe2e5d820f4e68a4a5685fab67/69b48/team-access-diagram.jpg 1920w,/static/3fe18afe2e5d820f4e68a4a5685fab67/2ff25/team-access-diagram.jpg 3431w" sizes="(max-width: 960px) 100vw, 960px" loading="lazy" decoding="async"/>
    </span></p><p>If you are interested in more technical information you should consider reading their <a href="https://developers.cloudflare.com/cloudflare-one/">developer documentation</a>.</p><h3>Practical deployment</h3><p>To illustrate how easy and magical it is, I will deploy from start to finish three docker containers (portainer, gluetun &amp; librespeed) on a Raspberry Pi.</p><p>Get your <a href="https://www.raspberrypi.org/software/operating-systems/#raspberry-pi-os-32-bit">Raspberry Pi OS Lite image</a> and use <a href="https://www.balena.io/etcher/">balenaEtcher</a> to write it down on your SD card.
You can add an &#34;ssh&#34; file without any extensions to make your Raspberry Pi headless and accessible from your computer or just plug-it in.</p><p>Let&#39;s get some updates</p><div data-language="shell"><pre data-linenumber="true"><code><p><span>1</span><span>sudo</span><span> </span><span>apt</span><span> update </span></p><p><span>2</span><span></span><span>sudo</span><span> </span><span>apt</span><span> upgrade</span></p></code></pre></div><p>We can now install Docker </p><div data-language="shell"><pre data-linenumber="true"><code><p><span>1</span><span>curl</span><span> -sSL https://get.docker.com </span><span>|</span><span> </span><span>sh</span></p></code></pre></div><p>Add permissions to the current user</p><div data-language="shell"><pre data-linenumber="true"><code><p><span>1</span><span>sudo</span><span> </span><span>usermod</span><span> -aG docker </span><span>${</span><span>USER</span><span>}</span></p></code></pre></div><p>Let&#39;s also install docker-compose</p><div data-language="shell"><pre data-linenumber="true"><code><p><span>1</span><span>sudo</span><span> </span><span>apt-get</span><span> </span><span>install</span><span> libffi-dev libssl-dev</span></p><p><span>2</span><span></span><span>sudo</span><span> </span><span>apt</span><span> </span><span>install</span><span> python3-dev</span></p><p><span>3</span><span></span><span>sudo</span><span> </span><span>apt-get</span><span> </span><span>install</span><span> -y python3 python3-pip</span></p><p><span>4</span><span></span><span>sudo</span><span> pip3 </span><span>install</span><span> docker-compose</span></p></code></pre></div><p>You can enable the docker service </p><div data-language="shell"><pre data-linenumber="true"><code><p><span>1</span><span>sudo</span><span> systemctl </span><span>enable</span><span> docker</span></p></code></pre></div><p>Let&#39;s deploy our docker containers, but before that a bit of explanation about the containers we are going to use:</p><ul><li><a href="https://docs.portainer.io">Portainer</a> is a GUI for docker.</li><li><a href="https://github.com/qdm12/gluetun">Gluetun</a> is a super awesome, vpn docker container, that allows you to route any other service through that container for additional privacy.</li><li><a href="https://hub.docker.com/r/linuxserver/librespeed">Librespeed</a> is just a lightweight speedtest implementation and will serve as an exemple of network routing.  </li></ul><p>All these containers are just here to illustrate this practical example and are not necessary for the Cloudflare side of things.</p><p>Let&#39;s start with Portainer</p><div data-language="shell"><pre data-linenumber="true"><code><p><span>1</span><span>docker run -d -p </span><span>8000</span><span>:8000 -p </span><span>9443</span><span>:9443 --name portainer </span><span>\</span><span></span></p><p><span>2</span><span>    --restart</span><span>=</span><span>always </span><span>\</span><span></span></p><p><span>3</span><span>    -v /var/run/docker.sock:/var/run/docker.sock </span><span>\</span><span></span></p><p><span>4</span><span>    -v portainer_data:/data </span><span>\</span><span></span></p><p><span>5</span><span>    portainer/portainer-ce:latest</span></p></code></pre></div><p>You can go to http://<!-- -->[your-machine-ip]<!-- -->:9443 and finish the Portainer setup on your own (and follow the <a href="https://docs.portainer.io/v/ce-2.9/start/install/server/docker/linux">official guide</a> if needed)</p><p>If you did everything right, your Portainer dashboard should look like this (without the two other containers at this moment):
<span>
      <span></span>
  <img alt="Portainer" title="Portainer" src="https://erdaltoprak.com/static/aac49ca2863242694de4df857ace333e/18e3b/portainer-working-state.jpg" srcset="/static/aac49ca2863242694de4df857ace333e/46946/portainer-working-state.jpg 240w,/static/aac49ca2863242694de4df857ace333e/55489/portainer-working-state.jpg 480w,/static/aac49ca2863242694de4df857ace333e/18e3b/portainer-working-state.jpg 960w,/static/aac49ca2863242694de4df857ace333e/5ebf8/portainer-working-state.jpg 1065w" sizes="(max-width: 960px) 100vw, 960px" loading="lazy" decoding="async"/>
    </span></p><p>Now we can docker compose gluetun and librespeed in one file, please note that I&#39;m using PIA vpn but you can use something else and even skip if needed. This is  just an example of how to route a container through another.</p><div data-language="shell"><pre data-linenumber="true"><code><p><span>1</span><span>mkdir</span><span> gluetunAndLibrespeed</span></p><p><span>2</span><span></span><span>cd</span><span> gluetunAndLibrespeed</span></p><p><span>3</span><span></span><span>touch</span><span> docker-compose.yml</span></p><p><span>4</span><span></span><span>nano</span><span> docker-compose.yml</span></p></code></pre></div><p>And paste the following lines:</p><p><a href="https://github.com/qdm12/gluetun/wiki">The documentation of gluetun is here</a> if you need help for your vpn.</p><div data-language="yml"><pre data-linenumber="true"><code><p><span>1</span><span>---</span><span></span></p><p><span>2</span><span></span><span>version</span><span>:</span><span> </span><span>&#34;2.1&#34;</span><span></span></p><p><span>3</span><span></span><span>services</span><span>:</span><span></span></p><p><span>4</span><span>  </span><span>gluetun</span><span>:</span><span></span></p><p><span>5</span><span>    </span><span>image</span><span>:</span><span> qmcgaw/gluetun</span></p><p><span>6</span><span>    </span><span>container_name</span><span>:</span><span> gluetun</span></p><p><span>7</span><span>    </span><span>cap_add</span><span>:</span><span></span></p><p><span>8</span><span>      </span><span>-</span><span> NET_ADMIN</span></p><p><span>9</span><span>    </span><span>volumes</span><span>:</span><span></span></p><p><span>10</span><span>      </span><span>-</span><span> /home/pi/gluetunAndLibrespeed</span><span>:</span><span>/gluetun</span></p><p><span>11</span><span>    </span><span>environment</span><span>:</span><span></span></p><p><span>12</span><span>      </span><span>-</span><span> VPNSP=private internet access</span></p><p><span>13</span><span>      </span><span>-</span><span> OPENVPN_USER=</span><span>[</span><span>YOUR_USERNAME</span><span>]</span><span></span></p><p><span>14</span><span>      </span><span>-</span><span> OPENVPN_PASSWORD=</span><span>[</span><span>YOUR_PASSWORD</span><span>]</span><span></span></p><p><span>15</span><span>      </span><span>-</span><span> REGION=</span><span>[</span><span>YOUR_REGION</span><span>]</span><span></span></p><p><span>16</span><span>    </span><span>ports</span><span>:</span><span></span></p><p><span>17</span><span>      </span><span>-</span><span> 7777</span><span>:</span><span>80</span><span></span></p><p><span>18</span><span>    </span><span>restart</span><span>:</span><span> unless</span><span>-</span><span>stopped</span></p><p><span>19</span><span>
</span></p><p><span>20</span><span>  </span><span>librespeed</span><span>:</span><span></span></p><p><span>21</span><span>    </span><span>image</span><span>:</span><span> ghcr.io/linuxserver/librespeed</span></p><p><span>22</span><span>    </span><span>container_name</span><span>:</span><span> librespeed</span></p><p><span>23</span><span>    </span><span>environment</span><span>:</span><span></span></p><p><span>24</span><span>      </span><span>-</span><span> PUID=1000</span></p><p><span>25</span><span>      </span><span>-</span><span> PGID=1000</span></p><p><span>26</span><span>      </span><span>-</span><span> TZ=Europe/Paris</span></p><p><span>27</span><span>      </span><span>-</span><span> PASSWORD=PASSWORD</span></p><p><span>28</span><span>    </span><span>volumes</span><span>:</span><span></span></p><p><span>29</span><span>      </span><span>-</span><span> /home/pi/gluetunAndLibrespeed</span><span>:</span><span>/config</span></p><p><span>30</span><span>    </span><span>network_mode</span><span>:</span><span> </span><span>&#34;service:gluetun&#34;</span><span></span></p><p><span>31</span><span>    </span><span>depends_on</span><span>:</span><span></span></p><p><span>32</span><span>      </span><span>-</span><span> gluetun</span></p><p><span>33</span><span>    </span><span>restart</span><span>:</span><span> unless</span><span>-</span><span>stopped</span></p></code></pre></div><p>To get this started, make sure to still be in the folder</p><p>Finally the Cloudflare part!</p><p>Let&#39;s setup Cloudflare teams to configure our access rules and our dashboard</p><p>Go to the <a href="https://dash.teams.cloudflare.com/">Teams area</a>, you should have a configuration page with a teams name selection.
I suggest you spend some time on the Teams dashboard to configure a default policy for your apps (I only use the one-time pin), once your understand the basics (policies, dashboard, etc..) let&#39;s add our first self-hosted application. </p><p><span>
      <span></span>
  <img alt="Cloudflare Self-Hosted Selection" title="Cloudflare Self-Hosted Selection" src="https://erdaltoprak.com/static/79a80892601920508cd3d4eb3bd375d3/7d769/cloudflare-teams-apps.png" srcset="/static/79a80892601920508cd3d4eb3bd375d3/5243c/cloudflare-teams-apps.png 240w,/static/79a80892601920508cd3d4eb3bd375d3/ab158/cloudflare-teams-apps.png 480w,/static/79a80892601920508cd3d4eb3bd375d3/7d769/cloudflare-teams-apps.png 960w,/static/79a80892601920508cd3d4eb3bd375d3/d447e/cloudflare-teams-apps.png 1064w" sizes="(max-width: 960px) 100vw, 960px" loading="lazy" decoding="async"/>
    </span></p><p><span>
      <span></span>
  <img alt="Cloudflare Self-Hosted Application setup" title="Cloudflare Self-Hosted Application setup" src="https://erdaltoprak.com/static/241f2f53e8d5882a8856a8f59d38a412/7d769/cloudflare-application-setup.png" srcset="/static/241f2f53e8d5882a8856a8f59d38a412/5243c/cloudflare-application-setup.png 240w,/static/241f2f53e8d5882a8856a8f59d38a412/ab158/cloudflare-application-setup.png 480w,/static/241f2f53e8d5882a8856a8f59d38a412/7d769/cloudflare-application-setup.png 960w,/static/241f2f53e8d5882a8856a8f59d38a412/87339/cloudflare-application-setup.png 1440w,/static/241f2f53e8d5882a8856a8f59d38a412/88b03/cloudflare-application-setup.png 1920w,/static/241f2f53e8d5882a8856a8f59d38a412/6a78d/cloudflare-application-setup.png 2760w" sizes="(max-width: 960px) 100vw, 960px" loading="lazy" decoding="async"/>
    </span></p><p>Once you are ready to add your first application, just give it a name, then a subdomain (like librespeed.<!-- -->[YOUR_DOMAIN]<!-- -->.tld), choose your domain in the list, then click next to add the policy configuration that you feel comfortable with and you&#39;re pretty much done for the web configuration.</p><p>We can use the tunnel as a service, docker container or standalone like we are doing right now. I&#39;m following (and you should too) the <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/run-tunnel/run-as-service">great documentation provided by Cloudflare</a>.</p><div data-language="shell"><pre data-linenumber="true"><code><p><span>1</span><span>cd</span><span></span></p><p><span>2</span><span></span><span>wget</span><span> https://bin.equinox.io/c/VdrWdbjqyF/cloudflared-stable-linux-arm.tgz</span></p><p><span>3</span><span></span><span>tar</span><span> -xvzf cloudflared-stable-linux-arm.tgz</span></p><p><span>4</span><span></span><span>sudo</span><span> </span><span>cp</span><span> ./cloudflared /usr/local/bin</span></p><p><span>5</span><span></span><span>sudo</span><span> </span><span>chmod</span><span> +x /usr/local/bin/cloudflared</span></p><p><span>6</span><span>cloudflared -v</span></p></code></pre></div><p>Let&#39;s authenticate</p><div data-language="shell"><pre data-linenumber="true"><code><p><span>1</span><span>cloudflared tunnel login</span></p></code></pre></div><p>Once this is done, you should have choosen a hostname (like &#34;pi&#34;) and we will use that for the creation of our tunnels.
If I want to expose my librespeed container, I will create the tunnel</p><div data-language="shell"><pre data-linenumber="true"><code><p><span>1</span><span>cloudflared tunnel create pi librespeed.</span><span>[</span><span>YOUR_DOMAIN</span><span>]</span><span>.tld</span></p></code></pre></div><p>Finally you modify the configuration file the .cloudflared directory and it should look like this:</p><div data-language="markdown"><pre data-linenumber="true"><code><p><span>1</span><span>#</span><span> url: http://localhost:9000</span><span></span></p><p><span>2</span><span>tunnel: XXXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXX</span></p><p><span>3</span><span>credentials-file: /home/pi/.cloudflared/XXXXXXXXXXXXXXXXXXX.json</span></p><p><span>4</span><span>
</span></p><p><span>5</span><span>ingress:</span></p><p><span>6</span><span></span><span>-</span><span> hostname: librespeed.[YOUR_DOMAIN].tld</span></p><p><span>7</span><span>  service: http://localhost:7777</span></p><p><span>8</span><span></span><span>-</span><span> service: http_status:404</span></p></code></pre></div><p>Congratulations, go to <!-- -->[YOUR_NAME]<!-- -->.cloudflareaccess.com and that&#39;s it, I will include a few screenshots of how it looks like in the browser.</p><p><span>
      <span></span>
  <img alt="Teams url access" title="Teams url access" src="https://erdaltoprak.com/static/6b741821a671c8a499303e761ad390ae/7d769/teams-url-access.png" srcset="/static/6b741821a671c8a499303e761ad390ae/5243c/teams-url-access.png 240w,/static/6b741821a671c8a499303e761ad390ae/ab158/teams-url-access.png 480w,/static/6b741821a671c8a499303e761ad390ae/7d769/teams-url-access.png 960w,/static/6b741821a671c8a499303e761ad390ae/87339/teams-url-access.png 1440w,/static/6b741821a671c8a499303e761ad390ae/88b03/teams-url-access.png 1920w,/static/6b741821a671c8a499303e761ad390ae/96ad1/teams-url-access.png 3584w" sizes="(max-width: 960px) 100vw, 960px" loading="lazy" decoding="async"/>
    </span></p><p><span>
      <span></span>
  <img alt="Teams pin code" title="Teams pin code" src="https://erdaltoprak.com/static/5ca6001a47a8c0bcb2c62b523421420a/7d769/teams-pin-code.png" srcset="/static/5ca6001a47a8c0bcb2c62b523421420a/5243c/teams-pin-code.png 240w,/static/5ca6001a47a8c0bcb2c62b523421420a/ab158/teams-pin-code.png 480w,/static/5ca6001a47a8c0bcb2c62b523421420a/7d769/teams-pin-code.png 960w,/static/5ca6001a47a8c0bcb2c62b523421420a/87339/teams-pin-code.png 1440w,/static/5ca6001a47a8c0bcb2c62b523421420a/88b03/teams-pin-code.png 1920w,/static/5ca6001a47a8c0bcb2c62b523421420a/96ad1/teams-pin-code.png 3584w" sizes="(max-width: 960px) 100vw, 960px" loading="lazy" decoding="async"/>
    </span></p><p><span>
      <span></span>
  <img alt="Teams dashboard" title="Teams dashboard" src="https://erdaltoprak.com/static/8889702ca6131a35c6749ec673c3c4f8/7d769/teams-dashboard.png" srcset="/static/8889702ca6131a35c6749ec673c3c4f8/5243c/teams-dashboard.png 240w,/static/8889702ca6131a35c6749ec673c3c4f8/ab158/teams-dashboard.png 480w,/static/8889702ca6131a35c6749ec673c3c4f8/7d769/teams-dashboard.png 960w,/static/8889702ca6131a35c6749ec673c3c4f8/87339/teams-dashboard.png 1440w,/static/8889702ca6131a35c6749ec673c3c4f8/88b03/teams-dashboard.png 1920w,/static/8889702ca6131a35c6749ec673c3c4f8/96ad1/teams-dashboard.png 3584w" sizes="(max-width: 960px) 100vw, 960px" loading="lazy" decoding="async"/>
    </span></p><p><span>
      <span></span>
  <img alt="Teams librespeed app" title="Teams librespeed app" src="https://erdaltoprak.com/static/3cd9cdd0ad69680a72db50cc28314466/7d769/teams-librespeed.png" srcset="/static/3cd9cdd0ad69680a72db50cc28314466/5243c/teams-librespeed.png 240w,/static/3cd9cdd0ad69680a72db50cc28314466/ab158/teams-librespeed.png 480w,/static/3cd9cdd0ad69680a72db50cc28314466/7d769/teams-librespeed.png 960w,/static/3cd9cdd0ad69680a72db50cc28314466/87339/teams-librespeed.png 1440w,/static/3cd9cdd0ad69680a72db50cc28314466/88b03/teams-librespeed.png 1920w,/static/3cd9cdd0ad69680a72db50cc28314466/96ad1/teams-librespeed.png 3584w" sizes="(max-width: 960px) 100vw, 960px" loading="lazy" decoding="async"/>
    </span></p><p>If you enjoyed this guide you can also check the previous one about <a href="https://erdaltoprak.com/icloud-custom-domain-guide">iCloud custom domains</a>.</p></section></div>
  </body>
</html>
