<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://decoded.avast.io/davidalvarez/linux-threat-hunting-syslogk-a-kernel-rootkit-found-under-development-in-the-wild/">Original</a>
    <h1>Linux Threat Hunting: ‘Syslogk’ a kernel rootkit found in the wild</h1>
    
    <div id="readability-page-1" class="page"><article id="post-5922">

                    
                    
                    
                    <div>
                        




<p>Rootkits are dangerous pieces of malware. Once in place, they are usually really hard to detect. Their code is typically more challenging to write than other malware, so developers resort to code reuse from open source projects. As rootkits are very interesting to analyze, we are always looking out for these kinds of samples in the wild.</p>



<p><a href="https://github.com/yaoyumeng/adore-ng" target="_blank" rel="noreferrer noopener">Adore-Ng</a> is a relatively old, open-source, well-known kernel rootkit for Linux, which initially targeted kernel 2.x but is currently updated to target kernel 3.x. It enables hiding processes, files, and even the kernel module, making it harder to detect. It also allows authenticated user-mode processes to interact with the rootkit to control it, allowing the attacker to hide many custom malicious artifacts by using a single rootkit.</p>



<p>In<code> early 2022</code>, we were analyzing a rootkit mostly based on <code>Adore-Ng</code> that we found in the wild, apparently under development. After obtaining the sample, we examined the <code>.modinfo</code> section and noticed it is compiled for a specific kernel version.</p>


<div>
<figure><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image.png"><img loading="lazy" width="798" height="94" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image.png" alt="" srcset="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image.png 798w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image-300x35.png 300w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image-768x90.png 768w" sizes="(max-width: 798px) 100vw, 798px"/></a></figure></div>


<p>As you may know, even if it is possible to ‘force load’ the module into the kernel by using the <code>--force</code> flag of the <a href="https://man7.org/linux/man-pages/man8/insmod.8.html" target="_blank" rel="noreferrer noopener">insmod</a> Linux command, this operation can fail if the required symbols are not found in the kernel; this can often lead to a system crash.</p>



<figure><p data-align="center"><code>insmod -f {module}</code></p></figure>



<p>We discovered that the kernel module could be successfully loaded without forcing into a default <a href="https://www.linuxvmimages.com/images/centos-6/" target="_blank" rel="noreferrer noopener">Centos 6.10</a> distribution, as the rootkit we found is compiled for a similar kernel version.</p>



<p>While looking at the file’s strings, we quickly identified the <code>PgSD93ql</code> hardcoded file name in the kernel rootkit to reference the payload. This payload file name is likely used to make it less obvious for the sysadmin, for instance, it can look like a legitimate <a href="https://www.postgresql.org/" target="_blank" rel="noreferrer noopener">PostgreSQL</a> file.</p>


<div>
<figure><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image3.png"><img loading="lazy" width="536" height="94" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image3.png" alt="" srcset="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image3.png 536w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image3-300x53.png 300w" sizes="(max-width: 536px) 100vw, 536px"/></a></figure></div>


<p>Using this hardcoded file name, we extracted the file hidden by the rootkit. It is a compiled backdoor trojan written in C programming language; Avast’s antivirus engine detects and classifies this file as <code>ELF:Rekoob</code> – which is widely known as the <a href="https://malpedia.caad.fkie.fraunhofer.de/details/elf.rekoobe" target="_blank" rel="noreferrer noopener">Rekoobe</a> malware family. <code>Rekoobe</code> is a piece of code implanted in legitimate servers. In this case it is embedded in a fake SMTP server, which spawns a shell when it receives a specially crafted command. In this post, we refer to this rootkit as <code>Syslogk</code> rootkit, due to how it ‘reveals’ itself when specially crafted data is written to the file <code>/proc/syslogk</code> .</p>







<p>The <code>Syslogk</code> rootkit is heavily based on <code>Adore-Ng</code> but incorporates new functionalities making the user-mode application and the kernel rootkit hard to detect.</p>



<h2>Loading the kernel module</h2>



<p>To load the rootkit into kernel space, it is necessary to approximately match the kernel version used for compiling; it does not have to be strictly the same.</p>



<figure><p data-align="center"><code>vermagic=2.6.32-696.23.1.el6.x86_64 SMP mod_unload modversions</code></p></figure>



<p>For example, we were able to load the rootkit without any effort in a <a href="https://www.linuxvmimages.com/images/centos-6/" target="_blank" rel="noreferrer noopener">Centos 6.10</a> virtual machine by using the <a href="https://linux.die.net/man/8/insmod" target="_blank" rel="noreferrer noopener">insmod</a> Linux command.</p>



<p>After loading it, you will notice that the malicious driver does not appear in the list of loaded kernel modules when using the <a href="https://linux.die.net/man/8/lsmod" target="_blank" rel="noreferrer noopener">lsmod</a> command.</p>



<h2>Revealing the rootkit</h2>



<p>The rootkit has a <code>hide_module</code> function which uses the <a href="https://www.kernel.org/doc/html/v5.8/core-api/kernel-api.html#c.list_del" target="_blank" rel="noreferrer noopener">list_del</a> function of the <a href="https://www.kernel.org/doc/html/v5.8/core-api/kernel-api.html" target="_blank" rel="noreferrer noopener">kernel API</a> to remove the module from the linked list of kernel modules. Next, it also accordingly updates its internal <code>module_hidden</code> flag.</p>



<p>Fortunately, the rootkit has a functionality implemented in the <code>proc_write</code> function that exposes an interface in the /proc file system which reveals the rootkit when the value <code>1</code> is written into the file <em><code>/proc/syslogk</code></em>.</p>


<div>
<figure><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image8.png"><img loading="lazy" width="446" height="172" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image8.png" alt="" srcset="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image8.png 446w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image8-300x116.png 300w" sizes="(max-width: 446px) 100vw, 446px"/></a></figure></div>


<p>Once the rootkit is revealed, it is possible to remove it from memory using the <a href="https://linux.die.net/man/8/rmmod" target="_blank" rel="noreferrer noopener">rmmod</a> Linux command. The <a href="#files">Files section</a> of this post has additional details that will be useful for programmatically uncloaking the rootkit.</p>



<h2>Overview of the Syslogk rootkit features</h2>



<p>Apart from hiding itself, making itself harder to detect when implanted, <code>Syslogk</code> can completely hide the malicious payload by taking the following actions:</p>



<ul><li>The <code>hk_proc_readdir</code> function of the rootkit hides directories containing malicious files, effectively hiding them from the operating system.</li><li>The malicious processes are hidden via <code>hk_getpr</code> – a mix of Adore-Ng functions for hiding processes.</li><li>The malicious payload is hidden from tools like <code>Netstat</code>; when running, it will not appear in the list of services. For this purpose, the rootkit uses the function <code>hk_t4_seq_show</code>.</li><li>The malicious payload is not continuously running. The attacker remotely executes it on demand when a specially crafted TCP packet (details below) is sent to the infected machine, which inspects the traffic by installing a <code>netfilter hook</code>.</li><li>It is also possible for the attacker to remotely stop the payload. This requires using a <code>hardcoded key</code> in the rootkit and knowledge of some fields of the <code>magic packet</code> used for remotely starting the payload. </li></ul>



<p>We observed that the <code>Syslogk</code> rootkit (and Rekoobe payload) perfectly align when used covertly in conjunction with a fake SMTP server. Consider how stealthy this could be; a backdoor that does not load until some <a href="https://www.drkns.net/kernel-who-does-magic/" target="_blank" rel="noreferrer noopener">magic packets</a> are sent to the machine. When queried, it appears to be a legitimate service hidden in memory, hidden on disk, remotely ‘magically’ executed, hidden on the network. Even if it is found during a network port scan, it still seems to be a legitimate SMTP server.</p>



<p>For compromising the operating system and placing the mentioned hiding functions, <code>Syslogk</code> uses the already known <a href="https://github.com/ksaravan910/FileCloakingRootkit/blob/master/rootkit.c#L64" target="_blank" rel="noreferrer noopener">set_addr_rw</a> and <a href="https://github.com/ksaravan910/FileCloakingRootkit/blob/master/rootkit.c#L81" target="_blank" rel="noreferrer noopener">set_addr_ro</a> rootkit functions, which adds or removes writing permissions to the <code>Page Table Entry</code> (<a href="https://www.kernel.org/doc/gorman/html/understand/understand006.html" target="_blank" rel="noreferrer noopener">PTE</a>) structure.</p>



<p>After adding writing permissions to the PTE, the rootkit can hook the functions declared in the <code>hks</code> internal rootkit structure.</p>



<figure><table><tbody><tr><td>PTE Hooks</td></tr><tr><td>Type of the function</td><td>Offset</td><td>Name of the function</td></tr><tr><td>Original</td><td>hks+(0x38) * 0</td><td>proc_root_readdir</td></tr><tr><td>Hook</td><td>hks+(0x38) * 0 + 0x10</td><td>hk_proc_readdir</td></tr><tr><td>Original</td><td>hks+(0x38) * 1</td><td>tcp4_seq_show</td></tr><tr><td>Hook</td><td>hks+(0x38) * 1 + 0x10</td><td>hk_t4_seq_show</td></tr><tr><td>Original</td><td>hks+(0x38) * 2</td><td>sys_getpriority</td></tr><tr><td>Hook</td><td>hks+(0x38) * 2 + 0x10</td><td>hk_getpr</td></tr></tbody></table></figure>



<p>The mechanism for placing the hooks consists of identifying the hookable kernel symbols via <code>/proc/kallsyms</code> as implemented in the <code>get_symbol_address</code> function of the rootkit (code reused from <a href="https://github.com/milabs/kmod_hooking/blob/master/module-init.c#L237" target="_blank" rel="noreferrer noopener">this repository</a>). After getting the address of the symbol, the <code>Syslogk</code> rootkit uses the <a href="https://github.com/vmt/udis86" target="_blank" rel="noreferrer noopener">udis86</a> project for hooking the function.</p>



<h2>Understanding the directory hiding mechanism</h2>



<p>The Virtual File System (VFS) is an abstraction layer that allows for FS-like operation over something that is typically not a traditional FS. As it is the entry point for all the File System queries, it is a good candidate for the rootkits to hook.</p>



<p>It is not surprising that the Syslogk rootkit hooks the VFS functions for hiding the Rekoobe payload stored in the file<code> /etc/rc-Zobk0jpi/PgSD93ql</code> .</p>



<p>The hook is done by<code> hk_root_readdir</code> which calls to <code>nw_root_filldir</code> where the directory filtering takes place.</p>


<div>
<figure><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image11.png"><img loading="lazy" width="410" height="147" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image11.png" alt="" srcset="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image11.png 410w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image11-300x108.png 300w" sizes="(max-width: 410px) 100vw, 410px"/></a></figure></div>


<p>As you can see, any directory containing the substring <code>-Zobk0jpi</code> will be hidden.</p>



<p>The function <code>hk_get_vfs</code> opens the root of the file system by using <a href="https://www.unix.com/man-page/suse/9/filp_open" target="_blank" rel="noreferrer noopener">filp_open</a>. This kernel function returns a pointer to the structure <a href="https://github.com/torvalds/linux/blob/master/include/linux/fs.h#L956" target="_blank" rel="noreferrer noopener">file</a>, which contains a <code>file_operations</code> structure called <a href="https://github.com/torvalds/linux/blob/master/include/linux/fs.h#L939" target="_blank" rel="noreferrer noopener">f_op</a> that finally stores the <a href="https://man7.org/linux/man-pages/man3/readdir.3.html" target="_blank" rel="noreferrer noopener">readdir</a> function hooked via <code>hk_root_readdir</code>.</p>



<p>Of course, this feature is not new at all. You can check the source code of <code>Adore-Ng</code> and see <a href="https://github.com/yaoyumeng/adore-ng/blob/master/adore-ng.c#L300" target="_blank" rel="noreferrer noopener">how it is implemented</a> on your own.</p>



<h2>Understanding the process hiding mechanism</h2>



<p>In the following screenshot, you can see that the <code>Syslogk</code> rootkit (code at the right margin of the screenshot) is prepared for hiding a process called <code>PgSD93ql</code>. Therefore, the rootkit seems more straightforward than the original version (see Adore-Ng at the left margin of the screenshot). Furthermore, the process to hide can be selected after authenticating with the rootkit.</p>


<div>
<figure><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image10.png"><img loading="lazy" width="1024" height="524" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image10-1024x524.png" alt="" srcset="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image10-1024x524.png 1024w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image10-300x154.png 300w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image10-768x393.png 768w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image10-1536x786.png 1536w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image10.png 1920w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure></div>


<p>The <code>Syslogk</code> rootkit function <code>hk_getpr</code> explained above, is a mix of <a href="https://github.com/yaoyumeng/adore-ng/blob/master/adore-ng.c#L178" target="_blank" rel="noreferrer noopener">adore_find_task</a> and <a href="https://github.com/yaoyumeng/adore-ng/blob/master/adore-ng.c#L193" target="_blank" rel="noreferrer noopener">should_be_hidden</a> functions but it uses the same mechanism for hiding processes.</p>



<h2>Understanding the network traffic hiding mechanism</h2>



<p>The <code>Adore-Ng</code> rootkit allows hiding a given set of listening services from Linux programs like <code>Netstat</code>. It uses the exported <a href="https://github.com/yaoyumeng/adore-ng/blob/522c80a2dc043c2d523256472becc88c90d66337/adore-ng.c#L662" target="_blank" rel="noreferrer noopener">proc_net</a> structure to <a href="https://github.com/yaoyumeng/adore-ng/blob/522c80a2dc043c2d523256472becc88c90d66337/adore-ng.c#L835" target="_blank" rel="noreferrer noopener">change</a> the <a href="https://github.com/torvalds/linux/blob/master/net/ipv4/tcp_ipv4.c#L2695" target="_blank" rel="noreferrer noopener">tcp4_seq_show( )</a> handler, which is invoked by the kernel when <code>Netstat</code> queries for listening connections. Within the <a href="https://github.com/yaoyumeng/adore-ng/blob/master/adore-ng.c#L688" target="_blank" rel="noreferrer noopener">adore_tcp4_seq_show()</a> function, <a href="https://github.com/yaoyumeng/adore-ng/blob/master/adore-ng.c#L697" target="_blank" rel="noreferrer noopener">strnstr( )</a> is used to look in <code>seq-&gt;buf</code> for a substring that contains the hexadecimal representation of the port it is trying to hide. If this is found, the string is deleted.</p>


<div>
<figure><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image6.png"><img loading="lazy" width="1024" height="550" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image6-1024x550.png" alt="" srcset="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image6-1024x550.png 1024w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image6-300x161.png 300w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image6-768x413.png 768w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image6-1536x826.png 1536w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image6.png 1944w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure></div>


<p>In this way, the backdoor will not appear when listing the connections in an infected machine. The following section describes other interesting capabilities of this rootkit.</p>



<h2>Understanding the magic packets</h2>



<p>Instead of continuously running the payload, it is remotely started or stopped on demand by sending specially crafted network traffic packets.</p>



<p>These are known as <code>magic packets</code> because they have a special format and special powers. In this implementation, an attacker can trigger actions without having a listening port in the infected machine such that the commands are, in some way, ‘magically’ executed in the system.</p>



<h3>Starting the Rekoobe payload</h3>



<p>The <code>magic packet</code> inspected by the <code>Syslogk</code><em> </em>rootkit for starting the <code>Rekoobe</code> fake SMTP server is straightforward. First, it checks whether the packet is a TCP packet and, in that case, it also checks the <code>source port</code>, which is expected to be <code>59318</code>.</p>



<p><code>Rekobee</code> will be executed by the rootkit if the magic packet fits the mentioned criteria.</p>


<div>
<figure><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image4.png"><img loading="lazy" width="817" height="569" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image4.png" alt="" srcset="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image4.png 817w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image4-300x209.png 300w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image4-768x535.png 768w" sizes="(max-width: 817px) 100vw, 817px"/></a></figure></div>


<p>Of course, before executing the fake service, the rootkit terminates all existing instances of the program by calling the rootkit function <code>pkill_clone_0</code>. This function contains the hardcoded process name <code>PgSD93ql</code><em>;</em>  it only kills the <code>Rekoobe</code> process by sending the <code>KILL</code> signal via <a href="https://docs.huihoo.com/doxygen/linux/kernel/3.7/kernel_2signal_8c_source.html#l01490" target="_blank" rel="noreferrer noopener">send_sig</a>.</p>



<p>To execute the command that starts the <code>Rekoobe</code> fake service in user mode, the rootkit executes the following command by combining the kernel APIs: <a href="https://www.kernel.org/doc/htmldocs/kernel-api/API-call-usermodehelper-setup.html" target="_blank" rel="noreferrer noopener">call_usermodehelper_setup</a>, <a href="http://www.hep.by/gnu/kernel/kernel-api/API-call-usermodehelper-setfns.html" target="_blank" rel="noreferrer noopener">call_usermodehelper_setfns</a>, and <a href="https://www.kernel.org/doc/htmldocs/kernel-api/API-call-usermodehelper-exec.html" target="_blank" rel="noreferrer noopener">call_usermodehelper_exec</a>.</p>



<figure><p><code>/bin/sh -c /etc/rc-Zobk0jpi/PgSD93ql</code></p></figure>



<p>The <a href="#files">Files section</a> of this post demonstrates how to manually craft (using Python) the TCP <code>magic packet</code> for starting the <code>Rekoobe</code> payload.</p>



<p>In the next section we describe a more complex form of the <code>magic packet</code>.</p>



<h3>Stopping the Rekoobe payload</h3>



<p>Since the attacker doesn’t want any other person in the network to be able to kill <code>Rekoobe</code>, the <code>magic packet</code> for killing <code>Rekoobe</code> must match some fields in the previous <code>magic packet</code> used for starting <code>Rekoobe</code>. Additionally, the packet must satisfy additional requirements – it must contain a key that is hardcoded in the rootkit and located in a variable offset of the <code>magic packet</code><em>. </em>The conditions that are checked:</p>



<ol><li>It checks a flag enabled when the rootkit executes <code>Rekoobe</code> via <code>magic packets</code>. It will only continue if the flag is enabled.</li><li>It checks the <code>Reserved</code> field of the TCP header to see that it is <code>0x08</code>.</li><li>The <code>Source Port</code> must be between <code>63400</code> and <code>63411</code> inclusive.</li><li>Both the <code>Destination Port</code> and the <code>Source Address</code>, must to be the same that were used when sending the <code>magic packet</code> for starting <code>Rekoobe</code>.</li><li>Finally, it looks for the <code>hardcoded key</code>. In this case, it is: <code>D9sd87JMaij</code></li></ol>



<p>The offset of the hardcoded key is also set in the packet and not in a hardcoded offset; it is calculated instead. To be more precise, it is set in the <code>data offset</code> byte (TCP header) such that after shifting the byte <code>4 bits</code> to the right and multiplying it by <code>4</code>, it points to the offset of where the <code>Key</code> is expected to be (as shown in the following screenshot, notice that the rootkit compares the <code>Key</code> in reverse order).</p>


<div>
<figure><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image12.png"><img loading="lazy" width="369" height="154" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image12.png" alt="" srcset="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image12.png 369w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image12-300x125.png 300w" sizes="(max-width: 369px) 100vw, 369px"/></a></figure></div>


<p>In our experiments, we used the value <code>0x50</code> for the <code>data offset</code> (TCP header) because after shifting it 4 bits, you get 5 which multiplied by 4 is equal to <code>20</code>. Since 20 is precisely the size of the TCP Header, by using this value, we were able to put the key at the start of the data section of the packet.</p>



<p>If you are curious about how we implemented this <code>magic packet</code> from scratch, then please see the <a href="#files">Files section</a> of this blog post.</p>







<p>When the infected machine receives the appropriate <code>magic packet</code>, the rootkit starts the hidden <code>Rekoobe</code> malware in user mode space.</p>



<p>It looks like an innocent SMTP server, but there is a backdoor command on it that can be executed when handling the <code>starttls</code> command. In a legitimate service, this command is sent by the client to the server to advise that it wants to start TLS negotiation.</p>


<div>
<figure><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image9.png"><img loading="lazy" width="1024" height="290" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image9-1024x290.png" alt="" srcset="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image9-1024x290.png 1024w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image9-300x85.png 300w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image9-768x218.png 768w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image9.png 1094w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure></div>


<p>For triggering the <code>Rekoobe</code> backdoor command (spawning a shell), the attacker must send the byte <code>0x03</code> via TLS, followed by a <code>Tag Length Value</code> (TLV) encoded data. Here, the tag is the symbol <code>%</code>, the length is specified in four numeric characters, and the value (notice that the length and value are arbitrary but can not be zero).</p>


<div>
<figure><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image5.png"><img loading="lazy" width="1024" height="485" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image5-1024x485.png" alt="" srcset="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image5-1024x485.png 1024w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image5-300x142.png 300w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image5-768x364.png 768w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image5-1536x727.png 1536w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image5.png 1914w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure></div>


<p>Additionally, to establish the TLS connection, you will need the certificate embedded in <code>Rekoobe</code>. </p>



<p>See the <a href="#files">Files section</a> below for the certificate and a Python script we developed to connect with <code>Rekoobe</code>.</p>







<p><code>Rekoobe</code> is clearly based on the <a href="https://github.com/creaktive/tsh/blob/master/tshd.c#L693" target="_blank" rel="noreferrer noopener">TinySHell</a> open source project; this is based on ordering observed in character and variables assignment taking place in the same order multiple times.</p>


<div>
<figure><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image7.png"><img loading="lazy" width="747" height="249" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image7.png" alt="" srcset="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image7.png 747w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image7-300x100.png 300w" sizes="(max-width: 747px) 100vw, 747px"/></a></figure></div>


<p>On the other hand, if you take a look at the <code>Syslogk</code> rootkit, even if it is new, you will notice that there are also references to <code>TinySHell</code> dating back to December 13, 2018.</p>


<div>
<figure><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image2.png"><img loading="lazy" width="537" height="129" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image2.png" alt="" srcset="https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image2.png 537w, https://decoded.avast.io/wp-content/uploads/sites/2/2022/06/image2-300x72.png 300w" sizes="(max-width: 537px) 100vw, 537px"/></a></figure></div>


<p>The evidence suggests that the threat actor developed <code>Rekoobe</code> and <code>Syslogk</code> to run them  together. We are pleased to say that our users are protected and hope that this research assists others.</p>







<p>One of the architectural advantages of security software is that it usually has components running in different privilege levels; malware running on less-privileged levels cannot easily interfere with processes running on higher privilege levels, thus allowing more straightforward dealing with malware.</p>



<p>On the other hand, kernel rootkits can be hard to detect and remove because these pieces of malware run in a privileged layer. This is why it is essential for system administrators and security companies to be aware of this kind of malware and write protections for their users as soon as possible.</p>







<h2>Syslogk sample</h2>



<ul><li><code>68facac60ee0ade1aa8f8f2024787244c2584a1a03d10cda83eeaf1258b371f2</code></li></ul>



<h2>Rekoobe sample</h2>



<ul><li><code>11edf80f2918da818f3862246206b569d5dcebdc2a7ed791663ca3254ede772d</code></li></ul>



<h2>Other Rekoobe samples</h2>



<ul><li><code>fa94282e34901eba45720c4f89a0c820d32840ae49e53de8e75b2d6e78326074</code></li><li><code>fd92e34675e5b0b8bfbc6b1f3a00a7652e67a162f1ea612f6e86cca846df76c5</code></li><li><code>12c1b1e48effe60eef7486b3ae3e458da403cd04c88c88fab7fca84d849ee3f5</code></li><li><code>06778bddd457aafbc93d384f96ead3eb8476dc1bc8a6fbd0cd7a4d3337ddce1e</code></li><li><code>f1a592208723a66fa51ce1bc35cbd6864e24011c6dc3bcd056346428e4e1c55d</code></li><li><code>55dbdb84c40d9dc8c5aaf83226ca00a3395292cc8f884bdc523a44c2fd431c7b</code></li><li><code>df90558a84cfcf80639f32b31aec187b813df556e3c155a05af91dedfd2d7429</code></li><li><code>160cfb90b81f369f5ba929aba0b3130cb38d3c90d629fe91b31fdef176752421</code></li><li><code>b4d0f0d652f907e4e77a9453dcce7810b75e1dc5867deb69bea1e4ecdd02d877</code></li><li><code>3a6f339df95e138a436a4feff64df312975a262fa16b75117521b7d6e7115d65</code></li><li><code>74699b0964a2cbdc2bc2d9ca0b2b6f5828b638de7c73b1d41e7fe26cfc2f3441</code></li><li><code>7a599ff4a58cb0672a1b5e912a57fcdc4b0e2445ec9bc653f7f3e7a7d1dc627f</code></li><li><code>f4e3cfeeb4e10f61049a88527321af8c77d95349caf616e86d7ff4f5ba203e5f</code></li><li><code>31330c0409337592e9de7ac981cecb7f37ce0235f96e459fefbd585e35c11a1a</code></li><li><code>c6d735b7a4656a52f3cd1d24265e4f2a91652f1a775877129b322114c9547deb</code></li><li><code>2e81517ee4172c43a2084be1d584841704b3f602cafc2365de3bcb3d899e4fb8</code></li><li><code>b22f55e476209adb43929077be83481ebda7e804d117d77266b186665e4b1845</code></li><li><code>a93b9333a203e7eed197d0603e78413013bd5d8132109bbef5ef93b36b83957c</code></li><li><code>870d6c202fcc72088ff5d8e71cc0990777a7621851df10ba74d0e07d19174887</code></li><li><code>ca2ee3f30e1c997cc9d8e8f13ec94134cdb378c4eb03232f5ed1df74c0a0a1f0</code></li><li><code>9d2e25ec0208a55fba97ac70b23d3d3753e9b906b4546d1b14d8c92f8d8eb03d</code></li><li><code>29058d4cee84565335eafdf2d4a239afc0a73f1b89d3c2149346a4c6f10f3962</code></li><li><code>7e0b340815351dab035b28b16ca66a2c1c7eaf22edf9ead73d2276fe7d92bab4</code></li><li><code>af9a19f99e0dcd82a31e0c8fc68e89d104ef2039b7288a203f6d2e4f63ae4d5c</code></li><li><code>6f27de574ad79eb24d93beb00e29496d8cfe22529fc8ee5010a820f3865336a9</code></li><li><code>d690d471b513c5d40caef9f1e37c94db20e6492b34ea6a3cddcc22058f842cf3</code></li><li><code>e08e241d6823efedf81d141cc8fd5587e13df08aeda9e1793f754871521da226</code></li><li><code>da641f86f81f6333f2730795de93ad2a25ab279a527b8b9e9122b934a730ab08</code></li><li><code>e3d64a128e9267640f8fc3e6ba5399f75f6f0aca6a8db48bf989fe67a7ee1a71</code></li><li><code>d3e2e002574fb810ac5e456f122c30f232c5899534019d28e0e6822e426ed9d3</code></li><li><code>7b88fa41d6a03aeda120627d3363b739a30fe00008ce8d848c2cbb5b4473d8bc</code></li><li><code>50b73742726b0b7e00856e288e758412c74371ea2f0eaf75b957d73dfb396fd7</code></li><li><code>8b036e5e96ab980df3dca44390d6f447d4ca662a7eddac9f52d172efff4c58f8</code></li><li><code>8b18c1336770fcddc6fe78d9220386bce565f98cc8ada5a90ce69ce3ddf36043</code></li><li><code>f04dc3c62b305cdb4d83d8df2caa2d37feeb0a86fb5a745df416bac62a3b9731</code></li><li><code>72f200e3444bb4e81e58112111482e8175610dc45c6e0c6dcd1d2251bacf7897</code></li><li><code>d129481955f24430247d6cc4af975e4571b5af7c16e36814371575be07e72299</code></li><li><code>6fc03c92dee363dd88e50e89062dd8a22fe88998aff7de723594ec916c348d0a</code></li><li><code>fca2ea3e471a0d612ce50abc8738085f076ad022f70f78c3f8c83d1b2ff7896b</code></li><li><code>2fea3bc88c8142fa299a4ad9169f8879fc76726c71e4b3e06a04d568086d3470</code></li><li><code>178b23e7eded2a671fa396dd0bac5d790bca77ec4b2cf4b464d76509ed12c51a</code></li><li><code>3bff2c5bfc24fc99d925126ec6beb95d395a85bc736a395aaf4719c301cbbfd4</code></li><li><code>14a33415e95d104cf5cf1acaff9586f78f7ec3ffb26efd0683c468edeaf98fd7</code></li><li><code>8bb7842991afe86b97def19f226cb7e0a9f9527a75981f5e24a70444a7299809</code></li><li><code>020a6b7edcff7764f2aac1860142775edef1bc057bedd49b575477105267fc67</code></li><li><code>6711d5d42b54e2d261bb48aa7997fa9191aec059fd081c6f6e496d8db17a372a</code></li><li><code>48671bc6dbc786940ede3a83cc18c2d124d595a47fb20bc40d47ec9d5e8b85dc</code></li><li><code>b0d69e260a44054999baa348748cf4b2d1eaab3dd3385bb6ad5931ff47a920de</code></li><li><code>e1999a3e5a611312e16bb65bb5a880dfedbab8d4d2c0a5d3ed1ed926a3f63e94</code></li><li><code>fa0ea232ab160a652fcbd8d6db8ffa09fd64bcb3228f000434d6a8e340aaf4cb</code></li><li><code>11edf80f2918da818f3862246206b569d5dcebdc2a7ed791663ca3254ede772d</code></li><li><code>73bbabc65f884f89653a156e432788b5541a169036d364c2d769f6053960351f</code></li><li><code>8ec87dee13de3281d55f7d1d3b48115a0f5e4a41bfbef1ea08e496ac529829c8</code></li><li><code>8285ee3115e8c71c24ca3bdce313d3cfadead283c31a116180d4c2611efb610d</code></li><li><code>958bce41371b68706feae0f929a18fa84d4a8a199262c2110a7c1c12d2b1dce2</code></li><li><code>38f357c32f2c5a5e56ea40592e339bac3b0cabd6a903072b9d35093a2ed1cb75</code></li><li><code>bcc3d47940ae280c63b229d21c50d25128b2a15ea42fe8572026f88f32ed0628</code></li><li><code>08a1273ac9d6476e9a9b356b261fdc17352401065e2fc2ad3739e3f82e68705a</code></li><li><code>cf525918cb648c81543d9603ac75bc63332627d0ec070c355a86e3595986cbb3</code></li><li><code>42bc744b22173ff12477e57f85fa58450933e1c4294023334b54373f6f63ee42</code></li><li><code>337674d6349c21d3c66a4245c82cb454fea1c4e9c9d6e3578634804793e3a6d6</code></li><li><code>4effa5035fe6bbafd283ffae544a5e4353eb568770421738b4b0bb835dad573b</code></li><li><code>5b8059ea30c8665d2c36da024a170b31689c4671374b5b9b1a93c7ca47477448</code></li><li><code>bd07a4ccc8fa67e2e80b9c308dec140ca1ae9c027fa03f2828e4b5bdba6c7391</code></li><li><code>bf09a1a7896e05b18c033d2d62f70ea4cac85e2d72dbd8869e12b61571c0327e</code></li><li><code>79916343b93a5a7ac7b7133a26b77b8d7d0471b3204eae78a8e8091bfe19dc8c</code></li><li><code>c32e559568d2f6960bc41ca0560ac8f459947e170339811804011802d2f87d69</code></li><li><code>864c261555fce40d022a68d0b0eadb7ab69da6af52af081fd1d9e3eced4aee46</code></li><li><code>275d63587f3ac511d7cca5ff85af2914e74d8b68edd5a7a8a1609426d5b7f6a9</code></li><li><code>031183e9450ad8283486621c4cdc556e1025127971c15053a3bf202c132fe8f9</code></li></ul>







<h2>Syslogk research tools</h2>



<ul><li><a href="https://github.com/avast/ioc/blob/master/SyslogkRootkit/Research%20Tools/unhide_rootkit.c">unhide_rootkit.c</a></li><li><a href="https://github.com/avast/ioc/blob/master/SyslogkRootkit/Research%20Tools/magic_packet_start_rekoobe.py" target="_blank" rel="noreferrer noopener">magic_packet_start_rekoobe.py</a></li><li><a href="https://github.com/avast/ioc/blob/master/SyslogkRootkit/Research%20Tools/magic_packet_kill_rekoobe.py" target="_blank" rel="noreferrer noopener">magic_packet_kill_rekoobe.py</a></li><li><a href="https://github.com/avast/ioc/blob/master/SyslogkRootkit/Research%20Tools/remove_syslogk_from_memory.sh" target="_blank" rel="noreferrer noopener">remove_syslogk_from_memory.sh</a></li></ul>



<h2>Rekoobe research tool</h2>



<ul><li><a href="https://github.com/avast/ioc/blob/master/SyslogkRootkit/Research%20Tools/rekoobe_backdoor_client.py" target="_blank" rel="noreferrer noopener">rekoobe_backdoor_client.py</a></li><li><a href="https://github.com/avast/ioc/blob/master/SyslogkRootkit/Research%20Tools/cert.pem" target="_blank" rel="noreferrer noopener">cert.pem</a></li></ul>







<p>The Syslogk and Rekoobe rootkit research tools and IoCs are in our <a href="https://github.com/avast/ioc/tree/master/SyslogkRootkit" target="_blank" rel="noreferrer noopener">IoC repository</a>.</p>
                                            </div>

                </article></div>
  </body>
</html>
