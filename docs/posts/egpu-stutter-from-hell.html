<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://idea.popcount.org/2022-09-05-egpu-stutter-from-hell">Original</a>
    <h1>eGPU stutter from hell</h1>
    
    <div id="readability-page-1" class="page"><article>


<p>05 September 2022</p>


<p>I was able to put my hands on an HTC Vive VR headset. Sadly, my
computers don&#39;t have a strong enough GPU for VR.</p>
<p>Since I only have laptops I decided to secure an eGPU (external GPU) -
a box with PCIe bus, connected over thunderbolt, which can house a
proper big graphics card. I got
<a href="https://www.razer.com/eu-en/gaming-egpus/razer-core-x">Razer Core X</a>. Together
with the laptop, the setup looks like this:</p>
<div><p><img src="https://idea.popcount.org/laptop_egpu.jpeg"/></p><p><small>Laptop with Razer Core X eGPU - connected with thunderbolt</small></p></div>

<p>And the Vive Headset like that - not that you haven&#39;t seen one before:</p>
<div><p><img src="https://idea.popcount.org/vive.jpeg"/></p><p><small>Good old HTC Vive headset</small></p></div>

<p>I stuffed an Nvidia 3080 into the eGPU, launched Windows and expected
to kill some aliens, zombies, drones, or at least slash red and blue
boxes.</p>
<p>Sadly, while Nvidia 3080 in the eGPU was working just fine, the games
were unplayable due to stutter. Every now and then the headset would
just freeze for a good fraction of a second. In VR this kind of
rendering issue is unacceptable.</p>
<p>There isn&#39;t a good way to visualize this, having frozen image when
moving the head is nauseous, confusing and frankly dangerous. Here&#39;s a
Steam VR &#34;Frame Timing&#34; chart. All the spikes in the bottom chart
indicate trouble - frames not being delivered on time. As you can see
this stutter causes a large number subsequent of frames to be
delayed. Note that it looks somewhat regular.</p>
<div><p><img src="https://idea.popcount.org/timing-bad.png"/></p><p><small>Stutter on Frame Timing from Steam VR</small></p></div>

<p>I&#39;ll save you the grueling debugging story. You have to believe me it
took me a lot of effort to understand the issue.</p>
<p>The issue, as far as I understand it, is rooted in a technology called
&#34;Nvidia Optimus&#34;. You see, modern laptops sometimes have two graphics
cards. The power-efficient integrated GPU (iGPU) - like Intel UHD, and
performance discrete graphics (dGPU) - Nvidia Quadro in my case.</p>
<p>Windows wants to utilize appropriate GPU depending on many
circumstances. For example, when on battery, using iGPU might be
preferred. When rendering harder graphics, dGPU might be a better
choice. It&#39;s a constant performance vs power struggle. Nvidia optimus
is a marketing name for a piece of software that inspects the system
and decides on whether dGPU should be powered off.</p>
<p>Things change when eGPU is connected - in my case it was also Nvidia,
which can be a contributing factor. In such case, the embedded
discrete GPU is not used - rightfully so. All complex graphics is
rendered on eGPU. However, Nvidia Optimus keeps on running and checking
on the dGPU.</p>
<p>My understanding is: Nvidia Optimus polls graphics cards, and this
regular polling causes the stutter. It seems to interfere with smooth
eGPU rendering. Maybe there is a shared mutex somewhere in NVidia
driver.</p>
<p>I don&#39;t know how to disable Nvidia Optimus, but I&#39;m aware of three
ways to work around the stuttering problem.</p>
<h2 id="solution-1-render-on-dgpu">Solution 1 - render on dGPU</h2>
<p>The whole idea is to do something with the dGPU in order to keep it
from idling. No idle dGPU - no stutter on eGPU. One way is to:</p>
<ul>
<li>disconnect eGPU (there is a software &#34;disconnect GPU&#34; button in nvidia panel)</li>
<li>run something that requires dGPU</li>
<li>connect eGPU</li>
<li>observe that the workload remains on dGPU and it remains active</li>
</ul>
<p>For example
<a href="https://www.3dgep.com/learning-directx-12-1/">this page contains some random Directx tutorial</a>. Look
for &#34;tutorial1.exe&#34; file.</p>
<div><p><img src="https://idea.popcount.org/dx-tut.png"/></p><p><small>Once started, tutorial1.exe keeps on running on dGPU</small></p></div>

<p>After enabling eGPU, the workload remains on the dGPU as can be seen
in Task Manager:</p>
<div><p><img src="https://idea.popcount.org/task-manager.png"/></p><p><small>Task manager shows dGPU being used</small></p></div>

<p>If the dGPU (Nvidia Quadro in my case) is using more than 0%, the
stutter won&#39;t occur.</p>
<p>For completeness, in past it was possible to run OpenGL on specific
GPU. For example
<a href="http://www.sulaco.co.za/opengl.htm">tutorials from here</a> could be &#34;Rendered on&#34;
like this:</p>
<div><p><img src="https://idea.popcount.org/opengl.png"/></p><p><small>OpenGL &#34;render on&#34; used to work</small></p></div>

<p>Sadly, this stopped working for me. Even with dGPU chosen from this
menu, it doesn&#39;t seem to work and the Task Manager shows iGPU being
used. Oh well.</p>
<h2 id="solution-2-keep-dgpu-busy">Solution 2 - keep dGPU busy</h2>
<p>It&#39;s possible to keep dGPU busy with other tricks. For example, on
certain laptops, external HDMI / DisplayPort ports are connected to
dGPU. That means, with external display present, the dGPU <em>must</em> be
engaged, which can keep Nvidia Optimus from causing the stutter. If
connecting display is not sufficient, than moving GPU-heavy workload
- like a browser - to secondary screen might do the job.</p>
<p>Finally, there is a tool called
<a href="https://github.com/jobeid/TrayPwrD3">TrayPwrD3</a>, which is doing
exactly that. Sadly, it&#39;s not supporting the case of three GPUs -
iGPU, dGPU and eGPU, but maybe this can be added in the future.</p>
<h2 id="solution-3-disable-dgpu">Solution 3 - disable dGPU</h2>
<p>Finally, there is a hardcore option - just disable dGPU in Device
Manager.</p>
<div><p><img src="https://idea.popcount.org/device-manager.png"/></p><p><small>Disable dGPU in device manager</small></p></div>

<p>I <em>think</em> I tried this without success in past, but hey: it totally
works as of September 2022.</p>
<h2 id="stutter-fixed">Stutter fixed</h2>
<p>I&#39;m using the &#34;solution 3&#34; most often. With it, the stutter problem
went away:</p>
<div><p><img src="https://idea.popcount.org/timing-good.png"/></p><p><small>Fixed frame Timing from Steam VR</small></p></div>

<p>If you look carefully at the bottom chart, you might notice a single
delayed/dropped frame once in a while. While I&#39;m not too scientific
about this, disabling dynamicticks seem to have fixed that minor issue
for me. Run cmd as Administrator:</p>
<div><pre><span>bcdedit</span><span>/</span><span>set</span> <span>disabledynamictick</span> <span>yes</span>
</pre></div>


<p>Ther was one more thing.</p>
<p>Once I had a case of a subpar quality HDMI cable, which resulted
totally terrible flicker. Here&#39;s how it looked:</p>
<div><p><video height="364" controls=""><source src="flicker.mp4" type="video/mp4"/>
Your browser does not support the video tag.</video>
</p><p><small>Flicker caused by bad HDMI cable</small></p></div>

<p>It took me a while to debug it. On first glance it looked like a
software problem - the image seemed half-rendered, with some white
noise patches. Anyhow, replacing the HDMI cable fixed it.</p>





</article></div>
  </body>
</html>
