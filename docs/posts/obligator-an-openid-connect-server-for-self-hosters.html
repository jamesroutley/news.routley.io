<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/anderspitman/obligator">Original</a>
    <h1>Show HN: Obligator – An OpenID Connect server for self-hosters</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">This is currently pre-release beta software. I don&#39;t recommend using it in
production at the moment. It has not yet undergone any sort of official
security review, and I am not a security expert. The plan is to arrange for a
security review before reaching 1.0.</p>
<p dir="auto">That said, testing and feedback (especially with respect to security) would be
greatly appreciated.</p>

<p dir="auto">obligator is a relatively simple and opinionated OpenID Connect (OIDC) Provider
(OP) server designed for self-hosters.</p>

<p dir="auto">There are lots of great open source OIDC servers out there (see
<a href="#comparison-is-the-thief-of-joy">comparison</a>). I made obligator because I
needed a specific combination of features I didn&#39;t find in any of the others.
Here&#39;s a brief list. See the <a href="#feature-explanation">feature explanation</a>
section for more detailed information.</p>
<ul dir="auto">
<li>Simple to deploy and manage. Static executable and either flat-file or sqlite
storage</li>
<li>Support for anonymous OAuth2 clients</li>
<li>Authenticate to multiple domains at once</li>
<li>Passwordless email login</li>
<li>Configurable at runtime with an API</li>
<li>Support for <a href="https://doc.traefik.io/traefik/middlewares/http/forwardauth/" rel="nofollow">forward auth</a></li>
<li>Support for <a href="https://www.authelia.com/integration/trusted-header-sso/introduction/" rel="nofollow">trusted headers</a></li>
<li>Support for upstream social login providers (GitLab, GitHub, Google, etc)</li>
</ul>

<p dir="auto">The overarching philosophy of obligator is that identities are built on email.
Email isn&#39;t perfect, but it&#39;s the globally unique federated identity we have
that works today.</p>
<p dir="auto">Thus the purpose of obligator is to validate that a user controls an email
address as simply as possible, and communicate that to the application the
user is attempting to log in to. Validation can either be done directly
through SMTP, or delegated to upstream OIDC (and some plain OAuth2) providers.</p>

<p dir="auto">Here&#39;s a fairly complete JSON storage file (<code>obligator_storage.json</code>). Note
that I call it &#34;storage&#34; and not &#34;config&#34; because it&#39;s not static, and more
like a simple database. obligator will update it at runtime if new values are
provided through the API.</p>
<div dir="auto" data-snippet-clipboard-copy-content="{
  &#34;root_uri&#34;: &#34;https://example.com&#34;,
  &#34;login_key_name&#34;: &#34;obligator_login_key&#34;,
  &#34;oauth2_providers&#34;: [
    {
      &#34;id&#34;: &#34;google&#34;,
      &#34;name&#34;: &#34;Google&#34;,
      &#34;uri&#34;: &#34;https://accounts.google.com&#34;,
      &#34;client_id&#34;: &#34;&lt;google oauth2 client_id&gt;&#34;,
      &#34;client_secret&#34;: &#34;&lt;google oauth2 client_secret&gt;&#34;,
      &#34;openid_connect&#34;: true
    },
    {
      &#34;id&#34;: &#34;lastlogin&#34;,
      &#34;name&#34;: &#34;LastLogin.io&#34;,
      &#34;uri&#34;: &#34;https://lastlogin.io&#34;,
      &#34;client_id&#34;: &#34;https://example.com&#34;,
      &#34;client_secret&#34;: &#34;&#34;,
      &#34;openid_connect&#34;: true
    }
  ],
  &#34;smtp&#34;: {
    &#34;server&#34;: &#34;smtp.fastmail.com&#34;,
    &#34;username&#34;: &#34;&lt;smtp-username&gt;&#34;,
    &#34;password&#34;: &#34;&lt;smtp-password&gt;&#34;,
    &#34;port&#34;: 587,
    &#34;sender&#34;: &#34;auth@example.com&#34;,
    &#34;sender_name&#34;: &#34;Example&#34;
  },
  &#34;jwks&#34;: &#34;&lt;generated at first startup if empty&gt;&#34;,
  &#34;users&#34;: [
    {
      &#34;email&#34;: &#34;user1@example.com&#34;
    },
    {
      &#34;email&#34;: &#34;user2@example.com&#34;
    }
  ],
  &#34;public&#34;: false
}"><pre>{
  <span>&#34;root_uri&#34;</span>: <span><span>&#34;</span>https://example.com<span>&#34;</span></span>,
  <span>&#34;login_key_name&#34;</span>: <span><span>&#34;</span>obligator_login_key<span>&#34;</span></span>,
  <span>&#34;oauth2_providers&#34;</span>: [
    {
      <span>&#34;id&#34;</span>: <span><span>&#34;</span>google<span>&#34;</span></span>,
      <span>&#34;name&#34;</span>: <span><span>&#34;</span>Google<span>&#34;</span></span>,
      <span>&#34;uri&#34;</span>: <span><span>&#34;</span>https://accounts.google.com<span>&#34;</span></span>,
      <span>&#34;client_id&#34;</span>: <span><span>&#34;</span>&lt;google oauth2 client_id&gt;<span>&#34;</span></span>,
      <span>&#34;client_secret&#34;</span>: <span><span>&#34;</span>&lt;google oauth2 client_secret&gt;<span>&#34;</span></span>,
      <span>&#34;openid_connect&#34;</span>: <span>true</span>
    },
    {
      <span>&#34;id&#34;</span>: <span><span>&#34;</span>lastlogin<span>&#34;</span></span>,
      <span>&#34;name&#34;</span>: <span><span>&#34;</span>LastLogin.io<span>&#34;</span></span>,
      <span>&#34;uri&#34;</span>: <span><span>&#34;</span>https://lastlogin.io<span>&#34;</span></span>,
      <span>&#34;client_id&#34;</span>: <span><span>&#34;</span>https://example.com<span>&#34;</span></span>,
      <span>&#34;client_secret&#34;</span>: <span><span>&#34;</span><span>&#34;</span></span>,
      <span>&#34;openid_connect&#34;</span>: <span>true</span>
    }
  ],
  <span>&#34;smtp&#34;</span>: {
    <span>&#34;server&#34;</span>: <span><span>&#34;</span>smtp.fastmail.com<span>&#34;</span></span>,
    <span>&#34;username&#34;</span>: <span><span>&#34;</span>&lt;smtp-username&gt;<span>&#34;</span></span>,
    <span>&#34;password&#34;</span>: <span><span>&#34;</span>&lt;smtp-password&gt;<span>&#34;</span></span>,
    <span>&#34;port&#34;</span>: <span>587</span>,
    <span>&#34;sender&#34;</span>: <span><span>&#34;</span>auth@example.com<span>&#34;</span></span>,
    <span>&#34;sender_name&#34;</span>: <span><span>&#34;</span>Example<span>&#34;</span></span>
  },
  <span>&#34;jwks&#34;</span>: <span><span>&#34;</span>&lt;generated at first startup if empty&gt;<span>&#34;</span></span>,
  <span>&#34;users&#34;</span>: [
    {
      <span>&#34;email&#34;</span>: <span><span>&#34;</span>user1@example.com<span>&#34;</span></span>
    },
    {
      <span>&#34;email&#34;</span>: <span><span>&#34;</span>user2@example.com<span>&#34;</span></span>
    }
  ],
  <span>&#34;public&#34;</span>: <span>false</span>
}</pre></div>
<p dir="auto">If you&#39;re already using docker, it&#39;s the easiest way to get started with
obligator:</p>
<div data-snippet-clipboard-copy-content="mkdir obligator_docker/
cp obligator_storage.json obligator_docker/

docker run --user $(id -u):$(id -g) --rm -it -v $PWD/obligator_docker:/data -v $PWD/obligator_docker:/api -p 1616:1616 anderspitman/obligator:latest -storage-dir /data -api-socket-dir /api -root-uri example.com -port 1616"><pre><code>mkdir obligator_docker/
cp obligator_storage.json obligator_docker/

docker run --user $(id -u):$(id -g) --rm -it -v $PWD/obligator_docker:/data -v $PWD/obligator_docker:/api -p 1616:1616 anderspitman/obligator:latest -storage-dir /data -api-socket-dir /api -root-uri example.com -port 1616
</code></pre></div>
<p dir="auto">You can also download static executables for various platforms from the
<a href="https://github.com/anderspitman/obligator/releases">releases</a> page.</p>

<p dir="auto">Currently the API is only offered through unix sockets. This reduces the
chance that it accidentally gets exposed, which is important because
it&#39;s not authenticated in any way.</p>
<p dir="auto">There&#39;s not any documentation, and the API is in flux, so refer to the
<a href="https://github.com/anderspitman/obligator/blob/master/api.go">source code</a> for usage.</p>
<p dir="auto">Here&#39;s an example assuming you ran the docker command above:</p>
<div data-snippet-clipboard-copy-content="curl --unix obligator_docker/obligator_api.sock dummy-domain/oauth2-providers"><pre><code>curl --unix obligator_docker/obligator_api.sock dummy-domain/oauth2-providers
</code></pre></div>
<p dir="auto">See <a href="https://superuser.com/q/834307" rel="nofollow">here</a> for more info on using curl over unix sockets.</p>

<h2 tabindex="-1" id="user-content-anonymous-oauth2-clients" dir="auto"><a href="#anonymous-oauth2-clients">Anonymous OAuth2 clients<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">Normally in OAuth2 (and therefore OIDC), an app (client) is required to
pre-register with the provider. This can create a lot of friction, especially
if you&#39;re self-hosting an open source application. App developers are forced to
either share a single client ID for all their users (and share their
<code>client secret</code>, which essentially makes it pointless), or each user must
separately register their instance.</p>
<p dir="auto">Instead, obligator takes essentially the approach described <a href="https://aaronparecki.com/2018/07/07/7/oauth-for-the-open-web" rel="nofollow">here</a>. Any
OAuth2 client can anonymously authenticate with an obligator instance, with the
<code>client_id</code> equal to the domain of the client, and <code>client_secret</code> left blank.
Security is maintained through the following means:</p>
<ul dir="auto">
<li>Only approved email addresses are permitted unless <code>public: true</code> is set in
the config.</li>
<li>The <code>client_id</code> URI must be a prefix of the <code>redirect_uri</code>, and the
<code>client_id</code> is displayed to the user when consenting to the login. This
guarantees that the user approves the ID token to be sent to the domain
shown. Note that this can actually be more secure than pre-registration.
There have been attacks in <a href="https://duo.com/blog/gmail-oauth-phishing-goes-viral" rel="nofollow">the past</a> where users were tricked into
authorizing apps because the pre-registered information looked convincing. By
forcing the user to decide whether they trust the actual domain where the ID
token will be sent, and not displaying any sort of logo which can be faked,
security is improved.</li>
</ul>
<h2 tabindex="-1" id="user-content-multi-domain-authentication" dir="auto"><a href="#multi-domain-authentication">Multi-domain authentication<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">Have you ever noticed when you login to Gmail on a new computer that you&#39;re
also automatically logged in to YouTube? How does this work when Gmail is on
google.com and youtube.com doesn&#39;t have any access to the cookies or
localstorage of google.com?</p>
<p dir="auto">The <a href="https://stackoverflow.com/a/19929304/943814" rel="nofollow">answer</a> is that when you log in on accounts.google.com, it makes a
quick redirect to youtube.com with a URL parameter to also set up the cookies
there. I also want this functionality for all the domains protected by my OIDC
server so I&#39;m building it into obligator.</p>
<h2 tabindex="-1" id="user-content-passwordless-email-login" dir="auto"><a href="#passwordless-email-login">Passwordless email login<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">In line with the philosophy above, email reigns supreme in obligator. Since
passwords are relatively difficult to use securely, the way to add an email
identity is to send a confirmation code to the email address.</p>

<p dir="auto">There&#39;s a public instance of obligator running at <a href="https://lastlogin.io" rel="nofollow">https://lastlogin.io</a>
(discovery doc at <a href="https://lastlogin.io/.well-known/openid-configuration" rel="nofollow">https://lastlogin.io/.well-known/openid-configuration</a>). You
can use it with any OIDC client. Just set the <code>client_id</code> to a prefix of the
<code>redirect_uri</code> when making the authorization request. I like to use
<a href="https://openidconnect.net/" rel="nofollow">https://openidconnect.net/</a> for ad-hoc testing. The official <a href="https://www.certification.openid.net/login.html" rel="nofollow">OpenID conformance
suite</a> is also excellent.</p>

<p dir="auto">Software is rarely about right vs wrong, but rather tradeoffs. This table is
intended to help compare tradeoffs of different servers. It&#39;s also very
incomplete and probably incorrect in many cases. If you have a correction,
please submit an issue or leave a comment on the Google sheet <a href="https://docs.google.com/spreadsheets/d/16Ya5KsmEpczTmoTk5J-1e2MOyuUqXIiPuj7rPfPrHAI/edit?usp=sharing" rel="nofollow">here</a> which
is where it&#39;s generated from.</p>
<table>
<thead>
<tr>
<th></th>
<th><a href="https://github.com/anderspitman/obligator">obligator</a></th>
<th><a href="https://www.authelia.com/" rel="nofollow">Authelia</a></th>
<th><a href="https://goauthentik.io/" rel="nofollow">Authentik</a></th>
<th><a href="https://www.keycloak.org/" rel="nofollow">KeyCloak</a></th>
<th><a href="https://github.com/vouch/vouch-proxy">Vouch</a></th>
<th><a href="https://github.com/oauth2-proxy/oauth2-proxy">oauth2-proxy</a></th>
<th><a href="https://dexidp.io/" rel="nofollow">Dex</a></th>
<th><a href="https://www.ory.sh/hydra/" rel="nofollow">Ory Hydra</a></th>
<th><a href="https://zitadel.com/" rel="nofollow">Zitadel</a></th>
<th><a href="https://casdoor.org/" rel="nofollow">Casdoor</a></th>
</tr>
</thead>
<tbody>
<tr>
<td>Simple</td>
<td>✅</td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
<td>❓</td>
<td>❓</td>
<td>❓</td>
<td>❌</td>
<td>❓</td>
<td>❓</td>
</tr>
<tr>
<td>Anonymous clients</td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
</tr>
<tr>
<td>Multi-domain auth</td>
<td>✅ (planned)</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>❓</td>
<td>❓</td>
<td>❓</td>
<td>❓</td>
</tr>
<tr>
<td>Passwordless email login</td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>❓</td>
</tr>
<tr>
<td>HTTP API</td>
<td>✅</td>
<td>❌</td>
<td>✅</td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
<td>✅</td>
<td>❓</td>
<td>❓</td>
<td>❓</td>
</tr>
<tr>
<td>Forward auth</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>❓</td>
<td>❌</td>
<td>❓</td>
<td>❓</td>
</tr>
<tr>
<td>Trusted header auth</td>
<td>✅ (planned)</td>
<td>✅</td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>❓</td>
<td>❓</td>
<td>❓</td>
<td>❓</td>
</tr>
<tr>
<td>Upstream OIDC/OAuth2</td>
<td>✅</td>
<td>❌</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>❓</td>
<td>❓</td>
<td>❓</td>
</tr>
<tr>
<td>SAML</td>
<td>❌</td>
<td>❌</td>
<td>✅</td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
<td>✅</td>
<td>❓</td>
<td>❓</td>
<td>❓</td>
</tr>
<tr>
<td>LDAP</td>
<td>❌</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
<td>✅</td>
<td>❓</td>
<td>❓</td>
<td>❓</td>
</tr>
<tr>
<td>MFA</td>
<td>❌</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
<td>❓</td>
<td>❓</td>
<td>❓</td>
<td>❓</td>
</tr>
<tr>
<td>Standalone reverse proxy</td>
<td>❌</td>
<td>❌</td>
<td>✅</td>
<td>✅</td>
<td>❌</td>
<td>✅</td>
<td>❌</td>
<td>❓</td>
<td>❓</td>
<td>❓</td>
</tr>
<tr>
<td>Admin GUI</td>
<td>❌</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
<td>❓</td>
<td>❓</td>
<td>❓</td>
<td>❓</td>
</tr>
<tr>
<td>Language</td>
<td>Go</td>
<td>Go</td>
<td>Python</td>
<td>Java</td>
<td>Go</td>
<td>Go</td>
<td>Go</td>
<td>Go</td>
<td>Go</td>
<td>Go</td>
</tr>
<tr>
<td>Dependencies</td>
<td>1</td>
<td>49</td>
<td>54</td>
<td>❓</td>
<td>16</td>
<td>36</td>
<td>36</td>
<td>58</td>
<td>81</td>
<td>68</td>
</tr>
<tr>
<td>Lines of code</td>
<td>~2500</td>
<td>❓</td>
<td>❓</td>
<td>❓</td>
<td>❓</td>
<td>❓</td>
<td>❓</td>
<td>❓</td>
<td>❓</td>
<td>❓</td>
</tr>
</tbody>
</table>
</article>
          </div></div>
  </body>
</html>
