<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mas-bandwidth.com/creating-a-matchmaker-for-your-multiplayer-game/">Original</a>
    <h1>Creating a matchmaker for your multiplayer game</h1>
    
    <div id="readability-page-1" class="page"><div>
        <p>I&#39;m <a href="https://www.linkedin.com/in/glenn-fiedler-11b735302/?ref=mas-bandwidth.com" rel="noreferrer">Glenn Fiedler</a> and welcome to <strong>Más Bandwidth</strong>, my new blog at the intersection of game network programming and scalable backend engineering.</p><p>A good matchmaker is vitally important to your multiplayer game experience.</p><p>But it&#39;s difficult to test your matchmaker properly ahead of launch. Testing often misses problems that arise with real-world distributions of players, and you really need to be 100% confident that your matchmaker will do a good job from day 1.</p><p>In this article I present a matchmaking simulator built on player data captured from a real game. This data set reconstructs one virtual day&#39;s worth of player joins across the world with the correct distribution of (latitude, longitude) according to the time of day – accurately reproducing the timing and pattern of player joins you&#39;ll experience at launch.</p><h2 id="goal">Goal</h2><p>Create a matchmaker that quickly finds low latency matches. Ideally, players find a good quality match almost instantly.</p><h2 id="context">Context</h2><p>The game plays identically from 0 - 50ms RTT by design, so there is no point preferring a 10ms server over 50ms. From 50 - 100ms the game still plays well, but 50ms or below is preferable. Above 100ms performance starts to degrade.</p><p>The server fleet for the game is distributed across datacenters around the world. If there are multiple server hosting companies in the same city, each are considered to be logically distinct because they can have different network performance.</p><p>There are 4 players per-match.</p><h2 id="intent">Intent</h2><ul><li>First match players to servers near them with &lt;= 50ms latency</li><li>After 10 seconds, if no match is found, expand to servers &lt;= 100ms latency</li><li>After another 10 seconds, give up and donate the player to any match that needs a player. There&#39;s no good match for this player and the priority is to just let them play. Alternatively, you could let them play against bots. <em><u>This should be very rare.</u></em></li></ul><h2 id="algorithm-in-detail">Algorithm in Detail</h2><p>Each datacenter has its own matchmaking queue. Players can be in multiple datacenter queues at the same time. Every second the set of datacenters are walked in <em><u>random order</u></em>. </p><p>For each datacenter, the matchmaker shuffles the queue to avoid the same players being matched together repeatedly (more should probably be done to avoid this), then walks the queue and assembles players into groups of 4 players. After all datacenters are processed, any left over players feed into the next iteration.</p><p>For each new player entering the matchmaking pool:</p><ul><li>Set the player state to <strong>NEW</strong></li></ul><p>For players in state <strong>NEW</strong>:</p><ul><li>Find all datacenters less than ideal threshold (50ms). If one or more datacenters are found, go to the <strong>IDEAL</strong> state.</li><li>If no datacenters are found under ideal threshold, find all datacenters less than expand threshold (100ms). If one or more datacenters are found, go to the <strong>EXPAND</strong> state.</li><li>If no datacenters are found under the expand threshold, go to the <strong>WARMBODY</strong> state.</li></ul><p>Players in <strong>IDEAL</strong> state should quickly find a game and go to <strong>PLAYING</strong> state.</p><ul><li>Any players that don&#39;t find a game within 10 seconds, go to <strong>EXPAND</strong> state.</li></ul><p>Players in <strong>EXPAND</strong> state should quickly find a game and go to <strong>PLAYING</strong> state.</p><ul><li>Any players that don&#39;t find a game within 10 seconds, go to <strong>WARMBODY</strong> state.</li></ul><p>Players in <strong>WARMBODY</strong> state donate themselves to all matchmaking queues. They just need to play somewhere.</p><ul><li>Look across all datacenters for games that need extra players to start, regardless of latency, and volunteer the warm body.</li><li>Any players that don&#39;t find a game within 10 seconds, go to <strong>FAILED</strong> state. Alternatively you could set these players to play with <strong>BOTS.</strong></li></ul><p>Players in <strong>PLAYING</strong> or <strong>BOTS </strong>state go to <strong>BETWEEN MATCH</strong> state at the end of the match.</p><p>Players in <strong>BETWEEN MATCH</strong> go to <strong>NEW</strong> state once the time between matches has elapsed (30 seconds).</p><p><strong>IMPORTANT</strong>: Break up players at the end of each match and send them back to matchmaking. Otherwise, little islands of players are formed and when you are in the down sloped portion of the CCU curve, new players won&#39;t find matches.</p><h2 id="estimating-latency">Estimating Latency</h2><p>The key input into the algorithm is the estimated round trip latency between a player and each datacenter. This is what guides players to low latency datacenters, so it&#39;s important that it&#39;s accurate. If the input is not accurate, the matchmaker will send players to the wrong place.</p><p>One option is to use the <a href="https://en.wikipedia.org/wiki/Haversine_formula?ref=mas-bandwidth.com" rel="noreferrer">haversine formula</a> to calculate the distance between the player and datacenter, then use the speed of light in fiber optic cables (2/3rds speed of light in a vacuum) plus some fudge factor to estimate the round trip time in milliseconds.</p><p>The problem with this approach is that in many cases the best datacenter isn&#39;t actually the closest. A great example are players in Peru, for whom the closest datacenter by distance is often São Paulo, but since there are no fiber optic cables directly through the Amazon rainforest, it&#39;s not actually the lowest latency datacenter for them to play on.</p><p>One way to get around this is to put ping servers in each datacenter you host game server in, and send low frequency pings to all ping servers on game startup. This way the round trip time can be determined to each datacenter in just one second.</p><p>But even this approach has problems. The route packets take over the internet often depends on the hash of the source and destination IP addresses and port numbers, and the game server the player will ultimately connect to has a different IP address and port from the ping server in the datacenter.</p><p>This can lead to the best datacenter for that player being excluded because it has false positive high RTT due to a bad route between the client and the ping server that doesn&#39;t occur when the client connects to the game server. Conversely, the ping server RTT might look good, but when the player connects to the game server, the route has a much higher RTT. See <a href="https://mas-bandwidth.com/the-case-for-network-acceleration-for-multiplayer-games/" rel="noreferrer">this article</a> for more details on why this happens.</p><p>Because of this, my preferred approach is to calculate latency maps as greyscale image files per-datacenter in a batch process run daily over the last 30 days. This lets you look up the RTT to a datacenter in constant time, and because it&#39;s an average, the RTT value isn&#39;t subject to internet fluctuations.</p><p>This way the player is always sent to the datacenters with the best chance of having low latency. I always pair this with a network accelerator like <a href="https://networknext.com/?ref=mas-bandwidth.com" rel="noreferrer">Network Next</a> to fix any bad routes between the game client and server.</p><figure><img src="https://mas-bandwidth.com/content/images/2024/06/combined.png" alt="" loading="lazy" width="2000" height="1000" srcset="https://mas-bandwidth.com/content/images/size/w600/2024/06/combined.png 600w, https://mas-bandwidth.com/content/images/size/w1000/2024/06/combined.png 1000w, https://mas-bandwidth.com/content/images/size/w1600/2024/06/combined.png 1600w, https://mas-bandwidth.com/content/images/size/w2400/2024/06/combined.png 2400w" sizes="(min-width: 720px) 720px"/><figcaption><span>A combined latency map. Grey scale color [0,255] is latency in ms to the nearest datacenter</span></figcaption></figure><h2 id="implementation">Implementation</h2><p>You can see the full source code and dataset for the matchmaking simulator <a href="https://github.com/mas-bandwidth/matchmaker?ref=mas-bandwidth.com" rel="noreferrer">here</a>.</p><h2 id="results">Results</h2><p>It takes an average of two seconds to find a match, with 30-40ms average RTT depending on the time of day. It seems that the matchmaker is working well.</p><figure><img src="https://mas-bandwidth.com/content/images/2024/06/image-4.png" alt="" loading="lazy" width="1810" height="1060" srcset="https://mas-bandwidth.com/content/images/size/w600/2024/06/image-4.png 600w, https://mas-bandwidth.com/content/images/size/w1000/2024/06/image-4.png 1000w, https://mas-bandwidth.com/content/images/size/w1600/2024/06/image-4.png 1600w, https://mas-bandwidth.com/content/images/2024/06/image-4.png 1810w" sizes="(min-width: 720px) 720px"/></figure><p>To confirm correct operation, let&#39;s visualize the set of active players in matches, so we can verify the distribution of players is correct. <em><u>It looks good!</u></em></p><figure><a href="https://youtu.be/5QOyvrKB_8Q?ref=mas-bandwidth.com"><img src="https://mas-bandwidth.com/content/images/2024/06/matchmaker-1.png" alt="" loading="lazy" width="1219" height="773" srcset="https://mas-bandwidth.com/content/images/size/w600/2024/06/matchmaker-1.png 600w, https://mas-bandwidth.com/content/images/size/w1000/2024/06/matchmaker-1.png 1000w, https://mas-bandwidth.com/content/images/2024/06/matchmaker-1.png 1219w" sizes="(min-width: 720px) 720px"/></a><figcaption><span>Click on the image to watch a timelapse across several days</span></figcaption></figure><h2 id="closing-thoughts">Closing thoughts</h2><p>While developing the simulator I found that for the same set of players joining, the peak CCU is <em><u>incredibly</u></em> sensitive to the % chance that a player will play another match.</p><p>What can you do to increase this % for your game?</p>
    </div></div>
  </body>
</html>
