<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.vogons.org/viewtopic.php?t=105451">Original</a>
    <h1>Reverse Engineering Sid Meier&#39;s Railroad Tycoon for DOS from 1990</h1>
    
    <div id="readability-page-1" class="page"><div>
						
								
	

						
						
						<div><p>Dear Vogons,</p>

<p>Today we will look into train animations. You can see animated trains in the game when:</p>

<p>Now, you might say that the train on the &#34;New Speed Records&#34; screen is not animated, but, it is actually a still frame of an animated train (tick count: 0x3D), so technically it is an animated train <span data-version="6.1" data-src="1f600" data-alt="grinning face">ðŸ˜€</span>.</p>

<p>Where are the assets that will be used to draw the animation? It depends on the scenario and whether the engine pulls &#34;modern cars&#34; or &#34;old cars&#34;. All the assets required to display an animated train are jammed into a single PIC file.</p>

<p>Code:</p><div role="group" aria-label="Code" data-clipboard-source=""><pre><span><span aria-hidden="true">1</span><code role="code"><span role="text presentation">02BB:F4F9  B82A00              mov  ax,002A // each engine is described by 42 bytes<br/></span></code></span><span><span aria-hidden="true">2</span><code role="code"><span role="text presentation">02BB:F4FC  F76E06              imul word [bp+06]           ss:[FEAA]=0002 // engine index<br/></span></code></span><span><span aria-hidden="true">3</span><code role="code"><span role="text presentation">02BB:F4FF  8BD8                mov  bx,ax<br/></span></code></span><span><span aria-hidden="true">4</span><code role="code"><span role="text presentation">02BB:F501  A17CBF              mov  ax,[BF7C] // modernCarsIntroductionYear, scenID=0001-&gt;1908 (0x0774)<br/></span></code></span><span><span aria-hidden="true">5</span><code role="code"><span role="text presentation">02BB:F504  39872C02            cmp  [bx+022C],ax // check engine introduction year, if &lt; modernCarsIntroductionYear, then load simple ?locos.pic, otherwise ?locosm.pic; base=0212, offset=1A (already aliased)<br/></span></code></span><span><span aria-hidden="true">6</span><code role="code"><span role="text presentation">02BB:F508  7D24                jge  0000F52E ($+24)<br/></span></code></span><span><span aria-hidden="true">7</span><code role="code"><span role="text presentation">02BB:F50A  833E209502          cmp  word [9520],0002 // scenario ID<br/></span></code></span><span><span aria-hidden="true">8</span><code role="code"><span role="text presentation">02BB:F50F  7D09                jge  0000F51A ($+9)<br/></span></code></span><span><span aria-hidden="true">9</span><code role="code"><span role="text presentation">02BB:F511  B80200              mov  ax,0002<br/></span></code></span><span><span aria-hidden="true">10</span><code role="code"><span role="text presentation">02BB:F514  50                  push ax<br/></span></code></span><span><span aria-hidden="true">11</span><code role="code"><span role="text presentation">02BB:F515  B8C938              mov  ax,38C9 // points to: &#34;locos.pic&#34;<br/></span></code></span><span><span aria-hidden="true">12</span><code role="code"><span role="text presentation">02BB:F518  EB36                jmp  short 0000F550 ($+36)<br/></span></code></span><span><span aria-hidden="true">13</span><code role="code"><span role="text presentation">02BB:F51A  B80200              mov  ax,0002<br/></span></code></span><span><span aria-hidden="true">14</span><code role="code"><span role="text presentation">02BB:F51D  50                  push ax<br/></span></code></span><span><span aria-hidden="true">15</span><code role="code"><span role="text presentation">02BB:F51E  39062095            cmp  [9520],ax // scenario ID<br/></span></code></span><span><span aria-hidden="true">16</span><code role="code"><span role="text presentation">02BB:F522  7505                jne  0000F529 ($+5)<br/></span></code></span><span><span aria-hidden="true">17</span><code role="code"><span role="text presentation">02BB:F524  B8D338              mov  ax,38D3 // points to: &#34;elocos.pic&#34;<br/></span></code></span><span><span aria-hidden="true">18</span><code role="code"><span role="text presentation">02BB:F527  EB27                jmp  short 0000F550 ($+27)<br/></span></code></span><span><span aria-hidden="true">19</span><code role="code"><span role="text presentation">02BB:F529  B8DE38              mov  ax,38DE // points to: &#34;clocos.pic&#34;<br/></span></code></span><span><span aria-hidden="true">20</span><code role="code"><span role="text presentation">02BB:F52C  EB22                jmp  short 0000F550 ($+22)<br/></span></code></span><span><span aria-hidden="true">21</span><code role="code"><span role="text presentation">02BB:F52E  833E209502          cmp  word [9520],0002<br/></span></code></span><span><span aria-hidden="true">22</span><code role="code"><span role="text presentation">02BB:F533  7D09                jge  0000F53E ($+9)<br/></span></code></span><span><span aria-hidden="true">23</span><code role="code"><span role="text presentation">02BB:F535  B80200              mov  ax,0002<br/></span></code></span><span><span aria-hidden="true">24</span><code role="code"><span role="text presentation">02BB:F538  50                  push ax<br/></span></code></span><span><span aria-hidden="true">25</span><code role="code"><span role="text presentation">02BB:F539  B8E938              mov  ax,38E9 // points to &#34;locosm.pic&#34;<br/></span></code></span><span><span aria-hidden="true">26</span><code role="code"><span role="text presentation">02BB:F53C  EB12                jmp  short 0000F550 ($+12)<br/></span></code></span><span><span aria-hidden="true">27</span><code role="code"><span role="text presentation">02BB:F53E  B80200              mov  ax,0002<br/></span></code></span><span><span aria-hidden="true">28</span><code role="code"><span role="text presentation">02BB:F541  50                  push ax<br/></span></code></span><span><span aria-hidden="true">29</span><code role="code"><span role="text presentation">02BB:F542  39062095            cmp  [9520],ax // scenario ID<br/></span></code></span><span><span aria-hidden="true">30</span><code role="code"><span role="text presentation">02BB:F546  7505                jne  0000F54D ($+5)<br/></span></code></span><span><span aria-hidden="true">31</span><code role="code"><span role="text presentation">02BB:F548  B8F438              mov  ax,38F4 // points to &#34;elocosm.pic&#34;<br/></span></code></span><span><span aria-hidden="true">32</span><code role="code"><span role="text presentation">02BB:F54B  EB03                jmp  short 0000F550 ($+3)<br/></span></code></span><span><span aria-hidden="true">33</span><code role="code"><span role="text presentation">02BB:F54D  B80039              mov  ax,3900 // points to &#34;clocosm.pic&#34;<br/></span></code></span><span><span aria-hidden="true">34</span><code role="code"><span role="text presentation">02BB:F550  50                  push ax<br/></span></code></span><span><span aria-hidden="true">35</span><code role="code"><span role="text presentation">02BB:F551  E844DD              call 0000D298_LoadLocos(fileName(in AX)) ($-22bc) // just loads the raw image<br/></span></code></span><span><span aria-hidden="true">36</span><code role="code"><span role="text presentation">02BB:F554  83C404              add  sp,0004<br/></span></code></span></pre></div>

<p>How do we know if an engine pulls modern cars or old cars? This can be calculated by the following way: if the engine&#39;s introduction year is greater or equal than <span>(scenario start year / 2) + 975</span> then the engine is pulling modern cars, otherwise old cars.</p>
<div role="group" aria-label="Code" data-clipboard-source=""><pre><span><span aria-hidden="true">1</span><code role="code"><span role="text presentation">// 02BB:F47C  A178DC              mov  ax,[DC78]              ds:[DC78]=076C // scenario start year!<br/></span></code></span><span><span aria-hidden="true">2</span><code role="code"><span role="text presentation">// 02BB:F47F  99                  cwd<br/></span></code></span><span><span aria-hidden="true">3</span><code role="code"><span role="text presentation">// 02BB:F480  2BC2                sub  ax,dx<br/></span></code></span><span><span aria-hidden="true">4</span><code role="code"><span role="text presentation">// 02BB:F482  D1F8                sar  ax,1<br/></span></code></span><span><span aria-hidden="true">5</span><code role="code"><span role="text presentation">// 02BB:F484  05CF03              add  ax,03CF<br/></span></code></span><span><span aria-hidden="true">6</span><code role="code"><span role="text presentation">// 02BB:F487  A37CBF              mov  [BF7C],ax              ds:[BF7C]=0785 // year 1925<br/></span></code></span></pre></div>

<p>All right, we have the assets picture loaded. How do we build the animation frames? To explain it we will use the &#34;4-4-0 American&#34; engine as an example. All the information is stored in the &#34;EngineInfo&#34; structure. Each engine is described by 42 bytes. Interesting fact: it seems the team planned to include 11 engines per scenario, but the 11th engine could not fit in the *locos*.pic file. Why do I think that? The SVE file contains an extra engine that never becomes available. This is the &#39;GP&#39; Series Diesel engine. All the engine data is there, but there are no assets available...</p>

<p>I could figure out the meaning of 40 out of 42 bytes of the EngineInfo structure, so the format is:</p>

<p>Bytes from 0x1C-0x28 are needed to build the animation frames. There are always 4 animation frames regardless the number of wheel frames in the assets picture. (For example, the Grasshopper engine only has 2 wheel frames, but the engine info struct will tell us to reuse frame 0 as frame 2 and frame 1 as frame 3.) The complete engine picture in the assets picture is the base frame. The wheels are scattered around in the big asset picture, wherever they fit. It does not really matter, because from the data stored in the engine info structure we can reconstruct all the animation frames. Interesting trivia: the wheels of the &#34;Mallet&#34; engine are not animated, most probably because its animated wheels did not fit in the assets picture.</p>

<p>So in the case of the &#34;4-4-0 American&#34; engine the values are:</p>
<div role="group" aria-label="Code" data-clipboard-source=""><pre><span><span aria-hidden="true">1</span><code role="code"><span role="text presentation">0x00..0x13	trainName	4-4-0 American     \0<br/></span></code></span><span><span aria-hidden="true">2</span><code role="code"><span role="text presentation">0x14..0x15	maximumSpeed (divided by 5)	8<br/></span></code></span><span><span aria-hidden="true">3</span><code role="code"><span role="text presentation">0x16..0x17	power (divided by 500)	3<br/></span></code></span><span><span aria-hidden="true">4</span><code role="code"><span role="text presentation">0x18..0x19	price (divided by 1000)	30<br/></span></code></span><span><span aria-hidden="true">5</span><code role="code"><span role="text presentation">0x1A..0x1B	yearOfIntroduction	1846<br/></span></code></span><span><span aria-hidden="true">6</span><code role="code"><span role="text presentation">0x1C..0x1D	smokeAttachmentX	59<br/></span></code></span><span><span aria-hidden="true">7</span><code role="code"><span role="text presentation">0x1E..0x1F	smokeAttachmentY	52<br/></span></code></span><span><span aria-hidden="true">8</span><code role="code"><span role="text presentation">0x20	engineAssetWidth	73<br/></span></code></span><span><span aria-hidden="true">9</span><code role="code"><span role="text presentation">0x21	xOffsetOfAnimatedWheelsOfLeftFrames	90<br/></span></code></span><span><span aria-hidden="true">10</span><code role="code"><span role="text presentation">0x22	yOffsetOfAnimatedWheelsOfTopFrames	77<br/></span></code></span><span><span aria-hidden="true">11</span><code role="code"><span role="text presentation">0x23	x1OffsetOfAnimatedWheelsOfLeftFrames	123<br/></span></code></span><span><span aria-hidden="true">12</span><code role="code"><span role="text presentation">0x24	y1OffsetOfAnimatedWheelsOfTopFrames	85<br/></span></code></span><span><span aria-hidden="true">13</span><code role="code"><span role="text presentation">0x25	xOffsetOfAnimatedWheelsOfRightFrames	125<br/></span></code></span><span><span aria-hidden="true">14</span><code role="code"><span role="text presentation">0x26	yOffsetOfAnimatedWheelsOfBottomFrames	87<br/></span></code></span><span><span aria-hidden="true">15</span><code role="code"><span role="text presentation">0x27	wheelPositionX	31<br/></span></code></span><span><span aria-hidden="true">16</span><code role="code"><span role="text presentation">0x28	wheelPositionY	63<br/></span></code></span></pre></div>


<p>The &#34;4-4-0 American&#34; is the 3rd engine, so its engine index is 2. To get the Y coordinate of the row in which the base image is we can use the following formula: <span>assetY = (engineIndex &amp; 7 /*because 8 engines fit in 1 column*/) * 0x18 /*height of the row*/;</span></p>

<p>The original game defines a fixed height for each engine within a row, which is 0x15=21 pixels (<span>02BB:F557  B81500              mov  ax,0015</span>). Therefore, the original game chops off the top 3 pixels of each row. This is definitely incorrect, because the top pixels of the &#34;Mallet&#34; engine picture are chopped off too, so the original should have only got rid of 1 or max 2 rows of pixels.</p>

<p>The wheel width can be calculated as <span>x1OffsetOfAnimatedWheelsOfLeftFrames - xOffsetOfAnimatedWheelsOfLeftFrames + 1</span>. So in the case of the &#34;4-4-0 American&#34; engine the animated wheel width is 123-90=33 pixels. (Note: in the assets picture there are 34 pixels present from the wheel, but only 33 are used)</p>

<p>To create a frame, we need to copy the pixels of the animated wheels to the copy of a base frame. The start location where the pixels should be copied to is given by the <span>wheelPositionX</span> and <span>wheelPositionY</span> values, however, they are absolute coordinates. Now we need to discuss a major difference between the port and the original. The original at a very high level does the drawing in a way that it draws the base frame, then restores the background pixels where the animated wheels would go and then draws the animated wheel pixels then the final pixels of the train are copied to the &#34;frame/front buffer&#34;. </p>

<p>C++ code from the port doing all these to demonstrate the above written logic:</p>
<div role="group" aria-label="Code" data-clipboard-source=""><pre><span><span aria-hidden="true">1</span><code role="code"><span role="text presentation">// 02BB:F55B-F561:<br/></span></code></span><span><span aria-hidden="true">2</span><code role="code"><span role="text presentation">const auto engineInfo = this-&gt;configuration.GetEngineInfo(engineIndex);<br/></span></code></span><span><span aria-hidden="true">3</span><code role="code"><span role="text presentation"><br/></span></code></span><span><span aria-hidden="true">4</span><code role="code"><span role="text presentation">// 02BB:F557  B81500              mov  ax,0015 // image height, but chops off the top pixel! (tested with Mallet!)<br/></span></code></span><span><span aria-hidden="true">5</span><code role="code"><span role="text presentation">const auto height = 0x15;<br/></span></code></span><span><span aria-hidden="true">6</span><code role="code"><span role="text presentation"><br/></span></code></span><span><span aria-hidden="true">7</span><code role="code"><span role="text presentation">// 02BB:F563-02BB:F56E:<br/></span></code></span><span><span aria-hidden="true">8</span><code role="code"><span role="text presentation">const int32_t width = engineInfo.GetEngineAssetWidth() % 160;<br/></span></code></span><span><span aria-hidden="true">9</span><code role="code"><span role="text presentation"><br/></span></code></span><span><span aria-hidden="true">10</span><code role="code"><span role="text presentation">// 02BB:F567-02BB:F57C:<br/></span></code></span><span><span aria-hidden="true">11</span><code role="code"><span role="text presentation">const int32_t assetY = (engineIndex &amp; 7) * 0x18 + 3; // 7 engines fit in one column<br/></span></code></span><span><span aria-hidden="true">12</span><code role="code"><span role="text presentation"><br/></span></code></span><span><span aria-hidden="true">13</span><code role="code"><span role="text presentation">// 02BB:F580-02BB:F586:<br/></span></code></span><span><span aria-hidden="true">14</span><code role="code"><span role="text presentation">const int32_t assetX = (engineIndex &gt; 7) ? 160 : 0;<br/></span></code></span><span><span aria-hidden="true">15</span><code role="code"><span role="text presentation"><br/></span></code></span><span><span aria-hidden="true">16</span><code role="code"><span role="text presentation">const auto texWidth = this-&gt;ClosestPowerOf2(width);<br/></span></code></span><span><span aria-hidden="true">17</span><code role="code"><span role="text presentation">const auto texHeight = this-&gt;ClosestPowerOf2(height);<br/></span></code></span><span><span aria-hidden="true">18</span><code role="code"><span role="text presentation">std::vector&lt;uint8_t&gt; pixels(texWidth * texHeight * 4);<br/></span></code></span><span><span aria-hidden="true">19</span><code role="code"><span role="text presentation">this-&gt;CopyRGBAPixels(image.ImageBytes, pixels,<br/></span></code></span><span><span aria-hidden="true">20</span><code role="code"><span role="text presentation">					 assetX, assetY, image.Width, image.Height,<br/></span></code></span><span><span aria-hidden="true">21</span><code role="code"><span role="text presentation">					 0, 0, texWidth, texHeight,<br/></span></code></span><span><span aria-hidden="true">22</span><code role="code"><span role="text presentation">					 width, height);<br/></span></code></span><span><span aria-hidden="true">23</span><code role="code"><span role="text presentation"><br/></span></code></span><span><span aria-hidden="true">24</span><code role="code"><span role="text presentation">// DEBUG&gt;&gt;LocalStorage::Instance().WriteAll(L&#34;raw.raw&#34;, pixels);<br/></span></code></span><span><span aria-hidden="true">25</span><code role="code"><span role="text presentation">auto baseTexture = ::RRTLIB::CreateTextureFromDecompressedRGBAPIC(::RRTLIB::DecompressedImage(pixels, texWidth, texHeight));<br/></span></code></span><span><span aria-hidden="true">26</span><code role="code"><span role="text presentation"><br/></span></code></span><span><span aria-hidden="true">27</span><code role="code"><span role="text presentation">// create the frames&gt;&gt;<br/></span></code></span><span><span aria-hidden="true">28</span><code role="code"><span role="text presentation">const auto wheelWidth = engineInfo.GetX1OffsetOfAnimatedWheelsOfLeftFrames() - engineInfo.GetXOffsetOfAnimatedWheelsOfLeftFrames() + 1;<br/></span></code></span><span><span aria-hidden="true">29</span><code role="code"><span role="text presentation">const auto wheelHeight = engineInfo.GetY1OffsetOfAnimatedWheelsOfTopFrames() - engineInfo.GetYOffsetOfAnimatedWheelsOfTopFrames() + 1;<br/></span></code></span><span><span aria-hidden="true">30</span><code role="code"><span role="text presentation"><br/></span></code></span><span><span aria-hidden="true">31</span><code role="code"><span role="text presentation">std::vector&lt;t_texture_2D_ptr&gt; animationFrames;<br/></span></code></span><span><span aria-hidden="true">32</span><code role="code"><span role="text presentation">animationFrames.reserve(4);<br/></span></code></span><span><span aria-hidden="true">33</span><code role="code"><span role="text presentation"><br/></span></code></span><span><span aria-hidden="true">34</span><code role="code"><span role="text presentation">// 02BB:F597-F639:<br/></span></code></span><span><span aria-hidden="true">35</span><code role="code"><span role="text presentation">for (size_t frameIndex = 0; frameIndex &lt; 4; ++frameIndex) {<br/></span></code></span><span><span aria-hidden="true">36</span><code role="code"><span role="text presentation">	auto frame = pixels;<br/></span></code></span><span><span aria-hidden="true">37</span><code role="code"><span role="text presentation"><br/></span></code></span><span><span aria-hidden="true">38</span><code role="code"><span role="text presentation">	if (wheelWidth &gt; 1) {<br/></span></code></span><span><span aria-hidden="true">39</span><code role="code"><span role="text presentation">		const auto wheelAssetX = (!(frameIndex &amp; 1)) ? engineInfo.GetXOffsetOfAnimatedWheelsOfLeftFrames() : engineInfo.GetXOffsetOfAnimatedWheelsOfRightFrames();<br/></span></code></span><span><span aria-hidden="true">40</span><code role="code"><span role="text presentation">		const auto wheelAssetY = (frameIndex &lt;= 1) ? engineInfo.GetYOffsetOfAnimatedWheelsOfTopFrames() : engineInfo.GetYOffsetOfAnimatedWheelsOfBottomFrames();<br/></span></code></span><span><span aria-hidden="true">41</span><code role="code"><span role="text presentation"><br/></span></code></span><span><span aria-hidden="true">42</span><code role="code"><span role="text presentation">		const auto wheelAttachPosX = (engineInfo.GetWheelPositionX() % 0xA0);<br/></span></code></span><span><span aria-hidden="true">43</span><code role="code"><span role="text presentation">		const auto wheelAttachPosY = (engineInfo.GetWheelPositionY() % 0x18) - 3;<br/></span></code></span><span><span aria-hidden="true">44</span><code role="code"><span role="text presentation"><br/></span></code></span><span><span aria-hidden="true">45</span><code role="code"><span role="text presentation">		this-&gt;CopyRGBAPixels(image.ImageBytes, frame,<br/></span></code></span><span><span aria-hidden="true">46</span><code role="code"><span role="text presentation">							 wheelAssetX, wheelAssetY, image.Width, image.Height,<br/></span></code></span><span><span aria-hidden="true">47</span><code role="code"><span role="text presentation">							 wheelAttachPosX, wheelAttachPosY, texWidth, texHeight,<br/></span></code></span><span><span aria-hidden="true">48</span><code role="code"><span role="text presentation">							 wheelWidth, wheelHeight);<br/></span></code></span><span><span aria-hidden="true">49</span><code role="code"><span role="text presentation">	}<br/></span></code></span><span><span aria-hidden="true">50</span><code role="code"><span role="text presentation">	// DEBUG&gt;&gt;LocalStorage::Instance().WriteAll(std::to_wstring(engineIndex) + std::wstring(L&#34;_engine_frame_&#34;) + std::to_wstring(frameIndex) + std::wstring(L&#34;.raw&#34;), frame);<br/></span></code></span><span><span aria-hidden="true">51</span><code role="code"><span role="text presentation"><br/></span></code></span><span><span aria-hidden="true">52</span><code role="code"><span role="text presentation">	animationFrames.push_back(::RRTLIB::CreateTextureFromDecompressedRGBAPIC(::RRTLIB::DecompressedImage(frame, texWidth, texHeight)));<br/></span></code></span><span><span aria-hidden="true">53</span><code role="code"><span role="text presentation">}<br/></span></code></span></pre></div>

<p>The final frames of the &#34;4-4-0 American&#34; engine are:</p>

<p>The smoke assets are always in a fixed location in the assets picture, which means it does not matter if the *locos.pic or the *locosM.pic file is loaded. The smoke asset width is fixed for each frame which is 0x004E (78) pixels and the height is also fixed: 0x000E (14) pixels. The width of a smoke &#34;cell&#34; is  0x0050 (80) pixels and the height is 0x000F (15) pixels. I just take the smoke assets and create 4 textures from them using the purple color as the transparent color.</p>

<p>To get the proper car asset is a bit trickier, because not all car type IDs map to an asset. For example the car type ID for the mail car is 0, but the passenger car&#39;s type ID is 3. Unused car type IDs are: 1, 2 (well, it is used to indicate a caboose car), 4, 5 and 15.</p>

<p>Let me show the assets picture here again, you can see that a passenger car (car type ID=3) is next to a mail car (car type ID=0):</p>

<p>If we use an index variable that only increases when a car type ID is used, then we get an index that can be used to calculate the asset coordinates for a car type ID. If this index is even then the we pick a car asset from the 1st column, if it is odd then from the 2nd column. The row of the car asset can be determined by integer dividing the index by 2.</p>
<div role="group" aria-label="Code" data-clipboard-source=""><pre><span><span aria-hidden="true">1</span><code role="code"><span role="text presentation">// NOTE: for simplicity we do a 1:1 mapping of car types and images. Unused car type slots will be black images<br/></span></code></span><span><span aria-hidden="true">2</span><code role="code"><span role="text presentation">t_texture_2D_ptr placeholder(new FSYSTEM::OPENGL::CGLTexture2D_Black());<br/></span></code></span><span><span aria-hidden="true">3</span><code role="code"><span role="text presentation"><br/></span></code></span><span><span aria-hidden="true">4</span><code role="code"><span role="text presentation">const auto width = (assumeModernCars) ? 0x3C : 0x2F;<br/></span></code></span><span><span aria-hidden="true">5</span><code role="code"><span role="text presentation">const auto height = 0x13; // 02BB:F658<br/></span></code></span><span><span aria-hidden="true">6</span><code role="code"><span role="text presentation"><br/></span></code></span><span><span aria-hidden="true">7</span><code role="code"><span role="text presentation">int16_t carImageIndex/*bp-06*/ = 0;<br/></span></code></span><span><span aria-hidden="true">8</span><code role="code"><span role="text presentation">for (int carType = 0; carType &lt; 15; ++carType) {<br/></span></code></span><span><span aria-hidden="true">9</span><code role="code"><span role="text presentation">	// 02BB:F646-02BB:F656:<br/></span></code></span><span><span aria-hidden="true">10</span><code role="code"><span role="text presentation">	if ((carType &lt; 6) &amp;&amp; (!((carType == 0) || (carType == 3)))) {<br/></span></code></span><span><span aria-hidden="true">11</span><code role="code"><span role="text presentation">		result.push_back(std::shared_ptr&lt;SimpleAssetInfo&gt;(new SimpleAssetInfo(placeholder, 8, 8, 1, 1)));<br/></span></code></span><span><span aria-hidden="true">12</span><code role="code"><span role="text presentation">		continue;<br/></span></code></span><span><span aria-hidden="true">13</span><code role="code"><span role="text presentation">	}<br/></span></code></span><span><span aria-hidden="true">14</span><code role="code"><span role="text presentation"><br/></span></code></span><span><span aria-hidden="true">15</span><code role="code"><span role="text presentation">	const auto texWidth = this-&gt;ClosestPowerOf2(width);<br/></span></code></span><span><span aria-hidden="true">16</span><code role="code"><span role="text presentation">	const auto texHeight = this-&gt;ClosestPowerOf2(height);<br/></span></code></span><span><span aria-hidden="true">17</span><code role="code"><span role="text presentation">	std::vector&lt;uint8_t&gt; pixels(texWidth * texHeight * 4);<br/></span></code></span><span><span aria-hidden="true">18</span><code role="code"><span role="text presentation"><br/></span></code></span><span><span aria-hidden="true">19</span><code role="code"><span role="text presentation">	// reimplementation of code 02BB:F658-02BB:F691:<br/></span></code></span><span><span aria-hidden="true">20</span><code role="code"><span role="text presentation">	const int32_t y = (carImageIndex / 2 /*row determination*/) * 0x14 /*car cell height*/ + 0x50 /*to skip 2 engines + smoke assets*/;<br/></span></code></span><span><span aria-hidden="true">21</span><code role="code"><span role="text presentation">	const int32_t x = (carImageIndex &amp; 1 /*left or right column*/) * 0x50 + 160 /*offset of the left column of cars in the large image*/;<br/></span></code></span><span><span aria-hidden="true">22</span><code role="code"><span role="text presentation"><br/></span></code></span><span><span aria-hidden="true">23</span><code role="code"><span role="text presentation">	this-&gt;CopyRGBAPixels(image.ImageBytes, pixels,<br/></span></code></span><span><span aria-hidden="true">24</span><code role="code"><span role="text presentation">						 x, y, image.Width, image.Height,<br/></span></code></span><span><span aria-hidden="true">25</span><code role="code"><span role="text presentation">						 0, 0, texWidth, texHeight,<br/></span></code></span><span><span aria-hidden="true">26</span><code role="code"><span role="text presentation">						 width, height);<br/></span></code></span><span><span aria-hidden="true">27</span><code role="code"><span role="text presentation">	<br/></span></code></span><span><span aria-hidden="true">28</span><code role="code"><span role="text presentation">	// DEBUG&gt;&gt; LocalStorage::Instance().WriteAll(std::wstring(L&#34;car_&#34;) + std::wstring(assumeModernCars ? L&#34;m_&#34; : L&#34;&#34;) + std::to_wstring(carType) + std::wstring(L&#34;.raw&#34;), pixels);<br/></span></code></span><span><span aria-hidden="true">29</span><code role="code"><span role="text presentation"><br/></span></code></span><span><span aria-hidden="true">30</span><code role="code"><span role="text presentation">	result.push_back(std::shared_ptr&lt;SimpleAssetInfo&gt;(<br/></span></code></span><span><span aria-hidden="true">31</span><code role="code"><span role="text presentation">		new SimpleAssetInfo(::RRTLIB::CreateTextureFromDecompressedRGBAPIC(::RRTLIB::DecompressedImage(pixels, texWidth, texHeight)),<br/></span></code></span><span><span aria-hidden="true">32</span><code role="code"><span role="text presentation">							width, height,<br/></span></code></span><span><span aria-hidden="true">33</span><code role="code"><span role="text presentation">							static_cast&lt;float&gt;(width) / static_cast&lt;float&gt;(texWidth),<br/></span></code></span><span><span aria-hidden="true">34</span><code role="code"><span role="text presentation">							static_cast&lt;float&gt;(height) / static_cast&lt;float&gt;(texHeight))));<br/></span></code></span><span><span aria-hidden="true">35</span><code role="code"><span role="text presentation"><br/></span></code></span><span><span aria-hidden="true">36</span><code role="code"><span role="text presentation">	++carImageIndex;<br/></span></code></span><span><span aria-hidden="true">37</span><code role="code"><span role="text presentation">}<br/></span></code></span></pre></div>

<p>Now that we have the animated engine frames and the car assets it is easy to render an animated train. BUT, we still have to deal with the smoke! First of all, the smoke only needs to be rendered if the engine is a steam engine. It can be easily determined by looking at the smokeAttachmentX value in the engine info structure (offset: 0x1C-0x1D). If this value is -1 (0xFFFF) then the engine is NOT a steam engine. In this case we have nothing else to do. Otherwise, we need to figure out where to draw it. The smokeAttachmentX and smokeAttachmentY values are absolute coordinates within the big assets picture. However, we need the relative coordinates because we have the engine asset already &#34;taken out&#34; from the big assets picture. This can be done by writing (simplified code!):</p>

<p>Now that we have the relative coordinates, just draw the smoke frame relative to the engine&#39;s position on the screen. By the way, how do we know which smoke asset to draw? There is an animation tick count that determines the frame index. The tick length in milliseconds is not fixed. The original uses vertical retrace waits to modify the tick count. For example, when a train needs to slow down as it arrives to a station is done by the original game by simply waiting more and more vertical retraces. In the port I sum up the elapsed time and if it is above the expected limit (n*vertTraceTime) then I increase the tick count and subtract the limit from the elapsed time.</p> 
<div role="group" aria-label="Code" data-clipboard-source=""><pre><span><span aria-hidden="true">1</span><code role="code"><span role="text presentation">// 17ED:11C0: smoke frame indices<br/></span></code></span><span><span aria-hidden="true">2</span><code role="code"><span role="text presentation">// 17ED:11C0 = 6 words, 17ED:11C0     00 00 03 00 01 00 03 00 02 00 03 00<br/></span></code></span></pre></div>

<p>The following formula is used to calculate an index that can be used to get the final smoke frame index: (animationTickCount / 3) % 6. I use the same logic in the port, obviously.</p>
<div role="group" aria-label="Code" data-clipboard-source=""><pre><span><span aria-hidden="true">1</span><code role="code"><span role="text presentation">// 17ED:11C0: smoke frame indices<br/></span></code></span><span><span aria-hidden="true">2</span><code role="code"><span role="text presentation">// 17ED:11C0 = 6 words, 17ED:11C0     00 00 03 00 01 00 03 00 02 00 03 00<br/></span></code></span><span><span aria-hidden="true">3</span><code role="code"><span role="text presentation">static int16_t smokeFrameIndices[] = { 0, 3, 1, 3, 2, 3 };<br/></span></code></span><span><span aria-hidden="true">4</span><code role="code"><span role="text presentation">...<br/></span></code></span><span><span aria-hidden="true">5</span><code role="code"><span role="text presentation">const auto smokeAsset = this-&gt;assetHandler-&gt;GetSmokeAsset(smokeFrameIndices[(this-&gt;animationTickCount / 3) % 6]);<br/></span></code></span><span><span aria-hidden="true">6</span><code role="code"><span role="text presentation">...<br/></span></code></span></pre></div>

<p>Finally, here is an image of the port showing a &#34;train arriving at a station&#34; animation. You can see that here I could also use resolution independent rendering, it is pretty nice (click for a larger image):</p>

<p>And here is a <b><span><a href="https://1drv.ms/v/c/27b68e061a772e82/IQTNLh6GRt7nQYr8we_dSxaXAUCnXmUOPYWJEqks1MbjeXk?width=1920&amp;height=1080">VIDEO</a></span></b> showing the first cargo delivery and the new speed record screens where train animations are involved.</p>

<p>I hope you enjoyed this little writeup. Next time we will look at something boring, like stocks and chart rendering. Or, if you want, we can dig into the details of the first cargo delivery screen, because there was a nasty bug in the original game that has been fixed in the port <span data-version="6" data-src="1f609" data-alt="winking face">ðŸ˜‰</span>.</p>

<p>Best regards,</p></div>

						
						

																								
																							</div></div>
  </body>
</html>
