<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jxnl.github.io/instructor/blog/2023/11/05/chain-of-density/">Original</a>
    <h1>Smarter summaries with finetuning GPT-3.5 and chain of density</h1>
    
    <div id="readability-page-1" class="page"><div data-md-component="main"> <div>   <div data-md-component="content">  <article> <a href="https://github.com/jxnl/instructor/edit/main/docs/blog/posts/chain-of-density.md" title="Edit this page"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"></path></svg> </a> <a href="https://github.com/jxnl/instructor/raw/main/docs/blog/posts/chain-of-density.md" title="View source of this page"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5Z"></path></svg> </a>  <blockquote> <p>Discover how to distil an iterative method like Chain Of Density into a single finetuned model using Instructor</p> </blockquote> <p>In this article, we&#39;ll guide you through implementing the original Chain of Density method using Instructor, then show how to distile a GPT 3.5 model to match GPT-4&#39;s iterative summarization capabilities. Using these methods were able to decrease latency by 20x, reduce costs by 50x and maintain entity density.</p> <p>By the end you&#39;ll end up with a GPT 3.5 model, (fine-tuned using Instructor&#39;s great tooling), capable of producing summaries that rival the effectiveness of Chain of Density <a href="https://arxiv.org/abs/2309.04269">[Adams et al. (2023)]</a>. As always, all code is readily available in our <code>examples/chain-of-density</code> folder in our repo for your reference.</p> <details> <summary>Datasets and Colab Notebook</summary> <p>We&#39;ve also uploaded all our generated data to Hugging Face <a href="https://huggingface.co/datasets/ivanleomk/gpt4-chain-of-density">here</a> for you to use if you&#39;d like to try reproducing these experiments. We&#39;ve also added a <a href="https://colab.research.google.com/drive/1iBkrEh2G5U8yh8RmI8EkWxjLq6zIIuVm?usp=sharing">Colab Instance</a> for you to check our generated values.</p> </details> <h2 id="part-1-chain-of-density">Part 1) Chain of Density<a href="#part-1-chain-of-density" title="Permanent link">¶</a></h2> <p>Summarizing extensive texts with AI can be challenging, often relying on inconsistent techniques. Their novel method, Chain Of Density prompting, enhances AI-based text summarization, outperforming human-generated summaries.</p> <p>Initially, an AI produces a summary, then refines it through multiple iterations, adding missing article entities. Each iteration adds new article entities to the summary, keeping length consistent, leading to an entity-dense, informative summary called Chain Of Density.</p> <p>First introduced in the paper - <a href="https://arxiv.org/abs/2309.04269">From Sparse to Dense: GPT-4 Summarization with Chain of Density Prompting</a>. The team has found that this method is able to consistently beats similar summaries written by human annotators.</p> <details> <summary>Implementation Details</summary> <p>Note that our implementation uses a validator to ensure that the rewritten summary has a minimum length rather than a prompt. We also perform just 3 and not 5 rounds of rewrites, resulting in a lower final entity density.</p> </details> <h3 id="original-prompt">Original Prompt<a href="#original-prompt" title="Permanent link">¶</a></h3> <p>We can break down the original process into smaller api calls. This allows us to introduce validation at each step to ensure that we&#39;re getting the results that we want.</p> <details> <summary>Original Chain of Density Prompt</summary> <div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>Article: {{ARTICLE}}
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>You will generate increasingly concise, entity-dense summaries of the
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>above Article.
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>Repeat the following 2 steps 5 times.
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>Step 1. Identify 1-3 informative Entities (&#34;;&#34; delimited) from the
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>Article which are missing from the previously generated summary.
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>Step 2. Write a new, denser summary of identical length which covers
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>every entity and detail from the previous summary plus the Missing
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>Entities.
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>A Missing Entity is:
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>- Relevant: to the main story.
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>- Specific: descriptive yet concise (5 words or fewer).
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>- Novel; not in the previous summary.
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>- Faithful: present in the Article.
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>- Anywhere: located anywhere in the Article.
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>Guidelines:
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>- The first summary should be long (4-5 sentences, -80 words) yet
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>highly non-specific, containing little information beyond the
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>entities marked as missing. Use overly verbose language and fillers
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>(e.g., &#34;this article discusses&#34;) to reach -80 words.
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>- Make every word count: re-write the previous summary to improve
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>flow and make space for additional entities.
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>- Make space with fusion, compression, and removal of uninformative
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>phrases like &#34;the article discusses&#34;
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>- The summaries should become highly dense and concise yet
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>self-contained, e.g., easily understood without the Article.
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>- Missing entities can appear anywhere in the new summary.
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>- Never drop entities from the previous summary. If space cannot be
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>made, add fewer new entities.
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>Remember, use the exact same number of words for each summary.
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>Answer in JSON. The JSON should be a list (length 5) of dictionaries
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>whose keys are &#34;Missing_Entities&#34; and &#34;Denser_Summary&#34;
</span></code></pre></div> </details> <figure> <p><img alt="RAG" src="https://ntietz.com/img/chain-of-density.png"/> </p> <figcaption>Improved process with Instructor</figcaption> </figure> <h3 id="data-modelling">Data Modelling<a href="#data-modelling" title="Permanent link">¶</a></h3> <p>Before we begin modelling the data, let&#39;s make sure we install all of our dependencies</p> <div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>pip install instructor aiohttp rich
</span></code></pre></div> <h4 id="initial-summary">Initial Summary<a href="#initial-summary" title="Permanent link">¶</a></h4> <p>Let&#39;s start by walking through some of the data models that we&#39;ll be using as the <code>response_model</code> for our open ai function calls</p> <p>Firstly, we&#39;ll need a data model for the initial summary that we will be generating. We&#39;ll take the description of this class straight from the original prompt. It&#39;s important to note that these docstrings serve a purpose, they are <strong>directly used by the LLM when generating the outputs</strong>.</p> <details> <summary>A quick note on Docstrings</summary> <p>Under the hood, Instructor parses the <code>response_model</code> that you give us into a function call for OpenAI to execute. This means that the final output will be closely linked to the Pydantic model you specify.</p> <p>For instance, this simple model that we later use in fine-tuning.</p> <div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span>class</span> <span>GeneratedSummary</span><span>(</span><span>BaseModel</span><span>):</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span>&#34;&#34;&#34;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span>This represents a highly concise summary that includes as many entities as possible from the original source article.</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span>An Entity is a real-world object that&#39;s assigned a name - for example, a person, country a product or a book title.</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span>Guidelines</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span>- Make every word count</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span>- The new summary should be highly dense and concise yet self-contained, eg., easily understood without the Article.</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span>- Make space with fusion, compression, and removal of uninformative phrases like &#34;the article discusses&#34;</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span>&#34;&#34;&#34;</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span>summary</span><span>:</span> <span>str</span> <span>=</span> <span>Field</span><span>(</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>    <span>...</span><span>,</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>    <span>description</span><span>=</span><span>&#34;This represents the final summary generated that captures the meaning of the original article which is as concise as possible. &#34;</span><span>,</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span>)</span>
</span></code></pre></div> <p>We eventually transform it into an OpenAI function call as seen below.</p> <div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>{
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>&#34;functions&#34;: [
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    {
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>    &#34;name&#34;: &#34;GeneratedSummary&#34;,
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>    &#34;description&#34;: &#34;This represents a highly concise summary that includes as many entities as possible from the original source article.\n\nAn Entity is a real-world object that&#39;s assigned a name - for example, a person, country a product or a book title.\n\nGuidelines\n- Make every word count\n- The new summary should be highly dense and concise yet self-contained, eg., easily understood without the Article.\n- Make space with fusion, compression, and removal of uninformative phrases like \&#34;the article discusses\&#34;&#34;,
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    &#34;parameters&#34;: {
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>        &#34;properties&#34;: {
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>        &#34;summary&#34;: {
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>            &#34;description&#34;: &#34;This represents the final summary generated that captures the meaning of the original article which is as concise as possible. &#34;,
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>            &#34;title&#34;: &#34;Summary&#34;,
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>            &#34;type&#34;: &#34;string&#34;
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>        }
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>        },
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>        &#34;required&#34;: [
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>        &#34;summary&#34;
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>        ],
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>        &#34;type&#34;: &#34;object&#34;
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>    }
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>    }
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>]
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>}
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>}
</span></code></pre></div> <p>Therefore this means that the more elaborate and detailed your descriptions are, the better the outputs you will be able to get back. But we don&#39;t just stop there, since it&#39;s all Pydantic under the hood, you can validate and parse the resulting output to make sure it is <strong>exactly what you specify</strong>. It&#39;s all python all the way down.</p> </details> <div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span>class</span> <span>InitialSummary</span><span>(</span><span>BaseModel</span><span>):</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span>    </span><span>&#34;&#34;&#34;</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span>    This is an initial summary which should be long ( 4-5 sentences, ~80 words)</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span>    yet highly non-specific, containing little information beyond the entities marked as missing.</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span>    Use overly verbose languages and fillers (Eg. This article discusses) to reach ~80 words.</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span>    &#34;&#34;&#34;</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>    <span>summary</span><span>:</span> <span>str</span> <span>=</span> <span>Field</span><span>(</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>        <span>...</span><span>,</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>        <span>description</span><span>=</span><span>&#34;This is a summary of the article provided which is overly verbose and uses fillers. It should be roughly 80 words in length&#34;</span><span>,</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>    <span>)</span>
</span></code></pre></div> <h4 id="rewritten-summary">Rewritten Summary<a href="#rewritten-summary" title="Permanent link">¶</a></h4> <p>We&#39;ll also need one additional class to help model the rewritten schema</p> <div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span>class</span> <span>RewrittenSummary</span><span>(</span><span>BaseModel</span><span>):</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span>    </span><span>&#34;&#34;&#34;</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span>    This is a new, denser summary of identical length which covers every entity</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span>    and detail from the previous summary plus the Missing Entities.</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span>    Guidelines</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span>    - Make every word count : Rewrite the previous summary to improve flow and make space for additional entities</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span>    - Never drop entities from the previous summary. If space cannot be made, add fewer new entities.</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span>    - The new summary should be highly dense and concise yet self-contained, eg., easily understood without the Article.</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span>    - Make space with fusion, compression, and removal of uninformative phrases like &#34;the article discusses&#34;</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span>    - Missing entities can appear anywhere in the new summary</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span>    An Entity is a real-world object that&#39;s assigned a name - for example, a person, country a product or a book title.</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span>    &#34;&#34;&#34;</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>    <span>summary</span><span>:</span> <span>str</span> <span>=</span> <span>Field</span><span>(</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>        <span>...</span><span>,</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>        <span>description</span><span>=</span><span>&#34;This is a new, denser summary of identical length which covers every entity and detail from the previous summary plus the Missing Entities. It should have the same length ( ~ 80 words ) as the previous summary and should be easily understood without the Article&#34;</span><span>,</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>    <span>)</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>    <span>absent</span><span>:</span> <span>List</span><span>[</span><span>str</span><span>]</span> <span>=</span> <span>Field</span><span>(</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>        <span>...</span><span>,</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>        <span>default_factory</span><span>=</span><span>list</span><span>,</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>        <span>description</span><span>=</span><span>&#34;this is a list of Entities found absent from the new summary that were present in the previous summary&#34;</span><span>,</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>    <span>)</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>    <span>missing</span><span>:</span> <span>List</span><span>[</span><span>str</span><span>]</span> <span>=</span> <span>Field</span><span>(</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>        <span>default_factory</span><span>=</span><span>list</span><span>,</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>        <span>description</span><span>=</span><span>&#34;This is a list of 1-3 informative Entities from the Article that are missing from the new summary which should be included in the next generated summary.&#34;</span><span>,</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>    <span>)</span>
</span></code></pre></div> <div> <p>Using Pydantic Validators with Instructor</p> <p>For a more in-depth walkthrough on how to use <code>Pydantic</code> validators with the <code>Instructor</code> library, we recommend checking out our previous article on LLM validation - <a href="https://ntietz.com/instructor/blog/2023/10/23/good-llm-validation-is-just-good-validation/">Good LLM Validation is just Good Validation</a></p> </div> <p>Ideally, we&#39;d like for <code>Missing</code> to have a length between 1 and 3, <code>Absent</code> to be an empty list and for our rewritten summaries to keep a minimum entity density. With <code>Instructor</code>, we can implement this logic using native <code>Pydantic</code> validators that are simply declared as part of the class itself.</p> <div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span>import</span> <span>nltk</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span>import</span> <span>spacy</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span>nlp</span> <span>=</span> <span>spacy</span><span>.</span><span>load</span><span>(</span><span>&#34;en_core_web_sm&#34;</span><span>)</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span>@field_validator</span><span>(</span><span>&#34;summary&#34;</span><span>)</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span>def</span> <span>min_length</span><span>(</span><span>cls</span><span>,</span> <span>v</span><span>:</span> <span>str</span><span>):</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span>    <span>tokens</span> <span>=</span> <span>nltk</span><span>.</span><span>word_tokenize</span><span>(</span><span>v</span><span>)</span> <span>#(1)!</span>
</span></span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>    <span>num_tokens</span> <span>=</span> <span>len</span><span>(</span><span>tokens</span><span>)</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>    <span>if</span> <span>num_tokens</span> <span>&lt;</span> <span>60</span><span>:</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>        <span>raise</span> <span>ValueError</span><span>(</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>            <span>&#34;The current summary is too short. Please make sure that you generate a new summary that is around 80 words long.&#34;</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>        <span>)</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>    <span>return</span> <span>v</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span>@field_validator</span><span>(</span><span>&#34;missing&#34;</span><span>)</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span>def</span> <span>has_missing_entities</span><span>(</span><span>cls</span><span>,</span> <span>missing_entities</span><span>:</span> <span>List</span><span>[</span><span>str</span><span>]):</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>    <span>if</span> <span>len</span><span>(</span><span>missing_entities</span><span>)</span> <span>==</span> <span>0</span><span>:</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>        <span>raise</span> <span>ValueError</span><span>(</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>            <span>&#34;You must identify 1-3 informative Entities from the Article which are missing from the previously generated summary to be used in a new summary&#34;</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>        <span>)</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>    <span>return</span> <span>missing_entities</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span>@field_validator</span><span>(</span><span>&#34;absent&#34;</span><span>)</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span>def</span> <span>has_no_absent_entities</span><span>(</span><span>cls</span><span>,</span> <span>absent_entities</span><span>:</span> <span>List</span><span>[</span><span>str</span><span>]):</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>    <span>absent_entity_string</span> <span>=</span> <span>&#34;,&#34;</span><span>.</span><span>join</span><span>(</span><span>absent_entities</span><span>)</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>    <span>if</span> <span>len</span><span>(</span><span>absent_entities</span><span>)</span> <span>&gt;</span> <span>0</span><span>:</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>        <span>print</span><span>(</span><span>f</span><span>&#34;Detected absent entities of </span><span>{</span><span>absent_entity_string</span><span>}</span><span>&#34;</span><span>)</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>        <span>raise</span> <span>ValueError</span><span>(</span>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>            <span>f</span><span>&#34;Do not omit the following Entities </span><span>{</span><span>absent_entity_string</span><span>}</span><span> from the new summary&#34;</span>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a>        <span>)</span>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a>    <span>return</span> <span>absent_entities</span>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a><span>@field_validator</span><span>(</span><span>&#34;summary&#34;</span><span>)</span>
</span><span id="__span-6-35"><a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>    <span>def</span> <span>min_entity_density</span><span>(</span><span>cls</span><span>,</span> <span>v</span><span>:</span> <span>str</span><span>):</span>
</span><span id="__span-6-36"><a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>        <span>tokens</span> <span>=</span> <span>nltk</span><span>.</span><span>word_tokenize</span><span>(</span><span>v</span><span>)</span>
</span><span id="__span-6-37"><a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>        <span>num_tokens</span> <span>=</span> <span>len</span><span>(</span><span>tokens</span><span>)</span>
</span><span id="__span-6-38"><a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a>
</span><span id="__span-6-39"><a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a>        <span># Extract Entities</span>
</span><span id="__span-6-40"><a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a><span>        <span>doc</span> <span>=</span> <span>nlp</span><span>(</span><span>v</span><span>)</span> <span>#(2)!</span>
</span></span><span id="__span-6-41"><a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a>        <span>num_entities</span> <span>=</span> <span>len</span><span>(</span><span>doc</span><span>.</span><span>ents</span><span>)</span>
</span><span id="__span-6-42"><a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a>
</span><span id="__span-6-43"><a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a>        <span>density</span> <span>=</span> <span>num_entities</span> <span>/</span> <span>num_tokens</span>
</span><span id="__span-6-44"><a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a><span>        <span>if</span> <span>density</span> <span>&lt;</span> <span>0.08</span><span>:</span> <span>#(3)!</span>
</span></span><span id="__span-6-45"><a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a>            <span>raise</span> <span>ValueError</span><span>(</span>
</span><span id="__span-6-46"><a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a>                <span>f</span><span>&#34;The summary of </span><span>{</span><span>v</span><span>}</span><span> has too few entities. Please regenerate a new summary with more new entities added to it. Remember that new entities can be added at any point of the summary.&#34;</span>
</span><span id="__span-6-47"><a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a>            <span>)</span>
</span><span id="__span-6-48"><a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>
</span><span id="__span-6-49"><a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a>        <span>return</span> <span>v</span>
</span></code></pre></div> <ol> <li> <p>Similar to the original paper, we utilize the <code>NLTK</code> word tokenizer to count the number of tokens within our generated sentences. We aim for at least 60 tokens in our generated summary so that we don&#39;t lose information.</p> </li> <li> <p>We also use the spaCy library to calculate the entity density of the generated summary.</p> </li> <li> <p>We also implement a minimum entity density so that we stay within a given range. 0.08 is arbitrarily chosen in this case</p> </li> </ol> <h3 id="putting-it-all-together">Putting it all Together<a href="#putting-it-all-together" title="Permanent link">¶</a></h3> <p>Now that we have our models and the rough flow figured out, let&#39;s implement a function to summarize a piece of text using <code>Chain Of Density</code> summarization.</p> <div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span>from</span> <span>openai</span> <span>import</span> <span>OpenAI</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span>import</span> <span>instructor</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span><span>client</span> <span>=</span> <span>instructor</span><span>.</span><span>patch</span><span>(</span><span>OpenAI</span><span>())</span> <span>#(1)!</span>
</span></span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span>def</span> <span>summarize_article</span><span>(</span><span>article</span><span>:</span> <span>str</span><span>,</span> <span>summary_steps</span><span>:</span> <span>int</span> <span>=</span> <span>3</span><span>):</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>    <span>summary_chain</span> <span>=</span> <span>[]</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>    <span># We first generate an initial summary</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span>    <span>summary</span><span>:</span> <span>InitialSummary</span> <span>=</span> <span>client</span><span>.</span><span>chat</span><span>.</span><span>completions</span><span>.</span><span>create</span><span>(</span>  <span># (2)!</span>
</span></span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span>        <span>model</span><span>=</span><span>&#34;gpt-4-0613&#34;</span><span>,</span>
</span></span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span>        <span>response_model</span><span>=</span><span>InitialSummary</span><span>,</span>
</span></span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span>        <span>messages</span><span>=</span><span>[</span>
</span></span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span>            <span>{</span>
</span></span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span>                <span>&#34;role&#34;</span><span>:</span> <span>&#34;system&#34;</span><span>,</span>
</span></span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span>                <span>&#34;content&#34;</span><span>:</span> <span>&#34;Write a summary about the article that is long (4-5 sentences) yet highly non-specific. Use overly, verbose language and fillers(eg.,&#39;this article discusses&#39;) to reach ~80 words&#34;</span><span>,</span>
</span></span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span>            <span>},</span>
</span></span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span>            <span>{</span><span>&#34;role&#34;</span><span>:</span> <span>&#34;user&#34;</span><span>,</span> <span>&#34;content&#34;</span><span>:</span> <span>f</span><span>&#34;Here is the Article: </span><span>{</span><span>article</span><span>}</span><span>&#34;</span><span>},</span>
</span></span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span>            <span>{</span>
</span></span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span>                <span>&#34;role&#34;</span><span>:</span> <span>&#34;user&#34;</span><span>,</span>
</span></span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span>                <span>&#34;content&#34;</span><span>:</span> <span>&#34;The generated summary should be about 80 words.&#34;</span><span>,</span>
</span></span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span>            <span>},</span>
</span></span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span>        <span>],</span>
</span></span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span>        <span>max_retries</span><span>=</span><span>2</span><span>,</span>
</span></span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span>    <span>)</span>
</span></span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>    <span>prev_summary</span> <span>=</span> <span>None</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>    <span>summary_chain</span><span>.</span><span>append</span><span>(</span><span>summary</span><span>.</span><span>summary</span><span>)</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>    <span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>summary_steps</span><span>):</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>        <span>missing_entity_message</span> <span>=</span> <span>(</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>            <span>[]</span>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>            <span>if</span> <span>prev_summary</span> <span>is</span> <span>None</span>
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>            <span>else</span> <span>[</span>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>                <span>{</span>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a>                    <span>&#34;role&#34;</span><span>:</span> <span>&#34;user&#34;</span><span>,</span>
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>                    <span>&#34;content&#34;</span><span>:</span> <span>f</span><span>&#34;Please include these Missing Entities: </span><span>{</span><span>&#39;,&#39;</span><span>.</span><span>join</span><span>(</span><span>prev_summary</span><span>.</span><span>missing</span><span>)</span><span>}</span><span>&#34;</span><span>,</span>
</span><span id="__span-7-35"><a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>                <span>},</span>
</span><span id="__span-7-36"><a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>            <span>]</span>
</span><span id="__span-7-37"><a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a>        <span>)</span>
</span><span id="__span-7-38"><a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a><span>        <span>new_summary</span><span>:</span> <span>RewrittenSummary</span> <span>=</span> <span>client</span><span>.</span><span>chat</span><span>.</span><span>completions</span><span>.</span><span>create</span><span>(</span> <span># (3)!</span>
</span></span><span id="__span-7-39"><a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a><span>            <span>model</span><span>=</span><span>&#34;gpt-4-0613&#34;</span><span>,</span>
</span></span><span id="__span-7-40"><a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a><span>            <span>messages</span><span>=</span><span>[</span>
</span></span><span id="__span-7-41"><a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a><span>                <span>{</span>
</span></span><span id="__span-7-42"><a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a><span>                    <span>&#34;role&#34;</span><span>:</span> <span>&#34;system&#34;</span><span>,</span>
</span></span><span id="__span-7-43"><a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a><span>                    <span>&#34;content&#34;</span><span>:</span> <span>&#34;&#34;&#34;</span>
</span></span><span id="__span-7-44"><a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a><span><span>                You are going to generate an increasingly concise,entity-dense summary of the following article.</span>
</span></span><span id="__span-7-45"><a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a><span>
</span></span><span id="__span-7-46"><a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a><span><span>                Perform the following two tasks</span>
</span></span><span id="__span-7-47"><a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a><span><span>                - Identify 1-3 informative entities from the following article which is missing from the previous summary</span>
</span></span><span id="__span-7-48"><a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a><span><span>                - Write a new denser summary of identical length which covers every entity and detail from the previous summary plus the Missing Entities</span>
</span></span><span id="__span-7-49"><a id="__codelineno-7-49" name="__codelineno-7-49" href="#__codelineno-7-49"></a><span>
</span></span><span id="__span-7-50"><a id="__codelineno-7-50" name="__codelineno-7-50" href="#__codelineno-7-50"></a><span><span>                Guidelines</span>
</span></span><span id="__span-7-51"><a id="__codelineno-7-51" name="__codelineno-7-51" href="#__codelineno-7-51"></a><span><span>                - Make every word count: re-write the previous summary to improve flow and make space for additional entities</span>
</span></span><span id="__span-7-52"><a id="__codelineno-7-52" name="__codelineno-7-52" href="#__codelineno-7-52"></a><span><span>                - Make space with fusion, compression, and removal of uninformative phrases like &#34;the article discusses&#34;.</span>
</span></span><span id="__span-7-53"><a id="__codelineno-7-53" name="__codelineno-7-53" href="#__codelineno-7-53"></a><span><span>                - The summaries should become highly dense and concise yet self-contained, e.g., easily understood without the Article.</span>
</span></span><span id="__span-7-54"><a id="__codelineno-7-54" name="__codelineno-7-54" href="#__codelineno-7-54"></a><span><span>                - Missing entities can appear anywhere in the new summary</span>
</span></span><span id="__span-7-55"><a id="__codelineno-7-55" name="__codelineno-7-55" href="#__codelineno-7-55"></a><span><span>                - Never drop entities from the previous summary. If space cannot be made, add fewer new entities.</span>
</span></span><span id="__span-7-56"><a id="__codelineno-7-56" name="__codelineno-7-56" href="#__codelineno-7-56"></a><span><span>                &#34;&#34;&#34;</span><span>,</span>
</span></span><span id="__span-7-57"><a id="__codelineno-7-57" name="__codelineno-7-57" href="#__codelineno-7-57"></a><span>                <span>},</span>
</span></span><span id="__span-7-58"><a id="__codelineno-7-58" name="__codelineno-7-58" href="#__codelineno-7-58"></a><span>                <span>{</span><span>&#34;role&#34;</span><span>:</span> <span>&#34;user&#34;</span><span>,</span> <span>&#34;content&#34;</span><span>:</span> <span>f</span><span>&#34;Here is the Article: </span><span>{</span><span>article</span><span>}</span><span>&#34;</span><span>},</span>
</span></span><span id="__span-7-59"><a id="__codelineno-7-59" name="__codelineno-7-59" href="#__codelineno-7-59"></a><span>                <span>{</span>
</span></span><span id="__span-7-60"><a id="__codelineno-7-60" name="__codelineno-7-60" href="#__codelineno-7-60"></a><span>                    <span>&#34;role&#34;</span><span>:</span> <span>&#34;user&#34;</span><span>,</span>
</span></span><span id="__span-7-61"><a id="__codelineno-7-61" name="__codelineno-7-61" href="#__codelineno-7-61"></a><span>                    <span>&#34;content&#34;</span><span>:</span> <span>f</span><span>&#34;Here is the previous summary: </span><span>{</span><span>summary_chain</span><span>[</span><span>-</span><span>1</span><span>]</span><span>}</span><span>&#34;</span><span>,</span>
</span></span><span id="__span-7-62"><a id="__codelineno-7-62" name="__codelineno-7-62" href="#__codelineno-7-62"></a><span>                <span>},</span>
</span></span><span id="__span-7-63"><a id="__codelineno-7-63" name="__codelineno-7-63" href="#__codelineno-7-63"></a><span>                <span>*</span><span>missing_entity_message</span><span>,</span>
</span></span><span id="__span-7-64"><a id="__codelineno-7-64" name="__codelineno-7-64" href="#__codelineno-7-64"></a><span>            <span>],</span>
</span></span><span id="__span-7-65"><a id="__codelineno-7-65" name="__codelineno-7-65" href="#__codelineno-7-65"></a><span>            <span>max_retries</span><span>=</span><span>3</span><span>,</span> <span>#(4)!</span>
</span></span><span id="__span-7-66"><a id="__codelineno-7-66" name="__codelineno-7-66" href="#__codelineno-7-66"></a><span>            <span>max_tokens</span><span>=</span><span>1000</span><span>,</span>
</span></span><span id="__span-7-67"><a id="__codelineno-7-67" name="__codelineno-7-67" href="#__codelineno-7-67"></a><span>            <span>response_model</span><span>=</span><span>RewrittenSummary</span><span>,</span>
</span></span><span id="__span-7-68"><a id="__codelineno-7-68" name="__codelineno-7-68" href="#__codelineno-7-68"></a><span>        <span>)</span>
</span></span><span id="__span-7-69"><a id="__codelineno-7-69" name="__codelineno-7-69" href="#__codelineno-7-69"></a>        <span>summary_chain</span><span>.</span><span>append</span><span>(</span><span>new_summary</span><span>.</span><span>summary</span><span>)</span>
</span><span id="__span-7-70"><a id="__codelineno-7-70" name="__codelineno-7-70" href="#__codelineno-7-70"></a>        <span>prev_summary</span> <span>=</span> <span>new_summary</span>
</span><span id="__span-7-71"><a id="__codelineno-7-71" name="__codelineno-7-71" href="#__codelineno-7-71"></a>
</span><span id="__span-7-72"><a id="__codelineno-7-72" name="__codelineno-7-72" href="#__codelineno-7-72"></a>    <span>return</span> <span>summary_chain</span>
</span></code></pre></div> <ol> <li> <p>We need to apply a <code>patch</code> function on the <code>OpenAI</code> client for us to get all of the benefits that <code>Instructor</code> provides. With a simple <code>patch</code>, we can get <strong>automatic type coercion of our outputs and automatic retries for invalid outputs</strong> out of the box!</p> </li> <li> <p>We first generate an initial summary. Note here that we explictly ask for a summary that has 80 words and is lengthy with overly verbose fillers in the system prompt</p> </li> <li> <p>We slightly modify the original system prompt used in the original paper to perform a rewrite of the summary. Using <code>Instructor</code>, we also get validation of the generated output with our <code>field_validator</code>s that we defined above</p> </li> <li> <p>If you&#39;ve chosen a value that is larger than 0.08, make sure to increase this value in case you need to do multiple rewrites</p> </li> </ol> <p>This summarization function yields a result which triples the number of entities while maintaining the same number of tokens. We can also see that stylistically, the summary is a lot more natural.</p> <p><strong>First Iteration</strong></p> <blockquote> <p>This article discusses the highly-anticipated boxing match between Manny Pacquiao and Floyd Mayweather. The article revolves around Manny Pacquiao&#39;s statements about his upcoming fight and his preparations for the same. A portion of the article provides details about the financial stipulations of the match and its significance in the sporting arena. Quotes from Pacquiao illustrating his determination and his battle strategy are highlighted. The tone of the article is largely centered around creating a build-up to the upcoming mega event.</p> </blockquote> <p><strong>Final Iteration</strong></p> <blockquote> <p>Manny Pacquiao, the Filipino boxer, anticipates the forthcoming May 2 showdown at the MGM Grand as the fight of his life, against the undefeated American Floyd Mayweather, in a $300m bout. Despite being seen as the underdog in this high-stakes Las Vegas match, Pacquiao is confident, promising a warrior&#39;s spirit and assuring the fans who have been awaiting this encounter for a decade, that it will indeed be the biggest sporting spectacle in history worthy of their anticipation</p> </blockquote> <h2 id="part-2-fine-tuning">Part 2) Fine-Tuning<a href="#part-2-fine-tuning" title="Permanent link">¶</a></h2> <p>In this section, we&#39;ll look into how to fine-tune a GPT 3.5 model so that it is able to perform at an equivalent level as a GPT-4 model. We&#39;ll then compare the performance of our model against that of <code>GPT-4</code> to see how it stacks up.</p> <h3 id="creating-a-training-set">Creating a Training Set<a href="#creating-a-training-set" title="Permanent link">¶</a></h3> <p>In order to prevent any contamination of data during testing, we randomly sampled 120 articles from the <code>griffin/chain-of-density</code> dataset and split these articles into a <code>train.csv</code> and a <code>test.csv</code> file which we uploaded to <a href="https://huggingface.co/datasets/ivanleomk/gpt4-chain-of-density">Hugging Face</a>. Now, we just neeed to import the <code>Instructions</code> module from the <code>Instructor</code> package which allows you to generate a nicely formatted <code>.jsonl</code> file to be used for fine-tuning</p> <div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span>from</span> <span>typing</span> <span>import</span> <span>List</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span><span>from</span> <span>chain_of_density</span> <span>import</span> <span>summarize_article</span> <span>#(1)!</span>
</span></span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span>import</span> <span>csv</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span>import</span> <span>logging</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span>import</span> <span>instructor</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span>from</span> <span>pydantic</span> <span>import</span> <span>BaseModel</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span>from</span> <span>openai</span> <span>import</span> <span>OpenAI</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span><span>client</span> <span>=</span> <span>instructor</span><span>.</span><span>patch</span><span>(</span><span>OpenAI</span><span>())</span> <span># (2)!</span>
</span></span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span><span>logging</span><span>.</span><span>basicConfig</span><span>(</span><span>level</span><span>=</span><span>logging</span><span>.</span><span>INFO</span><span>)</span> <span>#(3)!</span>
</span></span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span><span>instructions</span> <span>=</span> <span>instructor</span><span>.</span><span>Instructions</span><span>(</span> <span>#(4)!</span>
</span></span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span>    <span>name</span><span>=</span><span>&#34;Chain Of Density&#34;</span><span>,</span>
</span></span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span>    <span>finetune_format</span><span>=</span><span>&#34;messages&#34;</span><span>,</span>
</span></span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span>    <span># log handler is used to save the data to a file</span>
</span></span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span>    <span># you can imagine saving it to a database or other storage</span>
</span></span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span>    <span># based on your needs!</span>
</span></span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span>    <span>log_handlers</span><span>=</span><span>[</span><span>logging</span><span>.</span><span>FileHandler</span><span>(</span><span>&#34;generated.jsonl&#34;</span><span>)],</span>
</span></span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span>    <span>openai_client</span><span>=</span><span>client</span><span>,</span>
</span></span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span><span>)</span>
</span></span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span>class</span> <span>GeneratedSummary</span><span>(</span><span>BaseModel</span><span>):</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a><span>    </span><span>&#34;&#34;&#34;</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span>    This represents a highly concise summary that includes as many entities as possible from the original source article.</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span>    An Entity is a real-world object that&#39;s assigned a name - for example, a person, country a product or a book title.</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a><span>    Guidelines</span>
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a><span>    - Make every word count</span>
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a><span>    - The new summary should be highly dense and concise yet self-contained, eg., easily understood without the Article.</span>
</span><span id="__span-8-32"><a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a><span>    - Make space with fusion, compression, and removal of uninformative phrases like &#34;the article discusses&#34;</span>
</span><span id="__span-8-33"><a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a><span>    &#34;&#34;&#34;</span>
</span><span id="__span-8-34"><a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>
</span><span id="__span-8-35"><a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>    <span>summary</span><span>:</span> <span>str</span> <span>=</span> <span>Field</span><span>(</span>
</span><span id="__span-8-36"><a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a>        <span>...</span><span>,</span>
</span><span id="__span-8-37"><a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a>        <span>description</span><span>=</span><span>&#34;This represents the final summary generated that captures the meaning of the original article which is as concise as possible. &#34;</span><span>,</span>
</span><span id="__span-8-38"><a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a>    <span>)</span>
</span><span id="__span-8-39"><a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>
</span><span id="__span-8-40"><a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a><span><span>@instructions</span><span>.</span><span>distil</span> <span>#(4)!</span>
</span></span><span id="__span-8-41"><a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a><span>def</span> <span>distil_summarization</span><span>(</span><span>text</span><span>:</span> <span>str</span><span>)</span> <span>-&gt;</span> <span>GeneratedSummary</span><span>:</span>
</span><span id="__span-8-42"><a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a>    <span>summary_chain</span><span>:</span> <span>List</span><span>[</span><span>str</span><span>]</span> <span>=</span> <span>summarize_article</span><span>(</span><span>text</span><span>)</span>
</span><span id="__span-8-43"><a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a><span>    <span>return</span> <span>GeneratedSummary</span><span>(</span><span>summary</span><span>=</span><span>summary_chain</span><span>[</span><span>-</span><span>1</span><span>])</span> <span>#(5)!</span>
</span></span><span id="__span-8-44"><a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a>
</span><span id="__span-8-45"><a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a><span>with</span> <span>open</span><span>(</span><span>&#34;train.csv&#34;</span><span>,</span> <span>&#34;r&#34;</span><span>)</span> <span>as</span> <span>file</span><span>:</span>
</span><span id="__span-8-46"><a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a>    <span>reader</span> <span>=</span> <span>csv</span><span>.</span><span>reader</span><span>(</span><span>file</span><span>)</span>
</span><span id="__span-8-47"><a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a>    <span>next</span><span>(</span><span>reader</span><span>)</span>  <span># Skip the header</span>
</span><span id="__span-8-48"><a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a>    <span>for</span> <span>article</span><span>,</span> <span>summary</span> <span>in</span> <span>reader</span><span>:</span>
</span><span id="__span-8-49"><a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a>        <span># Run Distillisation to generate the values</span>
</span><span id="__span-8-50"><a id="__codelineno-8-50" name="__codelineno-8-50" href="#__codelineno-8-50"></a>        <span>distil_summarization</span><span>(</span><span>article</span><span>)</span>
</span></code></pre></div> <ol> <li> <p>In this example, we&#39;re using the summarize_article that we defined up above. We saved it in a local file called <code>chain_of_density.py</code>, hence the import</p> </li> <li> <p>We patch the default OpenAI client so that we can use the Instructor library with it</p> </li> <li> <p>We also need to configure logging at the <code>INFO</code> level. This is very important, if this is not configured, your output will not be generated.</p> </li> <li> <p>We instantiate a <code>Instruction</code> object which will help us handle the conversion of our function calls into a valid <code>.jsonl</code> file. We also define the name of the <code>.jsonl</code> file in the <code>log_handlers</code> parameter</p> </li> <li> <p>We add in an <code>instructions.distil</code> annotation so that we automatically capture the input and output of the function we&#39;d like to fine-tune our model to output</p> </li> <li> <p>We return a <code>Pydantic</code> object which matches the annotation that we use on our function. Note that we must specify a <code>Pydantic</code> object to be returned when using the <code>instructions.distil</code> annotation</p> </li> </ol> <div> <p>Rate Limiting</p> <p>We recommend running this script on a small subset of the dataset first to test you&#39;ve got everything configured nicely. Don&#39;t forget to add in rate limiting error handling with <code>tenacity</code> and set the <code>OPENAI_API_KEY</code> shell environment variable before running any subsequent commands</p> </div> <h3 id="creating-fine-tuning-jobs">Creating Fine-Tuning Jobs<a href="#creating-fine-tuning-jobs" title="Permanent link">¶</a></h3> <p>Once we run this script, we&#39;ll have a new file called <code>generated.jsonl</code> in our local repository. Now all that&#39;s left is to run the command below to start fine-tuning your first model!</p> <div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>instructor<span> </span><span>jobs</span><span> </span>create-from-file<span> </span>generated.jsonl
</span></code></pre></div> <details> <summary>Finetuning Reference</summary> <p>Checking out our <a href="https://ntietz.com/instructor/cli/finetune/">Finetuning CLI</a> to learn about other hyperparameters that you can tune to improve your model&#39;s performance.</p> </details> <p>Once the job is complete, all we need to do is to then change the annotation in the function call to <code>distil_summarization</code> in our original file above to start using our new model.</p> <div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span>@instructions</span><span>.</span><span>distil</span><span>(</span><span>model</span><span>=</span><span>&#39;gpt-3.5-turbo:finetuned-123&#39;</span><span>,</span> <span>mode</span><span>=</span><span>&#34;dispatch&#34;</span><span>)</span> <span>#(1)!</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span>def</span> <span>distil_summarization</span><span>(</span><span>text</span><span>:</span> <span>str</span><span>)</span> <span>-&gt;</span> <span>GeneratedSummary</span><span>:</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>    <span>summary_chain</span><span>:</span> <span>List</span><span>[</span><span>str</span><span>]</span> <span>=</span> <span>summarize_article</span><span>(</span><span>text</span><span>)</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span>return</span> <span>GeneratedSummary</span><span>(</span><span>summary</span><span>=</span><span>summary_chain</span><span>[</span><span>-</span><span>1</span><span>])</span>
</span></code></pre></div> <ol> <li>Don&#39;t forget to replace this with your new model id. OpenAI identifies fine tuned models with an id of ft:gpt-3.5-turbo-0613:personal::<id> under their Fine-tuning tab on their dashboard</id></li> </ol> <p>With that, you&#39;ve now got your own fine-tuned model ready to go and serve data in production. We&#39;ve seen how Instructor can make your life easier, from fine-tuning to distillation.</p> <h2 id="results-and-benchmarks">Results and Benchmarks<a href="#results-and-benchmarks" title="Permanent link">¶</a></h2> <p>We&#39;l be comparing the following models in 3 ways using 20 articles that were not used for fine-tuning.</p> <ul> <li>Entity Density : This is entities per token, the higher the better for density.</li> <li>Latency : Time to last token generated in seconds</li> <li>Costs : Total cost to generate outputs - we break down the cost into training and inference costs for easy reference</li> </ul> <dl> <dt><code>3.5 Finetuned (n)</code></dt> <dd> <p>This is a GPT 3.5 model that we fine-tuned on <code>n</code> examples. Each model was finetuned for 4-5 epochs ( This was automatically decided by the OpenAI scheduler )</p> </dd> <dt><code>GPT-4 (COD)</code></dt> <dd> <p>This is a GPT4 model which we applied 3 rounds of Chain Of Density rewrites to generate a summary with using the methodology above</p> </dd> <dt><code>GPT-3 (Vanilla)</code></dt> <dd> <p>This is a GPT 3.5 model that we asked to generate entity-dense summaries which were concise. Summaries were generated in a single pass</p> </dd> </dl> <table> <thead> <tr> <th>Model</th> <th>Mean Latency (s)</th> <th>Mean Entity Count</th> <th>Mean Entity Density</th> <th>Mean Tokens</th> </tr> </thead> <tbody> <tr> <td>GPT-4 (COD)</td> <td>49.5</td> <td>11.3</td> <td>0.138</td> <td>81.65</td> </tr> <tr> <td>GPT-3.5 (Vanilla)</td> <td>16.8</td> <td>11.95</td> <td>0.122</td> <td>98.35</td> </tr> <tr> <td>3.5 Finetuned (20)</td> <td>2.25</td> <td>14.7</td> <td>0.154</td> <td>95.45</td> </tr> <tr> <td>3.5 Finetuned (50)</td> <td>2.09</td> <td>12.4</td> <td>0.140</td> <td>88.35</td> </tr> <tr> <td>3.5 Finetuned (76)</td> <td>2.17</td> <td>11.65</td> <td>0.142</td> <td>82.05</td> </tr> </tbody> </table> <details> <summary>Finetuning Datasets</summary> <p>For our finetuned models, we did a few optimisations to raise the performance.</p> <p>We only included summaries that had a minimum density of 0.15 in the dataset, took the summary in the entire chain with the highest density as the final one, forced every regenerated summary to have a minimum density of 0.12 and regenerated summaries up to three times if they didn&#39;t meet the summaries. <strong>This is a much more expensive strategy and can cost up to 2.5x or more what we do in this tutorial</strong></p> <p>This resulted in the total cost of $63.46 to generate just 75 examples due to the stringent requirements, translating to about $0.85 per generated summary example.</p> </details> <p>Using the OpenAI Usage Dashboard, we can calculate the cost of generating 20 summaries as seen below.</p> <table> <thead> <tr> <th>Model</th> <th>Training Cost ($)</th> <th>Inference Cost ($)</th> <th>Tokens Used</th> <th>Total Cost ($)</th> </tr> </thead> <tbody> <tr> <td>3.5 Finetuned (20)</td> <td>0.664</td> <td>0.207</td> <td>56,573</td> <td>0.817</td> </tr> <tr> <td>3.5 Finetuned (50)</td> <td>1.368</td> <td>0.165</td> <td>49,057</td> <td>1.266</td> </tr> <tr> <td>3.5 Finetuned (76)</td> <td>1.824</td> <td>0.174</td> <td>51,583</td> <td>2.481</td> </tr> <tr> <td>GPT-4 (COD)</td> <td>-</td> <td>12.9</td> <td>409,062</td> <td>12.9</td> </tr> <tr> <td>GPT-3.5 (Vanilla)</td> <td>-</td> <td>0.20</td> <td>51,162</td> <td>0.2</td> </tr> </tbody> </table> <p>Here, we can see that <code>GPT-4</code> has an approximate inference cost of <code>0.65</code> per summary while our finetuned models have an inference cost of <code>0.0091</code> per summary which is ~ <code>72x</code> cheaper.</p> <p>Interestingly, the model finetuned with the least examples seems to outperform the others. While the reason for this is unknown, a few potential reasons could be that either we didn&#39;t train for sufficient epochs ( We chose the default 5 epochs ) or that the models started learning to imitate other behaviour such as more abstract writing styles from the larger variety of samples, resulting in a decrease in entity density.</p> <h2 id="conclusions">Conclusions<a href="#conclusions" title="Permanent link">¶</a></h2> <p>Finetuning this iterative method was 20-40x faster while improving overall performance, resulting in massive efficiency gains by finetuning and distilling capabilities into specialized models.</p> <p>We&#39;ve seen how <code>Instructor</code> can make your life easier, from data modeling to distilation and finetuning. If you enjoy the content or want to try out <code>instructor</code> check out the <a href="https://github.com/jxnl/instructor">github</a> and don&#39;t forget to give us a star!</p>  </article> </div>   </div>  </div></div>
  </body>
</html>
