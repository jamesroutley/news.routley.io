<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/hassanshaikley/pico-pubsub">Original</a>
    <h1>Show HN: JavaScript PubSub in 163 Bytes</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">The smallest PubSub library possible. Zero Dependencies. 149 bytes.</p>
<p dir="auto">I wrote <a href="https://hassanshaikley.medium.com/pubsub-in-half-a-kilobyte-b6cf6a66d674" rel="nofollow">this article</a> a while back. But I realized...why not just publish the code?</p>
<p dir="auto">Smaller than the competition.</p>
<ul dir="auto">
<li><a href="https://github.com/bjoerge/nano-pubsub"><code>nano-pubsub</code></a></li>
<li><a href="https://github.com/LukeWood/tiny-pubsub"><code>tiny-pubusb</code></a></li>
</ul>
<p dir="auto">Built with JS13K games in mind. Such as <a href="https://cred.fly.dev/html/index.html" rel="nofollow">cred</a> which is unfortunately in need of some weight loss soon, it is almost 25KB now.</p>
<p dir="auto"><sup><sub>If you have any ideas that may trim off even one single byte please share it. Create an issue! I don&#39;t mind.</sub></sup></p>

<p dir="auto">This is the entire source (<a href="https://github.com/hassanshaikley/pico-pubsub/blob/master/index.js">index.js</a>).</p>
<div dir="auto" data-snippet-clipboard-copy-content="let t = new EventTarget();

sub = (e, c) =&gt; (t.addEventListener(e, c), () =&gt; t.removeEventListener(e, c));
pub = (n, d) =&gt; t.dispatchEvent(new CustomEvent(n, { detail: d }));"><pre><span>let</span> <span>t</span> <span>=</span> <span>new</span> <span>EventTarget</span><span>(</span><span>)</span><span>;</span>

<span>sub</span> <span>=</span> <span>(</span><span>e</span><span>,</span> <span>c</span><span>)</span> <span>=&gt;</span> <span>(</span><span>t</span><span>.</span><span>addEventListener</span><span>(</span><span>e</span><span>,</span> <span>c</span><span>)</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>t</span><span>.</span><span>removeEventListener</span><span>(</span><span>e</span><span>,</span> <span>c</span><span>)</span><span>)</span><span>;</span>
<span>pub</span> <span>=</span> <span>(</span><span>n</span><span>,</span> <span>d</span><span>)</span> <span>=&gt;</span> <span>t</span><span>.</span><span>dispatchEvent</span><span>(</span><span>new</span> <span>CustomEvent</span><span>(</span><span>n</span><span>,</span> <span>{</span> <span>detail</span>: <span>d</span> <span>}</span><span>)</span><span>)</span><span>;</span></pre></div>


<div dir="auto" data-snippet-clipboard-copy-content="import &#34;pico-pubsub&#34;

const unsub = sub(&#39;jump&#39;, function (anything) {
  console.log(&#34;someone jumped - &#34; + anything.detail)
});

pub(&#39;jump&#39;, &#34;a_user_id&#34;)
&gt;&gt; &#34;someone jumped - a_user_id&#34;

unsub()

pub(&#39;jump&#39;, &#34;another_user_id&#34;)
&gt;&gt; Nothing happens now"><pre><span>import</span> <span>&#34;pico-pubsub&#34;</span>

<span>const</span> <span>unsub</span> <span>=</span> <span>sub</span><span>(</span><span>&#39;jump&#39;</span><span>,</span> <span>function</span> <span>(</span><span>anything</span><span>)</span> <span>{</span>
  <span>console</span><span>.</span><span>log</span><span>(</span><span>&#34;someone jumped - &#34;</span> <span>+</span> <span>anything</span><span>.</span><span>detail</span><span>)</span>
<span>}</span><span>)</span><span>;</span>

<span>pub</span><span>(</span><span>&#39;jump&#39;</span><span>,</span> <span>&#34;a_user_id&#34;</span><span>)</span>
<span>&gt;&gt;</span> <span>&#34;someone jumped - a_user_id&#34;</span>

<span>unsub</span><span>(</span><span>)</span>

<span>pub</span><span>(</span><span>&#39;jump&#39;</span><span>,</span> <span>&#34;another_user_id&#34;</span><span>)</span>
<span>&gt;&gt;</span> <span>Nothing</span> <span>happens</span> <span>now</span></pre></div>

<ul dir="auto">
<li>Might add TS support in the future. For now you can use the following snippet.</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="declare global {
  function pub(event: string, data: any): VoidFunction;
  function sub(event: string, callback: (data: CustomEvent) =&gt; void): void;
}"><pre><span>declare</span> global <span>{</span>
  <span>function</span> <span>pub</span><span>(</span><span>event</span>: <span>string</span><span>,</span> <span>data</span>: <span>any</span><span>)</span>: <span>VoidFunction</span><span>;</span>
  <span>function</span> <span>sub</span><span>(</span><span>event</span>: <span>string</span><span>,</span> <span>callback</span>: <span>(</span><span>data</span>: <span>CustomEvent</span><span>)</span> <span>=&gt;</span> <span><span>void</span></span><span>)</span>: <span><span>void</span></span><span>;</span>
<span>}</span></pre></div>
<ul dir="auto">
<li>If you have export issues just copy paste and change export type.</li>
</ul>

<p dir="auto">The following command will produce a <code>149b</code> file:</p>
<p dir="auto"><code>npx esbuild index.js --bundle --minify --format=esm --outfile=bundle.js</code></p>

<p dir="auto">Coming in at #2 we have <a href="https://github.com/bjoerge/nano-pubsub/blob/main/src/index.ts">nano-pubsub</a> which slims down to an impressive <code>194b</code>...Not bad at all! Only ~<code>30%</code> larger.</p>
<div dir="auto" data-snippet-clipboard-copy-content="/**
 * @public
 */
export interface Subscriber&lt;Event&gt; {
  (event: Event): void;
}
/**
 * @public
 */
export interface PubSub&lt;Message&gt; {
  publish: (message: Message) =&gt; void;
  subscribe: (subscriber: Subscriber&lt;Message&gt;) =&gt; () =&gt; void;
}

/**
 * @public
 */
export default function createPubSub&lt;Message = void&gt;(): PubSub&lt;Message&gt; {
  const subscribers: { [id: string]: Subscriber&lt;Message&gt; } =
    Object.create(null);
  let nextId = 0;
  function subscribe(subscriber: Subscriber&lt;Message&gt;) {
    const id = nextId++;
    subscribers[id] = subscriber;
    return function unsubscribe() {
      delete subscribers[id];
    };
  }

  function publish(event: Message) {
    for (const id in subscribers) {
      subscribers[id](event);
    }
  }

  return {
    publish,
    subscribe,
  };
}"><pre><span>/**</span>
<span> * <span>@public</span></span>
<span> */</span>
<span>export</span> <span>interface</span> <span>Subscriber</span><span>&lt;</span><span>Event</span><span>&gt;</span> <span>{</span>
  <span>(</span><span>event</span>: <span>Event</span><span>)</span>: <span><span>void</span></span><span>;</span>
<span>}</span>
<span>/**</span>
<span> * <span>@public</span></span>
<span> */</span>
<span>export</span> <span>interface</span> <span>PubSub</span><span>&lt;</span><span>Message</span><span>&gt;</span> <span>{</span>
  <span>publish</span>: <span>(</span><span>message</span>: <span>Message</span><span>)</span> <span>=&gt;</span> <span><span>void</span></span><span>;</span>
  <span>subscribe</span>: <span>(</span><span>subscriber</span>: <span>Subscriber</span><span>&lt;</span><span>Message</span><span>&gt;</span><span>)</span> <span>=&gt;</span> <span>(</span><span>)</span> <span>=&gt;</span> <span><span>void</span></span><span>;</span>
<span>}</span>

<span>/**</span>
<span> * <span>@public</span></span>
<span> */</span>
<span>export</span> <span>default</span> <span>function</span> <span>createPubSub</span><span>&lt;</span><span>Message</span> <span>=</span> <span><span>void</span></span><span>&gt;</span><span>(</span><span>)</span>: <span>PubSub</span><span>&lt;</span><span>Message</span><span>&gt;</span> <span>{</span>
  <span>const</span> <span>subscribers</span>: <span>{</span> <span>[</span><span>id</span>: <span>string</span><span>]</span>: <span>Subscriber</span><span>&lt;</span><span>Message</span><span>&gt;</span> <span>}</span> <span>=</span>
    <span>Object</span><span>.</span><span>create</span><span>(</span><span>null</span><span>)</span><span>;</span>
  <span>let</span> <span>nextId</span> <span>=</span> <span>0</span><span>;</span>
  <span>function</span> <span>subscribe</span><span>(</span><span>subscriber</span>: <span>Subscriber</span><span>&lt;</span><span>Message</span><span>&gt;</span><span>)</span> <span>{</span>
    <span>const</span> <span>id</span> <span>=</span> <span>nextId</span><span>++</span><span>;</span>
    <span>subscribers</span><span>[</span><span>id</span><span>]</span> <span>=</span> <span>subscriber</span><span>;</span>
    <span>return</span> <span>function</span> <span>unsubscribe</span><span>(</span><span>)</span> <span>{</span>
      <span>delete</span> <span>subscribers</span><span>[</span><span>id</span><span>]</span><span>;</span>
    <span>}</span><span>;</span>
  <span>}</span>

  <span>function</span> <span>publish</span><span>(</span><span>event</span>: <span>Message</span><span>)</span> <span>{</span>
    <span>for</span> <span>(</span><span>const</span> <span>id</span> <span>in</span> <span>subscribers</span><span>)</span> <span>{</span>
      <span>subscribers</span><span>[</span><span>id</span><span>]</span><span>(</span><span>event</span><span>)</span><span>;</span>
    <span>}</span>
  <span>}</span>

  <span>return</span> <span>{</span>
    publish<span>,</span>
    subscribe<span>,</span>
  <span>}</span><span>;</span>
<span>}</span></pre></div>
<p dir="auto">And at #3 we have <a href="https://github.com/LukeWood/tiny-pubsub/blob/master/pubsub.js">tiny-pubsub</a> which brings a non critical function to the table as well as an extra function with the way it handles unsubscribing! The agony! This comes in at a whopping <code>401b</code>, more than twice <code>nano-pubsub</code>!</p>
<div dir="auto" data-snippet-clipboard-copy-content="let subscriptions = Object.create(null);

function subscribe(evt, func) {
  if (typeof func !== &#34;function&#34;) {
    throw &#34;Subscribers must be functions&#34;;
  }
  const oldSubscriptions = subscriptions[evt] || [];
  oldSubscriptions.push(func);
  subscriptions[evt] = oldSubscriptions;
}

function publish(evt) {
  let args = Array.prototype.slice.call(arguments, 1);
  const subFunctions = subscriptions[evt] || [];
  for (let i = 0; i &lt; subFunctions.length; i++) {
    subFunctions[i].apply(null, args);
  }
}

function unsubscribe(evt, func) {
  const oldSubscriptions = subscriptions[evt] || [];
  const newSubscriptions = oldSubscriptions.filter((item) =&gt; item !== func);
  subscriptions[evt] = newSubscriptions;
}

function cancel(evt) {
  delete subscriptions[evt];
}

module.exports = { subscribe, publish, unsubscribe, cancel };"><pre><span>let</span> <span>subscriptions</span> <span>=</span> <span>Object</span><span>.</span><span>create</span><span>(</span><span>null</span><span>)</span><span>;</span>

<span>function</span> <span>subscribe</span><span>(</span><span>evt</span><span>,</span> <span>func</span><span>)</span> <span>{</span>
  <span>if</span> <span>(</span><span>typeof</span> <span>func</span> <span>!==</span> <span>&#34;function&#34;</span><span>)</span> <span>{</span>
    <span>throw</span> <span>&#34;Subscribers must be functions&#34;</span><span>;</span>
  <span>}</span>
  <span>const</span> <span>oldSubscriptions</span> <span>=</span> <span>subscriptions</span><span>[</span><span>evt</span><span>]</span> <span>||</span> <span>[</span><span>]</span><span>;</span>
  <span>oldSubscriptions</span><span>.</span><span>push</span><span>(</span><span>func</span><span>)</span><span>;</span>
  <span>subscriptions</span><span>[</span><span>evt</span><span>]</span> <span>=</span> <span>oldSubscriptions</span><span>;</span>
<span>}</span>

<span>function</span> <span>publish</span><span>(</span><span>evt</span><span>)</span> <span>{</span>
  <span>let</span> <span>args</span> <span>=</span> <span>Array</span><span>.</span><span>prototype</span><span>.</span><span>slice</span><span>.</span><span>call</span><span>(</span><span>arguments</span><span>,</span> <span>1</span><span>)</span><span>;</span>
  <span>const</span> <span>subFunctions</span> <span>=</span> <span>subscriptions</span><span>[</span><span>evt</span><span>]</span> <span>||</span> <span>[</span><span>]</span><span>;</span>
  <span>for</span> <span>(</span><span>let</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>subFunctions</span><span>.</span><span>length</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>{</span>
    <span>subFunctions</span><span>[</span><span>i</span><span>]</span><span>.</span><span>apply</span><span>(</span><span>null</span><span>,</span> <span>args</span><span>)</span><span>;</span>
  <span>}</span>
<span>}</span>

<span>function</span> <span>unsubscribe</span><span>(</span><span>evt</span><span>,</span> <span>func</span><span>)</span> <span>{</span>
  <span>const</span> <span>oldSubscriptions</span> <span>=</span> <span>subscriptions</span><span>[</span><span>evt</span><span>]</span> <span>||</span> <span>[</span><span>]</span><span>;</span>
  <span>const</span> <span>newSubscriptions</span> <span>=</span> <span>oldSubscriptions</span><span>.</span><span>filter</span><span>(</span><span>(</span><span>item</span><span>)</span> <span>=&gt;</span> <span>item</span> <span>!==</span> <span>func</span><span>)</span><span>;</span>
  <span>subscriptions</span><span>[</span><span>evt</span><span>]</span> <span>=</span> <span>newSubscriptions</span><span>;</span>
<span>}</span>

<span>function</span> <span>cancel</span><span>(</span><span>evt</span><span>)</span> <span>{</span>
  <span>delete</span> <span>subscriptions</span><span>[</span><span>evt</span><span>]</span><span>;</span>
<span>}</span>

<span>module</span><span>.</span><span>exports</span> <span>=</span> <span>{</span> subscribe<span>,</span> publish<span>,</span> unsubscribe<span>,</span> cancel <span>}</span><span>;</span></pre></div>

<p dir="auto">If you don&#39;t want to use the <code>window</code> object just do this, just know it&#39;ll cost ya 7 bytes:</p>
<div dir="auto" data-snippet-clipboard-copy-content="let t = new EventTarget();

export default {
  s: (e, c) =&gt; (t.addEventListener(e, c), () =&gt; t.removeEventListener(e, c)),
  p: (n, d) =&gt; t.dispatchEvent(new CustomEvent(n, { detail: d })),
};"><pre><span>let</span> <span>t</span> <span>=</span> <span>new</span> <span>EventTarget</span><span>(</span><span>)</span><span>;</span>

<span>export</span> <span>default</span> <span>{</span>
  <span>s</span>: <span>(</span><span>e</span><span>,</span> <span>c</span><span>)</span> <span>=&gt;</span> <span>(</span><span>t</span><span>.</span><span>addEventListener</span><span>(</span><span>e</span><span>,</span> <span>c</span><span>)</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>t</span><span>.</span><span>removeEventListener</span><span>(</span><span>e</span><span>,</span> <span>c</span><span>)</span><span>)</span><span>,</span>
  <span>p</span>: <span>(</span><span>n</span><span>,</span> <span>d</span><span>)</span> <span>=&gt;</span> <span>t</span><span>.</span><span>dispatchEvent</span><span>(</span><span>new</span> <span>CustomEvent</span><span>(</span><span>n</span><span>,</span> <span>{</span> <span>detail</span>: <span>d</span> <span>}</span><span>)</span><span>)</span><span>,</span>
<span>}</span><span>;</span></pre></div>
</article></div></div>
  </body>
</html>
