<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.cuongle.dev/p/inside-rusts-std-and-parking-lot-mutexes-who-win">Original</a>
    <h1>Inside Rust&#39;s std and parking_lot mutexes – who wins?</h1>
    
    <div id="readability-page-1" class="page"><div><div><div><article><div><div><div dir="auto"><p><span>A while ago, our team was working on a Rust project where </span><strong>std::sync::Mutex</strong><span> was everywhere. A team member suggested switching to </span><strong>parking_lot::Mutex</strong><span> instead. They heard that it has better performance, smaller memory footprint, and more predictable behavior under contention.</span></p><p>I had no idea how to evaluate this claim. A quick search online returned results favoring parking_lot. This felt wrong to me. Why? It contradicted my belief that std should be the gold standard. The standard library team knows what they’re doing, right? And if parking_lot’s mutex really was the performance winner, there had to be trade-offs between the two implementations that people weren’t talking about.</p><p>That mystery haunted me. I couldn’t just take it on faith. So I jumped down the rabbit hole: read both implementations, wrote the benchmarks, and here we are. In this post, I will:</p><ul><li><p>Explain how std implements the mutex (v1.90.0)</p></li><li><p>Explain how parking_lot implements their mutex (v0.12.5)</p></li><li><p>Show you the benchmark with key findings</p></li><li><p>Give you a decision guide for when to use each</p></li></ul><p>But first, let’s ground our foundation on mutexes (skim it if you’re already familiar).</p><p>A classic example of the kind of problem that mutex solves is withdrawing and receiving money at the same time. Imagine you have $100 in your account. Thread A tries to withdraw $80, and Thread B tries to deposit $50. Without proper synchronization, both threads might read the balance as $100 simultaneously, then write back their results independently:</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!tCcw!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F10eed961-c27c-4fc9-95ab-27a9ae9d9451_668x264.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!tCcw!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F10eed961-c27c-4fc9-95ab-27a9ae9d9451_668x264.png 424w, https://substackcdn.com/image/fetch/$s_!tCcw!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F10eed961-c27c-4fc9-95ab-27a9ae9d9451_668x264.png 848w, https://substackcdn.com/image/fetch/$s_!tCcw!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F10eed961-c27c-4fc9-95ab-27a9ae9d9451_668x264.png 1272w, https://substackcdn.com/image/fetch/$s_!tCcw!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F10eed961-c27c-4fc9-95ab-27a9ae9d9451_668x264.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!tCcw!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F10eed961-c27c-4fc9-95ab-27a9ae9d9451_668x264.png" width="668" height="264" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/10eed961-c27c-4fc9-95ab-27a9ae9d9451_668x264.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:false,&#34;imageSize&#34;:&#34;normal&#34;,&#34;height&#34;:264,&#34;width&#34;:668,&#34;resizeWidth&#34;:668,&#34;bytes&#34;:36291,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:false,&#34;topImage&#34;:true,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F10eed961-c27c-4fc9-95ab-27a9ae9d9451_668x264.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:&#34;center&#34;,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!tCcw!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F10eed961-c27c-4fc9-95ab-27a9ae9d9451_668x264.png 424w, https://substackcdn.com/image/fetch/$s_!tCcw!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F10eed961-c27c-4fc9-95ab-27a9ae9d9451_668x264.png 848w, https://substackcdn.com/image/fetch/$s_!tCcw!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F10eed961-c27c-4fc9-95ab-27a9ae9d9451_668x264.png 1272w, https://substackcdn.com/image/fetch/$s_!tCcw!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F10eed961-c27c-4fc9-95ab-27a9ae9d9451_668x264.png 1456w" sizes="100vw" fetchpriority="high"/></picture><div></div></div></a></figure></div><p>Mutex solves this nicely by having a thread wait until the other finishes its update:</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!36kg!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f26bcb8-127f-46cc-baf7-4743e02d8088_646x374.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!36kg!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f26bcb8-127f-46cc-baf7-4743e02d8088_646x374.png 424w, https://substackcdn.com/image/fetch/$s_!36kg!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f26bcb8-127f-46cc-baf7-4743e02d8088_646x374.png 848w, https://substackcdn.com/image/fetch/$s_!36kg!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f26bcb8-127f-46cc-baf7-4743e02d8088_646x374.png 1272w, https://substackcdn.com/image/fetch/$s_!36kg!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f26bcb8-127f-46cc-baf7-4743e02d8088_646x374.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!36kg!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f26bcb8-127f-46cc-baf7-4743e02d8088_646x374.png" width="646" height="374" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/3f26bcb8-127f-46cc-baf7-4743e02d8088_646x374.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:374,&#34;width&#34;:646,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:77908,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f26bcb8-127f-46cc-baf7-4743e02d8088_646x374.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!36kg!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f26bcb8-127f-46cc-baf7-4743e02d8088_646x374.png 424w, https://substackcdn.com/image/fetch/$s_!36kg!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f26bcb8-127f-46cc-baf7-4743e02d8088_646x374.png 848w, https://substackcdn.com/image/fetch/$s_!36kg!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f26bcb8-127f-46cc-baf7-4743e02d8088_646x374.png 1272w, https://substackcdn.com/image/fetch/$s_!36kg!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f26bcb8-127f-46cc-baf7-4743e02d8088_646x374.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><p><span>The operations that read and write the balance are what we need to protect - these are called </span><strong>critical sections</strong><span>. Any code that accesses shared data needs to be inside a critical section, guarded by a mutex.</span></p><p>Simple enough, right? Now let’s see how to use a mutex. (Again, skim this if it’s too basic for you)</p><p>In languages other than Rust, you typically declare a mutex separately from your data, then manually lock it before entering the critical section and unlock it afterward. Here’s how it looks in C++:</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!2Y36!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff5bb72b0-812e-4ef2-a5f2-3239c22daea3_1160x714.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!2Y36!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff5bb72b0-812e-4ef2-a5f2-3239c22daea3_1160x714.png 424w, https://substackcdn.com/image/fetch/$s_!2Y36!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff5bb72b0-812e-4ef2-a5f2-3239c22daea3_1160x714.png 848w, https://substackcdn.com/image/fetch/$s_!2Y36!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff5bb72b0-812e-4ef2-a5f2-3239c22daea3_1160x714.png 1272w, https://substackcdn.com/image/fetch/$s_!2Y36!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff5bb72b0-812e-4ef2-a5f2-3239c22daea3_1160x714.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!2Y36!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff5bb72b0-812e-4ef2-a5f2-3239c22daea3_1160x714.png" width="1160" height="714" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/f5bb72b0-812e-4ef2-a5f2-3239c22daea3_1160x714.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:714,&#34;width&#34;:1160,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:103118,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff5bb72b0-812e-4ef2-a5f2-3239c22daea3_1160x714.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!2Y36!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff5bb72b0-812e-4ef2-a5f2-3239c22daea3_1160x714.png 424w, https://substackcdn.com/image/fetch/$s_!2Y36!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff5bb72b0-812e-4ef2-a5f2-3239c22daea3_1160x714.png 848w, https://substackcdn.com/image/fetch/$s_!2Y36!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff5bb72b0-812e-4ef2-a5f2-3239c22daea3_1160x714.png 1272w, https://substackcdn.com/image/fetch/$s_!2Y36!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff5bb72b0-812e-4ef2-a5f2-3239c22daea3_1160x714.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><p><span>The problem? Nothing stops you from accessing </span><strong>account</strong><span> without locking the mutex first. The compiler won’t catch this bug.</span></p><p>Rust takes a completely different approach - the mutex wraps and owns the data:</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!0DUz!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F527dfd6d-3347-45db-ab9e-0b14e40357ba_1160x752.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!0DUz!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F527dfd6d-3347-45db-ab9e-0b14e40357ba_1160x752.png 424w, https://substackcdn.com/image/fetch/$s_!0DUz!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F527dfd6d-3347-45db-ab9e-0b14e40357ba_1160x752.png 848w, https://substackcdn.com/image/fetch/$s_!0DUz!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F527dfd6d-3347-45db-ab9e-0b14e40357ba_1160x752.png 1272w, https://substackcdn.com/image/fetch/$s_!0DUz!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F527dfd6d-3347-45db-ab9e-0b14e40357ba_1160x752.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!0DUz!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F527dfd6d-3347-45db-ab9e-0b14e40357ba_1160x752.png" width="1160" height="752" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/527dfd6d-3347-45db-ab9e-0b14e40357ba_1160x752.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:752,&#34;width&#34;:1160,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:123218,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F527dfd6d-3347-45db-ab9e-0b14e40357ba_1160x752.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!0DUz!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F527dfd6d-3347-45db-ab9e-0b14e40357ba_1160x752.png 424w, https://substackcdn.com/image/fetch/$s_!0DUz!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F527dfd6d-3347-45db-ab9e-0b14e40357ba_1160x752.png 848w, https://substackcdn.com/image/fetch/$s_!0DUz!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F527dfd6d-3347-45db-ab9e-0b14e40357ba_1160x752.png 1272w, https://substackcdn.com/image/fetch/$s_!0DUz!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F527dfd6d-3347-45db-ab9e-0b14e40357ba_1160x752.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><p>Three things to pay close attention to:</p><ul><li><p><strong>The mutex wraps the data</strong><span>: This makes it impossible to access </span><strong>account</strong><span> without holding the lock. The compiler enforces this.</span></p></li><li><p><strong>Automatic unlock</strong><span>: When you lock, you receive a guard. When the guard goes out of scope, it automatically unlocks. No manual cleanup needed.</span></p></li><li><p><strong>Lock can fail</strong><span>: Notice the </span><strong>.unwrap()</strong><span> on </span><strong>.lock()</strong><span>? It returns a </span><strong>Result</strong><span> because locking can fail due to poisoning. I’ll explain this shortly.</span></p></li></ul><p>That’s enough of the basics. Let’s have some fun. Here is how mutex is implemented, starting with Rust std.</p><p>A quick look into std::Mutex gives us this</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!s6rZ!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F634dc677-ea09-4213-911f-57888b36c471_1160x342.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!s6rZ!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F634dc677-ea09-4213-911f-57888b36c471_1160x342.png 424w, https://substackcdn.com/image/fetch/$s_!s6rZ!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F634dc677-ea09-4213-911f-57888b36c471_1160x342.png 848w, https://substackcdn.com/image/fetch/$s_!s6rZ!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F634dc677-ea09-4213-911f-57888b36c471_1160x342.png 1272w, https://substackcdn.com/image/fetch/$s_!s6rZ!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F634dc677-ea09-4213-911f-57888b36c471_1160x342.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!s6rZ!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F634dc677-ea09-4213-911f-57888b36c471_1160x342.png" width="1160" height="342" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/634dc677-ea09-4213-911f-57888b36c471_1160x342.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:342,&#34;width&#34;:1160,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:null,&#34;alt&#34;:&#34;&#34;,&#34;title&#34;:null,&#34;type&#34;:null,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" title="" srcset="https://substackcdn.com/image/fetch/$s_!s6rZ!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F634dc677-ea09-4213-911f-57888b36c471_1160x342.png 424w, https://substackcdn.com/image/fetch/$s_!s6rZ!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F634dc677-ea09-4213-911f-57888b36c471_1160x342.png 848w, https://substackcdn.com/image/fetch/$s_!s6rZ!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F634dc677-ea09-4213-911f-57888b36c471_1160x342.png 1272w, https://substackcdn.com/image/fetch/$s_!s6rZ!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F634dc677-ea09-4213-911f-57888b36c471_1160x342.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><ul><li><p><strong>data</strong><span> is the easy part. Since the mutex enforces exclusive access, Rust uses UnsafeCell to give you safe mutable access once it’s locked.</span></p></li><li><p><strong>poison</strong><span> is just </span><strong>Atomic&lt;bool&gt;</strong><span> flag to tell if the last thread acquired the lock panic. So, maybe you would want to handle it next time you lock it.</span></p></li></ul><p><strong>inner</strong><span> is interesting part, let’s look at it next. The code is really long, so I just show a simplified version here</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!slfu!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0e02fd8e-b3ce-402e-8059-eea9fb3d4965_1160x976.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!slfu!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0e02fd8e-b3ce-402e-8059-eea9fb3d4965_1160x976.png 424w, https://substackcdn.com/image/fetch/$s_!slfu!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0e02fd8e-b3ce-402e-8059-eea9fb3d4965_1160x976.png 848w, https://substackcdn.com/image/fetch/$s_!slfu!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0e02fd8e-b3ce-402e-8059-eea9fb3d4965_1160x976.png 1272w, https://substackcdn.com/image/fetch/$s_!slfu!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0e02fd8e-b3ce-402e-8059-eea9fb3d4965_1160x976.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!slfu!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0e02fd8e-b3ce-402e-8059-eea9fb3d4965_1160x976.png" width="1160" height="976" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/0e02fd8e-b3ce-402e-8059-eea9fb3d4965_1160x976.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:976,&#34;width&#34;:1160,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:153206,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0e02fd8e-b3ce-402e-8059-eea9fb3d4965_1160x976.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!slfu!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0e02fd8e-b3ce-402e-8059-eea9fb3d4965_1160x976.png 424w, https://substackcdn.com/image/fetch/$s_!slfu!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0e02fd8e-b3ce-402e-8059-eea9fb3d4965_1160x976.png 848w, https://substackcdn.com/image/fetch/$s_!slfu!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0e02fd8e-b3ce-402e-8059-eea9fb3d4965_1160x976.png 1272w, https://substackcdn.com/image/fetch/$s_!slfu!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0e02fd8e-b3ce-402e-8059-eea9fb3d4965_1160x976.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><p>The main idea is that for different OS (and OS version), Rust uses different Mutex implementation. However, we can divide these implementation to 2 big groups: Futex and other platform primitive.</p><ul><li><p>Futex (short for “fast userspace mutex”) is used where the OS kernels expose a “wait on this address” API. We will dive deeper into this one soon.</p></li><li><p>When that API is missing, Rust falls back to the best available platform traditional locks.</p></li></ul><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!xPH1!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8125b1da-37ca-4fa9-8641-86692fc7fa1f_620x330.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!xPH1!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8125b1da-37ca-4fa9-8641-86692fc7fa1f_620x330.png 424w, https://substackcdn.com/image/fetch/$s_!xPH1!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8125b1da-37ca-4fa9-8641-86692fc7fa1f_620x330.png 848w, https://substackcdn.com/image/fetch/$s_!xPH1!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8125b1da-37ca-4fa9-8641-86692fc7fa1f_620x330.png 1272w, https://substackcdn.com/image/fetch/$s_!xPH1!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8125b1da-37ca-4fa9-8641-86692fc7fa1f_620x330.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!xPH1!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8125b1da-37ca-4fa9-8641-86692fc7fa1f_620x330.png" width="620" height="330" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/8125b1da-37ca-4fa9-8641-86692fc7fa1f_620x330.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:330,&#34;width&#34;:620,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:196492,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8125b1da-37ca-4fa9-8641-86692fc7fa1f_620x330.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!xPH1!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8125b1da-37ca-4fa9-8641-86692fc7fa1f_620x330.png 424w, https://substackcdn.com/image/fetch/$s_!xPH1!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8125b1da-37ca-4fa9-8641-86692fc7fa1f_620x330.png 848w, https://substackcdn.com/image/fetch/$s_!xPH1!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8125b1da-37ca-4fa9-8641-86692fc7fa1f_620x330.png 1272w, https://substackcdn.com/image/fetch/$s_!xPH1!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8125b1da-37ca-4fa9-8641-86692fc7fa1f_620x330.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><p>(I’m in awe btw - that’s a lot of different implementations. Writing and maintaining all this platform-specific stuff must be exhausting. Major respect to whoever’s doing this.)</p><p>Since Futex is the most used and is quite a typical implementation for Mutex. Let’s look inside it.</p><p>At its heart, futex is just an atomic u32 (simplified here):</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!4h93!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F252d9b86-c436-4fb9-aba5-5dde4d5690b5_1160x194.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!4h93!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F252d9b86-c436-4fb9-aba5-5dde4d5690b5_1160x194.png 424w, https://substackcdn.com/image/fetch/$s_!4h93!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F252d9b86-c436-4fb9-aba5-5dde4d5690b5_1160x194.png 848w, https://substackcdn.com/image/fetch/$s_!4h93!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F252d9b86-c436-4fb9-aba5-5dde4d5690b5_1160x194.png 1272w, https://substackcdn.com/image/fetch/$s_!4h93!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F252d9b86-c436-4fb9-aba5-5dde4d5690b5_1160x194.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!4h93!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F252d9b86-c436-4fb9-aba5-5dde4d5690b5_1160x194.png" width="1160" height="194" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/252d9b86-c436-4fb9-aba5-5dde4d5690b5_1160x194.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:194,&#34;width&#34;:1160,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:20139,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F252d9b86-c436-4fb9-aba5-5dde4d5690b5_1160x194.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!4h93!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F252d9b86-c436-4fb9-aba5-5dde4d5690b5_1160x194.png 424w, https://substackcdn.com/image/fetch/$s_!4h93!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F252d9b86-c436-4fb9-aba5-5dde4d5690b5_1160x194.png 848w, https://substackcdn.com/image/fetch/$s_!4h93!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F252d9b86-c436-4fb9-aba5-5dde4d5690b5_1160x194.png 1272w, https://substackcdn.com/image/fetch/$s_!4h93!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F252d9b86-c436-4fb9-aba5-5dde4d5690b5_1160x194.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a></figure></div><p><span>Atomic type has this powerful operation called “Compare And Swap” (CAS) where the CPU executes it </span><strong>in an atomic call</strong><span>. It works by first comparing the value, if the value equals what is asked for, then it sets the value.</span></p><p>In other words, if we use value 0 for Unlocked state, and 1 for Locked state, we have a simple mutex where the thread can simply try to compare the state to 0 (Unlocked), and set to 1 (Locked). If the state is currently 1, keep doing that until successful.</p><p>So, a simplified version of mutex look like this:</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!vxbj!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5feddc98-679e-4832-96dd-ffa33f4ad87d_562x451.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!vxbj!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5feddc98-679e-4832-96dd-ffa33f4ad87d_562x451.png 424w, https://substackcdn.com/image/fetch/$s_!vxbj!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5feddc98-679e-4832-96dd-ffa33f4ad87d_562x451.png 848w, https://substackcdn.com/image/fetch/$s_!vxbj!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5feddc98-679e-4832-96dd-ffa33f4ad87d_562x451.png 1272w, https://substackcdn.com/image/fetch/$s_!vxbj!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5feddc98-679e-4832-96dd-ffa33f4ad87d_562x451.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!vxbj!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5feddc98-679e-4832-96dd-ffa33f4ad87d_562x451.png" width="562" height="451" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/5feddc98-679e-4832-96dd-ffa33f4ad87d_562x451.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:451,&#34;width&#34;:562,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:139603,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5feddc98-679e-4832-96dd-ffa33f4ad87d_562x451.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!vxbj!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5feddc98-679e-4832-96dd-ffa33f4ad87d_562x451.png 424w, https://substackcdn.com/image/fetch/$s_!vxbj!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5feddc98-679e-4832-96dd-ffa33f4ad87d_562x451.png 848w, https://substackcdn.com/image/fetch/$s_!vxbj!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5feddc98-679e-4832-96dd-ffa33f4ad87d_562x451.png 1272w, https://substackcdn.com/image/fetch/$s_!vxbj!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5feddc98-679e-4832-96dd-ffa33f4ad87d_562x451.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><p>But you might ask: if the first thread holds the lock for a long time, then the second thread needs to keep trying (like a infinite loop)? How about if there are hundreds or thousands of them? Maybe the CPU will soon be burnt.</p><p>Of course, there is the solution to this problem. In real implementation, Rust futex has 3 states:</p><ul><li><p>0: Unlocked</p></li><li><p>1: Locked</p></li><li><p>2: Contended - locked, but there are waiter.</p></li></ul><p>Notice the Contended state? A thread will try its best to acquire the lock. But if it can’t, it will mark the lock as contended and go to sleep, waiting for the process to wake it up when the mutex is released.</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!lkIj!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F836e330a-b1c2-4d3a-af29-9bd29343e216_555x352.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!lkIj!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F836e330a-b1c2-4d3a-af29-9bd29343e216_555x352.png 424w, https://substackcdn.com/image/fetch/$s_!lkIj!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F836e330a-b1c2-4d3a-af29-9bd29343e216_555x352.png 848w, https://substackcdn.com/image/fetch/$s_!lkIj!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F836e330a-b1c2-4d3a-af29-9bd29343e216_555x352.png 1272w, https://substackcdn.com/image/fetch/$s_!lkIj!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F836e330a-b1c2-4d3a-af29-9bd29343e216_555x352.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!lkIj!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F836e330a-b1c2-4d3a-af29-9bd29343e216_555x352.png" width="555" height="352" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/836e330a-b1c2-4d3a-af29-9bd29343e216_555x352.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:352,&#34;width&#34;:555,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:93565,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F836e330a-b1c2-4d3a-af29-9bd29343e216_555x352.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!lkIj!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F836e330a-b1c2-4d3a-af29-9bd29343e216_555x352.png 424w, https://substackcdn.com/image/fetch/$s_!lkIj!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F836e330a-b1c2-4d3a-af29-9bd29343e216_555x352.png 848w, https://substackcdn.com/image/fetch/$s_!lkIj!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F836e330a-b1c2-4d3a-af29-9bd29343e216_555x352.png 1272w, https://substackcdn.com/image/fetch/$s_!lkIj!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F836e330a-b1c2-4d3a-af29-9bd29343e216_555x352.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><p><strong>Note:</strong><span> See that spinning part in the diagram? Before a thread goes to sleep, it keeps checking the lock state for about 100 loops - if it becomes unlocked, the thread immediately tries CAS. This avoids the </span><strong>expensive syscall</strong><span> if the lock is released quickly.</span></p><p>What happens when a thread goes to sleep? The kernel helps us put these sleeping threads into a queue. Take a look at the system call on Linux and Android to put the thread into sleeping state (this is usually called “park a thread”):</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!YKa0!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6355b435-9dd7-40d3-bef1-8f4a7ae51e82_1160x640.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!YKa0!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6355b435-9dd7-40d3-bef1-8f4a7ae51e82_1160x640.png 424w, https://substackcdn.com/image/fetch/$s_!YKa0!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6355b435-9dd7-40d3-bef1-8f4a7ae51e82_1160x640.png 848w, https://substackcdn.com/image/fetch/$s_!YKa0!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6355b435-9dd7-40d3-bef1-8f4a7ae51e82_1160x640.png 1272w, https://substackcdn.com/image/fetch/$s_!YKa0!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6355b435-9dd7-40d3-bef1-8f4a7ae51e82_1160x640.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!YKa0!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6355b435-9dd7-40d3-bef1-8f4a7ae51e82_1160x640.png" width="1160" height="640" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/6355b435-9dd7-40d3-bef1-8f4a7ae51e82_1160x640.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:640,&#34;width&#34;:1160,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:null,&#34;alt&#34;:&#34;&#34;,&#34;title&#34;:null,&#34;type&#34;:null,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" title="" srcset="https://substackcdn.com/image/fetch/$s_!YKa0!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6355b435-9dd7-40d3-bef1-8f4a7ae51e82_1160x640.png 424w, https://substackcdn.com/image/fetch/$s_!YKa0!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6355b435-9dd7-40d3-bef1-8f4a7ae51e82_1160x640.png 848w, https://substackcdn.com/image/fetch/$s_!YKa0!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6355b435-9dd7-40d3-bef1-8f4a7ae51e82_1160x640.png 1272w, https://substackcdn.com/image/fetch/$s_!YKa0!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6355b435-9dd7-40d3-bef1-8f4a7ae51e82_1160x640.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><p><span>The key part is </span><strong>futex as *const Atomic&lt;u32&gt;</strong><span> - you give the kernel a memory address, and it queues your thread there. Later, when you want to wake a thread, you give the kernel that same address, and it dequeues and wakes a sleeper.</span></p><p>When a thread finishes, it sets the state to unlocked. If the state was contended, it wakes one waiting thread via syscall. This continues until the queue empties.</p><p>The final piece of std’s mutex is poisoning, a unique feature you won’t find in most other languages.</p><p><span>One unique feature of Rust’s standard mutex is poisoning. When a thread panics while holding a lock, the mutex becomes “poisoned.” Any subsequent attempts to lock it will return an </span><strong>Err(PoisonError)</strong><span>, but you still get the guard inside the error:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!I7Ry!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0e83077c-c835-4b9a-a89e-c8b1c03d89fb_1160x1088.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!I7Ry!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0e83077c-c835-4b9a-a89e-c8b1c03d89fb_1160x1088.png 424w, https://substackcdn.com/image/fetch/$s_!I7Ry!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0e83077c-c835-4b9a-a89e-c8b1c03d89fb_1160x1088.png 848w, https://substackcdn.com/image/fetch/$s_!I7Ry!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0e83077c-c835-4b9a-a89e-c8b1c03d89fb_1160x1088.png 1272w, https://substackcdn.com/image/fetch/$s_!I7Ry!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0e83077c-c835-4b9a-a89e-c8b1c03d89fb_1160x1088.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!I7Ry!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0e83077c-c835-4b9a-a89e-c8b1c03d89fb_1160x1088.png" width="1160" height="1088" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/0e83077c-c835-4b9a-a89e-c8b1c03d89fb_1160x1088.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:1088,&#34;width&#34;:1160,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:null,&#34;alt&#34;:&#34;&#34;,&#34;title&#34;:null,&#34;type&#34;:null,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" title="" srcset="https://substackcdn.com/image/fetch/$s_!I7Ry!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0e83077c-c835-4b9a-a89e-c8b1c03d89fb_1160x1088.png 424w, https://substackcdn.com/image/fetch/$s_!I7Ry!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0e83077c-c835-4b9a-a89e-c8b1c03d89fb_1160x1088.png 848w, https://substackcdn.com/image/fetch/$s_!I7Ry!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0e83077c-c835-4b9a-a89e-c8b1c03d89fb_1160x1088.png 1272w, https://substackcdn.com/image/fetch/$s_!I7Ry!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0e83077c-c835-4b9a-a89e-c8b1c03d89fb_1160x1088.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><p><span>How does poisoning work? Conceptually, it happens in the </span><strong>MutexGuard::drop()</strong><span> path (simplified here for clarity):</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!nQZQ!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F13c0888e-1b1d-4db3-9b24-c9325faf1b0c_1160x566.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!nQZQ!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F13c0888e-1b1d-4db3-9b24-c9325faf1b0c_1160x566.png 424w, https://substackcdn.com/image/fetch/$s_!nQZQ!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F13c0888e-1b1d-4db3-9b24-c9325faf1b0c_1160x566.png 848w, https://substackcdn.com/image/fetch/$s_!nQZQ!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F13c0888e-1b1d-4db3-9b24-c9325faf1b0c_1160x566.png 1272w, https://substackcdn.com/image/fetch/$s_!nQZQ!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F13c0888e-1b1d-4db3-9b24-c9325faf1b0c_1160x566.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!nQZQ!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F13c0888e-1b1d-4db3-9b24-c9325faf1b0c_1160x566.png" width="1160" height="566" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/13c0888e-1b1d-4db3-9b24-c9325faf1b0c_1160x566.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:566,&#34;width&#34;:1160,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:98586,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F13c0888e-1b1d-4db3-9b24-c9325faf1b0c_1160x566.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!nQZQ!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F13c0888e-1b1d-4db3-9b24-c9325faf1b0c_1160x566.png 424w, https://substackcdn.com/image/fetch/$s_!nQZQ!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F13c0888e-1b1d-4db3-9b24-c9325faf1b0c_1160x566.png 848w, https://substackcdn.com/image/fetch/$s_!nQZQ!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F13c0888e-1b1d-4db3-9b24-c9325faf1b0c_1160x566.png 1272w, https://substackcdn.com/image/fetch/$s_!nQZQ!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F13c0888e-1b1d-4db3-9b24-c9325faf1b0c_1160x566.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><p>The guard captures whether the thread was panicking when the lock was acquired. If we weren’t panicking then but we are now, a panic must have occurred in the critical section. The mutex is marked as poisoned with a simple atomic store.</p><p>This is a “best effort” mechanism. It won’t catch all cases (like double panics or non-Rust exceptions), but it provides a useful safety net. The key insight is that you still get access to the data even if the mutex is poisoned, allowing you to inspect and potentially recover from the corrupted state.</p><p><strong>Big note:</strong><span> mutex poisoning gets both love and hate. It catches data corruption but feels awkward compared to other languages (Me too, I know it’s helpful. But I still hate it, lol). The Rust team is adding a non-poisoning variant - see </span><a href="https://github.com/rust-lang/rust/issues/134645" rel="">issue#134645</a></p><p>parking_lot takes a fundamentally different approach. Two key differences:</p><ul><li><p>std uses different mutex implementations per platform. parking_lot uses one algorithm everywhere, calling platform-specific code only for sleep/wake.</p></li><li><p>std’s queues live in the kernel. parking_lot manages its own queues in user space via a global hash table.</p></li></ul><p>parking_lot’s mutex is remarkably small:</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!tu7E!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51bf2366-be3b-41bc-9edd-4f90c49e5d67_1160x380.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!tu7E!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51bf2366-be3b-41bc-9edd-4f90c49e5d67_1160x380.png 424w, https://substackcdn.com/image/fetch/$s_!tu7E!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51bf2366-be3b-41bc-9edd-4f90c49e5d67_1160x380.png 848w, https://substackcdn.com/image/fetch/$s_!tu7E!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51bf2366-be3b-41bc-9edd-4f90c49e5d67_1160x380.png 1272w, https://substackcdn.com/image/fetch/$s_!tu7E!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51bf2366-be3b-41bc-9edd-4f90c49e5d67_1160x380.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!tu7E!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51bf2366-be3b-41bc-9edd-4f90c49e5d67_1160x380.png" width="1160" height="380" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/51bf2366-be3b-41bc-9edd-4f90c49e5d67_1160x380.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:380,&#34;width&#34;:1160,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:67513,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51bf2366-be3b-41bc-9edd-4f90c49e5d67_1160x380.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!tu7E!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51bf2366-be3b-41bc-9edd-4f90c49e5d67_1160x380.png 424w, https://substackcdn.com/image/fetch/$s_!tu7E!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51bf2366-be3b-41bc-9edd-4f90c49e5d67_1160x380.png 848w, https://substackcdn.com/image/fetch/$s_!tu7E!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51bf2366-be3b-41bc-9edd-4f90c49e5d67_1160x380.png 1272w, https://substackcdn.com/image/fetch/$s_!tu7E!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51bf2366-be3b-41bc-9edd-4f90c49e5d67_1160x380.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><p>Why can parking_lot use just one byte while std needs more? It comes down to how queues work.</p><p><span>std’s futex uses the kernel to manage wait queues. When you call the futex syscall, you pass the memory address of your atomic variable, and the kernel uses that address as the queue ID. But there’s a catch: the kernel requires this address to be aligned to a 32-bit boundary. So std’s mutex must use </span><strong>AtomicU32</strong><span>, even though it only needs a few bits for state.</span></p><p><span>parking_lot manages its own queues in user space. It hashes the mutex’s memory address to find the right queue bucket. Since it doesn’t need to satisfy kernel alignment requirements, it can use a single </span><strong>AtomicU8</strong><span>.</span></p><p><strong>More states for queue bookkeeping</strong></p><p>Using separate bits gives parking_lot four possible states:</p><ul><li><p><strong>00</strong><span>: Unlocked, no waiters</span></p></li><li><p><strong>01</strong><span>: Locked, no waiters</span></p></li><li><p><strong>10</strong><span>: Unlocked, but threads still waiting</span></p></li><li><p><strong>11</strong><span>: Locked with waiters</span></p></li></ul><p><span>That third state (</span><strong>10</strong><span>) might seem odd at first. Why would a mutex be unlocked but still have waiting threads? This is a transient state that happens during parking_lot’s unlock process. Because parking_lot manages its own queue, it uses the PARKED_BIT as bookkeeping to track whether threads are still in the queue. This helps avoid lost wakeups where a thread might miss its notification. It’s not an advantage over std, just a consequence of managing queues in user space rather than delegating to the kernel.</span></p><p>When a thread can’t acquire the lock, it needs somewhere to wait. This is where parking_lot’s global hash table comes in.</p><p>Instead of each mutex maintaining its own queue (like kernel futexes do), parking_lot uses a single global hash table shared by all mutexes in your program. When a thread needs to wait:</p><ol><li><p>Hash the mutex’s memory address to find a bucket in the global table</p></li><li><p>Add the thread to the bucket’s wait queue</p></li><li><p>Go to sleep</p></li></ol><p>Being able to manage the thread queue itself is important for parking_lot to enforce fairness. As you can see right away in the next section.</p><p>Here’s where parking_lot differs from std in behavior. std’s futex uses a “barging” strategy where any active thread can grab the lock when it’s released, even if others have been waiting in the queue longer. This maximizes throughput but can cause starvation.</p><p>When a thread unlocks, there are two sources of threads that can lock again:</p><ul><li><p>An active thread that is calling for locking</p></li><li><p>A sleeping thread in the queue</p></li></ul><p>As you can see, the active thread will tend to win the fight of “who locks first”. So if a thread keeps calling for lock, finishes its work, then locks right away, it keeps all other threads starved.</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!Hkew!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6d858958-c7c5-447b-bc3a-e136f2ff5c5d_571x497.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!Hkew!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6d858958-c7c5-447b-bc3a-e136f2ff5c5d_571x497.png 424w, https://substackcdn.com/image/fetch/$s_!Hkew!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6d858958-c7c5-447b-bc3a-e136f2ff5c5d_571x497.png 848w, https://substackcdn.com/image/fetch/$s_!Hkew!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6d858958-c7c5-447b-bc3a-e136f2ff5c5d_571x497.png 1272w, https://substackcdn.com/image/fetch/$s_!Hkew!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6d858958-c7c5-447b-bc3a-e136f2ff5c5d_571x497.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!Hkew!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6d858958-c7c5-447b-bc3a-e136f2ff5c5d_571x497.png" width="571" height="497" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/6d858958-c7c5-447b-bc3a-e136f2ff5c5d_571x497.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:497,&#34;width&#34;:571,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:68043,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6d858958-c7c5-447b-bc3a-e136f2ff5c5d_571x497.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!Hkew!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6d858958-c7c5-447b-bc3a-e136f2ff5c5d_571x497.png 424w, https://substackcdn.com/image/fetch/$s_!Hkew!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6d858958-c7c5-447b-bc3a-e136f2ff5c5d_571x497.png 848w, https://substackcdn.com/image/fetch/$s_!Hkew!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6d858958-c7c5-447b-bc3a-e136f2ff5c5d_571x497.png 1272w, https://substackcdn.com/image/fetch/$s_!Hkew!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6d858958-c7c5-447b-bc3a-e136f2ff5c5d_571x497.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><p>As you can see, thread A keeps grabbing the lock immediately after releasing it. Threads B and C do get woken up by the syscall, but by the time they try to acquire the lock, thread A has already grabbed it again. They’re completely starved.</p><p>parking_lot implements “eventual fairness” to prevent this.</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!Jqnq!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4cc03117-98e2-42df-ac25-59170049763f_571x441.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!Jqnq!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4cc03117-98e2-42df-ac25-59170049763f_571x441.png 424w, https://substackcdn.com/image/fetch/$s_!Jqnq!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4cc03117-98e2-42df-ac25-59170049763f_571x441.png 848w, https://substackcdn.com/image/fetch/$s_!Jqnq!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4cc03117-98e2-42df-ac25-59170049763f_571x441.png 1272w, https://substackcdn.com/image/fetch/$s_!Jqnq!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4cc03117-98e2-42df-ac25-59170049763f_571x441.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!Jqnq!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4cc03117-98e2-42df-ac25-59170049763f_571x441.png" width="571" height="441" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/4cc03117-98e2-42df-ac25-59170049763f_571x441.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:441,&#34;width&#34;:571,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:60764,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4cc03117-98e2-42df-ac25-59170049763f_571x441.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!Jqnq!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4cc03117-98e2-42df-ac25-59170049763f_571x441.png 424w, https://substackcdn.com/image/fetch/$s_!Jqnq!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4cc03117-98e2-42df-ac25-59170049763f_571x441.png 848w, https://substackcdn.com/image/fetch/$s_!Jqnq!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4cc03117-98e2-42df-ac25-59170049763f_571x441.png 1272w, https://substackcdn.com/image/fetch/$s_!Jqnq!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4cc03117-98e2-42df-ac25-59170049763f_571x441.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><p>Each bucket in the hash table has a timer that fires approximately every 0.5 milliseconds. When the timer fires, the next unlock becomes a “fair unlock”:</p><ol><li><p>The unlocker keeps the LOCKED_BIT set</p></li><li><p>The woken thread receives the lock directly (a “handoff”)</p></li><li><p>That thread owns the lock immediately without racing with other active threads</p></li></ol><p>So this means, instead of letting anyone who is fast grab the lock, parking_lot forces the lock to be given directly to the next one in the queue (it keeps the LOCKED_BIT set and hands off; it doesn’t even unlock).</p><p><span>This timer-based approach means parking_lot is unfair most of the time (for performance), but guarantees fairness every ~0.5ms to prevent any thread from being starved indefinitely. You can also force a fair unlock explicitly with </span><strong>unlock_fair()</strong><span> if needed.</span></p><p>This eventual fairness technique from parking_lot is pretty clever, isn’t it?</p><p>You might wonder by now: how does parking_lot put threads to sleep without storing a 32-bit futex word inside every mutex? The answer is thread-local storage.</p><p><span>parking_lot still uses the same futex syscall as std, but it doesn’t pass the mutex address to the kernel. Instead, each thread owns a </span><strong>ThreadData</strong><span> record containing a reusable </span><strong>i32</strong><span>. Because this integer lives in thread-local storage, each thread has a unique address to use for the syscall. In the kernel, every blocked thread sits in its own single-entry queue.</span></p><p>The code looks almost identical to std’s futex path. The only difference? parking_lot points the syscall at the thread-local integer instead of the mutex:</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!APi2!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b26c0b0-eee1-47e3-baf0-e9d32ea15da1_1160x462.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!APi2!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b26c0b0-eee1-47e3-baf0-e9d32ea15da1_1160x462.png 424w, https://substackcdn.com/image/fetch/$s_!APi2!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b26c0b0-eee1-47e3-baf0-e9d32ea15da1_1160x462.png 848w, https://substackcdn.com/image/fetch/$s_!APi2!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b26c0b0-eee1-47e3-baf0-e9d32ea15da1_1160x462.png 1272w, https://substackcdn.com/image/fetch/$s_!APi2!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b26c0b0-eee1-47e3-baf0-e9d32ea15da1_1160x462.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!APi2!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b26c0b0-eee1-47e3-baf0-e9d32ea15da1_1160x462.png" width="1160" height="462" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/5b26c0b0-eee1-47e3-baf0-e9d32ea15da1_1160x462.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:462,&#34;width&#34;:1160,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:59471,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b26c0b0-eee1-47e3-baf0-e9d32ea15da1_1160x462.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!APi2!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b26c0b0-eee1-47e3-baf0-e9d32ea15da1_1160x462.png 424w, https://substackcdn.com/image/fetch/$s_!APi2!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b26c0b0-eee1-47e3-baf0-e9d32ea15da1_1160x462.png 848w, https://substackcdn.com/image/fetch/$s_!APi2!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b26c0b0-eee1-47e3-baf0-e9d32ea15da1_1160x462.png 1272w, https://substackcdn.com/image/fetch/$s_!APi2!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b26c0b0-eee1-47e3-baf0-e9d32ea15da1_1160x462.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><p><span>When unlocking, parking_lot uses the same per-thread integer and issues </span><strong>FUTEX_WAKE</strong><span> on that address. This way, the mutex stays just one byte while the thread-local helper handles all the sleeping and waking.</span></p><p><span>On platforms without futexes, the parker swaps in the local blocking primitive (</span><strong>pthread_cond_t</strong><span> on macOS/BSD, Windows’ </span><strong>WaitOnAddress</strong><span>/keyed events, or a plain spin loop) while keeping the same per-thread queue design.</span></p><p><span>Now let’s see how these implementations perform in practice. I ran benchmarks across four scenarios that reveal different aspects of mutex behavior. All benchmarks ran on Linux with the futex backend for std. You can find the source code and full report at </span><a href="https://github.com/cuongleqq/mutex-benches" rel="">https://github.com/cuongleqq/mutex-benches</a><span>.</span></p><p>For each scenario, you’ll see:</p><ul><li><p><strong>Per-thread operation counts</strong><span>: Shows how many lock acquisitions each thread completed</span></p></li><li><p><strong>Performance metrics</strong><span>: Throughput, wait latencies (median, mean, P99), and standard deviation</span></p></li><li><p><strong>Analysis</strong><span>: What the results tell us about each mutex’s behavior</span></p></li></ul><p><span>(If the numbers feel overwhelming, just read the </span><strong>scenario configuration</strong><span> and skip straight to the </span><strong>takeaway</strong><span>.)</span></p><p><strong>Configuration:</strong><span> 4 threads, 10 seconds, minimal work in critical section</span></p><p><strong>Scenario:</strong><span> This simulates a typical application where threads frequently acquire and release locks with very little work inside the critical section. Each thread simply increments a counter, representing the common case of protecting small data structures or quick state updates.</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!In6t!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff8f8550f-5b10-41ba-809e-6f60656bf7f6_1600x900.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!In6t!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff8f8550f-5b10-41ba-809e-6f60656bf7f6_1600x900.png 424w, https://substackcdn.com/image/fetch/$s_!In6t!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff8f8550f-5b10-41ba-809e-6f60656bf7f6_1600x900.png 848w, https://substackcdn.com/image/fetch/$s_!In6t!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff8f8550f-5b10-41ba-809e-6f60656bf7f6_1600x900.png 1272w, https://substackcdn.com/image/fetch/$s_!In6t!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff8f8550f-5b10-41ba-809e-6f60656bf7f6_1600x900.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!In6t!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff8f8550f-5b10-41ba-809e-6f60656bf7f6_1600x900.png" width="1456" height="819" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/f8f8550f-5b10-41ba-809e-6f60656bf7f6_1600x900.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:819,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:104329,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff8f8550f-5b10-41ba-809e-6f60656bf7f6_1600x900.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!In6t!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff8f8550f-5b10-41ba-809e-6f60656bf7f6_1600x900.png 424w, https://substackcdn.com/image/fetch/$s_!In6t!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff8f8550f-5b10-41ba-809e-6f60656bf7f6_1600x900.png 848w, https://substackcdn.com/image/fetch/$s_!In6t!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff8f8550f-5b10-41ba-809e-6f60656bf7f6_1600x900.png 1272w, https://substackcdn.com/image/fetch/$s_!In6t!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff8f8550f-5b10-41ba-809e-6f60656bf7f6_1600x900.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!FvEh!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F66dc8c33-8a6f-468d-97d1-61be2e0ea81c_1134x302.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!FvEh!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F66dc8c33-8a6f-468d-97d1-61be2e0ea81c_1134x302.png 424w, https://substackcdn.com/image/fetch/$s_!FvEh!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F66dc8c33-8a6f-468d-97d1-61be2e0ea81c_1134x302.png 848w, https://substackcdn.com/image/fetch/$s_!FvEh!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F66dc8c33-8a6f-468d-97d1-61be2e0ea81c_1134x302.png 1272w, https://substackcdn.com/image/fetch/$s_!FvEh!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F66dc8c33-8a6f-468d-97d1-61be2e0ea81c_1134x302.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!FvEh!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F66dc8c33-8a6f-468d-97d1-61be2e0ea81c_1134x302.png" width="1134" height="302" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/66dc8c33-8a6f-468d-97d1-61be2e0ea81c_1134x302.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:302,&#34;width&#34;:1134,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:80626,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F66dc8c33-8a6f-468d-97d1-61be2e0ea81c_1134x302.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!FvEh!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F66dc8c33-8a6f-468d-97d1-61be2e0ea81c_1134x302.png 424w, https://substackcdn.com/image/fetch/$s_!FvEh!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F66dc8c33-8a6f-468d-97d1-61be2e0ea81c_1134x302.png 848w, https://substackcdn.com/image/fetch/$s_!FvEh!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F66dc8c33-8a6f-468d-97d1-61be2e0ea81c_1134x302.png 1272w, https://substackcdn.com/image/fetch/$s_!FvEh!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F66dc8c33-8a6f-468d-97d1-61be2e0ea81c_1134x302.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><p><strong>Takeaway:</strong><span> In moderate contention with short critical sections, std’s futex shines with 9% higher throughput and lower average latency. The uncontended fast path and efficient kernel-managed queues work well here. However, look at the per-thread operations: std has 5.6% variation (20.6M vs 19.4M) while parking_lot has only 3.9% (18.9M vs 18.2M). Even in this favorable scenario for std, parking_lot’s fairness mechanism ensures more even work distribution across threads.</span></p><p><strong>Configuration:</strong><span> 8 threads, 10 seconds, 500µs sleep while holding lock</span></p><p><strong>Scenario:</strong><span> This tests heavy contention where threads hold the lock for a long time (500 microseconds). This simulates scenarios like I/O operations, slow computation, or accessing remote resources while holding a lock. With 8 threads competing for a lock that’s held for 500µs each time, contention is severe.</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!Qw15!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8a2306f9-c81b-4035-a4da-a1b68f70c3a9_1800x960.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!Qw15!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8a2306f9-c81b-4035-a4da-a1b68f70c3a9_1800x960.png 424w, https://substackcdn.com/image/fetch/$s_!Qw15!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8a2306f9-c81b-4035-a4da-a1b68f70c3a9_1800x960.png 848w, https://substackcdn.com/image/fetch/$s_!Qw15!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8a2306f9-c81b-4035-a4da-a1b68f70c3a9_1800x960.png 1272w, https://substackcdn.com/image/fetch/$s_!Qw15!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8a2306f9-c81b-4035-a4da-a1b68f70c3a9_1800x960.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!Qw15!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8a2306f9-c81b-4035-a4da-a1b68f70c3a9_1800x960.png" width="1456" height="777" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/8a2306f9-c81b-4035-a4da-a1b68f70c3a9_1800x960.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:777,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:125138,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8a2306f9-c81b-4035-a4da-a1b68f70c3a9_1800x960.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!Qw15!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8a2306f9-c81b-4035-a4da-a1b68f70c3a9_1800x960.png 424w, https://substackcdn.com/image/fetch/$s_!Qw15!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8a2306f9-c81b-4035-a4da-a1b68f70c3a9_1800x960.png 848w, https://substackcdn.com/image/fetch/$s_!Qw15!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8a2306f9-c81b-4035-a4da-a1b68f70c3a9_1800x960.png 1272w, https://substackcdn.com/image/fetch/$s_!Qw15!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8a2306f9-c81b-4035-a4da-a1b68f70c3a9_1800x960.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!2-q6!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa68288df-cde7-4f8b-82e7-6b23419e8a73_1134x302.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!2-q6!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa68288df-cde7-4f8b-82e7-6b23419e8a73_1134x302.png 424w, https://substackcdn.com/image/fetch/$s_!2-q6!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa68288df-cde7-4f8b-82e7-6b23419e8a73_1134x302.png 848w, https://substackcdn.com/image/fetch/$s_!2-q6!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa68288df-cde7-4f8b-82e7-6b23419e8a73_1134x302.png 1272w, https://substackcdn.com/image/fetch/$s_!2-q6!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa68288df-cde7-4f8b-82e7-6b23419e8a73_1134x302.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!2-q6!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa68288df-cde7-4f8b-82e7-6b23419e8a73_1134x302.png" width="1134" height="302" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/a68288df-cde7-4f8b-82e7-6b23419e8a73_1134x302.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:302,&#34;width&#34;:1134,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:87282,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa68288df-cde7-4f8b-82e7-6b23419e8a73_1134x302.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!2-q6!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa68288df-cde7-4f8b-82e7-6b23419e8a73_1134x302.png 424w, https://substackcdn.com/image/fetch/$s_!2-q6!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa68288df-cde7-4f8b-82e7-6b23419e8a73_1134x302.png 848w, https://substackcdn.com/image/fetch/$s_!2-q6!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa68288df-cde7-4f8b-82e7-6b23419e8a73_1134x302.png 1272w, https://substackcdn.com/image/fetch/$s_!2-q6!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa68288df-cde7-4f8b-82e7-6b23419e8a73_1134x302.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><p><strong>Takeaway:</strong><span> This benchmark reveals std’s critical weakness under heavy contention. Look at thread 3 in std: it completed only 66 operations while thread 5 completed 1,394. That’s a 95.3% variation - complete starvation. The extremely low median (125ns) combined with massive standard deviation (188.73ms) shows most lock attempts are fast, but some threads suffer extreme delays and essentially never get the lock.</span></p><p>parking_lot tells a different story. Every thread completed 860-877 operations (1.9% variation). The fairness mechanism worked exactly as designed. Yes, parking_lot has 7.5% lower throughput and higher median wait time, but that’s because it’s ensuring all threads make progress. The 51x more stable wait times (3.67ms vs 188.73ms standard deviation) show the predictability benefit. When fairness matters, parking_lot prevents the pathological starvation that std exhibits.</p><p><strong>Configuration:</strong><span> 8 threads, 15 seconds, 200ms active / 800ms idle</span></p><p><strong>Scenario:</strong><span> This simulates bursty workloads where threads alternate between periods of high activity (200ms of rapid lock acquisitions) and idle periods (800ms sleep). Think of web servers handling traffic spikes, batch processing systems, or applications with periodic activity patterns. This tests how mutexes handle sudden contention spikes followed by quiet periods.</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!2m9I!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe244d11d-3f22-46cf-91c1-dff34281d3c8_1800x960.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!2m9I!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe244d11d-3f22-46cf-91c1-dff34281d3c8_1800x960.png 424w, https://substackcdn.com/image/fetch/$s_!2m9I!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe244d11d-3f22-46cf-91c1-dff34281d3c8_1800x960.png 848w, https://substackcdn.com/image/fetch/$s_!2m9I!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe244d11d-3f22-46cf-91c1-dff34281d3c8_1800x960.png 1272w, https://substackcdn.com/image/fetch/$s_!2m9I!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe244d11d-3f22-46cf-91c1-dff34281d3c8_1800x960.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!2m9I!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe244d11d-3f22-46cf-91c1-dff34281d3c8_1800x960.png" width="1456" height="777" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/e244d11d-3f22-46cf-91c1-dff34281d3c8_1800x960.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:777,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:91034,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe244d11d-3f22-46cf-91c1-dff34281d3c8_1800x960.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!2m9I!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe244d11d-3f22-46cf-91c1-dff34281d3c8_1800x960.png 424w, https://substackcdn.com/image/fetch/$s_!2m9I!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe244d11d-3f22-46cf-91c1-dff34281d3c8_1800x960.png 848w, https://substackcdn.com/image/fetch/$s_!2m9I!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe244d11d-3f22-46cf-91c1-dff34281d3c8_1800x960.png 1272w, https://substackcdn.com/image/fetch/$s_!2m9I!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe244d11d-3f22-46cf-91c1-dff34281d3c8_1800x960.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!R_rJ!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51a2db2e-9cca-4f18-83d9-5b9a007d66f5_1134x302.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!R_rJ!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51a2db2e-9cca-4f18-83d9-5b9a007d66f5_1134x302.png 424w, https://substackcdn.com/image/fetch/$s_!R_rJ!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51a2db2e-9cca-4f18-83d9-5b9a007d66f5_1134x302.png 848w, https://substackcdn.com/image/fetch/$s_!R_rJ!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51a2db2e-9cca-4f18-83d9-5b9a007d66f5_1134x302.png 1272w, https://substackcdn.com/image/fetch/$s_!R_rJ!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51a2db2e-9cca-4f18-83d9-5b9a007d66f5_1134x302.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!R_rJ!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51a2db2e-9cca-4f18-83d9-5b9a007d66f5_1134x302.png" width="1134" height="302" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/51a2db2e-9cca-4f18-83d9-5b9a007d66f5_1134x302.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:302,&#34;width&#34;:1134,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:85433,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51a2db2e-9cca-4f18-83d9-5b9a007d66f5_1134x302.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!R_rJ!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51a2db2e-9cca-4f18-83d9-5b9a007d66f5_1134x302.png 424w, https://substackcdn.com/image/fetch/$s_!R_rJ!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51a2db2e-9cca-4f18-83d9-5b9a007d66f5_1134x302.png 848w, https://substackcdn.com/image/fetch/$s_!R_rJ!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51a2db2e-9cca-4f18-83d9-5b9a007d66f5_1134x302.png 1272w, https://substackcdn.com/image/fetch/$s_!R_rJ!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F51a2db2e-9cca-4f18-83d9-5b9a007d66f5_1134x302.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><p><strong>Takeaway:</strong><span> parking_lot excels in bursty workloads, achieving 18.5% higher throughput than std. During activity bursts, all 8 threads compete intensely for the lock. parking_lot’s adaptive spinning and fairness mechanisms handle these periodic spikes better, ensuring more even work distribution (9.9% variation vs 13.6%). The 24.8% more stable wait times show parking_lot handles the transitions between idle and active periods more smoothly. While std has lower tail latencies, parking_lot’s better stability and fairness during bursts translate to higher overall throughput.</span></p><p><strong>Configuration:</strong><span> 6 threads, 15 seconds, one thread monopolizes (sleeps 500µs while holding lock)</span></p><p><strong>Scenario:</strong><span> This tests the worst-case scenario: one “hog” thread repeatedly acquires the lock and holds it for 500µs, while 5 other threads compete normally. This simulates real-world situations like priority inversion, where a high-priority or busy thread keeps grabbing the lock immediately after releasing it, potentially starving other threads. Can the mutex prevent monopolization?</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!Sv15!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8322e2fc-9ad0-4789-8d8a-a363d6fa22fb_1800x960.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!Sv15!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8322e2fc-9ad0-4789-8d8a-a363d6fa22fb_1800x960.png 424w, https://substackcdn.com/image/fetch/$s_!Sv15!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8322e2fc-9ad0-4789-8d8a-a363d6fa22fb_1800x960.png 848w, https://substackcdn.com/image/fetch/$s_!Sv15!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8322e2fc-9ad0-4789-8d8a-a363d6fa22fb_1800x960.png 1272w, https://substackcdn.com/image/fetch/$s_!Sv15!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8322e2fc-9ad0-4789-8d8a-a363d6fa22fb_1800x960.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!Sv15!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8322e2fc-9ad0-4789-8d8a-a363d6fa22fb_1800x960.png" width="1456" height="777" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/8322e2fc-9ad0-4789-8d8a-a363d6fa22fb_1800x960.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:777,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:104889,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8322e2fc-9ad0-4789-8d8a-a363d6fa22fb_1800x960.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!Sv15!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8322e2fc-9ad0-4789-8d8a-a363d6fa22fb_1800x960.png 424w, https://substackcdn.com/image/fetch/$s_!Sv15!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8322e2fc-9ad0-4789-8d8a-a363d6fa22fb_1800x960.png 848w, https://substackcdn.com/image/fetch/$s_!Sv15!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8322e2fc-9ad0-4789-8d8a-a363d6fa22fb_1800x960.png 1272w, https://substackcdn.com/image/fetch/$s_!Sv15!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8322e2fc-9ad0-4789-8d8a-a363d6fa22fb_1800x960.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!xW_A!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fab1a3581-cfd5-4c77-b9aa-66b908d59488_1134x302.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!xW_A!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fab1a3581-cfd5-4c77-b9aa-66b908d59488_1134x302.png 424w, https://substackcdn.com/image/fetch/$s_!xW_A!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fab1a3581-cfd5-4c77-b9aa-66b908d59488_1134x302.png 848w, https://substackcdn.com/image/fetch/$s_!xW_A!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fab1a3581-cfd5-4c77-b9aa-66b908d59488_1134x302.png 1272w, https://substackcdn.com/image/fetch/$s_!xW_A!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fab1a3581-cfd5-4c77-b9aa-66b908d59488_1134x302.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!xW_A!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fab1a3581-cfd5-4c77-b9aa-66b908d59488_1134x302.png" width="1134" height="302" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/ab1a3581-cfd5-4c77-b9aa-66b908d59488_1134x302.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:302,&#34;width&#34;:1134,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:91395,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:&#34;https://blog.cuongle.dev/i/177427186?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fab1a3581-cfd5-4c77-b9aa-66b908d59488_1134x302.png&#34;,&#34;isProcessing&#34;:false,&#34;align&#34;:null,&#34;offset&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/$s_!xW_A!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fab1a3581-cfd5-4c77-b9aa-66b908d59488_1134x302.png 424w, https://substackcdn.com/image/fetch/$s_!xW_A!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fab1a3581-cfd5-4c77-b9aa-66b908d59488_1134x302.png 848w, https://substackcdn.com/image/fetch/$s_!xW_A!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fab1a3581-cfd5-4c77-b9aa-66b908d59488_1134x302.png 1272w, https://substackcdn.com/image/fetch/$s_!xW_A!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fab1a3581-cfd5-4c77-b9aa-66b908d59488_1134x302.png 1456w" sizes="100vw" loading="lazy"/></picture><div></div></div></a></figure></div><p><strong>Takeaway:</strong><span> This is the smoking gun that demonstrates std’s fundamental unfairness. The hog thread completed 12,242 operations while the other threads completed only 6-16 operations each. That’s complete starvation - the non-hog threads essentially never got the lock. The 100% variation and 130ms standard deviation show the extreme unpredictability.</span></p><p>parking_lot’s fairness timer prevented this catastrophe. The hog still got more operations (9,168) but nowhere near monopolization. All other threads made meaningful progress (7,023-7,109 operations). The result: 261.6% higher overall throughput because all 6 threads contributed work instead of 5 threads sitting idle. The 120x more stable wait times (1.09ms vs 130.76ms) show parking_lot’s predictability. The 0.5ms fairness timer does exactly what it promises: prevent any thread from monopolizing the lock indefinitely.</p><p>After diving deep into the implementations and running comprehensive benchmarks, here’s when to use each:</p><ol><li><p><strong>You need zero dependencies</strong><span> - It’s in std, always available</span></p></li><li><p><strong>Low to moderate contention with short critical sections</strong><span> - futex implementation is excellent here (9% faster throughput in our short-hold test)</span></p></li><li><p><strong>You want poisoning for debugging</strong><span> - Helps catch panic-related bugs during development</span></p></li><li><p><strong>Platform-specific optimizations matter</strong><span> - Gets priority inheritance on Fuchsia, etc.</span></p></li></ol><ol><li><p><strong>Fairness is critical</strong><span> - Prevents thread starvation (49x better fairness in heavy contention)</span></p></li><li><p><strong>Risk of monopolization exists</strong><span> - The hog scenario showed 261.6% better throughput by preventing starvation</span></p></li><li><p><strong>Bursty workloads</strong><span> - 18.5% faster in our burst scenario</span></p></li><li><p><strong>You need predictable behavior</strong><span> - 51x more stable latency under heavy load</span></p></li><li><p><strong>Memory footprint matters</strong><span> - Always 1 byte regardless of platform</span></p></li><li><p><strong>You want timeouts or fairness control</strong><span> - </span><strong>try_lock_for()</strong><span>, </span><strong>unlock_fair()</strong><span>, etc.</span></p></li><li><p><strong>Cross-platform consistency is important</strong><span> - Same behavior everywhere</span></p></li></ol><p data-attrs="{&#34;url&#34;:&#34;https://blog.cuongle.dev/p/inside-rusts-std-and-parking-lot-mutexes-who-win?utm_source=substack&amp;utm_medium=email&amp;utm_content=share&amp;action=share&#34;,&#34;text&#34;:&#34;Share&#34;,&#34;action&#34;:null,&#34;class&#34;:null}" data-component-name="ButtonCreateButton"><a href="https://blog.cuongle.dev/p/inside-rusts-std-and-parking-lot-mutexes-who-win?utm_source=substack&amp;utm_medium=email&amp;utm_content=share&amp;action=share" rel=""><span>Share</span></a></p><p><span>The benchmarks reveal a fundamental trade-off: </span><strong>std::Mutex optimizes for throughput in the average case</strong><span>, while </span><strong>parking_lot::Mutex optimizes for fairness and predictability in the worst case</strong><span>.</span></p><p>For most applications, where contention is light and critical sections are short, std::Mutex performs excellently. But if your application has any of these characteristics:</p><ul><li><p>Long-running critical sections</p></li><li><p>Risk of lock monopolization (e.g., one high-priority thread)</p></li><li><p>Need for predictable latency across all threads</p></li><li><p>Requirement that all threads make forward progress</p></li></ul><p>Then parking_lot::Mutex’s eventual fairness mechanism becomes invaluable. The 0.5ms fairness timer is a small price to pay for preventing complete thread starvation.</p><p><span>If you made it this far, you’re probably as obsessed with understanding how things really work as I am. I’m Cuong, and I write about Rust and programming. If you share the same passion, I’d love to connect with you. Feel free to reach out on </span><a href="https://x.com/cuongleqq" rel="">X</a><span>, </span><a href="https://www.linkedin.com/in/cuong-le/" rel="">LinkedIn</a><span>, or subscribe to my blog (</span><a href="https://blog.cuongle.dev/" rel="">substack</a><span>, </span><a href="https://medium.com/@cuongleqq" rel="">medium</a><span>) to keep pushing the boundaries together!</span></p></div></div></div></article></div></div></div><div><div id="discussion"><div><h4>Discussion about this post</h4></div></div></div></div>
  </body>
</html>
