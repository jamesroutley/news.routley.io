<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/bananaml/fructose">Original</a>
    <h1>Show HN: Fructose â€“ LLM calls as strongly typed functions</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text"><a target="_blank" rel="noopener noreferrer" href="https://private-user-images.githubusercontent.com/44653944/306484286-8162425c-a485-460f-b816-bcc6be5d2cef.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MDk3ODg1NzIsIm5iZiI6MTcwOTc4ODI3MiwicGF0aCI6Ii80NDY1Mzk0NC8zMDY0ODQyODYtODE2MjQyNWMtYTQ4NS00NjBmLWI4MTYtYmNjNmJlNWQyY2VmLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDAzMDclMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwMzA3VDA1MTExMlomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWJlYWViYjBkNjk5MWIzZWYzOWE3MDRhZWQ2NTA2ZWVlOGZiNGZiMmY1N2RiNjE3MTkxNDNkMzU4ZDc4OWU0YzYmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.mbCiOXYrmacKz_oehXSgyiWynREjAeJ51YZWzowYWWU"><img width="326" alt="Group 311 (2)" src="https://private-user-images.githubusercontent.com/44653944/306484286-8162425c-a485-460f-b816-bcc6be5d2cef.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MDk3ODg1NzIsIm5iZiI6MTcwOTc4ODI3MiwicGF0aCI6Ii80NDY1Mzk0NC8zMDY0ODQyODYtODE2MjQyNWMtYTQ4NS00NjBmLWI4MTYtYmNjNmJlNWQyY2VmLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDAzMDclMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwMzA3VDA1MTExMlomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWJlYWViYjBkNjk5MWIzZWYzOWE3MDRhZWQ2NTA2ZWVlOGZiNGZiMmY1N2RiNjE3MTkxNDNkMzU4ZDc4OWU0YzYmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.mbCiOXYrmacKz_oehXSgyiWynREjAeJ51YZWzowYWWU"/></a>

<p dir="auto">Fructose is a python package to create a dependable, strongly-typed interface around an LLM call.</p>
<p dir="auto">Just slap the <code>@ai()</code> decorator on a type-annotated function and call it as you would a function. It&#39;s lightweight, syntactic sugar.</p>
<div dir="auto" data-snippet-clipboard-copy-content="from fructose import Fructose
ai = Fructose()

@ai()
def describe(animals: list[str]) -&gt; str:
  &#34;&#34;&#34;
  Given a list of animals, use one word that&#39;d describe them all.
  &#34;&#34;&#34;

description = describe([&#34;dog&#34;, &#34;cat&#34;, &#34;parrot&#34;, &#34;goldfish&#34;])
print(description) # -&gt; &#34;pets&#34; type: str"><pre><span>from</span> <span>fructose</span> <span>import</span> <span>Fructose</span>
<span>ai</span> <span>=</span> <span>Fructose</span>()

<span>@<span>ai</span>()</span>
<span>def</span> <span>describe</span>(<span>animals</span>: <span>list</span>[<span>str</span>]) <span>-&gt;</span> <span>str</span>:
  <span>&#34;&#34;&#34;</span>
<span>  Given a list of animals, use one word that&#39;d describe them all.</span>
<span>  &#34;&#34;&#34;</span>

<span>description</span> <span>=</span> <span>describe</span>([<span>&#34;dog&#34;</span>, <span>&#34;cat&#34;</span>, <span>&#34;parrot&#34;</span>, <span>&#34;goldfish&#34;</span>])
<span>print</span>(<span>description</span>) <span># -&gt; &#34;pets&#34; type: str</span></pre></div>
<p dir="auto">The <code>@ai()</code> decorator introspects the function and builds a prompt to an LLM to perform the task whenever the function is invoked.</p>
<p dir="auto">Fructose supports:</p>
<ul dir="auto">
<li>args, kwargs, and return types</li>
<li>primative types <code>str</code> <code>bool</code> <code>int</code> <code>float</code></li>
<li>compound types <code>list</code> <code>dict</code> <code>tuple</code> <code>Enum</code> <code>Optional</code></li>
<li>complex datatypes <code>@dataclass</code></li>
<li>nested types</li>
<li>custom prompt templates</li>
<li>local function calling</li>
</ul>



<p dir="auto">It currently executes the prompt with OpenAI, so you&#39;ll need to use your own OpenAI API Key</p>
<div dir="auto" data-snippet-clipboard-copy-content="export OPENAI_API_KEY=sk-abcdefghijklmnopqrstuvwxyz"><pre><span>export</span> OPENAI_API_KEY=sk-abcdefghijklmnopqrstuvwxyz</pre></div>


<div dir="auto" data-snippet-clipboard-copy-content="from fructose import Fructose
from dataclasses import dataclass

ai = Fructose()

@dataclass
class Person:
    name: str
    hobbies: str
    dislikes: str
    obscure_inclinations: str
    age: int
    height: float
    is_human: bool

@ai()
def generate_fake_person_data() -&gt; Person:
  &#34;&#34;&#34;
    Generate fake data for a cliche aspiring author
  &#34;&#34;&#34;

person = generate_fake_person_data()
print(person)"><pre><span>from</span> <span>fructose</span> <span>import</span> <span>Fructose</span>
<span>from</span> <span>dataclasses</span> <span>import</span> <span>dataclass</span>

<span>ai</span> <span>=</span> <span>Fructose</span>()

<span>@<span>dataclass</span></span>
<span>class</span> <span>Person</span>:
    <span>name</span>: <span>str</span>
    <span>hobbies</span>: <span>str</span>
    <span>dislikes</span>: <span>str</span>
    <span>obscure_inclinations</span>: <span>str</span>
    <span>age</span>: <span>int</span>
    <span>height</span>: <span>float</span>
    <span>is_human</span>: <span>bool</span>

<span>@<span>ai</span>()</span>
<span>def</span> <span>generate_fake_person_data</span>() <span>-&gt;</span> <span>Person</span>:
  <span>&#34;&#34;&#34;</span>
<span>    Generate fake data for a cliche aspiring author</span>
<span>  &#34;&#34;&#34;</span>

<span>person</span> <span>=</span> <span>generate_fake_person_data</span>()
<span>print</span>(<span>person</span>)</pre></div>

<p dir="auto">Fructose <code>ai()</code> functions can choose to call local Python functions. Yes, even other <code>@ai()</code> functions.</p>
<p dir="auto">Pass the functions into the decorator with the <code>uses</code> argument: <code>@ai(uses = [func_1, func_2])</code></p>
<p dir="auto">For example, here&#39;s a fructose function fetching HackerNews comments using a local function and the <code>requests</code> library:</p>
<div dir="auto" data-snippet-clipboard-copy-content="from fructose import Fructose
import requests
from dataclasses import dataclass

ai = Fructose()

def get(uri: str) -&gt; str:
    &#34;&#34;&#34;
    GET request to a URI
    &#34;&#34;&#34;
    return requests.get(uri).text

@dataclass
class Comment:
    username: str
    comment: str

@ai(uses=[get], debug=True)
def get_comments(uri: str) -&gt; list[Comment]:
    &#34;&#34;&#34;
    Gets all base comments from a hacker news post
    &#34;&#34;&#34;
    

result = get_comments(&#34;https://news.ycombinator.com/item?id=22963649&#34;)

for comment in result:
    print(f&#34;ðŸ§‘ {comment.username}: \nðŸ’¬ {comment.comment}\n&#34;)"><pre><span>from</span> <span>fructose</span> <span>import</span> <span>Fructose</span>
<span>import</span> <span>requests</span>
<span>from</span> <span>dataclasses</span> <span>import</span> <span>dataclass</span>

<span>ai</span> <span>=</span> <span>Fructose</span>()

<span>def</span> <span>get</span>(<span>uri</span>: <span>str</span>) <span>-&gt;</span> <span>str</span>:
    <span>&#34;&#34;&#34;</span>
<span>    GET request to a URI</span>
<span>    &#34;&#34;&#34;</span>
    <span>return</span> <span>requests</span>.<span>get</span>(<span>uri</span>).<span>text</span>

<span>@<span>dataclass</span></span>
<span>class</span> <span>Comment</span>:
    <span>username</span>: <span>str</span>
    <span>comment</span>: <span>str</span>

<span>@<span>ai</span>(<span>uses</span><span>=</span>[<span>get</span>], <span>debug</span><span>=</span><span>True</span>)</span>
<span>def</span> <span>get_comments</span>(<span>uri</span>: <span>str</span>) <span>-&gt;</span> <span>list</span>[<span>Comment</span>]:
    <span>&#34;&#34;&#34;</span>
<span>    Gets all base comments from a hacker news post</span>
<span>    &#34;&#34;&#34;</span>
    

<span>result</span> <span>=</span> <span>get_comments</span>(<span>&#34;https://news.ycombinator.com/item?id=22963649&#34;</span>)

<span>for</span> <span>comment</span> <span>in</span> <span>result</span>:
    <span>print</span>(<span>f&#34;ðŸ§‘ <span><span>{</span><span>comment</span>.<span>username</span><span>}</span></span>: <span>\n</span>ðŸ’¬ <span><span>{</span><span>comment</span>.<span>comment</span><span>}</span></span><span>\n</span>&#34;</span>)</pre></div>
<p dir="auto">Local function calling currently requires:</p>
<ul dir="auto">
<li>type annotations on the function</li>
<li>docstring on the function</li>
<li>sane variable names for arguments</li>
</ul>
<p dir="auto">And supports arguments of basic types:</p>
<ul dir="auto">
<li><code>str</code> <code>bool</code> <code>int</code> <code>float</code> and <code>list</code></li>
</ul>

<p dir="auto">Most config may be set at the decorator level:</p>
<div dir="auto" data-snippet-clipboard-copy-content="ai = Fructose(*args, **kwargs)"><pre><span>ai</span> <span>=</span> <span>Fructose</span>(<span>*</span><span>args</span>, <span>**</span><span>kwargs</span>)</pre></div>
<p dir="auto">or at the function level</p>


<p dir="auto">Select your OpenAI model with the <code>model</code> keyword. Defaults to <code>gpt-4-turbo-preview</code></p>
<div dir="auto" data-snippet-clipboard-copy-content="ai = Fructose(model = &#34;gpt-3.5-turbo&#34;)"><pre><span>ai</span> <span>=</span> <span>Fructose</span>(<span>model</span> <span>=</span> <span>&#34;gpt-3.5-turbo&#34;</span>)</pre></div>

<p dir="auto">Fructose has a lightweight prompt wrapper that &#34;just works&#34; in most cases, but you&#39;re free to modify it using the below Flavors and Templates features.
Note: we&#39;re not satisfied with this specific API, so feel free to give suggestions for alternatives.</p>

<p dir="auto">Flavors are optional flags to change the behavior of the prompt.</p>
<ul dir="auto">
<li><code>random</code>: adds a random seed into the system prompt, to add a bit more variability</li>
<li><code>chain_of_thought</code>: splits calls into two steps: chain of thought for reasoning, then the structured generation.</li>
</ul>
<p dir="auto">decorator level:</p>
<div dir="auto" data-snippet-clipboard-copy-content="ai = Fructose([&#34;random&#34;, &#34;chain_of_thought&#34;])"><pre><span>ai</span> <span>=</span> <span>Fructose</span>([<span>&#34;random&#34;</span>, <span>&#34;chain_of_thought&#34;</span>])</pre></div>
<p dir="auto">or function level:</p>
<div dir="auto" data-snippet-clipboard-copy-content="@ai(flavors=[&#34;random&#34;, &#34;chain_of_thought&#34;])
def my_func():
    # ..."><pre><span>@<span>ai</span>(<span>flavors</span><span>=</span>[<span>&#34;random&#34;</span>, <span>&#34;chain_of_thought&#34;</span>])</span>
<span>def</span> <span>my_func</span>():
    <span># ...</span></pre></div>
<div dir="auto"><h3 tabindex="-1" dir="auto">Custom System Prompt Templates</h3><a id="user-content-custom-system-prompt-templates" aria-label="Permalink: Custom System Prompt Templates" href="#custom-system-prompt-templates"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">You&#39;re free to bring your own prompt template, using the Jinja templating language.</p>
<p dir="auto">To use a custom template on a function level, use the <code>system_template_path</code> argument in the <code>@ai()</code> decorator, with a relative path to your Jinja template file:</p>
<div dir="auto" data-snippet-clipboard-copy-content="@ai(system_template_path=&#34;relative/path/to/my_template.jinja&#34;)
def my_func():
    # ..."><pre><span>@<span>ai</span>(<span>system_template_path</span><span>=</span><span>&#34;relative/path/to/my_template.jinja&#34;</span>)</span>
<span>def</span> <span>my_func</span>():
    <span># ...</span></pre></div>
<p dir="auto">You can also set this on the decorator level, to make it default for all decorated functions.</p>
<p dir="auto">The template must include the following variables:</p>
<ul dir="auto">
<li><code>func_doc_string</code>: the docstring from the decorated function</li>
<li><code>return_type_string</code>: the string-representation of the function&#39;s return types</li>
</ul>
<p dir="auto">For reference, <a href="https://github.com/bananaml/fructose/blob/main/src/fructose/templates/default_prompt.jinja">find the default template here</a></p>
<div dir="auto"><h3 tabindex="-1" dir="auto">Custom Chain Of Thought Prompt Templates</h3><a id="user-content-custom-chain-of-thought-prompt-templates" aria-label="Permalink: Custom Chain Of Thought Prompt Templates" href="#custom-chain-of-thought-prompt-templates"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">In the case of the <code>chain_of_thought</code> flavor being used, fructose will first run a chain-of-thought call, using a special system prompt.</p>
<p dir="auto">Customize it on the function level with the <code>chain_of_thought_template_path</code> argument in the <code>@ai()</code> decorator.</p>
<div dir="auto" data-snippet-clipboard-copy-content="@ai(
    flavors = [&#34;chain_of_thought&#34;], 
    chain_of_thought_template_path=&#34;relative/path/to/my_template.jinja&#34;
)
def my_func():
    # ..."><pre><span>@<span>ai</span>(</span>
<span>    <span>flavors</span> <span>=</span> [<span>&#34;chain_of_thought&#34;</span>], </span>
<span>    <span>chain_of_thought_template_path</span><span>=</span><span>&#34;relative/path/to/my_template.jinja&#34;</span></span>
<span>)</span>
<span>def</span> <span>my_func</span>():
    <span># ...</span></pre></div>
<p dir="auto">You can also set this on the decorator level, to make it default for all decorated functions.</p>
<p dir="auto">For reference, <a href="https://github.com/bananaml/fructose/blob/main/src/fructose/templates/chain_of_thought_prompt.jinja">find the default chain-of-thought template here</a></p>
<hr/>

<p dir="auto">We are in v0, meaning the API is unstable version-to-version. Pin your versions to ensure new builds don&#39;t break!
Also note... since LLM generations are nondeterminsitic, the calls may break too!</p>


<p dir="auto">Getting creative but strongly typed responses from LLMs is particularly useful in game dev scenarios.</p>
<p dir="auto">Here&#39;s a prototype of an alien creature merging/breeding game: <a href="https://twitter.com/entreprenik/status/1758948061202809066" rel="nofollow">https://twitter.com/entreprenik/status/1758948061202809066</a></p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/a6b2bfc38aea04df5418365919247eb34f5c12b236d7a3ddfc2c146c69336f7b/68747470733a2f2f7062732e7477696d672e636f6d2f6d656469612f47476a7075654261344141454650303f666f726d61743d6a7067266e616d653d343039367834303936"><img src="https://camo.githubusercontent.com/a6b2bfc38aea04df5418365919247eb34f5c12b236d7a3ddfc2c146c69336f7b/68747470733a2f2f7062732e7477696d672e636f6d2f6d656469612f47476a7075654261344141454650303f666f726d61743d6a7067266e616d653d343039367834303936" alt="fructose in game dev" title="fructose in gamedev" data-canonical-src="https://pbs.twimg.com/media/GGjpueBa4AAEFP0?format=jpg&amp;name=4096x4096"/></a></p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Developing and Contributing</h2><a id="user-content-developing-and-contributing" aria-label="Permalink: Developing and Contributing" href="#developing-and-contributing"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">From the root of this repo:</p>
<p dir="auto">Create a virtual env</p>
<div dir="auto" data-snippet-clipboard-copy-content="python3 -m venv venv
. ./venv/bin/activate"><pre>python3 -m venv venv
<span>.</span> ./venv/bin/activate</pre></div>
<p dir="auto">Install fructose into your pip environment with:</p>

<p dir="auto">This installs the fructose package in editable mode. All imports of fructose will run the fructose source at <code>./src/fructose</code> directly.</p>
<p dir="auto">Under /examples you&#39;ll find different usage examples. And run them like so:</p>
<div dir="auto" data-snippet-clipboard-copy-content="python3 examples/fake_data.py"><pre>python3 examples/fake_data.py</pre></div>
<p dir="auto">Run tests with:</p>

</article></div></div>
  </body>
</html>
