<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mabez.dev/blog/posts/esp-rust-04-04-2022/">Original</a>
    <h1>Rust on Espressif chips Q1 2022</h1>
    
    <div id="readability-page-1" class="page"><div>
        
	  <p>This is the next quarterly update of esp-rs effort, detailing the progress over Q1 2022.</p>
<h2 id="standard-library">Standard library</h2>
<h3 id="build-system-changes">Build system changes</h3>
<p>The last post mentioned we were moving towards using the built-in esp-idf build system to compile esp-idf (dubbed &#34;native&#34; build) instead of PlatformIO. I&#39;m happy to announce we have completed this step, going forward the native approach is the default, and platformIO is opt-in via the <code>pio</code> feature of <code>esp-idf-sys</code>.</p>
<h3 id="new-default-version">New default version</h3>
<p>The default esp-idf version we target in the Rust world was v4.3 (note that this can be configured on a per-project basis), we have now bumped this to now default to v4.4. Version 4.4 has some quality of life fixes, as well as some features.</p>
<ul>
<li>Atomic Emulation up to 64 bits for <code>espidf</code> targets - <a href="https://github.com/esp-rs/rust/issues/107">esp-rs/rust#107</a>.</li>
<li>A <code>realpath</code> implementation to get usable panic messages for <code>espidf</code> targets.</li>
<li>Toolchain update to support developing on Windows - <a href="https://github.com/espressif/esp-idf/issues/7864">espressif/esp-idf#7864</a>.</li>
</ul>
<h3 id="compiler-xtensa-code-generation">Compiler &amp; Xtensa code generation</h3>
<p>Rust has been a good stress test for the Xtensa LLVM backend. We&#39;ve spotted a few bugs over the last quarter which are important to squash as eventually esp-idf will be compiled with clang instead of GCC (Hopefully by that time, <code>clang</code> will be available as a <code>rustup</code> <a href="https://github.com/rust-lang/rust/issues/56371">component</a>). We have also fixed a few issues with our standard library port.</p>
<ul>
<li>LLVM compilation error when optimizing loops for the hardware loop assistance registers of the esp32 - <a href="https://github.com/esp-rs/rust/issues/95">esp-rs/rust#95</a>.</li>
<li>LLVM atomic swap code generation broken on Xtensa targets for atomics smaller than 32 bits - <a href="https://github.com/esp-rs/rust/issues/106">esp-rs/rust#106</a>.</li>
<li>Add implementations for <code>lstat</code> &amp; <code>ftruncate</code> in esp-idf - <a href="https://github.com/esp-rs/rust/issues/100">esp-rs/rust#100</a>.</li>
<li>Fix the size of certain c types for <code>espidf</code> targets such that <code>stat</code> works correctly - <a href="https://github.com/esp-rs/rust/issues/92">esp-rs/rust#92</a>.</li>
</ul>

<h3 id="goodbye-esp-rs-esp32-hal-hello-esp-rs-esp-hal">Goodbye esp-rs/esp32-hal, hello esp-rs/esp-hal</h3>
<p>The new <a href="https://github.com/esp-rs/esp-hal">esp-hal</a> is coming along very well, it already has support for GPIO, TIMG, UART, I2C, SPI, and RNG for esp32, esp32s2, esp32s3, and esp32c3. Please see <a href="https://github.com/esp-rs/esp-hal/issues/19">this tracking issue</a> to see the chip support status. This multi-chip HAL is now using the official SVDs from Espressif instead of the hacked together SVD used in the original esp32 peripheral access crate (PAC), see the <a href="https://github.com/esp-rs/esp-pacs">esp-rs/esp-pacs</a> repository. We&#39;ve added a quick start template repository <a href="https://github.com/esp-rs/esp-template">esp-rs/esp-template</a> to get started with the new bare metal HAL.</p>
<p>The original HAL for the esp32 is now in maintenance mode, and will soon be deprecated once all drivers are ported to the new multi-chip HAL. There is still a number of drivers to be ported to the new HAL. Porting them would be a good first issue for anyone interested as the implementation would mostly stay the same, just a few API &amp; type changes. Please see <a href="https://github.com/esp-rs/esp32-hal/issues/80">this issue</a> if you want to help out.</p>
<h3 id="preliminary-wifi-support">Preliminary WiFi support</h3>
<p>This is something I&#39;m personally very excited about. We&#39;ve had WiFi support for the standard library (<code>espidf</code>) targets for a long while now, but just recently we&#39;ve managed to get WiFi going in pure Rust! It&#39;s possible to <code>scan</code> for Access Points (APs) and connect to an AP, and use <code>smoltcp</code> to talk over the network! Check out the <a href="https://github.com/bjoernQ/esp32c3-wifi-rs/blob/main/examples/dhcp.rs">dhcp example</a>. The repository is currently in a proof of concept state and can be found <a href="https://github.com/bjoernQ/esp32c3-wifi-rs">here</a>. It will be moved into the <code>esp-rs</code> org once we clean it up and add xtensa support.</p>

<h3 id="espflash">espflash</h3>
<p>Since the last post we have released 1.3.0 and the 1.4.0 release is due to be published very soon which boasts some great features and fixes.</p>
<ul>
<li>Better partition table support. We now properly handle partitions other than <code>factory</code> (OTA, etc).</li>
<li>USB Serial JTAG support. It&#39;s now possible to flash over the serial part of onboard the USB Serial JTAG peripheral.</li>
<li>The ability to modify firmware header via the command line. Configure custom flash sizes, flash speeds, and flash modes.</li>
<li>Use <a href="https://github.com/esp-rs/espmonitor"><code>espmonitor</code></a> as the <code>--monitor</code> inside <code>espflash</code>. <code>espmonitor</code> can decode addresses to source functions, providing a stack trace on abort over the serial port.</li>
</ul>
<h3 id="github-actions">Github actions</h3>
<p>Want to test your Xtensa based projects in CI? We recently released <a href="https://github.com/esp-rs/xtensa-toolchain">xtensa-toolchain</a>, a Github action for installing our forked Rust compiler with Xtensa support. Instructions on how to use can be found <a href="https://github.com/marketplace/actions/rust-toolchain-for-xtensa">here</a>.</p>
<h3 id="esp-rs-devcontainer-for-visual-studio-code">esp-rs devcontainer for Visual Studio Code</h3>
<p>To target Xtensa based chips (esp32, esp32s2, esp32s3, etc) we need a custom rust compiler, with a custom LLVM backend for Xtensa. This adds some friction to getting started with Xtensa based chips. We <a href="https://github.com/esp-rs/rust-build">already offer scripts</a> to download pre-built compiler toolchains, but we are happy to announce <a href="https://github.com/SergioGasquez/esp-rs-devcontainer">esp-rs-devcontainer</a>. This integrates into Visual Studio Code using the remote containers feature, allowing easy setup for developers already familiar with containers. Please see the <a href="https://github.com/SergioGasquez/esp-rs-devcontainer#setup">setup section</a> for supported configurations and initialization steps.</p>

<h3 id="the-esp-rust-board">The ESP Rust Board</h3>
<p>We&#39;ve developed an open source development board with a focus on being ready for Rust development! It&#39;s based on the RISCV esp32c3, so a standard Rust compiler will work. Whilst the boards are not yet on sale, the source files are available <a href="https://github.com/esp-rs/esp-rust-board">here</a> if you want to build one yourself.</p>
<p><img src="https://mabez.dev/rust_board_v1_pin-layout.png"/></p><h3 id="ferrous-training">Ferrous training</h3>
<p>We have collaborated with Ferrous Systems to produce a training workshop to help teach developers how to get productive with Rust on Espressif chips! Please see the <a href="https://www.espressif.com/en/news/ESP_RUST_training">newsletter release</a> for the full details.</p>
<h2 id="what-s-next">What&#39;s next?</h2>
<p>Continue the rapid progress on the bare metal multi-chip HAL, <code>esp-hal</code> and add bare metal WiFi support for Xtensa chips. The esp-idf series of crates are starting to stabilize however, there are still plenty of drivers and libraries not yet covered by nice Rust abstractions, so lots still to do here!</p>
</div></div>
  </body>
</html>
