<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://moosie.us/parade_db_ecto">Original</a>
    <h1>Putting a full power search engine in Ecto</h1>
    
    <div id="readability-page-1" class="page"><div>


<article>
  <header>
    <div>
      
      <p>
        Posted: <span id="created_at">2024-09-25T03:14:05Z</span>
      </p>
      <p>
        Updated: <span id="modified_at">2024-09-25T05:20:08Z</span>
      </p>
      
      <hr/>
    </div>
  </header>
  <section><p><img src="https://moosie.us/assets/parade_db_ecto/mosquito-pr-mk-xvi.jpg" alt="Mosquito PR MK XVI"/></p><p>I&#39;d like to start by not-so-briefly outlining the existing approaches to text search and their use-cases, primarily around Postgres.</p><h3>Basic string comparisons</h3><p>These methods are ideal for searching short strings such as product codes, addresses, or names:</p><ul><li><code>LIKE</code> and <code>ILIKE</code> - Operators that provide basic string and sub-string matching.</li><li>Fuzzy matching / <a href="https://www.postgresql.org/docs/current/fuzzystrmatch.html">fuzzystrmatch</a> - Including Soundex, Metaphone, and Levenstein Distance.</li><li>Trigrams / <a href="https://www.postgresql.org/docs/current/pgtrgm.html">pg_tgrm</a> - Measures the similarity of words based on 3-character segments.</li></ul><p>They all have certain advantages when it comes to handling partial matches, misspellings, and phonetically similar names, but aren&#39;t suitable for searching longer text passages.</p><h3>Postgres Full Text Search</h3><p>Postgres&#39; <a href="https://www.postgresql.org/docs/current/textsearch.html">Full Text Search</a> is best characterized by its convenience-to-capability ratio. It accomodates basic document retrieval without the need to synchronize or Extract-Transform-Load (ETL) your data to another service, but languishes in terms of capability and ranking of results.</p><h3>Dedicated search engines</h3><p>Dedicated search engines are standalone applications characterized by the following:</p><ul><li>They implement <a href="https://en.wikipedia.org/wiki/Okapi_BM25">BM25</a> text search and ranking, the gold standard for search results.</li><li>Support a variety of data types for querying, sorting, and analysis.</li><li>Make it reasonably straightforward to perform complex queries.</li><li>Maintain fast response times over massive datasets using specialized data structures.</li><li>Offer some sort of horizontal scaling or sharding.</li></ul><p>Incumbent offerings in the search engine space include <a href="https://solr.apache.org/">Apache Solr</a>, <a href="https://www.elastic.co/elasticsearch">Elasticsearch</a>, and more recently <a href="https://opensearch.org/">OpenSearch</a>. All of these are built on top of Apache Lucene and the JVM. A newer wave of search engines has also come about, built on <a href="https://github.com/quickwit-oss/tantivy">Tantivy</a> and Rust. Two prominent examples include <a href="https://www.meilisearch.com/">Meilisearch</a> (focuses on simplicity) and <a href="https://quickwit.io/">Quickwit</a> (focused on logs and object storage backing).</p><p>A major drawback of search engines is that they must be kept synchronized with your database:</p><ul><li>Your application must reflect any creation, update, or deletion in your database to the search engine.</li><li>Small and large data pushes to search engines often require separate code paths. Small updates call incremental procedures, whereas large updates often necessitate rebuilding search indexes entirely.</li><li>Dissonance often occurs when either system provides some query functionality you need to utilize in the same context.</li><li>You must manage deploying and hosting any search engine, in addition to your existing infrastructure.</li></ul><p><a href="https://www.paradedb.com/">ParadeDB</a> is a set of extensions that add pretty amazing search and analytics features to Postgres. In particular, ParadeDB embeds Tantivy as an extension via <a href="https://github.com/pgcentralfoundation/pgrx">pgrx</a>.</p><p>A few weeks ago I began exploring what it’d take to support ParadeDB in Ecto. My primary goal was to figure out how much work it&#39;d take, and what the developer experience would feel like. I&#39;ve created an initial implementation and <a href="https://github.com/Moosieus/pdb_demo">sample project</a> to demonstrate. The sample project contains transcripts of publicly available police scanner calls generated by OpenAI&#39;s <a href="https://github.com/openai/whisper">Whisper</a>.</p><p>A simple search query for all calls with the word &#34;drive&#34; or &#34;driving&#34; in them would look like this:</p><pre><code><span>from</span><span data-group-id="1925390829-1">(</span><span>
  </span><span>c</span><span> </span><span>in</span><span> </span><span>Call</span><span>,</span><span>
  </span><span>search</span><span>:</span><span> </span><span>parse</span><span data-group-id="1925390829-2">(</span><span>c</span><span>,</span><span> </span><span>&#34;transcript:drive&#34;</span><span data-group-id="1925390829-2">)</span><span>
</span><span data-group-id="1925390829-1">)</span><span> </span><span>|&gt;</span><span> </span><span>Repo</span><span>.</span><span>all</span><span data-group-id="1925390829-3">(</span><span data-group-id="1925390829-3">)</span></code></pre><p>The above example uses ParadeDB&#39;s mini query language, which can be accessed via <code>parse/2</code>. More advanced and structured queries are also available.</p><p>We could limit our search query to calls between 5 and 10 seconds long, and retrieve fewer fields using Ecto&#39;s existing <code>select/3</code>:</p><pre><code><span>from</span><span data-group-id="6613861442-1">(</span><span>
  </span><span>c</span><span> </span><span>in</span><span> </span><span>Call</span><span>,</span><span>
  </span><span>search</span><span>:</span><span> </span><span>parse</span><span data-group-id="6613861442-2">(</span><span>c</span><span>,</span><span> </span><span>&#34;transcript:drive&#34;</span><span data-group-id="6613861442-2">)</span><span>,</span><span>
  </span><span>search</span><span>:</span><span> </span><span>int4range</span><span data-group-id="6613861442-3">(</span><span>c</span><span>.</span><span>call_length</span><span>,</span><span> </span><span>5</span><span>,</span><span> </span><span>10</span><span>,</span><span> </span><span>&#34;[]&#34;</span><span data-group-id="6613861442-3">)</span><span>,</span><span>
  </span><span>select</span><span>:</span><span> </span><span data-group-id="6613861442-4">{</span><span>c</span><span>.</span><span>id</span><span>,</span><span> </span><span>c</span><span>.</span><span>transcript</span><span data-group-id="6613861442-4">}</span><span>
</span><span data-group-id="6613861442-1">)</span><span> </span><span>|&gt;</span><span> </span><span>Repo</span><span>.</span><span>all</span><span data-group-id="6613861442-5">(</span><span data-group-id="6613861442-5">)</span></code></pre><pre><code><span data-group-id="5145585995-1">[</span><span>
  </span><span data-group-id="5145585995-2">{</span><span>423</span><span>,</span><span>
   </span><span>&#34;Ambulance 725 probably was responding interperson from a fall. PLS, 15,320 Pine Orchard Drive, unit number 1 at Foxtrot.&#34;</span><span data-group-id="5145585995-2">}</span><span>,</span><span>
  </span><span data-group-id="5145585995-3">{</span><span>172</span><span>,</span><span>
   </span><span>&#34;Charlie here for truck inspection. We have on track transportation driving a white van with no logo. This is the first time. Please look out for us.&#34;</span><span data-group-id="5145585995-3">}</span><span>,</span><span>
  </span><span data-group-id="5145585995-4">{</span><span>37</span><span>,</span><span>
   </span><span>&#34;Morning, Sam. Go ahead. I have a hit and run on Woodfield and Deanna Drive and the Mary 2. I only have Mary 33 right now. All right. You can hold it.&#34;</span><span data-group-id="5145585995-4">}</span><span>
</span><span data-group-id="5145585995-1">]</span></code></pre><p>For a more <strong>maximal demonstration</strong>, here&#39;s a rather complex query:</p><pre><code><span>slop</span><span> </span><span>=</span><span> </span><span>1</span><span>

</span><span>query</span><span> </span><span>=</span><span>
  </span><span>from</span><span data-group-id="4435333235-1">(</span><span>
    </span><span>c</span><span> </span><span>in</span><span> </span><span>Call</span><span>,</span><span>
    </span><span>search</span><span>:</span><span> </span><span>boolean</span><span data-group-id="4435333235-2">(</span><span data-group-id="4435333235-3">[</span><span>
      </span><span>must</span><span>:</span><span> </span><span data-group-id="4435333235-4">[</span><span>
        </span><span>parse</span><span data-group-id="4435333235-5">(</span><span>c</span><span>,</span><span> </span><span>&#34;transcript:ambulance&#34;</span><span data-group-id="4435333235-5">)</span><span>,</span><span>
        </span><span>disjunction_max</span><span data-group-id="4435333235-6">(</span><span data-group-id="4435333235-7">[</span><span>
          </span><span>boost</span><span data-group-id="4435333235-8">(</span><span>parse</span><span data-group-id="4435333235-9">(</span><span>c</span><span>,</span><span> </span><span>&#34;transcript:(BLS ALS)&#34;</span><span data-group-id="4435333235-9">)</span><span>,</span><span> </span><span>10</span><span data-group-id="4435333235-8">)</span><span>,</span><span>
          </span><span>parse</span><span data-group-id="4435333235-10">(</span><span>c</span><span>,</span><span> </span><span>&#34;transcript:(fall)&#34;</span><span data-group-id="4435333235-10">)</span><span>,</span><span>
          </span><span>phrase</span><span data-group-id="4435333235-11">(</span><span>c</span><span>.</span><span>transcript</span><span>,</span><span> </span><span data-group-id="4435333235-12">[</span><span>&#34;routine&#34;</span><span>,</span><span> </span><span>&#34;response&#34;</span><span data-group-id="4435333235-12">]</span><span>,</span><span> </span><span>^</span><span>slop</span><span data-group-id="4435333235-11">)</span><span>
        </span><span data-group-id="4435333235-7">]</span><span data-group-id="4435333235-6">)</span><span>
      </span><span data-group-id="4435333235-4">]</span><span>,</span><span>
    </span><span data-group-id="4435333235-3">]</span><span data-group-id="4435333235-2">)</span><span>
  </span><span data-group-id="4435333235-1">)</span><span>

</span><span>Repo</span><span>.</span><span>all</span><span data-group-id="4435333235-13">(</span><span>query</span><span data-group-id="4435333235-13">)</span></code></pre><p>This query will:</p><ul><li>Return calls with the word <code>&#34;ambulance&#34;</code> in them</li><li>Include at least one of: <code>&#34;ALS&#34;</code>, <code>&#34;BLS&#34;</code>, <code>&#34;fall&#34;</code>, or <code>&#34;routine response&#34;</code> within a word of one another.</li><li>Rank calls that mention <code>&#34;ALS&#34;</code> or <code>&#34;BLS&#34;</code> higher, having them appear first.</li><li>Map the results to <code>%Call{}</code> structs as like any other Ecto query.</li></ul><p>To show how the search query can compose with the rest of SQL and Ecto, let&#39;s narrow the results somewhat to suit this post:</p><pre><code><span>query</span><span>
</span><span>|&gt;</span><span> </span><span>join</span><span data-group-id="3058085230-1">(</span><span>:inner</span><span>,</span><span> </span><span data-group-id="3058085230-2">[</span><span>c</span><span data-group-id="3058085230-2">]</span><span>,</span><span> </span><span>tg</span><span> </span><span>in</span><span> </span><span>assoc</span><span data-group-id="3058085230-3">(</span><span>c</span><span>,</span><span> </span><span>:talk_group</span><span data-group-id="3058085230-3">)</span><span data-group-id="3058085230-1">)</span><span>
</span><span>|&gt;</span><span> </span><span>where</span><span data-group-id="3058085230-4">(</span><span data-group-id="3058085230-5">[</span><span>_</span><span>,</span><span> </span><span>tg</span><span data-group-id="3058085230-5">]</span><span>,</span><span> </span><span>ilike</span><span data-group-id="3058085230-6">(</span><span>tg</span><span>.</span><span>tag</span><span>,</span><span> </span><span>&#34;%dispatch%&#34;</span><span data-group-id="3058085230-6">)</span><span data-group-id="3058085230-4">)</span><span>
</span><span>#  work-alike to: where([c, _], c.call_length &lt;= 20)</span><span>
</span><span>|&gt;</span><span> </span><span>search</span><span data-group-id="3058085230-7">(</span><span data-group-id="3058085230-8">[</span><span>c</span><span>,</span><span> </span><span>_</span><span data-group-id="3058085230-8">]</span><span>,</span><span> </span><span>int4range</span><span data-group-id="3058085230-9">(</span><span>c</span><span>.</span><span>call_length</span><span>,</span><span> </span><span>nil</span><span>,</span><span> </span><span>20</span><span>,</span><span> </span><span>&#34;(]&#34;</span><span data-group-id="3058085230-9">)</span><span data-group-id="3058085230-7">)</span><span>
</span><span>|&gt;</span><span> </span><span>select</span><span data-group-id="3058085230-10">(</span><span data-group-id="3058085230-11">[</span><span>c</span><span>,</span><span> </span><span>tg</span><span data-group-id="3058085230-11">]</span><span>,</span><span> </span><span data-group-id="3058085230-12">%{</span><span>
  </span><span>id</span><span>:</span><span> </span><span>c</span><span>.</span><span>id</span><span>,</span><span>
  </span><span>text</span><span>:</span><span> </span><span>c</span><span>.</span><span>transcript</span><span>,</span><span>
  </span><span>duration</span><span>:</span><span> </span><span>c</span><span>.</span><span>call_length</span><span>,</span><span>
  </span><span>talk_group</span><span>:</span><span> </span><span>tg</span><span>.</span><span>description</span><span>
</span><span data-group-id="3058085230-12">}</span><span data-group-id="3058085230-10">)</span><span>
</span><span>|&gt;</span><span> </span><span>Repo</span><span>.</span><span>all</span><span data-group-id="3058085230-13">(</span><span data-group-id="3058085230-13">)</span></code></pre><pre><code><span data-group-id="4752498048-1">[</span><span>
  </span><span data-group-id="4752498048-2">%{</span><span>
    </span><span>id</span><span>:</span><span> </span><span>170</span><span>,</span><span>
    </span><span>text</span><span>:</span><span> </span><span>&#34;Trader Joe&#39;s, 6831 Wisconsin Avenue, Suite 400, Cross Street, Stanford Street, Decrease LLC, ALS 1, Paramedic in 706, Ambulance 741, Bravo, Response 7, Alpha 1, Box 061, 1524.&#34;</span><span>,</span><span>
    </span><span>duration</span><span>:</span><span> </span><span>13</span><span>,</span><span>
    </span><span>talk_group</span><span>:</span><span> </span><span>&#34;7A2 Dispatch&#34;</span><span>
  </span><span data-group-id="4752498048-2">}</span><span>,</span><span>
  </span><span data-group-id="4752498048-3">%{</span><span>
    </span><span>id</span><span>:</span><span> </span><span>375</span><span>,</span><span>
    </span><span>text</span><span>:</span><span> </span><span>&#34;Are the mailboxes 4302 Randolph Road, Crosstown, Veras, Miller Road, Interperson, Firm of Fall, BOS, Ambulance 705, Response 701, Vox Air 21-2, 1545.&#34;</span><span>,</span><span>
    </span><span>duration</span><span>:</span><span> </span><span>11</span><span>,</span><span>
    </span><span>talk_group</span><span>:</span><span> </span><span>&#34;7A2 Dispatch&#34;</span><span>
  </span><span data-group-id="4752498048-3">}</span><span>
</span><span data-group-id="4752498048-1">]</span></code></pre><blockquote><p><em>If you&#39;re absolutely curious what the original audio sounds like, here you are: <a href="https://moosie.us/assets/parade_db_ecto/4005-1724354632_853612500.0-call_27.m4a">170</a> and <a href="https://moosie.us/assets/parade_db_ecto/4005-1724355931_851337500.0-call_437.m4a">375</a>. Be aware that they start with loud alert tones.</em></p></blockquote><p>Overall <strong>I&#39;m quite pleased with the results thus far!</strong></p><ul><li>Search indexes are handily created in migration files. ParadeDB transparently updates the search index when rows are inserted, updated, or deleted, while retaining ACID compliance. This obviates the need to maintain any synchronization or ETL pipeline between your database and search service.</li><li>Search queries compose quite fluently with the rest of SQL. This flexibility does introduce some performance considerations, but it&#39;s nice to even have the discretion available.</li><li>Ecto provides tons of features search engine clients often lack, providing an unparalleled (to my knowledge) developer experience.</li><li>Although not demonstrated here, it&#39;s possible to perform search queries across separate indexes and <a href="https://docs.paradedb.com/api-reference/optimization/joins">JOIN them</a> as you would any other SQL query. </li></ul><h2>Current implementation and next steps</h2><p>The current Ecto implementation needs a lot more work before it’s production-ready. ParadeDB already has several especially lucrative features that I’ve yet to expose:</p><ul><li>BM25 scores can be returned from ranked queries.</li><li>Searches also support hybrid search when used with pg_vector and AI generated embeddings.</li><li>Aggregates and facets are available, although limited to enterprise customers for now. (This will probably change at some point)</li><li>ParadeDB 0.10.0 just dropped, and adds lots of optimizations and features I&#39;ve not been able to touch yet.</li></ul><p>There’s also lots more getting the implementation <em>&#39;generally correct&#39;</em>, well tested, and working with all of Ecto’s existing features.</p><h2>Looking forward</h2><p>My tentative plan&#39;s to continue working on this with the goal of maintaining a <strong>downstream</strong> fork of <code>:ecto</code> and <code>:ecto_sql</code> others can use. That said, I’m just one person, so it’ll probably be a while before I’m able to fully realize that. If any folks are interested in contributing to accelerate the process, drop a PR, or message me on the Elixir Slack or Discord, @Moosieus.</p><p>ParadeDB itself is only about a year old, so it&#39;s early days yet. The core team&#39;s small but talented, and they&#39;ve fostered a community with lots of active contributions. Tantivy itself is also seeing continued improvement which will benefit ParadeDB in turn.</p><p>The code I&#39;m working on is located here: <a href="https://github.com/Moosieus/ecto">moosieus/ecto</a> and <a href="https://github.com/Moosieus/ecto_sql">moosieus/ecto_sql</a>. </p><h3>Q&amp;A</h3><p><strong>Why not just use fragments?</strong></p><p>ParadeDB introduces the need to compose its own queries within Ecto, which is a more comprehensive problem than fragments can address.</p><p><strong>Doesn&#39;t Postgrex support extensions?</strong></p><p>Postgrex extensions allow users to encode and decode additional data types. ParadeDB&#39;s API uses Postgres&#39; existing data types, so the extension API isn&#39;t of use here.</p><p><strong>Wouldn&#39;t a fork not get updates from Ecto?</strong></p><p>It&#39;d be a <em>downstream</em> fork, meaning changes from Ecto would be merged in and published regularly. The versions might have to look a bit funny though, something like <code>3.10.2-paradedb-v1</code>. I haven&#39;t fully thought this part out.</p></section>
  <hr/>
</article>
  </div></div>
  </body>
</html>
