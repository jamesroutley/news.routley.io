<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://0x80.pl/notesen/2024-12-21-uint8-division.html">Original</a>
    <h1>Dividing unsigned 8-bit numbers</h1>
    
    <div id="readability-page-1" class="page"><div id="step-1-updating-reminder-1">
<h3>Step 1: Updating reminder</h3>
<p>Unlike SSE/AVX2 code it&#39;s easier to actually perform shift right
to place i-th bit at position zero. Then isolating the least
siginificant bit and merging it with quotient can be expressed
as a single <a href="http://0x80.pl/notesen/2015-03-22-avx512-ternary-functions.html">ternary operation</a>.</p>
<pre><span>reminder</span><span> </span><span>&lt;&lt;=</span><span> </span><span>1</span><span>;</span><span>
</span><span>t0</span><span>         </span><span>=</span><span> </span><span>divisor</span><span> </span><span>&gt;&gt;</span><span> </span><span>i</span><span>;</span><span>
</span><span>reminder</span><span>   </span><span>=</span><span> </span><span>reminder</span><span> </span><span>|</span><span> </span><span>(</span><span>t0</span><span> </span><span>&amp;</span><span> </span><span>1</span><span>);</span><span> </span><span>// ternary operation</span>
</pre>
</div><div id="step-2-comparison-1">
<h3>Step 2: Comparison</h3>
<p>AVX512 supports unsigned byte comparison, and returns a mask.</p>
</div><div id="step-3-conditional-operations-1">
<h3>Step 3: Conditional operations</h3>
<p>This is straightforward use of masked operations.</p>
</div><div id="implementation">
<h3>Implementation</h3>
<p>The actual AVX512 implementation is shown below. Unlike SSE code, the inner
loop is manually unrolled. Also, there&#39;s no explictly use of the ternary logic
intrinsic function â€” but examing the assembly code revelas that a compiler
nicely fuses binary operation.</p>
<pre><span>void</span><span> </span><span>avx512_long_div_u8</span><span>(</span><span>const</span><span> </span><span>uint8_t</span><span>*</span><span> </span><span>A</span><span>,</span><span> </span><span>const</span><span> </span><span>uint8_t</span><span>*</span><span> </span><span>B</span><span>,</span><span> </span><span>uint8_t</span><span>*</span><span> </span><span>C</span><span>,</span><span> </span><span>size_t</span><span> </span><span>n</span><span>)</span><span> </span><span>{</span><span>
    </span><span>const</span><span> </span><span>__m512i</span><span> </span><span>one</span><span> </span><span>=</span><span> </span><span>_mm512_set1_epi8</span><span>(</span><span>1</span><span>);</span><span>

    </span><span>for</span><span> </span><span>(</span><span>size_t</span><span> </span><span>i</span><span>=</span><span>0</span><span>;</span><span> </span><span>i</span><span> </span><span>&lt;</span><span> </span><span>n</span><span>;</span><span> </span><span>i</span><span> </span><span>+=</span><span> </span><span>64</span><span>)</span><span> </span><span>{</span><span>
        </span><span>const</span><span> </span><span>__m512i</span><span> </span><span>dividend</span><span> </span><span>=</span><span> </span><span>_mm512_loadu_si512</span><span>((</span><span>const</span><span> </span><span>__m512</span><span>*</span><span>)(</span><span>&amp;</span><span>A</span><span>[</span><span>i</span><span>]));</span><span>
        </span><span>const</span><span> </span><span>__m512i</span><span> </span><span>divisor</span><span>  </span><span>=</span><span> </span><span>_mm512_loadu_si512</span><span>((</span><span>const</span><span> </span><span>__m512</span><span>*</span><span>)(</span><span>&amp;</span><span>B</span><span>[</span><span>i</span><span>]));</span><span>

        </span><span>const</span><span> </span><span>__m512i</span><span> </span><span>dividend_bit7</span><span> </span><span>=</span><span> </span><span>_mm512_and_epi32</span><span>(</span><span>_mm512_srli_epi32</span><span>(</span><span>dividend</span><span>,</span><span> </span><span>7</span><span>),</span><span> </span><span>one</span><span>);</span><span>
        </span><span>const</span><span> </span><span>__m512i</span><span> </span><span>dividend_bit6</span><span> </span><span>=</span><span> </span><span>_mm512_and_epi32</span><span>(</span><span>_mm512_srli_epi32</span><span>(</span><span>dividend</span><span>,</span><span> </span><span>6</span><span>),</span><span> </span><span>one</span><span>);</span><span>
        </span><span>const</span><span> </span><span>__m512i</span><span> </span><span>dividend_bit5</span><span> </span><span>=</span><span> </span><span>_mm512_and_epi32</span><span>(</span><span>_mm512_srli_epi32</span><span>(</span><span>dividend</span><span>,</span><span> </span><span>5</span><span>),</span><span> </span><span>one</span><span>);</span><span>
        </span><span>const</span><span> </span><span>__m512i</span><span> </span><span>dividend_bit4</span><span> </span><span>=</span><span> </span><span>_mm512_and_epi32</span><span>(</span><span>_mm512_srli_epi32</span><span>(</span><span>dividend</span><span>,</span><span> </span><span>4</span><span>),</span><span> </span><span>one</span><span>);</span><span>
        </span><span>const</span><span> </span><span>__m512i</span><span> </span><span>dividend_bit3</span><span> </span><span>=</span><span> </span><span>_mm512_and_epi32</span><span>(</span><span>_mm512_srli_epi32</span><span>(</span><span>dividend</span><span>,</span><span> </span><span>3</span><span>),</span><span> </span><span>one</span><span>);</span><span>
        </span><span>const</span><span> </span><span>__m512i</span><span> </span><span>dividend_bit2</span><span> </span><span>=</span><span> </span><span>_mm512_and_epi32</span><span>(</span><span>_mm512_srli_epi32</span><span>(</span><span>dividend</span><span>,</span><span> </span><span>2</span><span>),</span><span> </span><span>one</span><span>);</span><span>
        </span><span>const</span><span> </span><span>__m512i</span><span> </span><span>dividend_bit1</span><span> </span><span>=</span><span> </span><span>_mm512_and_epi32</span><span>(</span><span>_mm512_srli_epi32</span><span>(</span><span>dividend</span><span>,</span><span> </span><span>1</span><span>),</span><span> </span><span>one</span><span>);</span><span>
        </span><span>const</span><span> </span><span>__m512i</span><span> </span><span>dividend_bit0</span><span> </span><span>=</span><span> </span><span>_mm512_and_epi32</span><span>(</span><span>_mm512_srli_epi32</span><span>(</span><span>dividend</span><span>,</span><span> </span><span>0</span><span>),</span><span> </span><span>one</span><span>);</span><span>

        </span><span>__m512i</span><span> </span><span>quotient</span><span> </span><span>=</span><span> </span><span>_mm512_set1_epi32</span><span>(</span><span>0</span><span>);</span><span>
        </span><span>__m512i</span><span> </span><span>reminder</span><span> </span><span>=</span><span> </span><span>dividend_bit7</span><span>;</span><span>

        </span><span>{</span><span>
            </span><span>const</span><span> </span><span>__mmask64</span><span> </span><span>ge</span><span> </span><span>=</span><span> </span><span>_mm512_cmpge_epu8_mask</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>divisor</span><span>);</span><span>
            </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_mask_sub_epi8</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>ge</span><span>,</span><span> </span><span>reminder</span><span>,</span><span> </span><span>divisor</span><span>);</span><span>
            </span><span>quotient</span><span> </span><span>=</span><span> </span><span>_mm512_mask_add_epi8</span><span>(</span><span>quotient</span><span>,</span><span> </span><span>ge</span><span>,</span><span> </span><span>quotient</span><span>,</span><span> </span><span>one</span><span>);</span><span>
        </span><span>}</span><span>

        </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_add_epi32</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>reminder</span><span>);</span><span>
        </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_or_epi32</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>dividend_bit6</span><span>);</span><span>

        </span><span>{</span><span>
            </span><span>const</span><span> </span><span>__mmask64</span><span> </span><span>ge</span><span> </span><span>=</span><span> </span><span>_mm512_cmpge_epu8_mask</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>divisor</span><span>);</span><span>
            </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_mask_sub_epi8</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>ge</span><span>,</span><span> </span><span>reminder</span><span>,</span><span> </span><span>divisor</span><span>);</span><span>
            </span><span>quotient</span><span> </span><span>=</span><span> </span><span>_mm512_add_epi32</span><span>(</span><span>quotient</span><span>,</span><span> </span><span>quotient</span><span>);</span><span>
            </span><span>quotient</span><span> </span><span>=</span><span> </span><span>_mm512_mask_add_epi8</span><span>(</span><span>quotient</span><span>,</span><span> </span><span>ge</span><span>,</span><span> </span><span>quotient</span><span>,</span><span> </span><span>one</span><span>);</span><span>
        </span><span>}</span><span>

        </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_add_epi32</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>reminder</span><span>);</span><span>
        </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_or_epi32</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>dividend_bit5</span><span>);</span><span>

        </span><span>{</span><span>
            </span><span>const</span><span> </span><span>__mmask64</span><span> </span><span>ge</span><span> </span><span>=</span><span> </span><span>_mm512_cmpge_epu8_mask</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>divisor</span><span>);</span><span>
            </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_mask_sub_epi8</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>ge</span><span>,</span><span> </span><span>reminder</span><span>,</span><span> </span><span>divisor</span><span>);</span><span>
            </span><span>quotient</span><span> </span><span>=</span><span> </span><span>_mm512_add_epi32</span><span>(</span><span>quotient</span><span>,</span><span> </span><span>quotient</span><span>);</span><span>
            </span><span>quotient</span><span> </span><span>=</span><span> </span><span>_mm512_mask_add_epi8</span><span>(</span><span>quotient</span><span>,</span><span> </span><span>ge</span><span>,</span><span> </span><span>quotient</span><span>,</span><span> </span><span>one</span><span>);</span><span>
        </span><span>}</span><span>

        </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_add_epi32</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>reminder</span><span>);</span><span>
        </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_or_epi32</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>dividend_bit4</span><span>);</span><span>

        </span><span>{</span><span>
            </span><span>const</span><span> </span><span>__mmask64</span><span> </span><span>ge</span><span> </span><span>=</span><span> </span><span>_mm512_cmpge_epu8_mask</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>divisor</span><span>);</span><span>
            </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_mask_sub_epi8</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>ge</span><span>,</span><span> </span><span>reminder</span><span>,</span><span> </span><span>divisor</span><span>);</span><span>
            </span><span>quotient</span><span> </span><span>=</span><span> </span><span>_mm512_add_epi32</span><span>(</span><span>quotient</span><span>,</span><span> </span><span>quotient</span><span>);</span><span>
            </span><span>quotient</span><span> </span><span>=</span><span> </span><span>_mm512_mask_add_epi8</span><span>(</span><span>quotient</span><span>,</span><span> </span><span>ge</span><span>,</span><span> </span><span>quotient</span><span>,</span><span> </span><span>one</span><span>);</span><span>
        </span><span>}</span><span>

        </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_add_epi32</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>reminder</span><span>);</span><span>
        </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_or_epi32</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>dividend_bit3</span><span>);</span><span>

        </span><span>{</span><span>
            </span><span>const</span><span> </span><span>__mmask64</span><span> </span><span>ge</span><span> </span><span>=</span><span> </span><span>_mm512_cmpge_epu8_mask</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>divisor</span><span>);</span><span>
            </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_mask_sub_epi8</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>ge</span><span>,</span><span> </span><span>reminder</span><span>,</span><span> </span><span>divisor</span><span>);</span><span>
            </span><span>quotient</span><span> </span><span>=</span><span> </span><span>_mm512_add_epi32</span><span>(</span><span>quotient</span><span>,</span><span> </span><span>quotient</span><span>);</span><span>
            </span><span>quotient</span><span> </span><span>=</span><span> </span><span>_mm512_mask_add_epi8</span><span>(</span><span>quotient</span><span>,</span><span> </span><span>ge</span><span>,</span><span> </span><span>quotient</span><span>,</span><span> </span><span>one</span><span>);</span><span>
        </span><span>}</span><span>

        </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_add_epi32</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>reminder</span><span>);</span><span>
        </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_or_epi32</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>dividend_bit2</span><span>);</span><span>

        </span><span>{</span><span>
            </span><span>const</span><span> </span><span>__mmask64</span><span> </span><span>ge</span><span> </span><span>=</span><span> </span><span>_mm512_cmpge_epu8_mask</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>divisor</span><span>);</span><span>
            </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_mask_sub_epi8</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>ge</span><span>,</span><span> </span><span>reminder</span><span>,</span><span> </span><span>divisor</span><span>);</span><span>
            </span><span>quotient</span><span> </span><span>=</span><span> </span><span>_mm512_add_epi32</span><span>(</span><span>quotient</span><span>,</span><span> </span><span>quotient</span><span>);</span><span>
            </span><span>quotient</span><span> </span><span>=</span><span> </span><span>_mm512_mask_add_epi8</span><span>(</span><span>quotient</span><span>,</span><span> </span><span>ge</span><span>,</span><span> </span><span>quotient</span><span>,</span><span> </span><span>one</span><span>);</span><span>
        </span><span>}</span><span>

        </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_add_epi32</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>reminder</span><span>);</span><span>
        </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_or_epi32</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>dividend_bit1</span><span>);</span><span>

        </span><span>{</span><span>
            </span><span>const</span><span> </span><span>__mmask64</span><span> </span><span>ge</span><span> </span><span>=</span><span> </span><span>_mm512_cmpge_epu8_mask</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>divisor</span><span>);</span><span>
            </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_mask_sub_epi8</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>ge</span><span>,</span><span> </span><span>reminder</span><span>,</span><span> </span><span>divisor</span><span>);</span><span>
            </span><span>quotient</span><span> </span><span>=</span><span> </span><span>_mm512_add_epi32</span><span>(</span><span>quotient</span><span>,</span><span> </span><span>quotient</span><span>);</span><span>
            </span><span>quotient</span><span> </span><span>=</span><span> </span><span>_mm512_mask_add_epi8</span><span>(</span><span>quotient</span><span>,</span><span> </span><span>ge</span><span>,</span><span> </span><span>quotient</span><span>,</span><span> </span><span>one</span><span>);</span><span>
        </span><span>}</span><span>

        </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_add_epi32</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>reminder</span><span>);</span><span>
        </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_or_epi32</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>dividend_bit0</span><span>);</span><span>


        </span><span>{</span><span>
            </span><span>const</span><span> </span><span>__mmask64</span><span> </span><span>ge</span><span> </span><span>=</span><span> </span><span>_mm512_cmpge_epu8_mask</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>divisor</span><span>);</span><span>
            </span><span>reminder</span><span> </span><span>=</span><span> </span><span>_mm512_mask_sub_epi8</span><span>(</span><span>reminder</span><span>,</span><span> </span><span>ge</span><span>,</span><span> </span><span>reminder</span><span>,</span><span> </span><span>divisor</span><span>);</span><span>
            </span><span>quotient</span><span> </span><span>=</span><span> </span><span>_mm512_add_epi8</span><span>(</span><span>quotient</span><span>,</span><span> </span><span>quotient</span><span>);</span><span>
            </span><span>quotient</span><span> </span><span>=</span><span> </span><span>_mm512_mask_add_epi8</span><span>(</span><span>quotient</span><span>,</span><span> </span><span>ge</span><span>,</span><span> </span><span>quotient</span><span>,</span><span> </span><span>one</span><span>);</span><span>
        </span><span>}</span><span>

        </span><span>_mm512_storeu_si512</span><span>((</span><span>__m512</span><span>*</span><span>)</span><span>&amp;</span><span>C</span><span>[</span><span>i</span><span>],</span><span> </span><span>quotient</span><span>);</span><span>
    </span><span>}</span><span>
</span><span>}</span>
</pre>
</div></div>
  </body>
</html>
