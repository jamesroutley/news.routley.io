<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://kennedn.com/blog/posts/tapo/">Original</a>
    <h1>Wanted to spy on my dog, ended up spying on TP-Link</h1>
    
    <div id="readability-page-1" class="page"><section>
    <p>Saturday, September 13, 2025</p></section><article><p><img src="https://avi.im/blag/2025/setsum/cover.webp" alt=""/></p>
<p>I recently bought a cheap Tapo indoor camera to see what my dog gets up to when I am out of the house.</p>
<p>What actually followed? I ended up reverse-engineering onboarding flows, decompiling an APK, MITMing TLS sessions, and writing cryptographic scripts.</p>
<p>My main motivation for this project really stemmed from the fact that the camera annoyed me from day one. Setting the camera up in frigate was quite painful, no one really seemed to know how these cameras worked online.</p>
<blockquote>
<p>SIDENOTE: If you want 2 way audio to work in frigate you must use the <code>tapo://</code> go2rtc configuration for your main stream instead of the usual <code>rtsp://</code>. TP-Link are lazy and only implement 2 way audio on their own proprietary API.</p>
</blockquote>
<p>One undocumented behavior that tripped me up was that the device‚Äôs API is supposed to accept credentials <code>admin</code>:<code>&lt;your-tapo-cloud-password&gt;</code> after onboarding. However after banging my head against a wall for a few hours I later discovered that if you change your cloud password after onboarding, paired devices don‚Äôt get the memo üôÇ.</p>
<p>This implied a few things to me that started the cogs turning:</p>
<ul>
<li>There must be a call made during on-boarding that syncs the device password with the cloud password</li>
<li>The device must either allow unauthenticated calls before this step or have some sort of default password.</li>
</ul>
<p>So considering my onboarding woes and the fact that I was starting to recoil every time the tapo app tried to jam a ‚ÄúTapo Care‚Äù subscription down my throat, a cloudless onboarding solution for the device was beginning to look more and more desirable.</p>
<p>The first step to cracking this egg was to be be able to snoop on what the app and the camera are saying to each other during onboarding. E.g, establish a man in the middle.</p>
<h2 id="man-in-the-middle">Man in the middle</h2>
<p>To man in the middle a phone app, you must be able to route all http(s) traffic via a proxy server you control. Historically this has been quite simple to achieve, simply spin up a proxy on a computer, add the proxy‚Äôs self-signed certificate to the phone‚Äôs truststore, and configure the phone to point at the proxy.</p>
<p>However, modern phone apps can use a few nasty tricks to render this approach ineffective. Namely they will blatantly ignore proxies, throw the system truststore to the wind and make liberal use of certificate pinning.</p>
<p>The most full-proof technique for generically MITMing an app has therefore become dynamic instrumentation via tools like <code>frida</code>. What this allows us to do is force an app to use the proxies and certificates that we tell it to whilst batting aside it‚Äôs attempts to do things like certificate pinning.</p>
<p>So the setup ended up looking like this (full setup guide <a href="https://github.com/kennedn/tapo-onboarding?tab=readme-ov-file#capturing-onboarding-calls-from-tapo-app" target="_blank" rel="noopener noreferrer">here</a>
):</p>
<pre>  ---
config:
  theme: &#39;base&#39;
  themeVariables:
    primaryColor: &#39;#00000000&#39;
    primaryTextColor: &#39;#fff&#39;
    primaryBorderColor: &#39;#ffffff8e&#39;
    lineColor: &#39;#fff&#39;
    secondaryColor: &#39;#fff&#39;
    tertiaryColor: &#39;#fff&#39;
---
sequenceDiagram
    participant A as Tapo App &lt;br&gt;(with frida hooks)
    participant L as Laptop &lt;br&gt;(mitmproxy)
    participant C as Tapo Camera

    A-&gt;&gt;L: Request
    L-&gt;&gt;L: Record request
    L-&gt;&gt;C: Forward request
    C--&gt;&gt;L: Response
    L-&gt;&gt;L: Record response
    L--&gt;&gt;A: Forward response
</pre>

<p>After spinning up <code>mitmproxy</code>, injecting the <a href="https://github.com/httptoolkit/frida-interception-and-unpinning" target="_blank" rel="noopener noreferrer">frida scripts</a>
, and onboarding the camera, we finally see an initial login flow ‚Äî before the admin password ever gets changed:</p>

<p>However, subsequent requests look like this:</p>
<div><pre tabindex="0"><code data-lang="json"><span><span><span>{</span>
</span></span><span><span>  <span>&#34;method&#34;</span><span>:</span> <span>&#34;securePassthrough&#34;</span><span>,</span>
</span></span><span><span>  <span>&#34;params&#34;</span><span>:</span> <span>{</span>
</span></span><span><span>    <span>&#34;request&#34;</span><span>:</span> <span>&#34;bAhdgihJ9j6PrrknnbXWATBohGTZK5llv3MEzRcmoAmcxexmlVNz3OUX2r0h9a9EG/3X0tBpPi654T2+BjqVEOn2D178kokBpf8RQj01AvBZLYD5S5sFeaCXWiRXA7MgQUppROV4AbrU4f+GOM37KgPqT59qgLVja2slw6CzrKjPzOrG4Ho6Mu6wBa1xepcj&#34;</span>
</span></span><span><span>  <span>}</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>And responses look like this:</p>
<div><pre tabindex="0"><code data-lang="json"><span><span><span>{</span>
</span></span><span><span>  <span>&#34;seq&#34;</span><span>:</span> <span>584</span><span>,</span>
</span></span><span><span>  <span>&#34;result&#34;</span><span>:</span> <span>{</span>
</span></span><span><span>    <span>&#34;response&#34;</span><span>:</span> <span>&#34;Gqz1wbXAig/3wL+kXzY2Ig3hq+JSYasYI7FXdMNZR5PyH8bpLX+GJqQbImUtby9IEj5HQDhxqcTa+dUqQjI0GaGCxuGHqmrgQ0FeyCTQjBiW5gslAPQG33wj44OOkAep&#34;</span>
</span></span><span><span>  <span>},</span>
</span></span><span><span>  <span>&#34;error_code&#34;</span><span>:</span> <span>0</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>So from this initial dive we have learned that:</p>
<ul>
<li>Tapo 100% has a default password due to the fact that it performs a full login before it knows anything about the cloud password.</li>
<li>Tapo has an encrypted <code>securePassthrough</code> channel for its API calls to prevent peeping toms such as myself from spilling the beans.</li>
</ul>
<h2 id="the-jadx-dive">The JADX dive</h2>
<p>The next logical step is to decompile the apk in JADX and start rummaging around for a default password.</p>
<p>The initial login call that we captured references an <code>admin</code> username:</p>

<div><pre tabindex="0"><code data-lang="json"><span><span><span>{</span>
</span></span><span><span>  <span>&#34;method&#34;</span><span>:</span> <span>&#34;login&#34;</span><span>,</span>
</span></span><span><span>  <span>&#34;params&#34;</span><span>:</span> <span>{</span>
</span></span><span><span>    <span>&#34;cnonce&#34;</span><span>:</span> <span>&#34;AD0E189F6E1BA335&#34;</span><span>,</span>
</span></span><span><span>    <span>&#34;encrypt_type&#34;</span><span>:</span> <span>&#34;3&#34;</span><span>,</span>
</span></span><span><span>    <span>&#34;username&#34;</span><span>:</span> <span>&#34;admin&#34;</span>
</span></span><span><span>  <span>}</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Searching for <code>&#34;admin&#34;</code> in JADX gives us many hits but there are a few concentrated in a <code>CameraOnboardingViewModel</code> class that look interesting:</p>
<p><img src="https://avi.im/blag/2025/setsum/jadx1.webp" alt=""/></p>
<p>The function <code>m98131y2</code> appears to be returning a password that is then passed to the <code>new Account()</code> call. Following this function up the chain, we hit gold:</p>

<p><a href="#loginrequest">We already know</a>
 that the device is using <code>encrypt_type: 3</code>, so that means our default password is:</p>
<p><code>TPL075526460603</code></p>
<h2 id="teaching-mitmproxy-new-tricks">Teaching mitmproxy new tricks</h2>
<p>With the default password now revealed, we have the cards in our hand to derive session keys and decode the <code>securePassthrough</code> messages.</p>
<p>The only thing that would help us further is if we had a reference implementation for the authentication flow. This is where <a href="https://github.com/JurajNyiri/pytapo" target="_blank" rel="noopener noreferrer">PyTapo</a>
 really came in handy.</p>
<p>Using PyTapo as a reference, we could dump the session state and encrypted messages from mitmproxy and write a script to do some static analysis on the decrypted requests and responses, but a really cool feature of <code>mitmproxy</code> is that it supports scripting itself.</p>
<p>What this means is that we can pass a python script to mitmproxy, and have it directly decrypt request and response payloads inline whilst running a capture.</p>
<p>So I wrote <code>tapo_decrypt_pretty.py</code> which:</p>
<ul>
<li>Watches for the login handshake (<code>cnonce</code>, <code>nonce</code>, <code>device_confirm</code>)</li>
<li>Derives <code>lsk</code>/<code>ivb</code> session keys from it</li>
<li>Transparently decrypts subsequent API calls</li>
<li>Pretty-prints them inline in mitmproxy‚Äôs UI in <code>request_decrypted</code> and <code>response_decrypted</code> fields</li>
<li>Dumps them to JSON files for later analysis</li>
</ul>

<h2 id="analysing-the-results">Analysing the results</h2>
<p>The complete list of calls made by the Tapo app during onboarding were:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>getAppComponentList
</span></span><span><span>setLanguage
</span></span><span><span>scanApList
</span></span><span><span>bindToCloud
</span></span><span><span>changeAdminPassword
</span></span><span><span>setTimezone
</span></span><span><span>setRecordPlan
</span></span><span><span>setDeviceLocation
</span></span><span><span>connectAp
</span></span><span><span>getConnectStatus
</span></span><span><span>setAccountEnabled
</span></span><span><span>changeThirdAccount
</span></span></code></pre></div><p>This boiled down to just four important calls:</p>
<ol>
<li><code>scanApList</code> ‚Äî list Wi-Fi access points</li>
<li><code>setAccountEnabled</code> + <code>changeThirdAccount</code> ‚Äî enable RTSP/ONVIF account</li>
<li><code>changeAdminPassword</code> ‚Äî change from default password to the cloud password</li>
<li><code>connectAp</code> ‚Äî join the selected Wi-Fi access point</li>
</ol>
<p>Everything else was fluff: timezones, record plans, binding to cloud.</p>
<h2 id="final-thoughts">Final thoughts</h2>
<p>In the end, the prize for all this nonsense was a scrappy little Bash script, <a href="https://github.com/kennedn/tapo-onboarding/blob/main/tapo_onboard.sh" target="_blank" rel="noopener noreferrer"><code>tapo_onboard.sh</code></a>
, which:</p>
<ul>
<li>Logs in with the default admin password,</li>
<li>Scans and selects a Wifi access point</li>
<li>Switches off the obnoxious OSD logo on the camera feed,</li>
<li>Enables RTSP/ONVIF capabilities</li>
<li>Changes the admin password,</li>
<li>And finally joins the Wi-Fi.</li>
</ul>

<p>Peeling this onion left me with a few observations on Tapo‚Äôs firmware.</p>
<ul>
<li>Some endpoints use SHA-256 for hashing, while others cling to MD5 like it‚Äôs 2003.</li>
<li>There are <em>two</em> public keys used to send passwords to the device ‚Äî one that is shared with the client and another super secret one that‚Äôs hardcoded in the app. The easiest way to figure out which one to use is to flip a coin.</li>
<li>Password syncing between the app and its managed devices is strictly vibe-based.</li>
</ul>
<p>The whole thing feels like it was cobbled together by a consortium of couch-cryptographers. But then again, it was the cheapest indoor camera on amazon, so what did I expect?</p>
<p>And with all this said I did finally manage to figure out what the dog does when I am away.</p>
<p>She sleeps. On the sofa. Sometimes even in her bed.</p>

</article></div>
  </body>
</html>
