<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.thingsquare.com/blog/articles/iot-mesh-large-scale-testing/">Original</a>
    <h1>How to run a city-wide wireless network from a drawer</h1>
    
    <div id="readability-page-1" class="page"><div>
          <section><p>How do we test a wireless network that will be deployed like this:</p>
<img data-src="device-locations.png" alt="Large-scale IoT mesh network deployment"/>

<p>With a test setup that looks like this:</p>
<img data-src="testbed-compact.jpg" alt="Large-scale IoT mesh network testbed"/>

<p>The answer: <a href="https://en.wikipedia.org/wiki/MAC_filtering" target="_blank"><span>MAC</span>-level packet filtering</a>. With a bit of software to help us set it up correctly.</p>
<h2 id="how-to-test-a-large-scale-iot-mesh-network-with-a-small-scale-setup">How to test a large-scale IoT mesh network with a small-scale setup</h2>
<p>At Thingsquare we build large <a href="https://www.thingsquare.com/customers/" target="_blank">Internet of Things (IoT) solutions</a> that involve many thousands devices per system.</p>
<p>To cover large areas, we use <a href="https://www.thingsquare.com/blog/articles/what-is-subghz-networking/" target="_blank">sub-GHz radio frequencies</a> with <a href="https://www.thingsquare.com/blog/articles/why-iot-mesh/" target="_blank">IPv6 mesh networking</a>. In a mesh network, every device extend the range of the other devices.</p>
<p>What do we mean by large? <a href="https://www.thingsquare.com/blog/articles/iot-mesh-retail/" target="_blank">Sometimes that’s a department store</a>. Sometimes it an entire city.</p>
<p>Is this challenging?</p>
<p>Yes.</p>
<p>The <a href="https://www.thingsquare.com/blog/articles/iot-platform-challenges/" target="_blank">scale is a challenge by itself</a>.</p>
<p>To add to the challenge, every IoT solution is built with custom code.</p>
<p>Even with a solid <a href="https://www.thingsquare.com/iot-platform/" target="_blank">platform</a> as a starting point, each solution is different.</p>
<p>There is custom code running on the tiny microprocessors that are inside each device. There is custom software that controls the devices and handles the data that they produce.</p>
<p>This software needs to be developed. And it needs to be tested. And its performance must be good.</p>
<p>IoT solutions are highly complex systems. In such complex systems, it is hard to predict the performance without actually running the system. Then measure its performance.</p>
<p>So we need to run the system as soon as possible. And the system needs to be as close to the real thing as we can make it.</p>
<h2 id="a-lab-setup">A lab setup</h2>
<p>We could just deploy a system in the field, before we even have any custom code written. And then progressively update the code, <a href="https://www.thingsquare.com/blog/articles/network-updates/" target="_blank">over the air</a>, in the field as we develop it.</p>
<p>That works. We have done this on occasion. But it is highly inefficient.</p>
<p>And there is always a risk that we inadvertently deploy a version of the code that has a catastrophic bug that will make the entire system unusable.</p>
<p>So we need a lab setup.</p>
<p>With a lab setup, we have immediate, physical access to all devices. This means that we can reprogram them if we would break something.</p>
<p>We also have control of the environment. Do we need to test it with a specific temperature? Do we need to generate radio interference on specific frequencies? In the lab, that’s easy. In the field? Not so much.</p>
<p>A lab setup can be simple and still be useful. All it takes is a bunch of hardware boards placed in the vicinity of each other.</p>
<p>The next is up to the software.</p>
<h2 id="how-to-make-a-small-scale-system-behave-like-a-large-scale-system">How to make a small-scale system behave like a large-scale system</h2>
<p>There are several factors that make a lab setup different from a field deployment.</p>
<p>In the lab, all devices are close to each other. This means that they hear each other.</p>
<p>In the field, devices are far away from each other. So they will only be able to hear the devices that are next to it.</p>
<p>We want to emulate this behavior in the lab.</p>
<p>That is, we want to achieve this:</p>
<img data-src="simulated-positions.png" alt="IoT mesh network spread out over a large distance"/>

<p>When we in reality have this:</p>
<img data-src="actual-positions.png" alt="IoT mesh network where all devices are clustered close to each other"/>

<p>So this is what we do:</p>
<ul>
<li>We program each device with the ability to select specific devices that it choses to hear – and which to ignore.</li>
<li>We configure the that table for each device in a specific way – a way that matches what network structure we want to emulate.</li>
</ul>
<p>
<small>
This process is called <span>MAC</span> filtering, because it filters out specific devices based on their <a href="https://en.wikipedia.org/wiki/MAC_address" target="_blank">Medium Access Control (<span>MAC</span>) layer address</a>. The <span>MAC</span> layer address is a 16-byte long address that is burned into the hardware of each device. This address is sometimes called the EUI – <a href="https://www.ietf.org/rfc/rfc7042.txt" target="_blank">Extended Unique Identifier</a>.
</small>
</p>

<p>Manually configuring tables of devices and their <span>MAC</span> addresses are hard work though. So we make it easy by allowing devices to be placed on a map.</p>
<img data-src="simulated-positions.gif" alt="Devices are placed on a map"/>

<p>When we move devices around the map, the circle around the device shows the (emulated) communication range for that device. As the communication range covers neighboring devices, those devices are marked with a line. This makes it easy to see what devices it can communicate with.</p>
<p>Once all devices are placed on the map, we click the <code>Apply</code> button. This will cause all devices’ <span>MAC</span> layer filters to be configured according to their positions on the map.</p>
<p>But wait!</p>
<p>What if we have placed devices in positions where they are not reachable from other devices in the network? This could potentially cause devices to be unreachable.</p>
<p>Fortunately, the system helps by identifying this situation:</p>
<img data-src="no-neighbors.png" alt="Devices are placed on a map"/>

<p>And allows us to remedy this by placing the problematic devices in better positions.</p>
<img data-src="no-neighbors-remedy.png" alt="Devices are placed on a map"/>

<p>Once all devices are positioned, we can ask the system to activate the device filters.</p>
<div>
<p><img data-src="activate-filters.png" alt="Activate filters with the Activate filters button"/>
</p>
</div>

<p>The network will then start to activate their filters. Since the network now has a completely different layout, it might take a few minutes for the network to figure out its new structure.</p>
<p>Once all devices have reported their new parents, we can see the structure of the network in the mesh view.</p>
<div>
<p><img data-src="mesh-view.png" alt="The mesh structure of the network mirrors the map view that we have created"/>
</p>
</div>

<p>We can now run the performance measurements that we want, with the full network structure that we can expect to have in the field!</p>
<h2 id="how-it-works-under-the-hood">How it works, under the hood</h2>
<p>Under the hood, the devices form a wireless IPv6 mesh network. Each device has an IPv6 address, and a <span>MAC</span>-layer address. Each device also has the ability to enable a MAC layer filter, with a specific set of addresses.</p>
<p>By default, the <span>MAC</span> filter is disabled. Until we explicitly enable it.</p>
<p>When we place the devices on the map, and click the <code>Apply</code> button, the system figures out what devices are near each other. For each device, it takes the <span>MAC</span> addresses of its virtual neighbors and puts them in a variable called <code>d.feui</code>. These variables are then synchronized, so that all devices have a list of what <span>MAC</span> addresses to filter.</p>
<p>Each device will have a different number of neighbors in their filter table.</p>
<div>
<p><img data-src="filter-active.png" alt="The mesh structure of the network mirrors the map view that we have created"/>
</p>
</div>

<p>Before activating the filters for a network, it is crucial that all filter tables have been synchronized. Otherwise, we may end up in a situation that is asymmetric: device A may have device B in its table, but device B does not have device A in its table. The devices might then never be able to reach each other.</p>
<p>Once every filter is synchronized, the filters are activated simultaneously.</p>
<p>And then, the devices start to act like they are in a much larger network than they actually are.</p>
<p>
<small>
What happens if we install a the filter table configuration that causes the network to become disconnected? Or if devices in the middle of the network become unresponsive? The answer: each device has a watchdog timer that disables the filters after a few hours, if the device sees no traffic. Thus the network will eventually recover, even if we were to mess up the filters.
</small>
</p>

<h2 id="drawbacks">Drawbacks</h2>
<p>Although <span>MAC</span>-layer filtering is a standard way to emulate larger network structures, it is not without its drawbacks.</p>
<ul>
<li>Devices are still physically close to each other and their radio transmissions will, physically, interfere with each other. Even if they, virtually, don’t hear each others’ packets.</li>
<li>In the field, devices that are distant from each other will sometimes be heard and sometimes not. <span>MAC</span> layer filtering will not emulate this.</li>
</ul>
<p>So this method is not able to capture all effects that we see in the field.</p>
<p>But it allows us to do way more, in a chest drawer, than one might think we could.</p>
<h3 id="additional-credits">Additional credits</h3>
<p><small>Photo by sergio souza from Pexels</small></p>
</section>
        </div></div>
  </body>
</html>
