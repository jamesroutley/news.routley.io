<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://benjaminwuethrich.dev/2022-03-03-infinite-history.html">Original</a>
    <h1>The perfect Bash history setup: infinite history</h1>
    
    <div id="readability-page-1" class="page">


<p>This is the first in a series of posts about Bash history
configuration.</p>
<p>Bash can keep a history of the commands you’ve issued and make them
available via multiple methods, including <a href="https://www.gnu.org/software/bash/manual/bash.html#Commands-For-History">Readline
history commands</a> and <a href="https://www.gnu.org/software/bash/manual/bash.html#History-Interaction">history
expansion</a>.</p>
<p>An example of a Readline history command is <a href="https://www.gnu.org/software/bash/manual/bash.html#index-reverse_002dsearch_002dhistory-_0028C_002dr_0029"><code>reverse-search-history</code></a>,
which is usually bound to <code>C-r</code>
(<kbd>Ctrl</kbd>+<kbd>R</kbd>), and incrementally searches the history
backwards.</p>
<p>An example for history expansion is <code>!!</code>, an <a href="https://www.gnu.org/software/bash/manual/bash.html#Event-Designators">event
designator</a> for the previous command.</p>
<p>Having your history around is very useful, but the default settings
leave a few things on the table:</p>
<ul>
<li>History entries seem to disappear</li>
<li>History contains duplicates and useless junk like <code>ls</code>,
which you’re not very likely ever to feel like retrieving</li>
<li>Multi-line entries are folded into a single line, or split into
multiple separate entries, or even seem to change how they’re
stored</li>
<li>Parallel shell sessions overwrite each other’s history</li>
</ul>
<p>In these posts, I explain my Bash history setup, which addresses all
of these points. “Perfect” is of course in jest—I don’t think I’ve seen
many topics where people are as opinionated as when it comes to
customizing a command-line setup. So, “perfect for me”, probably.</p>
<p>Note that I’m <em>not</em> going to talk about settings that change
the behaviour of history expansion, but only how history is stored.</p>

<p>Bash can be compiled without history support
(<code>--enable-history</code> option for <code>configure</code>), but
it’s enabled by default unless not supported by the operating
system.</p>
<p>Given history support, interactive shells have history turned on by
default, but this can also be controlled using the <code>history</code>
shell option:</p>

<p>to enable, and</p>

<p>to disable. If enabled, the <a href="https://www.gnu.org/software/bash/manual/bash.html#index-SHELLOPTS"><code>SHELLOPTS</code></a>
variable contains <code>history</code>, and the status is also reported
by <code>set -o</code>.</p>

<p>The first nice-to-have is history that goes back all the way.</p>
<p>To understand how this works, we have to know a bit about how Bash
stores history. Command history is stored in multiple places: each
session has an in-memory history, which is initialized from a history
file; when the session is finished, the in-memory history is written
back to the history file.</p>
<p>Configuring this in a way so multiple parallel sessions don’t wipe
out each other’s histories will be subject of a separate post; for now,
we’re just thinking about a single session.</p>
<p>The history file by default lives at <code>~/.bash_history</code>; to
put it elsewhere, set the <a href="https://www.gnu.org/software/bash/manual/bash.html#index-HISTFILE"><code>HISTFILE</code></a>
variable. I like my home directory uncluttered, and I try to follow the
<a href="https://specifications.freedesktop.org/basedir-spec/basedir-spec-latest.html">XDG
Base Directory Specification</a>, so I have this in my
<code>.bashrc</code>:</p>
<div id="cb3"><pre><code><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span>HISTFILE</span><span>=</span><span>&#34;</span><span>$HOME</span><span>/.local/share/bash/history&#34;</span></span></code></pre></div>
<p>where <code>~/.local/share</code> is the default value of
<code>$XDG_DATA_HOME</code>.</p>
<p>When the session history gets written to the history file, the file
is either overwritten, or the history is appended. This is controlled
with the <a href="https://www.gnu.org/software/bash/manual/bash.html#The-Shopt-Builtin"><code>histappend</code>
shell option</a>:</p>

<p>to append, and</p>

<p>to overwrite the history file.</p>
<p>Since we only care about an individual shell session so far, we don’t
need to append; we can overwrite the history file at the end of each
session without losing anything.</p>
<p>The size of the history is controlled with the <a href="https://www.gnu.org/software/bash/manual/bash.html#index-HISTSIZE"><code>HISTSIZE</code></a>
variable (defaults to 500), and the size of the history file with <a href="https://www.gnu.org/software/bash/manual/bash.html#index-HISTFILESIZE"><code>HISTFILESIZE</code></a>.
Common advice is to just set these to large numbers; however, since Bash
4.3, they can be set to a negative value for unlimited history. (Watch
out, setting to 0 disables history and truncates the history file,
respectively!)</p>
<p>So, for an infinite history (and so far ignoring implications of
parallel shell session), we’d want something like this in our
<code>.bashrc</code>:</p>
<div id="cb6"><pre><code><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span># No clutter in the home directory</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span>HISTFILE</span><span>=</span><span>&#34;</span><span>$HOME</span><span>/.local/share/bash/history&#34;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span># Overwrite when storing</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span>shopt</span> <span>-u</span> histappend</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span># Infinite session history</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span>HISTSIZE</span><span>=</span>-1</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span># Infinite history file</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span>HISTFILESIZE</span><span>=</span>-1</span></code></pre></div>
<p>In the next post, we’ll look at controlling what exactly goes into
the history.</p>



</div>
  </body>
</html>
