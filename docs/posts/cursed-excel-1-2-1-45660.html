<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.quadratichq.com/blog/cursed-excel-datetime-math">Original</a>
    <h1>Cursed Excel: &#34;1/2&#34;&#43;1=45660</h1>
    
    <div id="readability-page-1" class="page"><div><div id="post-content-wrapper"><p>Quadratic aspires to be the best AI spreadsheet for data analysis, which implies two conflicting goals:</p><ol><li>Maintain feature parity with Microsoft Excel</li><li>Be good</li></ol><p>I mean no offense to the authors of Excel; it is fantastic software that we at Quadratic very often hail as the gold standard of spreadsheet interaction. That said, it’s reaching the ripe old age of 40 this year and its semantics seriously suffer from a decades-long accumulation of backwards-compatible cludges.</p><p>One of my favorite things about working here is that I get to reverse-engineer Excel, find strange quirks in its behavior, and decide what to do about them in Quadratic. I suffer every day so that our users may live blissfully unaware of the undocumented sins committed by Microsoft in the name of compatibility. Today you will gain a glimpse into the horrors I contend with, and then you too will live in fear of Microsoft Excel — not because you lack knowledge, but because you know too much.</p><p>For many years, geneticists have <a href="https://en.wikipedia.org/wiki/Microsoft_Excel#Conversion_problems">struggled with Excel’s overeager date parsing</a> applying to names like <code>MARCH1</code> or <code>SEPT2</code> that aren’t meant to be dates. But Excel’s date parser has much weirder edge cases.</p><p>If we type =<code>&#34;1/2&#34;</code> into a cell, then of course it contains the text “1/2”.</p><p><img alt="The formula bar contains =&#34;1/2&#34; and the selected cell contains 1/2." loading="lazy" src="https://cdn.sanity.io/images/b24dbxy9/production/e8c07bd5d48514cfc4064f0ebc38da2cb91a809d-278x142.png?w=700&amp;fit=max&amp;auto=format" srcset="https://cdn.sanity.io/images/b24dbxy9/production/e8c07bd5d48514cfc4064f0ebc38da2cb91a809d-278x142.png?w=700&amp;fit=max&amp;auto=format&amp;dpr=2 2x"/></p><p>What if we add 1 to that?</p><p><img alt="C1 contains 1/2. D1 is selected. The formula bar contains =C1+1 and the cell contains 45660." loading="lazy" src="https://cdn.sanity.io/images/b24dbxy9/production/389d183d5363a20568a5bf1bc188e10ff136fdfd-278x142.png?w=700&amp;fit=max&amp;auto=format" srcset="https://cdn.sanity.io/images/b24dbxy9/production/389d183d5363a20568a5bf1bc188e10ff136fdfd-278x142.png?w=700&amp;fit=max&amp;auto=format&amp;dpr=2 2x"/></p><p>45660? <em>What??</em> Here’s a hint: if you try this in the future, you may get a different number.</p><p>And it’s not just dates! Sometimes Excel’s time parser bites off a little more than it can chew. Of course typing <code>10:25</code> into a cell results in the time 10:25 a.m., but what happens if we type <code>10:75</code>?</p><p><img alt="10:75 is typed into a cell, and it turns into 0.46875." loading="lazy" src="https://cdn.sanity.io/images/b24dbxy9/production/a9d044d1b4da0b3dced671ab2aa0160e354413e6-278x142.gif?w=700&amp;fit=max&amp;auto=format" srcset="https://cdn.sanity.io/images/b24dbxy9/production/a9d044d1b4da0b3dced671ab2aa0160e354413e6-278x142.gif?w=700&amp;fit=max&amp;auto=format&amp;dpr=2 2x"/></p><p>0.46875?? Where the heck did that come from?</p><p>I promise that I will explain what’s going on here, but first we need to cover some technical documentation and some Catholic Church history.</p><p>In both of these scenarios, we’re tricking Excel into parsing our input as a date or time, but displaying it as a number. As the <a href="https://support.microsoft.com/en-us/office/datevalue-function-04218f74-795c-4330-9191-e7ccbe0424a8">official documentation for the DATEVALUE() function</a> explains:</p><blockquote>Microsoft Excel stores dates as sequential serial numbers so they can be used in calculations. By default, December 31, 1899 is serial number 1, and January 1, 2008 is serial number <code>39448</code> because it is 39,448 days after January 1, 1900.</blockquote><p>This is helpful but contains two inaccuracies. The first is that serial number <code>1</code> represents January 1, 1900, not December 31, 1899. In fact, Excel will never display a date before 1900 and instead insists that serial number <code>0</code> represents <em>January 0, 1900</em>.</p><p><img alt="The formula bar contains 1/0/1900 and the selected cell contains Saturday, January 0, 1900." loading="lazy" src="https://cdn.sanity.io/images/b24dbxy9/production/3159728dd056919817df36db1122fd36e1169728-280x142.png?w=700&amp;fit=max&amp;auto=format" srcset="https://cdn.sanity.io/images/b24dbxy9/production/3159728dd056919817df36db1122fd36e1169728-280x142.png?w=700&amp;fit=max&amp;auto=format&amp;dpr=2 2x"/></p><p>Thankfully, the mistake about serial number 1 is corrected elsewhere in <a href="https://support.microsoft.com/en-us/office/month-function-579a2881-199b-48b2-ab90-ddba0eba86e8">the documentation for MONTH()</a> and many other functions, but there is another inaccuracy that is still present, and it is much more insidious.</p><p><img alt="A website says that there are 39446 days between 01-Jan-1900 and 01-Jan-2008." loading="lazy" src="https://cdn.sanity.io/images/b24dbxy9/production/2df8f06fd7c5aa4c7558d2dcefe64c24837861cc-1158x604.png?w=700&amp;fit=max&amp;auto=format" srcset="https://cdn.sanity.io/images/b24dbxy9/production/2df8f06fd7c5aa4c7558d2dcefe64c24837861cc-1158x604.png?w=700&amp;fit=max&amp;auto=format&amp;dpr=2 2x"/></p><p>There are actually only 39,44<strong>6</strong> days between January 1, 1900 and January 1, 2008, not 39,44<strong>8</strong>. I can understand an off-by-one error, but why is Excel off by 2?</p><p>Imagine I’m assigning a number to each day of the week. Monday is 1, Tuesday is 2, …, and Friday is 5. But you wouldn’t say that Friday is 5 days after Monday. It’s only 4 days after, and you can calculate that by subtracting Monday’s number from Friday’s number: 5 - 1 = 4. The same thing is happening here: to get the number of days between January 1, 1900 and January 1, 2008, we should really subtract the 1900 number from the 2008 number: 39448 - 1 = 3944<strong>7</strong>. This is closer, but still off by one. To understand the remaining off-by-one error, we need to grab our time machine and travel almost 450 years into the past.</p><p>In October 1582, Pope Gregory XIII <a href="https://en.wikipedia.org/wiki/Pope_Gregory_XIII#The_Gregorian_calendar">officially decreed</a> that the Catholic Church would use the new calendar system developed by <a href="https://en.wikipedia.org/wiki/Aloysius_Lilius">Aloysius Lilius</a> (then deceased) and <a href="https://en.wikipedia.org/wiki/Christopher_Clavius">Christopher Clavius</a>. The <a href="https://en.wikipedia.org/wiki/Julian_calendar">Julian calendar</a>, which had a leap year every 4 years, had been in use for more than 1600 years but had caused so much drift that Easter had fallen out of alignment with the Spring equinox. The newly christened <a href="https://en.wikipedia.org/wiki/Gregorian_calendar">Gregorian calendar</a> corrected the drift by adding a new rule: every year divisible by 100 is <em>not</em> a leap year, except years divisible by 400 which <em>are</em> still leap years. This is why the year 2000 was a leap year (because it is divisible by 400), but 1900 was not.</p><p>In 1983, almost exactly 400 years after the new calendar was adopted, Lotus Software released <a href="https://en.wikipedia.org/wiki/Lotus_1-2-3">Lotus 1-2-3</a>, a revolutionary spreadsheet + database + charting program. Unfortunately, news of the 1582 promulgation had not yet reached the developers of Lotus 1-2-3, so they assumed that 1900 (being a multiple of 4) was a leap year. A few years later, Microsoft released the first version of Excel with the same mistaken leap year. If you enter <code>Feb 28, 1900</code> into Excel and add one, you’ll get <code>Feb 29, 1900</code> — a day that never happened, but is necessary to maintain compatibility with Lotus 1-2-3.</p><p><img alt="C1 contains 1900-02-28. D1 is selected. The formula bar contains =C1+1 and D1 contains 1900-02-29." loading="lazy" src="https://cdn.sanity.io/images/b24dbxy9/production/1a13444ae3116c3652a2df0310c64f8581b5dbc2-278x142.png?w=700&amp;fit=max&amp;auto=format" srcset="https://cdn.sanity.io/images/b24dbxy9/production/1a13444ae3116c3652a2df0310c64f8581b5dbc2-278x142.png?w=700&amp;fit=max&amp;auto=format&amp;dpr=2 2x"/></p><p>This explains the other off-by-one error in the Excel documentation; Excel is counting an extra day in February 1900, so serial numbers for dates later than that are 1 larger than you’d otherwise expect.</p><p>Back when you still had your sanity, I promised to explain why <code>&#34;1/2&#34;+1</code> equals <code>45660</code> and why Excel turned <code>10:75</code> into <code>0.46875</code>.</p><p>The first one should actually make some sense once you realize that Excel is parsing 1/2 as January 2, 2025 (the year that I’m writing this). When we add 1 we get January 3, 2025, and there were 45,6<strong>58</strong> days between that day and January 1, 1900. Add 2 for the reasons described earlier and we get 45,6<strong>60</strong>, exactly what Excel says. I don’t know why it displays a number instead of a date, but the number at least makes sense.</p><p>The second one requires a deep philosophical insight: <em>what is a time, other than a fraction of a day?</em> For example, 6:00 a.m. is 0.25 days, so Excel represents it using the number <code>0.25</code>. By this logic, <code>0.46875</code> should represent 11:15 a.m., which is 75 minutes after 10:00 a.m. so that’s sort of like 10:75 a.m. if you don’t think too hard about it. But deep down inside, Excel knows that this is very wrong so it displays it as a number instead.</p><p>We can even get times beyond 11:59 p.m. by using hours greater than 23. Typing <code>37:30</code> into a cell produces the number <code>1.5625</code>, which represents 1:30 p.m. <em>the next day</em>. The number 1 represents exactly midnight at the beginning of January 1, 1900, so <code>1.5625</code> represents 1:30 p.m. on January 1, 1900.</p><p>Google Sheets had the brilliant idea to remove February 29, 1900 by shifting the first two months of 1900 over by one, so it represents January 1, 1900 using serial number <code>2</code> instead of <code>1</code>. This is a pretty clever solution, although it’s a bit awkward to start at <code>2</code> and it causes dates before March 1, 1900 to be off-by-one when importing from Excel.</p><p>We’re building Quadratic from the ground up to work well with Python, SQL, JavaScript, and other modern programming and database tooling, so incorrect calendar systems are not an option. We use the battle-tested <a href="https://github.com/chronotope/chrono">chrono</a> library for datetimes in Rust, which plays nicely with Python’s built-in <a href="https://docs.python.org/3/library/datetime.html">datetime</a> library and similar data types in other languages. When <a href="https://docs.quadratichq.com/import-data/import-excel-files">importing files from Excel</a>, we convert any cells with date formatting into the corresponding datetime. In an effort to restore balance to the universe, February 29, 1900 is converted to February 28, 1900.</p><p>Using a <a href="https://docs.quadratichq.com/spreadsheet/date-time-formatting">proper datetime system</a> has the added bonus of letting us represent dates much farther in the past than 1900, although I’d be careful with anything before 1582. Building an <a href="https://www.quadratichq.com/blog/best-alternative-to-excel">Excel alternative</a> from scratch is challenging and takes a long time to get right, so if you have a use case we don’t support yet, let us know on our <a href="https://community.quadratichq.com/">community forums</a> or <a href="https://github.com/quadratichq/quadratic/">submit a code contribution on GitHub</a>!</p></div></div></div>
  </body>
</html>
