<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.asciinema.org/post/three-point-o/">Original</a>
    <h1>Asciinema CLI 3.0 rewritten in Rust, adds live streaming, upgrades file format</h1>
    
    <div id="readability-page-1" class="page"><article>
  
  <p>I’m happy to announce the release of asciinema CLI 3.0!</p>
<p>This is a complete rewrite of asciinema in Rust, upgrading the recording file
format, introducing terminal live streaming, and bringing numerous improvements
across the board.</p>
<p>In this post, I’ll go over the highlights of the release. For a deeper overview
of new features and improvements, see the <a href="https://github.com/asciinema/asciinema/releases/tag/v3.0.0">release
notes</a> and the
detailed
<a href="https://github.com/asciinema/asciinema/blob/develop/CHANGELOG.md">changelog</a>.</p>
<p>First, let’s get the Rust rewrite topic out of the way. I did it because I felt
like it. But seriously, I felt like it because I prefer working with Rust 100x
more than with Python these days. And this type of code, with syscalls and
concurrency, is way easier to deal with in Rust than in Python. That’s my
experience, YMMV. Anyway, in addition to making me enjoy working with this
component of asciinema again, the rewrite resulted in faster startup, easier
installation (a static binary), and made many new features possible by
integrating <a href="https://github.com/asciinema/avt">asciinema virtual terminal</a>
(also Rust) into the CLI.</p>
<p>Let’s look at what’s cool and new now.</p>
<h2 id="asciicast-v3-file-format">asciicast v3 file format</h2>
<p>The new <a href="https://docs.asciinema.org/manual/asciicast/v3/">asciicast v3</a> file
format is an evolution of the good old asciicast v2. It addresses several
shortcomings of the previous format that were discovered over the years.</p>
<p>The major change in the new format is the use of intervals (deltas) for timing
session events. v2 used absolute timestamps (measured since session start),
which had its own pros and cons. One often-brought-up issue was the difficulty
of editing the recordings - timestamps of all following events had to be
adjusted when adding/removing/updating events.</p>
<p>Other than timing, the header has been restructured, grouping related things
together, e.g. all terminal-related metadata is now under <code>term</code>. There’s also
support for the new <code>&#34;x&#34;</code> (exit) event type, for storing the session exit
status. Finally, line comments are allowed by using the <code>#</code> character as the
first character on a line.</p>
<p>Here’s an example of a short recording in asciicast v3 format:</p>
<div><pre tabindex="0"><code data-lang="json"><span><span>{<span>&#34;version&#34;</span>: <span>3</span>, <span>&#34;term&#34;</span>: {<span>&#34;cols&#34;</span>: <span>80</span>, <span>&#34;rows&#34;</span>: <span>24</span>, <span>&#34;type&#34;</span>: <span>&#34;xterm-256color&#34;</span>}, <span>&#34;timestamp&#34;</span>: <span>1504467315</span>, <span>&#34;title&#34;</span>: <span>&#34;Demo&#34;</span>, <span>&#34;env&#34;</span>: {<span>&#34;SHELL&#34;</span>: <span>&#34;/bin/zsh&#34;</span>}}
</span></span><span><span># event stream follows the header
</span></span><span><span>[<span>0.248848</span>, <span>&#34;o&#34;</span>, <span>&#34;Hey Dougal...\n&#34;</span>]
</span></span><span><span>[<span>0.248848</span>, <span>&#34;o&#34;</span>, <span>&#34;Yes Ted?\n&#34;</span>]
</span></span><span><span>[<span>1.001376</span>, <span>&#34;o&#34;</span>, <span>&#34;Is there anything on your mind?\n&#34;</span>]
</span></span><span><span>[<span>3.500000</span>, <span>&#34;m&#34;</span>, <span>&#34;&#34;</span>]
</span></span><span><span>[<span>0.143733</span>, <span>&#34;o&#34;</span>, <span>&#34;No.&#34;</span>]
</span></span><span><span># terminal window resized to <span>90</span> cols and <span>30</span> rows
</span></span><span><span>[<span>2.050000</span>, <span>&#34;r&#34;</span>, <span>&#34;90x30&#34;</span>]
</span></span><span><span>[<span>1.541828</span>, <span>&#34;o&#34;</span>, <span>&#34;Bye!&#34;</span>]
</span></span><span><span>[<span>0.8870</span>, <span>&#34;x&#34;</span>, <span>&#34;0&#34;</span>]
</span></span></code></pre></div><p>The new format is already supported by <a href="https://docs.asciinema.org/manual/server/">asciinema
server</a> and <a href="https://docs.asciinema.org/manual/player/">asciinema
player</a>.</p>
<h2 id="live-terminal-streaming">Live terminal streaming</h2>
<p>The new CLI allows for live streaming of terminal sessions, and provides two
modes for doing so.</p>
<p>Local mode uses built-in HTTP server, allowing people to view the stream on
trusted networks (e.g. a LAN). In this mode no data is sent anywhere, except to
the viewers’ browsers, which may require opening a firewall port. The CLI
bundles the latest version of asciinema player, and uses it to connect to the
stream from the page served by the built-in server.</p>
<pre tabindex="0"><code>$ asciinema stream --local
::: asciinema session started
::: Live streaming at http://127.0.0.1:37881
::: Press &lt;ctrl+d&gt; or type &#39;exit&#39; to end
$ _
</code></pre><p>Remote mode publishes the stream through an asciinema server (either
asciinema.org or a self-hosted one), which acts as a relay, delivering the
stream to the viewers at a shareable URL.</p>
<pre tabindex="0"><code>$ asciinema stream --remote
::: asciinema session started
::: Live streaming at https://asciinema.org/s/TQGS82DwiBS1bYAY
::: Press &lt;ctrl+d&gt; or type &#39;exit&#39; to end
$ _
</code></pre><p>The two modes can be used together as well.</p>
<p>Here’s a live stream of <code>btop</code> running on one of the asciinema.org servers:</p>

<p>You can also watch it directly on asciinema.org at
<a href="https://asciinema.org/s/olesiD03BIFH6Yz1">asciinema.org/s/olesiD03BIFH6Yz1</a>.</p>
<p>Read more about the streaming architecture and supported protocols
<a href="https://docs.asciinema.org/manual/server/streaming/">here</a>.</p>
<p>asciinema player (seen above) supports all the described protocols. To make the
viewing experience smooth and glitch-free, it implements an adaptive buffering
mechanism. It measures network latency in real-time and adjusts the buffer size
constantly, aiming for a good balance between low latency and buffer-underrun
protection.</p>
<p>asciinema server can now record every live stream and turn it into a regular
recording. At the moment, asciinema server running at asciinema.org has stream
recording disabled and a concurrent live stream limit of 1, but you can
self-host the server where recording is enabled and there’s no concurrent
stream limit by default. The limits on asciinema.org may change. I’d like to
first see how the streaming feature affects resource usage (btw, shout-out to
<a href="https://www.brightbox.com/">Brightbox</a>, which provides cloud services for
asciinema.org).</p>
<h2 id="local-first">Local-first</h2>
<p>In the early versions of asciinema, <code>asciinema rec</code> didn’t support saving to a
file - the recording was saved to a tmp file, uploaded to asciinema.org, and
the tmp file was removed. Later on, the CLI got the ability to specify a
filename, which allowed you to save the result of a recording session to a file
in asciicast v1 format and decide whether you want to keep it local only or
publish.</p>
<p>Although optional, the filename argument had long been available. However,
many, many tutorials on the internet (probably including asciinema’s own docs)
showed examples of recording and publishing in one go with <code>asciinema rec</code>.
That was fine - many people loved this short path from recording to sharing.</p>
<p>Over the years, I started seeing two problems with this. The first one is that
lots of people still think you must upload to asciinema.org, which is not true.
You can save locally and nothing leaves your machine. The second one is that
the optionality of the filename made it possible to unintentionally publish a
recording, and potentially leak sensitive data. And it’s a completely valid
concern!</p>
<p>Because of that, on several occasions I’ve seen negative comments saying
“asciinema is shady” /m\. It was never shady. It’s just a historical thing. I
just kept the original behavior for backward compatibility. asciinema.org is
not a commercial product - it’s <em>an</em> instance of asciinema server, which is
meant to give users an easy way to share, and to give a taste of what you get
when you self-host the server. In fact, I encourage everyone to self-host it,
as the recordings uploaded to asciinema.org are a liability for me (while being
a good promotion of the project :)).</p>
<p>I hope this clears up any confusion and suspicion.</p>
<p>Anyway, many things have changed since the original behavior of <code>asciinema rec</code> was implemented, including my approach to sharing my data with cloud
services. These days I self-host lots of services on a server at home, and I
try to avoid cloud services if I can (I’m pragmatic about it though).</p>
<p>The streaming feature was built from the ground up to support the local mode,
which came first, and the remote mode followed.</p>
<p>In asciinema CLI 2.4, released 2 years ago, I made the <code>upload</code> command show a
prompt where you have to explicitly make a decision on what to do with the
recording. It looked like this:</p>
<pre tabindex="0"><code>$ asciinema rec
asciinema: recording asciicast to /tmp/tmpo8_612f8-ascii.cast
asciinema: press &lt;ctrl-d&gt; or type &#34;exit&#34; when you&#39;re done
$ echo hello
hello
$ exit 
asciinema: recording finished
(s)ave locally, (u)pload to asciinema.org, (d)iscard
[s,u,d]? _
</code></pre><p>It was a stopgap and a way to prepare users for further changes that are coming
now.</p>
<p>In 3.0, the filename is always required, and the <code>rec</code> command no longer has
upload capability. To publish a recording to asciinema.org or a self-hosted
asciinema server, use the explicit <code>asciinema upload &lt;filename&gt;</code>.</p>
<h2 id="more-self-hosting-friendly">More self-hosting-friendly</h2>
<p>A related improvement introduced in this release is the new server URL prompt.</p>
<p>When using a command that integrates with asciinema server (<code>upload</code>, <code>stream</code>,
<code>auth</code>) for the first time, a prompt is shown, pre-filled with
<a href="https://asciinema.org">https://asciinema.org</a> (for convenience). This lets you choose an asciinema
server instance explicitly and intentionally. The choice is saved for future
invocations.</p>
<p>It was always possible to <a href="https://docs.asciinema.org/manual/cli/configuration/">point the CLI to another asciinema
server</a> with a config
file or environment variable, but this new prompt should come in handy
especially when running the CLI in a non-workstation/non-laptop yet interactive
environment, such as a fresh VM or a dev container.</p>
<p>This change should make it easier to use the CLI with your own asciinema
server, and at the same time it doubles as an additional guard preventing
unintended data leaks (to asciinema.org).</p>
<h2 id="summary">Summary</h2>
<p>I’m really excited about this release. It’s been in the making for a while, but
it’s out now, and I’m looking forward to seeing what new use-cases and
workflows people will discover with it.</p>
<p>It’s going to take a moment until 3.0 shows up in package repositories for all
supported platforms/distros. Meanwhile, you can download prebuilt binaries for
GNU/Linux and macOS from the <a href="https://github.com/asciinema/asciinema/releases/tag/v3.0.0">GitHub
release</a>, or <a href="https://github.com/asciinema/asciinema#building">build
it from source</a>.</p>
<p>Thanks for reading to this point!</p>


</article><p>
  Did you like it? Feel free to send me an email with your feedback to

  . You can also reach me on Mastodon at <a href="https://hachyderm.io/@ku1ik">@ku1ik@hachyderm.io</a>.

  Thanks!
</p></div>
  </body>
</html>
