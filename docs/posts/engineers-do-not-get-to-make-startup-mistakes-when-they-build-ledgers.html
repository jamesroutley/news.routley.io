<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://news.alvaroduran.com/p/engineers-do-not-get-to-make-startup">Original</a>
    <h1>Engineers do not get to make startup mistakes when they build ledgers</h1>
    
    <div id="readability-page-1" class="page"><div><div dir="auto"><p>Not losing track of money is the bare minimum for fintech companies.</p><p>And yet, I used to work for a startup that, on every transaction, simply lost track of a couple of cents. As if they fell from our pockets every time we pulled out our wallets.</p><p>At this startup, a stock trading platform, the engineering team had followed the mantra of ‚Äúmake it work, make it right, make it fast‚Äù; we refused to build a double-entry accounting system.</p><p>If you‚Äôve never worked at a startup, you might be shocked. But it‚Äôs perfectly normal. Engineers at startups have to buy time from wherever they can, to make room for the key design decisions.</p><p>It‚Äôs just that‚Ä¶it goes without saying that fintech companies should know better.</p><p>We could‚Äôve taken the time to build it right. We could‚Äôve done things better. But we didn‚Äôt.</p><p>Soon after we launched, we started noticing those few cents. Our vendor acknowledged one amount, and we acknowledged an amount that was almost exact. Just a few cents away.</p><p><span>We were full of excuses: numbers were almost right. They were only a few cents here and there. We called them </span><strong>dancing cents</strong><span>.</span></p><p>Stories like this don‚Äôt get aired very often because they‚Äôre embarrassing. But I believe it happens all the time.</p><p>The problem wasn‚Äôt the few cents. Startups are willing to burn way more than that if they can grow exponentially.</p><p>The problem was that users were furious. When they bought $5 of Apple stock, and saw an order for $4.98, they instantly hit our customer support chat.</p><p>Hell I am pissed off when I get charged a custodial fee on my brokerage account, and that‚Äôs a standard fee. Imagine if you got charged for no apparent reason!</p><p>Furious users weren‚Äôt recommending us. Our startup wasn‚Äôt growing as a result.</p><p>So what did we do? We bit the bullet. Our CEO ordered customer support to manually compensate those cents when a wrong transaction happened.</p><p>We even built a Slack bot.</p><p>On desperately trying to fix the dancing cents, I learned a lot. It was an intense course on accounting and engineering, at the highest stakes possible.</p><p>And in this week‚Äôs article, I‚Äôll tell you all the lessons I took away from it.</p><p><span>I‚Äôm</span><a href="https://www.linkedin.com/in/alvaroduranbarata/" rel=""> Alvaro Duran</a><span>, and this is </span><em>The Payments Engineer Playbook</em><span>. Scroll for while on Youtube and you‚Äôll find tons of tutorials that show you how to pass software design interviews that use payment systems. But there‚Äôs not much that teaches you how to build this critical software for real users and real money.</span></p><p>The reason I know this is because I‚Äôve built and maintained payment systems for almost ten years. I‚Äôve been able to see all types of interesting conversations about what works and what doesn&#39;t behind closed doors.</p><p>And I thought, ‚Äúyou know what? It‚Äôs time we have these conversations in public‚Äù.</p><p><span>In </span><em>The Payments Engineer Playbook</em><span>, we investigate the technology that transfers money. All to help you become a smarter, more skillful and more successful payments engineer. And we do that by cutting off one sliver of it and extract tactics from it.</span></p><p>Today‚Äôs post is about how to design a ledger.</p><p><strong>Ledgers are systems that track down money</strong><span>. But money is a pain in the ass to track down. Why? Sam Denby from Wendover Productions put it very eloquently: </span><a href="https://www.youtube.com/watch?v=8xzINLykprA" rel="">money is created when it moves</a><span>.</span></p><p>Most people don‚Äôt think too much about it. It‚Äôs one of those things that just works. But money is just a way to keep the score. Without an accounting system, that score is meaningless.</p><p><span>Cash is only needed when you need to keep track of value you expect to get or to give </span><em>in the future</em><span>. </span><strong>Money, conceptually, is assets in the future</strong><span>.</span></p><p>If you knew nothing about accounting, you‚Äôd probably start tracking down what you sell to your customers. This is what we did at the startup: this user paid $5, that user paid 6$, and so on. We naively thought that we only needed to monitor the money coming in, and going out.</p><p>What a huge mistake.</p><p><span>I bet that you‚Äôve already noticed that bank transfers aren‚Äôt immediate. They‚Äôre pretty slow, by Internet standards. Most banks clear transfers </span><em>on the next business day</em><span>. Payments online are fast, but transfers aren‚Äôt.</span></p><p><span>This became a headache for us. See, once a payment went through, we were certain that we were going to get some money </span><em>someday</em><span>. And we had to use that future money to buy shares on the stock market </span><em>now</em><span>.</span></p><p>The way we were tracking money didn‚Äôt account for that. We had to have some pending amount somewhere that would clear a few days later, and another amount had to go out immediately to our broker to buy some shares.</p><p>Rolling everything back when something went wrong was very difficult. In some corner cases, we didn‚Äôt even try.</p><p><span>Single-entry systems make normal use cases very complex. That‚Äôs because </span><strong>money is the natural consequence of designing a double-entry system</strong><span>, and not the other way around.¬†</span></p><p><span>Think about it: It is impossible to decouple the need to record </span><em>the promise of future assets</em><span> from the amount that is owed to the owner of those assets.</span></p><blockquote><p>Not only is it money that makes debt possible: money and debt appear on the scene at exactly the same time. Some of the very first written documents that have come down to us are Mesopotamian tablets recording credits and debits, rations issued by temples, money owed for rent of temple lands, the value of each precisely specified in grain and silver. Some of the earliest works of moral philosophy, in turn, are reflections on what it means to imagine morality as debt-that is, in terms of money.</p><p><span>‚Äî David Graeber, </span><a href="https://en.wikipedia.org/wiki/Debt:_The_First_5,000_Years" rel="">Debt: The First 5000 Years</a></p></blockquote><p>A double-entry system is an accounting method that tracks money at both its source and destination.</p><p><span>There‚Äôs been many accounting for developers guides published already (like </span><a href="https://beancount.github.io/docs/the_double_entry_counting_method.html#double-entry-bookkeeping" rel="">Beancount</a><span>‚Äôs, </span><a href="https://martin.kleppmann.com/2011/03/07/accounting-for-computer-scientists.html" rel="">Martin Kleppmans</a><span>‚Äôs and </span><a href="https://www.moderntreasury.com/journal/accounting-for-developers-part-i" rel="">Modern Treasury</a><span>‚Äôs). In this article, I‚Äôll get you up to speed, so that you can read those references later with much more context. I‚Äôve included them at the end.</span></p><p>But before I start, I want to highlight the importance of context when building ledgers.</p><p><span>In </span><a href="https://news.alvaroduran.com/p/the-most-important-book-in-payments" rel="">The Most Important Book In Payments Is a Data Systems Book</a><span>, I challenged the generalists: Those who believe that they are ready to tackle any kind of engineering problem, particularly money software, with generic engineering practices.</span></p><p>Ledgers fly in the face of the generalists. Building a ledger correctly is:</p><ul><li><p>Straightforward in the beginning</p></li><li><p>A business enabler down the line</p></li><li><p>Impossibly difficult to retroactively ‚Äúmake them right‚Äù</p></li></ul><p><span>Single-entry ledgers, like the one we rushed to build at my startup, can provide information about the flow of funds, but not </span><em>why</em><span> those flows happened.</span></p><p>If we wanted to know why a particular movement of money happened, we had to stitch together data from different models. Sometimes, it wasn‚Äôt even possible.</p><p><span>Single-entry ledgers are </span><strong>undebuggable</strong><span>:</span></p><blockquote><p>I think [there] is a very kind of important difference [between] the way we view debugging versus the way it‚Äôs been viewed traditionally. Debugging is not merely the act of making bugs go away. It is the act of understanding, gaining knowledge, new knowledge about the way the system works.</p><p><span>‚Äî Bryan Cantrill, </span><a href="https://www.youtube.com/watch?v=30jNsCVLpAE" rel="">Debugging Under Fire: Keep your Head when Systems have Lost their Mind</a></p></blockquote><p><span>On the other hand, double-entry ledgers give you the </span><em>what</em><span> and the </span><em>why</em><span>. Adding an extra bit of complexity, grounded in thousands of years of use, you can see money flowing from the point of view of any account. Single-entry ledgers journals; double-entry ledgers are complete maps.</span></p><p><span>That‚Äôs why dancing cents were impossible to fix in our single-entry system. Once gone, we didn‚Äôt know where they were anymore. It could‚Äôve been the foreign exchange, or the broker‚Äôs </span><a href="https://en.wikipedia.org/wiki/Rounding#Rounding_half_to_even" rel="">rounding to even mechanism</a><span>, or the </span><a href="https://www.finra.org/rules-guidance/guidance/trading-activity-fee" rel="">FINRA TAF fees</a><span> that were collected at the end of the day.</span></p><p>We couldn‚Äôt understand the way the system works. And so, we couldn‚Äôt make bugs go away.</p><p>Had we had a double-entry accounting system, each and every cent would‚Äôve been accounted for. That‚Äôs because, under a double-entry system, money always moves from one account to another.¬†</p><p>That‚Äôs what context gives you: the ability to gain knowledge.</p><p>And with that said, let‚Äôs discuss the data model of a double-entry ledger.</p><h2>The data structure of money<div><div></div></div></h2><p><span>The very first thing that many engineers do when they want to track money is to do that within their domain models. I call that the </span><em>balance as property</em><span> approach: when the Order has a price attribute, or when the expenses table has an amount column, you‚Äôre doing exactly that.</span></p><p>Like many bad designs, this approach works best when you‚Äôre starting out. It lets you go fast. But, over time, reporting becomes more sophisticated and slow, and payment processing and analysis becomes more difficult.</p><p>If your overnight report job takes multiple hours to run, using the balance as property approach is probably the underlying cause.</p><p><span>If you‚Äôre about to build a ledger from scratch, I suggest you treat it as a completely separate data model from which you can derive </span><em>any financial transaction in your system</em><span>.</span></p><p><span>Getting the data model right is crucial in finance. It‚Äôs one of the reasons there are </span><a href="https://materializedview.io/p/databases-are-commodities-now-what" rel="">many companies that specialize in this</a><span>.</span></p><p>Ledgers are conceptually a data model, represented by three entities: Accounts, Entries and Transactions.</p><p><span>Most people think of money in terms of </span><em>what‚Äôs theirs</em><span>, and Accounts are the representation of that point of view. They are the reason why engineers naturally gravitate towards the ‚Äúsimplicity‚Äù of single-entry systems. Accounts are both </span><em>buckets of value</em><span>, and </span><em>a particular point of view of how its value changes over time</em><span>.</span></p><p><span>Entries represent the flow of funds between Accounts. Crucially, they are always </span><em>an exchange of value</em><span>. Therefore, they </span><strong>always come in pairs</strong><span>: an Entry represents one leg of the exchange.</span></p><p>The way we ensure that Entries are paired correctly is with Transactions. Ledgers shouldn‚Äôt interact with Entries directly, but through the Transaction entity.</p><p><span>Not every ledger has Transactions, but I think they‚Äôre necessary. In </span><a href="https://www.youtube.com/watch?v=aw6y4r4NAlw" rel="">Building a powerful Double Entry Accounting system</a><span>, Nubank‚Äôs Lucas Cavalcanti says that they‚Äôve designed Entries with references both to the credit and the debit accounts. That way, the balancing of accounts is enforced by design.</span></p><p>But I think that‚Äôs a mistake. Transfers can fail for many reasons, and such a design would make it very complex to represent partial failures.</p><p>Transactions are very helpful with that. The Saga pattern fits very well with this way of representing money flows in a ledger.</p><blockquote><p><strong>Sagas trade </strong><em><strong>atomicity</strong></em><strong> for</strong><em><strong> availability</strong></em><span>. Rather than having a slow transaction locking many tables, you have smaller, discrete actions. That break down the same process, while exposing intermediate checkpoints along the way. At any of those points, another transaction can come in and do their work. That makes throughput better.</span></p><p><span>‚Äî </span><a href="https://news.alvaroduran.com/p/how-to-scale-payment-systems-with" rel="">How To Scale Payment Systems With The Saga Pattern</a></p></blockquote><h2>The Two Ledger Systems<div><div></div></div></h2><p>Accounting and Engineering are the two ledger systems.</p><p>The Accounting system is how the ledger is seen from the outside, the interface. Ledgers are meant to expose its data aggregated from multiple points of views: Reporting, Financial ratios, and Business Intelligence.</p><p>The Engineering system is how the ledger sees itself, the implementation. Ledgers are meant to have checks and balances in place, and must ensure the consistency and accuracy of the data. They‚Äôre for fintech companies what CRMs are to the sales team: a system of record, the source of truth.</p><p><span>This, by the way, is the key reason why </span><strong>ledgers are so difficult to scale</strong><span>: the Accounting system pulls towards high availability and low latency, whereas the Engineering system pulls towards strong consistency and schema-on-write checks.</span></p><h2>How Entries work<div><div></div></div></h2><p>Entries can be in one of three statuses: pending, discarded and posted.</p><p><span>Entries are </span><strong>always</strong><span> created with pending status, containing information on the value exchanged, the direction (credit or debit) and the account they reference.</span></p><p>A common mistake here is to use positive and negative numbers in the amount to represent the direction. I‚Äôll tell you more about this in How Accounts work.</p><p>Entries are immutable, except for one thing: pending Entries can be discarded in order to create posted Entries.</p><p>There‚Äôs a clear alternative design here: To create reversal entries to post a previously pending one in order to maintain full immutability. But I think that Modern Treasury‚Äôs design is better.</p><blockquote><p>While valid, this approach [create a reversal Entry to undo a pending one] leads to a messy Account history. We can‚Äôt distinguish between debits that were client-initiated and debits that are generated by the ledger as reversals. Listing Entries on an Account doesn‚Äôt match our intuition for what Entries actually comprise the current balance of the Account.</p><p>Discarding solves this problem by making it easy to see the current Entries (simply exclude any Entries that have discarded_at set), while also not losing any history.</p><p><span>‚Äî Matt McNierney, </span><a href="https://www.moderntreasury.com/journal/how-to-scale-a-ledger-part-ii" rel="">How to Scale a Ledger, Part II</a></p></blockquote><p><span>In a double-entry system, the collective amount of all non-discarded Entries with type credit and the collective amount of all non-discarded Entries with type debit is the same. </span><strong>Conceptually, this means that no matter how you move money in your pockets, the amount will stay the same</strong><span>.</span></p><p>A few special accounts, those that represent the outside world (consolidated into the Profit and Loss statement) are exceptional: They can‚Äôt be balanced. How much money does the world have, anyway?</p><h2>How Transactions work<div><div></div></div></h2><p>Entries are created in pairs, and we use Transactions to make sure that everything goes how it‚Äôs supposed to go:</p><ul><li><p>A Transaction is posted only when its associated Entries are either posted or discarded (and have been replaced by the posted ones)</p></li><li><p>A Transaction that fails partially can be semantically undone with compensating Entries.</p></li></ul><p><span>Again, this approach makes a lot of sense in the context of </span><a href="https://news.alvaroduran.com/p/how-to-scale-payment-systems-with" rel="">Sagas</a><span>.</span></p><h2>How Accounts work<div><div></div></div></h2><p>From the point of view of a single account, the ledger looks as if it implemented a single-entry system. It is associated with multiple Entries in a one-to-many relationship, and the total balance should match the aggregation of all its entries‚Äô individual balances.</p><p><span>With one caveat: depending on the Accounts </span><strong>normal balance</strong><span>, the way to calculate the total is different.</span></p><p><span>Remember when I said that using negative numbers in an Entry was a mistake? This is because </span><strong>some accounts are meant to be ‚Äúnet credit‚Äù and others ‚Äúnet debit‚Äù</strong><span>. ‚ÄúMeant to be‚Äù is the key here: just because an Account is supposed to be net debit (e.g., the cash in the bank) doesn‚Äôt mean it cannot be negative (e.g., overdrawn).</span></p><p>Bundling the amount with the sign is a huge accounting no-no, because you‚Äôre left wondering if being negative or positive is the right state of affairs.</p><p><span>Instead of using negative numbers, Accounts have normal balance: normal credit balance </span><em>literally means</em><span> that they are normal when its associated entries with type credit have a total amount that outweighs its associated entries with type debit. The reverse is true for normal debit balance.</span></p><p><span>Ledgers are the clearest example of a hard computer science problem disguised as a non technical discipline. As many payments engineers know, and as the</span><a href="https://www.bloomberg.com/opinion/articles/2022-12-21/wells-fargo-is-in-trouble-again?" rel=""> news</a><span> will attest to, building ledgers are hard to get right without proper context.</span></p><p>Feel free to bookmark this article and use it as a handbook when you work with ledgers. It should give you enough to keep you going.</p><p><span>I‚Äôve drawn from many references to put this article together. My favorite ‚ÄúAccounting 101 for Engineers‚Äù is this article by Anvil called </span><a href="https://anvil.works/blog/double-entry-accounting-for-engineers" rel="">An Engineer‚Äôs Guide to Double-Entry Bookkeeping</a><span>, which includes some basic Python code to guide the conversation along. Django Hordak, the plug-and-play double accounting system Django package, has a thorough explanation on </span><a href="https://django-hordak.readthedocs.io/en/latest/accounting-for-developers.html" rel="">Double Entry Accounting For Developers</a><span>. If you want to go in depth, Modern Treasury has a fantastic 6 part series on ledgers (Here‚Äôs </span><a href="https://www.moderntreasury.com/journal/how-to-scale-a-ledger-part-i" rel="">part I</a><span>).</span></p><p><span>I mentioned earlier that there are a few high quality ‚ÄúAccounting for Developers‚Äù guides in circulation. </span><a href="https://beancount.github.io/docs/the_double_entry_counting_method.html#double-entry-bookkeeping" rel="">Beancount</a><span>‚Äôs, </span><a href="https://martin.kleppmann.com/2011/03/07/accounting-for-computer-scientists.html" rel="">Martin Kleppmans</a><span>‚Äôs and </span><a href="https://www.moderntreasury.com/journal/accounting-for-developers-part-i" rel="">Modern Treasury</a><span>‚Äôs are all worth reading, especially because they try to explain accounting from different angles. See which one resonates with you the most.</span></p><p><span>Or maybe you want the full tutorial. In which case, </span><a href="https://www.mathstat.dal.ca/~selinger/accounting/tutorial.html" rel="">Peter Selinger</a><span>‚Äôs is the best</span></p><p><span>And last, companies like </span><a href="https://www.uber.com/en-ES/blog/money-scale-strong-data/" rel="">Uber</a><span>, </span><a href="https://developer.squareup.com/blog/books-an-immutable-double-entry-accounting-database-service/" rel="">Square</a><span> and </span><a href="https://medium.com/airbnb-engineering/tracking-the-money-scaling-financial-reporting-at-airbnb-6d742b80f040" rel="">Airbnb</a><span> have published how they‚Äôve implemented double-entry ledgers in their systems. Now that you know more, feel free to check them out.</span></p><p><span>This has been </span><em>The Payments Engineer Playbook</em><span>. I‚Äôll see you next week.</span></p><div><div><p>Thanks for reading The Payments Engineer Playbook! Subscribe for free to receive new posts and support my work.</p><div data-component-name="SubscribeWidget"><div><div><form action="/api/v1/free?nojs=true" method="post" novalidate=""><div></div></form></div></div></div></div></div><p><strong>PS</strong><span>: I want to ask you a question.</span></p><p>When I decided to write a post on ledgers, I already knew there were a few good resources out there to help me. But I‚Äôve been reading and watching and reading again, and after more than 100 hours on it, I haven‚Äôt finished yet.</p><p>Granted, 100 hours is an estimation. But I would be surprised if the actual number was less than 99.</p><p><span>As you can imagine, I have enough to write a small book on </span><em>How to Build a Future-Proof Ledger</em><span> (title TBD). Such a book would make fintech startups like the one I used to work for ready to tackle much more valuable problems than keeping track of their users‚Äô money. Or maybe do it at a much bigger scale, who knows.</span></p><p>Would you buy such a book if it existed?</p><p>You‚Äôve made it this far in the article, I‚Äôm assuming the topic was interesting. The question that‚Äôs percolating in my mind is: would somebody buy a book on engineering ledgers?</p><p><span>I thoroughly enjoyed writing my first book, </span><a href="https://shop.alvaroduran.com/l/databases-of-money" rel="">The Databases of Money</a><span>, and it would be amazing if enough people express their interest in this new book. If so, I‚Äôll be writing a few more posts on the engineering aspects of a scalable ledger, a ‚Äúbuilding in public‚Äù project kind of thing.</span></p><p>Otherwise, I will drop the topic altogether. No hard feelings.</p><p>So, if having a defined engineering strategy for building a double-entry ledger is valuable to you, you can do two things.</p><p><span>The first thing is to give a like to </span><a href="https://www.linkedin.com/pulse/engineers-do-get-make-startup-mistakes-when-build-ledgers-duran-vrhvf" rel="">this article on LinkedIn</a><span>. Not only helps other people find this newsletter, it also allows people who aren‚Äôt subscribers the opportunity to express their interest in my writing. A üëç is all it takes.</span></p><p>The second thing is to tell a friend. I suggest you share this article with this convenient button below. But word of mouth works too!</p><p data-attrs="{&#34;url&#34;:&#34;https://news.alvaroduran.com/p/engineers-do-not-get-to-make-startup?utm_source=substack&amp;utm_medium=email&amp;utm_content=share&amp;action=share&#34;,&#34;text&#34;:&#34;Share&#34;,&#34;action&#34;:null,&#34;class&#34;:null}" data-component-name="ButtonCreateButton"><a href="https://news.alvaroduran.com/p/engineers-do-not-get-to-make-startup?utm_source=substack&amp;utm_medium=email&amp;utm_content=share&amp;action=share" rel=""><span>Share</span></a></p><p>And if someone you respect shared this article with you, do me a favor and subscribe. Every week I feel I‚Äôm getting better at this. That means that my best articles on how to build payment systems are probably yet to be written.</p><p><span>You can only find out if you subscribe to </span><em>The Payments Engineer Playbook</em><span>. I‚Äôll see you around.</span></p></div></div></div>
  </body>
</html>
