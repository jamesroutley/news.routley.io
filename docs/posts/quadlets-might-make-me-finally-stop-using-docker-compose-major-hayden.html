<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://major.io/p/quadlets-replace-docker-compose/">Original</a>
    <h1>Quadlets might make me finally stop using Docker-compose ‚Äì Major Hayden</h1>
    
    <div id="readability-page-1" class="page"><article><header><ol><li><a href="https://major.io/">Major Hayden</a><span>/</span></li><li><a href="https://major.io/posts/">Posts</a><span>/</span></li><li><a href="https://major.io/p/quadlets-replace-docker-compose/">Quadlets might make me finally stop using docker-compose</a><span>/</span></li></ol><div><p><time datetime="2023-09-25 00:00:00 +0000 UTC">25 September 2023</time><span>¬∑</span><span>1417 words</span><span>¬∑</span><span title="Reading time">7 mins</span><span>¬∑</span>
<span><a href="https://github.com/major/major.io/blob/main/content/posts/2023/quadlets-replace-docker-compose/index.md" rel="noopener noreferrer" target="_blank" title="Edit content"><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M490.3 40.4c21.9 21.87 21.9 57.33.0 79.2l-30 30.1-98-97.98 30.1-30.06C414.3-.2135 449.7-.2135 471.6 21.66L490.3 40.4zM172.4 241.7 339.7 74.34l98 97.96L270.3 339.6C264.2 345.8 256.7 350.4 248.4 353.2l-88.8 29.6C150.1 385.6 141.5 383.4 135 376.1 128.6 370.5 126.4 361 129.2 352.4l29.6-88.8C161.6 255.3 166.2 247.8 172.4 241.7v0zM192 63.1c17.7.0 32 15.23 32 32 0 18.6-14.3 32-32 32H96c-17.67.0-32 15.2-32 32V416c0 17.7 14.33 32 32 32H352c17.7.0 32-14.3 32-32V319.1c0-16.8 14.3-32 32-32s32 15.2 32 32V416c0 53-43 96-96 96H96c-53.02.0-96-43-96-96V159.1c0-53 42.98-96 96-96h96z"></path></svg></span></a></span></p></div></header><section><div><hr/><p>I‚Äôve <a href="https://major.io/tags/containers/">written a lot about containers</a> on this blog.
Why do I love containers so much?</p><ul><li>They start quickly</li><li>They make your workloads portable</li><li>They disconnect your application stack from the OS that runs underneath</li><li>You can send your application through CI as a single container image</li><li>You can isolate workloads on the network and limit their resource usage much like a VM</li></ul><p>However, I‚Äôm still addicted to <a href="https://docs.docker.com/compose/" target="_blank" rel="noreferrer noopener">docker-compose</a>.
Can podman‚Äôs <a href="https://www.redhat.com/sysadmin/quadlet-podman" target="_blank" rel="noreferrer noopener">quadlets</a> change that?</p><p><strong>Yes, I think they can.</strong></p><p>Podman introduced support for quadlets in version 4.4 and it‚Äôs a simpler way of letting systemd manage your containers.
There was an option in the past to have podman generate systemd unit files, but those were unwieldy and full of podman command line options inside a unit file.
These unit files weren‚Äôt easy to edit or even parse with eyeballs.</p><p>Quadlets make this easier by giving you a simple ini-style file that you can easily read and edit.
This blog post will include some quadlets later, but here‚Äôs an example one for Wordpress:</p><div><pre tabindex="0"><code data-lang="ini"><span><span><span>[Unit]</span>
</span></span><span><span><span>Description</span><span>=</span><span>Wordpress Quadlet</span>
</span></span><span><span>
</span></span><span><span><span>[Container]</span>
</span></span><span><span><span>Image</span><span>=</span><span>docker.io/library/wordpress:fpm</span>
</span></span><span><span><span>ContainerName</span><span>=</span><span>wordpress</span>
</span></span><span><span><span>AutoUpdate</span><span>=</span><span>registry</span>
</span></span><span><span><span>EnvironmentFile</span><span>=</span><span>/home/core/.config/containers/containers-environment</span>
</span></span><span><span><span>Volume</span><span>=</span><span>wordpress.volume:/var/www/html</span>
</span></span><span><span><span>Network</span><span>=</span><span>wordpress.network</span>
</span></span><span><span>
</span></span><span><span><span>[Service]</span>
</span></span><span><span><span>Restart</span><span>=</span><span>always</span>
</span></span><span><span><span>TimeoutStartSec</span><span>=</span><span>900</span>
</span></span><span><span>
</span></span><span><span><span>[Install]</span>
</span></span><span><span><span>WantedBy</span><span>=</span><span>caddy.service multi-user.target default.target</span>
</span></span></code></pre></div><p>Lots of the lines under <code>[Container]</code> should look familiar to most readers who have worked with containers before.
However, there‚Äôs something new here.</p><p>Check out the <code>AutoUpdate=registry</code> line.
This tells podman to keep your container updated on a regular basis with the upstream container registry.
I‚Äôve used <a href="https://major.io/p/podman-quadlet-watchtower/">watchtower</a> in the past for this, but it requires a privileged container and it‚Äôs yet another external dependency.</p><p>Also, at the very end, you‚Äôll see a <code>WantedBy</code> line.
This is a great place to set up container dependencies.
In this example, the container that runs <code>caddy</code> (a web server) can‚Äôt start until Wordpress is up and running.</p><p>There‚Äôs no denying that docker-compose is an awesome tool.
You specify the desired outcome, tell it to bring up containers, and it gets containers into the state you specified.
It handles volumes, networks, and complicated configuration without a lot of legwork.
The YAML files are pretty easy to read, too.</p><p>However, as with watchtower, that‚Äôs another external dependency.</p><p>My container deployments are often done at instance boot time and I don‚Äôt make too many changes afterwards.
I found myself using docker-compose for the initial deployment and then I didn‚Äôt really use it again.</p><p>Why not remove it entirely and use what‚Äôs built into CoreOS already?</p><p>Before we start, we‚Äôre going to need a few things:</p><ul><li>An easy to read <a href="https://coreos.github.io/butane/" target="_blank" rel="noreferrer noopener">butane</a> configuration which gets transformed into a tiny <a href="https://coreos.github.io/ignition/" target="_blank" rel="noreferrer noopener">ignition</a> configuration for CoreOS</li><li>Some quadlets</li><li>Extra system configuration</li><li>A cloud provider with CoreOS images <em>(using <a href="https://www.vultr.com/?ref=9544589-8H" target="_blank" rel="noreferrer noopener">VULTR</a> for this)</em></li></ul><p>I‚Äôve packed all of these items into my <a href="https://github.com/major/quadlets-wordpress" target="_blank" rel="noreferrer noopener">quadlets-wordpress</a> repository to make it easy.
Start by looking at the <a href="https://github.com/major/quadlets-wordpress/blob/main/config.butane" target="_blank" rel="noreferrer noopener">config.butane</a> file.</p><p>Let‚Äôs break it down here.
First up, we add an ssh key for the default <code>core</code> user.</p><div><pre tabindex="0"><code data-lang="yaml"><span><span><span>variant</span><span>:</span><span> </span><span>fcos</span><span>
</span></span></span><span><span><span></span><span>version</span><span>:</span><span> </span><span>1.5.0</span><span>
</span></span></span><span><span><span></span><span>passwd</span><span>:</span><span>
</span></span></span><span><span><span>  </span><span>users</span><span>:</span><span>
</span></span></span><span><span><span>    </span>- <span>name</span><span>:</span><span> </span><span>core</span><span>
</span></span></span><span><span><span>      </span><span>ssh_authorized_keys</span><span>:</span><span>
</span></span></span><span><span><span>        </span>- <span>ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDyoH6gU4lgEiSiwihyD0Rxk/o5xYIfA3stVDgOGM9N0</span><span>
</span></span></span></code></pre></div><p>Next up, we enable the <code>podman-auto-update.timer</code> so we get container updates automatically:</p><div><pre tabindex="0"><code data-lang="yaml"><span><span><span>storage</span><span>:</span><span>
</span></span></span><span><span><span>  </span><span>links</span><span>:</span><span>
</span></span></span><span><span><span>    </span>- <span>path</span><span>:</span><span> </span><span>/home/core/.config/systemd/user/timers.target.wants/podman-auto-update.timer</span><span>
</span></span></span><span><span><span>      </span><span>target</span><span>:</span><span> </span><span>/usr/lib/systemd/user/podman-auto-update.timer</span><span>
</span></span></span><span><span><span>      </span><span>user</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>name</span><span>:</span><span> </span><span>core</span><span>
</span></span></span><span><span><span>      </span><span>group</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>name</span><span>:</span><span> </span><span>core</span><span>
</span></span></span></code></pre></div><p>Next is the long <code>files</code> section:</p><div><pre tabindex="0"><code data-lang="yaml"><span><span><span>  </span><span>files</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span># Ensure the `core` user can keep processes running after they&#39;re logged out.</span><span>
</span></span></span><span><span><span>    </span>- <span>path</span><span>:</span><span> </span><span>/var/lib/systemd/linger/core</span><span>
</span></span></span><span><span><span>      </span><span>mode</span><span>:</span><span> </span><span>0644</span><span>
</span></span></span><span><span><span>    
</span></span></span><span><span><span>    </span><span># Allow caddy to listen on 80 and 443.</span><span>
</span></span></span><span><span><span>    </span><span># Allow it to ask for bigger network buffers, too.</span><span>
</span></span></span><span><span><span>    </span>- <span>path</span><span>:</span><span> </span><span>/etc/sysctl.d/90-caddy.conf</span><span>
</span></span></span><span><span><span>      </span><span>contents</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>inline</span><span>:</span><span> </span><span>|</span><span>
</span></span></span><span><span><span>          net.ipv4.ip_unprivileged_port_start = 80
</span></span></span><span><span><span>          net.core.rmem_max=2500000
</span></span></span><span><span><span>          net.core.wmem_max=2500000</span><span>          
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span># Set up an an environment file that containers can read to configure themselves.</span><span>
</span></span></span><span><span><span>    </span>- <span>path</span><span>:</span><span> </span><span>/home/core/.config/containers/containers-environment</span><span>
</span></span></span><span><span><span>      </span><span>contents</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>inline</span><span>:</span><span> </span><span>|</span><span>
</span></span></span><span><span><span>          MYSQL_DATABASE=wordpress
</span></span></span><span><span><span>          MYSQL_USER=wordpress
</span></span></span><span><span><span>          MYSQL_ROOT_PASSWORD=mariadb-needs-a-secure-password
</span></span></span><span><span><span>          MYSQL_PASSWORD=wordpress-needs-a-secure-password
</span></span></span><span><span><span>          WORDPRESS_DB_HOST=mariadb
</span></span></span><span><span><span>          WORDPRESS_DB_USER=wordpress
</span></span></span><span><span><span>          WORDPRESS_DB_PASSWORD=wordpress-needs-a-secure-password
</span></span></span><span><span><span>          WORDPRESS_DB_NAME=wordpress</span><span>          
</span></span></span><span><span><span>      </span><span>mode</span><span>:</span><span> </span><span>0644</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span># Deploy the caddy configuration file from the repository.</span><span>
</span></span></span><span><span><span>    </span>- <span>path</span><span>:</span><span> </span><span>/home/core/.config/caddy/Caddyfile</span><span>
</span></span></span><span><span><span>      </span><span>contents</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>local</span><span>:</span><span> </span><span>caddy/Caddyfile</span><span>
</span></span></span><span><span><span>      </span><span>mode</span><span>:</span><span> </span><span>0644</span><span>
</span></span></span><span><span><span>      </span><span>user</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>name</span><span>:</span><span> </span><span>core</span><span>
</span></span></span><span><span><span>      </span><span>group</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>name</span><span>:</span><span> </span><span>core</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span># Add some named volumes for caddy and wordpress.</span><span>
</span></span></span><span><span><span>    </span>- <span>path</span><span>:</span><span> </span><span>/home/core/.config/containers/systemd/caddy-config.volume</span><span>
</span></span></span><span><span><span>      </span><span>contents</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>inline</span><span>:</span><span> </span><span>|</span><span>
</span></span></span><span><span><span>          [Volume]</span><span>          
</span></span></span><span><span><span>      </span><span>user</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>name</span><span>:</span><span> </span><span>core</span><span>
</span></span></span><span><span><span>      </span><span>group</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>name</span><span>:</span><span> </span><span>core</span><span>
</span></span></span><span><span><span>    </span>- <span>path</span><span>:</span><span> </span><span>/home/core/.config/containers/systemd/caddy-data.volume</span><span>
</span></span></span><span><span><span>      </span><span>contents</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>inline</span><span>:</span><span> </span><span>|</span><span>
</span></span></span><span><span><span>          [Volume]</span><span>          
</span></span></span><span><span><span>      </span><span>user</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>name</span><span>:</span><span> </span><span>core</span><span>
</span></span></span><span><span><span>      </span><span>group</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>name</span><span>:</span><span> </span><span>core</span><span>
</span></span></span><span><span><span>    </span>- <span>path</span><span>:</span><span> </span><span>/home/core/.config/containers/systemd/wordpress.volume</span><span>
</span></span></span><span><span><span>      </span><span>contents</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>inline</span><span>:</span><span> </span><span>|</span><span>
</span></span></span><span><span><span>          [Volume]</span><span>          
</span></span></span><span><span><span>      </span><span>user</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>name</span><span>:</span><span> </span><span>core</span><span>
</span></span></span><span><span><span>      </span><span>group</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>name</span><span>:</span><span> </span><span>core</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span># Create a network for all the containers to use and enable the</span><span>
</span></span></span><span><span><span>    </span><span># DNS plugin. This allows containers to find each other using</span><span>
</span></span></span><span><span><span>    </span><span># the container names.</span><span>
</span></span></span><span><span><span>    </span>- <span>path</span><span>:</span><span> </span><span>/home/core/.config/containers/systemd/wordpress.network</span><span>
</span></span></span><span><span><span>      </span><span>contents</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>inline</span><span>:</span><span> </span><span>|</span><span>
</span></span></span><span><span><span>          [Network]
</span></span></span><span><span><span>          DisableDNS=false
</span></span></span><span><span><span>          Internal=false</span><span>          
</span></span></span><span><span><span>      </span><span>user</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>name</span><span>:</span><span> </span><span>core</span><span>
</span></span></span><span><span><span>      </span><span>group</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>name</span><span>:</span><span> </span><span>core</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span># Add the wordpress container.</span><span>
</span></span></span><span><span><span>    </span>- <span>path</span><span>:</span><span> </span><span>/home/core/.config/containers/systemd/wordpress.container</span><span>
</span></span></span><span><span><span>      </span><span>contents</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>local</span><span>:</span><span> </span><span>quadlets/wordpress.container</span><span>
</span></span></span><span><span><span>      </span><span>mode</span><span>:</span><span> </span><span>0644</span><span>
</span></span></span><span><span><span>      </span><span>user</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>name</span><span>:</span><span> </span><span>core</span><span>
</span></span></span><span><span><span>      </span><span>group</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>name</span><span>:</span><span> </span><span>core</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span># Add the MariaDB container.</span><span>
</span></span></span><span><span><span>    </span>- <span>path</span><span>:</span><span> </span><span>/home/core/.config/containers/systemd/mariadb.container</span><span>
</span></span></span><span><span><span>      </span><span>contents</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>local</span><span>:</span><span> </span><span>quadlets/mariadb.container</span><span>
</span></span></span><span><span><span>      </span><span>mode</span><span>:</span><span> </span><span>0644</span><span>
</span></span></span><span><span><span>      </span><span>user</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>name</span><span>:</span><span> </span><span>core</span><span>
</span></span></span><span><span><span>      </span><span>group</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>name</span><span>:</span><span> </span><span>core</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span># Add the caddy container.</span><span>
</span></span></span><span><span><span>    </span>- <span>path</span><span>:</span><span> </span><span>/home/core/.config/containers/systemd/caddy.container</span><span>
</span></span></span><span><span><span>      </span><span>contents</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>local</span><span>:</span><span> </span><span>quadlets/caddy.container</span><span>
</span></span></span><span><span><span>      </span><span>mode</span><span>:</span><span> </span><span>0644</span><span>
</span></span></span><span><span><span>      </span><span>user</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>name</span><span>:</span><span> </span><span>core</span><span>
</span></span></span><span><span><span>      </span><span>group</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>name</span><span>:</span><span> </span><span>core</span><span>
</span></span></span></code></pre></div><p>The <a href="https://github.com/major/quadlets-wordpress/blob/main/caddy/Caddyfile" target="_blank" rel="noreferrer noopener">Caddyfile</a> is also in the repository and will be deployed by the butane configuration shown above.</p><p>We can go through each quadlet in detail.
First up is MariaDB.
We tell systemd that the wordpress container will want to have this one started first.</p><div><pre tabindex="0"><code data-lang="ini"><span><span><span>[Unit]</span>
</span></span><span><span><span>Description</span><span>=</span><span>MariaDB Quadlet</span>
</span></span><span><span>
</span></span><span><span><span>[Container]</span>
</span></span><span><span><span>Image</span><span>=</span><span>docker.io/library/mariadb:11</span>
</span></span><span><span><span>ContainerName</span><span>=</span><span>mariadb</span>
</span></span><span><span><span>AutoUpdate</span><span>=</span><span>registry</span>
</span></span><span><span><span>EnvironmentFile</span><span>=</span><span>/home/core/.config/containers/containers-environment</span>
</span></span><span><span><span>Volume</span><span>=</span><span>mariadb.volume:/var/lib/mysql</span>
</span></span><span><span><span>Network</span><span>=</span><span>wordpress.network</span>
</span></span><span><span>
</span></span><span><span><span>[Service]</span>
</span></span><span><span><span>Restart</span><span>=</span><span>always</span>
</span></span><span><span><span>TimeoutStartSec</span><span>=</span><span>900</span>
</span></span><span><span>
</span></span><span><span><span>[Install]</span>
</span></span><span><span><span>WantedBy</span><span>=</span><span>wordpress.service multi-user.target default.target</span>
</span></span></code></pre></div><p>The wordpress quadlet is much the same as the MariaDB one, but we tell systemd that caddy will want wordpress started first.</p><div><pre tabindex="0"><code data-lang="ini"><span><span><span>[Unit]</span>
</span></span><span><span><span>Description</span><span>=</span><span>Wordpress Quadlet</span>
</span></span><span><span>
</span></span><span><span><span>[Container]</span>
</span></span><span><span><span>Image</span><span>=</span><span>docker.io/library/wordpress:fpm</span>
</span></span><span><span><span>ContainerName</span><span>=</span><span>wordpress</span>
</span></span><span><span><span>AutoUpdate</span><span>=</span><span>registry</span>
</span></span><span><span><span>EnvironmentFile</span><span>=</span><span>/home/core/.config/containers/containers-environment</span>
</span></span><span><span><span>Volume</span><span>=</span><span>wordpress.volume:/var/www/html</span>
</span></span><span><span><span>Network</span><span>=</span><span>wordpress.network</span>
</span></span><span><span>
</span></span><span><span><span>[Service]</span>
</span></span><span><span><span>Restart</span><span>=</span><span>always</span>
</span></span><span><span><span>TimeoutStartSec</span><span>=</span><span>900</span>
</span></span><span><span>
</span></span><span><span><span>[Install]</span>
</span></span><span><span><span>WantedBy</span><span>=</span><span>caddy.service multi-user.target default.target</span>
</span></span></code></pre></div><p>Finally, the caddy quadlet contains four volumes and some published ports.
These ports will be published to the container host.
Also, you‚Äôll note that the wordpress volume is mounted here, too.
This is because caddy can serve static files <em>much faster</em> than wordpress can.</p><div><pre tabindex="0"><code data-lang="ini"><span><span><span>[Unit]</span>
</span></span><span><span><span>Description</span><span>=</span><span>Caddy Quadlet</span>
</span></span><span><span>
</span></span><span><span><span>[Container]</span>
</span></span><span><span><span>Image</span><span>=</span><span>docker.io/library/caddy:latest</span>
</span></span><span><span><span>ContainerName</span><span>=</span><span>caddy</span>
</span></span><span><span><span>AutoUpdate</span><span>=</span><span>registry</span>
</span></span><span><span><span>EnvironmentFile</span><span>=</span><span>/home/core/.config/containers/containers-environment</span>
</span></span><span><span><span>Volume</span><span>=</span><span>caddy-data.volume:/data</span>
</span></span><span><span><span>Volume</span><span>=</span><span>caddy-config.volume:/config</span>
</span></span><span><span><span>Volume</span><span>=</span><span>/home/core/.config/caddy/Caddyfile:/etc/caddy/Caddyfile:Z</span>
</span></span><span><span><span>Volume</span><span>=</span><span>wordpress.volume:/var/www/html</span>
</span></span><span><span><span>PublishPort</span><span>=</span><span>80:80</span>
</span></span><span><span><span>PublishPort</span><span>=</span><span>443:443</span>
</span></span><span><span><span>Network</span><span>=</span><span>wordpress.network</span>
</span></span><span><span>
</span></span><span><span><span>[Service]</span>
</span></span><span><span><span>Restart</span><span>=</span><span>always</span>
</span></span><span><span><span>TimeoutStartSec</span><span>=</span><span>900</span>
</span></span><span><span>
</span></span><span><span><span>[Install]</span>
</span></span><span><span><span>WantedBy</span><span>=</span><span>multi-user.target default.target</span>
</span></span></code></pre></div><p>There‚Äôs a <a href="https://github.com/major/quadlets-wordpress/blob/main/launch-instance" target="_blank" rel="noreferrer noopener">launch script</a> that ships this configuration to VULTR and launches a CoreOS instance:</p><div><pre tabindex="0"><code data-lang="shell"><span><span><span>#!/bin/bash
</span></span></span><span><span><span></span><span># This command starts up a CoreOS instance on Vultr using the vultr-cli</span>
</span></span><span><span>vultr-cli instance create <span>\
</span></span></span><span><span><span></span>    --os <span>391</span> <span>\
</span></span></span><span><span><span></span>    --plan vhp-1c-1gb-amd <span>\
</span></span></span><span><span><span></span>    --region dfw <span>\
</span></span></span><span><span><span></span>    --notify <span>true</span> <span>\
</span></span></span><span><span><span></span>    --ipv6 <span>true</span> <span>\
</span></span></span><span><span><span></span>    -u <span>&#34;</span><span>$(</span>butane --files-dir . config.butane<span>)</span><span>&#34;</span> <span>\
</span></span></span><span><span><span></span>    -l <span>&#34;coreos-</span><span>$(</span>date <span>&#34;+%s&#34;</span><span>)</span><span>&#34;</span>
</span></span></code></pre></div><p>To launch an instance, get your <a href="https://my.vultr.com/settings/#settingsapi" target="_blank" rel="noreferrer noopener">VULTR API key</a> first.
Then install vultr-cli and butane:</p><div><pre tabindex="0"><code data-lang="console"><span><span><span>$</span> sudo dnf -y install butane vultr-cli
</span></span></code></pre></div><p>After launch, check to see what your containers are doing:</p><div><pre tabindex="0"><code data-lang="console"><span><span><span>[core@vultr ~]$</span> podman ps
</span></span><span><span><span>CONTAINER ID  IMAGE                            COMMAND               CREATED         STATUS         PORTS                                     NAMES
</span></span></span><span><span><span>afa2d6501593  docker.io/library/caddy:latest   caddy run --confi...  54 seconds ago  Up 53 seconds  0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp  caddy
</span></span></span><span><span><span>460426f39e6c  docker.io/library/mariadb:11     mariadbd              35 seconds ago  Up 35 seconds                                            mariadb
</span></span></span><span><span><span>92ece6538d5a  docker.io/library/wordpress:fpm  php-fpm               28 seconds ago  Up 29 seconds                                            wordpress
</span></span></span></code></pre></div><p>We should be able to talk to wordpress through caddy on port 80:</p><div><pre tabindex="0"><code data-lang="console"><span><span><span>[core@vultr ~]$</span> curl -si http://localhost/wp-admin/install.php <span>|</span> head -n <span>25</span>
</span></span><span><span><span>HTTP/1.1 200 OK
</span></span></span><span><span><span>Cache-Control: no-cache, must-revalidate, max-age=0
</span></span></span><span><span><span>Content-Type: text/html; charset=utf-8
</span></span></span><span><span><span>Expires: Wed, 11 Jan 1984 05:00:00 GMT
</span></span></span><span><span><span>Server: Caddy
</span></span></span><span><span><span>X-Powered-By: PHP/8.0.30
</span></span></span><span><span><span>Date: Mon, 25 Sep 2023 21:43:40 GMT
</span></span></span><span><span><span>Transfer-Encoding: chunked
</span></span></span><span><span><span></span><span>
</span></span></span><span><span><span></span><span>&lt;!DOCTYPE html&gt;
</span></span></span><span><span><span>&lt;html lang=&#34;en-US&#34; xml:lang=&#34;en-US&#34;&gt;
</span></span></span><span><span><span>&lt;head&gt;
</span></span></span><span><span><span>	&lt;meta name=&#34;viewport&#34; content=&#34;width=device-width&#34; /&gt;
</span></span></span><span><span><span>	&lt;meta http-equiv=&#34;Content-Type&#34; content=&#34;text/html; charset=utf-8&#34; /&gt;
</span></span></span><span><span><span>	&lt;meta name=&#34;robots&#34; content=&#34;noindex,nofollow&#34; /&gt;
</span></span></span><span><span><span>	&lt;title&gt;WordPress &amp;rsaquo; Installation&lt;/title&gt;
</span></span></span><span><span><span>	&lt;link rel=&#39;stylesheet&#39; id=&#39;dashicons-css&#39; href=&#39;http://localhost/wp-includes/css/dashicons.min.css?ver=6.3.1&#39; type=&#39;text/css&#39; media=&#39;all&#39; /&gt;
</span></span></span><span><span><span>&lt;link rel=&#39;stylesheet&#39; id=&#39;buttons-css&#39; href=&#39;http://localhost/wp-includes/css/buttons.min.css?ver=6.3.1&#39; type=&#39;text/css&#39; media=&#39;all&#39; /&gt;
</span></span></span><span><span><span>&lt;link rel=&#39;stylesheet&#39; id=&#39;forms-css&#39; href=&#39;http://localhost/wp-admin/css/forms.min.css?ver=6.3.1&#39; type=&#39;text/css&#39; media=&#39;all&#39; /&gt;
</span></span></span><span><span><span>&lt;link rel=&#39;stylesheet&#39; id=&#39;l10n-css&#39; href=&#39;http://localhost/wp-admin/css/l10n.min.css?ver=6.3.1&#39; type=&#39;text/css&#39; media=&#39;all&#39; /&gt;
</span></span></span><span><span><span>&lt;link rel=&#39;stylesheet&#39; id=&#39;install-css&#39; href=&#39;http://localhost/wp-admin/css/install.min.css?ver=6.3.1&#39; type=&#39;text/css&#39; media=&#39;all&#39; /&gt;
</span></span></span><span><span><span>&lt;/head&gt;
</span></span></span><span><span><span>&lt;body class=&#34;wp-core-ui language-chooser&#34;&gt;
</span></span></span><span><span><span>&lt;p id=&#34;logo&#34;&gt;WordPress&lt;/p&gt;
</span></span></span></code></pre></div><p>Awesome! üéâ</p><p>Containers will automatically update on a schedule and you can check the timer:</p><div><pre tabindex="0"><code data-lang="console"><span><span><span>[core@vultr ~]$</span> systemctl status --user podman-auto-update.timer
</span></span><span><span><span>‚óè podman-auto-update.timer - Podman auto-update timer
</span></span></span><span><span><span>     Loaded: loaded (/usr/lib/systemd/user/podman-auto-update.timer; enabled; preset: disabled)
</span></span></span><span><span><span>     Active: active (waiting) since Mon 2023-09-25 21:41:31 UTC; 3min 14s ago
</span></span></span><span><span><span>    Trigger: Tue 2023-09-26 00:04:46 UTC; 2h 20min left
</span></span></span><span><span><span>   Triggers: ‚óè podman-auto-update.service
</span></span></span><span><span><span></span><span>
</span></span></span><span><span><span></span><span>Sep 25 21:41:31 vultr.guest systemd[1786]: Started podman-auto-update.timer - Podman auto-update timer.
</span></span></span></code></pre></div><p>Quadlets are just regular systemd units:</p><div><pre tabindex="0"><code data-lang="console"><span><span><span>[core@vultr ~]$</span> systemctl list-units --user <span>|</span> grep -i Quadlet
</span></span><span><span><span>  caddy.service                                                                       loaded active running Caddy Quadlet
</span></span></span><span><span><span>  mariadb.service                                                                     loaded active running MariaDB Quadlet
</span></span></span><span><span><span>  wordpress.service                                                                   loaded active running Wordpress Quadlet
</span></span></span></code></pre></div><p>As an example, you can make changes to caddy‚Äôs config file and restart it easily:</p><div><pre tabindex="0"><code data-lang="console"><span><span><span>[core@vultr ~]$</span> systemctl restart --user caddy
</span></span><span><span><span>[core@vultr ~]$</span> systemctl status --user caddy
</span></span><span><span><span>‚óè caddy.service - Caddy Quadlet
</span></span></span><span><span><span>     Loaded: loaded (/var/home/core/.config/containers/systemd/caddy.container; generated)
</span></span></span><span><span><span>    Drop-In: /usr/lib/systemd/user/service.d
</span></span></span><span><span><span>             ‚îî‚îÄ10-timeout-abort.conf
</span></span></span><span><span><span>     Active: active (running) since Mon 2023-09-25 21:46:28 UTC; 5s ago
</span></span></span><span><span><span>   Main PID: 2652 (conmon)
</span></span></span><span><span><span>      Tasks: 18 (limit: 1023)
</span></span></span><span><span><span>     Memory: 15.1M
</span></span></span><span><span><span>        CPU: 207ms
</span></span></span></code></pre></div><p>If you need to change a quadlet‚Äôs configuration, just open up the configuration file in your favorite editor under <code>~/.config/containers/systemd</code>, reload systemd, and restart the container:</p><div><pre tabindex="0"><code data-lang="console"><span><span><span>$</span> vi ~/.config/containers/systemd/caddy.container
</span></span><span><span><span>
</span></span></span><span><span><span></span><span>--- make your edits and save the quadlet configuration ---
</span></span></span><span><span><span></span><span>
</span></span></span><span><span><span></span><span>$</span> systemctl daemon-reload --user
</span></span><span><span><span>$</span> systemctl restart --user caddy
</span></span></code></pre></div><p>Enjoy!</p></div></section></article></div>
  </body>
</html>
