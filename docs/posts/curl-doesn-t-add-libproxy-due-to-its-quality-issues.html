<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://daniel.haxx.se/blog/2022/08/12/the-dream-of-auto-detecting-proxies/">Original</a>
    <h1>Curl doesn&#39;t add libproxy due to its quality issues</h1>
    
    <div id="readability-page-1" class="page"><div>
		
<p>curl, along with every other Internet tool with aspirations, supports <em>proxies</em>. A proxy is a (usually known) middle-man in a network operation; instead of going directly to the remote end server, the client goes <em>via</em> a proxy.</p>



<p>curl has supported proxies since the day it was born.</p>



<h2>Which proxy?</h2>



<p>Applications that do Internet transfers often would like to automatically be able to do their transfers even when users are trapped in an environment where they use a proxy.<em> To figure out the proxy situation automatically.</em></p>



<p>Many proxy users <em>have to</em> use their proxy to do Internet transfers.</p>



<h2>A library to detect which proxy?</h2>



<p>The challenge to figure out the proxy situation is of course even bigger if your applications can run on multiple platforms. macOS, Windows and Linux have completely different ways of storing and accessing the necessary information.</p>



<h2>libproxy</h2>



<p><em><a href="https://libproxy.github.io/libproxy/">libproxy</a></em> is a well-known library used for exactly this purpose. The first feature request to add support for this into libcurl that I can find, was <a href="https://sourceforge.net/p/curl/feature-requests/31/">filed in December 2007</a> (I also <a href="https://daniel.haxx.se/blog/2007/12/20/library-for-proxy-detection/">blogged about it</a>) and it has been popping up occasionally over the years since then.</p>



<p>In August 2016, David Woodhouse <a href="https://curl.se/mail/lib-2016-07/0074.html">submitted a patch for curl</a>  that implemented support for libproxy (the PR version is <a href="https://github.com/curl/curl/pull/977">here</a>). I was skeptical then primarily because of the lack of tests and docs in libproxy (and that the project seemed totally unresponsive to bug reports). Subsequently we did not merge that pull request.</p>



<p>Almost six years later, in June 2022,  <a href="https://github.com/janbrummer">Jan Brummer</a> revived David’s previous work and submitted a fresh pull request to <a href="https://github.com/curl/curl/pull/9068">add libproxy support</a> in curl. Another try.</p>



<p>The  proxy library dream is clearly still very much alive.  There are also a fair amount of applications and systems today that are built to use libproxy to figure out the proxy and then tell curl about it.</p>



<p>What is unfortunately also still present, is the unsatisfying state of libproxy. It seems to have changed and improved somewhat since the last time I looked at it (6 years ago), but there several warning signs remaining that make me hesitate.</p>



<p><strong>This is not a dependency I want to encourage curl users to lean and depend upon.</strong></p>



<p>I greatly appreciate the idea of a libproxy but I do not like the (state of the) implementation.</p>



<h2>My responsibility</h2>



<p>Or rather, the responsibility I think we have as curl maintainers. We ship a product that is used and depended upon by an almost unfathomable amount of users, tools, products and devices.</p>



<p>Our job is to help guide our users so that the entire product, including third party dependencies, become an as safe and secure solution as possible. I am not saying that we can take full responsibility for the security of code outside of our own domain, but I think we should recognize that what we condone and recommend will be used. People read our support for library X as some level of approval.</p>



<p>We should only add support for third party libraries that meets a certain quality threshold. This threshold or <em>bar</em> maybe is (unfortunately) not written down anywhere but is still mostly a soft “gut feeling” based on human reviews of the situation.</p>



<h2>What to do</h2>



<p>I think the sensible thing to do first, <em>before</em> trying to get curl to use libproxy, is to make sure that there is a library for proxies that we can and want to lean on. That library can be the libproxy of today but it could also be something else.</p>



<p>Some areas in need of attention in libproxy that I recently also highlighted in the curl PR, that would take it closer to meeting the requirements we can ask of a dependency:</p>



<ol><li>Improve the project with docs. We cannot safely rely on a library and its APIs if we don’t know exactly what to expect.</li><li>There needs to be at least basic tests that verify its functionality. We cannot fix and improve the library safely if we cannot check that it still works and behaves as expected. Tests is the only reliable way to make sure of this.</li><li>Add CI jobs that build the project and run those tests. To help the project better verify that things don’t break along the way.</li><li>Consider improving the API. To be fair, it is <em>extremely</em> simple now, but it’s also so simple that that it becomes ineffective and quirky in some use cases.</li><li>Allow for external URL parser and URL retrieving etc to avoid blocking, double-parsing and to reuse caches properly. It would be ridiculous for curl to use a library that has its own separate (semi-broken) HTTP transfer and its own (synchronous) name resolving process.</li></ol>



<h2>A <em>solid</em> proxy library?</h2>



<p>The current libproxy is not even a lot of code, it could perhaps make more sense to just plainly write a new library based on how you would <em>want</em> a library like this to work – and use all the knowledge, magic and experience from libproxy to get the technical parts done correctly. A <em>libproxy-next-generation</em>.</p>



<p>But</p>



<p>This would require that someone <em>really</em> wanted to see this development take place and happen. It would take someone to take lead in the project and push for changes (like perhaps the 5 bullets I listed above). The best would be if someone who would like to use this kind of setup could sponsor a developer half/full time for a while to get a good head start on this.</p>



<p>Based on history, seeing we have had this known use case and this library around for well over a decade and this is the best we have accomplished so far, I am not optimistic that we can turn this ship around. Until then, we simply cannot allow curl to use this dependency.</p>
	</div></div>
  </body>
</html>
