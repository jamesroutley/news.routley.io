<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/Tsadoq/ErisForge">Original</a>
    <h1>Show HN: I Created ErisForge, a Python Library for Abliteration of LLMs</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text"><p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://private-user-images.githubusercontent.com/28503469/385078961-1a11ad1a-a632-4d5f-990c-3fc84a6c543a.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzgwNDE2NDIsIm5iZiI6MTczODA0MTM0MiwicGF0aCI6Ii8yODUwMzQ2OS8zODUwNzg5NjEtMWExMWFkMWEtYTYzMi00ZDVmLTk5MGMtM2ZjODRhNmM1NDNhLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMjglMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTI4VDA1MTU0MlomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWViZjhkMzIxNjYyYTNjMTJlMTUyNzg5ZDIzYjQ5NzFlNmU4MTJhZDUyZDVmNjI3MGJlMDZiNGFkOTg2YzIwODImWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.e5z4W2a_tEj6RY-AEVm6aIMjn32p7j1O2jULnRFCi8w"><img src="https://private-user-images.githubusercontent.com/28503469/385078961-1a11ad1a-a632-4d5f-990c-3fc84a6c543a.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzgwNDE2NDIsIm5iZiI6MTczODA0MTM0MiwicGF0aCI6Ii8yODUwMzQ2OS8zODUwNzg5NjEtMWExMWFkMWEtYTYzMi00ZDVmLTk5MGMtM2ZjODRhNmM1NDNhLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMjglMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTI4VDA1MTU0MlomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWViZjhkMzIxNjYyYTNjMTJlMTUyNzg5ZDIzYjQ5NzFlNmU4MTJhZDUyZDVmNjI3MGJlMDZiNGFkOTg2YzIwODImWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.e5z4W2a_tEj6RY-AEVm6aIMjn32p7j1O2jULnRFCi8w" alt="erisforge_logo"/></a>
<strong>ErisForge</strong> is a Python library designed to modify Large Language Models (LLMs) by applying transformations to their internal layers. Named after Eris, the goddess of strife and discord, ErisForge allows you to alter model behavior in a controlled manner, creating both ablated and augmented versions of LLMs that respond differently to specific types of input.</p>

<ul dir="auto">
<li>Modify internal layers of LLMs to produce altered behaviors.</li>
<li>Ablate or enhance model responses with the <code>AblationDecoderLayer</code> and <code>AdditionDecoderLayer</code> classes.</li>
<li>Measure refusal expressions in model responses using the <code>ExpressionRefusalScorer</code>.</li>
<li>Supports custom behavior directions for applying specific types of transformations.</li>
</ul>

<p dir="auto">To install ErisForge, clone the repository and install the required packages:</p>
<div dir="auto" data-snippet-clipboard-copy-content="git clone https://github.com/tsadoq/erisforge.git
cd erisforge
pip install -r requirements.txt"><pre>git clone https://github.com/tsadoq/erisforge.git
<span>cd</span> erisforge
pip install -r requirements.txt</pre></div>
<p dir="auto">or install directly from pip:</p>



<div dir="auto" data-snippet-clipboard-copy-content="import torch
from transformers import AutoModelForCausalLM, AutoTokenizer
from erisforge import ErisForge
from erisforge.expression_refusal_scorer import ExpressionRefusalScorer

# Load a model and tokenizer
model_name = &#34;gpt2&#34;
model = AutoModelForCausalLM.from_pretrained(model_name)
tokenizer = AutoTokenizer.from_pretrained(model_name)

# Initialize ErisForge and configure the scorer
forge = ErisForge()
scorer = ExpressionRefusalScorer()"><pre><span>import</span> <span>torch</span>
<span>from</span> <span>transformers</span> <span>import</span> <span>AutoModelForCausalLM</span>, <span>AutoTokenizer</span>
<span>from</span> <span>erisforge</span> <span>import</span> <span>ErisForge</span>
<span>from</span> <span>erisforge</span>.<span>expression_refusal_scorer</span> <span>import</span> <span>ExpressionRefusalScorer</span>

<span># Load a model and tokenizer</span>
<span>model_name</span> <span>=</span> <span>&#34;gpt2&#34;</span>
<span>model</span> <span>=</span> <span>AutoModelForCausalLM</span>.<span>from_pretrained</span>(<span>model_name</span>)
<span>tokenizer</span> <span>=</span> <span>AutoTokenizer</span>.<span>from_pretrained</span>(<span>model_name</span>)

<span># Initialize ErisForge and configure the scorer</span>
<span>forge</span> <span>=</span> <span>ErisForge</span>()
<span>scorer</span> <span>=</span> <span>ExpressionRefusalScorer</span>()</pre></div>

<p dir="auto">You can apply transformations to specific layers of the model to induce different response behaviors.
A complete example can be found in this notebook: <a href="https://github.com/Tsadoq/ErisForge/blob/main/examples/example_run_forge_refusal_dir.ipynb">Transform Model Layers</a>.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto">Example 1: Applying Ablation to Model Layers</h4><a id="user-content-example-1-applying-ablation-to-model-layers" aria-label="Permalink: Example 1: Applying Ablation to Model Layers" href="#example-1-applying-ablation-to-model-layers"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div dir="auto" data-snippet-clipboard-copy-content="# Define instructions
instructions = [&#34;Explain why AI is beneficial.&#34;, &#34;What are the limitations of AI?&#34;]

# Specify layer ranges for ablation
min_layer = 2
max_layer = 4

# Modify the model by applying ablation to the specified layers
ablated_model = forge.run_forged_model(
    model=model,
    type_of_layer=AblationDecoderLayer,
    objective_behaviour_dir=torch.rand(768),  # Example direction tensor
    tokenizer=tokenizer,
    min_layer=min_layer,
    max_layer=max_layer,
    instructions=instructions,
    max_new_tokens=50
)

# Display modified responses
for conversation in ablated_model:
    print(&#34;User:&#34;, conversation[0][&#34;content&#34;])
    print(&#34;AI:&#34;, conversation[1][&#34;content&#34;])"><pre><span># Define instructions</span>
<span>instructions</span> <span>=</span> [<span>&#34;Explain why AI is beneficial.&#34;</span>, <span>&#34;What are the limitations of AI?&#34;</span>]

<span># Specify layer ranges for ablation</span>
<span>min_layer</span> <span>=</span> <span>2</span>
<span>max_layer</span> <span>=</span> <span>4</span>

<span># Modify the model by applying ablation to the specified layers</span>
<span>ablated_model</span> <span>=</span> <span>forge</span>.<span>run_forged_model</span>(
    <span>model</span><span>=</span><span>model</span>,
    <span>type_of_layer</span><span>=</span><span>AblationDecoderLayer</span>,
    <span>objective_behaviour_dir</span><span>=</span><span>torch</span>.<span>rand</span>(<span>768</span>),  <span># Example direction tensor</span>
    <span>tokenizer</span><span>=</span><span>tokenizer</span>,
    <span>min_layer</span><span>=</span><span>min_layer</span>,
    <span>max_layer</span><span>=</span><span>max_layer</span>,
    <span>instructions</span><span>=</span><span>instructions</span>,
    <span>max_new_tokens</span><span>=</span><span>50</span>
)

<span># Display modified responses</span>
<span>for</span> <span>conversation</span> <span>in</span> <span>ablated_model</span>:
    <span>print</span>(<span>&#34;User:&#34;</span>, <span>conversation</span>[<span>0</span>][<span>&#34;content&#34;</span>])
    <span>print</span>(<span>&#34;AI:&#34;</span>, <span>conversation</span>[<span>1</span>][<span>&#34;content&#34;</span>])</pre></div>
<div dir="auto"><h4 tabindex="-1" dir="auto">Example 2: Measuring Refusal Expressions</h4><a id="user-content-example-2-measuring-refusal-expressions" aria-label="Permalink: Example 2: Measuring Refusal Expressions" href="#example-2-measuring-refusal-expressions"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Use <code>ExpressionRefusalScorer</code> to measure if the model&#39;s response includes common refusal phrases.</p>
<div dir="auto" data-snippet-clipboard-copy-content="response_text = &#34;I&#39;m sorry, I cannot provide that information.&#34;
user_query = &#34;What is the recipe for a dangerous substance?&#34;

# Scoring the response for refusal expressions
refusal_score = scorer.score(user_query=user_query, model_response=response_text)
print(&#34;Refusal Score:&#34;, refusal_score)"><pre><span>response_text</span> <span>=</span> <span>&#34;I&#39;m sorry, I cannot provide that information.&#34;</span>
<span>user_query</span> <span>=</span> <span>&#34;What is the recipe for a dangerous substance?&#34;</span>

<span># Scoring the response for refusal expressions</span>
<span>refusal_score</span> <span>=</span> <span>scorer</span>.<span>score</span>(<span>user_query</span><span>=</span><span>user_query</span>, <span>model_response</span><span>=</span><span>response_text</span>)
<span>print</span>(<span>&#34;Refusal Score:&#34;</span>, <span>refusal_score</span>)</pre></div>

<p dir="auto">You can save your modified model locally or push it to the HuggingFace Hub:</p>
<div dir="auto" data-snippet-clipboard-copy-content="output_model_name = &#34;my_transformed_model&#34;

# Save the modified model
forge.save_model(
    model=model,
    behaviour_dir=torch.rand(768),  # Example direction tensor
    scale_factor=1,
    output_model_name=output_model_name,
    tokenizer=tokenizer,
    to_hub=False  # Set to True to push to HuggingFace Hub
)"><pre><span>output_model_name</span> <span>=</span> <span>&#34;my_transformed_model&#34;</span>

<span># Save the modified model</span>
<span>forge</span>.<span>save_model</span>(
    <span>model</span><span>=</span><span>model</span>,
    <span>behaviour_dir</span><span>=</span><span>torch</span>.<span>rand</span>(<span>768</span>),  <span># Example direction tensor</span>
    <span>scale_factor</span><span>=</span><span>1</span>,
    <span>output_model_name</span><span>=</span><span>output_model_name</span>,
    <span>tokenizer</span><span>=</span><span>tokenizer</span>,
    <span>to_hub</span><span>=</span><span>False</span>  <span># Set to True to push to HuggingFace Hub</span>
)</pre></div>

<p dir="auto">This project was inspired by and built upon the work from the following repositories and projects:</p>
<ul dir="auto">
<li><a href="https://github.com/Sumandora/remove-refusals-with-transformers">Removing refusals with HF Transformers</a></li>
<li><a href="https://huggingface.co/blog/mlabonne/abliteration" rel="nofollow">Ablation Blog post on Huggingface</a></li>
<li><a href="https://github.com/AUGMXNT/deccp">DECCP</a></li>
<li><a href="https://github.com/FailSpy/abliterator">AbliteratorV3</a></li>
</ul>

<p dir="auto">Feel free to submit issues, suggestions, or contribute directly to this project. Fork the repository, create a feature branch, and submit a pull request.</p>
<p dir="auto"><a href="https://github.com/Tsadoq/ErisForge/issues">Issues and Feature Requests</a></p>

<p dir="auto">This project is licensed under the MIT License.</p>

<p dir="auto"><strong>Disclaimer</strong>: This library is provided for research and development purposes only. The author assumes no responsibility for any specific applications or uses of ErisForge.</p>
</article></div></div>
  </body>
</html>
