<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.stmcyber.com/how-to-get-a-heart-attack-while-using-jeb-decompiler/">Original</a>
    <h1>How to get a heart attack while using JEB decompiler (2022)</h1>
    
    <div id="readability-page-1" class="page"><div>
        
<p>Once upon a time, we had to reverse engineer an Android application. To do that, we&#39;ve decided to use our favorite tool of choice - <a href="https://www.pnfsoftware.com/jeb/">J</a>EB. All was good until we noticed something suspiciousâ€¦</p>



<pre data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">Method REDACTED;-&gt;g0(Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;)V: Decrypted string: &#34;2022.08.30&#34;
Method REDACTED;-&gt;g0(Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;)V: Decrypted string: &#34;2022.08.30&#34;
Method REDACTED;-&gt;g0(Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;)V: Decrypted string: &#34;15:33:24.375&#34;</pre>



<p>We highly doubted that our application had an encrypted string with the exact current date down to a second. It looked like facts about our environment were somehow being &#34;leaked&#34; into the decompilation? When you suspect some shady actions are happening, it&#39;s always a good idea to look at the process list:</p>


<div>
<figure><a href="https://blog.stmcyber.com/wp-content/uploads/2022/09/image.png"><img decoding="async" src="https://blog.stmcyber.com/wp-content/uploads/2022/09/image.png" alt="" width="721" height="107" srcset="https://blog.stmcyber.com/wp-content/uploads/2022/09/image.png 721w, https://blog.stmcyber.com/wp-content/uploads/2022/09/image-300x45.png 300w" sizes="(max-width: 721px) 100vw, 721px"/></a><figcaption>htop showing JEB spawning suspicious processes</figcaption></figure></div>


<p><strong>WHAT.</strong></p>



<p>Does the application we&#39;re reverse engineering contain a JEB 0-day? Is someone actively trying to exploit us? After a short reverse engineering effort, we&#39;ve located the suspect, which is a function that looks for <code>su</code> binary on a rooted device:</p>



<pre data-enlighter-language="java" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">    public static String H() {
        String s = System.getenv(&#34;PATH&#34;);
        HashSet hashSet0 = new HashSet();
        
        String[] arr_s = s.split(&#34;:&#34;);
        for(int v = 0; v &lt; arr_s.length; ++v) {
            hashSet0.add(arr_s[v]);
        }

        Iterator iterator0 = hashSet0.iterator();
        while(iterator0.hasNext()) {
            Object object0 = iterator0.next();
            String s1 = (String)object0;
            if(!new File(s1 + &#34;/su&#34;).exists()) {
                continue;
            }

            try {
                Process process0 = Runtime.getRuntime().exec(new String[]{s1 + &#34;/su&#34;, &#34;-c&#34;, &#34;id&#34;}, null, null);
                BufferedReader bufferedReader0 = new BufferedReader(new InputStreamReader(process0.getInputStream()));
                String s2 = bufferedReader0.readLine();
                bufferedReader0.close();
                process0.waitFor();
                if(s2 == null) {
                    return null;
                }

                if(!s2.startsWith(&#34;uid=0&#34;)) {
                    continue;
                }

                return s1 + &#34;/su&#34;;
            }
            catch(InterruptedException | IOException iOException0) {
                Log.i(&#34;ERROR&#34;, Utils.w(iOException0));
            }
        }

        return null;
    }</pre>



<p>The hypothesis was that JEB somehow executes this code in its runtime. To verify this idea, we&#39;ve prepared a modified version of the apk file by unpacking it with <a href="https://ibotpeaches.github.io/Apktool/">apktool</a>, patching strings, and packing the apk back up. Shortly after, we confirmed the hypothesis - indeed, JEB was executing code from the application!</p>


<div>
<figure><a href="https://blog.stmcyber.com/wp-content/uploads/2022/09/image-6.png"><img decoding="async" loading="lazy" src="https://blog.stmcyber.com/wp-content/uploads/2022/09/image-6.png" alt="" width="721" height="107" srcset="https://blog.stmcyber.com/wp-content/uploads/2022/09/image-6.png 721w, https://blog.stmcyber.com/wp-content/uploads/2022/09/image-6-300x45.png 300w" sizes="(max-width: 721px) 100vw, 721px"/></a><figcaption>htop showing Jeb spawning &#34;better&#34; processes</figcaption></figure></div>


<p>However, after opening JEB more than a dozen times in a span of 15 minutes, we&#39;ve also noticed a fine print in Jeb&#39;s console log right after hitting the decompile button.</p>


<div>
<figure><a href="https://blog.stmcyber.com/wp-content/uploads/2022/09/image-1.png"><img decoding="async" loading="lazy" src="https://blog.stmcyber.com/wp-content/uploads/2022/09/image-1.png" alt="" width="694" height="67" srcset="https://blog.stmcyber.com/wp-content/uploads/2022/09/image-1.png 694w, https://blog.stmcyber.com/wp-content/uploads/2022/09/image-1-300x29.png 300w" sizes="(max-width: 694px) 100vw, 694px"/></a><figcaption>logs from Jeb while performing decompilation</figcaption></figure></div>


<p>Hmmm? Let&#39;s read more from JEB&#39;s website.</p>


<div>
<figure><a href="https://blog.stmcyber.com/wp-content/uploads/2022/09/image-2.png"><img decoding="async" loading="lazy" src="https://blog.stmcyber.com/wp-content/uploads/2022/09/image-2.png" alt="" width="815" height="207" srcset="https://blog.stmcyber.com/wp-content/uploads/2022/09/image-2.png 815w, https://blog.stmcyber.com/wp-content/uploads/2022/09/image-2-300x76.png 300w, https://blog.stmcyber.com/wp-content/uploads/2022/09/image-2-768x195.png 768w" sizes="(max-width: 815px) 100vw, 815px"/></a><figcaption>note from Jeb&#39;s webpage about JDK 18+</figcaption></figure></div>


<p>Oh. Oooooooh. That explains a lot. So JEB&#39;s &#34;emulation&#34; is just executing code in a sandbox. And since Java Security Sandbox doesn&#39;t work on Java 18 without an additional console flag - it executes code without any sandboxing on your host machine.</p>



<p>It would be nice to have this notification in a big red message box instead of small print <strong>after</strong> you hit decompile. At that point it&#39;s kind of too late. Especially when you can read this on their blog post:</p>


<div>
<figure><a href="https://blog.stmcyber.com/wp-content/uploads/2022/09/image-3.png"><img decoding="async" loading="lazy" width="709" height="64" src="https://blog.stmcyber.com/wp-content/uploads/2022/09/image-3.png" alt="" srcset="https://blog.stmcyber.com/wp-content/uploads/2022/09/image-3.png 709w, https://blog.stmcyber.com/wp-content/uploads/2022/09/image-3-300x27.png 300w" sizes="(max-width: 709px) 100vw, 709px"/></a><figcaption>fragment form JEB&#39;s blog about deobfuscators</figcaption></figure></div>


<h2>How to avoid this problem?</h2>



<p>Just disable deobfuscators during decompilation or use older Java.</p>


<div>
<figure><a href="https://blog.stmcyber.com/wp-content/uploads/2022/09/image-4.png"><img decoding="async" loading="lazy" width="970" height="275" src="https://blog.stmcyber.com/wp-content/uploads/2022/09/image-4.png" alt="" srcset="https://blog.stmcyber.com/wp-content/uploads/2022/09/image-4.png 970w, https://blog.stmcyber.com/wp-content/uploads/2022/09/image-4-300x85.png 300w, https://blog.stmcyber.com/wp-content/uploads/2022/09/image-4-768x218.png 768w" sizes="(max-width: 970px) 100vw, 970px"/></a><figcaption>JEB decompilation options</figcaption></figure></div>


<p><em><em>Special note from author:</em></em></p>


<div>
<figure><a href="https://blog.stmcyber.com/wp-content/uploads/2022/09/image-5.png"><img decoding="async" loading="lazy" src="https://blog.stmcyber.com/wp-content/uploads/2022/09/image-5.png" alt="" width="379" height="315" srcset="https://blog.stmcyber.com/wp-content/uploads/2022/09/image-5.png 569w, https://blog.stmcyber.com/wp-content/uploads/2022/09/image-5-300x249.png 300w" sizes="(max-width: 379px) 100vw, 379px"/></a><figcaption>author of this blog post after nearly getting a heart attack</figcaption></figure></div>


<p><s>Extra note: We tried to contact the PNF Software crew twice on their slack before posting this article, but they didn&#39;t respond to us.</s></p>



<p>Update 17.09.2022: The vulnerability was patched in the JEB 4.19.1, thanks to the PNF Software crew for the fast patch.</p>
        </div></div>
  </body>
</html>
