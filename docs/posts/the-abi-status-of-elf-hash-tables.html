<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/SubscriberLink/904892/dba951441b61cbdc/">Original</a>
    <h1>The ABI status of ELF hash tables</h1>
    
    <div id="readability-page-1" class="page"><p>

<h2>[LWN subscriber-only content]</h2>
</p><div>
<!-- $Id: slink-none,v 1.2 2005-11-04 22:11:18 corbet Exp $ -->
<blockquote>
<div>
<h3>Welcome to LWN.net</h3>
<p>
The following subscription-only content has been made available to you 
by an LWN subscriber.  Thousands of subscribers depend on LWN for the 
best news from the Linux and free software communities.  If you enjoy this 
article, please consider <a href="https://lwn.net/subscribe/">subscribing to LWN</a>.  Thank you
for visiting LWN.net!
</p></div>
</blockquote>
<p>
It is fair to say that some projects are rather more concerned about
preserving ABI compatibility than others; the <a href="https://www.gnu.org/software/libc/">GNU C Library</a> (glibc) project 
stands out even among those that put a lot of effort into preserving
interface stability,
So it may be a bit surprising that a recent glibc change is being
blamed for breaking a number of applications, most of which are proprietary
games.  There is, it seems, a class of glibc changes that can break
applications, but which are not deemed to be ABI changes.
</p><p>
When the dynamic linker starts a program, it must resolve all of the 
symbol references into shared libraries (including glibc).  That can
involve looking up thousands of symbols in long lists.  Since this process
must complete before an application can actually start running, it needs to
happen quickly.  Nobody likes a long delay between starting
<tt>nethack</tt> and facing off against that first kobold, after all.  So
it is not surprising that some effort has gone into optimizing symbol
lookup.
</p><p>
When the ELF file for a shared object is created by the linker, one of the sections
stored therein contains a hash table for the symbols in that file.  This
hash table can be used to speed the lookup process and get the application
underway.  For many years, the System V standard for the format of
this table has been <tt>DT_HASH</tt>; that format is supported by the
toolchains on Linux.  In 2006, though, the <tt>DT_GNU_HASH</tt> format was
added as well; it includes a number of improvements intended to get
<tt>nethack</tt> players into their dungeons even more quickly, including a
better hash algorithm and a <a href="https://en.wikipedia.org/wiki/Bloom_filter">Bloom filter</a> to
short-circuit the search for missing symbols.  This format is not well
documented, but <a href="https://flapenguin.me/elf-dt-gnu-hash">this 2017
blog post</a> gives an introduction.
</p><p>
Since the hash table lives in its own ELF section, there is nothing
preventing an ELF file from having more than one of them.  Linkers on Linux
systems can be told to create one format or the other — or to create
both, each in its own section.  Until recently, glibc has been built (by
default) with a 
linker option explicitly requesting that both formats be created.  That
changed, though, with the <a href="https://lwn.net/ml/libc-alpha/9174a0aa-cb9b-aafa-a4cd-e0ccdee65d98@redhat.com/">glibc
2.36 release</a> at the beginning of August; it contained <a href="https://sourceware.org/git/?p=glibc.git;a=patch;h=e47de5cb2d4dbecb58f569ed241e8e95c568f03c">a
simple patch</a> from Florian Weimer causing only the <tt>DT_GNU_HASH</tt>
format to be generated.
</p><p>
At this point, glibc 2.36 has been installed onto a number of systems running the
faster-moving Linux distributions, and few people have noticed the change;
the <tt>DT_HASH</tt> format has not been used for anything on those systems
in many years, and the only consequence of its removal is regaining a small
amount of disk space.  Game players, though, were not so lucky;
naturally, the problem relates to a piece of proprietary software that
cannot be easily changed.
</p><p>
The <a href="https://www.easy.ac/en-us/">Easy Anti-Cheat</a> (EAC) system
is a proprietary tool from EPIC intended to prevent game players from cheating by way
of modifications to the game executable itself.  As one might expect, the
actual heuristics used are not documented anywhere and the code is secret,
but one of the techniques involved appears to be looking at the symbols in
the game executable and ensuring that they match the expected values.  To
do this, EAC goes rooting through the <tt>DT_HASH</tt> tables; if an expected table
isn&#39;t present, EAC proudly proclaims that it has caught a cheater and does
not allow the game to run.
</p><p>

Gamers, it seems, find this behavior disappointing.  Arkadiusz Hiler, for
example, <a href="https://blog.hiler.eu/win32-the-only-stable-abi/">blogged</a>:
</p><blockquote>
	I think this whole situation shows why creating native games for
	Linux is challenging. It’s hard to blame developers for targeting
	Windows and relying on Wine + friends. It’s just much more stable
	and much less likely to break and stay broken.
</blockquote>
<p>
Hiler <a href="https://sourceware.org/bugzilla/show_bug.cgi?id=29456">reported</a>
the problem in the glibc bug tracker; the discussion later <a href="https://lwn.net/ml/libc-alpha/8c6fbd40-a0c6-d84f-4e5a-10e7109ffc08@linaro.org/">moved
to 
the project&#39;s mailing list</a> as well.  The report stated that the change
&#34;<q>breaks SysV ABI compatibility</q>&#34;, suggesting that it should be
reverted.  The responses from the project were not entirely sympathetic to
that cause, though.  Weimer <a href="https://sourceware.org/bugzilla/show_bug.cgi?id=29456#c1">answered</a>
that: &#34;<q>Any tool that performs symbol lookups needs to support
DT_GNU_HASH these days</q>&#34;.  Adhemerval Zanella <a href="https://sourceware.org/bugzilla/show_bug.cgi?id=29456#c7">said</a>:
&#34;<q>I am not sure this characterizes as an ABI break since the symbol lookup
information would be indeed provided (albeit in a different format)</q>&#34;
</p><p>
Carlos O&#39;Donell <a href="https://lwn.net/ml/libc-alpha/e2918326-9329-4195-6e9a-747829f3126e@redhat.com/">agreed</a>
that this change was not an ABI break:
</p><blockquote>
	Software that is an ELF consumer on Linux has had 16 years to be
	updated to handle the switch from DT_HASH to DT_GNU_HASH
	(OS-specific).
<p>
	While I&#39;m sympathetic to application developers and their backwards
	compatibility requirements, this specific case is about an ELF
	consumer and such a consumer needs to track upstream Linux ELF
	developments.
</p></blockquote>
<p>
He went on to say that characteristics of the generated ELF file are not
part of the glibc ABI, even if changes there break applications, and
suggested that the bug should be closed as &#34;won&#39;t fix&#34;.  He also requested
that the EAC developers provide reasons for why <tt>DT_HASH</tt> should be
retained by default.  As of this writing, the bug remains open.
</p><p>
Blaming the EAC developers for not keeping up with Linux ELF hash-table
formats might not be entirely fair.  The <tt>DT_HASH</tt> format is
mandated by the <a href="http://www.sco.com/developers/gabi/latest/contents.html">System V ABI
specification</a>, the <tt>DT_GNU_HASH</tt> format is undocumented, and
there has been no deprecation campaign to get users to move on.  Chances
are those developers are as surprised as anybody and haven&#39;t just been
ignoring the &#34;switch to <tt>DT_GNU_HASH</tt>&#34; entry languishing in their
issue tracker for the last decade or so.  Regardless of blame, though,
something needs to be done to solve this problem and save gamers from the
prospect of having to get some actual work done.
</p><p>
If EAC were free software, of course, chances are there would already be a
patch circulating to deal with the problem.  As it is, only its owner
can deal with this problem directly.  Meanwhile, though, there is
another workaround available: distributors can easily patch the glibc build
to restore the <tt>DT_HASH</tt> section and make the problem go away for
now.  Doing that and giving EAC (along with a few other programs) some time
to move to <tt>DT_GNU_HASH</tt> seems like the best solution from just
about any point of view.<br clear="all"/></p>
               </div></div>
  </body>
</html>
