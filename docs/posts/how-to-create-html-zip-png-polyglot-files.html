<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://gildas-lormeau.github.io/Polyglot-HTML-ZIP-PNG/SUMMARY.html">Original</a>
    <h1>How to Create HTML/ZIP/PNG Polyglot Files</h1>
    
    <div id="readability-page-1" class="page"><div>
      
      
      

      

<p>This article is a summary of the presentation available <a href="https://gildas-lormeau.github.io/Polyglot-HTML-ZIP-PNG/">here</a>. The resulting demo file can be downloaded at the end of the article. The repository can be found at <a href="https://github.com/gildas-lormeau/Polyglot-HTML-ZIP-PNG">https://github.com/gildas-lormeau/Polyglot-HTML-ZIP-PNG</a>.</p>

<h2 id="introduction">Introduction</h2>

<p><a href="https://github.com/gildas-lormeau/SingleFile">SingleFile</a>, a tool for web archiving, commonly stores web page resources as data URIs. However, this approach can be inefficient for large resources. A more elegant solution emerges through combining the ZIP format’s flexible structure with HTML. We’ll then take it a step further by encapsulating this entire structure within a PNG file.</p>

<h2 id="the-power-of-zip">The Power of ZIP</h2>

<p>The ZIP format provides an organized structure for storing multiple files. It is based on a structure with file entries followed by a central directory. The central directory acts as a table of contents, containing headers with metadata about each file entry. These headers include crucial information such as file names, sizes, checksums, and file entry offsets. What makes ZIP particularly versatile is its flexibility with data placement. The format enables data to be prepended before the ZIP content by setting an offset greater than 0 for the first file entry, while allowing up to 64KB of data to be appended afterward (i.e. ZIP comment). This feature makes it well-suited for creating polyglot files.</p>

<h2 id="creating-htmlzip-polyglot-files">Creating HTML/ZIP Polyglot Files</h2>

<p>Based on this knowledge, we can create a self-extracting archive that works in web browsers. The page to be displayed and its resources are stored in a ZIP file. By storing the ZIP data in an HTML comment, we can create a self-extracting page that extracts and displays the contents of the ZIP file.</p>

<p>Here is the basic structure of the self-extracting page:</p>
<div><div><pre><code><span>&lt;!doctype html&gt;</span>
<span>&lt;html&gt;</span>
  <span>&lt;head&gt;</span>
    <span>&lt;meta</span> <span>charset=</span><span>utf-8</span><span>&gt;</span>
    <span>&lt;title&gt;</span>Please wait...<span>&lt;/title&gt;</span>
    <span>&lt;script </span><span>src=</span><span>lib/zip.min.js</span><span>&gt;&lt;/script&gt;</span>
  <span>&lt;/head&gt;</span>
  <span>&lt;body&gt;</span>
    <span>&lt;p&gt;</span>Please wait...<span>&lt;/p&gt;</span>
    <span>&lt;!-- [ZIP data] --&gt;</span>
    <span>&lt;script&gt;</span><span>&lt;!--</span> <span>Content</span> <span>of</span> <span>assets</span><span>/</span><span>main</span><span>.</span><span>js</span> <span>--&gt;</span><span>&lt;/script&gt;</span>
  <span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
</code></pre></div></div>

<p>The <code>assets/main.js</code> script on this “bootstrap page” reads the ZIP data by calling <code>fetch(””)</code> and uses the <code>lib/zip.min.js</code> JavaScript library to extract it. This bootstrap page is then replaced by the extracted page with its resources. However, there’s a problem: due to the same-origin policy, retrieving ZIP data directly with <code>fetch(””)</code> fails when the page is opened from the filesystem (except in Firefox).</p>

<h2 id="reading-zip-data-from-the-dom">Reading ZIP Data from the DOM</h2>

<p>To overcome the filesystem limitation, we can read ZIP data directly from the DOM. This approach requires careful handling of character encoding. The bootstrap page is now encoded in <code>windows-1252</code>, which allows data to be read from the DOM with minimum degradation. Some encoding challenges emerge:</p>
<ol>
  <li>DOM text content gets decoded to <code>UTF-16</code> instead of <code>windows-1252</code></li>
  <li>The <code>NULL</code> character (<code>U+0000</code>) gets decoded to the replacement character (<code>U+FFFD</code>)</li>
  <li>Carriage returns (<code>\r</code>) and carriage return + line feeds (<code>\r\n</code>) get decoded to line feeds (<code>\n</code>)</li>
</ol>

<p>The first 2 points can be fixed by using an association table to convert characters to <code>windows-1252</code>. For the last point, “consolidation data” in a JSON script tag is added in the bootstrap page. This data tracks the offsets of carriage returns and carriage return + line feeds, and enables accurate reconstruction of the original content when extracting the ZIP data.</p>

<p>Here is the resulting structure:</p>
<div><div><pre><code><span>&lt;!doctype html&gt;</span>
<span>&lt;html&gt;</span>
  <span>&lt;head&gt;</span>
    <span>&lt;meta</span> <span>charset=</span><span>windows-1252</span><span>&gt;</span>
    <span>&lt;title&gt;</span>Please wait...<span>&lt;/title&gt;</span>
    <span>&lt;script </span><span>src=</span><span>lib/zip.min.js</span><span>&gt;&lt;/script&gt;</span>
  <span>&lt;/head&gt;</span>
  <span>&lt;body&gt;</span>
    <span>&lt;p&gt;</span>Please wait...<span>&lt;/p&gt;</span>
    <span>&lt;!-- [ZIP data] --&gt;</span>
    <span>&lt;script </span><span>text=</span><span>application/json</span><span>&gt;</span>
    <span>[</span><span>consolidation</span> <span>data</span><span>]</span>
    <span>&lt;/script&gt;</span>
    <span>&lt;script&gt;</span><span>&lt;!--</span> <span>Content</span> <span>of</span> <span>assets</span><span>/</span><span>main</span><span>.</span><span>js</span> <span>--&gt;</span><span>&lt;/script&gt;</span>
  <span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
</code></pre></div></div>

<h2 id="adding-png-to-the-mix">Adding PNG to the Mix</h2>

<p>The PNG format consists of a signature followed by chunks. Each chunk contains these fieds:</p>
<ul>
  <li>Length (4 bytes)</li>
  <li>Type identifier (4 bytes) e.g., <code>IHDR</code> (header), <code>IDAT</code> (data), <code>IEND</code> (end of file), <code>tEXt</code> (custom data)…</li>
  <li>Data content (n bytes)</li>
  <li>CRC32 checksum (4 bytes)</li>
</ul>

<p>Here is the minimum structure of a PNG file:</p>
<ol>
  <li>PNG signature (8 bytes)</li>
  <li><code>IHDR</code> chunk (13 bytes)</li>
  <li>One or more <code>IDAT</code> chunks</li>
  <li><code>IEND</code> chunk (12 bytes)</li>
</ol>

<h2 id="the-final-form-htmlzippng-polyglot-files">The Final Form: HTML/ZIP/PNG Polyglot Files</h2>

<p>The ultimate implementation combines all three formats into a single file. The HTML format’s fault tolerance allows for this complex structure. However, this approach introduces new challenges:</p>
<ol>
  <li>The signature, the <code>IHDR</code> and the <code>IEND</code> chunks become visible as text nodes briefly and should be removed as soon as the page is parsed</li>
  <li>The displayed page is rendered in quirks mode, requiring specific handling through <code>document.write()</code> and related methods to parse the displayed page</li>
</ol>

<p>Here is the resulting structure viewed as PNG chunks:</p>

<div><div><pre><code>[PNG signature]
[IHDR chunk]
[tEXt chunk
  &lt;!doctype html&gt;
  &lt;html&gt;
    &lt;head&gt;
      &lt;meta charset=windows-1252&gt;
      &lt;title&gt;Please wait...&lt;/title&gt;
      &lt;script src=lib/zip.min.js&gt;&lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
      &lt;p&gt;Please wait...&lt;/p&gt;
      &lt;!-- 
]
[IDAT chunk(s)]
[tEXt chunk
      --&gt;
      &lt;!-- [ZIP data] --&gt;
      &lt;script text=application/json&gt;
      [consolidation data]
      &lt;/script&gt;
      &lt;script&gt;&lt;!-- Content of assets/main.js --&gt;&lt;/script&gt;
    &lt;/body&gt;
  &lt;/html&gt;
]
[IEND chunk]
</code></pre></div></div>

<h2 id="optimization-through-image-reuse">Optimization Through Image Reuse</h2>

<p>The final optimization removes the main image (i.e. the logo of RennesJS) from the ZIP file and reuses the page, interpreted as a PNG file, to replace it in the displayed page.</p>

<h2 id="resulting-file">Resulting File</h2>

<p>Download <a href="https://github.com/gildas-lormeau/Polyglot-HTML-ZIP-PNG/raw/main/demo.png.zip.html">demo.png.zip.html</a> (a bug in “Archive Utility” on macOS prevents it from decompressing the resulting file, you can use unzip to get around this issue).</p>


      
      
      
    </div></div>
  </body>
</html>
