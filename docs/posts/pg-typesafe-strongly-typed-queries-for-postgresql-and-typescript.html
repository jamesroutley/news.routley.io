<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/n-e/pg-typesafe">Original</a>
    <h1>Show HN: Pg-typesafe â€“ Strongly typed queries for PostgreSQL and TypeScript</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">pg-typesafe generates TypeScript types for PostgreSQL queries.</p>
<p dir="auto">pg-typesafe does so with no runtime dependencies, and zero additional verbosity.</p>
<p dir="auto">Here is a query with <code>pg-typesafe</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="const { rows } = client.query(
  &#34;select id, name, last_modified from tbl where id = $1&#34;,
  [42],
);"><pre><span>const</span> <span>{</span> rows <span>}</span> <span>=</span> <span>client</span><span>.</span><span>query</span><span>(</span>
  <span>&#34;select id, name, last_modified from tbl where id = $1&#34;</span><span>,</span>
  <span>[</span><span>42</span><span>]</span><span>,</span>
<span>)</span><span>;</span></pre></div>
<p dir="auto">This query looks the same as a normal query with <code>pg</code>, but is fully typed:</p>
<ul dir="auto">
<li>The parameter is required, and must be a number</li>
<li><code>rows</code> has the type <code>{ id:number; name:string; last_modified: Date }[]</code></li>
</ul>

<p dir="auto">Install pg-typesafe:</p>

<p dir="auto">Run it for the first time:</p>
<div dir="auto" data-snippet-clipboard-copy-content="npm exec pg-typesafe -- --connectionString postgres://postgres:example@localhost"><pre>npm <span>exec</span> pg-typesafe -- --connectionString postgres://postgres:example@localhost</pre></div>
<p dir="auto">This will generate the file <code>src/defs.gen.ts</code> that contains the pg-typesafe types.</p>
<p dir="auto">Now that the types are generated you can cast your <code>Pool</code> to the pg-typesafe type:</p>
<div dir="auto" data-snippet-clipboard-copy-content="import type { TypesafePool } from &#34;./defs.gen.ts&#34;;

export const pool = new Pool() as TypesafePool;"><pre><span>import</span> <span>type</span> <span>{</span> <span>TypesafePool</span> <span>}</span> <span>from</span> <span>&#34;./defs.gen.ts&#34;</span><span>;</span>

<span>export</span> <span>const</span> <span>pool</span> <span>=</span> <span>new</span> <span>Pool</span><span>(</span><span>)</span> <span>as</span> <span>TypesafePool</span><span>;</span></pre></div>
<p dir="auto">This will allow pg-typesafe to find you queries, and also type them properly.</p>
<p dir="auto">You can now run pg-typesafe again to generate the types:</p>
<div dir="auto" data-snippet-clipboard-copy-content="npm exec pg-typesafe -- --connectionString postgres://postgres:example@localhost"><pre>npm <span>exec</span> pg-typesafe -- --connectionString postgres://postgres:example@localhost</pre></div>

<p dir="auto">pg-typesafe can only type queries where the SQL query is a constant, as dynamic queries cannot be analyzed. You should however, when possible, do so, as it avoids SQL injections and is faster.</p>

<div dir="auto"><h4 tabindex="-1" dir="auto"><code>--connectionString</code> (default: undefined)</h4><a id="user-content---connectionstring-default-undefined" aria-label="Permalink: --connectionString (default: undefined)" href="#--connectionstring-default-undefined"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The connection string to the postgresql database. pg-typesafe also honors
the node-pg environment variables (PGHOST, PGDATABASE...)</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>--definitionsFile</code> (default: <code>src/defs.gen.ts</code>)</h4><a id="user-content---definitionsfile-default-srcdefsgents" aria-label="Permalink: --definitionsFile (default: src/defs.gen.ts)" href="#--definitionsfile-default-srcdefsgents"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The path to the type definitions</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>--tsConfigFile</code> (default: <code>tsconfig.json</code>)</h4><a id="user-content---tsconfigfile-default-tsconfigjson" aria-label="Permalink: --tsConfigFile (default: tsconfig.json)" href="#--tsconfigfile-default-tsconfigjson"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The tsconfig file for the project. pg-typesafe uses this file to find the
files to analyze</p>
<div dir="auto"><h4 tabindex="-1" dir="auto"><code>--configFile</code> (default: <code>pg-typesafe.config.ts</code>)</h4><a id="user-content---configfile-default-pg-typesafeconfigts" aria-label="Permalink: --configFile (default: pg-typesafe.config.ts)" href="#--configfile-default-pg-typesafeconfigts"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The pg-typesasfe configuration file</p>

<p dir="auto">Basic <code>pg-typesafe.config.ts</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="import { defineConfig } from &#34;pg-typesafe&#34;;

export default defineConfig({
  connectionString: &#34;postgres://postgres:example@localhost&#34;,
});"><pre><span>import</span> <span>{</span> <span>defineConfig</span> <span>}</span> <span>from</span> <span>&#34;pg-typesafe&#34;</span><span>;</span>

<span>export</span> <span>default</span> <span>defineConfig</span><span>(</span><span>{</span>
  <span>connectionString</span>: <span>&#34;postgres://postgres:example@localhost&#34;</span><span>,</span>
<span>}</span><span>)</span><span>;</span></pre></div>
<p dir="auto">The full list of parameters is available as JSDoc.</p>

<div dir="auto"><h3 tabindex="-1" dir="auto">Convert BIGINTs to JavaScript bigints</h3><a id="user-content-convert-bigints-to-javascript-bigints" aria-label="Permalink: Convert BIGINTs to JavaScript bigints" href="#convert-bigints-to-javascript-bigints"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">By default, <code>pg</code> returns BIGINTs as strings, as very large values cannot be represented exactly by the JavaScript number type.</p>
<p dir="auto">In &#34;newer&#34; node.js versions, the bigint type is supported, let&#39;s use it.</p>
<p dir="auto">On the <code>pg</code> side, do the conversion:</p>
<div dir="auto" data-snippet-clipboard-copy-content="import { types } from &#34;pg&#34;;
types.setTypeParser(20, (val) =&gt; BigInt(val));"><pre><span>import</span> <span>{</span> <span>types</span> <span>}</span> <span>from</span> <span>&#34;pg&#34;</span><span>;</span>
<span>types</span><span>.</span><span>setTypeParser</span><span>(</span><span>20</span><span>,</span> <span>(</span><span>val</span><span>)</span> <span>=&gt;</span> <span>BigInt</span><span>(</span><span>val</span><span>)</span><span>)</span><span>;</span></pre></div>
<p dir="auto">On the pg-typesafe side, generate the right types:</p>
<div dir="auto" data-snippet-clipboard-copy-content="export default defineConfig({
  // when a query accepts a BIGINT as a parameter, type it as bigint
  transformParameter(param) {
    if (param.type_oid === 20) {
      return { type: &#34;bigint&#34; };
    }
    return defaultTransformParameter(param);
  },
  // when a query returns a BIGINT, type it as bigint
  transformField(field) {
    if (field.type_oid === 20) {
      return { type: &#34;bigint&#34; };
    }
    return defaultTransformField(field);
  },
});"><pre><span>export</span> <span>default</span> <span>defineConfig</span><span>(</span><span>{</span>
  <span>// when a query accepts a BIGINT as a parameter, type it as bigint</span>
  <span>transformParameter</span><span>(</span><span>param</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>param</span><span>.</span><span>type_oid</span> <span>===</span> <span>20</span><span>)</span> <span>{</span>
      <span>return</span> <span>{</span> <span>type</span>: <span>&#34;bigint&#34;</span> <span>}</span><span>;</span>
    <span>}</span>
    <span>return</span> <span>defaultTransformParameter</span><span>(</span><span>param</span><span>)</span><span>;</span>
  <span>}</span><span>,</span>
  <span>// when a query returns a BIGINT, type it as bigint</span>
  <span>transformField</span><span>(</span><span>field</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>field</span><span>.</span><span>type_oid</span> <span>===</span> <span>20</span><span>)</span> <span>{</span>
      <span>return</span> <span>{</span> <span>type</span>: <span>&#34;bigint&#34;</span> <span>}</span><span>;</span>
    <span>}</span>
    <span>return</span> <span>defaultTransformField</span><span>(</span><span>field</span><span>)</span><span>;</span>
  <span>}</span><span>,</span>
<span>}</span><span>)</span><span>;</span></pre></div>
<div dir="auto"><h3 tabindex="-1" dir="auto">Type JSONB columns to the right type depending on the context</h3><a id="user-content-type-jsonb-columns-to-the-right-type-depending-on-the-context" aria-label="Permalink: Type JSONB columns to the right type depending on the context" href="#type-jsonb-columns-to-the-right-type-depending-on-the-context"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">If your JSONB columns contain that data that conform to a schema, it can be nice to type them to the &#34;right&#34; type.</p>
<p dir="auto">To do this, we will type the columns as <code>table_name_column_name</code>, then define these types in another file.</p>
<div dir="auto" data-snippet-clipboard-copy-content="export default defineConfig({
  transformField(field) {
    if (field.type_oid === 3802 &amp;&amp; field.column) {
      const c = field.column;
      const typeName = c.table_name + &#34;_&#34; + c.column_name;
      return {
        type: typeName,
        imports: [{ name: typeName, path: &#34;./jsonb_columns.ts&#34; }],
      };
    }
    return defaultTransformField(field);
  },
});"><pre><span>export</span> <span>default</span> <span>defineConfig</span><span>(</span><span>{</span>
  <span>transformField</span><span>(</span><span>field</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>field</span><span>.</span><span>type_oid</span> <span>===</span> <span>3802</span> <span>&amp;&amp;</span> <span>field</span><span>.</span><span>column</span><span>)</span> <span>{</span>
      <span>const</span> <span>c</span> <span>=</span> <span>field</span><span>.</span><span>column</span><span>;</span>
      <span>const</span> <span>typeName</span> <span>=</span> <span>c</span><span>.</span><span>table_name</span> <span>+</span> <span>&#34;_&#34;</span> <span>+</span> <span>c</span><span>.</span><span>column_name</span><span>;</span>
      <span>return</span> <span>{</span>
        <span>type</span>: <span>typeName</span><span>,</span>
        <span>imports</span>: <span>[</span><span>{</span> <span>name</span>: <span>typeName</span><span>,</span> <span>path</span>: <span>&#34;./jsonb_columns.ts&#34;</span> <span>}</span><span>]</span><span>,</span>
      <span>}</span><span>;</span>
    <span>}</span>
    <span>return</span> <span>defaultTransformField</span><span>(</span><span>field</span><span>)</span><span>;</span>
  <span>}</span><span>,</span>
<span>}</span><span>)</span><span>;</span></pre></div>
<p dir="auto">Then, if you have a table <code>hello</code> with a JSONB column <code>data</code>, you can create a <code>jsonb_columns.ts</code> file with the right type:</p>
<div dir="auto" data-snippet-clipboard-copy-content="export interface hello_data {
  foo: string;
  bar: number;
}"><pre><span>export</span> <span>interface</span> <span>hello_data</span> <span>{</span>
  <span>foo</span>: <span>string</span><span>;</span>
  <span>bar</span>: <span>number</span><span>;</span>
<span>}</span></pre></div>

<p dir="auto">For the types to work properly, the pg-typesafe enhanced types must be used. This usually works automatically, even if you use <code>pool.connect</code> to acquire clients.</p>
<p dir="auto">If you pass connections to functions, you may use the types such as <code>TypesafePoolClient</code>, <code>TypesafeQuerier</code>, or <code>TypesafeQueryFn</code> for example:</p>
<div dir="auto" data-snippet-clipboard-copy-content="async function fetchFoos(client: TypesafeQuerier) {
  const { rows } = await client.query(&#34;select id, name from foo&#34;);
  return rows;
}"><pre><span>async</span> <span>function</span> <span>fetchFoos</span><span>(</span><span>client</span>: <span>TypesafeQuerier</span><span>)</span> <span>{</span>
  <span>const</span> <span>{</span> rows <span>}</span> <span>=</span> <span>await</span> <span>client</span><span>.</span><span>query</span><span>(</span><span>&#34;select id, name from foo&#34;</span><span>)</span><span>;</span>
  <span>return</span> <span>rows</span><span>;</span>
<span>}</span></pre></div>

<ul dir="auto">
<li>
<p dir="auto"><a href="https://pgtyped.dev" rel="nofollow">pgtyped</a>: pgtyped also generates types for queries, and supports queries in both .ts and .sql files. For queries in .ts files, it is more verbose and exposes its own helpers, while pg-typesafe adds no verbosity on top of <code>pg</code></p>
</li>
<li>
<p dir="auto"><a href="https://kysely.dev" rel="nofollow">kysely</a>: a type-safe query builder that is close to SQL</p>
</li>
</ul>
</article></div></div>
  </body>
</html>
