<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://xn--gckvb8fzb.com/irc-server-as-tor-hidden-service-on-openbsd/">Original</a>
    <h1>IRC Server as Tor Hidden Service on OpenBSD</h1>
    
    <div id="readability-page-1" class="page"><p>A brief guide on how to set up an IRC server (Ergo) as a Tor v3 Onion Hidden
Service on OpenBSD for secret idle parties with your friends.</p><div><p>With increasing surveillance by companies as well as government services, many
online services that were once fun to use have become a potential threat for
one’s privacy. Not only e-mail accounts and social networking websites, but
also niche services like the IRC cannot blindly be trusted anymore.</p><p>Therefore let’s take a look at how you can set up your own IRC server for you
and your friends, in a way that allows you to freely communication without being
bothered by big tech or anyone else. We’re going to be using
<a href="https://github.com/ergochat/ergo">Ergo</a> for this, as it’s an up to date IRC
server written in Go that offers bleeding-edge
<a href="https://ircv3.net/software/servers.html">IRCv3</a> support. We’re also going to
use OpenBSD for the base system.</p><h2 id="preparation">Preparation</h2><p>Usually when I build OpenBSD-based infrastructure, I use a
<a href="https://www.vultr.com/?ref=9209123-8H">Vultr</a> VPS instance. Even though Vultr
allows running Tor on their service unless it’s an exit node, for this setup I’d
rather take a look at a <a href="https://xn--gckvb8fzb.com/infrastructure/#infrastructure-providers">different infrastructure
provider</a> that is more focused on
privacy and ideally accepts payments via
<a href="https://www.getmonero.org/get-started/what-is-monero/">XMR</a>.</p><blockquote><p><strong>Note:</strong> I won’t explicitly mention under which user I’m running each
command, hence please read carefully. When the prompt shows <code>ircd#</code>, I’m
acting as <code>root</code> user, otherwise, when it shows <code>ircd%</code>, I’m the using the
<code>_ergo</code> user.</p></blockquote><p>As soon as the OpenBSD VPS has booted, we can log in via SSH and perform a quick
update of the system:</p><p>After that, let’s begin by installing some handy tools:</p><div><pre tabindex="0"><code data-lang="sh"><span><span>ircd# pkg_add git zsh neovim wget mosh rsync htop
</span></span></code></pre></div><p>What I like to do is link <code>nvim</code> to <code>vim</code>, because typing <code>vim</code> is in my muscle
memory. I also like to use <code>zsh</code> as shell. Since that’s all preference, these
steps are optional:</p><div><pre tabindex="0"><code data-lang="sh"><span><span>ircd# ln -s /usr/local/bin/nvim /usr/local/bin/vim
</span></span><span><span>ircd# chsh -s /usr/local/bin/zsh root
</span></span></code></pre></div><p>Another optional but useful thing that I like to do is to change the SSH port
and disable password authentication / enable pubkey authentication. Make sure
you have an <code>authorized_keys</code> entry with your pubkey in place before applying
this change:</p><div><pre tabindex="0"><code data-lang="sh"><span><span>ircd# sed -i <span>&#39;s/^#Port 22/Port 31231/g;\
</span></span></span><span><span><span>              s/^#PubkeyAuthentication .*/PubkeyAuthentication yes/g;\
</span></span></span><span><span><span>              s/^#PasswordAuthentication .*/PasswordAuthentication no/g&#39;</span> <span>\
</span></span></span><span><span><span></span>                /etc/ssh/sshd_config
</span></span><span><span>ircd# rcctl restart sshd
</span></span></code></pre></div><p>Afterwards, disconnect from SSH, and re-connect, ideally using <code>mosh</code>, and
launch <code>tmux</code> for the sake of comfort.</p><h2 id="tor">Tor</h2><p>We begin by installing and configuring the Tor hidden service:</p><div><pre tabindex="0"><code data-lang="sh"><span><span>ircd# pkg_add tor
</span></span><span><span>ircd# cat /etc/tor/torrc
</span></span></code></pre></div><pre tabindex="0"><code data-lang="config">Log notice syslog
RunAsDaemon 1
DataDirectory /var/tor
HiddenServiceDir /var/tor/hidden_service/
HiddenServicePort 6667 127.0.0.1:6667 unix:/hidden_service_sockets/ergo_tor_sock
User _tor
</code></pre><p>Next, enable the Tor hidden service:</p><div><pre tabindex="0"><code data-lang="sh"><span><span>ircd# rcctl <span>enable</span> tor
</span></span><span><span>ircd# rcctl start tor
</span></span></code></pre></div><p>We can now check the hidden service’s <a href="https://en.wikipedia.org/wiki/.onion">Onion
address</a>:</p><div><pre tabindex="0"><code data-lang="sh"><span><span>ircd# cat /var/tor/hidden_service/hostname
</span></span></code></pre></div><pre tabindex="0"><code>xyz.onion
</code></pre><p>This is the address that our hidden service IRC server will be available at. We
will need to add this address to <a href="#ergo-ircd">Ergo</a>’s configuration.</p><h2 id="ergo-ircd">Ergo IRCd</h2><p>First download and install the latest OpenBSD release of Ergo <a href="https://github.com/ergochat/ergo/releases">from
GitHub</a> – <code>2.10.0</code> as of writing this:</p><div><pre tabindex="0"><code data-lang="sh"><span><span>ircd# wget https://github.com/ergochat/ergo/releases/download/v2.10.0/ergo-2.10.0-openbsd-x86_64.tar.gz
</span></span><span><span>ircd# tar -xzf ergo-2.10.0-openbsd-x86_64.tar.gz
</span></span><span><span>ircd# cp ergo-2.10.0-openbsd-x86_64/ergo /usr/local/bin/ergo
</span></span></code></pre></div><p>Next, add a new system user for Ergo:</p><div><pre tabindex="0"><code data-lang="sh"><span><span>ircd# groupadd _ergo
</span></span><span><span>ircd# useradd -d /home/_ergo -m -c <span>&#34;Ergo&#34;</span> -g _ergo -L daemon -s /sbin/nologin _ergo
</span></span></code></pre></div><p>Now we can create a configuration as well as a <em>MOTD</em> file for Ergo in <code>/etc/</code>:</p><div><pre tabindex="0"><code data-lang="yaml"><span><span><span>network</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>name</span><span>:</span><span> </span><span>my-ircd</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>server</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>name</span><span>:</span><span> </span><span>xyz.onion </span><span>
</span></span></span><span><span><span>    </span><span>listeners</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>&#34;127.0.0.1:6667&#34;: </span><span># (loopback ipv4, localhost-only)</span><span>
</span></span></span><span><span><span>        </span><span>&#34;/hidden_service_sockets/ergo_tor_sock&#34;</span><span>:</span><span>
</span></span></span><span><span><span>             </span><span>tor</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>    </span><span>unix-bind-mode</span><span>:</span><span> </span><span>0777</span><span>
</span></span></span><span><span><span>    </span><span>tor-listeners</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>require-sasl</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>        </span><span>vhost</span><span>:</span><span> </span><span>&#34;xyz.onion&#34;</span><span>
</span></span></span><span><span><span>        </span><span>max-connections</span><span>:</span><span> </span><span>1024</span><span>
</span></span></span><span><span><span>        </span><span>throttle-duration</span><span>:</span><span> </span><span>10m</span><span>
</span></span></span><span><span><span>        </span><span>max-connections-per-duration</span><span>:</span><span> </span><span>64</span><span>
</span></span></span><span><span><span>    </span><span>sts</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>enabled</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>casemapping</span><span>:</span><span> </span><span>&#34;ascii&#34;</span><span>
</span></span></span><span><span><span>    </span><span>enforce-utf8</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>    </span><span>lookup-hostnames</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>    </span><span>forward-confirm-hostnames</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>    </span><span>check-ident</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>    </span><span>coerce-ident</span><span>:</span><span> </span><span>&#39;~u&#39;</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>motd</span><span>:</span><span> </span><span>/etc/ircd.motd</span><span>
</span></span></span><span><span><span>    </span><span>motd-formatting</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>relaymsg</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>enabled</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>proxy-allowed-from</span><span>:</span><span>
</span></span></span><span><span><span>        </span>- <span>localhost</span><span>
</span></span></span><span><span><span>    </span><span>max-sendq</span><span>:</span><span> </span><span>96k</span><span>
</span></span></span><span><span><span>    </span><span>compatibility</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>force-trailing</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>        </span><span>send-unprefixed-sasl</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>        </span><span>allow-truncation</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>ip-limits</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>count</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>        </span><span>max-concurrent-connections</span><span>:</span><span> </span><span>64</span><span>
</span></span></span><span><span><span>        </span><span>throttle</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>        </span><span>window</span><span>:</span><span> </span><span>10m</span><span>
</span></span></span><span><span><span>        </span><span>max-connections-per-window</span><span>:</span><span> </span><span>32</span><span>
</span></span></span><span><span><span>        </span><span>cidr-len-ipv4</span><span>:</span><span> </span><span>32</span><span>
</span></span></span><span><span><span>        </span><span>cidr-len-ipv6</span><span>:</span><span> </span><span>64</span><span>
</span></span></span><span><span><span>        </span><span>exempted</span><span>:</span><span>
</span></span></span><span><span><span>            </span>- <span>localhost</span><span>
</span></span></span><span><span><span>        </span><span>custom-limits</span><span>:</span><span>
</span></span></span><span><span><span>            </span><span>#&#34;irccloud&#34;:</span><span>
</span></span></span><span><span><span>            </span><span>#    nets:</span><span>
</span></span></span><span><span><span>            </span><span>#        - &#34;192.184.9.108&#34;  # highgate.irccloud.com</span><span>
</span></span></span><span><span><span>            </span><span>#        - &#34;192.184.9.110&#34;  # ealing.irccloud.com</span><span>
</span></span></span><span><span><span>            </span><span>#        - &#34;192.184.9.112&#34;  # charlton.irccloud.com</span><span>
</span></span></span><span><span><span>            </span><span>#        - &#34;192.184.10.118&#34; # brockwell.irccloud.com</span><span>
</span></span></span><span><span><span>            </span><span>#        - &#34;192.184.10.9&#34;   # tooting.irccloud.com</span><span>
</span></span></span><span><span><span>            </span><span>#        - &#34;192.184.8.73&#34;   # hathersage.irccloud.com</span><span>
</span></span></span><span><span><span>            </span><span>#        - &#34;192.184.8.103&#34;  # stonehaven.irccloud.com</span><span>
</span></span></span><span><span><span>            </span><span>#        - &#34;5.254.36.57&#34;    # tinside.irccloud.com</span><span>
</span></span></span><span><span><span>            </span><span>#        - &#34;5.254.36.56/29&#34; # additional ipv4 net</span><span>
</span></span></span><span><span><span>            </span><span>#        - &#34;2001:67c:2f08::/48&#34;</span><span>
</span></span></span><span><span><span>            </span><span>#        - &#34;2a03:5180:f::/64&#34;</span><span>
</span></span></span><span><span><span>            </span><span>#    max-concurrent-connections: 2048</span><span>
</span></span></span><span><span><span>            </span><span>#    max-connections-per-window: 2048</span><span>
</span></span></span><span><span><span>    </span><span>ip-check-script</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>enabled</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>        </span><span>command</span><span>:</span><span> </span><span>&#34;/usr/local/bin/check-ip-ban&#34;</span><span>
</span></span></span><span><span><span>        </span><span>args</span><span>:</span><span> </span><span>[]</span><span>
</span></span></span><span><span><span>        </span><span>timeout</span><span>:</span><span> </span><span>9s</span><span>
</span></span></span><span><span><span>        </span><span>kill-timeout</span><span>:</span><span> </span><span>1s</span><span>
</span></span></span><span><span><span>        </span><span>max-concurrency</span><span>:</span><span> </span><span>64</span><span>
</span></span></span><span><span><span>        </span><span>exempt-sasl</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>ip-cloaking</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>enabled</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>        </span><span>enabled-for-always-on</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>        </span><span>netname</span><span>:</span><span> </span><span>&#34;my-ircd&#34;</span><span>
</span></span></span><span><span><span>        </span><span>cidr-len-ipv4</span><span>:</span><span> </span><span>32</span><span>
</span></span></span><span><span><span>        </span><span>cidr-len-ipv6</span><span>:</span><span> </span><span>64</span><span>
</span></span></span><span><span><span>        </span><span>num-bits</span><span>:</span><span> </span><span>64</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>secure-nets</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span># - &#34;10.0.0.0/8&#34;</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>suppress-lusers</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>accounts</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>authentication-enabled</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>    </span><span>registration</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>enabled</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>        </span><span>allow-before-connect</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>        </span><span>throttling</span><span>:</span><span>
</span></span></span><span><span><span>            </span><span>enabled</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>            </span><span>duration</span><span>:</span><span> </span><span>10m</span><span>
</span></span></span><span><span><span>            </span><span>max-attempts</span><span>:</span><span> </span><span>30</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>        </span><span>bcrypt-cost</span><span>:</span><span> </span><span>4</span><span>
</span></span></span><span><span><span>        </span><span>verify-timeout</span><span>:</span><span> </span><span>&#34;32h&#34;</span><span>
</span></span></span><span><span><span>        </span><span>email-verification</span><span>:</span><span>
</span></span></span><span><span><span>            </span><span>enabled</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>            </span><span>password-reset</span><span>:</span><span>
</span></span></span><span><span><span>                </span><span>enabled</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>login-throttling</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>enabled</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>        </span><span>duration</span><span>:</span><span>  </span><span>1m</span><span>
</span></span></span><span><span><span>        </span><span>max-attempts</span><span>:</span><span> </span><span>3</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>skip-server-password</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>    </span><span>login-via-pass-command</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>    </span><span>require-sasl</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>enabled</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>        </span><span>exempted</span><span>:</span><span>
</span></span></span><span><span><span>            </span>- <span>&#34;localhost&#34;</span><span>
</span></span></span><span><span><span>            </span><span># - &#39;10.10.0.0/16&#39;</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>nick-reservation</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>enabled</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>        </span><span>additional-nick-limit</span><span>:</span><span> </span><span>1</span><span>
</span></span></span><span><span><span>        </span><span>method</span><span>:</span><span> </span><span>strict</span><span>
</span></span></span><span><span><span>        </span><span>allow-custom-enforcement</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>        </span><span>guest-nickname-format</span><span>:</span><span> </span><span>&#34;Privateer-*&#34;</span><span>
</span></span></span><span><span><span>        </span><span>force-guest-format</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>        </span><span>force-nick-equals-account</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>        </span><span>forbid-anonymous-nick-changes</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>multiclient</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>enabled</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>vhosts</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>enabled</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>        </span><span>max-length</span><span>:</span><span> </span><span>64</span><span>
</span></span></span><span><span><span>        </span><span>valid-regexp</span><span>:</span><span> </span><span>&#39;^[0-9A-Za-z.\-_/]+$&#39;</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>default-user-modes</span><span>:</span><span> </span><span>+i</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>auth-script</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>enabled</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>channels</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>default-modes</span><span>:</span><span> </span><span>+ntC</span><span>
</span></span></span><span><span><span>    </span><span>max-channels-per-client</span><span>:</span><span> </span><span>100</span><span>
</span></span></span><span><span><span>    </span><span>operator-only-creation</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>    </span><span>registration</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>enabled</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>        </span><span>operator-only</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>        </span><span>max-channels-per-account</span><span>:</span><span> </span><span>15</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>list-delay</span><span>:</span><span> </span><span>60s</span><span>
</span></span></span><span><span><span>    </span><span>invite-expiration</span><span>:</span><span> </span><span>24h</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>oper-classes</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>&#34;chat-moderator&#34;</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>title</span><span>:</span><span> </span><span>Moderator</span><span>
</span></span></span><span><span><span>        </span><span>capabilities</span><span>:</span><span>
</span></span></span><span><span><span>            </span>- <span>&#34;kill&#34;</span><span>      </span><span># disconnect user sessions</span><span>
</span></span></span><span><span><span>            </span>- <span>&#34;ban&#34;</span><span>       </span><span># ban IPs, CIDRs, NUH masks, and suspend accounts (UBAN / DLINE / KLINE)</span><span>
</span></span></span><span><span><span>            </span>- <span>&#34;nofakelag&#34;</span><span> </span><span># exempted from &#34;fakelag&#34; restrictions on rate of message sending</span><span>
</span></span></span><span><span><span>            </span>- <span>&#34;relaymsg&#34;</span><span>  </span><span># use RELAYMSG in any channel (see the `relaymsg` config block)</span><span>
</span></span></span><span><span><span>            </span>- <span>&#34;vhosts&#34;</span><span>    </span><span># add and remove vhosts from users</span><span>
</span></span></span><span><span><span>            </span>- <span>&#34;sajoin&#34;</span><span>    </span><span># join arbitrary channels, including private channels</span><span>
</span></span></span><span><span><span>            </span>- <span>&#34;samode&#34;</span><span>    </span><span># modify arbitrary channel and user modes</span><span>
</span></span></span><span><span><span>            </span>- <span>&#34;snomasks&#34;</span><span>  </span><span># subscribe to arbitrary server notice masks</span><span>
</span></span></span><span><span><span>            </span>- <span>&#34;roleplay&#34;</span><span>  </span><span># use the (deprecated) roleplay commands in any channel</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>&#34;server-admin&#34;</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>title</span><span>:</span><span> </span><span>Admin</span><span>
</span></span></span><span><span><span>        </span><span>extends</span><span>:</span><span> </span><span>&#34;chat-moderator&#34;</span><span>
</span></span></span><span><span><span>        </span><span>capabilities</span><span>:</span><span>
</span></span></span><span><span><span>            </span>- <span>&#34;rehash&#34;</span><span>       </span><span># rehash the server, i.e. reload the config at runtime</span><span>
</span></span></span><span><span><span>            </span>- <span>&#34;accreg&#34;</span><span>       </span><span># modify arbitrary account registrations</span><span>
</span></span></span><span><span><span>            </span>- <span>&#34;chanreg&#34;</span><span>      </span><span># modify arbitrary channel registrations</span><span>
</span></span></span><span><span><span>            </span>- <span>&#34;history&#34;</span><span>      </span><span># modify or delete history messages</span><span>
</span></span></span><span><span><span>            </span>- <span>&#34;defcon&#34;</span><span>       </span><span># use the DEFCON command (restrict server capabilities)</span><span>
</span></span></span><span><span><span>            </span>- <span>&#34;massmessage&#34;</span><span>  </span><span># message all users on the server</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>opers</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>supervisor</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>class</span><span>:</span><span> </span><span>&#34;server-admin&#34;</span><span>
</span></span></span><span><span><span>        </span><span>hidden</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>        </span><span>whois-line</span><span>:</span><span> </span><span>I&#39;m the supervisor, can I get a taxi number? </span><span>
</span></span></span><span><span><span>        </span><span># `ergo genpasswd`.</span><span>
</span></span></span><span><span><span>        </span><span>password</span><span>:</span><span> </span><span>&#34;$2a$04$...&#34;</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>logging</span><span>:</span><span>
</span></span></span><span><span><span>    </span>-<span>
</span></span></span><span><span><span>        </span><span>method</span><span>:</span><span> </span><span>stderr</span><span>
</span></span></span><span><span><span>        </span><span>type</span><span>:</span><span> </span><span>&#34;* -userinput -useroutput&#34;</span><span>
</span></span></span><span><span><span>        </span><span>level</span><span>:</span><span> </span><span>info</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>debug</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>recover-from-errors</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>lock-file</span><span>:</span><span> </span><span>&#34;ircd.lock&#34;</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>datastore</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>path</span><span>:</span><span> </span><span>ircd.db</span><span>
</span></span></span><span><span><span>    </span><span>autoupgrade</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>    </span><span>mysql</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>enabled</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>languages</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>enabled</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>    </span><span>default</span><span>:</span><span> </span><span>en</span><span>
</span></span></span><span><span><span>    </span><span>path</span><span>:</span><span> </span><span>languages</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>limits</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>nicklen</span><span>:</span><span> </span><span>32</span><span>
</span></span></span><span><span><span>    </span><span>identlen</span><span>:</span><span> </span><span>20</span><span>
</span></span></span><span><span><span>    </span><span>channellen</span><span>:</span><span> </span><span>64</span><span>
</span></span></span><span><span><span>    </span><span>awaylen</span><span>:</span><span> </span><span>390</span><span>
</span></span></span><span><span><span>    </span><span>kicklen</span><span>:</span><span> </span><span>390</span><span>
</span></span></span><span><span><span>    </span><span>topiclen</span><span>:</span><span> </span><span>390</span><span>
</span></span></span><span><span><span>    </span><span>monitor-entries</span><span>:</span><span> </span><span>100</span><span>
</span></span></span><span><span><span>    </span><span>whowas-entries</span><span>:</span><span> </span><span>100</span><span>
</span></span></span><span><span><span>    </span><span>chan-list-modes</span><span>:</span><span> </span><span>60</span><span>
</span></span></span><span><span><span>    </span><span>registration-messages</span><span>:</span><span> </span><span>1024</span><span>
</span></span></span><span><span><span>    </span><span>multiline</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>max-bytes</span><span>:</span><span> </span><span>4096</span><span> </span><span># 0 means disabled</span><span>
</span></span></span><span><span><span>        </span><span>max-lines</span><span>:</span><span> </span><span>100</span><span>  </span><span># 0 means no limit</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>fakelag</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>enabled</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>    </span><span>window</span><span>:</span><span> </span><span>1s</span><span>
</span></span></span><span><span><span>    </span><span>burst-limit</span><span>:</span><span> </span><span>5</span><span>
</span></span></span><span><span><span>    </span><span>messages-per-window</span><span>:</span><span> </span><span>2</span><span>
</span></span></span><span><span><span>    </span><span>cooldown</span><span>:</span><span> </span><span>5s</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>roleplay</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>enabled</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>history</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>enabled</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>    </span><span>channel-length</span><span>:</span><span> </span><span>2048</span><span>
</span></span></span><span><span><span>    </span><span>client-length</span><span>:</span><span> </span><span>256</span><span>
</span></span></span><span><span><span>    </span><span>autoresize-window</span><span>:</span><span> </span><span>2d</span><span>
</span></span></span><span><span><span>    </span><span>autoreplay-on-join</span><span>:</span><span> </span><span>20</span><span>
</span></span></span><span><span><span>    </span><span>chathistory-maxmessages</span><span>:</span><span> </span><span>1000</span><span>
</span></span></span><span><span><span>    </span><span>znc-maxmessages</span><span>:</span><span> </span><span>2048</span><span>
</span></span></span><span><span><span>    </span><span>restrictions</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>expire-time</span><span>:</span><span> </span><span>3d</span><span>
</span></span></span><span><span><span>        </span><span>query-cutoff</span><span>:</span><span> </span><span>&#39;join-time&#39;</span><span>
</span></span></span><span><span><span>        </span><span>grace-period</span><span>:</span><span> </span><span>1h</span><span>
</span></span></span><span><span><span>    </span><span>persistent</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>enabled</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>    </span><span>retention</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>allow-individual-delete</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>        </span><span>enable-account-indexing</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>    </span><span>tagmsg-storage</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>default</span><span>:</span><span> </span><span>false</span><span>
</span></span></span><span><span><span>        </span><span>whitelist</span><span>:</span><span>
</span></span></span><span><span><span>            </span>- <span>&#34;+draft/react&#34;</span><span>
</span></span></span><span><span><span>            </span>- <span>&#34;+react&#34;</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>allow-environment-overrides</span><span>:</span><span> </span><span>false</span><span>
</span></span></span></code></pre></div><p>Make sure to replace at least <code>my-ircd</code>, <code>xyz.onion</code>, and <code>$2a$04$...</code> with
values that make sense for your setup.</p><blockquote><p><strong>Note:</strong> This is an example configuration that <em>might</em> work for your use
case. It’s nevertheless a good idea to go through each individual setting and
make sure it’s what you want.</p></blockquote><div><pre tabindex="0"><code data-lang="txt"><span><span>Put the content of your message-of-the-day file here.
</span></span></code></pre></div><h2 id="supervisord">Supervisord</h2><p>To make sure our IRCd keeps running we’re going to install and configure
<code>supervisord</code>:</p><div><pre tabindex="0"><code data-lang="sh"><span><span>ircd# pkg_add supervisor
</span></span><span><span>ircd# cat /etc/supervisord.d/ircd.ini
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="ini"><span><span><span>[program:ircd]</span>
</span></span><span><span><span>command</span><span>=</span><span>ergo run --conf /etc/ircd.yaml</span>
</span></span><span><span><span>autostart</span><span>=</span><span>true</span>
</span></span><span><span><span>startsecs</span><span>=</span><span>5</span>
</span></span><span><span><span>startretries</span><span>=</span><span>5</span>
</span></span><span><span><span>autorestart</span><span>=</span><span>true</span>
</span></span><span><span><span>user</span><span>=</span><span>_ergo</span>
</span></span><span><span><span>environment</span><span>=</span><span>HOME=&#34;/home/_ergo&#34;,LC_ALL=&#34;en_US.UTF-8&#34;</span>
</span></span><span><span><span>directory</span><span>=</span><span>/home/_ergo</span>
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="sh"><span><span>ircd# rcctl <span>enable</span> supervisord
</span></span><span><span>ircd# rcctl start supervisord
</span></span></code></pre></div><h2 id="pf">PF</h2><p>Last but not least, add a basic firewall configuration:</p><div><pre tabindex="0"><code data-lang="cfg"><span><span><span>##########</span>
</span></span><span><span><span># Macros #</span>
</span></span><span><span><span>##########</span>
</span></span><span><span><span>minefield</span><span>=</span><span>&#34;1024:9999&#34;</span>
</span></span><span><span><span>ssh_alternate_port</span><span>=</span><span>31231</span>
</span></span><span><span>
</span></span><span><span><span>##########</span>
</span></span><span><span><span># Tables #</span>
</span></span><span><span><span>##########</span>
</span></span><span><span><span>table &lt;bruteforce&gt; persist</span>
</span></span><span><span><span>table &lt;troublemakers&gt; persist</span>
</span></span><span><span>
</span></span><span><span><span>###########</span>
</span></span><span><span><span># Options #</span>
</span></span><span><span><span>###########</span>
</span></span><span><span><span>set skip on lo</span>
</span></span><span><span>
</span></span><span><span><span>#########</span>
</span></span><span><span><span># Rules #</span>
</span></span><span><span><span>#########</span>
</span></span><span><span><span>block return    # Block stateless traffic</span>
</span></span><span><span><span>pass            # Establish keep-state</span>
</span></span><span><span>
</span></span><span><span><span># Block brute-forcers</span>
</span></span><span><span><span>block quick proto tcp from &lt;bruteforce&gt; \</span>
</span></span><span><span>  <span>to (egress) port $ssh_alternate_port</span>
</span></span><span><span><span>block quick proto tcp from &lt;troublemakers&gt; \</span>
</span></span><span><span>  <span>to (egress) port $ssh_alternate_port</span>
</span></span><span><span>
</span></span><span><span><span># By default, do not permit remote connections to X11</span>
</span></span><span><span><span>block return in on ! lo0 proto tcp to port 6000:6010</span>
</span></span><span><span>
</span></span><span><span><span># Port build user does not need network</span>
</span></span><span><span><span>block return out log proto {tcp udp} user _pbuild</span>
</span></span><span><span>
</span></span><span><span><span># Ergo user does not need network</span>
</span></span><span><span><span>block return out quick log proto {tcp udp} user _ergo</span>
</span></span><span><span>
</span></span><span><span><span># Tor user needs network</span>
</span></span><span><span><span>pass out on egress proto tcp user _tor</span>
</span></span><span><span>
</span></span><span><span><span># Connections that made it through to the SSH port but abusing it</span>
</span></span><span><span><span>pass proto tcp from any to (egress) \</span>
</span></span><span><span>  <span>port {$ssh_alternate_port} \</span>
</span></span><span><span>  <span>flags S/SA keep state \</span>
</span></span><span><span>  <span>(max-src-conn 5, max-src-conn-rate 5/5, \</span>
</span></span><span><span>  <span>overload &lt;bruteforce&gt; flush global \</span>
</span></span><span><span>  <span>)</span>
</span></span><span><span>
</span></span><span><span><span># Port 22 is a dead-giveaway </span>
</span></span><span><span><span># because we know we moved our SSH server</span>
</span></span><span><span><span># elsewhere. Anyone poking there is up to no good.</span>
</span></span><span><span><span>pass in on egress proto tcp \</span>
</span></span><span><span>  <span>from any \</span>
</span></span><span><span>  <span>to (egress) port { \</span>
</span></span><span><span>    <span>telnet, \</span>
</span></span><span><span>    <span>ssh, \</span>
</span></span><span><span>    <span>netbios-ns, \</span>
</span></span><span><span>    <span>netbios-ssn, \</span>
</span></span><span><span>    <span>microsoft-ds \</span>
</span></span><span><span>  <span>} \</span>
</span></span><span><span>  <span>synproxy state \</span>
</span></span><span><span>  <span>tag trouble</span>
</span></span><span><span>
</span></span><span><span><span># Tag stuff in the range $minefield as trouble ...</span>
</span></span><span><span><span>pass in on egress proto tcp from any to (egress) port $minefield \</span>
</span></span><span><span>  <span>synproxy state \</span>
</span></span><span><span>  <span>tag trouble</span>
</span></span><span><span>
</span></span><span><span><span># ... unless it&#39;s to our alternate port</span>
</span></span><span><span><span>pass in proto tcp from any to (egress) port $ssh_alternate_port tag good</span>
</span></span><span><span>
</span></span><span><span><span># Otherwise add to the troublemakers</span>
</span></span><span><span><span>pass proto tcp from any to (egress) port $ssh_alternate_port \</span>
</span></span><span><span>  <span>tagged trouble \</span>
</span></span><span><span>  <span>synproxy state \</span>
</span></span><span><span>  <span>(max-src-conn 1, max-src-conn-rate 1/10, \</span>
</span></span><span><span>  <span>overload &lt;troublemakers&gt; flush global \</span>
</span></span><span><span>  <span>)</span>
</span></span></code></pre></div><p>We’re pretty much done with the basic setup!</p><h2 id="connecting-to-the-ircd">Connecting to the IRCd</h2><p>From a client computer you can now configure your favorite IRC client to connect
to your new IRCd by …</p><ul><li>setting up a Tor client</li><li>configuring your IRC client to use the Tor client’s SOCKS proxy for
connections</li><li>adding a new connection to your Onion address, on port 6667</li></ul><p>I’m not going into these steps as these are different for every operating system
and IRC client. What I usually do is that I set up <a href="https://znc.in">ZNC</a> and Tor
on a dedicated VPS instance and use
<a href="https://github.com/rofl0r/proxychains-ng">proxychains-ng</a> to make ZNC connect
to all its IRC networks via its local Tor SOCKS proxy. This allows me to connect
from <a href="https://irssi.org">irssi</a> on <a href="https://xn--gckvb8fzb.com/computer/#cbrspc7">my workstation</a>, via a
clearnet VPN to ZNC, which in turn connects to multiple IRC networks via Tor
Hidden Service connections. IRC networks like for example
<a href="https://oftc.net">OFTC</a> allow connection via their Onion addresses.</p><p>By using ZNC in between my local IRC client and IRC servers I’m not only
increasing my own privacy on the networks but also avoid having to deal with
proxy configurations for irssi or the disconnects/timeouts that come with IRC
connections via Tor.</p></div></div>
  </body>
</html>
