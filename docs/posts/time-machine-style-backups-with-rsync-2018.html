<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://samuelhewitt.com/blog/2018-06-05-time-machine-style-backups-with-rsync">Original</a>
    <h1>Time Machine-style Backups with rsync (2018)</h1>
    
    <div id="readability-page-1" class="page"><article>
	
	<!-- published -->
	<small>Posted on <span>05 Jun 2018</span> <!-- by <span class="author">Sam Hewitt</span> --></small>
	<!-- tags -->
	
	
	<h2 id="data-hoarding-101">Data Hoarding 101</h2>

<p>I have digital backups of data, especially of my photos, going back almost a decade (I’m not that old) but it’s only recently that I got into creating time-snapshots of my backups, after I mistakenly deleted a bunch of (non-crucial) personal files with a stray <code>rsync --delete</code> on a directory I had not backed-up.</p>

<p>My home server used be <a href="https://samuelhewitt.com/blog/2015-09-12-debian-linux-server-mac-os-time-machine-backups-how-to">compatible with macOS’s Time Machine</a> and when I kept most things on my Mac that was useful, but I changed my data hoarding habits and that solution started to not be the optimal one.</p>

<!-- break -->

<h2 id="time-based-snapshots-using-rsync">Time Based Snapshots Using rsync</h2>

<p><code>rsync</code> has got to be one of my favourite and most used utilities. I use it constantly to transfer files between machine on my local network (and remote ones) but I’ve discovered it’s very useful as a backup tool. The following is a short script that uses <code>rsync</code> to create snapshots of the my data directory to another directory (they are mount points on two different drives):</p>

<div><div><pre><code><span>#!/bin/sh</span>

<span>TIMESTAMP</span><span>=</span><span>`</span><span>date</span> <span>&#34;+%Y-%m-%dT%H-%M-%S&#34;</span><span>`</span>
<span>USER</span><span>=</span>user
<span>SOURCEDIR</span><span>=</span>/var/data/backups
<span>TARGETDIR</span><span>=</span>/var/redundancy

<span># Create new backup using rsync and output to log</span>
rsync <span>-avPh</span> <span>--delete</span> <span>--link-dest</span><span>=</span><span>$TARGETDIR</span>/current <span>$SOURCEDIR</span>/<span>$USER</span>/ <span>$TARGETDIR</span>/<span>$USER</span>-<span>$TIMESTAMP</span> <span>&gt;</span> /var/log/rsync/<span>$TIMESTAMP</span>.log 2&gt;&amp;1

<span># check exit status to see if backup failed</span>
<span>if</span> <span>[</span> <span>&#34;</span><span>$?</span><span>&#34;</span> <span>=</span> 0 <span>]</span><span>;</span> <span>then</span>
    <span># Remove link to current backup</span>
    <span>rm</span> <span>-f</span> <span>$TARGETDIR</span>/current
    <span># Create link to the newest backup</span>
    <span>ln</span> <span>-s</span> <span>$TARGETDIR</span>/<span>$USER</span>-<span>$TIMESTAMP</span> <span>$TARGETDIR</span>/current
<span>else</span>
    <span># Rename directory if failed</span>
    <span>mv</span> <span>$TARGETDIR</span>/<span>$USER</span>-<span>$TIMESTAMP</span> <span>$TARGETDIR</span>/failed-<span>$USER</span>-<span>$TIMESTAMP</span>
<span>fi</span>
</code></pre></div></div>

<p>Essentially this script creates incremental copies of backups for a given user on the system by comparing any changes to that user’s data directory (<code>$SOURCEDIR</code>) with the current backup (<code>$TARGETDIR</code>) and making a new snapshot of any changes with the date.</p>

<p>Now all that remains is to save this script somewhere and create a <code>cron</code> job to run it on an automatic interval:</p>

<div><div><pre><code><span># daily at 5am</span>
0 5 <span>*</span> <span>*</span> <span>*</span> bash /usr/local/bin/rsync-time-machine
</code></pre></div></div>

<h3 id="hard-links">Hard Links</h3>

<p>This method uses rsync’s <code>--link-dest</code> option to create <a href="https://en.wikipedia.org/wiki/Hard_link">hard-links</a> so that isn’t duplicative of file data (the contents are only stored once, so you don’t use twice as much) and you can delete snapshots at will. (The links do still take up some space but it’s relatively insignificant.)</p>

<blockquote>
  <p>Be careful when deleting old snapshots. A new full backup of should be made before further incremental ones.
I have to give a shoutout to Mike Rubel whose <a href="http://www.mikerubel.org/computers/rsync_snapshots/">post</a> was helpful in coming up with this solution.</p>
</blockquote>

</article></div>
  </body>
</html>
