<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.openstatus.dev/blog/migration-backend-from-vercel-to-fly">Original</a>
    <h1>Migrating our backend from Vercel to Fly.io</h1>
    
    <div id="readability-page-1" class="page"><div><div><p>In this article we are going to see the reason that made us change our backend
to Fly.io and the challenges we had during the migrations.</p>
<p>We chose <a href="https://hono.dev/" target="_blank" rel="noopener noreferrer">Hono</a> as our API server with <a href="https://bun.sh/" target="_blank" rel="noopener noreferrer">Bun</a>
as the runtime and pick Fly.io as your hosting service.</p>
<h2 id="-why-did-we-want-to-move-our-backend-from-vercel">ü§î Why did we want to move our backend from Vercel?<a href="#-why-did-we-want-to-move-our-backend-from-vercel"><span></span></a></h2>
<h3 id="-a-lightweight-server">‚ö° A lightweight Server<a href="#-a-lightweight-server"><span></span></a></h3>
<p>We required a lightweight server with a simple REST API for our monitoring
endpoint. Deploying a simple Express server is possible, but it is not
specifically designed for this purpose.</p>
<p><code>It&#39;s possible to deploy an Express.js application as a single Serverless Function, but it comes with drawbacks and should only be used as a migration path. Instead, use Next.js or embrace multiple Serverless Functions as you incrementally migrate to the Vercel platform.</code></p>
<p><a href="https://vercel.com/guides/using-express-with-vercel" target="_blank" rel="noopener noreferrer">Source Vercel Doc</a></p>
<p>Also launching a clean and new Next.js server takes 2.5 seconds on my MacBook
Pro M1 and takes 110mb of RAM, and it includes unnecessary extra features from
Next.js. Our prod Next.js app takes about 5 seconds to launch on my computer
(contentlayer).</p>
<p><img src="https://www.openstatus.dev/assets/posts/migration-backend-from-vercel-to-fly/next-server.png" alt="Next server"/></p>
<p>For comparaison launching our current server takes 0.19ms and only takes 91mb.
Our current server stack is Hono + Bun.</p>
<p><img src="https://www.openstatus.dev/assets/posts/migration-backend-from-vercel-to-fly/hono-server.png" alt="Hono server"/></p>
<h3 id="-pricing">üí∏ Pricing<a href="#-pricing"><span></span></a></h3>
<p>We initially aimed to provide multi-region monitoring for all users while
maintaining a free tier. On Vercel, if you want a multi-region function, you
need to opt for Edge Functions. Edge functions are cost-effective as you only
pay for the actual CPU execution. This means that you won&#39;t be billed for idle
times when fetching data.</p>
<p>It&#39;s still affordable, but we are a bootstrap business and it difficult for us
to predict our monthly expenses. If we experience an increase in new users, our
costs will also increase accordingly.</p>
<p>Here&#39;s the math for the cost of one monitor for a user:</p>
<pre><code>6 (10 min monitors) * 24 * 30 * 3 (average execution unit per monitor) * 6 (number of regions) = 77,760 executions units per month

77,600 * (2/1,000,000) = 0.15c per monitor monthly
</code></pre>
<p>We have over 1000 monitors, and the monthly cost to run them would be $150.</p>
<p>While on fly we only have 6 servers with 2vcpu/512Mb It cost us $23.34 monthly
($3.89*6).</p>
<h2 id="-what-challenges-did-we-face-during-our-migrations">ü§Ø What challenges did we face during our migrations?<a href="#-what-challenges-did-we-face-during-our-migrations"><span></span></a></h2>
<h3 id="docker--monorepo--">Docker + monorepo = ü™®<a href="#docker--monorepo--"><span></span></a></h3>
<p>We are deploying to fly.io. We have to setup our app as a Docker image. Our apps
is in a monorepo. Our initial image was over 2 GB in size, which was excessively
large for a basic server.</p>
<p>Our image included everything, which was inefficient. After optimizing, our
image now occupies only 700MB. Although it is still somewhat large, it is a
significant improvement over our initial version.</p>
<p>It was something we never had to manage with Vercel deployment.</p>
<h3 id="-fly-deployment-timed">‚è≥ Fly deployment timed<a href="#-fly-deployment-timed"><span></span></a></h3>
<p>Our Fly deployments have been experiencing frequent timeouts without any
specific reason. The only solution we have discovered is to increase the timeout
duration.</p>
<pre><code>flyctl deploy --wait-timeout=500
</code></pre>
<p>Based on our experience, Fly deployments are generally less reliable compared
(more timed out) to Vercel deployments. Additionally, we have not discovered a
quick method to rollback to the previous version.</p>
<h3 id="-the-bun-bug">üêõ The Bun bug<a href="#-the-bun-bug"><span></span></a></h3>
<p>When we migrated to Fly, we decided to use Bun as our runtime. However, in the
first few hours after the migration, we observed an unexplained increase in
request failures.</p>
<p>After digging into the Bun GitHub we found a solution: We needed to set the
<code>keepalive</code> parameter to <code>false</code>. This is necessary because closed connections
are not automatically removed and remain in the Ôªø<code>CLOSE_WAIT</code> state.</p>
<p>Here&#39;s the GitHub issue:</p>
<p><a href="https://github.com/oven-sh/bun/issues/3327" target="_blank" rel="noopener noreferrer">https://github.com/oven-sh/bun/issues/3327</a></p>
<p>I wish it had been documented elsewhere.</p>
<h2 id="our-conclusion">Our conclusion<a href="#our-conclusion"><span></span></a></h2>
<p>We are pleased with our migration to Fly.io, although it was accompanied by a
challenging weekend. And we still love Vercel, they offer a super product, it
removes a lot of pain for the developers.However, if you require a hosting an
application other than Next.js, it may not be the best option.</p>
<p>We are still using it for our frontend.</p>
<p>Create an account on <a href="https://www.openstatus.dev/sign-up?ref=blog3" target="_blank" rel="noopener noreferrer">OpenStatus</a>
to start monitoring our website and managing your incidents for free.</p></div></div></div>
  </body>
</html>
