<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://neugierig.org/software/blog/2024/03/retrowin32-minesweeper-bug.html">Original</a>
    <h1>Retrowin32: Minesweeper and the Four Month Bug</h1>
    
    <div id="readability-page-1" class="page"><div>



<p><em>This post is part of a
<a href="https://neugierig.org/software/blog/2023/09/retrowin32.html">series on retrowin32</a>.</em></p>
<p><a href="https://github.com/evmar/retrowin32">retrowin32</a> now runs enough of Minesweeper
to let you sort of play it in your browser:</p>
<figure>
<img src="https://neugierig.org/software/blog/2024/03/minesweeper.png" width="192" height="258" alt="screenshot of minesweeper in browser"/>
<figcaption>Minesweeper; <a href="https://evmar.github.io/retrowin32/run.html?file=msvcrt.dll&amp;exe=winmine.exe">try it yourself</a></figcaption>
</figure>
<p>It is likely to crash if you explore it too far — for example, if you win it
attempts to bring up a &#34;you win&#34; dialog that triggers an unimplemented codepath
— but still! It kind of works!</p>
<p>Getting this working involved fleshing out a lot more of the Windows API. The
demoscene executables I had been focusing on up to this point mostly brought up
a window and sent pixels to it, while Minesweeper&#39;s startup pokes at the
registry, ini files, and in particular has a bunch of drawing code. If you click
&#34;view in debugger&#34; in the above UI and then &#34;imports&#34; you can see a list of all
of the various Windows API that this pulls in and which I have (partially)
implemented.</p>
<p>For example, the red numbers in the UI come from bottom-up bitmaps that are
stored as 4 bits per pixel and which are 13 pixels wide, so each row uses 6.5
bytes. I briefly went down a rabbithole of reasoning about generically decoding
these before I realized the BMP format uses padding.</p>
<p>Getting Minesweeper to render definitely makes this project feel more &#34;real&#34; and
I think is a cool demo, but I also am not really sure I ultimately want to
reimplement a bunch of old Windows APIs. For example, I looked a bit into
SkiFree. It has 1bpp bitmaps and various raster ops and I am just not too sure
it is interesting.</p>
<p>Introspecting, I think I looked at Minesweeper because I was curious to see how
hard it would be, but also because I was just avoiding The Big Scary Bug.</p>
<h2>The Big Scary Bug</h2>
<p><a href="https://neugierig.org/software/blog/2023/11/retrowin32-unicorn.html">Last November I posted about an emulator CPU bug</a>:
to resummarize, a demo worked when using Apple&#39;s CPU emulator but not mine, but
it manifested as just the demo doing the wrong thing and not as any smoking gun
crash.</p>
<p>Here are some of the approaches I have tried to isolate this bug over the last
few months:</p>
<ul>
<li><a href="https://neugierig.org/software/blog/2023/05/retrowin32-async-dll-tracing-zig.html">Tracing the executable on native Windows</a>
and my emulator and comparing execution traces; failed because native
execution is too different from my emulator</li>
<li><a href="https://neugierig.org/software/blog/2023/11/retrowin32-unicorn.html">Integrating a 3rd CPU emulator (Unicorn)</a>
and comparing execution traces; failed because I couldn&#39;t get Unicorn to
reliably report CPU state, possibly due to either bugs in it or how I
interacted with it</li>
<li>Figuring out
<a href="https://github.com/evmar/retrowin32/blob/main/lldb-trace.py">enough of the LLDB API</a>
to attempt to get it to dump an execution trace of running under Rosetta;
failed because I got the traces closer but they still just diverged at some
point, and also the LLDB API is very frustrating — how can I print an 80-bit
x86 float, still not even sure!</li>
</ul>
<p>In any case I put it all on the back burner while I fiddled with Minesweeper for
a bit.</p>
<p>Then today I was looking over my notes on different demos I had tried in the
emulator and for one my note on why it didn&#39;t work was &#34;uses lots of windows
apis, CreateDIBSection bitmap flags, SetTimer, etc&#34;. And I thought, huh, I
recently have implemented that kind of thing, I should try it again...</p>
<p>...and it gets much farther along, before of course encountering some other
problems, including that it somehow is underflowing the FPU stack. As I glanced
through some of the FPU code around its stack handling, I randomly noticed that
I had typo-misimplemented the <code>fild</code> instruction. It is supposed to take a
64-bit <em>integer</em> from memory and put it on the FPU stack (converting it to a
float), but I had made it take a 64-bit <em>float</em> from memory and put it on the
stack.</p>
<p>This did not fix this new demo, but apparently it did fix the four month long
bug. Argh.</p>
<h2>Test suite</h2>
<p>I think this is the third dumb typo bug I&#39;ve discovered in my FPU
implementation, where all three would have been caught if I had had even the
most trivial of tests (e.g. to test multiplication, &#34;does 2 * 3 produce 6?&#34;). I
noticed if I pasted some of the relevant code into an LLM
<a href="https://inuh.net/@evmar/112038779696641333">it was able to spot one</a>, but also
when I pasted the whole file into the same LLM it couldn&#39;t find those bugs nor
the new one. Someday soon though, maybe?</p>
<p>I have been circling around writing an x86 CPU test suite because I haven&#39;t been
sure exactly which way in which I want to test my implementation. There&#39;s of
course the &#34;does it work at all&#34; tests which would have caught these bugs, but
there are also lots of cases that would only be exercised by particular inputs,
like whether the overflow flag gets set based on particular combinations of
inputs. I have a basic approach at this that I have written in C but updating it
is pretty annoying; I even as far as building out
<a href="https://github.com/evmar/retrowin32/blob/b90b05de0a64800da2e63b8ee7b9a78f6047c805/.github/workflows/exe.yml#L38">GitHub CI goop to compile this C
via the MSVC toolchain</a>.
My most recent retrowin32 update,
<a href="http://localhost:8000/software/blog/2024/02/cross-compile.html">about cross-compiling Rust</a>,
was prompted exactly by the thought of writing this test suite in Rust.</p>
<p>One recent idea I had for those is that I could just exhaustively run all
combinations of inputs for the implementations of operations that involve 8-bit
integers — there are only 2**16 of them — and compare these against a native
CPU implementation. It has the downside that wouldn&#39;t flush out bugs in the 16
or 32-bit implementations, but for many of these I have written them as generics
over the operand size
(<a href="https://github.com/evmar/retrowin32/blob/b90b05de0a64800da2e63b8ee7b9a78f6047c805/x86/src/ops/math.rs#L43">example</a>)
so maybe it would be enough.</p>
<h2>Wine on Mac on Rosetta</h2>
<p>By the way, if you actually wanted to run Minesweeper on your Mac, recent
releases on Wine do
<a href="https://neugierig.org/software/blog/2023/08/x86-x64-aarch64.html">the 32-bit x86 on 64-bit Rosetta thing</a>
— after all, I learned about it from Wine — and Wine is a much more competent
implementation than mine. At this point you can just <code>brew install wine-stable</code>
and then <code>wine some.exe</code> and it will work, even on Apple silicon.</p>
<p>With that in hand, what is even the point of my own project? Of course, the
ultimate goal is just my own interest, but does Wine subsume its functionality?
It turns out the
<a href="https://www.pouet.net/prod.php?which=567">one demo that got me started on this whole thing</a>
still crashes under Rosetta due to an illegal instruction. Just guessing, but it
appears Rosetta doesn&#39;t implement the &#34;nested pointers&#34; variants of the
<a href="https://www.felixcloutier.com/x86/enter"><code>enter</code> instruction</a> that chillin
uses. So at least until they fix that, I still have a (totally made-up) purpose.</p>

</div></div>
  </body>
</html>
