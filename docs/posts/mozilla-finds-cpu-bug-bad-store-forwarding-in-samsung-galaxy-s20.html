<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1833315">Original</a>
    <h1>Mozilla finds CPU bug (bad store forwarding) in Samsung Galaxy S20</h1>
    
    <div id="readability-page-1" class="page"><div id="main-inner">










<section>
  <div>
  <div id="summary-container">
    <div id="field-status_summary">


  
    <p><span id="field-value-status_summary">
      <span data-status="closed">Closed</span>
      <span id="field-value-bug_id">
        <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1833315">Bug 1833315</a>
      </span>
      <span>
        <span>Opened <span title="2023-05-15 23:30 PDT" data-time="1684218626">3 months ago</span></span>
          <span>Closed <span title="2023-06-08 20:59 PDT" data-time="1686283188">2 months ago</span></span>
      </span>
        </span>
    </p>

  
</div>


    
  </div>
  </div>
</section>


<section id="module-categories">
    
  
</section>


<section id="module-tracking">
    
  
</section>



<section id="module-people">
    
  
</section>


<section id="module-references">
    
  
</section>


<section id="module-details">
    
  
</section>


<section id="module-crash-data">
    
  
</section>













<section id="module-attachments">
    
  
</section>







<meta name="firefox-versions" content="{&#34;FIREFOX_AURORA&#34;:&#34;&#34;,&#34;FIREFOX_DEVEDITION&#34;:&#34;117.0b4&#34;,&#34;FIREFOX_ESR&#34;:&#34;102.14.0esr&#34;,&#34;FIREFOX_ESR_NEXT&#34;:&#34;115.1.0esr&#34;,&#34;FIREFOX_NIGHTLY&#34;:&#34;118.0a1&#34;,&#34;LAST_MERGE_DATE&#34;:&#34;2023-07-31&#34;,&#34;LAST_RELEASE_DATE&#34;:&#34;2023-08-01&#34;,&#34;LAST_SOFTFREEZE_DATE&#34;:&#34;2023-07-27&#34;,&#34;LAST_STRINGFREEZE_DATE&#34;:&#34;2023-07-28&#34;,&#34;LATEST_FIREFOX_DEVEL_VERSION&#34;:&#34;117.0b4&#34;,&#34;LATEST_FIREFOX_OLDER_VERSION&#34;:&#34;3.6.28&#34;,&#34;LATEST_FIREFOX_RELEASED_DEVEL_VERSION&#34;:&#34;117.0b4&#34;,&#34;LATEST_FIREFOX_VERSION&#34;:&#34;116.0.2&#34;,&#34;NEXT_MERGE_DATE&#34;:&#34;2023-08-28&#34;,&#34;NEXT_RELEASE_DATE&#34;:&#34;2023-08-29&#34;,&#34;NEXT_SOFTFREEZE_DATE&#34;:&#34;2023-08-24&#34;,&#34;NEXT_STRINGFREEZE_DATE&#34;:&#34;2023-08-25&#34;}"/>



<div id="c0"><div id="ct-0" data-comment-id="16413312" data-ismarkdown="true"><p>This crash looks like a regression in Fenix 106 or a new crash signature from function inlining?</p>
<p>Crash report: <a href="https://crash-stats.mozilla.org/report/index/f585f1a9-0ed8-4dce-bc64-be8aa0230516" rel="nofollow">https://crash-stats.mozilla.org/report/index/f585f1a9-0ed8-4dce-bc64-be8aa0230516</a></p>
<p>Reason: <code>SIGSEGV / SEGV_MAPERR</code></p>
<p>Top 10 frames of crashing thread:</p>
<pre><code>0  libxul.so  js::StackUses  js/src/vm/BytecodeUtil.h:333
0  libxul.so  js::frontend::BytecodeSection::updateDepth  js/src/frontend/BytecodeSection.cpp:176
0  libxul.so  js::frontend::BytecodeEmitter::emitN  js/src/frontend/BytecodeEmitter.cpp:369
0  libxul.so  js::frontend::BytecodeEmitter::emitEnvCoordOp  js/src/frontend/BytecodeEmitter.cpp:792
0  libxul.so  js::frontend::NameOpEmitter::emitGet  js/src/frontend/NameOpEmitter.cpp:99
0  libxul.so  js::frontend::BytecodeEmitter::emitGetNameAtLocation  js/src/frontend/BytecodeEmitter.cpp:1537
0  libxul.so  js::frontend::BytecodeEmitter::emitGetName  js/src/frontend/BytecodeEmitter.h:690
0  libxul.so  js::frontend::BytecodeEmitter::emitGetName  js/src/frontend/BytecodeEmitter.cpp:1547
0  libxul.so  js::frontend::BytecodeEmitter::emitTree  js/src/frontend/BytecodeEmitter.cpp:11692
1  libxul.so  js::frontend::BytecodeEmitter::emitPropLHS  js/src/frontend/BytecodeEmitter.cpp:1635
</code></pre>
</div></div><div id="c1"><p>Matthew, I think you are already looking at this issue ;)</p><div><p>Severity: -- → S4</p><p>Flags: needinfo?(mgaudet)</p><p>Priority: -- → P3</p></div></div><div id="c2"><div id="ct-2" data-comment-id="16414158" data-ismarkdown="true"><p>This signature is covering three different crashes at least.</p>
<p>Looking at crash stats I&#39;ll note that of ~200 crashes, 95% are coming from Samsung mobiles. Almost all the samsung crashes have crash addresses ended in <code>fa9</code> -- which feels important but I&#39;m not sure what it means; they all appear to come to the same build IDs. Looking at the registers, there&#39;s a register with the crashing address (but aligned, ending in <code>fa8</code>). Unfortunately I can&#39;t see what instruction is being used to do the load, so I&#39;m not sure if this is like 1-past the end of a buffer or if we&#39;re doing an unaligned load where we ought to not be.</p>
<p>There&#39;s also a series of crashes at <code>0x0000087c</code>, all with the same install time (2023-05-09 17:49:58) -- these can be disregarded as bad hardware I suspect.</p>
<p><a href="https://crash-stats.mozilla.org/report/index/466b9608-946e-4b12-99c7-3e4050230514" rel="nofollow">At least one of these crashes from windows is pretty suspicious</a>. As much as the stack looks very real, it&#39;s reporting a <code>MOZ_RELEASE_ASSERT(pn_type &lt; ParseNodeKind::Limit)</code>, which is not used particularly nearby; it&#39;s unclear why this is the case.</p>
</div></div><div id="a48699_607045"><div><p>Flags: <span>needinfo?(mgaudet)</span></p></div></div><div id="c3"><p>This doesn&#39;t feel like an S4 to me given the crash volume. This is currently the #4 overall content process crash on Fenix release.</p><div><p>Flags: needinfo?(nicolas.b.pierron)</p></div></div><div id="c4"><p>I&#39;d be interested in Iain&#39;s thoughts on these crash patterns.</p><div><p>Severity: S4 → --</p><p>Flags: needinfo?(iireland)</p></div></div><div id="c5"><p>(Actually -- he&#39;s on PTO, nevermind. I&#39;ll take another look today)</p><div><p>Flags: needinfo?(iireland) → needinfo?(mgaudet)</p></div></div><div id="c6"><div><p>Flags: <span>needinfo?(mgaudet)</span></p></div></div><div id="c7"><div id="ct-7" data-comment-id="16426145" data-ismarkdown="true"><p>I think I&#39;ve finally managed to get the instructions out of the minidump. It says the faulting instruction pointer is 0x6c1b455dc0 and here&#39;s what I&#39;ve gotten with some work</p>
<pre><code>0x6c1b455da0	ldr x10, [x27, #0x28]
0x6c1b455da4	strb w23, [x10, x24]
0x6c1b455da8	ldrsb w10, [x9, #1]
0x6c1b455dac	ldr x9, [x27, #0x28]
0x6c1b455db0	tbnz w10, #0x1f, #0x6c1b455de8
0x6c1b455db4	add x11, x9, x24
0x6c1b455db8	ldrb w12, [x11]
0x6c1b455dbc	add x10, x19, x12, lsl #3
0x6c1b455dc0	ldrsb w13, [x10, #1]   &lt;-------- FAULTING INSTRUCTION HERE.
0x6c1b455dc4	tbnz w13, #0x1f, #0x6c1b4591ac
0x6c1b455dc8	and w11, w13, #0xff
0x6c1b455dcc	ldp w13, w12, [x27, #0xf0]
0x6c1b455dd0	ldrsb w10, [x10, #2]
0x6c1b455dd4	sub w11, w12, w11
</code></pre>
<p>So the unaligned access of <code>x10+1</code> is coming directly from the assembly. The origin of that value is <code>x19+ x12 &lt;&lt; 3</code> (previous instruction). Sure enough, doing this calculation using the values from one of the dumps seems to confirm that what I&#39;m seeing is real:</p>
<pre><code>js&gt; (0x000000700d6711d8 + (0x00000000ffffffba &lt;&lt; 3)).toString(16)
&#39;700d670fa8&#39;
</code></pre>
</div></div><div id="c8"><div id="ct-8" data-comment-id="16426217" data-ismarkdown="true"><p>Best guess is that these instructions are implementing</p>
<pre><code>   JSOp op = JSOp(*pc);
  int nuses = CodeSpec(op).nuses;
</code></pre>
<p>from <code>js::StackUses</code></p>
<p>Reading the back trace, it seems like we&#39;re emitting either a GetAliasedVar or GetAliasedDebugVar; we then call into <a href="https://hg.mozilla.org/releases/mozilla-release/file/8141476bccc7d2e2468b740df03954d6ab212248/js/src/frontend/BytecodeEmitter.cpp#l369" rel="nofollow"><code>emitN</code></a> where we set the initial value of the <a href="https://hg.mozilla.org/releases/mozilla-release/file/8141476bccc7d2e2468b740df03954d6ab212248/js/src/frontend/BytecodeEmitter.cpp#l361" rel="nofollow">bytecode pointer</a>.</p>
<p>Next we call <a href="https://hg.mozilla.org/releases/mozilla-release/file/8141476bccc7d2e2468b740df03954d6ab212248/js/src/frontend/BytecodeSection.cpp#l176" rel="nofollow">updateDepth at that offset</a> -- this reads back the immediately prior written bytecode. I don&#39;t know why this doesn&#39;t work on samsung phones, but I&#39;ll bet that this is the root cause -- see, under this theory, <code>x12</code> should be our <code>JSOp</code> -- but the actual value in the register we have is <code>0x00000000ffffffba</code> which is way out of bounds for our bytecode count.</p>
<p>Why this is happening now, in 113 where it didn&#39;t happen previously is totally unclear. For some reason clang is now emitting a sequence that is tripping this hardware issue?</p>
<p>I&#39;ve no idea how to resolve this. Patching this flow to avoid the read-after-write is awkward.</p>
</div></div><div id="c9"><div id="ct-9" data-comment-id="16426231" data-ismarkdown="true"><p>I tried to reverse engineer the assembly, but I do not see what it might corresponds to within StackUses:</p>
<pre><code>  unknown64_t* x19 = /* ??? */;
  size_t x12 = /* ??? */;
  unknown64_t* x10 = &amp;x19[x12];
  int8_t w13 = x10.one_byte_within;
  if (w13 % 32) {  // Potentially a switch statement condition with cases which are all below 32.
    return; // jump far further.
  }
  uint8_t w11 = w13 &amp; 0xff;
  uint64_t (w12, w13) = x27.some_field_in_large_struct; // offset of field 0xf0
  int8_t w10 = x10.two_bytes_within;
  uint16_t w11 = w12 - w11;  // x27.some_field_in_large_struct.first - x10.one_byte_within &amp; 0xff;
</code></pre>
<p>At first I thought x10 could be the CodeSpec, but I would not expect any condition to be added after loading <code>nuses</code>.</p>
<p>So I do not think this code belongs to StackUses as reported in the stack trace.</p>
<p>Right, this is potentially the <code>nuses</code> field which is being repeated before being tested elsewhere.</p>
</div></div><div id="c10">

  <p>Just in case it&#39;s helpful, i&#39;ve uploaded the -whole- disassembly I generated; the version in the comment was a snippet.</p></div><div id="c11"><div id="ct-11" data-comment-id="16427047" data-ismarkdown="true"><p>I am not sure what the assembly maps to. x19 is table of uint64_t struct indexed by a uint8_t. This would sounds like this is a table indexed by opcodes, but there are 2 occurrences where the field at offset 1 is compared against 32 (_ % 32 == 0, or _ &amp; 31 == 0) at 0x6c1b455db0 and 0x6c1b455dc4.</p>
<p>Also, given that 0x6c1b455da8 works, this is sounds quite unlikely that a failure would happen at 0x6c1b455dc0, especially since LRDB at 0x6c1b455db8 is suppose to read a single byte.</p>
<p>Could this be a sign issue? LDRB doing a sign extension in w12, which then causes problem when being used by reading the value from in incorrect memory page?</p>
<p>(In reply to Matthew Gaudet (he/him) [:mgaudet] from <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1833315#c7" title="RESOLVED FIXED - Crash in [@ js::StackUses] in js::frontend::BytecodeSection::updateDepth(js::frontend::BytecodeOffset) (Samsung CPU Issue)">comment #7</a>)</p>
<blockquote>
<pre><code>js&gt; (0x000000700d6711d8 + (0x00000000ffffffba &lt;&lt; 3)).toString(16)
&#39;700d670fa8&#39;
</code></pre>
</blockquote>
<p>Be careful JS shift operators only work with 32 bits values, and not 64 bits. Thus this is not the correct result here.</p>
</div></div><div id="c12"><p>I&#39;m at my own wits end on this one; I&#39;m going to leave this one in your hands</p></div><div id="c13"><div id="ct-13" data-comment-id="16433006" data-ismarkdown="true"><p>Poked at this a bit. It looks like everything&#39;s all been inlined together into one big pile of instructions and interleaved, but I think I&#39;ve made a bit of progress.</p>
<p>Consider these instructions from the beginning of Matt&#39;s assembly sequence:</p>
<pre><code>0x6c1b455d50	cmp w8, #6    
0x6c1b455d54	movn w9, #0x45   
0x6c1b455d58	cinc w23, w9, ne 
</code></pre>
<p>We are loading the constant ~0x45, then incrementing it if w8 is not 6. Interestingly, ~0x45 is 0xffffffba, which is precisely the mystery value that Matt found in x12. Later on, we have these instructions:</p>
<pre><code>0x6c1b455d7c	adrp x19, #0x6c1d6c5000
0x6c1b455d80	add x19, x19, #0x1d8
...
0x6c1b455d94	and x9, x23, #0xff
...
0x6c1b455d9c	add x9, x19, x9, lsl #3
...
0x6c1b455da8	ldrsb w10, [x9, #1]
</code></pre>
<p>The first two instructions load a hardcoded pointer. The next two compute <code>base_address + (our_mystery_register &amp; 0xff) &lt;&lt; 3</code>. This looks like we&#39;re finding an entry from the CodeSpecTable. The last instruction loads (and sign-extends) a value from the CodeSpec: specifically, nuses is at offset 1.</p>
<p><code>0xffffffba &amp; 0xff</code> is 0xba, which is JSOp::GetAliasedVar. 0xbb is JSOp::GetAliasedDebugVar. So the first set of instructions I pulled out maps to <a href="https://searchfox.org/mozilla-central/rev/0c2945ad4769e2d4428c72e6ddd78d60eb920394/js/src/frontend/NameOpEmitter.cpp#117-119" rel="nofollow">this code</a>, which we can confirm by noticing that NameLocation::Kind::EnvironmentCoordinate is 6, matching the hardcoded constant.</p>
<p>Staring at the rest of the code, I&#39;ve convinced myself that x27 is the BytecodeEmitter, and it&#39;s being used to reference the vector of bytecode we&#39;re emitting. A BytecodeEmitter contains a BytecodeSection at offset 32, which contains a BytecodeVector at offset 0. Doing the math, this means that x27+0x28 is <a href="https://searchfox.org/mozilla-central/rev/0c2945ad4769e2d4428c72e6ddd78d60eb920394/mfbt/Vector.h#402" rel="nofollow">mBegin</a>, x27+0x30 is the length, and x27+0x38 is the capacity. With that in mind, here&#39;s another interesting sequence of instructions. In this code, x23/w23 holds <code>0xffffffba</code>.</p>
<pre><code>0x6c1b455d4c	ldr x24, [x27, #0x30]     // x24 = offset (length of buffer before writing anything)
...	          
0x6c1b455da0	ldr x10, [x27, #0x28]     // x10 is address of buffer
0x6c1b455da4	strb w23, [x10, x24]      // write opcode in buffer at offset
...				          
0x6c1b455dac	ldr x9, [x27, #0x28]      // x9 is address of buffer
...				          
0x6c1b455db4	add x11, x9, x24          // x11 is offset of opcode we just wrote
0x6c1b455db8	ldrb w12, [x11]           // load the opcode
0x6c1b455dbc	add x10, x19, x12, lsl #3 // look it up in the codespec table
0x6c1b455dc0	ldrsb w13, [x10, #1]      // CRASH!
</code></pre>
<p>In short, we store the opcode in the buffer, then load it again to use as an index into the codespec table. The really interesting thing here is the ldrb. The ARM docs describe it as:</p>
<pre><code>LDRB Wt, addr
Load Byte: loads a byte from memory addressed by addr, then zero-extends it to Wt.
</code></pre>
<p>Since we just stored <code>0xba</code>, that&#39;s what x12 should contain. However, that&#39;s not what we&#39;re seeing. Looking at a dump, I see <code>x12 = 0x00000000ffffffba</code>. That&#39;s not zero-extended.</p>
<p>I have a strong suspicion that Samsung (or whoever designed this particular chip) messed up their store forwarding, and accidentally forwarded the entire register without clearing the upper bits.</p>
</div></div><div id="a1243656_24572"><div><p>Flags: <span>needinfo?(nicolas.b.pierron)</span></p></div></div><div id="c14"><div id="ct-14" data-comment-id="16433947" data-ismarkdown="true"><p>Marking as S3 given that we&#39;ve got some high-confidence this is a processor issue. The crash rate seems to have dropped a bit as well.</p>
<p>We&#39;ll need to investigate some mitigation if it keeps up</p>
</div></div><div id="c15"><div id="ct-15" data-comment-id="16444810" data-ismarkdown="true"><p>So this has started to spike even more.</p>
<p>At this point, it feels like we ought to do some refactoring to try to break sufficient dependencies that we no longer trigger this. I&#39;ll take a look at this shortly.</p>
</div><div><p>Severity: S3 → S2</p><p>Flags: needinfo?(mgaudet)</p><p>Summary: Crash in [@ js::StackUses] in js::frontend::BytecodeSection::updateDepth(js::frontend::BytecodeOffset) → Crash in [@ js::StackUses] in js::frontend::BytecodeSection::updateDepth(js::frontend::BytecodeOffset) (Samsung CPU Issue)</p></div></div><div id="c16">

  <p>The goal of this patch is to avoid the bad store forwarding on</p></div><div id="a1955977_600971"><div><p>Assignee: nobody → mgaudet</p><p>Status: NEW → ASSIGNED</p></div></div><div id="a2014545_607045"><div><p>Flags: <span>needinfo?(mgaudet)</span></p></div></div><div id="c18"><div id="ct-18" data-comment-id="16446130" data-ismarkdown="true"><p>Comment on <span><a href="https://bugzilla.mozilla.org/attachment.cgi?id=9337950" name="attach_9337950" title="Bug 1833315 - Pass JSOp along rather than recomputing r?iain">attachment 9337950</a> <a href="https://bugzilla.mozilla.org/attachment.cgi?id=9337950&amp;action=edit" title="Bug 1833315 - Pass JSOp along rather than recomputing r?iain">[details]</a></span></p>
<h3>Beta/Release Uplift Approval Request</h3>
<ul>
<li><strong>User impact if declined</strong>: Users of Samsung Galaxy S20s may continue to experience more crashes.</li>
<li><strong>Is this code covered by automated tests?</strong>: Yes</li>
<li><strong>Has the fix been verified in Nightly?</strong>: No</li>
<li><strong>Needs manual test from QE?</strong>: No</li>
<li><strong>If yes, steps to reproduce</strong>:</li>
<li><strong>List of other uplifts needed</strong>: None</li>
<li><strong>Risk to taking this patch</strong>: Low</li>
<li><strong>Why is the change risky/not risky? (and alternatives if risky)</strong>: A fairly trivial refactor intended to cause a hardware bug to no longer manifest</li>
<li><strong>String changes made/needed</strong>:</li>
<li><strong>Is Android affected?</strong>: Yes</li>
</ul>
<p>Note: this patch is attempting to remove a bad access pattern that manifests exclusively on Samsung Galaxy S20 (and Note 20) hardware. It&#39;s hard to say if this will actually -fix- the issue, but it&#39;s hoped that this will remove the proximate cause.</p>
</div></div><div id="c19"><div><p>Status: ASSIGNED → RESOLVED</p><p>Closed: <span title="2023-06-08 20:59 PDT" data-time="1686283188">2 months ago</span></p><p>Resolution: --- → FIXED</p><p>Target Milestone: --- → 116 Branch</p></div></div>



</div></div>
  </body>
</html>
