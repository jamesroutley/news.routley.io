<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://sm2n.ca/log/freebsd-nixos-vm-podman/">Original</a>
    <h1>Running FreeBSD in a VM on Linux to run a Linux container</h1>
    
    <div id="readability-page-1" class="page"><div>  <p>I wanted to try out FreeBSD’s recently added support for podman, the container management tool generally for linux. My computer runs NixOS (i.e Linux) though, so I decided to spin up a virtual machine to try it out in. I had some constraints though:</p>
<ul>
<li>The whole process should be rootless (i.e I shouldn’t need to use root privileges to spin up a VM)</li>
<li>Ideally it’s easy to clean up (i.e Starting the VM shouldn’t make a bunch of files on my system that I don’t know about)</li>
</ul>
<p>In the past I’d use libvirtd (gnome boxes, etc) for ad-hoc virtual machines and it fails on both counts. As far as I can tell, libvirtd tries to railroad you into using it as root, and it stores stuff in its own directory. There’s nothing wrong with that but it’s not what I want on my user system. It does support rootless usage but I couldn’t find documentation on how to do port forwarding. Finally, In rootful mode even if you don’t run as root (i.e by putting your user in the <code>libvirtd</code> group) my understanding is that access to the libvirtd socket should be considered implicit root access to the machine which disqualifies it from my day-to-day user account.</p>
<p>As far as I can tell for my usecase, all libvirt is doing is wrapping a “nicer” interface around constructing the qemu command line so I decided to cut out the middleman and run qemu manually. It’s simpler than you might think! Of course, libvirt shines more for more sophisticated usage but that’s not what this post is about.</p>
<h2 id="running-the-vm">Running the VM</h2>
<p>To start, we need to download FreeBSD. I grabbed the <a href="https://download.freebsd.org/releases/VM-IMAGES/15.0-RELEASE/amd64/Latest/FreeBSD-15.0-RELEASE-amd64-zfs.qcow2.xz">qcow2 vm disk image</a> from their website and then uncompressed it using <code>unxz</code>, which conveniently deletes the archive once it’s done.</p>
<pre tabindex="0" data-language="sh"><code><span><span>unxz</span><span> </span><span>FreeBSD-15.0-RELEASE-amd64-zfs.qcow2.xz</span></span></code></pre>
<p>Now all I need is <code>qemu</code>, which I don’t have installed so I will grab it with <code>nix shell</code>. On other distros you can use whatever your package manager is.</p>
<pre tabindex="0" data-language="sh"><code><span><span>nix</span><span> </span><span>shell</span><span> </span><span>nixpkgs#qemu</span></span></code></pre>
<p>qemu is now available in the shell to use, so we can do so.</p>
<pre tabindex="0" data-language="sh"><code><span><span>qemu-system-x86_64</span><span> </span><span>\</span></span>
<span><span> </span><span> </span><span>-drive</span><span> </span><span>file=FreeBSD-15.0-RELEASE-amd64-zfs.qcow2</span><span> </span><span>\</span></span>
<span><span> </span><span> </span><span>-accel</span><span> </span><span>kvm</span><span> </span><span>\</span></span>
<span><span> </span><span> </span><span>-smp</span><span> </span><span>4</span><span> </span><span>\</span></span>
<span><span> </span><span> </span><span>-m</span><span> </span><span>4G</span><span> </span><span>\</span></span>
<span><span> </span><span> </span><span>-nic</span><span> </span><span>user,hostfwd=tcp::60022-:22</span></span></code></pre>
<p>I gave it a generous amount of ram and cores (4 GB and 4 threads, respectively), but it doesn’t really matter. I originally didn’t set the ram and then I think freebsd’s <code>pkg</code> started swapping (there was some error printed along those lines). The important thing to include is <code>-accel kvm</code>—without it qemu has to actually emulate the cpu in software (very slow!), instead of asking the cpu for a hardware sandbox that it can run at ~full speed inside. Finally, we use qemu’s user networking to port forward TCP port 22 in the guest to port 60022 on the host so we can ssh into the VM. This is useful because using the VM monitor instead of an actual terminal sucks.</p>
<h2 id="making-it-usable-with-ssh">Making it usable with ssh</h2>
<p>Running this should pop up a window with FreeBSD. But it’s not very usable, so let’s ssh into it from a proper terminal emulator.</p>
<p>First we have to configure FreeBSD a bit. We can login with username: root and no password. The first thing we should do is set a password for root. This is not an optional step: sshing into root with no password will not work, even if you explicitly configure it to be allowed (trust me, I tried).</p>
<pre tabindex="0" data-language="sh"><code><span><span>passwd</span></span></code></pre>
<p>Once that’s done, we want to configure sshd to allow password logins and root logins. So edit the sshd config file with <code>vi /etc/ssh/sshd_config</code>, and change the following lines to match:</p>
<pre tabindex="0" data-language="plaintext"><code><span><span>PermitRootLogin</span><span> </span><span>yes</span></span>
<span><span>PasswordAuthentication</span><span> </span><span>yes</span></span></code></pre>
<p>Then we just need to enable sshd and we’re off to the races!</p>
<pre tabindex="0" data-language="sh"><code><span><span>service</span><span> </span><span>sshd</span><span> </span><span>enable</span></span>
<span><span>service</span><span> </span><span>sshd</span><span> </span><span>start</span></span></code></pre>
<p>Now on the host you should be able to ssh into the freebsd VM using the port forward we did earlier.</p>
<pre tabindex="0" data-language="sh"><code><span><span>ssh</span><span> </span><span>root@localhost</span><span> </span><span>-p</span><span> </span><span>60022</span></span></code></pre>
<h2 id="podman">podman</h2>
<p>Finally, we can get to what I wanted to mess around with. However, I’m going to punt on that in this post and refer to the <a href="https://freebsdfoundation.org/blog/oci-containers-on-freebsd/">post I followed</a>. I’ll just say that it does work, and I think it’s pretty cool.</p>
<pre tabindex="0" data-language="plaintext"><code><span><span>$</span><span> </span><span>ssh</span><span> </span><span>root@localhost</span><span> </span><span>-p</span><span> </span><span>60022</span></span>
<span><span>(root@localhost)</span><span> </span><span>Password</span><span> </span><span>for</span><span> </span><span>root@freebsd:</span></span>
<span><span>Last</span><span> </span><span>login:</span><span> </span><span>Wed</span><span> </span><span>Jan</span><span> </span><span>21</span><span> </span><span>03:52:20</span><span> </span><span>2026</span><span> </span><span>from</span><span> </span><span>10.0.2.2</span></span>
<span><span>FreeBSD</span><span> </span><span>15.0-RELEASE</span><span> </span><span>(GENERIC)</span><span> </span><span>releng/15.0-n280995-7aedc8de6446</span></span>
<span><span></span></span>
<span><span>Welcome</span><span> </span><span>to</span><span> </span><span>FreeBSD!</span></span>
<span><span></span></span>
<span><span>Release</span><span> </span><span>Notes,</span><span> </span><span>Errata:</span><span> </span><span>https://www.FreeBSD.org/releases/</span></span>
<span><span>Security</span><span> </span><span>Advisories:</span><span> </span><span> </span><span> </span><span>https://www.FreeBSD.org/security/</span></span>
<span><span>FreeBSD</span><span> </span><span>Handbook:</span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span>https://www.FreeBSD.org/handbook/</span></span>
<span><span>FreeBSD</span><span> </span><span>FAQ:</span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span>https://www.FreeBSD.org/faq/</span></span>
<span><span>Questions</span><span> </span><span>List:</span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span>https://www.FreeBSD.org/lists/questions/</span></span>
<span><span>FreeBSD</span><span> </span><span>Forums:</span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span>https://forums.FreeBSD.org/</span></span>
<span><span></span></span>
<span><span>Documents</span><span> </span><span>installed</span><span> </span><span>with</span><span> </span><span>the</span><span> </span><span>system</span><span> </span><span>are</span><span> </span><span>in</span><span> </span><span>the</span><span> </span><span>/usr/local/share/doc/freebsd/</span></span>
<span><span>directory,</span><span> </span><span>or</span><span> </span><span>can</span><span> </span><span>be</span><span> </span><span>installed</span><span> </span><span>later</span><span> </span><span>with:</span><span> </span><span> </span><span>pkg</span><span> </span><span>install</span><span> </span><span>en-freebsd-doc</span></span>
<span><span>For</span><span> </span><span>other</span><span> </span><span>languages,</span><span> </span><span>replace</span><span> </span><span>&#34;en&#34;</span><span> </span><span>with</span><span> </span><span>a</span><span> </span><span>language</span><span> </span><span>code</span><span> </span><span>like</span><span> </span><span>de</span><span> </span><span>or</span><span> </span><span>fr.</span></span>
<span><span></span></span>
<span><span>Show</span><span> </span><span>the</span><span> </span><span>version</span><span> </span><span>of</span><span> </span><span>FreeBSD</span><span> </span><span>installed:</span><span> </span><span> </span><span>freebsd-version</span><span> </span><span>;</span><span> </span><span>uname</span><span> </span><span>-a</span></span>
<span><span>Please</span><span> </span><span>include</span><span> </span><span>that</span><span> </span><span>output</span><span> </span><span>and</span><span> </span><span>any</span><span> </span><span>error</span><span> </span><span>messages</span><span> </span><span>when</span><span> </span><span>posting</span><span> </span><span>questions.</span></span>
<span><span>Introduction</span><span> </span><span>to</span><span> </span><span>manual</span><span> </span><span>pages:</span><span> </span><span> </span><span>man</span><span> </span><span>man</span></span>
<span><span>FreeBSD</span><span> </span><span>directory</span><span> </span><span>layout:</span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span>man</span><span> </span><span>hier</span></span>
<span><span></span></span>
<span><span>To</span><span> </span><span>change</span><span> </span><span>this</span><span> </span><span>login</span><span> </span><span>announcement,</span><span> </span><span>see</span><span> </span><span>motd(5).</span></span>
<span><span>root@freebsd:~</span><span> </span><span>#</span><span> </span><span>uname</span><span> </span><span>-a</span></span>
<span><span>FreeBSD</span><span> </span><span>freebsd</span><span> </span><span>15.0-RELEASE</span><span> </span><span>FreeBSD</span><span> </span><span>15.0-RELEASE</span><span> </span><span>releng/15.0-n280995-7aedc8de6446</span><span> </span><span>GENERIC</span><span> </span><span>amd64</span></span>
<span><span>root@freebsd:~</span><span> </span><span>#</span><span> </span><span>podman</span><span> </span><span>run</span><span> </span><span>-it</span><span> </span><span>--os=linux</span><span> </span><span>--rm</span><span> </span><span>docker.io/alpine</span><span> </span><span>sh</span></span>
<span><span>/</span><span> </span><span>#</span><span> </span><span>uname</span><span> </span><span>-a</span></span>
<span><span>Linux</span><span> </span><span>9a31763bdcbc</span><span> </span><span>5.15.0</span><span> </span><span>FreeBSD</span><span> </span><span>15.0-RELEASE</span><span> </span><span>releng/15.0-n280995-7aedc8de6446</span><span> </span><span>GENERIC</span><span> </span><span>x86_64</span><span> </span><span>Linux</span></span></code></pre>  </div></div>
  </body>
</html>
