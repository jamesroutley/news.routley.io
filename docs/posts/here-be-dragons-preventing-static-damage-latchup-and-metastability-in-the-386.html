<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://www.righto.com/2025/08/static-latchup-metastability-386.html">Original</a>
    <h1>Here be dragons: Preventing static damage, latchup, and metastability in the 386</h1>
    
    <div id="readability-page-1" class="page"><div id="post-body-3975009420599472603" itemprop="description articleBody">
<p>I&#39;ve been reverse-engineering the Intel 386 processor (from 1985), and I&#39;ve come across some interesting
circuits for the chip&#39;s input/output (I/O) pins.
Since these pins communicate with the outside world, they face special dangers:
static electricity and latchup can destroy the chip, while metastability can cause serious malfunctions.
These I/O circuits are completely different from the logic circuits in the 386, and I&#39;ve come
across a previously-undescribed flip-flop circuit, so I&#39;m
venturing into uncharted territory.
In this article, I take a close look at how the I/O circuitry protects the 386 from
the &#34;dragons&#34; that can destroy it.</p>
<p><a href="https://static.righto.com/images/386-iodrivers/die-pads.jpg"><img alt="The 386 die, zooming in on some of the bond pad circuits. The colors change due to the effects of different microscope lenses. Click this image (or any other) for a larger version." height="533" src="https://static.righto.com/images/386-iodrivers/die-pads-w500.jpg" title="The 386 die, zooming in on some of the bond pad circuits. The colors change due to the effects of different microscope lenses. Click this image (or any other) for a larger version." width="500"/></a></p><p>The 386 die, zooming in on some of the bond pad circuits. The colors change due to the effects of different microscope lenses. Click this image (or any other) for a larger version.</p>
<p>The photo above shows the die of the 386 under a microscope.
The dark, complex patterns arranged in rectangular regions arise from the two layers of metal that connect the circuits on the 386 chip.
Not visible are the transistors, formed from silicon and polysilicon and hidden beneath the metal.
Around the perimeter of this fingernail-sized silicon die, 141 square bond pads provide the connections between
the chip and the outside world; tiny gold bond wires connect the bond pads to the package.
Next to each I/O pad, specialized circuitry provides the electrical interface between the
chip and the external components while protecting the chip.
I&#39;ve zoomed in on three groups of these bond pads along with the associated I/O circuits.
The circuits at the top (for data pins) and the left (for address pins) are completely different from the
control pin circuits at the bottom, showing how the
circuitry varies with the pin&#39;s function.</p>
<h2>Static electricity</h2>
<p>The first dragon that threatens the 386 is static electricity, able to burn a hole in the chip.
MOS transistors are constructed with a thin insulating oxide layer
underneath the transistor&#39;s gate.
In the 386, this fragile, glass-like oxide layer is just 250 nm thick, the thickness of a virus.
Static electricity, even a small amount, can blow a hole through this oxide layer and
destroy the chip.
If you&#39;ve ever walked across a carpet and felt a spark when you touch a doorknob, you&#39;ve generated at least 3000 volts
of chip-destroying static electricity. <!-- 500 volts according to https://www.intel.com/content/www/us/en/docs/programmable/683251/current/esd-performance.html -->
Intel recommends an anti-static mat and a grounding wrist strap when installing a processor to
avoid the danger of static electricity, also known as Electrostatic Discharge or ESD.<span id="fnref:esd"><a href="#fn:esd">1</a></span></p>
<p>To reduce the risk of ESD damage, chips have protection diodes and other components in their I/O circuitry.
The schematic below shows the circuit for a typical 386 input.
The goal is to prevent static discharge from reaching the inverter, where it could destroy the inverter&#39;s transistors.
The diodes next to the pad provide the first layer of protection; they redirect excess voltage to the +5 rail or ground.
Next, the resistor reduces the current that can reach the inverter.
The third diode provides a final layer of protection.
(One unusual feature of this input—unrelated to ESD—is that the input has a pull-up, which is implemented with a transistor that acts like a 20KΩ resistor.<span id="fnref:bs16"><a href="#fn:bs16">2</a></span>)</p>
<p><a href="https://static.righto.com/images/386-iodrivers/bs16-schematic.jpg"><img alt="Schematic for the BS16# pad circuit. The BS16# signal indicates to the 386 if the external bus is 16 bits or 32 bits." height="129" src="https://static.righto.com/images/386-iodrivers/bs16-schematic-w550.jpg" title="Schematic for the BS16# pad circuit. The BS16# signal indicates to the 386 if the external bus is 16 bits or 32 bits." width="550"/></a></p><p>Schematic for the <code>BS16#</code> pad circuit. The <code>BS16#</code> signal indicates to the 386 if the external bus is 16 bits or 32 bits.</p>
<p>The image below shows how this circuit appears on the die.
For this photo, I dissolved the metal layers with acids, stripping the die down to the silicon to make the transistors visible.
The diodes and pull-up resistor are implemented with transistors.<span id="fnref:ggnmos"><a href="#fn:ggnmos">3</a></span>
Large grids of transistors form the pad-side diodes, while the third diode is above.
The pull-up resistor is implemented with polysilicon, which provides higher resistance than metal wiring.
The capacitor is implemented with a plate of polysilicon over silicon, separated by a thin oxide layer.
As you can see, the protection circuitry occupies much more area than the inverters that process the signal.</p>
<p><a href="https://static.righto.com/images/386-iodrivers/bs16-die.jpg"><img alt="The circuit for BS16# on the die. The green areas are where the oxide layer was incompletely removed." height="332" src="https://static.righto.com/images/386-iodrivers/bs16-die-w500.jpg" title="The circuit for BS16# on the die. The green areas are where the oxide layer was incompletely removed." width="500"/></a></p><p>The circuit for BS16# on the die. The green areas are where the oxide layer was incompletely removed.</p>
<h2>Latchup</h2>
<p>The transistors in the 386 are created by doping silicon with impurities to change its properties, creating regions of
&#34;N-type&#34; and &#34;P-type&#34; silicon.
The 386 chip, like most processors, is built from CMOS technology, so it uses two types of transistors: NMOS and PMOS.
The 386 starts from a wafer of N-type silicon and
PMOS transistors are formed by doping tiny regions to form P-type silicon embedded in the underlying N-type silicon.
NMOS transistors are the opposite, with N-type silicon embedded in P-type silicon.
To hold the NMOS transistors, &#34;wells&#34; of P-type silicon are formed, as shown in the cross-section diagram below.
Thus, the 386 chip contains complex patterns of P-type and N-type silicon that form its 285,000 transistors.</p>
<p><a href="https://static.righto.com/images/386-iodrivers/latchup-cross-section.jpg"><img alt="The structure of NMOS and PMOS transistors in the 386 forms parasitic NPN and PNP transistors. This diagram is the opposite of other latchup diagrams because the 386 uses N substrate, the opposite of modern chips with P substrate." height="244" src="https://static.righto.com/images/386-iodrivers/latchup-cross-section-w500.jpg" title="The structure of NMOS and PMOS transistors in the 386 forms parasitic NPN and PNP transistors. This diagram is the opposite of other latchup diagrams because the 386 uses N substrate, the opposite of modern chips with P substrate." width="500"/></a></p><p>The structure of NMOS and PMOS transistors in the 386 forms parasitic NPN and PNP transistors. This diagram is the opposite of other latchup diagrams because the 386 uses N substrate, the opposite of modern chips with P substrate.</p>
<p>But something dangerous lurks below the surface, the fire-breathing dragon of latchup waiting to burn up the chip.
The problem is that these regions of N-type and P-type silicon form unwanted, &#34;parasitic&#34; transistors underneath
the desired transistors.
In normal circumstances, these parasitic NPN and PNP transistors are inactive and can be ignored.
But if a current flows beneath the surface, through the silicon substrate,
it can turn on a parasitic transistor and awaken the dreaded latchup.<span id="fnref:substrate"><a href="#fn:substrate">4</a></span>
The parasitic transistors form a feedback loop, so if one transistor starts to turn on,
it turns on the other transistor, and so forth, until both transistors are fully on, a state called latchup.<span id="fnref:scr"><a href="#fn:scr">5</a></span>
Moreover, the feedback loop will maintain latchup until the chip&#39;s power is removed.<span id="fnref:power-cycle"><a href="#fn:power-cycle">6</a></span>
During latchup, the chip&#39;s power and ground are shorted through the parasitic transistors, causing high current flow that
can destroy the chip by overheating it or even melting bond wires.</p>
<p>Latchup can be triggered in many ways, from power supply overvoltage to radiation, but
a chip&#39;s I/O pins are the primary risk because signals from the outside world are unpredictable.
For instance, suppose a floppy drive is connected to the 386 and the drive sends a signal with a voltage higher than
the 386&#39;s 5-volt supply.
(This could happen due to a voltage surge in the drive, reflection in a signal line, or even connecting a cable.)
Current will flow through the 386&#39;s protection diodes, the diodes that were described in the previous section.<span id="fnref:latchup-recommendations"><a href="#fn:latchup-recommendations">7</a></span>
If this current flows through the chip&#39;s silicon substrate, it can trigger latchup and destroy the processor.</p>
<p>Because of this danger, the 386&#39;s I/O pads are designed to prevent latchup.
One solution is to block the unwanted currents through the substrate, essentially putting fences around the transistors
to keep malicious currents from escaping into the substrate.
In the 386, this fence consists of &#34;guard rings&#34; around the I/O transistors and diodes.
These rings prevent latchup by blocking unwanted current flow and safely redirecting it to power or ground.</p>
<p><a href="https://static.righto.com/images/386-iodrivers/wr-diagram.jpg"><img alt="The circuitry for the W/R# output pad. (The W/R# signal tells the computer&#39;s memory and I/O if the 386 is performing a write operation or a read operation.) I removed the metal and polysilicon to show the underlying silicon." height="394" src="https://static.righto.com/images/386-iodrivers/wr-diagram-w500.jpg" title="The circuitry for the W/R# output pad. (The W/R# signal tells the computer&#39;s memory and I/O if the 386 is performing a write operation or a read operation.) I removed the metal and polysilicon to show the underlying silicon." width="500"/></a></p><p>The circuitry for the W/R# output pad. (The W/R# signal tells the computer&#39;s memory and I/O if the 386 is performing a write operation or a read operation.) I removed the metal and polysilicon to show the underlying silicon.</p>
<p>The diagram above shows the double guard rings for a typical I/O pad.<span id="fnref:wr-schematic"><a href="#fn:wr-schematic">8</a></span>
Separate guard rings protect the NMOS transistors and the PMOS transistors.
The NMOS transistors have an inner guard ring of P-type silicon connected to ground (blue) and an outer guard ring of N-type silicon
connected to +5 (red). The rings are reversed for the PMOS transistors.
The guard rings take up significant space on the die, but this space isn&#39;t wasted since the rings protect the chip from latchup.</p>
<h2>Metastability</h2>
<p>The final dragon is metastability: it (probably) won&#39;t destroy the chip, but it can cause
serious malfunctions.<span id="fnref:spacecraft"><a href="#fn:spacecraft">9</a></span>
Metastability is a peculiar problem where a digital signal can take an unbounded amount of time to settle into
a zero or a one.
In other words, the circuit temporarily refuses to act digitally and shows its underlying analog nature.<span id="fnref:vonada"><a href="#fn:vonada">10</a></span>
Metastability was controversial in the 1960s and the 1970s, with many electrical engineers not believing it existed or
considering it irrelevant.
Nowadays, metastability is well understood, with special circuits to prevent it, but metastability can never
be completely eliminated.</p>
<p>In a processor, everything is synchronized to its clock.
While a modern processor has a clock speed of several gigahertz, the 386&#39;s clock ran at 12 to 33 megahertz.
Inside the processor, signals are carefully organized to change according to the clock—that&#39;s why your
computer runs faster with a higher clock speed.
The problem is that external signals may be independent of the CPU&#39;s clock.
For instance, a disk drive could send an interrupt to the computer when data is ready, which depends on the timing
of the spinning disk.
If this interrupt arrives at just the wrong time, it can trigger metastability.</p>
<p><a href="https://static.righto.com/images/386-iodrivers/metastability-1974.jpg"><img alt="A metastable signal settling to a high or low signal after an indefinite time. This image was used to promote a class on metastability in 1974. From My Work on All Things Metastable by Thomas Chaney." height="258" src="https://static.righto.com/images/386-iodrivers/metastability-1974-w350.jpg" title="A metastable signal settling to a high or low signal after an indefinite time. This image was used to promote a class on metastability in 1974. From My Work on All Things Metastable by Thomas Chaney." width="350"/></a></p><p>A metastable signal settling to a high or low signal after an indefinite time. This image was used to promote a class on metastability in 1974. From <a href="https://www.arl.wustl.edu/~jon.turner/cse/260/glitchChaney.pdf">My Work on All Things Metastable</a> by Thomas Chaney.</p>
<p>In more detail, processors use flip-flops to hold signals under the control of the clock.
An &#34;edge-triggered&#34; flip-flop grabs its
input at the moment the clock goes high (the &#34;rising edge&#34;) and holds this value until the next clock cycle.
Everything is fine if the value is stable when the clock changes:
if the input signal switches from low to high before the clock edge, the flip-flop will hold this high value.
And if the input signal switches from low to high <em>after</em> the clock edge, the flip-flop will hold the low value, since
the input was low at the clock edge.
But what happens if the input changes from low to high at the exact time that the clock switches?
Usually, the flip-flop will pick either low or high.
But very rarely, maybe a few times out of a billion, the flip-flop will hesitate in between, neither low nor high.
The flip-flop may take a few nanoseconds before it &#34;decides&#34; on a low or high value, and the value will be intermediate
until then.</p>
<p>The photo above illustrates a metastable signal, spending an unpredictable time between zero and one before settling
on a value.
The situation is similar to a ball balanced on top of a hill, a point of unstable equilibrium.<span id="fnref:physics"><a href="#fn:physics">11</a></span>
The smallest perturbation will knock the ball down one of the two stable positions at the bottom of the hill, but you
don&#39;t know which way it will go or how long it will take.</p>
<p><a href="https://static.righto.com/images/386-iodrivers/hill.jpg"><img alt="A metaphorical view of metastability as a ball on a hill, able to roll down either side." height="156" src="https://static.righto.com/images/386-iodrivers/hill-w300.jpg" title="A metaphorical view of metastability as a ball on a hill, able to roll down either side." width="300"/></a></p><p>A metaphorical view of metastability as a ball on a hill, able to roll down either side.</p>
<p>Metastability is serious because if a digital signal has a value that is neither 0 nor 1 then downstream
circuitry may get confused.
For instance, if part of the processor thinks that it received an interrupt and other parts of the processor think
that no interrupt happened, chaos will reign as the processor takes contradictory actions.
Moreover, waiting a few nanoseconds isn&#39;t a cure because the duration of metastability can be arbitrarily long.
Waiting helps, since the chance of metastability decreases exponentially with time, but there is no guarantee.<span id="fnref:metastability"><a href="#fn:metastability">12</a></span></p>
<p>The obvious solution is to never change an input exactly when the clock changes.
The processor is designed so that internal signals are stable when the clock changes, avoiding metastability.
Specifically, the designer of a flip-flop specifies the <em>setup</em> time—how long the signal must be stable before the clock edge—and the <em>hold</em> time—how long the signal must be stable after the clock edge.
As long as the input satisfies these conditions, typically a few picoseconds long,
the flip-flop will function without metastability.</p>
<p>Unfortunately, the setup and hold times can&#39;t be guaranteed when the processor receives an external signal that
isn&#39;t synchronized to its clock, known as an asynchronous signal.
For instance, a processor receives interrupt signals when an I/O device has data, but the timing is unpredictable
because it depends on 
mechanical factors such as a keypress or a spinning floppy disk.
Most of the time, everything will work fine, but what about the one-in-a-billion case where the timing of the
signal is unlucky?
(Since modern processors run at multi-gigahertz, one-in-a-billion events are not rare; they
can happen multiple times per second.)</p>
<p>One solution is a circuit called a synchronizer that takes an asynchronous signal and
synchronizes it to the clock.
A synchronizer can be implemented with two flip-flops in series:
even if the first flip-flop has a metastable output, chances are that it will resolve to 0 or 1 before the second flip-flop
stores the value.
Each flip-flop provides an exponential reduction in the chance of metastability, so using two flip-flops
drastically reduces the risk.
In other words, the circuit will still fail occasionally, but if the mean time between failures (MTBF) is long enough
(say, decades instead of seconds), then the risk is acceptable.</p>
<!--
The problem of metastability arises often in FPGA design, whenever a signal crosses a clock domain.
That is, if two parts of the FPGA use different clocks, the risk of metastability arises whenever
a signal is generated with one clock and used with another clock.
The standard FPGA solution is a synchronizer register chain with two flip-flops or more,
such as this [Intel recommendation](https://www.intel.com/content/www/us/en/docs/programmable/683082/21-3/synchronization-register-chains.html)
-->

<p><a href="https://static.righto.com/images/386-iodrivers/busy-schematic.jpg"><img alt="The schematic for the BUSY# pin, showing the flip-flops that synchronize the input signal." height="190" src="https://static.righto.com/images/386-iodrivers/busy-schematic-w400.jpg" title="The schematic for the BUSY# pin, showing the flip-flops that synchronize the input signal." width="400"/></a></p><p>The schematic for the BUSY# pin, showing the flip-flops that synchronize the input signal.</p>
<p>The schematic above shows how the 386 uses two flip-flops to minimize metastability.
The first flip-flop is a special flip-flop that is based on a sense amplifier.
It is much more complicated than a regular flip-flop, but it responds faster, reducing the
chance of metastability.
It is built from two of the sense-amplifier latches below, which I haven&#39;t seen described anywhere.
In a DRAM memory chip, a sense amplifier takes a weak signal from a memory cell and rapidly amplifies it into a
solid 0 or 1.
In this flip-flop, the sense amplifier takes a potentially ambiguous signal and rapidly amplifies it into a 0 or 1.
By amplifying the signal quickly, the flip-flop reduces metastability.
(See the footnote for details.<span id="fnref:sense-latch"><a href="#fn:sense-latch">14</a></span>)</p>
<p><a href="https://static.righto.com/images/386-iodrivers/sense-latch.jpg"><img alt="The sense amplifier latch circuit." height="436" src="https://static.righto.com/images/386-iodrivers/sense-latch-w350.jpg" title="The sense amplifier latch circuit." width="350"/></a></p><p>The sense amplifier latch circuit.</p>
<p>The die photo below shows how this circuitry looks on the die. Each flip-flop is built from two latches;
note that the sense-amp latches are larger than the standard latches.
As before, the pad has protection diodes inside guard rings. For some reason, however,
these diodes have a different structure from the transistor-based diodes described earlier.
The 386 has five inputs that use this circuitry to protect against metastability.<span id="fnref:metastable-pins"><a href="#fn:metastable-pins">13</a></span>
These inputs are all located together at the bottom of the die—it probably makes the layout more compact when
neighboring pad circuits are all the same size.</p>
<p><a href="https://static.righto.com/images/386-iodrivers/busy-die.jpg"><img alt="The circuitry for the BUSY# pin, showing the special sense-amplifier latches that reduce metastability." height="454" src="https://static.righto.com/images/386-iodrivers/busy-die-w500.jpg" title="The circuitry for the BUSY# pin, showing the special sense-amplifier latches that reduce metastability." width="500"/></a></p><p>The circuitry for the BUSY# pin, showing the special sense-amplifier latches that reduce metastability.</p>
<p>In summary, the 386&#39;s I/O circuits are interesting because they are completely different from the chip&#39;s regular logic circuitry.
In these circuits, the border between digital and analog breaks down; these circuits handle binary signals, but
analog issues dominate the design.
Moreover, hidden parasitic transistors play key roles; what you don&#39;t see can be more important than what you see.
These circuits defend against three dangerous &#34;dragons&#34;: static electricity, latchup, and metastability.
Intel succeeded in warding off these dragons and the 386 was a success.</p>
<p>For more on the 386 and other chips, follow me on
Mastodon (<a href="https://oldbytes.space/@kenshirriff">@<span data-cfemail="167d7378657e7f64647f707056797a72746f627365386566777573">[email protected]</span></a>),
Bluesky (<a href="https://bsky.app/profile/righto.com">@righto.com</a>),
or <a href="http://www.righto.com/feeds/posts/default">RSS</a>.  (I&#39;ve given up on Twitter.)
If you want to read more about 386 input circuits, I wrote about the clock pin <a href="https://www.righto.com/2023/11/intel-386-clock-circuit.html">here</a></p>
<h2>Notes and references</h2>
<div>
<ol>
<li id="fn:esd">
<p>Anti-static precautions are specified in Intel&#39;s <a href="https://www.intel.com/content/www/us/en/support/articles/000058166/processors.html">processor installation instructions</a>.
Also see Intel&#39;s <a href="https://www.intel.com/content/dam/www/public/us/en/documents/guides/ch3-esd-eos-guide.pdf">Electrostatic Discharge and Electrical Overstress Guide</a>.
I couldn&#39;t find ESD ratings for the 386, but a <a href="https://www.intel.com/content/www/us/en/docs/programmable/683251/current/esd-performance.html">modern Intel chip</a> is tested to withstand 500 volts or 2000 volts,
depending on the test procedure. <a href="#fnref:esd" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn:bs16">
<p>The BS16# pin is slightly unusual because it has an internal pull-up resistor.
If you look at the <a href="https://datasheets.chipdb.org/Intel/x86/386/datashts/23163011.pdf">datasheet</a> (9.2.3 and Table 9-3 footnotes),
a few input pins (ERROR#, BUSY#, and BS16#) have internal pull-up resistors of 20 KΩ, while the 
PEREQ input pin has an internal pull-down resistor of 20 KΩ. <a href="#fnref:bs16" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
<li id="fn:ggnmos">
<p>The protection diode is probably a <a href="https://en.wikipedia.org/wiki/GgNMOS">grounded-gate NMOS</a> (ggNMOS), an NMOS transistor with
the gate, source, and body (but not the drain) tied to ground. This forms a parasitic NPN transistor under the MOSFET that
dissipates the ESD.
(I think that the PMOS protection is the same, except the gate is pulled high, not grounded.)
For output pins, the output driver MOSFETs have parasitic transistors that make the output driver
&#34;self-protected&#34;.
One consequence is that the input pads and the output pads look similar (both have large MOS transistors),
unlike other chips where the presence of large transistors indicates an output.
(Even so, 386 outputs and inputs can be distinguished because outputs have large inverters inside the guard rings to drive the MOSFETs, while inputs do not.)
Also see <a href="https://ieeexplore.ieee.org/document/9646371">Practical ESD Protection Design</a>. <a href="#fnref:ggnmos" title="Jump back to footnote 3 in the text">↩</a></p>
</li>
<li id="fn:substrate">
<p>The 386 uses P-wells in an N-doped substrate. The substrate is heavily doped with antimony, with a lightly doped N
epitaxial layer on top. This doping helped provide immunity to latchup. (See &#34;High performance technology, circuits and packaging for the 80386&#34;, ICCD 1986.)
For the most part, modern chips use the opposite: N-wells with a P-doped substrate.
Why the substrate change?</p>
<p>In the earlier days of CMOS, P-well was standard due to the available doping technology,
see <a href="https://doi.org/10.1109/IEDM.1983.190465">N-well and P-well performance comparison</a>.
During the 1980s, there was controversy over which was better: P-well or N-well:
&#34;It is commonly agreed that P-well technology has a proven reliability record,
reduced alpha-particle sensitivity, closer matched p- and n- channel devices, and
high gain NPN structures. N-well proponents acknowledge better compatibility and
performance with NMOS processing and designs, good substrate quality, availability,
and cost, lower junction capacitance, and reduced body effects.&#34;
(See <a href="https://ucalgary.scholaris.ca/server/api/core/bitstreams/fd39e68c-1c60-4a26-8ac3-7f21a32a5108/content">Design of a CMOS Standard Cell Library</a>.)</p>
<p>As wafer sizes increased in the 1990s, technology shifted to P-doped substrates because it is difficult to make large N-doped wafers due to
the characteristics of the dopants (<a href="https://physics.stackexchange.com/a/162969/141705">link</a>).
Some chips optimize transistor characteristics by using both types of wells, called a twin-well process.
For instance, the Pentium used P-doped wafers and implanted both N and P wells.
(See
<a href="https://www.intel.com/content/dam/www/public/us/en/documents/research/1998-vol02-iss-3-intel-technology-journal.pdf">Intel&#39;s 0.25 micron, 2.0 volts logic process technology</a>.) <a href="#fnref:substrate" title="Jump back to footnote 4 in the text">↩</a></p>
</li>
<li id="fn:scr">
<p>You can also view the parasitic transistors as forming an SCR (Silicon Controlled Rectifier), a four-layer
semiconductor device.
SCRs were popular in the 1970s because they could handle higher currents and voltages than transistors.
But as high-power transistors were developed, SCRs fell out of favor.
In particular, once an SCR is turned on, it stays on until power is removed or reversed; this makes SCRs harder to
use than transistors.
(This is the same characteristic that makes latchup so dangerous.) <a href="#fnref:scr" title="Jump back to footnote 5 in the text">↩</a></p>
</li>
<li id="fn:power-cycle">
<p>Satellites and nuclear missiles have a high risk of latchup due to radiation.
Since radiation-induced latchup cannot always be prevented, 
one technique for dealing with latchup is to detect the excessive current from latchup and then power-cycle the chip.
For instance, you can buy a <a href="https://www.st.com/en/space-products/rhrpmicl1a.html">radiation-hardened current limiter chip</a> that will detect excessive current due to latchup and temporarily remove power;
this chip sells for the remarkable price of <a href="https://www.digikey.com/en/products/detail/stmicroelectronics/RH-PMICL1AK1/22106445">$1780</a>.</p>
<p>For more on latchup, see the Texas Instruments <a href="https://www.ti.com/lit/wp/scaa124/scaa124.pdf">Latch-Up</a> white
paper, as well as <a href="https://www.ti.com/lit/an/slya014a/slya014a.pdf">Latch-Up, ESD, and Other Phenomena</a>. <a href="#fnref:power-cycle" title="Jump back to footnote 6 in the text">↩</a></p>
</li>
<li id="fn:latchup-recommendations">
<p>The <a href="http://www.bitsavers.org/components/intel/80386/231732-001_80386_Hardware_Reference_Manual_1986.pdf#page=189">80386 Hardware Reference Manual</a>
discusses how a computer designer can prevent latchup in the 386.
The designer is assured that Intel&#39;s &#34;CHMOS III&#34; process prevents latchup under normal operating conditions.
However, exceeding the voltage limits on I/O pins can cause current surges and latchup.
Intel provides three guidelines: observe the maximum ratings for input voltages, never apply power to a 386 pin before the chip is powered up, and terminate I/O signals properly to avoid overshoot and undershoot. <a href="#fnref:latchup-recommendations" title="Jump back to footnote 7 in the text">↩</a></p>
</li>
<li id="fn:wr-schematic">
<p>The circuit for the WR# pin is similar to many other output pins.
The basic idea is that a large PMOS transistor pulls the output high, while a large NMOS transistor pulls the
output low.
If the <code>enable</code> input is low, both transistors are turned off and the output floats. (This allows other devices
to take over the bus in the HOLD state.)</p>
<p><a href="https://static.righto.com/images/386-iodrivers/wr-schematic.jpg"><img alt="Schematic for the WR# pin driver." height="167" src="https://static.righto.com/images/386-iodrivers/wr-schematic-w400.jpg" title="Schematic for the WR# pin driver." width="400"/></a></p><p>Schematic for the WR# pin driver.</p>
<p>The inverters that control the drive transistors have an unusual layout.
These inverters are inside the guard rings, meaning that the inverters are split apart, with the NMOS
transistors in one ring and PMOS transistors in the other.
The extra wiring adds capacitance to the output which probably makes the inverters slightly slower.</p>
<p>These inverters have a special design: one inverter is faster to go high than to go low,
while the other inverter is the opposite.
The motivation is that if both drive transistors are on at the same time,
a large current will flow through the transistors from power to
ground, producing an unwanted current spike (and potentially latchup).
To avoid this, the inverters are designed to turn one drive transistor off faster than turning the other one on.
Specifically, the high-side inverter has an extra transistor to quickly pull its output high, while the low-side inverter has an
extra transistor to pull the output low.
Moreover, the inverter&#39;s extra transistor is connected directly to the drive transistors, while the
inverter&#39;s main output connects through a longer polysilicon path with more resistance, providing an RC delay.
I found this layout very puzzling until I realized that the designers were carefully controlling the
turn-on and turn-off speeds of these inverters. <a href="#fnref:wr-schematic" title="Jump back to footnote 8 in the text">↩</a></p>
</li>
<li id="fn:spacecraft">
<p>In <a href="https://www.cs.unc.edu/~montek/teaching/Comp790-Fall11/Home/Home_files/ginosar-tutorial-dt-2011.pdf">Metastability and
Synchronizers: A Tutorial</a>,
there&#39;s a story of a spacecraft power supply being destroyed by metastability. Supposedly, metastability caused
the logic to turn on too many units, overloading and destroying the power supply.
I suspect that this is a fictional cautionary tale, rather than an actual incident.</p>
<p>For more on metastability, see <a href="https://classes.engineering.wustl.edu/cse464/images/6/60/Metastability.pdf">this presentation</a> and <a href="https://www.arl.wustl.edu/~jon.turner/cse/260/glitchChaney.pdf">this writeup</a> by Tom Chaney, one of the
early investigators of metastability. <a href="#fnref:spacecraft" title="Jump back to footnote 9 in the text">↩</a></p>
</li>
<li id="fn:vonada">
<p>One of Vonada&#39;s Engineering Maxims is &#34;Digital circuits are made from analog parts.&#34;
Another maxim is &#34;Synchronizing circuits may take forever to make a decision.&#34;
These maxims and a dozen others are from Don Vonada in DEC&#39;s 1978 book <a href="http://www.bitsavers.org/pdf/dec/_Books/Bell-ComputerEngineering.pdf#page=47">Computer Engineering</a>. <a href="#fnref:vonada" title="Jump back to footnote 10 in the text">↩</a></p>
</li>
<li id="fn:physics">
<p>Curiously, the definition of metastability in electronics doesn&#39;t match the definition in <a href="https://archive.org/details/penguindictionar00illi/page/297/mode/1up?q=metastable">physics</a> and <a href="https://archive.org/details/penguindictionar0000unse_k5h5/page/161/mode/1up?q=metastable">chemistry</a>.
In electronics, a metastable state is an unstable equilibrium.
In physics and chemistry, however, a metastable state is a stable state, just not the most stable ground state, so a
moderate perturbation will knock it from the metastable state to the ground state.
(In the hill analogy, it&#39;s as if the ball is caught in a small basin partway down the hill.) <a href="#fnref:physics" title="Jump back to footnote 11 in the text">↩</a></p>
</li>
<li id="fn:metastability">
<p>In case you&#39;re wondering what&#39;s going on with metastability at the circuit level, I&#39;ll give a brief explanation.
A typical flip-flop is based on a latch circuit like the one below, which consists of two inverters and an
electronic switch controlled by the clock.
When the clock goes high, the inverters are configured into a loop, latching the prior input value.
If the input was high, the output from the
first inverter is low and the output from the second inverter is high. The loop feeds this output back into the
first inverter, so the circuit is stable. Likewise, the circuit can be stable with a low input.</p>
<p><a href="https://static.righto.com/images/386-iodrivers/latch.jpg"><img alt="A latch circuit." height="109" src="https://static.righto.com/images/386-iodrivers/latch-w300.jpg" title="A latch circuit." width="300"/></a></p><p>A latch circuit.</p>
<p>But what happens if the clock flips the switch as the input is changing, so the input to the first inverter is
somewhere between zero and one?
We need to consider that an inverter is really an analog device, not a binary device.
You can describe it by a &#34;voltage transfer curve&#34; (purple line)
that specifies the output voltage for a particular input voltage. For example, if you put in a low input, you
get a high output, and vice versa.
But there is an equilibrium point where the output voltage is the same as the input voltage.
This is where metastability happens.</p>
<p><a href="https://static.righto.com/images/386-iodrivers/metastability.jpg"><img alt="The voltage transfer curve for a hypothetical inverter." height="266" src="https://static.righto.com/images/386-iodrivers/metastability-w400.jpg" title="The voltage transfer curve for a hypothetical inverter." width="400"/></a></p><p>The voltage transfer curve for a hypothetical inverter.</p>
<p>Suppose the input voltage to the inverter is the equilibrium voltage.
It&#39;s not going to be <em>precisely</em> the equilibrium voltage (because of noise if nothing else), so suppose,
for example, that it is 1µV above equilibrium.
Note that the transfer curve is very steep around equilibrium, say a slope of 100, so it will greatly amplify the
signal away from equilibrium.
Thus, if the input is 1µV above equilibrium, the output will be
100µV below equilibrium. Then the next inverter will amplify again,
sending a signal 10mV above equilibrium back to the first inverter. The distance will be amplified again,
now 1000mV below equilibrium. At this point, you&#39;re on the flat part of the curve, so the second inverter will
output +5V and the first inverter will output 0V, and the circuit is now stable.</p>
<p>The point of this is that the equilibrium voltage is an <em>unstable</em> equilibrium,
so the circuit will eventually settle
into the +5V or 0V states. But it may take an arbitrary number of loops through the inverters, depending on
how close the starting point was to equilibrium.
(The signal is continuous, so referring to &#34;loops&#34; is a simplification.)
Also note that the distance from equilibrium is amplified exponentially with time.
This is why the chance of metastability decreases exponentially with time. <a href="#fnref:metastability" title="Jump back to footnote 12 in the text">↩</a></p>
</li>
<li id="fn:metastable-pins">
<p>Looking at the die shows that the pins with metastability protection  are <code>INTR</code>, <code>NMI</code>, <code>PEREQ</code>, <code>ERROR#</code>,
and <code>BUSY#</code>.
The <a href="http://www.bitsavers.org/components/intel/80386/231732-001_80386_Hardware_Reference_Manual_1986.pdf#page=35">80386 Hardware Reference Manual</a> lists these same five pins as asynchronous—I like it when I spot something
unusual on the die and then discover that it matches an obscure statement in the documentation.
The interrupt pins <code>INTR</code> and <code>NMI</code> are asynchronous because they come from external sources that may not
be using the 386&#39;s clock. But what about 
<code>PEREQ</code>, <code>ERROR#</code>, and <code>BUSY#</code>?
These pins are part of the interface with an external math coprocessor (the 287 or 387 chip).
In most cases, the coprocessor uses the 386&#39;s clock. However, the 387 supported a little-used asynchronous mode
where the processor and the coprocessor could run at different speeds. <a href="#fnref:metastable-pins" title="Jump back to footnote 13 in the text">↩</a></p>
</li>
<li id="fn:sense-latch">
<p>The 386&#39;s metastability flip-flop is constructed with an unusual circuit. It has two latch stages (which is normal),
but instead of using two inverters in a loop, it uses a sense-amplifier circuit.
The idea of the sense amplifier is that it takes a differential input. When the clock enables the sense amplifier,
it drives the higher input high and the lower input low (the inputs are also the outputs).
(Sense amplifiers are used in dynamic RAM chips to amplify the tiny signals from a RAM cell to form a 0 or 1.
At the same time, the amplifier refreshes the DRAM cell by generating full voltages.)
Note that the sense amplifier&#39;s inputs also act as outputs; inputs during clock phase 1 and outputs during phase 2.</p>
<p>The schematic shows one of the latch stages; the complete flip-flop has a second stage, identical
except that the clock phases are switched.
This latch is much more complex than the typical 386 latch; 14 transistors versus 6 or 8.
The sense amplifier is similar to two inverters in a loop, except they share a limited power current
and a limited ground current.
As one inverter starts to go high, it &#34;steals&#34; the supply current from the other. Meanwhile, the other inverter
&#34;steals&#34; the ground current. Thus, a small difference in inputs is amplified, just as in a differential amplifier.
Thus, by combining the amplification of a differential amplifier with the amplification of the inverter loop,
this circuit reaches its final state faster than a regular inverter loop.</p>
<p>In more detail, during the first clock phase, the two inverters at the top generate the inverted and non-inverted
signals. (In a metastable situation, these will be close to the midpoint, not binary.)
During the second clock phase, the sense amplifier is activated. You can think of it as a differential amplifier with
cross-coupling.
If one input is slightly higher than the other, the amplifier pulls that input higher and the input lower,
amplifying the difference.
(The point is to quickly make the difference large enough to resolve the metastability.)</p>
<p>I couldn&#39;t find any latches like this in the literature.
<a href="https://doi.org/10.1109/ISQED.2010.5450482">Comparative Analysis and Study of Metastability on High-Performance Flip-Flops</a> describes eleven high-performance flip-flops.
It includes two flip-flops that are based on sense amplifiers, but their circuits are very different from the 386 circuit.
Perhaps the 386 circuit is an Intel design that was never publicized.
In any case, let me know if this circuit has an official name. <a href="#fnref:sense-latch" title="Jump back to footnote 14 in the text">↩</a></p>
</li>
</ol>
</div>

</div></div>
  </body>
</html>
