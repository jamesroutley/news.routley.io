<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://aless.co/automatic-release-management">Original</a>
    <h1>Automating Releases of @apollo/client</h1>
    
    <div id="readability-page-1" class="page"><div><p>This post is about the steps I took to automate <a href="https://github.com/apollographql/apollo-client"><code>@apollo/client</code></a>&#39;s release process with a tool called <a href="https://github.com/changesets/changesets">Changesets</a>. Hopefully it will save someone else implementing a similar workflow a few minutes in the future :)</p>
<h2 id="changesets"><a href="#changesets"><span></span></a>Changesets</h2>
<p>After comparing several options, <a href="https://github.com/changesets/changesets">Changesets</a> stood out as the library that would allow our team to adapt our existing manual workflow seamlessly.</p>
<p>Some of its features include:</p>
<ol>
<li>changelog entries written in Markdown at the time code is committed so both changelog and release notes can contain formatted code blocks, links, and other rich contextual information related to the change</li>
<li>an API for handling prereleases in long-running integration branches</li>
<li>a simple mechanism for batching changes into releases (changesets <code>.md</code> files themselves)</li>
<li>many other nice to haves, including <a href="https://github.com/changesets/changesets/blob/main/docs/snapshot-releases.md">snapshot releases</a></li>
</ol>
<p>IMO, the prerelease workflow is more interesting to discuss since its API <a href="https://github.com/changesets/changesets/issues/665">may undergo significant changes in v3</a> and it took a bit of experimentation before landing on the current approach, so let&#39;s take a look at the more straightforward release workflow first.</p>
<h2 id="releases"><a href="#releases"><span></span></a>Releases</h2>
<p>The basic premise of Changesets is that each change to your library (or librariesâ€”it was designed with monorepos in mind) is represented by a markdown file generated via <code>npx changeset</code>.</p>
<p>The CLI prompts you with two questions: whether your change represents a new patch/minor/major version, and for a description of the change. Once this info is entered, the CLI uses it to generate a new file inside of <code>.changeset</code>.</p>
<p>Here&#39;s an example of a recent Apollo Client changeset, <code>.changeset/gorgeous-buses-laugh.md</code>:</p>
<pre><code><span><span>---</span>
<span>&#39;@apollo/client&#39;: patch</span>
<span>---</span></span>

Adds <span>`TVariables`</span> generic to <span>`GraphQLRequest`</span> and <span>`MockedResponse`</span> interfaces.
</code></pre>
<p>In a monorepo, more than one package can be specified in the frontmatter block at the top. Once the PR containing the relevant change + changeset is merged to <code>main</code> the release workflow kicks off.</p>
<p>Here&#39;s an abridged + commented version of Apollo Client&#39;s <a href="https://github.com/apollographql/apollo-client/blob/main/.github/workflows/release.yml">release workflow</a>:</p>
<pre><code><span>name</span><span>:</span> Release

<span>on</span><span>:</span>
  <span>push</span><span>:</span>
    <span>branches</span><span>:</span>
      <span>-</span> main

<span>jobs</span><span>:</span>
  <span>release</span><span>:</span>
    
    <span>if</span><span>:</span> github.repository == &#39;apollographql/apollo<span>-</span>client&#39;

    <span>runs-on</span><span>:</span> ubuntu<span>-</span>latest
    <span>steps</span><span>:</span>
      <span>-</span> <span>name</span><span>:</span> Checkout repo
        <span>uses</span><span>:</span> actions/checkout@v3
        <span>with</span><span>:</span>
          
          
          <span>fetch-depth</span><span>:</span> <span>0</span>

      
      
      
      <span>-</span> <span>name</span><span>:</span> Append NPM token to .npmrc
      

      <span>-</span> <span>name</span><span>:</span> Create release PR or publish to npm + GitHub
        <span>id</span><span>:</span> changesets
        <span>uses</span><span>:</span> changesets/action@v1
        <span>with</span><span>:</span>
          
          
          <span>version</span><span>:</span> npx changeset<span>-</span>version <span>&amp;&amp;</span> npm i
          
          
          <span>publish</span><span>:</span> npm run build <span>&amp;&amp;</span> npx changeset publish <span>-</span><span>-</span> <span>-</span><span>-</span>tag next
        <span>env</span><span>:</span>
          <span>GITHUB_TOKEN</span><span>:</span> $<span>{</span><span>{</span> secrets.GITHUB_TOKEN <span>}</span><span>}</span>
          <span>NPM_TOKEN</span><span>:</span> $<span>{</span><span>{</span> secrets.NPM_TOKEN <span>}</span><span>}</span>

      
      <span>-</span> <span>name</span><span>:</span> Send a Slack notification on publish
        <span>if</span><span>:</span> steps.changesets.outcome == &#39;success&#39; <span>&amp;&amp;</span> steps.changesets.outputs.published == &#39;true&#39;
        
        
</code></pre>
<p>The first time this is run after merging a PR, changesets detects the new changeset file and opens a &#34;Versions Packages&#34; PR.</p>
<p><img alt="A screenshot of a Version Packages PR automatically created by the Changesets Action" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fversion.1186eee8.jpg&amp;w=1080&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fversion.1186eee8.jpg&amp;w=1920&amp;q=75 2x" src="https://aless.co/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fversion.1186eee8.jpg&amp;w=1920&amp;q=75" width="933" height="699" decoding="async" data-nimg="1" loading="lazy"/></p><p>Every time the release workflow runs on push events to the <code>main</code> branch, any unreleased changeset files are incorportated into the &#34;Version Packages&#34; PR and Changesets is smart enough to increment the package(s) version number(s) to the correct version.</p>
<p>By that I mean: if you have two unreleased changesets, one a <code>minor</code> change and one a <code>patch</code>, that results in a new minor version ðŸŽ‰ The automated &#34;Version Packages&#34; PR will update <code>CHANGELOG.md</code> listing minor/patch changes in separate sections, increment the version in <code>package.json</code> and lockfile, as well as removing the changeset markdown files for changes in the new release.</p>
<p>Merging this &#34;Version Packages&#34; PR is what will trigger the <code>changesets/action</code> to generate a new release ðŸ¥³</p>
<h2 id="prereleases"><a href="#prereleases"><span></span></a>Prereleases</h2>
<p>Prereleases work fairly similarly, but took some experimentation since entering &#34;prerelease mode&#34; generates a <code>pre.json</code> file that Changesets uses to track alpha releases.</p>
<p>Here&#39;s an example <code>pre.json</code> from Apollo Client&#39;s current <a href="https://github.com/apollographql/apollo-client/pull/10340"><code>release-3.8</code></a> branch:</p>
<pre><code><span>{</span>
  <span>&#34;mode&#34;</span><span>:</span> <span>&#34;pre&#34;</span><span>,</span>
  <span>&#34;tag&#34;</span><span>:</span> <span>&#34;alpha&#34;</span><span>,</span>
  <span>&#34;initialVersions&#34;</span><span>:</span> <span>{</span>
    <span>&#34;@apollo/client&#34;</span><span>:</span> <span>&#34;3.7.2&#34;</span>
  <span>}</span><span>,</span>
  <span>&#34;changesets&#34;</span><span>:</span> <span>[</span>
    <span>&#34;early-pens-retire&#34;</span><span>,</span>
    <span>&#34;polite-birds-rescue&#34;</span><span>,</span>
    <span>&#34;rude-mayflies-scream&#34;</span><span>,</span>
    <span>&#34;short-bikes-mate&#34;</span><span>,</span>
    <span>&#34;sixty-trains-sniff&#34;</span><span>,</span>
    <span>&#34;small-timers-shake&#34;</span><span>,</span>
    <span>&#34;wild-mice-nail&#34;</span>
  <span>]</span>
<span>}</span>
</code></pre>
<p>In other simpler prerelease workflows I&#39;ve seen in the wild, <code>pre.json</code> is repeatedly added and removed from the default branch, but that seemed like a nonstarter for Apollo Client with its many forks. I wanted to avoid ever committing <code>pre.json</code> to <code>main</code>.</p>
<p>Instead, Apollo Client:</p>
<ol>
<li>enters pre mode on all <code>release-x</code> branches by default</li>
<li>each new commit with a changeset opens a &#34;Version Packages (alpha)&#34; PR that functions the same as regular releases,</li>
<li><em>but</em> the version is monotonically increased, ie <code>3.8.0-alpha.0</code>, <code>3.8.0-alpha.1</code>, and so on</li>
<li>and only npm releases are generated (not GitHub releases)</li>
</ol>
<p>Apollo Client&#39;s <a href="https://github.com/apollographql/apollo-client/blob/main/.github/workflows/prerelease.yml"><code>prerelease.yml</code></a> looks like this:</p>
<pre><code>
<span>-</span> <span>name</span><span>:</span> Check for pre.json file existence
  <span>id</span><span>:</span> check_files
  <span>uses</span><span>:</span> andstor/file<span>-</span>existence<span>-</span>action@v2.0.0
  <span>with</span><span>:</span>
    <span>files</span><span>:</span> <span>&#39;.changeset/pre.json&#39;</span>



<span>-</span> <span>name</span><span>:</span> Enter alpha prerelease mode
  <span>if</span><span>:</span> steps.check_files.outputs.files_exists == &#39;false&#39; <span>&amp;&amp;</span> <span>!contains(github.event.head_commit.message</span><span>,</span> &#39;Exit prerelease&#39;)
  <span>run</span><span>:</span> npx changeset pre enter alpha

<span>-</span> <span>name</span><span>:</span> Create alpha release PR
  <span>uses</span><span>:</span> changesets/action@v1
  <span>with</span><span>:</span>
    <span>version</span><span>:</span> npm run changeset<span>-</span>version
  <span>env</span><span>:</span>
    <span>GITHUB_TOKEN</span><span>:</span> $<span>{</span><span>{</span> secrets.GITHUB_TOKEN <span>}</span><span>}</span>







<span>-</span> <span>name</span><span>:</span> get<span>-</span>npm<span>-</span>version
  <span>id</span><span>:</span> package<span>-</span>version
  <span>uses</span><span>:</span> martinbeentjes/npm<span>-</span>get<span>-</span>version<span>-</span>action@main

<span>-</span> <span>name</span><span>:</span> Run publish
  <span>id</span><span>:</span> changesets
  
  
  <span>if</span><span>:</span> steps.check_files.outputs.files_exists == &#39;true&#39; <span>&amp;&amp;</span> startsWith(github.event.head_commit.message<span>,</span> &#39;Version Packages&#39;)
  <span>run</span><span>:</span> npm run changeset<span>-</span>publish
</code></pre>
<p>Exiting pre mode has <a href="https://github.com/apollographql/apollo-client/blob/main/.github/workflows/exit-prerelease.yml#L1:L1">its own workflow</a> that does two things: removes <code>pre.json</code> and reverts the package number in <code>package.json</code> to the last released version in <code>main</code>, and a separate workflow <a href="https://github.com/apollographql/apollo-client/blob/main/.github/workflows/check-prerelease.yml#L1:L1"><code>check-prerelease.yml</code></a> makes sure <code>pre.json</code> will never be accidentally merged to main.</p>
<h2 id="conclusion"><a href="#conclusion"><span></span></a>Conclusion</h2>
<p>Working with Changesets has been a breath of fresh air! It&#39;s taken a lot of tedious and repetitive tasks out of the release process, and allowed us to focus on the fixes and features on our roadmap. Many thanks to the team that builds and maintains it ðŸ™Œ</p></div></div>
  </body>
</html>
