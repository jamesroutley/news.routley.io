<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://antonz.org/trying-chdb/">Original</a>
    <h1>Trying chDB, an embeddable ClickHouse engine</h1>
    
    <div id="readability-page-1" class="page"><div><div><article><div><div><header></header><p><a href="https://github.com/chdb-io/chdb">chDB</a> is an embeddable, in-process SQL OLAP engine powered by ClickHouse. It&#39;s as if SQLite and ClickHouse had an offspring (no offence to either party). chDB takes up ≈100mb of disk space, runs on smaller machines (even on a 64mb RAM container), and provides language bindings for Python, Node.js, Go, Rust and C/C++.</p><p>Let&#39;s get a taste of chDB with some interactive examples (you can run/edit them without leaving the browser or installing anything).</p><p><a href="#using-chdb">Using chDB</a> •
<a href="#sql-dialect">SQL dialect</a> •
<a href="#reading-data">Reading data</a> •
<a href="#writing-data">Writing data</a> •
<a href="#user-defined-functions">User-defined functions</a> •
<a href="#python-database-api">Python DB API</a> •
<a href="#current-status">Current status</a></p><h2 id="using-chdb">Using chDB</h2><p>It&#39;s as simple as <code>pip install chdb</code> and then:</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>import</span> <span>chdb</span>
</span></span><span><span>
</span></span><span><span><span>res</span> <span>=</span> <span>chdb</span><span>.</span><span>query</span>(<span>&#34;select 42&#34;</span>)
</span></span><span><span><span>print</span>(<span>res</span>, <span>end</span><span>=</span><span>&#34;&#34;</span>)
</span></span></code></pre></div><codapi-snippet sandbox="chdb-python" editor="basic"></codapi-snippet><p>Using a database engine to select the number <code>42</code> is probably not very exciting, but bear with me.</p><h2 id="sql-dialect">SQL dialect</h2><p>chDB is a wrapper around ClickHouse, so it supports exactly the same <a href="https://clickhouse.com/docs/en/sql-reference/syntax">SQL syntax</a>, including joins, CTEs, set operations, aggregations and window functions.</p><p>For example, let&#39;s create a sampled table of 10000 random numbers and calculate the mean and 95th percentile:</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>from</span> <span>chdb.session</span> <span>import</span> <span>Session</span>
</span></span><span><span>
</span></span><span><span><span>db</span> <span>=</span> <span>Session</span>()
</span></span><span><span><span>db</span><span>.</span><span>query</span>(<span>&#34;create database db&#34;</span>)
</span></span><span><span><span>db</span><span>.</span><span>query</span>(<span>&#34;use db&#34;</span>)
</span></span><span><span>
</span></span><span><span><span>db</span><span>.</span><span>query</span>(<span>&#34;&#34;&#34;
</span></span></span><span><span><span>create table data (id UInt32, x UInt32)
</span></span></span><span><span><span>engine MergeTree order by id sample by id
</span></span></span><span><span><span>as
</span></span></span><span><span><span>select number+1 as id, randUniform(1, 100) as x
</span></span></span><span><span><span>from numbers(10000);
</span></span></span><span><span><span>&#34;&#34;&#34;</span>)
</span></span><span><span>
</span></span><span><span><span>query_sql</span> <span>=</span> <span>&#34;&#34;&#34;
</span></span></span><span><span><span>select
</span></span></span><span><span><span>  avg(x) as &#34;avg&#34;,
</span></span></span><span><span><span>  round(quantile(0.95)(x), 2) as p95
</span></span></span><span><span><span>from data
</span></span></span><span><span><span>sample 0.1;
</span></span></span><span><span><span>&#34;&#34;&#34;</span>
</span></span><span><span>
</span></span><span><span><span>res</span> <span>=</span> <span>db</span><span>.</span><span>query</span>(<span>query_sql</span>, <span>&#34;PrettyCompactNoEscapes&#34;</span>)
</span></span><span><span><span>print</span>(<span>res</span>, <span>end</span><span>=</span><span>&#34;&#34;</span>)
</span></span></code></pre></div><codapi-snippet sandbox="chdb-python" editor="basic"></codapi-snippet><p>Note a couple of things here:</p><ul><li><code>Session</code> provides a stateful database connection (the data is stored in the temporary folder and discarded when the connection is closed).</li><li>The second argument to the <code>query</code> method specifies the output format. There are many <a href="https://doc.chdb.io/#/formats">supported formats</a> such as <code>CSV</code>, <code>SQLInsert</code>, <code>JSON</code> and <code>XML</code> (try changing the format in the above example and re-running the code). The default one is <code>CSV</code>.</li></ul><h2 id="reading-data">Reading data</h2><p>As with output formats, chDB supports any input format supported by ClickHouse.</p><p>For example, we can read a dataset from CSV:</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>query_sql</span> <span>=</span> <span>&#34;select * from &#39;employees.csv&#39;&#34;</span>
</span></span><span><span><span>res</span> <span>=</span> <span>chdb</span><span>.</span><span>query</span>(<span>query_sql</span>, <span>&#34;PrettyCompactNoEscapes&#34;</span>)
</span></span><span><span><span>print</span>(
</span></span><span><span>    <span>f</span><span>&#34;</span><span>{</span><span>res</span><span>.</span><span>rows_read</span>()<span>}</span><span> rows | &#34;</span>
</span></span><span><span>    <span>f</span><span>&#34;</span><span>{</span><span>res</span><span>.</span><span>bytes_read</span>()<span>}</span><span> bytes | &#34;</span>
</span></span><span><span>    <span>f</span><span>&#34;</span><span>{</span><span>res</span><span>.</span><span>elapsed</span>()<span>}</span><span> seconds&#34;</span>
</span></span><span><span>)
</span></span></code></pre></div><codapi-snippet sandbox="chdb-python" editor="basic" template="main.py" files="employees.csv"></codapi-snippet><p>Or work with an external dataset as if it were a database table:</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>query_sql</span> <span>=</span> <span>&#34;&#34;&#34;
</span></span></span><span><span><span>select distinct city
</span></span></span><span><span><span>from &#39;employees.csv&#39;
</span></span></span><span><span><span>&#34;&#34;&#34;</span>
</span></span><span><span>
</span></span><span><span><span>res</span> <span>=</span> <span>chdb</span><span>.</span><span>query</span>(<span>query_sql</span>, <span>&#34;CSV&#34;</span>)
</span></span><span><span><span>print</span>(<span>res</span>, <span>end</span><span>=</span><span>&#34;&#34;</span>)
</span></span></code></pre></div><codapi-snippet sandbox="chdb-python" editor="basic" template="main.py" files="employees.csv"></codapi-snippet><p>We can even query Pandas dataframes as if they were tables:</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>import</span> <span>chdb.dataframe</span> <span>as</span> <span>cdf</span>
</span></span><span><span><span>import</span> <span>pandas</span> <span>as</span> <span>pd</span>
</span></span><span><span>
</span></span><span><span><span>employees</span> <span>=</span> <span>pd</span><span>.</span><span>read_csv</span>(<span>&#34;employees.csv&#34;</span>)
</span></span><span><span><span>departments</span> <span>=</span> <span>pd</span><span>.</span><span>read_csv</span>(<span>&#34;departments.csv&#34;</span>)
</span></span><span><span>
</span></span><span><span><span>query_sql</span> <span>=</span> <span>&#34;&#34;&#34;
</span></span></span><span><span><span>select
</span></span></span><span><span><span>  emp_id, first_name,
</span></span></span><span><span><span>  dep.name as dep_name,
</span></span></span><span><span><span>  salary
</span></span></span><span><span><span>from __emp__ as emp
</span></span></span><span><span><span>    join __dep__ as dep using(dep_id)
</span></span></span><span><span><span>order by salary desc;
</span></span></span><span><span><span>&#34;&#34;&#34;</span>
</span></span><span><span>
</span></span><span><span><span>res</span> <span>=</span> <span>cdf</span><span>.</span><span>query</span>(<span>sql</span><span>=</span><span>query_sql</span>, <span>emp</span><span>=</span><span>employees</span>, <span>dep</span><span>=</span><span>departments</span>)
</span></span><span><span><span>print</span>(<span>res</span>, <span>end</span><span>=</span><span>&#34;&#34;</span>)
</span></span></code></pre></div><codapi-snippet sandbox="chdb-python" editor="basic" files="employees.csv departments.csv"></codapi-snippet><h2 id="writing-data">Writing data</h2><p>The easiest way to export data is to use the output format (the second parameter in the <code>query</code> method), and then write the data to disk:</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>from</span> <span>pathlib</span> <span>import</span> <span>Path</span>
</span></span><span><span>
</span></span><span><span><span>query_sql</span> <span>=</span> <span>&#34;select * from &#39;employees.csv&#39;&#34;</span>
</span></span><span><span><span>res</span> <span>=</span> <span>chdb</span><span>.</span><span>query</span>(<span>query_sql</span>, <span>&#34;Parquet&#34;</span>)
</span></span><span><span>
</span></span><span><span><span># export to Parquet</span>
</span></span><span><span><span>path</span> <span>=</span> <span>Path</span>(<span>&#34;/tmp/employees.parquet&#34;</span>)
</span></span><span><span><span>path</span><span>.</span><span>write_bytes</span>(<span>res</span><span>.</span><span>bytes</span>())
</span></span><span><span>
</span></span><span><span><span># import from Parquet</span>
</span></span><span><span><span>query_sql</span> <span>=</span> <span>&#34;select * from &#39;/tmp/employees.parquet&#39; limit 5&#34;</span>
</span></span><span><span><span>res</span> <span>=</span> <span>chdb</span><span>.</span><span>query</span>(<span>query_sql</span>, <span>&#34;PrettyCompactNoEscapes&#34;</span>)
</span></span><span><span><span>print</span>(<span>res</span>, <span>end</span><span>=</span><span>&#34;&#34;</span>)
</span></span></code></pre></div><codapi-snippet sandbox="chdb-python" editor="basic" template="main.py" files="employees.csv"></codapi-snippet><p>We can also easily convert the chDB result object into a PyArrow table:</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>query_sql</span> <span>=</span> <span>&#34;select * from &#39;employees.csv&#39;&#34;</span>
</span></span><span><span><span>res</span> <span>=</span> <span>chdb</span><span>.</span><span>query</span>(<span>query_sql</span>, <span>&#34;Arrow&#34;</span>)
</span></span><span><span>
</span></span><span><span><span>table</span> <span>=</span> <span>chdb</span><span>.</span><span>to_arrowTable</span>(<span>res</span>)
</span></span><span><span><span>print</span>(<span>table</span><span>.</span><span>schema</span>)
</span></span></code></pre></div><codapi-snippet sandbox="chdb-python" editor="basic" template="main.py" files="employees.csv"></codapi-snippet><p>Or Pandas dataframe:</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>query_sql</span> <span>=</span> <span>&#34;select * from &#39;employees.csv&#39;&#34;</span>
</span></span><span><span><span>res</span> <span>=</span> <span>chdb</span><span>.</span><span>query</span>(<span>query_sql</span>, <span>&#34;Arrow&#34;</span>)
</span></span><span><span>
</span></span><span><span><span>frame</span> <span>=</span> <span>chdb</span><span>.</span><span>to_df</span>(<span>res</span>)
</span></span><span><span><span>frame</span><span>.</span><span>info</span>()
</span></span></code></pre></div><codapi-snippet sandbox="chdb-python" editor="basic" template="main.py" files="employees.csv"></codapi-snippet><p>To persist a chDB session to a specific folder on disk, use the <code>path</code> constructor parameter. This way you can restore the session later:</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>from</span> <span>chdb.session</span> <span>import</span> <span>Session</span>
</span></span><span><span>
</span></span><span><span><span># create a persistent session</span>
</span></span><span><span><span>db</span> <span>=</span> <span>Session</span>(<span>path</span><span>=</span><span>&#34;/tmp/employees&#34;</span>)
</span></span><span><span>
</span></span><span><span><span># create a database and a table</span>
</span></span><span><span><span>db</span><span>.</span><span>query</span>(<span>&#34;create database db&#34;</span>)
</span></span><span><span><span>db</span><span>.</span><span>query</span>(<span>&#34;&#34;&#34;
</span></span></span><span><span><span>create table db.employees (
</span></span></span><span><span><span>  emp_id UInt32 primary key,
</span></span></span><span><span><span>  first_name String, last_name String,
</span></span></span><span><span><span>  birth_dt Date, hire_dt Date,
</span></span></span><span><span><span>  dep_id String, city String,
</span></span></span><span><span><span>  salary UInt32,
</span></span></span><span><span><span>) engine MergeTree;
</span></span></span><span><span><span>&#34;&#34;&#34;</span>)
</span></span><span><span>
</span></span><span><span><span># load data into the table</span>
</span></span><span><span><span>db</span><span>.</span><span>query</span>(<span>&#34;&#34;&#34;
</span></span></span><span><span><span>insert into db.employees
</span></span></span><span><span><span>select * from &#39;employees.csv&#39;
</span></span></span><span><span><span>&#34;&#34;&#34;</span>)
</span></span><span><span>
</span></span><span><span><span># ...</span>
</span></span><span><span><span># restore the session later</span>
</span></span><span><span><span>db</span> <span>=</span> <span>Session</span>(<span>path</span><span>=</span><span>&#34;/tmp/employees&#34;</span>)
</span></span><span><span>
</span></span><span><span><span># query the data</span>
</span></span><span><span><span>res</span> <span>=</span> <span>db</span><span>.</span><span>query</span>(<span>&#34;select count(*) from db.employees&#34;</span>)
</span></span><span><span><span>print</span>(<span>res</span>, <span>end</span><span>=</span><span>&#34;&#34;</span>)
</span></span></code></pre></div><codapi-snippet sandbox="chdb-python" editor="basic" files="employees.csv"></codapi-snippet><h2 id="user-defined-functions">User-defined functions</h2><p>We can define a function in Python and use it in chDB SQL queries.</p><p>Here is a <code>split_part</code> function that splits a string on the given separator and returns the resulting field with the given index (counting from one):</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>from</span> <span>chdb.udf</span> <span>import</span> <span>chdb_udf</span>
</span></span><span><span>
</span></span><span><span><span>@chdb_udf</span>()
</span></span><span><span><span>def</span> <span>split_part</span>(<span>s</span>, <span>sep</span>, <span>idx</span>):
</span></span><span><span>    <span>idx</span> <span>=</span> <span>int</span>(<span>idx</span>)<span>-</span><span>1</span>
</span></span><span><span>    <span>return</span> <span>s</span><span>.</span><span>split</span>(<span>sep</span>)[<span>idx</span>]
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>second</span> <span>=</span> <span>chdb</span><span>.</span><span>query</span>(<span>&#34;select split_part(&#39;a;b;c&#39;, &#39;;&#39;, 2)&#34;</span>)
</span></span><span><span><span>print</span>(<span>second</span>, <span>end</span><span>=</span><span>&#34;&#34;</span>)
</span></span></code></pre></div><codapi-snippet sandbox="chdb-python" editor="basic" template="main.py"></codapi-snippet><p>And here is a <code>sumn</code> function that calculates a sum from 1 to N:</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>from</span> <span>chdb.udf</span> <span>import</span> <span>chdb_udf</span>
</span></span><span><span>
</span></span><span><span><span>@chdb_udf</span>(<span>return_type</span><span>=</span><span>&#34;Int32&#34;</span>)
</span></span><span><span><span>def</span> <span>sumn</span>(<span>n</span>):
</span></span><span><span>    <span>n</span> <span>=</span> <span>int</span>(<span>n</span>)
</span></span><span><span>    <span>return</span> <span>n</span><span>*</span>(<span>n</span><span>+</span><span>1</span>)<span>//</span><span>2</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>sum20</span> <span>=</span> <span>chdb</span><span>.</span><span>query</span>(<span>&#34;select sumn(20)&#34;</span>)
</span></span><span><span><span>print</span>(<span>sum20</span>, <span>end</span><span>=</span><span>&#34;&#34;</span>)
</span></span></code></pre></div><codapi-snippet sandbox="chdb-python" editor="basic" template="main.py"></codapi-snippet><p>Currently chDB only supports scalar functions that take strings as parameters. If the function returns a type other than string, we should pass it as <code>return_type</code> to the <code>chdb_udf</code> decorator.</p><h2 id="python-database-api">Python Database API</h2><p>The chDB Python package adheres to the Python DB API (<a href="https://peps.python.org/pep-0249/">PEP 249</a>), so you can use it just like you&#39;d use stdlib&#39;s <code>sqlite3</code> module:</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>from</span> <span>contextlib</span> <span>import</span> <span>closing</span>
</span></span><span><span><span>from</span> <span>chdb</span> <span>import</span> <span>dbapi</span>
</span></span><span><span>
</span></span><span><span><span>print</span>(<span>f</span><span>&#34;chdb version: </span><span>{</span><span>dbapi</span><span>.</span><span>get_client_info</span>()<span>}</span><span>&#34;</span>)
</span></span><span><span>
</span></span><span><span><span>with</span> <span>closing</span>(<span>dbapi</span><span>.</span><span>connect</span>()) <span>as</span> <span>conn</span>:
</span></span><span><span>    <span>with</span> <span>closing</span>(<span>conn</span><span>.</span><span>cursor</span>()) <span>as</span> <span>cur</span>:
</span></span><span><span>        <span>cur</span><span>.</span><span>execute</span>(<span>&#34;select version()&#34;</span>)
</span></span><span><span>        <span>print</span>(<span>&#34;description:&#34;</span>, <span>cur</span><span>.</span><span>description</span>)
</span></span><span><span>        <span>print</span>(<span>&#34;data:&#34;</span>, <span>cur</span><span>.</span><span>fetchone</span>())
</span></span></code></pre></div><codapi-snippet sandbox="chdb-python" editor="basic"></codapi-snippet><h2 id="current-status">Current status</h2><p>chDB reached 1.0 in December 2023. It has the full power of ClickHouse under the hood, a team of passionate maintainers and a growing user base. The future looks bright and I wish chDB all the best!</p><p>──</p><p>P.S. <mark>Interactive examples in this post</mark> are powered by <a href="https://codapi.org/"><strong>codapi</strong></a> — an open source tool I&#39;m building. Use it to embed live code snippets into your product docs, online course or blog.</p><p><em><a href="https://antonz.org/subscribe/"><i></i> <strong>Subscribe</strong></a>
to keep up with new posts.</em></p></div></div></article></div></div></div>
  </body>
</html>
