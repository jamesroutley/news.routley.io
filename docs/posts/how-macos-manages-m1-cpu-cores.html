<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://eclecticlight.co/2022/04/25/how-macos-manages-m1-cpu-cores/">Original</a>
    <h1>How macOS manages M1 CPU cores</h1>
    
    <div id="readability-page-1" class="page"><div data-first_letter="I">
		<p>In conventional multi-core processors, like the Intel CPUs used in previous Mac models, all cores are the same. Allocating threads to cores is therefore a matter of balancing their load, in what’s termed <em>symmetric multiprocessing</em> (SMP).</p>
<p><span><img data-attachment-id="65065" data-permalink="https://eclecticlight.co/coremanintel/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanintel.png" data-orig-size="1028,1400" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="coremanintel" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanintel.png?w=220" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanintel.png?w=752" src="https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanintel.png?w=940" alt="coremanintel" srcset="https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanintel.png?w=940 940w, https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanintel.png?w=110 110w, https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanintel.png?w=220 220w, https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanintel.png?w=768 768w, https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanintel.png?w=752 752w, https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanintel.png 1028w" sizes="(max-width: 940px) 100vw, 940px"/></span></p>
<p>In Activity Monitor’s CPU History window, core load (as CPU %) is shown against time, with the oldest values at the left. Odd-numbered cores in the left half are real, and show the eight cores in the 8-Core Intel Xeon W under heavy load. Even-numbered cores in the right half are the virtual cores of Hyper-threading, engaged to cope with the heaviest load.</p>
<p>CPUs in Apple Silicon chips are different, as they contain two different core types, one designed for high performance (Performance, P or Firestorm cores), the other for energy efficiency (Efficiency, E or Icestorm cores). For these to work well, threads need to be allocated by core type, a task which can be left to apps and processes, as it is in <a href="https://asahilinux.org" target="_blank" rel="noopener">Asahi Linux,</a> or managed by the operating system, as it is in macOS. This article explains how macOS manages core allocation in all Apple’s M1 series chips, in what it terms <em>asymmetric multiprocessing</em> (AMP, although others prefer to call this <em>heterogeneous computing).</em></p>
<p><strong>Architecture</strong></p>
<p>There are two types of CPU core in M1 series chips:</p>
<ul>
<li>E cores contain roughly half the internal processing units of P cores, and have a maximum frequency of 2064 MHz.</li>
<li>P cores have a higher maximum frequency, of either 3204 MHz in the original M1, or 3228 MHz in M1 Pro/Max/Ultra.</li>
</ul>
<p>There are three configurations of CPU cores available in M1 series chips:</p>
<ul>
<li>the original M1, with 4 E and 4 P cores, in the MacBook Air, MacBook Pro 13-inch, iMac and Mac mini;</li>
<li>M1 Pro and Max, with 2 E and 8 P cores, in the MacBook Pro 14- and 16-inch, and Mac Studio Max;</li>
<li>M1 Ultra, with 4 E and 16 P cores, in the Mac Studio Ultra.</li>
</ul>
<p>Some MacBook Pro 14-inch notebooks have a reduced M1 Pro chip with only 6 P cores instead of 8.</p>
<p>To simplify the management of cores, macOS divides them functionally into clusters of 2-4 cores of the same type. Unfortunately, numbering of cores at a system level, as shown by tools such as <code>powermetrics</code>, and as displayed in Activity Monitor is different. For consistency with the latter, I here follow its core numbering, but number clusters in accordance with the system. The three chips have the following functional clusters as of macOS Monterey 12.3.1:</p>
<ul>
<li>the original M1 has one cluster of each type of core, E0 and P0, each containing 4 cores of the same type;</li>
<li>M1 Pro and Max have one cluster of 2 E cores (E0), and two clusters each containing 4 P cores (P0, P1);</li>
<li>M1 Ultra has one cluster of 4 E cores (E0), and four clusters each containing 4 P cores (P0, P1, P2, P3).</li>
</ul>
<p>All cores within any given cluster are run at the same frequency, and generally (but not always) have their load balanced within the cluster. There are occasions when load is distributed more unevenly, and in exceptional cases, certain threads may be allocated to only one core within a cluster.</p>
<p><strong>Thread control</strong></p>
<p>Unlike Asahi Linux, macOS doesn’t provide direct access to cores, core types, or clusters, at least not in public APIs. Instead, these are normally managed through Grand Central Dispatch using Quality of Service (QoS) settings, which macOS then uses to determine thread management policies.</p>
<p>Threads with the lowest QoS will only be run on the E cluster, while those with higher QoS can be assigned to either E or P clusters. The latter behaviour can be modified dynamically by the <code>taskpolicy</code> command tool, or by the <code>setpriority()</code> function in code. Those can constrain higher QoS threads to execution only on E cores, or on either E or P cores. However, they <a href="https://eclecticlight.co/2022/01/24/how-you-cant-promote-threads-on-an-m1/">cannot alter</a> the rule that lowest QoS threads are only executed on the E cluster.</p>
<p>macOS itself adopts a strategy where most, if not all, of its background tasks are run at lowest QoS. These include automatic Time Machine backups and Spotlight index maintenance. This also applies to compression and decompression performed by Archive Utility: for example, if you download a copy of Xcode in xip format, decompressing that takes a long time as much of the code is constrained to the E cores, and there’s no way to change that.</p>
<p><strong>Background threads</strong></p>
<p>Lowest QoS threads are loaded and run differently in original M1 and M1 Pro/Max chips, as they have different E cluster sizes.</p>
<p>In the original M1 chip, with 4 E cores, QoS 9 threads are run with the core frequency set at about 1000 MHz (1 GHz). What happens in the M1 Pro/Max with its 2 E cores is different: if there’s only one thread, it’s run on the cluster at a frequency of about 1000 MHz, but if there are two or more threads, the frequency is increased to 2064 MHz. This ensures that the E cluster in the M1 Pro/Max delivers at least the performance for background tasks as that in the original M1, at similar power consumption, despite the difference in size of the clusters.</p>
<p>Common exceptions to this are lowest QoS threads of processes such as <code>backupd</code>, which also undergo I/O throttling, and are run at a frequency of about 1000 MHz on the M1 Pro/Max.</p>
<p><strong>User threads</strong></p>
<p>All threads with a QoS higher than 9 are handled similarly, with differences resulting from the priority given to their queues.</p>
<p>As high QoS threads are eligible to be run on either of the core types and any core cluster, their management differs between M1 and M1 Pro/Max variants. On the original M1, with its single P cluster, batches of up to 8 threads can be distributed to the two available clusters, with 4 thread slots available on each. When there are 4 or fewer threads, they will be run on the P cluster whenever possible, and the E cluster is only recruited when there are more high QoS threads in the queue. P cores are run at a frequency of about 3 GHz, and E cores at about 2 GHz, twice the frequency normally used for QoS 9 threads.</p>
<p>M1 Pro and Max chips have a total of three clusters, two of 4 P cores each, plus the half-size 2-core E cluster. With up to 4 threads in the queue, they will be allocated to the first P cluster (P0); threads 5-8 will go to the second P cluster (P1), which would otherwise remain unloaded and inactive for economy. If there are a further 2 threads in the queue, they will be run on the E cores. Frequencies set are the maximum for the core type, to 3228 MHz on P0 and P1, and 2064 MHz on E0.</p>
<p>M1 Ultra chips have a total of five clusters, each with 4 cores. They follow the same policy as M1 Pro/Max chips, but with all 4 P clusters being loaded before E0 is used.</p>
<p>There are two situations in which code appears to run exclusively on a single core, though: during the boot process, before the kernel initialises and runs the other cores, code runs on just a single active E core. The other situation is when ‘preparing’ a downloaded macOS update before starting the installation process. On M1 Pro/Max chips, the 5 threads are given one core-worth of active residency, indicated as 100% CPU, but are confined to a single P core, the first in the first of the 2 P clusters (P0, labelled below as Core 3).</p>
<p><span><img data-attachment-id="64413" data-permalink="https://eclecticlight.co/oddcores02/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2022/03/oddcores02.jpg" data-orig-size="1360,1234" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="oddcores02" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2022/03/oddcores02.jpg?w=300" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2022/03/oddcores02.jpg?w=940" src="https://eclecticlightdotcom.files.wordpress.com/2022/03/oddcores02.jpg?w=940" alt="oddcores02" srcset="https://eclecticlightdotcom.files.wordpress.com/2022/03/oddcores02.jpg?w=940 940w, https://eclecticlightdotcom.files.wordpress.com/2022/03/oddcores02.jpg?w=150 150w, https://eclecticlightdotcom.files.wordpress.com/2022/03/oddcores02.jpg?w=300 300w, https://eclecticlightdotcom.files.wordpress.com/2022/03/oddcores02.jpg?w=768 768w, https://eclecticlightdotcom.files.wordpress.com/2022/03/oddcores02.jpg?w=1024 1024w, https://eclecticlightdotcom.files.wordpress.com/2022/03/oddcores02.jpg 1360w" sizes="(max-width: 940px) 100vw, 940px"/></span></p>
<p>This unusual distribution of active residency is sustained throughout the 30 minutes of preparation to install the update.</p>
<p><strong>Patterns under load</strong></p>
<p>The effects of macOS policies are shown in the following more typical examples taken from the CPU History window of Activity Monitor.</p>
<p><span><img data-attachment-id="65066" data-permalink="https://eclecticlight.co/coremanm1/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanm1.png" data-orig-size="1668,901" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="coremanm1" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanm1.png?w=300" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanm1.png?w=940" src="https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanm1.png?w=940" alt="coremanm1" srcset="https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanm1.png?w=940 940w, https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanm1.png?w=150 150w, https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanm1.png?w=300 300w, https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanm1.png?w=768 768w, https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanm1.png?w=1024 1024w, https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanm1.png 1668w" sizes="(max-width: 940px) 100vw, 940px"/></span></p>
<p>This original M1 chip is here being subjected to a series of loads from increasing numbers of CPU-intensive threads. Its 2 clusters, E0 and P0, are distinguished by the blue boxes. With 1-4 threads at high QoS (from the left), the load is borne entirely in the P0 cluster, then with 5-8 threads the E0 cluster takes its share.</p>
<p><span><img data-attachment-id="65067" data-permalink="https://eclecticlight.co/coremanm1pro/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanm1pro.png" data-orig-size="1924,1176" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="coremanm1pro" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanm1pro.png?w=300" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanm1pro.png?w=940" src="https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanm1pro.png?w=940" alt="coremanm1pro" srcset="https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanm1pro.png?w=940 940w, https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanm1pro.png?w=1880 1880w, https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanm1pro.png?w=150 150w, https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanm1pro.png?w=300 300w, https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanm1pro.png?w=768 768w, https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanm1pro.png?w=1024 1024w" sizes="(max-width: 940px) 100vw, 940px"/></span></p>
<p>This M1 Pro chip is under heavy and changing load from many threads, some of which are at background QoS, while others are at higher QoS. While much of the load is borne by the 2 cores in the E0 cluster, P0 is also loaded for much of the time, and P1 is recruited to take some of the peak.</p>
<p><span><img data-attachment-id="65068" data-permalink="https://eclecticlight.co/coremanultra/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanultra.png" data-orig-size="2242,1975" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="coremanultra" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanultra.png?w=300" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanultra.png?w=940" src="https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanultra.png?w=940" alt="coremanultra" srcset="https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanultra.png?w=940 940w, https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanultra.png?w=1880 1880w, https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanultra.png?w=150 150w, https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanultra.png?w=300 300w, https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanultra.png?w=768 768w, https://eclecticlightdotcom.files.wordpress.com/2022/04/coremanultra.png?w=1024 1024w" sizes="(max-width: 940px) 100vw, 940px"/></span></p>
<p>I have rearranged the cores shown in this example from an M1 Ultra to separate them into their clusters, with E0 at the top, and P0 to P3 in two columns below. Loads shown here are typical of those during the first few minutes after login, with heavy load on E0 and P0, which spills over to P1-3 during the early peak.</p>
<p>One important piece of information about M1 cores not (yet) provided by Activity Monitor is cluster frequency. A cluster running at 100% CPU (equivalent to active residency) with a frequency of less than 1000 MHz is completing instructions at less than half the rate of the same cluster at 100% CPU and a frequency of 2064 MHz. Unfortunately, the only accessible means of obtaining frequency information at present is the command tool <code>powermetrics</code>.</p>
<p>A summary of macOS management of CPU cores in the original M1, M1 Pro and Max chips is given in the diagram below. As I complete information about the M1 Ultra, I will incorporate that in the next revision. If you have an M1 Ultra, are familiar with <code>powermetrics</code>, and would like to help, I’d be delighted to work with you.</p>
<p><span><img data-attachment-id="63405" data-permalink="https://eclecticlight.co/schedulingthreadsm1/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2022/01/schedulingthreadsm1.jpg" data-orig-size="2480,1748" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="schedulingThreadsM1" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2022/01/schedulingthreadsm1.jpg?w=300" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2022/01/schedulingthreadsm1.jpg?w=940" src="https://eclecticlightdotcom.files.wordpress.com/2022/01/schedulingthreadsm1.jpg?w=940" alt="schedulingThreadsM1" srcset="https://eclecticlightdotcom.files.wordpress.com/2022/01/schedulingthreadsm1.jpg?w=940 940w, https://eclecticlightdotcom.files.wordpress.com/2022/01/schedulingthreadsm1.jpg?w=1880 1880w, https://eclecticlightdotcom.files.wordpress.com/2022/01/schedulingthreadsm1.jpg?w=150 150w, https://eclecticlightdotcom.files.wordpress.com/2022/01/schedulingthreadsm1.jpg?w=300 300w, https://eclecticlightdotcom.files.wordpress.com/2022/01/schedulingthreadsm1.jpg?w=768 768w, https://eclecticlightdotcom.files.wordpress.com/2022/01/schedulingthreadsm1.jpg?w=1024 1024w" sizes="(max-width: 940px) 100vw, 940px"/></span></p>
<p>With Apple expected to announce the successor to its M1 series at the next WWDC in early June, it will be interesting to see its core architecture and the strategies offered by macOS for managing it.</p>
<p><em>I’m very grateful to Walt for providing information about and the screenshot of the Ultra under load.</em></p>
	</div></div>
  </body>
</html>
