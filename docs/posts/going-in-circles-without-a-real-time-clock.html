<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://rachelbythebay.com/w/2024/04/10/rtc/">Original</a>
    <h1>Going in circles without a real-time clock</h1>
    
    
<p>
I have a story about paper cuts when using a little Linux box.  
</p>
<p>
One of my sites has an older Raspberry Pi installed in a spot that 
takes some effort to access.  A couple of weeks ago, it freaked out and 
stopped allowing remote logins.  My own simple management stuff was 
still running and was reporting that something was wrong, but it 
wasn&#39;t nearly enough detail to find out exactly what happened.
</p>
<p>
I had to get a console connected to it in order to find out that it was 
freaking out about its filesystem because something stupid had 
apparently happened to the SD card.  I don&#39;t know exactly why it 
wouldn&#39;t let me log in.  Back in the old days, you could still get into 
a machine with a totally dead disk as long as enough stuff was still in 
the cache - inetd + telnetd + login + your shell, or sshd + your shell 
and (naturally) all of the libraries those things rely on.  I guess 
something happened and some part of the equation was missing.  There 
are a LOT more moving parts these days, as we&#39;ve been learning with the 
whole xz thing.  Whatever.
</p>
<p>
So I rebooted it, and went about my business, and it wasn&#39;t until a 
while later that I noticed the thing&#39;s clock was over a day off.  chrony 
was running, so WTF, right?  chrony actually said that it had no 
sources, so it was just sitting there looking sad.
</p>
<p>
This made little sense to me, given that chrony is one of the more 
<a href="https://rachelbythebay.com/w/2022/12/21/boot/">clueful</a>
programs which will keep trying to resolve sources until it gets enough 
to feel happy about using them for synchronization.  In the case of my 
stock install, that meant it was trying to use 2.debian.pool.ntp.org.
</p>
<p>
I tried to resolve it myself on the box.  It didn&#39;t work.  I queried 
another resolver (on another box) and it worked fine.  So now what, on 
top of chrony not working, unbound wasn&#39;t working too?
</p>
<p>
A little context here: this box was reconfigured at some point to run 
its own recursive caching resolver for the local network due to some 
other (*cough* 
<a href="https://rachelbythebay.com/w/2023/11/17/omada/">TP-Link</a>
*cough*) problems I had last year.  It was also configured to *only* 
use that local unbound for DNS resolution.
</p>
<p>
This started connecting some of the dots.  chrony wasn&#39;t setting the 
clock because it couldn&#39;t resolve hosts in the NTP pool.  It couldn&#39;t 
resolve hosts because unbound wasn&#39;t working.  But, okay, why wasn&#39;t 
unbound working?
</p>
<p>
Well, here&#39;s the problem - it *mostly* was.  I could resolve several 
other domains just fine.  It&#39;s just that ntp.org stuff wasn&#39;t happening.
</p>
<p>
(This is where you start pointing at the screen if this has happened to 
you before.)
</p>
<p>
So, what would make only some domains not resolve... but not all of 
them... on a box... with a clock that&#39;s over a day behind?
</p>
<p>
Yeah, that&#39;s about when it fit together.  I figured they must be running 
DNSSEC on that zone (or some part of it), and it must have a 
&#34;not-before&#34; constraint on some aspect of it.  I&#39;ve been down
<a href="https://rachelbythebay.com/w/2018/03/20/sshclock/">this road</a>
before with SSH certificates, so why not DNS?
</p>
<p>
I added another resolver to resolv.conf, then chrony started working, 
and that brought the time forward, and then unbound started resolving 
the pool, and everything else returned to normal.
</p>
<p>
By &#34;everything else&#34;, I also mean WireGuard.  Did you know that if your 
machine gets far enough out of sync, that&#39;ll stop working, too?  I had 
no idea that it apparently includes time in its crypto stuff, but what 
other explanation is there?
</p>
<p>
Backing up, let&#39;s talk about what happened, because most of this is on 
me.
</p>
<p>
I have an old Pi running from an SD card.  It freaked out.  It took me 
about a day and a half to get to where it was so I could start working 
on fixing it.
</p>
<p>
This particular Pi doesn&#39;t have a real-time clock.  The very newest ones 
(5B) *do*, but you have to actually buy a battery and connect it.  By 
default, they are in the same boat.  This means when they come up, they 
use some nonsense time for a while.  I&#39;m not sure exactly what that is 
offhand, because...
</p>
<p>
systemd does something of late where it will try to put the clock back 
to somewhere closer to &#34;now&#34; when it detects a value that&#39;s too far in 
the past.  I suspect it just digs around in the journal, grabs the last 
timestamp from that, and runs with it.  This is usually pretty good, 
since if you&#39;re just doing a commanded reboot, the difference is a few 
seconds, and your time sync stuff fixes the rest not long thereafter.
</p>
<p>
But, recall that the machine sat there unable to write to its &#34;disk&#34; (SD 
card) for well over a day, so that&#39;s the timestamp it used.  If I had 
gotten there sooner, I guess it wouldn&#39;t have been so far off, but that 
wasn&#39;t an option.
</p>
<p>
Coming up with time that far off made unbound unable to resolve the 
ntp.org pool servers, and that made chrony unable to update the clock... 
which made unbound unable to resolve the pool servers... which...
</p>
<p>
My own configuration choice which pointed DNS resolution only at  
localhost did the rest.
</p>
<p>
So, what now?  Well, first of all, I gave it secondary and tertiary 
resolvers so that particular DNS anomaly won&#39;t be repeated.  Then I 
explicitly gave chrony a &#34;peer&#34; source of a nearby host (another Pi, 
unfortunately) which might be able to help it out in a pinch even if the 
link to the outside isn&#39;t up for whatever reason.
</p>
<p>
There&#39;s a certain problem with thinking of these little boxes as cheap.  
They are... until they aren&#39;t.  To mangle a line from jwz, a Raspberry 
Pi is only cheap if your time has no value.
</p>
<p>
As usual, this post is not a request for THE ONE to show up.  If you are 
THE ONE, you don&#39;t make mistakes.  We know.  Shut up and go away.
</p>

  </body>
</html>
