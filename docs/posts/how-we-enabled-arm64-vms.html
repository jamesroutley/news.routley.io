<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.ubicloud.com/blog/how-we-enabled-arm64-vms">Original</a>
    <h1>How we enabled ARM64 VMs</h1>
    
    <div id="readability-page-1" class="page"><div data-animation="default" data-collapse="medium" data-duration="400" data-easing="ease" data-easing2="ease" data-doc-height="1" role="banner"><div><div><p><a href="https://www.ubicloud.com/"><img src="https://assets-global.website-files.com/64f9d9b4e737e7b37d4e39a4/64fe48116c52fe1a51e17279_ubicolud%20logo.png" loading="lazy" alt=""/></a></p></div></div></div><section><div><div><div id="w-node-decdb48f-56e8-4c35-c577-932285e9b439-40843ad6"><p>May 27, 2024 · 5 min read</p><div><p><img src="https://assets-global.website-files.com/64f9d9b4e737e7b37d4e39a4/6650a5f6b6976b859d032536_Daniel.png" loading="lazy" alt=""/></p><div><p>Daniel Farina</p><p>Founder / CTO</p></div></div><div><p>AWS popularized Arm-based CPUs with their Graviton line. When compared with x86, this new CPU architecture offers 40% better price/performance; this makes Arm particularly appealing for compute-intensive workloads such as HPC, video encoding, and data science. Arm-based CPUs also consume up to 60% less power, making them attractive for use in large data centers.</p><h3>diffstat</h3><div><p><span>migrate/20231014_arm64.rb</span> <span>| 15</span> <span>+++++++++++</span><br/></p><p><span>prog/learn_arch.rb</span> <span>| 11</span> <span>++++++++</span><br/></p><p><span>prog/vm/host_nexus.rb</span> <span>| 3</span> <span>+++</span><br/></p><p><span>prog/vm/nexus.rb</span> <span>| 7</span> <span>++</span><span>---</span><br/></p><p><span>rhizome/common/bin/arch</span> <span>| 6</span> <span>+++++</span><br/></p><p><span>rhizome/common/lib/arch.rb</span> <span>| 27</span> <span>+++++++++++++++++++</span><br/></p><p><span>rhizome/host/bin/prep_host.rb</span> <span>| 10</span> <span>+++</span><span>----</span><br/></p><p><span>rhizome/host/bin/setup-spdk</span> <span>| 10</span> <span>++++++</span><span>-</span><br/></p><p><span>rhizome/host/lib/cloud_hypervisor.rb</span> <span>| 51</span> <span>+++++++++++++++++++++++++++++++++</span><span>---</span><br/></p><p><span>rhizome/host/lib/vm_setup.rb</span> <span>| 24</span> <span>++++++++++++</span><span>-----</span><br/></p><p><span>spec/prog/learn_arch_spec.rb</span> <span>| 23</span> <span>++++++++++++++++</span><br/></p><p><span>spec/prog/vm/host_nexus_spec.rb</span> <span>| 3</span> <span>+++</span><br/></p><p><span>spec/prog/vm/nexus_spec.rb</span> <span>| 5</span> <span>++</span><span>--</span><br/></p><p>13 files changed,   173 insertions (+),   22 deletions (-)<br/></p></div><p>We were able to enable arm64 instances with the above diffset. With these changes, we standardized naming for CPU architectures, removed the need to manually enter new CPU names, updated our VM placement logic, and dropped in the new binaries required for ARM architectures. Here’s a bit more on each of these changes.<br/></p></div><div id="sign-up-and-sign-in"><p><strong>Normalize naming to x64 and arm64</strong>: The first problem was that nobody agreed on CPU architecture names. Example architecture names that we saw were arm64, AArch64, a64, x64, x86, x86-64, amd64, x86_64, and Intel 64. </p><p><img src="https://assets-global.website-files.com/64f9d9b4e737e7b37d4e39a4/66544ba153a70eceec56bd63_Screenshot%202024-05-27%20at%2010.59.55%E2%80%AFAM.png" loading="lazy" sizes="(max-width: 479px) 93vw, (max-width: 767px) 92vw, (max-width: 991px) 94vw, (max-width: 1439px) 72vw, 864px" srcset="https://assets-global.website-files.com/64f9d9b4e737e7b37d4e39a4/66544ba153a70eceec56bd63_Screenshot%202024-05-27%20at%2010.59.55%E2%80%AFAM-p-500.png 500w, https://assets-global.website-files.com/64f9d9b4e737e7b37d4e39a4/66544ba153a70eceec56bd63_Screenshot%202024-05-27%20at%2010.59.55%E2%80%AFAM-p-800.png 800w, https://assets-global.website-files.com/64f9d9b4e737e7b37d4e39a4/66544ba153a70eceec56bd63_Screenshot%202024-05-27%20at%2010.59.55%E2%80%AFAM.png 1059w" alt=""/></p><p><strong></strong>: Next, we didn’t want to manually type in the CPU architecture name when an operator was adding new machines to the system. This was also time consuming when you were doing development. So instead, Ubicloud now asks the machine for its architecture, we use the previous step to create a normalized name, and save this state in a column in our control plane database.</p><p><img src="https://assets-global.website-files.com/64f9d9b4e737e7b37d4e39a4/66544d495e7934edc149a844_2024-05-arm64-allocator-changes.png" loading="lazy" sizes="(max-width: 479px) 93vw, (max-width: 767px) 92vw, (max-width: 991px) 94vw, (max-width: 1439px) 72vw, 864px" srcset="https://assets-global.website-files.com/64f9d9b4e737e7b37d4e39a4/66544d495e7934edc149a844_2024-05-arm64-allocator-changes-p-500.png 500w, https://assets-global.website-files.com/64f9d9b4e737e7b37d4e39a4/66544d495e7934edc149a844_2024-05-arm64-allocator-changes-p-800.png 800w, https://assets-global.website-files.com/64f9d9b4e737e7b37d4e39a4/66544d495e7934edc149a844_2024-05-arm64-allocator-changes-p-1080.png 1080w, https://assets-global.website-files.com/64f9d9b4e737e7b37d4e39a4/66544d495e7934edc149a844_2024-05-arm64-allocator-changes.png 1086w" alt=""/></p></div><div id="sign-up-and-sign-in"><h3>Challenges in enabling arm64 VMs</h3></div><p>As we worked on enabling arm64 VMs, we also ran into two high level challenges, where there’s still room for improvement.</p><p><img src="https://assets-global.website-files.com/64f9d9b4e737e7b37d4e39a4/6650a2a1ff594bae98716baa_Screenshot%202024-05-24%20at%2015.22.05.png" loading="lazy" sizes="100vw" srcset="https://assets-global.website-files.com/64f9d9b4e737e7b37d4e39a4/6650a2a1ff594bae98716baa_Screenshot%202024-05-24%20at%2015.22.05-p-500.png 500w, https://assets-global.website-files.com/64f9d9b4e737e7b37d4e39a4/6650a2a1ff594bae98716baa_Screenshot%202024-05-24%20at%2015.22.05-p-800.png 800w, https://assets-global.website-files.com/64f9d9b4e737e7b37d4e39a4/6650a2a1ff594bae98716baa_Screenshot%202024-05-24%20at%2015.22.05-p-1080.png 1080w, https://assets-global.website-files.com/64f9d9b4e737e7b37d4e39a4/6650a2a1ff594bae98716baa_Screenshot%202024-05-24%20at%2015.22.05-p-1600.png 1600w, https://assets-global.website-files.com/64f9d9b4e737e7b37d4e39a4/6650a2a1ff594bae98716baa_Screenshot%202024-05-24%20at%2015.22.05-p-2000.png 2000w, https://assets-global.website-files.com/64f9d9b4e737e7b37d4e39a4/6650a2a1ff594bae98716baa_Screenshot%202024-05-24%20at%2015.22.05.png 2328w" alt=""/></p><div id="enter-billing"><h3><strong>Conclusion</strong></h3><p>We introduced arm64 VMs on Ubicloud earlier this year. The changes were pedestrian and took 151 lines of code. In the process, we also ran into two challenges associated with introducing a new CPU architecture. First, we used Hetzner’s arm64 bare metal machines and we couldn’t customize the underlying hardware. This led to us being somewhat wasteful in terms of the compute and disk usage on these machines. Second, we doubled the number of binaries to build, version, and deploy to Ubicloud’s data plane. This required us to improve our build and release pipeline.</p></div></div></div></div></section></div>
  </body>
</html>
