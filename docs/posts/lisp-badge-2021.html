<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://www.technoblogy.com/show?2AEE">Original</a>
    <h1>Lisp Badge (2021)</h1>
    
    <div id="readability-page-1" class="page"><div id="content">

<p>10th January 2019</p>
<p>This is a self-contained computer with its own display and keyboard, based on an ATmega1284, that you can program in the high-level language Lisp:</p>
<p><img src="http://www.technoblogy.com/pictures/kvm/lispbadgehand.jpg" alt="LispBadgeHand.jpg" width="720" height="462"/></p>
<p><em>The Lisp Badge, a computer programmed in Lisp with a self-contained keyboard and display.</em></p>
<p>You can use it to run programs that interface to components such as LEDs and push-buttons via the I/O pins, read the analogue inputs, and operate external devices via the I2C and SPI interfaces. It has a greyscale OLED display that gives 8 lines of 42 characters, and an integrated 45-key keyboard optimised for Lisp.</p>
<h3>Introduction</h3>
<p>My earlier <a href="http://www.technoblogy.com/show?1KTO">Tiny Lisp Computer 2 PCB</a> was a board running Lisp that was just 3.25&#34; x 1.5&#34;, but although it had an integrated display, it needed an external keyboard.</p>
<p>I was inspired to make this new version when I saw Voja Antonic&#39;s Belgrade Badge, a self-contained BASIC computer with an integrated keyboard and display designed for the Hackaday Belgrade conference in July 2018 <sup id="cite_ref1"><a href="#cite_note1">[1]</a></sup>.</p>
<p>The keyboard is based on tactile pushbuttons that are available for under 6 pence/cents each. I decided to keep the board as compact as possible by providing only the keys needed to program in uLisp, which meant departing from a standard keyboard layout. One benefit of this is that the keys you use a lot when entering Lisp programs, the parentheses &#39;(&#39; and &#39;)&#39;, are on two dedicated keys on the bottom row of the keyboard.</p>
<p>For the display I chose a very nice greyscale OLED display with a resolution of 256 x 64 available on AliExpress <sup id="cite_ref2"><a href="#cite_note2">[2]</a></sup>, which gives a text display of 42 x 8 characters. It&#39;s slightly more expensive than the usual 128 x 64 displays, but is perfect for this project.</p>
<p>The Lisp badge is based on an ATmega1284P, which I think is the best ATmega processor for running uLisp as it provides 16 Kbytes of RAM, more than any other ATmega chip. This chip drives the display, scans the keyboard, and handles the Lisp interpreter, without needing any other active devices; the circuit uses every pin on the 44-pin chip.</p>
<p>I designed the Lisp Badge to be powered by an AAA-sized 3.7V LiPO battery, and the processor runs with a 16MHz crystal clock. According to the Atmel datasheet the ATmega1284 needs 3.825V to work at 16MHz, but I haven&#39;t had any problems; if you prefer to err on the safe side you could use a 12MHz crystal, which should be fine down to 3.15V.</p>
<p>Here&#39;s the full specification:</p>
<div>
<h3>Lisp Badge – Specification</h3>
<p><strong>Size:</strong> 107mm x 61mm (4.2&#34; x 2.4&#34;).</p>
<p><strong>Display</strong>: 42 characters x 8 lines.</p>
<p><strong>Keyboard:</strong> Integrated 45-key keyboard providing upper and lower-case characters, digits, and the symbols required by uLisp.</p>
<p><strong>Memory available</strong>: 2816 Lisp cells (11264 bytes).</p>
<p><strong>EEPROM</strong>: 1024 Lisp cells (4096 bytes), allows you to save the Lisp workspace using <strong>save-image</strong>.</p>
<p><strong>Processor:</strong> ATmega1284P</p>
<p><strong>Clock speed:</strong> 16 MHz.</p>
<p><strong>Current consumption:</strong> Approx. 20 mA.</p>
<h4><strong>Language</strong></h4>
<p>uLisp, a subset of Common Lisp, with 122 Lisp functions and special forms. For a full definition see <a href="http://www.ulisp.com/show?3L" target="_blank">uLisp Language Reference</a>.</p>
<p>The language includes two extensions, <strong>plot</strong> and <strong>plot3d</strong>, for plotting graphs and 3d functions. </p>
<p>uLisp also includes an AVR assembler which allows you to generate and run machine-code functions, written in AVR mnemonics, using an assembler written in Lisp.</p>
<p><strong>Types supported</strong>: list, symbol, integer, character, string, and stream.</p>
<p>An integer is a sequence of digits, optionally prefixed with &#34;+&#34; or &#34;-&#34;. Integers can be between -32768 and 32767. You can enter numbers in hexadecimal, octal, or binary with the notations #x2A, #o52, or #b101010, all of which represent 42.</p>
<p>User-defined symbol names can have arbitrary names. Any sequence that isn&#39;t an integer can be used as a symbol; so, for example, 12a is a valid symbol.</p>
<p>There is one namespace for functions and variables; in other words, you cannot use the same name for a function and a variable.</p>
<p>Includes a mark and sweep garbage collector. Garbage collection takes 5 msec.</p>
<h4><strong>Interfaces</strong></h4>
<p>These interfaces are brought to headers at the edge of the Lisp Badge board. The numbers in brackets refer to Arduino pin numbers:</p>
<ul>
<li>Four analogue input pins using <strong>analogread</strong>: A0 to A3 (24 to 27) plus VCC and GND.</li>
<li>Two analogue outputs using <strong>analogwrite</strong>: MISO (6), and SCK (7).</li>
<li>Digital input and output using <strong>pinmode</strong>, <strong>digitalread</strong>, and <strong>digitalwrite</strong>: MOSI (5), MISO (6), SCK (7), RX0 (8), TX0 (9), SCL (16), SDA (17), and A0 to A3 (24 to 27)</li>
<li>I2C interface using <strong>with-i2c</strong> and <strong>restart-i2c</strong>: SCL (16) and SDA (17).</li>
<li>SPI interface using <strong>with-spi</strong>: MOSI (5), MISO (6), and SCK (7).</li>
<li>Serial interface (FTDI) using <strong>with-serial</strong>: RX0 (8) and TX0 (9).</li>
</ul><p>
The shift key can be used as a digital input: SHIFT (23).</p></div>
<h3>Entering programs</h3>
<p>You can enter commands and programs by typing them at the keyboard, and pressing ENTER. A keyboard buffer is provided that buffers a full screen of text, and you can use the DEL key to delete characters and correct typing mistakes. The editor includes parenthesis matching which automatically highlights matching brackets in grey as you type in a program. This makes it much easier to enter a program correctly, and is especially helpful in telling you how many closing brackets to type at the end of defining a function.</p>
<p>Typing on the tactile buttons isn&#39;t particularly easy, but you can also connect the Lisp Badge to a computer by plugging a 3.3V FTDI USB-to-serial converter onto the FTDI connector on the top right of the Lisp Badge, and then connecting this to the computer using a USB cable. You can then use the Serial Monitor in the Arduino IDE to enter and edit programs as described in <a href="http://www.ulisp.com/show?19XT">Using uLisp</a>.</p>
<p>I used the 3.3V FTDI Basic Breakout from Sparkfun <sup id="cite_ref3"><a href="#cite_note3">[3]</a></sup>. When using it with the Lisp Badge it powers the Lisp Badge, and so the battery should be removed or switched off. </p>
<h3>Plot function</h3>
<p>I&#39;ve added a <strong>plot3d</strong> function, to allow 3D function plotting on the display. You call it with a function of two arguments, x and y, and it calculates the function for every (x, y) point between (0, 0) and (127, 63) and plots the greyscale of the value returned, between 0 and 15:</p>
<p><img src="http://www.technoblogy.com/pictures/kvm/lispbadgeplot3d.jpg" alt="LispBadgePlot3D.jpg" width="560" height="330"/></p>
<p><em>Demonstration of the Lisp 3D plotting function.</em></p>
<p>There&#39;s also a 2D <strong>plot </strong>function that will plot up to four 2D functions, with optional axes.</p>
<p>For details see <a href="http://www.ulisp.com/show?2G4B">Plotting extensions</a>.</p>
<h3>The display</h3>
<p>The display is a greyscale OLED display with 16 grey levels and a resolution of 256 x 64. It&#39;s based on an SH1122 driver chip <sup id="cite_ref4"><a href="#cite_note4">[4]</a></sup>. To test out the display I built a terminal program, which I&#39;ve described in an earlier article: <a href="http://www.technoblogy.com/show?2D8S">Tiny Terminal 2</a>.</p>
<p>After designing the Lisp Badge PCB in Eagle I ordered a second display from the same AliExpress supplier, as a spare, and was shocked to discover that it was a new Version 1.1 of the board with the order of the pins reversed, so it would no longer work in my PCB!</p>
<p><img src="http://www.technoblogy.com/pictures/kvm/oled256s.jpg" alt="OLED256s.jpg" width="565" height="369"/></p>
<p><em>The two alternative versions of the 256x64 OLED display.</em></p>
<p>The Eagle files I&#39;ve provided on GitHub are for the V1.0 display. I&#39;ve made a second version of the PCB for the Version 1.1 display; contact me if you need this for use with a V1.1 display.</p>
<h3>The circuit</h3>
<p>Here&#39;s the main part of the circuit:</p>
<p><img src="http://www.technoblogy.com/pictures/kvm/lispbadge.gif" alt="LispBadge.gif" width="720" height="556"/></p>
<p><em>Circuit of the Lisp Badge, based on an ATmega1284P microcontroller.</em></p>
<p>The keyboard arranges the keys in a matrix of four rows and 11 columns:</p>
<p><img src="http://www.technoblogy.com/pictures/kvm/lispbadgekybd.gif" alt="LispBadgeKybd.gif" width="720" height="206"/></p>
<p><em>The circuit of the Lisp Badge keyboard matrix.</em></p>
<h3>Construction</h3>
<p>I created a PCB in Eagle, and ordered a set of boards from <a href="https://www.pcbway.com/" target="_blank">PCBWay</a>. I chose black PCBs as the white screening shows up well against black.</p>
<p>Most of the components, apart from the pushbuttons and display, are mounted on the back of the board:</p>
<p><img src="http://www.technoblogy.com/pictures/kvm/lispbadgeback.jpg" alt="LispBadgeBack.jpg" width="560" height="330"/></p>
<p><em>The reverse side of the Lisp Badge printed circuit board.</em></p>
<p>All the components are SMD apart from the pushbuttons, which are through-hole. I chose through-hole pushbuttons because (a) they&#39;re cheaper, (b) they are easier to solder by hand, and (c) the holes ensure that they line up perfectly. The downside is that it makes the back of the PCB prickly, but you could solve that with a small case, or a large self-adhesive foam pad.</p>
<p>The PCB uses 0805 resistors, capacitors, and an LED. I used a Youyue 858D+ hot air gun at 250°C to solder the SMD components, but with care it should be possible to use a fine-tipped soldering iron. The PCB is designed for a two-pad SMD crystal. I used an Abracon ABM7 16.000MHz type.</p>
<p>The display is held in place with a double-sided self-adhesive foam pad, and then soldered to the board with seven header pins, but I recommend leaving the display uninstalled until you have uploaded the bootloader; see below.</p>
<h4 id="parts-list">► Parts list</h4>

<h3>The program</h3>
<p>The Lisp Badge program is based on the code for the AVR version of uLisp Version 2.5 (see <a href="http://www.ulisp.com/show?1AA0" target="_blank">Download uLisp</a>), with the addition of routines to handle the display and keyboard, and the plot extensions.</p>
<p>The display routine is essentially the same as in my earlier project <a href="http://www.technoblogy.com/show?2D8S">Tiny Terminal 2</a>. It uses character set definitions stored in program memory to generate the characters, and hardware scrolling to scroll the display when the cursor moves below the bottom line of the display. The parenthesis highlighting works in the same way as in my <a href="http://www.technoblogy.com/show?1INT">Tiny Lisp Computer 2</a>.</p>
<p>The keyboard uses the ATmega1284&#39;s Timer/Counter2 to generate an overflow interrupt at about 2kHz. Each call of the overflow interrupt service routine takes the next column low in the keyboard matrix, and it then tests to see if any of the four row inputs has been pulled low by the pressing of a pushbutton. If so, the button&#39;s position is looked up in a key table to translate it to the ASCII code of the key. This also takes into account the state of the SHIFT keys, which are connected to a dedicated input.</p>
<h3>Installing a bootloader</h3>
<p>To program the Lisp Badge I now recommend using MCUdude&#39;s <a href="https://github.com/MCUdude/MightyCore" target="_blank">MightyCore on GitHub</a>.</p>
<p>The first step is to install a bootloader using an ISP programmer. The Optiboot bootloader provided with MightyCore also supports writing to flash, which uLisp now uses for <strong>save-image</strong> and the AVR assembler.</p>
<p>Because the display is only tolerant of 3.3V you should either use an ISP programmer that supplies 3.3V, or do this before connecting the OLED display to the board. I used a USBasp ISP programmer set to the 3.3V setting.</p>
<p>Choose the <strong>ATmega1284</strong> option under the <strong>MightyCore</strong> heading on the <strong>Board</strong> option on the <strong>Tools</strong> menu. Check that the subsequent options are set as follows (ignore any other options):</p>
<p><strong>Clock: &#34;External 16MHz&#34;</strong></p>
<p>Set the <strong>Programmer</strong> option as appropriate for the ISP programmer you are using. Then choose <strong>Burn Bootloader</strong>.</p>
<h3>Uploading the Lisp Badge code</h3>
<p>The next step is to install the Lisp Badge code, using an 3.3V FTDI USB-to-serial converter plugged into the FTDI connector on the PCB. I used the SparkFun FTDI Basic Breakout <sup id="cite_ref5"><a href="#cite_note5">[5]</a></sup>.</p>
<p>Leave the MegaCore options set as described above, and choose the USB port from the <strong>Port</strong> submenu. Then choose <strong>Upload</strong> from the <strong>Sketch</strong> menu to upload uLisp.</p>
<h3>Resources</h3>
<p>Get the latest Lisp Badge source from GitHub, together with the Eagle files for the PCB so you can make yourself a board, at: <a href="https://github.com/technoblogy/lisp-badge" target="_blank">Lisp Badge</a>.</p>
<p>Or order a board from OSH Park here: <a href="https://oshpark.com/shared_projects/wnj60xEU" target="_blank">Lisp Badge Board</a>.</p>
<p>Or order a board from PCBWay here: <a href="https://www.pcbway.com/project/shareproject/Lisp_Badge.html" target="_blank">Lisp Badge Board</a>.</p>
<p>For more information about the Lisp Badge, and some example programs demonstrating its sound and graphics features, see <a href="http://www.ulisp.com/show?2L0C">Lisp Badge</a>.</p>
<h3>Updates</h3>
<p>11th January 2019: Added a brief description of the program.</p>
<p>12th January 2019: Added current consumption to the specification.</p>
<p>13th January 2019: Corrected 5V in the circuit diagram to 3.3V.</p>
<p>8th March 2019: Corrected the instructions for installing a bootloader.</p>
<p>26th May 2019: I&#39;ve just uploaded a new version of the Lisp Badge source to GitHub, updated to use the latest version of uLisp, version 2.7.</p>
<p>10th July 2020: The Lisp Badge source was updated to uLisp Version 3.3a.</p>
<p>4th April 2021: The Lisp Badge source has been updated to uLisp Version 3.6, and I&#39;ve updated the installation instructions to describe using MCUdude&#39;s MightyCore, which is required for the new <strong>save-image</strong> and AVR assembler features.</p><hr/>
<ol>
<li id="cite_note1"><a href="#cite_ref1">^</a> <a href="https://hackaday.io/project/80627-badge-for-hackaday-conference-2018-in-belgrade" target="_blank">Badge for Hackaday Conference 2018 in Belgrade</a> on Hackaday.</li>
<li id="cite_note2"><a href="#cite_ref2">^</a> <a href="https://www.aliexpress.com/item/2-08-inch-7P-SPI-White-OLED-Screen-Module-SH1122-Drive-IC-256-64/32831226777.html">2.08 inch 7P SPI White OLED Screen Module</a> on Aliexpress.</li>
<li id="cite_note3"><a href="#cite_ref3">^</a> <a href="https://www.sparkfun.com/products/9873" target="_blank">FTDI Basic Breakout – 3.3V</a> - on Sparkfun.</li>
<li id="cite_note4"><a href="#cite_ref4">^</a> <a href="https://www.displayfuture.com/Display/datasheet/controller/SH1122.pdf" target="_blank">SH1122 datasheet</a> on DisplayFuture.</li>
<li id="cite_note5"><a href="#cite_ref5">^</a> <a href="https://www.sparkfun.com/products/9873" target="_blank">FTDI Basic Breakout 3.3V</a> on SparkFun.</li>
</ol>

<hr/>


<p><a href="http://disqus.com">blog comments powered by </a></p></div></div>
  </body>
</html>
