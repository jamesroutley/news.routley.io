<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://apenwarr.ca/log/20140801">Original</a>
    <h1>WiFi: “beamforming” only begins to describe it (2014)</h1>
    
    <div id="readability-page-1" class="page"><div>
<p><b>Wifi: &#34;beamforming&#34; only begins to describe it</b></p>
<p><a href="http://apenwarr.ca/beamlab/"><img src="http://apenwarr.ca/log/beamforming.png"/></a></p>
<p>[Note to the impatient: to try out my beamforming simulation, which produced
the above image, visit my <a href="http://apenwarr.ca/beamlab/">beamlab test
page</a> - ideally in a browser with very fast javascript, like Chrome.  You
can also
<a href="http://github.com/apenwarr/beamlab">view the source</a>.]</p>
<p>I promised you some cheating of Shannon&#39;s Law.  Of course, as with most
things in physics, even the cheating isn&#39;t really cheating; you just adjust
your model until the cheating falls within the rules.</p>
<p>The types of &#34;cheating&#34; that occur in wifi can be briefly categorized as
<b>antenna directionality</b>, <b>beamforming</b>, and <b>MIMO</b>.  (People
usually think about MIMO before beamforming, but I find the latter to be
easier to understand, mathematically, so I switched the order.)</p>
<p><b>Antenna Directionality and the Signal to Noise Ratio</b></p>
<p>Previously, we discussed the signal-to-noise ratio (SNR) in some detail, and
how Shannon&#39;s Law can tell you how fast you can transfer data through a
channel with a given SNR.</p>
<p>The thing to notice about SNR is that you can increase it by increasing
amplification at the sender (where the background noise is fixed but you
have a clear copy of the signal) but not at the receiver.  Once a receiver
has a copy of the signal, it already has noise in it, so when you amplify
the received signal, you just amplify the noise by the same amount, and the
SNR stays constant.</p>
<p>(By the way, that&#39;s why those &#34;amplified&#34; routers you can buy don&#39;t do much
good.  They amplify the transmitted signal, but amplifying the received
signal doesn&#39;t help in the other direction.  The maximum range is still
limited by the transmit power on your puny unamplified phone or laptop.)</p>
<p>On the other hand, one thing that <em>does</em> help is making your antenna more
&#34;directional.&#34;  The technical term for this is &#34;antenna gain,&#34; but I don&#39;t
like that name, because it makes it sound like your antenna amplifies the
signal somehow for free.  That&#39;s not the case.  Antenna gain doesn&#39;t so much
amplify the signal as ignore some of the noise.  Which has the same net
effect on the SNR, but the mechanics of it are kind of important.</p>
<p>You can think of an antenna as a &#34;scoop&#34; that picks up both the signal and
the noise from a defined volume of space surrounding the antenna.  The shape
of that volume is important.  An ideal &#34;isotropic&#34; antenna (my favourite
kind, although unfortunately it doesn&#39;t exist) picks up the signal equally
in all directions, which means the region it &#34;scoops&#34; is spherical.</p>
<p>In general we assume that background noise is distributed evenly through
space, which is not exactly true, but is close enough for most purposes. 
Thus, the bigger the volume of your scoop, the more noise you scoop up along
with it.  To stretch our non-mathematical metaphor well beyond its breaking
point, a &#34;bigger sphere&#34; will contain more signal as well as more noise, so
just expanding the size of your region doesn&#39;t affect the SNR.  That&#39;s why,
and I&#39;m very sorry about this, a bigger antenna actually doesn&#39;t improve your
reception at all.</p>
<p>(There&#39;s another concept called &#34;antenna efficiency&#34; which basically says
you can adjust your scoop to resonate at a particular frequency, rejecting
noise outside that frequency.  That definitely works - but all antennas are
already designed for this.  That&#39;s why you get different antennas for
different frequency ranges.  Nowadays, the only thing you can do by changing
your antenna size is to screw up the efficiency.  You won&#39;t be improving it
any further.  So let&#39;s ignore antenna efficiency.  You need a good quality
antenna, but there is not really such a thing as a &#34;better&#34; quality antenna
these days, at least for wifi.)</p>
<p>So ok, a bigger scoop doesn&#39;t help.  But what can help is changing the shape
of the scoop.  Imagine if, instead of a sphere, we scoop up only the
signal from a half-sphere.</p>
<p>If that half-sphere is in the direction of the transmitter - which is
important!  - then you&#39;ll still receive all the same signal you did before. 
But, intuitively, you&#39;ll only get half the noise, because you&#39;re ignoring
the noise coming in from the other direction.  On the other hand, if the
half-sphere is pointed away from the incoming signal, you won&#39;t hear any of
the signal at all, and you&#39;re out of luck.  Such a half-sphere would have 2x
the signal to noise ratio of a sphere, and in decibels, 2x is about 3dB.  So
this kind of (also not really existing) antenna is called 3dBi, where dBi is
&#34;decibels better than isotropic&#34; so an isotropic (spherical) receiver is
defined as 0dBi.</p>
<p>Taking it a step further, you could take a quarter of a sphere, ie. a region
90 degrees wide in any direction, and point it at your transmitter.  That
would double the SNR again, thus making a 6dBi antenna.</p>
<p>Real antennas don&#39;t pick up signals in a perfectly spherical shape; math
makes that hard.  So real ones tend to produce a kind of weirdly-shaped
scoop with little roundy bits sticking out all over, and one roundy bit
larger than the others, in the direction of interest.  Essentially, the size
of the biggest roundy bit defines the antenna gain (dBi).  For regulatory
purposes, the FCC mostly assumes you will use a 6dBi antenna, although of course
the 6dBi will not be in the shape of a perfect quarter sphere.</p>
<p>Now is that the most hand-wavy explanation of antenna gain you have ever
seen?  Good.</p>
<p>Anyway, the lesson from all this is if you use a directional antenna, you
can get improved SNR.  A typical improvement is around 6dBi, which is pretty
good.  But the down side of a directional antenna is you have to aim it. 
With a wifi router, that can be bad news.  It&#39;s great for outdoors if you&#39;re
going to set up a long-distance link and aim very carefully; you can get
really long range with a very highly directional antenna.  But indoors,
where distances are short and people move around a lot, it can be trouble.</p>
<p>One simple thing that does work indoors is hanging your wifi router from the
ceiling.  Then, if you picture eg. a quarter-sphere pointing downwards, you
can imagine covering the whole room without really sacrificing anything
(other than upstairs coverage, which you don&#39;t care about if you put a
router up there too).  Basically, that&#39;s as good as you can do, which is why
most &#34;enterprise&#34; wifi deployments hang their routers from the ceiling.  If
you did that at home too - and had the right kind of antennas with the right
gain in the right direction - you could get up to 6dB of improvement on your
wifi signal, which is pretty great.</p>
<p>(Another trick some routers do is to have multiple antennas, each one
pointing in a different direction, and then switch them on and off to
pick the one(s) with the highest SNR for each client.  This works okay but
it interferes with MIMO - where you want to actively use as many antennas as
possible - so it&#39;s less common nowadays.  It was a big deal in
the days of 802.11g, where that was the main reason to have multiple
antennas at all.  Let&#39;s talk about MIMO later, since MIMO is its own brand
of fun.)</p>
<p><b>Beamforming</b></p>
<p>So okay, that was antenna directionality (gain).  To summarize all that
blathering: you point your antenna in a particular direction, and you get a
better SNR in that particular direction.</p>
<p>But the problem is that wifi clients move around, so antennas permanently
pointed in a particular direction are going to make things worse about as
often as they help (except for simple cases like hanging from the ceiling,
and even that leaves out the people upstairs).</p>
<p>But wouldn&#39;t it be cool if, using software plus magic, you could use
multiple antennas to create &#34;virtual directionality&#34; and re-aim a &#34;beam&#34;
automatically as the client device moves around?</p>
<p>Yes, that would be cool.</p>
<p>Unfortunately, that&#39;s not what beamforming actually is.</p>
<p>Calling it &#34;beamforming&#34; is not a <em>terrible</em> analogy, but the reality of the
signal shape is vastly more complex and calling it a &#34;beam&#34; is pretty
misleading.</p>
<p>This is where we finally talk about what I mentioned last time, where two
destructively-interfering signals result in zero signal.  Where does the
power go?</p>
<p>As an overview, let&#39;s say you have two unrelated transmitters sending out a
signal at the same frequency from different locations.  It takes a fixed
amount of power for each transmitter to send its signal.  At some points in
space, the signals interfere destructively, so there&#39;s no signal at that
point.  Where does it go?  There&#39;s a conservation of energy problem after
all; the transmitted power has to equal the power delivered, via
electromagnetic waves, out there in the wild.  Does it mean the transmitter
is suddenly unable to deliver that much power in the first place?  Is it
like friction, where the energy gets converted into heat?</p>
<p>Well, it&#39;s not heat, because heat is vibration, ie, the motion of physical
particles with mass.  The electromagnetic waves we&#39;re talking about don&#39;t
necessarily have any relationship with mass; they might be traveling through
a vacuum where there is no mass, but destructive interference can still
happen.</p>
<p>Okay, maybe the energy is re-emitted as radiation?  Well, no.  The waves
<i>in the first place</i> were radiation.  If we re-emitted them as
radiation, then by definition, they weren&#39;t cancelled out.  But we know they
<i>were</i> cancelled out; you can measure it and see.</p>
<p>The short and not-very-satisfying answer is that in terms of conservation of
energy, things work out okay.  There are always areas where the waves
interfere <b>constructively</b> that exactly cancel out the areas where they
interfere <b>destructively</b>.</p>
<p>The reason I find that answer unsatisfying is that the different regions
don&#39;t really interact.  It&#39;s not like energy is being pushed, somehow,
between the destructive areas and the constructive areas.  It adds up in the
end, because it has to, but that doesn&#39;t explain <em>how</em> it happens.</p>
<p>The best explanation I&#39;ve found relates to quantum mechanics, in a lecture
I read by Richard Feynman at some point.  The idea is that light (and
all electromagnetic waves, which is what we&#39;re talking about) actually
<b>does not really travel in straight lines</b>.  The idea that light
travels in a straight line is just an illusion caused by large-scale
constructive and destructive interference.  Basically, you can think of
light as travelling along <i>all</i> the possible paths - even silly paths
that involve backtracking and spirals - from point A to point B.  The thing
is, however, that for almost every path, there is an equal and opposite path
that cancels it out.  The only exception is the shortest path - a straight
line - of which there is only one.  Since there&#39;s only one, there can&#39;t be
an equal but opposite version.  So as far as we&#39;re concerned, light travels
in a straight line.</p>
<p>(I offer my apologies to every physicist everywhere for the poor quality of
that explanation.)</p>
<p>But there are a few weird experiments you can do (look up the &#34;double slit
experiment&#34; for example) to prove that in fact, the &#34;straight line&#34; model is
the wrong one, and the &#34;it takes all the possible paths&#34; model is actually
more like what&#39;s really going on.</p>
<p>So that&#39;s what happens here too.  When we create patterns of constructive
and destructive radio interference, we are simply disrupting the rule of thumb that light travels in a straight line.</p>
<p>Oh, is that all?  Okay.  Let&#39;s call it... beam-un-forming.</p>
<p>There&#39;s one last detail we have to note in order to make it all work out. 
The FCC says that if we transmit from two antennas, we have to cut the power
from each antenna in half, so the total output is unchanged.  If we do that,
naively it might seem like the constructive interference effect is useless. 
When the waves destructively interfere, you still get zero, but when they
constructively interfere, you get 2<em>½</em>cos(ωt), which is just the
original signal.  Might as well just use one antenna with the original
transmit power, right?</p>
<p>Not exactly.  Until now, I have skipped over talking about signal power vs
amplitude, since it hasn&#39;t been that important so far.  The FCC regulates
<em>power</em>, not amplitude.  The power of A*cos(ωt) turns out to be
½A<sup>2</sup>.  I won&#39;t go over all the math, but the energy of f(x)
during a given period is defined as ∫ f<sup>2</sup>(x) dx over that
period.  Power is energy divided by time.  It turns out (via trig identities
again) the power of cos(x) is 0.5, and the rest flows from there.</p>
<p>Anyway, the FCC limit requires a <em>power</em> reduction of ½.  So if the
original wave was cos(ωt), then the original power was 0.5.  We need
the new transmit power (for each antenna) to be 0.25, which is
½A<sup>2</sup> = ½(0.5). Thus A = sqrt(0.5) = 1/sqrt(2) = 0.7 or so. </p>
<p>So the new transmit wave is 0.7 cos(ωt).  Two of those,
interfering constructively, gives about 1.4 cos(ωt).  The
resulting power is thus around ½(1.4)<sup>2</sup> = 1, or double the
original (non-reduced, with only one antenna) transmit power.</p>
<p>Ta da!  Some areas have twice the power - a 3dB &#34;antenna array gain&#34; or &#34;tx
beamforming gain&#34; - while others have zero power.  It all adds up.  No
additional transmit power is required, but a receiver, if it&#39;s in one of the
areas of constructive interference, now sees 3dB more signal power and thus
3dB more SNR.</p>
<p>We&#39;re left with the simple (ha ha) matter of making sure that the receiver
is in an area of maximum constructive interference at all times.  To make a
long story short, we do this by adjusting the phase between the
otherwise-identical signals coming from the different antennas.</p>
<p>I don&#39;t really know exactly how wifi arranges for the phase adjustment to
happen; it&#39;s complicated.  But we can imagine a very simple version: just
send from each antenna, one at a time, and have the receiver tell you the
phase difference right now between each variant.  Then, on the transmitter,
adjust the transmit phase on each antenna by an opposite amount.  I&#39;m sure
what actually happens is more complicated than that, but that&#39;s the
underlying concept, and it&#39;s called &#34;explicit beamforming feedback.&#34;
Apparently the 802.11ac standard made progress toward getting everyone to
agree on a good way of providing beamforming feedback, which is important
for making this work well.</p>
<p>Even more weirdly, the same idea works in reverse.  If you know the phase
difference between the client&#39;s antenna (we&#39;re assuming for now that he has
only one, so we don&#39;t go insane) and each of your router&#39;s antennas, then
when the client sends a signal <em>back</em> to you, you can extract the signal
from the different antennas in a particular way that gets you the same
amount of gain as in the transmit direction, and we call that rx
beamforming.  At least, I think you can.  I haven&#39;t done the math for that
yet, so I don&#39;t know for sure how well it can work.</p>
<p>Relatedly, even if there is no <em>explicit</em> beamforming feedback, in theory
you can calculate the phase differences by listening to the signals from the
remote end on each of your router&#39;s antennas.  Because the signals should be
following exactly the same path in both directions, you can guess what phase
difference your signal arrived with by seeing which difference <em>his</em> signal
came back with, and compensate accordingly.  This is called &#34;implicit
beamforming feedback.&#34; Of course, if both ends try this trick at once,
hilarity ensues.</p>
<p>And finally, I just want to point out how little the result of &#34;beamforming&#34;
is like a beam.  Although conceptually we&#39;d like to think of it that way -
we have a couple of transmitters tuning their signal to point directly at
the receiver - mathematically it&#39;s not really like that.  &#34;Beamforming&#34;
creates a kind of on-off &#34;warped checkerboard&#34; sort of pattern that extends
in all directions.  To the extent that your antenna array is symmetrical,
the checkerboard pattern is also symmetrical.</p>
<p><b>Beamforming Simulation</b></p>
<p>Of course, a checkerboard is also a flawed analogy.  Once you start looking
for a checkerboard, you start to see that in fact, the warping is kind of
directional, and sort of looks like a beam, and you can imagine that with a
hundred antennas, maybe it really would be &#34;beam&#34; shaped.</p>
<p>After doing all the math, I really wanted to know what beamforming looked
like, so I wrote a little simulation of it, and the image at the top of this
article is the result.  (That particular one came from a 9-antenna
beamforming array.)</p>
<p>You can also <a href="http://apenwarr.ca/beamlab/">try out the simulation
yourself</a>, moving around up to 9 antennas to create different
interference patterns.  I find it kind of fun and mesmerizing, especially to
think that these signals are all around us and if you could see them, they&#39;d
look like <em>that</em>.  On my computer with Chrome, I get about 20 frames per
second; with Safari, I get about 0.5 frames per second, which is not as fun. 
So use a browser with a good javascript engine.</p>
<p>Note that while the image looks like it has contours and &#34;shadows,&#34; the
shadows are entirely the effect of the constructive/destructive interference
patterns causing bright and dark areas.  Nevertheless, you can kind of
visually see how the algorithm builds one level of constructive interference
on top of another, with the peak of the humpiest bump being at the exact
location of the receiver.  It really works!</p>
<p>Some notes about the simulation:
- It&#39;s 2-dimensional.  Real life has at least 3 dimensions.  It works pretty much the same though.
- The intensity (brightness) of the colour indicates the signal strength at that point.  Black means almost no signal.
- &#34;Blue&#34; means cos(ωt) is positive at that point, and red means it&#39;s negative.
- Because of the way phasors work, &#34;blue plus red&#34; is not the only kind of destructive interference, so it&#39;s a bit confusing.
- Click on the visualization to move around the currently-selected transmitter or receiver.
- When you move the receiver around, it auto-runs the beamforming optimization so you can see the &#34;beam&#34; move around.
- The anti-optimize button is not very smart; a smarter algorithm could achieve an even less optimal result.  But most of the time it does an okay job, and it does show how you can also use beamforming to make a receiver <em>not</em> hear your signal.  That&#39;s the basis of <a href="http://en.wikipedia.org/wiki/Multi-user_MIMO">MU-MIMO</a>.</p>
<p><b>MIMO</b></p>
<p>The last and perhaps most exciting way to cheat Shannon&#39;s Law is MIMO.  I&#39;ll
try to explain that later, but I&#39;m still working out the math :)</p>




</div></div>
  </body>
</html>
