<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://webkit.org/blog/12257/the-file-system-access-api-with-origin-private-file-system/">Original</a>
    <h1>Safari now supports File System Access API with private origin</h1>
    
    <div id="readability-page-1" class="page"><div>
                <p>It is very common for an application to interact with local files. For example, a general workflow is opening a file, making some changes, and saving the file. For web apps, this might be hard to implement. It is possible to simulate the file operations using IndexedDB API, an HTML input element with the <code>file</code> type, an HTML anchor element with the <code>download</code> attribute, etc, but that would require a good understanding of these standards and careful design for a good user experience. Also, the performance may not be satisfactory for frequent operations and large files.</p>
<p>The <a href="https://developer.mozilla.org/en-US/docs/Web/API/File_System_Access_API">File System Access API</a> makes it possible for web apps to have easy and efficient file access. It provides a way to create, open, read, and write files directly. It also allows apps to create directories and enumerate their contents.</p>
<h2>Origin Private File System</h2>
<p>WebKit has added support for the File System Access API with <a href="https://wicg.github.io/file-system-access/#wellknowndirectory-origin-private-file-system">the origin private file system</a> — a private storage endpoint to some <a href="https://html.spec.whatwg.org/multipage/origin.html#concept-origin">origin</a>. Conceptually, every origin owns an independent directory, and a page can only access files or directories in its origin’s directory. For example, <a href="https://webkit.org/">https://webkit.org</a> cannot read files created by <a href="https://apple.com/">https://apple.com</a>.</p>
<p>Based on the implementation of different browsers, one entry in the origin private file system does not necessarily map to an entry in the user’s local filesystem — it can be an object stored in some database. That means a file or directory created via the File System Access API may not be easily retrieved from outside of the browser.</p>
<h2>Persistence</h2>
<p>The API is currently unavailable for Safari windows in Private Browsing mode. For where is it available, its storage lifetime is the same as other persistent storage types like IndexedDB and LocalStorage. The storage policy will conform to the <a href="https://storage.spec.whatwg.org/#storage-endpoints">Storage Standard</a>. Safari users can view and delete file system storage for a site via Preferences on macOS or Settings on iOS.</p>
<h2>Browser Support</h2>
<p>The File System Access API with origin private file system is enabled in WebKit from <a href="https://commits.webkit.org/242951@main">r284131</a>. It is available in Safari on:</p>
<ul>
<li>macOS 12.2 and above</li>
<li>iOS 15.2 and above</li>
</ul>
<p>In Safari on macOS 12.4 and iOS 15.4, we introduced the <code>getFile()</code> method of <code>FileSystemFileHandle</code>.</p>
<h2>The API</h2>
<p>WebKit currently supports four interfaces of the File System Access API:</p>
<ul>
<li><code>FileSystemHandle</code>, which represents an entry in the file system. It is available in Worker and </li>
<li><code>FileSystemFileHandle</code>, which inherits from FileSystemHandle and represents a file entry. </li>
<li><code>FileSystemDirectoryHandle</code>, which inherits from FileSystemHandle and represents a directory entry. </li>
<li><code>FileSystemSyncAccessHandle</code>, which provides an exclusive duplex stream for synchronous read and write on an entry. Unlike the interfaces above, which exist in both Window and Worker contexts, <code>FileSystemSyncAccessHandle</code> is only available in Worker.</li>
</ul>
<p>With these basic interfaces in mind, let’s look at how to use them by diving into some examples.</p>
<h2>Examples</h2>
<h3>Accessing the Origin Private File System</h3>
<p>In the origin private file system, a <code>FileSystemHandle</code> represents either the root directory of the origin’s space, or a descendant of the root directory. Therefore, the first step is to get the root <code>FileSystemDirectoryHandle</code>. It is done via <a href="https://storage.spec.whatwg.org/#dom-navigatorstorage-storage"><code>StorageManager</code></a> interface.</p>
<pre><code><span>const</span> <span>root</span> <span>=</span> <span>await</span> <span>navigator</span>.<span>storage</span>.<span>getDirectory</span>();
</code></pre>
<h3>Creating a directory or a file</h3>
<p>With a <code>FileSystemDirectoryHandle</code> object like root, you can get access to its child with some specific name using <code>getDirectoryHandle()</code> and <code>getFileHandle()</code> methods.</p>
<pre><code><span>const</span> <span>untitledFile</span> <span>=</span> <span>await</span> <span>root</span>.<span>getFileHandle</span>(<span>&#34;Untitled.txt&#34;</span>, { <span>&#34;create&#34;</span> <span>:</span> <span>true</span> });
<span>const</span> <span>existingUntitledFile</span> <span>=</span> <span>await</span> <span>root</span>.<span>getFileHandle</span>(<span>&#34;Untitled.txt&#34;</span>);
<span>const</span> <span>diaryDirectory</span> <span>=</span> <span>await</span> <span>root</span>.<span>getDirectoryHandle</span>(<span>&#34;Diary Folder&#34;</span>, { <span>&#34;create&#34;</span> <span>:</span> <span>true</span> });
</code></pre>
<h3>Moving or Renaming a Directory or a File</h3>
<p>To move around the file or directory a <code>FileSystemHandle</code> represents, you can use the <code>move()</code> method. The first parameter is a <code>FileSystemDirectoryHandle</code> representing the target parent directory, and the second parameter is a <code>USVString</code> representing the target file name. The string must be a <a href="https://wicg.github.io/file-system-access/#valid-file-name">valid file name</a>.</p>
<pre><code><span>await</span> <span>untitledFile</span>.<span>move</span>(<span>diaryDirectory</span>, <span>untitledFile</span>.<span>name</span>);
<span>await</span> <span>untitledFile</span>.<span>move</span>(<span>diaryDirectory</span>, <span>&#34;Feb_01.txt&#34;</span>);
</code></pre>
<h3>Resolving the Path from a Directory Entry to its Descendant</h3>
<p>To find out if a <code>FileSystemHandle</code> is a descendant of an existing <code>FileSystemDirectoryHandle</code>, and to get their relative path, you can use the <code>resolve()</code> method. The result is an array of component names that forms the path.</p>
<pre><code><span>const</span> <span>diaryFile</span> <span>=</span> <span>await</span> <span>diaryDirectory</span>.<span>getFileHandle</span>(<span>&#34;Feb_01.txt&#34;</span>);
<span>const</span> <span>relativePath</span> <span>=</span> <span>await</span> <span>root</span>.<span>resolve</span>(<span>diaryFile</span>);
</code></pre>
<h3>Enumerating Contents in a Directory</h3>
<p>The methods introduced above require you to know the name of target, but if you don’t know the name, you can still get it by enumerating the contents of an existing directory with <code>async</code> iterators returned by the <code>keys()</code>, <code>values()</code>, and <code>entries()</code> methods.</p>
<pre><code><span>const</span> <span>trashDirectory</span> <span>=</span> <span>await</span> <span>root</span>.<span>getDirectoryHandle</span>(<span>&#34;Trash&#34;</span>, { <span>&#34;create&#34;</span> <span>:</span> <span>true</span> });
<span>const</span> <span>directoryNames</span> <span>=</span> [];
<span>for</span> <span>await</span> (<span>const</span> <span>handle</span> <span>of</span> <span>root</span>.<span>values</span>()) {
    <span>if</span> (<span>handle</span>.<span>kind</span> <span>=</span><span>=</span> <span>&#34;directory&#34;</span>) {
        <span>directoryNames</span>.<span>push</span>(<span>handle</span>.<span>name</span>);
    }
}
</code></pre>
<h3>Deleting a Directory or a File</h3>
<p>With a <code>FileSystemDirectoryHandle</code> object, you can delete its child entries by name with the <code>removeEntry()</code> method.</p>
<pre><code><span>await</span> <span>diaryDirectory</span>.<span>removeEntry</span>(<span>diaryFile</span>.<span>name</span>);
<span>await</span> <span>root</span>.<span>removeEntry</span>(<span>trashDirectory</span>.<span>name</span>, { <span>&#34;recursive&#34;</span> <span>:</span> <span>true</span> });
</code></pre>
<h3>Reading a File</h3>
<p>Once you have the <code>FileSystemFileHandle</code> representing the target file, you can read its properties and content by converting it to a <a href="https://w3c.github.io/FileAPI/#file-section"><code>File</code></a> object using the <code>getFile()</code> method. You can get file information and content using interfaces of <code>File</code>.</p>
<pre><code><span>const</span> <span>fileHandle</span> <span>=</span> <span>await</span> <span>root</span>.<span>getFileHandle</span>(<span>&#34;Draft.txt&#34;</span>, { <span>&#34;create&#34;</span> <span>:</span> <span>true</span> });
<span>const</span> <span>file</span> <span>=</span> <span>await</span> <span>fileHandle</span>.<span>getFile</span>();
</code></pre>
<h3>Reading and Writing a File in a Worker Thread</h3>
<p>Another way to read a file is to use the <code>read()</code> method of the <code>FileSystemSyncAccessHandle</code> interface. You can create a <code>FileSystemSyncAccessHandle</code> from a <code>FileSystemFileHandle</code> object using the <code>createSyncAccessHandle()</code> method. Since <code>FileSystemSyncAccessHandle</code> is only available in Worker contexts, you will need to <a href="https://html.spec.whatwg.org/multipage/workers.html#creating-a-dedicated-worker">create a dedicated Worker</a> first.</p>
<p>Unlike <code>getFile()</code> that returns a Promise, <code>read()</code> is synchronous, and thus provides better performance. If you’re aiming for the most efficient file access, <code>FileSystemSyncAccessHandle</code> is the way to go.</p>
<p>To write a file, you can use the synchronous <code>write()</code> method of <code>FileSystemSyncAccessHandle</code>. In the current implementation, this is the only way to write a file in WebKit.</p>
<p>To implement synchronous read and write operations, a <code>FileSystemSyncAccessHandle</code> must have exclusive access to a file entry. Therefore, the attempt to create a second <code>FileSystemSyncAccessHandle</code> on an entry will fail, if the previous <code>FileSystemSyncAccessHandle</code> is not closed properly.</p>
<pre><code><span>const</span> <span>root</span> <span>=</span> <span>await</span> <span>navigator</span>.<span>storage</span>.<span>getDirectory</span>();
<span>const</span> <span>draftFile</span> <span>=</span> <span>await</span> <span>root</span>.<span>getFileHandle</span>(<span>&#34;Draft.txt&#34;</span>);
<span>const</span> <span>accessHandle</span> <span>=</span> <span>await</span> <span>draftFile</span>.<span>createSyncAccessHandle</span>();
<span>const</span> <span>fileSize</span> <span>=</span> <span>await</span> <span>accessHandle</span>.<span>getSize</span>();
<span>const</span> <span>readBuffer</span> <span>=</span> <span>new</span> <span>ArrayBuffer</span>(<span>fileSize</span>);
<span>const</span> <span>readSize</span> <span>=</span> <span>accessHandle</span>.<span>read</span>(<span>readBuffer</span>, { <span>&#34;at&#34;</span><span>:</span> <span>0</span> });
<span>const</span> <span>encoder</span> <span>=</span> <span>new</span> <span>TextEncoder</span>();
<span>const</span> <span>writeBuffer</span> <span>=</span> <span>encoder</span>.<span>encode</span>(<span>&#34;Thank you for reading this.&#34;</span>);
<span>const</span> <span>writeSize</span> <span>=</span> <span>accessHandle</span>.<span>write</span>(<span>writeBuffer</span>, { <span>&#34;at&#34;</span> <span>:</span> <span>readSize</span> });
<span>await</span> <span>accessHandle</span>.<span>truncate</span>(<span>1</span>);
<span>await</span> <span>accessHandle</span>.<span>flush</span>();
<span>await</span> <span>accessHandle</span>.<span>close</span>();
</code></pre>
<h2>Summary</h2>
<p>If your web app needs to interact with files, you should try the new File System Access API. It provides interfaces that are similar to the native file system API, with optimized performance.</p>
<p>As the standard evolves and development goes on, we will keep adding or updating interfaces and methods according to the <a href="https://wicg.github.io/file-system-access/">File System Access API</a> spec. If you encounter any issue when using this API, please file a bug on <a href="https://bugs.webkit.org/">bugs.webkit.org</a> under the “Website Storage” component. You may also create a new bug report for feature requests, describing your use case and why the feature is important. If you have any question or suggestion about the API itself, you can file a spec issue in the <a href="https://github.com/wicg/file-system-access/issues/">WICG repo</a>. Your feedback is very important to us.</p>

                            </div></div>
  </body>
</html>
