<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://kiwiziti.com/~matt/wireguard/">Original</a>
    <h1>You may not need Cloudflare Tunnel. Linux is fine</h1>
    
    <div id="readability-page-1" class="page">
    
    
    <p>
      <a href="https://www.cloudflare.com/products/tunnel/">Cloudflare Tunnel</a>
      is a cool little product Cloudflare offers to essentially give your
      computer a public IP address. Getting a packet from point A to point B is
      Linux&#39;s bread and butter. Why not just use it?
    </p>
    <h2>what is a tunnel and why use one?</h2>
    <p>
      In this context, a tunnel allows you to expose a computer from your home
      to the internet easily and securely. It also might come with some
      performance benefits.
    </p>
    <p>
      Most folks love when someone comes to their house when invited, but I&#39;d
      say very few enjoy an intruder. This is exactly the experience of the
      internet for the majority: you can request information and get a response,
      but usually not the other way around.
    </p>
    <p>
      This is a bummer of a way to only experience the internet. In reality, you
      can have a website just like
      <a href="https://www.unicefusa.org/">unicefusa.org</a> or
      <a href="https://www.wikipedia.org/">wikipedia.org</a>. You can create a
      beautiful garden on the World Wide Web and people can swing by to enjoy
      that garden whenever. It&#39;s a very empowering and magical concept.
    </p>
    <p>
      The easiest way to set up your garden is to use somewhere already public
      instead of your own yard. That&#39;s what a lot of people do by using a
      <a href="https://en.wikipedia.org/wiki/Virtual_private_server">VPS</a>
      like <a href="https://www.digitalocean.com/">Digital Ocean</a>. The thing
      is, you have your own huge, wonderful yard. Why not plant your garden
      there? Plus, the community garden is a shared place. It doesn&#39;t really
      feel like <em>yours</em>.
    </p>
    <p>
      However, just because you want to let people experience your garden does
      not mean you want to allow folks to roam around <em>everywhere</em> at
      your place.
    </p>
    <p>
      One way to get back some privacy is to build a fence around your garden.
      People have been firewalling their networks via
      <a href="https://en.wikipedia.org/wiki/Network_address_translation">NAT</a>
      forever <a href="#footnote-1">[1]</a>. Making an impenetrable fence around
      your garden is pretty easy, but configuring the fence on what to let in or
      out is the hard part.
    </p>
    <p>
      Another issue is telling people where your garden is. Ah, you could use a
      <a href="https://www.duckdns.org/">DNS server</a> to broadcast your IP
      address! You&#39;ll have to keep the phone book up to date with your current
      address... wait, did I just say your current home address?! You&#39;re not
      crazy about having your address just being broadcasted out there in the
      yellow pages (even though you know it&#39;s really public knowledge). You
      might get an angry mob outside. You&#39;d have to build a pretty good fence
      around your garden to feel comfortable. You remember the days of trying to
      set up port forwarding to download that
      <a href="https://en.wikipedia.org/wiki/In_Rainbows">Radiohead CD</a> and
      it&#39;s no different this time. The manual is confusing. There are typos
      everywhere. You&#39;re really not sure you set it up right.
    </p>
    <p>
      There&#39;s another clever solution to all of that: blindfold your garden
      visitors and have a driver drive a
      <a href="https://en.wikipedia.org/wiki/DDoS_mitigation">reasonable number of people</a>
      back-and-forth to your fully imprisoned garden in an armored vehicle. Or
      instead of an armored car you could
      <a href="https://en.wikipedia.org/wiki/Encapsulation_(networking)">encapsulate the internet packets</a>
      and then
      <a href="https://en.wikipedia.org/wiki/WireGuard">encrypt those encapsulated packets</a>.
    </p>
    <p>
      An unexpected benefit of this seemingly radical approach is allowing most
      visitors to get to your garden as quickly as possible. The public
      community garden was right off the highway; everyone knew how to get
      there. Now that they had to go to your home, however, sometimes they&#39;d
      take really silly routes. Your new driver knows how to get to your house
      super fast. <a href="#footnote-2">[2]</a>
    </p>
    <p>
      Our approach here differs from Cloudflare&#39;s setup in a few ways, but the
      overall concept is identical. I&#39;ll outline those differences and their
      pros and cons in the conclusion.
    </p>
    <h2 id="how-">how do I set it up?</h2>
    <p>
      Get yourself a cheap VPS near you and make sure you get two IPv4
      addresses. We&#39;ll use one to SSH into the VPS and the other to use as your
      home computer&#39;s public address (<code>$PUBLIC_IPv4</code>).
    </p>
    <p>
      I went with <a href="https://www.hetzner.com/cloud">Hetzner</a> because
      they&#39;re awesome, they&#39;re like &lt;300 miles away, and each VPS instance is
      allotted a generous 20TB of traffic that I&#39;ll never in a million years
      use. Most importantly, they seem to have excellent
      <a href="https://www.peeringdb.com/net/23795">peering</a>.
    </p>
    <p>
      We&#39;ll assume you&#39;ve already
      <a href="https://www.wireguard.com/quickstart/">set up the Wireguard interfaces on both devices</a>. The public IPv4 address should not yet be set up (i.e. associated with
      an interface) on the VPS.
    </p>
    <h3>On your VPS</h3>
    <ul>
      <li>
        Allow this device to forward packets it gets that are destined to
        someone else&#39;s IPv4. You&#39;ll need to do this each time you boot. It can
        be made permanent, but how to do that varies from distro to distro. This
        allows your home computer to reply to messages it receives.
      </li>
      <pre><code><span>$</span> <span>sudo</span> <span>sysctl</span> -w net.ipv4.ip_forward=<span>1</span></code></pre>
      <li>
        Anything sent to your home server&#39;s Wireguard IPv4 address should travel
        via the Wireguard interface &#34;device&#34;. Standard stuff.
      </li>
      <pre><code><span>$</span> <span>ip</span> route \
     add <span>$HOME_WIREGUARD_IPv4</span> \
     dev <span>$WIREGUARD_INTERFACE_NAME</span> \
     scope link</code></pre>
      <li>
        Anything sent to your public IPv4 address should travel via the
        Wireguard interface &#34;device&#34;. Act as if the home Wireguard IPv4 is a
        router even though the public IPv4 looks completely different.
      </li>
      <pre><code><span>$</span> <span>ip</span> route \
     add <span>$PUBLIC_IPv4</span> \
     via <span>$HOME_WIREGUARD_IPv4</span> \
     dev <span>$WIREGUARD_INTERFACE_NAME</span> \
     onlink</code></pre>
      <li>
        Pretend to other routers connected to your real world ethernet interface
        that you&#39;re the owner of the public IPv4 address.
      </li>
      <pre><code><span>$</span> <span>ip</span> neighbour \
     add proxy <span>$PUBLIC_IPv4</span> \
     dev <span>$ETHERNET_INTERFACE_NAME</span></code></pre>
    </ul>
    <h3>On your home computer</h3>
    <ul>
      <li>
        Anything sent to your VPS&#39;s Wireguard IPv4 address should travel via the
        Wireguard interface &#34;device&#34;. Standard stuff.
      </li>
      <pre><code><span>$</span> <span>ip</span> route \
     add <span>$VPS_WIREGUARD_IPv4</span> \
     dev <span>$WIREGUARD_INTERFACE_NAME</span> \
     scope link</code></pre>
      <li>
        Make a new world of rules and call it: &#34;Table 200&#34;. Anything that
        subscribes to that world&#39;s rules will, by default, be sent to the VPS
        via Wireguard as if it were a router.
      </li>
      <pre><code><span>$</span> <span>ip</span> route \
     add default \
     via <span>$VPS_WIREGUARD_IPv4</span> \
     table 200</code></pre>
      <li>
        Make anything sent from the public IPv4 address subscribe to the world
        of &#34;Table 200&#34; rules.
      </li>
      <pre><code><span>$</span> <span>ip</span> rule \
     add from <span>$PUBLIC_IPv4</span> \
     lookup 200</code></pre>
    </ul>
      You may want to use the
      <a href="https://git.zx2c4.com/wireguard-tools/about/src/man/wg-quick.8">wg-quick</a>
      <code>PostUp</code> and <code>PostDown</code> configurations for these.
      For <code>PostDown</code>, replace <code>add</code> with
      <code>del</code> and do it in reverse.
    
    <h2 id="conclusion">conclusion</h2>
    <p>
      Does it work? Well, if you&#39;re reading this on
      <a href="https://kiwiziti.com/">kiwiziti.com</a> then the answer is yes.
      If you&#39;re reading it on the
      <a href="https://web.archive.org/web/*/https://kiwiziti.com/~matt/wireguard/">
        archive.org backup</a>, then maybe not so much.
    </p>
    <figure>
      <picture>
        <source type="image/avif" srcset="rack.avif"/>
        <source type="image/webp" srcset="rack.webp"/>
        <source type="image/jpeg" srcset="rack.jpg"/>
        <img src="https://kiwiziti.com/~matt/wireguard/rack.jpg" alt="A server next to a TV playing a scene in &#39;2001: A Space Odyssey&#39; where apes are interacting with an alien monolith" loading="lazy"/>
      </picture>
      <figcaption>
        My &#34;rack&#34; (lower right: laptop and NAS). </figcaption>
    </figure>
    <p>
      I bet it will work OK. Maybe even better than OK. I really think that CDNs
      are a premature optimization for like 99% of people. We have some really
      insanely powerful machines just idling at home. Residential fiber is
      increasingly available. Nginx is a nearly optimal finite state machine.
      The in-kernel Wireguard implementation is more than fast enough.
    </p>
    <p>
      Will it work better than Cloudflare Tunnel? Decidedly not. Coming back to
      our analogy at the beginning:
    </p>
    <ul>
      <li>
        Cloudflare&#39;s driver drives a
        <a href="https://github.com/cloudflare/boringtun">Ford GT</a>.
      </li>
      <li>
        They drive it on their
        <a href="https://www.cloudflare.com/products/argo-smart-routing/">own private roads</a>
        and valet the garden visitors right next to their own home.
      </li>
      <li>
        Cloudflare&#39;s driver is
        <a href="https://www.cloudflare.com/waf/">also a bouncer</a>. They&#39;ll
        deny rides to creeps.
      </li>
      <li>
        They offer their services for free: mileage, car, driving hours, and
        all. For... a while?
      </li>
    </ul>
    <p>By contrast:</p>
    <ul>
      <li>
        Our driver drives a
        <a href="https://en.wikipedia.org/wiki/Linux">5 speed manual transmission 2005 Subaru Forester with no sunroof and
          manual window motors</a>.
      </li>
      <li>
        We use public roads and visitors have to first
        <a href="https://www.he.net/">drive down the interstate</a> before they
        get transported by us.
      </li>
      <li>
        Our driver is kinda dumb. They just take everyone over to the garden,
        even
        <a href="https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol">ping packets</a>.
      </li>
      <li>Our driver costs a few bucks a month.</li>
    </ul>
    <p>
      I&#39;m not trying to insult our solution too much. I actually like it! We can
      find a mechanic in a stones&#39; throw if the car breaks. The car is
      <em>basic</em>, sure, but it doesn&#39;t even run a userspace daemon to
      manage. And are the interstates <em>really</em> that much slower than
      Cloudflare&#39;s private roads?
    </p>
    <p>
      I guess the decision point for me comes down to the driver. I&#39;m pretty
      sure Cloudflare&#39;s driver is trying to take over the world and I think
      diversity is one of the most important things. Also, our driver is
      predictable. The contract is known and an amazing price. If I pay Hetzner,
      they&#39;ll get the job done. Cloudflare is less certain. Their driver seems
      amazing and does amazing things. I may even have a bit of a crush on the
      driver. But will Cloudflare back out and leave me high and dry if I
      suddenly get a lot of traffic? What if my website makes it big?! Talk
      about premature optimization...
    </p>
    <p>
      Really, though, using a pre-built solution like Cloudflare Tunnel that
      checks all the boxes sounds like a decision I&#39;d make at <em>work</em>. But
      I&#39;m at <em>home</em>. And a little step closer to touching that big wire
      we&#39;re all talking to each other over.
    </p>
    
  

</div>
  </body>
</html>
