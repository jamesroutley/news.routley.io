<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/bracesdev/errtrace">Original</a>
    <h1>Show HN: Error return traces for Go, inspired by Zig</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/bracesdev/errtrace/blob/main/assets/logo.png"><img src="https://github.com/bracesdev/errtrace/raw/main/assets/logo.png" alt="errtrace logo"/></a></p>
<p dir="auto"><a href="https://github.com/bracesdev/errtrace/actions/workflows/ci.yml"><img src="https://github.com/bracesdev/errtrace/actions/workflows/ci.yml/badge.svg" alt="CI"/></a>
<a href="https://pkg.go.dev/braces.dev/errtrace" rel="nofollow"><img src="https://camo.githubusercontent.com/fdfb8e972c0c28a657a02616dc1ed235e576c7e8be1ffa99164dcee8a3a8d35a/68747470733a2f2f706b672e676f2e6465762f62616467652f6272616365732e6465762f65727274726163652e737667" alt="Go Reference" data-canonical-src="https://pkg.go.dev/badge/braces.dev/errtrace.svg"/></a>
<a href="https://codecov.io/gh/bracesdev/errtrace" rel="nofollow"><img src="https://camo.githubusercontent.com/3ad3b5110532b338480bd45fd91f88ef6b230d0a4962ac45793f29d61e97add2/68747470733a2f2f636f6465636f762e696f2f67682f6272616365736465762f65727274726163652f67726170682f62616467652e7376673f746f6b656e3d4b445930345845454a39" alt="codecov" data-canonical-src="https://codecov.io/gh/bracesdev/errtrace/graph/badge.svg?token=KDY04XEEJ9"/></a></p>
<ul dir="auto">
<li><a href="#introduction">Introduction</a>
<ul dir="auto">
<li><a href="#features">Features</a></li>
<li><a href="#try-it-out">Try it out</a></li>
<li><a href="#why-is-this-useful">Why is this useful</a></li>
</ul>
</li>
<li><a href="#installation">Installation</a></li>
<li><a href="#usage">Usage</a>
<ul dir="auto">
<li><a href="#manual-instrumentation">Manual instrumentation</a></li>
<li><a href="#automatic-instrumentation">Automatic instrumentation</a></li>
</ul>
</li>
<li><a href="#performance">Performance</a></li>
<li><a href="#caveats">Caveats</a>
<ul dir="auto">
<li><a href="#error-wrapping">Error wrapping</a></li>
<li><a href="#safety">Safety</a></li>
</ul>
</li>
<li><a href="#contributing">Contributing</a></li>
<li><a href="#acknowledgements">Acknowledgements</a></li>
<li><a href="#license">License</a></li>
</ul>
<h2 tabindex="-1" dir="auto"><a id="user-content-introduction" aria-hidden="true" tabindex="-1" href="#introduction"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Introduction</h2>
<p dir="auto">errtrace is an <strong>experimental</strong> package to trace an error&#39;s return path —
the return trace — through a Go program.</p>
<p dir="auto">Where a stack trace tracks the code path that led to an error,
a return trace tracks the code path that the error took to get to the user.
Often these are the same path, but in Go they can diverge,
since errors are values that can be transported across goroutines
(e.g. with channels).
When that happens, a return trace can be more useful than a stack trace.</p>
<p dir="auto">This library is inspired by
<a href="https://ziglang.org/documentation/0.11.0/#Error-Return-Traces" rel="nofollow">Zig&#39;s error return traces</a>.</p>
<h3 tabindex="-1" dir="auto"><a id="user-content-features" aria-hidden="true" tabindex="-1" href="#features"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Features</h3>
<ul dir="auto">
<li><strong>Lightweight</strong></li>
<li><strong><a href="#manual-instrumentation">Simple</a></strong></li>
<li><strong><a href="#automatic-instrumentation">Easy</a></strong></li>
<li><strong><a href="#performance">Fast</a></strong></li>
</ul>
<h3 tabindex="-1" dir="auto"><a id="user-content-try-it-out" aria-hidden="true" tabindex="-1" href="#try-it-out"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Try it out</h3>
<p dir="auto">Try out errtrace with your own code:</p>
<ol dir="auto">
<li>
<p dir="auto">Install the CLI.</p>
<div dir="auto" data-snippet-clipboard-copy-content="go install braces.dev/errtrace/cmd/errtrace@latest"><pre>go install braces.dev/errtrace/cmd/errtrace@latest</pre></div>
</li>
<li>
<p dir="auto">Switch to your Git repository and instrument your code.</p>
<div dir="auto" data-snippet-clipboard-copy-content="git ls-files -- &#39;*.go&#39; | xargs errtrace -w"><pre>git ls-files -- <span><span>&#39;</span>*.go<span>&#39;</span></span> <span>|</span> xargs errtrace -w</pre></div>
</li>
<li>
<p dir="auto">Let <code>go mod tidy</code> install the errtrace Go module for you.</p>

</li>
<li>
<p dir="auto">Run your tests to ensure everything still works.
You may see failures
if you&#39;re comparing errors with <code>==</code> on critical paths
or if you&#39;re type-casting errors directly.
See <a href="#error-wrapping">Error wrapping</a> for more details.</p>

</li>
<li>
<p dir="auto">Print return traces for errors in your code.
To do this, you can use the <code>errtrace.FormatString</code> function
or format the error with <code>%+v</code> in <code>fmt.Printf</code>-style functions.</p>
<div dir="auto" data-snippet-clipboard-copy-content="if err != nil {
  fmt.Fprintf(os.Stderr, &#34;%+v&#34;, err)
}"><pre><span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
  <span>fmt</span>.<span>Fprintf</span>(<span>os</span>.<span>Stderr</span>, <span>&#34;%+v&#34;</span>, <span>err</span>)
}</pre></div>
</li>
</ol>
<p dir="auto">Return traces printed by errtrace
will include the error message
and the path the error took until it was printed.
The output will look roughly like this:</p>
<div data-snippet-clipboard-copy-content="error message

example.com/myproject.MyFunc
	/home/user/myproject/myfile.go:123
example.com/myproject.CallerOfMyFunc
	/home/user/myproject/another_file.go:456
[...]"><pre><code>error message

example.com/myproject.MyFunc
	/home/user/myproject/myfile.go:123
example.com/myproject.CallerOfMyFunc
	/home/user/myproject/another_file.go:456
[...]
</code></pre></div>
<p dir="auto">Some real world examples of errtrace in action:</p>
<details>
<summary>Example 1</summary>
<div data-snippet-clipboard-copy-content="doc2go: parse file: /path/to/project/example/foo.go:3:1: expected declaration, found invalid

go.abhg.dev/doc2go/internal/gosrc.parseFiles
        /path/to/project/internal/gosrc/parser.go:85
go.abhg.dev/doc2go/internal/gosrc.(*Parser).ParsePackage
        /path/to/project/internal/gosrc/parser.go:44
main.(*Generator).renderPackage
        /path/to/project/generate.go:193
main.(*Generator).renderTree
        /path/to/project/generate.go:141
main.(*Generator).renderTrees
        /path/to/project/generate.go:118
main.(*Generator).renderPackageIndex
        /path/to/project/generate.go:149
main.(*Generator).renderTree
        /path/to/project/generate.go:137
main.(*Generator).renderTrees
        /path/to/project/generate.go:118
main.(*Generator).renderPackageIndex
        /path/to/project/generate.go:149
main.(*Generator).renderTree
        /path/to/project/generate.go:137
main.(*Generator).renderTrees
        /path/to/project/generate.go:118
main.(*Generator).Generate
        /path/to/project/generate.go:110
main.(*mainCmd).run
        /path/to/project/main.go:199"><pre><code>doc2go: parse file: /path/to/project/example/foo.go:3:1: expected declaration, found invalid

go.abhg.dev/doc2go/internal/gosrc.parseFiles
        /path/to/project/internal/gosrc/parser.go:85
go.abhg.dev/doc2go/internal/gosrc.(*Parser).ParsePackage
        /path/to/project/internal/gosrc/parser.go:44
main.(*Generator).renderPackage
        /path/to/project/generate.go:193
main.(*Generator).renderTree
        /path/to/project/generate.go:141
main.(*Generator).renderTrees
        /path/to/project/generate.go:118
main.(*Generator).renderPackageIndex
        /path/to/project/generate.go:149
main.(*Generator).renderTree
        /path/to/project/generate.go:137
main.(*Generator).renderTrees
        /path/to/project/generate.go:118
main.(*Generator).renderPackageIndex
        /path/to/project/generate.go:149
main.(*Generator).renderTree
        /path/to/project/generate.go:137
main.(*Generator).renderTrees
        /path/to/project/generate.go:118
main.(*Generator).Generate
        /path/to/project/generate.go:110
main.(*mainCmd).run
        /path/to/project/main.go:199
</code></pre></div>
<p dir="auto">Note the some functions repeat in this trace
because the functions are mutually recursive.</p>
</details>
<details open="">
<summary>Example 2</summary>
<p dir="auto">Realistic comparison of a
stacktrace versus an error return trace
for a custom dial error from the HTTP client,
which happens on a background goroutine.</p>
<table>
<thead>
<tr><td>errtrace</td><td>stacktrace</td></tr>
</thead>
<tbody>
<tr><td>
<div data-snippet-clipboard-copy-content="Error: connect rate limited

braces.dev/errtrace_test.rateLimitDialer
	/path/to/errtrace/example_http_test.go:72
braces.dev/errtrace_test.(*PackageStore).updateIndex
	/path/to/errtrace/example_http_test.go:59
braces.dev/errtrace_test.(*PackageStore).Get
	/path/to/errtrace/example_http_test.go:49"><pre><code>Error: connect rate limited

braces.dev/errtrace_test.rateLimitDialer
	/path/to/errtrace/example_http_test.go:72
braces.dev/errtrace_test.(*PackageStore).updateIndex
	/path/to/errtrace/example_http_test.go:59
braces.dev/errtrace_test.(*PackageStore).Get
	/path/to/errtrace/example_http_test.go:49
</code></pre></div>
</td><td>
<div data-snippet-clipboard-copy-content="Error: connect rate limited
braces.dev/errtrace_test.rateLimitDialer
	/errtrace/example_stack_test.go:81
net/http.(*Transport).dial
	/goroot/src/net/http/transport.go:1190
net/http.(*Transport).dialConn
	/goroot/src/net/http/transport.go:1625
net/http.(*Transport).dialConnFor
	/goroot/src/net/http/transport.go:1467
runtime.goexit
	/goroot/src/runtime/asm_arm64.s:1197"><pre><code>Error: connect rate limited
braces.dev/errtrace_test.rateLimitDialer
	/errtrace/example_stack_test.go:81
net/http.(*Transport).dial
	/goroot/src/net/http/transport.go:1190
net/http.(*Transport).dialConn
	/goroot/src/net/http/transport.go:1625
net/http.(*Transport).dialConnFor
	/goroot/src/net/http/transport.go:1467
runtime.goexit
	/goroot/src/runtime/asm_arm64.s:1197
</code></pre></div>
</td></tr>
<tr>
<td>errtrace reports the method that triggered the HTTP request</td>
<td>stacktrace shows details of how the HTTP client creates a connection</td>
</tr>
</tbody>
</table>
</details>
<h3 tabindex="-1" dir="auto"><a id="user-content-why-is-this-useful" aria-hidden="true" tabindex="-1" href="#why-is-this-useful"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Why is this useful?</h3>
<p dir="auto">In Go, <a href="https://go.dev/blog/errors-are-values" rel="nofollow">errors are values</a>.
This means that an error can be passed around like any other value.
You can store it in a struct, pass it through a channel, etc.
This level of flexibility is great,
but it can also make it difficult to track down the source of an error.
A stack trace stored in an error — recorded at the error site —
becomes less useful as the error moves through the program.
When it&#39;s eventually surfaced to the user,
we&#39;ve lost a lot of context about its origin.</p>
<p dir="auto">With errtrace,
we instead record the path the program took from the error site
to get to the user — the <strong>return trace</strong>.
Not only can this be more useful than a stack trace,
it tends to be much faster and more lightweight as well.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-installation" aria-hidden="true" tabindex="-1" href="#installation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Installation</h2>
<p dir="auto">Install errtrace with Go modules:</p>
<div dir="auto" data-snippet-clipboard-copy-content="go get braces.dev/errtrace@latest"><pre>go get braces.dev/errtrace@latest</pre></div>
<p dir="auto">If you want to use the CLI, use <code>go install</code>.</p>
<div dir="auto" data-snippet-clipboard-copy-content="go install braces.dev/errtrace/cmd/errtrace@latest"><pre>go install braces.dev/errtrace/cmd/errtrace@latest</pre></div>
<h2 tabindex="-1" dir="auto"><a id="user-content-usage" aria-hidden="true" tabindex="-1" href="#usage"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Usage</h2>
<p dir="auto">errtrace offers the following modes of usage:</p>
<ul dir="auto">
<li><a href="#manual-instrumentation">Manual instrumentation</a></li>
<li><a href="#automatic-instrumentation">Automatic instrumentation</a></li>
</ul>
<h3 tabindex="-1" dir="auto"><a id="user-content-manual-instrumentation" aria-hidden="true" tabindex="-1" href="#manual-instrumentation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Manual instrumentation</h3>
<div dir="auto" data-snippet-clipboard-copy-content="import &#34;braces.dev/errtrace&#34;"><pre><span>import</span> <span>&#34;braces.dev/errtrace&#34;</span></pre></div>
<p dir="auto">Under manual instrumentation,
you&#39;re expected to import errtrace,
and wrap errors at all return sites like so:</p>
<div dir="auto" data-snippet-clipboard-copy-content="// ...
if err != nil {
    return errtrace.Wrap(err)
}"><pre><span>// ...</span>
<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
    <span>return</span> <span>errtrace</span>.<span>Wrap</span>(<span>err</span>)
}</pre></div>
<details>
<summary>Example</summary>
<p dir="auto">Given a function like the following:</p>
<div dir="auto" data-snippet-clipboard-copy-content="func writeToFile(path string, src io.Reader) error {
  dst, err := os.Create(path)
  if err != nil {
    return err
  }
  defer dst.Close()

  if _, err := io.Copy(dst, src); err != nil {
    return err
  }

  return nil
}"><pre><span>func</span> <span>writeToFile</span>(<span>path</span> <span>string</span>, <span>src</span> io.<span>Reader</span>) <span>error</span> {
  <span>dst</span>, <span>err</span> <span>:=</span> <span>os</span>.<span>Create</span>(<span>path</span>)
  <span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
    <span>return</span> <span>err</span>
  }
  <span>defer</span> <span>dst</span>.<span>Close</span>()

  <span>if</span> <span>_</span>, <span>err</span> <span>:=</span> <span>io</span>.<span>Copy</span>(<span>dst</span>, <span>src</span>); <span>err</span> <span>!=</span> <span>nil</span> {
    <span>return</span> <span>err</span>
  }

  <span>return</span> <span>nil</span>
}</pre></div>
<p dir="auto">With errtrace, you&#39;d change it to:</p>
<div dir="auto" data-snippet-clipboard-copy-content="func writeToFile(path string, src io.Reader) error {
  dst, err := os.Create(path)
  if err != nil {
    return errtrace.Wrap(err)
  }
  defer dst.Close()

  if _, err := io.Copy(dst, src); err != nil {
    return errtrace.Wrap(err)
  }

  return nil
}"><pre><span>func</span> <span>writeToFile</span>(<span>path</span> <span>string</span>, <span>src</span> io.<span>Reader</span>) <span>error</span> {
  <span>dst</span>, <span>err</span> <span>:=</span> <span>os</span>.<span>Create</span>(<span>path</span>)
  <span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
    <span>return</span> <span>errtrace</span>.<span>Wrap</span>(<span>err</span>)
  }
  <span>defer</span> <span>dst</span>.<span>Close</span>()

  <span>if</span> <span>_</span>, <span>err</span> <span>:=</span> <span>io</span>.<span>Copy</span>(<span>dst</span>, <span>src</span>); <span>err</span> <span>!=</span> <span>nil</span> {
    <span>return</span> <span>errtrace</span>.<span>Wrap</span>(<span>err</span>)
  }

  <span>return</span> <span>nil</span>
}</pre></div>
<p dir="auto">It&#39;s important that the <code>errtrace.Wrap</code> function is called
inside the same function that&#39;s actually returning the error.
A helper function will not suffice.</p>
</details>
<h3 tabindex="-1" dir="auto"><a id="user-content-automatic-instrumentation" aria-hidden="true" tabindex="-1" href="#automatic-instrumentation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Automatic instrumentation</h3>
<p dir="auto">If manual instrumentation is too much work (we agree),
we&#39;ve included a tool that will automatically instrument
all your code with errtrace.</p>
<p dir="auto">First, <a href="#installation">install the tool</a>.
Then, run it on your code:</p>
<div dir="auto" data-snippet-clipboard-copy-content="errtrace -w path/to/file.go path/to/another/file.go"><pre>errtrace -w path/to/file.go path/to/another/file.go</pre></div>
<p dir="auto">To run it on all Go files in your project,
if you use Git, run the following command on a Unix-like system:</p>
<div dir="auto" data-snippet-clipboard-copy-content="git ls-files -- &#39;*.go&#39; | xargs errtrace -w"><pre>git ls-files -- <span><span>&#39;</span>*.go<span>&#39;</span></span> <span>|</span> xargs errtrace -w</pre></div>
<p dir="auto">errtrace can be set be setup as a custom formatter in your editor,
similar to gofmt or goimports.</p>
<h4 tabindex="-1" dir="auto"><a id="user-content-opting-out-during-automatic-instrumentation" aria-hidden="true" tabindex="-1" href="#opting-out-during-automatic-instrumentation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Opting-out during automatic instrumentation</h4>
<p dir="auto">If you&#39;re relying on automatic instrumentation
and want to ignore specific lines from being instrumented,
you can add a comment in one of the following forms
on relevant lines:</p>
<div dir="auto" data-snippet-clipboard-copy-content="//errtrace:skip
//errtrace:skip explanation"><pre><span>//errtrace:skip</span>
<span>//errtrace:skip explanation</span></pre></div>
<p dir="auto">This can be especially useful if the returned error
has to match another error exactly because the caller still uses <code>==</code>.</p>
<p dir="auto">For example, if you&#39;re implementing <code>io.Reader</code>,
you need to return <code>io.EOF</code> when you reach the end of the input.
Wrapping it will cause functions like <code>io.ReadAll</code> to misbehave.</p>
<div dir="auto" data-snippet-clipboard-copy-content="type myReader struct{/* ... */}

func (*myReader) Read(bs []byte) (int, error) {
  // ...
  return 0, io.EOF //errtrace:skip (io.Reader requires io.EOF)
}"><pre><span>type</span> <span>myReader</span> <span>struct</span>{<span>/* ... */</span>}

<span>func</span> (<span>*</span><span>myReader</span>) <span>Read</span>(<span>bs</span> []<span>byte</span>) (<span>int</span>, <span>error</span>) {
  <span>// ...</span>
  <span>return</span> <span>0</span>, <span>io</span>.<span>EOF</span> <span>//errtrace:skip (io.Reader requires io.EOF)</span>
}</pre></div>
<h2 tabindex="-1" dir="auto"><a id="user-content-performance" aria-hidden="true" tabindex="-1" href="#performance"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Performance</h2>
<p dir="auto">errtrace is designed to have very low overhead
on <a href="#supported-systems">supported systems</a>.</p>
<p dir="auto">Benchmark results for linux/amd64 on an Intel Core i5-13600 (best of 10):</p>
<div data-snippet-clipboard-copy-content="BenchmarkFmtErrorf      11574928               103.5 ns/op            40 B/op          2 allocs/op
# default build, uses Go assembly.
BenchmarkWrap           78173496                14.70 ns/op           24 B/op          0 allocs/op
# build with -tags safe to avoid assembly.
BenchmarkWrap            5958579               198.5 ns/op            24 B/op          0 allocs/op

# benchext compares capturing stacks using pkg/errors vs errtrace
# both tests capture ~10 frames,
BenchmarkErrtrace        6388651               188.4 ns/op           280 B/op          1 allocs/op
BenchmarkPkgErrors       1673145               716.8 ns/op           304 B/op          3 allocs/op"><pre><code>BenchmarkFmtErrorf      11574928               103.5 ns/op            40 B/op          2 allocs/op
# default build, uses Go assembly.
BenchmarkWrap           78173496                14.70 ns/op           24 B/op          0 allocs/op
# build with -tags safe to avoid assembly.
BenchmarkWrap            5958579               198.5 ns/op            24 B/op          0 allocs/op

# benchext compares capturing stacks using pkg/errors vs errtrace
# both tests capture ~10 frames,
BenchmarkErrtrace        6388651               188.4 ns/op           280 B/op          1 allocs/op
BenchmarkPkgErrors       1673145               716.8 ns/op           304 B/op          3 allocs/op
</code></pre></div>
<p dir="auto">Stack traces have a large initial cost,
while errtrace scales with each frame that an error is returned through.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-caveats" aria-hidden="true" tabindex="-1" href="#caveats"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Caveats</h2>
<h3 tabindex="-1" dir="auto"><a id="user-content-error-wrapping" aria-hidden="true" tabindex="-1" href="#error-wrapping"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Error wrapping</h3>
<p dir="auto">errtrace operates by wrapping your errors to add caller information.
As a result of this,
error comparisons and type-casting may not work as expected.
You can no longer use <code>==</code> to compare errors, or type-cast them directly.
You must use the standard library&#39;s
<a href="https://pkg.go.dev/errors#Is" rel="nofollow">errors.Is</a> and
<a href="https://pkg.go.dev/errors#As" rel="nofollow">errors.As</a> functions.</p>
<p dir="auto">For example, if you have a function <code>readFile</code>
that wraps an <code>io.EOF</code> error with errtrace:</p>
<p dir="auto"><strong>Matching errors</strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="err := readFile() // returns errtrace.Wrap(io.EOF)

// This will not work.
fmt.Println(err == io.EOF)          // false

// Use errors.Is instead.
fmt.Println(errors.Is(err, io.EOF)) // true"><pre><span>err</span> <span>:=</span> <span>readFile</span>() <span>// returns errtrace.Wrap(io.EOF)</span>

<span>// This will not work.</span>
<span>fmt</span>.<span>Println</span>(<span>err</span> <span>==</span> <span>io</span>.<span>EOF</span>)          <span>// false</span>

<span>// Use errors.Is instead.</span>
<span>fmt</span>.<span>Println</span>(<span>errors</span>.<span>Is</span>(<span>err</span>, <span>io</span>.<span>EOF</span>)) <span>// true</span></pre></div>
<p dir="auto">Similarly, if you have a function <code>runCmd</code>
that wraps an <code>exec.ExitError</code> error with errtrace:</p>
<p dir="auto"><strong>Type-casting errors</strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="err := runCmd() // returns errtrace.Wrap(&amp;exec.ExitError{...})

// This will not work.
exitErr, ok := err.(*exec.ExitError) // ok = false

// Use errors.As instead.
var exitErr *exec.ExitError
ok := errors.As(err, &amp;exitErr)       // ok = true"><pre><span>err</span> <span>:=</span> <span>runCmd</span>() <span>// returns errtrace.Wrap(&amp;exec.ExitError{...})</span>

<span>// This will not work.</span>
<span>exitErr</span>, <span>ok</span> <span>:=</span> <span>err</span>.(<span>*</span>exec.<span>ExitError</span>) <span>// ok = false</span>

<span>// Use errors.As instead.</span>
<span>var</span> <span>exitErr</span> <span>*</span>exec.<span>ExitError</span>
<span>ok</span> <span>:=</span> <span>errors</span>.<span>As</span>(<span>err</span>, <span>&amp;</span><span>exitErr</span>)       <span>// ok = true</span></pre></div>
<h4 tabindex="-1" dir="auto"><a id="user-content-linting" aria-hidden="true" tabindex="-1" href="#linting"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Linting</h4>
<p dir="auto">You can use <a href="https://github.com/polyfloyd/go-errorlint">go-errorlint</a>
to find places in your code
where you&#39;re comparing errors with <code>==</code> instead of using <code>errors.Is</code>
or type-casting them directly instead of using <code>errors.As</code>.</p>
<h3 tabindex="-1" dir="auto"><a id="user-content-safety" aria-hidden="true" tabindex="-1" href="#safety"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Safety</h3>
<p dir="auto">To achieve the performance above on <a href="#supported-systems">supported systems</a>,
errtrace makes use of unsafe operations using Go assembly
to read the caller information directly from the stack.
This is part of the reason why we have the disclaimer on top.</p>
<p dir="auto">errtrace includes an opt-in safe mode
that drops these unsafe operations in exchange for poorer performance.
To opt into safe mode,
use the <code>safe</code> build tag when compiling code that uses errtrace.</p>

<h4 tabindex="-1" dir="auto"><a id="user-content-supported-systems" aria-hidden="true" tabindex="-1" href="#supported-systems"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Supported systems</h4>
<p dir="auto">errtrace&#39;s unsafe operations are currently implemented
for <code>GOARCH=amd64</code> and <code>GOARCH=arm64</code> only.
Other systems are supported but they will use safe mode, which is slower.</p>
<p dir="auto">Contributions to support unsafe mode for other architectures are welcome.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-contributing" aria-hidden="true" tabindex="-1" href="#contributing"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Contributing</h2>
<p dir="auto">Contributions are welcome.
However, we ask that before contributing new features,
you <a href="https://github.com/bracesdev/errtrace/issues">open an issue</a>
to discuss the feature with us.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-acknowledgements" aria-hidden="true" tabindex="-1" href="#acknowledgements"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Acknowledgements</h2>
<p dir="auto">The idea of tracing return paths instead of stack traces
comes from <a href="https://ziglang.org/documentation/0.11.0/#Error-Return-Traces" rel="nofollow">Zig&#39;s error return traces</a>.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-license" aria-hidden="true" tabindex="-1" href="#license"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>License</h2>
<p dir="auto">This software is made available under the BSD3 license.
See LICENSE file for details.</p>
</article>
          </div></div>
  </body>
</html>
