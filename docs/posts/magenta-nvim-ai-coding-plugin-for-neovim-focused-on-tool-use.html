<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/dlants/magenta.nvim">Original</a>
    <h1>Show HN: Magenta.nvim – AI coding plugin for Neovim focused on tool use</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<div data-snippet-clipboard-copy-content="   ________
  ╱        ╲
 ╱         ╱
╱         ╱
╲__╱__╱__╱
Magenta is for agents."><pre><code>   ________
  ╱        ╲
 ╱         ╱
╱         ╱
╲__╱__╱__╱
Magenta is for agents.
</code></pre></div>
<p dir="auto">Jan 2025 update</p>
<p dir="auto"><a href="https://www.youtube.com/watch?v=BPnUO_ghMJQ" rel="nofollow"><img src="https://camo.githubusercontent.com/26cd141d6597af729d17fd0c0d8cf401c45835d664ef4161f39c53832d5eecd1/68747470733a2f2f696d672e796f75747562652e636f6d2f76692f42506e554f5f67684d4a512f302e6a7067" alt="video of Jan 2025 update" data-canonical-src="https://img.youtube.com/vi/BPnUO_ghMJQ/0.jpg"/></a></p>
<ul dir="auto">
<li>inline mode</li>
<li>context management</li>
<li>prompt caching</li>
<li>port to node</li>
</ul>
<p dir="auto">Plugin overview (Dec 2024)</p>
<p dir="auto"><a href="https://www.youtube.com/watch?v=i4YYvZwCMxM" rel="nofollow"><img src="https://camo.githubusercontent.com/282c25c21d6c3bc61eca02aa77727f185bb94ad19cb0ae9f0e53c989ded6ba2d/68747470733a2f2f696d672e796f75747562652e636f6d2f76692f69345959765a77434d784d2f302e6a7067" alt="video demo of the plugin" data-canonical-src="https://img.youtube.com/vi/i4YYvZwCMxM/0.jpg"/></a></p>
<ul dir="auto">
<li>chat window</li>
<li>tools</li>
<li>context pinning</li>
<li>architecture overview</li>
</ul>
<p dir="auto"><code>magenta.nvim</code> is a plugin for leveraging LLM agents in neovim. It provides a chat window where you can talk to your AI coding assistant, as well as tools to populate context and perform inline edits. In functionality, it&#39;s similar to cursor-compose, cody or windsurf.</p>
<p dir="auto">Rather than writing complex code to compress your repo and send it to the LLM (like a repomap in aider, etc...), magenta is built around the idea that the AI agent can choose which context to gather via tools.</p>
<p dir="auto">Flagship models will continue to get better at tools use, and as this happens, the gap between tools like magenta and other editors that try to be clever about context management will grow smaller.</p>

<p dir="auto">Make sure you have <a href="https://nodejs.org/en/download" rel="nofollow">node</a> installed, at least <code>v20</code>:</p>

<p dir="auto">The plugin will look for configuration for providers in the following env variables:</p>
<ul dir="auto">
<li>anthropic: ANTHROPIC_API_KEY</li>
<li>openai: OPENAI_API_KEY, OPENAI_BASE_URL</li>
</ul>

<div dir="auto" data-snippet-clipboard-copy-content="{
    &#34;dlants/magenta.nvim&#34;,
    lazy = false, -- you could also bind to &lt;leader&gt;mt
    build = &#34;npm install --frozen-lockfile&#34;,
    opts = {},
},"><pre>{
    <span><span>&#34;</span>dlants/magenta.nvim<span>&#34;</span></span>,
    <span>lazy</span> <span>=</span> <span>false</span>, <span><span>--</span> you could also bind to &lt;leader&gt;mt</span>
    <span>build</span> <span>=</span> <span><span>&#34;</span>npm install --frozen-lockfile<span>&#34;</span></span>,
    <span>opts</span> <span>=</span> {},
},</pre></div>

<div dir="auto" data-snippet-clipboard-copy-content="local vim = vim
local Plug = vim.fn[&#39;plug#&#39;]

vim.call(&#39;plug#begin&#39;)
Plug(&#39;dlants/magenta.vim&#39;, {
  [&#39;do&#39;] = &#39;npm install --frozen-lockfile&#39;,
})
vim.call(&#39;plug#end&#39;)

require(&#39;magenta&#39;).setup()"><pre><span>local</span> <span>vim</span> <span>=</span> <span>vim</span>
<span>local</span> <span>Plug</span> <span>=</span> <span>vim</span>.<span>fn</span>[<span><span>&#39;</span>plug#<span>&#39;</span></span>]

<span>vim</span>.<span>call</span>(<span><span>&#39;</span>plug#begin<span>&#39;</span></span>)
<span>Plug</span>(<span><span>&#39;</span>dlants/magenta.vim<span>&#39;</span></span>, {
  [<span><span>&#39;</span>do<span>&#39;</span></span>] <span>=</span> <span><span>&#39;</span>npm install --frozen-lockfile<span>&#39;</span></span>,
})
<span>vim</span>.<span>call</span>(<span><span>&#39;</span>plug#end<span>&#39;</span></span>)

<span>require</span>(<span><span>&#39;</span>magenta<span>&#39;</span></span>).<span>setup</span>()</pre></div>


<p dir="auto">Global keymaps are set <a href="https://github.com/dlants/magenta.nvim/blob/main/lua/magenta/init.lua#L12">here</a>.</p>
<p dir="auto">Input and display buffer keymaps are set <a href="https://github.com/dlants/magenta.nvim/blob/main/node/sidebar.ts#L87">here</a>.</p>
<p dir="auto">Commands are all nested under <code>:Magenta &lt;cmd&gt;</code>, and can be found <a href="https://github.com/dlants/magenta.nvim/blob/main/node/magenta.ts#L54">here</a>.</p>
<p dir="auto">TLDR:</p>
<ul dir="auto">
<li><code>&lt;leader&gt;mt</code> is for <code>:Magenta toggle</code>, will toggle the sidebar on and off.</li>
<li><code>&lt;leader&gt;mp</code> is for <code>:Magenta paste-selection</code>. In visual mode it will take the current selection and paste it into the input buffer.</li>
<li><code>&lt;leader&gt;mb</code> is for <code>:Magenta context-files</code> with your <em>current</em> file. It will pin the current file to your context.</li>
<li><code>&lt;leader&gt;mf</code> is for <code>:Magenta context-files</code> it allows you to select files via fzf-lua, and will pin those files to your context. This requires that fzf-lua is installed.</li>
<li><code>&lt;leader&gt;mc</code> is for <code>:Magenta clear</code>, which will clear the current chat.</li>
<li><code>&lt;leader&gt;ma</code> is for <code>:Magenta abort</code>, which will abort the current in-flight request.</li>
</ul>

<ul dir="auto">
<li><code>&lt;leader&gt;mi</code> is for <code>:Magenta start-inline-edit</code>, or <code>start-inline-edit-selection</code> in visual mode. This will bring up a new split where you can write a prompt to edit the current buffer. Magenta will force a find-and-replace tool use for normal mode, or force a replace tool use for the selection in visual mode.</li>
</ul>
<p dir="auto">Inline edit uses your chat history so far, so a great workflow is to build up context in the chat panel, and then use it to perform inline edits in a buffer.</p>

<p dir="auto">The display buffer is not modifiable, however you can interact with some parts of the display buffer by pressing <code>&lt;CR&gt;</code>. For example, you can expand the tool request and responses to see their details, and you can trigger a diff to appear on file edits.</p>
<ul dir="auto">
<li>hit enter on a [review] message to pull up the diff to try and edit init</li>
<li>hit enter on a tool to see the details of the request &amp; result. Enter again on any part of the expanded view to collapse it.</li>
<li>hit enter on a piece of context to remove it</li>
</ul>

<p dir="auto">The command <code>:Magenta provider &lt;provider&gt;</code> will set the current provider. Currently supported values are <code>openai</code> (defaults to ChatGPT 4o) and <code>anthropic</code> (defaults to Claude Sonnet 3.5). You can also provide configuration to setup that will choose the default provider and model. <a href="https://github.com/dlants/magenta.nvim/blob/main/lua/magenta/init.lua#L5">code</a></p>
<p dir="auto">Any provider that has a node sdk and supports tool use should be easy to add. Contributions are welcome.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">tools available to the LLM</h2><a id="user-content-tools-available-to-the-llm" aria-label="Permalink: tools available to the LLM" href="#tools-available-to-the-llm"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">See the most up-to-date list of implemented tools <a href="https://github.com/dlants/magenta.nvim/tree/main/node/tools">here</a>.</p>
<ul>
<li> list a directory (only in cwd, excluding hidden and gitignored files)</li>
<li> list current buffers (only buffers in cwd, excluding hidden and gitignored files)</li>
<li> get the contents of a file (requires user approval if not in cwd or hidden/gitignored)</li>
<li> get lsp diagnostics</li>
<li> get lsp references for a symbol in a buffer</li>
<li> get lsp &#34;hover&#34; info for a symbol in a buffer</li>
<li> insert or replace in a file (the user can then review the changes via neovim&#39;s <a href="https://neovim.io/doc/user/diff.html" rel="nofollow">diff mode</a>)</li>
</ul>

<ul dir="auto">
<li>It uses the new <a href="https://github.com/dlants/magenta.nvim/issues/1" data-hovercard-type="issue" data-hovercard-url="/dlants/magenta.nvim/issues/1/hovercard">rpc-pased remote plugin setup</a>. This means more flexible plugin development (can easily use both lua and typescript), and no need for <code>:UpdateRemotePlugins</code>! (h/t <a href="https://github.com/wallpants/bunvim">wallpants</a>).</li>
<li>The state of the plugin is managed via an elm-inspired architecture (The Elm Architecture or <a href="https://github.com/evancz/elm-architecture-tutorial">TEA</a>) <a href="https://github.com/dlants/magenta.nvim/blob/main/node/tea/tea.ts">code</a>. I think this makes it fairly easy to understand and lays out a clear pattern for extending the feature set, as well as <a href="https://github.com/dlants/magenta.nvim/blob/main/node/chat/chat.spec.ts">eases testing</a>. It also unlocks some cool future features (like the ability to persist a structured chat state into a file).</li>
<li>I spent a considerable amount of time figuring out a full end-to-end testing setup. Combined with typescript&#39;s async/await, it makes writing tests fairly easy and readable. The plugin is already fairly well-tested <a href="https://github.com/dlants/magenta.nvim/blob/main/node/magenta.spec.ts#L8">code</a>.</li>
<li>In order to use TEA, I had to build a VDOM-like system for rendering text into a buffer. This makes writing view code declarative. <a href="https://github.com/dlants/magenta.nvim/blob/main/node/tea/view.ts#L141">code</a> <a href="https://github.com/dlants/magenta.nvim/blob/main/node/tools/getFile.ts#L139">example defining a tool view</a></li>
<li>we can leverage existing sdks to communicate with LLMs, and async/await to manage side-effect chains, which greatly speeds up development. For example, streaming responses was pretty easy to implement, and I think is typically one of the trickier parts of other LLM plugins. <a href="https://github.com/dlants/magenta.nvim/blob/main/node/anthropic.ts#L49">code</a></li>
<li>smart prompt caching. Pinned files only move up in the message history when they change, which means the plugin is more likely to be able to use caching. I also implemented anthropic&#39;s prompt caching <a href="https://github.com/dlants/magenta.nvim/pull/30" data-hovercard-type="pull_request" data-hovercard-url="/dlants/magenta.nvim/pull/30/hovercard">pr</a> using an cache breakpoints.</li>
<li>I made an effort to expose the raw tool use requests and responses, as well as the stop reasons and usage info from interactions with each model. This should make debugging your workflows a lot more straightforward.</li>
</ul>

<p dir="auto">I think the closest plugins to this one are <a href="https://github.com/yetone/avante.nvim">avante.nvim</a> and <a href="https://github.com/olimorris/codecompanion.nvim">codecompanion.nvim</a></p>
<div dir="auto"><h2 tabindex="-1" dir="auto">compared to codecompanion:</h2><a id="user-content-compared-to-codecompanion" aria-label="Permalink: compared to codecompanion:" href="#compared-to-codecompanion"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Codecompanion has a single buffer, while magenta.nvim has separate input &amp; display buffers. This makes it easier to add some interactivity to the display buffer (since it&#39;s not directly editable). I think this makes it nicer for situations when the LLM uses multiple tools at once. So for example, in codecompanion when the LLM needs permission to open a file, or proposes a change, this takes over your editor, which isn&#39;t a nice workflow when the tool needs to edit multiple files.</p>

<p dir="auto">I think it&#39;s fairly similar. However, magenta.nvim is written in typescript and uses the sdks to implement streaming, which I think makes it more stable. I think the main advantage is the architecture is very clean so it should be easy to extend the functionality. Between typescript, sdks and the architecture, I think my velocity is pretty high. I haven&#39;t used avante in a while so I&#39;m not sure how close I got feature-wise, but it should be fairly close, and only after a couple of weeks of development time.</p>

<p dir="auto">AFAIK both avante and codecompanion roll their own tool system, so the tools are defined in-prompt, and they do the parsing of the tool use themselves. I&#39;m instead using the providers tool capabilities, like the one in <a href="https://docs.anthropic.com/en/docs/build-with-claude/tool-use" rel="nofollow">anthropic</a>. In practice I think this makes the tool use a lot more robust.</p>
<p dir="auto">I&#39;m not doing any treesitter analysis of symbols, dependencies, or repository summarization / repomap construction. As I mentioned in the intro, I&#39;m opting instead to rely on the agent to explore the repo using the tools available to it. Right now that&#39;s occasionally worse than the repomap approach, but I think with time it will matter less and less.</p>
<p dir="auto">Another thing that&#39;s probably glaringly missing is model selection and customization of keymappings, etc... I&#39;ll probably do some of this eventually, but if you use a different picker / completion plugin, or you would like to make something configurable that is not currently, I would welcome contributions.</p>

<p dir="auto">See <a href="https://github.com/dlants/magenta.nvim/blob/main/CONTRIBUTING.md">the contributions guide</a></p>
</article></div></div>
  </body>
</html>
