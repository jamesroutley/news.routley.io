<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/nh2/internal-contstrained-pki">Original</a>
    <h1>Just want simple TLS for your .internal network?</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text"><div dir="auto"><h2 tabindex="-1" dir="auto">Just want simple TLS for your <a href="https://en.wikipedia.org/wiki/.internal" rel="nofollow"><code>.internal</code></a> network?</h2><a id="user-content-just-want-simple-tls-for-your-internal-network" aria-label="Permalink: Just want simple TLS for your .internal network?" href="#just-want-simple-tls-for-your-internal-network"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Run</p>
<div dir="auto" data-snippet-clipboard-copy-content="./create-internal-constrained-pki.sh mydomain.internal"><pre>./create-internal-constrained-pki.sh mydomain.internal</pre></div>
<p dir="auto">It creates a root CA certificate that your users (colleagues/friends/family) can <strong><em>safely</em></strong> add to their devices&#39; trust store because it uses X.509 <a href="https://netflixtechblog.com/bettertls-c9915cd255c0" rel="nofollow"><code>Name Constraints</code></a> to provably restrict it to the chosen domain.</p>
<p dir="auto">The CA cannot be used to <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack" rel="nofollow">MitM</a> all traffic.</p>
<p dir="auto">Result:</p>
<div data-snippet-clipboard-copy-content="certs-and-keys/
    ca-mydomain.internal.crt           &lt;- root CA certificate to give to your users
                                          to _safely_ add to their devices&#39; trust store

    wildcard.mydomain.internal.crt     &lt;- certificate and key to use for hosting services
    wildcard.mydomain.internal.key.pem    under mydomain.internal and *.mydomain.internal"><pre><code>certs-and-keys/
    ca-mydomain.internal.crt           &lt;- root CA certificate to give to your users
                                          to _safely_ add to their devices&#39; trust store

    wildcard.mydomain.internal.crt     &lt;- certificate and key to use for hosting services
    wildcard.mydomain.internal.key.pem    under mydomain.internal and *.mydomain.internal
</code></pre></div>

<p dir="auto">Your users can run</p>
<div dir="auto" data-snippet-clipboard-copy-content="openssl x509 -noout -text -in ca-mydomain.internal.crt"><pre>openssl x509 -noout -text -in ca-mydomain.internal.crt</pre></div>
<p dir="auto">to verify which domains the root CA allows; it should show:</p>
<div data-snippet-clipboard-copy-content="            X509v3 Name Constraints: critical
                Permitted:
                  DNS:mydomain.internal
                  DNS:.mydomain.internal"><pre><code>            X509v3 Name Constraints: critical
                Permitted:
                  DNS:mydomain.internal
                  DNS:.mydomain.internal
</code></pre></div>

<ul dir="auto">
<li>Read the code of <code>create-internal-constrained-pki.sh</code> to see if it suites your goals:
<ul dir="auto">
<li>Default <code>VALIDITY_DAYS=&#34;3650&#34;</code></li>
<li><strong>No passphrases:</strong> The generated keys will be unencrypted (no passphrase) to allow the script to run without prompts. <strong>Generate them directly onto at-rest encrypted storage.</strong> If you want passphrases instead, add e.g. <code>-aes256</code> to the <code>openssl genrsa</code> invocations.</li>
</ul>
</li>
</ul>

<ul dir="auto">
<li>
<p dir="auto">Security StackExchange: <a href="https://security.stackexchange.com/questions/31376/can-i-restrict-a-certification-authority-to-signing-certain-domains-only/130674#130674" rel="nofollow">Can I restrict a Certification Authority to signing certain domains only?</a></p>
</li>
<li>
<p dir="auto"><a href="https://systemoverlord.com/2020/06/14/private-ca-with-x-509-name-constraints.html" rel="nofollow">https://systemoverlord.com/2020/06/14/private-ca-with-x-509-name-constraints.html</a>
with <code>openssl</code> instructions</p>
</li>
<li>
<p dir="auto"><a href="https://utcc.utoronto.ca/~cks/space/blog/tech/TLSInternalCANameConstraints" rel="nofollow">https://utcc.utoronto.ca/~cks/space/blog/tech/TLSInternalCANameConstraints</a></p>
</li>
<li>
<p dir="auto"><a href="https://utcc.utoronto.ca/~cks/space/blog/tech/TLSInternalCANameConstraintsII?showcomments" rel="nofollow">https://utcc.utoronto.ca/~cks/space/blog/tech/TLSInternalCANameConstraintsII?showcomments</a></p>
</li>
<li>
<p dir="auto"><a href="https://smallstep.com/docs/step-ca/" rel="nofollow"><code>step-ca</code></a> is easier than <code>openssl</code>, but apparently can use <code>Name Constraints</code> only in intermediate certificates:
<a href="https://smallstep.com/docs/step-ca/templates/#adding-name-constraints" rel="nofollow">https://smallstep.com/docs/step-ca/templates/#adding-name-constraints</a>
So this does not meet our goal.
<a href="https://smallstep.com/docs/step-ca/#limitations" rel="nofollow">https://smallstep.com/docs/step-ca/#limitations</a> also says:</p>
<blockquote>
<p dir="auto">Its root CA is always offline; a single-tier PKI is not supported</p>
</blockquote>
<p dir="auto">Further, see <a data-error-text="Failed to load title" data-id="1855170420" data-permission-text="Title is private" data-url="https://github.com/caddyserver/caddy/issues/5759" data-hovercard-type="issue" data-hovercard-url="/caddyserver/caddy/issues/5759/hovercard" href="https://github.com/caddyserver/caddy/issues/5759">caddyserver/caddy#5759</a></p>
</li>
<li>
<p dir="auto">Support in clients was originally bad, where many would allow to bypass the Name Constraints:
<a href="https://news.ycombinator.com/item?id=37537689" rel="nofollow">https://news.ycombinator.com/item?id=37537689</a></p>
</li>
<li>
<p dir="auto">The spec does not even require that Name Constraint be enforced on Root CAs, only on intermediates:
<a href="https://issues.chromium.org/issues/40685439" rel="nofollow">https://issues.chromium.org/issues/40685439</a></p>
<p dir="auto">That creates the same problem as above, not meeting the goal.</p>
<p dir="auto">However, Chrome now <a href="https://issues.chromium.org/issues/40685439" rel="nofollow">supports it</a> properly, and OpenSSL and Firefox already did before.</p>
<p dir="auto"><a href="https://bettertls.com" rel="nofollow">https://bettertls.com</a> tracks which implementations support it how well.
Good write-up: <a href="https://netflixtechblog.com/bettertls-c9915cd255c0" rel="nofollow">https://netflixtechblog.com/bettertls-c9915cd255c0</a></p>
</li>
<li>
<p dir="auto">Important point from <a data-error-text="Failed to load title" data-id="1855170420" data-permission-text="Title is private" data-url="https://github.com/caddyserver/caddy/issues/5759" data-hovercard-type="issue" data-hovercard-url="/caddyserver/caddy/issues/5759/hovercard?comment_id=1690700681&amp;comment_type=issue_comment" href="https://github.com/caddyserver/caddy/issues/5759#issuecomment-1690700681">caddyserver/caddy#5759 (comment)</a>:</p>
<blockquote>
<p dir="auto">People using name constraints should know what they exactly mean, as some cases are not obvious. For example, <strong>adding just <code>permittedDNSDomains</code> as above does not exclude creating domains with IP addresses or any other type of SAN</strong>. Name constraints are defined in <a href="https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.10" rel="nofollow">RFC5280#4.2.1.10</a></p>
</blockquote>
<ul dir="auto">
<li>See also:
<a href="https://github.com/FiloSottile/mkcert/pull/309/commits/922158ed6856077c8b07478d67e0a7a930b90510#r1805672121">https://github.com/FiloSottile/mkcert/pull/309/commits/922158ed6856077c8b07478d67e0a7a930b90510#r1805672121</a></li>
</ul>
</li>
</ul>
</article></div></div>
  </body>
</html>
