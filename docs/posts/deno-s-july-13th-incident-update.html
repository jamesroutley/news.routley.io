<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://deno.com/blog/2022-07-13-outage-post-mortem">Original</a>
    <h1>Denoâ€™s July 13th incident update</h1>
    
    <div id="readability-page-1" class="page"><div><p>Starting on July 13th (Wednesday) at approximately 18:00 UTC several services
provided by the Deno company experienced a regional service disruption in Utah
(us-west3) for a period of just over 24 hours. During this time people in the
Utah region experienced failures accessing projects hosted on Deno Deploy,
including many Deno web properties.</p>
<p>We have concluded that this outage was caused by our load balancing service.
This post details what exactly happened, and what we are doing to prevent this
in the future.</p>
<p>A shorter outage was also suffered on July 15 between 15:30 UTC and 16:00 UTC,
after attempting to bring the us-west3 region back online. The newly created
load balancer worked correctly for a few hours, but eventually encountered the
same problem. During this time projects hosted on Deno Deploy, including many
Deno web properties, were not available in this region.</p>
<p>All services are now operating normally again. No data was lost. We take outages
like these seriously and sincerely apologize for the disruption.</p>
<h2 id="impact"><a aria-hidden="true" tabindex="-1" href="#impact"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Impact</h2><p>For a period of around 24 hours, some users in the us-west3 region were unable
to access dash.deno.com, and Deno Deploy projects, including deno.com and
deno.land. This region is based in Utah, and services the surrounding area,
including some neighboring states. During the secondary incident, the impact was
the same, but for a much shorter time period; less than 30 minutes.</p>
<p>Only the us-west3 region was disrupted. All other regions operated normally
throughout the incident. Additionally, subhosting was not affected.</p>
<h2 id="timeline-of-events"><a aria-hidden="true" tabindex="-1" href="#timeline-of-events"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Timeline of events</h2><p>On July 13th, at around 18:45 UTC we started to receive reports of an outage
from a small number of users. We investigated the status of our services, but
were unable to confirm any of the reports. All of our status monitoring and
tests reported that everything was operating normally.</p>
<p>Over the course of the outage, we continued to monitor our service status, and
worked with some of the affected users to narrow down the source of the problem.</p>
<p>On July 14th, at 19:14 UTC we were able to identify that the problem was within
our us-west3 region, which we then took offline, directing traffic to other
nearby regions instead.</p>
<p>On July 15th, at 11:30 UTC we attempted to bring the region back online, with a
new load balancer instance.</p>
<p>On July 15th, at 16:00 UTC the load balancer entered the same faulted state as
before, and we again disabled the region. The region will remain disabled until
our monitoring has improved and the issue has been fixed more permanently.</p>
<h2 id="root-cause"><a aria-hidden="true" tabindex="-1" href="#root-cause"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Root cause</h2><p>End user requests entering the Deno Deploy network go through various load
balancers before ultimately ending up at a service that can execute JavaScript
code to respond to the request.</p>
<p>The different layers of load balancers and backend services use <a href="https://etcd.io/" rel="noopener noreferrer">etcd</a> to
preform service discovery. Services announce themselves to the etcd cluster when
their availability state changes. Other services (like these load balancers)
retrieve the list of healthy backend services from etcd. They also
<a href="https://etcd.io/docs/v3.2/learning/api/#watch-api" rel="noopener noreferrer">watch</a> the list of announced services to be informed when a given
service becomes available, or goes offline. The load balancers then use this
list to decide which backend services to route traffic to.</p>
<p>During this outage, one of the regional load balancers managed to sever its
connection to etcd without the application noticing. We expect this connection
to be routinely severed due to network faults, timeouts and the like. As such,
the application is programmed to reconnect automatically, and to shut itself off
if it fails.</p>
<p>Without this connection, the load balancer was unable to receive updates from
etcd. This resulted in it &#34;desynchronizing&#34; from the rest of the system, and not
knowing of any healthy backends to direct traffic to.</p>
<p>The situation of a load balancer not having any healthy backend services is not
terribly uncommon, and as such the load balancer knows how to deal with this. If
there are no healthy backends it will un-advertise itself from the network to
prevent requests ending up at this &#34;dead end&#34;.</p>
<p>Due to a design oversight in the load balancer, it did not un-advertise itself
from the system in this specific scenario. This resulted in the loadbalancer
continuing to receive traffic from upstream load balancers, without having
anywhere to direct the traffic to. This caused the traffic to be dropped
entirely.</p>
<h2 id="whats-next"><a aria-hidden="true" tabindex="-1" href="#whats-next"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>What&#39;s next?</h2><p>This incident has made it clear that a few blindspots exist within our
monitoring systems. We are looking into ways to reduce these, and to improve our
monitoring capabilities within individual regions.</p>
<p>Additionally it was difficult for us to narrow down which region was causing the
outage, because the load balancer that failed was very early in the network
stack (a TCP load balancer). It does not record any diagnostics about dropped
connections, nor does it have a return channel to return diagnostic information
to the user (unlike HTTP loadbalancers, which can return a response header). We
are working to improve the monitoring situation here.</p>
<p>We are also currently working on some architectural changes in the load
balancing system to prevent this class of failures entirely.</p>
</div></div>
  </body>
</html>
