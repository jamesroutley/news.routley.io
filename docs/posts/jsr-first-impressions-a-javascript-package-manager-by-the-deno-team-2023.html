<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.kitsonkelly.com/posts/jsr-first-impressions">Original</a>
    <h1>JSR first impressions: a JavaScript package manager by the Deno team (2023)</h1>
    
    <div id="readability-page-1" class="page"><div><p><a href="https://jsr.io" rel="noopener noreferrer">JSR</a> is a new package repository being introduced by the team
at Deno that aims to solve many problems in the Javascript eco-system. I was
invited to take part in very early access to it and want to share my
impressions.</p>
<p><img src="https://www.kitsonkelly.com/posts/jsr-first-impressions/hero.png" alt="Dinosaur unboxing the letters JSR"/></p>
<h2 id="a-bit-of-history-11"><a aria-hidden="true" tabindex="-1" href="#a-bit-of-history-11"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>A bit of history</h2><p>I was a very early contributor to Deno which eventually ended up with me joining
Deno when Ry and Bert got their seed funding.
<a href="https://www.kitsonkelly.com/posts/leaving-deno-land" rel="noopener noreferrer">I left after two years</a> to pursue work that was located in
Australia.</p>
<p>During my time in the Deno community I created <a href="https://deno.land/x/oak" rel="noopener noreferrer">oak</a>,
an Express-like middleware framework written specifically for Deno. It still to
this day remains a very popular framework. While I was at Deno, we often used it
as a proving ground for things, like automatically generating documentation,
making sure it worked on <a href="https://deno.com/deploy" rel="noopener noreferrer">Deno Deploy</a>, and other
changes to the ecosystem.</p>
<p>I think its continued popularity and usage was one of reasons the Deno team
reached out to me to give me very early access to JSR so I could see how it
would work with something like oak.</p>
<h2 id="what-is-jsr-11"><a aria-hidden="true" tabindex="-1" href="#what-is-jsr-11"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>What is JSR?</h2><p>JSR is a Javascript/TypeScript registry. It is <em>not</em> a package manager. It is
pretty clear that <a href="https://www.npmjs.com/" rel="noopener noreferrer">npm</a> was the first viable package
manager and registry for the Javascript ecosystem. Since then we have seen a lot
of innovation in the package manager side of the equation, with
<a href="https://yarnpkg.com/" rel="noopener noreferrer">yarn</a>, <a href="https://pnpm.io/" rel="noopener noreferrer">pnpm</a>, and even run-times
integrating that package manager like <a href="https://bun.sh/" rel="noopener noreferrer">Bun</a>.</p>
<p>This was all innovation on the package management side. There has been little
change or innovation on the registry side that still has the npm registry at its
core. There have been corporate solutions which deal with things like private
repositories and &#34;allow-listing&#34; approved packages, there have been solutions to
enhance the npm registry, like <a href="https://unpkg.com/" rel="noopener noreferrer">unpkg</a> and
<a href="https://esm.sh/" rel="noopener noreferrer">esm.sh</a>, and while useful, they are still intrinsically
coupled to the npm eco-system.</p>
<p>We in Deno tried to make a go of package-manager-less registry with
<a href="https://deno.land/x" rel="noopener noreferrer">deno.land/x</a> which worked somewhat well for Deno which
focused on &#34;package management as code&#34;, but it has had it challenges. Ones that
we were talking about before I left Deno.</p>
<p>JSR appears to be trying to innovate on that package registry side. Javascript
has come a long way since the early days of npm. The npm registry and package
manager were purpose built to serve a single runtime (Node.js) which was
introducing the world to the concept of Javascript modules which came out of a
community effort to scale JavaScript. We only really remember CommonJS for its
module syntax adopted by Node.js, but it was originally a lot more.</p>
<p>Now the Javascript eco-system is a lot different. We have a language that has
transformed itself, we have a standard for modules that services both server
run-times and client browsers, we have a world where TypeScript is as dominate
of a way to author Javascript code as Javascript by itself, and we have a
breadth of local server run-times, serverless run-times, and browsers.</p>
<h2 id="what-is-it-trying-to-solve-11"><a aria-hidden="true" tabindex="-1" href="#what-is-it-trying-to-solve-11"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>What is it trying to solve?</h2><p>I didn&#39;t get a brief from the Deno team on JSR, or its roadmap, so a lot of this
is formed from what I have seen using JSR.</p>
<p>The first thing it appears to try to solve are the challenges that we ran into
with <code>deno.land/x</code> and the package-manager as code approach to managing
dependencies. When it works, it is a great development experience, just focus on
authoring code. The problem then comes in trying to express version
dependencies. Each external dependency on <code>deno.land/x</code> is &#34;pinned&#34; to an exact
version. This is great from a &#34;stability&#34; method, but harder when common
libraries are shared across packages. <strong>JSR supports semver expression of
dependencies.</strong> While this has been in the npm world from the start, for Deno
users, this allows the flexibility and benefit of package-manager as code, but
with the benefits of not always pinning to a specific version.</p>
<p>Another problem that JSR appears to be trying to solve is <strong>fully supporting
TypeScript alongside Javascript</strong>. TypeScript didn&#39;t exist with the creation of
TypeScript and the solutions around TypeScript the community have arrived at
really work around the challenges. It is confusing for package maintainers, &#34;do
I ship both transpiled and source TypeScript code? If I ship both, how do I help
the users consume the package?&#34; It is a real mess. In JSR you publish your
source, be it TypeScript or Javascript, and the registry makes sure that the
users consume the right version of code.</p>
<p>In addition, <strong>published code is &#34;zapped&#34;</strong> (which appears to be originally
called FastCheck bit is migrating to Zap, which I suspect is because of the
testing libraries that conflict with &#34;fast check&#34;). This appears to be a level
of TypeScript type checking that can be accomplished without control flow
analysis, looking at the public API surface of the package. The upside is that
Zap is extremely fast, my antidotal evidence on oak is that it is about 10x -
15x faster. It also ensures that the published code can be fully documented via
automatic document generation.</p>
<p>For package author&#39;s JSR aspires to <strong>write once, run everywhere</strong>. While it
wasn&#39;t present in the early versions I played with and still has a ways to go, I
recently took the ability to load JSR packages via Node.js and npm. The registry
is runtime aware in that the package creator publishes a single version and the
registry handles serving up a version specific to the target runtime. At the
moment, the expectation is that the code is &#34;aware&#34; of the differences in the
runtime, but I suspect, in the near future there will be ways to enable
different ways of handling this. The Deno team created
<a href="https://deno.land/x/dnt" rel="noopener noreferrer">dnt</a> a while back and hopefully we will see some of
the features and ideas leveraged there work their way into JSR.</p>
<p><strong>Enrich the package development experience</strong> is an apparent goal. Back when I
was at Deno, we worked to improve the development experience with <code>deno.land/x</code>
so that package maintainers had a full suite of capabilities to improve their
downstream users development experience. The larger npm eco-system has innovated
on that, and <a href="https://npmjs.org" rel="noopener noreferrer">npmjs.org</a> has enriched the data to a degree
based on these innovations, but it still isn&#39;t the whole solution. One of the
big things we did with <code>deno.land/x</code> which has been brought into JSR, is the
automatic generation of documentation. The same mechanisms package authors use
to enrich the IDE experience through JSDoc and TypeScript type annotations is
used to generate rich online documentation for each package.</p>
<p>One of the advantages of Deno has always been the ability to use and TypeScript
code as a first class citizen. It means that as a package creator, I don&#39;t have
to figure out a way to distribute my type information alongside my runtime code
(or make the consumer of the package do it). This non-Deno eco-system challenge
has led some package authors to abandon developing in TypeScript in favour of
authoring in &#34;types-as-comments&#34; JavaScript. That approach comes with its own
complexities. I have it on good authority that while it isn&#39;t part of JSR at the
moment, very soon <strong>JSR will generate type definitions along with transpile
Javascript code</strong> when targeting the npm ecosystem. This means package authors
can write in TypeScript and users will be able to consume the packages without
need for either to worry about transpiling but have the ability to preserve the
full IDE experience uplift and type checking that comes from using TypeScript.</p>
<h2 id="capabilities-and-intelligent-limitations-11"><a aria-hidden="true" tabindex="-1" href="#capabilities-and-intelligent-limitations-11"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Capabilities and intelligent limitations</h2><p>Code being published on JSR can only depend upon other JSR packages, npm
packages, or Node.js built-ins. This <em>walled garden</em> appears to be an
intentional limitation/constraint. This makes sure that the registry eco-system
is contained and controllable.</p>
<p>But having access to the wider npm eco-system is transparent to both the package
author as well as the downstream user, and it uses the &#34;package-manager as code&#34;
style of management. For example, I use the great
<a href="https://github.com/pillarjs/path-to-regexp" rel="noopener noreferrer">path-to-regexp</a> library in oak. For
the <code>deno.land/x</code> version I publish I use the version that someone published to
<code>deno.land/x</code>. In the walled garden of JSR, a version would have to be published
to JSR (which I am sure the package maintainer is unlikely to be interested in
any time soon), or I could just use the version on npm. This is what I chose
when publishing on npm. I re-export all my dependencies from a <code>./deps.ts</code> file
in oak and this is what it looks like there:</p>
<div><pre><span>export</span> <span>{</span>
  compile<span>,</span>
  <span>type</span> <span>Key</span><span>,</span>
  match <span>as</span> pathMatch<span>,</span>
  parse <span>as</span> pathParse<span>,</span>
  <span>type</span> <span>ParseOptions</span><span>,</span>
  pathToRegexp<span>,</span>
  <span>type</span> <span>TokensToRegexpOptions</span><span>,</span>
<span>}</span> <span>from</span> <span>&#34;npm:path-to-regexp@6.2.1&#34;</span><span>;</span></pre></div><p>Another intentional limitation is that all published packages have to have fully
qualified module names for internal code. This is to avoid the challenge that
Node.js and the rest of the eco-system have had to try to unpick with how to
interpret modules without explicit resolution.</p>
<p>One of the things that npm was sort of weak on was a lot of dependency on
convention of what the public API service of a package was. That has been slowly
addressed through the addition of <code>&#34;exports&#34;</code> to <code>package.json</code>. With JSR, this
is explicit as well. As an author you have to either supply just a &#34;main&#34;
exported module, or a map of various named exports and their module. For oak, I
export everything, but have added named exports for various public parts of oak.
It looks like this in the <code>deno.json</code> (which is the single meta-data file for
JSR packages):</p>
<div><pre><span>{</span>
  <span>&#34;name&#34;</span><span>:</span> <span>&#34;@oak/oak&#34;</span><span>,</span>
  <span>&#34;version&#34;</span><span>:</span> <span>&#34;13.1.0&#34;</span><span>,</span>
  <span>&#34;exports&#34;</span><span>:</span> <span>{</span>
    <span>&#34;.&#34;</span><span>:</span> <span>&#34;./mod.ts&#34;</span><span>,</span>
    <span>&#34;./application&#34;</span><span>:</span> <span>&#34;./application.ts&#34;</span><span>,</span>
    <span>&#34;./body&#34;</span><span>:</span> <span>&#34;./body.ts&#34;</span><span>,</span>
    <span>&#34;./context&#34;</span><span>:</span> <span>&#34;./context.ts&#34;</span><span>,</span>
    <span>&#34;./helpers&#34;</span><span>:</span> <span>&#34;./helpers.ts&#34;</span><span>,</span>
    <span>&#34;./etag&#34;</span><span>:</span> <span>&#34;./etag.ts&#34;</span><span>,</span>
    <span>&#34;./form_data&#34;</span><span>:</span> <span>&#34;./form_data.ts&#34;</span><span>,</span>
    <span>&#34;./http_server_native&#34;</span><span>:</span> <span>&#34;./http_server_native.ts&#34;</span><span>,</span>
    <span>&#34;./proxy&#34;</span><span>:</span> <span>&#34;./middleware/proxy.ts&#34;</span><span>,</span>
    <span>&#34;./range&#34;</span><span>:</span> <span>&#34;./range.ts&#34;</span><span>,</span>
    <span>&#34;./request&#34;</span><span>:</span> <span>&#34;./request.ts&#34;</span><span>,</span>
    <span>&#34;./response&#34;</span><span>:</span> <span>&#34;./response.ts&#34;</span><span>,</span>
    <span>&#34;./router&#34;</span><span>:</span> <span>&#34;./router.ts&#34;</span><span>,</span>
    <span>&#34;./send&#34;</span><span>:</span> <span>&#34;./send.ts&#34;</span><span>,</span>
    <span>&#34;./serve&#34;</span><span>:</span> <span>&#34;./middleware/serve.ts&#34;</span><span>,</span>
    <span>&#34;./testing&#34;</span><span>:</span> <span>&#34;./testing.ts&#34;</span>
  <span>}</span>
<span>}</span></pre></div><p>As you can see from the above, there are now <code>&#34;name&#34;</code> and <code>&#34;version&#34;</code> fields
that go into the <code>deno.json</code> which are then used for publishing as well.</p>
<p>The Deno CLI is the publishing too for packages to JSR. It contains everything
you need as a package author. To publish a version, you simply do <code>deno publish</code>
and away you go. The CLI will do all the checks and the like and even includes
the <code>--dry-run</code> option to make sure it behaves. The interface, while adequate,
is obviously still maturing.</p>
<h2 id="the-registry-interface-11"><a aria-hidden="true" tabindex="-1" href="#the-registry-interface-11"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>The registry interface</h2><p>The registry web interface is already pretty rich. It is obviously building on a
lot of what we did for <code>deno.land/x</code> but it clearly takes it all to the next
level. For those of you familiar with <code>deno.land/x</code>, a lot will be familiar, but
for those of you not familiar, you can see how the amount of information
available goes beyond what we currently get through the npm-ecosystem, all in
one place.</p>
<p>This is what the oak package landing page looks like on JSR:</p>
<p><img src="https://www.kitsonkelly.com/images/overview.png" alt="Screenshot of the landing page for the oak package on jsr.io"/></p>
<p>Because I have a module JSDoc block in the main entrypoint of oak, it is
displaying that as the main document versus the README. If it wasn&#39;t present, it
would have displayed the README instead.</p>
<p>There are instructions on how to install a package under npm (or other
npm-ecosystem package managers):</p>
<p><img src="https://www.kitsonkelly.com/images/npm_install.png" alt="Installation instructions for oak on npm"/></p>
<p>The instructions work, but the problem is that the code published to oak doesn&#39;t
support Node.js yet. While I do publish
<a href="https://www.npmjs.com/package/@oakserver/oak" rel="noopener noreferrer">oak to npm directly</a> at the
moment and that version works and is tested under Node.js, the same solutions
for providing that capability aren&#39;t built into JSR. I have provided the team my
feedback on this and hopefully we will see improvements in that area. I will
also see if I can find a way to support both runtimes under the single JSR
version.</p>
<p>One of the great thing we experimented with on <code>deno.land/x</code> but had a hard time
getting right appears to have been integrated directly in JSR, the ability to
search for symbols:</p>
<p><img src="https://www.kitsonkelly.com/images/symbol_search.png" alt="Searching for &#34;router&#34; on oak"/></p>
<p>Here is the view of the dependencies for oak on JSR, where you express all your
dependencies as code including the semver constraints which is automatically
analyzed when you publish:</p>
<p><img src="https://www.kitsonkelly.com/images/dependencies.png" alt="List of dependencies for oak"/></p>
<p>There is clearly an opportunity here to further enrich this with other data like
if the dependency is current, or what are the changes the semver actually
resolves to.</p>
<p>You also get a view of the versions published on the registry of a package,
because I am the owner of the package, I also have the ability to &#34;yank&#34; a
version:</p>
<p><img src="https://www.kitsonkelly.com/images/versions.png" alt="The versions of oak published on JSR"/></p>
<p>The auto-generation of documentation was one of the most rewarding things I
worked on for <code>deno.land/x</code> and I love that it has continued through to JSR:</p>
<p><img src="https://www.kitsonkelly.com/images/documentation.png" alt="Documentation of oak&#39;s Application class on JSR"/></p>
<p>When embraced, this is a huge boost to developer productivity. It also makes the
package maintainers life a lot easier, where you worry about writing your code
and the same mechanism uplifting the developer experience in the IDE becomes the
mechanism for documenting your package. Even without effort by the package
author, you provide correct up-to-date documentation as a baseline.</p>
<h2 id="conclusions-11"><a aria-hidden="true" tabindex="-1" href="#conclusions-11"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Conclusions</h2><p>JSR is still in the early stages. My initial impressions a month ago was that it
was a fair amount of work for me to migrate oak to JSR. Some of that was the
early stages and I was falling into problems that are now resolved and some of
them are still being worked out.</p>
<p>Initially I was missing the &#34;yeah, so what&#34;, but as more of the vision has
started to reveal itself, the more excited I am getting.</p>
<p>It solves a lot of the problems that <code>deno.land/x</code> had, but in a way the
preserves all the advantages that a &#34;package-management as code&#34; brings. Add to
that the ability to interoperate with the rest of the Javascript eco-system is
really solving a lot of real problems.</p>
<p>At the very least, having a registry that brings TypeScript on equal footing
with Javascript is substantial. It is an advantage we have had in Deno land for
years, but not something easily accessible to the rest of the Javascript
eco-system until now.</p>
<p>So while it is still very very early, and obviously the eco-system will vote
with its feet, I see some method to what on the surface was just a madness a
little while ago.</p>
<h2 id="oak-example-using-jsr-11"><a aria-hidden="true" tabindex="-1" href="#oak-example-using-jsr-11"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>oak example using JSR</h2><p>Here is an example of using a version of oak off of JSR. This should be fully
runnable with recent versions of the Deno CLI. (Deno Deploy doesn&#39;t currently
support JSR, but I hear that is coming very soon.)</p>
<div><pre><span>import</span> <span>{</span>
  Application<span>,</span>
  Context<span>,</span>
  isHttpError<span>,</span>
  Router<span>,</span>
  RouterContext<span>,</span>
  Status<span>,</span>
<span>}</span> <span>from</span> <span>&#34;jsr:@oak/oak@13&#34;</span><span>;</span>

<span>interface</span> <span>Book</span> <span>{</span>
  id<span>:</span> <span>string</span><span>;</span>
  title<span>:</span> <span>string</span><span>;</span>
  author<span>:</span> <span>string</span><span>;</span>
<span>}</span>

<span>const</span> books <span>=</span> <span>new</span> <span>Map<span>&lt;</span><span>string</span><span>,</span> Book<span>&gt;</span></span><span>(</span><span>)</span><span>;</span>

books<span>.</span><span>set</span><span>(</span><span>&#34;1234&#34;</span><span>,</span> <span>{</span>
  id<span>:</span> <span>&#34;1234&#34;</span><span>,</span>
  title<span>:</span> <span>&#34;The Hound of the Baskervilles&#34;</span><span>,</span>
  author<span>:</span> <span>&#34;Conan Doyle, Author&#34;</span><span>,</span>
<span>}</span><span>)</span><span>;</span>

<span>function</span> <span>notFound</span><span>(</span>context<span>:</span> Context<span>)</span> <span>{</span>
  context<span>.</span>response<span>.</span>status <span>=</span> Status<span>.</span>NotFound<span>;</span>
  context<span>.</span>response<span>.</span>body <span>=</span>
    <span><span>`</span><span>&lt;html&gt;&lt;body&gt;&lt;h1&gt;404 - Not Found&lt;/h1&gt;&lt;p&gt;Path &lt;code&gt;</span><span><span>${</span>context<span>.</span>request<span>.</span>url<span>}</span></span><span>&lt;/code&gt; not found.</span><span>`</span></span><span>;</span>
<span>}</span>

<span>const</span> router <span>=</span> <span>new</span> <span>Router</span><span>(</span><span>)</span><span>;</span>
router
  <span>.</span><span>get</span><span>(</span><span>&#34;/&#34;</span><span>,</span> <span>(</span>context<span>)</span> <span>=&gt;</span> <span>{</span>
    context<span>.</span>response<span>.</span>body <span>=</span> <span>&#34;Hello world!&#34;</span><span>;</span>
  <span>}</span><span>)</span>
  <span>.</span><span>get</span><span>(</span><span>&#34;/book&#34;</span><span>,</span> <span>(</span>context<span>)</span> <span>=&gt;</span> <span>{</span>
    context<span>.</span>response<span>.</span>body <span>=</span> <span>Array</span><span>.</span><span>from</span><span>(</span>books<span>.</span><span>values</span><span>(</span><span>)</span><span>)</span><span>;</span>
  <span>}</span><span>)</span>
  <span>.</span><span>get</span><span>(</span><span>&#34;/book/:id&#34;</span><span>,</span> <span>(</span>context<span>)</span> <span>=&gt;</span> <span>{</span>
    <span>if</span> <span>(</span>context<span>.</span>params <span>&amp;&amp;</span> books<span>.</span><span>has</span><span>(</span>context<span>.</span>params<span>.</span>id<span>)</span><span>)</span> <span>{</span>
      context<span>.</span>response<span>.</span>body <span>=</span> books<span>.</span><span>get</span><span>(</span>context<span>.</span>params<span>.</span>id<span>)</span><span>;</span>
    <span>}</span> <span>else</span> <span>{</span>
      <span>return</span> <span>notFound</span><span>(</span>context<span>)</span><span>;</span>
    <span>}</span>
  <span>}</span><span>)</span><span>;</span>

<span>const</span> app <span>=</span> <span>new</span> <span>Application</span><span>(</span><span>)</span><span>;</span>


app<span>.</span><span>use</span><span>(</span><span>async</span> <span>(</span>context<span>,</span> next<span>)</span> <span>=&gt;</span> <span>{</span>
  <span>await</span> <span>next</span><span>(</span><span>)</span><span>;</span>
  <span>const</span> rt <span>=</span> context<span>.</span>response<span>.</span>headers<span>.</span><span>get</span><span>(</span><span>&#34;X-Response-Time&#34;</span><span>)</span><span>;</span>
  <span>console</span><span>.</span><span>log</span><span>(</span>
    <span><span>`</span><span>%c</span><span><span>${</span>context<span>.</span>request<span>.</span>method<span>}</span></span><span> %c</span><span><span>${</span>
      <span>decodeURIComponent</span><span>(</span>context<span>.</span>request<span>.</span>url<span>.</span>pathname<span>)</span>
    <span>}</span></span><span>%c - %c</span><span><span>${</span>rt<span>}</span></span><span>`</span></span><span>,</span>
    <span>&#34;color:green&#34;</span><span>,</span>
    <span>&#34;color:cyan&#34;</span><span>,</span>
    <span>&#34;color:none&#34;</span><span>,</span>
    <span>&#34;font-weight: bold&#34;</span><span>,</span>
  <span>)</span><span>;</span>
<span>}</span><span>)</span><span>;</span>


app<span>.</span><span>use</span><span>(</span><span>async</span> <span>(</span>context<span>,</span> next<span>)</span> <span>=&gt;</span> <span>{</span>
  <span>const</span> start <span>=</span> Date<span>.</span><span>now</span><span>(</span><span>)</span><span>;</span>
  <span>await</span> <span>next</span><span>(</span><span>)</span><span>;</span>
  <span>const</span> ms <span>=</span> Date<span>.</span><span>now</span><span>(</span><span>)</span> <span>-</span> start<span>;</span>
  context<span>.</span>response<span>.</span>headers<span>.</span><span>set</span><span>(</span><span>&#34;X-Response-Time&#34;</span><span>,</span> <span><span>`</span><span><span>${</span>ms<span>}</span></span><span>ms</span><span>`</span></span><span>)</span><span>;</span>
<span>}</span><span>)</span><span>;</span>


app<span>.</span><span>use</span><span>(</span><span>async</span> <span>(</span>context<span>,</span> next<span>)</span> <span>=&gt;</span> <span>{</span>
  <span>try</span> <span>{</span>
    <span>await</span> <span>next</span><span>(</span><span>)</span><span>;</span>
  <span>}</span> <span>catch</span> <span>(</span>err<span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>isHttpError</span><span>(</span>err<span>)</span><span>)</span> <span>{</span>
      context<span>.</span>response<span>.</span>status <span>=</span> err<span>.</span>status<span>;</span>
      <span>const</span> <span>{</span> message<span>,</span> status<span>,</span> stack <span>}</span> <span>=</span> err<span>;</span>
      <span>if</span> <span>(</span>context<span>.</span>request<span>.</span><span>accepts</span><span>(</span><span>&#34;json&#34;</span><span>)</span><span>)</span> <span>{</span>
        context<span>.</span>response<span>.</span>body <span>=</span> <span>{</span> message<span>,</span> status<span>,</span> stack <span>}</span><span>;</span>
        context<span>.</span>response<span>.</span>type <span>=</span> <span>&#34;json&#34;</span><span>;</span>
      <span>}</span> <span>else</span> <span>{</span>
        context<span>.</span>response<span>.</span>body <span>=</span> <span><span>`</span><span><span>${</span>status<span>}</span></span><span> </span><span><span>${</span>message<span>}</span></span><span>\n\n</span><span><span>${</span>stack <span>??</span> <span>&#34;&#34;</span><span>}</span></span><span>`</span></span><span>;</span>
        context<span>.</span>response<span>.</span>type <span>=</span> <span>&#34;text/plain&#34;</span><span>;</span>
      <span>}</span>
    <span>}</span> <span>else</span> <span>{</span>
      <span>console</span><span>.</span><span>log</span><span>(</span>err<span>)</span><span>;</span>
      <span>throw</span> err<span>;</span>
    <span>}</span>
  <span>}</span>
<span>}</span><span>)</span><span>;</span>


app<span>.</span><span>use</span><span>(</span>router<span>.</span><span>routes</span><span>(</span><span>)</span><span>)</span><span>;</span>
app<span>.</span><span>use</span><span>(</span>router<span>.</span><span>allowedMethods</span><span>(</span><span>)</span><span>)</span><span>;</span>


app<span>.</span><span>use</span><span>(</span>notFound<span>)</span><span>;</span>

app<span>.</span><span>addEventListener</span><span>(</span><span>&#34;listen&#34;</span><span>,</span> <span>(</span><span>{</span> hostname<span>,</span> port<span>,</span> serverType <span>}</span><span>)</span> <span>=&gt;</span> <span>{</span>
  <span>console</span><span>.</span><span>log</span><span>(</span>
    <span><span>`</span><span>%cStart listening on %c</span><span><span>${</span>hostname<span>}</span></span><span>:</span><span><span>${</span>port<span>}</span></span><span>`</span></span><span>,</span>
    <span>&#34;font-weight:bold&#34;</span><span>,</span>
    <span>&#34;color:yellow&#34;</span><span>,</span>
  <span>)</span><span>;</span>
  <span>console</span><span>.</span><span>log</span><span>(</span><span><span>`</span><span>  using HTTP server: %c</span><span><span>${</span>serverType<span>}</span></span><span>`</span></span><span>,</span> <span>&#34;color:yellow&#34;</span><span>)</span><span>;</span>
<span>}</span><span>)</span><span>;</span>

<span>await</span> app<span>.</span><span>listen</span><span>(</span><span>)</span><span>;</span></pre></div></div></div>
  </body>
</html>
