<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://vercel.com/blog/build-your-own-web-framework">Original</a>
    <h1>Build your own web framework</h1>
    
    <div id="readability-page-1" class="page"><div><div><p>Have you ever wondered what it takes to build your own web framework that also deploys to edge and serverless infrastructure? What features does a modern framework need to support, and how can we ensure that these features allow us to build a scalable, performant web application?<!-- --></p><p>This post will explain how to build your own simple React-based web framework. We&#39;ll use the <!-- --><a href="https://vercel.com/docs/build-output-api/v3" rel="noopener" target="_blank">Vercel Build Output API<!-- --></a> to deploy our framework with support for the following features:<!-- --></p><ul><li><b>Static Files </b>to statically render pages<!-- --></li><li><b>Incremental Static Regeneration</b> to automatically revalidate and regenerate pages after a specific timeout<!-- --></li><li><b>Edge Functions</b> to enable edge rendering and middleware<!-- --></li><li><b>Automatic Image Optimization</b> to efficiently serve the images using the latest format, enable lazy loading, and prevent layout shift<!-- --></li><li><b>Serverless Functions </b>to server-render dynamic pages and create data fetching endpoints<!-- --></li><li><b>Edge Caching </b>to quickly serve static files to users globally<!-- --></li></ul><p>The source code for this article is available in <!-- --><a href="https://github.com/lydiahallie/byof-demo" rel="noopener" target="_blank">this GitHub Repo<!-- --></a> to see the demo implementation covered in this article.<!-- --></p><p><span><span><b>Note: </b></span>The implementation of this demo framework is simplified. Production frameworks usually do more to create an optimized output, such as more advanced bundling, caching, type checking, and more. This blog post demonstrates how to create a basic yet functional example and deploy it to Vercel using the Build Output API.<!-- --></span></p><h3><span id="landing-page"></span><a href="#landing-page">Landing Page <!-- --></a><span><svg data-testid="geist-icon" fill="none" height="0.75em" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="0.75em" style="color:currentColor"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"></path></svg></span></h3><p>Let&#39;s explore the requirements of each page we want to build and how to build optimizations into our web framework to help achieve excellent performance.<!-- --></p><div><figure><p><img alt="Demo website&#39;s landing page" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F2fFVUrfEOESje3mAcWm0TV%2F295fa6a95a6d71ba20104d115332c5db%2FScreen_Shot_2022-07-20_at_10.33.06_AM.png&amp;w=750&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F2fFVUrfEOESje3mAcWm0TV%2F295fa6a95a6d71ba20104d115332c5db%2FScreen_Shot_2022-07-20_at_10.33.06_AM.png&amp;w=1920&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F2fFVUrfEOESje3mAcWm0TV%2F295fa6a95a6d71ba20104d115332c5db%2FScreen_Shot_2022-07-20_at_10.33.06_AM.png&amp;w=1920&amp;q=75" width="721" height="476" decoding="async" data-nimg="future" loading="lazy"/></p><figcaption><svg fill="none" height="12" viewBox="0 0 11 12" width="11"><path clip-rule="evenodd" d="M2 6l8 5V1L2 6z" fill="var(--geist-foreground)" fill-rule="evenodd" stroke="var(--geist-foreground)" stroke-width="1.5"></path></svg> <!-- -->Demo website&#39;s landing page<!-- --></figcaption></figure></div><div><figure><p><img alt="Demo website&#39;s landing page" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F6bHqWUhMCNuo1oXI8ykOlK%2F95ee4653f2a27237639f8d7959be2058%2FGroup_13.png&amp;w=1920&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F6bHqWUhMCNuo1oXI8ykOlK%2F95ee4653f2a27237639f8d7959be2058%2FGroup_13.png&amp;w=3840&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F6bHqWUhMCNuo1oXI8ykOlK%2F95ee4653f2a27237639f8d7959be2058%2FGroup_13.png&amp;w=3840&amp;q=75" width="1274" height="775" decoding="async" data-nimg="future" loading="lazy"/></p><figcaption><svg fill="none" height="12" viewBox="0 0 11 12" width="11"><path clip-rule="evenodd" d="M2 6l8 5V1L2 6z" fill="var(--geist-foreground)" fill-rule="evenodd" stroke="var(--geist-foreground)" stroke-width="1.5"></path></svg> <!-- -->Demo website&#39;s landing page<!-- --></figcaption></figure></div><p>The landing page is a static page with a single large hero image. Although this page may seem simple, there are a few optimizations we can implement in our framework to ensure this page is fast.<!-- --></p><p><b>Image Optimization</b></p><p><b>
</b>We can reduce the image size without sacrificing quality by using the latest image formats (like <!-- --><code>.webp</code> and <!-- --><code>.avif</code>) and prevent <!-- --><a href="https://vercel.com/blog/core-web-vitals#cumulative-layout-shift" rel="noopener" target="_blank">layout shift<!-- --></a> by explicitly setting the image width and height.<!-- --></p><p><b>Edge Caching</b></p><p><b>
</b>Since we want our framework to generate a static HTML file for this page, we can use a CDN to improve the Time To First Byte (TTFB) by caching the file at each region (or edge). Vercel provides this functionality out of the box with the <!-- --><a href="https://vercel.com/docs/concepts/edge-network/overview" rel="noopener" target="_blank">Edge Network<!-- --></a>, so we don&#39;t need to add this ourselves.<!-- --></p><h3><span id="products-page"></span><a href="#products-page">Products Page<!-- --></a><span><svg data-testid="geist-icon" fill="none" height="0.75em" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="0.75em" style="color:currentColor"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"></path></svg></span></h3><div><figure><p><img alt="Demo website&#39;s product page" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F3u6eee6JfvXHBSOhripbkl%2Fab4eefdecae05c5ff6c5fb072a6403ed%2FScreen_Shot_2022-07-20_at_10.32.57_AM.png&amp;w=750&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F3u6eee6JfvXHBSOhripbkl%2Fab4eefdecae05c5ff6c5fb072a6403ed%2FScreen_Shot_2022-07-20_at_10.32.57_AM.png&amp;w=1920&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F3u6eee6JfvXHBSOhripbkl%2Fab4eefdecae05c5ff6c5fb072a6403ed%2FScreen_Shot_2022-07-20_at_10.32.57_AM.png&amp;w=1920&amp;q=75" width="721" height="476" decoding="async" data-nimg="future" loading="lazy"/></p><figcaption><svg fill="none" height="12" viewBox="0 0 11 12" width="11"><path clip-rule="evenodd" d="M2 6l8 5V1L2 6z" fill="var(--geist-foreground)" fill-rule="evenodd" stroke="var(--geist-foreground)" stroke-width="1.5"></path></svg> <!-- -->Demo website&#39;s product page<!-- --></figcaption></figure></div><div><figure><p><img alt="Demo website&#39;s product page" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F6KI3JTpdy2IT4jZHN3XsMK%2F290a494b57931556e1487b1198a58d13%2FGroup_14.png&amp;w=1920&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F6KI3JTpdy2IT4jZHN3XsMK%2F290a494b57931556e1487b1198a58d13%2FGroup_14.png&amp;w=3840&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F6KI3JTpdy2IT4jZHN3XsMK%2F290a494b57931556e1487b1198a58d13%2FGroup_14.png&amp;w=3840&amp;q=75" width="1253" height="778" decoding="async" data-nimg="future" loading="lazy"/></p><figcaption><svg fill="none" height="12" viewBox="0 0 11 12" width="11"><path clip-rule="evenodd" d="M2 6l8 5V1L2 6z" fill="var(--geist-foreground)" fill-rule="evenodd" stroke="var(--geist-foreground)" stroke-width="1.5"></path></svg> <!-- -->Demo website&#39;s product page<!-- --></figcaption></figure></div><p>The products page is a hybrid between a pre-generated static HTML page and a dynamic server-rendered page. The page renders a list of products retrieved from a data provider and should automatically update after a certain amount of time (or when new products have been added).<!-- --></p><p>This product page can benefit from a few optimizations we want to build into our framework. <!-- --></p><p><b>Image Optimization</b></p><p>Since we&#39;re showing many images on this page, we want to use image optimization to serve the images in the latest format and defer the loading of non-critical images for a faster <!-- --><a href="https://nextjs.org/learn/seo/web-performance/lcp" rel="noopener" target="_blank">first paint<!-- --></a>.<!-- --></p><p><b>Incremental Static Regeneration</b></p><p>Displayed products should update after a certain amount of time or when new products are added. This rendering pattern is also referred to as <!-- --><a href="https://vercel.com/blog/how-hashicorp-developers-iterate-faster-with-isr" rel="noopener" target="_blank">Incremental Static Regeneration<!-- --></a> behavior and gives you the benefits of Static Generation, combined with the dynamic benefits of Server-Side Rendering. When using the Build Output API, we can use Prerender Functions to enable and configure ISR on certain pages.<!-- --></p><h2><span id="popular-page"></span><a href="#popular-page">Popular Page<!-- --></a><span><svg data-testid="geist-icon" fill="none" height="0.75em" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="0.75em" style="color:currentColor"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"></path></svg></span></h2><div><figure><p><img alt="Demo website&#39;s popular page" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F6X5TEmUDsX6Bvh5N6fPKP5%2Fa99490185aa987e5cd7f9d08ee558b47%2FScreen_Shot_2022-07-20_at_10.32.06_AM.png&amp;w=750&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F6X5TEmUDsX6Bvh5N6fPKP5%2Fa99490185aa987e5cd7f9d08ee558b47%2FScreen_Shot_2022-07-20_at_10.32.06_AM.png&amp;w=1920&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F6X5TEmUDsX6Bvh5N6fPKP5%2Fa99490185aa987e5cd7f9d08ee558b47%2FScreen_Shot_2022-07-20_at_10.32.06_AM.png&amp;w=1920&amp;q=75" width="721" height="476" decoding="async" data-nimg="future" loading="lazy"/></p><figcaption><svg fill="none" height="12" viewBox="0 0 11 12" width="11"><path clip-rule="evenodd" d="M2 6l8 5V1L2 6z" fill="var(--geist-foreground)" fill-rule="evenodd" stroke="var(--geist-foreground)" stroke-width="1.5"></path></svg> <!-- -->Demo website&#39;s popular page<!-- --></figcaption></figure></div><div><figure><p><img alt="Demo website&#39;s popular page" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F3kgcMvMR2sZzbcNkmXZuM7%2F03d78741541c34f480207acd1a931e08%2FGroup_15.png&amp;w=1920&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F3kgcMvMR2sZzbcNkmXZuM7%2F03d78741541c34f480207acd1a931e08%2FGroup_15.png&amp;w=3840&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F3kgcMvMR2sZzbcNkmXZuM7%2F03d78741541c34f480207acd1a931e08%2FGroup_15.png&amp;w=3840&amp;q=75" width="1274" height="775" decoding="async" data-nimg="future" loading="lazy"/></p><figcaption><svg fill="none" height="12" viewBox="0 0 11 12" width="11"><path clip-rule="evenodd" d="M2 6l8 5V1L2 6z" fill="var(--geist-foreground)" fill-rule="evenodd" stroke="var(--geist-foreground)" stroke-width="1.5"></path></svg> <!-- -->Demo website&#39;s popular page<!-- --></figcaption></figure></div><p>We want to display the most relevant, personalized products to our visitors. How can our web framework help enable us to add this feature?<!-- --></p><p><b>Edge Functions</b></p><p>To get the visitor’s location, we can use an Edge Function to determine the city based on the <!-- --><code>x-vercel-ip-city</code> header. We could take two approaches to Edge Functions: either use <!-- --><a href="https://vercel.com/edge" rel="noopener" target="_blank">Edge Middleware<!-- --></a> to redirect the user to a specific page based on their location, <!-- --><i>or</i> we can server-render the page using <!-- --><a href="https://vercel.com/edge" rel="noopener" target="_blank">Edge Functions<!-- --></a>. We’ll choose server-rendering for a fast, personalized page in this case.<!-- --></p><h2><span id="building-the-framework"></span><a href="#building-the-framework">Building the framework<!-- --></a><span><svg data-testid="geist-icon" fill="none" height="0.75em" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="0.75em" style="color:currentColor"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"></path></svg></span></h2><p>We now know what features our website could benefit from to create a better user experience. Next, let’s focus on implementing our framework to ensure it supports all the features mentioned above.<!-- --></p><p>Our framework expects the pages to be located in the <!-- --><code>pages/</code> folder. To keep it simple, we’ll expect that the page contains:<!-- --></p><ul><li>A default <!-- --><code>export</code> to export the page’s React component<!-- --></li><li>A configuration object named <!-- --><code>pageConfig</code>, which includes a <!-- --><code>strategy</code> prop to define the rendering technique that should be used for this page - either <!-- --><code>static</code>, <!-- --><code>ssr</code>, <!-- --><code>prerender</code>, or <!-- --><code>edge</code> . If a page is prerendered, users can also pass an optional  <!-- --><code>expiration </code>time and <!-- --><code>fallback</code> component to configure the regeneration<!-- --></li></ul><p>Let&#39;s see how our framework can work with these values and create a valid output Vercel can use to deploy our project.<!-- --></p><h2><span id="static-rendering"></span><a href="#static-rendering">Static Rendering<!-- --></a><span><svg data-testid="geist-icon" fill="none" height="0.75em" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="0.75em" style="color:currentColor"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"></path></svg></span></h2><p>When a page is statically rendered, the page’s HTML is generated during the build. Vercel&#39;s Edge Network can quickly return this pre-generated HTML file when a user visits the page, after which the browser can draw the contents to the user’s screen.<!-- --></p><p>To support static pages, we first have to implement a transpilation step that turns React-based pages into static HTML. ReactDOM Server exposes a method called <!-- --><code>renderToString</code>, which takes a React component and returns the corresponding HTML output. We can invoke this function to prerender the HTML for static pages during the build.<!-- --></p><div><pre><pre><code><span>function<!-- --></span> <!-- --><span>createStaticPage<!-- --></span><span>(<!-- --></span><span>pagePath<!-- --></span><span>)<!-- --></span> <!-- --><span>{<!-- --></span>
  <!-- --><span>const<!-- --></span> <!-- --><span>{<!-- --></span> <!-- --><span>Component<!-- --></span> <!-- --><span>}<!-- --></span> <!-- --><span>=<!-- --></span> <!-- --><span>require<!-- --></span><span>(<!-- --></span>pagePath<!-- --><span>)<!-- --></span><span>;<!-- --></span>
  <!-- --><span>const<!-- --></span> pageHTML <!-- --><span>=<!-- --></span> `<!-- --><span>&lt;<!-- --></span>div id<!-- --><span>=<!-- --></span><span>&#34;root&#34;<!-- --></span><span>&gt;<!-- --></span>$<!-- --><span>{<!-- --></span><span>ReactDOMServer<!-- --></span><span>.<!-- --></span><span>renderToString<!-- --></span><span>(<!-- --></span><span>Component<!-- --></span><span>)<!-- --></span><span>&lt;<!-- --></span><span>/<!-- --></span>div<!-- --><span>&gt;<!-- --></span>`<!-- --><span>;<!-- --></span>
  <!-- --><span>...<!-- --></span>
<!-- --><span>}<!-- --></span></code></pre></pre></div><p>In most cases, however, our React components aren’t <!-- --><i>entirely</i> static. Components usually contain some interactivity, such as event handlers. To account for this, we also need to create one or multiple <!-- --><a href="https://nextjs.org/learn/foundations/how-nextjs-works/bundling" rel="noopener" target="_blank">JavaScript bundle(s)<!-- --></a> to <!-- --><i>hydrate</i> the static markup once it’s been rendered.<!-- --></p><p>To hydrate dynamic components, we can export a string literal that our bundler eventually uses to create a custom hydration script for the individual pages. A bundler can generate HTML and automatically inject this custom hydration script as a deferred script. The script automatically fetches the hydration bundle to add interactivity when a browser has loaded the page&#39;s HTML.<!-- --></p><div><div><figure><p><img alt="Group 12.png" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F7x9KCOlF8nkedaO7W2NRwn%2Ff44c1544a9c864ae34e4547a08768915%2FGroup_12.png&amp;w=1920&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F7x9KCOlF8nkedaO7W2NRwn%2Ff44c1544a9c864ae34e4547a08768915%2FGroup_12.png&amp;w=3840&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F7x9KCOlF8nkedaO7W2NRwn%2Ff44c1544a9c864ae34e4547a08768915%2FGroup_12.png&amp;w=3840&amp;q=75" width="1708" height="531" decoding="async" data-nimg="future" loading="lazy"/></p></figure></div><div><figure><p><img alt="Group 17.png" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F6JFrLXMWj7tCjjx8LkuFGR%2Fdf3651557291d04bb9426de3a314f4fa%2FGroup_17.png&amp;w=1920&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F6JFrLXMWj7tCjjx8LkuFGR%2Fdf3651557291d04bb9426de3a314f4fa%2FGroup_17.png&amp;w=3840&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F6JFrLXMWj7tCjjx8LkuFGR%2Fdf3651557291d04bb9426de3a314f4fa%2FGroup_17.png&amp;w=3840&amp;q=75" width="1708" height="531" decoding="async" data-nimg="future" loading="lazy"/></p></figure></div></div><div><div><figure><p><img alt="Group 24.png" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F1pxulv0vqHdgXOT7WGxZ3h%2Fbe8d60a0ef8728c0fe5635ec6c5db310%2FGroup_24.png&amp;w=640&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F1pxulv0vqHdgXOT7WGxZ3h%2Fbe8d60a0ef8728c0fe5635ec6c5db310%2FGroup_24.png&amp;w=1080&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F1pxulv0vqHdgXOT7WGxZ3h%2Fbe8d60a0ef8728c0fe5635ec6c5db310%2FGroup_24.png&amp;w=1080&amp;q=75" width="531" height="1170" decoding="async" data-nimg="future" loading="lazy"/></p></figure></div><div><figure><p><img alt="Group 41.png" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F4Vx46n09Pw1Ez8rMdedtRa%2F521e4dc2c8c7cd1996bec084fc952f13%2FGroup_41.png&amp;w=1080&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F4Vx46n09Pw1Ez8rMdedtRa%2F521e4dc2c8c7cd1996bec084fc952f13%2FGroup_41.png&amp;w=2048&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F4Vx46n09Pw1Ez8rMdedtRa%2F521e4dc2c8c7cd1996bec084fc952f13%2FGroup_41.png&amp;w=2048&amp;q=75" width="1002" height="1242" decoding="async" data-nimg="future" loading="lazy"/></p></figure></div></div><p>Let’s see what this could look like in our code.<!-- --></p><p>The example below shows a dynamic <!-- --><code>createStaticFile</code> method that takes our page’s default exported component and the <!-- --><code>filePath</code> where the component is located. With this information, we can create a bundle that automatically gets injected into the newly created HTML file and output it to the <!-- --><code>.vercel/output/static</code> folder.<!-- --></p><div><pre><pre><code><span>export<!-- --></span> <!-- --><span>async<!-- --></span> <!-- --><span>function<!-- --></span> <!-- --><span>createStaticFile<!-- --></span><span>(<!-- --></span><span><span>Component<!-- --></span><span>,<!-- --></span>filePath<!-- --></span><span>)<!-- --></span> <!-- --><span>{<!-- --></span>
  <!-- --><span>const<!-- --></span> pageName <!-- --><span>=<!-- --></span> <!-- --><span>getPageName<!-- --></span><span>(<!-- --></span>filePath<!-- --><span>)<!-- --></span><span>;<!-- --></span>
  <!-- --><span>const<!-- --></span> outdir <!-- --><span>=<!-- --></span> <!-- --><span>join<!-- --></span><span>(<!-- --></span><span>&#34;.vercel&#34;<!-- --></span><span>,<!-- --></span> <!-- --><span>&#34;output&#34;<!-- --></span><span>,<!-- --></span> <!-- --><span>&#34;static&#34;<!-- --></span><span>)<!-- --></span><span>;<!-- --></span>
  <!-- --><span>await<!-- --></span> fs<!-- --><span>.<!-- --></span><span>ensureDir<!-- --></span><span>(<!-- --></span>outdir<!-- --><span>)<!-- --></span><span>;<!-- --></span>
 
  <!-- --><span>await<!-- --></span> <!-- --><span>generateClientBundle<!-- --></span><span>(<!-- --></span><span>{<!-- --></span> filePath<!-- --><span>,<!-- --></span> outdir<!-- --><span>,<!-- --></span> pageName <!-- --><span>}<!-- --></span><span>)<!-- --></span><span>;<!-- --></span>
  
  <!-- --><span>return<!-- --></span> fs<!-- --><span>.<!-- --></span><span>writeFileSync<!-- --></span><span>(<!-- --></span>
    path<!-- --><span>.<!-- --></span><span>join<!-- --></span><span>(<!-- --></span>outdir<!-- --><span>,<!-- --></span> <!-- --><span><span>`<!-- --></span><span><span>${<!-- --></span>pageName<!-- --><span>}<!-- --></span></span><span>.html<!-- --></span><span>`<!-- --></span></span><span>)<!-- --></span><span>,<!-- --></span>
    <!-- --><span><span>`<!-- --></span><span>&lt;!DOCTYPE html&gt;
      ...
      &lt;body&gt;
        &lt;div id=&#34;root&#34;&gt;<!-- --></span><span><span>${<!-- --></span><span>ReactDOMServer<!-- --></span><span>.<!-- --></span><span>renderToString<!-- --></span><span>(<!-- --></span><span>React<!-- --></span><span>.<!-- --></span><span>createElement<!-- --></span><span>(<!-- --></span><span>Component<!-- --></span><span>)<!-- --></span> <!-- --><span>)<!-- --></span><span>}<!-- --></span></span><span>&lt;/div&gt;
        &lt;script src=&#34;<!-- --></span><span><span>${<!-- --></span>pageName<!-- --><span>}<!-- --></span></span><span>.bundle.js&#34; defer&gt;&lt;/script&gt;
      &lt;/body&gt;<!-- --></span><span>`<!-- --></span></span>
  <!-- --><span>)<!-- --></span><span>;<!-- --></span>
<!-- --><span>}<!-- --></span></code></pre></pre></div><p>At build time, we end up with a <!-- --><code>.vercel/output/static</code> folder that contains the static HTML and the JavaScript bundle(s) necessary for hydration.<!-- --></p><div><div><figure><p><img alt="Folder structure for static assets" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F19874KIUDRfAI0Cm5KG4k7%2F1669b320b358a7a4ad08f28bf4c5a5d2%2FGroup_39.png&amp;w=828&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F19874KIUDRfAI0Cm5KG4k7%2F1669b320b358a7a4ad08f28bf4c5a5d2%2FGroup_39.png&amp;w=1920&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F19874KIUDRfAI0Cm5KG4k7%2F1669b320b358a7a4ad08f28bf4c5a5d2%2FGroup_39.png&amp;w=1920&amp;q=75" width="814" height="413" decoding="async" data-nimg="future" loading="lazy"/></p><figcaption><svg fill="none" height="12" viewBox="0 0 11 12" width="11"><path clip-rule="evenodd" d="M2 6l8 5V1L2 6z" fill="var(--geist-foreground)" fill-rule="evenodd" stroke="var(--geist-foreground)" stroke-width="1.5"></path></svg> <!-- -->Folder structure for static assets<!-- --></figcaption></figure></div><div><figure><p><img alt="Folder structure for static assets" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F1b1agvbBdxaZa7Z0VUQjRq%2F83f56536a784bd36f7aaddc2abbccc4c%2FGroup_22.png&amp;w=828&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F1b1agvbBdxaZa7Z0VUQjRq%2F83f56536a784bd36f7aaddc2abbccc4c%2FGroup_22.png&amp;w=1920&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F1b1agvbBdxaZa7Z0VUQjRq%2F83f56536a784bd36f7aaddc2abbccc4c%2FGroup_22.png&amp;w=1920&amp;q=75" width="814" height="413" decoding="async" data-nimg="future" loading="lazy"/></p><figcaption><svg fill="none" height="12" viewBox="0 0 11 12" width="11"><path clip-rule="evenodd" d="M2 6l8 5V1L2 6z" fill="var(--geist-foreground)" fill-rule="evenodd" stroke="var(--geist-foreground)" stroke-width="1.5"></path></svg> <!-- -->Folder structure for static assets<!-- --></figcaption></figure></div></div><div><div><figure><p><img alt="Folder structure for static assets" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F3B5TljKO5a2IMnBhzY5YHA%2F591d4cf4b1aa3aaf4f05924d39dff57c%2FGroup_43.png&amp;w=640&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F3B5TljKO5a2IMnBhzY5YHA%2F591d4cf4b1aa3aaf4f05924d39dff57c%2FGroup_43.png&amp;w=1080&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F3B5TljKO5a2IMnBhzY5YHA%2F591d4cf4b1aa3aaf4f05924d39dff57c%2FGroup_43.png&amp;w=1080&amp;q=75" width="534" height="646" decoding="async" data-nimg="future" loading="lazy"/></p><figcaption><svg fill="none" height="12" viewBox="0 0 11 12" width="11"><path clip-rule="evenodd" d="M2 6l8 5V1L2 6z" fill="var(--geist-foreground)" fill-rule="evenodd" stroke="var(--geist-foreground)" stroke-width="1.5"></path></svg> <!-- -->Folder structure for static assets<!-- --></figcaption></figure></div><div><figure><p><img alt="Folder structure for static assets" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F3lbN6jxtCZejsxyQpnsWo3%2Fb1bbfc73063609b96b449509f28a0230%2FGroup_43__1_.png&amp;w=640&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F3lbN6jxtCZejsxyQpnsWo3%2Fb1bbfc73063609b96b449509f28a0230%2FGroup_43__1_.png&amp;w=1080&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F3lbN6jxtCZejsxyQpnsWo3%2Fb1bbfc73063609b96b449509f28a0230%2FGroup_43__1_.png&amp;w=1080&amp;q=75" width="534" height="639" decoding="async" data-nimg="future" loading="lazy"/></p><figcaption><svg fill="none" height="12" viewBox="0 0 11 12" width="11"><path clip-rule="evenodd" d="M2 6l8 5V1L2 6z" fill="var(--geist-foreground)" fill-rule="evenodd" stroke="var(--geist-foreground)" stroke-width="1.5"></path></svg> <!-- -->Folder structure for static assets<!-- --></figcaption></figure></div></div><p>Any static assets, such as HTML, CSS, JavaScript, and images should be located in the <!-- --><code>.vercel/output/static</code> folder so the Vercel Build Output API can convert them into infrastructure primitives.<!-- --></p><h2><span id="incremental-static-regeneration"></span><a href="#incremental-static-regeneration">Incremental Static Regeneration<!-- --></a><span><svg data-testid="geist-icon" fill="none" height="0.75em" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="0.75em" style="color:currentColor"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"></path></svg></span></h2><p><a href="https://vercel.com/blog/how-hashicorp-developers-iterate-faster-with-isr" rel="noopener" target="_blank">Incremental Static Regeneration<!-- --></a> is a powerful pattern that we can use for pages that contain data that frequently updates by invalidating the cache and regenerating the page after a specific interval or based on an event.<!-- --></p><p>The <!-- --><code>/products</code> page can benefit from ISR, as it could regenerate after a specific interval to ensure it always shows the latest products and optional price reductions as quickly as possible.<!-- --></p><div><div><figure><p><img alt="Group 40.png" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F23DM76u7oI9CRKFpq5K9Ka%2F40c0af99885a0ee396703c72a1bcd15b%2FGroup_40.png&amp;w=1920&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F23DM76u7oI9CRKFpq5K9Ka%2F40c0af99885a0ee396703c72a1bcd15b%2FGroup_40.png&amp;w=3840&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F23DM76u7oI9CRKFpq5K9Ka%2F40c0af99885a0ee396703c72a1bcd15b%2FGroup_40.png&amp;w=3840&amp;q=75" width="1913" height="746" decoding="async" data-nimg="future" loading="lazy"/></p></figure></div><div><figure><p><img alt="Group 18.png" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F7mSrBiHfPZQBWMo0wrS7O%2F80f62f8dd12ba895b43fa0ce6b1b4595%2FGroup_18.png&amp;w=1920&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F7mSrBiHfPZQBWMo0wrS7O%2F80f62f8dd12ba895b43fa0ce6b1b4595%2FGroup_18.png&amp;w=3840&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F7mSrBiHfPZQBWMo0wrS7O%2F80f62f8dd12ba895b43fa0ce6b1b4595%2FGroup_18.png&amp;w=3840&amp;q=75" width="1913" height="746" decoding="async" data-nimg="future" loading="lazy"/></p></figure></div></div><div><div><figure><p><img alt="Group 27.png" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F15c5gXTFKmaveAUBFXsYM2%2F2a8bc738de9371e7c83b7ec332fee2ef%2FGroup_27.png&amp;w=1200&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F15c5gXTFKmaveAUBFXsYM2%2F2a8bc738de9371e7c83b7ec332fee2ef%2FGroup_27.png&amp;w=3840&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F15c5gXTFKmaveAUBFXsYM2%2F2a8bc738de9371e7c83b7ec332fee2ef%2FGroup_27.png&amp;w=3840&amp;q=75" width="1092" height="1323" decoding="async" data-nimg="future" loading="lazy"/></p></figure></div><div><figure><p><img alt="Group 28.png" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F48XRqaSa5CK3oI5dyS4sV1%2Fd948acb3c0d2ea6ffc6e4e3239eb3cb2%2FGroup_28.png&amp;w=1200&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F48XRqaSa5CK3oI5dyS4sV1%2Fd948acb3c0d2ea6ffc6e4e3239eb3cb2%2FGroup_28.png&amp;w=3840&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F48XRqaSa5CK3oI5dyS4sV1%2Fd948acb3c0d2ea6ffc6e4e3239eb3cb2%2FGroup_28.png&amp;w=3840&amp;q=75" width="1092" height="1323" decoding="async" data-nimg="future" loading="lazy"/></p></figure></div></div><p>To enable Incremental Static Regeneration, we need to create a few files.<!-- --></p><ul><li><code>products.func/index.js</code><b>:</b> A Serverless Function containing the handler that takes care of the page’s (re)generation.<!-- --></li><li><code>products.func/vc-config.js</code>: The configuration file used by the Serverless Function to configure its environment, such as the runtime and optional helpers.<!-- --></li><li><code>products.prerender-config.json</code>: The configuration file that Vercel uses to determine when and how to regenerate the page. This is necessary since this isn’t just Server-Rendering—it’s also using automatic invalidation and regeneration.<!-- --></li><li><code>products.prerender-fallback.html</code>: The (optional) fallback HTML that gets served when there’s no cached version of the page available yet and the page is being generated in the background. This creates a better user experience since users don’t have to stare at a blank screen while the page is generated.<!-- --></li></ul><h2><span id="serverless-functions"></span><a href="#serverless-functions"><b>
Serverless Functions</b></a><span><svg data-testid="geist-icon" fill="none" height="0.75em" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="0.75em" style="color:currentColor"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"></path></svg></span></h2><p>First, let’s see how we can create a Serverless Function that handles the HTML (re)generation.<!-- --></p><p>When a Serverless Function is invoked, its handler function runs. This function runs in its own environment, meaning that we have to ensure that this handler function has access to all the necessary code to generate the HTML.<!-- --></p><p>We can create a Serverless Function on Vercel by creating a <!-- --><code>&lt;name&gt;.func</code> folder, with the name being the name of the server-rendered page. In this case, we have to create a <!-- --><code>products.func</code> folder, since the page needs to get regenerated in a Serverless Function.<!-- --></p><p>To include all the necessary code and dependencies, we can create a <!-- --><code>node_modules</code> folder within the function folder or bundle everything together into one single handler file.<!-- --></p><div><div><figure><p><img alt="Group 15.png" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F2YODASQPfkhgXNbQVNxs1L%2Fe05363fa6ddaa44ace7bd11a404974d2%2FGroup_15.png&amp;w=828&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F2YODASQPfkhgXNbQVNxs1L%2Fe05363fa6ddaa44ace7bd11a404974d2%2FGroup_15.png&amp;w=1920&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F2YODASQPfkhgXNbQVNxs1L%2Fe05363fa6ddaa44ace7bd11a404974d2%2FGroup_15.png&amp;w=1920&amp;q=75" width="772" height="466" decoding="async" data-nimg="future" loading="lazy"/></p></figure></div><div><figure><p><img alt="Group 21.png" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F2yldyPzFv7mNOJZRLSv5gJ%2F3e3bcf4315cea0de1c527b58b5bafb42%2FGroup_21.png&amp;w=828&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F2yldyPzFv7mNOJZRLSv5gJ%2F3e3bcf4315cea0de1c527b58b5bafb42%2FGroup_21.png&amp;w=1920&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F2yldyPzFv7mNOJZRLSv5gJ%2F3e3bcf4315cea0de1c527b58b5bafb42%2FGroup_21.png&amp;w=1920&amp;q=75" width="772" height="466" decoding="async" data-nimg="future" loading="lazy"/></p></figure></div></div><div><div><figure><p><img alt="Group 15.png" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F2YODASQPfkhgXNbQVNxs1L%2Fe05363fa6ddaa44ace7bd11a404974d2%2FGroup_15.png&amp;w=828&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F2YODASQPfkhgXNbQVNxs1L%2Fe05363fa6ddaa44ace7bd11a404974d2%2FGroup_15.png&amp;w=1920&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F2YODASQPfkhgXNbQVNxs1L%2Fe05363fa6ddaa44ace7bd11a404974d2%2FGroup_15.png&amp;w=1920&amp;q=75" width="772" height="466" decoding="async" data-nimg="future" loading="lazy"/></p></figure></div><div><figure><p><img alt="Group 21.png" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F2yldyPzFv7mNOJZRLSv5gJ%2F3e3bcf4315cea0de1c527b58b5bafb42%2FGroup_21.png&amp;w=828&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F2yldyPzFv7mNOJZRLSv5gJ%2F3e3bcf4315cea0de1c527b58b5bafb42%2FGroup_21.png&amp;w=1920&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F2yldyPzFv7mNOJZRLSv5gJ%2F3e3bcf4315cea0de1c527b58b5bafb42%2FGroup_21.png&amp;w=1920&amp;q=75" width="772" height="466" decoding="async" data-nimg="future" loading="lazy"/></p></figure></div></div><p>To create the files that are necessary for a serverless function, let’s create a <!-- --><code>createServerlessFunction</code> function that invokes two functions:<!-- --></p><ul><li><code>generateClientBundle</code>, to generate a client-side bundle used to hydrate the static HTML returned from the server<!-- --></li><li><code>generateLambdaBundle</code>, to bundle the necessary files into a script that’s executed in the Lambda’s handler<!-- --></li></ul><p>The method also generates a <!-- --><code>.vc-config.json</code> file, which includes information that the Lambda needs to set up its execution context.<!-- --></p><div><pre><pre><code><span>export<!-- --></span> <!-- --><span>async<!-- --></span> <!-- --><span>function<!-- --></span> <!-- --><span>createServerlessFunction<!-- --></span><span>(<!-- --></span><span><span>Component<!-- --></span><span>,<!-- --></span> filePath<!-- --></span><span>)<!-- --></span> <!-- --><span>{<!-- --></span>
  <!-- --><span>const<!-- --></span> pageName <!-- --><span>=<!-- --></span> <!-- --><span>getPageName<!-- --></span><span>(<!-- --></span>filePath<!-- --><span>)<!-- --></span><span>;<!-- --></span>
  <!-- --><span>const<!-- --></span> funcFolder <!-- --><span>=<!-- --></span> <!-- --><span><span>`<!-- --></span><span>.vercel/output/functions/<!-- --></span><span><span>${<!-- --></span>pageName<!-- --><span>}<!-- --></span></span><span>.func<!-- --></span><span>`<!-- --></span></span><span>;<!-- --></span>

  <!-- --><span>await<!-- --></span> fs<!-- --><span>.<!-- --></span><span>ensureDir<!-- --></span><span>(<!-- --></span>funcFolder<!-- --><span>)<!-- --></span><span>;<!-- --></span>

  <!-- --><span>await<!-- --></span> <!-- --><span>Promise<!-- --></span><span>.<!-- --></span><span>allSettled<!-- --></span><span>(<!-- --></span><span>[<!-- --></span>
    <!-- --><span>generateClientBundle<!-- --></span><span>(<!-- --></span><span>{<!-- --></span> filePath<!-- --><span>,<!-- --></span> pageName <!-- --><span>}<!-- --></span><span>)<!-- --></span><span>,<!-- --></span>
    <!-- --><span>generateLambdaBundle<!-- --></span><span>(<!-- --></span><span>{<!-- --></span>
      funcFolder<!-- --><span>,<!-- --></span>
      pageName<!-- --><span>,<!-- --></span>
      <!-- --><span>Component<!-- --></span><span>,<!-- --></span>
    <!-- --><span>}<!-- --></span><span>)<!-- --></span><span>,<!-- --></span>
  <!-- --><span>]<!-- --></span><span>)<!-- --></span><span>;<!-- --></span>

  <!-- --><span>return<!-- --></span> fs<!-- --><span>.<!-- --></span><span>writeJson<!-- --></span><span>(<!-- --></span><span><span>`<!-- --></span><span><span>${<!-- --></span>funcFolder<!-- --><span>}<!-- --></span></span><span>/.vc-config.json<!-- --></span><span>`<!-- --></span></span><span>,<!-- --></span> <!-- --><span>{<!-- --></span>
    runtime<!-- --><span>:<!-- --></span> <!-- --><span>&#34;nodejs16.x&#34;<!-- --></span><span>,<!-- --></span>
    handler<!-- --><span>:<!-- --></span> <!-- --><span>&#34;index.js&#34;<!-- --></span><span>,<!-- --></span>
    launcherType<!-- --><span>:<!-- --></span> <!-- --><span>&#34;Nodejs&#34;<!-- --></span><span>,<!-- --></span>
    shouldAddHelpers<!-- --><span>:<!-- --></span> <!-- --><span>true<!-- --></span><span>,<!-- --></span>
  <!-- --><span>}<!-- --></span><span>)<!-- --></span><span>;<!-- --></span>
<!-- --><span>}<!-- --></span></code></pre></pre></div><p>The handler function is responsible for server-rendering the HTML based on the page’s exported component. This approach is very similar to the static rendering we saw before. This time, however, we’re generating the HTML at <!-- --><i>request time </i>instead of at build time.<!-- --></p><div><pre><pre><code><span>export<!-- --></span> <!-- --><span>async<!-- --></span> <!-- --><span>function<!-- --></span> <!-- --><span>generateLambdaBundle<!-- --></span><span>(<!-- --></span><span><span>Component<!-- --></span><span>,<!-- --></span> funcFolder<!-- --><span>,<!-- --></span> pageName<!-- --><span>,<!-- --></span>outfile<!-- --></span><span>)<!-- --></span> <!-- --><span>{<!-- --></span>
  <!-- --><span>const<!-- --></span> html <!-- --><span>=<!-- --></span> <!-- --><span>ReactDOMServer<!-- --></span><span>.<!-- --></span><span>renderToString<!-- --></span><span>(<!-- --></span><span>React<!-- --></span><span>.<!-- --></span><span>createElement<!-- --></span><span>(<!-- --></span><span>Component<!-- --></span><span>)<!-- --></span><span>)<!-- --></span><span>;<!-- --></span> 
  <!-- --><span>const<!-- --></span> <!-- --><span>{<!-- --></span> code<!-- --><span>:<!-- --></span> contents <!-- --><span>}<!-- --></span> <!-- --><span>=<!-- --></span> <!-- --><span>await<!-- --></span> <!-- --><span>transform<!-- --></span><span>(<!-- --></span><span>getHandlerCode<!-- --></span><span>(<!-- --></span>html<!-- --><span>,<!-- --></span> pageName<!-- --><span>)<!-- --></span><span>)<!-- --></span><span>;<!-- --></span>

  <!-- --><span>return<!-- --></span> <!-- --><span>await<!-- --></span> <!-- --><span>build<!-- --></span><span>(<!-- --></span><span>{<!-- --></span>
    <!-- --><span>...<!-- --></span>
    stdin<!-- --><span>:<!-- --></span> <!-- --><span>{<!-- --></span> contents<!-- --><span>,<!-- --></span> resolveDir<!-- --><span>:<!-- --></span> path<!-- --><span>.<!-- --></span><span>join<!-- --></span><span>(<!-- --></span><span>&#34;.&#34;<!-- --></span><span>)<!-- --></span> <!-- --><span>}<!-- --></span><span>,<!-- --></span>
    outfile<!-- --><span>,<!-- --></span>
  <!-- --><span>}<!-- --></span><span>)<!-- --></span><span>;<!-- --></span>
<!-- --><span>}<!-- --></span><span>;<!-- --></span>

<!-- --><span>const<!-- --></span> <!-- --><span>getHandlerCode<!-- --></span> <!-- --><span>=<!-- --></span> <!-- --><span>(<!-- --></span><span>html<!-- --><span>:<!-- --></span> string<!-- --><span>,<!-- --></span> pageName<!-- --><span>:<!-- --></span> string<!-- --></span><span>)<!-- --></span> <!-- --><span>=&gt;<!-- --></span> <!-- --><span><span>`<!-- --></span><span>
  export default (req, res) =&gt; {  
    res.setHeader(&#39;Content-type&#39;, &#39;text/html&#39;);
    res.end(\`&lt;!DOCTYPE html&gt;
    &lt;html lang=&#34;en&#34;&gt;
      ...
      &lt;body&gt;
        &lt;div id=&#34;root&#34;&gt;<!-- --></span><span><span>${<!-- --></span>html<!-- --><span>}<!-- --></span></span><span>&lt;/div&gt;
        &lt;script src=&#34;<!-- --></span><span><span>${<!-- --></span>pageName<!-- --><span>}<!-- --></span></span><span>.bundle.js&#34; defer&gt;&lt;/script&gt;
      &lt;/body&gt;
    &lt;/html&gt;\`)
  }
<!-- --></span><span>`<!-- --></span></span><span>;<!-- --></span></code></pre></pre></div><p>After bundling, the <!-- --><code>.vercel/output/functions/products.func/index.js</code> handler file includes the functionality to server-render the component’s HTML.<!-- --></p><p>Besides creating a Serverless Function, we also need a <!-- --><code>prerender-config.json</code> file that contains information about the regeneration when we’re using Incremental Static Regeneration. Our framework allows the users to set their own revalidate time, so we can dynamically create this config file.<!-- --></p><p>Our new <!-- --><code>createPrerender</code> function calls the <!-- --><code>createServerlessFunction</code> and <!-- --><code>createStaticFile</code> functions that we created before, and creates a <!-- --><code>&lt;name&gt;.prerender-config.json</code>. We’re creating a static file to render this as a fallback page.  This page gets shown to the user when the page is still being generated in the background.  The Build Output API expects this fallback HTML to be located at <!-- --><code>&lt;name&gt;.prerender-fallback.html</code> , or as specified in the <!-- --><code>&lt;name&gt;.prerender-config.json</code>.<!-- --></p><div><pre><pre><code><span>export<!-- --></span> <!-- --><span>async<!-- --></span> <!-- --><span>function<!-- --></span> <!-- --><span>createPrerender<!-- --></span><span>(<!-- --></span><span><span>Component<!-- --></span><span>,<!-- --></span> filePath<!-- --><span>,<!-- --></span> pageConfig<!-- --></span><span>)<!-- --></span> <!-- --><span>{<!-- --></span>
  <!-- --><span>const<!-- --></span> pageName <!-- --><span>=<!-- --></span> <!-- --><span>getPageName<!-- --></span><span>(<!-- --></span>filePath<!-- --><span>)<!-- --></span><span>;<!-- --></span>

  <!-- --><span>const<!-- --></span> funcFolder <!-- --><span>=<!-- --></span> <!-- --><span><span>`<!-- --></span><span>.vercel/output/functions/<!-- --></span><span><span>${<!-- --></span>pageName<!-- --><span>}<!-- --></span></span><span>.func<!-- --></span><span>`<!-- --></span></span><span>;<!-- --></span>
  <!-- --><span>await<!-- --></span> fs<!-- --><span>.<!-- --></span><span>ensureDir<!-- --></span><span>(<!-- --></span>funcFolder<!-- --><span>)<!-- --></span><span>;<!-- --></span>

  <!-- --><span>await<!-- --></span> <!-- --><span>Promise<!-- --></span><span>.<!-- --></span><span>allSettled<!-- --></span><span>(<!-- --></span><span>[<!-- --></span>
    <!-- --><span>createServerlessFunction<!-- --></span><span>(<!-- --></span><span>Component<!-- --></span><span>,<!-- --></span> filePath<!-- --><span>)<!-- --></span><span>,<!-- --></span>
    <!-- --><span>createStaticFile<!-- --></span><span>(<!-- --></span><span>Component<!-- --></span><span>,<!-- --></span> filePath<!-- --><span>,<!-- --></span> <!-- --><span>{<!-- --></span>
      outdir<!-- --><span>:<!-- --></span> <!-- --><span><span>`<!-- --></span><span>.vercel/output/functions<!-- --></span><span>`<!-- --></span></span><span>,<!-- --></span>
      fileName<!-- --><span>:<!-- --></span> <!-- --><span><span>`<!-- --></span><span><span>${<!-- --></span>pageName<!-- --><span>}<!-- --></span></span><span>.prerender-fallback.html<!-- --></span><span>`<!-- --></span></span><span>,<!-- --></span>
      bundle<!-- --><span>:<!-- --></span> <!-- --><span>false<!-- --></span><span>,<!-- --></span>
    <!-- --><span>}<!-- --></span><span>)<!-- --></span><span>,<!-- --></span>
  <!-- --><span>]<!-- --></span><span>)<!-- --></span><span>;<!-- --></span>

  <!-- --><span>return<!-- --></span> <!-- --><span>writeJson<!-- --></span><span>(<!-- --></span>
    <!-- --><span><span>`<!-- --></span><span>.vercel/output/functions/<!-- --></span><span><span>${<!-- --></span>pageName<!-- --><span>}<!-- --></span></span><span>.prerender-config.json<!-- --></span><span>`<!-- --></span></span><span>,<!-- --></span>
    <!-- --><span>{<!-- --></span>
      expiration<!-- --><span>:<!-- --></span> pageConfig<!-- --><span>.<!-- --></span><span>revalidate<!-- --></span><span>,<!-- --></span>
      group<!-- --><span>:<!-- --></span> <!-- --><span>1<!-- --></span><span>,<!-- --></span>
      fallback<!-- --><span>:<!-- --></span> <!-- --><span><span>`<!-- --></span><span><span>${<!-- --></span>pageName<!-- --><span>}<!-- --></span></span><span>.prerender-fallback.html<!-- --></span><span>`<!-- --></span></span><span>,<!-- --></span>
    <!-- --><span>}<!-- --></span>
  <!-- --><span>)<!-- --></span><span>;<!-- --></span>
<!-- --><span>}<!-- --></span></code></pre></pre></div><p>Once building has been completed, we end up with a <!-- --><code>products.func</code> folder containing all the code it needs to generate the HTML on the server.<!-- --></p><div><div><figure><p><img alt="Folder structure for prerender functions" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F49xKR5AdjRUJo0YwhtNpaP%2F42b913b1e9b241f3cbcf110e985c9932%2FGroup_3.png&amp;w=1200&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F49xKR5AdjRUJo0YwhtNpaP%2F42b913b1e9b241f3cbcf110e985c9932%2FGroup_3.png&amp;w=3840&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F49xKR5AdjRUJo0YwhtNpaP%2F42b913b1e9b241f3cbcf110e985c9932%2FGroup_3.png&amp;w=3840&amp;q=75" width="1097" height="706" decoding="async" data-nimg="future" loading="lazy"/></p><figcaption><svg fill="none" height="12" viewBox="0 0 11 12" width="11"><path clip-rule="evenodd" d="M2 6l8 5V1L2 6z" fill="var(--geist-foreground)" fill-rule="evenodd" stroke="var(--geist-foreground)" stroke-width="1.5"></path></svg> <!-- -->Folder structure for prerender functions<!-- --></figcaption></figure></div><div><figure><p><img alt="Folder structure for prerender functions" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F5WQzyErWPB0iakpZUjU5FR%2Fab3bd02001bfe9a79f6f2d9dc8a6ab5a%2FGroup_20.png&amp;w=1200&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F5WQzyErWPB0iakpZUjU5FR%2Fab3bd02001bfe9a79f6f2d9dc8a6ab5a%2FGroup_20.png&amp;w=3840&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F5WQzyErWPB0iakpZUjU5FR%2Fab3bd02001bfe9a79f6f2d9dc8a6ab5a%2FGroup_20.png&amp;w=3840&amp;q=75" width="1097" height="706" decoding="async" data-nimg="future" loading="lazy"/></p><figcaption><svg fill="none" height="12" viewBox="0 0 11 12" width="11"><path clip-rule="evenodd" d="M2 6l8 5V1L2 6z" fill="var(--geist-foreground)" fill-rule="evenodd" stroke="var(--geist-foreground)" stroke-width="1.5"></path></svg> <!-- -->Folder structure for prerender functions<!-- --></figcaption></figure></div></div><div><div><figure><p><img alt="Folder structure for prerender functions" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F7ppFUydERgYA6d76qRqW8K%2Fb310dc6f86c757603e25098eba88f162%2FGroup_42.png&amp;w=828&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F7ppFUydERgYA6d76qRqW8K%2Fb310dc6f86c757603e25098eba88f162%2FGroup_42.png&amp;w=1920&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F7ppFUydERgYA6d76qRqW8K%2Fb310dc6f86c757603e25098eba88f162%2FGroup_42.png&amp;w=1920&amp;q=75" width="800" height="1009" decoding="async" data-nimg="future" loading="lazy"/></p><figcaption><svg fill="none" height="12" viewBox="0 0 11 12" width="11"><path clip-rule="evenodd" d="M2 6l8 5V1L2 6z" fill="var(--geist-foreground)" fill-rule="evenodd" stroke="var(--geist-foreground)" stroke-width="1.5"></path></svg> <!-- -->Folder structure for prerender functions<!-- --></figcaption></figure></div><div><figure><p><img alt="Folder structure for prerender functions" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F72lH5wMxriTbO9FBWVGzwV%2F8a4e885c5340ee98f41b26b8ac7c0421%2FGroup_43.png&amp;w=828&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F72lH5wMxriTbO9FBWVGzwV%2F8a4e885c5340ee98f41b26b8ac7c0421%2FGroup_43.png&amp;w=1920&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F72lH5wMxriTbO9FBWVGzwV%2F8a4e885c5340ee98f41b26b8ac7c0421%2FGroup_43.png&amp;w=1920&amp;q=75" width="800" height="1009" decoding="async" data-nimg="future" loading="lazy"/></p><figcaption><svg fill="none" height="12" viewBox="0 0 11 12" width="11"><path clip-rule="evenodd" d="M2 6l8 5V1L2 6z" fill="var(--geist-foreground)" fill-rule="evenodd" stroke="var(--geist-foreground)" stroke-width="1.5"></path></svg> <!-- -->Folder structure for prerender functions<!-- --></figcaption></figure></div></div><p>Right now, the <!-- --><code>createPrerender</code> function takes care of creating the Serverless Function, creating a static <!-- --><code>prerender-fallback.html</code> fallback file by statically rendering the component at build time, and generating a <!-- --><code>prerender-config.json</code> configuration file that includes the necessary information the Build Output API needs to configure the prerendering behavior, such as the <!-- --><code>expiration</code> value.<!-- --></p><h2><span id="edge-server-rendering"></span><a href="#edge-server-rendering">Edge Server-Rendering<!-- --></a><span><svg data-testid="geist-icon" fill="none" height="0.75em" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="0.75em" style="color:currentColor"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"></path></svg></span></h2><p>Since React is compatible with the <!-- --><a href="https://vercel.com/blog/introducing-the-edge-runtime" rel="noopener" target="_blank">Edge Runtime<!-- --></a> due to its isomorphic nature - it doesn’t use any Node.js libraries - it’s possible to render React <!-- --><i>at the Edge</i>. Creating an <!-- --><a href="https://vercel.com/edge" rel="noopener" target="_blank">Edge Function<!-- --></a> is similar to a serverless function, with its <!-- --><a href="https://vercel.com/blog/introducing-the-edge-runtime" rel="noopener" target="_blank">runtime<!-- --></a> as the most significant difference.<!-- --></p><div><div><figure><p><img alt="Group 36.png" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F2h6nIVs1bcKHK1bV5A2zuZ%2Fbe5bb0251165940717492afd87744e18%2FGroup_36.png&amp;w=1920&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F2h6nIVs1bcKHK1bV5A2zuZ%2Fbe5bb0251165940717492afd87744e18%2FGroup_36.png&amp;w=3840&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F2h6nIVs1bcKHK1bV5A2zuZ%2Fbe5bb0251165940717492afd87744e18%2FGroup_36.png&amp;w=3840&amp;q=75" width="1881" height="524" decoding="async" data-nimg="future" loading="lazy"/></p></figure></div><div><figure><p><img alt="Group 35.png" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F5Wc2Z7LaqIjwOZkWJbMO9H%2F6dc885c89fbdb17549fe3cbb6e403e37%2FGroup_35.png&amp;w=1920&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F5Wc2Z7LaqIjwOZkWJbMO9H%2F6dc885c89fbdb17549fe3cbb6e403e37%2FGroup_35.png&amp;w=3840&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F5Wc2Z7LaqIjwOZkWJbMO9H%2F6dc885c89fbdb17549fe3cbb6e403e37%2FGroup_35.png&amp;w=3840&amp;q=75" width="1881" height="524" decoding="async" data-nimg="future" loading="lazy"/></p></figure></div></div><div><div><figure><p><img alt="Group 37.png" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F1HkmQtJCYwuaba5p74S47E%2F6bd56d8273174d76ce3b513041c40ab2%2FGroup_37.png&amp;w=1200&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F1HkmQtJCYwuaba5p74S47E%2F6bd56d8273174d76ce3b513041c40ab2%2FGroup_37.png&amp;w=3840&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F1HkmQtJCYwuaba5p74S47E%2F6bd56d8273174d76ce3b513041c40ab2%2FGroup_37.png&amp;w=3840&amp;q=75" width="1090" height="959" decoding="async" data-nimg="future" loading="lazy"/></p></figure></div><div><figure><p><img alt="Group 38.png" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2FuOYiZkd4qzn7YEzfmTa7j%2F7a2851f40738cce7bfd33d8b34313a98%2FGroup_38.png&amp;w=1200&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2FuOYiZkd4qzn7YEzfmTa7j%2F7a2851f40738cce7bfd33d8b34313a98%2FGroup_38.png&amp;w=3840&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2FuOYiZkd4qzn7YEzfmTa7j%2F7a2851f40738cce7bfd33d8b34313a98%2FGroup_38.png&amp;w=3840&amp;q=75" width="1090" height="959" decoding="async" data-nimg="future" loading="lazy"/></p></figure></div></div><p>Let’s create a <!-- --><code>createEdgeFunction</code> function that takes care of generating the necessary files to enable Edge Server-Rendering. This function calls the <!-- --><code>generateEdgeBundle</code> function that eventually takes care of bundling the required files, and creates a <!-- --><code>.vc-config.json </code>configuration file that indicates we’re using the <!-- --><code>edge</code> runtime with an <!-- --><code>entrypoint</code> file instead of a handler.<!-- --></p><div><pre><pre><code><span>export<!-- --></span> <!-- --><span>async<!-- --></span> <!-- --><span>function<!-- --></span> <!-- --><span>createEdgeFunction<!-- --></span><span>(<!-- --></span><span><span>Component<!-- --></span><span>,<!-- --></span> filePath<!-- --></span><span>)<!-- --></span> <!-- --><span>{<!-- --></span>
  <!-- --><span>const<!-- --></span> pageName <!-- --><span>=<!-- --></span> <!-- --><span>getPageName<!-- --></span><span>(<!-- --></span>filePath<!-- --><span>)<!-- --></span><span>;<!-- --></span>
  <!-- --><span>const<!-- --></span> funcFolder <!-- --><span>=<!-- --></span> <!-- --><span><span>`<!-- --></span><span>.vercel/output/functions/<!-- --></span><span><span>${<!-- --></span>pageName<!-- --><span>}<!-- --></span></span><span>.func<!-- --></span><span>`<!-- --></span></span><span>;<!-- --></span>
  <!-- --><span>await<!-- --></span> <!-- --><span>ensureDir<!-- --></span><span>(<!-- --></span>funcFolder<!-- --><span>)<!-- --></span><span>;<!-- --></span>

  <!-- --><span>await<!-- --></span> <!-- --><span>generateEdgeBundle<!-- --></span><span>(<!-- --></span><span>{<!-- --></span>
    funcFolder<!-- --><span>,<!-- --></span>
    filePath<!-- --><span>,<!-- --></span>
    pageName<!-- --><span>,<!-- --></span>
    <!-- --><span>Component<!-- --></span><span>,<!-- --></span>
  <!-- --><span>}<!-- --></span><span>)<!-- --></span><span>;<!-- --></span>

  <!-- --><span>return<!-- --></span> <!-- --><span>writeJson<!-- --></span><span>(<!-- --></span><span><span>`<!-- --></span><span><span>${<!-- --></span>funcFolder<!-- --><span>}<!-- --></span></span><span>/.vc-config.json<!-- --></span><span>`<!-- --></span></span><span>,<!-- --></span> <!-- --><span>{<!-- --></span>
    runtime<!-- --><span>:<!-- --></span> <!-- --><span>&#34;edge&#34;<!-- --></span><span>,<!-- --></span>
    entrypoint<!-- --><span>:<!-- --></span> <!-- --><span>&#34;index.js&#34;<!-- --></span><span>,<!-- --></span>
  <!-- --><span>}<!-- --></span><span>)<!-- --></span><span>;<!-- --></span>
<!-- --><span>}<!-- --></span>
<!-- --></code></pre></pre></div><p>Generating the bundle is similar to the serverless approach, however this time, we care about values present on the <!-- --><code>req</code> object. To pass the prop down to the edge-rendered page, we can dynamically create the React element that was bundled from the original page’s file path.<!-- --></p><div><pre><pre><code><span>export<!-- --></span> <!-- --><span>async<!-- --></span> <!-- --><span>function<!-- --></span> <!-- --><span>generateEdgeBundle<!-- --></span><span>(<!-- --></span><span>funcFolder<!-- --><span>,<!-- --></span> pageName<!-- --><span>,<!-- --></span> filePath<!-- --></span><span>)<!-- --></span> <!-- --><span>{<!-- --></span>
  <!-- --><span>const<!-- --></span> <!-- --><span>{<!-- --></span> code<!-- --><span>:<!-- --></span> contents <!-- --><span>}<!-- --></span> <!-- --><span>=<!-- --></span> <!-- --><span>await<!-- --></span> <!-- --><span>transform<!-- --></span><span>(<!-- --></span>
    <!-- --><span>getEdgeHandlerCode<!-- --></span><span>(<!-- --></span>filePath<!-- --><span>)<!-- --></span><span>,<!-- --></span>
    edgeBuildConfig
  <!-- --><span>)<!-- --></span><span>;<!-- --></span>

  <!-- --><span>return<!-- --></span> <!-- --><span>await<!-- --></span> <!-- --><span>build<!-- --></span><span>(<!-- --></span><span>{<!-- --></span>
    <!-- --><span>...<!-- --></span>
    stdin<!-- --><span>:<!-- --></span> <!-- --><span>{<!-- --></span> contents<!-- --><span>,<!-- --></span> resolveDir<!-- --><span>:<!-- --></span> path<!-- --><span>.<!-- --></span><span>join<!-- --></span><span>(<!-- --></span><span>&#34;.&#34;<!-- --></span><span>)<!-- --></span> <!-- --><span>}<!-- --></span><span>,<!-- --></span>
    outfile<!-- --><span>,<!-- --></span>
  <!-- --><span>}<!-- --></span><span>)<!-- --></span><span>;<!-- --></span>
<!-- --><span>}<!-- --></span>

<!-- --><span>export<!-- --></span> <!-- --><span>const<!-- --></span> <!-- --><span>getEdgeHandlerCode<!-- --></span> <!-- --><span>=<!-- --></span> <!-- --><span>(<!-- --></span><span>filePath<!-- --></span><span>)<!-- --></span> <!-- --><span>=&gt;<!-- --></span> <!-- --><span><span>`<!-- --></span><span>
  import { createElement } from &#39;react&#39;;
  import { renderToString } from &#39;react-dom/server&#39;;
  import Component from &#39;<!-- --></span><span><span>${<!-- --></span>filePath<!-- --><span>}<!-- --></span></span><span>&#39;;

  export default async function(req) {
    const html = renderToString(createElement(Component, { req }));

    return new Response(\`&lt;!DOCTYPE html&gt;&lt;div id=&#34;root&#34;&gt;<!-- --></span><span><span>${<!-- --></span>html<!-- --><span>}<!-- --></span></span><span>&lt;/div&gt;\`, {
      headers: { &#39;Content-Type&#39;: &#39;text/html; charset=utf-8&#39; }
    });
  }
<!-- --></span><span>`<!-- --></span></span><span>;<!-- --></span></code></pre></pre></div><p>After bundling, we now end up with an entrypoint that passes the <!-- --><code>req</code> prop to the edge-rendered page and returns a new <!-- --><code>Response</code> object with the generated HTML.<!-- --></p><h2><span id="serverless-functions"></span><a href="#serverless-functions">Serverless Functions<!-- --></a><span><svg data-testid="geist-icon" fill="none" height="0.75em" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="0.75em" style="color:currentColor"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"></path></svg></span></h2><p>Serverless Functions can be used to server-render pages or to create data fetching endpoints. <!-- --></p><p>When we implemented Incremental Static Regeneration in the previous paragraph, we created a Serverless Function responsible for generating the page’s HTML. Server-Side Rendering uses the same approach - with the main differences being <!-- --><i>when</i> the Serverless Function gets invoked and its caching behavior.

To server-render a page, we need to create a function that generates the page’s HTML on every request.<!-- --></p><div><div><figure><p><img alt="Group 16.png" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F5QXRw0d0qcLZx5YDUz5X0m%2F41e965d9a5f654c7a36d5412be9f4c2a%2FGroup_16.png&amp;w=1920&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F5QXRw0d0qcLZx5YDUz5X0m%2F41e965d9a5f654c7a36d5412be9f4c2a%2FGroup_16.png&amp;w=3840&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F5QXRw0d0qcLZx5YDUz5X0m%2F41e965d9a5f654c7a36d5412be9f4c2a%2FGroup_16.png&amp;w=3840&amp;q=75" width="1881" height="524" decoding="async" data-nimg="future" loading="lazy"/></p></figure></div><div><figure><p><img alt="Group 19.png" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F356oKfVY2IjGIAsQueYiVG%2F751a16f5fcb74cbcde8703faea7fee36%2FGroup_19.png&amp;w=1920&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F356oKfVY2IjGIAsQueYiVG%2F751a16f5fcb74cbcde8703faea7fee36%2FGroup_19.png&amp;w=3840&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F356oKfVY2IjGIAsQueYiVG%2F751a16f5fcb74cbcde8703faea7fee36%2FGroup_19.png&amp;w=3840&amp;q=75" width="1881" height="524" decoding="async" data-nimg="future" loading="lazy"/></p></figure></div></div><div><div><figure><p><img alt="Group 32.png" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F33DyAEOTzOiAsiCM0X6S0r%2Fe3112d2f7de75c4b09a8b3355ade4627%2FGroup_32.png&amp;w=1200&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F33DyAEOTzOiAsiCM0X6S0r%2Fe3112d2f7de75c4b09a8b3355ade4627%2FGroup_32.png&amp;w=3840&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F33DyAEOTzOiAsiCM0X6S0r%2Fe3112d2f7de75c4b09a8b3355ade4627%2FGroup_32.png&amp;w=3840&amp;q=75" width="1090" height="959" decoding="async" data-nimg="future" loading="lazy"/></p></figure></div><div><figure><p><img alt="Group 31.png" srcset="/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F41IQxrW5kHpX2GQYJItfy9%2F44becaac9fcbff00f1f2861a6fc768b8%2FGroup_31.png&amp;w=1200&amp;q=75 1x, /_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F41IQxrW5kHpX2GQYJItfy9%2F44becaac9fcbff00f1f2861a6fc768b8%2FGroup_31.png&amp;w=3840&amp;q=75 2x" src="https://vercel.com/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F41IQxrW5kHpX2GQYJItfy9%2F44becaac9fcbff00f1f2861a6fc768b8%2FGroup_31.png&amp;w=3840&amp;q=75" width="1090" height="959" decoding="async" data-nimg="future" loading="lazy"/></p></figure></div></div><p>You can see that it’s essentially a subset of the Incremental Static Regeneration code. In this case, we’re only calling the <!-- --><code>createServerlessFunction</code> method covered in the previous paragraph to create both a lambda (serverless) bundle <!-- --><i>and</i> a client-side bundle.<!-- --></p><p>With ISR, this lambda only gets invoked when a user requests a page that had been cached longer than the revalidate value. Vercel then automatically regenerates the page.<!-- --></p><p>With server-side rendering, however, this function is invoked on every request. Vercel won’t automatically cache responses from this function when the page is server-rendered, resulting in unique responses every time.<!-- --></p><p>Now that we’re supporting the rendering techniques, let’s see how to implement Image Optimization.<!-- --></p><h2><span id="automatic-image-optimization"></span><a href="#automatic-image-optimization">Automatic Image Optimization<!-- --></a><span><svg data-testid="geist-icon" fill="none" height="0.75em" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="0.75em" style="color:currentColor"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"></path></svg></span></h2><p>Vercel can <!-- --><a href="https://vercel.com/docs/concepts/image-optimization" rel="noopener" target="_blank">automatically optimize images<!-- --></a> by pointing the image src to <!-- --><code>/_vercel/image?url=</code>  and adding the necessary configuration. For our framework, we&#39;ll add support for a <!-- --><code>vercel.config.js</code> file, where the Image Optimization configuration can be defined.<!-- --></p><p>Let’s make it easy for our users to use optimized images by exporting an <!-- --><code>Image</code> component. This component ensures that the src point to the <!-- --><code>/_vercel/image</code> path and adds the necessary height and width to serve the correct image size based on the viewport.<!-- --></p><div><pre><pre><code><span>export<!-- --></span> <!-- --><span>const<!-- --></span> <!-- --><span><span>Image<!-- --></span></span> <!-- --><span>=<!-- --></span> <!-- --><span>(<!-- --></span><span>props<!-- --></span><span>)<!-- --></span> <!-- --><span>=&gt;<!-- --></span> <!-- --><span>{<!-- --></span>
  <!-- --><span>return<!-- --></span>  <!-- --><span>(<!-- --></span>
    <!-- --><span>&lt;<!-- --></span>img 
      <!-- --><span>{<!-- --></span><span>...<!-- --></span>props<!-- --><span>}<!-- --></span> 
      ref<!-- --><span>=<!-- --></span><span>{<!-- --></span>ref<!-- --><span>}<!-- --></span> 
      width<!-- --><span>=<!-- --></span><span>{<!-- --></span>props<!-- --><span>.<!-- --></span><span>width<!-- --></span><span>}<!-- --></span> 
      height<!-- --><span>=<!-- --></span><span>{<!-- --></span>props<!-- --><span>.<!-- --></span><span>height<!-- --></span><span>}<!-- --></span> 
      src<!-- --><span>=<!-- --></span><span>{<!-- --></span><span><span>`<!-- --></span><span>/_vercel/image?url=<!-- --></span><span><span>${<!-- --></span><span>encodeURIComponent<!-- --></span><span>(<!-- --></span>props<!-- --><span>.<!-- --></span><span>src<!-- --></span><span>)<!-- --></span><span>}<!-- --></span></span><span>&amp;w=<!-- --></span><span><span>${<!-- --></span>props<!-- --><span>.<!-- --></span><span>width<!-- --></span><span>}<!-- --></span></span><span>&amp;q=75<!-- --></span><span>`<!-- --></span></span><span>}<!-- --></span> 
   <!-- --><span>/<!-- --></span><span>&gt;<!-- --></span>
  <!-- --><span>)<!-- --></span>
<!-- --><span>}<!-- --></span></code></pre></pre></div><p>You can now import the <!-- --><code>Image</code> component and use it like a regular <!-- --><code>img</code> tag. The only part required is some configuration in the <!-- --><code>vercel.config.js</code> file, such as the domain if it’s an external domain, the image size, and the modern image format we want to use. This file is used by our framework and outputs its contents to <!-- --><code>.vercel/output/config.json</code>. <!-- --></p><div><pre><pre><code>
<!-- --><span>export<!-- --></span> <!-- --><span>default<!-- --></span> <!-- --><span>{<!-- --></span>
  images<!-- --><span>:<!-- --></span> <!-- --><span>{<!-- --></span>
    domains<!-- --><span>:<!-- --></span> <!-- --><span>[<!-- --></span><span>...<!-- --></span><span>]<!-- --></span><span>,<!-- --></span> 
    sizes<!-- --><span>:<!-- --></span> <!-- --><span>[<!-- --></span><span>...<!-- --></span><span>]<!-- --></span><span>,<!-- --></span>
    minimumCacheTTL<!-- --><span>:<!-- --></span> <!-- --><span>60<!-- --></span><span>,<!-- --></span>
    formats<!-- --><span>:<!-- --></span> <!-- --><span>[<!-- --></span>
      <!-- --><span>&#34;image/webp&#34;<!-- --></span><span>,<!-- --></span>
      <!-- --><span>&#34;image/avif&#34;<!-- --></span>
    <!-- --><span>]<!-- --></span>
  <!-- --><span>}<!-- --></span>
<!-- --><span>}<!-- --></span></code></pre></pre></div><p>After adding this configuration, any image that uses our custom <!-- --><code>Image</code> component can benefit from the Automatic Image Optimization feature Vercel provides.<!-- --></p><h2><span id="conclusion"></span><a href="#conclusion">Conclusion<!-- --></a><span><svg data-testid="geist-icon" fill="none" height="0.75em" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="0.75em" style="color:currentColor"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"></path></svg></span></h2><p>Now that we have the necessary methods to support the rendering patterns and optimize images, we can traverse the <!-- --><code>pages</code> directory and invoke the functions to create the required files.  We’re also copying all the static files - such as images, CSS, and JavaScript - from the project’s <!-- --><code>public</code> folder to the <!-- --><code>.vercel/output/static</code> folder and creating a <!-- --><code>.vercel/output/config.json</code> file based on the project’s <!-- --><code>vercel.config.js</code>.<!-- --></p><div><pre><pre><code><span>async<!-- --></span> <!-- --><span>function<!-- --></span> <!-- --><span>buildVercelOutput<!-- --></span><span>(<!-- --></span><span>)<!-- --></span> <!-- --><span>{<!-- --></span>
  <!-- --><span>...<!-- --></span>
  <!-- --><span>await<!-- --></span> <!-- --><span>Promise<!-- --></span><span>.<!-- --></span><span>allSettled<!-- --></span><span>(<!-- --></span>
    <!-- --><span>getRoutes<!-- --></span><span>(<!-- --></span><span>)<!-- --></span><span>.<!-- --></span><span>map<!-- --></span><span>(<!-- --></span><span>async<!-- --></span> <!-- --><span>(<!-- --></span><span>filePath<!-- --></span><span>)<!-- --></span> <!-- --><span>=&gt;<!-- --></span> <!-- --><span>{<!-- --></span>
      <!-- --><span>const<!-- --></span> <!-- --><span>{<!-- --></span> pageConfig<!-- --><span>,<!-- --></span> <!-- --><span>default<!-- --></span><span>:<!-- --></span> <!-- --><span>Component<!-- --></span> <!-- --><span>}<!-- --></span> <!-- --><span>=<!-- --></span> <!-- --><span>await<!-- --></span> <!-- --><span>import<!-- --></span><span>(<!-- --></span>filePath<!-- --><span>)<!-- --></span><span>;<!-- --></span>

      <!-- --><span>switch<!-- --></span> <!-- --><span>(<!-- --></span>pageConfig<!-- --><span>.<!-- --></span><span>strategy<!-- --></span><span>)<!-- --></span> <!-- --><span>{<!-- --></span>
        <!-- --><span>case<!-- --></span> <!-- --><span>&#34;static&#34;<!-- --></span><span>:<!-- --></span>
          <!-- --><span>return<!-- --></span> <!-- --><span>createStaticFile<!-- --></span><span>(<!-- --></span><span>Component<!-- --></span><span>,<!-- --></span> filePath<!-- --><span>)<!-- --></span><span>;<!-- --></span>
        <!-- --><span>case<!-- --></span> <!-- --><span>&#34;prerender&#34;<!-- --></span><span>:<!-- --></span>
          <!-- --><span>return<!-- --></span> <!-- --><span>createPrerender<!-- --></span><span>(<!-- --></span><span>Component<!-- --></span><span>,<!-- --></span> filePath<!-- --><span>,<!-- --></span> pageConfig<!-- --><span>)<!-- --></span><span>;<!-- --></span>
        <!-- --><span>case<!-- --></span> <!-- --><span>&#34;ssr&#34;<!-- --></span><span>:<!-- --></span>
          <!-- --><span>return<!-- --></span> <!-- --><span>createServerlessFunction<!-- --></span><span>(<!-- --></span><span>Component<!-- --></span><span>,<!-- --></span> filePath<!-- --><span>)<!-- --></span><span>;<!-- --></span>
        <!-- --><span>case<!-- --></span> <!-- --><span>&#34;edge&#34;<!-- --></span><span>:<!-- --></span>
          <!-- --><span>return<!-- --></span> <!-- --><span>createEdgeFunction<!-- --></span><span>(<!-- --></span><span>Component<!-- --></span><span>,<!-- --></span> filePath<!-- --><span>)<!-- --></span><span>;<!-- --></span>

        <!-- --><span>default<!-- --></span><span>:<!-- --></span>
          <!-- --><span>return<!-- --></span><span>;<!-- --></span>
      <!-- --><span>}<!-- --></span>
    <!-- --><span>}<!-- --></span><span>)<!-- --></span>
  <!-- --><span>)<!-- --></span><span>;<!-- --></span>

  <!-- --><span>await<!-- --></span> <!-- --><span>copy<!-- --></span><span>(<!-- --></span><span>&#34;public&#34;<!-- --></span><span>,<!-- --></span> <!-- --><span>&#34;.vercel&#34;<!-- --></span><span>,<!-- --></span> <!-- --><span>&#34;output&#34;<!-- --></span><span>,<!-- --></span> <!-- --><span>&#34;static&#34;<!-- --></span><span>)<!-- --></span>

  <!-- --><span>return<!-- --></span> <!-- --><span>writeJSON<!-- --></span><span>(<!-- --></span><span>&#34;.vercel/output/config.json&#34;<!-- --></span><span>,<!-- --></span> <!-- --><span>{<!-- --></span>
    <!-- --><span>...<!-- --></span><span>(<!-- --></span><span>require<!-- --></span><span>(<!-- --></span>process<!-- --><span>.<!-- --></span><span>cwd<!-- --></span><span>(<!-- --></span><span>)<!-- --></span> <!-- --><span>+<!-- --></span> <!-- --><span>&#34;/vercel.config.js&#34;<!-- --></span><span>)<!-- --></span><span>.<!-- --></span><span>default<!-- --></span><span>)<!-- --></span><span>,<!-- --></span>
    <!-- --><span>...<!-- --></span><span>{<!-- --></span>
      version<!-- --><span>:<!-- --></span> <!-- --><span>3<!-- --></span><span>,<!-- --></span>
      routes<!-- --><span>:<!-- --></span> <!-- --><span>getTransformedRoutes<!-- --></span><span>(<!-- --></span><span>{<!-- --></span>
         cleanUrls<!-- --><span>:<!-- --></span> <!-- --><span>true<!-- --></span>
      <!-- --><span>}<!-- --></span><span>)<!-- --></span><span>.<!-- --></span><span>routes<!-- --></span><span>,<!-- --></span>
    <!-- --><span>}<!-- --></span><span>,<!-- --></span>
  <!-- --><span>}<!-- --></span><span>)<!-- --></span><span>;<!-- --></span>
  <!-- --><span>...<!-- --></span>
<!-- --><span>}<!-- --></span></code></pre></pre></div><p>When invoking this method, we can create a valid <!-- --><code>.vercel/output</code> folder that allows us to deploy to Vercel, using some of the cutting-edge features that the platform provides. <!-- --></p><p>When using modern frameworks such as <!-- --><a href="https://vercel.com/solutions/nextjs" rel="noopener" target="_blank">Next.js<!-- --></a>, we luckily don’t have to worry about implementing all these steps since the optimizations are provided out of the box.<!-- --></p><p>However, if you’re an independent developer that wants to benefit from the platform’s features or a framework author that’s looking to integrate with Vercel, the <!-- --><a href="https://vercel.com/docs/build-output-api" rel="noopener" target="_blank">Build Output API<!-- --></a> makes it easy to build any project on Vercel.<!-- --></p><p>Although it should be clear that this framework should not be used in production—it just does the bare minimum and can be optimized—it’s good to see how modern frameworks make development so much easier.<!-- --></p><p>The code is available in <!-- --><a href="https://github.com/lydiahallie/byof-demo" rel="noopener" target="_blank">this GitHub Repo<!-- --></a> to see the demo implementation covered in this article. If you’d like another example of using the Build Output API, check out <!-- --><a href="https://github.com/withastro/astro/tree/main/packages/integrations/vercel" rel="noopener" target="_blank">Astro<!-- --></a>, a framework that has successfully integrated with Vercel.<!-- --></p></div></div></div>
  </body>
</html>
