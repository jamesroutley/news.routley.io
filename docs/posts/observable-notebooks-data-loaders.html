<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://observablehq.com/notebook-kit/data-loaders">Original</a>
    <h1>Observable Notebooks Data Loaders</h1>
    
    <div id="readability-page-1" class="page"><div><div id="cell-2"><p><strong>Data loaders</strong> are special cells that run “ahead” at build time via an interpreter, rather than “live” when you view a notebook in the browser. Data loaders are useful for preparing static data, ensuring consistency and stability, and improving performance. Think of data loaders as a generalization of <a href="https://observablehq.com/notebook-kit/databases">database connectors</a> that allow languages besides SQL.</p></div><div id="cell-7"><p>Notebooks currently support Node.js and Python data loaders. We will likely add additional interpreters in the future.</p></div><div id="cell-3"><p>As an example, here is a trivial Python cell that says hello, and reports the current version of Python:</p></div><pre data-language="python"><code><span>import</span> <span>platform</span>

<span>print</span>(<span>f&#34;Hello from Python </span>{<span>platform</span>.<span>python_version</span>()}<span>!&#34;</span>, <span>end</span>=<span>&#34;&#34;</span>)</code></pre><div id="cell-22"><p>The Python cell above uses the text <strong>format</strong>, and hence its value is displayed as a string. The <strong>output</strong> is given the name <code>hello</code>, allowing it to be referenced in JavaScript:</p></div><pre data-language="js"><code><span>hello</span>.<span>toUpperCase</span>()</code></pre><div id="cell-24"><div><p>A variety of formats are supported, including these text-based formats:</p>
<ul>
<li><code>text</code> - a string</li>
<li><code>json</code> - JSON</li>
<li><code>csv</code> - comma-separated values</li>
<li><code>tsv</code> - tab-separated values</li>
<li><code>xml</code> - XML</li>
</ul>
<p>And these binary formats:</p>
<ul>
<li><code>arrow</code> - Apache Arrow IPC</li>
<li><code>parquet</code> - Apache Parquet</li>
<li><code>blob</code> - binary data as a <code>Blob</code></li>
<li><code>buffer</code> - binary data as an <code>ArrayBuffer</code></li>
</ul>
<p>You can also generate images in <code>jpeg</code>, <code>gif</code>, <code>webp</code>, <code>png</code>, and <code>svg</code> format. And you can server-side render HTML content using the <code>html</code> format.</p>
</div></div><div id="cell-21"><p>As a more realistic example, below is a Node.js data loader cell that fetches download statistics for Observable Plot from npm.</p></div><pre data-language="node"><code><span>async</span> <span>function</span> <span>getNpmDownloads</span>(<span>name</span>, {<span>end</span>, <span>start</span>}) {
  <span>const</span> <span>data</span> = [];
  <span>for</span> (<span>let</span> <span>d1</span> = <span>end</span>, <span>d2</span>; <span>d1</span> &gt; <span>start</span>; ) {
    <span>d2</span> = <span>d1</span>;
    <span>d1</span> = <span>addDate</span>(<span>d1</span>, -<span>365</span>); 
    <span>if</span> (<span>d1</span> &lt; <span>start</span>) <span>d1</span> = <span>start</span>;
    <span>const</span> <span>response</span> = <span>await</span> <span>fetch</span>(<span>`https://api.npmjs.org/downloads/range/</span>${<span>formatDate</span>(<span>d1</span>)}<span>:</span>${<span>formatDate</span>(<span>addDate</span>(<span>d2</span>, -<span>1</span>))}<span>/</span>${<span>encodeURIComponent</span>(<span>name</span>)}<span>`</span>);
    <span>if</span> (!<span>response</span>.<span>ok</span>) <span>throw</span> <span>new</span> <span>Error</span>(<span>`fetch failed: </span>${<span>response</span>.<span>status</span>}<span>`</span>);
    <span>const</span> {<span>downloads</span>} = <span>await</span> <span>response</span>.<span>json</span>();
    <span>for</span> (<span>const</span> {<span>downloads</span>: <span>value</span>, <span>day</span>: <span>date</span>} <span>of</span> <span>downloads</span>.<span>reverse</span>()) {
      <span>data</span>.<span>push</span>({<span>date</span>: <span>new</span> <span>Date</span>(<span>date</span>), <span>value</span>});
    }
  }
  <span>for</span> (<span>let</span> <span>i</span> = <span>data</span>.<span>length</span> - <span>1</span>; <span>i</span> &gt;= <span>0</span>; --<span>i</span>) {
    <span>if</span> (<span>data</span>[<span>i</span>].<span>value</span> &gt; <span>0</span>) {
      <span>return</span> <span>data</span>.<span>slice</span>(<span>data</span>[<span>0</span>].<span>value</span> &gt; <span>0</span> ? <span>0</span> : <span>1</span>, <span>i</span> + <span>1</span>); 
    }
  }
  <span>throw</span> <span>new</span> <span>Error</span>(<span>&#34;no data found&#34;</span>);
}

<span>function</span> <span>formatDate</span>(<span>date</span>) {
  <span>return</span> <span>date</span>.<span>toISOString</span>().<span>slice</span>(<span>0</span>, <span>10</span>);
}

<span>function</span> <span>addDate</span>(<span>date</span>, <span>n</span>) {
  <span>date</span> = <span>new</span> <span>Date</span>(+<span>date</span>);
  <span>date</span>.<span>setDate</span>(<span>date</span>.<span>getDate</span>() + <span>n</span>);
  <span>return</span> <span>date</span>;
}

<span>process</span>.<span>stdout</span>.<span>write</span>(
  <span>JSON</span>.<span>stringify</span>(
    <span>await</span> <span>getNpmDownloads</span>(<span>&#34;@observablehq/plot&#34;</span>, {
      <span>start</span>: <span>new</span> <span>Date</span>(<span>&#34;2022-09-01&#34;</span>),
      <span>end</span>: <span>new</span> <span>Date</span>(<span>&#34;2025-09-01&#34;</span>)
    })
  )
);</code></pre><div id="cell-6"><div>
<p>The output of a data loader cell is automatically saved to a <code>.observable/cache</code> directory on your local file system alongside your notebooks. Data snapshots are stable — the data only updates if you re-run the data loader cell. In Observable Desktop, you can re-run a data loader cell by clicking the <strong>Play</strong> button, by hitting <span><strong>shift-return</strong></span>, or by clicking on the query age in the cell toolbar. In Notebook Kit, delete the corresponding file from the <code>.observable/cache</code> directory; you can also use continuous deployment, such as GitHub Actions, to refresh data automatically.</p>
</div></div><div id="cell-27"><p>The Node.js cell above defines the <code>downloads</code> variable, which we use below to render an area chart with Observable Plot:</p></div><pre data-language="js"><code><span>Plot</span>.<span>plot</span>({
  <span>width</span>,
  <span>x</span>: {<span>type</span>: <span>&#34;utc&#34;</span>},
  <span>y</span>: {<span>grid</span>: <span>true</span>, <span>label</span>: <span>&#34;downloads&#34;</span>},
  <span>marks</span>: [
    <span>Plot</span>.<span>axisY</span>({<span>label</span>: <span>&#34;Downloads per day&#34;</span>}),
    <span>Plot</span>.<span>areaY</span>(<span>downloads</span>, {<span>x</span>: <span>&#34;date&#34;</span>, <span>y</span>: <span>&#34;value&#34;</span>, <span>curve</span>: <span>&#34;step&#34;</span>}),
    <span>Plot</span>.<span>tip</span>(<span>downloads</span>, <span>Plot</span>.<span>pointerX</span>({<span>x</span>: <span>&#34;date&#34;</span>, <span>y</span>: <span>&#34;value&#34;</span>, <span>tip</span>: <span>true</span>}))
  ]
})</code></pre><div id="cell-28"><p>Here’s a bit more about data loaders.</p></div><div id="cell-17"><div><h2 id="node-js-data-loaders" tabindex="-1"><a href="#node-js-data-loaders">Node.js data loaders</a></h2>
<p>Node.js data loaders require Node.js 22.12+ to be installed in one of the following locations:</p>
<ul>
<li><code>/opt/homebrew/bin/node</code> (Homebrew)</li>
<li><code>/opt/local/bin/node</code> (MacPorts)</li>
<li><code>/usr/local/bin/node</code> (official Node.js installer)</li>
<li><code>/usr/bin/node</code> (operating system)</li>
</ul>
</div></div><div id="cell-31"><p>TypeScript is supported via Node.js’ built-in <a href="https://nodejs.org/api/typescript.html#type-stripping">type stripping</a>. Hence, no type checking is performed, and only erasable TypeScript syntax is supported (for example, <code>enum</code> declarations are not allowed).</p></div><div id="cell-8"><p>To improve security, the Node.js interpreter uses <a href="https://nodejs.org/api/permissions.html">process-based permissions</a>: Node.js cells are only allowed to read files in the same directory as the notebook, with no other permissions. (We may offer a way to relax permissions in the future, but want to encourage safety; let us know if you run into issues.)</p></div><div id="cell-9"><p>Due to the above security restrictions, if you wish to import installed packages, they must be installed within the same directory as the notebook (<em>e.g.</em>, if your notebook is in <code>docs</code>, packages must be installed in <code>docs/node_modules</code> with a <code>docs/package.json</code>).</p></div><div id="cell-18"><div><h2 id="python-data-loaders" tabindex="-1"><a href="#python-data-loaders">Python data loaders</a></h2>
<p>Python data loaders require Python 3.12+ to be installed in one of the following locations:</p>
<ul>
<li><code>.venv/bin/python3</code> (venv)</li>
<li><code>/opt/homebrew/bin/python3</code> (Homebrew)</li>
<li><code>/opt/local/bin/python3</code> (MacPorts)</li>
<li><code>/usr/local/bin/python3</code> (official Python installer)</li>
<li><code>/usr/bin/python3</code> (operating system)</li>
</ul>
</div></div><div id="cell-30"><p>If you have a virtual environment (<code>.venv</code>) in the same directory as the notebook, it will automatically be used. However, packages are not installed implicitly; you must install packages yourself, typically using <code>pip</code>. (And we recommend using <code>pip freeze</code> to create a <code>requirements.txt</code>.)</p></div></div></div>
  </body>
</html>
