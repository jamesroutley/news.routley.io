<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/SubscriberLink/921787/949cf79f2599f734/">Original</a>
    <h1>Git archive generation meets Hyrum&#39;s law</h1>
    
    <div id="readability-page-1" class="page"><div>
<!-- $Id: slink-none,v 1.2 2005-11-04 22:11:18 corbet Exp $ -->
<blockquote>
<div>
<h3>Welcome to LWN.net</h3>
<p>
The following subscription-only content has been made available to you 
by an LWN subscriber.  Thousands of subscribers depend on LWN for the 
best news from the Linux and free software communities.  If you enjoy this 
article, please consider <a href="https://lwn.net/subscribe/">subscribing to LWN</a>.  Thank you
for visiting LWN.net!
</p></div>
</blockquote>
<p>
On January 30, the GitHub blog carried <a href="https://github.blog/changelog/2023-01-30-git-archive-checksums-may-change/">a
brief notice</a> that the checksums of archives (such as tarballs)
generated by the site had just changed.  GitHub&#39;s engineers were seemingly
unaware of the consequences of such a change — consequences that were
immediately evident to anybody familiar with either packaging systems or 
<a href="https://www.hyrumslaw.com/">Hyrum&#39;s law</a>.  Those checksums were
widely depended on by build systems, which immediately broke when the
change went live; the resulting impact of
jawbones hitting the floor was observed by seismographs worldwide.  The
change has been reverted for now, but it is worth looking at how GitHub
managed to casually break vast numbers of build systems — and why this sort
of change will almost certainly happen again.
</p><p>
One widely used GitHub feature is the ability to download an archive file
of the state of the repository at an arbitrary commit; it is often used by
build systems to obtain a specific release of a package of interest.
Internally, this archive is created at request time by the <a href="https://git-scm.com/docs/git-archive"><tt>git archive</tt></a>
subcommand.  Most build systems will compare the resulting archive against
a separately stored checksum to be sure that the archive is as expected and
has not been corrupted; if 
the checksum fails to match, the build will be aborted.  So when the
checksums of GitHub-generated tarballs abruptly changed, builds started
failing.
</p><p>
Unsurprisingly, people started to complain.  The initial <a href="https://github.com/bazel-contrib/SIG-rules-authors/issues/11#issuecomment-1409373032">response</a>
from GitHub employee (and major Git contributor) brian m. carlson was less
than fully understanding:
</p><blockquote>
	I&#39;m saying that policy has never been correct and we&#39;ve never
	guaranteed stable checksums for archives, just like Git has never
	guaranteed that. I apologize that things are broken here and that
	there hasn&#39;t been clearer communication in the past on this, but
	our policy hasn&#39;t changed in over 4 years.
</blockquote>
<p>
This answer, it might be said, was not received well.  Wyatt Anderson, for
example, <a href="https://github.com/bazel-contrib/SIG-rules-authors/issues/11#issuecomment-1409404725">said</a>:
</p><blockquote>
	The collective amount of human effort it will take to break glass,
	recover broken build systems that are impacted by this change, and
	republish artifacts across entire software ecosystems could
	probably cure cancer. Please consider reverting this change as soon
	as possible.
</blockquote>	
<p>
The outcry grew
louder, and it took about two hours for Matt Cooper (another GitHub
employee) to <a href="https://github.com/bazel-contrib/SIG-rules-authors/issues/11#issuecomment-1409438954">announce</a>
that the change was being reverted — for now: &#34;<q>we&#39;re reverting the
change, and we&#39;ll communicate better about such changes in the future
(including timelines)</q>&#34;.  Builds resumed working, and peace
reigned once again.
</p><h4>The source of the problem</h4>
<p>
The developers at GitHub did not wake up one morning and hatch a scheme to
break large numbers of build systems; instead, all they did was upgrade the
version of Git used internally.  In June 2022, René Schedar <a href="https://git.kernel.org/pub/scm/git/git.git/commit/?id=4f4be00d302">changed
<tt>git archive</tt></a> to use an internal implementation of the
gzip compression algorithm rather than invoking the <tt>gzip</tt>
program separately.  This change, which found its way into the
Git 2.38 release, allowed Git to drop the <tt>gzip</tt> dependency,
more easily support compression across operating systems, and compress the
data with less CPU time.
</p><p>
It also caused <tt>git archive</tt> to compress files differently.  While
the uncompressed data is identical, the compressed form differs, so the
checksum of the compressed data differs as well.  Once this change landed
on GitHub&#39;s production systems, the checksums for tarballs generated on the
fly abruptly changed.  GitHub backed out the change, either by reverting to
an older Git or by explicitly configuring the use of the standalone
<tt>gzip</tt> program, and the immediate problem went away.
</p><p>
The resulting discussion on the Git mailing list has been relatively muted
so far.  Eli Schwartz <a href="https://lwn.net/ml/git/a812a664-67ea-c0ba-599f-cb79e2d96694@gmail.com/">started
things off</a> with a suggestion that Git should change its default back to
using the external <tt>gzip</tt> program for now, then implement a &#34;<q>v2
archive format</q>&#34; using the internal compressor.  Using a heuristic,
<tt>git archive</tt> would always default to the older format for
commits before some sort of cutoff date.  That would ensure ongoing
compatibility for older archives, but the idea of wiring that sort of
heuristic into Git was not generally popular.
</p><p>
Ævar Arnfjörð Bjarmason, instead, <a href="https://lwn.net/ml/git/230131.86357rrtsg.gmgdl@evledraar.gmail.com/">suggested</a>
that the default could be changed to use the external <tt>gzip</tt>,
retaining the internal implementation as an option or as a fallback should
the external program not be found.
The responsibility for output compatibility could then be shifted to the
compression
program: anybody who wants to ensure that their generated archive files do
not change will have to ensure that their <tt>gzip</tt> does not change.
Since the Git developers do not control that program, they cannot guarantee
its forward compatibility in any case.
</p><p>
Carlson, though, <a href="https://lwn.net/ml/git/Y9jlWYLzZ%2Fyy4NqD@tapette.crustytoothpaste.net/">argued</a>
for avoiding stability guarantees — especially implicit guarantees — if
possible:
</p><blockquote>
	I made a change some years back to the archive format to fix the
	permissions on pax headers when extracted as files, and kernel.org
	was relying on that and broke.  Linus yelled at me because of that.
<p>
	Since then, I&#39;ve been very opposed to us guaranteeing output format
	consistency without explicitly doing so.  I had sent some patches
	before that I don&#39;t think ever got picked up that documented this
	explicitly.  I very much don&#39;t want people to come to rely on our
	behaviour unless we explicitly guarantee it.
</p></blockquote>
<p>
He went on to suggest that Git <i>could</i> guarantee the stability of the
archive format in uncompressed form.  That format would have to be
versioned, though, since the <a href="https://lwn.net/Articles/898522/">SHA-256 transition</a>, if and when it happens,
will force changes in that format anyway (a claim that Bjarmason <a href="https://lwn.net/ml/git/230131.86tu06rkbp.gmgdl@evledraar.gmail.com/">questioned</a>). In
general, carlson concluded, it may well become necessary for anybody who
wants consistent results  to decompress archive
files before checking checksums.  He later <a href="https://lwn.net/ml/git/Y9mXB1LaYSUJBlwF@tapette.crustytoothpaste.net/">reiterated</a>
that, in his opinion, implementing a stable <tt>tar</tt> format is
feasible, but adding compression is not: &#34;<q>I personally
feel that&#39;s too hard to get right and am not planning on working on it</q>&#34;.
</p><p>
Konstantin Ryabitsev <a href="https://lwn.net/ml/git/20230131150555.ewiwsbczwep6ltbi@meerkat.local/">said</a>
that, while he understands carlson&#39;s desire to avoid committing to an
output format, &#34;<q>I also think it&#39;s one of those things that happen
despite your best efforts to prevent it</q>&#34;.  He suggested adding a
<tt>--stable</tt> option to <tt>git archive</tt> that was guaranteed
to not change.
</p><h4>What next?</h4>
<p>
As of this writing, the Git community has not decided whether to make any
changes 
as the result of this episode.  Bjarmason <a href="https://lwn.net/ml/git/230201.86cz6tqyvy.gmgdl@evledraar.gmail.com/">argued</a> 
that the Git 
community should accommodate the needs of its users, even if they came to
depend
on a feature that was never advertised as being stable:
</p><blockquote>
	That&#39;s unfortunate, and those people probably shouldn&#39;t have done
	that, but that&#39;s water under the bridge. I think it would be
	irresponsible to change the output willy-nilly at this point,
	especially when it seems rather easy to find some compromise
	everyone will be happy with.
</blockquote>
<p>
He has since posted <a href="https://lwn.net/ml/git/cover-0.9-00000000000-20230202T093212Z-avarab@gmail.com/">a
patch set</a> restoring the old behavior, but also <a href="https://lwn.net/ml/git/patch-9.9-b40833b2168-20230202T093212Z-avarab@gmail.com/">documenting</a>
that this behavior could change in the future.
</p><p>
Committing to stability of this type is never a thing to be done lightly,
though; such stability can be hard to maintain (especially when dealing
with file formats defined by others) and can block other types of progress.
For example, replacing <tt>gzip</tt> can yield better compression that can
be performed more efficiently; an inability to move beyond that algorithm
would prevent Git from obtaining those benefits.  Even if Git restores the
use of an external <tt>gzip</tt> program by default, that program might,
itself, change, or downstream users like GitHub may decide that they no
longer want to support that format.
</p><p>
It would thus be unsurprising if this problem were to refuse to go away.
The Git project is reluctant to add a stability guarantee to its
maintenance load, and the same is true of its downstream users;
GitHub has said that it would give some warning before a checksum change
returns, but has not said that such a change would not happen.  The
developers and users of build systems may want to be rethinking their reliance
on the specific compression format used by one proprietary service on the
Internet.  The next time problems turn up, they will not be able to say
they haven&#39;t been warned.<br clear="all"/></p>
               </div></div>
  </body>
</html>
