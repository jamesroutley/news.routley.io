<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.dtornow.com/the-cap-theorem.-the-bad-the-bad-the-ugly/">Original</a>
    <h1>The CAP theorem. The Bad, the Bad, &amp; the Ugly</h1>
    
    <div id="readability-page-1" class="page"><div><blockquote><p>The CAP theorem is too simplistic and too widely misunderstood to be of much use for characterizing systems. Therefore I ask that we retire all references to the CAP theorem, stop talking about the CAP theorem, and put the poor thing to rest</p></blockquote><blockquote><p><a href="https://martin.kleppmann.com/2015/05/11/please-stop-calling-databases-cp-or-ap.html">Martin Kleppmann</a></p></blockquote><p>In 2000, Eric Brewer introduced the CAP Conjecture during his keynote address <a href="https://people.eecs.berkeley.edu/~brewer/cs262b-2004/PODC-keynote.pdf">Towards Robust Distributed Systems</a> at the Principles of Distributed Computing conference. Brewer posited that a distributed system cannot achieve Consistency, Availability, and Partition Tolerance simultaneously. While presented as a theorem, at that time, <em>Brewer’s interpretation</em> of CAP was merely conjecture, as Brewer did not offer formal proof in its support.</p><p>In 2002, Seth Gilbert and Nancy Lynch published a formal proof in <a href="https://users.ece.cmu.edu/~adrian/731-sp04/readings/GL-cap.pdf">Brewer’s conjecture and the feasibility of consistent, available, partition-tolerant web services</a>, rendering <em>their interpretation</em> of CAP a theorem.</p><p><strong>Since then, the CAP Theorem rose to stardom and turned into the most famous yet least useful theorem in the world of distributed systems.</strong></p><h2 id="cap">CAP</h2><p>The CAP Conjecture is an attempt to <em>formulate</em> the conflict between Consistency and Availability in the presence of Partitions while the CAP Theoremis an attempt to <em>formalize</em> the conflict between Consistency and Availability in the Presence of Partitions.</p><p>Informally, both the conjecture as well as the theorem define consistency as a safety property and availability as a liveness property of the system:</p><ul><li><p><strong>Consistency</strong>. Every read request receives a response indicating success and reflecting the value of the most recent write request or a response indicating failure.</p></li><li><p><strong>Availability</strong>. Every read request receives a response indicating success (not necessarily reflecting the value of the most recent write request).</p></li></ul><p>Additionally, both the conjecture as well as the theorem define a network partition as a failure mode of the underlying system model:</p><ul><li><strong>Network Partition</strong>. A network partition divides the network into segments, messages sent from nodes in one segment to nodes in other segments are lost.</li></ul><p>Formally, the conjecture and the theorem disagree about the definitions, rendering the conjecture and the theorem incomparable.</p><table><thead><tr><th></th><th>Consistency</th><th>Availability</th><th>Partitioning</th></tr></thead><tbody><tr><td>Conjecture</td><td>Single Copy Serializability</td><td>Some node responds timely</td><td>Temporary</td></tr><tr><td>Theorem</td><td>Linearizability r/w register</td><td>Any node responds eventually</td><td>Permanent</td></tr></tbody></table><p><strong>The conjecture doesn’t posit what the theorem proofs and the theorem doesn’t proof what the conjecture posits.</strong></p><h2 id="the-bad--the-cap-conjecture">The Bad • The CAP Conjecture</h2><p>Eric Brewer presented CAP as a “Pick 2 out of 3” framework. The “Pick 2 out of 3” interpretation implies that network partitions are optional, something you can opt-in or opt-out of. However, network partitions are inevitable in a realistic system model. Therefore, the ability to tolerate partitions is a non-negotiable requirement, rather than an optional attribute.</p><p>Since you have to account for network partitions, you have to choose between consistency and availability if and when a partition occurs. In other words, the CAP divides the world into CP and AP systems.</p><h2 id="the-bad--the-cap-theorem">The Bad • The CAP Theorem</h2><p>Seth Gilbert and Nancy Lynch published a theorem that provides a formal, mathematical articulation within the specific assumptions and constraints of their system model.</p><p>Gilbert’s and Lynch’s system model consists of three nodes, C, N₁, and N₂. Nodes do not have access to clocks and communicate by sending and receiving messages over an asynchronous network. N₁ and N₂ start out with the same value, v₀. Additionally, let’s consider a permanent network partition between N₁ and N₂. Communication is still possible between C and both N₁ and N₂, but not between N₁ and N₂.</p><p>To demonstrate the impossibility of achieving consistency, availability, and partition tolerance simultaneously, Gilbert and Lynch employed a proof by contradiction.</p><p>Assume, only for the sake of contradiction, that an algorithm exists allowing the system to be both consistent and available under this network partition.</p><h4 id="the-algorithms-failure">The Algorithm’s Failure</h4><ul><li><p><strong>Step 1</strong></p><p>C sends a single write request to N₁ setting the value to v₁.</p><p>send(w, v₁) recv(w, v₁) send(ack) recv(ack)</p></li><li><p><strong>Step 2</strong></p><p>C sends a single read request to N₂.</p><p>send(r) recv(r) send(v₀) recv(v₀)</p></li></ul><p>Under these conditions, if a write occurs on N₁ and a read occurs on N₂, the read operation will not be able to return the most recent value (v₁), thereby violating the assumed consistency.</p><p><img src="https://blog.dtornow.com/images/the-cap-theorem/the-cap-theorem.jpg" alt=""/></p><p>Therefore, we reach a contradiction: our initial assumption that this system could be both consistent and available is proven false.</p><p><strong>What did this prove?!</strong></p><h2 id="the-ugly">The Ugly</h2><p>The CAP theorem is often understood as demonstrating that (some further unspecified notion of) strong consistency cannot be achieved with high availability, whereas (some further unspecified notion of) weak consistency can be achieved with high availability.</p><p><strong>However, in the case of a permanent partition, no information can flow from one segment to another. Therefore, even the weakest form of consistency is not possible in a system with a permanent partition.</strong></p><p><strong>On the other hand, given a non-permanent partition and the requirements that a request receives a response eventually, that is, in unbounded time, both strong consistency as well as weak consistency can be achieved.</strong></p><h2 id="the-ugly-continuation">The Ugly, Continuation</h2><p>Note that Gilbert and Lynch’s definition requires any non-failed node－not just some non-failed node－to be able to generate valid responses, even if that node is isolated from other nodes. That is an unnecessary and unrealistic restriction. In essence, that restriction renders consensus protocols not highly available, because only some nodes, the nodes in the majority, are able to respond.</p><p><strong>Consensus algorithms are all about achieving high availability while maintaining strong consistency.</strong></p><h2 id="conclusion">Conclusion</h2><p>The CAP Theorem has had both positive and negative effects on the distributed system community. On the positive side, CAP has taught us to think about the inherent trade-offs in distributed systems. However, on the negative side, CAP is often misused as a definitive argument to shut down a conversation, even when CAP may not be applicable to the design challenges at hand.</p><p>While many software engineers cite the CAP Theorem to justify their design decisions, a comprehensive understanding reveals that the CAP Theorem applies “in theory” yet may not apply to the design challenges at hand “in practice”.</p><h2 id="where-do-we-go-from-here">Where do we go from here</h2><p>The trade-offs between consistency and availablity exist, but CAP is the least useful framework to think about them. My favorite framework, Invariant confluence, is presented in the paper <a href="http://www.vldb.org/pvldb/vol8/p185-bailis.pdf">Coordination Avoidance in Database Systems</a>. Invariant confluence, determines whether an application requires coordination for correct execution.</p><p>The irony of the paper referencing the CAP Theorem is not lost on me.</p><h2 id="receipts">Receipts</h2><ul><li><a href="https://arxiv.org/abs/1509.05393">A Critique of the CAP Theorem</a>, Martin Kleppmann</li><li><a href="https://dl.acm.org/doi/10.1145/3475965.3480470">Don’t Get Stuck in the “Con” Game</a>, Pat Helland</li></ul></div></div>
  </body>
</html>
