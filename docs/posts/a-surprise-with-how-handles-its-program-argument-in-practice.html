<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/unix/ShebangRelativePathSurprise">Original</a>
    <h1>A surprise with how &#39;#!&#39; handles its program argument in practice</h1>
    
    <div id="readability-page-1" class="page"><div><h2>A surprise with how &#39;#!&#39; handles its program argument in practice</h2>

	<p><small>November 17, 2025</small></p>
</div><div><p>Every so often I get to be surprised about some Unix thing. Today&#39;s
surprise is the actual behavior of &#39;#!&#39; in practice on at least
Linux, FreeBSD, and OpenBSD, which I learned about from a comment
by <a href="http://plasmasturm.org/">Aristotle Pagaltzis</a> on <a href="https://utcc.utoronto.ca/~cks/space/blog/unix/UsingEnvRarelyUseful">my entry
on (not) using &#39;#!/usr/bin/env&#39;</a>. I&#39;ll quote
the starting part here:</p>

<blockquote><p>In fact the shebang line doesn’t require absolute paths, you can
use relative paths too. The path is simply resolved from your current
directory, just as any other path would be – the kernel simply
doesn’t do anything special for shebang line paths at all. [...]</p>
</blockquote>

<p>I found this so surprising that I tested it on our Linux servers
as well as a FreeBSD and an OpenBSD machine. On the Linux servers
(and probably on the others too), the kernel really does accept the
full collection of relative paths in &#39;#!&#39;. You can write &#39;#!python3&#39;,
&#39;#!bin/python3&#39;, &#39;#!../python3&#39;, &#39;#!../../../usr/bin/python3&#39;, and so
on, and provided that your current directory is in the right place in
the filesystem, they all worked.</p>

<p>(On FreeBSD and OpenBSD I only tested the &#39;#!python3&#39; case.)</p>

<p>As far as I can tell, this behavior goes all the way back to 4.2
BSD (<a href="https://utcc.utoronto.ca/~cks/space/blog/unix/ExecAndShebangHistory">which isn&#39;t quite the origin point of &#39;#!&#39; support in the
Unix kernel</a> but is about as close as we can
get). The execve() kernel implementation in <a href="https://www.tuhs.org/cgi-bin/utree.pl?file=4.2BSD/usr/src/sys/sys/kern_exec.c">sys/kern_exec.c</a>
finds the program from your &#39;#!&#39; line with a namei() call that uses
the same arguments (apart from the name) as it did to find the
initial executable, and that initial executable can definitely be
a relative path.</p>

<p>Although this is probably the easiest way to implement &#39;#!&#39; inside
the kernel, I&#39;m a little bit surprised that it survived in Linux
(in a completely independent implementation) and in OpenBSD (where
the security people might have had a double-take at some point). But
given <a href="https://www.hyrumslaw.com/">Hyrum&#39;s Law</a> there are probably
people out there who are depending on this behavior so we&#39;re now
stuck with it.</p>

<p>(In the kernel, you&#39;d have to go at least a little bit out of your
way to check that the new path starts with a &#39;/&#39; or use a kernel
name lookup function that only resolves absolute paths. Using a
general name lookup function that accepts both absolute and relative
paths is the simplest approach.)</p>

<p>PS: I don&#39;t have access to Illumos based systems, other BSDs (NetBSD,
etc), or macOS, but I&#39;d be surprised if they had different behavior.
People with access to less mainstream Unixes (including commercial
ones like AIX) can give it a try to see if there are any Unixes
that don&#39;t support relative paths in &#39;#!&#39;.</p>
</div></div>
  </body>
</html>
