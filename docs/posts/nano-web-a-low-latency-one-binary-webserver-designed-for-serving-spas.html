<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/radiosilence/nano-web">Original</a>
    <h1>Show HN: Nano-web, a low latency one binary webserver designed for serving SPAs</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/radiosilence/nano-web/actions/workflows/publish-container.yml/badge.svg"><img src="https://github.com/radiosilence/nano-web/actions/workflows/publish-container.yml/badge.svg" alt="publish-container"/></a></p>
<p dir="auto">Hyper-minimal low-latency webserver for serving SPAs and static content based on fasthttp.</p>
<ul dir="auto">
<li>Precaches, templates, compresses all resources into memory at startup to reduce latency.</li>
<li>Brotli and gzip compression.</li>
<li>Designed to work as a docker base image or as a nanovm unikernel.</li>
<li>Includes runtime templating of environment variables (configurable prefix).</li>
<li>Index pages so works nicely with things like Astro from the get-go.</li>
<li>SPA mode to service 404s as index (200) to support client side routing.</li>
</ul>

<ul dir="auto">
<li><code>PORT</code> The port to listen on. Defaults to <code>80</code></li>
<li><code>SPA_MODE</code> when set to <code>1</code> 404 request will return <code>/public/index.html</code> as a <code>200</code>.</li>
<li><code>CONFIG_PREFIX</code> will set the prefix to scan environment variables in order to enable runtime config. Defaults to <code>VITE_</code></li>
</ul>

<div dir="auto" data-snippet-clipboard-copy-content="
FROM ghcr.io/radiosilence/nano-web:latest
COPY ./dist /public/
ENV PORT=8081
ENV SPA_MODE=1
"><pre><span>FROM</span> ghcr.io/radiosilence/nano-web:latest
<span>COPY</span> ./dist /public/
<span>ENV</span> PORT=8081
<span>ENV</span> SPA_MODE=1
</pre></div>

<p dir="auto">You&#39;ll want a <code>config.json</code> for your project that looks something like this:</p>
<div dir="auto" data-snippet-clipboard-copy-content="{
  &#34;Dirs&#34;: [&#34;public&#34;],
  &#34;Env&#34;: {
    &#34;SPA_MODE&#34;: &#34;1&#34;,
    &#34;PORT&#34;: &#34;8081&#34;
  },
  &#34;RunConfig&#34;: {
    &#34;Ports&#34;: [&#34;8081&#34;]
  }
}"><pre>{
  <span>&#34;Dirs&#34;</span>: [<span><span>&#34;</span>public<span>&#34;</span></span>],
  <span>&#34;Env&#34;</span>: {
    <span>&#34;SPA_MODE&#34;</span>: <span><span>&#34;</span>1<span>&#34;</span></span>,
    <span>&#34;PORT&#34;</span>: <span><span>&#34;</span>8081<span>&#34;</span></span>
  },
  <span>&#34;RunConfig&#34;</span>: {
    <span>&#34;Ports&#34;</span>: [<span><span>&#34;</span>8081<span>&#34;</span></span>]
  }
}</pre></div>
<p dir="auto">Make sure your public files are in a <code>./public</code> directory relative to CWD.</p>
<p dir="auto">Then you can run this command to build your image:</p>
<div data-snippet-clipboard-copy-content="ops image create -c config.json --package radiosilence/nano-web:latest -i my-website"><pre><code>ops image create -c config.json --package radiosilence/nano-web:latest -i my-website
</code></pre></div>
<p dir="auto">Then run locally to test:</p>
<div data-snippet-clipboard-copy-content="ops instance create my-website -c ./config.json --port 8081"><pre><code>ops instance create my-website -c ./config.json --port 8081
</code></pre></div>

<p dir="auto"><strong>THIS IS NOT INTENDED FOR STORING SECRETS, ALL VARIABLES WILL BE PUBLIC TO CLIENT</strong></p>
<p dir="auto">If are using <code>SPA_MODE</code> and you have set <code>CONFIG_PREFIX</code>, or use variables starting with <code>VITE_</code> by default, the server will
allow injection of environment variables at runtime, which is useful for configuring dynamically changing API urls, client IDs,
etc, in a dynamically scaling/routing environment such as Kubernetes.</p>
<p dir="auto">Here&#39;s an example <code>index.html</code> that utilises this:</p>
<div dir="auto" data-snippet-clipboard-copy-content="&lt;!DOCTYPE html&gt;
&lt;html lang=&#34;en&#34; data-theme=&#34;cf&#34;&gt;
  &lt;head&gt;
    &lt;script&gt;
      window.RUNTIME_ENV = &#34;{{.EscapedJson}}&#34;;
    &lt;/script&gt;
  &lt;/head&gt;
&lt;/html&gt;"><pre><span>&lt;!DOCTYPE html<span>&gt;</span></span>
<span>&lt;</span><span>html</span> <span>lang</span>=&#34;<span>en</span>&#34; <span>data-theme</span>=&#34;<span>cf</span>&#34;<span>&gt;</span>
  <span>&lt;</span><span>head</span><span>&gt;</span>
    <span>&lt;</span><span>script</span><span>&gt;</span>
      <span>window</span><span>.</span><span>RUNTIME_ENV</span> <span>=</span> <span>&#34;{{.EscapedJson}}&#34;</span><span>;</span>
    <span>&lt;/</span><span>script</span><span>&gt;</span>
  <span>&lt;/</span><span>head</span><span>&gt;</span>
<span>&lt;/</span><span>html</span><span>&gt;</span></pre></div>
<p dir="auto">And your client side TS which is safe to be bundled:</p>
<div dir="auto" data-snippet-clipboard-copy-content="let runtimeEnv: Record&lt;string, string&gt; = {};
try {
  runtimeEnv = JSON.parse((window as any).RUNTIME_ENV ?? &#34;{}&#34;);
} catch {
  // do nothing
}"><pre><span>let</span> <span>runtimeEnv</span>: <span>Record</span><span>&lt;</span><span>string</span><span>,</span> <span>string</span><span>&gt;</span> <span>=</span> <span>{</span><span>}</span><span>;</span>
<span>try</span> <span>{</span>
  <span>runtimeEnv</span> <span>=</span> <span>JSON</span><span>.</span><span>parse</span><span>(</span><span>(</span><span>window</span> <span>as</span> <span>any</span><span>)</span><span>.</span><span>RUNTIME_ENV</span> <span>??</span> <span>&#34;{}&#34;</span><span>)</span><span>;</span>
<span>}</span> <span>catch</span> <span>{</span>
  <span>// do nothing</span>
<span>}</span></pre></div>
<p dir="auto">In this way, you can reference these variables that can be set when the container is spun-up.</p>
</article></div></div>
  </body>
</html>
