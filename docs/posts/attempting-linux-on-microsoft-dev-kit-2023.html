<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.alexellis.io/linux-on-microsoft-dev-kit-2023/">Original</a>
    <h1>Attempting Linux on Microsoft Dev Kit 2023</h1>
    
    <div id="readability-page-1" class="page"><div role="main">
   <article>

        

        <section>
            <div><p>When I heard about the <a href="https://learn.microsoft.com/en-us/windows/arm/dev-kit">Microsoft Dev Kit 2023</a>, I was surprised by how generous the specifications were for the price? Naturally, I wanted to know if I could run Linux on it. You may also wonder. The answer is: kinda.</p>
<p>I&#39;m not sure why you are interested in ARM computers, but for me I got involved with them when porting software to the Raspberry Pi and helping support other Open Source projects to do the same. I maintain OpenFaaS, and it&#39;s always had support to run on ARM devices as well as larger on-premises or cloud servers. The team at <a href="https://metal.equinix.com/">Equinix Metal</a> gave me complimentary access to large enterprise-grade ARM servers, <a href="https://twitter.com/alexellisuk/status/1230140417032716293?s=20">Ampere even shipped me a server once</a>, which was unfortunately far too loud to leave on in the house.</p>
<p>Then came the M1 chip from Apple, this is probably where interest in ARM turned mainstream, and binaries for common software started appearing on GitHub releases pages, <a href="https://www.arm.com/company/news/2019/04/docker-and-arm-partnership">Docker announced a partnership with ARM</a> and AWS released two generations of server CPUs with an ARM architecture, including support for Lambda.</p>
<p>See also: <a href="https://www.raspberrypi.com/news/five-years-of-raspberry-pi-clusters/">raspberrypi.org: Five years of Raspberry Pi clusters</a></p>
<h2 id="thedevkitoffer">The Dev Kit offer</h2>
<p>The Dev Kit comes in a small black plastic case with a matte finish, it&#39;s got 3x USB-A ports on the back, 2x USB-C on the side and a mini Display Port connector. Inside there&#39;s a 8-core Snapdragon 8c 64-bit ARM processor, 32GB of RAM and a 512GB NVMe.</p>
<p><img src="https://pbs.twimg.com/media/FgEgrhhXoAAaAOa?format=jpg&amp;name=medium" alt="OpenBSD Dev Kit 2023"/></p>
<blockquote>
<p><a href="https://twitter.com/bluerise/status/1585584481854816256/photo/1">&#34;OpenBSD Dev Kit 2023&#34; by Patrick Wildt</a></p>
</blockquote>
<p>Why does that look like such good value? Well there really aren&#39;t any other computers in this price range that have a 64-bit ARM processor, and the Raspberry Pi 4 is miles slower in comparison.</p>
<blockquote><p lang="en" dir="ltr">Some comparisons on options for ARM64 compute. <a href="https://t.co/9mmL84m4tr">https://t.co/9mmL84m4tr</a> <a href="https://t.co/T4LIioxEo0">pic.twitter.com/T4LIioxEo0</a></p>â€” Alex Ellis (@alexellisuk) <a href="https://twitter.com/alexellisuk/status/1585018056220475393?ref_src=twsrc%5Etfw">October 25, 2022</a></blockquote> 
<p>Comparing the Raspberry Pi 4 8GB against some more expensive machines.</p>
<p>What about the <a href="https://www.apple.com/uk/shop/buy-mac/mac-mini/apple-m1-chip-with-8-core-cpu-and-8-core-gpu-256gb">Mac Mini M1 2020</a>? Despite being over 2 years old, it still costs 899 GBP and comes with half the RAM and half the storage. That makes the Dev Kit great value at 570 GBP.</p>
<p>One thing we do know about the Mac Mini is that it&#39;s worse value, but a good performer, and <a href="https://asahilinux.org/">Asahi Linux</a> seems relatively stable. It even runs Firecracker.</p>
<blockquote><p lang="en" dir="ltr">The Mac Mini M1 with Ashai Linux installed really is quite fast for the money</p>â€” Alex Ellis (@alexellisuk) <a href="https://twitter.com/alexellisuk/status/1585228202087415808?ref_src=twsrc%5Etfw">October 26, 2022</a></blockquote> 
<h2 id="whativetried">What I&#39;ve tried</h2>
<p>The first thing I figured out was how to disable secure boot.</p>
<p><img src="https://pbs.twimg.com/media/FgERrCSXwAEpKGw?format=jpg&amp;name=medium" alt="Disable secure boot"/></p>
<blockquote>
<p>Disable secure boot by holding the power button and small circular button down and powering up.</p>
</blockquote>
<p>That was painless, then I flashed my trusty USB pen drive with Ubuntu 22.04 and held the two larger buttons to &#34;Boot from USB&#34;</p>
<p><img src="https://pbs.twimg.com/media/FgERrCQXwAQrYL5?format=jpg&amp;name=medium" alt="No Linux for you"/></p>
<blockquote>
<p>No Linux for you</p>
</blockquote>
<p>Grub showed its boot menu, and I thought I&#39;d got it sorted. I couldn&#39;t have been more wrong.</p>
<p>So I did what any sane person would do next, try a newer Ubuntu version - 22.10. It broke in exactly the same way.</p>
<p>Now support for the Snapdragon 8c was merged into Linux v6.0, so I thought perhaps I needed to build a new Kernel?</p>
<p><img src="https://pbs.twimg.com/media/FgGrzi1WYAESMah?format=jpg&amp;name=medium" alt="Not booting a v6.0 Kernel"/></p>
<blockquote>
<p>Not booting a v6.0 Kernel</p>
</blockquote>
<p>Well that didn&#39;t work either.</p>
<p>So I thought maybe I had built the Kernel wrong, and would use a nightly snapshot of Debian sid, which had a v6.0 Kernel built in. That also didn&#39;t work.</p>
<p>I spent a day building and rebuilding USB drives and running debootstrap, hoping that one variation or changed Kernel configuration setting would get me booted at least into the Kernel&#39;s start-up screen.</p>
<p>Patrick Wildt, an <a href="https://www.openbsd.org/">OpenBSD</a> maintainer replied to one of my tweets and told me he had OpenBSD 7.2 up and running on his, so I thought I would at least try that out.</p>
<p><img src="https://pbs.twimg.com/media/FgGsGGIWAAAY93a?format=jpg&amp;name=medium" alt="OpenBSD running"/></p>
<blockquote>
<p>OpenBSD running!</p>
</blockquote>
<p>I was able to install Golang (Go) and port some of my own software over ([inlets/mixctl](<a href="https://github.com/inlets/mixctl/">https://github.com/inlets/mixctl/</a> - a TCP load-balancer written in Go):</p>
<p><a href="https://twitter.com/alexellisuk/status/1585738474304327680"><img src="https://pbs.twimg.com/media/FgGskFIXgAAkGx3?format=jpg&amp;name=medium" alt="inlets/mixctl"/></a></p>
<p>But I need to be able to run Linux, with KVM for this to be useful for my work on <a href="https://docs.actuated.dev">actuated - managed and isolated self-hosted CI runners using Firecracker</a>.</p>
<p>I even tried a USB flash drive known to boot with the Lenovo x13s, but it didn&#39;t get past Grub.</p>
<h2 id="notquitegivingup">Not quite giving up</h2>
<p>I&#39;ve used Linux on the desktop since 2018 and it suits my current work very well to be able to run containers directly on the host I&#39;m using, to have a lightweight and responsive UI and the ease of configuration.</p>
<p>Whilst all the various OSS projects I release all have Windows binaries, and it&#39;s a decent Operating System, I don&#39;t want to have to contend with it on a daily basis.</p>
<p>So I thought, if I can&#39;t run Linux on the machine directly, what if I could use WSL2?</p>
<blockquote><p lang="en" dir="ltr">Windows Dev Kit 2023 - Linux (WSL) vs Mac Mini with Asahi Linux</p>â€” Alex Ellis (@alexellisuk) <a href="https://twitter.com/alexellisuk/status/1587041579042217986?ref_src=twsrc%5Etfw">October 31, 2022</a></blockquote> 
<p>WSL started really quite quickly and so I ran Geekbench 5, hdparm and dd to test the CPU/memory, along with the read and write speed of the disk.</p>
<p>The single-core speed was better, whilst the multi-core speed had dropped off a little <a href="https://twitter.com/alexellisuk/status/1585563096357142528">compared to running Geekbench directly in Windows 11</a>.</p>
<p>Now because I needed KVM to run Firecracker, I typed in &#34;cpu-checker&#34; and to my dismay, I saw the module hadn&#39;t been made available in this Kernel.</p>
<p>At <a href="https://openfaas.com">OpenFaaS Ltd</a>, we&#39;ve been <a href="https://docs.actuated.dev/examples/kernel/">building Kernels</a> to run in guest VMs using Firecracker for actuated CI runners, for ARM and Intel processors, so it&#39;s something I&#39;m very familiar with.</p>
<p><a href="https://twitter.com/unixterminal">Hayden Barnes</a> has written about <a href="https://boxofcables.dev/kvm-optimized-custom-kernel-wsl2-2022/">how to build and install a custom Kernel for WSL</a>, so I took his instructions and updated them for ARM.</p>
<p><a href="https://twitter.com/alexellisuk/status/1587041591721598976/"><img src="https://pbs.twimg.com/media/FgZN4VqXkAEl--O?format=jpg&amp;name=medium" alt="Building my Kernel"/></a></p>
<blockquote>
<p>Building my Kernel with KVM enabled</p>
</blockquote>
<p>Then just like all my other experiments with trying to get Linux to work how I needed, it felt flat on its face:</p>
<p><a href="https://twitter.com/alexellisuk/status/1587042888914984960/photo/1"><img src="https://pbs.twimg.com/media/FgZO_CUWYAUn-O1?format=png&amp;name=medium" alt=""/></a></p>
<p>For whatever reason, KVM isn&#39;t built into the Kernel either as a built-in module or as a loadable module, <a href="https://github.com/microsoft/WSL/issues/8821">and a custom Kernel isn&#39;t yet supported for ARM64</a>.</p>
<h2 id="whyweneedarmforciandhowmyraspberrypibeatgithubshostedrunner">Why we need ARM for CI and how my Raspberry Pi beat GitHub&#39;s hosted runner</h2>
<p>Let&#39;s take a quick look at why access to real ARM hardware is important vs. emulation with QEMU.</p>
<p><a href="https://twitter.com/alexellisuk/status/1583092051398524928?s=20&amp;t=wargJRjxPmMPht5K3IKxAQ"><img src="https://pbs.twimg.com/media/FfhEfWRWQAAppb7?format=jpg&amp;name=medium" alt="A Raspberry Pi 8GB kitted out with an NVMe"/></a></p>
<blockquote>
<p>A Raspberry Pi 8GB kitted out with an NVMe, bought before the global shortage</p>
</blockquote>
<p>A start-up founder in Berlin <a href="https://twitter.com/fredbrancz">tweeted complaining that his tests were taking 33m30s to execute against an ARM64 CPU profile</a>.</p>
<blockquote><p lang="en" dir="ltr">Does anyone have a <a href="https://twitter.com/github?ref_src=twsrc%5Etfw">@github</a> actions self-hosted runner manifest for me to throw at a <a href="https://twitter.com/kubernetesio?ref_src=twsrc%5Etfw">@kubernetesio</a> cluster? I&#39;m tired of waiting for emulated arm64 CI runs taking ages.</p>â€” Frederic ðŸ§Š Branczyk (@fredbrancz) <a href="https://twitter.com/fredbrancz/status/1582779459379204096?ref_src=twsrc%5Etfw">October 19, 2022</a></blockquote> 
<p>I took a look at his builds and quickly found out that the reason for the slowness was user-space emulation that his team had set up with the &#34;qemu&#34; tool.</p>
<p><a href="https://www.qemu.org/">qemu</a> is what allows us to create multi-arch builds from a PC that work on ARM computers. But it can also run programs and operating systems.</p>
<p>I cloned his <a href="https://github.com/parca-dev/parca">Parca</a> project, then moved it to an organisation where I&#39;d set up <a href="https://docs.actuated.dev">actuated</a>, and changed <code>ubuntu-latest</code> to <code>actuated-aarch64</code></p>
<p>The first build went onto an ARM64 host at Equinix Metal costing 2.5 USD / hour. The build usually took over 33 minutes on a Hosted Runner without emulation, <a href="https://twitter.com/alexellisuk/status/1583089248084729856/photo/1">it took just 1min26s on the Equinix Metal host</a>.</p>
<p>And that was with only 4/80 cores allocated, if it had say 32 allocated, it would have probably completed even quicker.</p>
<p><img src="https://pbs.twimg.com/media/FfhC5z1XkAAoYjn?format=jpg&amp;name=medium" alt="QEMU vs bare-metal ARM64"/></p>
<blockquote>
<p>QEMU vs bare-metal ARM64</p>
</blockquote>
<p>Next, I set up the actuated agent on a Raspberry Pi 4. The initial run was 9m30s, 3x faster than emulation, on a device that has a one-time cost of 30-80 GBP total. I then noticed that his build was spending a long time resolving and downloading Go modules. I ran <code>go mod vendor</code> and started another build.</p>
<p>That took 7min20s. Saving 2 minutes.</p>
<p><img src="https://user-images.githubusercontent.com/6358735/197342481-229a005f-2cdf-4b47-be8b-0c5084202ae9.png" alt="Vendoring to the rescue"/></p>
<blockquote>
<p>Vendoring to the rescue</p>
</blockquote>
<p>So then I looked into what the cheapest ARM64 host would be on the cloud, and it turns out AWS has an a1.metal with 16 cores and 32GB of RAM for 0.48 USD / hour, or 350 USD / mo. So for 350 USD / mo, you can have an ARM64 build-queue 3-4 deep and builds that complete in 1 minute instead of 34.</p>
<p>If some day a Dev Kit 2023 actually works with Linux and KVM, then you could pay for vs an AWS a1.metal instance in just two months.</p>
<p>If you want ARM64 builds or end to end tests for your project, feel free to <a href="mailto:alex@openfaas.com">reach out to me</a>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>The Dev Kit 2023 from Microsoft is a snappy Windows 11 machine with excellent support for Linux, but only if used through WSL2.</p>
<p>When is Linux coming then?</p>
<p>Booting Linux isn&#39;t an option at the moment, and may require Microsoft to release a Device Tree Blob (DTB), or a third-party to reverse engineer this.</p>
<p>Whilst I enjoy this kind of tinkering, it was disappointing that a &#34;Dev Kit&#34;, built for developers can neither boot Linux, nor enable a custom Linux Kernel for WSL2.</p>
<p>What&#39;s that I hear Hacker News and Reddit cry? &#34;It&#39;s a Dev Kit for Windows, you moron!&#34; That may be the case, but Microsoft &#34;Loves Linux&#34;, and clearly has worked hard to make WSL2 available out of the box on these devices.</p>
<p>If you&#39;re looking for a step above the Raspberry Pi B 8GB for running healess Linux, the 2020 Mac Mini, configured with 16GB of RAM and 256GB of disk space runs to ~ 899 GBP. I wish it were cheaper, but with Ashai Linux it runs Firecracker, KVM, Docker and just about anything else I&#39;ve thrown at it.</p>
<p>Thanks to:</p>
<ul>
<li><a href="https://twitter.com/bluerise">Patrick Wildt</a> for encouraging me <a href="https://twitter.com/alexellisuk/status/1585737770294644736?s=20&amp;t=K0wICOefpNSqAlojmwIa-w">to try out OpenBSD</a></li>
<li><a href="https://twitter.com/lululombard">Lucas Lombard</a> for giving me access to his 2020 Mac Mini M1 for testing out <a href="https://twitter.com/alexellisuk/status/1585228202087415808?s=20&amp;t=K0wICOefpNSqAlojmwIa-w">actuated</a></li>
</ul>
<h2 id="checkoutwhatimdoingwitharm">Check out what I&#39;m doing with ARM</h2>
<p>With <a href="https://docs.actuated.dev/">actuated</a>, we&#39;re trying to make CI faster, more secure, and isolated whilst taking away a lot of the management and common issues.</p>
<p>Our actuated solution is primarily for Intel/AMD users, but also supports ARM runners.</p>
<p>Feel free to <a href="https://docs.actuated.dev">check out the docs</a>, or watch a quick demo of it in action launching Firecracker VMs for each CI job:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/2o28iUC-J1w" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>
</div>
        </section>

        

    </article>
</div></div>
  </body>
</html>
