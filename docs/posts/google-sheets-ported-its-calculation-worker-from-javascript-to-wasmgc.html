<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://web.dev/case-studies/google-sheets-wasmgc">Original</a>
    <h1>Google Sheets ported its calculation worker from JavaScript to WasmGC</h1>
    
    <div id="readability-page-1" class="page">
    <devsite-progress type="indeterminate" id="app-progress"></devsite-progress>
  
    <section>
      
      <devsite-cookie-notification-bar></devsite-cookie-notification-bar>
      <devsite-header role="banner">
  
    























<div>
  <div>
    <div>
      <div>
        <div>

  <a href="https://loeber.substack.com/" data-category="Site-Wide Custom Events" data-label="Site logo" track-type="globalNav" track-name="webDev" track-metadata-position="nav" track-metadata-eventdetail="nav">
  
  <picture>
    
    <img src="https://www.gstatic.com/devrel-devsite/prod/vb33e12289bba8e69a7a2381ed0b330f48e3451c31f78602f030bd1a47c2a4e59/web/images/lockup.svg" alt="web.dev"/>
  </picture>
  
</a>



  
  
  </div>
        <div>
          <div>
            
              
              
  <devsite-tabs>

    <nav aria-label="Upper tabs">
      
        
          <tab>
            
    <a href="https://web.dev/about" track-metadata-eventdetail="https://web.dev/about" track-type="nav" track-metadata-position="nav - about" track-metadata-module="primary nav" data-category="Site-Wide Custom Events" data-label="Tab: About" track-name="about">
    About
  
    </a>
  
  
          </tab>
        
      
        
          <tab>
            
    <a href="https://web.dev/blog" track-metadata-eventdetail="https://web.dev/blog" track-type="nav" track-metadata-position="nav - blog" track-metadata-module="primary nav" data-category="Site-Wide Custom Events" data-label="Tab: Blog" track-name="blog">
    Blog
  
    </a>
  
  
          </tab>
        
      
        
          <tab>
            
    <a href="https://web.dev/articles" track-metadata-eventdetail="https://web.dev/articles" track-type="nav" track-metadata-position="nav - articles" track-metadata-module="primary nav" data-category="Site-Wide Custom Events" data-label="Tab: Articles" track-name="articles">
    Articles
  
    </a>
  
  
          </tab>
        
      
        
          <tab>
            
    <a href="https://web.dev/learn" track-metadata-eventdetail="https://web.dev/learn" track-type="nav" track-metadata-position="nav - learn" track-metadata-module="primary nav" data-category="Site-Wide Custom Events" data-label="Tab: Learn" track-name="learn">
    Learn
  
    </a>
  
  
          </tab>
        
      
        
          <tab>
            
    <a href="https://web.dev/explore" track-metadata-eventdetail="https://web.dev/explore" track-type="nav" track-metadata-position="nav - explore" track-metadata-module="primary nav" data-category="Site-Wide Custom Events" data-label="Tab: Explore" track-name="explore">
    Explore
  
    </a>
  
  
          </tab>
        
      
        
          <tab>
            
    <a href="https://web.dev/patterns" track-metadata-eventdetail="https://web.dev/patterns" track-type="nav" track-metadata-position="nav - patterns" track-metadata-module="primary nav" data-category="Site-Wide Custom Events" data-label="Tab: Patterns" track-name="patterns">
    Patterns
  
    </a>
  
  
          </tab>
        
      
        
          <tab>
            
    <a href="https://web.dev/case-studies" track-metadata-eventdetail="https://web.dev/case-studies" track-type="nav" track-metadata-position="nav - case studies" track-metadata-module="primary nav" data-category="Site-Wide Custom Events" data-label="Tab: Case studies" track-name="case studies">
    Case studies
  
    </a>
  
  
          </tab>
        
      
    </nav>

  </devsite-tabs>

            
           </div>
          
<devsite-search enable-signin="" enable-search="" enable-suggestions="" enable-query-completion="" project-name="web.dev" tenant-name="web.dev">
  <form action="https://web.dev/s/results" method="GET">
    <div>
      <div>
        
      </div>
    </div>
  </form>
  
</devsite-search>

        </div>

        

        

        

        

        

        
          
          
          <devsite-user enable-profiles="" id="devsite-user">
            
              
              <span aria-hidden="true" visually-hidden="">Sign in</span>
            
        </devsite-user>
           
        
      </div>
    </div>
  </div>



  <div>
    
  </div>

</div>



  
</devsite-header>
      
      <section id="gc-wrapper">
        <main role="main" has-sidebar="">
          
          
          <div>
            
          </div>
          
          <devsite-content>
            
              











<article>
  
  
  
    <div>
      <div>
        <div><p>
          Thanks for tuning in to Google I/O! <a href="https://io.google/2024/explore/?utm_source=web&amp;utm_medium=embedded_marketing&amp;utm_campaign=&amp;utm_content=">Watch content on-demand</a>.
        </p></div>
      </div>
    </div>
  
  
  

  <div role="navigation">
    
    
    <ul>
  
  <li>
    
    
    
      
  <a href="https://web.dev/" data-category="Site-Wide Custom Events" data-label="Breadcrumbs" data-value="1" track-type="globalNav" track-name="breadcrumb" track-metadata-position="1" track-metadata-eventdetail="web.dev">
    
        web.dev
      
  </a>
  
    
  </li>
  
</ul>
    
      
    <devsite-thumb-rating position="header">
    </devsite-thumb-rating>
  
    
  </div>
  
      
  <devsite-feature-tooltip ack-key="AckCollectionsBookmarkTooltipDismiss" analytics-category="Site-Wide Custom Events" analytics-action-show="Callout Profile displayed" analytics-action-close="Callout Profile dismissed" analytics-label="Create Collection Callout" dismiss-button="true" id="devsite-collections-dropdown" dismiss-button-text="Dismiss" close-button-text="Got it">

        
        <devsite-bookmark></devsite-bookmark>

        <span slot="popout-heading">
          
          Stay organized with collections
        </span>
        <span slot="popout-contents">
          
          Save and categorize content based on your preferences.
        </span>
      </devsite-feature-tooltip>
  
  

  <devsite-toc depth="2" devsite-toc-embedded="">
  </devsite-toc>
  
    
  

  






<div>

  
    




<div translate="no">
  
    
    
      
    
  
    
    
      <div>
        
          <p><img alt="Thomas Steiner" src="https://web.dev/images/authors/thomassteiner.jpg" decoding="async" height="64" loading="lazy" width="64"/></p><div>
          <p><span> 
            Thomas Steiner
          </span></p><div>
            
              <a href="https://twitter.com/tomayac" aria-label="Thomas Steiner on X">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 300 271">
                  <title>X</title>
                  <path fill="currentColor" d="m236 0h46l-101 115 118 156h-92.6l-72.5-94.8-83 94.8h-46l107-123-113-148h94.9l65.5 86.6zm-16.1 244h25.5l-165-218h-27.4z"></path>
                </svg></a>
            
            
              <a href="https://github.com/tomayac" aria-label="Thomas Steiner on GitHub">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 32.6 31.8">
                  <title>GitHub</title>
                  <path d="M16.3 0C7.3 0 0 7.3 0 16.3c0 7.2 4.7 13.3 11.1 15.5.8.1 1.1-.4 1.1-.8v-2.8c-4.5 1-5.5-2.2-5.5-2.2-.7-1.9-1.8-2.4-1.8-2.4-1.5-1 .1-1 .1-1 1.6.1 2.5 1.7 2.5 1.7 1.5 2.5 3.8 1.8 4.7 1.4.1-1.1.6-1.8 1-2.2-3.6-.4-7.4-1.8-7.4-8.1 0-1.8.6-3.2 1.7-4.4-.1-.3-.7-2 .2-4.2 0 0 1.4-.4 4.5 1.7 1.3-.4 2.7-.5 4.1-.5 1.4 0 2.8.2 4.1.5 3.1-2.1 4.5-1.7 4.5-1.7.9 2.2.3 3.9.2 4.3 1 1.1 1.7 2.6 1.7 4.4 0 6.3-3.8 7.6-7.4 8 .6.5 1.1 1.5 1.1 3V31c0 .4.3.9 1.1.8 6.5-2.2 11.1-8.3 11.1-15.5C32.6 7.3 25.3 0 16.3 0z" fill-rule="evenodd" clip-rule="evenodd" fill="currentColor"></path>
                </svg></a>
            
            
              <a href="https://glitch.com/@tomayac" aria-label="Thomas Steiner on Glitch">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 32 32">
                  <title>Glitch</title>
                  <path fill="currentColor" d="M31.734 16.76c-.385-.198-4.536 1.865-5.427 1.693-2.24-.401-1.828-.667-4.839-1.359-1.203-.266-1.031-.109-1.297-.307-.172-.135-.344-.161-.599-.401 4-.719 6.026-1.693 6.734-1.839.76-.146 5.161 1.958 5.427 1.469.266-.495-.964-1.578-.401-3.031.589-1.464-.693-2.422.016-3.583.719-1.161.573-2.932.396-3.026-.396-.203-4.531 1.865-5.438 1.693-2.24-.417-1.828-.682-4.839-1.359-1.203-.271-1.031-.12-1.297-.323-.266-.198-.521-.13-1.036-.974-.521-.839-6.51-2.13-6.906-2.13-.828 0-2.375 2.13-2.375 2.13s-.599 0-2.401.094c-1.802.094-3.375.896-5.495 2.563C-.173 9.737.134 11.414.134 11.414s1.969.667 1.969 1.042c0 .359-1.729.802-1.729.802 1.12 1.411 4.583 2.745 5.464 2.745h.693c-1.438.281-2.823 1.068-4.583 2.438-2.12 1.698-1.813 3.375-1.813 3.375s1.969.667 1.969 1.026-1.729.802-1.729.802c1.12 1.427 4.583 2.76 5.464 2.76.844 0 1.427.026 2.495-.172.078.172.906 1.932 2.599 2.292 1.786.385 2.776.078 2.776.078s.094-.786-.323-1.573c1.547.161 3.307.203 5.026-.068 4.76-.719 7.12-1.865 7.896-2.01.76-.161 5.161 1.948 5.427 1.464.266-.505-.964-1.583-.385-3.036.573-1.469-.708-2.417 0-3.589.719-1.161.573-2.932.396-3.026zM4.615 11.828a1.446 1.446 0 0 1-.297-.042h-.052c-.026-.01-.052-.026-.078-.042l-.052-.01-.083-.042h-.052a.418.418 0 0 1-.068-.042l-.068-.052-.063-.036-.057-.042c-.021-.016-.042-.036-.063-.052l-.042-.042c-.026-.026-.047-.052-.068-.078l-.026-.031a1.954 1.954 0 0 1-.094-.104l-.026-.026c-.021-.036-.036-.073-.052-.109l-.026-.036-.057-.083c-.005-.021-.016-.042-.026-.063l-.026-.083-.026-.052-.016-.094-.01-.068c-.01-.026-.021-.052-.026-.078v-.068c.094.573.557 1.016 1.104 1.016.63 0 1.146-.573 1.146-1.297 0-.719-.505-1.307-1.146-1.307-.625 0-1.13.573-1.146 1.281 0-.932.667-1.693 1.495-1.693.823 0 1.479.745 1.479 1.682 0 .932-.667 1.693-1.479 1.693zm-1-1.265c0-.203.13-.365.318-.365s.307.161.307.365c0 .198-.135.344-.307.344s-.318-.161-.318-.344zm1 11.651a.712.712 0 0 1-.146 0l-.057-.016a.6.6 0 0 1-.094-.01l-.052-.016-.078-.026-.052-.026c-.031-.005-.057-.016-.083-.026l-.052-.026c-.021-.016-.047-.026-.068-.042L3.881 22l-.068-.052-.052-.042-.068-.052-.042-.042c-.031-.031-.063-.057-.089-.094a.671.671 0 0 1-.094-.12l-.031-.026c-.016-.031-.036-.063-.052-.094l-.026-.052c-.016-.026-.036-.052-.052-.078l-.026-.057-.026-.094-.026-.052-.031-.094-.01-.052c-.01-.031-.021-.063-.026-.094v-.068c.094.573.557 1.016 1.104 1.016.63 0 1.146-.573 1.146-1.292 0-.724-.505-1.297-1.146-1.297-.625 0-1.13.563-1.146 1.266 0-.932.667-1.693 1.495-1.693.823 0 1.479.76 1.479 1.682 0 .917-.667 1.693-1.479 1.693zm-1-1.266c0-.188.13-.349.318-.349s.307.161.307.349c0 .188-.135.344-.307.344s-.318-.146-.318-.344zm6.77-7.333v-.042l.042-.078.078-.297c.182-.583.344-1.172.479-1.771.161-.708.229-1.281.203-1.599-.016-.12-.031-.245-.052-.359a8.276 8.276 0 0 0-.521-1.724l-.083-.172-.026-.068c-.12-.266.057-.573.323-.557h.188l.531.036 2.104.109 1.151.078a28.24 28.24 0 0 1 10.573 2.828l.891.401c.172.078.266.307.188.505-.068.188-.266.292-.438.214l-.896-.401a27.695 27.695 0 0 0-10.359-2.786l-1.146-.068-.51-.026-1.599-.094h-.156c.188.51.339 1.031.453 1.562l.063.427c.042.453-.036 1.078-.224 1.88l-.203.823a23.62 23.62 0 0 1-.385 1.323l-.026.078v.042c-.068.188-.266.292-.438.214-.177-.068-.271-.292-.203-.495zm-2-6.349a.307.307 0 0 1 .479.026c.208.26.396.536.563.828.292.531.495 1.068.547 1.615.026.307 0 .651-.052 1.026a8.718 8.718 0 0 1-.271 1.104c-.094.313-.208.62-.333.922-.078.188-.276.266-.453.172-.172-.094-.24-.318-.156-.521l.026-.052.068-.172c.073-.198.146-.396.214-.599.099-.328.182-.661.24-1 .052-.307.063-.573.052-.802a3.47 3.47 0 0 0-.453-1.292 4.794 4.794 0 0 0-.443-.667l-.036-.042a.417.417 0 0 1 .026-.531zm1.537 13.869c-.063.38-.151.76-.271 1.13a9.549 9.549 0 0 1-.333.906c-.078.188-.276.266-.453.177-.172-.094-.24-.323-.156-.521l.026-.057.068-.172c.073-.198.146-.396.214-.599.099-.328.182-.661.24-1 .052-.307.063-.573.036-.802a3.365 3.365 0 0 0-.438-1.276 4.794 4.794 0 0 0-.443-.667l-.036-.057a.417.417 0 0 1 .026-.531.3.3 0 0 1 .464 0c.214.266.396.547.563.839.292.536.495 1.083.547 1.615.026.307 0 .651-.052 1.026zm16.531.157c-.068.188-.266.297-.438.214l-.896-.401a27.695 27.695 0 0 0-10.359-2.786l-1.135-.063h-.063l-.458-.026c-.583-.036-1.172-.068-1.755-.094l.036.078c.234.615.396 1.255.479 1.906.042.453-.036 1.078-.224 1.88l-.203.828a24.99 24.99 0 0 1-.385 1.333l-.026.068v.036c-.068.203-.266.297-.438.229a.42.42 0 0 1-.203-.51v-.026l.042-.078.078-.292c.182-.589.344-1.177.479-1.776.161-.708.229-1.281.203-1.599-.016-.12-.031-.24-.052-.359a7.996 7.996 0 0 0-.521-1.708l-.052-.12-.031-.068-.026-.063c-.12-.271.057-.578.323-.563h.188l.531.042 2.12.104 1.135.083a28.14 28.14 0 0 1 10.573 2.823l.891.401c.172.078.266.307.188.505z"></path>
                </svg></a>
            
            
              <a href="https://www.linkedin.com/in/thomassteinerlinkedin" aria-label="Thomas Steiner on LinkedIn">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 200 200">
                  <title>LinkedIn</title>
                  <path d="M185.2 0H14.8C6.6 0 0 6.4 0 14.3v171.3c0 7.9 6.6 14.3 14.8 14.3h170.4c8.1 0 14.8-6.4 14.8-14.3V14.3C199.9 6.4 193.3 0 185.2 0zM60.6 167.3H30.4V77.1h30.2v90.2zM45.5 64.8h-.2c-10.1 0-16.7-6.9-16.7-15.6 0-8.8 6.7-15.6 17.1-15.6 10.3 0 16.7 6.7 16.9 15.6 0 8.6-6.5 15.6-17.1 15.6zm124 102.5h-30.2V119c0-12.1-4.4-20.4-15.3-20.4-8.4 0-13.3 5.6-15.5 11-.8 1.9-1 4.6-1 7.3v50.4H77.3s.4-81.8 0-90.3h30.2v12.8c4-6.1 11.2-14.9 27.2-14.9 19.9 0 34.8 12.9 34.8 40.6v51.8zm-62.2-77.1c0-.1.1-.2.2-.3v.3h-.2z" fill="currentColor"></path>
                </svg></a>
            
            
              <a href="https://toot.cafe/@tomayac" aria-label="Thomas Steiner on Mastodon">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 16 16">
                  <title>Mastodon</title>
                  <path fill="currentColor" d="M 15.659 9.592 C 15.424 10.72 13.553 11.956 11.404 12.195 C 10.283 12.32 9.18 12.434 8.003 12.384 C 6.079 12.302 4.56 11.956 4.56 11.956 C 4.56 12.13 4.572 12.297 4.595 12.452 C 4.845 14.224 6.478 14.33 8.025 14.379 C 9.586 14.429 10.976 14.02 10.976 14.02 L 11.04 15.337 C 11.04 15.337 9.948 15.884 8.003 15.984 C 6.93 16.039 5.598 15.959 4.047 15.576 C 0.683 14.746 0.104 11.4 0.015 8.006 C -0.012 6.998 0.005 6.048 0.005 5.253 C 0.005 1.782 2.443 0.765 2.443 0.765 C 3.672 0.238 5.782 0.017 7.975 0 L 8.029 0 C 10.221 0.017 12.332 0.238 13.561 0.765 C 13.561 0.765 15.999 1.782 15.999 5.253 C 15.999 5.253 16.03 7.814 15.659 9.592 Z M 13.124 5.522 L 13.124 9.725 L 11.339 9.725 L 11.339 5.646 C 11.339 4.786 10.951 4.35 10.175 4.35 C 9.317 4.35 8.887 4.867 8.887 5.891 L 8.887 8.124 L 7.113 8.124 L 7.113 5.891 C 7.113 4.867 6.683 4.35 5.825 4.35 C 5.049 4.35 4.661 4.786 4.661 5.646 L 4.661 9.725 L 2.876 9.725 L 2.876 5.522 C 2.876 4.663 3.111 3.981 3.582 3.476 C 4.067 2.971 4.703 2.712 5.493 2.712 C 6.406 2.712 7.098 3.039 7.555 3.695 L 8 4.39 L 8.445 3.695 C 8.902 3.039 9.594 2.712 10.507 2.712 C 11.297 2.712 11.933 2.971 12.418 3.476 C 12.889 3.981 13.124 4.663 13.124 5.522 Z" style="stroke:none;stroke-miterlimit:10;fill-rule:evenodd;"></path>
                </svg></a>
            
            
              <a href="https://blog.tomayac.com/" aria-label="Thomas Steiner&#39;s homepage">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 30 30">
                  <title>Homepage</title>
                  <circle cx="14.5" cy="14.5" r="13.5" stroke-width="2" stroke-miterlimit="10" fill="none" stroke="currentColor"></circle>
                  <ellipse cx="14.5" cy="14.5" rx="6.1" ry="13.5" stroke-width="2" stroke-miterlimit="10" fill="none" stroke="currentColor"></ellipse>
                  <path d="M1.6 9.6h25.8M1.6 19.4h25.8" stroke-width="2" stroke-miterlimit="10" fill="none" stroke="currentColor"></path>
                </svg></a>
            
          </div>
        </div>
      </div>
    
  
</div>

<p>Google Sheets is one of the first products at Google to use WasmGC on Chrome. The move was announced in 2022, and the Sheets and Chrome teams partnered on standardization, engineering, and tooling to provide real-time feedback on optimizations. This partnership set a precedent for how engineering teams at Google can effectively work with Chrome to have more Google apps running on WasmGC.</p>

<h2 id="the_challenge_javascript" data-text="The challenge: JavaScript" tabindex="-1">The challenge: JavaScript</h2>

<p>The Google Sheets calculation engine was originally written in Java and launched in 2006. In the early days of the product, all calculation happened on the server. However, from 2013, the engine has run in the browser using JavaScript. This was originally accomplished through Google Web Toolkit (<a href="https://www.gwtproject.org/">GWT</a>), and later through Java to Closure JavaScript transpiler (<a href="https://github.com/google/j2cl/">J2CL</a>). The JavaScript calculation engine runs in a <a href="https://developer.mozilla.org/docs/Web/API/Web_Workers_API/Using_web_workers">Web Worker</a> and communicates with the main thread using a <a href="https://developer.mozilla.org/docs/Web/API/MessageChannel"><code translate="no" dir="ltr">MessageChannel</code></a>.</p>

<p>Migrating users from the server to the JavaScript version of the calculation engine (and later from GWT to J2CL) was a major undertaking that required careful validation. To ensure that the JavaScript calculation engine produced precisely the same results as the Java version, the Sheets team developed an internal validation mechanism. This mechanism can process a large corpus of sheets and validate that the results are identical between multiple versions of the calculation engine. The Sheets team uses this tool regularly to validate changes to Sheets. But the team didn&#39;t just compare the results of those calculations, they also compared the performance between JavaScript on the client and Java on the server. They found that the JavaScript version of the calculation engine was more than three times slower than the Java version.</p>

<h3 id="why_is_javascript_slower_than_java" data-text="Why is JavaScript slower than Java?" tabindex="-1">Why is JavaScript slower than Java?</h3>

<p>JavaScript is fast for a loosely-typed, dynamic language. Heavy investment in just-in-time (JIT) compilers (for example, <a href="https://v8.dev/blog/maglev">Maglev</a>, <a href="https://v8.dev/blog/sparkplug">Sparkplug</a>, and <a href="https://v8.dev/blog/turbofan-jit">Turbofan</a>) over the past 15 years has increased JavaScript&#39;s performance. However, JavaScript&#39;s loose types and dynamic behavior make it challenging for JIT compilers to generate optimal code. This means JavaScript still lags behind languages like Java and C++ for raw throughput. <a href="https://www.typescriptlang.org/">TypeScript</a> adds type safety to JavaScript, but that type information is designed to make development easier, not to provide the sorts of guarantees needed by compilers to generate optimal code. For cases like Google Sheets, where large spreadsheets can take tens of seconds to calculate, JavaScript is fast, but not fast enough.</p>

<h2 id="the_solution_wasmgc" data-text="The Solution: WasmGC" tabindex="-1">The Solution: WasmGC</h2>

<p><a href="https://developer.chrome.com/blog/wasmgc/">WasmGC</a> is an <a href="https://github.com/WebAssembly/gc">extension</a> to the existing <a href="https://webassembly.org/">WebAssembly</a> specification which adds the primitives needed to compile garbage collected languages (such as Java). For example, WasmGC adds instructions for defining types and allocating garbage collected data structures. WasmGC is poised to do for garbage collected languages what Wasm did for C++ (for example, <a href="https://loeber.substack.com/articles/ps-on-the-web#webassembly_porting_with_emscripten">Photoshop</a> or <a href="https://loeber.substack.com/case-studies/earth-webassembly">Google Earth</a>), which is to bring them to the web at near native speed. At Google, we believe that WasmGC has the potential to be even more impactful than Wasm because of the popularity of garbage collected languages.</p>

<h2 id="google_workspace_partners_with_chrome" data-text="Google Workspace partners with Chrome" tabindex="-1">Google Workspace partners with Chrome</h2>

<p>The <a href="https://github.com/WebAssembly/gc/blob/main/proposals/gc/MVP.md">WasmGC MVP draft specification</a> was published in 2019. In late 2020, Google Workspace and Chrome partnered to evaluate WasmGC using the Sheets calculation engine. Workspace&#39;s multiplatform team has significant expertise building and optimizing compilers and transpilers. Sheets, a part of Workspace, was identified as an ideal candidate for evaluating WasmGC: it is performance-sensitive and has robust performance and correctness validation mechanisms. Chrome has the <a href="http://v8.dev">V8</a> team to build and optimize the WasmGC runtime as well as contributors to <a href="https://github.com/WebAssembly/binaryen">Binaryen</a> to build ahead-of-time (AOT) optimizations. Between Chrome and Workspace, there&#39;s all the expertise needed to build and optimize a WasmGC toolchain, with Google Sheets as an ideal testbed.</p>

<h3 id="the_first_prototype" data-text="The first prototype" tabindex="-1">The first prototype</h3>

<p>By mid 2021, the teams had a working <a href="https://github.com/google/j2cl/tree/master/samples/wasm">Java to WasmGC compiler</a>. Toward the end of the same year, they had a prototype version of Google Sheets running as WasmGC and doing calculations. Along the way, they hit many challenges. Tooling for profiling and taking heap dumps did not exist and had to be built. The existing implementation relied on many JavaScript libraries for which replacements had to be found or written for WasmGC. Validating the correctness of the Wasm calculation engine was a time-consuming effort due to the experimental nature of the specification, compiler, and new libraries. But Sheets&#39; validation mechanisms were once again extremely helpful. The teams ultimately got it all working, and performance data started coming in early 2022.</p>

<h3 id="additional_optimizations" data-text="Additional optimizations" tabindex="-1">Additional optimizations</h3>

<p>The initial version of Sheets Wasm showed calculation performance roughly two times <em>slower</em> than JavaScript. However, this isn&#39;t a bad result for a new specification, new compiler, and several new libraries. From this point, the Sheets team began optimizing. Of the optimizations they found, a few categories emerged:</p>

<ul>
<li>Replicating core optimizations that already existed in the Java Virtual Machine (JVM) and in V8.</li>
<li>Using highly optimized browser APIs.</li>
<li>Removing JavaScript-specific coding patterns.</li>
</ul>

<p>Firstly, the Sheets team needed to replicate optimizations which already exist in other toolchains. The best example of this is optimizing <a href="https://en.wikipedia.org/wiki/Dynamic_dispatch">virtual method dispatching</a>, which has long been optimized by the JVM and V8, but nothing existed for WasmGC. Implementing <a href="https://en.wikipedia.org/wiki/Inline_caching">speculative inlining</a> and <a href="https://github.com/WebAssembly/binaryen/blob/main/src/passes/ConstantFieldPropagation.cpp">devirtualization</a>—two very common optimizations—sped up calculation time by roughly 40% in Chrome.</p>

<p>Second, there are cases where browser APIs are backed by optimized native implementations that are difficult to compete with using Wasm. Strings and regular expressions are two good examples. Specifically, with regular expressions, the team saw nearly a 100 times speedup of regular expression operations when switching from <a href="https://github.com/google/re2j">re2j</a> (compiled to WasmGC) to the <a href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/RegExp"><code translate="no" dir="ltr">RegExp</code></a> browser API in Chrome, which can compile each regular expression to its own machine code.</p>

<p>Lastly, they found that years of optimizing had caused the codebase to be over-fitted to JavaScript. For example, they had a core data structure in Sheets which was blurring the lines between arrays and maps. This is efficient in JavaScript, which automatically models sparse arrays as maps, but slow on other platforms. So they had to rewrite the code in a more platform-agnostic way. This is another thing the team like about WebAssembly: it makes it easier for multiplatform applications to get good performance on the web. You don&#39;t have to bend your whole application to the idiosyncrasies of JavaScript.</p>

<h2 id="conclusion" data-text="Conclusion" tabindex="-1">Conclusion</h2>

<p>WasmGC is a powerful technology that has the potential to advance the way developers build web applications. Over the coming years, at Google, we hope to see WasmGC advance to support <a href="https://chromestatus.com/feature/5163209685467136">shared memory multithreading</a> and further improve single threaded performance. We encourage all web developers to consider <a href="https://v8.dev/blog/wasm-gc-porting">using WasmGC</a> for their next high-performance project. Join us and make the web a faster, smoother place together!</p>

<h2 id="acknowledgements" data-text="Acknowledgements" tabindex="-1">Acknowledgements</h2>

<p>Thank you for those who worked on the WasmGC implementation and this case study:
Diwas Adhikary,
Matthew Albright,
Ksenia Bukina,
Julien Dramaix,
Asim Fazal,
Michael Frederick,
Goktug Gokdogan,
Janice Gu,
Adam Klein,
Manos Koukoutos,
Jakob Kummerow,
Matthias Liedtke,
Thomas Lively,
Roberto Lublinerman,
Vishrut Mehta,
Thomas Nattestad,
Josh Pearlstein,
Joaquim Perotti,
Chris Ruenes,
Steven Saviano,
Derek Schuff,
Tim Sears,
Michael Thomas,
Yuan Tian,
Philipp Weis,
Mason Wu,
Alon Zakai, and
Emanuel Ziegler.</p>

  

  
</div>

  

  
    
    
      
    <devsite-thumb-rating position="footer">
    </devsite-thumb-rating>
  
       
    
    
  

  
  
</article>


<devsite-content-footer>
  <p>Except as otherwise noted, the content of this page is licensed under the <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 License</a>, and code samples are licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a>. For details, see the <a href="https://developers.google.com/site-policies">Google Developers Site Policies</a>. Java is a registered trademark of Oracle and/or its affiliates.</p>
  <p>Last updated 2024-06-26 UTC.</p>
</devsite-content-footer>


<devsite-notification>
</devsite-notification>


  
<p>
  <template>
  [{
      &#34;type&#34;: &#34;thumb-down&#34;,
      &#34;id&#34;: &#34;missingTheInformationINeed&#34;,
      &#34;label&#34;:&#34;Missing the information I need&#34;
    },{
      &#34;type&#34;: &#34;thumb-down&#34;,
      &#34;id&#34;: &#34;tooComplicatedTooManySteps&#34;,
      &#34;label&#34;:&#34;Too complicated / too many steps&#34;
    },{
      &#34;type&#34;: &#34;thumb-down&#34;,
      &#34;id&#34;: &#34;outOfDate&#34;,
      &#34;label&#34;:&#34;Out of date&#34;
    },{
      &#34;type&#34;: &#34;thumb-down&#34;,
      &#34;id&#34;: &#34;samplesCodeIssue&#34;,
      &#34;label&#34;:&#34;Samples / code issue&#34;
    },{
      &#34;type&#34;: &#34;thumb-down&#34;,
      &#34;id&#34;: &#34;otherDown&#34;,
      &#34;label&#34;:&#34;Other&#34;
    }]
  </template>
  <template>
  [{
      &#34;type&#34;: &#34;thumb-up&#34;,
      &#34;id&#34;: &#34;easyToUnderstand&#34;,
      &#34;label&#34;:&#34;Easy to understand&#34;
    },{
      &#34;type&#34;: &#34;thumb-up&#34;,
      &#34;id&#34;: &#34;solvedMyProblem&#34;,
      &#34;label&#34;:&#34;Solved my problem&#34;
    },{
      &#34;type&#34;: &#34;thumb-up&#34;,
      &#34;id&#34;: &#34;otherUp&#34;,
      &#34;label&#34;:&#34;Other&#34;
    }]
  </template>
  
</p>
            
          </devsite-content>
        </main>
        <devsite-footer-promos>
          
            
          
        </devsite-footer-promos>
        <devsite-footer-linkboxes>
          
            
<nav aria-label="Footer links">
  
  <ul>
    
    <li>
    <h3>web.dev</h3>
      <ul>
        
        <li>
          
          <h3>
          
            web.dev
          
          </h3>
          
          
          <p>We want to help you build beautiful, accessible, fast, and secure websites that work cross-browser, and for all of your users. This site is our home for content to help you on that journey, written by members of the Chrome team, and external experts.</p>
          
        </li>
        
      </ul>
    </li>
    
    <li>
    <h3>Contribute</h3>
      <ul>
        
        <li>
          
          <a href="https://issuetracker.google.com/issues/new?component=1400680&amp;template=1857359" data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
            
          
            File a bug
          
          </a>
          
          
        </li>
        
        <li>
          
          <a href="https://issuetracker.google.com/issues?q=status:open%20componentid:1400680&amp;s=created_time:desc" data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
            
              
              
            
          
            See open issues
          
          </a>
          
          
        </li>
        
      </ul>
    </li>
    
    <li>
    <h3>Related Content</h3>
      <ul>
        
        <li>
          
          <a href="https://developer.chrome.com/" data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
            
          
            Chrome for Developers
          
          </a>
          
          
        </li>
        
        <li>
          
          <a href="https://blog.chromium.org/" data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
            
          
            Chromium updates
          
          </a>
          
          
        </li>
        
        <li>
          
          <a href="https://loeber.substack.com/case-studies" data-category="Site-Wide Custom Events" data-label="Footer Link (index 3)">
            
          
            Case studies
          
          </a>
          
          
        </li>
        
        <li>
          
          <a href="https://loeber.substack.com/shows" data-category="Site-Wide Custom Events" data-label="Footer Link (index 4)">
            
              
              
            
          
            Podcasts &amp; shows
          
          </a>
          
          
        </li>
        
      </ul>
    </li>
    
    <li>
    <h3>Connect</h3>
      <ul>
        
        <li>
          
          <a href="https://twitter.com/ChromiumDev" data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">
            
          
            @ChromiumDev on X
          
          </a>
          
          
        </li>
        
        <li>
          
          <a href="https://www.youtube.com/user/ChromeDevelopers" data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">
            
          
            YouTube
          
          </a>
          
          
        </li>
        
        <li>
          
          <a href="https://www.linkedin.com/showcase/chrome-for-developers" data-category="Site-Wide Custom Events" data-label="Footer Link (index 3)">
            
              
              
            
          
            Chrome for Developers on LinkedIn
          
          </a>
          
          
        </li>
        
      </ul>
    </li>
    
  </ul>
  
</nav>
          
        </devsite-footer-linkboxes>
        <devsite-footer-utility>
          
            

<div>
  

  
  <nav aria-label="Utility links">
    
    <ul>
      
      <li>
        
        
        <a href="https://policies.google.com/terms" data-category="Site-Wide Custom Events" data-label="Footer Terms link">
          Terms
        </a>
        
      </li>
      
      <li>
        
        
        <a href="https://policies.google.com/privacy" data-category="Site-Wide Custom Events" data-label="Footer Privacy link">
          Privacy
        </a>
        
      </li>
      
      <li>
        
        
        <a href="#" data-category="Site-Wide Custom Events" data-label="Footer Manage cookies link" aria-hidden="true">
          Manage cookies
        </a>
        
      </li>
      
    </ul>
    
    
  </nav>
</div>
          
        </devsite-footer-utility>
        <devsite-panel></devsite-panel>
        
      </section></section>
    <devsite-sitemask></devsite-sitemask>
    <devsite-snackbar>
</devsite-snackbar>
    <devsite-tooltip></devsite-tooltip>
    <devsite-heading-link></devsite-heading-link>
    <devsite-analytics analytics-iframe="">
      
        

      
    </devsite-analytics>
    
      <devsite-badger></devsite-badger>
    
    
    
    <devsite-a11y-announce></devsite-a11y-announce>
  
</div>
  </body>
</html>
