<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.tmm.cx/2022/05/15/the-very-weird-hewlett-packard-freedos-option/">Original</a>
    <h1>The weird Hewlett Packard FreeDOS option (2022)</h1>
    
    <div id="readability-page-1" class="page"><article id="post-309">
	<!-- .entry-header -->
		<div>
		
<div><p><span aria-hidden="true"></span><img fetchpriority="high" decoding="async" width="1024" height="768" alt="" src="https://blog.tmm.cx/wp-content/uploads/2022/05/Screenshot_HPDOS_2022-05-15_170432.png" data-object-fit="cover" srcset="https://blog.tmm.cx/wp-content/uploads/2022/05/Screenshot_HPDOS_2022-05-15_170432.png 1024w, https://blog.tmm.cx/wp-content/uploads/2022/05/Screenshot_HPDOS_2022-05-15_170432-300x225.png 300w, https://blog.tmm.cx/wp-content/uploads/2022/05/Screenshot_HPDOS_2022-05-15_170432-768x576.png 768w" sizes="(max-width: 1024px) 100vw, 1024px"/></p><p>The very weird Hewlett Packard FreeDOS option</p></div>



<p>In this installment: some strange things I discovered when purchasing a FreeDOS laptop from Hewlett Packard. I suspect that the audience for this will be somewhat limited but I had fun exploring this. Perhaps you, dear reader, will find a chuckle in here too.</p>



<p>Some background: I recently purchased a <a href="https://www.hp.com/us-en/shop/pdp/hp-zbook-fury-17-g7-mobile-workstation-customizable-46q00av-mb">HP ZBook 17.8 G8</a> as I run <a href="https://getfedora.org">Fedora Linux</a> I decided to have a little fun with the OS selection and picked the <a href="https://freedos.org">FreeDOS</a> option (Other options include Ubuntu, and various flavors of Windows 11).</p>



<figure><img decoding="async" width="1024" height="266" src="https://blog.tmm.cx/wp-content/uploads/2022/05/Screenshot-2022-05-15-at-16-40-31-Stel-uw-ideale-workstation-samen-HP-Store-Nederland-1024x266.png" alt="" srcset="https://blog.tmm.cx/wp-content/uploads/2022/05/Screenshot-2022-05-15-at-16-40-31-Stel-uw-ideale-workstation-samen-HP-Store-Nederland-1024x266.png 1024w, https://blog.tmm.cx/wp-content/uploads/2022/05/Screenshot-2022-05-15-at-16-40-31-Stel-uw-ideale-workstation-samen-HP-Store-Nederland-300x78.png 300w, https://blog.tmm.cx/wp-content/uploads/2022/05/Screenshot-2022-05-15-at-16-40-31-Stel-uw-ideale-workstation-samen-HP-Store-Nederland-768x200.png 768w, https://blog.tmm.cx/wp-content/uploads/2022/05/Screenshot-2022-05-15-at-16-40-31-Stel-uw-ideale-workstation-samen-HP-Store-Nederland.png 1400w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p>And! Sure enough: After unpacking and plugging in the laptop I was greeted by the following.</p>



<figure><img decoding="async" width="1024" height="771" src="https://blog.tmm.cx/wp-content/uploads/2022/05/FREEDOS-blurred-1024x771.jpg" alt="" srcset="https://blog.tmm.cx/wp-content/uploads/2022/05/FREEDOS-blurred-1024x771.jpg 1024w, https://blog.tmm.cx/wp-content/uploads/2022/05/FREEDOS-blurred-300x226.jpg 300w, https://blog.tmm.cx/wp-content/uploads/2022/05/FREEDOS-blurred-768x578.jpg 768w, https://blog.tmm.cx/wp-content/uploads/2022/05/FREEDOS-blurred.jpg 1280w" sizes="(max-width: 1024px) 100vw, 1024px"/><figcaption>The out of the box FreeDOS experience of the HP Zbook Fury 17.8 G8</figcaption></figure>



<p>Apart from this appearing to be a very old version of FreeDOS the primary thing I noticed was how long it took to get to this point. I was also fairly sure that I saw something flash during boot which looked suspiciously like some Linux kernel boot messages. I saved whatever was on the hard drive from the factory to some image files before installing Fedora Workstation.</p>



<p>From the factory HP included three partitions:</p>



<ul><li>An <a href="https://en.wikipedia.org/wiki/EFI_system_partition">EFI System partition</a></li><li>An <a href="https://en.wikipedia.org/wiki/Ext4">EXT4 Linux filesystem </a></li><li>A <a href="https://wiki.archlinux.org/title/swap#Swap_partition">Linux swap partition</a></li></ul>



<p>None of this appears terribly DOS-sy. It appears that HP is actually shipping a Linux and then running DOS in a VM. Let’s try to boot this whole thing in a VM and see what we get.</p>




		




<p>As the eagle eyes of you might have noticed the “HP Documentation” link appears to start some kind of PDF reader. The document at the end starts with the following:</p>



<figure><img loading="lazy" decoding="async" width="1024" height="431" src="https://blog.tmm.cx/wp-content/uploads/2022/05/Screenshot-from-2022-05-15-17-18-57-1024x431.png" alt="" srcset="https://blog.tmm.cx/wp-content/uploads/2022/05/Screenshot-from-2022-05-15-17-18-57-1024x431.png 1024w, https://blog.tmm.cx/wp-content/uploads/2022/05/Screenshot-from-2022-05-15-17-18-57-300x126.png 300w, https://blog.tmm.cx/wp-content/uploads/2022/05/Screenshot-from-2022-05-15-17-18-57-768x323.png 768w, https://blog.tmm.cx/wp-content/uploads/2022/05/Screenshot-from-2022-05-15-17-18-57-1536x647.png 1536w, https://blog.tmm.cx/wp-content/uploads/2022/05/Screenshot-from-2022-05-15-17-18-57.png 1959w" sizes="auto, (max-width: 1024px) 100vw, 1024px"/><figcaption>Very limited indeed</figcaption></figure>



<p>It seems that although this computer did indeed not ship with a Windows ® operating system it shipped with at a minimum two others. I say at a minimum because there’s actually THREE operating systems shipped on this machine!</p>



<h2>What was in the factory image</h2>



<p>Now that we’ve seen what the factory image does let’s have a look at how it does it. First of all: What are we booting?</p>



<pre><code># cat /etc/os-release 
PRETTY_NAME=&#34;Debian GNU/Linux 9 (stretch)&#34;
NAME=&#34;Debian GNU/Linux&#34;
VERSION_ID=&#34;9&#34;
VERSION=&#34;9 (stretch)&#34;
ID=debian
HOME_URL=&#34;https://www.debian.org/&#34;
SUPPORT_URL=&#34;https://www.debian.org/support&#34;
BUG_REPORT_URL=&#34;https://bugs.debian.org/&#34;</code></pre>



<p>So it appears we got a <a href="https://www.debian.org/">Debian GNU/Linux 9</a> installation on the hard drive. After some poking around I have found the following:</p>



<ul><li>The laptops is set to UEFI boot, which boots a pretty standard <a href="https://www.gnu.org/software/grub/">GRUB</a></li><li>Debian gets booted with <a href="https://www.kernel.org/doc/html/v4.15/gpu/drm-kms.html">KMS</a> disabled, as well as all <a href="https://en.wikipedia.org/wiki/Direct_Rendering_Manager">DRM</a> drivers.</li><li>Once the system is booted <a href="https://en.wikipedia.org/wiki/GNOME_Display_Manager">Gnome Display Manager</a> starts</li><li>GDM will automatically login the root user and start the <a href="https://wiki.debian.org/Xsession">/root/.xsession</a></li><li>The XSession will start an XFCE terminal and executes Qemu on an image file in <code>/home/aos/qemu</code></li></ul>



<p>The actual /root/.xsession is copied below:</p>



<pre><code>#!/bin/bash

xfce4-terminal --zoom=-7 --geometry=1x1 --fullscreen --hide-toolbar --hide-menubar --hide-scrollbar --hide-borders -e &#34;bash -c &#39;sleep 2 &amp;&amp; xdotool search --name QEMU windowsize 100% 100% &amp;&amp; xdotool search --name QEMU windowsize 100% 100%  &amp;&amp; xdotool search --name QEMU windowsize 100% 100%  &amp;&amp; xdotool search --name QEMU windowsize 100% 100% &amp;  qemu-system-x86_64 -smp cores=8 --enable-kvm -m 2048 -vga cirrus -hda /home/aos/qemu/freedos.img -usbdevice tablet -usb -device usb-host,hostbus=2,hostaddr=1 -monitor telnet:127.0.0.1:9378,server,nowait &amp;&amp; poweroff -f  ; exec bash&#39;&#34; &gt;/dev/null 2&gt;&amp;1
poweroff -f
#xfce4-terminal --fullscreen --hide-toolbar --hide-menubar --hide-scrollbar --hide-borders</code></pre>



<p>This is an… interesting approach, probably necessary because no <a href="https://en.wikipedia.org/wiki/X_window_manager">window manager</a> is started in the X session. <a href="https://github.com/jordansissel/xdotool">Xdotool</a> is used in this case to repeatedly try to resize the Qemu window until it covers the entire X session. Apparently after testing just doing it three times was “good enough”</p>



<p>What this basically does is the following:</p>



<ul><li>Start an XFCE terminal hiding all of its UI</li><li>Start a 2 second timer and wait</li><li>At the same time start a <a href="https://www.qemu.org/">Qemu</a> virtual machine</li><li>Once the 2 second time is up search for the Qemu window and try to resize it to fill the screen. Do this three times in case one of them fails?</li><li>Once Qemu exits shutdown the computer</li></ul>



<h2>More questions than answers</h2>



<p>At this point it is worth mentioning that the FreeDOS/HP Documentation menu is running inside the Qemu VM. The “real” bootloader (grub) does not have its menus enabled and just always boots straight into the Debian 9 installation on the hard drives.</p>



<p>What is this “HP Documentation” thing then. Did they package a DOS PDF reader? Well, only one way to find out. We have to go ONE LEVEL DEEPER (into <code>/home/aos/qemu/freedos.img</code>)</p>



<pre><code># fdisk -l freedos.img 
Disk freedos.img: 2 GiB, 2150400000 bytes, 4200000 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x00000000

Device       Boot   Start     End Sectors  Size Id Type
freedos.img1         2048 2007039 2004992  979M  b W95 FAT32
freedos.img2 *    2007040 4192255 2185216    1G  b W95 FAT32</code></pre>



<p>So it seems we have two partitions… Wait is there a <code>C:</code> and a <code>D:</code> drive in here?</p>



<p>Remember how I said there’s three operating systems on this machine? I lied: There’s four. The freedos.img file actually contains TWO separate FreeDOS installations however both are the exact same version.</p>



<h2>Imageception: What is in freedos.img</h2>



<p>After extracting the contents of the two FAT32 partitions I found the following:</p>



<ul><li>The image contains an installation of <a href="https://wiki.syslinux.org/wiki/index.php?title=The_Syslinux_Project">syslinux</a> </li><li>Boot option one is a chain boot into FreeDOS on the first partition</li><li>Boot option two boots another Linux from the second partition </li></ul>



<pre><code>label dos
        menu label ^FreeDOS
        menu default
        com32 chain.c32
        append hd0 1

label live
        menu label ^HP Documents
        kernel /live/vmlinuz
        append initrd=/live/initrd.img boot=live config homepage=file:///hpdocs/platform_guides/languages/index.html nonetworking nopersistent quickreboot nomodeset radeon.modeset=0 nouveau.modeset=0 i915.modeset=0 username=webc video=vesa apm=off novtswitch pnpbios=off acpi=off nomce loglevel=3 libata.force=noncq quiet splash noroot novtswitch</code></pre>



<p>This Linux appears to live in /live and it has a <a href="https://en.wikipedia.org/wiki/SquashFS">squashfs</a> root filesystem. So… let’s have a poke at that too. This file is located on partition two in <code>/live/filesystem.squashfs</code> no points for originality there.</p>



<p>Most of the files in this filesystem seem to date back several decades so no convenient <code>/etc/os-release</code> file for us there. But we DO get an <code>/etc/debian_version</code>, there is no <code>ubuntu_version</code> so it appears that this is in fact Debian based.</p>



<pre><code># cat debian_version 
6.0.3</code></pre>



<p>It appears we have a 32bit Debian 6.0.3 installation. Judging by the <a href="https://www.debian.org/News/2011/20111008">release notes</a> this release is from October 8th, 2011. </p>



<h2>Down, down, down we go</h2>



<p>It appears we have another image to dissect. This time the Debian 6.0.3 installation which shows us that helpful PDF telling us the PC is useless in its factory configuration. After looking through the various startup options the image appears to be doing the following:</p>



<ul><li>We boot Debian more-or-less like normal, disabling all hardware accelerated video outputs and switching to the VESA driver.</li><li>There’s an <code>/etc/rc.local</code> file which attempts to locate a partition labeled <code>HPDOCS</code> and mounts it on <code>/hpdocs</code>. If it can’t locate this it mounts whatever happens to be <code>/dev/sda1</code> on <code>/hpdocs</code></li><li>Start a service called “Webconverger”, this is apparently an old style “turn Debian into a web kiosk” project. (<a href="https://web.archive.org/web/20140211061727/http://www.webconverger.com/">Archive.org link</a>)</li></ul>



<p><a href="https://webconverger.org/blog/entry/Debian_Web_Kiosk/">Webconverger</a> does a couple more things</p>



<ul><li>Configures an X server</li><li>Sets <a href="https://en.wikipedia.org/wiki/Mozilla_software_rebranded_by_Debian#Iceweasel">iceweasel</a>‘s homepage to the value from the pxelinux configuration above</li><li>Set audio volume control to 100% (auch)</li><li>Sleep 10 seconds, then switch between virtual terminal 1 and 2</li></ul>



<h2>Summary</h2>



<p>When ordering a HP machine with FreeDOS what you are getting is the following:</p>



<ul><li>A Linux installation on the “bare metal” which boots a VM </li><li>This VM boots either an old version of FreeDOS or</li><li>An old version of Linux in a kiosk mode</li></ul>



<h2>Conclusions, such as they are</h2>



<p>It doesn’t seem likely that the FreeDOS image as provided is actually good for anything. I didn’t really expect it to be but I was kind of hoping to install Duke Nukem 3D on “bare hardware” on a factory OS.</p>



<p>Based on the dates and how this is put together I assume that the contents of <code>freedos.img</code> are what used to be shipped on the real hardware. When <a href="https://en.wikipedia.org/wiki/NVM_Express">NVME drives</a> and other modern hardware features became the norm I suspect that this just didn’t work any longer. Instead of updating the image a VM layer was put in and the old factory image simply got included in the new one. It’s not a terrible solution really.</p>



<p>Someone at HP really needs to learn about what Window managers are for on X11, however, they could have saved themselves a lot of headaches. If anyone wants to build a system like this <a href="mailto:hp@prehensile-tales.com">send me an email</a>, I’m sure we can work something out 🙂</p>



<p>To round out this review below you will find some videos of the various boot options that shipped with the PC.</p>



<figure><video controls="" src="https://blog.tmm.cx/wp-content/uploads/2022/05/HPDOS_1.mp4"></video><figcaption>Booting the original image into DOS</figcaption></figure>



<figure><video controls="" src="https://blog.tmm.cx/wp-content/uploads/2022/05/HPDOS_2.mp4"></video><figcaption>Booting the original image into the Documentation page</figcaption></figure>




	</div><!-- .entry-content -->
	<!-- .entry-footer -->
</article></div>
  </body>
</html>
