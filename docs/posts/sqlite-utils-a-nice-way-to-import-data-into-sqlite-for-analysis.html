<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jvns.ca/blog/2022/05/12/sqlite-utils--a-nice-way-to-import-data-into-sqlite/">Original</a>
    <h1>sqlite-utils: a nice way to import data into SQLite for analysis</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>Hello! This is a quick post about a nice tool I found recently called <a href="https://sqlite-utils.datasette.io">sqlite-utils</a>, from the <a href="https://jvns.ca/#cool-computer-tools---features---ideas">tools category</a>.</p>
<p>Recently I wanted to do some basic data analysis using data from my Shopify
store. So I figured I’d query the Shopify API and import my data into SQLite,
and then I could make queries to get the graphs I want.</p>
<p>But this seemed like a lot of boring work, like I’d have to write a
schema and write a Python program. So I hunted around for a solution, and I
found <code>sqlite-utils</code>, a tool designed to make it easy to import arbitrary data
into SQLite to do data analysis on the data.</p>
<h3 id="sqlite-utils-automatically-generates-a-schema">sqlite-utils automatically generates a schema</h3>
<p>The Shopify data has about a billion fields and I really did not want to type
out a schema for it. <code>sqlite-utils</code> solves this problem: if I have an array of
JSON orders, I can create a new SQLite table with that data in it like this:</p>
<pre><code>import sqlite_utils

orders = ... # (some code to get the `orders` array here)

db = sqlite_utils.Database(&#39;orders.db&#39;)
db[&#39;shopify_orders&#39;].insert_all(orders)
</code></pre>
<h3 id="you-can-alter-the-schema-if-there-are-new-fields-with-alter">you can alter the schema if there are new fields (with <code>alter</code>)</h3>
<p>Next, I ran into a problem where on the 5th page of downloads, the JSON
contained a new field that I hadn’t seen before.</p>
<p>Luckily, <code>sqlite-utils</code> thought of that: there’s an <code>alter</code> flag which will
update the table’s schema to include the new fields. ```</p>
<p>Here’s what the code for that looks like</p>
<pre><code>db[&#39;shopify_orders&#39;].insert_all(orders, alter=True)
</code></pre>
<h3 id="you-can-deduplicate-existing-rows-with-upsert">you can deduplicate existing rows (with <code>upsert</code>)</h3>
<p>Next I ran into a problem where sometimes when doing a sync, I’d download data
from the API where some of it was new and some wasn’t.</p>
<p>So I wanted to do an “upsert” where it only created new rows if the item didn’t
already exist. <code>sqlite-utils</code> also thought of this, and there’s an <code>upsert</code>
method.</p>
<p>For this to work you have to specify the primary key. For me that was
<code>pk=&#34;id&#34;</code>. Here’s what my final code looks like:</p>
<pre><code>db[&#39;shopify_orders&#39;].upsert_all(
    orders,
    pk=&#34;id&#34;,
    alter=True
)
</code></pre>
<h3 id="there-s-also-a-command-line-tool">there’s also a command line tool</h3>
<p>I’ve talked about using <code>sqlite-utils</code> as a library so far, but there’s also a
command line tool which is really useful.</p>
<p>For example, this inserts the data from a <code>plants.csv</code> into a <code>plants</code> table:</p>
<pre><code>sqlite-utils insert plants.db plants plants.csv --csv
</code></pre>
<h3 id="format-conversions">format conversions</h3>
<p>I haven’t tried this yet, but here’s a cool example from the help docs of how
you can do format conversions, like converting a string to a float:</p>
<pre><code>sqlite-utils insert plants.db plants plants.csv --csv --convert &#39;
return {
  &#34;name&#34;: row[&#34;name&#34;].upper(),
  &#34;latitude&#34;: float(row[&#34;latitude&#34;]),
  &#34;longitude&#34;: float(row[&#34;longitude&#34;]),
}&#39;
</code></pre>
<p>This seems really useful for CSVs, where by default it’ll often interpret numeric
data as strings if you don’t do this conversions.</p>
<h3 id="metabase-seems-nice-too">metabase seems nice too</h3>
<p>Once I had all the data in SQLite, I needed a way to draw graphs with it. I
wanted some dashboards, so I ended up using <a href="https://www.metabase.com/">Metabase</a>, an open source business
intelligence tool. I found it very straightforward and it seems like a really
easy way to turn SQL queries into graphs.</p>
<p>This whole setup (sqlite-utils + metabase + SQL) feels a lot easier to use than
my previous setup, where I had a custom Flask website that used plotly and
pandas to draw graphs.</p>
<h3 id="that-s-all">that’s all!</h3>
<p>I was really delighted by <code>sqlite-utils</code>, it was super easy to use and it did
everything I wanted.</p>
</div></div>
  </body>
</html>
