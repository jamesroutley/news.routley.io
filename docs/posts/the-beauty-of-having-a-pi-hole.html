<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://den.dev/blog/pihole/">Original</a>
    <h1>The Beauty of Having a Pi-Hole</h1>
    
    <div id="readability-page-1" class="page"><article>
    <header>
      
        <ol>
  
  
    
  
    
  
  <li>
    <a href="https://den.dev/">Hi, I&#39;m Den üëã</a><span>/</span>
  </li>

  
  <li>
    <a href="https://den.dev/blog/">Writing</a><span>/</span>
  </li>

  
  <li>
    <a href="https://den.dev/blog/pihole/">The Beauty Of Having A Pi-hole</a><span>/</span>
  </li>

</ol>


      
      
      <div>
        





  
  



  

  
  
    
  

  

  
    
  

  

  

  <p><time datetime="2024-08-02 00:00:00 +0000 UTC">August 2, 2024</time><span>¬∑</span><span>1592 words</span>
    

    
    
  </p>

  
  
    
  


      </div>
      
    </header>
    <section>
      
        
      
      <div>
        <p>So, check this little idea that I have - I want to browse the internet without all sorts of unscrupulous actors collecting every little bit of metadata on me and my family they can possibly get their hands on. Radical, I know. Who would‚Äôve thought that I don‚Äôt wont every single website I visit syphon metadata about my computer, my browser, and other signals that can help them build a profile without my consent.</p>
<p>Unfortunately, the experience of browsing the web or using software in 2024 boils down to fielding a barrage of ads, malicious scripts, analytics widgets, chatbot widgets, massive ‚Äútake over your page‚Äù banners asking you to consent to cookies, software that won‚Äôt shut up and just phones home with every click, and other things that you probably didn‚Äôt want to have to deal with. Not that any of these things didn‚Äôt exist in some capacity in 2004 (or even 1994), but the sheer amount of privacy-abusing techniques was much smaller.</p>
<p>The whole concept of ‚Äúad tech‚Äù became ‚Äúfigure out how to abuse the living hell out of every visitor‚Äù which is, let‚Äôs say, suboptimal. I even alluded to it <a href="https://den.dev/blog/user-hostile-software/" target="_blank" rel="noreferrer noopener">in some of my previous writing</a>.</p>
<p>Which brings me to my main point - <strong>you should absolutely use a <a href="https://pi-hole.net/" target="_blank" rel="noreferrer noopener">Pi-hole</a> in your home network</strong>. It‚Äôs not exactly news that this project exists - folks like <a href="https://blog.codinghorror.com/an-exercise-program-for-the-fat-web/" target="_blank" rel="noreferrer noopener">Jeff Atwood</a>, <a href="https://www.troyhunt.com/mmm-pi-hole/" target="_blank" rel="noreferrer noopener">Troy Hunt</a>, <a href="https://www.hanselman.com/blog/blocking-ads-before-they-enter-your-house-at-the-dns-level-with-pihole-and-a-cheap-raspberry-pi" target="_blank" rel="noreferrer noopener">Scott Hanselman</a>, and <a href="https://scotthelme.co.uk/tag/pi-hole/" target="_blank" rel="noreferrer noopener">Scott Helme</a> talked about it <em>for years</em>. I am just adding another datapoint to the camp of ‚ÄúGet this on your network ASAP.‚Äù</p>
<p>If you‚Äôve never heard about it, Pi-hole is software that runs on a Raspberry Pi (can technically run even outside a Pi) that acts as the Domain Name Service (DNS) proxy <em>within your own network</em>. That is, if you go to <code>https://example.com</code>, it first hits the Pi-hole before going out and asking authoritative DNS servers for domain information. Its main purpose is blocking requests to domains that you don‚Äôt want to hit from your network. Those can be trackers, ad-serving content delivery networks (CDNs), or just any domain that you deem not worthy of receiving data from within your house or place of business.</p>
<p>To give you an idea of how much <em>completely unnecessary</em> network traffic there is, on my own network a whopping <strong>66.6% of all traffic is blocked</strong> with no functional impact on anything that I do. This tells you just how much various devices, sites, and apps like to either phone home or load things that I do not want.</p>





<figure>
  
  <img alt="Screenshot of the Pi-hole dashboard in a web browser." src="https://assets.den.dev/images/postmedia/pihole/pi-hole-stats.png"/>
  
  <figcaption>Screenshot of the Pi-hole dashboard in a web browser.</figcaption>
</figure>
<h2 id="the-kit">The kit <span><a href="#the-kit" aria-label="Anchor">#</a></span></h2>
<p>Setting Pi-hole up doesn‚Äôt take a significant investment. This is a list of recommendations, but of course you can fly solo and come up with your own configuration that suits your needs better. On the surface, you will need:</p>
<ul>
<li>A <a href="https://www.raspberrypi.com/" target="_blank" rel="noreferrer noopener">Raspberry Pi</a>. If you‚Äôre in the US, you can get a <a href="https://www.canakit.com/raspberry-pi-5-8gb.html?cid=USD" target="_blank" rel="noreferrer noopener">CanaKit</a> starter kit for roughly $155, which also includes a microSD card you will need for the setup.</li>
<li>A monitor, mouse, and keyboard that you can plug into the Raspberry Pi as you set it up.</li>
<li>Minimal time to <a href="https://docs.pi-hole.net/main/basic-install/" target="_blank" rel="noreferrer noopener">follow instructions on Pi-hole setup</a>.</li>
<li>Some time to make sure that you set up your network to route DNS requests through the Pi-hole.</li>
</ul>
<p>And that‚Äôs about it. Frankly, the biggest investment here is time - getting everything set up and validated. Worry not, though - the Pi-hole team have done a marvelous job in making sure that the installation process is as simple as possible.</p>
<h2 id="domain-lists">Domain lists <span><a href="#domain-lists" aria-label="Anchor">#</a></span></h2>
<p>Once you set up the Pi-hole hardware and software, as well as configure your router to point to the Pi-hole device as the target for DNS requests, you will also need to configure <em>which domains to block</em>. You can do that yourself, for example by seeing what flows through your network and then deciding whether you want it or not, or you can use <em>community blocklists</em>. I highly recommend looking at <a href="https://firebog.net/" target="_blank" rel="noreferrer noopener">Firebog</a> as the starting point for your explorations as the community has done extensive research and collected a myriad of domains that you likely haven‚Äôt heard about.</p>
<div>
  <p><img src="https://assets.den.dev/images/shared/sweaty.gif" alt="Mole out of the ground, sweating."/>
  </p>
  <p>Oooofff... There are quite a few lists there. Do I need to use every single one when I configure my own Pi-hole instance?</p>
</div>
<p>Absolutely not, but it‚Äôs a great reference point. What I found is that as you start setting things up you will notice that certain things will break or not work. Conveniently, you can look at the <em>live query log</em> that I mentioned earlier, that will tell you what clients are trying to access specific domains. You can use that view to dynamically block or unblock domains as you see fit.</p>





<figure>
  
  <img alt="Screenshot of the Pi-hole query log in a web browser." src="https://assets.den.dev/images/postmedia/pihole/query-log.png"/>
  
  <figcaption>Screenshot of the Pi-hole query log in a web browser.</figcaption>
</figure>
<p>Not only that, but you can also set up rules to block domains that fit a certain criteria via regular expressions. For example, and because I see a lot of malicious traffic sourced from Russia, China, and Hong Kong, I can easily block those TLDs:</p>
<p>Now, anything that tries to talk to any server with those TLDs will not escape your network if the requests are routed through the Pi-hole. Now, of course, a country TLD is not necessarily the only attack vector for malware, but blocking them is another small step in terms of improving the overall network security posture.</p>
<h2 id="preventing-devices-bypassing-dns-settings">Preventing devices bypassing DNS settings <span><a href="#preventing-devices-bypassing-dns-settings" aria-label="Anchor">#</a></span></h2>
<p>As you set things up and configure the network-wide DNS provider to be your Pi-hole, you might also not realize that quite a few devices <em>bypass your DNS settings</em> to make sure that they can still serve you ads or collect analytics. To solve this you need to use a trick that is dependent on <em>what hardware you‚Äôre using for your router</em>. In my case, because I am within the UniFi ecosystem and using a UDM Pro, I can run the following set of commands when I SSH into the UDM itself:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>iptables -t nat -A PREROUTING ! -s YOUR_PI_HOLE_IP -p tcp --dport <span>53</span> -j DNAT --to YOUR_PI_HOLE_IP
</span></span><span><span>iptables -t nat -A PREROUTING ! -s YOUR_PI_HOLE_IP -p udp --dport <span>53</span> -j DNAT --to YOUR_PI_HOLE_IP
</span></span><span><span>
</span></span><span><span><span># Make sure that we skip 192.168.1.1 since that seems to break UniFi Protect</span>
</span></span><span><span>iptables -t nat -A POSTROUTING -m iprange --src-range 192.168.1.2-192.168.254.254 -j MASQUERADE
</span></span></code></pre></div><p>The Bash script above configures the <code>iptables</code> rules to redirect <em>all</em> DNS traffic (port 53) to my Pi-hole and applies Network Address Translation (NAT) rules to allow for network address masquerading, which is a technique that allows to abstract away the internal network from the public internet by replacing the source IP address with the address of the gateway (your router).</p>
<p>Let‚Äôs dissect these commands a bit more in-depth:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>iptables -t nat -A PREROUTING ! -s YOUR_PI_HOLE_IP -p tcp --dport <span>53</span> -j DNAT --to YOUR_PI_HOLE_IP
</span></span></code></pre></div><p>Here is what each argument does:</p>
<table>
<thead>
<tr>
<th>Argument</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-t nat</code></td>
<td>Specifies that the rule is for the NAT table.</td>
</tr>
<tr>
<td><code>-A PREROUTING</code></td>
<td>Adds a rule to the <code>PREROUTING</code> chain, which processes inbound packets <em>before</em> routing.</td>
</tr>
<tr>
<td><code>! -s YOUR_PIHOLE_IP</code></td>
<td>Excludes packets that are originating from the Pi-hole itself.</td>
</tr>
<tr>
<td><code>-p tcp</code></td>
<td>Specifies that the rule applies to TCP packets.</td>
</tr>
<tr>
<td><code>--dport 53</code></td>
<td>Matches packets destined for port 53 (DNS).</td>
</tr>
<tr>
<td><code>-j DNAT</code></td>
<td>Jumps to the destination NAT (DNAT) target, modifying the destination IP address.</td>
</tr>
<tr>
<td><code>--to YOUR_PIHOLE_IP</code></td>
<td>Finally, redirects the packets to the Pi-hole IP address.</td>
</tr>
</tbody>
</table>
<p>The second line does the <em>exact same thing</em> but for UDP packets:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>iptables -t nat -A PREROUTING ! -s YOUR_PI_HOLE_IP -p udp --dport <span>53</span> -j DNAT --to YOUR_PI_HOLE_IP
</span></span></code></pre></div><p>For the third command, we do the following:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>iptables -t nat -A POSTROUTING -m iprange --src-range 192.168.1.2-192.168.254.254 -j MASQUERADE
</span></span></code></pre></div><p>The arguments are somewhat similar to what we saw above, but let‚Äôs break them down too:</p>
<table>
<thead>
<tr>
<th>Argument</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-t nat</code></td>
<td>Specifies that the rule is for the NAT table.</td>
</tr>
<tr>
<td><code>-A POSTROUTING</code></td>
<td>Adds a rule to the <code>POSTROUTING</code> chain, which processes inbound packets <em>after</em> routing.</td>
</tr>
<tr>
<td><code>-m iprange --src-range 192.168.1.2-192.168.254.254</code></td>
<td>Matches packets with source IP addresses in the range 192.168.1.2 to 192.168.254.254. You can adjust the ranges fro your own network.</td>
</tr>
<tr>
<td><code>-j MASQUERADE</code></td>
<td>Jumps to the <code>MASQUERADE</code> target, which replaces the source IP address with the router‚Äôs IP address for outgoing packets.</td>
</tr>
</tbody>
</table>
<p>Long story longer - the script ensures that all DNS requests (both TCP and UDP) from devices on the network are redirected to the Pi-hole, except for requests originating from the Pi-hole itself.</p>
<p>The <code>MASQUERADE</code> rule ensures that the source IP addresses in the specified range are masked with the router‚Äôs IP address, ensuring proper routing and response handling. In my special case, the IP range excludes 192.168.1.1 to avoid breaking UniFi Protect.</p>

<p>Despite having Pi-hole sitting between all the devices on my network and the rest of the internet, there is still a lot of value in having a <em>trusted</em> ad-blocker like <a href="https://ublockorigin.com/" target="_blank" rel="noreferrer noopener">uBlock Origin</a>. That‚Äôs mainly because you will still run into domains that you can‚Äôt block (e.g., for YouTube) but still want to use the service ad-free (e.g., again - YouTube). I treat the Pi-hole as <em>another layer</em> in blocking unwanted content and requests in addition to an ad-blocker in the browser, which can also helpfully block specific UI elements, such as passive ads or sponsored content that loads from the primary website domain.</p>
<h2 id="conclusion">Conclusion <span><a href="#conclusion" aria-label="Anchor">#</a></span></h2>
<p>Once I set up the Pi-hole on my network, there is no going back. I did the same thing for my parents and in-laws, and will continue advocating it to everyone that wants to hear about it. It makes <em>that big</em> of a difference in the online quality of life.</p>

      </div>
    </section>
    
  </article></div>
  </body>
</html>
