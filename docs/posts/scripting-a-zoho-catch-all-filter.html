<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://miccah.io/posts/scripting-a-zoho-catch-all-filter.html">Original</a>
    <h1>Scripting a Zoho catch-all filter</h1>
    
    <div id="readability-page-1" class="page"><div aria-label="Content">
      <div>
        <article itemscope="" itemtype="http://schema.org/BlogPosting">

  

  <div itemprop="articleBody">
    <p>I use <a href="https://www.zoho.com/mail/">Zoho</a> as my email provider, and I recently
learned that <a href="https://www.zoho.com/mail/help/adminconsole/catch-all-setup.html">you can setup a catch-all forwarding address</a>. This is pretty great,
because that means I can receive any email sent to my domain! Go ahead, <a href="mailto:lol@miccah.io">try it</a>.</p>

<p>I want to sort the emails I receive into their own folder, though, depending on
the delivery address (for example, <code>lol@miccah.io</code> will go to
<code>/catch-all/lol</code>). It turns out, Zoho supports custom mail filters using a
scripting DSL called <a href="https://www.zoho.com/deluge/">deluge</a>, so I wrote one!</p>

<p>At a high level, the filter parses the <code>To</code> address of the email, creates the
folder if it does not exist, then moves the email into that folder. In order to
work properly, I needed to create a “connection” with the properly scoped
permissions: <code>ZohoMail.messages.READ</code>, <code>ZohoMail.messages.UPDATE</code>, and
<code>ZohoMail.folders.ALL</code>. This will be clear if you’re going through the process
yourself, otherwise don’t worry about it.</p>

<p>Here’s the script in all it’s glory. I had fun hacking on this and was
pleasantly surprised that it was a feature available to me!</p>

<div><div><pre><code><span>info</span> <span>&#34;</span><span>Use the &#39;To&#39; address to create a subfolder in catch-all and move the message there</span><span>&#34;</span><span>;</span>
<span>conn</span> <span>=</span> <span>&#34;</span><span>catchallfilter</span><span>&#34;</span><span>;</span>
<span>messageID</span> <span>=</span> <span>mail_messageId</span><span>;</span>
<span>messageDetails</span> <span>=</span> <span>zoho</span><span>.</span><span>mail</span><span>.</span><span>getMessage</span><span>(</span><span>messageID</span><span>,</span> <span>conn</span><span>);</span>

<span>// Parse address for the folder name.</span>
<span>// toAddress is of the form &#34;&amp;lt;ADDR@domain.com&amp;gt;&#34;</span>
<span>toAddress</span> <span>=</span> <span>messageDetails</span><span>.</span><span>get</span><span>(</span><span>&#34;</span><span>TO</span><span>&#34;</span><span>);</span>
<span>newName</span> <span>=</span> <span>toAddress</span><span>.</span><span>subString</span><span>(</span><span>4</span><span>,</span> <span>toAddress</span><span>.</span><span>indexOf</span><span>(</span><span>&#34;</span><span>@</span><span>&#34;</span><span>));</span>
<span>info</span> <span>&#34;</span><span>routing to </span><span>&#34;</span> <span>+</span> <span>newName</span><span>;</span>

<span>// Search top-level folders for &#34;catch-all&#34;, then search its children for</span>
<span>// newName. If it&#39;s not found, create it.</span>
<span>for</span> <span>each</span> <span>folder</span> <span>in</span> <span>zoho</span><span>.</span><span>mail</span><span>.</span><span>getFolders</span><span>(</span><span>conn</span><span>)</span> <span>{</span>
	<span>folderName</span> <span>=</span> <span>folder</span><span>.</span><span>get</span><span>(</span><span>&#34;</span><span>NAME</span><span>&#34;</span><span>);</span>
	<span>if </span><span>(</span><span>folderName</span> <span>!=</span> <span>&#34;</span><span>catch-all</span><span>&#34;</span><span>)</span> <span>{</span>
		<span>continue</span><span>;</span>
	<span>}</span>
	<span>catchallSubFolders</span> <span>=</span> <span>folder</span><span>.</span><span>get</span><span>(</span><span>&#34;</span><span>CHILDREN</span><span>&#34;</span><span>);</span>
	<span>subFolderExists</span> <span>=</span> <span>false</span><span>;</span>
	<span>for</span> <span>each</span> <span>subFolder</span> <span>in</span> <span>catchallSubFolders</span> <span>{</span>
		<span>if </span><span>(</span><span>subFolder</span><span>.</span><span>get</span><span>(</span><span>&#34;</span><span>NAME</span><span>&#34;</span><span>)</span> <span>!=</span> <span>newName</span><span>)</span> <span>{</span>
			<span>continue</span><span>;</span>
		<span>}</span>
		<span>subFolderExists</span> <span>=</span> <span>true</span><span>;</span>
		<span>info</span> <span>&#34;</span><span>subfolder exists</span><span>&#34;</span><span>;</span>
		<span>break</span><span>;</span>
	<span>}</span>
	<span>if </span><span>(</span><span>!</span><span>subFolderExists</span><span>)</span> <span>{</span>
		<span>info</span> <span>&#34;</span><span>creating subfolder</span><span>&#34;</span><span>;</span>
		<span>zoho</span><span>.</span><span>mail</span><span>.</span><span>createFolder</span><span>(</span><span>newName</span><span>,</span> <span>folder</span><span>.</span><span>get</span><span>(</span><span>&#34;</span><span>ID</span><span>&#34;</span><span>),</span> <span>conn</span><span>);</span>
	<span>}</span>
	<span>break</span><span>;</span>
<span>}</span>
<span>info</span> <span>&#34;</span><span>moving to subfolder</span><span>&#34;</span><span>;</span>
<span>zoho</span><span>.</span><span>mail</span><span>.</span><span>moveToFolder</span><span>(</span><span>messageID</span><span>,</span> <span>&#34;</span><span>/catch-all/</span><span>&#34;</span> <span>+</span> <span>newName</span><span>,</span> <span>conn</span><span>);</span>
</code></pre></div></div>

  </div>
</article>

      </div>
    </div></div>
  </body>
</html>
