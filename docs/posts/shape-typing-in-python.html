<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jameshfisher.com/2024/04/12/shape-typing-in-python/">Original</a>
    <h1>Shape Typing in Python</h1>
    
    <div id="readability-page-1" class="page"><div id="content"><p>While I was looking the other way,
Python got advanced static types!
Here’s matrix multiplication,
describing the input shapes and its output shape:</p>
<pre><code><span>def</span> mat_mul<span>[</span>
    N<span>,</span> K<span>,</span> M
<span>]</span><span>(</span>
  m1<span>:</span> Mat<span>[</span>N<span>,</span> M<span>]</span><span>,</span>
  m2<span>:</span> Mat<span>[</span>M<span>,</span> K<span>]</span><span>,</span>
<span>)</span> <span>-</span><span>&gt;</span> Mat<span>[</span>N<span>,</span> K<span>]</span><span>:</span>
    <span>return</span> m1 @ m2</code></pre>
<p>There’s a lot going on here!
In traditional Python, we’d write:</p>
<pre><code><span>def</span> <span>mat_mul</span><span>(</span>m1<span>,</span> m2<span>)</span><span>:</span>
    <span>return</span> m1 @ m2</code></pre>
<p>Then if we used the wrong shapes,
we’d get a runtime error,
like this:</p>
<pre><code>&gt;&gt;&gt; m1 @ m2
Traceback (most recent call last):
  File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt;
ValueError: matmul: Input operand 1 has a mismatch
  in its core dimension 0, with gufunc signature
  (n?,k),(k,m?)-&gt;(n?,m?) (size 2 is different from 3)</code></pre>
<p>Our type-safe wrapper <code>mat_mul</code> uses a type <code>Mat[N, M]</code>,
which I defined as:</p>
<pre><code><span>type</span> Mat<span>[</span>N<span>,</span> M<span>]</span> <span>=</span> np<span>.</span>ndarray<span>[</span>
    <span>tuple</span><span>[</span>N<span>,</span> M<span>]</span><span>,</span>
    np<span>.</span>dtype<span>[</span>np<span>.</span>float64<span>]</span><span>,</span>
<span>]</span></code></pre>
<p>If we try to multiply matrices of the wrong shape,
<a href="https://github.com/microsoft/pyright">Pyright</a> gives a type error.</p>
<p>This uses Numpy’s <code>np.ndarray</code> type,
which takes two arguments
that describe the shape and dtype.
For example, we can describe a 2x3 matrix of integers as:</p>
<pre><code>mat2x3<span>:</span> np<span>.</span>ndarray<span>[</span>
    <span>tuple</span><span>[</span>Literal<span>[</span><span>2</span><span>]</span><span>,</span> Literal<span>[</span><span>3</span><span>]</span><span>]</span><span>,</span>
    np<span>.</span>dtype<span>[</span>np<span>.</span>int64<span>]</span><span>,</span>
<span>]</span> <span>=</span> np<span>.</span>array<span>(</span><span>[</span><span>[</span><span>1</span><span>,</span><span>2</span><span>,</span><span>3</span><span>]</span><span>,</span><span>[</span><span>4</span><span>,</span><span>5</span><span>,</span><span>6</span><span>]</span><span>]</span><span>)</span></code></pre>
<p>At the moment, most of the numpy API does not use these type parameters.
For example, <code>np.array(...)</code> just gives you an <code>np.ndarray[Any, Any]</code>.
So we have to make our own type-safe wrappers.</p>
<div><h3>More by Jim</h3><div><a href="https://jameshfisher.com/2020/11/01/what-does-the-dot-do-in-javascript/"><p>What does the dot do in JavaScript? </p><p><code>foo.bar</code>, <code>foo.bar()</code>, or <code>foo.bar = baz</code> - what do they mean? A deep dive into prototypical inheritance and getters/setters.  <span>2020-11-01</span></p></a><a href="https://jameshfisher.com/2020/08/06/smear-phishing-how-to-scam-an-android-user/"><p>Smear phishing: a new Android vulnerability </p><p>Trick Android to display an SMS as coming from any contact. Convincing phishing vuln, but still unpatched.  <span>2020-08-06</span></p></a><a href="https://jameshfisher.com/2020/04/26/jim-scoring-a-probabilistic-pub-quiz-for-nerds/"><p>A probabilistic pub quiz for nerds </p><p>A “true or false” quiz where you respond with your confidence level, and the optimal strategy is to report your true belief.  <span>2020-04-26</span></p></a><a href="https://jameshfisher.com/2020/03/14/time-is-running-out-to-catch-covid19/"><p>Time is running out to catch COVID-19 </p><p>Simulation shows it’s rational to deliberately infect yourself with COVID-19 early on to get treatment, but after healthcare capacity is exceeded, it’s better to avoid infection. Includes interactive parameters and visualizations.  <span>2020-03-14</span></p></a><a href="https://jameshfisher.com/2019/04/27/the-inception-bar-a-new-phishing-method/"><p>The inception bar: a new phishing method </p><p>A new phishing technique that displays a fake URL bar in Chrome for mobile. A key innovation is the “scroll jail” that traps the user in a fake browser.  <span>2019-04-27</span></p></a><a href="https://jameshfisher.com/2019/03/23/the-hacker-hype-cycle/"><p>The hacker hype cycle </p><p>I got started with simple web development, but because enamored with increasingly esoteric programming concepts, leading to a “trough of hipster technologies” before returning to more productive work.  <span>2019-03-23</span></p></a><a href="https://jameshfisher.com/2019/02/16/project-c-43-the-lost-origins-of-asymmetric-crypto/"><p>Project C-43: the lost origins of asymmetric crypto </p><p>Bob invents asymmetric cryptography by playing loud white noise to obscure Alice’s message, which he can cancel out but an eavesdropper cannot. This idea, published in 1944 by Walter Koenig Jr., is the forgotten origin of asymmetric crypto.  <span>2019-02-16</span></p></a><a href="https://jameshfisher.com/2019/01/26/how-hacker-news-stays-interesting/"><p>How Hacker News stays interesting </p><p>Hacker News buried my post on conspiracy theories in my family due to overheated discussion, not censorship. Moderation keeps the site focused on interesting technical content.  <span>2019-01-26</span></p></a><a href="https://jameshfisher.com/2019/01/20/my-parents-are-flat-earthers/"><p>My parents are Flat-Earthers </p><p>For decades, my parents have been working up to Flat-Earther beliefs. From Egyptology to Jehovah’s Witnesses to theories that human built the Moon billions of years in the future. Surprisingly, it doesn’t affect their successful lives very much. For me, it’s a fun family pastime.  <span>2019-01-20</span></p></a><a href="https://jameshfisher.com/2018/04/07/the-dots-do-matter-how-to-scam-a-gmail-user/"><p>The dots do matter: how to scam a Gmail user </p><p>Gmail’s “dots don’t matter” feature lets scammers create an account on, say, Netflix, with your email address but different dots. Results in convincing phishing emails.  <span>2018-04-07</span></p></a><a href="https://jameshfisher.com/2017/12/02/the-sorry-state-of-openssl-usability/"><p>The sorry state of OpenSSL usability </p><p>OpenSSL’s inadequate documentation, confusing key formats, and deprecated interfaces make it difficult to use, despite its importance.  <span>2017-12-02</span></p></a><a href="https://jameshfisher.com/2017/11/08/i-hate-telephones/"><p>I hate telephones </p><p>I hate telephones. Some rational reasons: lack of authentication, no spam filtering, forced synchronous communication. But also just a visceral fear.  <span>2017-11-08</span></p></a><a href="https://jameshfisher.com/2017/10/26/time-thought-and-typing/"><p>The Three Ts of Time, Thought and Typing: measuring cost on the web </p><p>Businesses often tout “free” services, but the real costs come in terms of time, thought, and typing required from users. Reducing these “Three Ts” is key to improving sign-up flows and increasing conversions.  <span>2017-10-26</span></p></a><a href="https://jameshfisher.com/2017/05/19/granddad-died-today/"><p>Granddad died today </p><p>Granddad died. The unspoken practice of death-by-dehydration in the NHS. The Liverpool Care Pathway. Assisted dying in the UK. The importance of planning in end-of-life care.  <span>2017-05-19</span></p></a><a href="https://jameshfisher.com/2017/02/17/how-do-i-call-a-program-in-c-with-pipes/"><p>How do I call a program in C, setting up standard pipes? </p><p>A C function to create a new process, set up its standard input/output/error pipes, and return a struct containing the process ID and pipe file descriptors.  <span>2017-02-17</span></p></a><a href="https://jameshfisher.com/2014/05/11/your-syntax-highlighter-is-wrong/"><p>Your syntax highlighter is wrong </p><p>Syntax highlighters make value judgments about code. Most highlighters judge that comments are cruft, and try to hide them. Most diff viewers judge that code deletions are bad.  <span>2014-05-11</span></p></a></div></div><p> This page copyright James Fisher 2024. Content is not associated with my employer.<span> <a href="https://github.com/jameshfisher/jameshfisher.com/edit/master/_posts/2024-04-12-shape-typing-in-python/index.md">Found an error? Edit this page.</a></span></p></div></div>
  </body>
</html>
