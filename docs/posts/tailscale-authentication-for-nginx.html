<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tailscale.com/blog/tailscale-auth-nginx/">Original</a>
    <h1>Tailscale Authentication for Nginx</h1>
    
    <div id="readability-page-1" class="page"><div>
      <p>Previously on the Tailscale blog, I walked through how authentication works
with Tailscale <a href="https://tailscale.com/blog/grafana-auth/">for Grafana</a> and even
<a href="https://tailscale.com/blog/tailscale-auth-minecraft/">for Minecraft</a>. Today
we’re going to take that basic concept and show how to extend it to services
that you have proxied behind <a href="https://nginx.org">NGINX</a>.</p>
<p>The Grafana/Minecraft authentication proxy trick works because we set up a whole
new node on your tailnet to proxy traffic directly to Grafana or Minecraft. This
does work, but there’s a nonzero setup cost every time you add a new service to
the mix. If you have an existing NGINX configuration for all your internal
services, it may be easier to just use NGINX to proxy access to everything.</p>
<p>I have created
<a href="https://github.com/tailscale/tailscale/tree/main/cmd/nginx-auth"><code>nginx-auth</code></a>
to implement the <a href="https://docs.nginx.com/nginx/admin-guide/security-controls/configuring-subrequest-authentication/">NGINX HTTP subrequest authentication
protocol</a>.
You can use this to authenticate every request to your internal services and
then decorate requests to them with the right HTTP headers.</p>
<p>Like what you see here? Want to help us focus future efforts in making DevOps
tools easier to use with Tailscale? Fill out our survey
<a href="https://forms.gle/J37SELFSzXQJxAwB8">here</a>! Our future efforts will be
guided by this feedback.</p>

<h2 id="setup">Setup</h2>
<p>I have added <code>nginx-auth</code> to the Tailscale repositories for <code>x86_64</code> Linux
machines. To install it on an Ubuntu machine, run this command:</p>
<pre tabindex="0"><code>sudo apt-get update &amp;&amp; sudo apt-get install tailscale-nginx-auth
</code></pre><p>At the time of writing, this autoinstall strategy isn’t supported on
non-debian/ubuntu. You can work around this by going into a checkout of
<a href="https://github.com/tailscale/tailscale">tailscale/tailscale</a> and checking out
<code>cmd/nginx-auth</code>’s
<a href="https://github.com/tailscale/tailscale/tree/main/cmd/nginx-auth#building">documentation</a>
on how to build packages.</p>

<p>This will automatically download the <code>nginx-auth</code> tool and other metadata needed
to run it in <a href="https://systemd.io">systemd</a>.</p>
<p>Once it is installed, you need to activate it in systemd with the following
command:</p>
<pre tabindex="0"><code>sudo systemctl enable --now tailscale.nginx-auth.socket 
</code></pre><p>This uses <a href="https://mgdm.net/weblog/systemd-socket-activation/">systemd socket
activation</a> to automatically
start the service when it is needed. This lets systemd dynamically activate
<code>tailscale.nginx-auth.service</code> on-demand instead of having it always run. This
also automatically restarts the service if it crashes.</p>
<h3 id="nginx-configuration">NGINX configuration</h3>
<p>Once the <code>tailscale.nginx-auth</code> service is set up in your system, you need to
configure NGINX to use it. This works in the <code>server</code> block, meaning that you
can set up separate authentication logic for services listening over Tailscale
vs services listening to the internet.</p>
<p>Set up an internal route named <code>/auth</code> (you can change this path should you need
to):</p>
<div><pre tabindex="0"><code data-lang="nginx"><span><span><span>location</span> <span>/auth</span> <span>{</span>
</span></span><span><span>  <span>internal</span><span>;</span>
</span></span><span><span>
</span></span><span><span>  <span>proxy_pass</span> <span>http://unix:/run/tailscale.nginx-auth.sock</span><span>;</span>
</span></span><span><span>  <span>proxy_pass_request_body</span> <span>off</span><span>;</span>
</span></span><span><span>
</span></span><span><span>  <span>proxy_set_header</span> <span>Host</span> <span>$http_host</span><span>;</span>
</span></span><span><span>  <span>proxy_set_header</span> <span>Remote-Addr</span> <span>$remote_addr</span><span>;</span>
</span></span><span><span>  <span>proxy_set_header</span> <span>Remote-Port</span> <span>$remote_port</span><span>;</span>
</span></span><span><span>  <span>proxy_set_header</span> <span>Original-URI</span> <span>$request_uri</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>And then in your <code>location</code> block that reverse proxies to your service, add this
just before the <code>proxy_pass</code> instruction to use it:</p>
<div><pre tabindex="0"><code data-lang="nginx"><span><span><span>auth_request</span> <span>/auth</span><span>;</span>
</span></span><span><span><span>auth_request_set</span> <span>$auth_user</span> <span>$upstream_http_tailscale_user</span><span>;</span>
</span></span><span><span><span>auth_request_set</span> <span>$auth_name</span> <span>$upstream_http_tailscale_name</span><span>;</span>
</span></span><span><span><span>auth_request_set</span> <span>$auth_login</span> <span>$upstream_http_tailscale_login</span><span>;</span>
</span></span><span><span><span>auth_request_set</span> <span>$auth_tailnet</span> <span>$upstream_http_tailscale_tailnet</span><span>;</span>
</span></span><span><span><span>auth_request_set</span> <span>$auth_profile_picture</span> <span>$upstream_http_tailscale_profile_picture</span><span>;</span>
</span></span><span><span>
</span></span><span><span><span>proxy_set_header</span> <span>X-Webauth-User</span> <span>&#34;</span><span>$auth_user&#34;</span><span>;</span>
</span></span><span><span><span>proxy_set_header</span> <span>X-Webauth-Name</span> <span>&#34;</span><span>$auth_name&#34;</span><span>;</span>
</span></span><span><span><span>proxy_set_header</span> <span>X-Webauth-Login</span> <span>&#34;</span><span>$auth_login&#34;</span><span>;</span>
</span></span><span><span><span>proxy_set_header</span> <span>X-Webauth-Tailnet</span> <span>&#34;</span><span>$auth_tailnet&#34;</span><span>;</span>
</span></span><span><span><span>proxy_set_header</span> <span>X-Webauth-Profile-Picture</span> <span>&#34;</span><span>$auth_profile_picture&#34;</span><span>;</span>
</span></span></code></pre></div><p>From here you can configure your applications to use the contents of
<code>X-Webauth-User</code> or the other headers to use that for authentication logic. For
a full list of options that are exposed in these response headers, check the
<a href="https://github.com/tailscale/tailscale/tree/main/cmd/nginx-auth#headers">documentation
table</a>
which includes header names, example values and descriptions.</p>
<h2 id="security-benefits">Security benefits</h2>
<p>Overall the security benefits of doing this are similar to setting up a
corporate SSO system. By moving authentication into the Tailscale level, you
no longer need to handle authentication yourself. You don’t need to have internal
tools maintain their own account systems with their own passwords. People
connect to the server over Tailscale, and Tailscale already knows who they are.</p>
<p>This will give you a Single-Sign-On (SSO) experience without having the
installation and maintenance overhead of setting up a new OAuth2 client, nor
enduring the toil involved with getting administrative approval to try things
out.</p>
<p>This proxy listens over a UNIX socket instead of a network-facing TCP socket.
This makes it impossible to accidentally expose the proxy to the network. When
you have the ability to, you should have your services listen over UNIX sockets
like this. It allows you to use normal filesystem permissions to limit access to
services instead of having to configure firewall rules.</p>
<h2 id="get-in-touch">Get in touch</h2>
<p>Did you try this? How did you like it? Ping us on Twitter
<a href="https://twitter.com/Tailscale">@Tailscale</a> or let us know on <a href="https://forum.tailscale.com">the
forum</a>. If you want to check out the source code of
this authentication sidecar, check it out <a href="https://github.com/tailscale/tailscale/tree/main/cmd/nginx-auth">on
GitHub</a>.</p>
<p>Many thanks to <a href="https://twitter.com/zrail">@zrail</a> for pointing out this NGINX
feature. Their examples helped guide the development of this service.</p>
    </div></div>
  </body>
</html>
