<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://comsec.ethz.ch/research/microarch/branch-privilege-injection/">Original</a>
    <h1>Branch Privilege Injection: Exploiting branch predictor race conditions</h1>
    
    <div id="readability-page-1" class="page"><div id="content">
			<!-- If has sidebar start -->
	<main id="main">
		<div>
			<!-- If has sidebar end -->
							<article id="post-1737" class="page">
										<!-- .entry-header -->
					<div>
						
<p>Branch Privilege Injection (<a href="https://www.cve.org/CVERecord?id=CVE-2024-45332">CVE-2024-45332</a>) brings back the full might of branch target injection attacks (Spectre-BTI) on Intel. Intelâ€™s hardware mitigations against these types of attacks have held their ground for almost 6 years. In our work, we demonstrate how these mitigations can be broken due to a race condition in Intel CPUs.</p>



<p>Our Branch Privilege injection attack is made possible by the following two main insights:</p>



<ul>
<li>Branch predictors on Intel processors are updated asynchronously to the instruction stream. We are the first to unveil this behavior and we can show that updates are delayed by tens or hundreds of cycles under certain conditions. These asynchronous updates are a feature and not a vulnerability by themselves.</li>



<li>We find that there is insufficient synchronization between the branch predictor and the instruction stream during security critical operations. Branch predictor updates can still be in-flight when an affected processor switches privileges (e.g., user to kernel or guest to hypervisor) or performs an IBPB. Because these updates are still in-flight, they are associated with the wrong privilege mode once they land after the privilege switch. We call this new class of vulnerabilities Branch Predictor Race Conditions.</li>
</ul>



<p>We use the above insights to build an end-to-end Branch Privilege Injection attack that leaks arbitrary memory at 5.6KiB/s on an up-to-date Ubuntu 24.04 with all default mitigations enabled. The following video demonstrates how Branch Privilege Injection leaks arbitrary memory on an Intel Raptor Lake (13th gen) processor.</p>



<figure><p>
<iframe title="Branch Privilege Injection leaking /etc/shadow from kernel memory" width="780" height="439" src="https://www.youtube.com/embed/jrsOvaN7PaA?feature=oembed" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>
</p></figure>



<hr/>



<h2>Affected Mitigations</h2>



<p><strong>eIBRS:</strong> Intel has introduced enhanced Indirect Branch Restricted Speculation (eIBRS) as a Spectre-BTI mitigation on all its processors since the 9th generation (Coffee Lake Refresh).</p>



<p><strong>IBPB:</strong> eIBRS only prevents cross-domain attacks between different hardware security domains.</p>



<p>Both of these mitigations are recommended as the default mitigation strategy for their respective use-cases.</p>



<h2>Branch Predictor Race Conditions</h2>



<p>Our work demonstrates race conditions in the branch predictor which invalidate the security guarantees of eIBRS and IBPB. While eIBRS appears to correctly restrict predictions to the security domain they are associated with, this association can be manipulated. Branch predictor updates that are in-flight while a privilege switch occurs are associated with the new security domain instead of the previous one.</p>



<h2>Mitigations against Branch Predictor Race Conditions</h2>



<p>Intel has developed a microcode update for affected processors and provided us with one to evaluate on Alder Lake. We were able to verify that the microcode update stops our primitives that we use in the paper to detect the vulnerabilities. Our performance evaluation shows up to 2.7% overhead for the microcode mitigation on Alder Lake. We have also evaluated several potential alternative mitigation strategies in software with overheads between 1.6% (Coffee Lake Refresh) and 8.3% (Rocket lake). Please refer to our <a href="https://comsec.ethz.ch/wp-content/files/bprc_sec25.pdf">paper</a> for more details.</p>



<h2>Resources</h2>



<p>A <a href="https://comsec.ethz.ch/wp-content/files/bprc_sec25.pdf">paper</a> about Branch Privilege Injection will be presented at <a href="https://www.usenix.org/conference/usenixsecurity25">USENIX Security 2025</a>. There will also be a talk at <a href="https://www.blackhat.com/us-25/briefings/schedule/#-for-privilege-leaking-privileged-memory-from--using-under-embargo-45260">Black Hat USA 2025</a> with a focus on vulnerability discovery and exploitation. You can find the source code for the attack and all our experiments on <a href="https://github.com/comsec-group/bprc">github</a>.</p>



<h2>FAQ</h2>



<ul>
<li><strong><strong>Is my machine affected?</strong></strong></li>



<li><strong>Does Branch Privilege Injection affect non-Intel CPUs?</strong></li>



<li><strong>Are only Linux systems affected?</strong></li>



<li><strong>What should I do?</strong></li>
</ul>
					</div><!-- .entry-content -->
				</article><!-- #post -->
							<!-- If has sidebar start -->
		</div>
				<!-- If has sidebar end -->
		</main><!-- .site-main -->
	</div></div>
  </body>
</html>
