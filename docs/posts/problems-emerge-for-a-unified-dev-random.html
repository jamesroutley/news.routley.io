<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/SubscriberLink/889452/953e190af78809a7/">Original</a>
    <h1>Problems emerge for a unified /dev/*random</h1>
    
    <div id="readability-page-1" class="page"><div>
<!-- $Id: slink-none,v 1.2 2005-11-04 22:11:18 corbet Exp $ -->
<blockquote>
<div>
<h3>Welcome to LWN.net</h3>
<p>
The following subscription-only content has been made available to you 
by an LWN subscriber.  Thousands of subscribers depend on LWN for the 
best news from the Linux and free software communities.  If you enjoy this 
article, please consider <a href="https://lwn.net/subscribe/">subscribing to LWN</a>.  Thank you
for visiting LWN.net!
</p></div>
</blockquote>

<p>
In mid-February, we <a href="https://lwn.net/Articles/884875/">reported</a> on the plan to
unite the two kernel devices that provide random numbers;
<tt>/dev/urandom</tt> was to effectively just be another way to access the
random numbers provided by <tt>/dev/random</tt>.   That change made it as
far as the mainline during the Linux 5.18 merge window, but it was
quickly reverted when problems were found.  It may be possible to
do that unification someday, but, for now, there are environments that need
their random numbers early on—without entropy or the &#34;Linus jitter dance&#34;
being available on the platform.
</p>

<p>
A bunch of changes for the kernel random-number
generator (RNG) were <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=5628b8de1228">merged</a>
by Linus Torvalds on March 21.  Those changes included unifying the
two RNG devices, because it was hoped that no mainstream platforms would
lack a source of unpredictable data that would allow the RNG pool to
initialize in short order at boot time.  For several years now, the jitter
dance has used <a href="https://lwn.net/Articles/642166/">CPU execution time jitter</a> to
initialize the pool in less than a second; it uses the differences in
code-execution speed of repetitive operations due to unpredictability in
modern CPUs, from caches, branch prediction, and the like. 
But some systems lack jitter and have no other
source of unpredictable data.  That leads to the boot process hanging
waiting for the RNG pool to initialize. 
</p>

<h4>De-unification</h4>

<p>
Guenter Roeck <a href="https://lwn.net/ml/linux-kernel/20220322155820.GA1745955@roeck-us.net/">reported</a>
a problem the day after the code was merged.  He saw &#34;<span>a
large number of qemu boot test failures for various architectures (arm,
m68k, microblaze, sparc32, xtensa are the ones I observed). Common
denominator is that boot hangs at &#39;Saving random seed:&#39;</span>&#34;
He bisected the problem to
the <a href="https://git.kernel.org/pub/scm/linux/kernel/git/crng/random.git/commit/?id=6f98a4bfee72">patch</a>
that unified the RNG devices, and noted that reverting it fixes the
problems he found. 
As would be expected, a user-space regression of that sort led Torvalds to
<a href="https://lwn.net/ml/linux-kernel/CAHk-=wjH7rNyP_S7ut3EUPfa_dOYAP1T6yOxS6hdVi3zPV9SzA@mail.gmail.com/">say</a>
that he would revert the patch.  The idea was good, but it &#34;<span>causes problems for
various platforms that can&#39;t do jitter entropy and have nothing else
happening either</span>&#34;.  Jason A. Donenfeld, the author of the patch and
one of the kernel RNG maintainers, <a href="https://lwn.net/ml/linux-kernel/CAHmME9pTX8MK-cJC0zSMU0PBtyE3iTFQTCRoM8RG1zA+fCaTBw@mail.gmail.com/">agreed</a>
with that assessment.
Later that day, Torvalds <a href="https://git.kernel.org/pub/scm/linux/kernel/git/crng/random.git/commit/?id=0313bc278dac">reverted</a>
the unification; &#34;<span>This isn&#39;t hugely unexpected - we tried it, it failed, so now we&#39;ll
revert it.</span>&#34;
</p>

<p>
But Donenfeld was <a href="https://lwn.net/ml/linux-kernel/YjoC5kQMqyC%2F3L5Y@zx2c4.com/">interested in finding
out more</a> about the underlying problem and asked Roeck for information
about the QEMU virtual machines (VMs) used.  If the unified-RNG-devices idea
is ever going to return, &#34;<span>understanding everything about why
the previous time failed might be a good idea</span>&#34;, Donenfeld said.  He
poked around in one of the VM images and discovered the boot-time shell script that
was printing the message in question.  It was using a stored random seed to
initialize <tt>/dev/urandom</tt> by writing to it, then reading from the
device to grab a new seed to store for the next boot.
</p>

<p>
There are some problems with that approach, however.  The first is that
writing to <tt>/dev/urandom</tt> will only mix the data into the pool; it
does not credit any entropy, so the RNG subsystem still does not
initialize.  Because it does not initialize, and the changes merged (and
since reverted) make <tt>/dev/urandom</tt> block until it is initialized,
the boot process would hang when it tried to read the new seed.  That was a
clear user-space regression that is not going to be—was not—tolerated.
</p>

<p>
A more insidious problem, perhaps, is that a seed written to the RNG before
it initializes will not actually be used until <i>after</i> the pool is
initialized properly; &#34;<span>you might write in a perfectly good seed to
/dev/urandom, but what you read out for the subsequent seed may be
complete deterministic crap</span>&#34;, Donenfeld said.
The data that gets written to the device is not credited with any entropy
unless the <tt>RNDADDTOENTCNT</tt> <tt>ioctl()</tt> command is used, but
that also means the fast initialization pool is 
not updated with the seed data, so the random numbers returned from the
non-blocking <tt>/dev/urandom</tt> before it is initialized are much worse.
That behavior has been true for
quite some time, he said, but it makes the &#34;<span>innocuous
pattern</span>&#34; of writing a seed and reading a new one into a potentially
serious flaw; he thought he had a &#34;<span>quick unobtrusive
fix</span>&#34; for that.
</p>

<p>
Torvalds <a href="https://lwn.net/ml/linux-kernel/CAHk-=wiq3bKDdt7noWOaMnDL-yYfFHb1CEsNkk8huq4O7ByetA@mail.gmail.com/">said</a>
that he hates the &#34;<span>no entropy means that we can&#39;t use it</span>&#34; idea
that exists in the RNG; &#34;<span>It&#39;s a disease, I tell you.</span>&#34;  It is
the direct cause of that second problem, he said, continuing:
</p><blockquote>
By all means the code can say &#34;I can&#39;t credit this as entropy&#34;, but
the fact that it then doesn&#39;t even mix it into the fast pool is just
wrong, wrong, wrong.
<p>
I think *that* is what we should fix. The fact is, urandom has
long-standing semantics as &#34;don&#39;t block&#34;, and that it shouldn&#39;t care
about the (often completely insane) entropy crediting rules.
</p><p>
But that &#34;don&#39;t care about entropy rules&#34; should then also mean &#34;oh,
we&#39;ll mix things in even if we don&#39;t credit entropy&#34;.
</p></blockquote>


<p>
Donenfeld <a href="https://lwn.net/ml/linux-kernel/CAHmME9oi-XM--3c4fbM6LydM_Q7CTBdEzKC9fDEE7gXcwUwtcw@mail.gmail.com/">agreed</a>
with that view: &#34;<span>In general, your intuition is correct, I think, that the entropy
crediting scheme is sort of insane and leads to problems.</span>&#34;  He
pointed to his <a href="https://lwn.net/Articles/888413/">recent report on kernel RNG
changes</a>, noting that it talks about other RNGs that could be used
(e.g. <a href="https://www.schneier.com/academic/fortuna/">Fortuna</a>), which
do not suffer from the same types of problems, so that &#34;<span>might be
something to look at seriously in the future</span>&#34;.  
</p>

<h4>Another patch</h4>

<p>
Donenfeld <a href="https://lwn.net/ml/linux-kernel/20220322191436.110963-1-Jason@zx2c4.com/">posted</a>
a patch on March 22 to try to address the problem with reading
poor-quality random numbers for seed files during early boot.  He said that
he had <a href="https://github.com/systemd/systemd/commit/da2862ef06f22fc8d31dafced6d2d6dc14f2ee0b">fixed
a related problem in systemd</a>, but that cleaner fix did not help the
existing shell scripts.
</p><blockquote>
So this patch fixes the issue by including /dev/urandom writes as part
of the &#34;fast init&#34;, but not crediting it as part of the fast init
counter. This is more or less exactly what&#39;s already done for
kernel-sourced entropy whose quality we don&#39;t know, when we use
add_device_randomness(), which both contributes to the input pool and to
the fast init key.
</blockquote>


<p>
Torvalds <a href="https://lwn.net/ml/linux-kernel/CAHk-=wgSRk_-Nh5gtDKZj_fKya1NKry1Y5jdejfKNPnB+Pr4cw@mail.gmail.com/">wondered</a>
why reads from <tt>/dev/urandom</tt> did not simply use the initializing
pool, since the data written to the device <i>is</i> already mixed into
that.  Donenfeld <a href="https://lwn.net/ml/linux-kernel/CAHmME9oWzXeuEJacLoKWHer82LwCtD6+9Kv9gMOKYcZOhhN7pA@mail.gmail.com/">agreed</a>
that his approach was less-than-perfect, but that it is far better now
that some changes he made for 5.18 are in place.  He had a lengthy
explanation on the goals of his changes and on the differences between the
input pool and the fast init pool. The input pool is used to 
rekey the <a href="https://en.wikipedia.org/wiki/Salsa20">ChaCha</a> cipher
that actually provides the random bytes after initialization, while the fast init pool is
used before the full 256 bits of entropy are gathered in the input pool.
Until that entropy is gathered (from various kernel sources, a hardware
RNG, entropy credited from user space, or from jitter), the input pool is
not properly initialized, thus an 
alternative needs to be used:
</p><blockquote>
The &#34;pre init pool&#34;, the &#34;fast init pool&#34;, the &#34;super terrible
but at least not zero pool&#34;, the &#34;all bets are off pool&#34;, ... whatever
you want to call it. Why a separate pool for pre init? Because the
real input pool needs to accumulate 256 bits of entropy before it&#39;s
safe to use.
<p>
Your suggestion is to instead not have a separate pool, but perhaps
just do separate accounting. That might work to some degree, but the
devil is in the details, and that sounds a lot harder and messier to
code.
</p></blockquote>


<p>
He reiterated there may be some other longer-term solutions to consider,
but did not think Torvalds&#39;s suggestion would help much.  Ted Ts&#39;o,
the other kernel RNG maintainer,  <a href="https://lwn.net/ml/linux-kernel/YjqVemCkZCU1pOzj@mit.edu/">cautioned</a> that
writing to <tt>/dev/urandom</tt> is not a privileged operation, so a
malicious user-space program could write specific values to it; that is the
reason why inputs to the device are not used &#34;<span>until there
is a chance for it to be mixed 
in with other entropy which is hopefully not under the control of
malicious userspace</span>&#34;.
</p><blockquote>
Now, I recognize that things are a bit special in early boot, and if
we have a malicious script running in a systemd unit script, we might
as well go home.  But something to consider is whether we want to do
[something] special if the process writing to /dev/[u]random has
CAP_SYS_ADMIN, or some such.
</blockquote>


<p>
Donenfeld <a href="https://lwn.net/ml/linux-kernel/YjqbcQbYHCOpgqGg@zx2c4.com/">said</a>
that the input provided by writing to the RNG devices is
cryptographically hashed, so &#34;<span>we can haphazardly mix whatever any user
wants, without too much 
concern</span>&#34; as long as it is not given entropy credit.  While crediting entropy when the writes to
<tt>/dev/urandom</tt> are done from a process with <tt>CAP_SYS_ADMIN</tt>
(or some other privilege) might be reasonable, there may be user-space code
that is expecting the current behavior.  He noted that the problem he saw in the
shell scripts being used by Roeck&#39;s tests is not really a kernel bug:
</p><blockquote>
[...] this
has _always_ been broken, and those shell scripts have _always_ been
vulnerable. Maybe the kernel should fix that, but due to the ambiguity
of the /dev/urandom write interface, maybe the best fix is actually in
userspace itself, which means it&#39;d work on old kernels too (which are
rather common for the embedded devices that tend to have those types of
shell scripts).
</blockquote>


<p>
Donenfeld pointed to his systemd fix and one he <a href="https://lists.buildroot.org/pipermail/buildroot/2022-March/639359.html">submitted</a>
for <a href="https://buildroot.org/">Buildroot</a> as a better approach.
The idea is that user space hashes the old seed with the data it receives
from reading the RNG device before storing it away for the next boot.  That
way, even if the RNG is not initialized, &#34;<span>the amount of entropy in the new seed
will stay the same or get better, but not appreciably regress</span>&#34;. 
</p>

<h4><tt>RNDADDTOENTCNT</tt></h4>

<p>
In his proposed patch, Donenfeld noted that the <tt>RNDADDTOENTCNT</tt>
<tt>ioctl()</tt> command is a poor interface for crediting entropy, in part
because of the separation of the pools during initialization.  The
<tt>RNDADDTOENTCNT</tt> command simply tells the kernel to credit the
number of entropy bits that is passed in, but the write to the RNG device has already
happened (without credit).  Repeatedly writing small amounts of data to the
RNG device and then crediting it would give an attacker a window to
brute-force the exact data that was written from the fast init pool.  If
the 
write-credit cycle is done enough times to
fully initialize the input pool, the attacker could then brute-force the initial state of
the pool.
</p>

<p>
The <tt>RNDADDENTROPY</tt> command combines the
write and the credit in the same call, which allows the kernel to make a
better decision on what do with it, he said.  With <tt>RNDADDTOENTCNT</tt>, the
kernel does not know whether the data is simply meant to perturb the pool,
or whether it should be counted as truly unpredictable data, until after
the data
has already been processed. He suggested that deprecating
<tt>RNDADDTOENTCNT</tt> might be a good plan; Ts&#39;o <a href="https://lwn.net/ml/linux-kernel/YjsTOsqiNaURZQLM@mit.edu/">concurred</a> on that plan.
</p>

<p>
Alex Xu <a href="https://lwn.net/ml/linux-kernel/1648009787.fah6dos6ya.none@localhost/">did some
research</a> on the uses of <tt>RNDADDTOENTCNT</tt> in existing code, which
led Donenfeld to <a href="https://lwn.net/ml/linux-kernel/CAHmME9rsvxczJrhPwRX6nyrh9NB2AuJqkEKrTLx-G-T1J6_czQ@mail.gmail.com/">question</a>
his patch.  There are, it seems, programs that do exactly what Donenfeld
was worried about.  For example, <a href="https://github.com/sandy-harris/maxwell">maxwell</a> is a daemon to
feed jitter entropy into the Linux RNG; Xu said it operates as follows:
</p><blockquote>
sandy-harris/maxwell is a &#34;jitter entropy&#34; daemon, similar to haveged. 
It writes 4 bytes of &#34;generated entropy&#34; to /dev/random, then calls 
RNDADDTOENTCNT, then repeats.
</blockquote>


<p>
Donenfeld replied: &#34;<span>Okay bingo. The existence of this means that this patch will
definitely introduce a new vulnerability.</span>&#34;  An attacker could
brute-force the data 32 bits at a time, so his patch would need to change,
he said.  Part of the problem is  that some early boot efforts to initialize the
RNG in user space are not actually doing so unless there is entropy being
credited during that process.  David Laight <a href="https://lwn.net/ml/linux-kernel/6716f3ffefae4ed8b5fd332bfcca8a9a@AcuMS.aculab.com/">said</a>:
&#34;<span>You can&#39;t really expect startup scripts to be issuing ioctl
requests.</span>&#34;.  But that is exactly what is required if there are no
other sources of entropy, as Donenfeld <a href="https://lwn.net/ml/linux-kernel/YjqLAWbZ8K7eg3Fw@zx2c4.com/">explained</a>:
</p><blockquote>
Crediting bits has required an ioctl since forever. Those
shell scripts have been broken forever. The proposal here is to add new
behavior to support those old broken shell scripts.
<p>
Fortunately, it seems sort of fixable. But only sort of. There are also
a lot of complications, as detailed above. Part of it is that some
people use /dev/urandom writes expecting it not to credit, while others
use that and then later manually credit it with the ioctl. Both of those
in general seem like not a very good interface for seeding the rng. The
correct interface to use is RNDADDENTROPY, which takes both the data and
whether it should be credited, since then the kernel knows what the
intentions are and can do something smart with it. Barring that
knowledge, we&#39;re in this vague middle ground where it&#39;s unclear what the
user intends to do.
</p></blockquote>


<p>
There was some discussion of possible heuristics for when to credit entropy
for writes to the RNG devices. for example only during early boot or when the process has
certain privileges, but all of those are fraught.  There are other cases
where crediting that entropy could be problematic or catastrophic.
Eric Biggers <a href="https://lwn.net/ml/linux-kernel/YjyyAm9pyOp9Fyqi@gmail.com/">provided</a> an example
of where things might go wrong.  The Android system writes its kernel
command line to <tt>/dev/urandom</tt> early in the boot process with the
expectation that it will <i>not</i> count as entropy, &#34;<span>given that
the command line might not contain much entropy, or any at all</span>&#34;. 
</p>

<p>
For those reasons, Donenfeld <a href="https://lwn.net/ml/linux-kernel/CAHmME9ovJpdcuuZhNKrOTUc8XvKDDdC+axhAmOD9iESnRR7JqA@mail.gmail.com/">came
to the conclusion</a> that not changing the current behavior was the right
thing to do.
</p><blockquote>
Based on this, the fact that shell scripts cannot seed the RNG anyway,
and due to the hazards in trying to retrofit some heuristics onto an
interface that was never designed to work like this, I&#39;m convinced at
this point that the right course of action here is to leave this
alone. There&#39;s no combination of /dev/urandom write hacks/heuristics
that do the right thing without creating some big problem elsewhere.
It just does not have the right semantics for it, and changing the
existing semantics will break existing users.
</blockquote>


<p>
His plan is to work with user-space utilities to make changes that reflect
the current reality, so that file-based seeding works well everywhere.  To
that end he has created a simple <a href="https://git.zx2c4.com/seedrng/about/">SeedRNG program</a> that is
intended to be incorporated into programs that need this kind of
functionality.  If that work is successful, it &#34;<span>might lead to a better ecosystem and
less boot time blocking and all that jazz</span>&#34;. 
</p>

<p>
It is clear that Donenfeld has injected some needed energy into the
maintenance of the kernel RNG code.  There is a lot of work going on in
that area right now and, seemingly, more to come.  For now, we are still
facing that longtime kernel bugaboo, entropy gathering woes early in the
boot process, but perhaps there is some light on the horizon in the form of
other techniques that might improve the situation.  In the meantime,
reworking user space to properly use the facilities we do have looks like
the right approach.
</p></div></div>
  </body>
</html>
